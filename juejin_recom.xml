<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[AI工程化实践指南：从入门到落地]]></title>    <link>https://juejin.cn/post/7585778343350894655</link>    <guid>https://juejin.cn/post/7585778343350894655</guid>    <pubDate>2025-12-21T10:16:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585778343350894655" data-draft-id="7585751355592359955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI工程化实践指南：从入门到落地"/> <meta itemprop="keywords" content="后端,AI编程"/> <meta itemprop="datePublished" content="2025-12-21T10:16:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="無量"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI工程化实践指南：从入门到落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    無量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T10:16:55.000Z" title="Sun Dec 21 2025 10:16:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一位Java开发者的AI之旅：从AI Coding到AI工程化应用</p>
</blockquote>
<h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#1-%E5%BC%95%E8%A8%80ai%E6%97%B6%E4%BB%A3java%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84%E6%96%B0%E6%9C%BA%E9%81%87" title="#1-%E5%BC%95%E8%A8%80ai%E6%97%B6%E4%BB%A3java%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84%E6%96%B0%E6%9C%BA%E9%81%87">1. 引言：AI时代，Java开发者的新机遇</a></li>
<li><a href="#2-ai%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E7%9A%84%E6%BC%94%E8%BF%9B" title="#2-ai%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%AE%9E%E8%B7%B5%E7%9A%84%E6%BC%94%E8%BF%9B">2. AI发展历程：从理论到实践的演进</a></li>
<li><a href="#3-ai%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E6%9E%84%E5%BB%BA%E5%AE%8C%E6%95%B4%E7%9A%84%E8%AE%A4%E7%9F%A5%E5%9C%B0%E5%9B%BE" title="#3-ai%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E6%9E%84%E5%BB%BA%E5%AE%8C%E6%95%B4%E7%9A%84%E8%AE%A4%E7%9F%A5%E5%9C%B0%E5%9B%BE">3. AI知识体系：构建完整的认知地图</a></li>
<li><a href="#4-ai-coding%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84%E6%99%BA%E8%83%BD%E5%8A%A9%E6%89%8B" title="#4-ai-coding%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84%E6%99%BA%E8%83%BD%E5%8A%A9%E6%89%8B">4. AI Coding工具：开发者的智能助手</a></li>
<li><a href="#5-ai%E5%B7%A5%E7%A8%8B%E5%8C%96%E5%AE%9E%E8%B7%B5%E4%BB%8E%E6%A6%82%E5%BF%B5%E5%88%B0%E8%90%BD%E5%9C%B0" title="#5-ai%E5%B7%A5%E7%A8%8B%E5%8C%96%E5%AE%9E%E8%B7%B5%E4%BB%8E%E6%A6%82%E5%BF%B5%E5%88%B0%E8%90%BD%E5%9C%B0">5. AI工程化实践：从概念到落地</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">1. 引言：AI时代，Java开发者的新机遇</h2>
<h3 data-id="heading-2">1.1 为什么是现在？</h3>
<p>2022年11月，ChatGPT的发布标志着我们进入了大模型时代。作为Java开发者，我们正处于一个历史性的转折点：</p>
<ul>
<li><strong>开发方式的革命</strong>：AI Coding工具正在改变我们写代码的方式</li>
<li><strong>应用形态的创新</strong>：AI能力正在被集成到各类应用中</li>
<li><strong>技术栈的扩展</strong>：Java生态正在快速拥抱AI技术</li>
</ul>
<h3 data-id="heading-3">1.2 Java开发者的优势</h3>
<p>作为Java开发者，我们在AI工程化落地方面有天然优势：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Java开发者优势] --&gt; B[企业级开发经验]
    A --&gt; C[工程化思维]
    A --&gt; D[成熟的生态系统]

    B --&gt; E[大型项目架构能力]
    B --&gt; F[高并发处理经验]

    C --&gt; G[代码规范]
    C --&gt; H[测试驱动]
    C --&gt; I[DevOps实践]

    D --&gt; J[Spring生态]
    D --&gt; K[微服务框架]
    D --&gt; L[中间件集成]

    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#fff4e1
    style D fill:#fff4e1
</code></pre>
<hr/>
<h2 data-id="heading-4">2. AI发展历程：从理论to实践的演进</h2>
<h3 data-id="heading-5">2.1 AI发展时间线</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title AI发展关键节点
    1956 : 达特茅斯会议
         : AI概念诞生
    1997 : 深蓝战胜卡斯帕罗夫
         : 符号AI巅峰
    2012 : ImageNet突破
         : 深度学习崛起
    2016 : AlphaGo战胜李世石
         : 强化学习里程碑
    2017 : Transformer架构
         : 注意力机制革命
    2018 : BERT发布
         : 预训练模型时代
    2020 : GPT-3发布
         : 大模型时代开启
    2022 : ChatGPT发布
         : AI应用大爆发
    2023 : GPT-4/Claude 3
         : 多模态能力飞跃
    2024 : Claude 3.5 Sonnet
         : AI Coding成熟
    2025 : AI工程化普及
         : 企业级应用落地
</code></pre>
<h3 data-id="heading-6">2.2 三个重要阶段</h3>
<h4 data-id="heading-7"><strong>阶段一：传统AI时代（1956-2010）</strong></h4>
<p>特征：</p>
<ul>
<li>基于规则和专家系统</li>
<li>符号主义和逻辑推理</li>
<li>应用场景有限</li>
</ul>
<p>典型代表：</p>
<ul>
<li>专家系统（MYCIN、DENDRAL）</li>
<li>搜索算法（A*、博弈树）</li>
<li>早期自然语言处理</li>
</ul>
<h4 data-id="heading-8"><strong>阶段二：深度学习革命（2012-2020）</strong></h4>
<p>特征：</p>
<ul>
<li>数据驱动的学习方式</li>
<li>神经网络的复兴</li>
<li>在特定领域超越人类</li>
</ul>
<p>关键技术：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[深度学习技术栈] --&gt; B[卷积神经网络 CNN]
    A --&gt; C[循环神经网络 RNN/LSTM]
    A --&gt; D[Transformer架构]

    B --&gt; E[图像识别]
    B --&gt; F[计算机视觉]

    C --&gt; G[序列建模]
    C --&gt; H[机器翻译]

    D --&gt; I[自然语言处理]
    D --&gt; J[大语言模型]

    style A fill:#e1f5ff
    style D fill:#ffe1e1
</code></pre>
<h4 data-id="heading-9"><strong>阶段三：大模型时代（2020至今）</strong></h4>
<p>特征：</p>
<ul>
<li>规模化预训练模型</li>
<li>涌现能力（Emergent Abilities）</li>
<li>通用人工智能的雏形</li>
</ul>
<p>核心理念：</p>
<ol>
<li><strong>Scale Law</strong>：模型越大，能力越强</li>
<li><strong>Few-shot Learning</strong>：少样本甚至零样本学习</li>
<li><strong>Instruction Following</strong>：理解并执行复杂指令</li>
</ol>
<hr/>
<h2 data-id="heading-10">3. AI知识体系：构建完整的认知地图</h2>
<h3 data-id="heading-11">3.1 整体知识架构</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;应用层&amp;#34;
        A1[AI Coding]
        A2[智能客服]
        A3[文档问答]
        A4[代码助手]
        A5[数据分析]
    end

    subgraph &amp;#34;工程层&amp;#34;
        B1[LangChain4j]
        B2[Spring AI]
        B3[LlamaIndex]
        B4[Semantic Kernel]
    end

    subgraph &amp;#34;能力层&amp;#34;
        C1[Prompt Engineering]
        C2[RAG检索增强]
        C3[Agent智能体]
        C4[Function Calling]
        C5[Fine-tuning微调]
    end

    subgraph &amp;#34;模型层&amp;#34;
        D1[GPT-4/GPT-4o]
        D2[Claude 3.5]
        D3[Gemini]
        D4[Llama 3]
        D5[通义千问]
    end

    subgraph &amp;#34;基础层&amp;#34;
        E1[Transformer]
        E2[Attention机制]
        E3[Token机制]
        E4[Embedding]
    end

    A1 &amp; A2 &amp; A3 &amp; A4 &amp; A5 --&gt; B1 &amp; B2 &amp; B3 &amp; B4
    B1 &amp; B2 &amp; B3 &amp; B4 --&gt; C1 &amp; C2 &amp; C3 &amp; C4 &amp; C5
    C1 &amp; C2 &amp; C3 &amp; C4 &amp; C5 --&gt; D1 &amp; D2 &amp; D3 &amp; D4 &amp; D5
    D1 &amp; D2 &amp; D3 &amp; D4 &amp; D5 --&gt; E1 &amp; E2 &amp; E3 &amp; E4

    style A1 fill:#e1f5ff
    style B1 fill:#fff4e1
    style C1 fill:#e1ffe1
    style D1 fill:#ffe1f5
    style E1 fill:#f5e1ff
</code></pre>
<h3 data-id="heading-12">3.2 核心概念详解</h3>
<h4 data-id="heading-13"><strong>3.2.1 大语言模型（LLM）</strong></h4>
<p><strong>什么是LLM？</strong></p>
<p>大语言模型是通过在海量文本数据上进行预训练，学习语言模式和知识的深度学习模型。</p>
<p><strong>核心特征：</strong></p>






























<table><thead><tr><th>特征</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>大规模参数</strong></td><td>数十亿到数千亿参数</td><td>GPT-4: ~1.7T, Claude 3.5: 未公开</td></tr><tr><td><strong>预训练</strong></td><td>在大规模语料上自监督学习</td><td>互联网文本、书籍、代码等</td></tr><tr><td><strong>涌现能力</strong></td><td>模型规模达到临界点后出现的能力</td><td>推理、代码生成、多语言理解</td></tr><tr><td><strong>上下文学习</strong></td><td>从提示词中学习任务</td><td>Few-shot、Zero-shot学习</td></tr></tbody></table>
<p><strong>工作原理简化理解：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">用户输入 → Token化 → Embedding → Transformer处理 → 概率预测 → 生成输出
   ↓          ↓           ↓              ↓              ↓           ↓
<span class="hljs-string">"你好"</span>   → [<span class="hljs-number">101</span>,<span class="hljs-number">203</span>] → 向量化 → 多层注意力计算 → 下一个Token → <span class="hljs-string">"您好"</span>
</code></pre>
<h4 data-id="heading-14"><strong>3.2.2 Prompt Engineering（提示词工程）</strong></h4>
<p><strong>定义：</strong> 设计和优化输入提示词，以获得更好的模型输出。</p>
<p><strong>核心技巧：</strong></p>
<ol>
<li><strong>明确角色和任务</strong></li>
</ol>

<pre><code class="hljs">你是一位资深的Java架构师，擅长Spring Boot和微服务设计。
请帮我设计一个订单系统的数据库表结构。
</code></pre>
<p>2.  <strong>提供上下文和约束</strong></p>

<pre><code class="hljs language-diff" lang="diff">背景：电商系统，日订单量10万
要求：
<span class="hljs-deletion">- 支持订单拆分</span>
<span class="hljs-deletion">- 需要记录完整的状态流转</span>
<span class="hljs-deletion">- 考虑分库分表</span>
</code></pre>
<p>3.  <strong>使用示例引导</strong></p>

<pre><code class="hljs language-diff" lang="diff">参考以下格式输出：
表名：t_order
字段：
<span class="hljs-deletion">- id: bigint, 主键</span>
<span class="hljs-deletion">- user_id: bigint, 用户ID</span>
...
</code></pre>
<p>4.  <strong>分步骤思考（Chain of Thought）</strong></p>

<pre><code class="hljs language-markdown" lang="markdown">请按以下步骤分析：
<span class="hljs-bullet">1.</span> 识别核心实体
<span class="hljs-bullet">2.</span> 确定表关系
<span class="hljs-bullet">3.</span> 设计字段
<span class="hljs-bullet">4.</span> 添加索引
<span class="hljs-bullet">5.</span> 考虑扩展性
</code></pre>
<p><strong>Prompt模式总结：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf1443b120241d38ca8eb0d53cc6ac1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766917015&amp;x-signature=U1hGOywBy1eSnxpZuTIn68CIpWw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15"><strong>3.2.3 RAG（检索增强生成）</strong></h4>
<p><strong>为什么需要RAG？</strong></p>
<p>大模型虽然强大，但存在局限：</p>
<ul>
<li>❌ 知识截止日期限制</li>
<li>❌ 无法访问私有数据</li>
<li>❌ 可能产生幻觉（Hallucination）</li>
<li>❌ 缺乏特定领域知识</li>
</ul>
<p><strong>RAG如何解决？</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant S as 系统
    participant V as 向量数据库
    participant L as LLM

    U-&gt;&gt;S: 提问：&amp;#34;公司Q3财报如何？&amp;#34;
    S-&gt;&gt;S: Query改写与优化
    S-&gt;&gt;V: 向量检索相似内容
    V--&gt;&gt;S: 返回Top-K相关文档
    Note over S: 文档1: Q3营收100亿&lt;br/&gt;文档2: 同比增长25%&lt;br/&gt;文档3: 净利润15亿
    S-&gt;&gt;L: 构建Prompt（问题+检索文档）
    Note over L: Prompt:&lt;br/&gt;基于以下信息回答...&lt;br/&gt;[相关文档]&lt;br/&gt;问题: 公司Q3财报如何？
    L--&gt;&gt;S: 生成答案
    S--&gt;&gt;U: &amp;#34;Q3营收100亿，同比增长25%...&amp;#34;
</code></pre>
<p><strong>RAG技术架构：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;数据准备&amp;#34;
        A[原始文档] --&gt; B[文档分块]
        B --&gt; C[向量化Embedding]
        C --&gt; D[存入向量数据库]
    end

    subgraph &amp;#34;检索阶段&amp;#34;
        E[用户查询] --&gt; F[Query Embedding]
        F --&gt; G[相似度检索]
        D --&gt; G
        G --&gt; H[Top-K文档]
    end

    subgraph &amp;#34;生成阶段&amp;#34;
        H --&gt; I[Prompt构建]
        E --&gt; I
        I --&gt; J[LLM生成]
        J --&gt; K[答案输出]
    end

    style A fill:#e1f5ff
    style E fill:#e1f5ff
    style K fill:#e1ffe1
</code></pre>
<p><strong>关键技术点：</strong></p>



































<table><thead><tr><th>环节</th><th>技术选择</th><th>说明</th></tr></thead><tbody><tr><td><strong>文档切分</strong></td><td>固定长度、语义切分、递归切分</td><td>平衡上下文完整性和检索精度</td></tr><tr><td><strong>Embedding模型</strong></td><td>OpenAI、BGE、M3E</td><td>中文推荐BGE或M3E</td></tr><tr><td><strong>向量数据库</strong></td><td>Milvus、Qdrant、Pinecone</td><td>考虑性能和部署方式</td></tr><tr><td><strong>检索策略</strong></td><td>密集检索、稀疏检索、混合检索</td><td>提升召回率和准确率</td></tr><tr><td><strong>重排序</strong></td><td>Rerank模型</td><td>优化Top-K结果质量</td></tr></tbody></table>
<h4 data-id="heading-16"><strong>3.2.4 Agent（智能体）</strong></h4>
<p><strong>什么是AI Agent？</strong></p>
<p>具备自主决策和工具使用能力的AI系统，能够理解任务、制定计划、执行动作、并根据反馈调整策略。</p>
<p><strong>Agent核心组件：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Agent核心] --&gt; B[感知 Perception]
    A --&gt; C[规划 Planning]
    A --&gt; D[记忆 Memory]
    A --&gt; E[工具 Tools]
    A --&gt; F[执行 Action]

    B --&gt; B1[理解任务]
    B --&gt; B2[环境感知]

    C --&gt; C1[任务分解]
    C --&gt; C2[制定计划]
    C --&gt; C3[决策推理]

    D --&gt; D1[短期记忆]
    D --&gt; D2[长期记忆]
    D --&gt; D3[经验积累]

    E --&gt; E1[搜索工具]
    E --&gt; E2[代码执行]
    E --&gt; E3[API调用]
    E --&gt; E4[数据库查询]

    F --&gt; F1[执行操作]
    F --&gt; F2[获取反馈]
    F --&gt; F3[调整策略]

    style A fill:#e1f5ff
</code></pre>
<p><strong>Agent工作流程：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; 接收任务
    接收任务 --&gt; 理解分析
    理解分析 --&gt; 制定计划
    制定计划 --&gt; 选择工具
    选择工具 --&gt; 执行动作
    执行动作 --&gt; 观察结果
    观察结果 --&gt; 判断完成: 任务完成？
    判断完成 --&gt; 返回结果: 是
    判断完成 --&gt; 调整计划: 否
    调整计划 --&gt; 选择工具
    返回结果 --&gt; [*]
</code></pre>
<p><strong>典型Agent模式：</strong></p>
<ol>
<li><strong>ReAct模式</strong>（Reasoning + Acting）</li>
</ol>

<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">Thought:</span> 用户想查询订单状态，我需要先获取订单ID
<span class="hljs-symbol">Action:</span> 调用getUserOrders工具
<span class="hljs-symbol">Observation:</span> 返回订单列表[#<span class="hljs-number">12345</span>, #<span class="hljs-number">12346</span>]
<span class="hljs-symbol">Thought:</span> 用户最近的订单是#<span class="hljs-number">12346</span>，查询其状态
<span class="hljs-symbol">Action:</span> 调用getOrderStatus(#<span class="hljs-number">12346</span>)
<span class="hljs-symbol">Observation:</span> 订单状态为<span class="hljs-string">"已发货"</span>
<span class="hljs-symbol">Thought:</span> 我已经得到答案
<span class="hljs-symbol">Answer:</span> 您的订单#<span class="hljs-number">12346</span>已发货
</code></pre>
<p>2.  <strong>Plan-and-Execute模式</strong></p>

<pre><code class="hljs language-ini" lang="ini">Plan:
1. 搜索Spring AI Alibaba官方文档
2. 提取核心特性信息
3. 对比LangChain4j的差异
4. 生成对比表格

Execute:
<span class="hljs-section">[执行步骤1]</span> → <span class="hljs-section">[执行步骤2]</span> → <span class="hljs-section">[执行步骤3]</span> → <span class="hljs-section">[执行步骤4]</span>
</code></pre>
<h4 data-id="heading-17"><strong>3.2.5 Function Calling（函数调用）</strong></h4>
<p><strong>定义：</strong> 让LLM能够主动调用外部函数/API来完成任务。</p>
<p><strong>工作原理：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant L as LLM
    participant S as 系统
    participant API as 外部API

    U-&gt;&gt;L: &amp;#34;查询北京明天天气&amp;#34;
    L-&gt;&gt;L: 分析需要调用天气API
    L-&gt;&gt;S: 返回函数调用请求
    Note over S: {&lt;br/&gt;  &amp;#34;function&amp;#34;: &amp;#34;getWeather&amp;#34;,&lt;br/&gt;  &amp;#34;parameters&amp;#34;: {&lt;br/&gt;    &amp;#34;city&amp;#34;: &amp;#34;北京&amp;#34;,&lt;br/&gt;    &amp;#34;date&amp;#34;: &amp;#34;明天&amp;#34;&lt;br/&gt;  }&lt;br/&gt;}
    S-&gt;&gt;API: 调用天气API
    API--&gt;&gt;S: 返回天气数据
    S-&gt;&gt;L: 将结果返回给LLM
    L-&gt;&gt;U: &amp;#34;北京明天晴，15-25℃&amp;#34;
</code></pre>
<p><strong>Java实现示例（LangChain4j）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义工具函数</span>
<span class="hljs-meta">@Tool("查询订单状态")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOrderStatus</span><span class="hljs-params">(<span class="hljs-meta">@P("订单ID")</span> String orderId)</span> {
    <span class="hljs-comment">// 实际业务逻辑</span>
    <span class="hljs-keyword">return</span> orderService.queryStatus(orderId);
}

<span class="hljs-comment">// 配置Agent</span>
<span class="hljs-type">ChatLanguageModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> OpenAiChatModel.builder()
    .apiKey(apiKey)
    .modelName(<span class="hljs-string">"gpt-4"</span>)
    .build();

<span class="hljs-type">Assistant</span> <span class="hljs-variable">assistant</span> <span class="hljs-operator">=</span> AiServices.builder(Assistant.class)
    .chatLanguageModel(model)
    .tools(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderTools</span>())
    .build();

<span class="hljs-comment">// 调用</span>
<span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> assistant.chat(<span class="hljs-string">"帮我查询订单12345的状态"</span>);
</code></pre>
<h4 data-id="heading-18"><strong>3.2.6 Fine-tuning（微调）</strong></h4>
<p><strong>什么是微调？</strong></p>
<p>在预训练模型基础上，使用特定领域数据进行进一步训练，使模型适应特定任务。</p>
<p><strong>微调 vs RAG vs Prompt Engineering：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[任务需求] --&gt; B{数据量}
    B --&gt;|少量数据&lt;br/&gt;快速迭代| C[Prompt Engineering]
    B --&gt;|中等数据&lt;br/&gt;知识增强| D[RAG]
    B --&gt;|大量数据&lt;br/&gt;行为定制| E[Fine-tuning]

    C --&gt; C1[优点: 零成本快速验证]
    C --&gt; C2[缺点: 受限于模型能力]

    D --&gt; D1[优点: 动态知识更新]
    D --&gt; D2[缺点: 需要维护检索系统]

    E --&gt; E1[优点: 深度定制]
    E --&gt; E2[缺点: 成本高周期长]

    style C fill:#e1ffe1
    style D fill:#fff4e1
    style E fill:#ffe1e1
</code></pre>
<p><strong>选择决策树：</strong></p>



































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>格式化输出</td><td>Prompt</td><td>简单有效</td></tr><tr><td>企业知识问答</td><td>RAG</td><td>知识可更新</td></tr><tr><td>特定领域对话风格</td><td>Fine-tuning</td><td>深度定制</td></tr><tr><td>多轮对话</td><td>Prompt + RAG</td><td>组合使用</td></tr><tr><td>专业术语翻译</td><td>Fine-tuning</td><td>专业性强</td></tr></tbody></table>
<h3 data-id="heading-19">3.3 技术栈全景图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;前端层&amp;#34;
        UI1[Web界面]
        UI2[移动端]
        UI3[IDE插件]
    end

    subgraph &amp;#34;应用层&amp;#34;
        APP1[Spring Boot应用]
        APP2[微服务]
        APP3[Serverless]
    end

    subgraph &amp;#34;AI框架层&amp;#34;
        FW1[Spring AI Alibaba]
        FW2[LangChain4j]
        FW3[Semantic Kernel]
    end

    subgraph &amp;#34;AI能力层&amp;#34;
        CAP1[Chat对话]
        CAP2[Embedding向量化]
        CAP3[Image生成]
        CAP4[Audio处理]
    end

    subgraph &amp;#34;模型接入层&amp;#34;
        MOD1[OpenAI API]
        MOD2[Anthropic API]
        MOD3[阿里云百炼]
        MOD4[本地模型Ollama]
    end

    subgraph &amp;#34;数据层&amp;#34;
        DATA1[向量数据库]
        DATA2[关系数据库]
        DATA3[缓存Redis]
        DATA4[对象存储]
    end

    UI1 &amp; UI2 &amp; UI3 --&gt; APP1 &amp; APP2 &amp; APP3
    APP1 &amp; APP2 &amp; APP3 --&gt; FW1 &amp; FW2 &amp; FW3
    FW1 &amp; FW2 &amp; FW3 --&gt; CAP1 &amp; CAP2 &amp; CAP3 &amp; CAP4
    CAP1 &amp; CAP2 &amp; CAP3 &amp; CAP4 --&gt; MOD1 &amp; MOD2 &amp; MOD3 &amp; MOD4
    FW1 &amp; FW2 &amp; FW3 --&gt; DATA1 &amp; DATA2 &amp; DATA3 &amp; DATA4

    style FW1 fill:#e1f5ff
    style FW2 fill:#e1f5ff
</code></pre>
<hr/>
<h2 data-id="heading-20">4. AI Coding工具：开发者的智能助手</h2>
<h3 data-id="heading-21">4.1 AI Coding的本质</h3>
<p>AI Coding不是替代程序员，而是：</p>
<ul>
<li>✅ 提升开发效率（2-5倍）</li>
<li>✅ 减少重复性工作</li>
<li>✅ 辅助学习新技术</li>
<li>✅ 改善代码质量</li>
</ul>
<h3 data-id="heading-22">4.2 主流工具全景对比</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86c7eb1721b541afa7a1643c3878656b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766917015&amp;x-signature=IXvdRjJrpn0VzJjc81u%2BccWe9rQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-23">4.3 重点工具详解</h3>
<h4 data-id="heading-24"><strong>4.3.1 Claude Code</strong></h4>
<p><strong>定位：</strong> 官方CLI工具，深度集成Claude 3.5 Sonnet，专注于代码生成和工程实践。</p>
<p><strong>核心特性：</strong></p>






























<table><thead><tr><th>特性</th><th>说明</th><th>优势</th></tr></thead><tbody><tr><td><strong>长上下文</strong></td><td>支持200K tokens</td><td>可以理解整个代码库</td></tr><tr><td><strong>Artifacts</strong></td><td>独立的代码预览</td><td>所见即所得</td></tr><tr><td><strong>工具集成</strong></td><td>Bash、文件操作、搜索</td><td>完整的开发环境</td></tr><tr><td><strong>思维链</strong></td><td>可见的推理过程</td><td>理解AI的决策逻辑</td></tr></tbody></table>
<p><strong>典型使用场景：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 代码重构</span>
claude <span class="hljs-string">"将这个Controller改造为RESTful风格，并添加参数校验"</span>

<span class="hljs-comment"># 2. 单元测试生成</span>
claude <span class="hljs-string">"为UserService生成完整的单元测试，覆盖率达到80%"</span>

<span class="hljs-comment"># 3. 代码审查</span>
claude <span class="hljs-string">"审查这段代码的安全性和性能问题"</span>

<span class="hljs-comment"># 4. 架构设计</span>
claude <span class="hljs-string">"设计一个支持百万级用户的秒杀系统架构"</span>
</code></pre>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[使用Claude Code] --&gt; B[准备充分的上下文]
    B --&gt; C[明确的需求描述]
    C --&gt; D[迭代式交互]
    D --&gt; E[代码审查验证]

    B --&gt; B1[项目README]
    B --&gt; B2[相关代码文件]
    B --&gt; B3[技术栈说明]

    C --&gt; C1[功能需求]
    C --&gt; C2[技术约束]
    C --&gt; C3[期望输出格式]

    D --&gt; D1[先整体后细节]
    D --&gt; D2[及时反馈调整]

    E --&gt; E1[运行测试]
    E --&gt; E2[代码review]
    E --&gt; E3[性能验证]
</code></pre>
<h4 data-id="heading-25"><strong>4.3.2 Cursor</strong></h4>
<p><strong>定位：</strong> AI-first的IDE，基于VS Code深度定制。</p>
<p><strong>核心特性：</strong></p>
<ol>
<li>
<p><strong>Cmd+K：内联编辑</strong></p>
<ul>
<li>选中代码，描述需求</li>
<li>AI直接修改代码</li>
<li>支持多处同时编辑</li>
</ul>
</li>
<li>
<p><strong>Composer：多文件编辑</strong></p>
<ul>
<li>跨文件重构</li>
<li>一次性修改多个相关文件</li>
<li>保持代码一致性</li>
</ul>
</li>
<li>
<p><strong>Chat：对话式编程</strong></p>
<ul>
<li><code>@Codebase</code> 搜索整个代码库</li>
<li><code>@Web</code> 搜索网络资料</li>
<li><code>@Docs</code> 查询文档</li>
</ul>
</li>
<li>
<p><strong>Tab：代码补全</strong></p>
<ul>
<li>上下文感知补全</li>
<li>学习个人编码风格</li>
</ul>
</li>
</ol>
<p><strong>Cursor vs Claude Code：</strong></p>








































<table><thead><tr><th>维度</th><th>Cursor</th><th>Claude Code</th></tr></thead><tbody><tr><td><strong>界面</strong></td><td>图形化IDE</td><td>命令行CLI</td></tr><tr><td><strong>集成度</strong></td><td>深度集成VS Code</td><td>独立工具</td></tr><tr><td><strong>学习曲线</strong></td><td>平缓</td><td>稍陡峭</td></tr><tr><td><strong>灵活性</strong></td><td>中等</td><td>高</td></tr><tr><td><strong>适用场景</strong></td><td>日常开发</td><td>复杂任务、自动化</td></tr><tr><td><strong>价格</strong></td><td>$20/月</td><td>按API计费</td></tr></tbody></table>
<p><strong>组合使用建议：</strong></p>
<pre><code class="hljs language-css" lang="css">日常开发：<span class="hljs-attribute">Cursor</span>（快速迭代）
复杂重构：Claude <span class="hljs-selector-tag">Code</span>（深度思考）
学习探索：两者结合使用
</code></pre>
<h4 data-id="heading-26"><strong>4.3.3 GitHub Copilot</strong></h4>
<p><strong>定位：</strong> GitHub官方，集成度最高。</p>
<p><strong>优势：</strong></p>
<ul>
<li>✅ 无缝集成GitHub生态</li>
<li>✅ 支持几乎所有IDE</li>
<li>✅ 企业版安全合规</li>
<li>✅ Chat功能增强</li>
</ul>
<p><strong>适合：</strong></p>
<ul>
<li>使用VS Code/JetBrains的团队</li>
<li>需要企业级安全的公司</li>
<li>GitHub深度用户</li>
</ul>
<h4 data-id="heading-27"><strong>4.3.4 其他工具简介</strong></h4>






























<table><thead><tr><th>工具</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Codeium</strong></td><td>免费、隐私保护</td><td>个人开发者、初学者</td></tr><tr><td><strong>Tabnine</strong></td><td>本地运行、企业级</td><td>对数据安全要求高的企业</td></tr><tr><td><strong>Amazon Q</strong></td><td>AWS生态集成</td><td>使用AWS服务的团队</td></tr><tr><td><strong>Windsurf</strong></td><td>新兴工具，流式体验</td><td>尝鲜用户</td></tr></tbody></table>
<h3 data-id="heading-28">4.4 工具选择决策树</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[选择AI Coding工具] --&gt; B{预算?}
    B --&gt;|有限| C{需要IDE集成?}
    B --&gt;|充足| D{主要用途?}

    C --&gt;|是| E[Codeium免费版]
    C --&gt;|否| F[Claude Code API]

    D --&gt;|日常开发| G{使用VS Code?}
    D --&gt;|复杂任务| H[Claude Code]
    D --&gt;|团队协作| I[GitHub Copilot企业版]

    G --&gt;|是| J[Cursor]
    G --&gt;|否| K[JetBrains AI]

    E --&gt; L[开始使用]
    F --&gt; L
    H --&gt; L
    I --&gt; L
    J --&gt; L
    K --&gt; L

    style L fill:#e1ffe1
</code></pre>
<h3 data-id="heading-29">4.5 AI Coding最佳实践</h3>
<h4 data-id="heading-30"><strong>4.5.1 提示词技巧</strong></h4>
<p><strong>1. 提供足够的上下文</strong></p>
<p>❌ 不好的提示：</p>
<pre><code class="hljs">帮我写个用户服务
</code></pre>
<p>✅ 好的提示：</p>
<pre><code class="hljs language-markdown" lang="markdown">项目：Spring Boot 3.2 + MyBatis Plus
需求：创建UserService，包含CRUD操作
要求：
<span class="hljs-bullet">1.</span> 使用@Service注解
<span class="hljs-bullet">2.</span> 集成Redis缓存
<span class="hljs-bullet">3.</span> 添加事务管理
<span class="hljs-bullet">4.</span> 参数校验使用JSR-303
<span class="hljs-bullet">5.</span> 统一异常处理
</code></pre>
<p><strong>2. 明确技术栈和约束</strong></p>
<pre><code class="hljs language-diff" lang="diff">技术栈：
<span class="hljs-deletion">- JDK 17</span>
<span class="hljs-deletion">- Spring Boot 3.2</span>
<span class="hljs-deletion">- MySQL 8.0</span>
<span class="hljs-deletion">- Redis 7.0</span>

约束：
<span class="hljs-deletion">- 遵循阿里巴巴Java开发规范</span>
<span class="hljs-deletion">- 使用Lombok减少样板代码</span>
<span class="hljs-deletion">- 日志使用SLF4J</span>
<span class="hljs-deletion">- 返回统一的Result对象</span>
</code></pre>
<p><strong>3. 使用示例驱动</strong></p>
<pre><code class="hljs language-less" lang="less">参考以下代码风格：

<span class="hljs-variable">@Service</span>
<span class="hljs-variable">@Slf4j</span>
public class OrderService {

    <span class="hljs-variable">@Resource</span>
    private OrderMapper orderMapper;

    <span class="hljs-variable">@Cacheable</span>(value = <span class="hljs-string">"order"</span>, key = <span class="hljs-string">"#id"</span>)
    public OrderDTO <span class="hljs-built_in">getById</span>(Long id) {
        <span class="hljs-comment">// ...</span>
    }
}

请按相同风格实现UserService
</code></pre>
<h4 data-id="heading-31"><strong>4.5.2 代码审查检查清单</strong></h4>
<p>AI生成代码后，必须检查：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((代码审查))
    功能正确性
      逻辑是否正确
      边界条件处理
      异常处理
    安全性
      SQL注入
      XSS攻击
      敏感信息泄露
    性能
      数据库查询优化
      缓存使用
      资源释放
    代码质量
      命名规范
      注释完整性
      可读性
    工程规范
      日志记录
      事务管理
      错误码统一
</code></pre>
<h4 data-id="heading-32"><strong>4.5.3 迭代式开发流程</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant D as 开发者
    participant AI as AI工具
    participant C as 代码库
    participant T as 测试

    D-&gt;&gt;AI: 1. 描述需求（高层次）
    AI--&gt;&gt;D: 2. 生成架构设计
    D-&gt;&gt;D: 3. Review设计，提出调整
    D-&gt;&gt;AI: 4. 细化具体模块
    AI--&gt;&gt;C: 5. 生成代码
    D-&gt;&gt;T: 6. 运行测试
    T--&gt;&gt;D: 7. 测试结果
    alt 测试失败
        D-&gt;&gt;AI: 8a. 反馈错误信息
        AI--&gt;&gt;C: 9a. 修复代码
    else 测试通过
        D-&gt;&gt;AI: 8b. 要求优化
        AI--&gt;&gt;C: 9b. 重构优化
    end
    D-&gt;&gt;D: 10. 最终Review
</code></pre>
<hr/>
<h2 data-id="heading-33">5. AI工程化实践：从概念到落地</h2>
<h3 data-id="heading-34">5.1 AI应用架构设计</h3>
<h4 data-id="heading-35"><strong>5.1.1 整体架构</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;用户层&amp;#34;
        U1[Web前端]
        U2[移动端]
        U3[API调用]
    end

    subgraph &amp;#34;应用层 - Spring Boot&amp;#34;
        A1[Controller层]
        A2[Service层]
        A3[AI Service层]
    end

    subgraph &amp;#34;AI框架层&amp;#34;
        F1[Spring AI Alibaba]
        F2[LangChain4j]
    end

    subgraph &amp;#34;AI能力层&amp;#34;
        C1[Chat对话]
        C2[RAG检索]
        C3[Agent执行]
        C4[Embedding]
    end

    subgraph &amp;#34;模型层&amp;#34;
        M1[通义千问]
        M2[Claude]
        M3[GPT-4]
    end

    subgraph &amp;#34;数据层&amp;#34;
        D1[(MySQL)]
        D2[(向量数据库)]
        D3[(Redis)]
    end

    U1 &amp; U2 &amp; U3 --&gt; A1
    A1 --&gt; A2
    A2 --&gt; A3
    A3 --&gt; F1 &amp; F2
    F1 &amp; F2 --&gt; C1 &amp; C2 &amp; C3 &amp; C4
    C1 &amp; C2 &amp; C3 &amp; C4 --&gt; M1 &amp; M2 &amp; M3
    A2 &amp; A3 --&gt; D1 &amp; D2 &amp; D3

    style A3 fill:#e1f5ff
    style F1 fill:#fff4e1
    style F2 fill:#fff4e1
</code></pre>
<h4 data-id="heading-36"><strong>5.1.2 分层设计原则</strong></h4>
<p><strong>1. 控制层（Controller）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/ai/chat")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatService chatService;

    <span class="hljs-meta">@PostMapping("/stream")</span>
    <span class="hljs-keyword">public</span> SseEmitter <span class="hljs-title function_">chatStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ChatRequest request)</span> {
        <span class="hljs-comment">// 处理流式响应</span>
        <span class="hljs-keyword">return</span> chatService.streamChat(request);
    }

    <span class="hljs-meta">@PostMapping("/sync")</span>
    <span class="hljs-keyword">public</span> Result&lt;ChatResponse&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ChatRequest request)</span> {
        <span class="hljs-comment">// 同步响应</span>
        <span class="hljs-keyword">return</span> Result.success(chatService.chat(request));
    }
}
</code></pre>
<p><strong>2. 服务层（Service）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatService</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;  <span class="hljs-comment">// Spring AI</span>

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ConversationService conversationService;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> RagService ragService;

    <span class="hljs-keyword">public</span> ChatResponse <span class="hljs-title function_">chat</span><span class="hljs-params">(ChatRequest request)</span> {
        <span class="hljs-comment">// 1. 加载历史对话</span>
        List&lt;Message&gt; history = conversationService.getHistory(request.getSessionId());

        <span class="hljs-comment">// 2. RAG检索</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> ragService.retrieve(request.getQuestion());

        <span class="hljs-comment">// 3. 构建Prompt</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> buildPrompt(request.getQuestion(), context);

        <span class="hljs-comment">// 4. 调用大模型</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.call(prompt);

        <span class="hljs-comment">// 5. 保存对话</span>
        conversationService.save(request.getSessionId(), request.getQuestion(), response);

        <span class="hljs-keyword">return</span> ChatResponse.builder()
            .answer(response)
            .sessionId(request.getSessionId())
            .build();
    }
}
</code></pre>
<h3 data-id="heading-37">5.2 Java生态AI框架深度对比</h3>
<h4 data-id="heading-38"><strong>5.2.1 Spring AI Alibaba详解</strong></h4>
<p><strong>定位：</strong> 阿里云官方AI框架，深度集成阿里云百炼平台，也支持OpenAI等。</p>
<p><strong>核心特性：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((Spring AI Alibaba))
    统一抽象
      ChatClient
      ImageClient
      AudioClient
      EmbeddingClient
    模型支持
      通义千问
      通义万相
      百炼平台
      OpenAI兼容
    RAG支持
      DocumentReader
      VectorStore
      Retriever
    Spring集成
      自动配置
      依赖注入
      配置属性
    企业特性
      可观测性
      限流降级
      安全审计
</code></pre>
<p><strong>快速开始：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-ai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0-M2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">dashscope:</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">${DASHSCOPE_API_KEY}</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">qwen-max</span>
          <span class="hljs-attr">temperature:</span> <span class="hljs-number">0.7</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AiService</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-keyword">return</span> chatClient.call(message);
    }

    <span class="hljs-comment">// 流式响应</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">streamChat</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-keyword">return</span> chatClient.stream(message)
            .map(ChatResponse::getResult)
            .map(result -&gt; result.getOutput().getContent());
    }
}
</code></pre>
<p><strong>RAG实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RagConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> VectorStore <span class="hljs-title function_">vectorStore</span><span class="hljs-params">(EmbeddingClient embeddingClient)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleVectorStore</span>(embeddingClient);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DocumentReader <span class="hljs-title function_">pdfReader</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PagePdfDocumentReader</span>(<span class="hljs-string">"classpath:docs/manual.pdf"</span>);
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RagService</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> VectorStore vectorStore;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">ragChat</span><span class="hljs-params">(String question)</span> {
        <span class="hljs-comment">// 1. 检索相关文档</span>
        List&lt;Document&gt; docs = vectorStore.similaritySearch(
            SearchRequest.query(question).withTopK(<span class="hljs-number">3</span>)
        );

        <span class="hljs-comment">// 2. 构建Prompt</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> docs.stream()
            .map(Document::getContent)
            .collect(Collectors.joining(<span class="hljs-string">"\n"</span>));

        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
            基于以下信息回答问题：

            %s

            问题：%s
            """</span>.formatted(context, question);

        <span class="hljs-comment">// 3. 调用大模型</span>
        <span class="hljs-keyword">return</span> chatClient.call(prompt);
    }
}
</code></pre>
<h4 data-id="heading-39"><strong>5.2.2 LangChain4j详解</strong></h4>
<p><strong>定位：</strong> Java版LangChain，功能最全面的Java AI框架。</p>
<p><strong>核心特性：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[LangChain4j] --&gt; B[模型抽象]
    A --&gt; C[AI Services]
    A --&gt; D[Tools/Agents]
    A --&gt; E[RAG链路]
    A --&gt; F[Memory管理]

    B --&gt; B1[20+模型支持]
    B --&gt; B2[统一接口]

    C --&gt; C1[接口式AI]
    C --&gt; C2[自动Prompt]

    D --&gt; D1[函数调用]
    D --&gt; D2[ReAct Agent]

    E --&gt; E1[文档加载器]
    E --&gt; E2[向量存储]
    E --&gt; E3[检索器]

    F --&gt; F1[对话记忆]
    F --&gt; F2[Token管理]
</code></pre>
<p><strong>快速开始：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.35.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.35.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AI Services - 接口式编程</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Assistant</span> {

    <span class="hljs-meta">@SystemMessage("你是一个Java专家，帮助开发者解决技术问题")</span>
    String <span class="hljs-title function_">chat</span><span class="hljs-params">(String userMessage)</span>;

    <span class="hljs-meta">@UserMessage("""
        分析以下代码的问题：
        ```java
        {{code}}
        ```
        """)</span>
    String <span class="hljs-title function_">analyzeCode</span><span class="hljs-params">(<span class="hljs-meta">@V("code")</span> String code)</span>;
}

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LangChain4jConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Assistant <span class="hljs-title function_">assistant</span><span class="hljs-params">(<span class="hljs-meta">@Value("${openai.api.key}")</span> String apiKey)</span> {
        <span class="hljs-type">ChatLanguageModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> OpenAiChatModel.builder()
            .apiKey(apiKey)
            .modelName(GPT_4_O)
            .temperature(<span class="hljs-number">0.7</span>)
            .build();

        <span class="hljs-keyword">return</span> AiServices.create(Assistant.class, model);
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeReviewService</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Assistant assistant;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">reviewCode</span><span class="hljs-params">(String code)</span> {
        <span class="hljs-keyword">return</span> assistant.analyzeCode(code);
    }
}
</code></pre>
<p><strong>Tools（函数调用）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义工具</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseTools</span> {

    <span class="hljs-meta">@Tool("查询用户信息")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@P("用户ID")</span> Long userId)</span> {
        <span class="hljs-comment">// 实际数据库查询</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(userId);
        <span class="hljs-keyword">return</span> JSON.toJSONString(user);
    }

    <span class="hljs-meta">@Tool("更新用户状态")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateUserStatus</span><span class="hljs-params">(
        <span class="hljs-meta">@P("用户ID")</span> Long userId,
        <span class="hljs-meta">@P("状态")</span> String status)</span> {
        userMapper.updateStatus(userId, status);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"更新成功"</span>;
    }
}

<span class="hljs-comment">// 配置Agent</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Assistant <span class="hljs-title function_">agentAssistant</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ChatLanguageModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> OpenAiChatModel.builder()
        .apiKey(apiKey)
        .modelName(GPT_4_O)
        .build();

    <span class="hljs-keyword">return</span> AiServices.builder(Assistant.class)
        .chatLanguageModel(model)
        .tools(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseTools</span>())  <span class="hljs-comment">// 注册工具</span>
        .chatMemory(MessageWindowChatMemory.withMaxMessages(<span class="hljs-number">10</span>))
        .build();
}
</code></pre>
<p><strong>RAG完整实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentRagService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmbeddingStore&lt;TextSegment&gt; embeddingStore;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmbeddingModel embeddingModel;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatLanguageModel chatModel;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DocumentRagService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 初始化Embedding模型</span>
        <span class="hljs-built_in">this</span>.embeddingModel = OpenAiEmbeddingModel.builder()
            .apiKey(apiKey)
            .modelName(<span class="hljs-string">"text-embedding-3-small"</span>)
            .build();

        <span class="hljs-comment">// 2. 初始化向量数据库</span>
        <span class="hljs-built_in">this</span>.embeddingStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryEmbeddingStore</span>&lt;&gt;();

        <span class="hljs-comment">// 3. 初始化Chat模型</span>
        <span class="hljs-built_in">this</span>.chatModel = OpenAiChatModel.builder()
            .apiKey(apiKey)
            .modelName(GPT_4_O)
            .build();

        <span class="hljs-comment">// 4. 加载文档</span>
        loadDocuments();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadDocuments</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 读取文档</span>
        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> FileSystemDocumentLoader.loadDocument(
            <span class="hljs-string">"docs/knowledge.pdf"</span>,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApachePdfBoxDocumentParser</span>()
        );

        <span class="hljs-comment">// 文档分块</span>
        <span class="hljs-type">DocumentSplitter</span> <span class="hljs-variable">splitter</span> <span class="hljs-operator">=</span> DocumentSplitters.recursive(
            <span class="hljs-number">500</span>,  <span class="hljs-comment">// chunk size</span>
            <span class="hljs-number">50</span>    <span class="hljs-comment">// overlap</span>
        );
        List&lt;TextSegment&gt; segments = splitter.split(document);

        <span class="hljs-comment">// 向量化并存储</span>
        List&lt;Embedding&gt; embeddings = embeddingModel.embedAll(segments).content();
        embeddingStore.addAll(embeddings, segments);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">ragQuery</span><span class="hljs-params">(String question)</span> {
        <span class="hljs-comment">// 1. 检索相关文档</span>
        <span class="hljs-type">Embedding</span> <span class="hljs-variable">questionEmbedding</span> <span class="hljs-operator">=</span> embeddingModel.embed(question).content();
        List&lt;EmbeddingMatch&lt;TextSegment&gt;&gt; matches = embeddingStore.findRelevant(
            questionEmbedding,
            <span class="hljs-number">3</span>,  <span class="hljs-comment">// top-k</span>
            <span class="hljs-number">0.7</span> <span class="hljs-comment">// 最小相似度</span>
        );

        <span class="hljs-comment">// 2. 构建上下文</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> matches.stream()
            .map(match -&gt; match.embedded().text())
            .collect(Collectors.joining(<span class="hljs-string">"\n\n"</span>));

        <span class="hljs-comment">// 3. 构建Prompt</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> PromptTemplate.from(<span class="hljs-string">"""
            基于以下信息回答问题：

            {{context}}

            问题：{{question}}

            要求：
            1. 只基于提供的信息回答
            2. 如果信息不足，明确说明
            3. 给出信息来源
            """</span>)
            .apply(Map.of(
                <span class="hljs-string">"context"</span>, context,
                <span class="hljs-string">"question"</span>, question
            ))
            .text();

        <span class="hljs-comment">// 4. 生成答案</span>
        <span class="hljs-keyword">return</span> chatModel.generate(prompt);
    }
}
</code></pre>
<h4 data-id="heading-40"><strong>5.2.3 框架对比总结</strong></h4>























































<table><thead><tr><th>维度</th><th>Spring AI Alibaba</th><th>LangChain4j</th></tr></thead><tbody><tr><td><strong>定位</strong></td><td>Spring生态集成，国内优化</td><td>功能全面，社区活跃</td></tr><tr><td><strong>上手难度</strong></td><td>简单（Spring开发者）</td><td>中等</td></tr><tr><td><strong>文档</strong></td><td>中文文档完善</td><td>英文为主，示例丰富</td></tr><tr><td><strong>模型支持</strong></td><td>侧重阿里云、OpenAI兼容</td><td>20+主流模型</td></tr><tr><td><strong>功能丰富度</strong></td><td>核心功能</td><td>非常全面（Tools、Agent等）</td></tr><tr><td><strong>生态集成</strong></td><td>Spring Boot深度集成</td><td>多框架支持</td></tr><tr><td><strong>企业特性</strong></td><td>可观测性、限流等</td><td>需自行集成</td></tr><tr><td><strong>适用场景</strong></td><td>使用阿里云、Spring项目</td><td>复杂AI应用、多模型切换</td></tr><tr><td><strong>开源活跃度</strong></td><td>较新，快速迭代</td><td>非常活跃</td></tr></tbody></table>
<p><strong>选择建议：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[选择框架] --&gt; B{使用阿里云?}
    B --&gt;|是| C[Spring AI Alibaba]
    B --&gt;|否| D{需要复杂Agent?}

    D --&gt;|是| E[LangChain4j]
    D --&gt;|否| F{团队熟悉Spring?}

    F --&gt;|是| G[Spring AI Alibaba]
    F --&gt;|否| E

    C --&gt; H[开始开发]
    E --&gt; H
    G --&gt; H

    style H fill:#e1ffe1
</code></pre>
<h3 data-id="heading-41">5.3 AI工程化最佳实践</h3>
<h4 data-id="heading-42"><strong>5.3.1 项目结构设计</strong></h4>
<pre><code class="hljs language-bash" lang="bash">my-ai-application/
├── src/main/java/
│   ├── config/                 <span class="hljs-comment"># 配置类</span>
│   │   ├── AiConfig.java      <span class="hljs-comment"># AI框架配置</span>
│   │   ├── VectorStoreConfig.java
│   │   └── PromptConfig.java
│   ├── controller/            <span class="hljs-comment"># 控制器</span>
│   │   ├── ChatController.java
│   │   └── RagController.java
│   ├── service/               <span class="hljs-comment"># 业务服务</span>
│   │   ├── ChatService.java
│   │   ├── RagService.java
│   │   └── AgentService.java
│   ├── ai/                    <span class="hljs-comment"># AI核心</span>
│   │   ├── prompt/           <span class="hljs-comment"># Prompt管理</span>
│   │   │   ├── PromptTemplate.java
│   │   │   └── templates/
│   │   │       ├── chat.txt
│   │   │       └── rag.txt
│   │   ├── tools/            <span class="hljs-comment"># AI工具</span>
│   │   │   ├── DatabaseTool.java
│   │   │   └── ApiTool.java
│   │   ├── chain/            <span class="hljs-comment"># 执行链</span>
│   │   │   ├── RagChain.java
│   │   │   └── AgentChain.java
│   │   └── memory/           <span class="hljs-comment"># 记忆管理</span>
│   │       └── ConversationMemory.java
│   ├── domain/               <span class="hljs-comment"># 领域模型</span>
│   ├── repository/           <span class="hljs-comment"># 数据访问</span>
│   └── utils/                <span class="hljs-comment"># 工具类</span>
├── src/main/resources/
│   ├── prompts/              <span class="hljs-comment"># Prompt模板</span>
│   │   ├── system.txt
│   │   ├── user.txt
│   │   └── rag.txt
│   ├── documents/            <span class="hljs-comment"># 知识库文档</span>
│   └── application.yml
└── src/test/
</code></pre>
<h4 data-id="heading-43"><strong>5.3.2 Prompt管理</strong></h4>
<p><strong>1. 模板化管理</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PromptTemplateManager</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; templates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadTemplates</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 从文件加载</span>
        templates.put(<span class="hljs-string">"chat"</span>, loadFromFile(<span class="hljs-string">"prompts/chat.txt"</span>));
        templates.put(<span class="hljs-string">"rag"</span>, loadFromFile(<span class="hljs-string">"prompts/rag.txt"</span>));
        templates.put(<span class="hljs-string">"code_review"</span>, loadFromFile(<span class="hljs-string">"prompts/code_review.txt"</span>));
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPrompt</span><span class="hljs-params">(String templateName, Map&lt;String, String&gt; variables)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> templates.get(templateName);
        <span class="hljs-keyword">return</span> replaceVariables(template, variables);
    }
}
</code></pre>
<p><strong>2. Prompt版本控制</strong></p>
<pre><code class="hljs language-rust" lang="rust">prompts/
├── v1/
│   ├── chat.txt
│   └── rag.txt
├── v2/
│   ├── chat.txt
│   └── rag.txt
└── current <span class="hljs-punctuation">-&gt;</span> v2/
</code></pre>
<p><strong>3. A/B测试框架</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PromptExperimentService</span> {

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chatWithExperiment</span><span class="hljs-params">(String message, String userId)</span> {
        <span class="hljs-comment">// 根据用户分组选择不同Prompt</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">promptVersion</span> <span class="hljs-operator">=</span> getUserGroup(userId);
        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> promptManager.getPrompt(promptVersion, Map.of(<span class="hljs-string">"message"</span>, message));

        <span class="hljs-comment">// 记录实验数据</span>
        experimentTracker.track(userId, promptVersion, message);

        <span class="hljs-keyword">return</span> chatClient.call(prompt);
    }
}
</code></pre>
<h4 data-id="heading-44"><strong>5.3.3 模型管理</strong></h4>
<p><strong>1. 多模型策略</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelRouter</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient gpt4Client;     <span class="hljs-comment">// 复杂任务</span>

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient gpt35Client;    <span class="hljs-comment">// 简单任务</span>

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient qwenClient;     <span class="hljs-comment">// 备用模型</span>

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-comment">// 根据复杂度路由</span>
        <span class="hljs-keyword">if</span> (isComplexQuery(message)) {
            <span class="hljs-keyword">return</span> gpt4Client.call(message);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> gpt35Client.call(message);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isComplexQuery</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-comment">// 简单判断逻辑</span>
        <span class="hljs-keyword">return</span> message.length() &gt; <span class="hljs-number">200</span> ||
               message.contains(<span class="hljs-string">"分析"</span>) ||
               message.contains(<span class="hljs-string">"设计"</span>);
    }
}
</code></pre>
<p><strong>2. 降级策略</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FallbackService</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ModelRouter modelRouter;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> CacheManager cacheManager;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chatWithFallback</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 主模型</span>
            <span class="hljs-keyword">return</span> modelRouter.chat(message);
        } <span class="hljs-keyword">catch</span> (RateLimitException e) {
            <span class="hljs-comment">// 降级到备用模型</span>
            log.warn(<span class="hljs-string">"主模型限流，切换备用模型"</span>);
            <span class="hljs-keyword">return</span> qwenClient.call(message);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 返回缓存结果</span>
            <span class="hljs-keyword">return</span> cacheManager.getCachedResponse(message)
                .orElse(<span class="hljs-string">"服务暂时不可用，请稍后重试"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-45"><strong>5.3.4 监控与可观测</strong></h4>
<p><strong>1. 指标监控</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AiMetricsAspect</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> MeterRegistry meterRegistry;

    <span class="hljs-meta">@Around("@annotation(AiMonitored)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">monitor</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        Timer.<span class="hljs-type">Sample</span> <span class="hljs-variable">sample</span> <span class="hljs-operator">=</span> Timer.start(meterRegistry);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pjp.proceed();

            <span class="hljs-comment">// 记录成功</span>
            sample.stop(Timer.builder(<span class="hljs-string">"ai.call"</span>)
                .tag(<span class="hljs-string">"method"</span>, pjp.getSignature().getName())
                .tag(<span class="hljs-string">"status"</span>, <span class="hljs-string">"success"</span>)
                .register(meterRegistry));

            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 记录失败</span>
            sample.stop(Timer.builder(<span class="hljs-string">"ai.call"</span>)
                .tag(<span class="hljs-string">"method"</span>, pjp.getSignature().getName())
                .tag(<span class="hljs-string">"status"</span>, <span class="hljs-string">"error"</span>)
                .tag(<span class="hljs-string">"error"</span>, e.getClass().getSimpleName())
                .register(meterRegistry));
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p><strong>2. 日志记录</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AiLogger</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> AiLogRepository logRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logInteraction</span><span class="hljs-params">(String sessionId, String input, String output,
                               <span class="hljs-type">long</span> latency, <span class="hljs-type">int</span> tokens)</span> {
        <span class="hljs-type">AiLog</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> AiLog.builder()
            .sessionId(sessionId)
            .input(input)
            .output(output)
            .latency(latency)
            .tokens(tokens)
            .cost(calculateCost(tokens))
            .timestamp(LocalDateTime.now())
            .build();

        logRepository.save(log);
    }

    <span class="hljs-keyword">private</span> BigDecimal <span class="hljs-title function_">calculateCost</span><span class="hljs-params">(<span class="hljs-type">int</span> tokens)</span> {
        <span class="hljs-comment">// 根据Token数计算成本</span>
        <span class="hljs-keyword">return</span> BigDecimal.valueOf(tokens)
            .multiply(BigDecimal.valueOf(<span class="hljs-number">0.00001</span>));
    }
}
</code></pre>
<p><strong>3. 链路追踪</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TracedChatService</span> {

    <span class="hljs-meta">@NewSpan("ai.chat")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@SpanTag("session.id")</span> String sessionId,
                       <span class="hljs-meta">@SpanTag("input")</span> String message)</span> {

        <span class="hljs-type">Span</span> <span class="hljs-variable">currentSpan</span> <span class="hljs-operator">=</span> tracer.currentSpan();

        <span class="hljs-comment">// 检索阶段</span>
        currentSpan.tag(<span class="hljs-string">"stage"</span>, <span class="hljs-string">"retrieve"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> ragService.retrieve(message);
        currentSpan.tag(<span class="hljs-string">"retrieved.docs"</span>, String.valueOf(context.split(<span class="hljs-string">"\n"</span>).length));

        <span class="hljs-comment">// 生成阶段</span>
        currentSpan.tag(<span class="hljs-string">"stage"</span>, <span class="hljs-string">"generate"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.call(buildPrompt(message, context));
        currentSpan.tag(<span class="hljs-string">"response.length"</span>, String.valueOf(response.length()));

        <span class="hljs-keyword">return</span> response;
    }
}
</code></pre>
<h4 data-id="heading-46"><strong>5.3.5 测试策略</strong></h4>
<p><strong>1. 单元测试</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatServiceTest</span> {

    <span class="hljs-meta">@MockBean</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatService chatService;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testChat</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Mock</span>
        when(chatClient.call(anyString()))
            .thenReturn(<span class="hljs-string">"这是测试回复"</span>);

        <span class="hljs-comment">// 执行</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatService.chat(<span class="hljs-string">"测试问题"</span>);

        <span class="hljs-comment">// 验证</span>
        assertThat(response).isEqualTo(<span class="hljs-string">"这是测试回复"</span>);
        verify(chatClient).call(anyString());
    }
}
</code></pre>
<p><strong>2. Prompt测试</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">testPromptQuality</span><span class="hljs-params">()</span> {
    List&lt;TestCase&gt; testCases = loadTestCases();

    <span class="hljs-keyword">for</span> (TestCase testCase : testCases) {
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatService.chat(testCase.getInput());

        <span class="hljs-comment">// 评估回复质量</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> evaluateResponse(response, testCase.getExpectedKeywords());

        assertThat(score).isGreaterThan(<span class="hljs-number">0.8</span>);
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">evaluateResponse</span><span class="hljs-params">(String response, List&lt;String&gt; keywords)</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">matchCount</span> <span class="hljs-operator">=</span> keywords.stream()
        .filter(response::contains)
        .count();
    <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) matchCount / keywords.size();
}
</code></pre>
<p><strong>3. 集成测试</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatControllerIntegrationTest</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> TestRestTemplate restTemplate;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testChatEndpoint</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ChatRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRequest</span>();
        request.setMessage(<span class="hljs-string">"测试问题"</span>);
        request.setSessionId(<span class="hljs-string">"test-session"</span>);

        ResponseEntity&lt;ChatResponse&gt; response = restTemplate.postForEntity(
            <span class="hljs-string">"/ai/chat"</span>,
            request,
            ChatResponse.class
        );

        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getAnswer()).isNotEmpty();
    }
}
</code></pre>
<h3 data-id="heading-47">5.4 典型应用场景实战</h3>
<h4 data-id="heading-48"><strong>5.4.1 场景一：智能客服系统</strong></h4>
<p><strong>架构设计：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    U[用户] --&gt; W[Web/App]
    W --&gt; G[API Gateway]
    G --&gt; CS[客服Service]

    CS --&gt; IT[意图识别]
    CS --&gt; RAG[知识库检索]
    CS --&gt; WF[工单流转]

    IT --&gt; LLM[大模型]
    RAG --&gt; VS[(向量数据库)]
    WF --&gt; DB[(MySQL)]

    CS --&gt; Cache[(Redis缓存)]
    CS --&gt; MQ[消息队列]

    style CS fill:#e1f5ff
</code></pre>
<p><strong>核心代码：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceAI</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> KnowledgeBaseService knowledgeBase;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> IntentClassifier intentClassifier;

    <span class="hljs-keyword">public</span> CustomerServiceResponse <span class="hljs-title function_">handle</span><span class="hljs-params">(String userMessage, String sessionId)</span> {
        <span class="hljs-comment">// 1. 意图识别</span>
        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> intentClassifier.classify(userMessage);

        <span class="hljs-comment">// 2. 根据意图路由</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span> (intent) {
            <span class="hljs-keyword">case</span> FAQ -&gt; handleFAQ(userMessage);
            <span class="hljs-keyword">case</span> COMPLAINT -&gt; handleComplaint(userMessage, sessionId);
            <span class="hljs-keyword">case</span> ORDER_QUERY -&gt; handleOrderQuery(userMessage);
            <span class="hljs-keyword">default</span> -&gt; handleGeneral(userMessage);
        };
    }

    <span class="hljs-keyword">private</span> CustomerServiceResponse <span class="hljs-title function_">handleFAQ</span><span class="hljs-params">(String question)</span> {
        <span class="hljs-comment">// RAG检索知识库</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> knowledgeBase.search(question);

        <span class="hljs-keyword">if</span> (answer != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> CustomerServiceResponse.builder()
                .answer(answer)
                .source(<span class="hljs-string">"knowledge_base"</span>)
                .confidence(<span class="hljs-number">0.9</span>)
                .build();
        }

        <span class="hljs-comment">// 降级到大模型</span>
        <span class="hljs-keyword">return</span> handleGeneral(question);
    }

    <span class="hljs-keyword">private</span> CustomerServiceResponse <span class="hljs-title function_">handleComplaint</span><span class="hljs-params">(String message, String sessionId)</span> {
        <span class="hljs-comment">// 创建工单</span>
        <span class="hljs-type">Ticket</span> <span class="hljs-variable">ticket</span> <span class="hljs-operator">=</span> ticketService.create(message, sessionId);

        <span class="hljs-comment">// AI生成安抚话术</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.call(
            <span class="hljs-string">"用户投诉："</span> + message + <span class="hljs-string">"\n请生成专业的安抚回复"</span>
        );

        <span class="hljs-keyword">return</span> CustomerServiceResponse.builder()
            .answer(response)
            .ticketId(ticket.getId())
            .needHumanIntervention(<span class="hljs-literal">true</span>)
            .build();
    }
}
</code></pre>
<h4 data-id="heading-49"><strong>5.4.2 场景二：代码助手</strong></h4>
<p><strong>功能模块：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((代码助手))
    代码生成
      根据需求生成代码
      单元测试生成
      文档生成
    代码审查
      安全漏洞检测
      性能问题分析
      代码规范检查
    代码解释
      逐行解释
      架构分析
      依赖关系
    重构建议
      设计模式应用
      代码简化
      性能优化
</code></pre>
<p><strong>实现示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeAssistant</span> {

    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Assistant</span> {
        <span class="hljs-meta">@SystemMessage("""
            你是一位资深Java架构师，擅长：
            1. 代码审查和优化建议
            2. 设计模式应用
            3. 性能优化
            4. 安全漏洞检测
            """)</span>
        String <span class="hljs-title function_">reviewCode</span><span class="hljs-params">(<span class="hljs-meta">@UserMessage</span> String code)</span>;

        <span class="hljs-meta">@UserMessage("""
            请为以下方法生成单元测试：
            ```java
            {{code}}
            ```
            要求：
            - 使用JUnit 5和Mockito
            - 覆盖正常和异常情况
            - 包含边界条件测试
            """)</span>
        String <span class="hljs-title function_">generateTest</span><span class="hljs-params">(<span class="hljs-meta">@V("code")</span> String code)</span>;
    }

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Assistant assistant;

    <span class="hljs-keyword">public</span> CodeReviewResult <span class="hljs-title function_">review</span><span class="hljs-params">(String code)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">review</span> <span class="hljs-operator">=</span> assistant.reviewCode(code);
        <span class="hljs-keyword">return</span> parseReviewResult(review);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateUnitTest</span><span class="hljs-params">(String methodCode)</span> {
        <span class="hljs-keyword">return</span> assistant.generateTest(methodCode);
    }
}
</code></pre>
<h4 data-id="heading-50"><strong>5.4.3 场景三：文档问答系统</strong></h4>
<p><strong>系统架构：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph &amp;#34;数据准备&amp;#34;
        D[文档上传] --&gt; P[解析]
        P --&gt; S[分块]
        S --&gt; E[Embedding]
        E --&gt; V[(向量库)]
    end

    subgraph &amp;#34;查询流程&amp;#34;
        Q[用户提问] --&gt; QE[Query Embedding]
        QE --&gt; R[检索]
        V --&gt; R
        R --&gt; F[过滤重排]
        F --&gt; G[生成答案]
        G --&gt; A[返回]
    end

    style V fill:#e1f5ff
    style G fill:#ffe1e1
</code></pre>
<p><strong>完整实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentQAService</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> EmbeddingModel embeddingModel;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> VectorStore vectorStore;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;

    <span class="hljs-comment">/**
     * 文档导入
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importDocuments</span><span class="hljs-params">(List&lt;MultipartFile&gt; files)</span> {
        files.forEach(file -&gt; {
            <span class="hljs-comment">// 1. 解析文档</span>
            <span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> parseDocument(file);

            <span class="hljs-comment">// 2. 文档分块</span>
            List&lt;TextSegment&gt; segments = splitDocument(doc);

            <span class="hljs-comment">// 3. 向量化</span>
            List&lt;Embedding&gt; embeddings = embeddingModel.embedAll(segments).content();

            <span class="hljs-comment">// 4. 存储</span>
            vectorStore.addAll(embeddings, segments);
        });
    }

    <span class="hljs-comment">/**
     * 问答
     */</span>
    <span class="hljs-keyword">public</span> QAResponse <span class="hljs-title function_">query</span><span class="hljs-params">(String question)</span> {
        <span class="hljs-comment">// 1. 检索相关文档</span>
        List&lt;Document&gt; relevantDocs = retrieveRelevantDocs(question, <span class="hljs-number">5</span>);

        <span class="hljs-comment">// 2. 重排序</span>
        List&lt;Document&gt; rerankedDocs = rerank(question, relevantDocs);

        <span class="hljs-comment">// 3. 构建Prompt</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> buildQAPrompt(question, rerankedDocs);

        <span class="hljs-comment">// 4. 生成答案</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> chatClient.call(prompt);

        <span class="hljs-comment">// 5. 提取引用</span>
        List&lt;Citation&gt; citations = extractCitations(rerankedDocs);

        <span class="hljs-keyword">return</span> QAResponse.builder()
            .answer(answer)
            .citations(citations)
            .confidence(calculateConfidence(rerankedDocs))
            .build();
    }

    <span class="hljs-keyword">private</span> List&lt;Document&gt; <span class="hljs-title function_">retrieveRelevantDocs</span><span class="hljs-params">(String query, <span class="hljs-type">int</span> topK)</span> {
        <span class="hljs-type">Embedding</span> <span class="hljs-variable">queryEmbedding</span> <span class="hljs-operator">=</span> embeddingModel.embed(query).content();

        <span class="hljs-keyword">return</span> vectorStore.findRelevant(queryEmbedding, topK, <span class="hljs-number">0.7</span>)
            .stream()
            .map(EmbeddingMatch::embedded)
            .map(segment -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(segment.text()))
            .collect(Collectors.toList());
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildQAPrompt</span><span class="hljs-params">(String question, List&lt;Document&gt; docs)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> docs.stream()
            .map(Document::text)
            .collect(Collectors.joining(<span class="hljs-string">"\n\n---\n\n"</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-string">"""
            # 任务
            基于以下文档内容回答用户问题。

            # 文档内容
            %s

            # 用户问题
            %s

            # 要求
            1. 仅基于提供的文档内容回答
            2. 如果文档中没有相关信息，明确说明
            3. 给出具体的文档引用
            4. 回答要准确、简洁
            """</span>.formatted(context, question);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Supabase Postgres Docker 容器化部署指南]]></title>    <link>https://juejin.cn/post/7585706951603650586</link>    <guid>https://juejin.cn/post/7585706951603650586</guid>    <pubDate>2025-12-21T02:39:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951603650586" data-draft-id="7585463195202404402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Supabase Postgres Docker 容器化部署指南"/> <meta itemprop="keywords" content="PostgreSQL,Docker"/> <meta itemprop="datePublished" content="2025-12-21T02:39:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老赵"/> <meta itemprop="url" content="https://juejin.cn/user/3208848015890347"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Supabase Postgres Docker 容器化部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3208848015890347/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老赵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T02:39:19.000Z" title="Sun Dec 21 2025 02:39:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>Supabase Postgres 是一款基于PostgreSQL官方镜像构建的容器化应用，集成了多种实用插件，旨在为开发者提供便捷、可靠的数据库服务。该镜像保持了PostgreSQL的原生功能特性，同时预装了PostGIS、pg_cron、pgAudit等常用扩展，满足地理信息处理、定时任务、审计日志等多样化需求。</p>
<p>本文档将详细介绍如何通过Docker容器化方式部署Supabase Postgres，包括环境准备、镜像拉取、容器配置、功能测试及生产环境优化建议，帮助用户快速搭建稳定的Supabase Postgres数据库服务。推荐使用标签<code>17.6.0.023-orioledb</code>进行部署，更多版本信息可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fxuanyuan.cloud%2Fr%2Fsupabase%2Fpostgres%2Ftags" title="https://xuanyuan.cloud/r/supabase/postgres/tags" target="_blank" ref="nofollow noopener noreferrer">Postgres 镜像标签列表（轩辕）</a>。</p>
<h2 data-id="heading-1">环境准备</h2>
<h3 data-id="heading-2">Docker环境安装</h3>
<p>部署Supabase Postgres容器前，需先确保服务器已安装Docker环境。推荐使用以下一键安装脚本：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">bash</span> &lt;(wget -qO- <span class="hljs-attribute">https</span>:<span class="hljs-comment">//xuanyuan.cloud/docker.sh)</span>
</code></pre>
<p>脚本执行完成后，可通过<code>docker --version</code>命令验证安装是否成功，出现类似<code>Docker version 20.10.xx, build xxxxxxx</code>的输出即表示Docker环境就绪。</p>
<p>轩辕镜像访问支持可改善镜像访问体验；镜像来源于官方公共仓库，平台不存储不修改镜像内容。</p>
<h2 data-id="heading-3">镜像准备</h2>
<h3 data-id="heading-4">拉取Supabase Postgres镜像</h3>
<p>使用以下命令通过轩辕镜像访问支持域名拉取推荐版本的POSTGRES镜像：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker pull xxx.xuanyuan.run/supabase/postgres:<span class="hljs-number">17.6</span><span class="hljs-number">.0</span><span class="hljs-number">.023</span>-orioledb
</code></pre>
<p>拉取完成后，可通过<code>docker images | grep supabase/postgres</code>命令验证镜像是否成功获取，输出应包含<code>xxx.xuanyuan.run/supabase/postgres</code>及对应标签信息。</p>
<h2 data-id="heading-5">容器部署</h2>
<h3 data-id="heading-6">基础部署命令</h3>
<p>使用以下命令启动Supabase Postgres容器，包含基础的端口映射、数据持久化及环境变量配置：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \  --name postgres-container \  -p 5432:5432 \  -v postgres-data:/var/lib/postgresql/data \  -e POSTGRES_PASSWORD=your_secure_password \  --<span class="hljs-built_in">command</span> <span class="hljs-string">"postgres -c config_file=/etc/postgresql/postgresql.conf"</span> \  xxx.xuanyuan.run/supabase/postgres:17.6.0.023-orioledb
</code></pre>
<p><strong>参数说明</strong>：</p>
<ul>
<li>• <code>-d</code>：后台运行容器</li>
<li>• <code>--name postgres-container</code>：指定容器名称为<code>postgres-container</code>，便于后续管理</li>
<li>• <code>-p 5432:5432</code>：将容器内5432端口映射到主机5432端口（PostgreSQL默认端口）</li>
<li>• <code>-v postgres-data:/var/lib/postgresql/data</code>：使用命名卷<code>postgres-data</code>持久化数据库数据，避免容器删除导致数据丢失</li>
<li>• <code>-e POSTGRES_PASSWORD=your_secure_password</code>：设置数据库超级用户密码，建议使用强密码并妥善保管</li>
<li>• <code>--command</code>：指定启动命令，加载自定义配置文件（适用于14.1.0及以上版本）</li>
</ul>
<h3 data-id="heading-7">自定义配置部署</h3>
<p>如需调整数据库配置（如内存分配、连接数限制等），可通过挂载本地配置文件实现：</p>
<ol>
<li>
<p>1. 从容器中复制默认配置文件到本地：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">cp</span> postgres-container:/etc/postgresql/postgresql.conf ./postgresql.conf
</code></pre>
</li>
<li>
<p>2. 编辑本地<code>postgresql.conf</code>文件，根据需求调整参数（如<code>max_connections</code>、<code>shared_buffers</code>等）</p>
</li>
<li>
<p>3. 使用自定义配置文件启动容器：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \  --name postgres-container \  -p 5432:5432 \  -v $(<span class="hljs-built_in">pwd</span>)/postgresql.conf:/etc/postgresql/postgresql.conf \  -v postgres-data:/var/lib/postgresql/data \  -e POSTGRES_PASSWORD=your_secure_password \  xxx.xuanyuan.run/supabase/postgres:17.6.0.023-orioledb
</code></pre>
</li>
</ol>
<h2 data-id="heading-8">功能测试</h2>
<h3 data-id="heading-9">容器状态检查</h3>
<p>部署完成后，首先检查容器运行状态：</p>
<pre><code class="hljs language-python" lang="python">docker ps --<span class="hljs-built_in">filter</span> <span class="hljs-string">"name=postgres-container"</span>
</code></pre>
<p>若输出中<code>STATUS</code>字段显示为<code>Up</code>，表示容器正常运行。</p>
<h3 data-id="heading-10">日志验证</h3>
<p>通过查看容器日志确认服务启动状态及是否存在异常：</p>
<pre><code class="hljs">docker logs postgres-container
</code></pre>
<p>正常启动时，日志末尾应包含类似<code>database system is ready to accept connections</code>的提示信息。</p>
<h3 data-id="heading-11">数据库连接测试</h3>
<p>使用<code>psql</code>客户端连接数据库（需先安装PostgreSQL客户端工具）：</p>
<pre><code class="hljs language-css" lang="css">psql -h localhost -<span class="hljs-selector-tag">p</span> <span class="hljs-number">5432</span> -U postgres
</code></pre>
<p>输入部署时设置的密码<code>your_secure_password</code>，成功登录后进入PostgreSQL命令行界面，可执行以下命令验证数据库版本及扩展：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- 查看数据库版本<span class="hljs-keyword">SELECT</span> version();-- 验证预装扩展（以pg_stat_statements为例）<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_extension <span class="hljs-keyword">WHERE</span> extname = <span class="hljs-comment">'pg_stat_statements';</span>
</code></pre>
<p>若版本信息显示正确且扩展记录存在，表明数据库服务正常运行。</p>
<h2 data-id="heading-12">生产环境建议</h2>
<h3 data-id="heading-13">数据安全与持久化</h3>
<ul>
<li>
<p>• <strong>使用外部存储卷</strong>：生产环境建议使用绑定挂载（<code>-v /host/path:/container/path</code>）而非命名卷，便于数据备份和迁移，确保数据路径权限设置正确（建议PostgreSQL用户ID为999）</p>
</li>
<li>
<p>• <strong>定期备份</strong>：通过<code>pg_dump</code>工具或<code>docker exec</code>执行备份命令，如：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> postgres-container pg_dump -U postgres -Fc mydatabase &gt; backup_$(<span class="hljs-built_in">date</span> +%Y%m%d).dump
</code></pre>
</li>
<li>
<p>• <strong>启用SSL</strong>：配置<code>ssl = on</code>及相关证书参数，强制客户端使用SSL连接，防止数据传输过程中被窃听</p>
</li>
</ul>
<h3 data-id="heading-14">性能优化</h3>
<ul>
<li>
<p>• <strong>资源限制</strong>：根据服务器配置和业务需求，通过<code>--memory</code>和<code>--cpus</code>参数限制容器资源使用，避免资源耗尽，如：</p>
<pre><code class="hljs language-css" lang="css">docker run -d \  <span class="hljs-attr">--name</span> postgres-container \  <span class="hljs-attr">--memory</span>=<span class="hljs-number">4</span>g \  <span class="hljs-attr">--cpus</span>=<span class="hljs-number">2</span> \  ...（其他参数）
</code></pre>
</li>
<li>
<p>• <strong>配置调优</strong>：根据服务器内存调整<code>shared_buffers</code>（通常设为物理内存的25%）、<code>work_mem</code>、<code>maintenance_work_mem</code>等参数，优化查询性能</p>
</li>
<li>
<p>• <strong>索引优化</strong>：针对频繁查询的字段创建合适索引，定期使用<code>EXPLAIN</code>分析查询计划</p>
</li>
</ul>
<h3 data-id="heading-15">高可用配置</h3>
<ul>
<li>
<p>• <strong>主从复制</strong>：部署多节点主从架构，通过PostgreSQL流复制实现数据同步，提高服务可用性</p>
</li>
<li>
<p>• <strong>容器编排</strong>：使用Kubernetes或Docker Compose管理多容器应用，配置健康检查和自动重启策略，如：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">docker-compose.yml示例片段services:  postgres:    image: xxx.xuanyuan.run/supabase/postgres:17.6.0.023-orioledb    restart: always    healthcheck:      <span class="hljs-built_in">test</span>: [<span class="hljs-string">"CMD-SHELL"</span>, <span class="hljs-string">"pg_isready -U postgres"</span>]      interval: 10s      <span class="hljs-built_in">timeout</span>: 5s      retries: 5</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-16">故障排查</h2>
<h3 data-id="heading-17">容器无法启动</h3>
<ul>
<li>• <strong>端口冲突</strong>：检查主机5432端口是否被占用，使用<code>netstat -tulpn | grep 5432</code>或<code>ss -tulpn | grep 5432</code>查看占用进程，关闭冲突进程或修改映射端口</li>
<li>• <strong>数据卷权限</strong>：若使用绑定挂载，确保主机目录权限允许容器内用户访问，可通过<code>chmod 700 /host/path</code>及<code>chown -R 999:999 /host/path</code>调整权限</li>
<li>• <strong>配置文件错误</strong>：检查自定义配置文件语法，可通过<code>docker run</code>不加<code>-d</code>参数前台启动容器，直接查看错误日志</li>
</ul>
<h3 data-id="heading-18">连接失败</h3>
<ul>
<li>• <strong>网络问题</strong>：验证主机防火墙是否开放5432端口（如<code>ufw allow 5432</code>），远程连接需确保<code>postgresql.conf</code>中<code>listen_addresses = '*'</code>及<code>pg_hba.conf</code>中允许对应IP段访问</li>
<li>• <strong>密码错误</strong>：通过<code>docker exec -it postgres-container psql -U postgres</code>直接登录容器内数据库，使用<code>ALTER USER postgres PASSWORD 'new_password';</code>重置密码</li>
<li>• <strong>容器状态</strong>：确认容器处于运行状态，若已停止可通过<code>docker start postgres-container</code>重启</li>
</ul>
<h3 data-id="heading-19">扩展加载异常</h3>
<ul>
<li>• <strong>日志检查</strong>：查看容器日志中是否有扩展加载失败提示，如<code>could not load library</code></li>
<li>• <strong>依赖缺失</strong>：部分扩展可能需要额外系统库，可通过<code>docker exec -it postgres-container apt update &amp;&amp; apt install -y [依赖包]</code>安装缺失依赖</li>
<li>• <strong>版本兼容性</strong>：确认使用的镜像标签与扩展版本兼容，可参考 POSTGRES镜像文档（轩辕） <code>https://xuanyuan.cloud/r/supabase/postgres</code> 查看扩展支持信息</li>
</ul>
<h2 data-id="heading-20">参考资源</h2>
<ul>
<li>• Postgres 镜像文档（轩辕） <code>https://xuanyuan.cloud/r/supabase/postgres</code></li>
<li>• Postgres 镜像标签列表（轩辕） <code>https://xuanyuan.cloud/r/supabase/postgres/tags</code></li>
<li>• Supabase Postgres GitHub仓库 <code>https://github.com/supabase/postgres</code></li>
<li>• PostgreSQL官方文档 <code>https://www.postgresql.org/docs</code></li>
<li>• Docker容器最佳实践 <code>https://docs.docker.com/develop/develop-images/dockerfile_best-practices</code></li>
</ul>
<h2 data-id="heading-21">总结</h2>
<p>本文详细介绍了Supabase Postgres的Docker容器化部署方案，包括环境准备、镜像拉取、基础与自定义部署、功能测试、生产环境优化及故障排查等内容。通过容器化部署，用户可快速搭建包含多种实用插件的PostgreSQL数据库服务，满足开发与生产需求。</p>
<p><strong>关键要点</strong>：</p>
<ul>
<li>• 使用一键脚本快速部署Docker环境，简化前期准备工作</li>
<li>• 通过轩辕镜像访问支持拉取Supabase Postgres镜像，改善访问体验</li>
<li>• 容器部署需注意数据持久化（使用卷挂载）、密码安全及配置文件加载</li>
<li>• 生产环境中应重视资源限制、数据备份、SSL配置及高可用架构设计</li>
<li>• 故障排查以日志分析为核心，重点关注端口冲突、权限问题及配置错误</li>
</ul>
<p><strong>后续建议</strong>：</p>
<ul>
<li>• 深入学习Supabase Postgres预装扩展的使用方法，如PostGIS地理信息处理、pg_cron定时任务等高级特性</li>
<li>• 根据业务负载情况持续优化数据库配置参数，定期监控性能指标（可结合Prometheus+Grafana）</li>
<li>• 关注 Supabase Postgres镜像标签列表（轩辕） <code>https://xuanyuan.cloud/r/supabase/postgres/tags</code>，及时更新镜像版本以获取安全补丁和功能更新</li>
<li>• 对于大规模部署场景，建议参考官方文档设计基于Kubernetes的容器编排方案，实现自动化运维与弹性伸缩</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetbrains 这个知名软件十年了！]]></title>    <link>https://juejin.cn/post/7585534343562166322</link>    <guid>https://juejin.cn/post/7585534343562166322</guid>    <pubDate>2025-12-21T05:42:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585534343562166322" data-draft-id="7584286241488977960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetbrains 这个知名软件十年了！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-21T05:42:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetbrains 这个知名软件十年了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T05:42:23.000Z" title="Sun Dec 21 2025 05:42:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>📅 2025 年 12 月 16 日是 DataGrip 的 10 周岁生日！<br/>
在这十年中，它从代号 <code>0xdbe</code> 的原型成长为专业数据库 IDE 的标杆。\</p>
</blockquote>
<h2 data-id="heading-0">今天就来讲讲再DataGrip中隐藏的满分技巧</h2>
<hr/>
<h2 data-id="heading-1">✨ 1. 跨文件单词补全：<code>Alt/Opt + /</code></h2>
<p>不止是 SQL 关键字或字段名——这个功能能从<strong>当前所有打开的文件中</strong>智能匹配任意单词（类似“Hippie Completion”）。</p>
<p>✅ 适用场景：在 <code>INSERT</code> 语句中快速补全枚举值（例如将所有候选值预存在一个 Scratch 文件里）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4db52a476e042dfbfa2ebba9e58f83d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=UdgKQzCHK6pqU3yX181nxGZN6Gs%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>💡 小技巧：连续按 <code>Alt+/</code> 可循环切换匹配项。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🔍 2. 最近位置导航：<code>Ctrl/Cmd + Shift + E</code></h2>
<p>比 “Recent Files”（<code>Ctrl/Cmd + E</code>）更强大：</p>
<ul>
<li>显示最近<strong>查看或编辑过的位置</strong>（带上下文代码片段）</li>
<li>再按一次快捷键，仅显示<strong>已修改文件</strong></li>
<li>支持<strong>输入代码片段实时过滤</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a804be8df84427ab54a2d56fcce9f7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=bGvikb9E1NRybEKjN%2B3k9iEpDJM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>🎯 特别适合：快速找回“刚刚写到哪了”的复杂查询。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">🖼️ 3. 自定义背景图（不只是美化！）</h2>
<p>前往：<br/>
<code>Settings | Appearance &amp; Behavior | Appearance | UI Options → Background Image</code></p>
<p>可为<strong>编辑器 + 所有工具窗口</strong>设置背景图，支持缩放、透明度调节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0010cecd73604016b84879b915284801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=b5Tmo%2BD37ntYXamKR%2B%2BoDhoDO%2F8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>🎨 用途建议：</p>
<ul>
<li>暗色主题下加低透明度水印 logo（团队规范提醒）</li>
<li>显示 ER 图作为视觉参考（开发时对照结构）</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-4">🗃️ 4. 一键导出整个 Schema 的 DDL（带文件结构）</h2>
<p>使用 <strong>SQL Generator</strong>（<code>Ctrl/Cmd + Alt + G</code>）不仅可生成单表 DDL，还能：</p>
<p>✅ 对整个 <strong>Schema 节点</strong>调用 → 切换到 <code>File Output Options</code><br/>
✅ 自定义文件组织方式（如“每个表一个文件”、“按对象类型分目录”）<br/>
✅ 点击 <code>Dump</code> 直接生成物理文件！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/190e4fae0d64412180db58669dc4234d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=Q2YLxKlg6Sk7GaH%2FwtWlvJ5y36U%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>🛠️ 场景：版本控制 schema 变更、灾备重建、跨环境迁移。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">📋 5. 复制数据源 = 复制配置（跨机器/IDE 共享！）</h2>
<ul>
<li>在 Database 面板中选中数据源 → <code>Ctrl/Cmd + C</code></li>
<li>粘贴到任意位置（甚至另一台电脑的 DataGrip / IntelliJ IDEA）→ <code>Ctrl/Cmd + V</code></li>
</ul>
<p>🔍 底层原理：剪贴板存的是 <strong>XML 配置片段</strong>（不含密码）！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/798cf569efaf4363897bd127ab814afa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=7wdy9D54aQOU7AK3gfQ1pUtkRwc%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>🤝 团队协作利器：Slack 发一段 XML，同事秒连同款数据库！</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">🕰️ 6. 文件夹级本地历史（误删文件？秒恢复！）</h2>
<p>不仅单个文件有 <code>Local History</code>，<strong>整个文件夹</strong>也可以：</p>
<ol>
<li>在 <code>Files</code> 工具窗口右键文件夹</li>
<li><code>Show History → Local History</code></li>
<li>查看/恢复任意时间点的目录树 &amp; 文件内容</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/560ca6d96be243868a0102b5c989055b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=bIJeoB4JexX9Cw5eGRNHbu3w77s%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>⚠️ 注意：非 Git 历史！是 IDE 自动保存的本地快照（重启/断电也不丢）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">📑 7. SQL 自定义区域折叠 + 结构导航</h2>
<p>用特殊注释定义可折叠区域（支持 <code>--region</code> / <code>--endregion</code> 或 <code>#region</code>）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--region Sales Report</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(order_date) <span class="hljs-operator">=</span> <span class="hljs-number">2025</span>;
<span class="hljs-comment">--endregion</span>
</code></pre>
<ul>
<li>折叠/展开：<code>Ctrl/Cmd + - / +</code></li>
<li>在 <code>File Structure</code>（<code>Ctrl/Cmd + F12</code>）中清晰列出所有区域</li>
<li>⚡ <strong>可直接从结构窗口执行某区域 SQL！</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b11b89bbc8aa471bb02dd77aa0bff2ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=bITnxkfACuCte0p8SqNfLh%2FKPCA%3D" alt="" loading="lazy"/><br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff526beff2b14d6fadfa561f6297d4f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=90pA%2BiHLnEUvrjXRXpy8u74F3eo%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>🧩 适合：巨型 SQL 脚本分区管理（ETL、报表、迁移脚本等）</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">📊 8. 把“节点”当表查（元数据即数据！）</h2>
<p>在 Database 树中选中任意节点（如 <code>tables</code>, <code>functions</code>, <code>indices</code>）→ 按 <code>F4</code>：</p>
<p>→ 立即以<strong>表格形式展示该类对象列表</strong>，支持：</p>
<ul>
<li>列筛选、排序</li>
<li>文本搜索（<code>Ctrl+F</code>）</li>
<li>导出为 CSV/Excel</li>
<li><strong>本地过滤</strong>（无需写 SQL！）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/320e7323215c4323a3aca545fbaaeb0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=SzMMbsfnICeK0zzfUsLTqXd8GwU%3D" alt="" loading="lazy"/><br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab9e908b369a4ab58cd81c0d290326d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=UrOlDLJXVgTtoYEaiLgs%2FmSldW4%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>🎯 实战案例：查 PostgreSQL 中所有 <code>VOLATILE</code> 函数？打开 <code>functions</code> 节点 → 筛 <code>volatility = 'volatile'</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🧮 9. 隐藏计算器（Search Everywhere 里的彩蛋）</h2>
<ol>
<li><code>Double Shift</code> 呼出 <code>Search Everywhere</code></li>
<li>切换到 <code>All</code> 标签页</li>
<li>直接输入算式（如 <code>1024 * 8 + 512</code>）→ 结果实时显示！</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01fc435f21b64bb997e06f4d400e7826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=ACUr6fkQzHku1mFVkN9X%2BnVeics%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>😄 纯趣味功能？不！写分页 SQL 时快速算 <code>OFFSET</code> / <code>LIMIT</code> 值超方便～</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">🤖 10. AI 聊天中“@”附数据库对象（2025 必备！）</h2>
<p>在 DataGrip 内置 AI 聊天框中：</p>
<ol>
<li>输入 <code>@</code> 或 <code>#</code></li>
<li>输入 <code>dbObject:</code></li>
<li>选择表/视图/函数等 → 自动附加其完整元数据（结构、注释、样例数据）</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df17db341c5f471892c3250a0e2906a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900543&amp;x-signature=VSYGLdsMS8kFcBJXxLM0wjfTaYA%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>🌟 优势：避免“大模型幻觉”，让 AI 精准理解你当前操作的表结构，生成可靠 SQL / 注释 / 修复建议。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">🎁 结语：十年磨一剑，深藏功与名</h2>
<p>DataGrip 已不只是“写 SQL 的工具”，它集成了：</p>
<ul>
<li>⚡ 开发效率加速器</li>
<li>🛡️ 数据安全守门人</li>
<li>🤖 AI 增强生产力伙伴</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【UE5 学习笔记】第一人称模板项目解析（一）：项目结构与核心逻辑]]></title>    <link>https://juejin.cn/post/7585553799298334766</link>    <guid>https://juejin.cn/post/7585553799298334766</guid>    <pubDate>2025-12-21T09:48:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585553799298334766" data-draft-id="7585534343562297394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【UE5 学习笔记】第一人称模板项目解析（一）：项目结构与核心逻辑"/> <meta itemprop="keywords" content="Unreal Engine"/> <meta itemprop="datePublished" content="2025-12-21T09:48:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="椰子不是原子"/> <meta itemprop="url" content="https://juejin.cn/user/661238026361450"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【UE5 学习笔记】第一人称模板项目解析（一）：项目结构与核心逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/661238026361450/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    椰子不是原子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T09:48:44.000Z" title="Sun Dec 21 2025 09:48:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【UE5 学习笔记】第一人称模板项目解析（一）：项目结构与核心逻辑</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/511c7d807a6a4a9fa0c11e09e2b76ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=ltmw53OKTVflxxKyixKZkTJf9ao%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>在第一人称游戏中，玩家从其所扮演角色的视点来查看游戏。一些第一人称游戏会显示角色模型的某部分，例如角色的手臂或武器。这与<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.epicgames.com%2Fdocumentation%2Fzh-cn%2Funreal-engine%2Fthird-person-template-in-unreal-engine" target="_blank" title="https://dev.epicgames.com/documentation/zh-cn/unreal-engine/third-person-template-in-unreal-engine" ref="nofollow noopener noreferrer">第三人称游戏</a>不同，在后者中，你可以从角色背后略上方的位置看到角色动作。</p>
</blockquote>
<h3 data-id="heading-1">1. 项目概览</h3>
<p>可以看到<code>Content</code>目录下有如下四个文件夹：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6df34881e4b4273bce3f96792f9c11a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=adf7QG7vEP5qi3xMlDzqS0Uta7w%3D" alt="image.png" loading="lazy"/></p>
<p>下面我们来逐一分析每一个文件夹的内部结构</p>
<h4 data-id="heading-2">1.1 ⭐ 角色 <code>Characters</code></h4>
<p>角色文件夹里面只有一个角色<code>Mannequins</code>，意为“模特”，可以理解为<strong>其他角色的基础类</strong>。<code>Mannequins</code>包含五个文件夹，如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddd28e066e6c4c6d9fd778d734eebfc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=6hMVa%2B9HlNhSSN8vLxIZ8GQYuN8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<h4 data-id="heading-3"><code>Anims</code>：存放角色的动画序列</h4>
</li>
</ul>
<p>可以看到，不同的动画被分门别类，放在不同的文件夹里</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfbe3f1354cd4b0bbb57c36be725ee61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=0K47HV7lMozWvQzBLAe4TRraWvY%3D" alt="image.png" loading="lazy"/></p>
<p>我们选择其中的<code>Unarmed</code>（未手持武器）的动画集合为例进行分析，可以发现，该文件夹下有三种不同的文件：</p>
<ul>
<li><strong>动画蓝图：</strong> <strong>连接游戏逻辑和所有动画资源</strong>（动画序列、混合空间），根据游戏状态输出最终的角色动画</li>
<li><strong>混合空间：</strong> 基于指定参数（如速度、转向角度），自动平滑混合多个相似动画序列的资源，<strong>解决多个动画之间卡顿切换的问题</strong></li>
<li><strong>动画序列：</strong> <strong>存储单一、独立动画动作的基础资源</strong>，相当于动作片段，是角色动画的原材料</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecdbc18e89c8418fbc69eb4e7d7afda3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=zwZBWAW64pXn6flB5xvzqEyGI3U%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dc30c1642884c6f9271845b1321d740~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=FdsL%2FFPCmjl5WX%2FGgsM0JoD6d6k%3D" alt="image.png" loading="lazy"/></p>
<p>如果你需要修改模型的行走动画，比如将摆臂的幅度加大，你可以修改对应的动画序列文件，但这是游戏美术需要考虑的事情。</p>
<ul>
<li>
<h4 data-id="heading-4"><code>Materials</code>：存放角色的材质</h4>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c264873f5406421e8c9740e9b5b1a968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=0o8p8f3U1ni4mHqjntwK9I7r4a4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6fbf6c253e141c48a38cab0d6eb5940~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=mWeor91LAMqWFBXjizB3C9RnY8Y%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>文件夹<code>Manny</code>/<code>Quinn</code>：分别对应默认的两个人体模特（男性/女性）的专属材质资源</li>
<li><code>M_Mannequin</code>：是<strong>人体模特的基础材质</strong>（或材质实例），直接控制人体模特的视觉表现（比如默认的灰白纹理外观）</li>
</ul>
<blockquote>
<p>Q：<strong>材质和材质实例的区别是什么？</strong></p>
<p>A：<strong>Material是材质的母版</strong>，可以编辑Shader网络、设置基础渲染属性（比如是否透明、光照响应方式）；而<strong>Material Instance是基于基础材质创建的子资源</strong>，继承基础材质的所有属性，但可以单独修改部分参数（比如颜色、纹理、粗糙度），不用重新做整个材质，能大幅提升资源复用和调整效率。</p>
</blockquote>
<ul>
<li>
<h4 data-id="heading-5"><code>Mesh</code>：角色的网格图形</h4>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d853789ce9f4bdbb42eba35cd822d38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=WfenMUT4coG4toj7BSI1Ww%2Beagw%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>Mesh存储了物体的顶点、面、法线等几何数据，决定了角色在游戏里呈现出的形状。</p>
</blockquote>
<p>可以看到<code>Mesh</code>文件夹里面有两种文件：</p>
<ul>
<li>
<p><strong>Skeleton</strong> ：<strong>角色的动画骨架</strong>,定义了角色能活动的关节逻辑</p>
</li>
<li>
<p><strong>Skeletal Mesh</strong> ：这是<strong>绑定了骨骼的Mesh</strong>，既包含角色的几何形状，又和骨骼资源关联，能驱动骨骼动画</p>
</li>
<li>
<h4 data-id="heading-6"><code>Rigs</code>：角色的动画控制与物理交互辅助</h4>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1429dbcbdeaf47fcabfd12ed66a7016f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=1TsNCFD80Dj%2B73EgdiWdAStPc68%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到<code>Rigs</code>里包含两类核心资源：</p>
<ul>
<li><strong>Control Rig</strong>：可视化的骨骼控制工具，负责调整角色姿态、补全动画细节；</li>
<li><strong>Physical Asset</strong>：绑定骨骼的碰撞配置资源，负责处理角色的物理碰撞、受力反馈。</li>
</ul>
<p>我们对文件夹里的每个文件进行解析：</p>
<ol>
<li><strong><code>CR_Mannequin_Body</code></strong>：<strong>身体控制</strong>，调整角色身体各关节的姿态，也能给现有动画叠加细节，让动画更生动</li>
<li><strong><code>CR_Mannequin_FootIK</code></strong>：<strong>脚部IK控制</strong>，解决动画穿模问题，让脚部自动贴合地面，使移动动画更真实自然</li>
<li><strong><code>CR_Mannequin_Procedural</code></strong>：<strong>程序化控制</strong>，根据角色的运动状态自动调整肢体细节，不用手动逐帧编辑动画，提升动画制作效率</li>
<li><strong><code>PA_Mannequin</code></strong>：<strong>角色物理资产</strong>，给角色骨骼绑定了对应的碰撞体，让角色能和场景物体产生碰撞、受到物理力时产生反馈等</li>
</ol>
<ul>
<li>
<h4 data-id="heading-7"><code>Textures</code>：角色的纹理</h4>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c140529a55bf4ca9ab3ecf134ab4b53a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=hbU%2B%2FxPzlaKu%2BEcKiZhp4jOXXL0%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到该文件夹下有三个子文件夹，其作用也很清晰：</p>
<ul>
<li><strong><code>Manny</code></strong>：男性模特的专属纹理文件夹</li>
<li><strong><code>Quinn</code></strong>：女性模特的专属纹理文件夹</li>
<li><strong><code>Shared</code></strong>：两个模特共用的纹理文件夹，比如通用的布料底色、金属装饰纹理等</li>
</ul>
<p>至此，我们已经分析了角色文件夹<code>Characters</code>内的所有内容，可以看到这是一个UE官方给出的功能相对完善的角色基础模板，我们后续可以<strong>在其基础上拓展出不同类型的角色</strong>。</p>
<h4 data-id="heading-8">1.2 输入配置 <code>Input</code></h4>
<p>先通览一下<code>Input</code>文件夹内的内容：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24071fd6cbc5433bb40f3e05f5c7aa07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=QLWibas1mdmXE8WeEPhisP3Rd7c%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f23c15999dd345dd920090b4a3d636cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=%2BJReXUNSxzCNNvdAWJaGkB16Fu8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53d0f13247c24ea8a347dcf1b5fe52d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=AgBQtd6%2BWdBSwHyZtgNhYGau6oY%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>输入映射上下文</strong>是输入的核心文件，<code>IMC_Default</code>/<code>IMC_MouseLook</code>用来切换不同的输入规则（比如<code>IMC_Default</code>是默认全操作，<code>IMC_MouseLook</code>是仅允许鼠标控制视角的简化操作）。</li>
<li><code>Actions</code>是<strong>动作输入的映射库</strong>，包含“操作——游戏动作”的具体绑定配置，把玩家的按键或操作对应到具体的游戏功能
<ul>
<li><code>IA_Jump</code>：触发角色跳跃</li>
<li><code>IA_Move</code>：控制角色移动</li>
<li><code>IA_Look</code>/<code>IA_MouseLook</code>：绑定视角操作并转动角色视角</li>
</ul>
</li>
<li><code>Touch</code>是<strong>触屏设备的专属输入配置</strong>
<ul>
<li><code>UI_Thumbstick</code>：虚拟摇杆控件，对应手柄左摇杆（触屏时拖动摇杆控制移动）</li>
<li><code>BP_TouchInterface</code>：触摸交互的逻辑蓝图，管理触屏操作的识别规则</li>
<li><code>UI_TouchSimple</code>：简单触摸按钮配置</li>
</ul>
</li>
</ul>
<p>举个例子，为了给角色加入一个<strong>瞄准</strong>动作，我需要做如下操作：</p>
<ol>
<li>新建一个<code>IA_Aim</code>动作</li>
<li>将鼠标右键点击事件绑定到<code>IA_Aim</code>动作</li>
<li>在角色蓝图中添加相关事件的处理逻辑，如更改FOV、减少抖动等</li>
</ol>
<h4 data-id="heading-9">1.3 关卡原型 <code>LevelPrototyping</code></h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2048c49cbec4a3ab47569693d84cb7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=zBAJ0%2FUDbwzZWu%2BnkjAmzufqqwk%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到，这个文件夹专门用于存放搭建测试关卡所需的资源</p>
<ul>
<li><code>Interactable</code>：<strong>关卡原型的交互物体库</strong>，存放关卡中能和玩家产生互动的物体资源（比如可拾取的道具、可触发的机关、可打开的门）</li>
<li><code>Materials</code>：关卡原型的基础材质包</li>
<li><code>Meshes</code>：关卡原型的场景几何体</li>
<li><code>Textures</code>：关卡原型的简化纹理素材</li>
</ul>
<p>基于这些原型资源，开发者可以快速搭建出供测试用的地图以验证核心玩法，无需等待美术资源全部制作完毕，大大提高了开发效率。</p>
<h4 data-id="heading-10">1.4 ⭐ 第一人称模板 <code>FirstPerson</code></h4>
<p>这是本节的重中之重，包含了第一人称角色的控制相关的功能，先来看一下目录结构：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8d40ab3979c45c981fd2eba6710eb9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=i%2FB1ZA%2FjXFZ8Ps1rQcT5T9mNDpw%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到根目录下有两个独立文件：</p>
<ul>
<li><code>Lvl_FirstPerson</code>是<strong>第一人称玩法的演示场景</strong>，已经搭好适配第一人称视角的基础关卡（比如简单的房间、可交互的道具），可以直接用来测试第一人称的移动、交互等核心玩法</li>
<li><code>MI_FirstPersonColorway</code>是<strong>第一人称可见物体（比如武器、手臂模型）的外观配置资源</strong>，能单独调整这些元素的颜色、质感（比如把武器改成黄色、调整手臂模型的光泽度），不用修改基础材质就能快速切换外观风格</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b98bcfad26349a2a99ffbcd439622e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=fCF92CxycADTKmut57VN%2B%2FtoBsY%3D" alt="image.png" loading="lazy"/></p>
<p><code>Anims</code>文件夹用于存放角色的动画序列，相比基础模特，这里的动画序列多了以下两个：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4c5f1e6a9e9427ca40f023957795810~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=YvQp0YZTQedE1fsbji%2FN69batro%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong><code>ABP_FP_Copy</code>（动画蓝图）</strong> ：负责接收第一人称的操作输入，调用对应的动画资源，<strong>输出最终的第一人称动画表现</strong></li>
<li><strong><code>CtrlRig_FPWarp</code>（Control Rig）</strong> ：负责<strong>精细调整第一人称可见部分的姿态</strong>，让动作更真实自然</li>
</ul>
<p><code>Blueprints</code>文件夹下有四个蓝图文件，这四个蓝图是支撑第一人称玩法的核心功能模块，分工覆盖了 <strong>角色实体、操作控制、视角管理、关卡规则</strong>。</p>
<ul>
<li><strong><code>BP_FirstPersonCharacter</code>（角色蓝图）</strong>
<ul>
<li>处理移动、跳跃等基础动作逻辑</li>
<li>管理角色的状态（如生命值、交互状态）</li>
<li>绑定第一人称视角下的可见元素（如手臂、手持道具）</li>
</ul>
</li>
<li><strong><code>BP_FirstPersonPlayerController</code>（玩家控制器蓝图）</strong>
<ul>
<li>接收玩家的输入并传递给角色蓝图</li>
<li>管理第一人称视角的控制逻辑</li>
<li>传递UI与角色之间的交互指令</li>
</ul>
</li>
<li><strong><code>BP_FP_CameraManager</code>（相机管理器蓝图）</strong>
<ul>
<li>控制相机的跟随规则</li>
<li>实现视角的动态效果</li>
<li>限制视角的转动范围</li>
</ul>
</li>
<li><strong><code>GM_FirstPerson</code>（游戏模式蓝图）</strong>
<ul>
<li>定义关卡的核心规则</li>
<li>管理关卡内的资源刷新、敌人配置等全局逻辑</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class GM_FirstPerson {
        +定义关卡的核心规则
        +管理关卡内的资源刷新、敌人配置等全局逻辑
    }
    class BP_FirstPersonPlayerController {
        +接收玩家的输入并传递给角色蓝图
        +管理第一人称视角的控制逻辑
        +传递UI与角色之间的交互指令
    }
    class BP_FirstPersonCharacter {
        +处理移动、跳跃等基础动作逻辑
        +管理角色的状态（如生命值、交互状态）
        +绑定第一人称视角下的可见元素（如手臂、手持道具）
    }
    class BP_FP_CameraManager {
        +控制相机的跟随规则
        +实现视角的动态效果
        +限制视角的转动范围
    }

    GM_FirstPerson &lt;|-- BP_FirstPersonPlayerController : 使用
    BP_FirstPersonPlayerController --&gt; BP_FirstPersonCharacter : 控制/Possess
    BP_FirstPersonCharacter --&gt; BP_FP_CameraManager : 包含/使用
    BP_FirstPersonCharacter --&gt; ABP_FP_Copy : 使用动画蓝图
    BP_FirstPersonCharacter --&gt; CtrlRig_FPWarp : 使用Control Rig
</code></pre>
<p>至此，我们基本了解了这个示例项目的结构，接下来我们将对程序的核心——<code>FirstPerson</code>文件夹下的四个蓝图进行分析，了解游戏核心逻辑是如何编写的。</p>
<h3 data-id="heading-11">2. <code>FirstPerson</code> 核心逻辑分析</h3>
<h4 data-id="heading-12">2.1 ⭐ <code>BP_FirstPersonCharacter</code></h4>
<p>先对该蓝图所拥有的组件进行概览：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c8d58b5fbc0466d97ed7b8fa60650c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=789WePbzeDyUrFE0RxpKvdZr8Vg%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>胶囊体组件 (CollisionCylinder)</strong> ：角色根组件，用于<strong>处理基本碰撞检测</strong>和<strong>防止角色穿透世界物体</strong></li>
<li><strong>箭头组件 (Arrow)</strong> ：可视化方向箭头，用于在编辑器中<strong>表示角色朝向</strong>，便于调试和定位</li>
<li><strong>网格体 (CharacterMesh0)</strong> ：第三人称视图下的<strong>完整角色骨骼网格</strong>（Skeletal Mesh），在第一人称模式下通常隐藏，仅他人可见</li>
<li><strong>FirstPersonMesh</strong>：第一人称视图下的<strong>手臂/武器骨骼网格</strong>，仅拥有玩家可见，随相机移动</li>
<li><strong>FirstPersonCamera</strong>：第一人称相机组件，提供<strong>玩家视角</strong>视图，并控制<strong>头部转动</strong></li>
<li><strong>角色移动 (CharMoveComp)</strong> ：<code>CharacterMovementComponent</code>的简称，负责<strong>处理角色移动、跳跃、重力、碰撞响应等物理逻辑</strong></li>
</ul>
<p>有了这些组件，我们就可以编写具体的控制逻辑。逻辑写在蓝图的事件图表中，我们将这个复杂的流程拆解成以下几个部分：</p>
<ul>
<li>
<h5 data-id="heading-13">流程入口</h5>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3ba6b9442c644289399daba2c716fab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=kSkRIlkeUJlyCQkFFq7kyA6vOg0%3D" alt="image.png" loading="lazy"/></p>
<p><strong>在Pawn被任何Controller（玩家或 AI）接管时触发</strong>，用于区分玩家控制（PlayerController）与 AI 控制（AIController），以执行不同逻辑（如仅玩家可见的 UI、输入映射、相机设置等）。</p>
<ul>
<li>
<h5 data-id="heading-14">跨平台输入自适应</h5>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f2052d6f9b45e6a794e0e8defffaf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=dtTAwxotvoazJ3QG731csyqTV4Q%3D" alt="image.png" loading="lazy"/></p>
<p>根据当前运行平台有条件地添加一个专门用于鼠标瞄准的输入映射上下文（IMC_MouseLook），同时在移动平台上创建并显示一个触摸UI控件（Target Touch UI），以<strong>避免鼠标输入与触摸输入冲突</strong>。</p>
<blockquote>
<p>如果不是触摸设备，则添加瞄准映射上下文，否则鼠标输入会干扰触摸操作。如果想在 Windows 上测试触摸 UI，可以开启“Use mouse for touch”选项，并将 Windows 分支设置为创建触摸 UI。</p>
</blockquote>
<ul>
<li>
<h5 data-id="heading-15">视角控制</h5>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71d7619265b140a6be051271a0422f9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=9oze5TWHEqwZuTns14HDEkBnhXM%3D" alt="image.png" loading="lazy"/></p>
<p>这是一套典型的<strong>处理视角输入</strong>的蓝图逻辑，与上文跨平台输入的适配完美配合，我们可以用一个表格来描述逻辑要点：</p>

































<table><thead><tr><th>输入来源</th><th>输入动作/事件</th><th>X轴 →</th><th>Y轴 →</th><th>最终处理函数</th></tr></thead><tbody><tr><td>鼠标（PC）</td><td>IA_Look（Triggered）</td><td>Yaw（左右）</td><td>Pitch（上下）</td><td>Aim</td></tr><tr><td>鼠标（备用/补充）</td><td>IA_MouseLook（Triggered）</td><td>Yaw</td><td>Pitch</td><td>Aim</td></tr><tr><td>触摸右摇杆（移动端）</td><td>Event Secondary Thumbstick</td><td>Yaw</td><td>Pitch</td><td>Aim</td></tr></tbody></table>
<p>这一套逻辑有以下几个优点：</p>
<ol>
<li>无论鼠标还是触摸摇杆，<strong>最终都调用同一个Aim函数</strong>，可以确保视角控制逻辑一致</li>
<li>完美配合了前一张图的逻辑——移动端弹出触摸UI并触发此事件，PC端使用鼠标输入动作。</li>
<li><strong>所有输入都通过Input Action定义</strong>，便于在Project Settings中统一绑定键位、调整曲线、添加修饰器（如死区、灵敏度）。</li>
</ol>
<ul>
<li>
<h5 data-id="heading-16">移动控制</h5>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3db3fca1569c40caaca4d723dab21284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=M91hFMr8D9LLjMqZr9fJNhCiOnI%3D" alt="image.png" loading="lazy"/></p>
<p>实现了<strong>键盘与触摸摇杆的统一移动控制</strong>，两种输入源的X/Y轴值都汇入Move函数，驱动第一人称角色的前后左右平移。</p>
<p>同样我们使用一个表格来诠释这一套逻辑：</p>


























<table><thead><tr><th>输入来源</th><th>输入动作/事件</th><th>X轴 →</th><th>Y轴 →</th><th>最终处理函数</th></tr></thead><tbody><tr><td><strong>键盘（PC）</strong></td><td>IA_Move（Triggered）</td><td>Left/Right</td><td>Forward/Backward</td><td>Move</td></tr><tr><td><strong>触摸左摇杆（移动端）</strong></td><td>Event Primary Thumbstick</td><td>Left/Right</td><td>Forward/Backward</td><td>Move</td></tr></tbody></table>
<ul>
<li>
<h5 data-id="heading-17">跳跃控制</h5>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa39a873e83c497ea97d3aefcc70c037~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=ODEynVtlV28oPzza1mvGi1pabpo%3D" alt="image.png" loading="lazy"/></p>
<p>这段蓝图实现了<strong>键盘与触摸按钮的统一跳跃控制</strong>。</p>
<p>使用一个表格来诠释这一套逻辑：</p>




















<table><thead><tr><th>输入来源</th><th>跳跃开始（Jump）</th><th>跳跃结束（Stop Jumping）</th></tr></thead><tbody><tr><td><strong>键盘/手柄（PC）</strong></td><td>IA_Jump Started</td><td>IA_Jump Completed</td></tr><tr><td><strong>触摸按钮（移动端）</strong></td><td>Event Touch Jump Start</td><td>Event Touch Jump End</td></tr></tbody></table>
<p>另外，这个蓝图中还有两个重要的函数：<code>Move</code>和<code>Aim</code>，以下两张图分别展示了这两个函数的核心逻辑：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0ceacdeee6741868bc12b2867ebde3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=QuZrUh%2BRjFtXqTNd0KPVKRV7bYc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/109f4429f1834df393277c8986dd42cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=8jxVCzqdYa5o%2FPq5PQ6E5mP3fGE%3D" alt="image.png" loading="lazy"/></p>
<p>这些函数封装了<strong>角色移动</strong>和<strong>视角转换</strong>的API，使开发者执行这两个操作变得极其简单。</p>
<p>使用伪代码描述逻辑链：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// BP_FirstPersonCharacter - 输入处理部分</span>

<span class="hljs-comment">// 视角控制（Camera Input）</span>
On Enhanced <span class="hljs-selector-tag">Input</span> Action IA_Look <span class="hljs-built_in">Triggered</span>(ValueX, ValueY)
    <span class="hljs-built_in">Aim</span>(Yaw = ValueX, Pitch = ValueY)

On Enhanced <span class="hljs-selector-tag">Input</span> Action IA_MouseLook <span class="hljs-built_in">Triggered</span>(ValueX, ValueY)
    <span class="hljs-built_in">Aim</span>(Yaw = ValueX, Pitch = ValueY)

On Event Secondary Thumbstick From Touch <span class="hljs-built_in">Interface</span>(AxisX, AxisY)
    <span class="hljs-built_in">Aim</span>(Yaw = AxisX, Pitch = AxisY)

<span class="hljs-comment">// 移动控制（Movement Input）</span>
On Enhanced <span class="hljs-selector-tag">Input</span> Action IA_Move <span class="hljs-built_in">Triggered</span>(ValueX, ValueY)
    Move(LeftRight = ValueX, ForwardBackward = ValueY)

On Event Primary Thumbstick From Touch <span class="hljs-built_in">Interface</span>(AxisX, AxisY)
    Move(LeftRight = AxisX, ForwardBackward = AxisY)

<span class="hljs-comment">// 跳跃控制（Jump Input）</span>
On Enhanced <span class="hljs-selector-tag">Input</span> Action IA_Jump Started
    <span class="hljs-built_in">Jump</span>()

On Enhanced <span class="hljs-selector-tag">Input</span> Action IA_Jump Completed
    Stop <span class="hljs-built_in">Jumping</span>()

On Event Touch Jump Start From Touch Interface
    <span class="hljs-built_in">Jump</span>()

On Event Touch Jump End From Touch Interface
    Stop <span class="hljs-built_in">Jumping</span>()

<span class="hljs-comment">// 内部函数（通常在蓝图函数中实现）</span>
Function <span class="hljs-built_in">Aim</span>(Yaw, Pitch)
    Add Controller Yaw <span class="hljs-selector-tag">Input</span>(Yaw * MouseSensitivity)
    Add Controller Pitch <span class="hljs-selector-tag">Input</span>(Pitch * MouseSensitivity)

Function Move(LeftRight, ForwardBackward)
    Add Movement <span class="hljs-selector-tag">Input</span>(Get Actor Forward Vector(), ForwardBackward)
    Add Movement <span class="hljs-selector-tag">Input</span>(Get Actor Right Vector(), LeftRight)
</code></pre>
<h4 data-id="heading-18">2.2 <code>BP_FirstPersonPlayerController</code></h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/905299d82136429b9b5161b80b0e533a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=7oGHJUxLKjzfjZDKVyS82lkUrZ0%3D" alt="image.png" loading="lazy"/></p>
<p>作为第一人称项目的<strong>玩家控制器</strong>，负责管理玩家输入系统的初始化、跨平台适配、触摸UI的创建与显示，以及其他玩家专属逻辑（如 HUD、输入模式切换）。</p>
<p>它主要与之前的<code>BP_FirstPersonCharacter</code>配合：<code>Character</code>处理移动/视角/跳跃的具体实现，<code>PlayerController</code>处理输入映射和UI的平台差异。</p>
<p>使用伪代码描述逻辑链：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// BP_FirstPersonPlayerController - Event Graph (主要在 Event BeginPlay 中执行)</span>

<span class="hljs-function">Event <span class="hljs-title">BeginPlay</span>()</span>
{
    <span class="hljs-comment">// 获取当前本地玩家的 Enhanced Input 子系统</span>
    EnhancedInputSubsystem = <span class="hljs-function">Get Enhanced Input Local Player <span class="hljs-title">Subsystem</span>()

    <span class="hljs-comment">// 添加基础输入映射上下文（包含移动、视角、跳跃等所有 Input Action）</span>
    EnhancedInputSubsystem.Add Mapping <span class="hljs-title">Context</span>(<span class="hljs-params">IMC_Default, Priority = <span class="hljs-number">0</span></span>)

    <span class="hljs-comment">// 获取当前运行平台名称（返回字符串，如 "Windows"、"Android"、"iOS" 等）</span>
    PlatformName</span> = <span class="hljs-function">Get Platform <span class="hljs-title">Name</span>()

    <span class="hljs-comment">// 根据平台进行分支判断</span>
    <span class="hljs-title">Switch</span> (<span class="hljs-params">PlatformName</span>)</span>
    {
        Case <span class="hljs-string">"Windows"</span>:
            <span class="hljs-comment">// PC 平台：仅使用键盘鼠标，无需触摸 UI</span>
            <span class="hljs-comment">// 不执行任何额外操作（鼠标输入已由 IMC_Default 覆盖）</span>
            Break

        Case <span class="hljs-string">"Android"</span>:
        Case <span class="hljs-string">"iOS"</span>:
            <span class="hljs-comment">// 移动平台：创建并显示虚拟触摸控件 UI</span>
            TouchUIWidget = <span class="hljs-function">Create <span class="hljs-title">Widget</span>(<span class="hljs-params">Class = TargetTouchUI, OwningPlayer = Self</span>)
            <span class="hljs-title">if</span> (<span class="hljs-params">TouchUIWidget != <span class="hljs-literal">null</span></span>)</span>
            {
                TouchUIWidget.<span class="hljs-function">Add To <span class="hljs-title">Viewport</span>()  <span class="hljs-comment">// 添加到屏幕视口，使其可见</span>
                <span class="hljs-comment">// 可选：设置输入模式为 Game and UI，允许触摸按钮接收输入</span>
                Set Input Mode Game And <span class="hljs-title">UI</span>()
                Show Mouse <span class="hljs-title">Cursor</span>(<span class="hljs-params"><span class="hljs-literal">false</span></span>)  <span class="hljs-comment">// 通常隐藏鼠标光标</span>
            }
            Break

        Default:
            <span class="hljs-comment">// 其他平台（如 Editor 测试、Console 等）：默认同 PC 处理</span>
            <span class="hljs-comment">// 不创建触摸 UI</span>
            Break
    }
}
</span></code></pre>
<h4 data-id="heading-19">2.3 <code>GM_FirstPerson</code></h4>
<p>这是一个纯数据的蓝图，定义了<strong>游戏的运行模式</strong>，以下展示了几个重要的设置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0216028cdca141c293d108bf9eb53118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=BF%2B%2F5o2isMhuX6QBPLl74Derons%3D" alt="image.png" loading="lazy"/></p>
<p>我们只需要在<strong>世界场景设置</strong>中选择该蓝图，即可应用对应的游戏模式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcfc00e01fc9419197eee6a319959ff9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=bEK2fFc%2B3u7q8vC69xgKp0s5lLY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-20">2.4 <code>BP_FP_CameraManager</code></h4>
<p>可用于<strong>自定义玩家相机行为</strong>，用于增强第一人称体验。标准第一人称模板中通常不需要重度自定义，我们之后可以将其用于实现<strong>相机抖动</strong>、<strong>瞄准时FOV变化</strong>、<strong>头部鲍勃</strong>或其他平滑相机效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6befa16820e04cf2a337e1d8a9593174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qSw5a2Q5LiN5piv5Y6f5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915832&amp;x-signature=K64PIefA1yD%2FaiPQ9806Vs9PDdQ%3D" alt="image.png" loading="lazy"/></p>
<p>至此，我们分析了这个项目的<strong>结构</strong>以及<strong>核心逻辑</strong>（四个蓝图），在下一节中，我们将对项目结构进行进一步优化，便于我们后续的拓展开发。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代前端开发工程化：Vue3 + Vite 带你从 0 到 1 搭建 Vue3 项目🚀]]></title>    <link>https://juejin.cn/post/7585555806667866146</link>    <guid>https://juejin.cn/post/7585555806667866146</guid>    <pubDate>2025-12-21T10:14:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585555806667866146" data-draft-id="7585727457472397312" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代前端开发工程化：Vue3 + Vite 带你从 0 到 1 搭建 Vue3 项目🚀"/> <meta itemprop="keywords" content="Vue.js,Vite,前端"/> <meta itemprop="datePublished" content="2025-12-21T10:14:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaoxue_"/> <meta itemprop="url" content="https://juejin.cn/user/4065372122398027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代前端开发工程化：Vue3 + Vite 带你从 0 到 1 搭建 Vue3 项目🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4065372122398027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaoxue_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T10:14:35.000Z" title="Sun Dec 21 2025 10:14:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">现代前端开发<strong>工程化</strong>：从 0 到 1 搭建 Vue3 项目 🚀</h2>
<p>在前端开发飞速发展的今天，“工程化” 已经成为提升开发效率、保证项目质量的核心关键词。不再是拿着编辑器写几行 HTML、CSS、JS 就能搞定的时代，现代前端开发需要一套完整的工具链和架构规范。今天，我们就以 Vue3 + Vite 为例，参照下面这幅 <strong>Vue3 前端技术栈架构图</strong> ，手把手带你走进现代前端工程化的世界，从初始化项目到实现多页面开发，让你感受到规范架构带来的丝滑体验～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d6a21e45f94e8abf740bf07d43171f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766916874&amp;x-signature=D0TQNvGX%2FEhilj5f5vzKo7oLZ0w%3D" alt="QQ20251221-174448.png" loading="lazy"/></p>
<h3 data-id="heading-1">一、初始化一个 Vue 项目 🔧</h3>
<p>想要开启 Vue3 项目开发，第一步就是初始化一个规范的项目结构。这里我们强烈推荐使用<code>vite</code>作为构建工具，操作简单又高效！</p>
<h4 data-id="heading-2">1.项目初始化步骤</h4>
<p>打开终端，输入以下命令，跟着指引一步步操作即可：</p>
<p>bash</p>
<pre><code class="hljs language-csharp" lang="csharp">npm <span class="hljs-keyword">init</span> vite
</code></pre>
<p>执行命令后，会出现几个关键选项需要你决策：</p>
<ul>
<li>给项目起个名字：我们这里命名为<code>all-vue</code>（方便后续统一管理）</li>
<li>选择框架：直接选中<code>vue</code>（毕竟我们要开发 Vue 项目呀～）</li>
<li>选择版本：推荐选<code>javascript</code>（对新手更友好，上手成本低）</li>
</ul>
<p>不到 10 秒，一个基础的 Vue 项目框架就搭建完成了！是不是比传统的<code>vue create</code>快很多？这就要归功于我们使用的构建工具 ——vite 了～</p>
<h4 data-id="heading-3">2.关于 Vite 的那些事儿 🤔</h4>
<p>很多小伙伴可能会问：“vite 到底是个啥？和 Vue 又是什么关系呢？”</p>
<p>简单来说，<strong>vite 是 Vue 作者尤雨溪开发的现代前端构建工具</strong>，它最牛的地方在于利用浏览器原生的 ES 模块（ESM）实现了两大黑科技：</p>
<ul>
<li><strong>极速冷启动</strong>：传统构建工具会先打包所有文件再启动开发服务器，而 vite 直接让浏览器去解析模块，启动速度快到飞起！</li>
<li><strong>热更新</strong>：修改文件后，vite 只会更新变化的部分，不会重新打包整个项目，浏览器瞬间刷新，开发体验直接拉满～</li>
</ul>
<p>而 Vue 和 vite 的关系，可以用 “内容” 和 “工具” 来概括：</p>
<ul>
<li><strong>Vue</strong>：是一套用于构建用户界面的 JavaScript 框架，专注于视图层，提供了组件化、响应式等核心能力（负责 “做什么”）；</li>
<li><strong>Vite</strong>：是新一代前端构建工具，负责把你写的 Vue 代码进行打包、编译、启动开发服务器（负责 “怎么做”）。</li>
<li>总结来说：vue 是前端框架（负责写业务逻辑、组件、界面），而 vite 是构建工具（负责把你写的 vue 代码 “打包、编译、启动开发服务器”）。</li>
</ul>
<p>打个比方：如果 Vue 是画笔，那 vite 就是调色盘和画板，帮你更高效地创作～</p>
<h4 data-id="heading-4">3.启动项目：一行命令的事儿 🚀</h4>
<p>项目初始化完成后，还需要安装依赖并启动开发服务器。进入项目目录，执行以下命令：</p>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> all-vue
<span class="hljs-comment"># 安装依赖</span>
npm i
<span class="hljs-comment"># 启动开发服务器</span>
npm run dev
</code></pre>
<p>这里的<code>npm i</code>会根据项目根目录下的<code>package.json</code>文件安装依赖。打开<code>package.json</code>看看，里面记录了项目的核心信息：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all-vue"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 项目名称</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.5.24"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Vue核心依赖</span>
    <span class="hljs-attr">"vue-router"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.6.4"</span> <span class="hljs-comment">// 路由依赖（后面会用到）</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.2.4"</span> <span class="hljs-comment">// 开发环境依赖：vite构建工具</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 启动开发服务器的脚本</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 打包项目的脚本</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite preview"</span> <span class="hljs-comment">// 预览打包后项目的脚本</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>执行<code>npm run dev</code>后，终端会显示项目启动信息，通常会在<code>localhost:5173</code>启动服务，甚至会自动打开浏览器（这是 vite 借助 Node 的 OS 模块实现的小细节～）。更爽的是，当你修改任何文件时，浏览器会自动刷新展示最新效果，这就是前面提到的 “热更新”，再也不用手动 F5 啦！</p>
<h3 data-id="heading-5">二、优秀架构：项目的 “骨架” 有多重要？ 📐</h3>
<p>一个优秀的项目架构就像一栋大楼的骨架，决定了它的稳定性和可扩展性。Vite 初始化的 Vue 项目，自带一套非常规范的架构，我们来一一拆解～</p>
<p>Vue 项目结构预览：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-vue-app/
├── node_modules/    <span class="hljs-comment"># 依赖包</span>
├── src/
│   ├── App.vue      <span class="hljs-comment"># Vue 根组件（核心）</span>
│   ├── main.js      <span class="hljs-comment"># 入口文件：创建 Vue 实例并挂载</span>
│   ├── components/  <span class="hljs-comment"># 组件目录</span>
│   └── style.css    <span class="hljs-comment"># 全局样式</span>
├── index.html       <span class="hljs-comment"># Vite 入口（区别于 Webpack，Vite 以 HTML 为入口）</span>
├── package.json     <span class="hljs-comment"># 脚本和依赖（含 Vite、Vue 核心依赖）</span>
└── vite.config.js   <span class="hljs-comment"># Vite 配置文件（可选，自定义端口、插件等）</span>
</code></pre>
<h4 data-id="heading-6">1.根目录的 “灵魂文件”：index.html</h4>
<p>打开项目根目录，你会看到<code>index.html</code>，它是整个应用的入口页面，相当于大楼的 “地基”：</p>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/svg+xml"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/vite.svg"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>all-vue<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 组件的挂载点：Vue应用会在这里“生根发芽” --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 加载Vue应用的入口脚本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>这里有两个关键知识点：</p>
<ol>
<li><strong>挂载点</strong>：<code>&lt;div id="app"&gt;&lt;/div&gt;</code>是 Vue 应用的 “落脚点”，后续所有的 Vue 组件都会被渲染到这个元素里，它是 Vue 与原生 DOM 的唯一连接点。</li>
<li><strong>ES 模块脚本</strong>：<code>&lt;script type="module" src="/src/main.js"&gt;&lt;/script&gt;</code>中的<code>type="module"</code>是 Vite 实现极速启动的核心！它告诉浏览器这是一个 ES 模块脚本，支持<code>import/export</code>语法，浏览器会直接按需加载模块，不用等待全量打包。</li>
</ol>
<h4 data-id="heading-7">2.src 目录：前端开发的 “主战场” 📂</h4>
<p>所有的业务代码都集中在<code>src</code>目录下，就像大楼里的各个房间，分工明确：</p>
<ul>
<li><code>main.js</code>：应用入口文件（相当于 “大门”，所有资源从这里进入）</li>
<li><code>App.vue</code>：根组件（相当于 “客厅”，是所有页面的共同容器）</li>
<li><code>style.css</code>：全局样式文件（统一管理整个应用的样式风格）</li>
<li><code>components/</code>：组件目录（存放可复用的 UI 组件，比如按钮、卡片等）</li>
</ul>
<h5 data-id="heading-8">（1）入口文件：main.js 的 “总指挥” 角色</h5>
<p><code>main.js</code>是整个 Vue 应用的启动入口，就像乐队的指挥，负责把所有资源整合起来：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 从Vue核心库中导入创建应用实例的方法</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 导入全局样式（让整个应用都能用上这些样式）</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>
<span class="hljs-comment">// 导入根组件App（整个应用的“总容器”）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-comment">// 导入路由模块（后面实现多页面会用到）</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>;

<span class="hljs-comment">// 创建Vue应用实例 → 启用路由 → 挂载到#app上</span>
<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
  .<span class="hljs-title function_">use</span>(router) <span class="hljs-comment">// 让应用拥有路由能力</span>
  .<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>) <span class="hljs-comment">// 把App组件渲染到index.html的#app元素里</span>
</code></pre>
<p>这几行代码看似简单，却完成了从 “创建应用” 到 “启动应用” 的全流程：先创建 Vue 实例，关联根组件<code>App.vue</code>，再通过<code>mount('#app')</code>把组件渲染到<code>index.html</code>的挂载点上，一个 Vue 应用就正式启动了！</p>
<h5 data-id="heading-9">（2）根组件：App.vue 的 “总容器” 作用</h5>
<p><code>App.vue</code>是 Vue 应用的根组件，所有页面和组件都会嵌套在它里面，就像一个大礼盒，装着应用的所有内容。它的结构分为三部分：模板（HTML）、脚本（JS）、样式（CSS）：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 这里可以写组件的逻辑代码（目前我们暂时不需要复杂逻辑）</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 头部导航 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 路由导航链接：vue-router提供的全局组件 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 页面内容区域：路由出口，页面组件会在这里显示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-view</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 页脚 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* scoped表示样式只作用于当前组件，避免样式冲突 */</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>可以看到，<code>App.vue</code>定义了应用的整体布局（头部、主体、底部），其中<code>&lt;router-view&gt;</code>是路由出口（后面讲多页面开发时会详细说），<code>&lt;router-link&gt;</code>是路由导航链接，这些都是<code>vue-router</code>提供的能力。</p>
<h4 data-id="heading-10">3.开发工具：效率提升的 “神器” ✨</h4>
<p>工欲善其事，必先利其器。开发 Vue3 项目，这两个工具一定要安排上：</p>
<ol>
<li><strong>Volar 插件</strong>（VS Code）：Vue 官方推出的语法提示工具，能识别 Vue3 的新语法（比如<code>&lt;script setup&gt;</code>），提供精准的代码补全和错误提示，比以前的 Vetur 好用太多！安装后，写 Vue 代码就像 “开了挂”，再也不用死记硬背 API 了～</li>
<li><strong>Vue Devtools 插件</strong>（Chrome 浏览器）：调试 Vue 应用的 “显微镜”。安装后，在浏览器开发者工具里会多出一个 “Vue” 标签，能查看组件树、组件状态、路由信息等，帮你快速定位问题。比如修改组件数据后，能实时看到界面变化，调试效率翻倍！</li>
</ol>
<h3 data-id="heading-11">三、如何进行多个页面开发呢？ 📄→📑</h3>
<p>单页面应用（SPA）是现代前端的主流，但 “单页面” 不代表只有一个页面，而是通过路由实现多个页面的切换（无需刷新浏览器）。Vue 项目中，我们用<code>vue-router</code>来实现路由功能。</p>
<h4 data-id="heading-12">第一步：安装 vue-router</h4>
<p>在终端执行以下命令，安装路由依赖：</p>
<p>bash</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> vue-router
</code></pre>
<p>安装完成后，<code>package.json</code>的<code>dependencies</code>里会多出<code>"vue-router": "^4.6.4"</code>，表示路由插件已成功引入。</p>
<h4 data-id="heading-13">第二步：配置路由规则</h4>
<p>路由就像 “地图”，告诉应用 “访问哪个路径该显示哪个页面”。我们需要创建一个路由配置文件：</p>
<ol>
<li>在<code>src</code>目录下新建<code>router</code>文件夹，然后在里面创建<code>index.js</code>（路由配置的核心文件）；</li>
<li>在<code>src</code>目录下新建<code>views</code>文件夹，存放页面组件（<code>Home.vue</code>和<code>About.vue</code>）。</li>
</ol>
<p>先看页面组件的代码，非常简单：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/views/Home.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Home Page 🏠<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/views/About.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>About Page 🔍<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>再来看路由配置文件<code>src/router/index.js</code>：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 从vue-router中导入核心方法</span>
<span class="hljs-keyword">import</span> {
  createRouter, <span class="hljs-comment">// 创建路由实例</span>
  createWebHashHistory <span class="hljs-comment">// 路由模式（hash模式，路径带#）</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-comment">// 导入页面组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>

<span class="hljs-comment">// 路由规则：路径和组件的对应关系</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-comment">// 访问根路径（http://localhost:5173/#/）</span>
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> <span class="hljs-comment">// 显示Home组件</span>
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-comment">// 访问/about路径（http://localhost:5173/#/about）</span>
    <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> <span class="hljs-comment">// 显示About组件</span>
  }
];

<span class="hljs-comment">// 创建路由实例</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(), <span class="hljs-comment">// 使用hash模式（路径带#，兼容性好）</span>
  routes <span class="hljs-comment">// 关联路由规则</span>
})

<span class="hljs-comment">// 导出路由实例，供main.js使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;
</code></pre>
<p>这里的<code>createWebHashHistory</code>表示使用 hash 模式，路径中会带<code>#</code>（比如<code>#/about</code>），好处是部署时不需要服务器额外配置；如果想去掉<code>#</code>，可以用<code>createWebHistory</code>（需要服务器支持）。</p>
<h4 data-id="heading-14">第三步：让应用 “拥有” 路由能力</h4>
<p>配置好路由后，需要在<code>main.js</code>中注册路由，让整个应用都能使用路由功能：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入路由实例</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>;

<span class="hljs-comment">// 创建应用时，通过.use(router)启用路由</span>
<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
  .<span class="hljs-title function_">use</span>(router) 
  .<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这一步非常关键，相当于给应用 “装上导航系统”，没有它，<code>&lt;router-link&gt;</code>和<code>&lt;router-view&gt;</code>都无法生效。</p>
<h4 data-id="heading-15">第四步：在 App.vue 中使用路由</h4>
<p>最后，在根组件<code>App.vue</code>中添加路由导航和路由出口：</p>
<ul>
<li><code>&lt;router-link to="路径"&gt;</code>：路由导航链接（相当于<code>&lt;a&gt;</code>标签，但不会刷新页面）；</li>
<li><code>&lt;router-view&gt;</code>：路由出口（匹配的页面组件会在这里显示）。</li>
</ul>
<p>代码我们前面已经见过了，再重点看一下核心部分：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 点击跳转到首页 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 点击跳转到关于页 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 页面内容会在这里显示 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-view</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>此时启动项目，点击导航链接，页面会在<code>Home</code>和<code>About</code>之间无缝切换，地址栏的路径也会跟着变化，这就是单页面应用的路由效果～</p>
<p>效果亮个相：
观察界面中央和地址栏的变化</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ce06ece9be74b63839da07402e27c82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766916874&amp;x-signature=tEZayKdyiDQmBGV37c%2BaIQmzBhI%3D" alt="QQ20251221-18326.gif" loading="lazy"/></p>
<h3 data-id="heading-16">结语 🌟</h3>
<p>到这里，我们已经完整走通了 “用 Vite 初始化 Vue3 项目→理解项目架构→实现多页面路由” 的全流程。回顾整个过程，你会发现现代前端工程化的核心优势：</p>
<ul>
<li><strong>工具链简化开发</strong>：Vite 的极速启动和热更新，让开发效率提升数倍；</li>
<li><strong>架构规范清晰</strong>：从<code>index.html</code>到<code>src</code>目录，每个文件的职责明确，项目再大也不会乱；</li>
<li><strong>生态完善</strong>：<code>vue-router</code>等官方插件无缝衔接，轻松实现复杂功能。</li>
</ul>
<p>前端开发不再是 “写几行代码” 那么简单，而是一套 “工具 + 规范 + 生态” 的协同体系。掌握这些基础，你就已经跨进了现代前端开发的大门～ 接下来，不妨试试在这个基础上添加更多页面、组件和交互，感受 Vue3+Vite 的魅力吧！💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 的核心概念与实现案例]]></title>    <link>https://juejin.cn/post/7585466235662270516</link>    <guid>https://juejin.cn/post/7585466235662270516</guid>    <pubDate>2025-12-20T20:16:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585466235662270516" data-draft-id="7585574047074025472" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 的核心概念与实现案例"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2025-12-20T20:16:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tinero"/> <meta itemprop="url" content="https://juejin.cn/user/332513186430804"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 的核心概念与实现案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/332513186430804/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tinero
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T20:16:34.000Z" title="Sat Dec 20 2025 20:16:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我认为 LangChain 框架主要分为这几个部分:</p>
<ol>
<li>对模型 I/O 的封装</li>
<li>数据连接封装</li>
<li>对话历史管理</li>
<li>架构封装（针对 Chain 和 Agent）</li>
</ol>
<h2 data-id="heading-0">一、对模型 I/O 的封装</h2>
<p>该模块主要是用于更好的访问 LLM 进行推理、嵌入任务。所以对访问 LLM 的请求、发送请求的数据以及接收 LLM 生成的数据进行封装</p>
<h3 data-id="heading-1">1.1 Prompt 模板</h3>
<p>这个是用来封装向 LLM 发送请求的提示词，比如常见的 SystemMessage（告诉模型如何行为并为交互提供上下文），HumanMessage（表示用户输入和与模型的交互） 和 AIMessage（模型生成的响应，包括文本内容、工具调用和元数据）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage, SystemMessage

<span class="hljs-comment"># 模拟多轮对话</span>
messages = [  
    <span class="hljs-comment"># 告诉模型你的身份</span>
    SystemMessage(content=<span class="hljs-string">"你是 JoJo 的私人小助理"</span>),  
    <span class="hljs-comment"># 用户输入的问题</span>
    HumanMessage(content=<span class="hljs-string">"我是 JoJo 的朋友，我叫 Tinero"</span>),  
    <span class="hljs-comment"># AI 的回答</span>
    AIMessage(content=<span class="hljs-string">"你好！"</span>),  
    <span class="hljs-comment"># 用户再问</span>
    HumanMessage(content=<span class="hljs-string">"我是谁？"</span>)  
]  
<span class="hljs-comment"># 就能获取 AI 的回答</span>
<span class="hljs-comment">#   llm 是用来和大模型进行交互的对象，后面会说到</span>
ret = llm.invoke(messages)  
<span class="hljs-built_in">print</span>(ret.content)  

<span class="hljs-comment"># 还可以继续再问</span>
response = llm.invoke([  
    HumanMessage(<span class="hljs-string">"你是谁?"</span>)  
])  
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<p>上面的这种方式，是整个 Prompt 都需要程序员编写，LangChain 为了更方便的调用，也支持通过自定义的模板，来构建 Prompt</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate

<span class="hljs-comment"># 定义模板</span>
template = PromptTemplate.from_template(<span class="hljs-string">"给我讲个关于{subject}的笑话"</span>)  
<span class="hljs-built_in">print</span>(template)  
<span class="hljs-built_in">print</span>(template.<span class="hljs-built_in">format</span>(subject=<span class="hljs-string">"小猫球球"</span>))  
template = PromptTemplate.from_template(<span class="hljs-string">"给我讲个关于{subject}的笑话，内容要符合{style}这个风格"</span>)  
<span class="hljs-comment"># 此时如果不传入 style 会直接报错  </span>
<span class="hljs-comment"># print(template.format(subject="小猫球球"))  </span>
ret = llm.invoke(template.<span class="hljs-built_in">format</span>(subject=<span class="hljs-string">"小猫球球"</span>, style=<span class="hljs-string">"甜甜的"</span>))  
<span class="hljs-built_in">print</span>(ret.content)
</code></pre>
<p>还可以通过模板来表示上下文</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate, ChatPromptTemplate, MessagesPlaceholder

<span class="hljs-comment"># 该模板用于表示上下文，而下面的 history 则是用于表示对话历史</span>
human_prompt = <span class="hljs-string">"Translate your answer to {language}"</span>  
<span class="hljs-comment"># 这个 prompt 可以理解为带有参数的函数，使用的时候，需要去传入参数  </span>
human_message_template = HumanMessagePromptTemplate.from_template(human_prompt)  
chat_prompt = ChatPromptTemplate.from_messages([  
    <span class="hljs-comment"># history 是 MessagesPlaceholder 在模板中的变量名，用于在赋值时使用</span>
    <span class="hljs-comment"># 这里改变顺序的话，会影响下面提示词生产的顺序  </span>
    <span class="hljs-comment"># 也就是说，如果顺序变为 human_message_template, MessagesPlaceholder("history") 那么下面赋值的时候，顺序也需要对应的进行调整 </span>
    MessagesPlaceholder(<span class="hljs-string">"history"</span>), human_message_template
    
])
<span class="hljs-comment"># 构建对话历史</span>
human_message = HumanMessage(content=<span class="hljs-string">"Who is JoJo?"</span>)  
ai_message = AIMessage(content=<span class="hljs-string">"JoJo is a billionaire entrepreneur, inventor, and industrial designer"</span>)  
messages = chat_prompt.format_prompt(  
    <span class="hljs-comment"># 对 history 和 language 进行赋值  </span>
    history=[human_message, ai_message], language=<span class="hljs-string">"中文"</span>  
)
<span class="hljs-comment"># 访问 LLM</span>
ret = llm.invoke(messages)  
<span class="hljs-built_in">print</span>(ret.content)
</code></pre>
<p>除此之外，还可以从文件中去加载 Prompt 模板</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate

<span class="hljs-string">"""
./prompt_template.txt 文件的内容为：
给我讲个关于{topic}的笑话
"""</span>

template = PromptTemplate.from_file(<span class="hljs-string">"./prompt_template.txt"</span>, encoding=<span class="hljs-string">"utf-8"</span>)  
<span class="hljs-built_in">print</span>(template.format_prompt(topic=<span class="hljs-string">"小猫球球"</span>))
</code></pre>
<h3 data-id="heading-2">1.2 访问 LLMs</h3>
<p>好的，有了想要访问 LLM 的 Prompt，我们就需要将其发送给 LLM，让它去给我们生成回答，而 LLM 的回答，根据任务的不同（分为推理、嵌入等），会有不同的返回结果</p>
<p>LangChain 封装了 OpenAI，所以可以使用这种方式去访问模型，先说使用模型进行推理任务</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 这里访问的是 Qwen 模型，对应的 API 和 Token 我都存储到环境变量里去了</span>
llm = ChatOpenAI(model=<span class="hljs-string">"qwen3-max"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>))

<span class="hljs-comment"># 然后就可以对其进行推理任务了</span>
response = llm.invoke(<span class="hljs-string">"你是谁?"</span>)

<span class="hljs-comment"># 还可以通过 llm 进行流式输出，获取对应的 chunks</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> llm.stream(<span class="hljs-string">"你是谁"</span>):  
    <span class="hljs-built_in">print</span>(chunk)
</code></pre>
<p>除了实现推理任务，还可以对其进行词嵌入任务</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> OpenAIEmbeddings

<span class="hljs-comment"># 这里同样访问的是 Qwen 的词嵌入模型，返回的是一个列表，里面一堆浮点型数据，词嵌入通常和检索一块儿使用</span>
embeddings = OpenAIEmbeddings(model=<span class="hljs-string">"text-embedding-v4"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>),  check_embedding_ctx_length=<span class="hljs-literal">False</span>)
<span class="hljs-built_in">print</span>(embeddings.embed_query(<span class="hljs-string">"你是谁？"</span>))
</code></pre>
<h3 data-id="heading-3">1.3 格式化 LLMs 的响应结果</h3>
<p>访问 LLMs 后，我们会获取到其推理生成的结果（这里不说嵌入），但是响应的结果通常都是文本（LangChain 支持对 LLMs 响应结果的各种解析，可以使用 JsonOutputParser 去解析 LLMs 生成的 Json 数据，还可以使用 StrOutputParser 解析 LLMs 生成的字符串，以及其他的解析器。因为调用 llm 对象，返回的也是个对象，可以使用这几个将其结果全部解析除了，比如调用 StrOutputParser 后，获取到的结果是个字符串，因为很简单就不举例了，可以看官方文档，这里重点说下如何解析成 Json 和 Pydantic），这个不方便我们解析，我们想要将其格式化，那么就可以使用这种方式</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> JsonOutputParser, PydanticOutputParser

<span class="hljs-comment"># 直接输出 pydantic 对象  </span>
<span class="hljs-comment"># 定义输出对象  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Date</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):  
    year: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"Year"</span>)  
    month: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"Month"</span>)  
    day: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"Day"</span>)  
    era: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"BC or AD"</span>)  
  
  
<span class="hljs-comment"># 定义结构化输出的模型  </span>
structured_llm = llm.with_structured_output(Date)  
<span class="hljs-comment"># 下面的模板中，必须要包含 "返回的结果是包含 year, month, day, 和 era 的 Json 对象" 这句话，要不然会报错，因为返回的不是 Json 对象，无法将其转换为 pydantic 对象</span>
template = <span class="hljs-string">"""  
提取用户输入中的日期  
用户输入：  
{query}  
返回的结果是包含 year, month, day, 和 era 的 Json 对象  
"""</span>  
prompt = PromptTemplate(template=template)  
<span class="hljs-comment"># 还可以这样子</span>
<span class="hljs-comment"># prompt = PromptTemplate.from_template(template)  </span>
query = <span class="hljs-string">"2025年十一月30日天气晴。。。"</span>  
input_query = prompt.format_prompt(query=query)  
ret = structured_llm.invoke(input_query)  
<span class="hljs-built_in">print</span>(ret)


<span class="hljs-comment"># 输出指定格式的 Json</span>
json_schema = {  
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"Date"</span>,  
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"Formated date expression"</span>,  
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,  
    <span class="hljs-string">"properties"</span>: {  
        <span class="hljs-string">"year"</span>: {  
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"integer"</span>,  
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"year YYYY"</span>  
        },  
        <span class="hljs-string">"month"</span>: {  
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"integer"</span>,  
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"month MM"</span>  
        },  
        <span class="hljs-string">"day"</span>: {  
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"integer"</span>,  
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"day DD"</span>  
        },  
        <span class="hljs-string">"era"</span>: {  
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,  
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"BC or AD"</span>  
        }  
    }  
}  
structured_llm = llm.with_structured_output(json_schema)  
<span class="hljs-comment"># 还是必须加上最后一句话，要不然会报错  </span>
template = <span class="hljs-string">"""  
提取用户输入中的日期  
用户输入：  
{query}  
返回的结果是包含 year, month, day, 和 era 的 Json 对象  
"""</span>  
prompt = PromptTemplate.from_template(template)  
query = <span class="hljs-string">"2025年十一月30日天气晴。。。"</span>  
input_query = prompt.format_prompt(query=query)  
ret = structured_llm.invoke(input_query)  
<span class="hljs-built_in">print</span>(ret)


<span class="hljs-comment"># 也可以使用 JsonOutputParser  </span>
<span class="hljs-comment"># parser = JsonOutputParser(pydantic_object=Date)  </span>
<span class="hljs-comment"># 使用 PydanticOutputParser 也是可以的  </span>
parser = PydanticOutputParser(pydantic_object=Date)  
prompt = PromptTemplate(  
    template=<span class="hljs-string">"提取用户输入中的日期 \n 用户输入：\n{query}\n{format_instructions}"</span>,  
    input_variables=[<span class="hljs-string">"query"</span>],  
    <span class="hljs-comment"># 指定响应格式</span>
    partial_variables={  
        <span class="hljs-string">"format_instructions"</span>: parser.get_format_instructions()  
    }  
)  
query = <span class="hljs-string">"2025年十一月30日天气晴。。。"</span>  
input_prompt = prompt.format_prompt(query=query) 
ret = llm.invoke(input_prompt)  
<span class="hljs-built_in">print</span>(ret.content)  
<span class="hljs-built_in">print</span>(parser.invoke(ret))

</code></pre>
<p>当然，在实际使用中，如果有时候大模型响应的结果不正确，或不符合我们的要求，我们不希望他直接报错，而是自动纠错下，然后再返回给我们，但是使用这个功能，很考验大模型的能力，可以看下面的例子</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在上面案例的基础上，添加一个纠错的功能</span>
<span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> OutputFixingParser

<span class="hljs-comment"># 利用大模型做格式自动纠错</span>
parser = PydanticOutputParser(pydantic_object=Date)  
new_parser = OutputFixingParser.from_llm(parser=parser, llm=llm)  
bad_output = ret.content.replace(<span class="hljs-string">"5"</span>, <span class="hljs-string">"四"</span>)  
<span class="hljs-comment"># bad_output = ret.content.replace("5", "六")  </span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"PydanticOutputParser: "</span>)  
<span class="hljs-keyword">try</span>:  
    parser.invoke(bad_output)  
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  
    <span class="hljs-built_in">print</span>(e)  
<span class="hljs-built_in">print</span>(<span class="hljs-string">"OutputFixingParser："</span>)  
<span class="hljs-built_in">print</span>(new_parser.invoke(bad_output))  
<span class="hljs-string">"""  
但是纠错后的结果，为 year=2023 month=11 day=30 era='AD'，  
我们想要的结果是 year=2025 month=11 day=30 era='AD'  
这个问题和模型能力有关系，只能说付费有付费的道理  
使用 qwen3-max 强的一点在于，如果替换为四，纠错后为 2024，如果替换为六，纠错后为 2026  
使用 qwen-plus，不管是替换为四还是替为六，纠错后都是 2024，只能说能力提升了一点，但是不多
如果有兴趣的话，可以使用一些付费的模型去试试，我比较穷，就先不尝试了
"""</span>

</code></pre>
<p>经过上面的对 Prompt、请求 LLMs 以及 Parser Output，整个对模型 I/O 的封装已经实现了，但是有时候，我们会遇到 Function Calling 的情况，特别是在 Agent 里，所以介绍下这个</p>
<h3 data-id="heading-4">1.4 Function Calling</h3>
<p>实际开发中，如果想要各种业务接口互相调用的话，那么就可以用这个，我理解这个主要是用于和 MCP 进行对接的</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool

<span class="hljs-comment"># 自定义两个工具函数，需要注意的是，一定要在函数里添加注释！！！，否则识别不了你这个工具是干啥的</span>
<span class="hljs-comment"># 添加个装饰器，表明这个使用调用的工具函数</span>
<span class="hljs-meta">@tool  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:  
    <span class="hljs-string">"""  
    Add two integers.  
    :param a: First integer  
    :param b: Second integer  
    :return:  
    """</span>  
    <span class="hljs-keyword">return</span> a + b  
  
  
<span class="hljs-meta">@tool  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:  
    <span class="hljs-string">"""  
    Multiply two integers.  
    :param a: First integer  
    :param b: Second integer  
    :return:  
    """</span>  
    <span class="hljs-keyword">return</span> a * b  
  

<span class="hljs-comment"># 绑定自定义工具</span>
llm_with_tools = llm.bind_tools([add, multiply])  
query = <span class="hljs-string">"3 的 4 倍是多少？"</span>  
messages = [HumanMessage(query)]  
output = llm_with_tools.invoke(messages)  
<span class="hljs-built_in">print</span>(json.dumps(output.tool_calls, indent=<span class="hljs-number">4</span>))  
<span class="hljs-built_in">print</span>()  
<span class="hljs-comment"># 将 AI 响应的结果，放到对话历史里</span>
messages.append(output)  
available_tools = {  
    <span class="hljs-string">"add"</span>: add,  
    <span class="hljs-string">"multiply"</span>: multiply  
}  
<span class="hljs-comment"># 看模型调用哪个工具，就执行对应的函数，然后将结果存放到对话历史里</span>
<span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> output.tool_calls:  
    selected_tool = available_tools[tool_call[<span class="hljs-string">"name"</span>].lower()]  
    tool_msg = selected_tool.invoke(tool_call)  
    messages.append(tool_msg)  

<span class="hljs-comment"># 把整个对话历史再发送给模型</span>
new_output = llm_with_tools.invoke(messages)  
<span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> messages:  
    <span class="hljs-built_in">print</span>(json.dumps(message.model_dump(), indent=<span class="hljs-number">4</span>, ensure_ascii=<span class="hljs-literal">False</span>))  
    <span class="hljs-built_in">print</span>()  
<span class="hljs-built_in">print</span>(new_output.content)
</code></pre>
<h2 data-id="heading-5">二、数据连接封装</h2>
<p>使用 LangChain 在做 RAG 的时候，经常会用到整个，现在通过构建个简单的 RAG 案例，来进行介绍</p>
<h3 data-id="heading-6">2.1 Document Loaders</h3>
<p>LangChain 支持对各种格式文件进行加载，如何加载就是使用不同的加载器，这里我是对 PDF 进行加载，其他的可以查看官方文档进行使用</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> PyMuPDFLoader

<span class="hljs-comment"># 提取文档内容  </span>
loader = PyMuPDFLoader(<span class="hljs-string">"./resource/2307.09288v2.pdf"</span>)  
<span class="hljs-comment"># 进行分页，需要注意的是，这个只能提取出文字，图片识别不出来</span>
pages = loader.load_and_split() 
</code></pre>
<h3 data-id="heading-7">2.2 Document Transformers</h3>
<p>将不同的格式文件加载进来后，需要对文档内容进行分割，分割的话，方法有很多种，比如按段落啦，或是通过 AI 辅助，将内容按相近语义进行分割啦等等，这里只举例最简单的例子</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter


<span class="hljs-comment"># 对文档内容进行分割  </span>
<span class="hljs-comment"># 这个类，只能对简单的文本进行切割，但是对图片，表格这种，是切分不了的  </span>
text_splitter = RecursiveCharacterTextSplitter(  
    <span class="hljs-comment"># chunk 的大小  </span>
    chunk_size=<span class="hljs-number">200</span>,  
    <span class="hljs-comment"># 重复的大小  </span>
    chunk_overlap=<span class="hljs-number">100</span>,  
    <span class="hljs-comment"># 统计 chunk 长度的函数</span>
    length_function=<span class="hljs-built_in">len</span>,  
    add_start_index=<span class="hljs-literal">True</span>  
)  
paragraphs = text_splitter.create_documents([  
    page.page_content <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pages[:<span class="hljs-number">4</span>]  
])
<span class="hljs-keyword">for</span> para <span class="hljs-keyword">in</span> paragraphs:  
    <span class="hljs-built_in">print</span>(para.page_content)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>)
</code></pre>
<h3 data-id="heading-8">2.3 Text Embedding Models</h3>
<p>对文档进行切割后，我们就需要对文本进行向量化表示，用于检索等操作，那么就可以使用到上面说的词嵌入方式了</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> OpenAIEmbeddings

<span class="hljs-comment"># 我使用的是 阿里云百炼的模型，并不是官方的 openai 的模型。</span>
<span class="hljs-comment"># 调用非 OpenAI 模型时，  </span>
<span class="hljs-comment"># LangChain 默认会对文本进行 Token 化预处理，</span>
<span class="hljs-comment"># 导致实际发送给模型的不是原始字符串，而是 Token 列表，从而触发格式错误  </span>
<span class="hljs-comment"># 所以要加上 check_embedding_ctx_length=False</span>
embeddings = OpenAIEmbeddings(model=<span class="hljs-string">"text-embedding-v4"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>),  check_embedding_ctx_length=<span class="hljs-literal">False</span>)  
<span class="hljs-built_in">print</span>(embeddings.embed_query(<span class="hljs-string">"你是谁？"</span>))
</code></pre>
<h3 data-id="heading-9">2.4 Vectorstores</h3>
<p>获取到词嵌入模型对象，那么我们就可以根据这个词嵌入模型，将之前切分的 chunk 分别进行向量化表示，然后将其全部存储到向量数据库中</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS

<span class="hljs-comment"># 我们将向量存储到 FAISS 数据库中</span>
<span class="hljs-comment"># text-embedding-v4 可能存在单文本字符数上限（如 8192 字符）和批量大小限制（如单次不超过 10 条）。  </span>
<span class="hljs-comment"># paragraphs 列表若包含超长文本或批次过大，会进一步引发类似错误，所以采用下面的方法，进行批次处理</span>
BATCH_SIZE = <span class="hljs-number">1</span> <span class="hljs-comment"># 根据模型文档调整  </span>
db = <span class="hljs-literal">None</span>  
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(paragraphs), BATCH_SIZE):  
    batch_docs = paragraphs[i:i+BATCH_SIZE]  
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span>:  
        db = FAISS.from_documents(batch_docs, embeddings)  
    <span class="hljs-keyword">else</span>:  
        db.add_documents(batch_docs)
        
<span class="hljs-comment"># 如果没有限制的话，可以直接一步搞定</span>
db = FAISS.from_documents(paragraphs, embeddings)
</code></pre>
<h3 data-id="heading-10">2.5 Retrievers</h3>
<p>全部向量化后，我们就可以进行提问了，提问的时候，会去向量库中去检索最相似的向量，一块儿发送给 LLMs，让 LLMs 给我们做总结归纳</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 检索 top-3 的结果  </span>
retriever = db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})  
docs = retriever.invoke(<span class="hljs-string">"llama2 有多少参数"</span>)  
  
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:  
    <span class="hljs-built_in">print</span>(doc.page_content)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"================"</span>)
</code></pre>
<p>此时，一个简单的 RAG 就已经开发完了</p>
<h2 data-id="heading-11">三、对话历史管理</h2>
<p>现在我们已经会使用 LangChain 和 LLMs 进行交互了，但是有一个问题也需要我们去注意，就是如何管理用户和 AI 的对话历史，如果只是简单的进行了几次交互，倒也罢了，如果是好几十条，百条呢？</p>
<p>在 LangChain 里可以使用 trim_messages 去管理历史对话，首先我们先声明一个 ChatOpenAI 的对象，这个对象和上面的不同之处在于，我们需要在这个对象里面，去自定义一个 Token 的计数逻辑，用来统计 AI 生成了多少 Token，从而可以让我们去决定，什么时候去触发对会话历史进行管理</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tiktoken  
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>  
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QwenChatOpenAI</span>(<span class="hljs-title class_ inherited__">ChatOpenAI</span>):  
<span class="hljs-string">"""如果不自定义实现的话，会报错，因为不支持"""</span>  
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_num_tokens_from_messages</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[BaseMessage], tools=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">int</span>:  
    <span class="hljs-string">"""  
    自定义 qwen3-max 的 token 计数逻辑  
    根据 qwen3-max 的实际 token 规则，重写  get_num_tokens_from_messages 方法。国内模型通常使用与 GPT 兼容的 BPE 编码，可借助 tiktoken 库模拟计算  
    :param messages:  
    :param tools:  
    :return:  
    """</span>  
    <span class="hljs-comment"># 1. 选择与 qwen3-max 兼容的编码模型（如 gpt-3.5-turbo）  </span>
    encoding = tiktoken.get_encoding(<span class="hljs-string">"cl100k_base"</span>)  
    <span class="hljs-comment"># 2. 按模型规则计算token数（参考文档）  </span>
    num_tokens = <span class="hljs-number">0</span>  
    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> messages:  
    num_tokens += <span class="hljs-number">4</span> <span class="hljs-comment"># 每个消息固定前缀：&lt;|im_start|&gt;role\ncontent&lt;|im_end|&gt;  </span>
    num_tokens += <span class="hljs-built_in">len</span>(encoding.encode(message.content))  
    num_tokens += <span class="hljs-number">2</span> <span class="hljs-comment"># 对话结束标记  </span>
    <span class="hljs-keyword">return</span> num_tokens  
  
  
llm = QwenChatOpenAI(model=<span class="hljs-string">"qwen3-max"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>))
</code></pre>
<p>好的，现在我们已经有了模型对象了，再声明一个多轮对话的列表，模拟对话历史</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> AIMessage, HumanMessage, SystemMessage

messages = [  
    SystemMessage(<span class="hljs-string">"You're a good assistant, you always respond with a joke"</span>),  
    HumanMessage(<span class="hljs-string">"I wonder why it's called langchain"</span>),  
    <span class="hljs-comment"># 可使用这种来指定 ID  </span>
    <span class="hljs-comment"># HumanMessage("I wonder why it's called langchain", id="3"),  </span>
    AIMessage(<span class="hljs-string">"Well, I guess they thought 'WordRope' and 'SentenceString' just didn't have the same thing to it!"</span>),  
    <span class="hljs-comment"># HumanMessage("and who is harrison chasing anyways"),  </span>
    <span class="hljs-comment"># 可使用这种来指定 name 属性  </span>
    HumanMessage(<span class="hljs-string">"and who is harrison chasing anyways"</span>, name=<span class="hljs-string">"example_user"</span>),  
    <span class="hljs-comment"># AIMessage("Hmm let me think. \n\n Why, he's probably chasing after the last cup of coffee in the office!"),  </span>
    AIMessage(<span class="hljs-string">"Hmm let me think. \n\n Why, he's probably chasing after the last cup of coffee in the office!"</span>,  
    name=<span class="hljs-string">"aaa"</span>),  
    HumanMessage(<span class="hljs-string">"what do you call a speechless parrot"</span>)  
]
</code></pre>
<h3 data-id="heading-12">3.1 trim_messages</h3>
<p>现在可以通过 trim_messages 来管理对话信息</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> trim_messages

<span class="hljs-comment"># 只保留最后一次对话，这两种方式都可以</span>
<span class="hljs-comment"># result = trim_messages(messages, max_tokens=45, strategy="last", token_counter=llm.get_num_tokens_from_messages)  </span>
result = trim_messages(messages, max_tokens=<span class="hljs-number">45</span>, strategy=<span class="hljs-string">"last"</span>, token_counter=llm)  
<span class="hljs-built_in">print</span>(result)
</code></pre>
<p>上面的案例可以跑跑看，有了大概的影响，来介绍下 trim_messages 里的参数</p>
<pre><code class="hljs language-python" lang="python">result = trim_messages(messages,  
    <span class="hljs-comment"># 允许的最大 token 总数  </span>
    <span class="hljs-comment"># 限制 messages 列表的总 token 数上限，超过此值时触发截断逻辑  </span>
    max_tokens=<span class="hljs-number">45</span>, 
    <span class="hljs-comment"># 截断策略  </span>
    <span class="hljs-comment"># 决定如何保留消息以满足 max_tokens 限制，默认值常为 "last"（保留最新消息）。  </span>
    strategy=<span class="hljs-string">"last"</span>,  
    <span class="hljs-comment"># token 计数工具  </span>
    <span class="hljs-comment"># 负责计算单条/多条消息的 token 数量，确保截断后总 token 严格控制在 max_tokens 内。  </span>
    token_counter=llm,  
    <span class="hljs-comment"># 是否 保留系统提示消息  </span>
    include_system=<span class="hljs-literal">True</span>,  
    <span class="hljs-comment"># 当单条消息过长（如超长用户输入）时，是否允许 截断该消息本身（而非整段丢弃）  </span>
    <span class="hljs-comment"># True（默认）：截取消息的前 N 个 tokens（保留部分内容）  </span>
    <span class="hljs-comment"># ❌ 原消息："这是一段 100 tokens 的超长文本..."  </span>
    <span class="hljs-comment"># ✅ 截断后："这是一段 30 tokens 的超..."（假设剩余 tokens 仅 30）  </span>
    <span class="hljs-comment"># False：若单条消息 tokens &gt; max_tokens，直接丢弃整条消息（可能丢失关键信息）  </span>
    allow_partial=<span class="hljs-literal">True</span>)  
<span class="hljs-built_in">print</span>(result)
</code></pre>
<h3 data-id="heading-13">3.2 filter_messages</h3>
<p>除此之外，还可以使用 filter_messages 去过滤带标识的历史信息</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> filter_messages

<span class="hljs-comment"># include_types 用于 指定需要保留的消息类型，不符合类型的消息会被过滤掉  </span>
<span class="hljs-comment"># 支持 字符串（单个类型）或 列表（多个类型），例如 include_types=["human", "ai"] 会同时保留人类和AI的消息  </span>
result = filter_messages(messages, include_types=<span class="hljs-string">"human"</span>)

<span class="hljs-comment"># exclude_names 用于 指定需要排除的发送者名称，匹配名称的消息会被过滤掉  </span>
<span class="hljs-comment"># ["example_user", "example_assistant"]：排除名称为“示例用户”和“示例助手”的消息（通常用于过滤演示数据或测试消息）。  </span>
<span class="hljs-comment"># 名称匹配区分大小写（如 Example_User 与 example_user 视为不同名称）  </span>
<span class="hljs-comment"># 筛选逻辑：遍历 messages，排除 name 属性在 exclude_names 列表中的消息，保留其他所有消息。  </span>
result = filter_messages(messages, exclude_names=[<span class="hljs-string">"example_user"</span>, <span class="hljs-string">"example_assistant"</span>])

<span class="hljs-comment"># exclude_ids  </span>
<span class="hljs-comment"># 排除 指定唯一ID 的消息。id 通常是消息的唯一标识符（如UUID或自增编号），用于精准定位单条消息  </span>
result = filter_messages(messages, include_types=[HumanMessage, AIMessage], exclude_ids=[<span class="hljs-string">"3"</span>])
</code></pre>
<h3 data-id="heading-14">3.3 存储对话历史</h3>
<p>上面说到的方法，都是对对话历史进行裁剪、过滤，除此之外，还可以将对话历史进行存储</p>
<p>在高并发场景下，可以使用 redis，mongodb 这种缓存数据库，但是推荐使用 redis。这里我们使用 sqlite 进行一个简单的举例，我们通过 session id 来区分对话历史，并将其存储到 sqlite 中</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_session_history</span>(<span class="hljs-params">session_id</span>):  
    <span class="hljs-comment"># 通过 session_id 区分对话历史，并存储在 sqlite 数据库中  </span>
    <span class="hljs-comment"># SQLite是文件型数据库，Python标准库已内置基础支持，通过sqlalchemy即可直接操作，无需额外部署服务  </span>
    <span class="hljs-comment"># LangChain通过它实现与SQLite的连接和操作  </span>
    <span class="hljs-keyword">return</span> SQLChatMessageHistory(session_id, <span class="hljs-string">"sqlite:///memory.db"</span>)
</code></pre>
<p>声明 LLMs 对象，并构建一个简单的 lcel 对象（后面会说到，就是一个链式调用）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser

model = ChatOpenAI(model=<span class="hljs-string">"qwen-plus"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  
base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>), temperature=<span class="hljs-number">0</span>)

runnable = model | StrOutputParser()
</code></pre>
<p>构建管理历史对话的 runnable（该对象除了可以正常调用外，还可以传入对应的配置）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables.history <span class="hljs-keyword">import</span> RunnableWithMessageHistory

runnable_width_history = RunnableWithMessageHistory(  
    runnable,  
    <span class="hljs-comment"># 指定自定义的历史管理方法  </span>
    get_session_history  
)
</code></pre>
<p>现在构建完成了，使用简单的例子来验证下</p>
<pre><code class="hljs language-python" lang="python">ret = runnable_width_history.invoke(  
    [  
        HumanMessage(content=<span class="hljs-string">"你好，我叫 JoJo，中文名字叫啵啵"</span>)  
    ],  
    config={  
        <span class="hljs-string">"configurable"</span>: {  
            <span class="hljs-string">"session_id"</span>: <span class="hljs-string">"jojo"</span>  
        }  
    }  
)  
<span class="hljs-built_in">print</span>(ret)  
<span class="hljs-built_in">print</span>()  
ret = runnable_width_history.invoke(  
    [  
        HumanMessage(content=<span class="hljs-string">"你知道我叫什么名字吗？"</span>)  
    ],  
    config={  
        <span class="hljs-string">"configurable"</span>: {  
            <span class="hljs-string">"session_id"</span>: <span class="hljs-string">"jojo"</span>  
        }  
    }  
)  
<span class="hljs-built_in">print</span>(ret)  
<span class="hljs-built_in">print</span>()  
ret = runnable_width_history.invoke(  
    [  
        HumanMessage(content=<span class="hljs-string">"你好，我叫 JoJo，中文名字叫啵啵"</span>)  
    ],  
    config={  
        <span class="hljs-string">"configurable"</span>: {  
            <span class="hljs-string">"session_id"</span>: <span class="hljs-string">"test"</span>  
        }  
    }  
)  
<span class="hljs-built_in">print</span>(ret)  
<span class="hljs-built_in">print</span>()
</code></pre>
<h2 data-id="heading-15">四、架构封装</h2>
<p>有了上面的知识，其实 LangChain 基本的知识都已经掌握了，而在架构封装里，主要介绍到两个东西，分别是 Chain 和 Agent</p>
<h3 data-id="heading-16">4.1 Chain</h3>
<p>Chain 其实就是上面说到的 lcel（LangChain Expression Language，链式调用），主要是就是对一个功能或一系列顺序功能组合</p>
<p>举个例子，通过链式调用 PromptTemplate，LLM 和 OutputParser</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">from</span> langchain_openai.chat_models <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough


<span class="hljs-comment"># 定义输出结构  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SortEnum</span>(<span class="hljs-built_in">str</span>, Enum):  
    data = <span class="hljs-string">"data"</span>  
    price = <span class="hljs-string">"price"</span>  
  
  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderingEnum</span>(<span class="hljs-built_in">str</span>, Enum):  
    ascend = <span class="hljs-string">"ascend"</span>  
    descend = <span class="hljs-string">"descend"</span>  
  
  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Semantics</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):  
    name: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"流量包名称"</span>, default=<span class="hljs-literal">None</span>)  
    price_lower: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(description=<span class="hljs-string">"价格下限"</span>, default=<span class="hljs-literal">None</span>)  
    price_upper: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(description=<span class="hljs-string">"价格上限"</span>, default=<span class="hljs-literal">None</span>)  
    data_lower: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(description=<span class="hljs-string">"流量下限"</span>, default=<span class="hljs-literal">None</span>)  
    data_upper: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(description=<span class="hljs-string">"流量上限"</span>, default=<span class="hljs-literal">None</span>)  
    sort_by: <span class="hljs-type">Optional</span>[SortEnum] = Field(description=<span class="hljs-string">"按价格或流量排序"</span>, default=<span class="hljs-literal">None</span>)  
    ordering: <span class="hljs-type">Optional</span>[OrderingEnum] = Field(description=<span class="hljs-string">"升序或降序排序"</span>, default=<span class="hljs-literal">None</span>)  
  
  
<span class="hljs-comment"># Prompt 模板  </span>
prompt = ChatPromptTemplate.from_messages(  
    [  
        (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个语义解析器，你的任务是将用户的输入解析成 Json 表示，不要回答用户的问题。"</span>),  
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{text}"</span>)  
    ]  
)

<span class="hljs-comment"># 直接获取结果</span>
structured_llm = llm.with_structured_output(Semantics)  

<span class="hljs-comment"># LCEL 表达式  </span>
<span class="hljs-comment"># 数据从左往右传输，类似于 Linux 中的 管道 命令</span>
runnable = (  
    {  
        <span class="hljs-comment"># RunnablePassthrough 将输入数据原样传递到下游步骤，说白了就是获取输入的文本，可以将其理解为 Python 中的 input</span>
        <span class="hljs-string">"text"</span>: RunnablePassthrough()  
    } | prompt | structured_llm  
)  

ret = runnable.invoke(<span class="hljs-string">"不超过 100 元的流量大的套餐有哪些"</span>)  
<span class="hljs-built_in">print</span>(json.dumps(ret.model_dump(), indent=<span class="hljs-number">4</span>, ensure_ascii=<span class="hljs-literal">False</span>))

<span class="hljs-comment"># 流式输出</span>
prompt = PromptTemplate.from_template(<span class="hljs-string">"讲个关于{topic}的笑话"</span>)  
runnable = (  
    {  
        <span class="hljs-string">"topic"</span>: RunnablePassthrough()  
    } | prompt | llm | StrOutputParser()  
)  
<span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> runnable.stream(<span class="hljs-string">"小猫球球"</span>):  
    <span class="hljs-built_in">print</span>(s, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
</code></pre>
<p>而且在链式调用，可以支持工厂模式，即可以自由选择要推理的模型</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai.chat_models <span class="hljs-keyword">import</span> ChatOpenAI  
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, HumanMessagePromptTemplate  
<span class="hljs-keyword">from</span> langchain_core.runnables.utils <span class="hljs-keyword">import</span> ConfigurableField  
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser  
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough  
  
<span class="hljs-comment"># 模型1  </span>
llm_max = ChatOpenAI(model=<span class="hljs-string">"qwen3-max"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>))  
<span class="hljs-comment"># 模型2  </span>
llm_plus = ChatOpenAI(model=<span class="hljs-string">"qwen-plus"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>), temperature=<span class="hljs-number">0</span>)  
  
<span class="hljs-comment"># 通过 configurable_alternatives 按指定字段选择模型  </span>
<span class="hljs-comment"># 将两个模型包装为可切换选项  </span>
llm = llm_plus.configurable_alternatives(  
    <span class="hljs-comment"># 配置字段 ID（用于运行时切换）  </span>
    ConfigurableField(<span class="hljs-built_in">id</span>=<span class="hljs-string">"llm"</span>),  
    <span class="hljs-comment"># 默认使用 qwen3 plus 模型  </span>
    default_key=<span class="hljs-string">"plus"</span>,  
    <span class="hljs-comment"># 注册 qwen3 max，键名为 "max"  </span>
    <span class="hljs-built_in">max</span>=llm_max  
)  
  
<span class="hljs-comment"># prompt 模板  </span>
prompt = ChatPromptTemplate.from_messages([  
    HumanMessagePromptTemplate.from_template(<span class="hljs-string">"{query}"</span>)  
])  
  
<span class="hljs-comment"># LCEL  </span>
chain = {  
<span class="hljs-string">"query"</span>: RunnablePassthrough()  
} | prompt | llm | StrOutputParser()  
  
<span class="hljs-comment"># 运行时指定 “plus” 或 “max”  </span>
ret = chain.with_config(configurable={  
    <span class="hljs-comment"># "llm": "plus"  </span>
    <span class="hljs-string">"llm"</span>: <span class="hljs-string">"max"</span>  
}).invoke(<span class="hljs-string">"你叫什么名字，请自我介绍下"</span>)  
<span class="hljs-built_in">print</span>(ret)
</code></pre>
<p>而且使用链式调用，可以直接实现一个 RAG</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai.embeddings <span class="hljs-keyword">import</span> OpenAIEmbeddings
<span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> PyMuPDFLoader  
<span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter  
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser

<span class="hljs-comment"># 加载文档  </span>
loader = PyMuPDFLoader(<span class="hljs-string">"./resource/2307.09288v2.pdf"</span>)  
pages = loader.load_and_split()

<span class="hljs-comment"># 文档切分  </span>
text_splitter = RecursiveCharacterTextSplitter(  
    chunk_size=<span class="hljs-number">300</span>,  
    chunk_overlap=<span class="hljs-number">100</span>,  
    length_function=<span class="hljs-built_in">len</span>,  
    add_start_index=<span class="hljs-literal">True</span>  
)  
texts = text_splitter.create_documents(  
    [  
        page.page_content <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pages[:<span class="hljs-number">1</span>]  
    ]  
)

<span class="hljs-comment"># 灌库  </span>
embeddings = OpenAIEmbeddings(model=<span class="hljs-string">"text-embedding-v4"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>),  check_embedding_ctx_length=<span class="hljs-literal">False</span>)  
db = <span class="hljs-literal">None</span>  
<span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(texts):  
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span>:  
        db = FAISS.from_documents([text], embeddings)  
    <span class="hljs-keyword">else</span>:  
        db.add_documents([text])
        
<span class="hljs-comment"># 检索 top 2 的结果  </span>
retriever = db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})

<span class="hljs-comment"># prompt 模板  </span>
template = <span class="hljs-string">"""  
Answer the question based only on the following context:  
{context}  
  
Questions: {question}  
"""</span>  
prompt = ChatPromptTemplate.from_template(template)

<span class="hljs-comment"># chain，全部声明好后，直接全部串联起来了</span>
rag_chain = (  
    {  
        <span class="hljs-string">"question"</span>: RunnablePassthrough(),  
        <span class="hljs-string">"context"</span>: retriever  
    } | prompt | llm | StrOutputParser()  
)  
ret = rag_chain.invoke(<span class="hljs-string">"Llama 2 的有多少参数？"</span>)  
<span class="hljs-built_in">print</span>(ret)
</code></pre>
<h3 data-id="heading-17">4.2 Agent</h3>
<p>而 Agent 就是根据用户输入，自动规划执行步骤，自动选择每一步需要的工具，最终完成用户指定的功能</p>
<p>LangChain 实现 Agent，可以分为两类，这两类的名称，官方是没有这个说法的，只是我用来方便区分</p>
<h4 data-id="heading-18">4.2.1 传统方式</h4>
<p>使用 AgentType，进行指定，提示词内置不可见</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai.chat_models <span class="hljs-keyword">import</span> ChatOpenAI  
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, AgentType, create_react_agent, AgentExecutor, create_tool_calling_agent  
<span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> StructuredTool, Tool

<span class="hljs-comment"># 1. 获取 Tavily 搜索工具的实例</span>
<span class="hljs-comment"># 使用之前要配置好 TAVILY_API_KEY 环境变量</span>
search = TavilySearchResults(max_results=<span class="hljs-number">10</span>)
<span class="hljs-comment"># 由于 TavilySearchResults 类是继承了 BaseTool 基类的，所以不需要再封装一层，可直接使用，如果没有，则必须再封装一层，如何封装，接下来会举例</span>

<span class="hljs-comment"># 2. 定义一个计算工具</span>
<span class="hljs-comment"># Langchain 封装的工具类，可以进行数学计算，这个集成的基类不是 BaseTool，所以必须得包一层才行  </span>
python_repl = PythonREPL()  
<span class="hljs-comment"># 封装的话，有两种方式，一种是使用 Tool</span>
calc_tool = Tool(  
    name=<span class="hljs-string">"calculator"</span>,  
    <span class="hljs-comment"># 指定入口函数</span>
    func=python_repl.run,  
    description=<span class="hljs-string">"用于执行数学计算，例如计算百分比变化"</span>  
)
<span class="hljs-comment"># 另一种则是使用 StructuredTool</span>
calc_tool = StructuredTool.from_function(
    func=python_repl.run,  
    name=<span class="hljs-string">"Search"</span>,  
    description=<span class="hljs-string">"用于检索互联网上的信息"</span>  
)


<span class="hljs-comment"># 3. 再定义一个自定义的工具</span>
<span class="hljs-comment"># 自定义工具函数  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_calculator</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:  
    <span class="hljs-string">"""  
    基础数学计算工具，支持加减乘除和幂运算  
    :param expression: 数学表达式字符串，比如 “3+5” 或 “2**3”  
    :return: 计算结果字符串或错误信息  
    """</span>  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n[工具调用] 计算表达式：<span class="hljs-subst">{expression}</span>"</span>)  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"mua ~"</span>)  
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(<span class="hljs-built_in">eval</span>(expression))  
  
  
<span class="hljs-comment"># 包装一下，一定要包含 name 和 description</span>
base_cal_tool = Tool(  
    func=simple_calculator,  
    name=<span class="hljs-string">"math_calculator"</span>,  
    description=<span class="hljs-string">"用于基础数学计算，输入必须是纯数学表达式（如“3+5”或“2**3”表示平方），不支持字母或特殊符号"</span>  
)

<span class="hljs-comment"># 4. 获取大语言模型  </span>
llm = ChatOpenAI(model=<span class="hljs-string">"qwen3-max"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>))

<span class="hljs-comment"># 5. 获取 Agent 实例</span>
<span class="hljs-comment"># 可以使用 ReAct 模型  </span>
<span class="hljs-comment"># agent = AgentType.ZERO_SHOT_REACT_DESCRIPTION  </span>
<span class="hljs-comment"># 也可以使用 function call，选择其他的模型，需要看官方文档</span>
agent = AgentType.OPENAI_FUNCTIONS

<span class="hljs-comment"># 6. 获取 AgentExecutor 实例  </span>
agent_executor = initialize_agent(
    <span class="hljs-comment"># 还可以直接去存放工具类，因为都继承的是一个父类，所以可以直接省略掉  </span>
    <span class="hljs-comment"># 区别在于，使用上面的方式，可以自定义 name，description 这些，而使用这种方式则是已经内部写死，不能自定义了  </span>
    <span class="hljs-comment"># name 和 description 是必要的，llm 会根据这些来决定是否调用  </span>
    tools=[search, calc_tool, base_cal_tool],  
    llm=llm,  
    agent=agent,  
    <span class="hljs-comment"># 显示详细的日志信息  </span>
    verbose=<span class="hljs-literal">True</span>  
)

<span class="hljs-comment"># 6. 通过 AgentExecutor 调用 invoke，得到响应  </span>
<span class="hljs-comment"># result = agent_executor.invoke("特斯拉 Model Y 的车价，近几年有没有降低趋势？")  </span>
<span class="hljs-comment"># 也可以使用这种方式去调用  </span>
result = agent_executor.invoke({  
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"特斯拉 Model Y 的车价，近几年有没有降低趋势？"</span>
})  
<span class="hljs-built_in">print</span>(result)
</code></pre>
<h4 data-id="heading-19">4.2.2 通用方式</h4>
<p>使用 AgentExecutor 构造方法，可以自定义提示词模板</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults
<span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub
<span class="hljs-keyword">from</span> langchain_openai.chat_models <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, AgentType, create_react_agent, AgentExecutor, create_tool_calling_agent

<span class="hljs-comment"># 1. 获取工具实例</span>
search = TavilySearchResults(max_results=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 2. 获取大语言模型</span>
llm = ChatOpenAI(model=<span class="hljs-string">"qwen3-max"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>))

<span class="hljs-comment"># 3. 提供提示词模板</span>
<span class="hljs-comment"># 使用 Function Call 模式，推荐使用 ChatPromptTemplate  </span>
<span class="hljs-comment"># prompt_template = ChatPromptTemplate.from_messages([  </span>
<span class="hljs-comment"># SystemMessage("你是一个乐于助人的 AI 助手，根据用户的提问，必要时调用 Search 工具，使用互联网检索数据"),  </span>
<span class="hljs-comment"># # 如果使用 HumanMessage 类，{input} 会被当作纯文本，而非需要替换的变量占位符，不晓得为啥，还是不太熟哇  </span>
<span class="hljs-comment"># # HumanMessage("{input}"),  </span>
<span class="hljs-comment"># ("human", "{input}"),  </span>
<span class="hljs-comment"># # 这个必须声明，用于存储和传递 Agent 的思考过程，  </span>
<span class="hljs-comment"># # 比如在链式调用工具时（如先搜天气再推荐行程），该字段会保留历史步骤，避免上下文丢失，不传入会报错  </span>
<span class="hljs-comment"># # 使用下面这三个方式声明都是可以的  </span>
<span class="hljs-comment"># # MessagesPlaceholder(variable_name="agent_scratchpad"),  </span>
<span class="hljs-comment"># # ("system", "{agent_scratchpad}")  </span>
<span class="hljs-comment"># ("placeholder", "{agent_scratchpad}")  </span>
<span class="hljs-comment"># ])  </span>
<span class="hljs-comment"># 使用 ReAct 模式，推荐直接使用 hub，或者 copy 下来，使用 PromptTemplate，也就是说，直接完整版的 prompt 比切块的效果要好一些  </span>
<span class="hljs-comment"># 使用上面的 prompt 模板，会报错，显示缺少 {'tools', 'tool_names'}，因此可以直接使用现成的 react 模板  </span>
<span class="hljs-comment"># 因为手动配置的话，会比较麻烦，必须得包含 tools tool_names agent_scratchpad，太麻烦了，拼接起来  </span>
prompt_template = hub.pull(<span class="hljs-string">"hwchase17/react"</span>)  
<span class="hljs-built_in">print</span>(prompt_template.input_variables)

<span class="hljs-comment"># 4. 获取 Agent 实例</span>
<span class="hljs-comment"># 使用 Function Call 模式  </span>
<span class="hljs-comment"># agent = create_tool_calling_agent(  </span>
<span class="hljs-comment"># llm=llm,  </span>
<span class="hljs-comment"># prompt=prompt_template,  </span>
<span class="hljs-comment"># tools=[search_tool],  </span>
<span class="hljs-comment"># )  </span>
<span class="hljs-comment"># 使用 ReAct 模式  </span>
agent = create_react_agent(  
    llm=llm,  
    prompt=prompt_template,  
    tools=[search_tool],  
)

<span class="hljs-comment"># 5. 获取 AgentExecutor 实例</span>
agent_executor = AgentExecutor(  
    agent=agent,  
    tools=[search_tool],  
    verbose=<span class="hljs-literal">True</span>  
)  

<span class="hljs-comment"># 6. 通过 AgentExecutor 调用 invoke 得到响应  </span>
result = agent_executor.invoke({  
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"查询杭州下周的天气情况"</span>  
})  
<span class="hljs-built_in">print</span>(result)
</code></pre>
<h4 data-id="heading-20">4.2.3 嵌入记忆</h4>
<p>在构造 Agent 的时候，我们还可以嵌入记忆，作为一个会话去进行对话</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用传统方式，进行嵌入记忆，以 ReAct 模式为例</span>
<span class="hljs-keyword">from</span> langchain_openai.chat_models <span class="hljs-keyword">import</span> ChatOpenAI  
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, AgentType, create_react_agent, AgentExecutor, create_tool_calling_agent  
<span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory

<span class="hljs-comment"># 1. 获取工具实例</span>
search = TavilySearchResults(max_results=<span class="hljs-number">10</span>)  

<span class="hljs-comment"># 2. 获取大语言模型  </span>
llm = ChatOpenAI(model=<span class="hljs-string">"qwen3-max"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>))  
  
<span class="hljs-comment"># 3. 获取一个记忆的实例，使用 ConversationBufferMemory 来存储上下文  </span>
memory = ConversationBufferMemory(  
    <span class="hljs-comment"># 想返回一个消息  </span>
    return_messages=<span class="hljs-literal">True</span>,  
    <span class="hljs-comment"># 用来存放历史记录，key 值要和 prompt 中的要保持一直  </span>
    memory_key=<span class="hljs-string">"chat_history"</span>  
)  
  
<span class="hljs-comment"># 4. 获取 Agent 实例  </span>
<span class="hljs-comment"># 要想存储上下文就不能使用这个了，这里面没有类似 chat_history 的字段去存储上下文  </span>
<span class="hljs-comment"># agent = AgentType.ZERO_SHOT_REACT_DESCRIPTION  </span>
<span class="hljs-comment"># 这个 Agent 实例里面，有 chat_history 字段，专门去存储上下文</span>
agent = AgentType.CONVERSATIONAL_REACT_DESCRIPTION  
  
<span class="hljs-comment"># 5. 获取 AgentExecutor  </span>
agent_executor = initialize_agent(  
    agent=agent,  
    llm=llm,  
    tools=[search],  
    memory=memory,  
    verbose=<span class="hljs-literal">True</span>,  
    <span class="hljs-comment"># Qwen3-Max 模型输出格式与 CONVERSATIONAL_REACT_DESCRIPTION 代理模板不兼容，导致解析器无法识别工具调用指令，一直报错，需要添加这个</span>
    handle_parsing_errors=<span class="hljs-literal">True</span>  
)  

<span class="hljs-comment"># 6. 执行  </span>
<span class="hljs-comment"># 使用二次对话的方式来进行测试  </span>
result = agent_executor.invoke({  
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"杭州明天的天气怎么样？"</span>  
})  
<span class="hljs-built_in">print</span>(result)  
result = agent_executor.invoke({  
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"山西呢？"</span>  
})  
<span class="hljs-built_in">print</span>(result)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用 通用方式去嵌入记忆</span>
<span class="hljs-keyword">from</span> langchain_openai.chat_models <span class="hljs-keyword">import</span> ChatOpenAI  
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, AgentType, create_react_agent, AgentExecutor, create_tool_calling_agent  
<span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory
<span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub

<span class="hljs-comment"># 1. 获取工具实例</span>
search = TavilySearchResults(max_results=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 2. 获取大语言模型  </span>
llm = ChatOpenAI(model=<span class="hljs-string">"qwen3-max"</span>, api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>),  base_url=os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>))  

<span class="hljs-comment"># 3. 提供提示词模板  </span>
<span class="hljs-comment"># 使用 Function Call 模式，推荐使用 ChatPromptTemplate  </span>
<span class="hljs-comment"># prompt_template = ChatPromptTemplate.from_messages([  </span>
    <span class="hljs-comment"># SystemMessage("你是一个乐于助人的 AI 助手，根据用户的提问，必要时调用 Search 工具，使用互联网检索数据"),  </span>
    <span class="hljs-comment"># # 顺序不固定，但是模板中必须包含这几个键值</span>
    <span class="hljs-comment"># ("human", "{input}"),  </span>
    <span class="hljs-comment"># ("placeholder", "{agent_scratchpad}"),  </span>
    <span class="hljs-comment"># # 存储上下文的记忆  </span>
    <span class="hljs-comment"># ("system", "{history}")  </span>
<span class="hljs-comment"># ])  </span>
<span class="hljs-comment"># 使用 ReAct 模式，推荐直接使用 hub，或者 copy 下来，使用 PromptTemplate  </span>
prompt_template = hub.pull(<span class="hljs-string">"hwchase17/react-chat"</span>)  
<span class="hljs-built_in">print</span>(prompt_template.input_variables)  

<span class="hljs-comment"># 4. 提供记忆的实例</span>
memory = ConversationBufferMemory(  
    return_messages=<span class="hljs-literal">True</span>,  
    <span class="hljs-comment"># 该值要与 prompt 中的同名  </span>
    <span class="hljs-comment"># Function Call 模式  </span>
    <span class="hljs-comment"># memory_key="history"  </span>
    <span class="hljs-comment"># ReAct 模式，因为 prompt 中的变量名为 chat_history，所以要进行替换 </span>
    memory_key=<span class="hljs-string">"chat_history"</span>  
)

<span class="hljs-comment"># 5. 获取 Agent 实例  </span>
<span class="hljs-comment"># 使用 Function Call 模式  </span>
<span class="hljs-comment"># agent = create_tool_calling_agent(  </span>
<span class="hljs-comment"># llm=llm,  </span>
<span class="hljs-comment"># prompt=prompt_template,  </span>
<span class="hljs-comment"># tools=[search],  </span>
<span class="hljs-comment"># )  </span>
<span class="hljs-comment"># 使用 ReAct 模式  </span>
agent = create_react_agent(  
    llm=llm,  
    prompt=prompt_template,  
    tools=[search],  
)  

<span class="hljs-comment"># 6. 获取 AgentExecutor 实例  </span>
agent_executor = AgentExecutor(  
    agent=agent,  
    tools=[search],  
    verbose=<span class="hljs-literal">True</span>,  
    memory=memory  
)

<span class="hljs-comment"># 7. 通过 AgentExecutor 调用 invoke 得到响应  </span>
<span class="hljs-comment"># 使用二次对话的方式来进行测试  </span>
result = agent_executor.invoke({  
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"杭州明天的天气怎么样？"</span>  
})  
<span class="hljs-built_in">print</span>(result)  
result = agent_executor.invoke({  
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"山西呢？"</span>  
})  
<span class="hljs-built_in">print</span>(result)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java Scanner完全指南：让程序与用户对话]]></title>    <link>https://juejin.cn/post/7585758163435061254</link>    <guid>https://juejin.cn/post/7585758163435061254</guid>    <pubDate>2025-12-21T06:50:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585758163435061254" data-draft-id="7585485074038947846" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java Scanner完全指南：让程序与用户对话"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-21T06:50:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java Scanner完全指南：让程序与用户对话
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T06:50:58.000Z" title="Sun Dec 21 2025 06:50:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在Java编程中，Scanner就像程序的"耳朵"，让程序能够听到用户的声音，实现真正的交互式程序。今天，我们学习这个让Java程序"活"起来的关键工具。</p>
<h2 data-id="heading-0">一、Scanner基础：创建与使用</h2>
<h3 data-id="heading-1">1.1 导入和创建Scanner</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Scanner;  <span class="hljs-comment">// 第一步：导入</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScannerBasic</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 第二步：创建Scanner对象</span>
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        
        <span class="hljs-comment">// 第三步：使用Scanner</span>
        System.out.print(<span class="hljs-string">"请输入你的名字："</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> scanner.nextLine();
        System.out.println(<span class="hljs-string">"你好，"</span> + name + <span class="hljs-string">"！"</span>);
        
        <span class="hljs-comment">// 第四步：关闭Scanner（重要！）</span>
        scanner.close();
    }
}
</code></pre>
<h3 data-id="heading-2">1.2 读取不同类型的数据</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadDifferentTypes</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        
        <span class="hljs-comment">// 读取整数</span>
        System.out.print(<span class="hljs-string">"请输入年龄："</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> scanner.nextInt();
        
        <span class="hljs-comment">// 读取小数</span>
        System.out.print(<span class="hljs-string">"请输入身高（米）："</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">height</span> <span class="hljs-operator">=</span> scanner.nextDouble();
        
        <span class="hljs-comment">// 读取字符串</span>
        scanner.nextLine();  <span class="hljs-comment">// 重要：先清空缓冲区</span>
        System.out.print(<span class="hljs-string">"请输入城市："</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        System.out.println(<span class="hljs-string">"年龄："</span> + age);
        System.out.println(<span class="hljs-string">"身高："</span> + height);
        System.out.println(<span class="hljs-string">"城市："</span> + city);
        
        scanner.close();
    }
}
</code></pre>
<h2 data-id="heading-3">二、最重要的两个方法：next() vs nextLine()</h2>
<h3 data-id="heading-4">2.1 关键区别示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NextVsNextLine</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        
        <span class="hljs-comment">// ❌ 错误示例</span>
        System.out.print(<span class="hljs-string">"请输入年龄："</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> scanner.nextInt();
        
        System.out.print(<span class="hljs-string">"请输入姓名："</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> scanner.nextLine();  <span class="hljs-comment">// 这里会出问题！</span>
        System.out.println(<span class="hljs-string">"你好，"</span> + name);
        
        <span class="hljs-comment">// ✅ 正确做法</span>
        System.out.print(<span class="hljs-string">"\n请重新输入年龄："</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">age2</span> <span class="hljs-operator">=</span> scanner.nextInt();
        scanner.nextLine();  <span class="hljs-comment">// 关键：清空缓冲区</span>
        
        System.out.print(<span class="hljs-string">"请重新输入姓名："</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">name2</span> <span class="hljs-operator">=</span> scanner.nextLine();
        System.out.println(<span class="hljs-string">"这次对了，你好，"</span> + name2);
        
        scanner.close();
    }
}
</code></pre>
<h3 data-id="heading-5">2.2 记忆技巧</h3>
<ul>
<li><strong>next()</strong> ：读取一个"单词"（遇到空格就停止）</li>
<li><strong>nextLine()</strong> ：读取整行（包括空格）</li>
<li><strong>重要</strong>：使用nextInt()、nextDouble()等后，要用<code>scanner.nextLine()</code>清空缓冲区</li>
</ul>
<h2 data-id="heading-6">三、实战应用：学生成绩计算器</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentGradeCalculator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        
        System.out.println(<span class="hljs-string">"=== 学生成绩计算器 ===\n"</span>);
        
        <span class="hljs-comment">// 输入学生信息</span>
        System.out.print(<span class="hljs-string">"请输入学生姓名："</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> scanner.nextLine();
        
        System.out.print(<span class="hljs-string">"请输入语文成绩："</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">chinese</span> <span class="hljs-operator">=</span> scanner.nextInt();
        
        System.out.print(<span class="hljs-string">"请输入数学成绩："</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">math</span> <span class="hljs-operator">=</span> scanner.nextInt();
        
        System.out.print(<span class="hljs-string">"请输入英语成绩："</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">english</span> <span class="hljs-operator">=</span> scanner.nextInt();
        
        scanner.nextLine();  <span class="hljs-comment">// 清空缓冲区</span>
        
        <span class="hljs-comment">// 计算</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> chinese + math + english;
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> total / <span class="hljs-number">3.0</span>;
        
        <span class="hljs-comment">// 输出结果</span>
        System.out.println(<span class="hljs-string">"\n=== 成绩报告 ==="</span>);
        System.out.println(<span class="hljs-string">"姓名："</span> + name);
        System.out.println(<span class="hljs-string">"总分："</span> + total);
        System.out.printf(<span class="hljs-string">"平均分：%.2f\n"</span>, average);
        
        <span class="hljs-comment">// 判断等级</span>
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) {
            System.out.println(<span class="hljs-string">"等级：优秀"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) {
            System.out.println(<span class="hljs-string">"等级：良好"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) {
            System.out.println(<span class="hljs-string">"等级：及格"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"等级：不及格"</span>);
        }
        
        scanner.close();
    }
}
</code></pre>
<h2 data-id="heading-7">四、错误处理和输入验证</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InputValidation</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
        
        <span class="hljs-comment">// 验证年龄输入（必须是1-100之间的整数）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">valid</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        
        <span class="hljs-keyword">while</span> (!valid) {
            System.out.print(<span class="hljs-string">"请输入年龄（1-100）："</span>);
            
            <span class="hljs-keyword">if</span> (scanner.hasNextInt()) {
                age = scanner.nextInt();
                <span class="hljs-keyword">if</span> (age &gt;= <span class="hljs-number">1</span> &amp;&amp; age &lt;= <span class="hljs-number">100</span>) {
                    valid = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"错误：年龄必须在1-100之间！"</span>);
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"错误：请输入整数！"</span>);
                scanner.next();  <span class="hljs-comment">// 清除错误的输入</span>
            }
        }
        
        scanner.nextLine();  <span class="hljs-comment">// 清空缓冲区</span>
        System.out.println(<span class="hljs-string">"年龄验证通过："</span> + age);
        
        scanner.close();
    }
}
</code></pre>
<h2 data-id="heading-8">五、最重要知识点总结</h2>
<h3 data-id="heading-9">1. 核心三步骤</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 导入</span>
<span class="hljs-keyword">import</span> java.util.Scanner;

<span class="hljs-comment">// 2. 创建</span>
<span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);

<span class="hljs-comment">// 3. 使用</span>
<span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> scanner.nextLine();

<span class="hljs-comment">// 4. 关闭（不要忘！）</span>
scanner.close();
</code></pre>
<h3 data-id="heading-10">2. 黄金法则</h3>
<ul>
<li><strong>混合使用nextXXX()和nextLine()时</strong>：先用<code>scanner.nextLine()</code>清空缓冲区</li>
<li><strong>输入验证</strong>：用<code>hasNextInt()</code>、<code>hasNextDouble()</code>检查输入类型</li>
<li><strong>关闭Scanner</strong>：用完一定要关闭，释放资源</li>
</ul>
<h3 data-id="heading-11">3. 一句话记住</h3>
<p><strong>Scanner是Java程序的"麦克风"——nextXXX()接收用户输入，nextLine()清空缓冲区，记得用完要关闭！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java面向对象编程：封装、继承与多态深度解析]]></title>    <link>https://juejin.cn/post/7585758163435094022</link>    <guid>https://juejin.cn/post/7585758163435094022</guid>    <pubDate>2025-12-21T07:01:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585758163435094022" data-draft-id="7585485074039013382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java面向对象编程：封装、继承与多态深度解析"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-21T07:01:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java面向对象编程：封装、继承与多态深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T07:01:40.000Z" title="Sun Dec 21 2025 07:01:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>面向对象编程（OOP）是Java的核心思想，它让代码更加模块化、可重用和易维护。今天，我们将深入探讨OOP的三大支柱：封装、继承和多态，这是每个Java程序员必须掌握的核心概念。</p>
<h2 data-id="heading-0">引入：为什么需要面向对象编程？</h2>
<p>想象一下，你正在开发一个游戏系统：</p>
<ul>
<li>游戏中有玩家（Player）、敌人（Enemy）、道具（Item）等多种角色</li>
<li>这些角色都有共同的特征（如位置、血量），但也有各自的特殊能力</li>
<li>如果不使用OOP，代码会变得混乱不堪，难以维护</li>
</ul>
<p>使用面向对象编程，我们可以将现实世界的实体抽象为"对象"，每个对象都有自己的数据和行为，就像乐高积木一样，可以灵活组合。</p>
<h2 data-id="heading-1">一、封装：保护数据的"保险箱"</h2>
<h3 data-id="heading-2">1.1 什么是封装？</h3>
<p><strong>封装</strong>就是将数据和对数据的操作包装在一起，并隐藏实现细节。就像银行的ATM机：</p>
<ul>
<li>你只能通过界面按钮（公共方法）操作</li>
<li>不能直接接触内部的现金（私有数据）</li>
<li>ATM内部的运作机制对你隐藏（实现细节）</li>
</ul>
<h3 data-id="heading-3">1.2 封装的实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncapsulationDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建银行账户</span>
        <span class="hljs-type">BankAccount</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BankAccount</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"123456"</span>);
        
        <span class="hljs-comment">// ✅ 正确的访问方式：通过公共方法</span>
        account.deposit(<span class="hljs-number">1000</span>);      <span class="hljs-comment">// 存款</span>
        account.withdraw(<span class="hljs-number">500</span>);      <span class="hljs-comment">// 取款</span>
        account.displayBalance();   <span class="hljs-comment">// 查看余额</span>
        
        <span class="hljs-comment">// ❌ 错误的方式：直接访问私有数据</span>
        <span class="hljs-comment">// account.balance = 1000000;  // 编译错误！无法直接访问</span>
        <span class="hljs-comment">// account.password = "hack";  // 编译错误！无法直接访问</span>
        
        System.out.println(<span class="hljs-string">"\n尝试非法操作："</span>);
        account.withdraw(<span class="hljs-number">10000</span>);    <span class="hljs-comment">// 余额不足，安全被拒绝</span>
        
        System.out.println(<span class="hljs-string">"\n尝试破解密码："</span>);
        <span class="hljs-comment">// 无法直接修改密码，只能通过验证流程</span>
        account.changePassword(<span class="hljs-string">"wrong"</span>, <span class="hljs-string">"new123"</span>);  <span class="hljs-comment">// 失败</span>
        account.changePassword(<span class="hljs-string">"123456"</span>, <span class="hljs-string">"new123"</span>); <span class="hljs-comment">// 成功</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
    <span class="hljs-comment">// 私有属性：外部不能直接访问（封装的精髓）</span>
    <span class="hljs-keyword">private</span> String accountHolder;  <span class="hljs-comment">// 账户持有人</span>
    <span class="hljs-keyword">private</span> String password;       <span class="hljs-comment">// 密码</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> balance;        <span class="hljs-comment">// 余额</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String accountNumber; <span class="hljs-comment">// 账号（final表示不可变）</span>
    
    <span class="hljs-comment">// 构造方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BankAccount</span><span class="hljs-params">(String holder, String pwd)</span> {
        <span class="hljs-built_in">this</span>.accountHolder = holder;
        <span class="hljs-built_in">this</span>.password = pwd;
        <span class="hljs-built_in">this</span>.balance = <span class="hljs-number">0.0</span>;
        <span class="hljs-built_in">this</span>.accountNumber = generateAccountNumber();
    }
    
    <span class="hljs-comment">// 公共方法：存款</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deposit</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
        <span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">0</span>) {
            balance += amount;
            System.out.println(<span class="hljs-string">"成功存款："</span> + amount + <span class="hljs-string">"元"</span>);
            logTransaction(<span class="hljs-string">"存款"</span>, amount);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"存款金额必须大于0"</span>);
        }
    }
    
    <span class="hljs-comment">// 公共方法：取款</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withdraw</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) {
            System.out.println(<span class="hljs-string">"取款金额必须大于0"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (amount &gt; balance) {
            System.out.println(<span class="hljs-string">"余额不足！当前余额："</span> + balance);
        } <span class="hljs-keyword">else</span> {
            balance -= amount;
            System.out.println(<span class="hljs-string">"成功取款："</span> + amount + <span class="hljs-string">"元"</span>);
            logTransaction(<span class="hljs-string">"取款"</span>, amount);
        }
    }
    
    <span class="hljs-comment">// 公共方法：显示余额</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayBalance</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"账户："</span> + accountNumber);
        System.out.println(<span class="hljs-string">"持有人："</span> + accountHolder);
        System.out.println(<span class="hljs-string">"当前余额："</span> + balance + <span class="hljs-string">"元"</span>);
    }
    
    <span class="hljs-comment">// 公共方法：修改密码（需要验证原密码）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">changePassword</span><span class="hljs-params">(String oldPwd, String newPwd)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.password.equals(oldPwd)) {
            <span class="hljs-built_in">this</span>.password = newPwd;
            System.out.println(<span class="hljs-string">"密码修改成功"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"原密码错误，修改失败"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">// 私有方法：只能在类内部使用（封装的实现细节）</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateAccountNumber</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟生成账号：时间戳 + 随机数</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ACC"</span> + System.currentTimeMillis() % <span class="hljs-number">10000</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logTransaction</span><span class="hljs-params">(String type, <span class="hljs-type">double</span> amount)</span> {
        <span class="hljs-comment">// 记录交易日志</span>
        System.out.println(<span class="hljs-string">"[日志] "</span> + type + <span class="hljs-string">" "</span> + amount + <span class="hljs-string">"元"</span>);
    }
    
    <span class="hljs-comment">// Getter方法：提供对私有属性的受控访问</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAccountHolder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> accountHolder;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getBalance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> balance;
    }
    
    <span class="hljs-comment">// 没有提供password的getter，保护密码安全</span>
    
    <span class="hljs-comment">// Setter方法：提供对私有属性的受控修改</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAccountHolder</span><span class="hljs-params">(String holder)</span> {
        <span class="hljs-keyword">if</span> (holder != <span class="hljs-literal">null</span> &amp;&amp; !holder.trim().isEmpty()) {
            <span class="hljs-built_in">this</span>.accountHolder = holder;
        }
    }
}
</code></pre>
<h3 data-id="heading-4">1.3 封装的好处</h3>
<ol>
<li><strong>数据安全</strong>：防止外部代码随意修改对象状态</li>
<li><strong>易于维护</strong>：内部实现可以改变而不影响外部代码</li>
<li><strong>代码清晰</strong>：明确区分"可以做什么"和"如何实现"</li>
<li><strong>减少耦合</strong>：类之间的关系更清晰，更易于修改</li>
</ol>
<h2 data-id="heading-5">二、继承：代码复用的"基因传递"</h2>
<h3 data-id="heading-6">2.1 什么是继承？</h3>
<p><strong>继承</strong>允许一个类（子类）继承另一个类（父类）的属性和方法。就像生物学中的遗传：</p>
<ul>
<li>孩子继承父母的特征</li>
<li>但孩子也可以有自己独特的特征</li>
<li>继承建立了类之间的层次关系</li>
</ul>
<h3 data-id="heading-7">2.2 继承的实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritanceDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 继承示例：车辆系统 ===\n"</span>);
        
        <span class="hljs-comment">// 创建不同类型的车辆</span>
        <span class="hljs-type">Vehicle</span> <span class="hljs-variable">genericVehicle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vehicle</span>(<span class="hljs-string">"通用车辆"</span>, <span class="hljs-number">2020</span>);
        <span class="hljs-type">Car</span> <span class="hljs-variable">myCar</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">"丰田卡罗拉"</span>, <span class="hljs-number">2022</span>, <span class="hljs-number">4</span>);
        <span class="hljs-type">Motorcycle</span> <span class="hljs-variable">myBike</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Motorcycle</span>(<span class="hljs-string">"本田CBR"</span>, <span class="hljs-number">2023</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-type">ElectricCar</span> <span class="hljs-variable">tesla</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ElectricCar</span>(<span class="hljs-string">"特斯拉Model 3"</span>, <span class="hljs-number">2023</span>, <span class="hljs-number">4</span>, <span class="hljs-number">75</span>);
        
        <span class="hljs-comment">// 展示多态性：父类引用指向子类对象</span>
        Vehicle[] vehicles = {genericVehicle, myCar, myBike, tesla};
        
        <span class="hljs-keyword">for</span> (Vehicle vehicle : vehicles) {
            vehicle.displayInfo();
            vehicle.start();  <span class="hljs-comment">// 多态：同一个方法，不同行为</span>
            System.out.println();
        }
        
        <span class="hljs-comment">// 访问子类特有的方法</span>
        System.out.println(<span class="hljs-string">"=== 子类特有方法 ==="</span>);
        myCar.openSunroof();
        myBike.doWheelie();
        tesla.chargeBattery();
    }
}

<span class="hljs-comment">// 父类：车辆</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Vehicle</span> {
    <span class="hljs-comment">// 受保护属性：子类可以访问，外部不能</span>
    <span class="hljs-keyword">protected</span> String brand;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> year;
    
    <span class="hljs-comment">// 构造方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Vehicle</span><span class="hljs-params">(String brand, <span class="hljs-type">int</span> year)</span> {
        <span class="hljs-built_in">this</span>.brand = brand;
        <span class="hljs-built_in">this</span>.year = year;
    }
    
    <span class="hljs-comment">// 公共方法：启动车辆</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        System.out.println(brand + <span class="hljs-string">" 正在启动..."</span>);
    }
    
    <span class="hljs-comment">// 公共方法：停止车辆</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
        System.out.println(brand + <span class="hljs-string">" 已停止"</span>);
    }
    
    <span class="hljs-comment">// 公共方法：显示信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"品牌："</span> + brand);
        System.out.println(<span class="hljs-string">"年份："</span> + year);
    }
    
    <span class="hljs-comment">// 计算年龄</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateAge</span><span class="hljs-params">(<span class="hljs-type">int</span> currentYear)</span> {
        <span class="hljs-keyword">return</span> currentYear - year;
    }
}

<span class="hljs-comment">// 子类：汽车（继承Vehicle）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Vehicle</span> {
    <span class="hljs-comment">// 子类特有的属性</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> doorCount;
    
    <span class="hljs-comment">// 子类构造方法：使用super调用父类构造方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Car</span><span class="hljs-params">(String brand, <span class="hljs-type">int</span> year, <span class="hljs-type">int</span> doorCount)</span> {
        <span class="hljs-built_in">super</span>(brand, year);  <span class="hljs-comment">// 必须首先调用父类构造方法</span>
        <span class="hljs-built_in">this</span>.doorCount = doorCount;
    }
    
    <span class="hljs-comment">// 重写父类方法（方法覆盖）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        System.out.println(brand + <span class="hljs-string">" 汽车启动：钥匙转动，引擎轰鸣！"</span>);
    }
    
    <span class="hljs-comment">// 子类特有的方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">openSunroof</span><span class="hljs-params">()</span> {
        System.out.println(brand + <span class="hljs-string">" 的天窗已打开"</span>);
    }
    
    <span class="hljs-comment">// 重写显示信息方法，添加子类特有信息</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.displayInfo();  <span class="hljs-comment">// 调用父类方法</span>
        System.out.println(<span class="hljs-string">"类型：汽车"</span>);
        System.out.println(<span class="hljs-string">"车门数量："</span> + doorCount);
    }
}

<span class="hljs-comment">// 子类：摩托车（继承Vehicle）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Motorcycle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Vehicle</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> hasSidecar;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Motorcycle</span><span class="hljs-params">(String brand, <span class="hljs-type">int</span> year, <span class="hljs-type">boolean</span> hasSidecar)</span> {
        <span class="hljs-built_in">super</span>(brand, year);
        <span class="hljs-built_in">this</span>.hasSidecar = hasSidecar;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        System.out.println(brand + <span class="hljs-string">" 摩托车启动：踩下启动杆，引擎咆哮！"</span>);
    }
    
    <span class="hljs-comment">// 摩托车特有方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doWheelie</span><span class="hljs-params">()</span> {
        System.out.println(brand + <span class="hljs-string">" 正在抬头特技！"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.displayInfo();
        System.out.println(<span class="hljs-string">"类型：摩托车"</span>);
        System.out.println(<span class="hljs-string">"是否有边车："</span> + (hasSidecar ? <span class="hljs-string">"是"</span> : <span class="hljs-string">"否"</span>));
    }
}

<span class="hljs-comment">// 子类的子类：电动汽车（继承Car）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ElectricCar</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Car</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> batteryCapacity;  <span class="hljs-comment">// 电池容量（千瓦时）</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ElectricCar</span><span class="hljs-params">(String brand, <span class="hljs-type">int</span> year, <span class="hljs-type">int</span> doorCount, <span class="hljs-type">double</span> batteryCapacity)</span> {
        <span class="hljs-built_in">super</span>(brand, year, doorCount);
        <span class="hljs-built_in">this</span>.batteryCapacity = batteryCapacity;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        System.out.println(brand + <span class="hljs-string">" 电动汽车启动：无声启动，零排放！"</span>);
    }
    
    <span class="hljs-comment">// 电动汽车特有方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">chargeBattery</span><span class="hljs-params">()</span> {
        System.out.println(brand + <span class="hljs-string">" 正在充电，电池容量："</span> + batteryCapacity + <span class="hljs-string">"kWh"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.displayInfo();  <span class="hljs-comment">// 调用Car的displayInfo</span>
        System.out.println(<span class="hljs-string">"动力类型：电动"</span>);
        System.out.println(<span class="hljs-string">"电池容量："</span> + batteryCapacity + <span class="hljs-string">"kWh"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">2.3 继承的关键点</h3>
<ol>
<li>
<p><strong>super关键字</strong>：用于访问父类的属性、方法和构造方法</p>
</li>
<li>
<p><strong>方法重写（Override）</strong> ：子类重新实现父类的方法</p>
</li>
<li>
<p><strong>访问修饰符</strong>：</p>
<ul>
<li><strong>private</strong>：只有本类能访问</li>
<li><strong>protected</strong>：本类、子类和同包类能访问</li>
<li><strong>public</strong>：所有类都能访问</li>
</ul>
</li>
<li>
<p><strong>final关键字</strong>：</p>
<ul>
<li><strong>final类</strong>：不能被继承</li>
<li><strong>final方法</strong>：不能被子类重写</li>
<li><strong>final变量</strong>：常量，不能被修改</li>
</ul>
</li>
</ol>
<h2 data-id="heading-9">三、多态：灵活多变的"变形金刚"</h2>
<h3 data-id="heading-10">3.1 什么是多态？</h3>
<p><strong>多态</strong>（Polymorphism）意为"多种形态"。在Java中，多态允许我们使用父类引用指向子类对象，同一个方法调用会根据实际对象类型产生不同的行为。</p>
<h3 data-id="heading-11">3.2 多态的实现示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PolymorphismDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 多态示例：几何图形计算 ===\n"</span>);
        
        <span class="hljs-comment">// 使用父类引用指向不同的子类对象</span>
        Shape[] shapes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shape</span>[<span class="hljs-number">4</span>];
        
        shapes[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-number">5.0</span>);
        shapes[<span class="hljs-number">1</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>(<span class="hljs-number">4.0</span>, <span class="hljs-number">6.0</span>);
        shapes[<span class="hljs-number">2</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Triangle</span>(<span class="hljs-number">3.0</span>, <span class="hljs-number">4.0</span>, <span class="hljs-number">5.0</span>);
        shapes[<span class="hljs-number">3</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-number">7.0</span>);
        
        <span class="hljs-comment">// 多态的魅力：同一个方法调用，不同的行为</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">totalArea</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">double</span> <span class="hljs-variable">totalPerimeter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (Shape shape : shapes) {
            System.out.println(shape.getShapeName() + <span class="hljs-string">":"</span>);
            System.out.printf(<span class="hljs-string">"  面积: %.2f\n"</span>, shape.calculateArea());
            System.out.printf(<span class="hljs-string">"  周长: %.2f\n"</span>, shape.calculatePerimeter());
            
            totalArea += shape.calculateArea();
            totalPerimeter += shape.calculatePerimeter();
            
            <span class="hljs-comment">// 检查具体类型并进行特殊处理</span>
            <span class="hljs-keyword">if</span> (shape <span class="hljs-keyword">instanceof</span> Circle) {
                <span class="hljs-type">Circle</span> <span class="hljs-variable">circle</span> <span class="hljs-operator">=</span> (Circle) shape;  <span class="hljs-comment">// 向下转型</span>
                System.out.printf(<span class="hljs-string">"  半径: %.2f\n"</span>, circle.getRadius());
            }
            
            System.out.println();
        }
        
        System.out.printf(<span class="hljs-string">"总面积: %.2f\n"</span>, totalArea);
        System.out.printf(<span class="hljs-string">"总周长: %.2f\n"</span>, totalPerimeter);
        
        <span class="hljs-comment">// 多态在方法参数中的应用</span>
        System.out.println(<span class="hljs-string">"\n=== 多态在方法参数中的应用 ==="</span>);
        displayShapeInfo(shapes[<span class="hljs-number">0</span>]);
        displayShapeInfo(shapes[<span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-comment">// 方法接收父类类型参数，可以接受任何子类对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayShapeInfo</span><span class="hljs-params">(Shape shape)</span> {
        System.out.println(<span class="hljs-string">"形状信息："</span>);
        shape.displayInfo();
        System.out.println();
    }
}

<span class="hljs-comment">// 抽象类：形状（不能实例化）</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">protected</span> String color;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Shape</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.color = <span class="hljs-string">"黑色"</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Shape</span><span class="hljs-params">(String color)</span> {
        <span class="hljs-built_in">this</span>.color = color;
    }
    
    <span class="hljs-comment">// 抽象方法：子类必须实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculatePerimeter</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getShapeName</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// 具体方法：子类可以继承或重写</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"形状: "</span> + getShapeName());
        System.out.println(<span class="hljs-string">"颜色: "</span> + color);
        System.out.printf(<span class="hljs-string">"面积: %.2f\n"</span>, calculateArea());
        System.out.printf(<span class="hljs-string">"周长: %.2f\n"</span>, calculatePerimeter());
    }
    
    <span class="hljs-comment">// Getter和Setter</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getColor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> color;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setColor</span><span class="hljs-params">(String color)</span> {
        <span class="hljs-built_in">this</span>.color = color;
    }
}

<span class="hljs-comment">// 具体类：圆形</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> radius;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Circle</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
        <span class="hljs-built_in">super</span>();
        <span class="hljs-built_in">this</span>.radius = radius;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Circle</span><span class="hljs-params">(<span class="hljs-type">double</span> radius, String color)</span> {
        <span class="hljs-built_in">super</span>(color);
        <span class="hljs-built_in">this</span>.radius = radius;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Math.PI * radius * radius;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculatePerimeter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * Math.PI * radius;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getShapeName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"圆形"</span>;
    }
    
    <span class="hljs-comment">// Circle特有的方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getRadius</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> radius;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRadius</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
        <span class="hljs-keyword">if</span> (radius &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">this</span>.radius = radius;
        }
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.displayInfo();
        System.out.printf(<span class="hljs-string">"半径: %.2f\n"</span>, radius);
        System.out.printf(<span class="hljs-string">"直径: %.2f\n"</span>, <span class="hljs-number">2</span> * radius);
    }
}

<span class="hljs-comment">// 具体类：矩形</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> width;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> height;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Rectangle</span><span class="hljs-params">(<span class="hljs-type">double</span> width, <span class="hljs-type">double</span> height)</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"蓝色"</span>);
        <span class="hljs-built_in">this</span>.width = width;
        <span class="hljs-built_in">this</span>.height = height;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> width * height;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculatePerimeter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * (width + height);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getShapeName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"矩形"</span>;
    }
    
    <span class="hljs-comment">// Rectangle特有的方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getWidth</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> width;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getHeight</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> height;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.displayInfo();
        System.out.printf(<span class="hljs-string">"宽度: %.2f\n"</span>, width);
        System.out.printf(<span class="hljs-string">"高度: %.2f\n"</span>, height);
    }
}

<span class="hljs-comment">// 具体类：三角形</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Triangle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> sideA;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> sideB;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> sideC;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Triangle</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b, <span class="hljs-type">double</span> c)</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"绿色"</span>);
        <span class="hljs-built_in">this</span>.sideA = a;
        <span class="hljs-built_in">this</span>.sideB = b;
        <span class="hljs-built_in">this</span>.sideC = c;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用海伦公式计算三角形面积</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> (sideA + sideB + sideC) / <span class="hljs-number">2</span>;
        <span class="hljs-keyword">return</span> Math.sqrt(s * (s - sideA) * (s - sideB) * (s - sideC));
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculatePerimeter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sideA + sideB + sideC;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getShapeName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"三角形"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.displayInfo();
        System.out.printf(<span class="hljs-string">"边长: %.2f, %.2f, %.2f\n"</span>, sideA, sideB, sideC);
    }
}
</code></pre>
<h3 data-id="heading-12">3.3 多态的两种形式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PolymorphismForms</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 多态的两种形式 ===\n"</span>);
        
        <span class="hljs-comment">// 形式1：编译时多态（方法重载）</span>
        <span class="hljs-type">Calculator</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>();
        System.out.println(<span class="hljs-string">"加法重载示例："</span>);
        System.out.println(<span class="hljs-string">"两个整数相加: "</span> + calc.add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"三个整数相加: "</span> + calc.add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>));
        System.out.println(<span class="hljs-string">"两个小数相加: "</span> + calc.add(<span class="hljs-number">5.5</span>, <span class="hljs-number">3.3</span>));
        System.out.println(<span class="hljs-string">"整数和小数相加: "</span> + calc.add(<span class="hljs-number">5</span>, <span class="hljs-number">3.3</span>));
        
        <span class="hljs-comment">// 形式2：运行时多态（方法重写）</span>
        System.out.println(<span class="hljs-string">"\n动物叫声示例："</span>);
        Animal myAnimal;
        
        <span class="hljs-comment">// 运行时决定调用哪个方法</span>
        myAnimal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();
        myAnimal.makeSound();  <span class="hljs-comment">// 输出：汪汪汪！</span>
        
        myAnimal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();
        myAnimal.makeSound();  <span class="hljs-comment">// 输出：喵喵喵！</span>
        
        myAnimal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bird</span>();
        myAnimal.makeSound();  <span class="hljs-comment">// 输出：叽叽喳喳！</span>
        
        <span class="hljs-comment">// 实际应用：工厂模式</span>
        System.out.println(<span class="hljs-string">"\n=== 工厂模式示例 ==="</span>);
        <span class="hljs-type">AnimalFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimalFactory</span>();
        
        <span class="hljs-type">Animal</span> <span class="hljs-variable">animal1</span> <span class="hljs-operator">=</span> factory.createAnimal(<span class="hljs-string">"dog"</span>);
        animal1.makeSound();
        
        <span class="hljs-type">Animal</span> <span class="hljs-variable">animal2</span> <span class="hljs-operator">=</span> factory.createAnimal(<span class="hljs-string">"cat"</span>);
        animal2.makeSound();
        
        <span class="hljs-type">Animal</span> <span class="hljs-variable">animal3</span> <span class="hljs-operator">=</span> factory.createAnimal(<span class="hljs-string">"bird"</span>);
        animal3.makeSound();
    }
}

<span class="hljs-comment">// 编译时多态：方法重载</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-comment">// 同一个方法名，不同的参数列表</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> c)</span> {
        <span class="hljs-keyword">return</span> a + b + c;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">double</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
}

<span class="hljs-comment">// 运行时多态：方法重写</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSound</span><span class="hljs-params">()</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"动物正在睡觉..."</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSound</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"汪汪汪！"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fetch</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"狗狗叼回了飞盘"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSound</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"喵喵喵！"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scratch</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"猫在抓沙发"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bird</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSound</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"叽叽喳喳！"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fly</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"鸟在飞翔"</span>);
    }
}

<span class="hljs-comment">// 工厂模式：使用多态创建对象</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimalFactory</span> {
    <span class="hljs-keyword">public</span> Animal <span class="hljs-title function_">createAnimal</span><span class="hljs-params">(String type)</span> {
        <span class="hljs-keyword">switch</span> (type.toLowerCase()) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"dog"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();
            <span class="hljs-keyword">case</span> <span class="hljs-string">"cat"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();
            <span class="hljs-keyword">case</span> <span class="hljs-string">"bird"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bird</span>();
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未知的动物类型: "</span> + type);
        }
    }
}
</code></pre>
<h3 data-id="heading-13">3.4 多态的优势</h3>
<ol>
<li><strong>代码灵活性</strong>：可以编写更通用的代码</li>
<li><strong>易于扩展</strong>：添加新的子类时，无需修改现有代码</li>
<li><strong>接口统一</strong>：不同对象可以通过统一接口操作</li>
<li><strong>解耦合</strong>：降低模块间的依赖关系</li>
</ol>
<h2 data-id="heading-14">四、三大特性综合实战：员工管理系统</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeManagementSystem</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 员工管理系统 ===\n"</span>);
        
        <span class="hljs-comment">// 创建公司</span>
        <span class="hljs-type">Company</span> <span class="hljs-variable">company</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Company</span>(<span class="hljs-string">"科技无限公司"</span>);
        
        <span class="hljs-comment">// 创建不同类型的员工</span>
        <span class="hljs-type">Employee</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Manager</span>(<span class="hljs-string">"张经理"</span>, <span class="hljs-number">50000</span>, <span class="hljs-number">20000</span>, <span class="hljs-number">10</span>);
        <span class="hljs-type">Employee</span> <span class="hljs-variable">developer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Developer</span>(<span class="hljs-string">"王程序员"</span>, <span class="hljs-number">30000</span>, <span class="hljs-string">"Java"</span>, <span class="hljs-number">5</span>);
        <span class="hljs-type">Employee</span> <span class="hljs-variable">sales</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Salesperson</span>(<span class="hljs-string">"李销售"</span>, <span class="hljs-number">25000</span>, <span class="hljs-number">1000000</span>);
        
        <span class="hljs-comment">// 添加员工到公司</span>
        company.hireEmployee(manager);
        company.hireEmployee(developer);
        company.hireEmployee(sales);
        
        <span class="hljs-comment">// 临时工</span>
        company.hireEmployee(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intern</span>(<span class="hljs-string">"赵实习生"</span>, <span class="hljs-number">5000</span>, <span class="hljs-number">6</span>));
        
        <span class="hljs-comment">// 展示所有员工信息</span>
        company.displayAllEmployees();
        
        <span class="hljs-comment">// 计算总工资支出</span>
        System.out.println(<span class="hljs-string">"\n=== 月度工资报告 ==="</span>);
        company.calculateMonthlyPayroll();
        
        <span class="hljs-comment">// 员工工作</span>
        System.out.println(<span class="hljs-string">"\n=== 员工工作 ==="</span>);
        company.makeEmployeesWork();
        
        <span class="hljs-comment">// 晋升员工</span>
        System.out.println(<span class="hljs-string">"\n=== 员工晋升 ==="</span>);
        company.promoteEmployee(<span class="hljs-string">"王程序员"</span>, <span class="hljs-string">"Senior Developer"</span>);
        
        <span class="hljs-comment">// 展示晋升后信息</span>
        company.displayAllEmployees();
    }
}

<span class="hljs-comment">// 抽象员工类</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">protected</span> String name;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">double</span> baseSalary;
    <span class="hljs-keyword">protected</span> String employeeId;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">nextId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 静态变量，用于生成ID</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Employee</span><span class="hljs-params">(String name, <span class="hljs-type">double</span> baseSalary)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.baseSalary = baseSalary;
        <span class="hljs-built_in">this</span>.employeeId = <span class="hljs-string">"EMP"</span> + nextId++;
    }
    
    <span class="hljs-comment">// 抽象方法：计算工资（不同员工计算方式不同）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSalary</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// 抽象方法：工作（不同员工工作内容不同）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// 具体方法：所有员工共享</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attendMeeting</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 正在参加会议"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">takeBreak</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 正在休息"</span>);
    }
    
    <span class="hljs-comment">// 显示员工信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayInfo</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"ID: "</span> + employeeId);
        System.out.println(<span class="hljs-string">"姓名: "</span> + name);
        System.out.println(<span class="hljs-string">"职位: "</span> + getPosition());
        System.out.printf(<span class="hljs-string">"基本工资: ¥%.2f\n"</span>, baseSalary);
        System.out.printf(<span class="hljs-string">"实发工资: ¥%.2f\n"</span>, calculateSalary());
    }
    
    <span class="hljs-comment">// 获取职位名称</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getPosition</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// Getter方法</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getEmployeeId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> employeeId;
    }
    
    <span class="hljs-comment">// Setter方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">if</span> (name != <span class="hljs-literal">null</span> &amp;&amp; !name.trim().isEmpty()) {
            <span class="hljs-built_in">this</span>.name = name;
        }
    }
}

<span class="hljs-comment">// 经理类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Manager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> bonus;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> teamSize;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Manager</span><span class="hljs-params">(String name, <span class="hljs-type">double</span> baseSalary, <span class="hljs-type">double</span> bonus, <span class="hljs-type">int</span> teamSize)</span> {
        <span class="hljs-built_in">super</span>(name, baseSalary);
        <span class="hljs-built_in">this</span>.bonus = bonus;
        <span class="hljs-built_in">this</span>.teamSize = teamSize;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSalary</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 经理工资 = 基本工资 + 奖金</span>
        <span class="hljs-keyword">return</span> baseSalary + bonus;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 经理正在制定项目计划和分配任务"</span>);
        System.out.println(<span class="hljs-string">"管理团队大小: "</span> + teamSize + <span class="hljs-string">"人"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPosition</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"经理"</span>;
    }
    
    <span class="hljs-comment">// 经理特有方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">conductReview</span><span class="hljs-params">(Employee employee)</span> {
        System.out.println(name + <span class="hljs-string">" 正在对员工 "</span> + employee.getName() + <span class="hljs-string">" 进行绩效评估"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBonus</span><span class="hljs-params">(<span class="hljs-type">double</span> bonus)</span> {
        <span class="hljs-keyword">if</span> (bonus &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">this</span>.bonus = bonus;
        }
    }
}

<span class="hljs-comment">// 开发人员类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Developer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">private</span> String programmingLanguage;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> yearsOfExperience;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Developer</span><span class="hljs-params">(String name, <span class="hljs-type">double</span> baseSalary, String language, <span class="hljs-type">int</span> experience)</span> {
        <span class="hljs-built_in">super</span>(name, baseSalary);
        <span class="hljs-built_in">this</span>.programmingLanguage = language;
        <span class="hljs-built_in">this</span>.yearsOfExperience = experience;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSalary</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 开发人员工资 = 基本工资 + 经验津贴（每年经验+5%）</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">experienceBonus</span> <span class="hljs-operator">=</span> baseSalary * <span class="hljs-number">0.05</span> * yearsOfExperience;
        <span class="hljs-keyword">return</span> baseSalary + experienceBonus;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 开发人员正在用 "</span> + programmingLanguage + <span class="hljs-string">" 编写代码"</span>);
        System.out.println(<span class="hljs-string">"经验: "</span> + yearsOfExperience + <span class="hljs-string">"年"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPosition</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"开发人员 ("</span> + programmingLanguage + <span class="hljs-string">")"</span>;
    }
    
    <span class="hljs-comment">// 开发人员特有方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">debugCode</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 正在调试代码"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attendTechMeeting</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 正在参加技术会议"</span>);
    }
}

<span class="hljs-comment">// 销售人员类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Salesperson</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> salesAmount;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Salesperson</span><span class="hljs-params">(String name, <span class="hljs-type">double</span> baseSalary, <span class="hljs-type">double</span> salesAmount)</span> {
        <span class="hljs-built_in">super</span>(name, baseSalary);
        <span class="hljs-built_in">this</span>.salesAmount = salesAmount;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSalary</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 销售人员工资 = 基本工资 + 销售提成（销售额的10%）</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">commission</span> <span class="hljs-operator">=</span> salesAmount * <span class="hljs-number">0.10</span>;
        <span class="hljs-keyword">return</span> baseSalary + commission;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 销售人员正在联系客户，完成销售目标"</span>);
        System.out.printf(<span class="hljs-string">"本月销售额: ¥%.2f\n"</span>, salesAmount);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPosition</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"销售人员"</span>;
    }
    
    <span class="hljs-comment">// 销售人员特有方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSale</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
        salesAmount += amount;
        System.out.println(name + <span class="hljs-string">" 完成一笔销售: ¥"</span> + amount);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attendSalesTraining</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 正在参加销售培训"</span>);
    }
}

<span class="hljs-comment">// 实习生类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Intern</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> internshipDuration;  <span class="hljs-comment">// 实习时长（月）</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Intern</span><span class="hljs-params">(String name, <span class="hljs-type">double</span> baseSalary, <span class="hljs-type">int</span> duration)</span> {
        <span class="hljs-built_in">super</span>(name, baseSalary);
        <span class="hljs-built_in">this</span>.internshipDuration = duration;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSalary</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 实习生只有基本工资，没有奖金</span>
        <span class="hljs-keyword">return</span> baseSalary;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 实习生正在学习并协助完成简单任务"</span>);
        System.out.println(<span class="hljs-string">"实习时长: "</span> + internshipDuration + <span class="hljs-string">"个月"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPosition</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"实习生"</span>;
    }
    
    <span class="hljs-comment">// 实习生特有方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">learn</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 正在学习新技能"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestMentor</span><span class="hljs-params">()</span> {
        System.out.println(name + <span class="hljs-string">" 请求导师指导"</span>);
    }
}

<span class="hljs-comment">// 公司类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> ArrayList&lt;Employee&gt; employees;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Company</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.employees = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
    
    <span class="hljs-comment">// 雇佣员工（多态：可以接收任何Employee子类）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hireEmployee</span><span class="hljs-params">(Employee employee)</span> {
        employees.add(employee);
        System.out.println(<span class="hljs-string">"已雇佣: "</span> + employee.getName() + <span class="hljs-string">" ("</span> + employee.getPosition() + <span class="hljs-string">")"</span>);
    }
    
    <span class="hljs-comment">// 展示所有员工信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayAllEmployees</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"=== "</span> + name + <span class="hljs-string">" 员工列表 ==="</span>);
        System.out.println(<span class="hljs-string">"="</span>.repeat(<span class="hljs-number">50</span>));
        
        <span class="hljs-keyword">for</span> (Employee emp : employees) {
            emp.displayInfo();
            System.out.println(<span class="hljs-string">"-"</span>.repeat(<span class="hljs-number">50</span>));
        }
    }
    
    <span class="hljs-comment">// 计算月度工资支出</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateMonthlyPayroll</span><span class="hljs-params">()</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (Employee emp : employees) {
            total += emp.calculateSalary();
        }
        
        System.out.printf(<span class="hljs-string">"员工总数: %d人\n"</span>, employees.size());
        System.out.printf(<span class="hljs-string">"月度工资总支出: ¥%.2f\n"</span>, total);
        
        <span class="hljs-comment">// 按职位统计</span>
        System.out.println(<span class="hljs-string">"\n按职位统计:"</span>);
        <span class="hljs-keyword">for</span> (Employee emp : employees) {
            System.out.printf(<span class="hljs-string">"%-20s: ¥%.2f\n"</span>, 
                emp.getPosition(), emp.calculateSalary());
        }
    }
    
    <span class="hljs-comment">// 让所有员工工作（多态：调用各自的工作方法）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeEmployeesWork</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (Employee emp : employees) {
            System.out.print(<span class="hljs-string">"&gt; "</span>);
            emp.work();
        }
    }
    
    <span class="hljs-comment">// 晋升员工</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">promoteEmployee</span><span class="hljs-params">(String employeeName, String newPosition)</span> {
        <span class="hljs-keyword">for</span> (Employee emp : employees) {
            <span class="hljs-keyword">if</span> (emp.getName().equals(employeeName)) {
                System.out.println(emp.getName() + <span class="hljs-string">" 晋升为: "</span> + newPosition);
                
                <span class="hljs-comment">// 根据晋升调整工资</span>
                <span class="hljs-keyword">if</span> (emp <span class="hljs-keyword">instanceof</span> Developer) {
                    <span class="hljs-type">Developer</span> <span class="hljs-variable">dev</span> <span class="hljs-operator">=</span> (Developer) emp;
                    System.out.println(<span class="hljs-string">"工资增加20%"</span>);
                    <span class="hljs-comment">// 实际应用中会有更复杂的逻辑</span>
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (emp <span class="hljs-keyword">instanceof</span> Manager) {
                    <span class="hljs-type">Manager</span> <span class="hljs-variable">mgr</span> <span class="hljs-operator">=</span> (Manager) emp;
                    System.out.println(<span class="hljs-string">"奖金增加30%"</span>);
                }
                <span class="hljs-keyword">return</span>;
            }
        }
        System.out.println(<span class="hljs-string">"未找到员工: "</span> + employeeName);
    }
}
</code></pre>
<h2 data-id="heading-15">五、总结：三大特性的核心要点</h2>
<h3 data-id="heading-16">🎯 核心要点总结：</h3>
<ol>
<li>
<p><strong>封装（Encapsulation）</strong> ：把数据和行为包装在类中，隐藏实现细节</p>
<ul>
<li>使用<code>private</code>保护数据</li>
<li>通过<code>public</code>方法提供访问接口</li>
<li>好处：安全性、易维护、低耦合</li>
</ul>
</li>
<li>
<p><strong>继承（Inheritance）</strong> ：子类继承父类的属性和方法</p>
<ul>
<li>使用<code>extends</code>关键字</li>
<li><code>super</code>调用父类构造方法</li>
<li>方法重写（<code>@Override</code>）</li>
<li>好处：代码复用、建立层次关系</li>
</ul>
</li>
<li>
<p><strong>多态（Polymorphism）</strong> ：同一接口，不同实现</p>
<ul>
<li>编译时多态：方法重载</li>
<li>运行时多态：方法重写</li>
<li>父类引用指向子类对象</li>
<li>好处：灵活性、扩展性、解耦合</li>
</ul>
</li>
</ol>
<h3 data-id="heading-17">💡 实战建议：</h3>
<ol>
<li><strong>合理设计类层次</strong>：不要让继承层次太深（通常不超过3层）</li>
<li><strong>优先使用组合而不是继承</strong>：除非有明显的"is-a"关系</li>
<li><strong>为扩展而设计</strong>：使用抽象类和接口定义契约</li>
<li><strong>遵守里氏替换原则</strong>：子类应该能够替换父类而不影响程序功能</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 批量发邮件脚本：Excel 名单 + Jinja2 模板，带日志与防限流，163 邮箱实测可用]]></title>    <link>https://juejin.cn/post/7585502118460473363</link>    <guid>https://juejin.cn/post/7585502118460473363</guid>    <pubDate>2025-12-21T08:10:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585502118460473363" data-draft-id="7585468725333557302" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 批量发邮件脚本：Excel 名单 + Jinja2 模板，带日志与防限流，163 邮箱实测可用"/> <meta itemprop="keywords" content="Python,程序员"/> <meta itemprop="datePublished" content="2025-12-21T08:10:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="起风了___"/> <meta itemprop="url" content="https://juejin.cn/user/3298190615395896"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 批量发邮件脚本：Excel 名单 + Jinja2 模板，带日志与防限流，163 邮箱实测可用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3298190615395896/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    起风了___
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T08:10:29.000Z" title="Sun Dec 21 2025 08:10:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">文章简介</h2>
<p>闲来无事，帮朋友写个邮件发送脚本，顺便拿来写篇技术文，一举两得。脚本从指定的 excel 文件读取客户姓名、邮箱等信息，使用指定的邮件模版批量发送邮件。由于朋友使用文本模版就能达成要求，所以脚本虽然支持 Html 邮件模版，但并未测试。有自定义样式的朋友还需自行调试代码。
备注：本人测试是使用 163 邮箱</p>
<h2 data-id="heading-1">依赖</h2>
<ul>
<li>yagmail==0.15.293
<ul>
<li>用来发送邮件</li>
</ul>
</li>
<li>pandas==2.3.1
<ul>
<li>用来读取 Excel 文件</li>
</ul>
</li>
<li>jinja2==3.1.6
<ul>
<li>用来编写 Html 模版</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">配置信息</h2>
<ul>
<li>邮箱配置
<ul>
<li>password：部分邮箱（如163、QQ）需要使用授权码而不是登录密码，请大家按需从邮箱设置中开启SMTP服务并获取授权码。</li>
<li>host：对不同的邮箱请使用不同的邮箱服务器，记得选择 SMTP 邮箱服务器</li>
<li>port：端口号可使用 465 端口（SSL加密）和 587 端口（STARTTLS），避免使用 25 端口（无加密，不安全）</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailConfig</span>:
    <span class="hljs-string">"""
    邮箱配置
    """</span>
    <span class="hljs-comment"># 你的邮箱</span>
    user: <span class="hljs-built_in">str</span> = <span class="hljs-string">'138xxxx8888@163.com'</span>
    <span class="hljs-comment"># 邮箱授权码</span>
    password: <span class="hljs-built_in">str</span> = <span class="hljs-string">'TXYuclse932VzHJ'</span>
    <span class="hljs-comment"># 邮箱服务器</span>
    host: <span class="hljs-built_in">str</span> = <span class="hljs-string">'smtp.163.com'</span>
    <span class="hljs-comment"># 端口</span>
    port: <span class="hljs-built_in">int</span> = <span class="hljs-string">'587'</span>
</code></pre>
<ul>
<li>发件人信息
<ul>
<li>发件人信息是用在邮件模版中的，可按需添加、删除</li>
<li>get_subject：在这里配置通用的邮件主题，client 是从 excel 文件中读取出的客户信息，使用该信息请和 excel 文件中的标题一致</li>
<li>to_json：返回的数据是用在 Html 模版中的数据，可按需添加。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SenderInfo</span>:
    <span class="hljs-string">"""
    发件人信息
    """</span>
    <span class="hljs-comment"># 显示给客户的发件人名称</span>
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">'起风了-dev'</span>
    <span class="hljs-comment"># 职位</span>
    position: <span class="hljs-built_in">str</span> = <span class="hljs-string">'开发人员'</span>
    <span class="hljs-comment"># 公司</span>
    company: <span class="hljs-built_in">str</span> = <span class="hljs-string">'xxx科技有限责任公司'</span>
    <span class="hljs-comment"># 邮箱</span>
    email: <span class="hljs-built_in">str</span> = <span class="hljs-string">'138xxxx8888@163.com'</span>
    <span class="hljs-comment"># 签名</span>
    signature: <span class="hljs-built_in">str</span> = <span class="hljs-string">'签名测试'</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_subject</span>(<span class="hljs-params">self, client: <span class="hljs-built_in">dict</span></span>):
        <span class="hljs-string">"""
        获取邮件主题
        :param client: 客户信息, 与客户信息文件内一致
        :return: 邮件主题
        """</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>致<span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span>的邮件"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_json</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'name'</span>: self.name,
            <span class="hljs-string">'position'</span>: self.position,
            <span class="hljs-string">'company'</span>: self.company,
            <span class="hljs-string">'email'</span>: self.email,
            <span class="hljs-string">'signature'</span>: self.signature
        }
</code></pre>
<ul>
<li>发送设置
<ul>
<li>发送配置可以调整邮件的发送速度，避免被邮件服务器限制，将邮件当作垃圾邮件</li>
<li>delay_between_emails：每封邮件之间的间隔时间</li>
<li>test_mode：在模版测试时可以先将邮件发送给自己，检查完毕后再给客户发送</li>
<li>max_emails_per_batch：发送邮件每次达到该数目时暂停 1 分钟，有其他需求的朋友可以自行修改代码</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendSettings</span>:
    <span class="hljs-string">"""
    发送设置
    """</span>
    <span class="hljs-comment"># 邮件间隔(秒)，避免被限制</span>
    delay_between_emails: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span>
    <span class="hljs-comment"># 测试模式（只发给自己）</span>
    test_mode: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    <span class="hljs-comment"># 每批最多发送量</span>
    max_emails_per_batch: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span>
</code></pre>
<h2 data-id="heading-3">加载客户数据</h2>
<ul>
<li>excel 文件格式















<table><thead><tr><th align="center">index</th><th align="center">name</th><th align="center">email</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">起风了</td><td align="center"><a href="https://link.juejin.cn?target=mailto%3Axxxx%40qq.com" target="_blank" title="mailto:xxxx@qq.com" ref="nofollow noopener noreferrer">xxxx@qq.com</a></td></tr></tbody></table>
</li>
<li>加载客户数据时会检验客户姓名和邮箱是否存在</li>
<li>返回数据结构: [{index: 1,name:'起风了', email: '<a href="https://link.juejin.cn?target=mailto%3Axxxx%40qq.com" target="_blank" title="mailto:xxxx@qq.com" ref="nofollow noopener noreferrer">xxxx@qq.com</a>'},{index: 2, name:'', email: ''}]</li>
</ul>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_clients</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">"""加载客户数据"""</span>
        df = pd.read_excel(self.client_data_file)
        client_list = df.to_dict(orient=<span class="hljs-string">'records'</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client_list:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"客户数据为空"</span>)
        <span class="hljs-comment"># 客户数据校验并清洗</span>
        <span class="hljs-keyword">for</span> client <span class="hljs-keyword">in</span> client_list:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client[<span class="hljs-string">'email'</span>]:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"客户 <span class="hljs-subst">{json.dumps(client, ensure_ascii=<span class="hljs-literal">False</span>)}</span> 的邮箱为空"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client[<span class="hljs-string">'name'</span>]:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"客户 <span class="hljs-subst">{json.dumps(client, ensure_ascii=<span class="hljs-literal">False</span>)}</span> 的姓名为空"</span>)
            client[<span class="hljs-string">'name'</span>] = client[<span class="hljs-string">'name'</span>].strip()
            client[<span class="hljs-string">'email'</span>] = client[<span class="hljs-string">'email'</span>].strip()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已加载 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(client_list)}</span> 个客户数据"</span>)
        <span class="hljs-keyword">return</span> client_list
</code></pre>
<h2 data-id="heading-4">加载模版数据</h2>
<p>模版从文件内加载</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_template</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""加载邮件模板"""</span>
        template = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> self.template_file:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.template_file, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                template = Template(f.read())
        txt_template = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> self.txt_template_file:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.txt_template_file, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                txt_template = f.read()
        <span class="hljs-keyword">return</span> template, txt_template
</code></pre>
<h2 data-id="heading-5">转换 HTML 到纯文本</h2>
<p>如果只指定了 HTML 模版，会使用这个函数转换一份纯文本邮件出来，HTML 模版本人并未测试，有相应需求的朋友可自行调试代码</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_convert_html_to_text</span>(<span class="hljs-params">self, html</span>):
        <span class="hljs-string">"""
        智能转换HTML到纯文本
        保留重要格式（列表、段落、强调等）
        """</span>
        <span class="hljs-comment"># 自定义转换规则</span>
        replacements = [
            (<span class="hljs-string">r'&lt;br\s*/?&gt;'</span>, <span class="hljs-string">'\n'</span>),
            (<span class="hljs-string">r'&lt;p.*?&gt;'</span>, <span class="hljs-string">'\n\n'</span>),
            (<span class="hljs-string">r'&lt;/p&gt;'</span>, <span class="hljs-string">''</span>),
            (<span class="hljs-string">r'&lt;li.*?&gt;'</span>, <span class="hljs-string">'• '</span>),
            (<span class="hljs-string">r'&lt;/li&gt;'</span>, <span class="hljs-string">'\n'</span>),
            (<span class="hljs-string">r'&lt;strong.*?&gt;'</span>, <span class="hljs-string">'*'</span>),
            (<span class="hljs-string">r'&lt;/strong&gt;'</span>, <span class="hljs-string">'*'</span>),
            (<span class="hljs-string">r'&lt;em.*?&gt;'</span>, <span class="hljs-string">'_'</span>),
            (<span class="hljs-string">r'&lt;/em&gt;'</span>, <span class="hljs-string">'_'</span>),
            (<span class="hljs-string">r'&lt;h[1-6].*?&gt;'</span>, <span class="hljs-string">'\n\n'</span>),
            (<span class="hljs-string">r'&lt;/h[1-6]&gt;'</span>, <span class="hljs-string">'\n\n'</span>),
            (<span class="hljs-string">r'&lt;[^&gt;]+&gt;'</span>, <span class="hljs-string">''</span>),  <span class="hljs-comment"># 移除其他所有HTML标签</span>
        ]

        text = html
        <span class="hljs-keyword">for</span> pattern, replacement <span class="hljs-keyword">in</span> replacements:
            text = re.sub(pattern, replacement, text)

        <span class="hljs-comment"># 清理多余的空行</span>
        text = re.sub(<span class="hljs-string">r'\n\s*\n\s*\n'</span>, <span class="hljs-string">'\n\n'</span>, text)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'_convert_html_to_text:<span class="hljs-subst">{text}</span>'</span>)
        <span class="hljs-keyword">return</span> text.strip()
</code></pre>
<h2 data-id="heading-6">邮件内容组织</h2>
<ul>
<li>在这个函数中将模版中的占位符替换为指定数据
<ul>
<li>纯文本模版使用 {client_key} 结构的参数作为客户信息占位符</li>
<li>{sender_key}为发送者信息占位符</li>
<li>其中 key 是客户 excel 文件标题和配置中 SenderInfo 对象 to_json 函数返回的对象 key</li>
</ul>
</li>
<li>Html 模版内容替换方式请移步学习 jinja2 库</li>
</ul>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">personalize_content</span>(<span class="hljs-params">self, client, template, txt_template: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""个性化邮件内容"""</span>

        html_content = template.render(client=client, sender=self.sender_info.to_json()) <span class="hljs-keyword">if</span> template <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

        <span class="hljs-keyword">if</span> txt_template:
            txt_content = txt_template
            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> client.keys():
                txt_content = txt_content.replace(<span class="hljs-string">'{client_'</span> + key + <span class="hljs-string">'}'</span>, <span class="hljs-built_in">str</span>(client[key]))
            sender_json = self.sender_info.to_json()
            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> sender_json:
                txt_content = txt_content.replace(<span class="hljs-string">'{sender_'</span> + key + <span class="hljs-string">'}'</span>, <span class="hljs-built_in">str</span>(sender_json[key]))
        <span class="hljs-keyword">else</span>:
            txt_content = self._convert_html_to_text(html_content)

        <span class="hljs-keyword">return</span> html_content, txt_content
</code></pre>
<h2 data-id="heading-7">发送邮件</h2>
<p>这部分是邮件发送的核心代码，邮件主题从 SenderInfo 配置中获取，实现统一配置。
发送成功或失败都要记录日志，已备后续查看、核对</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_to_client</span>(<span class="hljs-params">self, client, content</span>):
        <span class="hljs-string">"""发送给单个客户"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 构建邮件</span>
            subject = self.sender_info.get_subject(client=client)

            <span class="hljs-comment"># 如果是测试模式，发给自己</span>
            to_email = client[<span class="hljs-string">'email'</span>]
            <span class="hljs-keyword">if</span> self.send_settings.test_mode:
                to_email = self.email_config.user
                subject = <span class="hljs-string">f"[测试] <span class="hljs-subst">{subject}</span>"</span>

            <span class="hljs-comment"># 发送</span>
            self.yag.send(
                to=to_email,
                subject=subject,
                contents=content,
                <span class="hljs-comment"># attachments=['attachments/sample.pdf'],  # 可选附件</span>
                headers={
                    <span class="hljs-comment"># 'X-Priority': '1',  #  高优先级 ⚠️（显示感叹号）</span>
                    <span class="hljs-string">'X-Priority'</span>: <span class="hljs-string">'3'</span>,  <span class="hljs-comment"># 普通优先级（默认，不显示特殊标记）</span>
                    <span class="hljs-comment"># 'X-Priority': '5',  # 低优先级</span>
                    <span class="hljs-string">'X-Mailer'</span>: <span class="hljs-string">'PersonalEmailSender'</span>
                }
            )

            <span class="hljs-comment"># 记录日志</span>
            log_entry = {
                <span class="hljs-string">'client'</span>: client[<span class="hljs-string">'name'</span>],
                <span class="hljs-string">'email'</span>: client[<span class="hljs-string">'email'</span>],
                <span class="hljs-string">'time'</span>: datetime.now().isoformat(),
                <span class="hljs-string">'status'</span>: <span class="hljs-string">'成功'</span>
            }
            self.sent_log.append(log_entry)

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ 已发送给 <span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span> &lt;<span class="hljs-subst">{client[<span class="hljs-string">'email'</span>]}</span>&gt;"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✗ 发送失败 <span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{e}</span>"</span>)
            self.sent_log.append({
                <span class="hljs-string">'client'</span>: client[<span class="hljs-string">'name'</span>],
                <span class="hljs-string">'email'</span>: client[<span class="hljs-string">'email'</span>],
                <span class="hljs-string">'time'</span>: datetime.now().isoformat(),
                <span class="hljs-string">'status'</span>: <span class="hljs-string">f'失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>'</span>
            })
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<h2 data-id="heading-8">存储日志</h2>
<p>运行完毕将日志写入文件</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save_log</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""保存发送记录"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.sent_log:
            <span class="hljs-keyword">return</span>

        log_df = pd.DataFrame(self.sent_log)
        timestamp = datetime.now().strftime(<span class="hljs-string">'%Y%m%d_%H%M%S'</span>)
        log_file = <span class="hljs-string">f'sent_logs/sent_<span class="hljs-subst">{timestamp}</span>.csv'</span>

        <span class="hljs-comment"># 确保目录存在</span>
        os.makedirs(<span class="hljs-string">'sent_logs'</span>, exist_ok=<span class="hljs-literal">True</span>)

        log_df.to_csv(log_file, index=<span class="hljs-literal">False</span>, encoding=<span class="hljs-string">'utf-8-sig'</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📋 发送记录已保存: <span class="hljs-subst">{log_file}</span>"</span>)
</code></pre>
<h2 data-id="heading-9">功能组合后的主运行函数</h2>
<p>在此处整合以上介绍的各部分功能。</p>
<ul>
<li>流程：加载客户 --&gt; 加载模版 --&gt; 分别为客户生成邮件内容 --&gt; 内容校验 --&gt; 发送邮件 --&gt; 发送延迟 --&gt; 保存日志 --&gt; 发送结束</li>
</ul>
<pre><code class="hljs language-python" lang="python">
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""主运行函数"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始发送个性化邮件...\n"</span>)

        <span class="hljs-comment"># 加载数据</span>
        client_list = self.load_clients()
        template, txt_template = self.load_template()

        sent_count = <span class="hljs-number">0</span>
        total_clients = <span class="hljs-built_in">len</span>(client_list)

        <span class="hljs-keyword">for</span> i, client <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(client_list, <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n[<span class="hljs-subst">{i}</span>/<span class="hljs-subst">{total_clients}</span>] 处理: <span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span>"</span>)

            <span class="hljs-comment"># 个性化内容</span>
            html_content, text_content = self.personalize_content(client, template, txt_template)

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> text_content:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✗ 无内容可发送给 <span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span>"</span>)
                <span class="hljs-comment"># 记录日志</span>
                log_entry = {
                    <span class="hljs-string">'client'</span>: client[<span class="hljs-string">'name'</span>],
                    <span class="hljs-string">'email'</span>: client[<span class="hljs-string">'email'</span>],
                    <span class="hljs-string">'time'</span>: datetime.now().isoformat(),
                    <span class="hljs-string">'status'</span>: <span class="hljs-string">'失败'</span>,
                    <span class="hljs-string">'原因'</span>: <span class="hljs-string">'无内容'</span>
                }
                self.sent_log.append(log_entry)
                <span class="hljs-keyword">continue</span>

            content = [text_content, html_content] <span class="hljs-keyword">if</span> html_content <span class="hljs-keyword">else</span> text_content
            <span class="hljs-comment"># 发送</span>
            <span class="hljs-keyword">if</span> self.send_to_client(client, content):
                sent_count += <span class="hljs-number">1</span>

            <span class="hljs-comment"># 延迟，避免被限制</span>
            <span class="hljs-keyword">if</span> i &lt; total_clients:
                delay = self.send_settings.delay_between_emails
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"等待 <span class="hljs-subst">{delay}</span> 秒..."</span>)
                time.sleep(delay)

            <span class="hljs-comment"># 分批暂停（如果发送量大）</span>
            <span class="hljs-keyword">if</span> i % self.send_settings.max_emails_per_batch == <span class="hljs-number">0</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n已发送 <span class="hljs-subst">{i}</span> 封，暂停 60 秒..."</span>)
                time.sleep(<span class="hljs-number">60</span>)

        <span class="hljs-comment"># 保存日志</span>
        self.save_log()

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✅ 完成！成功发送 <span class="hljs-subst">{sent_count}</span>/<span class="hljs-subst">{total_clients}</span> 封邮件"</span>)

        <span class="hljs-comment"># 关闭连接</span>
        <span class="hljs-keyword">if</span> self.yag:
            self.yag.close()
</code></pre>
<h2 data-id="heading-10">运行示例</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 客户数据文件</span>
    client_data_file = <span class="hljs-string">'./clients/clients.xlsx'</span>
    <span class="hljs-comment"># 邮件模板文件</span>
    txt_template_file = <span class="hljs-string">'./templates/christmas.txt'</span>
    sender = EmailSender(client_data_file=client_data_file,
                         txt_template_file=txt_template_file)
    sender.run()
</code></pre>
<h2 data-id="heading-11">附源码</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 配置信息</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailConfig</span>:
    <span class="hljs-string">"""
    邮箱配置
    """</span>
    <span class="hljs-comment"># 你的邮箱</span>
    user: <span class="hljs-built_in">str</span> = <span class="hljs-string">'138xxxx8888@163.com'</span>
    <span class="hljs-comment"># 邮箱授权码</span>
    password: <span class="hljs-built_in">str</span> = <span class="hljs-string">'TXYuclse932VzHJ'</span>
    <span class="hljs-comment"># 邮箱服务器</span>
    host: <span class="hljs-built_in">str</span> = <span class="hljs-string">'smtp.163.com'</span>
    <span class="hljs-comment"># 端口</span>
    port: <span class="hljs-built_in">int</span> = <span class="hljs-string">'587'</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SenderInfo</span>:
    <span class="hljs-string">"""
    发件人信息
    """</span>
    <span class="hljs-comment"># 显示给客户的发件人名称</span>
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">'起风了-dev'</span>
    <span class="hljs-comment"># 职位</span>
    position: <span class="hljs-built_in">str</span> = <span class="hljs-string">'开发人员'</span>
    <span class="hljs-comment"># 公司</span>
    company: <span class="hljs-built_in">str</span> = <span class="hljs-string">'xxx科技有限责任公司'</span>
    <span class="hljs-comment"># 邮箱</span>
    email: <span class="hljs-built_in">str</span> = <span class="hljs-string">'138xxxx8888@163.com'</span>
    <span class="hljs-comment"># 签名</span>
    signature: <span class="hljs-built_in">str</span> = <span class="hljs-string">'签名测试'</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_subject</span>(<span class="hljs-params">self, client: <span class="hljs-built_in">dict</span></span>):
        <span class="hljs-string">"""
        获取邮件主题
        :param client: 客户信息, 与客户信息文件内一致
        :return: 邮件主题
        """</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>致<span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span>的邮件"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_json</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'name'</span>: self.name,
            <span class="hljs-string">'position'</span>: self.position,
            <span class="hljs-string">'company'</span>: self.company,
            <span class="hljs-string">'email'</span>: self.email,
            <span class="hljs-string">'signature'</span>: self.signature
        }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SendSettings</span>:
    <span class="hljs-string">"""
    发送设置
    """</span>
    <span class="hljs-comment"># 邮件间隔(秒)，避免被限制</span>
    delay_between_emails: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span>
    <span class="hljs-comment"># 测试模式（只发给自己）</span>
    test_mode: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    <span class="hljs-comment"># 每批最多发送量</span>
    max_emails_per_batch: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span>

<span class="hljs-comment"># 主功能代码</span>
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> re

<span class="hljs-keyword">import</span> yagmail
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Template
<span class="hljs-keyword">from</span> config.config <span class="hljs-keyword">import</span> EmailConfig, SenderInfo, SendSettings


<span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailSender</span>:
    <span class="hljs-string">"""邮件发送器"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, client_data_file: <span class="hljs-built_in">str</span>, txt_template_file: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""初始化"""</span>
        <span class="hljs-comment"># 客户数据</span>
        self.client_data_file = client_data_file
        <span class="hljs-comment"># 邮件模板</span>
        self.template_file = <span class="hljs-literal">None</span>
        self.txt_template_file = txt_template_file
        <span class="hljs-comment"># 邮件配置</span>
        self.email_config = EmailConfig()
        self.sender_info = SenderInfo()
        self.send_settings = SendSettings()
        self.yag = yagmail.SMTP(
            user=self.email_config.user,
            password=self.email_config.password,
            host=self.email_config.host,
            port=self.email_config.port
        )
        self.sent_log = []

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_clients</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]:
        <span class="hljs-string">"""加载客户数据"""</span>
        df = pd.read_excel(self.client_data_file)
        client_list = df.to_dict(orient=<span class="hljs-string">'records'</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client_list:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"客户数据为空"</span>)
        <span class="hljs-comment"># 客户数据校验并清洗</span>
        <span class="hljs-keyword">for</span> client <span class="hljs-keyword">in</span> client_list:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client[<span class="hljs-string">'email'</span>]:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"客户 <span class="hljs-subst">{json.dumps(client, ensure_ascii=<span class="hljs-literal">False</span>)}</span> 的邮箱为空"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> client[<span class="hljs-string">'name'</span>]:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"客户 <span class="hljs-subst">{json.dumps(client, ensure_ascii=<span class="hljs-literal">False</span>)}</span> 的姓名为空"</span>)
            client[<span class="hljs-string">'name'</span>] = client[<span class="hljs-string">'name'</span>].strip()
            client[<span class="hljs-string">'email'</span>] = client[<span class="hljs-string">'email'</span>].strip()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已加载 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(client_list)}</span> 个客户数据"</span>)
        <span class="hljs-keyword">return</span> client_list

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_template</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""加载邮件模板"""</span>
        template = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> self.template_file:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.template_file, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                template = Template(f.read())
        txt_template = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> self.txt_template_file:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.txt_template_file, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                txt_template = f.read()
        <span class="hljs-keyword">return</span> template, txt_template

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_convert_html_to_text</span>(<span class="hljs-params">self, html</span>):
        <span class="hljs-string">"""
        智能转换HTML到纯文本
        保留重要格式（列表、段落、强调等）
        """</span>
        <span class="hljs-comment"># 自定义转换规则</span>
        replacements = [
            (<span class="hljs-string">r'&lt;br\s*/?&gt;'</span>, <span class="hljs-string">'\n'</span>),
            (<span class="hljs-string">r'&lt;p.*?&gt;'</span>, <span class="hljs-string">'\n\n'</span>),
            (<span class="hljs-string">r'&lt;/p&gt;'</span>, <span class="hljs-string">''</span>),
            (<span class="hljs-string">r'&lt;li.*?&gt;'</span>, <span class="hljs-string">'• '</span>),
            (<span class="hljs-string">r'&lt;/li&gt;'</span>, <span class="hljs-string">'\n'</span>),
            (<span class="hljs-string">r'&lt;strong.*?&gt;'</span>, <span class="hljs-string">'*'</span>),
            (<span class="hljs-string">r'&lt;/strong&gt;'</span>, <span class="hljs-string">'*'</span>),
            (<span class="hljs-string">r'&lt;em.*?&gt;'</span>, <span class="hljs-string">'_'</span>),
            (<span class="hljs-string">r'&lt;/em&gt;'</span>, <span class="hljs-string">'_'</span>),
            (<span class="hljs-string">r'&lt;h[1-6].*?&gt;'</span>, <span class="hljs-string">'\n\n'</span>),
            (<span class="hljs-string">r'&lt;/h[1-6]&gt;'</span>, <span class="hljs-string">'\n\n'</span>),
            (<span class="hljs-string">r'&lt;[^&gt;]+&gt;'</span>, <span class="hljs-string">''</span>),  <span class="hljs-comment"># 移除其他所有HTML标签</span>
        ]

        text = html
        <span class="hljs-keyword">for</span> pattern, replacement <span class="hljs-keyword">in</span> replacements:
            text = re.sub(pattern, replacement, text)

        <span class="hljs-comment"># 清理多余的空行</span>
        text = re.sub(<span class="hljs-string">r'\n\s*\n\s*\n'</span>, <span class="hljs-string">'\n\n'</span>, text)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'_convert_html_to_text:<span class="hljs-subst">{text}</span>'</span>)
        <span class="hljs-keyword">return</span> text.strip()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">personalize_content</span>(<span class="hljs-params">self, client, template, txt_template: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""个性化邮件内容"""</span>

        html_content = template.render(client=client, sender=self.sender_info.to_json()) <span class="hljs-keyword">if</span> template <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

        <span class="hljs-keyword">if</span> txt_template:
            txt_content = txt_template
            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> client.keys():
                txt_content = txt_content.replace(<span class="hljs-string">'{client_'</span> + key + <span class="hljs-string">'}'</span>, <span class="hljs-built_in">str</span>(client[key]))
            sender_json = self.sender_info.to_json()
            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> sender_json:
                txt_content = txt_content.replace(<span class="hljs-string">'{sender_'</span> + key + <span class="hljs-string">'}'</span>, <span class="hljs-built_in">str</span>(sender_json[key]))
        <span class="hljs-keyword">else</span>:
            txt_content = self._convert_html_to_text(html_content)

        <span class="hljs-keyword">return</span> html_content, txt_content

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_to_client</span>(<span class="hljs-params">self, client, content</span>):
        <span class="hljs-string">"""发送给单个客户"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 构建邮件</span>
            subject = self.sender_info.get_subject(client=client)

            <span class="hljs-comment"># 如果是测试模式，发给自己</span>
            to_email = client[<span class="hljs-string">'email'</span>]
            <span class="hljs-keyword">if</span> self.send_settings.test_mode:
                to_email = self.email_config.user
                subject = <span class="hljs-string">f"[测试] <span class="hljs-subst">{subject}</span>"</span>

            <span class="hljs-comment"># 发送</span>
            self.yag.send(
                to=to_email,
                subject=subject,
                contents=content,
                <span class="hljs-comment"># attachments=['attachments/sample.pdf'],  # 可选附件</span>
                headers={
                    <span class="hljs-comment"># 'X-Priority': '1',  #  高优先级 ⚠️（显示感叹号）</span>
                    <span class="hljs-string">'X-Priority'</span>: <span class="hljs-string">'3'</span>,  <span class="hljs-comment"># 普通优先级（默认，不显示特殊标记）</span>
                    <span class="hljs-comment"># 'X-Priority': '5',  # 低优先级</span>
                    <span class="hljs-string">'X-Mailer'</span>: <span class="hljs-string">'PersonalEmailSender'</span>
                }
            )

            <span class="hljs-comment"># 记录日志</span>
            log_entry = {
                <span class="hljs-string">'client'</span>: client[<span class="hljs-string">'name'</span>],
                <span class="hljs-string">'email'</span>: client[<span class="hljs-string">'email'</span>],
                <span class="hljs-string">'time'</span>: datetime.now().isoformat(),
                <span class="hljs-string">'status'</span>: <span class="hljs-string">'成功'</span>
            }
            self.sent_log.append(log_entry)

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ 已发送给 <span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span> &lt;<span class="hljs-subst">{client[<span class="hljs-string">'email'</span>]}</span>&gt;"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✗ 发送失败 <span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{e}</span>"</span>)
            self.sent_log.append({
                <span class="hljs-string">'client'</span>: client[<span class="hljs-string">'name'</span>],
                <span class="hljs-string">'email'</span>: client[<span class="hljs-string">'email'</span>],
                <span class="hljs-string">'time'</span>: datetime.now().isoformat(),
                <span class="hljs-string">'status'</span>: <span class="hljs-string">f'失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>'</span>
            })
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save_log</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""保存发送记录"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.sent_log:
            <span class="hljs-keyword">return</span>

        log_df = pd.DataFrame(self.sent_log)
        timestamp = datetime.now().strftime(<span class="hljs-string">'%Y%m%d_%H%M%S'</span>)
        log_file = <span class="hljs-string">f'sent_logs/sent_<span class="hljs-subst">{timestamp}</span>.csv'</span>

        <span class="hljs-comment"># 确保目录存在</span>
        os.makedirs(<span class="hljs-string">'sent_logs'</span>, exist_ok=<span class="hljs-literal">True</span>)

        log_df.to_csv(log_file, index=<span class="hljs-literal">False</span>, encoding=<span class="hljs-string">'utf-8-sig'</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📋 发送记录已保存: <span class="hljs-subst">{log_file}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""主运行函数"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始发送个性化邮件...\n"</span>)

        <span class="hljs-comment"># 加载数据</span>
        client_list = self.load_clients()
        template, txt_template = self.load_template()

        sent_count = <span class="hljs-number">0</span>
        total_clients = <span class="hljs-built_in">len</span>(client_list)

        <span class="hljs-keyword">for</span> i, client <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(client_list, <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n[<span class="hljs-subst">{i}</span>/<span class="hljs-subst">{total_clients}</span>] 处理: <span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span>"</span>)

            <span class="hljs-comment"># 个性化内容</span>
            html_content, text_content = self.personalize_content(client, template, txt_template)

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> text_content:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✗ 无内容可发送给 <span class="hljs-subst">{client[<span class="hljs-string">'name'</span>]}</span>"</span>)
                <span class="hljs-comment"># 记录日志</span>
                log_entry = {
                    <span class="hljs-string">'client'</span>: client[<span class="hljs-string">'name'</span>],
                    <span class="hljs-string">'email'</span>: client[<span class="hljs-string">'email'</span>],
                    <span class="hljs-string">'time'</span>: datetime.now().isoformat(),
                    <span class="hljs-string">'status'</span>: <span class="hljs-string">'失败'</span>,
                    <span class="hljs-string">'原因'</span>: <span class="hljs-string">'无内容'</span>
                }
                self.sent_log.append(log_entry)
                <span class="hljs-keyword">continue</span>

            content = [text_content, html_content] <span class="hljs-keyword">if</span> html_content <span class="hljs-keyword">else</span> text_content
            <span class="hljs-comment"># 发送</span>
            <span class="hljs-keyword">if</span> self.send_to_client(client, content):
                sent_count += <span class="hljs-number">1</span>

            <span class="hljs-comment"># 延迟，避免被限制</span>
            <span class="hljs-keyword">if</span> i &lt; total_clients:
                delay = self.send_settings.delay_between_emails
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"等待 <span class="hljs-subst">{delay}</span> 秒..."</span>)
                time.sleep(delay)

            <span class="hljs-comment"># 分批暂停（如果发送量大）</span>
            <span class="hljs-keyword">if</span> i % self.send_settings.max_emails_per_batch == <span class="hljs-number">0</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n已发送 <span class="hljs-subst">{i}</span> 封，暂停 60 秒..."</span>)
                time.sleep(<span class="hljs-number">60</span>)

        <span class="hljs-comment"># 保存日志</span>
        self.save_log()

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✅ 完成！成功发送 <span class="hljs-subst">{sent_count}</span>/<span class="hljs-subst">{total_clients}</span> 封邮件"</span>)

        <span class="hljs-comment"># 关闭连接</span>
        <span class="hljs-keyword">if</span> self.yag:
            self.yag.close()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 客户数据文件</span>
    client_data_file = <span class="hljs-string">'./clients/clients.xlsx'</span>
    <span class="hljs-comment"># 邮件模板文件</span>
    txt_template_file = <span class="hljs-string">'./templates/christmas.txt'</span>
    sender = EmailSender(client_data_file=client_data_file,
                         txt_template_file=txt_template_file)
    sender.run()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（六）]]></title>    <link>https://juejin.cn/post/7585553799298416686</link>    <guid>https://juejin.cn/post/7585553799298416686</guid>    <pubDate>2025-12-21T10:31:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585553799298416686" data-draft-id="7585743487258542089" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（六）"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-21T10:31:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="名字被你们想完了"/> <meta itemprop="url" content="https://juejin.cn/user/3065854916834782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（六）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3065854916834782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    名字被你们想完了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T10:31:52.000Z" title="Sun Dec 21 2025 10:31:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（六）</h2>
<p>Flutter: 3.35.6</p>
<p>前面有人提到在元素内部的那块判断怎么那么写的，看来对知识渴望的小伙伴还是有，这样挺好的。不至于说牢记部分知识，只需要大致了解一下有个印象后面如果哪里再用到了就可以根据这个印象去查阅资料。</p>
<p>接下来我们说一下判断原理。当我们知晓矩形的四个顶点坐标(包括任意旋转后)，可以使用向量叉乘法来判断是否在矩形内部。</p>
<p>向量叉乘法的核心思想就是：如果一个点在凸多边形内部，那么它应该始终位于该多边形每条边的同一侧。</p>
<p>注：凸多边形定义为所有内角均小于180度，并且任意两点之间的连线都完全位于多边形内部或边界。</p>
<p>所以我们利用向量叉乘法来判断点位于线的哪一侧。假设矩形顶点按<strong>顺时针</strong>或<strong>逆时针</strong>顺序为 A，B，C，D：</p>
<ul>
<li>对于边 AB，计算向量 AB 和 AP 的叉积。</li>
<li>对于边 BC，计算向量 BC 和 BP 的叉积。</li>
<li>对于边 CD，计算向量 CD 和 CP 的叉积。</li>
<li>对于边 DA，计算向量 DA 和 DP 的叉积。</li>
</ul>
<p>如果点 P 在所有边的‌同一侧‌（即所有叉积结果的符号相同），那么点 P 就在矩形内部。我们假设矩形某条边的顶点为(x1, y1), (x2, y2), 判断的点坐标为(x, y)，那么就有：</p>
<p>(x2 - x1) * (y - y1) - (y2 - y1) * (x - x1) &gt; 0</p>
<p>这样就可以判断在某侧，如果其他三条边也满足，那就是内侧了，要转换为下面代码中的形式，那就做一下加减乘除就行了：</p>
<ol>
<li>(x2 - x1) * (y - y1) - (y2 - y1) * (x - x1) &gt; 0: 初始</li>
<li>(x2 - x1) * (y - y1) / (y2 - y1) - (x - x1) &gt; 0: 两边同时除以(y2 - y1)</li>
<li>(x2 - x1) * (y - y1) / (y2 - y1) - x + x1 &gt; 0: 展开括号</li>
<li>(x2 - x1) * (y - y1) / (y2 - y1) + x1 &gt; x: 将x移项</li>
</ol>
<p>这样就得到了代码中的判断依据，至于循环遍历顶点的写法，就是为了获取相邻两个顶点，这个就可以带入square坐标和循环去算一下就行了，保证每次循环都是相邻的两个顶点。</p>
<p>我们使用的顶点坐标顺序是顺时针，第一次循环 i = 0，j = 3，那么i就是左上顶点，j就是左下顶点，两个顶点刚好构成矩形左边；第二次循环 j = i++，此时 j = 0，i = 1后续喜欢以此类推即可。</p>
<p>这样判断在内侧差不多就解释完了。接下来开始我们今天正文。前面我们就简单完成了多个元素的相应操作，剩下的就是一些优化和一些简单的扩展功能。</p>
<p>既然是多个元素，那么肯定就涉及到新增和删除，之前的新增都是在列表里面直接添加，现在我们单独提取一个方法用于新增。至于删除功能我们就定义在元素左上角为删除区域，触发方式为点击。之前我们对热区的数据模型中添加了 trigger 字段，用于表示当前区域触发操作的方式是什么，所以我们得对点击方法进行优化，并且在临时中间变量上面存储 trigger 字段，用于判断：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResponseAreaModel</span> </span>{
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">/// <span class="markdown">当前响应操作的触发方式</span></span>
  <span class="hljs-keyword">final</span> TriggerMethod trigger;
}

<span class="hljs-comment">/// <span class="markdown">新增返回Records，用于记录状态和触发方式</span></span>
(ElementStatus, TriggerMethod)? _onDownZone({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y,
  <span class="hljs-keyword">required</span> ElementModel item,
}) {
  <span class="hljs-comment">// 先判断是否在响应对应操作的区域</span>
  <span class="hljs-keyword">final</span> (ElementStatus, TriggerMethod)? areaStatus = _getElementZone(x: x, y: y, item: item);
  <span class="hljs-keyword">if</span> (areaStatus != <span class="hljs-keyword">null</span>) {
    <span class="hljs-keyword">return</span> areaStatus;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_insideElement(x: x, y: y, item: item)) {
    <span class="hljs-comment">// 因为加入旋转，所以单独抽取落点是否在元素内部的方法</span>
    <span class="hljs-keyword">return</span> (ElementStatus.move, TriggerMethod.move);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
}

<span class="hljs-comment">/// <span class="markdown">新增返回Records，用于记录状态和触发方式</span></span>
(ElementStatus, TriggerMethod)? _getElementZone({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y,
  <span class="hljs-keyword">required</span> ElementModel item,
}) {
  <span class="hljs-comment">// 新增Records记录返回的状态和触发方式</span>
  (ElementStatus, TriggerMethod)? tempStatus;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ConstantsConfig.baseAreaList.length; i++) {
    <span class="hljs-comment">// 其他省略...</span>

    <span class="hljs-keyword">if</span> (
      x &gt;= dx - areaCW &amp;&amp;
      x &lt;= dx + areaCW &amp;&amp;
      y &gt;= dy - areaCH &amp;&amp;
      y &lt;= dy + areaCH
    ) {
      tempStatus = (currentArea.status, currentArea.trigger);
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">return</span> tempStatus;
}
</code></pre>
<p>这样触发方式和状态都记录了，我们就开始实现删除功能，依然按照之前的步骤快速实现：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 新增删除</span>
ResponseAreaModel(
  areaWidth: <span class="hljs-number">20</span>,
  areaHeight: <span class="hljs-number">20</span>,
  xRatio: <span class="hljs-number">0</span>,
  yRatio: <span class="hljs-number">0</span>,
  status: ElementStatus.deleteStatus,
  icon: <span class="hljs-string">'assets/images/icon_delete.png'</span>,
  trigger: TriggerMethod.down,
),
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">处理删除元素</span></span>
<span class="hljs-keyword">void</span> _onDelete() {
  <span class="hljs-keyword">if</span> (_currentElement == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;

  _elementList.removeWhere((item) =&gt; item.id == _currentElement?.id);
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">按下事件</span></span>
<span class="hljs-keyword">void</span> _onPanDown(DragDownDetails details) {
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">// 遍历判断当前点击的位置是否落在了某个元素的响应区域</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> _elementList) {
    <span class="hljs-comment">// 新增Records数据，存储元素状态和触发方式</span>
    <span class="hljs-keyword">final</span> (ElementStatus, TriggerMethod)? status = _onDownZone(x: dx, y: dy, item: item);

    <span class="hljs-keyword">if</span> (status != <span class="hljs-keyword">null</span>) {
      currentElement = item;
      temp = temp.copyWith(status: status.$<span class="hljs-number">1</span>, trigger: status.$<span class="hljs-number">2</span>);
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-comment">// 新增判断</span>
  <span class="hljs-comment">// 如果当前有选中的元素且和点击区域的currentElement是一个元素</span>
  <span class="hljs-comment">// 并且 temp 的 status对应的触发方式为点击，那么就响应对应的点击事件</span>
  <span class="hljs-keyword">if</span> (currentElement?.id == _currentElement?.id &amp;&amp; temp.trigger == TriggerMethod.down) {
    <span class="hljs-keyword">if</span> (temp.status == ElementStatus.deleteStatus) {
      _onDelete();
      <span class="hljs-comment">// 因为是删除，就置空选中，让下面代码执行最后的清除</span>
      currentElement = <span class="hljs-keyword">null</span>;
    }
  }

  <span class="hljs-comment">// 其他省略...</span>
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c31a7b32d93495e96cd5dc3d0ba960b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766917912&amp;x-signature=QlV%2B7Tyl83Ib0ywhrpUNPvC8fi4%3D" alt="image01.gif" loading="lazy"/></p>
<p>这样就简单实现了元素的删除功能。到此操作区域常用的功能差不多就完成，接下来我们考虑一些区域的自定义；例如我希望旋转的区域在右下角（现在在右上角），并且不使用缩放功能，还想自定义一个区域，这时候该如何实现呢？</p>
<p>允许传递配置，通过这份配置来决定元素应该有什么响应区域并且是否使用这些响应区域，然而操作这些内置的我们可以使用之前定义的 <strong>final ElementStatus status;</strong> 字段来确定要修改哪个区域，毕竟一个操作应该是对应一个区域；对于自定义区域，我们的ElementStatus是个枚举类型且为必传，这就限制了自定义区域，所以我们的改造一下，用户传递的自定义区域，status为自行设置的字符串，我们内部也同时更改为字符串（涉及更改的地方有一些，这里不做过多的说明，后续可以查阅源码）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">元素当前操作状态</span></span>
<span class="hljs-comment">/// <span class="markdown">更改新增字符串的value属性</span></span>
<span class="hljs-keyword">enum</span> ElementStatus {
  move(value: <span class="hljs-string">'move'</span>),
  rotate(value: <span class="hljs-string">'rotate'</span>),
  scale(value: <span class="hljs-string">'scale'</span>),
  deleteStatus(value: <span class="hljs-string">'deleteStatus'</span>),;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> value;

  <span class="hljs-keyword">const</span> ElementStatus({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.value});
}

<span class="hljs-comment">/// <span class="markdown">大致说一些需要更改的地方</span></span>
<span class="hljs-comment">/// <span class="markdown">TemporaryModel 的 status 更改为字符串类型</span></span>
<span class="hljs-comment">/// <span class="markdown">ResponseAreaModel 的 status 更改为字符串类型</span></span>
<span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">_onDownZone 方法中 Records 第一项也返回 String</span></span></span>
<span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">_</span>getElementZone 方法中 Records 第一项也返回 String</span></span>
</code></pre>
<p>接下来我们确定自定义区域配置中需要的字段：</p>
<ul>
<li>status：用于映射内置的区域，方便做更改（String 必须）</li>
<li>use：用于确定该 status 对应的内置区域是否使用（bool 非必须）</li>
<li>xRatio：用于确定区域位置（double 非必须，如果非内置的默认就是0）</li>
<li>yRatio：用于确定区域位置（double 非必须，如果非内置的默认就是0）</li>
<li>trigger：用于确定区域的触发方式（TriggerMethod 非必须，默认TriggerMethod.down）</li>
<li>icon：用于确定操作区域的展示icon（String 如果是内置的 status 就是非必须，如果不是内置的就是必须）</li>
<li>fn：自定义区域需要执行的方法（Function({required double x, required double y}) 如果是内置的就是非必须，如果不是内置的就必须）</li>
</ul>
<p>基于上述开始进行编码：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">新增自定义区域配置</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomAreaConfig</span> </span>{
  <span class="hljs-keyword">const</span> CustomAreaConfig({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">this</span>.use,
    <span class="hljs-keyword">this</span>.xRatio,
    <span class="hljs-keyword">this</span>.yRatio,
    <span class="hljs-keyword">this</span>.trigger = TriggerMethod.down,
    <span class="hljs-keyword">this</span>.icon,
    <span class="hljs-keyword">this</span>.fn,
  });

  <span class="hljs-comment">/// <span class="markdown">区域的操作状态字符串，可以是内置的，如果是内置的就覆盖内置的属性</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> status;
  <span class="hljs-comment">/// <span class="markdown">是否启用</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool?</span> use;
  <span class="hljs-comment">/// <span class="markdown">自定义位置</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double?</span> xRatio;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double?</span> yRatio;
  <span class="hljs-comment">/// <span class="markdown">区域响应操作的触发方式</span></span>
  <span class="hljs-keyword">final</span> TriggerMethod trigger;
  <span class="hljs-comment">/// <span class="markdown">自定义区域就是必传</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> icon;
  <span class="hljs-comment">/// <span class="markdown">自定义区域就是必传，点击对应的响应区域就执行自定义的方法</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function</span>({<span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x, <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y})? fn;
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">新增自定义区域配置</span></span>
<span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;CustomAreaConfig&gt; _customAreaList = [
  <span class="hljs-comment">// 不使用缩放区域</span>
  CustomAreaConfig(
    status: ElementStatus.scale.value,
    use: <span class="hljs-keyword">false</span>,
  ),
  <span class="hljs-comment">// 将旋转移到右下角</span>
  CustomAreaConfig(
    status: ElementStatus.rotate.value,
    xRatio: <span class="hljs-number">1</span>,
    yRatio: <span class="hljs-number">1</span>,
  ),
];
<span class="hljs-comment">/// <span class="markdown">容器响应操作区域，之前是直接使用的常量里面的配置</span></span>
<span class="hljs-built_in">List</span>&lt;ResponseAreaModel&gt; _areaList = [];

<span class="hljs-comment">/// <span class="markdown">初始化响应区域</span></span>
<span class="hljs-keyword">void</span> _initArea() {
  <span class="hljs-built_in">List</span>&lt;ResponseAreaModel&gt; areaList = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> area <span class="hljs-keyword">in</span> ConstantsConfig.baseAreaList) {
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> index = _customAreaList.indexWhere((item) =&gt; item.status == area.status);

    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">final</span> CustomAreaConfig customArea = _customAreaList[index];

      <span class="hljs-comment">// 如果是不使用，则跳出本次循环</span>
      <span class="hljs-keyword">if</span> (customArea.use == <span class="hljs-keyword">false</span>) {
        <span class="hljs-keyword">continue</span>;
      }

      areaList.add(area.copyWith(
        xRatio: customArea.xRatio,
        yRatio: customArea.yRatio,
        icon: customArea.icon,
        fn: customArea.fn,
      ));
    } <span class="hljs-keyword">else</span> {
      areaList.add(area);
    }
  }

  setState(() {
    _areaList = areaList;
  });
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>

<span class="hljs-comment">/// <span class="markdown">抽取渲染的元素</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> TransformItem({
    <span class="hljs-comment">// 其他省略...</span>

    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.areaList,
  });

  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;ResponseAreaModel&gt; areaList;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Positioned(
      left: elementItem.x,
      top: elementItem.y,
      <span class="hljs-comment">// 新增旋转功能</span>
      child: Transform.rotate(
        angle: elementItem.rotationAngle,
        child: Container(
          <span class="hljs-comment">// 其他省略...</span>

          <span class="hljs-comment">// 新增区域的渲染</span>
          child: selected ? Stack(
            clipBehavior: Clip.none,
            children: [
              <span class="hljs-comment">// 修改从外界传递区域列表</span>
              ...areaList.map((item) =&gt; Positioned(
                <span class="hljs-comment">// 其他省略...</span>
              )),
            ],
          ) : <span class="hljs-keyword">null</span>,
        ),
      )
    );
  }
}
</code></pre>
<p>其他编码不算核心，就不再展示了，反正就一个，之前从 ConstantsConfig.baseAreaList 拿的数据现在都直接使用 _areaList。</p>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/919333907ca8484ea4ad7b32d225334d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766917912&amp;x-signature=8uNMV4cVZOMorlQloFL7GA19lk4%3D" alt="image02.gif" loading="lazy"/></p>
<p>可以看到，我们将旋转区域移到右下角了，并且不使用缩放区域，这样就简单完成了区域自定义的配置。</p>
<p>感兴趣的也可以关注我的微信公众号【前端学习小营地】，不定时会分享一些小功能～</p>
<p>今天的分享就到此结束了，感谢阅读～拜拜～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust 的CPU和IO操作]]></title>    <link>https://juejin.cn/post/7585534343562149938</link>    <guid>https://juejin.cn/post/7585534343562149938</guid>    <pubDate>2025-12-21T05:29:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585534343562149938" data-draft-id="7585686247268876297" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust 的CPU和IO操作"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-21T05:29:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐森"/> <meta itemprop="url" content="https://juejin.cn/user/4455643804079608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust 的CPU和IO操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4455643804079608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T05:29:44.000Z" title="Sun Dec 21 2025 05:29:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">纯 CPU —— 并行质数寻找器 (Parallel Prime Finder)</h3>
<p><strong>目标：</strong>  找出 1 到 10,000,000 (一千万) 之间的所有质数。 <strong>核心逻辑：</strong>  这是一个纯计算任务。判断一个数是不是质数，需要大量的除法运算，CPU 必须一直在转。 <strong>工具：</strong>  这里我们<strong>不用 Tokio</strong>。对于纯 CPU 任务，Rust 社区最常用的库是 <strong><code>Rayon</code></strong>。它能把你的 <code>for</code> 循环自动变成并行的。</p>
<p><strong>Cargo.toml:</strong></p>
<p>Ini, TOML</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">rayon</span> = <span class="hljs-string">"1.8"</span> 
</code></pre>
<p><strong>main.rs:</strong></p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> rayon::prelude::*; <span class="hljs-comment">// 引入 Rayon 的并行迭代器功能</span>

<span class="hljs-comment">// 一个非常笨重、耗费 CPU 的函数：判断 n 是否为质数</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">is_prime</span>(n: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> {
    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    <span class="hljs-comment">// 笨办法：从 2 遍历到 sqrt(n)，疯狂做除法</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">limit</span> = (n <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>).<span class="hljs-title function_ invoke__">sqrt</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span>;
    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">2</span>..=limit {
        <span class="hljs-keyword">if</span> n % i == <span class="hljs-number">0</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">limit</span> = <span class="hljs-number">10_000_000</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"--- 开始寻找 1 到 {} 之间的质数 ---"</span>, limit);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">start_time</span> = std::time::Instant::<span class="hljs-title function_ invoke__">now</span>();

    <span class="hljs-comment">// 方式 A: 单线程写法 (对比组)</span>
    <span class="hljs-comment">// 只要把下面的 par_iter() 改成 iter() 就是单线程</span>
    <span class="hljs-comment">// let count = (1..limit).filter(|&amp;n| is_prime(n)).count();</span>

    <span class="hljs-comment">// 方式 B: 并行写法 (Rayon)</span>
    <span class="hljs-comment">// par_iter() 会自动把 1..limit 切成好几块，分发给所有的 CPU 核</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">count</span> = (<span class="hljs-number">1</span>..limit)
        .<span class="hljs-title function_ invoke__">into_par_iter</span>() <span class="hljs-comment">// &lt;--- 魔法在这里！变成并行迭代器</span>
        .<span class="hljs-title function_ invoke__">filter</span>(|&amp;n| <span class="hljs-title function_ invoke__">is_prime</span>(n)) <span class="hljs-comment">// 这会在多个核上同时跑</span>
        .<span class="hljs-title function_ invoke__">count</span>();

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"找到 {} 个质数"</span>, count);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"--- 计算结束，耗时: {:?} ---"</span>, start_time.<span class="hljs-title function_ invoke__">elapsed</span>());
}
</code></pre>
<p><strong>练习重点：</strong></p>
<ol>
<li>
<p><strong>观察 CPU：</strong>  运行这个程序时，打开你的任务管理器/活动监视器。你会看到 CPU 占用率瞬间飙升到 100%（所有核都被吃满了）。</p>
</li>
<li>
<p><strong>对比试验：</strong>  试着把 <code>.into_par_iter()</code> 改回普通的 <code>.into_iter()</code>。</p>
<ul>
<li><strong>并行版：</strong>  可能只要 1-2 秒（取决于你的核数）。</li>
<li><strong>单线程版：</strong>  可能需要 5-8 秒。</li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2882d6c1cddf4a63bdf3659c3d5cb5f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5qOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766899784&amp;x-signature=qbDWERjXdN9FOPjni8N%2FDMdEG4I%3D" alt="8939d65c92a156e0b5e8a1b94ae6908e.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db4eebb2ecc74979a4297e16b0c73f93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5qOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766899784&amp;x-signature=OXQRF516Hd6jEqlQht%2BLNVm5wV8%3D" alt="0be753bfd229fe6d3bac6a63e6febe04.jpg" loading="lazy"/></p>
<h2 data-id="heading-1">磁盘 I/O 是<strong>实打实能看到硬盘读写飙升</strong>的。</h2>
<p>我们来做一个  <strong>“极速文件备份引擎” (Async File Replicator)</strong> 。</p>
<h3 data-id="heading-2">核心目标</h3>
<ol>
<li><strong>场景：</strong>  模拟你有一堆巨大的日志文件（比如 50 个 100MB 的文件），需要从 A 文件夹备份到 B 文件夹。</li>
<li><strong>挑战：</strong>  也就是通常说的“拷贝文件”。如果是单线程，是一个个拷；我们要用 <code>tokio</code> 并发拷，看能不能把你的 SSD 吞吐量打满。</li>
<li><strong>观测：</strong>  教你如何用系统工具监控这个过程。</li>
</ol>
<hr/>
<h3 data-id="heading-3">第一步：先学会“看” I/O (监控工具)</h3>
<p>在跑代码之前，先把监控面板打开，这样代码一跑，你就能看到波形图跳起来。</p>
<h4 data-id="heading-4">1. Windows 用户</h4>
<ul>
<li><strong>基础版：</strong>  打开 <strong>任务管理器 (Task Manager)</strong>  -&gt; <strong>性能 (Performance)</strong>  -&gt; 点击 <strong>磁盘 (Disk)</strong> 。关注  <strong>“活动时间 (Active time)”</strong>  和  <strong>“磁盘传输速率 (Transfer Rate)”</strong> 。</li>
<li><strong>进阶版 (推荐)：</strong>  Win + R 输入 <code>resmon</code> 打开 <strong>资源监视器</strong>。点击 <strong>磁盘</strong> 选项卡。这里能看到具体是哪个 <code>exe</code> 在读写，以及读写了哪个文件。</li>
</ul>
<h4 data-id="heading-5">2. macOS 用户</h4>
<ul>
<li>打开 <strong>活动监视器 (Activity Monitor)</strong>  (Cmd + Space 搜索 Activity Monitor)。</li>
<li>点击底部的  <strong>“磁盘 (Disk)”</strong>  标签页。</li>
<li>关注底部的  <strong>“数据读取/秒 (Data read/sec)”</strong>  和  <strong>“数据写入/秒 (Data written/sec)”</strong> 。你会看到这两个数字瞬间飙升。</li>
</ul>
<h4 data-id="heading-6">3. Linux 用户</h4>
<ul>
<li>在终端输入 <code>iotop</code> (需要 sudo)。你会看到实时的磁盘 I/O 排行榜。</li>
</ul>
<hr/>
<h3 data-id="heading-7">第二步：项目代码 —— 极速备份引擎</h3>
<p>这个项目分为两部分：</p>
<ol>
<li><strong>生成器：</strong>  快速生成一堆垃圾文件用来测试。</li>
<li><strong>备份器：</strong>  使用 Tokio 并发复制。</li>
</ol>
<p><strong>Cargo.toml:</strong></p>
<p>Ini, TOML</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">tokio</span> = { version = <span class="hljs-string">"1"</span>, features = [<span class="hljs-string">"full"</span>] }
<span class="hljs-attr">rand</span> = <span class="hljs-string">"0.8"</span> <span class="hljs-comment"># 用来生成随机文件名或内容（可选，这里其实只用0填充也行）</span>
</code></pre>
<p><strong>main.rs:</strong></p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::path::Path;
<span class="hljs-keyword">use</span> tokio::fs;
<span class="hljs-keyword">use</span> tokio::io::AsyncWriteExt;
<span class="hljs-keyword">use</span> tokio::time::Instant;
<span class="hljs-keyword">use</span> std::sync::Arc;
<span class="hljs-keyword">use</span> tokio::sync::Semaphore;

<span class="hljs-comment">// 设定测试规模</span>
<span class="hljs-keyword">const</span> FILE_COUNT: <span class="hljs-type">usize</span> = <span class="hljs-number">20</span>;       <span class="hljs-comment">// 文件数量</span>
<span class="hljs-keyword">const</span> FILE_SIZE_MB: <span class="hljs-type">usize</span> = <span class="hljs-number">50</span>;     <span class="hljs-comment">// 每个文件 50MB (总共 1GB)</span>
<span class="hljs-keyword">const</span> SOURCE_DIR: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">"./source_data"</span>;
<span class="hljs-keyword">const</span> TARGET_DIR: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">"./backup_data"</span>;

<span class="hljs-meta">#[tokio::main]</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> std::error::Error&gt;&gt; {
    <span class="hljs-comment">// --- 准备工作 ---</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"--- 阶段 1: 准备测试数据 ---"</span>);
    <span class="hljs-title function_ invoke__">prepare_directories</span>().<span class="hljs-keyword">await</span>?;
    <span class="hljs-title function_ invoke__">generate_dummy_files</span>().<span class="hljs-keyword">await</span>?;

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"\n请现在打开你的【活动监视器/任务管理器/iotop】... 3秒后开始疯狂拷贝"</span>);
    tokio::time::<span class="hljs-title function_ invoke__">sleep</span>(tokio::time::Duration::<span class="hljs-title function_ invoke__">from_secs</span>(<span class="hljs-number">3</span>)).<span class="hljs-keyword">await</span>;

    <span class="hljs-comment">// --- 核心工作: 异步并发拷贝 ---</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"--- 阶段 2: 开始极速备份 ---"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">start</span> = Instant::<span class="hljs-title function_ invoke__">now</span>();

    <span class="hljs-comment">// 限制并发数：虽然是 I/O，但如果不限制，瞬间打开几千个文件句柄会报错</span>
    <span class="hljs-comment">// 同时也为了观察持续的 I/O 压力，而不是一瞬间结束</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">semaphore</span> = Arc::<span class="hljs-title function_ invoke__">new</span>(Semaphore::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">5</span>)); 
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tasks</span> = <span class="hljs-built_in">vec!</span>[];

    <span class="hljs-comment">// 读取源目录</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">entries</span> = fs::<span class="hljs-title function_ invoke__">read_dir</span>(SOURCE_DIR).<span class="hljs-keyword">await</span>?;

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(entry) = entries.<span class="hljs-title function_ invoke__">next_entry</span>().<span class="hljs-keyword">await</span>? {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">path</span> = entry.<span class="hljs-title function_ invoke__">path</span>();
        <span class="hljs-keyword">if</span> path.<span class="hljs-title function_ invoke__">is_file</span>() {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">sem_clone</span> = semaphore.<span class="hljs-title function_ invoke__">clone</span>();
            
            <span class="hljs-comment">// 开启一个异步任务去拷贝这个文件</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">task</span> = tokio::<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">move</span> {
                <span class="hljs-comment">// 获取令牌</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_permit</span> = sem_clone.<span class="hljs-title function_ invoke__">acquire</span>().<span class="hljs-keyword">await</span>.<span class="hljs-title function_ invoke__">unwrap</span>();
                
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_name</span> = path.<span class="hljs-title function_ invoke__">file_name</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">to_str</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">target_path</span> = Path::<span class="hljs-title function_ invoke__">new</span>(TARGET_DIR).<span class="hljs-title function_ invoke__">join</span>(file_name);

                <span class="hljs-comment">// ⚠️ 核心 I/O 操作：tokio::fs::copy</span>
                <span class="hljs-comment">// 这行代码底层会利用 OS 的异步文件接口</span>
                <span class="hljs-keyword">match</span> fs::<span class="hljs-title function_ invoke__">copy</span>(&amp;path, &amp;target_path).<span class="hljs-keyword">await</span> {
                    <span class="hljs-title function_ invoke__">Ok</span>(bytes) =&gt; {
                        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"✅ 已备份: {} ({:.2} MB)"</span>, file_name, bytes <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span> / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024.0</span>);
                    }
                    <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; eprintln!(<span class="hljs-string">"❌ 失败 {}: {}"</span>, file_name, e),
                }
                <span class="hljs-comment">// 令牌自动释放</span>
            });
            tasks.<span class="hljs-title function_ invoke__">push</span>(task);
        }
    }

    <span class="hljs-comment">// 等待所有拷贝任务完成</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">task</span> <span class="hljs-keyword">in</span> tasks {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = task.<span class="hljs-keyword">await</span>;
    }

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">duration</span> = start.<span class="hljs-title function_ invoke__">elapsed</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">total_size_mb</span> = (FILE_COUNT * FILE_SIZE_MB) <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">speed</span> = total_size_mb / duration.<span class="hljs-title function_ invoke__">as_secs_f64</span>();

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"\n--- 备份完成 ---"</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"耗时: {:.2?}"</span>, duration);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"平均吞吐量: {:.2} MB/s"</span>, speed);
    
    <span class="hljs-comment">// 清理现场（可选）</span>
    <span class="hljs-comment">// fs::remove_dir_all(SOURCE_DIR).await?;</span>
    <span class="hljs-comment">// fs::remove_dir_all(TARGET_DIR).await?;</span>

    <span class="hljs-title function_ invoke__">Ok</span>(())
}

<span class="hljs-comment">// 辅助函数：生成垃圾文件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">generate_dummy_files</span>() <span class="hljs-punctuation">-&gt;</span> std::io::<span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-comment">// 创建一个 全是 0 的 50MB 缓冲区</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">buffer</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; FILE_SIZE_MB * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];

    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..FILE_COUNT {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_path</span> = Path::<span class="hljs-title function_ invoke__">new</span>(SOURCE_DIR).<span class="hljs-title function_ invoke__">join</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"log_{}.dat"</span>, i));
        <span class="hljs-keyword">if</span> !file_path.<span class="hljs-title function_ invoke__">exists</span>() {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"生成测试文件: log_{}.dat ..."</span>, i);
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">file</span> = fs::File::<span class="hljs-title function_ invoke__">create</span>(file_path).<span class="hljs-keyword">await</span>?;
            file.<span class="hljs-title function_ invoke__">write_all</span>(&amp;buffer).<span class="hljs-keyword">await</span>?;
        }
    }
    <span class="hljs-title function_ invoke__">Ok</span>(())
}

<span class="hljs-comment">// 辅助函数：创建目录</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">prepare_directories</span>() <span class="hljs-punctuation">-&gt;</span> std::io::<span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-keyword">if</span> !Path::<span class="hljs-title function_ invoke__">new</span>(SOURCE_DIR).<span class="hljs-title function_ invoke__">exists</span>() {
        fs::<span class="hljs-title function_ invoke__">create_dir</span>(SOURCE_DIR).<span class="hljs-keyword">await</span>?;
    }
    <span class="hljs-keyword">if</span> Path::<span class="hljs-title function_ invoke__">new</span>(TARGET_DIR).<span class="hljs-title function_ invoke__">exists</span>() {
        fs::<span class="hljs-title function_ invoke__">remove_dir_all</span>(TARGET_DIR).<span class="hljs-keyword">await</span>?;
    }
    fs::<span class="hljs-title function_ invoke__">create_dir</span>(TARGET_DIR).<span class="hljs-keyword">await</span>?;
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ee40f4912764679a82ee919d0289abd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5qOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766899784&amp;x-signature=8LhsYkw3gwAGB3chTJX0gwA%2FAMM%3D" alt="69632d5619c1d1413d2d3a8d3f0a7618.jpg" loading="lazy"/></p>
<ol>
<li>
<p><strong>文件系统的 Async I/O:</strong></p>
<ul>
<li><code>tokio::fs</code> 模块里的 API (<code>read_dir</code>, <code>copy</code>, <code>File::create</code>) 和标准库 <code>std::fs</code> 长得几乎一样，但它们全是 <strong>非阻塞</strong> 的。</li>
<li>当你调用 <code>fs::copy</code> 时，如果硬盘忙不过来，Tokio 线程会去处理别的任务，而不是干等着。</li>
</ul>
</li>
<li>
<p><strong>观察系统瓶颈:</strong></p>
<ul>
<li>当你运行这个程序时，盯着你的任务管理器。</li>
<li><strong>如果是机械硬盘 (HDD):</strong>  你的吞吐量可能只有 100MB/s，而且你会听到硬盘疯狂寻道的声音（磁头在源文件和目标文件之间来回跳）。</li>
<li><strong>如果是固态硬盘 (NVMe SSD):</strong>  你可能会看到 1GB/s - 2GB/s 的惊人速度，瞬间跑完。</li>
</ul>
</li>
<li>
<p><strong>并发控制 (Semaphore) 的重要性:</strong></p>
<ul>
<li>试着把 <code>Semaphore::new(5)</code> 改成 <code>Semaphore::new(100)</code>。</li>
<li>如果在机械硬盘上，速度<strong>反而会变慢</strong>。因为磁头来回跳跃（随机读写）的开销太大了，不如排队顺序读写（顺序 I/O）快。</li>
<li>这就是为什么即便用了异步，我们依然需要<strong>限流</strong>。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[12 Go Eino AI应用开发实战 | 消息队列架构]]></title>    <link>https://juejin.cn/post/7585412203979030571</link>    <guid>https://juejin.cn/post/7585412203979030571</guid>    <pubDate>2025-12-20T09:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203979030571" data-draft-id="7585397173023195155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="12 Go Eino AI应用开发实战 | 消息队列架构"/> <meta itemprop="keywords" content="人工智能,Go,后端"/> <meta itemprop="datePublished" content="2025-12-20T09:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            12 Go Eino AI应用开发实战 | 消息队列架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:51:17.000Z" title="Sat Dec 20 2025 09:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>声明：本AI应用开发系列教程首发在同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5DYsyMKh9cDJdVvs_Mn9_Q" target="_blank" title="https://mp.weixin.qq.com/s/5DYsyMKh9cDJdVvs_Mn9_Q" ref="nofollow noopener noreferrer">王中阳</a>，未经授权禁止转载。</p>
</blockquote>
<p>Go-Eino Interview Agent 平台中的消息队列架构实现了一个异步处理系统，旨在处理评估报告生成和主题评估任务。该架构提供可靠的消息传递、可扩展的处理能力以及灵活的后端实现。</p>
<h2 data-id="heading-0">核心架构概述</h2>
<p>消息队列系统采用生产者-消费者模式，支持可插拔的后端实现。它既支持用于开发/测试的内存队列，也支持用于生产环境的 Redis 队列。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5570ebf622a74be6ab42619e23940e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766829077&amp;x-signature=oJG%2F4tAgZA7VWroKdDqXnfdnXbk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">消息队列接口设计</h2>
<p>系统通过 <code>MessageQueue</code> 接口 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fmq.go%23L40-L48" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/mq.go#L40-L48" ref="nofollow noopener noreferrer">backend/internal/mq/mq.go#L40-L48</a> 定义了清晰的抽象：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> MessageQueue <span class="hljs-keyword">interface</span> {
    Publish(ctx context.Context, message *Message) <span class="hljs-type">error</span>
    Subscribe(ctx context.Context, handler MessageHandler) <span class="hljs-type">error</span>
    Close() <span class="hljs-type">error</span>
}
</code></pre>
<p>该接口实现了不同队列实现之间的无缝切换，同时保持整个应用程序的行为一致性。</p>
<h2 data-id="heading-2">消息类型和结构</h2>
<p>系统支持两种主要消息类型 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fmq.go%23L12-L20" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/mq.go#L12-L20" ref="nofollow noopener noreferrer">backend/internal/mq/mq.go#L12-L20</a>：</p>




















<table><thead><tr><th>消息类型</th><th>用途</th><th>负载结构</th></tr></thead><tbody><tr><td><code>evaluation_report</code></td><td>生成综合评估报告</td><td><code>EvaluationReportPayload{UserID, ReportID}</code></td></tr><tr><td><code>topic_evaluation</code></td><td>处理特定主题评估</td><td><code>TopicEvaluationPayload{UserID, ReportID}</code></td></tr></tbody></table>
<p>每条消息遵循标准化结构 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fmq.go%23L22-L27" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/mq.go#L22-L27" ref="nofollow noopener noreferrer">backend/internal/mq/mq.go#L22-L27</a>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Message <span class="hljs-keyword">struct</span> {
    Type    MessageType            <span class="hljs-string">`json:"type"`</span>
    Payload <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{} <span class="hljs-string">`json:"payload"`</span>
}
</code></pre>
<h2 data-id="heading-3">实现策略</h2>
<h3 data-id="heading-4">内存队列实现</h3>
<p><code>InMemoryQueue</code> 为开发和测试环境提供了轻量级解决方案 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fmq.go%23L53-L125" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/mq.go#L53-L125" ref="nofollow noopener noreferrer">backend/internal/mq/mq.go#L53-L125</a>。主要特点：</p>
<ul>
<li><strong>缓冲区管理</strong>：可配置的缓冲区大小，默认为 100 条消息</li>
<li><strong>并发处理</strong>：多个处理器异步处理消息</li>
<li><strong>优雅关闭</strong>：正确清理通道和 goroutine</li>
</ul>
<p>内存实现使用缓冲通道防止高频消息发布时的阻塞，而基于 goroutine 的处理确保了非阻塞的消息处理。</p>
<h3 data-id="heading-5">Redis 队列实现</h3>
<p>对于生产环境，<code>RedisQueue</code> 利用 Redis Pub/Sub 实现分布式消息处理 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fredis_queue.go%23L13-L132" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/redis_queue.go#L13-L132" ref="nofollow noopener noreferrer">backend/internal/mq/redis_queue.go#L13-L132</a>：</p>
<p><strong>主要特性</strong>：</p>
<ul>
<li><strong>基于通道的路由</strong>：消息根据类型路由到特定通道</li>
<li><strong>多个订阅者</strong>：支持多个消费者实例</li>
<li><strong>持久连接</strong>：通过正确清理维持稳定的 Redis 连接</li>
</ul>
<h2 data-id="heading-6">消费者处理架构</h2>
<p>消费者系统通过 <code>ConsumerHandler</code> <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fconsumer.go%23L10-L89" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/consumer.go#L10-L89" ref="nofollow noopener noreferrer">backend/internal/mq/consumer.go#L10-L89</a> 实现了健壮的消息处理管道：</p>
<h3 data-id="heading-7">消息处理流程</h3>
<ol>
<li><strong>消息路由</strong>：使用 switch 语句根据类型路由消息</li>
<li><strong>负载验证</strong>：从负载中类型安全地提取 userID 和 reportID</li>
<li><strong>服务集成</strong>：调用评估服务进行实际处理</li>
<li><strong>错误处理</strong>：全面的日志记录和错误传播</li>
</ol>
<h3 data-id="heading-8">评估服务集成</h3>
<p>消费者与两个关键评估服务集成：</p>
<ul>
<li><strong>GenerateRecordEvaluation</strong>：生成综合面试评估 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fconsumer.go%23L42" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/consumer.go#L42" ref="nofollow noopener noreferrer">backend/internal/mq/consumer.go#L42</a></li>
<li><strong>GenerateAnswerRecordEvaluation</strong>：处理主题特定评估 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fconsumer.go%23L71" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/consumer.go#L71" ref="nofollow noopener noreferrer">backend/internal/mq/consumer.go#L71</a></li>
</ul>
<h2 data-id="heading-9">初始化和生命周期管理</h2>
<p>系统在主应用程序中实现了正确的初始化模式 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Fmain.go%23L79-L95" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/main.go#L79-L95" ref="nofollow noopener noreferrer">backend/main.go#L79-L95</a>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 初始化 Redis 消息队列</span>
messageQueue := mq.NewRedisQueue(redisClient)
mq.InitMessageQueue(messageQueue)
 
<span class="hljs-comment">// 在单独的 goroutine 中启动消费者</span>
<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> err := mq.StartConsumer(consumerCtx); err != <span class="hljs-literal">nil</span> {
        log.Printf(<span class="hljs-string">"Error starting consumer: %v"</span>, err)
    }
}()
</code></pre>
<p>消费者在单独的 goroutine 中运行，使用可取消的上下文，在应用程序终止时实现优雅关闭和正确的资源清理。</p>
<h2 data-id="heading-10">发布模式</h2>
<p>系统提供了便捷的发布函数，抽象了队列实现细节：</p>
<h3 data-id="heading-11">评估报告发布</h3>
<p><code>PublishEvaluationReport</code> 函数处理完整的发布工作流 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fmq.go%23L155-L186" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/mq.go#L155-L186" ref="nofollow noopener noreferrer">backend/internal/mq/mq.go#L155-L186</a>：</p>
<ol>
<li><strong>负载构建</strong>：创建类型化负载结构</li>
<li><strong>序列化</strong>：转换为 JSON 然后转换为通用映射</li>
<li><strong>消息创建</strong>：包装在标准 Message 结构中</li>
<li><strong>队列发布</strong>：通过全局消息队列实例路由</li>
</ol>
<h3 data-id="heading-12">主题评估发布</h3>
<p>类似地，<code>PublishTopicEvaluation</code> 为主题评估消息提供了专门的接口 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fmq.go%23L188-L209" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/mq.go#L188-L209" ref="nofollow noopener noreferrer">backend/internal/mq/mq.go#L188-L209</a>。</p>
<h2 data-id="heading-13">错误处理和监控</h2>
<p>系统在整个消息管道中实现了全面的错误处理和日志记录：</p>
<ul>
<li><strong>发布时验证</strong>：检查队列可用性和序列化错误</li>
<li><strong>消费者错误隔离</strong>：单个消息处理失败不影响其他消息</li>
<li><strong>详细日志</strong>：在消息处理的每个阶段进行全面日志记录</li>
<li><strong>优雅降级</strong>：如果 Redis 不可用则回退到内存队列</li>
</ul>
<h2 data-id="heading-14">性能考虑</h2>
<h3 data-id="heading-15">并发处理</h3>
<p>两种实现都通过基于 goroutine 的处理器执行支持并发消息处理 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwangzhongyang.com%2Fgo-eino-interview-agent%2Fbackend%2Finternal%2Fmq%2Fmq.go%23L108-L113" target="_blank" title="http://wangzhongyang.com/go-eino-interview-agent/backend/internal/mq/mq.go#L108-L113" ref="nofollow noopener noreferrer">backend/internal/mq/mq.go#L108-L113</a>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">for</span> _, handler := <span class="hljs-keyword">range</span> q.handlers {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(h MessageHandler, msg *Message)</span></span> {
        <span class="hljs-keyword">if</span> err := h(ctx, msg); err != <span class="hljs-literal">nil</span> {
            log.Printf(<span class="hljs-string">"[MQ] Error processing message: %v, type: %s"</span>, err, msg.Type)
        }
    }(handler, message)
}
</code></pre>
<h3 data-id="heading-16">资源管理</h3>
<p>系统实现了正确的资源清理模式：</p>
<ul>
<li><strong>通道管理</strong>：缓冲通道防止内存泄漏</li>
<li><strong>上下文取消</strong>：为长时间运行的操作提供正确的关闭信号</li>
<li><strong>Redis 连接管理</strong>：外部 Redis 客户端生命周期单独管理</li>
</ul>
<h2 data-id="heading-17">集成点</h2>
<p>消息队列架构与几个关键系统组件集成：</p>
<ul>
<li><strong>API 层</strong>：REST 端点触发消息发布</li>
<li><strong>评估服务</strong>：面试评估的异步处理</li>
<li><strong>数据库层</strong>：评估结果的持久化存储</li>
<li><strong>配置系统</strong>：队列类型选择和连接参数</li>
</ul>
<p>该架构为可扩展的异步处理提供了坚实的基础，同时为不同的部署场景和未来增强保持了灵活性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG实战|8种RAG架构浅析]]></title>    <link>https://juejin.cn/post/7585390679399333894</link>    <guid>https://juejin.cn/post/7585390679399333894</guid>    <pubDate>2025-12-20T07:02:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679399333894" data-draft-id="7585382553290686500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG实战|8种RAG架构浅析"/> <meta itemprop="keywords" content="AIGC,LangChain"/> <meta itemprop="datePublished" content="2025-12-20T07:02:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周末程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056989757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG实战|8种RAG架构浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056989757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周末程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:02:08.000Z" title="Sat Dec 20 2025 07:02:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>因为项目的需要，之前研究了一段时间的<code>RAG</code>，于是本文总结 8 种 <code>RAG</code> 架构，对每种架构进行简要介绍，并用 <code>langchain</code> 实现其参考代码。</p>
<h2 data-id="heading-0">1. Naive RAG</h2>
<p><strong>简介：</strong></p>
<p>Naive RAG 是最基础的检索增强生成架构，采用“索引-检索-生成”的经典流程。<strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a791bbe7f4524e51b74053ad63de110f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=ku0AJbn3D7xRqqygvjDvDp5jEfs%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>数据加载 ：收集数据并进行清洗，比如各个文档格式的转换，OCR 文字提取等</li>
<li>分块和 embedding ：将文档拆分更小的 chunk，一方面让 embedding 更好转换语义信息，另一方面解决LLM的上下文长度限制问题</li>
<li>向量存储：将 embedding 存储到向量数据库中，方便快速搜索</li>
<li>search 和 Prompt工程：对于查找的问题先通过向量数据库检索，然后将召回的文件原文，通过 Prompt 加工提供给LLM</li>
<li>输出答案：LLM 根据 Prompt 生成答案输出</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">import</span> lancedb

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NaiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_naive_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span></span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"naive_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行检索并生成答案"""</span>
        <span class="hljs-comment"># 创建检索链</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
        
        prompt_template = PromptTemplate(
            input_variables=[<span class="hljs-string">"context"</span>, <span class="hljs-string">"question"</span>],
            template=<span class="hljs-string">"""基于以下上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        
        qa_chain = RetrievalQA.from_chain_type(
            llm=self.llm,
            chain_type=<span class="hljs-string">"stuff"</span>,
            retriever=retriever,
            chain_type_kwargs={<span class="hljs-string">"prompt"</span>: prompt_template}
        )
        
        <span class="hljs-keyword">return</span> qa_chain.invoke({<span class="hljs-string">"query"</span>: question})[<span class="hljs-string">"result"</span>]

<span class="hljs-comment"># 使用示例</span>
naive_rag = NaiveRAG()
naive_rag.build_index([<span class="hljs-string">"文档1内容..."</span>, <span class="hljs-string">"文档2内容..."</span>, <span class="hljs-string">"文档3内容..."</span>])
answer = naive_rag.query(<span class="hljs-string">"What is issue date of lease?"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-1">2. Multi-Head RAG</h2>
<p><strong>简介：</strong></p>
<p>Multi-Head RAG 借鉴了 Transformer 的多头注意力机制，利用模型不同注意力头捕获的多样化语义特征进行并行检索。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d889c3e8cf46d9a2bf9be204b3dbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=YUXFtx%2FXAO9Q0PjbKx6buyMl9UY%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>多头注意力Embedding：利用 Transformer 模型的多头注意力层（而非最后一层）生成多个embedding，每个头捕获不同的语义特征</li>
<li>多向量索引构建：为每个注意力头构建独立的向量索引，存储不同维度的语义信息</li>
<li>并行检索：针对查询，在多个索引上并行检索，每个头返回最相关的文档片段</li>
<li>结果融合：将多个头的检索结果进行去重和融合，综合考虑不同语义维度的相关性</li>
<li>上下文生成：将融合后的文档片段组装成上下文，输入LLM生成答案</li>
</ul>
<p><strong>相关参考如下：</strong></p>
<p>论文：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2406.05085" target="_blank" title="https://arxiv.org/pdf/2406.05085" ref="nofollow noopener noreferrer">arxiv.org/pdf/2406.05…</a></p>
<p>代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspcl%2FMRAG" target="_blank" title="https://github.com/spcl/MRAG" ref="nofollow noopener noreferrer">github.com/spcl/MRAG</a></p>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.embeddings.base <span class="hljs-keyword">import</span> Embeddings
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModel, AutoTokenizer
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadEmbeddings</span>(<span class="hljs-title class_ inherited__">Embeddings</span>):
    <span class="hljs-string">"""自定义多头注意力Embedding，继承LangChain的Embeddings基类"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_name=<span class="hljs-string">"bert-base-uncased"</span>, head_index=<span class="hljs-number">0</span>, num_heads=<span class="hljs-number">12</span></span>):
        self.tokenizer = AutoTokenizer.from_pretrained(model_name)
        self.model = AutoModel.from_pretrained(model_name, output_hidden_states=<span class="hljs-literal">True</span>)
        self.head_index = head_index
        self.num_heads = num_heads
        self.head_dim = <span class="hljs-number">768</span> // num_heads  <span class="hljs-comment"># BERT hidden size / num_heads</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_head_embedding</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
        <span class="hljs-string">"""获取指定头的embedding"""</span>
        inputs = self.tokenizer(texts, return_tensors=<span class="hljs-string">"pt"</span>, padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">with</span> torch.no_grad():
            outputs = self.model(**inputs, output_hidden_states=<span class="hljs-literal">True</span>)
        hidden_states = outputs.hidden_states[-<span class="hljs-number">2</span>]  <span class="hljs-comment"># 倒数第二层</span>
        start = self.head_index * self.head_dim
        end = (self.head_index + <span class="hljs-number">1</span>) * self.head_dim
        head_emb = hidden_states[:, <span class="hljs-number">0</span>, start:end].numpy()
        <span class="hljs-keyword">return</span> head_emb.tolist()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">embed_documents</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
        <span class="hljs-keyword">return</span> self._get_head_embedding(texts)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">embed_query</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]:
        <span class="hljs-keyword">return</span> self._get_head_embedding([text])[<span class="hljs-number">0</span>]

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_heads=<span class="hljs-number">12</span></span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.num_heads = num_heads
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_multihead_rag"</span>)
        self.vectorstores = []  <span class="hljs-comment"># 每个头一个向量存储</span>
        self.documents = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""为每个头构建独立的LanceDB向量存储"""</span>
        self.documents = documents
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        
        <span class="hljs-keyword">for</span> head_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_heads):
            embeddings = MultiHeadEmbeddings(head_index=head_idx, num_heads=self.num_heads)
            vectorstore = LanceDB.from_documents(
                docs, 
                embeddings,
                connection=self.db,
                table_name=<span class="hljs-string">f"head_<span class="hljs-subst">{head_idx}</span>_docs"</span>
            )
            self.vectorstores.append(vectorstore)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""多头并行检索并融合结果"""</span>
        all_results = <span class="hljs-built_in">set</span>()
        <span class="hljs-keyword">for</span> vectorstore <span class="hljs-keyword">in</span> self.vectorstores:
            docs = vectorstore.similarity_search(query, k=top_k)
            <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
                all_results.add(doc.page_content)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(all_results)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""检索并生成答案"""</span>
        retrieved_docs = self.search(question)
        context = <span class="hljs-string">"\n\n"</span>.join(retrieved_docs)
        
        <span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下多维度检索的上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm
        response = chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})
        <span class="hljs-keyword">return</span> response.content

<span class="hljs-comment"># 使用示例</span>
mrag = MultiHeadRAG(num_heads=<span class="hljs-number">12</span>)
documents = [<span class="hljs-string">"文档1的内容..."</span>, <span class="hljs-string">"文档2的内容..."</span>, <span class="hljs-string">"文档3的内容..."</span>]
mrag.build_index(documents)
answer = mrag.query(<span class="hljs-string">"查询问题"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-2">3. Corrective RAG</h2>
<p><strong>简介：</strong></p>
<p>Corrective RAG 在传统 RAG 基础上引入了文档质量评估和自我修正机制。对检索到的每个文档进行相关性评分（Correct/Incorrect/Ambiguous），对于质量不足的检索结果，搜索外部知识源进行补充。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe0109c62e3e43f68ce49846a9450b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=Wei8vQwsNIC1FczlF8K80NbNPsE%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>初始检索：使用向量检索获取与查询相关的候选文档</li>
<li>相关性评估：使用LLM或专门的评估模型对每个检索到的文档进行相关性评分（Correct/Incorrect/Ambiguous）</li>
<li>知识修正：对于评估为不相关或模糊的文档，触发知识修正机制</li>
<li>网络搜索增强：当本地知识库文档质量不足时，调用外部搜索引擎获取补充信息</li>
<li>文档重组：将评估为相关的文档和补充搜索结果重新组织，去除冗余信息</li>
<li>答案生成：基于修正后的高质量上下文生成最终答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain_community.tools <span class="hljs-keyword">import</span> TavilySearchResults
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CorrectiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_corrective_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        <span class="hljs-comment"># 使用Tavily进行网络搜索</span>
        self.web_search = TavilySearchResults(max_results=<span class="hljs-number">3</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"corrective_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""评估文档与查询的相关性"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估以下文档与查询的相关性。
            查询: {query}
            文档: {document}
            
            请回答: CORRECT(相关), INCORRECT(不相关), 或 AMBIGUOUS(模糊)
            只返回一个词。"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
        <span class="hljs-keyword">return</span> response.strip().upper()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search_web</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""当本地文档不足时进行网络搜索"""</span>
        <span class="hljs-keyword">try</span>:
            results = self.web_search.invoke(query)
            <span class="hljs-keyword">return</span> [r[<span class="hljs-string">"content"</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span><span class="hljs-string">"content"</span><span class="hljs-keyword">in</span> r]
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_and_correct</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""检索并修正文档"""</span>
        <span class="hljs-comment"># 1. 初始检索</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: top_k})
        docs = retriever.invoke(query)
        
        <span class="hljs-comment"># 2. 评估每个文档的相关性</span>
        correct_docs = []
        need_web_search = <span class="hljs-literal">True</span>
        
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
            relevance = self.evaluate_relevance(query, doc.page_content)
            <span class="hljs-keyword">if</span> relevance == <span class="hljs-string">"CORRECT"</span>:
                correct_docs.append(doc.page_content)
                need_web_search = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">elif</span> relevance == <span class="hljs-string">"AMBIGUOUS"</span>:
                <span class="hljs-comment"># 对模糊文档进行知识精炼</span>
                refined = self.refine_document(query, doc.page_content)
                correct_docs.append(refined)
        
        <span class="hljs-comment"># 3. 必要时进行网络搜索补充</span>
        <span class="hljs-keyword">if</span> need_web_search <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(correct_docs) &lt; <span class="hljs-number">2</span>:
            web_results = self.search_web(query)
            correct_docs.extend(web_results)
        
        <span class="hljs-keyword">return</span> correct_docs
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">refine_document</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""精炼文档，提取与查询相关的部分"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""从以下文档中提取与查询最相关的信息：
            查询: {query}
            文档: {document}
            
            请只返回相关的精炼内容："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成最终答案"""</span>
        corrected_docs = self.retrieve_and_correct(question)
        context = <span class="hljs-string">"\n\n"</span>.join(corrected_docs)
        
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下经过修正的上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})

<span class="hljs-comment"># 使用示例</span>
crag = CorrectiveRAG()
crag.build_index([<span class="hljs-string">"文档1..."</span>, <span class="hljs-string">"文档2..."</span>, <span class="hljs-string">"文档3..."</span>])
answer = crag.query(<span class="hljs-string">"你的问题是什么？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-3">4. Agentic RAG</h2>
<p><strong>简介：</strong></p>
<p>Agentic RAG（智能体RAG）将 AI Agent 的规划和推理能力与 RAG 相结合。<br/>
Agent 可以自主分析查询、制定检索策略、选择合适的工具（语义搜索、关键词搜索、计算器等），并根据中间结果进行迭代优化。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d4ac2fafbf4f2f8a4549436c5adc3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=nzUF6IDJ6xHC4IINPGVnM04N3Ig%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>Agent初始化：创建具有推理和规划能力的AI Agent，配备检索工具</li>
<li>任务分解：Agent分析用户查询，将复杂问题分解为多个子任务</li>
<li>工具选择：Agent根据子任务特点选择合适的工具（检索、计算、API调用等）</li>
<li>迭代检索：Agent可以根据中间结果决定是否需要进一步检索或调整查询策略</li>
<li>推理整合：Agent对多轮检索和工具调用的结果进行推理和整合</li>
<li>自我反思：Agent评估答案质量，必要时进行自我修正</li>
<li>最终输出：生成完整、准确的答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgenticRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_agentic_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        self.agent_executor = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"agentic_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_agent</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""配置Agent和工具"""</span>
        vectorstore = self.vectorstore  <span class="hljs-comment"># 闭包引用</span>
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">semantic_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于语义搜索，当需要理解问题含义并查找相关文档时使用"""</span>
            docs = vectorstore.similarity_search(query, k=<span class="hljs-number">3</span>)
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">keyword_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于关键词搜索，当需要精确匹配特定术语时使用"""</span>
            docs = vectorstore.similarity_search(query, k=<span class="hljs-number">2</span>)
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于数学计算，输入数学表达式"""</span>
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(<span class="hljs-built_in">eval</span>(expression))
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">return</span><span class="hljs-string">"计算错误"</span>
        
        tools = [semantic_search, keyword_search, calculator]
        
        <span class="hljs-comment"># 使用新版本的Agent提示模板</span>
        prompt = ChatPromptTemplate.from_messages([
            (<span class="hljs-string">"system"</span>, <span class="hljs-string">"""你是一个智能助手，可以使用工具来回答问题。
            
            可用工具：
            - semantic_search: 用于语义搜索，查找相关文档
            - keyword_search: 用于关键词精确匹配
            - calculator: 用于数学计算
            
            请根据问题选择合适的工具，可以多次调用工具来获取完整信息。"""</span>),
            (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
            MessagesPlaceholder(variable_name=<span class="hljs-string">"agent_scratchpad"</span>)
        ])
        
        <span class="hljs-comment"># 创建Tool Calling Agent</span>
        agent = create_tool_calling_agent(self.llm, tools, prompt)
        self.agent_executor = AgentExecutor(
            agent=agent, 
            tools=tools, 
            verbose=<span class="hljs-literal">True</span>,
            max_iterations=<span class="hljs-number">5</span>,
            handle_parsing_errors=<span class="hljs-literal">True</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行查询"""</span>
        ifnot self.agent_executor:
            self.setup_agent()
        result = self.agent_executor.invoke({<span class="hljs-string">"input"</span>: question})
        <span class="hljs-keyword">return</span> result[<span class="hljs-string">"output"</span>]

<span class="hljs-comment"># 使用示例</span>
arag = AgenticRAG()
arag.build_index([<span class="hljs-string">"产品A价格100元..."</span>, <span class="hljs-string">"产品B价格200元..."</span>, <span class="hljs-string">"优惠政策..."</span>])
answer = arag.query(<span class="hljs-string">"产品A和产品B的总价是多少？有什么优惠？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-4">5. Graph RAG</h2>
<p><strong>简介：</strong></p>
<p>Graph RAG 将知识图谱技术与 RAG 相结合，通过从文档中抽取实体和关系构建知识图谱，并进行社区检测和摘要生成。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/156a00f8228c4cd6ad9d9a913b14922b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=1qbByKhMhrVkeQ42ZSiqfMkGUbc%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>实体抽取：使用NER或LLM从文档中抽取实体（人物、地点、概念等）</li>
<li>关系抽取：识别实体之间的关系，构建三元组（实体-关系-实体）</li>
<li>知识图谱构建：将实体和关系存储到图数据库中（如Neo4j）</li>
<li>社区检测：对图进行社区划分，识别主题聚类</li>
<li>社区摘要：为每个社区生成摘要描述</li>
<li>图检索：根据查询在知识图谱中检索相关子图和社区摘要</li>
<li>答案生成：结合图结构信息和社区摘要生成更全面的答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.graphs <span class="hljs-keyword">import</span> Neo4jGraph
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser, JsonOutputParser
<span class="hljs-keyword">import</span> networkx <span class="hljs-keyword">as</span> nx
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, neo4j_uri=<span class="hljs-string">"bolt://localhost:7687"</span>, 
                 neo4j_user=<span class="hljs-string">"neo4j"</span>, neo4j_password=<span class="hljs-string">"password"</span></span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用LangChain的Neo4j集成</span>
        self.graph_db = Neo4jGraph(
            url=neo4j_uri, 
            username=neo4j_user, 
            password=neo4j_password
        )
        self.nx_graph = nx.Graph()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_entities_and_relations</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""使用LLM抽取实体和关系"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""从以下文本中抽取实体和关系，返回JSON格式：
            文本: {text}
            
            返回格式(只返回JSON):
            {{
                "entities": ["实体1", "实体2", ...],
                "relations": [["实体1", "关系", "实体2"], ...]
            }}"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"text"</span>: text})
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> json.loads(response)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"entities"</span>: [], <span class="hljs-string">"relations"</span>: []}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_knowledge_graph</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建知识图谱"""</span>
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents:
            extracted = self.extract_entities_and_relations(doc)
            
            <span class="hljs-comment"># 添加到NetworkX图</span>
            <span class="hljs-keyword">for</span> entity <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"entities"</span>]:
                self.nx_graph.add_node(entity)
            
            <span class="hljs-keyword">for</span> rel <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"relations"</span>]:
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rel) == <span class="hljs-number">3</span>:
                    self.nx_graph.add_edge(rel[<span class="hljs-number">0</span>], rel[<span class="hljs-number">2</span>], relation=rel[<span class="hljs-number">1</span>])
            
            <span class="hljs-comment"># 存储到Neo4j</span>
            <span class="hljs-keyword">for</span> entity <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"entities"</span>]:
                self.graph_db.query(
                    <span class="hljs-string">"MERGE (e:Entity {name: $name})"</span>, 
                    {<span class="hljs-string">"name"</span>: entity}
                )
            <span class="hljs-keyword">for</span> rel <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"relations"</span>]:
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rel) == <span class="hljs-number">3</span>:
                    self.graph_db.query(
                        <span class="hljs-string">"""MATCH (a:Entity {name: $from})
                           MATCH (b:Entity {name: $to})
                           MERGE (a)-[r:RELATED {type: $rel}]-&gt;(b)"""</span>,
                        {<span class="hljs-string">"from"</span>: rel[<span class="hljs-number">0</span>], <span class="hljs-string">"to"</span>: rel[<span class="hljs-number">2</span>], <span class="hljs-string">"rel"</span>: rel[<span class="hljs-number">1</span>]}
                    )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_communities</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""社区检测"""</span>
        <span class="hljs-keyword">from</span> networkx.algorithms <span class="hljs-keyword">import</span> community
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.nx_graph.nodes()) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> []
        communities = community.louvain_communities(self.nx_graph)
        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">list</span>(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> communities]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_community_summaries</span>(<span class="hljs-params">self, communities: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-string">"""为每个社区生成摘要"""</span>
        summaries = []
        <span class="hljs-keyword">for</span> i, comm <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(communities):
            subgraph = self.nx_graph.subgraph(comm)
            edges_info = [(u, v, d.get(<span class="hljs-string">'relation'</span>, <span class="hljs-string">''</span>)) 
                         <span class="hljs-keyword">for</span> u, v, d <span class="hljs-keyword">in</span> subgraph.edges(data=<span class="hljs-literal">True</span>)]
            
            prompt = ChatPromptTemplate.from_template(
                <span class="hljs-string">"""为以下实体群组生成简短摘要：
                实体: {entities}
                关系: {relations}
                摘要:"""</span>
            )
            chain = prompt | self.llm | StrOutputParser()
            summary = chain.invoke({<span class="hljs-string">"entities"</span>: comm, <span class="hljs-string">"relations"</span>: edges_info})
            summaries.append({<span class="hljs-string">"community"</span>: i, <span class="hljs-string">"entities"</span>: comm, <span class="hljs-string">"summary"</span>: summary})
        <span class="hljs-keyword">return</span> summaries
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""基于图的检索和回答"""</span>
        <span class="hljs-comment"># 1. 从问题中提取关键实体</span>
        entities = self.extract_entities_and_relations(question)[<span class="hljs-string">"entities"</span>]
        
        <span class="hljs-comment"># 2. 在Neo4j中查找相关子图</span>
        graph_context = self.graph_db.query(
            <span class="hljs-string">"""MATCH (e:Entity)-[r]-(related)
               WHERE e.name IN $entities
               RETURN e.name AS entity, type(r) AS rel_type, 
                      r.type AS relation, related.name AS related_entity
               LIMIT 20"""</span>,
            {<span class="hljs-string">"entities"</span>: entities}
        )
        
        <span class="hljs-comment"># 3. 获取社区摘要</span>
        communities = self.detect_communities()
        summaries = self.generate_community_summaries(communities[:<span class="hljs-number">3</span>])
        
        <span class="hljs-comment"># 4. 生成答案</span>
        context = <span class="hljs-string">f"图关系: <span class="hljs-subst">{graph_context}</span>\n社区摘要: <span class="hljs-subst">{summaries}</span>"</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下知识图谱信息回答问题：
            {context}
            
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})

<span class="hljs-comment"># 使用示例</span>
grag = GraphRAG()
grag.build_knowledge_graph([
    <span class="hljs-string">"张三是ABC公司的CEO，该公司位于北京"</span>,
    <span class="hljs-string">"李四是ABC公司的CTO，他与张三是大学同学"</span>,
    <span class="hljs-string">"ABC公司开发了产品X，市场份额领先"</span>
])
answer = grag.query(<span class="hljs-string">"ABC公司的领导层有哪些人？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-5">6. Self RAG</h2>
<p><strong>简介：</strong></p>
<p>Self RAG 提供给模型自我评估和决策能力，它通过四个反思标记（Retrieve/ISREL/ISSUP/ISUSE）来判断：是否需要检索、文档是否相关、答案是否被支持、答案是否有用，模型会生成多个候选答案并综合评分，选择最优结果输出。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f305a7dcc64a4d119b93fc171c739451~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=568LwX2VOeLFWFTprYECRBOGzH0%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>检索决策：模型首先判断是否需要检索（生成Retrieve标记）</li>
<li>按需检索：如果需要检索，从知识库中获取相关文档</li>
<li>相关性评估：模型评估检索到的文档是否与查询相关（生成ISREL标记）</li>
<li>支持度评估：模型评估生成的内容是否被检索文档支持（生成ISSUP标记）</li>
<li>有用性评估：模型评估生成的回答是否对用户有用（生成ISUSE标记）</li>
<li>自适应生成：基于以上评估标记，模型决定是否使用检索内容、重新检索或直接生成</li>
<li>输出最优答案：选择评分最高的生成结果作为最终输出</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SelfRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_self_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"self_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_retrieve</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""判断是否需要检索 (Retrieve标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""判断以下问题是否需要检索外部知识来回答。
            问题: {query}
            
            如果问题需要事实性知识、最新信息或特定领域知识，回答YES。
            如果问题是通用问题或推理问题，回答NO。
            只回答YES或NO:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query}).strip().upper()
        <span class="hljs-keyword">return</span><span class="hljs-string">"YES"</span><span class="hljs-keyword">in</span> response
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估文档相关性 (ISREL标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估文档与问题的相关性，打分1-5分。
            问题: {query}
            文档: {document}
            
            返回格式: 分数|理由
            示例: 4|文档直接回答了问题的核心内容"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_support</span>(<span class="hljs-params">self, document: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估答案是否被文档支持 (ISSUP标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估答案是否被文档内容支持，打分1-5分。
            文档: {document}
            答案: {answer}
            
            返回格式: 分数|理由"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"document"</span>: document, <span class="hljs-string">"answer"</span>: answer})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_usefulness</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估答案有用性 (ISUSE标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估答案对用户问题的有用程度，打分1-5分。
            问题: {query}
            答案: {answer}
            
            返回格式: 分数|理由"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"answer"</span>: answer})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_with_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""基于上下文生成答案"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下上下文回答问题。如果上下文不足以回答，请说明。
            上下文: {context}
            问题: {query}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_without_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""不使用检索直接生成"""</span>
        prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"请回答以下问题: {query}"</span>)
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""Self-RAG主流程"""</span>
        <span class="hljs-comment"># 1. 检索决策</span>
        need_retrieval = self.should_retrieve(question)
        
        ifnot need_retrieval:
            <span class="hljs-comment"># 直接生成</span>
            answer = self.generate_without_context(question)
            _, usefulness = self.evaluate_usefulness(question, answer)
            <span class="hljs-keyword">return</span> answer
        
        <span class="hljs-comment"># 2. 检索文档</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
        docs = retriever.invoke(question)
        
        <span class="hljs-comment"># 3. 对每个文档生成候选答案并评分</span>
        candidates = []
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
            <span class="hljs-comment"># 评估相关性 (ISREL)</span>
            is_relevant, rel_score = self.evaluate_relevance(question, doc.page_content)
            ifnot is_relevant:
                <span class="hljs-keyword">continue</span>
            
            <span class="hljs-comment"># 生成答案</span>
            answer = self.generate_with_context(question, doc.page_content)
            
            <span class="hljs-comment"># 评估支持度 (ISSUP)</span>
            is_supported, sup_score = self.evaluate_support(doc.page_content, answer)
            
            <span class="hljs-comment"># 评估有用性 (ISUSE)</span>
            is_useful, use_score = self.evaluate_usefulness(question, answer)
            
            <span class="hljs-comment"># 综合评分</span>
            total_score = rel_score * <span class="hljs-number">0.3</span> + sup_score * <span class="hljs-number">0.4</span> + use_score * <span class="hljs-number">0.3</span>
            candidates.append((answer, total_score))
        
        <span class="hljs-comment"># 4. 选择最佳答案</span>
        <span class="hljs-keyword">if</span> candidates:
            candidates.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">return</span> candidates[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 如果没有合适的检索结果，直接生成</span>
            <span class="hljs-keyword">return</span> self.generate_without_context(question)

<span class="hljs-comment"># 使用示例</span>
srag = SelfRAG()
srag.build_index([<span class="hljs-string">"文档1内容..."</span>, <span class="hljs-string">"文档2内容..."</span>, <span class="hljs-string">"文档3内容..."</span>])
answer = srag.query(<span class="hljs-string">"你的问题是什么？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-6">7. Adaptive RAG</h2>
<p><strong>简介：</strong></p>
<p>Adaptive RAG 根据查询的类型和复杂度动态选择最优的处理策略。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/867cf90ae2aa496eb94c184bbfc132a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=n8LHCBmrPpc99fZg4kO7JcJl4h0%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>查询分类：分析用户查询的类型和复杂度（简单事实/多跳推理/开放性问题）</li>
<li>策略选择：根据查询类型选择最优的RAG策略</li>
<li>
<ul>
<li>简单查询：直接LLM回答或单次检索</li>
<li>复杂查询：多轮迭代检索</li>
<li>开放性问题：结合网络搜索</li>
</ul>
</li>
<li>动态路由：将查询路由到对应的处理流程</li>
<li>自适应检索：根据中间结果动态调整检索深度和范围</li>
<li>结果整合：整合不同策略的结果生成最终答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda, RunnablePassthrough
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryType</span>(<span class="hljs-title class_ inherited__">Enum</span>):
    SIMPLE = <span class="hljs-string">"simple"</span>           <span class="hljs-comment"># 简单事实查询</span>
    MULTI_HOP = <span class="hljs-string">"multi_hop"</span>     <span class="hljs-comment"># 多跳推理查询</span>
    OPEN_ENDED = <span class="hljs-string">"open_ended"</span>   <span class="hljs-comment"># 开放性问题</span>
    NO_RETRIEVAL = <span class="hljs-string">"no_retrieval"</span><span class="hljs-comment"># 不需要检索</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_adaptive_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"adaptive_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">classify_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; QueryType:
        <span class="hljs-string">"""分类查询类型"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""分析以下查询的类型，返回对应类别：
            查询: {query}
            
            类别说明:
            - SIMPLE: 简单的事实性问题，可以直接从单个文档找到答案
            - MULTI_HOP: 需要综合多个信息源进行推理的复杂问题
            - OPEN_ENDED: 开放性问题，需要广泛的知识和创造性思考
            - NO_RETRIEVAL: 通用知识问题，不需要检索即可回答
            
            只返回类别名称(SIMPLE/MULTI_HOP/OPEN_ENDED/NO_RETRIEVAL):"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query}).strip().upper()
        mapping = {
            <span class="hljs-string">"SIMPLE"</span>: QueryType.SIMPLE,
            <span class="hljs-string">"MULTI_HOP"</span>: QueryType.MULTI_HOP,
            <span class="hljs-string">"OPEN_ENDED"</span>: QueryType.OPEN_ENDED,
            <span class="hljs-string">"NO_RETRIEVAL"</span>: QueryType.NO_RETRIEVAL
        }
        <span class="hljs-keyword">return</span> mapping.get(response, QueryType.SIMPLE)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""简单RAG：单次检索"""</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"基于以下内容回答问题：\n{context}\n\n问题：{question}\n答案："</span>
        )
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">format_docs</span>(<span class="hljs-params">docs</span>):
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        chain = (
            {<span class="hljs-string">"context"</span>: retriever | format_docs, <span class="hljs-string">"question"</span>: RunnablePassthrough()}
            | prompt
            | self.llm
            | StrOutputParser()
        )
        <span class="hljs-keyword">return</span> chain.invoke(query)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">multi_hop_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, max_hops: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""多跳RAG：迭代检索"""</span>
        accumulated_context = []
        current_query = query
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        
        <span class="hljs-keyword">for</span> hop <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_hops):
            <span class="hljs-comment"># 检索</span>
            docs = retriever.invoke(current_query)
            accumulated_context.extend([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
            
            <span class="hljs-comment"># 检查是否已有足够信息</span>
            context = <span class="hljs-string">"\n"</span>.join(accumulated_context)
            check_prompt = ChatPromptTemplate.from_template(
                <span class="hljs-string">"""基于当前收集的信息，判断是否足够回答问题。
                收集的信息: {context}
                问题: {query}
                
                回答YES如果信息足够，回答NO如果需要更多信息。
                如果回答NO，请提供下一步应该搜索的子问题。
                格式: YES 或 NO|子问题"""</span>
            )
            check_chain = check_prompt | self.llm | StrOutputParser()
            check_response = check_chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
            
            <span class="hljs-keyword">if</span> check_response.strip().upper().startswith(<span class="hljs-string">"YES"</span>):
                <span class="hljs-keyword">break</span>
            eli<span class="hljs-string">f"|"</span><span class="hljs-keyword">in</span> check_response:
                current_query = check_response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">1</span>].strip()
        
        <span class="hljs-comment"># 生成最终答案</span>
        final_context = <span class="hljs-string">"\n"</span>.join(accumulated_context)
        final_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"综合以下信息回答问题：\n{context}\n\n问题：{question}\n答案："</span>
        )
        final_chain = final_prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> final_chain.invoke({<span class="hljs-string">"context"</span>: final_context, <span class="hljs-string">"question"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_ended_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""开放性RAG：广泛检索+创造性生成"""</span>
        <span class="hljs-comment"># 扩展查询</span>
        expand_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"为以下问题生成3个相关的搜索查询：\n{query}\n查询列表："</span>
        )
        expand_chain = expand_prompt | self.llm | StrOutputParser()
        expanded = expand_chain.invoke({<span class="hljs-string">"query"</span>: query})
        queries = [query] + [q.strip() <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> expanded.split(<span class="hljs-string">"\n"</span>) <span class="hljs-keyword">if</span> q.strip()][:<span class="hljs-number">3</span>]
        
        <span class="hljs-comment"># 多查询检索</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        all_docs = []
        <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> queries:
            docs = retriever.invoke(q)
            all_docs.extend([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        <span class="hljs-comment"># 去重</span>
        unique_docs = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(all_docs))
        context = <span class="hljs-string">"\n"</span>.join(unique_docs[:<span class="hljs-number">5</span>])
        
        final_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下信息，对问题给出全面、有见地的回答：
            信息: {context}
            问题: {question}
            
            请提供详细的分析和见解："""</span>
        )
        final_chain = final_prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> final_chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">no_retrieval_generate</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""直接生成：不使用检索"""</span>
        prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"请回答：{query}"</span>)
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""自适应查询主流程 - 使用LangChain路由"""</span>
        <span class="hljs-comment"># 1. 分类查询</span>
        query_type = self.classify_query(question)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询类型: <span class="hljs-subst">{query_type.value}</span>"</span>)
        
        <span class="hljs-comment"># 2. 路由到对应策略</span>
        routing_map = {
            QueryType.SIMPLE: self.simple_rag,
            QueryType.MULTI_HOP: self.multi_hop_rag,
            QueryType.OPEN_ENDED: self.open_ended_rag,
            QueryType.NO_RETRIEVAL: self.no_retrieval_generate
        }
        <span class="hljs-keyword">return</span> routing_map[query_type](question)

<span class="hljs-comment"># 使用示例</span>
arag = AdaptiveRAG()
arag.build_index([<span class="hljs-string">"公司财报数据..."</span>, <span class="hljs-string">"市场分析报告..."</span>, <span class="hljs-string">"行业趋势..."</span>])
answer = arag.query(<span class="hljs-string">"分析公司未来的发展前景"</span>)  <span class="hljs-comment"># 会被识别为OPEN_ENDED</span>
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-7">8. SFR RAG</h2>
<p><strong>简介：</strong></p>
<p>SFR RAG（Salesforce Research RAG）是工业级高质量 RAG 的最佳实践。它采用经过指令微调的高性能 embedding 模型（如 BGE），结合 Cross-Encoder 重排序、上下文压缩、引用生成和质量验证等多项优化技术。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad02654af9d646f2854979047c43080d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=zLZu5nudCscefZbhgOBpnlaA%2BKA%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>高质量Embedding：使用SFR（Salesforce Research）的高性能embedding模型进行文档和查询编码</li>
<li>指令微调检索：使用指令微调的检索模型，支持多种检索任务（问答、摘要、事实核查等）</li>
<li>上下文压缩：对检索到的文档进行智能压缩，去除冗余信息</li>
<li>重排序：使用专门的重排序模型对候选文档进行精细排序</li>
<li>引用生成：生成答案时附带引用来源，提高可信度</li>
<li>质量控制：对生成结果进行事实性检验和质量评估</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> HuggingFaceBgeEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain_community.cross_encoders <span class="hljs-keyword">import</span> HuggingFaceCrossEncoder
<span class="hljs-keyword">from</span> langchain.retrievers.document_compressors <span class="hljs-keyword">import</span> CrossEncoderReranker
<span class="hljs-keyword">from</span> langchain.retrievers <span class="hljs-keyword">import</span> ContextualCompressionRetriever
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SFRRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 使用BGE高质量Embedding模型</span>
        self.embeddings = HuggingFaceBgeEmbeddings(
            model_name=<span class="hljs-string">"BAAI/bge-large-en-v1.5"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>},
            query_instruction=<span class="hljs-string">"为检索任务生成查询表示: "</span>
        )
        <span class="hljs-comment"># 重排序模型</span>
        self.reranker_model = HuggingFaceCrossEncoder(
            model_name=<span class="hljs-string">"cross-encoder/ms-marco-MiniLM-L-6-v2"</span>
        )
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.db = lancedb.connect(<span class="hljs-string">"./lancedb_sfr_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        self.documents = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建高质量向量索引"""</span>
        self.documents = documents
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"sfr_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_retriever_with_reranker</span>(<span class="hljs-params">self, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""创建带重排序的检索器"""</span>
        <span class="hljs-comment"># 基础检索器</span>
        base_retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">10</span>})
        
        <span class="hljs-comment"># 重排序压缩器</span>
        reranker = CrossEncoderReranker(
            model=self.reranker_model, 
            top_n=top_k
        )
        
        <span class="hljs-comment"># 组合检索器</span>
        <span class="hljs-keyword">return</span> ContextualCompressionRetriever(
            base_compressor=reranker,
            base_retriever=base_retriever
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, documents: <span class="hljs-type">List</span>[Document]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""上下文压缩"""</span>
        doc_texts = <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"[<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>] <span class="hljs-subst">{doc.page_content}</span>"</span>
                              <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(documents)])
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""提取以下文档中与问题相关的关键信息：
            问题: {query}
            
            文档:
            {documents}
            
            请返回压缩后的关键信息，保留文档编号以便引用："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"documents"</span>: doc_texts})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_with_citations</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成带引用的答案"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下上下文回答问题，并标注引用来源[1][2]等。
            
            上下文: {context}
            
            问题: {query}
            
            要求：
            1. 准确回答问题
            2. 在相关陈述后标注引用来源
            3. 如果上下文不足以回答，请说明
            
            答案："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_answer</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span>, documents: <span class="hljs-type">List</span>[Document]</span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""验证答案质量"""</span>
        doc_contents = [doc.page_content <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents]
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估以下答案的质量：
            问题: {query}
            答案: {answer}
            参考文档: {documents}
            
            评估维度(1-5分)：
            1. 准确性：答案是否被文档支持
            2. 完整性：答案是否全面回答了问题
            3. 相关性：答案是否紧扣问题
            
            返回格式: 准确性分数|完整性分数|相关性分数|总评"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({
            <span class="hljs-string">"query"</span>: query, 
            <span class="hljs-string">"answer"</span>: answer, 
            <span class="hljs-string">"documents"</span>: doc_contents
        })
        <span class="hljs-keyword">try</span>:
            parts = response.split(<span class="hljs-string">"|"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"accuracy"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">0</span>].strip()),
                <span class="hljs-string">"completeness"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">1</span>].strip()),
                <span class="hljs-string">"relevance"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">2</span>].strip()),
                <span class="hljs-string">"summary"</span>: parts[<span class="hljs-number">3</span>].strip() <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">3</span><span class="hljs-keyword">else</span><span class="hljs-string">""</span>
            }
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"accuracy"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"completeness"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"relevance"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"summary"</span>: <span class="hljs-string">""</span>}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""SFR-RAG主流程"""</span>
        <span class="hljs-comment"># 1. 初始检索 + 重排序</span>
        retriever = self.get_retriever_with_reranker(top_k=<span class="hljs-number">5</span>)
        docs = retriever.invoke(question)
        
        <span class="hljs-comment"># 2. 上下文压缩</span>
        compressed_context = self.compress_context(question, docs)
        
        <span class="hljs-comment"># 3. 生成带引用的答案</span>
        answer = self.generate_with_citations(question, compressed_context)
        
        <span class="hljs-comment"># 4. 质量验证</span>
        quality = self.verify_answer(question, answer, docs)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"answer"</span>: answer,
            <span class="hljs-string">"sources"</span>: [{<span class="hljs-string">"content"</span>: doc.page_content[:<span class="hljs-number">100</span>]} <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs],
            <span class="hljs-string">"quality"</span>: quality
        }

<span class="hljs-comment"># 使用示例</span>
sfr_rag = SFRRAG()
sfr_rag.build_index([
    <span class="hljs-string">"人工智能是计算机科学的一个分支..."</span>,
    <span class="hljs-string">"机器学习是AI的核心技术之一..."</span>,
    <span class="hljs-string">"深度学习使用神经网络进行学习..."</span>
])
result = sfr_rag.query(<span class="hljs-string">"什么是人工智能？"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"答案: <span class="hljs-subst">{result[<span class="hljs-string">'answer'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"质量评估: <span class="hljs-subst">{result[<span class="hljs-string">'quality'</span>]}</span>"</span>)
</code></pre>
<h2 data-id="heading-8">参考</h2>
<p>（1）<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/langchain/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenAI 甩出王炸：GPT-5.2-Codex 上线，这次它想做你的“赛博合伙人”]]></title>    <link>https://juejin.cn/post/7585377128490532916</link>    <guid>https://juejin.cn/post/7585377128490532916</guid>    <pubDate>2025-12-19T16:19:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585377128490532916" data-draft-id="7585385309891526656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenAI 甩出王炸：GPT-5.2-Codex 上线，这次它想做你的“赛博合伙人”"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-19T16:19:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenAI 甩出王炸：GPT-5.2-Codex 上线，这次它想做你的“赛博合伙人”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T16:19:15.000Z" title="Fri Dec 19 2025 16:19:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>老实说，在 AI 模型像下饺子一样发布的 2025 年年底，大家对“颠覆性升级”这个词早就脱敏了。但 OpenAI 刚刚在 12 月 18 日悄悄放出的 GPT-5.2-Codex，还是让不少熬夜写代码的工程师虎躯一震。</p>
<p>这不仅仅是 GPT-5.2 的一个微调版本，更像是一次针对程序员痛点的“精准爆破”。如果说以前的 AI 是帮你补全代码的实习生，那么这次上线的 Codex，更像是一个能扛事儿的“高级合伙人”。</p>
<p>我花了一点时间扒了扒这背后的技术细节和实测数据，有些东西确实值得聊聊。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Feergertg-1024x468.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/eergertg-1024x468.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/355f433ab89041c0b69fbedcb6314329~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766765955&amp;x-signature=%2B43n99d%2FOVt16Kd3ZC2FB%2FjRY8Q%3D" alt="eergertg" loading="lazy"/></a></p>
<h3 data-id="heading-0">告别“金鱼记忆”：上下文压缩技术</h3>
<p>以前用 AI 写代码，最大的崩溃瞬间是什么？是你把整个项目扔给它，聊到第十轮对话时，它突然忘记了开头定义的变量。</p>
<p>GPT-5.2-Codex 最大的看点就在于**“上下文压缩”技术**。这听起来很学术，但用大白话解释就是：它学会了划重点。</p>
<p>在处理那些持续数周、代码量巨大的复杂任务时，它不再是傻傻地把所有 Token 塞进内存，而是能动态压缩推理过程，保留核心逻辑。官方数据显示，这种机制让 Token 的使用效率提升了 30%。这意味着，当你进行大规模重构或者跨语言迁移这种“长跑”任务时，它不会跑到一半就断片儿。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Ferhgrth-1024x683.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/erhgrth-1024x683.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b3be86eeb07468e8d767efeaee43239~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766765955&amp;x-signature=P9NbElypS3RM9w4sxLAojjMCRs0%3D" alt="erhgrth" loading="lazy"/></a></p>
<h3 data-id="heading-1">真实的工程能力，而不只是刷题</h3>
<p>很多模型在做 LeetCode 算法题时猛如虎，一到真实的业务代码里就歇菜。OpenAI 这次似乎听到了开发者的吐槽，专门强化了 GPT-5.2-Codex 的<strong>工程实战能力</strong>。</p>
<p>两个数据很有意思：</p>
<ol>
<li><strong>SWE-Bench Pro</strong>（软件工程任务）的完成率冲到了 <strong>56.4%</strong>。别觉得这个数字低，在全是坑的真实软件开发环境中，能过半数任务不出错，已经是目前的行业天花板。</li>
<li><strong>Terminal-Bench 2.0</strong>（终端操作）准确率达到了 <strong>64%</strong>。</li>
</ol>
<p>更贴心的是，它终于不再只是 Linux 优先了。OpenAI 专门优化了它在 <strong>原生 Windows 10/11 环境</strong>下的表现。对于那些在这个生态里摸爬滚打的开发者来说，这绝对是个迟来的好消息。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Ffsdfsdg.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/fsdfsdg.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3962bef769b047538897b321eab0ce8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766765955&amp;x-signature=EJYuxjqFNKMdBm8sWkHn4dPbYEs%3D" alt="fsdfsdg" loading="lazy"/></a></p>
<h3 data-id="heading-2">看到“草图”就能写代码</h3>
<p>虽然我们强调它是个后端强手，但这次的视觉理解能力也让人印象深刻。</p>
<p>你现在可以把一张画在餐巾纸上的 UI 草图，或者一张复杂的技术架构图扔给它，它能直接理解并转化为原型的代码。这对于产品经理或者全栈开发者来说，从“想法”到“Demo”的时间被极度压缩了。</p>
<h3 data-id="heading-3">一把双刃剑：强悍的安全攻防能力</h3>
<p>这里必须得提个醒。GPT-5.2-Codex 的代码审计能力强得有点让人害怕。</p>
<p>有一个具体的案例：安全研究员用它的前代模型，在一周内就挖出了 React 框架里的三个安全漏洞。到了这一代，它的防御性编程和漏洞挖掘能力更上了一层楼。</p>
<p>正因为这把“刀”太快，OpenAI 目前采取了非常谨慎的发布策略。虽然付费的 ChatGPT 用户已经在 Codex 界面里用上了，但 API 接口还得等几周才会逐步开放。特别是针对高阶的网络安全功能，OpenAI 搞了个“可信访问试点计划”，生怕被坏人拿去搞破坏。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fhryjytj-1024x809.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/hryjytj-1024x809.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc68bf1514f24b909f3fcd69852c463b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766765955&amp;x-signature=4hPO1f%2FsW50MKfDhmCeuh%2FsfNCw%3D" alt="hryjytj" loading="lazy"/></a></p>
<h3 data-id="heading-4">写在最后</h3>
<p>现在的 GPT-5.2-Codex 完美吗？肯定不。它依然昂贵，依然需要人工 Code Review，依然可能在一本正经地胡说八道。</p>
<p>但它的出现标志着一个转变：AI 正在从一个“被动响应”的工具，变成一个能够“主动执行”长链路任务的智能体。</p>
<p>对于我们这些开发者来说，好消息是如果你有“拖延症”，不知道复杂项目从何下手，把它当成思维陪练和起步工具会非常顺手；坏消息是，留给只会写 CRUD 的“代码搬运工”的时间，真的不多了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fsdgfdgdfh-1024x496.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/sdgfdgdfh-1024x496.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/986c94a5c40b42b08d4c6c3407b09b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766765955&amp;x-signature=Lgt1JkThVJ6JIUKig0%2BTWDs9Tcc%3D" alt="sdgfdgdfh" loading="lazy"/></a></p>
<p>目前这个模型已经向所有 Plus 用户全量推送。建议你去试着用它跑一个还没填完的坑，也许会有惊喜。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[互联网大厂面试实录：当严谨面试官遇上搞笑程序员谢飞机]]></title>    <link>https://juejin.cn/post/7571060853354283018</link>    <guid>https://juejin.cn/post/7571060853354283018</guid>    <pubDate>2025-11-10T15:58:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571060853354283018" data-draft-id="7570903763722436618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="互联网大厂面试实录：当严谨面试官遇上搞笑程序员谢飞机"/> <!----> <meta itemprop="datePublished" content="2025-11-10T15:58:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="福尔摩斯的弟子"/> <meta itemprop="url" content="https://juejin.cn/user/622743759107883"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            互联网大厂面试实录：当严谨面试官遇上搞笑程序员谢飞机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/622743759107883/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    福尔摩斯的弟子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T15:58:40.000Z" title="Mon Nov 10 2025 15:58:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">互联网大厂面试实录：当严谨面试官遇上搞笑程序员谢飞机</h2>
<h3 data-id="heading-1">面试场景：某大厂技术二面现场，会议室里坐着一位神情严肃的面试官，对面是满脸写着"我可能要凉了"的程序员谢飞机。</h3>
<h4 data-id="heading-2"><strong>第一轮提问：基础夯实</strong></h4>
<p><strong>面试官</strong>：谢飞机，先聊聊你对Java内存模型的理解吧。我们公司用的是JDK17，你能说说它和JDK8在内存模型上的主要区别吗？</p>
<p><strong>谢飞机</strong>（挠头）：呃……我记得好像有堆、栈、方法区，还有个元空间对吧？以前叫永久代，现在改名叫元空间了，因为……嗯……更高级了？</p>
<p><strong>面试官</strong>（微微点头）：不错，回答得挺准确。那你知道为什么要把永久代换成元空间吗？</p>
<p><strong>谢飞机</strong>：因为……永久代容易内存溢出，而且不能动态扩容，而元空间是放在本地内存里的，不会受堆大小限制，所以更稳！</p>
<p><strong>面试官</strong>（微笑）：很好，回答得很到位。继续，说说volatile关键字的作用，以及它如何保证可见性和禁止指令重排序。</p>
<p><strong>谢飞机</strong>：哦，volatile就是让变量在多个线程之间共享，每次读都从主内存拿，写也直接写到主内存，这样就保证了可见性。至于指令重排序，它会加一个内存屏障，阻止编译器和处理器乱序执行，对吧？</p>
<p><strong>面试官</strong>：完全正确，看来你确实掌握了核心概念。</p>
<h4 data-id="heading-3"><strong>第二轮提问：并发与线程池</strong></h4>
<p><strong>面试官</strong>：很好。接下来我们进入多线程部分。你能不能解释一下线程池的核心参数有哪些？它们各自的作用是什么？</p>
<p><strong>谢飞机</strong>：核心线程数、最大线程数、工作队列、拒绝策略、线程工厂、超时时间……啊，还有个线程存活时间。核心线程数是最低保持的线程数量，最大线程数是上限，工作队列放任务，拒绝策略处理来不及的任务，线程工厂用来创建线程，存活时间是空闲线程等待任务的时间。</p>
<p><strong>面试官</strong>：非常清晰，逻辑完整。那么，如果使用ThreadPoolExecutor，你如何合理设置这些参数来应对高并发场景？比如一个秒杀系统。</p>
<p><strong>谢飞机</strong>：嗯……我觉得可以设核心线程数为服务器核数的两倍，最大线程数可以再翻倍，工作队列用阻塞队列，比如LinkedBlockingQueue，拒绝策略用CallerRunsPolicy，这样能防止系统雪崩。</p>
<p><strong>面试官</strong>：思路很清晰。但有没有考虑过队列长度过大带来的内存压力？</p>
<p><strong>谢飞机</strong>：啊……这个……我还没想那么深……不过反正有拒绝策略兜底嘛，应该没问题吧？</p>
<p><strong>面试官</strong>（轻笑）：建议你记住一句话：<strong>队列不是万能的，它只是延迟问题，不是解决问题</strong>。继续，说说你对ThreadLocal的理解，它有什么用途？</p>
<p><strong>谢飞机</strong>：哦，ThreadLocal就是每个线程都有自己的副本，互不干扰，适合做线程隔离，比如保存用户登录信息、事务上下文什么的。</p>
<p><strong>面试官</strong>：很好。但要注意什么？</p>
<p><strong>谢飞机</strong>：啊……要记得在finally里remove掉，不然可能内存泄漏……</p>
<p><strong>面试官</strong>：对，这是关键点，很多新人会忽略。</p>
<h4 data-id="heading-4"><strong>第三轮提问：框架与中间件</strong></h4>
<p><strong>面试官</strong>：很好。现在我们进入框架部分。你用过Spring Boot，能说说它的自动装配机制是怎么工作的吗？</p>
<p><strong>谢飞机</strong>：哦，自动装配就是通过@Import、@ConditionalOnClass这些注解，根据类路径是否存在某些类来决定是否加载配置类。比如你引入了Redis依赖，就会自动配置RedisTemplate。</p>
<p><strong>面试官</strong>：非常准确。那Spring的Bean生命周期有几个阶段？</p>
<p><strong>谢飞机</strong>：实例化、属性赋值、初始化、销毁……啊，还有个Aware接口回调，比如ApplicationContextAware，还有InitializingBean接口，然后才是postConstruct……</p>
<p><strong>面试官</strong>：很好，你把整个流程都说清楚了。那你说说MyBatis的缓存机制，一级缓存和二级缓存的区别是什么？</p>
<p><strong>谢飞机</strong>：一级缓存是SqlSession级别的，同一个SqlSession里查询数据会命中；二级缓存是Mapper级别的，跨SqlSession共享，但需要手动开启，并且实体类要实现Serializable。</p>
<p><strong>面试官</strong>：非常准确。那在分布式环境下，二级缓存怎么解决一致性问题？</p>
<p><strong>谢飞机</strong>：这个……我好像没遇到过……也许可以用Redis做分布式缓存？或者……加个版本号？</p>
<p><strong>面试官</strong>（点头）：不错，思路打开了。最后一个问题，谈谈你对DDD领域驱动设计的理解，它和传统的分层架构有什么不同？</p>
<p><strong>谢飞机</strong>：嗯……就是把业务逻辑拆成一个个领域，用实体、值对象、聚合根来建模，然后用领域服务来处理复杂逻辑。相比传统架构，它更贴近业务，代码更有层次感，不容易混乱。</p>
<p><strong>面试官</strong>：很好，回答得很有深度。虽然有些地方略显粗糙，但整体理解到位。</p>
<h4 data-id="heading-5"><strong>结束语</strong></h4>
<p><strong>面试官</strong>：谢飞机，今天的面试就到这里。你的基础知识扎实，对主流框架有较深理解，虽然在一些细节上还略有欠缺，但潜力很大。请回去等通知，我们会在3个工作日内给你答复。</p>
<p><strong>谢飞机</strong>（松了一口气）：谢谢面试官！我回去好好补课，争取下次别再被问懵了！</p>
<hr/>
<h3 data-id="heading-6">答案详解：核心技术点解析（小白也能看懂）</h3>
<h4 data-id="heading-7">1. Java内存模型（JMM）</h4>
<ul>
<li><strong>堆</strong>：存放所有对象实例，垃圾回收的主要区域。</li>
<li><strong>栈</strong>：存放局部变量、方法调用栈帧，每个线程独立。</li>
<li><strong>方法区</strong>：存储类信息、常量、静态变量等，JDK8后更名为<strong>元空间</strong>（Metaspace），位于本地内存，不再受限于堆大小。</li>
<li><strong>元空间替代永久代的原因</strong>：永久代在堆中，容易导致<code>OutOfMemoryError</code>；元空间使用本地内存，可动态扩展，避免内存溢出。</li>
</ul>
<h4 data-id="heading-8">2. volatile关键字</h4>
<ul>
<li><strong>可见性</strong>：当一个线程修改volatile变量，其他线程能立即看到最新值（通过内存屏障刷新主内存）。</li>
<li><strong>禁止指令重排序</strong>：插入内存屏障，防止编译器或处理器对代码进行乱序优化，确保执行顺序符合预期。</li>
<li><strong>典型应用</strong>：单例模式中的双重检查锁、状态标志位等。</li>
</ul>
<h4 data-id="heading-9">3. 线程池核心参数 &amp; 调优</h4>
<ul>
<li><code>corePoolSize</code>：核心线程数，即使空闲也不会被回收。</li>
<li><code>maximumPoolSize</code>：最大线程数，超过核心数后才创建新线程。</li>
<li><code>workQueue</code>：任务队列，如<code>LinkedBlockingQueue</code>（无界）、<code>ArrayBlockingQueue</code>（有界）、<code>SynchronousQueue</code>（直接提交）。</li>
<li><code>rejectedExecutionHandler</code>：拒绝策略，如<code>AbortPolicy</code>（抛异常）、<code>CallerRunsPolicy</code>（由调用线程执行）。</li>
<li><strong>调优建议</strong>：
<ul>
<li>CPU密集型任务：<code>corePoolSize = CPU核数 + 1</code></li>
<li>I/O密集型任务：<code>corePoolSize = 2 * CPU核数</code></li>
<li>队列选择：避免无界队列导致内存溢出，建议使用有界队列配合拒绝策略。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-10">4. ThreadLocal使用注意事项</h4>
<ul>
<li>每个线程拥有独立副本，适用于线程隔离场景（如用户登录上下文、事务管理）。</li>
<li><strong>必须手动清理</strong>：在<code>finally</code>块中调用<code>threadLocal.remove()</code>，否则可能导致内存泄漏（因ThreadLocalMap持有强引用）。</li>
</ul>
<h4 data-id="heading-11">5. Spring Boot自动装配原理</h4>
<ul>
<li>基于<code>@EnableAutoConfiguration</code>注解，扫描<code>META-INF/spring.factories</code>文件，加载<code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>指定的自动配置类。</li>
<li>使用<code>@ConditionalOnClass</code>、<code>@ConditionalOnMissingBean</code>等条件注解控制是否生效，实现“按需加载”机制。</li>
</ul>
<h4 data-id="heading-12">6. Spring Bean生命周期</h4>
<ol>
<li><strong>实例化</strong>：通过构造函数或工厂方法创建对象。</li>
<li><strong>属性赋值</strong>：注入依赖（@Autowired）。</li>
<li><strong>Aware接口回调</strong>：如ApplicationContextAware、BeanNameAware等。</li>
<li><strong>InitializingBean接口</strong>：调用<code>afterPropertiesSet()</code>方法。</li>
<li><strong>@PostConstruct注解方法</strong>：执行自定义初始化逻辑。</li>
<li><strong>Bean初始化完成</strong>：注册到容器中。</li>
<li><strong>销毁</strong>：调用<code>@PreDestroy</code>或<code>DisposableBean</code>接口方法。</li>
</ol>
<h4 data-id="heading-13">7. MyBatis缓存机制</h4>
<ul>
<li><strong>一级缓存</strong>：默认开启，作用域为SqlSession，同一会话内重复查询命中缓存。</li>
<li><strong>二级缓存</strong>：作用域为Mapper级别，需手动开启（<code>&lt;cache /&gt;</code>标签），跨会话共享，但需实体类实现<code>Serializable</code>接口。</li>
<li><strong>一致性问题</strong>：由于缓存异步更新，可能出现脏读。解决方案：
<ul>
<li>用Redis等分布式缓存替代。</li>
<li>启用<code>@CacheNamespaceRef</code>和<code>@Options(flushCache = true)</code>强制刷新。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14">8. DDD领域驱动设计核心思想</h4>
<ul>
<li><strong>领域模型</strong>：以业务为核心，将复杂业务抽象为实体（Entity）、值对象（Value Object）、聚合根（Aggregate Root）。</li>
<li><strong>分层架构</strong>：
<ul>
<li><strong>表现层</strong>：处理前端请求。</li>
<li><strong>应用层</strong>：协调领域服务，处理用例。</li>
<li><strong>领域层</strong>：包含核心业务逻辑和规则。</li>
<li><strong>基础设施层</strong>：数据库、消息队列等外部依赖。</li>
</ul>
</li>
<li><strong>优势</strong>：代码结构清晰，易于维护，业务与技术分离，适合复杂系统长期演进。</li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>总结</strong>：本次面试虽有笑点，但内容扎实。掌握这些核心知识点，是你冲击大厂的关键一步。持续学习，未来可期！</p>
</blockquote>
<p><strong>文章标签</strong>：Java, 面试, 多线程, SpringBoot, Redis, MySQL, JVM</p>
<p><strong>文章简述</strong>：一场充满笑点与干货的面试现场，从基础到框架，从并发到架构，带你深度复盘大厂高频技术问题。通过故事化场景还原真实面试流程，答案部分详细解析每个技术点，小白也能轻松掌握核心知识。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <!----></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解析Android内存分析的指标]]></title>    <link>https://juejin.cn/post/7585446706326781961</link>    <guid>https://juejin.cn/post/7585446706326781961</guid>    <pubDate>2025-12-20T05:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706326781961" data-draft-id="7585463258690273289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析Android内存分析的指标"/> <meta itemprop="keywords" content="Android,APP"/> <meta itemprop="datePublished" content="2025-12-20T05:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析Android内存分析的指标
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:10:11.000Z" title="Sat Dec 20 2025 05:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 系统开发中，为了精准衡量进程的内存消耗，通常会使用 <strong>VSS、RSS、PSS、USS</strong> 这四个指标。由于内存共享机制的存在，单一的“内存占用”数字往往无法真实反映进程对系统的影响，因此这四个指标提供了不同维度的观察视角。</p>
<h2 data-id="heading-0">0x00 核心含义详解</h2>
<p>我们可以通过一个简单的模型来理解：假设进程 A 使用了 <strong>50MB 私有内存</strong>，并与进程 B 共享一个 <strong>20MB 的动态库</strong>。</p>
<h3 data-id="heading-1"><strong>VSS (Virtual Set Size) - 虚拟耗用内存</strong></h3>
<ul>
<li><strong>含义</strong>：进程能访问到的全部虚拟地址空间大小。</li>
<li><strong>包含</strong>：已分配但未实际使用的内存、映射到磁盘的文件、共享库占用的全部空间等。</li>
<li><strong>特点</strong>：数值最大。它不代表真实的物理内存消耗，对于<strong>性能分析意义较小</strong>。</li>
</ul>
<h3 data-id="heading-2"><strong>RSS (Resident Set Size) - 实际使用物理内存</strong></h3>
<ul>
<li><strong>含义</strong>：进程当前实际占用的物理内存（RAM）。</li>
<li><strong>包含</strong>：进程的私有内存 + <strong>共享库的全部大小</strong>。</li>
<li><strong>缺点</strong>：存在“重复计算”。如果有 10 个进程都用了那个 20MB 的共享库，每个进程的 RSS 都会计入这 20MB。将所有进程的 RSS 相加，会远大于系统总内存。</li>
</ul>
<h3 data-id="heading-3"><strong>PSS (Proportional Set Size) - 比例分配内存</strong></h3>
<ul>
<li><strong>含义</strong>：将共享库的大小按共享进程的数量<strong>均摊</strong>。</li>
<li><strong>计算</strong>：私有内存 + (共享库大小 / 共享该库的进程数)。</li>
<li><strong>优点</strong>：<strong>最客观的指标</strong>。如果将系统中所有进程的 PSS 相加，结果几乎等于系统实际消耗的总内存。它是衡量进程系统级负担的最佳标准。</li>
</ul>
<h3 data-id="heading-4"><strong>USS (Unique Set Size) - 进程独占内存（最常用）</strong></h3>
<ul>
<li><strong>含义</strong>：进程完全独占的物理内存。</li>
<li><strong>包含</strong>：只有该进程能访问到的 RAM 区域。</li>
<li><strong>优点</strong>：<strong>分析内存泄露的核心指标</strong>。它表示如果杀死该进程，系统能立刻回收的内存量。</li>
</ul>
<h2 data-id="heading-5">0x01 核心判断标准：为什么 USS 是“金标准”？</h2>
<p>在分析泄漏时，我们通常遵循这个优先级：<strong>USS &gt; PSS &gt; RSS &gt; VSS</strong>。</p>
<ul>
<li><strong>VSS 和 RSS 的局限性</strong>：由于 RSS 包含了共享库内存，当系统其他进程加载或卸载共享库时，你的进程 RSS 可能会波动，这会产生“伪泄漏”的干扰。</li>
<li><strong>PSS 的参考意义</strong>：PSS 能够反映你的进程对系统总内存的真实贡献。如果 PSS 持续上涨，说明你的应用正在拖慢系统。</li>
<li><strong>USS 的决定性作用</strong>：<strong>USS 只包含进程完全独占的内存。</strong> 内存泄漏本质上是进程内部的对象无法被回收，因此<strong>内存泄漏一定会直接反映在 USS 的上涨上</strong>。</li>
</ul>
<h2 data-id="heading-6">0x02 分析内存泄漏分析的流程</h2>
<h3 data-id="heading-7">第一步：建立基准线 (Baseline)</h3>
<p>在应用启动并进入主界面稳定后，记录当前的内存状态。</p>
<pre><code class="hljs language-shell" lang="shell">adb shell dumpsys meminfo &lt;your_package_name&gt;
</code></pre>
<p>重点记录：<code>TOTAL Pss</code> 和 <code>Private Dirty</code>（后者非常接近 USS）。</p>
<h3 data-id="heading-8">第二步：执行重复性操作 (Stress Test)</h3>
<p>内存泄漏通常发生在 Activity 销毁或长生命周期对象（如 Singleton、Thread）中。执行以下操作：</p>
<ol>
<li>进入一个怀疑有泄漏的页面，再退出。</li>
<li>重复上述过程 <strong>10 次以上</strong>。</li>
<li>手动触发几次 GC（在 Android Studio Profiler 中点击小垃圾桶图标，或通过 <code>adb shell cmd activity gc</code>）。</li>
</ol>
<h3 data-id="heading-9">第三步：对比观测</h3>
<p>再次运行 <code>adb shell dumpsys meminfo &lt;your_package_name&gt;</code>，观察数据变化：</p>
<ul>
<li><strong>如果 USS (Private Dirty) 阶梯式上升</strong>：说明存在<strong>私有内存泄漏</strong>（通常是 Java 对象、Bitmap 或 Native 堆内存）。</li>
<li><strong>如果 PSS 上升但 USS 稳定</strong>：这种情况极少见，可能意味着你调用的系统共享资源（如某些系统服务的缓存）在增加，而不是你进程内部的泄漏。</li>
<li><strong>如果 PSS/USS 均不增加，但 VSS 疯狂增长</strong>：说明你在不断地申请虚拟地址空间（例如创建了大量线程，每个线程占用 1MB 虚拟栈空间，但实际还没开始使用物理内存）。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">Applications Memory Usage (in Kilobytes):
Uptime: 102275 Realtime: 102275

** MEMINFO in pid 3069 [com.android.launcher3] **
                   Pss  Private  Private     Swap      Rss     Heap     Heap     Heap
                 Total    Dirty    Clean    Dirty    Total     Size    Alloc     Free
                ------   ------   ------   ------   ------   ------   ------   ------
  Native Heap    11128    11060        0        0    13796    19812    13511     2600
  Dalvik Heap     2316     2188        0        0     6620    27729     3153    24576
 Dalvik Other     2587     2264        0        0     3528                           
        Stack      736      736        0        0      740                           
       Ashmem        2        0        0        0        8                           
      Gfx dev     1244     1244        0        0     1244                           
    Other dev       36        0       36        0      284                           
     .so mmap     6076      212      128        0    54512                           
    .jar mmap     1922        0        0        0    26648                           
    .apk mmap    14824        0    13900        0    38756                           
    .ttf mmap       54        0        0        0      228                           
    .dex mmap      213        4        0        0      504                           
    .oat mmap       55        0        0        0     2044                           
    .art mmap     7794     7404        4        0    20040                           
   Other mmap     1179        4       32        0     4984                           
   EGL mtrack    40288    40288        0        0    40288                           
    GL mtrack     6104     6104        0        0     6104                           
      Unknown      466      448        0        0     1100                           
        TOTAL    97024    71956    14100        0    97024    47541    16664    27176
 
 App Summary
                       Pss(KB)                        Rss(KB)
                        ------                         ------
           Java Heap:     9596                          26660
         Native Heap:    11060                          13796
                Code:    14256                         123424
               Stack:      736                            740
            Graphics:    47636                          47636
       Private Other:     2772
              System:    10968
             Unknown:                                    9172
 
           TOTAL PSS:    97024            TOTAL RSS:   221428      TOTAL SWAP (KB):        0
 
...

</code></pre>
<h2 data-id="heading-10">0x03 针对不同类型的泄漏分析</h2>
<h3 data-id="heading-11">A. Java 层泄漏 (Activity/Fragment)</h3>
<ul>
<li>
<p><strong>现象</strong>：<code>TOTAL Pss</code> 和 <code>Java Heap</code> 持续增长。</p>
</li>
<li>
<p><strong>分析</strong>：查看 <code>dumpsys meminfo</code> 最后的 <code>Objects</code> 部分。</p>
<ul>
<li><code>Views</code> 和 <code>Activities</code> 的数量。如果你退出了页面，<code>Activities</code> 数量没有减少，那就是典型的 Activity 泄漏。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">B. Native 层泄漏 (C++/JNI)</h3>
<ul>
<li><strong>现象</strong>：<code>Native Heap</code> 指标持续增长，且 <code>USS</code> 同步上涨。</li>
<li><strong>分析</strong>：如果你在 JNI 中使用了 <code>malloc</code> 或 <code>new</code> 但没有 <code>free</code>，这部分内存会体现在 <code>Native Heap</code> 中。</li>
</ul>
<h3 data-id="heading-13">C. 共享内存/文件描述符泄漏 (SharedMemory/FD)</h3>
<p>如果 SharedMemory 没有被正确关闭：</p>
<ul>
<li>
<p><strong>现象</strong>：<code>USS</code> 可能不会显著增长（如果你已经 <code>munmap</code> 了），但<strong>文件描述符 (FD)</strong> 会耗尽。</p>
</li>
<li>
<p><strong>检查方式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">ls</span> -l /proc/&lt;pid&gt;/fd | <span class="hljs-built_in">wc</span> -l
</code></pre>
<p>例如检查<code>3069</code>号进程(<code>com.android.launcher3</code>)</p>
<pre><code class="hljs language-shell" lang="shell">adb root
adb shell ls -l /proc/3069/fd | wc -l
<span class="hljs-meta prompt_">
# </span><span class="bash">输出</span>
<span class="hljs-meta prompt_"># </span><span class="bash">82</span>
</code></pre>
<p>重复操作后，如果 FD 数量不断增加，说明你的 <code>SharedMemory</code> 或 <code>ParcelFileDescriptor</code> 没有执行 <code>close()</code>。</p>
</li>
</ul>
<h2 data-id="heading-14">0x04 自动化检测工具推荐</h2>
<p>虽然手动分析 <code>dumpsys</code> 很有帮助，但在实际开发中，建议配合以下工具：</p>





















<table><thead><tr><th><strong>工具</strong></th><th><strong>优势</strong></th></tr></thead><tbody><tr><td><strong>LeakCanary</strong></td><td>自动化程度最高，直接在手机端弹窗告知 Java 泄漏引用链。</td></tr><tr><td><strong>Android Studio Profiler</strong></td><td>可视化实时查看 PSS 分布，支持 Capture Heap Dump 分析堆快照。</td></tr><tr><td><strong>Perfetto / Systrace</strong></td><td>适合分析 Native 层和系统级的内存分配行为。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[支付成功订单却没了？MyBatis连接池的坑我踩了]]></title>    <link>https://juejin.cn/post/7585446706327126025</link>    <guid>https://juejin.cn/post/7585446706327126025</guid>    <pubDate>2025-12-20T06:25:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327126025" data-draft-id="7585463258690650121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="支付成功订单却没了？MyBatis连接池的坑我踩了"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-20T06:25:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9号达人"/> <meta itemprop="url" content="https://juejin.cn/user/2450136052270077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            支付成功订单却没了？MyBatis连接池的坑我踩了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2450136052270077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9号达人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:25:35.000Z" title="Sat Dec 20 2025 06:25:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">事故现场</h2>
<p>上周线上炸了。</p>
<p>支付业务出了问题，用户支付成功，但订单表没数据。更诡异的是，修改订单时有时也会提示获取锁超时。</p>
<p>DBA看了一眼数据库连接，发现几个事务一直没提交，锁着订单表的几行数据。</p>
<p>排查半天，最后发现是某个业务接口忘了提交事务。</p>
<p>按理说,事务没提交应该很容易发现。但这个bug就比较隐蔽。</p>
<p><strong>4个反常识的现象：</strong></p>
<ol>
<li><strong>业务代码正常执行完毕</strong> 没有任何报错，日志也正常打印。</li>
<li><strong>日志显示事务已提交</strong> commit方法被调用了，但数据库里没数据。</li>
<li><strong>偶尔会成功</strong> 大部分时候失败，但偶尔能正常插入订单。</li>
</ol>
<p>这种情况让人摸不着头脑。代码没报错，日志也正常，为啥数据就是不入库?</p>
<h2 data-id="heading-1">应急处理</h2>
<p>线上出问题，那肯定先恢复业务再说。</p>
<p>最快的办法就是重启应用，强制释放这些连接。</p>
<p>重启完，支付功能恢复正常。但问题还是要找到</p>
<p>重启只能暂时缓解，得找到到底哪个业务出了问题。</p>
<p>对比了最近的上线记录，发现有个新业务刚上线。检查代码，果然发现了问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> void handleSpecialCase() {
        <span class="hljs-comment">// 开启事务</span>
        sqlSession.connection.setAutoCommit(<span class="hljs-literal">false</span>);

        <span class="hljs-comment">// 执行SQL</span>
        mapper.insert(<span class="hljs-keyword">data</span>);

        <span class="hljs-comment">// 特殊情况下，忘记commit了！</span>
        <span class="hljs-keyword">if</span> (specialCondition) {
            <span class="hljs-comment">// 某些情况下会return，但没commit</span>
            <span class="hljs-keyword">return</span>;
        }

        sqlSession.commit();
    }
}
</code></pre>
<p>特殊分支直接return了，commit没执行。</p>
<h3 data-id="heading-2">快速修复</h3>
<p>立即补上commit，重新上线：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> void handleSpecialCase() {
        <span class="hljs-keyword">try</span> {
            sqlSession.connection.setAutoCommit(<span class="hljs-literal">false</span>);
            mapper.insert(<span class="hljs-keyword">data</span>);

            <span class="hljs-keyword">if</span> (specialCondition) {
                sqlSession.commit(); <span class="hljs-comment">// 补上！</span>
                <span class="hljs-keyword">return</span>;
            }

            sqlSession.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            sqlSession.rollback();
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>上线后验证，问题解决。</p>
<h2 data-id="heading-3">事后复盘</h2>
<p>问题虽然解决了，但还是很奇怪：为啥一个业务的事务没提交，会影响到其他完全不相关的支付业务？</p>
<p>周末花了半天debug源码，终于搞清楚了。</p>
<h3 data-id="heading-4">断点打在getTransaction</h3>
<p>首先在Spring的<code>getTransaction</code>方法打断点，发现出问题的请求都会走到这里：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">TransactionStatus</span> <span class="hljs-selector-tag">getTransaction</span>(<span class="hljs-variable">@Nullable</span> TransactionDefinition definition)
        <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">TransactionException</span> {

    <span class="hljs-comment">// 使用默认的事务定义</span>
    <span class="hljs-selector-tag">TransactionDefinition</span> <span class="hljs-selector-tag">def</span> = (definition != null ? <span class="hljs-attribute">definition </span>: TransactionDefinition.<span class="hljs-built_in">withDefaults</span>());

    <span class="hljs-comment">// 关键：获取当前事务对象</span>
    <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">transaction</span> = <span class="hljs-selector-tag">doGetTransaction</span>();
    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">debugEnabled</span> = <span class="hljs-selector-tag">logger</span><span class="hljs-selector-class">.isDebugEnabled</span>();

    <span class="hljs-comment">// 判断是否是已存在的事务</span>
    <span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">isExistingTransaction</span>(transaction)) {
        <span class="hljs-comment">// 发现已存在的事务，直接返回</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">handleExistingTransaction</span>(def, transaction, debugEnabled);
    }

    <span class="hljs-comment">// 创建新事务的逻辑...</span>
}
</code></pre>
<p>问题就出在<code>doGetTransaction</code>这个方法。</p>
<h3 data-id="heading-5">doGetTransaction会复用连接</h3>
<p>点开<code>doGetTransaction</code>，会发现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doGetTransaction</span><span class="hljs-params">()</span> {
    <span class="hljs-type">DataSourceTransactionObject</span> <span class="hljs-variable">txObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionObject</span>();
    txObject.setSavepointAllowed(<span class="hljs-built_in">this</span>.isNestedTransactionAllowed());

    <span class="hljs-comment">// 关键：从TransactionSynchronizationManager获取连接</span>
    <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">conHolder</span> <span class="hljs-operator">=</span> (ConnectionHolder) TransactionSynchronizationManager.getResource(<span class="hljs-built_in">this</span>.obtainDataSource());

    txObject.setConnectionHolder(conHolder, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> txObject;
}
</code></pre>
<p><code>TransactionSynchronizationManager.getResource</code>会从连接池拿连接。如果拿到一个被污染的连接（上一个事务没提交），<code>ConnectionHolder</code>里就带着上一个事务的状态。</p>
<h3 data-id="heading-6">isExistingTransaction的判断</h3>
<p>然后<code>isExistingTransaction</code>会检查这个连接：</p>
<pre><code class="hljs language-scss" lang="scss">protected boolean <span class="hljs-built_in">isExistingTransaction</span>(Object transaction) {
    DataSourceTransactionObject txObject = (DataSourceTransactionObject)transaction;
    return txObject<span class="hljs-selector-class">.hasConnectionHolder</span>() &amp;&amp; txObject<span class="hljs-selector-class">.getConnectionHolder</span>()<span class="hljs-selector-class">.isTransactionActive</span>();
}
</code></pre>
<p>如果连接上有事务标记(<code>isTransactionActive()</code>)，就认为是已存在的事务，不会创建新事务。</p>
<p>问题来了：如果上一个业务用完连接后，事务没提交也没回滚，<code>ConnectionHolder</code>的事务标记还在。下一个业务通过<code>doGetTransaction</code>从<code>TransactionSynchronizationManager</code>拿到这个<code>ConnectionHolder</code>，就被当成已存在的事务了。</p>
<h3 data-id="heading-7">被污染的连接是怎么来的</h3>
<p>回顾前面应急处理时找到的那段demo代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSpecialCase</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 开启事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTransactionDefinition</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行SQL</span>
            mapper.insert(data);

            <span class="hljs-comment">// 特殊分支：直接return，没commit！</span>
            <span class="hljs-keyword">if</span> (specialCondition) {
                <span class="hljs-keyword">return</span>;
            }

            transactionManager.commit(status);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            transactionManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>当走到特殊分支return时：</p>
<ul>
<li><code>ConnectionHolder</code>已经被标记为有事务（<code>isTransactionActive() = true</code>）</li>
<li>但事务既没commit，也没rollback</li>
<li>方法结束后，连接归还到<code>TransactionSynchronizationManager</code></li>
<li><code>ConnectionHolder</code>的事务标记还在</li>
</ul>
<p>这个连接就被污染了。</p>
<h3 data-id="heading-8">复用导致的问题</h3>
<p>其他业务刚好复用到了这个被污染的连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 手动开启事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTransactionDefinition</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 插入订单</span>
            orderMapper.insert(order);

            <span class="hljs-comment">// 提交事务</span>
            transactionManager.commit(status);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            transactionManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>看起来没问题，对吧？但当这个方法获取到被污染的连接时：</p>
<ol>
<li><code>getTransaction</code>判断<code>isExistingTransaction</code>为true</li>
<li>走进<code>handleExistingTransaction</code>方法</li>
<li>根据事务传播行为，可能会加入现有事务，而不是创建新事务</li>
<li>最后commit时，因为不是事务发起者，不会真正提交</li>
</ol>
<h3 data-id="heading-9">processCommit的判断</h3>
<p>继续debug到commit方法，发现会执行processCommit去完成提交：</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">processCommit</span>(DefaultTransactionStatus status) throws TransactionException {
    try {
        boolean beforeCompletionInvoked = false;

        try {
            <span class="hljs-built_in">prepareForCommit</span>(status);
            <span class="hljs-built_in">triggerBeforeCommit</span>(status);
            <span class="hljs-built_in">triggerBeforeCompletion</span>(status);
            beforeCompletionInvoked = true;

            if (status.hasSavepoint()) {
                status<span class="hljs-selector-class">.releaseHeldSavepoint</span>();
            }
            <span class="hljs-comment">// 关键判断：只有新事务才真正提交</span>
            else if (status.isNewTransaction()) {
                if (status.isDebug()) {
                    logger<span class="hljs-selector-class">.debug</span>("Initiating transaction commit");
                }
                <span class="hljs-comment">// 真正执行数据库commit</span>
                <span class="hljs-built_in">doCommit</span>(status);
            }
            <span class="hljs-comment">// 如果不是新事务，什么都不做！</span>

        } catch (UnexpectedRollbackException ex) {
            <span class="hljs-comment">// ...</span>
        }

    } finally {
        <span class="hljs-built_in">cleanupAfterCompletion</span>(status);
    }
}
</code></pre>
<p>因为<code>status.isNewTransaction()</code>返回false（这是个加入的事务，不是新事务），所以<code>doCommit(status)</code>根本不会执行。</p>
<p>真正的<code>connection.commit()</code>根本没执行。</p>
<h3 data-id="heading-10">完整的问题链路</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949f8bc5fad646ce99fe08ea931a121b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOeWPt-i-vuS6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766816735&amp;x-signature=eaui1jMxdtT2JMmKe2B7tW5yA9M%3D" alt="" loading="lazy"/></p>
<ol>
<li><code>SomeService.handleSpecialCase()</code>特殊分支没提交事务</li>
<li>方法结束，<code>ConnectionHolder</code>归还到<code>TransactionSynchronizationManager</code>，但事务标记<code>isTransactionActive()</code>还是true</li>
<li><code>PaymentService.createOrder()</code>调用<code>doGetTransaction()</code></li>
<li><code>doGetTransaction</code>从<code>TransactionSynchronizationManager</code>拿到被污染的<code>ConnectionHolder</code></li>
<li><code>isExistingTransaction</code>判断为true，认为已有事务</li>
<li>走<code>handleExistingTransaction</code>流程，加入现有事务（<code>isNewTransaction = false</code>）</li>
<li>业务代码执行完，调用<code>commit</code></li>
<li><code>processCommit</code>中判断<code>isNewTransaction()</code>为false，跳过<code>doCommit</code></li>
<li>数据没入库，<code>ConnectionHolder</code>继续待在<code>TransactionSynchronizationManager</code>，继续污染下一个业务</li>
</ol>
<h2 data-id="heading-11">为什么偶尔会成功？</h2>
<p>因为<code>TransactionSynchronizationManager</code>是ThreadLocal实现的，每个线程有独立的资源。</p>
<p>如果支付请求分配到一个干净的线程（没有被污染的<code>ConnectionHolder</code>），就能正常工作。但只要分配到被污染的线程，就会出问题。</p>
<p>这就是为什么这个bug这么难发现：</p>
<ul>
<li>不是100%复现（取决于线程池调度）</li>
<li>没有报错信息</li>
<li>日志看起来正常</li>
</ul>
<h2 data-id="heading-12">预防措施</h2>
<p>经过这次事故，我们加了几个预防措施。</p>
<h3 data-id="heading-13">1. 连接池健康检查</h3>
<p>配置连接池的连接校验：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-string">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-string">validation-timeout:</span> <span class="hljs-number">3000</span>
      <span class="hljs-comment"># 从池子取连接前先测试</span>
      <span class="hljs-string">connection-init-sql:</span> <span class="hljs-string">SET</span> <span class="hljs-string">autocommit=1</span>
</code></pre>
<p><code>connection-init-sql</code>会在每次从池子取连接时重置状态，避免被污染的连接影响业务。</p>
<h3 data-id="heading-14">2. 监控告警</h3>
<p>增加数据库长事务监控：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查找执行超过30秒的事务</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> information_schema.innodb_trx
<span class="hljs-keyword">WHERE</span> TIME_TO_SEC(TIMEDIFF(NOW(), trx_started)) <span class="hljs-operator">&gt;</span> <span class="hljs-number">30</span>;
</code></pre>
<p>配置告警规则，超过30秒的事务立即报警。</p>
<h2 data-id="heading-15">踩坑总结</h2>
<p>这次事故让我明白了几点。</p>
<h3 data-id="heading-16">1. 连接池不只是性能优化</h3>
<p>之前我一直觉得连接池就是提升性能的。这次才懂，连接池还会带来状态复用的坑。</p>
<p>一个连接的问题，会影响后面所有复用这个连接的业务。</p>
<h3 data-id="heading-17">2. 事务管理要写清楚</h3>
<p>手动管理事务，一定要写清楚commit和rollback：</p>
<ul>
<li>commit写在try块末尾</li>
<li>rollback写在catch块</li>
<li>finally块关闭资源</li>
</ul>
<p>别偷懒省这几行代码。一个遗漏的commit，就可能导致线上事故。</p>
<h3 data-id="heading-18">3. 监控要覆盖到数据库层</h3>
<p>应用层日志正常，不代表数据库层没问题。</p>
<p>必须要有数据库层面的监控：</p>
<ul>
<li>慢查询</li>
<li>长事务</li>
<li>锁等待</li>
<li>连接数</li>
</ul>
<h3 data-id="heading-19">4. 源码不能只看，要调试</h3>
<p>看源码很多时候看不出问题。这次是真的打断点一步步走，才发现<code>getTransaction</code>方法里有个<code>isExistingTransaction</code>的判断。</p>
<p>遇到诡异问题，直接上断点调试。看调用栈，看变量值，比看文档快多了。</p>
<h2 data-id="heading-20">写在最后</h2>
<p>这个bug修复后，我跟同事也分享了一下。记录了问题现象、排查过程、根本原因、解决方案和预防措施。</p>
<p>不是为了甩锅，是为了让团队其他人避免踩同样的坑。</p>
<p>技术债不可怕，可怕的是踩坑了还不总结。</p>
<p>生产环境的每一次事故，都是学习的机会。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障]]></title>    <link>https://juejin.cn/post/7585463195200946226</link>    <guid>https://juejin.cn/post/7585463195200946226</guid>    <pubDate>2025-12-20T05:47:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200946226" data-draft-id="7490783352842207259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2025-12-20T05:47:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis与MySQL双剑合璧：缓存更新策略与数据一致性保障
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:47:47.000Z" title="Sat Dec 20 2025 05:47:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">一、前言</h4>
<p>在现代高并发系统中，性能和数据一致性常常是一对“欢喜冤家”：追求极致性能可能牺牲一致性，而过于强调一致性又容易拖慢系统响应。Redis和MySQL作为两种截然不同的数据库技术，就像武侠小说中的双剑，一个快如闪电，一个稳如磐石。如何让它们携手作战，既提升性能又保障数据一致性，是许多开发者面临的现实挑战。</p>
<p>想象一下，你正在开发一个电商系统，商品详情页每秒被访问上万次，数据库不堪重负；或者在秒杀活动中，库存数据稍有延迟就可能引发超卖。单靠MySQL，查询慢、压力大；单靠Redis，又难以保证持久化和复杂查询。这时，Redis与MySQL的结合就成了“救命稻草”。Redis负责缓存热点数据，MySQL保障数据持久化和事务支持，两者分工明确，优势互补。</p>
<p>这篇文章面向有1-2年Redis使用经验的开发者。你可能已经熟悉基本的<code>SET</code>、<code>GET</code>操作，也尝试过用Redis优化系统性能，但面对缓存更新策略和一致性问题时，难免有些迷雾重重。我的目标是通过实战经验，带你梳理Redis与MySQL协同工作的核心策略，剖析常见问题，并分享解决方案和注意事项。无论你是想提升系统性能，还是解决“缓存和数据库不同步”的头疼问题，这里都有你需要的答案。</p>
<h5 data-id="heading-1">我的故事与经验</h5>
<p>我从事后端开发已有10年，其中Redis几乎是我每个项目的“老搭档”。从早期的高并发电商平台，到后来的实时数据分析系统，再到最近的分布式日志服务，Redis与MySQL的组合贯穿始终。比如在某电商项目中，我们用Redis缓存商品详情页，QPS从几百提升到上万，数据库负载降低了80%；在实时监控项目中，Redis的低延迟让我们能秒级更新数据，而MySQL则默默守护着数据的完整性。这些经验告诉我，缓存与数据库的协作不仅仅是技术选型，更是业务需求与架构设计的平衡。</p>
<p>然而，这一路并非坦途。缓存失效导致的脏数据、高并发下的热点Key问题、甚至Redis宕机引发的连锁反应，都让我踩过不少坑。正是这些“摔打”，让我深刻认识到缓存更新策略和数据一致性保障的重要性。接下来，我将结合这些实战经验，带你一步步解锁Redis与MySQL双剑合璧的奥秘。</p>
<hr/>
<h4 data-id="heading-2">二、Redis与MySQL双剑合璧的核心优势</h4>
<p>Redis和MySQL的组合，就像一场精心编排的“双人舞”：Redis以迅雷不及掩耳之势处理高频请求，MySQL则稳扎稳打守护数据的完整性。单独使用它们都有局限，但结合起来却能迸发出惊人的能量。这一节，我们将剖析两者的互补性，探讨典型应用场景，并聊聊性能与一致性之间的微妙权衡。</p>
<h5 data-id="heading-3">1. Redis与MySQL的互补性</h5>
<p>MySQL是关系型数据库的“老大哥”，擅长持久化存储和复杂查询。它的强一致性（ACID特性）和丰富的事务支持，让它成为数据可靠性的基石。然而，面对高并发场景，磁盘I/O和锁机制往往让它“喘不过气来”。相比之下，Redis就像一位“轻功高手”，基于内存操作，读写延迟低至亚毫秒级，单机QPS轻松突破十万，非常适合缓存热点数据或临时状态。但Redis也有短板：数据持久化能力有限，复杂查询更是它的“软肋”。</p>
<p>两者的结合，恰好弥补了彼此的不足。在我参与的一个电商项目中，商品详情页的访问量激增时，我们用Redis缓存热点数据，QPS从500提升到2万，MySQL的查询压力骤降80%。而库存更新等关键操作依然交给MySQL，确保数据不会因Redis宕机而丢失。这种“快慢搭配”的模式，既提升了性能，又保障了可靠性。</p>
<p><strong>核心优势一览表：</strong></p>



































<table><thead><tr><th>特性</th><th>MySQL</th><th>Redis</th><th>结合后效果</th></tr></thead><tbody><tr><td>数据存储</td><td>磁盘，持久化</td><td>内存，临时</td><td>热点数据加速，核心数据安全</td></tr><tr><td>访问速度</td><td>毫秒级</td><td>亚毫秒级</td><td>性能提升10倍以上</td></tr><tr><td>查询能力</td><td>复杂SQL支持</td><td>简单Key-Value</td><td>满足多样化需求</td></tr><tr><td>一致性</td><td>强一致性</td><td>弱一致性</td><td>可根据业务灵活调整</td></tr></tbody></table>
<h5 data-id="heading-4">2. 典型应用场景</h5>
<p>在实际项目中，Redis与MySQL的组合无处不在。以下是两个常见的例子：</p>
<ul>
<li>
<p><strong>电商商品详情页</strong><br/>
商品信息（如名称、价格）变化频率低，但访问量极高。我们用Redis缓存这些数据，设置TTL为1小时，极大减少MySQL的查询压力。而库存数据因实时性要求高，更新时直接写MySQL，再同步失效Redis缓存。这种分工让系统既快又稳。</p>
</li>
<li>
<p><strong>用户会话管理</strong><br/>
在一个社交应用中，用户登录状态用Redis存储，TTL设为30分钟，快速响应会话查询。用户的长期数据（如注册信息）则保存在MySQL中，确保即使Redis重启，会话过期后也能从MySQL恢复。这种搭配让会话管理高效又可靠。</p>
</li>
</ul>
<h5 data-id="heading-5">3. 一致性与性能的权衡</h5>
<p>Redis与MySQL协作时，性能和一致性就像天平的两端，很难两全其美。我们常听到“最终一致性”和“强一致性”这两个词，它们该如何选择呢？答案藏在业务需求里。</p>
<p>以秒杀场景为例，库存扣减必须实时准确，任何延迟或不一致都可能导致超卖。这时需要强一致性，通常通过分布式锁或事务确保Redis和MySQL同步更新。而在推荐系统中，用户看到的商品列表可能基于几分钟前的数据，短暂的不一致无伤大雅，最终一致性就够用了——先更新MySQL，再异步刷新Redis即可。</p>
<p><strong>权衡选择示意图：</strong></p>
<pre><code class="hljs language-lua" lang="lua">高一致性需求       中间地带       高性能需求
|<span class="hljs-comment">-------|-------|-------|-------|</span>
强一致性         最终一致性
&lt;<span class="hljs-comment">-- 秒杀、支付 --&gt; &lt;-- 推荐、日志 --&gt;</span>
</code></pre>
<p>在我的经验中，一个实时数据分析项目让我深刻体会到这种权衡。初期我们追求强一致性，所有数据都同步写Redis和MySQL，结果性能瓶颈明显。后来调整为异步写回策略，吞吐量提升了3倍，用户也能接受秒级的延迟。这提醒我们：技术方案没有绝对的好坏，只有适不适合。</p>
<hr/>
<h4 data-id="heading-6">三、缓存更新策略详解</h4>
<p>Redis与MySQL的协作好比一场精密的“接力赛”，缓存更新策略就是接力棒交接的规则。交接顺畅，系统跑得又快又稳；稍有失误，就可能摔个跟头。这一节，我们将深入探讨三种主流缓存更新策略：Cache-Aside、Write-Through和Write-Behind，剖析它们的原理、优缺点，并结合实战经验分享代码和踩坑教训，最后给出选择建议。</p>
<h5 data-id="heading-7">1. 常见的缓存更新策略</h5>
<h6 data-id="heading-8">Cache-Aside（旁路缓存）</h6>
<p><strong>原理</strong>：这是最经典的缓存策略。读取时，先查Redis，若未命中则查MySQL并回写缓存；写入时，先更新MySQL，再主动失效（删除）Redis缓存。这种“懒加载”的方式让缓存按需填充，非常灵活。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>实现简单，开发成本低。</li>
<li>适合读多写少的场景，缓存命中率高时性能提升显著。</li>
</ul>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取用户信息</span>
String <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redis.get(cacheKey); <span class="hljs-comment">// 先查Redis</span>
    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 未命中</span>
        user = mysql.query(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, userId); <span class="hljs-comment">// 查MySQL</span>
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            redis.setex(cacheKey, <span class="hljs-number">3600</span>, user); <span class="hljs-comment">// 回写Redis，TTL为1小时</span>
        }
    }
    <span class="hljs-keyword">return</span> user;
}

<span class="hljs-comment">// 更新用户信息</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String data)</span> {
    mysql.update(<span class="hljs-string">"UPDATE users SET data = ? WHERE id = ?"</span>, data, userId); <span class="hljs-comment">// 先更新MySQL</span>
    redis.del(<span class="hljs-string">"user:"</span> + userId); <span class="hljs-comment">// 再删除Redis缓存</span>
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在一个电商项目中，我们发现部分用户数据更新后，缓存未及时失效，导致前端显示脏数据。后来分析发现，某些场景下<code>redis.del</code>因网络抖动失败。为此，我们引入TTL自动清理机制，即使删除失败，缓存也会在到期后失效，避免长期不一致。</p>
<h6 data-id="heading-9">Write-Through（直写）</h6>
<p><strong>原理</strong>：写入时同时更新MySQL和Redis，确保两者数据时刻一致。就像“双管齐下”，每次写操作都两边同步。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>一致性强，读操作无需担心脏数据。</li>
<li>适合写频繁且一致性要求高的场景。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>性能开销大，双写增加了延迟。</li>
<li>Redis和MySQL的同步可能因异常中断。</li>
</ul>
<p><strong>实际场景</strong>：<br/>
在金融系统的账户余额更新中，我们采用Write-Through。每次转账操作先写MySQL，再同步更新Redis，确保余额实时准确。虽然性能略有下降，但一致性得到了保障。</p>
<h6 data-id="heading-10">Write-Behind（异步写回）</h6>
<p><strong>原理</strong>：先快速写入Redis，再通过异步任务（如消息队列或定时任务）批量更新MySQL。就像“先记账，后对账”，优先保证写性能。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>高吞吐量，适合高并发写场景。</li>
<li>异步批量操作减少数据库压力。</li>
</ul>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductStock</span><span class="hljs-params">(<span class="hljs-type">int</span> productId, <span class="hljs-type">int</span> stock)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + productId;
    redis.set(cacheKey, stock); <span class="hljs-comment">// 先写Redis</span>
    messageQueue.send(<span class="hljs-string">"update_stock"</span>, productId, stock); <span class="hljs-comment">// 异步发MQ更新MySQL</span>
}

<span class="hljs-comment">// MQ消费者</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String productId, <span class="hljs-type">int</span> stock)</span> {
    mysql.update(<span class="hljs-string">"UPDATE products SET stock = ? WHERE id = ?"</span>, stock, productId);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在实时监控系统中，我们用Write-Behind处理指标数据。某次MQ消费失败，导致MySQL未更新，数据丢失了近1小时。吸取教训后，我们引入重试机制和日志补偿：失败的任务重试3次仍不成功则记录日志，运维人员手动修复。</p>
<h5 data-id="heading-11">2. 如何选择合适的策略</h5>
<p>选择缓存策略就像挑选武功招式，没有最强，只有最合适。以下是我的经验总结：</p>
<p><strong>选择依据对比表：</strong></p>

































<table><thead><tr><th>策略</th><th>适用场景</th><th>一致性</th><th>性能</th><th>复杂度</th></tr></thead><tbody><tr><td>Cache-Aside</td><td>读多写少（如商品详情）</td><td>最终一致性</td><td>高</td><td>低</td></tr><tr><td>Write-Through</td><td>写频繁一致性高（如金融）</td><td>强一致性</td><td>中</td><td>中</td></tr><tr><td>Write-Behind</td><td>高并发写（如日志）</td><td>最终一致性</td><td>极高</td><td>高</td></tr></tbody></table>
<p><strong>项目经验</strong>：</p>
<ul>
<li><strong>电商库存管理</strong>：我们用Cache-Aside结合延迟双删（后文详述），应对读多写少的场景，确保库存更新后缓存及时刷新。</li>
<li><strong>实时监控</strong>：Write-Through保证指标数据实时同步，满足强一致性需求。</li>
<li><strong>日志系统</strong>：Write-Behind配合消息队列，轻松应对每秒百万级的写请求。</li>
</ul>
<p>选择时，建议从业务特点出发：</p>
<ol>
<li><strong>读写比例</strong>：读多写少选Cache-Aside，写多读少选Write-Through。</li>
<li><strong>一致性要求</strong>：强一致性选Write-Through，最终一致性可考虑其他两者。</li>
<li><strong>系统复杂度</strong>：资源有限时，优先简单易用的Cache-Aside。</li>
</ol>
<p><strong>策略选择流程图：</strong></p>
<pre><code class="hljs language-rust" lang="rust">开始
  |
读多写少? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Cache-Aside
  |             否
强一致性? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Write-Through
  |             否
高并发写? -<span class="hljs-punctuation">-&gt;</span> 是 -<span class="hljs-punctuation">-&gt;</span> Write-Behind
  |
其他场景 -<span class="hljs-punctuation">-&gt;</span> 根据复杂度调整
</code></pre>
<hr/>
<h4 data-id="heading-12">四、数据一致性保障的实战技巧</h4>
<p>缓存更新策略为Redis与MySQL的协作搭好了舞台，但一致性问题就像舞台下的“暗流”，稍不留神就会让表演翻车。无论是缓存未及时刷新，还是并发更新导致的脏数据，这些问题都可能让用户体验大打折扣。这一节，我们将直面一致性问题的根源，分享我在项目中总结的实战技巧，帮助你打造一个既快又准的系统。</p>
<h5 data-id="heading-13">1. 一致性问题的根源</h5>
<p>一致性问题通常源于两点：</p>
<ul>
<li><strong>更新顺序异常</strong>：比如先写MySQL后删Redis，但Redis宕机或网络延迟导致删除失败，缓存保留了旧数据。</li>
<li><strong>并发冲突</strong>：多个线程同时更新同一数据，比如秒杀场景下多人抢购库存，可能出现Redis和MySQL的数据“打架”。</li>
</ul>
<p>在一次电商活动中，我们就遇到过类似问题：库存更新后，Redis缓存未及时删除，导致前端显示的库存比实际多，最终引发超卖。分析后发现，根源在于高并发下操作顺序不可控和异常处理不足。</p>
<h5 data-id="heading-14">2. 解决方案与最佳实践</h5>
<p>针对这些问题，我总结了三种实用方案，下面逐一展开。</p>
<h6 data-id="heading-15">延迟双删策略</h6>
<p><strong>原理</strong>：写MySQL后立即删除Redis缓存，等几秒后再删一次，确保即使有并发读回写了旧数据，也能被清理掉。这就像“双重保险”，牺牲一点延迟换取一致性。</p>
<p><strong>代码示例（Java+Spring）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(<span class="hljs-type">int</span> productId, String data)</span> {
    <span class="hljs-comment">// 更新MySQL</span>
    mysql.update(<span class="hljs-string">"UPDATE products SET data = ? WHERE id = ?"</span>, data, productId);
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    redis.del(cacheKey); <span class="hljs-comment">// 第一次删除</span>
    <span class="hljs-comment">// 延迟2秒再次删除</span>
    taskScheduler.schedule(() -&gt; redis.del(cacheKey), <span class="hljs-number">2000</span>);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在某项目中，我们固定延迟2秒，结果发现高峰期QPS过高时，2秒不够覆盖所有并发读，导致部分脏数据残留。后来改为动态调整延迟时间（根据业务QPS，范围1-5秒），问题显著减少。</p>
<p><strong>适用场景</strong>：读多写少，且能容忍短暂不一致。</p>
<h6 data-id="heading-16">分布式锁</h6>
<p><strong>原理</strong>：在高并发更新时，用Redis分布式锁确保同一时刻只有一个线程能操作数据，避免冲突。就像给资源加了把“安全锁”，谁拿到钥匙谁操作。</p>
<p><strong>代码示例（Redis分布式锁）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:product:"</span> + productId;
<span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
<span class="hljs-keyword">if</span> (redis.setnx(lockKey, <span class="hljs-string">"1"</span>)) { <span class="hljs-comment">// 尝试加锁</span>
    redis.expire(lockKey, <span class="hljs-number">10</span>); <span class="hljs-comment">// 设置10秒超时</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 更新MySQL</span>
        mysql.update(<span class="hljs-string">"UPDATE products SET stock = stock - 1 WHERE id = ?"</span>, productId);
        redis.del(cacheKey); <span class="hljs-comment">// 同步删除缓存</span>
    } <span class="hljs-keyword">finally</span> {
        redis.del(lockKey); <span class="hljs-comment">// 释放锁</span>
    }
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取锁失败，重试"</span>);
}
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>超时设置</strong>：锁超时太短可能提前释放，太长可能阻塞其他线程，建议根据业务调整（5-30秒）。</li>
<li><strong>续期机制</strong>：若操作耗时长，可用watchdog线程自动续期，避免死锁。</li>
<li><strong>踩坑经验</strong>：一次秒杀活动中，忘记释放锁，导致后续请求全被阻塞。后来用<code>finally</code>块确保释放，才解决问题。</li>
</ul>
<p><strong>适用场景</strong>：秒杀、库存扣减等高并发强一致性场景。</p>
<h6 data-id="heading-17">消息队列解耦</h6>
<p><strong>原理</strong>：写操作通过消息队列（MQ）解耦，先快速写Redis，再由消费者异步更新MySQL。这就像“快递代发”，前端快速响应，后端慢慢处理。</p>
<p><strong>代码示例（Java伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateLog</span><span class="hljs-params">(String logData)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"log:"</span> + UUID.randomUUID();
    redis.set(cacheKey, logData); <span class="hljs-comment">// 先写Redis</span>
    messageQueue.send(<span class="hljs-string">"update_log"</span>, logData); <span class="hljs-comment">// 发MQ异步更新</span>
}

<span class="hljs-comment">// MQ消费者</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String logData)</span> {
    mysql.insert(<span class="hljs-string">"INSERT INTO logs (data) VALUES (?)"</span>, logData);
}
</code></pre>
<p><strong>踩坑经验</strong>：<br/>
在日志系统中，MQ消费者宕机导致积压，MySQL未及时更新。后来引入死信队列，所有消费失败的消息转入备用队列，由定时任务重试，确保不丢数据。</p>
<p><strong>适用场景</strong>：高并发写，且一致性要求不高（如日志、统计数据）。</p>
<h5 data-id="heading-18">3. 一致性验证</h5>
<p>无论用哪种策略，异常总可能发生。为防万一，我们需要“查漏补缺”：</p>
<ul>
<li><strong>定期比对</strong>：用定时任务对比Redis与MySQL数据，发现不一致时自动修复。</li>
<li><strong>项目经验</strong>：在电商库存管理中，我们每天凌晨跑脚本比对，修复了99%的脏数据问题。修复过程记录日志，便于追溯。</li>
</ul>
<p><strong>验证流程示意图：</strong></p>
<pre><code class="hljs language-rust" lang="rust">定时任务启动
    |
获取Redis数据 -<span class="hljs-punctuation">-&gt;</span> 与MySQL比对 -<span class="hljs-punctuation">-&gt;</span> 不一致?
    |                              是 -<span class="hljs-punctuation">-&gt;</span> 更新Redis或MySQL -<span class="hljs-punctuation">-&gt;</span> 记录日志
    |                              否
结束
</code></pre>
<p><strong>一致性保障方案对比表：</strong></p>

































<table><thead><tr><th>方案</th><th>一致性</th><th>性能影响</th><th>复杂度</th><th>适用场景</th></tr></thead><tbody><tr><td>延迟双删</td><td>较高</td><td>小</td><td>中</td><td>读多写少</td></tr><tr><td>分布式锁</td><td>极高</td><td>中</td><td>高</td><td>高并发强一致性</td></tr><tr><td>消息队列</td><td>最终一致性</td><td>低</td><td>高</td><td>高并发写</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-19">五、性能优化与踩坑经验</h4>
<p>Redis与MySQL的协作就像一辆跑车，缓存策略和一致性保障是引擎，而性能优化则是让它跑得更快更稳的“调校”。但这条赛道上也埋了不少“陷阱”，稍不留神就可能翻车。这一节，我将分享性能优化的核心技巧，以及我在实战中踩过的坑和应对之道，希望帮你少走弯路。</p>
<h5 data-id="heading-20">1. 性能优化的关键点</h5>
<p>要想让系统跑得快，细节决定成败。以下是三个关键点：</p>
<ul>
<li>
<p><strong>Redis键设计</strong><br/>
键名要短小精悍，避免“大Key”拖慢性能。比如存储复杂数据时，别用一个String存JSON，而是用Hash结构分字段存储。在一个用户管理系统中，我们将用户信息从<code>user:123:info</code>的单一String改为<code>HSET user:123 name "Tom" age "25"</code>，内存占用减少30%，查询效率也更高。</p>
</li>
<li>
<p><strong>批量操作</strong><br/>
Redis的单次操作很快，但网络RTT（往返时间）可能是瓶颈。使用Pipeline批量提交命令，能大幅降低延迟。在实时监控项目中，我们将每秒100次<code>SET</code>改为Pipeline批量操作，RTT从50ms降到5ms，性能提升10倍。</p>
</li>
<li>
<p><strong>缓存预热</strong><br/>
系统启动时，别让Redis“裸奔”。提前加载热点数据，能避免冷启动时的数据库压力。在电商活动中，我们在活动前将Top 100商品数据预热到Redis，首波流量直接命中缓存，MySQL毫发无损。</p>
</li>
</ul>
<p><strong>性能优化效果示意图：</strong></p>
<pre><code class="hljs language-lua" lang="lua">优化前：高RTT + 大Key + 冷启动
  |<span class="hljs-comment">----&gt; 数据库压力激增</span>
优化后：Pipeline + Hash + 预热
  |<span class="hljs-comment">----&gt; QPS提升，稳定运行</span>
</code></pre>
<h5 data-id="heading-21">2. 踩坑经验分享</h5>
<p>实战中，性能问题往往伴随着“坑”。以下是我遇到的三大典型问题及解决方案：</p>
<h6 data-id="heading-22">缓存穿透</h6>
<p><strong>问题</strong>：查询不存在的数据（如用户ID为-1），Redis未命中，请求直达MySQL，导致数据库压力暴增。<br/>
<strong>案例</strong>：某次接口被恶意请求刷爆，QPS从1万飙到10万，MySQL差点挂掉。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>布隆过滤器</strong>：预先用布隆过滤器判断Key是否存在，不存在直接返回。</li>
<li><strong>缓存空值</strong>：查不到数据时，缓存空对象（如<code>null</code>），TTL设短些（如5分钟）。
<pre><code class="hljs language-java" lang="java">String <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
    <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redis.get(cacheKey);
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> user;
    <span class="hljs-keyword">if</span> (bloomFilter.mightContain(cacheKey)) {
        user = mysql.query(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, userId);
        redis.setex(cacheKey, user == <span class="hljs-literal">null</span> ? <span class="hljs-number">300</span> : <span class="hljs-number">3600</span>, user); <span class="hljs-comment">// 空值TTL 5分钟</span>
    }
    <span class="hljs-keyword">return</span> user;
}
</code></pre>
</li>
</ol>
<p><strong>经验</strong>：布隆过滤器适合大数据量场景，空值缓存更简单但需控制内存。</p>
<h6 data-id="heading-23">缓存雪崩</h6>
<p><strong>问题</strong>：大量缓存Key同时失效，请求全打到MySQL，导致宕机。<br/>
<strong>案例</strong>：一次活动结束后，所有商品缓存TTL统一到期，MySQL瞬间瘫痪。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>TTL随机化</strong>：给每个Key的TTL加随机偏移（如1小时±10分钟）。
<pre><code class="hljs language-java" lang="java">redis.setex(cacheKey, <span class="hljs-number">3600</span> + random.nextInt(<span class="hljs-number">600</span>), data);
</code></pre>
</li>
<li><strong>热点缓存隔离</strong>：将高频Key单独延长TTL或永不过期，手动刷新。<br/>
<strong>经验</strong>：随机化简单有效，热点隔离更适合核心数据。</li>
</ol>
<h6 data-id="heading-24">热点Key问题</h6>
<p><strong>问题</strong>：单个Key（如活动页数据）QPS过高，Redis单节点压力爆棚。<br/>
<strong>案例</strong>：某电商活动页Key每秒10万次请求，Redis集群响应变慢。<br/>
<strong>解决</strong>：</p>
<ol>
<li><strong>分片存储</strong>：将数据拆成多个Key（如<code>activity:1:part1</code>、<code>part2</code>），分散压力。</li>
<li><strong>本地缓存</strong>：前端或应用层用Guava Cache分担流量。我们在Nginx层加了本地缓存，Redis压力降到20%。
<pre><code class="hljs language-java" lang="java">Cache&lt;String, String&gt; localCache = CacheBuilder.newBuilder()
    .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.SECONDS).build();
String <span class="hljs-title function_">getActivityData</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> localCache.getIfPresent(key);
    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
        data = redis.get(key);
        localCache.put(key, data);
    }
    <span class="hljs-keyword">return</span> data;
}
</code></pre>
</li>
</ol>
<p><strong>经验</strong>：分片适合Redis层优化，本地缓存更灵活但需注意内存。</p>
<p><strong>踩坑问题对比表：</strong></p>





























<table><thead><tr><th>问题</th><th>表现</th><th>解决方法</th><th>实施难度</th></tr></thead><tbody><tr><td>缓存穿透</td><td>数据库压力大</td><td>布隆过滤器/空值缓存</td><td>中</td></tr><tr><td>缓存雪崩</td><td>数据库瞬时过载</td><td>TTL随机化/热点隔离</td><td>低</td></tr><tr><td>热点Key</td><td>Redis响应慢</td><td>分片/本地缓存</td><td>高</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-25">六、总结与展望</h4>
<p>Redis与MySQL的协作就像一场精彩的“双人舞”，从缓存策略到一致性保障，再到性能优化，每一步都考验着开发者的智慧和经验。走完这段旅程，我们不仅看到了两者的默契配合，也收获了实战中的宝贵教训。这一节，我将总结核心要点，分享实践建议，并展望未来的技术趋势，希望为你点亮前行的路。</p>
<h5 data-id="heading-26">1. 总结</h5>
<p>Redis与MySQL双剑合璧的核心在于两点：</p>
<ul>
<li><strong>合理选择缓存策略</strong>：Cache-Aside适合读多写少，Write-Through保障强一致性，Write-Behind应对高并发写。策略没有优劣之分，关键是匹配业务需求。</li>
<li><strong>保障数据一致性</strong>：延迟双删、分布式锁和消息队列各有千秋，配合定期验证，能让系统既快又稳。</li>
</ul>
<p>我的核心经验是：一切从业务出发。高并发电商需要性能优先，金融系统强调一致性，日志服务追求吞吐量。技术是为业务服务的，脱离需求的优化都是“空中楼阁”。比如在电商项目中，我们用Cache-Aside加延迟双删，QPS提升10倍的同时保证了库存准确；在实时监控中，Write-Through让数据零延迟，满足了客户需求。这些成功都源于对业务的深刻理解。</p>
<p><strong>实践建议</strong>：</p>
<ol>
<li><strong>从小处着手</strong>：先用Cache-Aside试水，简单易上手，再根据需求调整。</li>
<li><strong>关注异常</strong>：为每种策略设计兜底方案（如重试、日志补偿）。</li>
<li><strong>监控先行</strong>：部署Redis和MySQL的监控，实时掌握命中率、延迟和一致性问题。</li>
<li><strong>迭代优化</strong>：性能和一致性是个动态平衡，定期复盘调整。</li>
</ol>
<h5 data-id="heading-27">2. 展望</h5>
<p>Redis与MySQL的协作仍在进化。Redis 7.0增强了集群功能，支持多线程I/O和更灵活的数据结构，未来可能在一致性场景中扮演更重要角色。MySQL 8.0则优化了JSON支持和高可用性，与Redis的配合将更紧密。比如，Redis的Stream数据结构可以与MySQL的binlog集成，实现更高效的异步同步。</p>
<p>未来趋势可能包括：</p>
<ul>
<li><strong>智能化缓存</strong>：AI驱动的缓存预热和淘汰策略，让Redis更“聪明”。</li>
<li><strong>云原生融合</strong>：Serverless架构下，Redis和MySQL可能以托管服务形式无缝集成。</li>
<li><strong>一致性新解法</strong>：分布式事务（如TiDB+Redis的结合）或将简化强一致性实现。</li>
</ul>
<p>作为开发者，我鼓励你多实践、多分享。Redis与MySQL的组合看似简单，实则蕴藏无限可能。每次踩坑和优化，都是成长的契机。我的10年经验告诉我，技术没有终点，只有不断探索的乐趣。</p>
<p><strong>个人心得</strong>：<br/>
我最喜欢Redis的轻快和MySQL的稳重，它们就像我的左右手，缺一不可。每次解决一个一致性难题或优化一次性能瓶颈，都让我对这对“黄金搭档”更有信心。希望你也能在实践中找到属于自己的节奏。</p>
<hr/>
<p><strong>文章尾声：</strong><br/>
至此，我们从Redis与MySQL的优势讲到缓存策略，再到一致性和性能优化，走了一条完整的实战之路。带着这些经验和建议，去试试吧！有什么心得或问题，欢迎随时交流，毕竟技术的魅力就在于分享与成长。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 之高级面向对象编程 深入理解设计模式、原则与性能优化]]></title>    <link>https://juejin.cn/post/7585397173022736403</link>    <guid>https://juejin.cn/post/7585397173022736403</guid>    <pubDate>2025-12-19T23:46:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173022736403" data-draft-id="7585382553289916452" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" PHP 之高级面向对象编程 深入理解设计模式、原则与性能优化"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-12-19T23:46:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             PHP 之高级面向对象编程 深入理解设计模式、原则与性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T23:46:30.000Z" title="Fri Dec 19 2025 23:46:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 之高级面向对象编程 深入理解设计模式、原则与性能优化</h2>
<p>面向对象编程（Object-Oriented Programming, OOP）不只是“如何写 class”的语法规则。它更像一种组织软件系统的思维方式：通过清晰的边界、职责拆分与对象协作，让系统更容易理解、扩展和维护。</p>
<p>当你已经掌握了类、对象、属性、方法这些基础概念之后，就可以把视角往更深一层挪一挪：设计模式、SOLID 原则，以及在大型系统里绕不开的性能与内存问题。</p>
<p>本文会围绕几个常见主题展开：策略模式与单例模式、SOLID 五原则，以及不可变对象与内存管理相关的性能考虑。它们的目的不是“炫技”，而是让真实项目在后续迭代中更稳、更好改。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fadvanced-object-oriented-programming-design-patterns-solid-performance" target="_blank" title="https://catchadmin.com/post/2025-12/advanced-object-oriented-programming-design-patterns-solid-performance" ref="nofollow noopener noreferrer">原文链接 PHP 之高级面向对象编程 深入理解设计模式、原则与性能优化</a></p>
<h3 data-id="heading-1">面向对象编程中的设计模式</h3>
<p>设计模式是对软件设计中常见问题的可复用解决方案。它们不是代码模板，而是可以在不同场景下调整和落地的一组设计思路。</p>
<h4 data-id="heading-2">策略模式：将算法与类解耦</h4>
<p>策略模式（Strategy Pattern）可以把一组可互换的算法抽出来，用统一的接口对外暴露，让使用方在运行时自由选择实现，而不需要把具体算法硬编码进业务类。</p>
<p>当你希望“根据条件切换算法”，又不希望让一个类膨胀到塞满 <code>if/else</code> 时，策略模式通常很好用。</p>
<p>以电商折扣为例：可能有“打折”“买一送一”等不同折扣策略。如果把所有折扣规则都堆在 <code>Cart</code> 里，<code>Cart</code> 会越来越难维护。用策略模式则可以把折扣计算拆到不同策略类里。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DiscountStrategy</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> <span class="hljs-variable">$total</span></span>): <span class="hljs-title">float</span></span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PercentDiscount</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">DiscountStrategy</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> <span class="hljs-variable">$percent</span></span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> <span class="hljs-variable">$total</span></span>): <span class="hljs-title">float</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$total</span> * (<span class="hljs-number">1</span> - <span class="hljs-variable language_">$this</span>-&gt;percent);
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BuyOneGetOneFree</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">DiscountStrategy</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> <span class="hljs-variable">$total</span></span>): <span class="hljs-title">float</span> </span>{
        <span class="hljs-comment">// 简单模拟：买一送一即总价减半</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$total</span> / <span class="hljs-number">2</span>;
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cart</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$items</span> = [];

    <span class="hljs-comment">// 依赖注入：注入策略接口而非具体实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> DiscountStrategy <span class="hljs-variable">$strategy</span></span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addItem</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> <span class="hljs-variable">$price</span></span>): <span class="hljs-title">void</span> </span>{
        <span class="hljs-variable language_">$this</span>-&gt;items[] = <span class="hljs-variable">$price</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">total</span>(<span class="hljs-params"/>): <span class="hljs-title">float</span> </span>{
        <span class="hljs-variable">$subtotal</span> = <span class="hljs-title function_ invoke__">array_sum</span>(<span class="hljs-variable">$this</span>-&gt;items);
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;strategy-&gt;<span class="hljs-title function_ invoke__">apply</span>(<span class="hljs-variable">$subtotal</span>);
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-variable">$cart</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cart</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PercentDiscount</span>(<span class="hljs-number">0.1</span>)); <span class="hljs-comment">// 打九折</span>
<span class="hljs-variable">$cart</span>-&gt;<span class="hljs-title function_ invoke__">addItem</span>(<span class="hljs-number">100</span>);
<span class="hljs-variable">$cart</span>-&gt;<span class="hljs-title function_ invoke__">addItem</span>(<span class="hljs-number">200</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$cart</span>-&gt;<span class="hljs-title function_ invoke__">total</span>(); <span class="hljs-comment">// 输出: 270</span>
</code></pre>
<p>这里 <code>Cart</code> 不需要知道“折扣怎么算”，它只依赖一个抽象的 <code>DiscountStrategy</code>。想更换折扣规则，只要传入不同的策略实现即可，无需修改 <code>Cart</code>。</p>
<h4 data-id="heading-3">单例模式：确保只有一个实例</h4>
<p>单例模式（Singleton Pattern）用于保证某个类在应用生命周期内只有一个实例，并提供一个全局访问点。</p>
<p>它常用于管理共享资源，例如数据库连接、配置对象等：这类对象通常不希望被频繁创建，也不希望出现多个实例导致状态不一致。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseConnection</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> ?DatabaseConnection <span class="hljs-variable">$instance</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 私有化构造函数，防止外部 new</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"/>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"连接到数据库...\n"</span>;
    }

    <span class="hljs-comment">// 防止克隆</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__clone</span>(<span class="hljs-params"/>) </span>{}

    <span class="hljs-comment">// 防止反序列化</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"/>) </span>{
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">"Cannot unserialize singleton"</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInstance</span>(<span class="hljs-params"/>): <span class="hljs-title">DatabaseConnection</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>::<span class="hljs-variable">$instance</span> === <span class="hljs-literal">null</span>) {
            <span class="hljs-built_in">self</span>::<span class="hljs-variable">$instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>::<span class="hljs-variable">$instance</span>;
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-variable">$db1</span> = <span class="hljs-title class_">DatabaseConnection</span>::<span class="hljs-title function_ invoke__">getInstance</span>();
<span class="hljs-variable">$db2</span> = <span class="hljs-title class_">DatabaseConnection</span>::<span class="hljs-title function_ invoke__">getInstance</span>();

<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$db1</span> === <span class="hljs-variable">$db2</span>); <span class="hljs-comment">// 输出: bool(true)</span>
</code></pre>
<p>上面 <code>DatabaseConnection</code> 通过重写 <code>__new__</code> 来确保无论实例化多少次，返回的都是同一个对象。</p>
<h3 data-id="heading-4">SOLID 原则</h3>
<p>SOLID 是一组面向对象设计原则，目标是让系统更易维护、可扩展、可测试。把这些原则落到日常编码里，能减少很多常见的“面向对象写着写着就变成一团”的问题。</p>
<h4 data-id="heading-5">单一职责原则（SRP）</h4>
<p>单一职责原则（Single Responsibility Principle）强调：一个类应该只有一个引起它变化的原因。换句话说，一个类最好只负责一件事。</p>
<p>例如 <code>User</code> 既保存用户数据又负责发送通知，会同时承担“数据模型”和“通知逻辑”两种职责。可以按 SRP 拆分：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span></span>) </span>{}
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserNotification</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendWelcomeEmail</span>(<span class="hljs-params">User <span class="hljs-variable">$user</span></span>): <span class="hljs-title">void</span> </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"正在向 <span class="hljs-subst">{$user-&gt;name}</span> 发送欢迎邮件。\n"</span>;
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-variable">$user</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>);
<span class="hljs-variable">$notifier</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserNotification</span>();
<span class="hljs-variable">$notifier</span>-&gt;<span class="hljs-title function_ invoke__">sendWelcomeEmail</span>(<span class="hljs-variable">$user</span>);
</code></pre>
<p>拆分之后，每个类的职责更集中，测试与修改也更可控。</p>
<h4 data-id="heading-6">开放/封闭原则（OCP）</h4>
<p>开放/封闭原则（Open/Closed Principle）要求：对扩展开放，对修改封闭。也就是在不改动既有代码的前提下，能够通过扩展来引入新行为。</p>
<p>下面用形状面积示例说明：<code>Shape</code> 定义接口，不同形状通过继承实现 <code>area()</code>，调用方不需要知道具体类型。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Shape</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">area</span>(<span class="hljs-params"/>): <span class="hljs-title">float</span></span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Circle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Shape</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> <span class="hljs-variable">$radius</span></span>) </span>{}
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">area</span>(<span class="hljs-params"/>): <span class="hljs-title">float</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">pi</span>() * <span class="hljs-title function_ invoke__">pow</span>(<span class="hljs-variable">$this</span>-&gt;radius, <span class="hljs-number">2</span>);
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rectangle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Shape</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> <span class="hljs-variable">$width</span>, <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> <span class="hljs-variable">$height</span></span>) </span>{}
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">area</span>(<span class="hljs-params"/>): <span class="hljs-title">float</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;width * <span class="hljs-variable language_">$this</span>-&gt;height;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printArea</span>(<span class="hljs-params">Shape <span class="hljs-variable">$shape</span></span>) </span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"面积: "</span> . <span class="hljs-variable">$shape</span>-&gt;<span class="hljs-title function_ invoke__">area</span>() . <span class="hljs-string">"\n"</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_ invoke__">printArea</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-number">5</span>));
<span class="hljs-title function_ invoke__">printArea</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>(<span class="hljs-number">4</span>, <span class="hljs-number">6</span>));
</code></pre>
<p>当你要新增一种形状时，只需要添加新子类即可，不必改动 <code>print_area</code> 或既有形状代码。</p>
<h4 data-id="heading-7">里氏替换原则（LSP）</h4>
<p>里氏替换原则（Liskov Substitution Principle）指出：基类能出现的地方，子类也应该能替换进去，并且不影响程序正确性。它要求子类是对父类能力的“真实扩展”，而不是“表面继承”。</p>
<p>下面这个例子里，<code>Penguin</code> 继承 <code>Bird</code> 但无法飞行，导致替换失败：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bird</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fly</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span> </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"正在飞行...\n"</span>;
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Penguin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bird</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fly</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span> </span>{
        <span class="hljs-comment">// 企鹅不会飞，违反了父类 Bird 的行为预期</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"企鹅不会飞！"</span>);
    }
}

<span class="hljs-comment">/** * 修正方案：拆分接口
 * interface Bird {}
 * interface FlyingBird extends Bird { public function fly(); }
 * class Penguin implements Bird { ... }
 */</span>
</code></pre>
<p>这个设计违反了 LSP：<code>Penguin</code> 无法在需要 <code>Bird.fly()</code> 的上下文中正常工作。要解决它，通常需要重新审视抽象（例如把“会飞”能力从 <code>Bird</code> 中拆出来，或者调整继承层次）。</p>
<h4 data-id="heading-8">接口隔离原则（ISP）</h4>
<p>接口隔离原则（Interface Segregation Principle）强调：客户端不应该被迫依赖自己用不到的方法。与其做一个“很大很全”的接口，不如拆成多个小而聚焦的接口，让使用方按需组合。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Workable</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">work</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span></span>;
}

<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Eatable</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eat</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span></span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HumanWorker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Workable</span>, <span class="hljs-title">Eatable</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">work</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span> </span>{ <span class="hljs-keyword">echo</span> <span class="hljs-string">"人类在工作\n"</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eat</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span> </span>{ <span class="hljs-keyword">echo</span> <span class="hljs-string">"人类在吃饭\n"</span>; }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RobotWorker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Workable</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">work</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span> </span>{ <span class="hljs-keyword">echo</span> <span class="hljs-string">"机器人在工作\n"</span>; }
    <span class="hljs-comment">// 机器人不需要实现 eat() 接口</span>
}
</code></pre>
<p>这里 <code>Worker</code> 与 <code>Eater</code> 拆成两个接口，避免了让所有实现者都背上不需要的职责。</p>
<h4 data-id="heading-9">依赖倒置原则（DIP）</h4>
<p>依赖倒置原则（Dependency Inversion Principle）主张：高层模块不应该依赖低层模块，二者都应该依赖抽象（接口/抽象类）。这样可以降低耦合，让替换实现更容易。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Switchable</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">turnOn</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span></span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">turnOff</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span></span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LightBulb</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Switchable</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">turnOn</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span> </span>{ <span class="hljs-keyword">echo</span> <span class="hljs-string">"灯亮了\n"</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">turnOff</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span> </span>{ <span class="hljs-keyword">echo</span> <span class="hljs-string">"灯灭了\n"</span>; }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Switcher</span> </span>{
    <span class="hljs-comment">// 依赖于接口，而不是具体的 LightBulb 类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> Switchable <span class="hljs-variable">$device</span></span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">operate</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span> </span>{
        <span class="hljs-variable language_">$this</span>-&gt;device-&gt;<span class="hljs-title function_ invoke__">turnOn</span>();
    }
}

<span class="hljs-variable">$bulb</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LightBulb</span>();
<span class="hljs-variable">$switch</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Switcher</span>(<span class="hljs-variable">$bulb</span>);
<span class="hljs-variable">$switch</span>-&gt;<span class="hljs-title function_ invoke__">operate</span>();
</code></pre>
<p>这里 <code>Switch</code> 直接依赖 <code>LightBulb</code>。如果把依赖改为抽象接口（比如 <code>Switchable</code>），<code>Switch</code> 就能支持更多设备实现，而不需要改动自身代码。</p>
<h3 data-id="heading-10">面向对象编程中的性能优化与内存考量</h3>
<p>OOP 通常更强调清晰与可维护，但在大型系统里，性能与内存开销同样需要被考虑。理解对象创建、内存分配以及不可变性带来的影响，有助于在“可读性”和“效率”之间取得更好的平衡。</p>
<h4 data-id="heading-11">为值对象引入不可变性</h4>
<p>PHP 8.2 引入了 readonly class，这非常适合实现不可变的值对象。不可变对象在处理值类型（Value Object）时很常见，例如 <code>Money</code>、<code>DateRange</code>、<code>Coordinate</code>。把对象设计成不可变，可以减少共享状态带来的副作用，也更利于推理与并发场景下的安全性。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">readonly</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Money</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$currency</span>,
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$amount</span>
    </span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">Money <span class="hljs-variable">$other</span></span>): <span class="hljs-title">Money</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;currency !== <span class="hljs-variable">$other</span>-&gt;currency) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"币种不匹配"</span>);
        }
        <span class="hljs-comment">// 返回新实例，而不是修改当前对象</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Money</span>(<span class="hljs-variable language_">$this</span>-&gt;currency, <span class="hljs-variable language_">$this</span>-&gt;amount + <span class="hljs-variable">$other</span>-&gt;amount);
    }
}

<span class="hljs-variable">$m1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Money</span>(<span class="hljs-string">"CNY"</span>, <span class="hljs-number">100</span>);
<span class="hljs-variable">$m2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Money</span>(<span class="hljs-string">"CNY"</span>, <span class="hljs-number">50</span>);
<span class="hljs-variable">$result</span> = <span class="hljs-variable">$m1</span>-&gt;<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-variable">$m2</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$result</span>-&gt;amount; <span class="hljs-comment">// 150</span>
<span class="hljs-comment">// $m1-&gt;amount = 200; // 会报错，因为是 readonly</span>
</code></pre>
<p>在这个例子里，<code>Money</code> 是不可变的：每次运算都会返回一个新实例，原对象保持不变。</p>
<h4 data-id="heading-12">避免对象抖动（Object Churn）</h4>
<p>在紧密循环里频繁创建和销毁对象，会带来明显的性能问题：更多的内存分配、更高的垃圾回收（GC）压力。</p>
<p>遇到这种情况，可以考虑对象池（object pool）或复用对象，减少不必要的创建与回收开销。</p>
<h3 data-id="heading-13">总结：把原则与模式落到代码里</h3>
<p>面向对象编程提供了一套组织复杂系统的工具。设计模式（例如 Strategy、Singleton）帮助你复用成熟的结构；SOLID 原则提醒你如何划分职责、控制依赖；而不可变对象、对象创建成本等性能视角则让系统在规模化场景下更稳。</p>
<p>OOP 的重点不在“有多少类”，而在抽象是否清晰、边界是否明确、实现是否可替换、变化是否被限制在可控的范围内。把这些要点坚持下来，代码通常会更好读，也更好维护。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——拆解预训练、微调、奖励建模与强化学习四阶段（以ChatGPT构建流程为例）]]></title>    <link>https://juejin.cn/post/7585706951604355098</link>    <guid>https://juejin.cn/post/7585706951604355098</guid>    <pubDate>2025-12-21T09:16:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951604355098" data-draft-id="7585743487258378249" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——拆解预训练、微调、奖励建模与强化学习四阶段（以ChatGPT构建流程为例）"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-21T09:16:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——拆解预训练、微调、奖励建模与强化学习四阶段（以ChatGPT构建流程为例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T09:16:50.000Z" title="Sun Dec 21 2025 09:16:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>大语言模型（如ChatGPT）的“智能”并非一蹴而就，而是通过分阶段的精细化训练逐步实现的。本文基于课程内容，拆解ChatGPT的四阶段构建流程，解析每个环节的核心逻辑与技术细节。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41444af6d95f4f2fbe829b203ee1cc06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766913410&amp;x-signature=rZn%2B0TUmRXfzfopgGz0enDYPDWo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">一、阶段一：自监督预训练——给模型“打知识底子”</h2>
<p>这是大模型的<strong>基础能力奠基阶段</strong>，核心是让模型学习语言规律与世界知识。</p>
<ul>
<li><strong>核心思路</strong>：利用文本的前k个词（token），预测第k+1个词，实现“自监督学习”（无需人工标注标签）。</li>
<li><strong>训练数据</strong>：覆盖互联网网页、维基百科、书籍、GitHub代码、论文等多源语料，总量达数千亿至数万亿单词，确保内容的多样性与知识覆盖度。</li>
<li><strong>训练目标</strong>：最大化预测概率，数学表达为：
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Max</mtext><msub><mo>∑</mo><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>u</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>u</mi><mrow><mi>i</mi><mo>−</mo><mi>k</mi></mrow></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>u</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">;</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Max} \sum_{i} \log P(u_i|u_{i-k}, ..., u_{i-1}; \theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"/><span class="mord text"><span class="mord">Max</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>
（其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>u</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">u_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是语料中的词，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>是模型参数）</li>
<li><strong>输出与资源</strong>：得到“基础模型”，需<strong>1000+GPU/月</strong>的训练资源。</li>
</ul>
<h2 data-id="heading-2">二、阶段二：有监督微调（指令微调）——让模型“听懂人类指令”</h2>
<p>预训练模型能“续写文本”，但还不懂“指令”；这一阶段的目标是让模型理解人类需求。</p>
<ul>
<li><strong>核心逻辑</strong>：在预训练模型的基础上，用 <strong>“用户指令+理想输出”的标注数据</strong> 继续训练。</li>
<li><strong>训练数据</strong>：数万级标注用户指令+对应高质量输出，聚焦开放问题、阅读理解、代码生成等场景。</li>
<li><strong>能力提升</strong>：模型具备初步的指令理解能力，能完成开放领域问答、翻译、代码编写，还能泛化到未知任务。</li>
<li><strong>输出与资源</strong>：得到“SFT模型（有监督微调模型）”，需<strong>1-100GPU/天</strong>的训练资源。</li>
</ul>
<h2 data-id="heading-3">三、阶段三：奖励建模——给模型“立评价标准”</h2>
<p>这一阶段的核心是<strong>构建“文本质量评估体系”</strong>，为后续优化提供“奖励信号”。</p>
<ul>
<li><strong>核心目标</strong>：训练一个“奖励模型（RM）”，用于评估SFT模型输出内容的质量高低。</li>
<li><strong>训练方式</strong>：人工标注百万级样本——将同一个指令输入SFT模型得到多个输出，由标注人员对这些输出按质量排序，以此训练RM模型。</li>
<li><strong>作用</strong>：RM模型会成为后续强化学习的“裁判”，为模型的输出打分。</li>
<li><strong>输出与资源</strong>：得到“RM模型（奖励模型）”，需<strong>1-100GPU/天</strong>的训练资源。</li>
</ul>
<h2 data-id="heading-4">四、阶段四：强化学习——让模型“越答越贴合需求”</h2>
<p>这是ChatGPT的<strong>最终优化阶段</strong>，核心是用奖励信号让模型持续迭代。</p>
<ul>
<li><strong>核心流程</strong>：
<ol>
<li>输入十万级用户指令，让SFT模型生成输出；</li>
<li>用RM模型对输出打分（即“奖励”）；</li>
<li>根据奖励结果调整SFT模型的参数，让模型更倾向于生成高分内容。</li>
</ol>
</li>
<li><strong>最终输出</strong>：经过此阶段训练后，得到最终的ChatGPT模型。</li>
<li><strong>资源需求</strong>：需<strong>1-100GPU/天</strong>的训练资源。</li>
</ul>
<h2 data-id="heading-5">总结：ChatGPT构建的“四步逻辑”</h2>
<p>ChatGPT的训练是一个“从基础到优化”的递进过程：</p>
<ol>
<li>预训练：学语言、攒知识 → 基础模型；</li>
<li>有监督微调：学指令、懂需求 → SFT模型；</li>
<li>奖励建模：定标准、做裁判 → RM模型；</li>
<li>强化学习：靠反馈、迭代优 → ChatGPT。</li>
</ol>
<p>各阶段的<strong>数据规模、算法类型、计算资源</strong>需精准匹配，才能最终实现模型的“智能表现”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 MurmurHash + Base62 生成短链接]]></title>    <link>https://juejin.cn/post/7585574047075418112</link>    <guid>https://juejin.cn/post/7585574047075418112</guid>    <pubDate>2025-12-21T08:51:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585574047075418112" data-draft-id="7585693761532543010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 MurmurHash + Base62 生成短链接"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-21T08:51:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Charlie_Byte"/> <meta itemprop="url" content="https://juejin.cn/user/1968540037686224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 MurmurHash + Base62 生成短链接
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1968540037686224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Charlie_Byte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T08:51:08.000Z" title="Sun Dec 21 2025 08:51:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">短链接？</h2>
<p>你有没有遇到过这种情况？</p>
<blockquote>
<p>想在朋友圈分享一个链接，结果一粘贴——好家伙，一长串参数，占了半屏，还带一堆 <code>?utm_source=xxx&amp;ref=yyy……</code> 别人一看就烦，自己都懒得点。更别说在短信、海报、二维码等空间有限的场景下了。</p>
</blockquote>
<p>这时候，就需要一个<strong>短链接</strong>，比如把：</p>
<pre><code class="hljs language-text" lang="text">https://example.com/article?id=12345&amp;source=wechat&amp;utm_campaign=spring_sale
</code></pre>
<p>变成</p>
<pre><code class="hljs language-text" lang="text">https://ex.co/aB3k9
</code></pre>
<p>这类短链接简洁美观，易于传播并且可隐藏原始逻辑，用起来还是挺方便的。</p>
<h2 data-id="heading-1">哈希 + 编码 = 短码</h2>
<p>要生成短链接，关键在于将任意长度的原始 URL 映射为一个固定长度、唯一且紧凑的字符串标识符（即“短码”）。</p>
<p>这里采用两步法：</p>
<p><strong>第一步：哈希</strong></p>
<p>使用<strong>非加密型哈希函数</strong>（如 MurmurHash）将原始 URL 转换为一个固定长度的整数（通常是 32 位）。<br/>
为什么不用 MD5 或 SHA？因为它们输出太长（MD5 是 32 位十六进制字符串），而我们需要的是短</p>
<p><strong>MurmurHash 的优势</strong></p>
<ul>
<li>高性能：计算速度快，适合高并发场景</li>
<li>均匀分布：冲突率低，保证不同 URL 生成不同哈希值</li>
<li>固定种子：Guava 提供的 <code>murmur3_32_fixed()</code> 使用固定种子，确保跨 JVM、跨机器结果一致</li>
<li>非加密：不用于安全场景，正适合做 ID 生成</li>
</ul>
<p><strong>第二步：编码</strong></p>
<p>将哈希得到的整数（可能为负数）转换为<strong>Base62 字符串</strong>。</p>
<p><strong>Base62 是什么？</strong></p>
<ul>
<li>字符集：<code>0–9</code>（10个） + <code>A–Z</code>（26个） + <code>a–z</code>（26个） = 共 62 个字符</li>
<li>优点：URL 安全（不含 <code>+</code>, <code>/</code>, <code>=</code> 等特殊字符），可直接拼接到域名后</li>
<li>对比 Base64：Base64 含 <code>+</code> 和 <code>/</code>，在 URL 中需转义，不适合做短链</li>
</ul>
<p><strong>最终流程</strong></p>
<pre><code class="hljs language-text" lang="text">长 URL → MurmurHash → 32位整数 → 转无符号 long → Base62 编码 → 5~6位短码
</code></pre>
<h2 data-id="heading-2">核心代码</h2>
<p>首先，在 Maven 项目中引入 Google Guava 库（提供了稳定高效的 MurmurHash 实现）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.google.guava/guava --&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>33.5.0-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>哈希测试，看 MurmurHash 输出什么</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// import com.google.common.hash.Hashing;</span>
<span class="hljs-comment">// import java.nio.charset.StandardCharsets;</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {  
    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://tse1-mm.cn.bing.net/th/id/OIP-C.wb-bFBTpIZDy_1jcvMY_5QHaE8?w=286&amp;h=191&amp;c=7&amp;r=0&amp;o=7&amp;cb=ucfimg2&amp;dpr=1.1&amp;pid=1.7&amp;rm=3&amp;ucfimg=1"</span>;  
  
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Hashing.murmur3_32_fixed()  
            .hashString(url, StandardCharsets.UTF_8)  
            .asInt();  
    System.out.println(<span class="hljs-string">"hash: "</span> + hash); <span class="hljs-comment">// 可能为负数，如 -904567778</span>
  
    <span class="hljs-type">long</span> <span class="hljs-variable">unsignedHash</span> <span class="hljs-operator">=</span> hash &amp; <span class="hljs-number">0xFFFFFFFFL</span>; <span class="hljs-comment">// 转为无符号 long，如 3390399518</span>
    System.out.println(<span class="hljs-string">"unsignedHash: "</span> + unsignedHash);  
}
</code></pre>
<pre><code class="hljs language-text" lang="text">hash: -904567778
unsignedHash: 3390399518
</code></pre>
<p>Java 的 int 是有符号的，直接对负数做 Base62 编码会导致错误（比如模运算异常或空字符串），因此须先转为无符号 long</p>
<p>在很多业务中，同一个链接对不同用户可能有不同的行为或权限，就需要对短码进行区分生成，因此可以在生成短码时，将用户唯一标识（如 user_id、设备 ID）与原始 URL 拼接，再进行哈希：</p>
<pre><code class="hljs language-java" lang="java">create(url + <span class="hljs-string">"|"</span> + userId)
</code></pre>
<p>因为输入变了，哈希结果就变了，短码自然也不同。</p>
<h2 data-id="heading-3">完整代码</h2>
<blockquote>
<p>带注释，放心抄</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> io.jiangbyte.app.biz.urls.utils;  
  
<span class="hljs-keyword">import</span> com.google.common.hash.Hashing;  
  
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;  
  
<span class="hljs-comment">/**  
 * 1. 使用 Guava 的 Murmur3_32_fixed 哈希算法对输入字符串计算 32 位哈希值  
 * 2. 将有符号 int 转换为无符号 long（避免负数问题）  
 * 3. 将该数值使用 Base62 编码（字符集：0-9, A-Z, a-z）输出为紧凑字符串  
 */</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MurmurHashUtils</span> {  
  
    <span class="hljs-comment">/**  
     * Base62 编码字符集，按标准顺序排列  
     * - 数字 '0' 到 '9'（10 个）  
     * - 大写字母 'A' 到 'Z'（26 个）  
     * - 小写字母 'a' 到 'z'（26 个）  
     */</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] CHARS = buildBase62Chars();  
  
    <span class="hljs-comment">/**  
     * Base62 的基数，值为 62  
     * 用于进制转换计算  
     */</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BASE</span> <span class="hljs-operator">=</span> CHARS.length;  
  
    <span class="hljs-comment">/**  
     * 构建 Base62 字符数组  
     * 按照标准顺序依次填充数字、大写字母、小写字母  
     *  
     * <span class="hljs-doctag">@return</span> 长度为 62 的字符数组，索引即对应数值（如 CHARS[0]='0', CHARS[10]='A'）  
     */</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">char</span>[] buildBase62Chars() {  
        <span class="hljs-type">char</span>[] chars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">62</span>];  
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  
  
        <span class="hljs-comment">// 填充数字 '0' ~ '9'        for (char c = '0'; c &lt;= '9'; c++) {  </span>
            chars[index++] = c;  
        }  
        <span class="hljs-comment">// 填充大写字母 'A' ~ 'Z'        for (char c = 'A'; c &lt;= 'Z'; c++) {  </span>
            chars[index++] = c;  
        }  
        <span class="hljs-comment">// 填充小写字母 'a' ~ 'z'        for (char c = 'a'; c &lt;= 'z'; c++) {  </span>
            chars[index++] = c;  
        }  
  
        <span class="hljs-keyword">return</span> chars;  
    }  
  
    <span class="hljs-comment">/**  
     * 将一个非负长整型数值转换为 Base62 编码字符串  
     * 不断对 BASE 取模获取最低位字符，再除以 BASE，直到数值为 0, 最后将字符序列反转，得到高位在前的标准表示  
     *  
     * <span class="hljs-doctag">@param</span> n 待编码的非负 long 值  
     * <span class="hljs-doctag">@return</span> Base62 编码后的字符串  
     */</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">base62</span><span class="hljs-params">(<span class="hljs-type">long</span> n)</span> {  
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) {  
            <span class="hljs-keyword">return</span> <span class="hljs-string">"0"</span>; <span class="hljs-comment">// 特殊情况：0 编码为 "0"        }  </span>
  
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();  
        <span class="hljs-keyword">while</span> (n &gt; <span class="hljs-number">0</span>) {  
            sb.append(CHARS[(<span class="hljs-type">int</span>) (n % BASE)]); <span class="hljs-comment">// 取模得到当前最低位对应的字符索引  </span>
            n /= BASE;  <span class="hljs-comment">// 整除进入下一位  </span>
        }  
  
        <span class="hljs-comment">// 由于是从低位到高位追加，需反转得到正确顺序  </span>
        <span class="hljs-keyword">return</span> sb.reverse().toString();  
    }  
  
    <span class="hljs-comment">/**  
     * 对输入字符串进行哈希并生成 Base62 短字符串。  
     * 使用 Murmur3_32_fixed 算法（Guava 提供的固定种子版本，保证跨 JVM 一致性）  
     * 将结果转为无符号 32 位整数，再进行 Base62 编码  
     *  
     * <span class="hljs-doctag">@param</span> input 原始输入字符串  
     * <span class="hljs-doctag">@return</span> Base62 编码的短字符串  
     */</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">create</span><span class="hljs-params">(String input)</span> {  
        <span class="hljs-comment">// 使用 UTF-8 编码计算 Murmur3_32 哈希值（固定种子）  </span>
        <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Hashing.murmur3_32_fixed()  
                .hashString(input, StandardCharsets.UTF_8)  
                .asInt();  
  
        <span class="hljs-comment">// 将有符号 int 转换为无符号 long（避免负数导致 base62 逻辑异常）  </span>
        <span class="hljs-comment">// -1 → 0xFFFFFFFFL = 4294967295  </span>
        <span class="hljs-type">long</span> <span class="hljs-variable">unsignedHash</span> <span class="hljs-operator">=</span> hash &amp; <span class="hljs-number">0xFFFFFFFFL</span>;  
  
        <span class="hljs-keyword">return</span> base62(unsignedHash);  
    }  
  
    <span class="hljs-comment">/**  
     * 生成带用户隔离的短链标识。  
     * 若提供 userId，则将 URL 与 userId 拼接后再哈希  
     * 使得同一 URL 对不同用户生成不同短链  
     * 若 userId 为 null，则退化为普通模式  
     *  
     * <span class="hljs-doctag">@param</span> url    原始长链接  
     * <span class="hljs-doctag">@param</span> userId 用户唯一标识  
     * <span class="hljs-doctag">@return</span> 用户隔离或通用的 Base62 短字符串  
     */</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">create</span><span class="hljs-params">(String url, String userId)</span> {  
        <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) {  
            <span class="hljs-comment">// 拼接格式：原始URL + 分隔符 "|" + 用户ID  </span>
            <span class="hljs-keyword">return</span> create(url + <span class="hljs-string">"|"</span> + userId);  
        } <span class="hljs-keyword">else</span> {  
            <span class="hljs-comment">// 无用户隔离，直接哈希原始 URL</span>
            <span class="hljs-keyword">return</span> create(url);  
        }  
    }  
}
</code></pre>
<p><strong>测试输出</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {  
    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://tse1-mm.cn.bing.net/th/id/OIP-C.wb-bFBTpIZDy_1jcvMY_5QHaE8?w=286&amp;h=191&amp;c=7&amp;r=0&amp;o=7&amp;cb=ucfimg2&amp;dpr=1.1&amp;pid=1.7&amp;rm=3&amp;ucfimg=1"</span>;  
  
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Hashing.murmur3_32_fixed()  
            .hashString(url, StandardCharsets.UTF_8)  
            .asInt();  
    System.out.println(<span class="hljs-string">"hash: "</span> + hash); <span class="hljs-comment">// 有符号 int，逻辑出错，为空  </span>
  
    <span class="hljs-type">String</span> <span class="hljs-variable">base62_hash</span> <span class="hljs-operator">=</span> base62(hash);  
    System.out.println(<span class="hljs-string">"base62_hash: "</span> + base62_hash);  
  
    <span class="hljs-type">long</span> <span class="hljs-variable">unsignedHash</span> <span class="hljs-operator">=</span> hash &amp; <span class="hljs-number">0xFFFFFFFFL</span>;  
    System.out.println(<span class="hljs-string">"unsignedHash: "</span> + unsignedHash);  
  
    <span class="hljs-type">String</span> <span class="hljs-variable">base62_unsignedHash</span> <span class="hljs-operator">=</span> base62(unsignedHash);  
    System.out.println(<span class="hljs-string">"base62_unsignedHash: "</span> + base62_unsignedHash);  
  
    System.out.println(<span class="hljs-string">"create: "</span> + create(url));  
  
    System.out.println(<span class="hljs-string">"create: "</span> + create(url, <span class="hljs-string">"1234"</span>));  
    System.out.println(<span class="hljs-string">"create: "</span> + create(url, <span class="hljs-string">"1234"</span>));  
    System.out.println(<span class="hljs-string">"create: "</span> + create(url, <span class="hljs-string">"12345"</span>));  
}
</code></pre>
<pre><code class="hljs language-text" lang="text">hash: -904567778
base62_hash: 
unsignedHash: 3390399518
base62_unsignedHash: 3hRlnC
create: 3hRlnC
create: 4YmoRu
create: 4YmoRu
create: GsQoj
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[监控指标与容量预警——延迟、命中率、慢查询与内存碎片的解读方法]]></title>    <link>https://juejin.cn/post/7585758163435372550</link>    <guid>https://juejin.cn/post/7585758163435372550</guid>    <pubDate>2025-12-21T09:06:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585758163435372550" data-draft-id="7585758163435356166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="监控指标与容量预警——延迟、命中率、慢查询与内存碎片的解读方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-21T09:06:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="十月南城"/> <meta itemprop="url" content="https://juejin.cn/user/3456520290576862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            监控指标与容量预警——延迟、命中率、慢查询与内存碎片的解读方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520290576862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    十月南城
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T09:06:08.000Z" title="Sun Dec 21 2025 09:06:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>写在前面，本人目前处于求职中，如有合适内推岗位，请加微信：lpshiyue 感谢</strong></p>
<blockquote>
<p>在 Redis 运维中，监控是指数级投入回报比的投资：每增加一个关键指标监控，可能预防十倍以上的故障损失</p>
</blockquote>
<p>在解决热点 Key 与大 Key 的治理挑战后，我们面临一个更为基础且关键的问题：如何提前发现并预防这些问题的发生。完善的监控体系不仅能实时反映 Redis 健康状态，更能通过趋势分析预测潜在风险，实现从被动救火到主动预防的转变。本文将深入解析 Redis 核心监控指标，建立完整的容量预警体系，让缓存系统运行在可视、可控、可预测的轨道上。</p>
<h3 data-id="heading-0">1 监控体系的价值与构建原则</h3>
<h4 data-id="heading-1">1.1 从被动救火到主动预防</h4>
<p>Redis 作为内存数据库，对资源异常敏感，​<strong>无监控的 Redis 如同盲人驾驶高速赛车</strong>​——看似运行正常，实则危机四伏。完善的监控体系能实现三个核心价值：<strong>实时故障发现</strong>将故障发现时间从小时级缩短到分钟级，<strong>根因分析</strong>通过历史数据追溯问题源头，<strong>容量规划</strong>基于趋势预测提前扩容避免资源耗尽。</p>
<p>监控系统的缺失会导致故障放大效应。当用户首先感知问题而非运维人员时，故障影响已扩散。如所述，若由用户通过客服反馈再排查到 Redis 故障，整个发现、定位和解决时间被拉长，小故障被“无限”放大。</p>
<h4 data-id="heading-2">1.2 监控体系构建的黄金法则</h4>
<p>有效的 Redis 监控应遵循​<strong>SMART 原则</strong>​：监控指标需​<strong>具体</strong>​（Specific）、​<strong>可衡量</strong>​（Measurable）、​<strong>可达成</strong>​（Attainable）、​<strong>相关</strong>​（Relevant）和​<strong>有时效</strong>​（Time-bound）。监控不是数据堆砌，而是关键信号提取。</p>
<p><strong>分层监控</strong>理念至关重要：<strong>基础层</strong>关注服务器资源（CPU、内存、网络）；<strong>Redis 实例层</strong>跟踪连接、内存、持久化状态；<strong>业务层</strong>聚焦命中率、延迟等业务相关指标。这种分层结构确保问题定位效率。</p>
<h3 data-id="heading-3">2 核心性能指标深度解读</h3>
<h4 data-id="heading-4">2.1 延迟（Latency）：用户体验的直接体现</h4>
<p>延迟是 Redis 性能最直观的指标，衡量从命令发送到收到响应的总时间。单线程架构使 Redis 对延迟异常敏感，任何微小延迟都可能累积成严重瓶颈。</p>
<p>​<strong>延迟监控的多维度实现</strong>​：</p>
<ul>
<li>
<p>​<strong>内在延迟</strong>​：使用 <code>redis-cli --intrinsic-latency</code> 测量 Redis 服务器自身延迟</p>
</li>
<li>
<p>​<strong>网络延迟</strong>​：通过 <code>redis-cli --latency -h host -p port</code> 测试客户端到服务器的往返延迟</p>
</li>
<li>
<p>​<strong>命令延迟</strong>​：配置 <code>latency-monitor-threshold</code> 启用延迟监控框架</p>
<h2 data-id="heading-5">设置延迟监控阈值为100毫秒</h2>
<p>CONFIG SET latency-monitor-threshold 100</p>
<h2 data-id="heading-6">查看最新延迟事件</h2>
<p>LATENCY LATEST</p>
<h2 data-id="heading-7">获取延迟历史数据</h2>
<p>LATENCY HISTORY command
​</p>
</li>
</ul>
<p>基于的延迟监控配置</p>
<p>​<strong>延迟的典型阈值参考</strong>​：</p>
<ul>
<li>理想延迟：&lt;1ms（内存操作）</li>
<li>可接受延迟：1-5ms（正常网络开销）</li>
<li>需关注延迟：5-10ms（可能存在性能瓶颈）</li>
<li>问题延迟：&gt;10ms（需立即排查）</li>
</ul>
<h4 data-id="heading-8">2.2 命中率（Hit Rate）：缓存效率的核心指标</h4>
<p>命中率衡量缓存有效性，计算公式为：<code>keyspace_hits / (keyspace_hits + keyspace_misses)</code>。低命中率意味着缓存效率低下，大量请求直接穿透到后端数据库。</p>
<p>​<strong>命中率解读与优化策略</strong>​：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 命中率计算示例</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> <span class="hljs-title">calculateHitRate</span>()</span> {
    <span class="hljs-built_in">long</span> hits = redis.info(<span class="hljs-string">"stats"</span>).getLong(<span class="hljs-string">"keyspace_hits"</span>);
    <span class="hljs-built_in">long</span> misses = redis.info(<span class="hljs-string">"stats"</span>).getLong(<span class="hljs-string">"keyspace_misses"</span>);
    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">double</span>)hits / (hits + misses);
}
​
</code></pre>
<p>基于的命中率计算逻辑</p>
<p>​<strong>命中率阈值指南</strong>​：</p>
<ul>
<li>优秀：&gt;95%（缓存效果极佳）</li>
<li>良好：90%-95%（缓存效果良好）</li>
<li>需关注：80%-90%（需要优化）</li>
<li>较差：&lt;80%（缓存策略需重构）</li>
</ul>
<p>低命中率通常由以下原因导致：<strong>内存不足</strong>导致频繁数据淘汰，<strong>数据访问模式变化</strong>使热点数据失效，<strong>TTL 设置过短</strong>导致数据过早失效。</p>
<h4 data-id="heading-9">2.3 内存碎片（Memory Fragmentation）：隐藏的性能杀手</h4>
<p>内存碎片率通过 <code>mem_fragmentation_ratio</code>（used_memory_rss/used_memory）计算，反映内存使用效率。</p>
<p>​<strong>碎片率解读与行动指南</strong>​：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查看内存碎片率</span>
redis-cli info memory | <span class="hljs-keyword">grep</span> mem_fragmentation_ratio
​
</code></pre>
<p>​</p>
<p>碎片率判断标准</p>
<p>​：</p>
<ul>
<li>​<strong>理想状态</strong>​（1.0-1.5）：内存分配紧凑，无显著碎片</li>
<li>​<strong>需关注</strong>​（1.5-2.0）：存在一定碎片，考虑监控优化</li>
<li>​<strong>问题状态</strong>​（&gt;2.0）：碎片严重，需要重启或内存优化</li>
<li>​<strong>危险信号</strong>​（&lt;1.0）：内存交换到磁盘，性能严重下降</li>
</ul>
<p>高碎片率通常由​<strong>频繁修改不同大小数据</strong>​、<strong>大量键过期</strong>导致。解决方案包括重启实例、使用 <code>MEMORY PURGE</code>（需 Jemalloc）或优化数据访问模式。</p>
<h3 data-id="heading-10">3 容量预警指标体系</h3>
<h4 data-id="heading-11">3.1 内存容量规划与预警</h4>
<p>内存是 Redis 最关键的资源，需建立多级预警机制：</p>
<p>​<strong>内存使用率预警阈值</strong>​：</p>
<p>使用率</p>
<p>告警级别</p>
<p>处理动作</p>
<p>≤70%</p>
<p>正常</p>
<p>持续监控</p>
<p>70%-85%</p>
<p>警告</p>
<p>检查大 Key，优化数据</p>
<p>85%-95%</p>
<p>严重</p>
<p>准备扩容，优化过期策略</p>
<p>≥95%</p>
<p>紧急</p>
<p>立即扩容，可能已拒绝写入</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 监控内存使用情况</span>
<span class="hljs-string">redis-cli</span> <span class="hljs-string">info</span> <span class="hljs-string">memory</span>
<span class="hljs-attr">used_memory:</span> <span class="hljs-number">1000000</span>       <span class="hljs-comment"># Redis分配内存总量</span>
<span class="hljs-attr">used_memory_rss:</span> <span class="hljs-number">1500000</span>   <span class="hljs-comment"># 操作系统视角内存占用</span>
<span class="hljs-attr">used_memory_peak:</span> <span class="hljs-number">1200000</span>  <span class="hljs-comment"># 历史峰值内存</span>
<span class="hljs-attr">maxmemory:</span> <span class="hljs-number">2000000</span>        <span class="hljs-comment"># 最大内存限制</span>
<span class="hljs-string">​</span>
</code></pre>
<p>基于的内存监控指标</p>
<p>​<strong>内存优化策略</strong>​：</p>
<ul>
<li>​<strong>数据分片</strong>​：将大数据集分布到多个实例</li>
<li>​<strong>压缩存储</strong>​：对适合数据启用压缩</li>
<li>​<strong>过期策略</strong>​：设置合理的 TTL 和淘汰策略</li>
</ul>
<h4 data-id="heading-12">3.2 连接数容量管理</h4>
<p>连接数超限会导致新连接被拒绝，监控 <code>connected_clients</code> 并设置合理阈值至关重要：</p>
<p>​<strong>连接数监控要点</strong>​：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 查看连接数信息</span>
<span class="hljs-string">redis-cli</span> <span class="hljs-string">info</span> <span class="hljs-string">clients</span>
<span class="hljs-attr">connected_clients:</span> <span class="hljs-number">100</span>        <span class="hljs-comment"># 当前连接数</span>
<span class="hljs-attr">maxclients:</span> <span class="hljs-number">10000</span>            <span class="hljs-comment"># 最大连接数限制</span>
<span class="hljs-attr">blocked_clients:</span> <span class="hljs-number">0</span>           <span class="hljs-comment"># 阻塞连接数</span>
<span class="hljs-string">​</span>
</code></pre>
<p>基于的连接数监控</p>
<p>​<strong>连接数预警阈值</strong>​：</p>
<ul>
<li>​<strong>正常</strong>​：&lt;80% maxclients</li>
<li>​<strong>警告</strong>​：80%-95% maxclients</li>
<li>​<strong>紧急</strong>​：&gt;95% maxclients 或出现 <code>rejected_connections</code></li>
</ul>
<p>连接数突增通常由​<strong>连接池配置错误</strong>​、<strong>客户端未正确关闭连接</strong>或<strong>慢查询阻塞</strong>导致。应监控 <code>blocked_clients</code> 了解阻塞命令情况。</p>
<h4 data-id="heading-13">3.3 网络带宽与吞吐量监控</h4>
<p>网络带宽影响 Redis 吞吐能力，需监控网络输入输出：</p>
<p>​<strong>关键网络指标</strong>​：</p>
<ul>
<li>​<strong>instantaneous_input_kbps</strong>​：瞬时输入带宽</li>
<li>​<strong>instantaneous_output_kbps</strong>​：瞬时输出带宽</li>
<li>​<strong>total_net_input_bytes</strong>​：累计输入流量</li>
<li>​<strong>total_net_output_bytes</strong>​：累计输出流量</li>
</ul>
<p>千兆网卡理论极限约 125MB/s，当网络吞吐接近极限时需考虑分片或升级网络。</p>
<h3 data-id="heading-14">4 慢查询分析与优化</h3>
<h4 data-id="heading-15">4.1 慢查询诊断框架</h4>
<p>慢查询是 Redis 性能的常见瓶颈，通过慢日志功能识别：</p>
<p>​<strong>慢查询配置与查看</strong>​：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 设置慢查询阈值（微秒）</span>
CONFIG SET slowlog-log-slower-than <span class="hljs-number">10000</span>

<span class="hljs-comment"># 设置慢查询日志长度</span>
CONFIG SET slowlog-<span class="hljs-built_in">max</span>-<span class="hljs-built_in">len</span> <span class="hljs-number">128</span>

<span class="hljs-comment"># 查看慢查询</span>
SLOWLOG GET <span class="hljs-number">10</span>
​
</code></pre>
<p>基于的慢查询配置</p>
<p>​<strong>慢查询分析维度</strong>​：</p>
<ol>
<li>​<strong>命令类型</strong>​：识别耗时最高的命令模式</li>
<li>​<strong>执行时间</strong>​：分析命令执行时间分布</li>
<li>​<strong>发生频率</strong>​：统计慢查询发生频率</li>
<li>​<strong>时间规律</strong>​：寻找慢查询的时间规律</li>
</ol>
<h4 data-id="heading-16">4.2 常见慢查询场景与解决方案</h4>
<p>​<strong>大 Key 操作</strong>​：拆分超过 10KB 的 String 或元素超 1000 的集合</p>
<p>​<strong>复杂运算</strong>​：避免在 Redis 内执行 O(N)复杂度的操作</p>
<p>​<strong>阻塞命令</strong>​：谨慎使用 BLPOP、BRPOP 等阻塞命令</p>
<p>优化方案包括​<strong>数据分片</strong>​、<strong>管道化操作</strong>减少网络往返，<strong>Lua 脚本优化</strong>将多个操作合并。</p>
<h3 data-id="heading-17">5 持久化与复制监控</h3>
<h4 data-id="heading-18">5.1 持久化健康度检查</h4>
<p>持久化影响数据安全，需关注关键指标：</p>
<p>​<strong>RDB 持久化监控</strong>​：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查RDB状态</span>
redis-cli info persistence
rdb_last_bgsave_status:ok    <span class="hljs-comment"># 上次bgsave状态</span>
rdb_last_bgsave_time_sec:2    <span class="hljs-comment"># 上次bgsave耗时</span>
latest_fork_usec:500          <span class="hljs-comment"># 最近fork耗时(微秒)</span>
​
</code></pre>
<p>基于的持久化监控</p>
<p>​<strong>AOF 持久化监控</strong>​：</p>
<ul>
<li>​<strong>aof_last_bgrewrite_status</strong>​：AOF 重写状态</li>
<li>​<strong>aof_current_size</strong>​：AOF 当前大小</li>
<li>​<strong>aof_base_size</strong>​：AOF 基础大小</li>
</ul>
<p>持久化故障预警点包括 bgsave 失败、fork 耗时过长（&gt;1 秒）、AOF 重写异常等。</p>
<h4 data-id="heading-19">5.2 主从复制健康监控</h4>
<p>复制延迟可能导致数据不一致，需密切监控：</p>
<p>​<strong>复制状态监控</strong>​：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看复制信息</span>
redis-cli info replication
role:master                    <span class="hljs-comment"># 实例角色</span>
master_repl_offset:1000       <span class="hljs-comment"># 主节点复制偏移量</span>
slave_repl_offset:980         <span class="hljs-comment"># 从节点复制偏移量</span>
replica_backlog_histlen:100   <span class="hljs-comment"># 复制积压缓冲区长度</span>
​
</code></pre>
<p>基于的复制监控</p>
<p>​<strong>复制延迟计算与告警</strong>​：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 计算复制延迟</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title">getReplicationLag</span><span class="hljs-params">(<span class="hljs-type">String</span> masterHost, <span class="hljs-type">int</span> masterPort)</span> </span>{
    <span class="hljs-type">long</span> masterOffset = <span class="hljs-built_in">getMasterOffset</span>(masterHost, masterPort);
    <span class="hljs-type">long</span> slaveOffset = <span class="hljs-built_in">getSlaveOffset</span>();
    <span class="hljs-keyword">return</span> masterOffset - slaveOffset;  <span class="hljs-comment">// 延迟偏移量</span>
}
​
</code></pre>
<p>基于的复制延迟计算</p>
<p>复制延迟告警阈值建议：​<strong>警告</strong>​&gt;10MB，​<strong>严重</strong>​&gt;100MB，​<strong>紧急</strong>​&gt;1GB（可能触发全量同步）。</p>
<h3 data-id="heading-20">6 监控系统实战部署</h3>
<h4 data-id="heading-21">6.1 Prometheus + Grafana 监控栈</h4>
<p>现代监控推荐使用 Prometheus 采集数据，Grafana 展示：</p>
<p>​<strong>部署 Redis Exporter</strong>​：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.yml示例</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">redis-exporter:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">oliver006/redis_exporter</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9121:9121"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">REDIS_ADDR=redis://redis:6379</span>
<span class="hljs-string">​</span>
</code></pre>
<p>基于的 Exporter 部署</p>
<p>​<strong>Prometheus 配置</strong>​：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'redis'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'redis-exporter:9121'</span>]
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>
<span class="hljs-string">​</span>
</code></pre>
<p>基于的 Prometheus 配置</p>
<h4 data-id="heading-22">6.2 关键告警规则配置</h4>
<p>基于 Prometheus 的告警规则示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">groups:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">redis.rules</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">RedisDown</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">up{job="redis"}</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
    <span class="hljs-attr">annotations:</span>
      <span class="hljs-attr">summary:</span> <span class="hljs-string">"Redis实例下线"</span>
      
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">RedisMemoryUsageHigh</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">(redis_memory_used_bytes</span> <span class="hljs-string">/</span> <span class="hljs-string">redis_memory_max_bytes)</span> <span class="hljs-string">*</span> <span class="hljs-number">100</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">85</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
    <span class="hljs-attr">annotations:</span>
      <span class="hljs-attr">summary:</span> <span class="hljs-string">"Redis内存使用率过高"</span>
      
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">RedisHitRateLow</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">(rate(redis_keyspace_hits_total[5m])</span> <span class="hljs-string">/</span> <span class="hljs-string">(rate(redis_keyspace_hits_total[5m])</span> <span class="hljs-string">+</span> <span class="hljs-string">rate(redis_keyspace_misses_total[5m])))</span> <span class="hljs-string">*</span> <span class="hljs-number">100</span> <span class="hljs-string">&lt;</span> <span class="hljs-number">90</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
    <span class="hljs-attr">annotations:</span>
      <span class="hljs-attr">summary:</span> <span class="hljs-string">"Redis缓存命中率过低"</span>
<span class="hljs-string">​</span>
</code></pre>
<p>基于的告警规则</p>
<h3 data-id="heading-23">7 容量规划与预警实战</h3>
<h4 data-id="heading-24">7.1 容量规划方法论</h4>
<p>有效的容量规划基于历史数据趋势分析，需考虑以下因素：</p>
<p>​<strong>数据增长趋势</strong>​：分析日常数据增量，预测未来容量需求</p>
<p>​<strong>业务增长预期</strong>​：结合业务规划，预估访问量增长</p>
<p>​<strong>季节性波动</strong>​：识别业务高峰期，预留足够缓冲容量</p>
<p>容量规划公式示例：</p>
<pre><code class="hljs language-scss" lang="scss">所需容量 = 当前数据量 × (<span class="hljs-number">1</span> + 月增长率)^月份 + 安全余量(<span class="hljs-number">20%</span>)
​
</code></pre>
<h4 data-id="heading-25">7.2 预警等级与响应机制</h4>
<p>建立多级预警机制，确保及时响应：</p>
<p>​<strong>三级预警体系</strong>​：</p>
<ul>
<li>​<strong>黄色预警</strong>​（使用率 &gt;80%）：监控关注，每周回顾</li>
<li>​<strong>橙色预警</strong>​（使用率 &gt;90%）：立即分析，3 天内处理</li>
<li>​<strong>红色预警</strong>​（使用率 &gt;95%）：紧急处理，立即扩容</li>
</ul>
<h3 data-id="heading-26">总结</h3>
<p>Redis 监控不是简单的数据收集，而是通过关键指标洞察系统状态的艺术。有效的监控体系应聚焦<strong>延迟、命中率、内存碎片、慢查询</strong>等核心指标，建立<strong>多级预警</strong>机制，实现从被动救火到主动预防的转变。</p>
<p>监控的价值不仅在于实时告警，更在于提供<strong>容量规划</strong>的数据支撑和<strong>性能优化</strong>的决策依据。通过完善的监控体系，Redis 运维团队能够提前发现潜在风险，优化资源配置，确保缓存系统持续稳定运行。</p>
<p><strong>监控的终极目标不是收集数据，而是通过数据驱动决策，将问题消灭在发生之前。</strong></p>
<p><strong>📚 下篇预告</strong>​</p>
<p>《MQ 选型框架——Kafka/RabbitMQ/RocketMQ 的模型差异与业务匹配清单》—— 我们将深入探讨：</p>
<ul>
<li>📨 ​<strong>消息模型对比</strong>​：发布-订阅、点对点、事务消息的适用场景分析</li>
<li>🚀 ​<strong>吞吐性能基准</strong>​：百万级消息吞吐的架构设计与优化策略</li>
<li>💾 ​<strong>可靠性保障</strong>​：消息持久化、副本同步与故障恢复机制</li>
<li>📊 ​<strong>运维复杂度评估</strong>​：集群管理、监控告警与扩展性对比</li>
<li>🎯 ​<strong>选型决策矩阵</strong>​：不同业务场景下的技术选型标准指南</li>
</ul>
<p><strong>​点击关注，掌握消息中间件选型的核心方法论！​</strong>​</p>
<blockquote>
<p>​<strong>今日行动建议</strong>​：</p>
<ol>
<li>检查现有 Redis 监控覆盖度，确保关键指标无遗漏</li>
<li>配置多级预警阈值，建立预警响应流程</li>
<li>分析历史容量数据，制定未来 3-6 个月扩容规划</li>
<li>建立慢查询定期分析机制，持续优化性能瓶颈</li>
</ol>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React + Vite：用Fetch将.csv大文件数据转成JSON字符串]]></title>    <link>https://juejin.cn/post/7585555806667653154</link>    <guid>https://juejin.cn/post/7585555806667653154</guid>    <pubDate>2025-12-21T08:07:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585555806667653154" data-draft-id="7585555806667472930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React + Vite：用Fetch将.csv大文件数据转成JSON字符串"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-12-21T08:07:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="学高数就犯困"/> <meta itemprop="url" content="https://juejin.cn/user/54353143012724"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React + Vite：用Fetch将.csv大文件数据转成JSON字符串
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/54353143012724/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    学高数就犯困
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T08:07:11.000Z" title="Sun Dec 21 2025 08:07:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 React + Vite：用 Fetch 将 CSV 文件数据转成 JSON 字符串</h2>
<h4 data-id="heading-1">🏕 背景</h4>
<p>在一些小型项目中，前端可能需要直接处理 CSV 文件数据，将其转换为 JSON 字符串后再进行逻辑操作和展示。本文将会介绍两种方法。</p>
<h4 data-id="heading-2">🌄 方法1：将 CSV 放在<code>public</code>目录下，用<code>fetch</code>读取</h4>
<h5 data-id="heading-3">代码实现</h5>
<p>工具函数：csv -&gt; json</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/utils/csvParser.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">csvParser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">{ file }</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(file);
    <span class="hljs-keyword">if</span> (!resp.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${resp.status}</span>`</span>);
    }

    <span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> resp.<span class="hljs-title function_">text</span>(); <span class="hljs-comment">// 转成文本</span>
    <span class="hljs-keyword">const</span> lines = text.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\r?\n/</span>); <span class="hljs-comment">// 每一行作为数组一个元素</span>
    <span class="hljs-keyword">const</span> header = lines[<span class="hljs-number">0</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">","</span>); <span class="hljs-comment">// 把表头单独提取出来</span>

    <span class="hljs-keyword">const</span> data = lines.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">line</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> values = line.<span class="hljs-title function_">split</span>(<span class="hljs-string">","</span>); <span class="hljs-comment">// 具体每一行数据的值</span>
      <span class="hljs-keyword">const</span> row = {}; <span class="hljs-comment">// 最终数据下的逐行的载体</span>
      header.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">h, i</span>) =&gt;</span> {
        row[h] = values[i] ?? <span class="hljs-string">""</span>;
      });
      <span class="hljs-keyword">return</span> row;
    });
    <span class="hljs-keyword">return</span> data;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
    <span class="hljs-keyword">return</span> [];
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> csvParser;
</code></pre>
<p>在 React 中使用</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/pages/Home.jsx</span>
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { csvParser } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadcsv</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">csvParser</span>({ <span class="hljs-attr">file</span>: <span class="hljs-string">"/testInfo.csv"</span> });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  };
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">loadcsv</span>();
  }, []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Home</span>;
</code></pre>
<h5 data-id="heading-4">注意事项</h5>
<p>我们应该将所需要的 CSV 文件放在<code>public</code>目录下而非<code>src/assets</code>目录下，采取直接调用。</p>
<blockquote>
<p>当 CSV 放在<code>src/assets</code>下并通过<code>import</code>或模块方式加载时， Vite 会将其打包成模块路径，<code>fetch</code>实际请求的是开发服务器的模块入口。对于大文件，这会导致请求头中包含过多信息，从而触发 431 错误。</p>
</blockquote>
<p>P.S. 如果忘记了<code>fetch</code>的具体用法...<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1ahBwBWEa9%3Fvd_source%3D5efd67697f12ad6e7903bc924c0815ba" target="_blank" title="https://www.bilibili.com/video/BV1ahBwBWEa9?vd_source=5efd67697f12ad6e7903bc924c0815ba" ref="nofollow noopener noreferrer">传送门</a></p>
<h4 data-id="heading-5">🌄 方法2：利用 Rollup 插件直接 <code>import</code> CSV</h4>
<p>由于 Vite 的底层构建引擎包含 Rollup，我们可以直接利用 Rollup 的官方插件生态来扩展功能，直接将 CSV 文件作为模块导入。</p>
<h5 data-id="heading-6">代码实现</h5>
<p>安装开发依赖：</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> -D <span class="hljs-keyword">@rollup</span>/plugin-dsv
</code></pre>
<p>配置vite</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">"@vitejs/plugin-react"</span>;
<span class="hljs-keyword">import</span> dsv <span class="hljs-keyword">from</span> <span class="hljs-string">"@rollup/plugin-dsv"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>(), <span class="hljs-title function_">dsv</span>()],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">"@"</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"src"</span>),
    },
  },
});
</code></pre>
<p>在 React 中使用</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/pages/Home.jsx</span>
<span class="hljs-keyword">import</span> data <span class="hljs-keyword">from</span> <span class="hljs-string">"@/assets/testInfo.csv"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Home</span>;
</code></pre>
<h5 data-id="heading-7">注意事项</h5>
<p>适用于小文件，较大文件、关注性能的话还是更推荐使用第一种。</p>
<h4 data-id="heading-8">🚉 结语</h4>
<p>在 React + Vite 项目中处理 CSV 文件时，选择合适的加载方式非常重要：</p>
<ul>
<li>小文件：可以直接通过 <code>import</code> 导入，开发快速方便。</li>
<li>大文件：推荐放在 <code>public</code> 目录，用 <code>fetch</code> 异步加载，并结合分页或虚拟渲染，保证性能和稳定性。</li>
</ul>
<p>掌握这两种方法后，你可以根据项目需求灵活处理不同规模的 CSV 数据，让前端数据处理既高效又安全。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript和JavaScript到底有什么区别？]]></title>    <link>https://juejin.cn/post/7585502118460571667</link>    <guid>https://juejin.cn/post/7585502118460571667</guid>    <pubDate>2025-12-21T09:54:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585502118460571667" data-draft-id="7585490245007523846" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript和JavaScript到底有什么区别？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-21T09:54:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江城开朗的豌豆"/> <meta itemprop="url" content="https://juejin.cn/user/3307789418773736"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript和JavaScript到底有什么区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3307789418773736/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江城开朗的豌豆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T09:54:46.000Z" title="Sun Dec 21 2025 09:54:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(1turn)}}.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#36ace1;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{color:#36ace1}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"";display:block;position:absolute;left:0;top:0;bottom:0;margin:auto;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAF8UlEQVRIS71Wa2wUVRT+7r0zu9t2t/RBaSioPCpYbIUfaEIQUogSAwZDAlUSGwgg/CBATExMCJH1D2hIfOEjFEUEhViCgBgIUCH44OkjPAMGBVqhpUCfW3Zn5z7MuQOE0hYxMdxJdmd25s53vnO+851leMCLPWA8/CfA2TsvL8n7q+nTFfNLG+4VqInHOeJLDQMzdz/3r4DGGDb9lxu+aPcE7U61JHDMDePcuv0O21ShugOefqDdtBie3Dk6K/O+Ab+qOjJiz7Ahv6c8hbDDwRiQlgYGDOcaWyEcjg8On+j71IpJndjGt9XO+jM7+pkywNvbazIfercieSdoJ4bE5sWjyZqMpDdeaQNXMNC34ME3LV8B56+1w3AOgk+EXe/Ub6uiLB6XdH/G/mYjeBCcFwnt3zQqWt4t4NjjnhzQ1CGkBhwOCMFAB71U0qsYgRlwBtQ1tiEJAy44OBdQUmFK3aWS06NLT+ukZAQoKCCjsfbDmk6p78RwX3ncWffmIj8U4kh6GpEwh+9rGy23LDU4GBrrm9DsuDYIGMAYIC/EUNQ7Cq1hn+WM2TI8f+jEyCmvjfn1FssuojHx6tDkyZOaCzr8TNpASzDAk8amlRIrEylcSGsYrcGIstIYWhgDDIM2BiGH3ywFkGAC1U9n38bpVqWGdk6r4HMWrZZaG1D5KLn0qYyBEAKnG1otAxLR8L7Z9nfP13CJHQ/ST4vK8sVHe8JsU0U6uO5hlexo8PI7vNDQomwoBRAwpSmtgJAAztS3QLsOsmBQlBtFJMQhlbbPUBBUR7o2hqHVddLbRsfCPQJ+u3TPw8uGl1yklAlHIJZKo3//XEhlLCtifPFyM7xwCI/lZ8IKTTBbS7pPLIggZZsSQ+zXbT4UYSsnet3UMM5HPT5LGbrDGYQroClyT2Jwnyj9aN949e8mDCwuRFoqKxRHUJ21BSDRELuQYGhvbMVV32Dp2RuxcfHSRBfAYTsbU9nJdFj5EiLkglHkRInC1xoxKbH9hQJIaTDvxxTCUddWl4wg0dCCtqSPDmoVx4Eitpxh64ZtsT6b5ie6pPRkfF90TllxOzEwmipMKRRgHODGgCuJkqIcvDdC2BZ5Y+tlHHMzkAKghbAxcQqQDiKrFBxhqg5MHTivS1tQ+sdsvaQl5Yd6yfdRXNQLsQwXnq/AQFLXEIIjzBSuNaaR0SuEtkQKl9IKjAsbJaWfzo1USDsM6zceDJfeVGgnhhN2N7YOyo5kJz1pa2AbgfrO1gRwXW6vSRQNtddR+EhvKGmseskgTtY2Q7kucYWWgToPHzyUyXry0iXfnBtfl5f/PaWPvPNW/zkOAQegJHltFE5dSaCskHqPVEnqpMAMEgkPtR1pKxyh/N0/vTToubtH1G3RmLjhM8ubKXfWB2mRa9ySOaWS2uT8lTZ0cI6I52Ngv7zAbW9mQVm1cpytu441P38XeXTlQu+e46nyh+bjLkMZRU0MCYTCJWZSG1y7cBWNURpxBlxqFBfEwGnGGhaYPSNwhpSv4DK+/vPynBk9MqRIiOWs8a2WJTm9a+cgh6SaMIMz9W1WjYHHMtv0wSmZdWB9gdsya/rcYVg7JoffCdqlD6ceTpiY59tM0PhJp5WNvra+BQkejCMyBarr8KKYDcZi8sDaCDKYFIGRk+FnSVXzyTO9JxBwF8DLc1dlLn65ooNEYN0fBsu21fTvL6PXnhxXlnLIqqhYYBian4lQ2Lk9ogiALsimiLC1QYfhlV1Hnxh7JfcMqxrpd7U2GFa5t9nOd7Kr+kg4uWvnCpromlJeXlq3Os3ZLOlrZBmNQf1ybVqpxhbA7mRIOCy1+esDOWhIyDv/+3Q7LRbsqH+rKRJ+nba+/+WW7II1s9vvVBuNr7KNF1WUM1bSt5f1Vq01jUVkKfnx8uoti3Or5rbd9782M61azJz/rFywYU/OyKqK1p5G2MS1Z18tGFDwTkvIxcK9RwaMP3a9/tbc62lPj/Nw5B9ey9Ehy/MY4oEqelgNleuyCgdXJlmc3fO5Ll56r5f+n/f+AWFf9jvBgaHpAAAAAElFTkSuQmCC);animation:spin 2s linear 1s infinite}.markdown-body h1{position:relative;font-size:30px;padding:12px 38px;margin:30px 0}.markdown-body h1:before{width:30px;height:30px;background-size:30px 30px}.markdown-body h2{position:relative;font-size:24px;padding:12px 36px;margin:28px 0}.markdown-body h2:before{width:28px;height:28px;background-size:28px 28px}.markdown-body h3{position:relative;font-size:18px;padding:4px 32px;margin:26px 0}.markdown-body h3:before{width:24px;height:24px;background-size:24px 24px}.markdown-body h4{position:relative;padding:4px 28px;font-size:16px;margin:22px 0}.markdown-body h4:before{width:20px;height:20px;background-size:20px 20px}.markdown-body h5{position:relative;padding:4px 26px;font-size:15px;margin:20px 0}.markdown-body h5:before{width:18px;height:18px;background-size:18px 18px}.markdown-body h6{position:relative;padding:4px 22px;font-size:14px;margin:16px 0}.markdown-body h6:before{width:16px;height:16px;background-size:16px 16px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#36ace1,#dff0fe,#36ace1);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:50px;height:24px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaCAYAAACpSkzOAAAEgElEQVRIS72Va0xbZRjH/z2FcimbchEQFDYRCIRAAWFQ2MaCXBwmUxYDLGGEcRFkH9wmk04zG0Bo2dwNIisERANqhjqdEmhd4nRbuwpsXDYWLLoRgeG4Chu9QHvMOQ0dpTAKH3y/tDnv8/5/z/Oc//scBv6nxdgoJ14gVYPEuITHdTdHY12gRIH0T0KljlqwthqUFHGtzAEsxqwLtPvkdc+FeeI3BgMeAMEhdOqR1mM7xswBrgmKE8pfIUhtm7fbZsft/i7wc98MtrUFxmbU6ByYgFwxjtFp5Q+WpF1mCy9wajXoqqD4E91saOf603e+5B7t99xTkyZJEiKJAl2DE9Xio1HvrBS8IuhVwVUP503swdJ9QWAw1izaoDs6pQT/655BMS9yy3KYiUoM/7adu7NmtnQfx5zWm8Q8Ui3gyGcddyU8rv/STRNQouDGP5/mhTubX4dpPv3DMzh1qS9LwuPWr+i63WVyn5QYj/4d/i4bqmbpoQ+auvBlQYghX6PE4wTSOzV5EUYlb5Q4MDqLk9/3cMRF27spDSNQamUnWZ4ebNB+OKNCyYVeFCZ5wZ5tiePN/UiP2YoQL0cUX+iFt4sNUiLdcaVvHJLecQiWnKVE8s5LvxAXRWeYgHLre0hecgAN0sxr0XBZgbJUP6OiLnaM4ivZCBrzOWBZEIY9rY5E8pl2nM0KMzzLq5aPiXmRzgbQm2VyR8KGGK/ICAFB6IusbvsDwhRf+n/jtSHc/nsGgjR9V6/1TyLa1wGU+FtnO1CbHQTHTSzIFJOYJ1jwcGLTccMTcyhp7oW4KFJ/SV4/IScrc55kQj07WNuOn94Lpw8kCm/Qv3W5HLjbWxsyfuNUO1TzWjAJBloKt2FBS+Jz6ShiA12NupBdLWugQcmn28lPMkONNql3U5cTSD9Lq+qEUqPFt++G0aKL687wDAqb+pAU7IKCuK2493AOPQ9UCNpib6T1tkg+RZ9KKJcNn8sJc1vac8o16jklLWLuOiDqwvHUIKPw7vtTON+iCDKkl/Cx9FeSYET5um1mHt6jN0Dz9ftwYjORudNjTdaBmi7kxvvA1d6Gjs0X/Q5Sp3tMEMSHre9HnDEZAPFCWUNVdliGJVPvqEP1Hbh4yPj9LadSY6fu6gPsCX+B3mq7NYLv2od8fj4aoViMNQGFijos/XVMTXGavgUisQIle71hwVx9KFEutLVjw8GORTuxoEbeJS7iPrmQyy/sIj2hQpqYHO7ZGs95nnZS4y8K8Pfqrb58UZ+IlKqbqNgfQm8da+pC9xjLqo8foFkau2qaCeXSyvzXfA9SDrp1bxJ/DU/jSJKXEWdBR2J/9U0UpwXTFZ/+8S76h/71FvO4A8sTeuqQThDKalOiPLN3BbhiYlaNsm964elkCztrC4xMqeDqYIus2JdB3cbS5l4MTag44qJt9GxbF4gKThRKY59lW13+KCUQ1pZMEwHKviKx4pFSqXzxCn/X9Gr2NO+zw+cTiTbxmUyCqH3GlsWg2kRNhOnHmhlrFkIvHTZt1borWvMCmRnwH4usn58STiycAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body del{color:#36ace1}.markdown-body code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#282c34;color:#4ec9b0;padding:.24em .46em;margin:0 4px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;font-size:12px;border-radius:10px;padding:15px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#4ec9b0;background:#282c34}.markdown-body a{text-decoration:none;color:#409eff;border-bottom:1px solid #409eff}.markdown-body a:active,.markdown-body a:hover{color:#007bff;border-bottom:1px solid #007bff}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;padding:8px 26px;background-color:rgba(54,172,225,.75);margin:16px 0;border-left:4px solid #409eff;border-radius:5px}.markdown-body blockquote:before{content:"❝";top:10px;left:8px;color:#409eff;font-size:20px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:20px;position:absolute;right:8px;bottom:0;color:#409eff;opacity:.7}.markdown-body blockquote&gt;p{color:#fff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">两种语言的本质关系：从自由奔放到严谨规划</h2>
<p>首先，让我们澄清一个最常见的误解：<strong>TypeScript不是JavaScript的替代品，而是它的超集</strong>。</p>
<p>简单来说，所有合法的JavaScript代码都是合法的TypeScript代码。但TypeScript在此基础上，添加了强大的类型系统和其他现代语言特性。</p>
<p>想象一下：</p>
<ul>
<li><strong>JavaScript</strong> 就像一个自由奔放的艺术家，可以在画布上随意挥洒，不拘一格</li>
<li><strong>TypeScript</strong> 则像是这位艺术家决定遵循一套建筑蓝图，让创作更加结构化和可预测</li>
</ul>
<h2 data-id="heading-1">核心区别：类型系统的魔力</h2>
<h3 data-id="heading-2">无类型 vs 静态类型</h3>
<p>让我们通过一个简单的例子来看看这两者的核心区别：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript版本：自由但危险</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-params">price, quantity</span>) {
    <span class="hljs-keyword">return</span> price * quantity;
}

<span class="hljs-comment">// 这行代码能正常运行，但结果可能不是你想要的</span>
<span class="hljs-keyword">const</span> total = <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-string">"100"</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// 返回 "100100100"</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// TypeScript版本：明确且安全</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-params">price: number, quantity: number</span>): number {
    <span class="hljs-keyword">return</span> price * quantity;
}

<span class="hljs-comment">// 下面这行代码会在编译时就报错</span>
<span class="hljs-keyword">const</span> total = <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-string">"100"</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// 编译错误：Argument of type 'string' is not assignable to parameter of type 'number'</span>
</code></pre>
<p>看出区别了吗？<strong>TypeScript在你写代码的时候就会检查类型错误</strong>，而JavaScript要到运行时才会发现问题。</p>
<h3 data-id="heading-3">接口和类型定义</h3>
<p>TypeScript最强大的特性之一就是接口（Interface）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义用户接口</span>
interface <span class="hljs-title class_">User</span> {
    <span class="hljs-attr">id</span>: number;
    <span class="hljs-attr">name</span>: string;
    <span class="hljs-attr">email</span>: string;
    age?: number; <span class="hljs-comment">// 可选属性</span>
}

<span class="hljs-comment">// 使用接口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">userData: User</span>): <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">name</span>: userData.<span class="hljs-property">name</span>,
        <span class="hljs-attr">email</span>: userData.<span class="hljs-property">email</span>,
        <span class="hljs-attr">age</span>: userData.<span class="hljs-property">age</span> || <span class="hljs-number">25</span>
    };
}

<span class="hljs-comment">// TypeScript会检查我是否提供了所有必需的属性</span>
<span class="hljs-keyword">const</span> newUser = <span class="hljs-title function_">createUser</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">"zhangsan@example.com"</span>
});
</code></pre>
<h2 data-id="heading-4">开发体验对比：写代码时的不同感受</h2>
<h3 data-id="heading-5">智能提示和自动补全</h3>
<p>使用TypeScript时，IDE能够提供极其精准的智能提示：</p>
<pre><code class="hljs language-javascript" lang="javascript">interface <span class="hljs-title class_">Product</span> {
    <span class="hljs-attr">id</span>: number;
    <span class="hljs-attr">name</span>: string;
    <span class="hljs-attr">price</span>: number;
    <span class="hljs-attr">inStock</span>: boolean;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">product</span>: <span class="hljs-title class_">Product</span> = {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"笔记本电脑"</span>,
    <span class="hljs-attr">price</span>: <span class="hljs-number">7999</span>,
    <span class="hljs-attr">inStock</span>: <span class="hljs-literal">true</span>
};

<span class="hljs-comment">// 当我输入"product."时，IDE会提示所有可用的属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(product.<span class="hljs-property">name</span>); <span class="hljs-comment">// IDE知道这是string类型</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(product.<span class="hljs-property">price</span>); <span class="hljs-comment">// IDE知道这是number类型</span>
<span class="hljs-comment">// console.log(product.description); // 编译错误：属性'description'不存在</span>
</code></pre>
<h3 data-id="heading-6">重构时的安心感</h3>
<p>在大项目中重构代码时，TypeScript提供的安全保障是无价的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 假设我要修改API响应结构</span>
interface <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
    <span class="hljs-attr">success</span>: boolean;
    <span class="hljs-attr">data</span>: T;
    <span class="hljs-attr">timestamp</span>: string;
    <span class="hljs-comment">// 新增字段</span>
    requestId?: string;
}

<span class="hljs-comment">// TypeScript会告诉我所有需要更新的地方</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processResponse</span>(<span class="hljs-params">response: ApiResponse&lt;User&gt;</span>) {
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">success</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">name</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">requestId</span>); <span class="hljs-comment">// 我知道这是可选字段</span>
    }
}
</code></pre>
<h2 data-id="heading-7">实战场景：从JavaScript迁移到TypeScript</h2>
<p>让我分享一个实际的迁移经验。我曾经维护一个中型电商项目，最初使用纯JavaScript开发：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原来的JavaScript代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">item, quantity</span>) {
    <span class="hljs-comment">// item是什么结构？quantity应该是数字吗？</span>
    cart.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>({ item, quantity });
    <span class="hljs-title function_">updateCartTotal</span>();
}
</code></pre>
<p>迁移到TypeScript后：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// TypeScript版本</span>
interface <span class="hljs-title class_">CartItem</span> {
    <span class="hljs-attr">id</span>: number;
    <span class="hljs-attr">name</span>: string;
    <span class="hljs-attr">price</span>: number;
    <span class="hljs-attr">category</span>: string;
}

interface <span class="hljs-title class_">CartEntry</span> {
    <span class="hljs-attr">item</span>: <span class="hljs-title class_">CartItem</span>;
    <span class="hljs-attr">quantity</span>: number;
    <span class="hljs-attr">addedAt</span>: <span class="hljs-title class_">Date</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">item: CartItem, quantity: number</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">cartEntry</span>: <span class="hljs-title class_">CartEntry</span> = {
        item,
        quantity,
        <span class="hljs-attr">addedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    };
    
    cart.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>(cartEntry);
    <span class="hljs-title function_">updateCartTotal</span>();
}
</code></pre>
<p>迁移过程虽然需要一些额外工作，但回报是巨大的：</p>
<ol>
<li>代码错误减少了约40%</li>
<li>新成员上手时间缩短了50%</li>
<li>重构时的信心大大增强</li>
</ol>
<h2 data-id="heading-8">学习曲线和成本考量</h2>
<h3 data-id="heading-9">TypeScript的学习成本</h3>
<p>是的，TypeScript需要学习一些新概念：</p>
<ul>
<li>类型注解</li>
<li>接口和类型别名</li>
<li>泛型</li>
<li>枚举</li>
<li>装饰器（可选）</li>
</ul>
<p>但对于有JavaScript基础的开发者来说，这些概念并不难掌握。我建议从简单的类型注解开始，逐步深入。</p>
<h3 data-id="heading-10">项目中的成本效益分析</h3>
<p>在中小型项目中，纯JavaScript可能更快速灵活。但在以下场景中，TypeScript的优势明显：</p>
<ol>
<li><strong>团队协作项目</strong>：类型系统作为文档，减少沟通成本</li>
<li><strong>大型复杂应用</strong>：提前发现潜在错误</li>
<li><strong>长期维护项目</strong>：代码可读性和可维护性更好</li>
<li><strong>公共库开发</strong>：提供更好的开发者体验</li>
</ol>
<h2 data-id="heading-11">我的实用建议</h2>
<p>经过多年的实践，我总结了一些建议：</p>
<ol>
<li><strong>新项目优先考虑TypeScript</strong>，特别是团队项目</li>
<li><strong>老项目逐步迁移</strong>，可以从配置文件开始，逐个模块转换</li>
<li><strong>不要过度使用高级特性</strong>，保持代码简洁易懂</li>
<li><strong>结合具体业务场景选择</strong>，简单的工具脚本可能不需要TypeScript</li>
</ol>
<h2 data-id="heading-12">总结：选择合适的工具</h2>
<p>回到最初的问题：TypeScript和JavaScript有什么区别？我认为最核心的区别是：</p>
<p><strong>JavaScript给你自由，TypeScript给你安全和结构。</strong></p>
<p>作为一名开发者，我的选择通常是：</p>
<ul>
<li>小型脚本、原型验证、学习实验 → JavaScript</li>
<li>企业级应用、团队协作、长期维护项目 → TypeScript</li>
</ul>
<p>两种语言各有适用场景，理解它们的差异不是为了争论孰优孰劣，而是为了在合适的场景使用合适的工具。</p>
<p>在2024年的前端开发中，TypeScript已经成为许多团队的标准选择。但这并不意味着JavaScript会消失——它们将长期共存，各自在适合的领域发光发热。</p>
<p><strong>真正的技术选择，不在于追求最新最热，而在于找到最适合当前问题和团队的工具。</strong>  这就是我从六年开发经验中学到的最重要的一课。</p>
<hr/>
<p><em>小杨的实践心得：无论选择哪种语言，保持代码清晰、可维护才是最重要的。技术只是工具，解决问题才是目的。</em></p>
<h2 data-id="heading-13">⭐  写在最后</h2>
<blockquote>
<p>请大家不吝赐教,在下方评论或者私信我,十分感谢🙏🙏🙏.</p>
<p>✅ 认为我某个部分的设计过于繁琐,有更加简单或者更高逼格的封装方式</p>
<p>✅ 认为我部分代码过于老旧,可以提供新的API或最新语法</p>
<p>✅ 对于文章中部分内容不理解</p>
<p>✅ 解答我文章中一些疑问</p>
<p>✅ 认为某些交互,功能需要优化,发现BUG</p>
<p>✅ 想要添加新功能,对于整体的设计,外观有更好的建议</p>
<p>✅ 一起探讨技术加qq交流群：<a href="https://link.juejin.cn?target=https%3A%2F%2Fqm.qq.com%2Fcgi-bin%2Fqm%2Fqr%3Fk%3DP2hE4MESJEHOwpBFPrAME1oTKqsLcA4m%26jump_from%3Dwebapi%26authKey%3DwuPbPtFsfgSInZP%2F9I9dSY7rhk9PScl6h6rUFUFtV4KOZY%2F%2B2D0xiqXSWRuYZs2f" target="_blank" title="https://qm.qq.com/cgi-bin/qm/qr?k=P2hE4MESJEHOwpBFPrAME1oTKqsLcA4m&amp;jump_from=webapi&amp;authKey=wuPbPtFsfgSInZP/9I9dSY7rhk9PScl6h6rUFUFtV4KOZY/+2D0xiqXSWRuYZs2f" ref="nofollow noopener noreferrer">906392632</a></p>
<p>最后感谢各位的耐心观看，既然都到这了，点个 👍赞再走吧！<br/>
</p>
</blockquote>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e6b3cb3a7c1476b83e30eea13e97bc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5Z-O5byA5pyX55qE6LGM6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766915686&amp;x-signature=EtbTE8uRI9OQCG%2B5zIWhfF9Xq5E%3D" alt="" loading="lazy"/>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我们来说说 ThreadLocal 的原理，使用场景及内存泄漏问题]]></title>    <link>https://juejin.cn/post/7585727457472299008</link>    <guid>https://juejin.cn/post/7585727457472299008</guid>    <pubDate>2025-12-21T08:15:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585727457472299008" data-draft-id="7585693761532510242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我们来说说 ThreadLocal 的原理，使用场景及内存泄漏问题"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-21T08:15:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小假"/> <meta itemprop="url" content="https://juejin.cn/user/2285197690931932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我们来说说 ThreadLocal 的原理，使用场景及内存泄漏问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2285197690931932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小假
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T08:15:46.000Z" title="Sun Dec 21 2025 08:15:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、核心原理</h3>
<h4 data-id="heading-1">1. <strong>数据存储结构</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 每个 Thread 对象内部都有一个 ThreadLocalMap</span>
<span class="hljs-type">ThreadLocal</span>.<span class="hljs-type">ThreadLocalMap</span> threadLocals = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// ThreadLocalMap 内部使用 Entry 数组，Entry 继承自 WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</span>
static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</span> </span>{
    <span class="hljs-type">Object</span> value;
    <span class="hljs-type">Entry</span>(<span class="hljs-type">ThreadLocal</span>&lt;?&gt; k, <span class="hljs-type">Object</span> v) {
        <span class="hljs-keyword">super</span>(k);  <span class="hljs-comment">// 弱引用指向 ThreadLocal 实例</span>
        value = v; <span class="hljs-comment">// 强引用指向实际存储的值</span>
    }
}
</code></pre>
<h4 data-id="heading-2">2. <strong>关键设计</strong></h4>
<ul>
<li><strong>线程隔离</strong>：每个线程有自己的 ThreadLocalMap 副本</li>
<li><strong>哈希表结构</strong>：使用开放地址法解决哈希冲突</li>
<li><strong>弱引用键</strong>：Entry 的 key（ThreadLocal 实例）是弱引用</li>
<li><strong>延迟清理</strong>：set / get 时自动清理过期条目</li>
</ul>
<h3 data-id="heading-3">二、源码分析</h3>
<h4 data-id="heading-4">1. <strong>set() 方法流程</strong></h4>
<pre><code class="hljs language-ini" lang="ini">public void set(T value) {
    Thread <span class="hljs-attr">t</span> = Thread.currentThread()<span class="hljs-comment">;</span>
    ThreadLocalMap <span class="hljs-attr">map</span> = getMap(t)<span class="hljs-comment">;</span>
    if (map != null) {
        map.set(this, value)<span class="hljs-comment">;  // this指当前ThreadLocal实例</span>
    } else {
        createMap(t, value)<span class="hljs-comment">;</span>
    }
}

private void set(ThreadLocal&lt;?&gt; key, Object value) {
    Entry<span class="hljs-section">[]</span> <span class="hljs-attr">tab</span> = table<span class="hljs-comment">;</span>
    int <span class="hljs-attr">len</span> = tab.length<span class="hljs-comment">;</span>
    int <span class="hljs-attr">i</span> = key.threadLocalHashCode &amp; (len-<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>

    // 遍历查找合适的位置
    for (Entry <span class="hljs-attr">e</span> = tab[i]<span class="hljs-comment">; e != null; e = tab[i = nextIndex(i, len)]) {</span>
        ThreadLocal&lt;?&gt; <span class="hljs-attr">k</span> = e.get()<span class="hljs-comment">;</span>

        // 找到相同的key，直接替换value
        if (<span class="hljs-attr">k</span> == key) {
            <span class="hljs-attr">e.value</span> = value<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }

        // key已被回收，替换过期条目
        if (<span class="hljs-attr">k</span> == null) {
            replaceStaleEntry(key, value, i)<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }
    }

    tab<span class="hljs-section">[i]</span> = new Entry(key, value)<span class="hljs-comment">;</span>
    int <span class="hljs-attr">sz</span> = ++size<span class="hljs-comment">;</span>
    // 清理并判断是否需要扩容
    if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)
        rehash()<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-5">2. <strong>get() 方法流程</strong></h4>
<pre><code class="hljs language-ini" lang="ini">public T get() {
    Thread <span class="hljs-attr">t</span> = Thread.currentThread()<span class="hljs-comment">;</span>
    ThreadLocalMap <span class="hljs-attr">map</span> = getMap(t)<span class="hljs-comment">;</span>
    if (map != null) {
        ThreadLocalMap.Entry <span class="hljs-attr">e</span> = map.getEntry(this)<span class="hljs-comment">;</span>
        if (e != null) {
            @SuppressWarnings("unchecked")
            T <span class="hljs-attr">result</span> = (T)e.value<span class="hljs-comment">;</span>
            return result<span class="hljs-comment">;</span>
        }
    }
    return setInitialValue()<span class="hljs-comment">;  // 返回初始值</span>
}
</code></pre>
<h3 data-id="heading-6">三、使用场景</h3>
<h4 data-id="heading-7">1. <strong>典型应用场景</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 场景1：线程上下文信息传递（如Spring的RequestContextHolder）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RequestContextHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;HttpServletRequest&gt; requestHolder = 
    <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRequest</span>(<span class="hljs-params">HttpServletRequest request</span>)</span> {
        requestHolder.<span class="hljs-keyword">set</span>(request);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpServletRequest <span class="hljs-title">getRequest</span>()</span> {
        <span class="hljs-keyword">return</span> requestHolder.<span class="hljs-keyword">get</span>();
    }
}

<span class="hljs-comment">// 场景2：数据库连接管理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Connection&gt; connectionHolder = 
    ThreadLocal.withInitial(() -&gt; DriverManager.getConnection(url));

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">getConnection</span>()</span> {
        <span class="hljs-keyword">return</span> connectionHolder.<span class="hljs-keyword">get</span>();
    }
}

<span class="hljs-comment">// 场景3：用户会话信息</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;UserInfo&gt; userHolder = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUser</span>(<span class="hljs-params">UserInfo user</span>)</span> {
        userHolder.<span class="hljs-keyword">set</span>(user);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserInfo <span class="hljs-title">getUser</span>()</span> {
        <span class="hljs-keyword">return</span> userHolder.<span class="hljs-keyword">get</span>();
    }
}

<span class="hljs-comment">// 场景4：避免参数传递</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TransactionContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Transaction&gt; transactionHolder = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beginTransaction</span>()</span> {
        transactionHolder.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">new</span> Transaction());
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Transaction <span class="hljs-title">getTransaction</span>()</span> {
        <span class="hljs-keyword">return</span> transactionHolder.<span class="hljs-keyword">get</span>();
    }
}
</code></pre>
<h4 data-id="heading-8">2. <strong>使用建议</strong></h4>
<ul>
<li>声明为 <code>private static final</code></li>
<li>考虑使用 <code>ThreadLocal.withInitial()</code> 提供初始值</li>
<li>在 finally 块中清理资源</li>
</ul>
<h3 data-id="heading-9">四、内存泄漏问题</h3>
<h4 data-id="heading-10">1. <strong>泄漏原理</strong></h4>
<pre><code class="hljs language-markdown" lang="markdown">强引用链：
Thread → ThreadLocalMap → Entry[] → Entry → value (强引用)

<span class="hljs-code">                                                   弱引用：
                                                   Entry → key (弱引用指向ThreadLocal)
</span>
泄漏场景：
<span class="hljs-bullet">1.</span> ThreadLocal实例被回收 → key=null
<span class="hljs-bullet">2.</span> 但value仍然被Entry强引用
<span class="hljs-bullet">3.</span> 线程池中线程长期存活 → value无法被回收
<span class="hljs-bullet">4.</span> 导致内存泄漏
</code></pre>
<h4 data-id="heading-11">2. <strong>解决方案对比</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 方案1：手动remove（推荐）</span>
<span class="hljs-keyword">try</span> {
    threadLocal.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">value</span>);
    <span class="hljs-comment">// ... 业务逻辑</span>
} <span class="hljs-keyword">finally</span> {
    threadLocal.<span class="hljs-keyword">remove</span>();  <span class="hljs-comment">// 必须执行！</span>
}

<span class="hljs-comment">// 方案2：使用InheritableThreadLocal（父子线程传递）</span>
ThreadLocal&lt;String&gt; parent = <span class="hljs-keyword">new</span> InheritableThreadLocal&lt;&gt;();
parent.<span class="hljs-keyword">set</span>(<span class="hljs-string">"parent value"</span>);

<span class="hljs-keyword">new</span> Thread(() -&gt; {
    <span class="hljs-comment">// 子线程可以获取父线程的值</span>
    System.<span class="hljs-keyword">out</span>.println(parent.<span class="hljs-keyword">get</span>());  <span class="hljs-comment">// "parent value"</span>
}).start();

<span class="hljs-comment">// 方案3：使用FastThreadLocal（Netty优化版）</span>
<span class="hljs-comment">// 适用于高并发场景，避免了哈希冲突</span>
</code></pre>
<h4 data-id="heading-12">3. <strong>最佳实践</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeThreadLocalExample</span> {
    <span class="hljs-comment">// 1. 使用static final修饰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;SimpleDateFormat&gt; DATE_FORMAT =
    ThreadLocal.withInitial(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd"</span>));

    <span class="hljs-comment">// 2. 包装为工具类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title function_">parse</span><span class="hljs-params">(String dateStr)</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> DATE_FORMAT.get();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> sdf.parse(dateStr);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 注意：这里通常不需要remove，因为要重用SimpleDateFormat</span>
            <span class="hljs-comment">// 但如果是用完即弃的场景，应该remove</span>
        }
    }

    <span class="hljs-comment">// 3. 线程池场景必须清理</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeInThreadPool</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            executor.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    UserContext.setUser(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>());
                    <span class="hljs-comment">// ... 业务处理</span>
                } <span class="hljs-keyword">finally</span> {
                    UserContext.remove();  <span class="hljs-comment">// 关键！</span>
                }
            });
        }
    }
}
</code></pre>
<h3 data-id="heading-13">五、注意事项</h3>
<ol>
<li><strong>线程池风险</strong>：线程复用导致数据污染</li>
<li><strong>继承问题</strong>：子线程默认无法访问父线程的ThreadLocal</li>
<li><strong>性能影响</strong>：哈希冲突时使用线性探测，可能影响性能</li>
<li><strong>空值处理</strong>：get()返回null时要考虑初始化</li>
</ol>
<h3 data-id="heading-14">六、替代方案</h3>



































<table><thead><tr><th>方案</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>ThreadLocal</td><td>线程隔离数据</td><td>简单高效</td><td>内存泄漏风险</td></tr><tr><td>InheritableThreadLocal</td><td>父子线程传递</td><td>继承上下文</td><td>线程池中失效</td></tr><tr><td>TransmittableThreadLocal</td><td>线程池传递</td><td>线程池友好</td><td>引入依赖</td></tr><tr><td>参数传递</td><td>简单场景</td><td>无副作用</td><td>代码冗余</td></tr></tbody></table>
<h3 data-id="heading-15">七、调试技巧</h3>
<pre><code class="hljs language-ini" lang="ini">// 查看ThreadLocalMap内容（调试用）
public static void dumpThreadLocalMap(Thread thread) throws Exception {
    Field <span class="hljs-attr">field</span> = Thread.class.getDeclaredField(<span class="hljs-string">"threadLocals"</span>)<span class="hljs-comment">;</span>
    field.setAccessible(true)<span class="hljs-comment">;</span>
    Object <span class="hljs-attr">map</span> = field.get(thread)<span class="hljs-comment">;</span>

    if (map != null) {
        Field <span class="hljs-attr">tableField</span> = map.getClass().getDeclaredField(<span class="hljs-string">"table"</span>)<span class="hljs-comment">;</span>
        tableField.setAccessible(true)<span class="hljs-comment">;</span>
        Object<span class="hljs-section">[]</span> <span class="hljs-attr">table</span> = (Object[]) tableField.get(map)<span class="hljs-comment">;</span>

        for (Object entry : table) {
            if (entry != null) {
                Field <span class="hljs-attr">valueField</span> = entry.getClass().getDeclaredField(<span class="hljs-string">"value"</span>)<span class="hljs-comment">;</span>
                valueField.setAccessible(true)<span class="hljs-comment">;</span>
                System.out.println("Key: " + ((WeakReference&lt;?&gt;) entry).get() 
                                   + ", Value: " + valueField.get(entry))<span class="hljs-comment">;</span>
            }
        }
    }
}
</code></pre>
<p>ThreadLocal 是强大的线程隔离工具，但需要谨慎使用。在 Web 应用和线程池场景中，<strong>必须</strong>在 finally 块中调用 remove()，这是避免内存泄漏的关键。</p>
<h3 data-id="heading-16">面试回答</h3>
<p>关于 ThreadLocal，我从原理、场景和内存泄漏三个方面来说一下我的理解。</p>
<h4 data-id="heading-17"><strong>1. 首先，它的核心原理是什么？</strong></h4>
<p>简单来说，<strong>ThreadLocal 是一个线程级别的变量隔离工具</strong>。它的设计目标就是让同一个变量，在不同的线程里有自己独立的副本，互不干扰。</p>
<ul>
<li><strong>底层结构</strong>：每个线程（<code>Thread</code>对象）内部都有一个自己的 <code>ThreadLocalMap</code>（你可以把它想象成一个线程私有的、简易版的HashMap）。</li>
<li><strong>怎么存</strong>：当我们调用 <code>ThreadLocal.set(value)</code> 时，实际上是以<strong>当前的</strong> ****<code>ThreadLocal</code> ****<strong>实例自身作为 Key</strong>，要保存的值作为 Value，存入<strong>当前线程的那个 ThreadLocalMap 里</strong>。</li>
<li><strong>怎么取</strong>：调用 <code>ThreadLocal.get()</code> 时，也是用自己作为 Key，去当前线程的 Map 里查找对应的 Value。</li>
<li><strong>打个比方</strong>：就像去银行租保险箱。<code>Thread</code> 是银行，<code>ThreadLocalMap</code> 是银行里的一排保险箱，<code>ThreadLocal</code> 实例就是你手里那把<strong>特定的钥匙</strong>。你用这把钥匙（ThreadLocal实例）只能打开属于你的那个格子（当前线程的Map），存取自己的东西（Value），完全看不到别人格子的东西。不同的人（线程）即使用同一款钥匙（同一个ThreadLocal实例），打开的也是不同银行的格子，东西自然隔离了。</li>
</ul>
<h4 data-id="heading-18"><strong>2. 其次，它的典型使用场景有哪些？</strong></h4>
<p>正是因为这种线程隔离的特性，它特别适合用来传递一些需要在线程整个生命周期内、多个方法间共享，但又<strong>不能（或不想）通过方法参数显式传递</strong>的数据。最常见的有两个场景：</p>
<ul>
<li><strong>场景一：保存上下文信息（最经典）</strong><br/>
比如在 <strong>Web 应用</strong> 或 <strong>RPC 框架</strong> 中处理一个用户请求时，这个请求从进入系统到返回响应，全程可能由同一个线程处理。我们会把一些信息（比如用户ID、交易ID、语言环境）存到一个 ThreadLocal 里。这样，后续的任何业务方法、工具类，只要在<strong>同一个线程里</strong>，就能直接 <code>get()</code> 到这些信息，避免了在每一个方法签名上都加上这些参数，代码会简洁很多。</li>
<li><strong>场景二：管理线程安全的独享资源</strong><br/>
典型例子是 <strong>数据库连接</strong> 和 <strong>SimpleDateFormat</strong>。</li>
</ul>

<ul>
<li>
<ul>
<li>像 <code>SimpleDateFormat</code> 这个类，它不是线程安全的。如果做成全局共享，就要加锁，性能差。用 ThreadLocal 的话，每个线程都拥有自己的一个 <code>SimpleDateFormat</code> 实例，既避免了线程安全问题，又因为线程复用了这个实例，减少了创建对象的开销。</li>
<li>类似的，在一些需要保证数据库连接线程隔离（比如事务管理）的场景，也会用到 ThreadLocal 来存放当前线程的连接。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-19"><strong>3. 最后，关于它的内存泄漏问题</strong></h4>
<p>ThreadLocal 如果使用不当，确实可能导致内存泄漏。它的根源在于 <code>ThreadLocalMap</code> <strong>中 Entry 的设计</strong>。</p>
<ul>
<li><strong>问题根源</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li><code>ThreadLocalMap</code> 的 Key（也就是 <code>ThreadLocal</code> 实例）是一个 <strong>弱引用</strong>。这意味着，如果外界没有强引用指向这个 <code>ThreadLocal</code> 对象（比如我们把 <code>ThreadLocal</code> 变量设为了 <code>null</code>），下次垃圾回收时，这个 Key 就会被回收掉，于是 Map 里就出现了一个 <strong>Key 为</strong> ****<code>null</code> <strong>，但 Value 依然存在的 Entry</strong>。</li>
<li>这个 Value 是一个强引用，只要线程还活着（比如用的是线程池，线程会复用，一直不结束），这个 Value 对象就永远无法被回收，造成了内存泄漏。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>如何避免</strong>：</li>
</ul>
<ol>
<li>
<ol>
<li><strong>良好习惯</strong>：每次使用完 ThreadLocal 后，<strong>一定要手动调用</strong> ****<code>remove() </code>****<strong>方法</strong>。这不仅是清理当前值，更重要的是它会清理掉整个 Entry，这是最有效、最安全的做法。</li>
<li><strong>设计保障</strong>：<code>ThreadLocal</code> 本身也做了一些努力，比如在 <code>set()</code>、<code>get()</code>、<code>remove()</code> 的时候，会尝试去清理那些 Key 为 <code>null</code> 的过期 Entry。但这是一种“被动清理”，不能完全依赖。</li>
<li><strong>代码层面</strong>：尽量将 <code>ThreadLocal</code> 变量声明为 <code>static final</code>，这样它的生命周期就和类一样长，不会被轻易回收，减少了产生 <code>null</code> Key 的机会。但这并不能替代 <code>remove()</code>，因为线程池复用时，上一个任务的值可能会污染下一个任务。</li>
</ol>
</li>
</ol>
<hr/>
<p><strong>总结一下</strong>：内存泄漏的关键是 <strong>“弱Key + 强Value + 长生命周期线程”</strong> 的组合。所以，把 <code>remove()</code> 放在 <code>finally</code> 块里调用，是一个必须养成的编程习惯。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RESTful风格解析]]></title>    <link>https://juejin.cn/post/7585743487258214409</link>    <guid>https://juejin.cn/post/7585743487258214409</guid>    <pubDate>2025-12-21T06:46:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585743487258214409" data-draft-id="7585645111875469339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RESTful风格解析"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-21T06:46:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="L0CK"/> <meta itemprop="url" content="https://juejin.cn/user/3555195572989993"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RESTful风格解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3555195572989993/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    L0CK
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T06:46:33.000Z" title="Sun Dec 21 2025 06:46:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>RESTful</strong> 是一种目前最流行的<strong>互联网软件架构设计风格</strong>。</p>
<hr/>
<h3 data-id="heading-0">1. 核心理念：看山是山（资源导向）</h3>
<p>在 RESTful 风格中，网络上的所有东西（用户、订单、商品）都被看作是“<strong>资源” (Resource</strong>)。</p>
<ul>
<li>
<p>传统风格（动词导向 - 像下命令）：</p>
<p>以前我们写接口，喜欢把动作写在网址里：</p>
<ul>
<li><code>http://localhost:8080/getUser?id=1</code></li>
<li><code>http://localhost:8080/createUser</code></li>
<li><code>http://localhost:8080/deleteUser?id=1</code></li>
<li><code>http://localhost:8080/updateUser</code></li>
<li><em>缺点：网址乱七八糟，如果不看文档，不知道 delete 后面是跟 id 还是 name。</em></li>
</ul>
</li>
<li>
<p>RESTful 风格（名词导向 - 像文件路径）：</p>
<p>REST 认为，网址 (URL) 用来定位资源，不应该包含动作。</p>
<ul>
<li>不管增删改查，网址统一都是：<code>http://localhost:8080/users</code></li>
<li>如果要找特定的人：<code>http://localhost:8080/users/1</code></li>
</ul>
</li>
</ul>
<p>那服务器怎么知道我是要“删除”还是“查询”呢？</p>
<p>靠 HTTP 请求方式（动词） 来区分！</p>
<hr/>
<h3 data-id="heading-1">2. 四大金刚：HTTP 动词</h3>
<p>RESTful 巧妙地利用了 HTTP 协议自带的四个动词，完美对应数据库的 <strong>CRUD（增删改查）</strong> ：</p>



































<table><thead><tr><th><strong>HTTP 动词</strong></th><th><strong>对应的操作</strong></th><th><strong>含义</strong></th><th><strong>例子 (操作用户 ID=1)</strong></th></tr></thead><tbody><tr><td><strong>GET</strong></td><td><strong>查</strong> (Read)</td><td>获取资源</td><td><code>GET /users/1</code></td></tr><tr><td><strong>POST</strong></td><td><strong>增</strong> (Create)</td><td>新建资源</td><td><code>POST /users</code> (数据在请求体里)</td></tr><tr><td><strong>PUT</strong></td><td><strong>改</strong> (Update)</td><td>修改资源</td><td><code>PUT /users</code> (数据在请求体里)</td></tr><tr><td><strong>DELETE</strong></td><td><strong>删</strong> (Delete)</td><td>删除资源</td><td><code>DELETE /users/1</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">3. 代码实战：Before vs After</h3>
<p>让我们把你之前的 <code>UserController</code> 改造一下，你就明白差距在哪了。</p>
<h4 data-id="heading-3">❌ 传统写法（非 RESTful）</h4>
<p>Java</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
public class UserController {

    <span class="hljs-comment">// 动作全写在 URL 里</span>
    <span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/queryUserById"</span>) 
    public User <span class="hljs-built_in">get</span>(Integer id) { ... }

    <span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/saveUser"</span>)
    public void <span class="hljs-built_in">save</span>(User user) { ... }
    
    <span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/deleteUser"</span>)
    public void <span class="hljs-built_in">delete</span>(Integer id) { ... }
}
</code></pre>
<h4 data-id="heading-4">✅ RESTful 写法（推荐）</h4>
<p>在 Spring Boot 中，我们有专门的注解来对应那四个动词。注意看 URL 有多干净：</p>
<p>Java</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/users"</span>) <span class="hljs-comment">// 1. 统一资源的路径，全是复数</span>
public class UserController {

    <span class="hljs-comment">// 获取所有用户：GET /users</span>
    <span class="hljs-variable">@GetMapping</span> 
    public List&lt;User&gt; <span class="hljs-built_in">list</span>() { ... }

    <span class="hljs-comment">// 获取单个用户：GET /users/1</span>
    <span class="hljs-comment">// @PathVariable 用于获取路径上的 {id}</span>
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/{id}"</span>) 
    public User <span class="hljs-built_in">getById</span>(<span class="hljs-variable">@PathVariable</span> Integer id) { ... }

    <span class="hljs-comment">// 新增用户：POST /users</span>
    <span class="hljs-variable">@PostMapping</span>
    public void <span class="hljs-built_in">save</span>(<span class="hljs-variable">@RequestBody</span> User user) { ... }

    <span class="hljs-comment">// 修改用户：PUT /users</span>
    <span class="hljs-variable">@PutMapping</span>
    public void <span class="hljs-built_in">update</span>(<span class="hljs-variable">@RequestBody</span> User user) { ... }

    <span class="hljs-comment">// 删除用户：DELETE /users/1</span>
    <span class="hljs-variable">@DeleteMapping</span>(<span class="hljs-string">"/{id}"</span>)
    public void <span class="hljs-built_in">delete</span>(<span class="hljs-variable">@PathVariable</span> Integer id) { ... }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">4. 两个关键新注解</h3>
<p>在 RESTful 开发中，你会频繁用到这两个注解：</p>
<ol>
<li>
<p><strong><code>@PathVariable</code></strong>：</p>
<ul>
<li><strong>场景</strong>：用于路径参数。</li>
<li><strong>例子</strong>：<code>/users/1</code> 中的 <code>1</code>。</li>
<li><strong>代码</strong>：<code>@DeleteMapping("/{id}") public void delete(@PathVariable Integer id)</code></li>
</ul>
</li>
<li>
<p><strong><code>@RequestBody</code></strong>：</p>
<ul>
<li><strong>场景</strong>：用于接收前端发来的 <strong>JSON 数据</strong>（通常用于 POST 和 PUT）。</li>
<li><strong>解释</strong>：它会自动把前端发来的 JSON 字符串（比如 <code>{"name":"大桥", "age":20}</code>）转换成 Java 的 <code>User</code> 对象。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-6">5. 总结：为什么要用 RESTful？</h3>
<ol>
<li><strong>看网址就知道在干嘛</strong>：看到 <code>DELETE /users/1</code>，傻子都知道这是要删除 1 号用户。</li>
<li><strong>前端后端沟通成本低</strong>：这已经成了行业标准。前端开发人员看到你的接口文档是 RESTful 风格的，他都不用问你，直接就会调。</li>
<li><strong>支持多端</strong>：这种风格返回的通常是 JSON 数据，无论是网页、安卓 App 还是 iOS App，都可以通用一套接口。</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探索 DoraCMS 的架构设计：从 Repository 模式到双数据库支持]]></title>    <link>https://juejin.cn/post/7585727457472233472</link>    <guid>https://juejin.cn/post/7585727457472233472</guid>    <pubDate>2025-12-21T07:48:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585727457472233472" data-draft-id="7585727457472217088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探索 DoraCMS 的架构设计：从 Repository 模式到双数据库支持"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-21T07:48:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="生哥740"/> <meta itemprop="url" content="https://juejin.cn/user/77392562883348"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探索 DoraCMS 的架构设计：从 Repository 模式到双数据库支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/77392562883348/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    生哥740
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T07:48:33.000Z" title="Sun Dec 21 2025 07:48:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">探索 DoraCMS 的架构设计：从 Repository 模式到双数据库支持</h2>
<p>在 Node.js CMS 领域，如何设计一个既灵活又易维护的架构一直是个挑战。最近在研究 DoraCMS 的架构设计时，发现了一些值得分享的设计思路，特别是其 Repository 模式和双数据库支持的实现方式。</p>
<h3 data-id="heading-1">架构概览</h3>
<p>DoraCMS 采用了前后端分离的现代化架构，整体分为四层：</p>
<pre><code class="hljs">前端应用层 → API 网关层 → 应用服务层 → 数据存储层
</code></pre>
<p>后端采用 EggJS 框架，遵循 <strong>Controller → Service → Repository</strong> 三层架构，职责清晰，易于维护。</p>
<h3 data-id="heading-2">核心设计：Repository 模式</h3>
<h4 data-id="heading-3">为什么需要 Repository 模式？</h4>
<p>在传统的 MVC 架构中，业务代码往往直接操作数据库模型，这会导致几个问题：</p>
<ol>
<li><strong>数据库耦合</strong>：切换数据库需要重写大量查询代码</li>
<li><strong>代码分散</strong>：查询逻辑散布在各个 Service 中，难以复用</li>
<li><strong>维护困难</strong>：相同的数据操作逻辑在多处重复</li>
</ol>
<p>DoraCMS 通过 Repository 模式解决了这些问题。Repository 层作为数据访问的抽象层，提供了统一的查询接口，屏蔽了底层数据库的差异。</p>
<h4 data-id="heading-4">四层继承结构</h4>
<p>DoraCMS 的 Repository 采用了四层继承结构：</p>
<pre><code class="hljs language-scss" lang="scss">IBaseRepository (接口层)
    ↓
BaseStandardRepository (跨数据库基类)
    ↓                    ↓
BaseMongoRepository  BaseMariaRepository
    ↓                    ↓
UserMongoRepository  UserMariaRepository
</code></pre>
<p>这种设计的巧妙之处在于：</p>
<ul>
<li><strong>BaseStandardRepository</strong> 实现了通用的 CRUD 操作和统一的参数接口</li>
<li><strong>BaseMongoRepository</strong> 和 <strong>BaseMariaRepository</strong> 分别实现数据库特定的查询转换</li>
<li>具体的 Repository 只需要实现业务特定的逻辑</li>
</ul>
<h4 data-id="heading-5">统一的参数接口</h4>
<p>无论使用 MongoDB 还是 MariaDB，业务代码都使用相同的查询方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 统一的查询接口</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> userRepository.<span class="hljs-title function_">findMany</span>({
  <span class="hljs-attr">filters</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"active"</span> },
  <span class="hljs-attr">populate</span>: [<span class="hljs-string">"role"</span>, <span class="hljs-string">"department"</span>],
  <span class="hljs-attr">sort</span>: { <span class="hljs-attr">createdAt</span>: -<span class="hljs-number">1</span> },
  <span class="hljs-attr">pagination</span>: { <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">limit</span>: <span class="hljs-number">20</span> },
});
</code></pre>
<p>Repository 内部会根据数据库类型自动转换查询参数，业务层完全无感知。</p>
<h3 data-id="heading-6">双数据库支持</h3>
<p>这是 DoraCMS 的一个亮点特性。通过 Repository 模式的抽象，实现了 MongoDB 和 MariaDB 的无缝切换。</p>
<h4 data-id="heading-7">切换方式</h4>
<p>只需要在配置文件中修改一行代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// config.js</span>
config.<span class="hljs-property">dbType</span> = <span class="hljs-string">"mongodb"</span>; <span class="hljs-comment">// 或 'mariadb'</span>
</code></pre>
<p>业务代码完全不需要修改，这得益于 Repository 层的抽象和 Adapter 适配器模式。</p>
<h4 data-id="heading-8">技术实现</h4>
<ul>
<li><strong>MongoDB</strong>：使用 Mongoose 作为 ODM</li>
<li><strong>MariaDB</strong>：使用 Sequelize 作为 ORM</li>
<li><strong>Adapter 层</strong>：负责查询参数的转换和结果映射</li>
</ul>
<p>这种设计让开发者可以根据项目需求灵活选择数据库，而不需要重写业务代码。</p>
<h3 data-id="heading-9">三层架构的职责划分</h3>
<h4 data-id="heading-10">Controller 层</h4>
<p>负责处理 HTTP 请求和响应：</p>
<ul>
<li>参数验证</li>
<li>权限检查</li>
<li>调用 Service 层</li>
<li>格式化响应</li>
</ul>
<h4 data-id="heading-11">Service 层</h4>
<p>负责业务逻辑编排：</p>
<ul>
<li>业务规则验证</li>
<li>事务管理</li>
<li>调用 Repository 进行数据操作</li>
<li>跨模块协调</li>
</ul>
<h4 data-id="heading-12">Repository 层</h4>
<p>负责数据访问：</p>
<ul>
<li>数据库 CRUD 操作</li>
<li>查询转换和优化</li>
<li>异常处理</li>
<li>字段映射</li>
</ul>
<p>这种清晰的职责划分让代码结构更加清晰，也更容易进行单元测试。</p>
<h3 data-id="heading-13">微前端架构</h3>
<p>DoraCMS 还支持微前端架构，基于 qiankun 框架实现。主应用可以注册多个子应用，每个子应用可以独立开发、部署和升级。</p>
<p>这种架构特别适合大型项目，可以让不同团队独立负责不同的前端应用，提高开发效率。</p>
<h3 data-id="heading-14">技术栈</h3>
<h4 data-id="heading-15">前端</h4>
<ul>
<li>Vue 3 + TypeScript</li>
<li>Vite 构建工具</li>
<li>Element Plus UI 组件库</li>
<li>UnoCSS 原子化 CSS</li>
</ul>
<h4 data-id="heading-16">后端</h4>
<ul>
<li>EggJS 3.x 企业级框架</li>
<li>MongoDB / MariaDB 双数据库支持</li>
<li>Redis 缓存</li>
<li>JWT 认证</li>
</ul>
<h3 data-id="heading-17">设计亮点总结</h3>
<ol>
<li><strong>Repository 模式</strong>：实现了数据访问层的抽象，代码复用率可达 90%+</li>
<li><strong>双数据库支持</strong>：通过配置即可切换数据库，业务代码零修改</li>
<li><strong>三层架构</strong>：职责清晰，易于维护和扩展</li>
<li><strong>微前端支持</strong>：适合大型项目的模块化开发</li>
<li><strong>类型安全</strong>：TypeScript 全面支持，减少运行时错误</li>
</ol>
<h3 data-id="heading-18">思考与启发</h3>
<p>DoraCMS 的架构设计给我最大的启发是：<strong>通过合理的抽象层设计，可以在保持灵活性的同时，降低代码复杂度</strong>。</p>
<p>Repository 模式虽然增加了代码层次，但带来的好处是显而易见的：</p>
<ul>
<li>业务代码与数据库解耦</li>
<li>查询逻辑统一封装</li>
<li>易于测试和维护</li>
<li>支持多数据库切换</li>
</ul>
<p>这种设计思路值得在类似项目中借鉴。</p>
<h3 data-id="heading-19">总结</h3>
<p>DoraCMS 的架构设计体现了对代码质量和可维护性的重视。通过 Repository 模式、三层架构和双数据库支持，它提供了一个既灵活又易用的 CMS 解决方案。</p>
<p>如果你对 Node.js CMS 架构设计感兴趣，或者正在寻找一个可扩展的内容管理系统，不妨了解一下 DoraCMS 的设计思路。</p>
<hr/>
<p><strong>相关链接：</strong></p>
<ul>
<li>GitHub 仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdoramart%2FDoraCMS" target="_blank" title="https://github.com/doramart/DoraCMS" ref="nofollow noopener noreferrer">github.com/doramart/Do…</a></li>
<li>官方网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.doracms.net" target="_blank" title="https://www.doracms.net" ref="nofollow noopener noreferrer">www.doracms.net</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python进阶: 元类与属性查找理解]]></title>    <link>https://juejin.cn/post/7585706951604289562</link>    <guid>https://juejin.cn/post/7585706951604289562</guid>    <pubDate>2025-12-21T08:19:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951604289562" data-draft-id="7585534343562494002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python进阶: 元类与属性查找理解"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-21T08:19:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="verbannung"/> <meta itemprop="url" content="https://juejin.cn/user/1086751804772174"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python进阶: 元类与属性查找理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1086751804772174/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    verbannung
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T08:19:14.000Z" title="Sun Dec 21 2025 08:19:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python进阶: 元类与属性查找理解</h2>
<h3 data-id="heading-1">metaclass</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">M</span>(<span class="hljs-title class_ inherited__">type</span>):
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__prepare__</span>(<span class="hljs-params">metacls, name, bases, **kwargs</span>):
        namespace = <span class="hljs-built_in">dict</span>()

        <span class="hljs-comment"># 注入一个工具函数，类定义体里可以直接用</span>
        namespace[<span class="hljs-string">'add'</span>] = <span class="hljs-keyword">lambda</span> a, b: a + b
        namespace[<span class="hljs-string">'BASE_VALUE'</span>] = <span class="hljs-number">100</span>

        <span class="hljs-keyword">return</span> namespace


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>(metaclass=M):
    result = add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)  
    total = BASE_VALUE + <span class="hljs-number">50</span>  
    
test = Test()
<span class="hljs-built_in">print</span>(Test.result)  <span class="hljs-comment">#3</span>
</code></pre>
<p>这里是一个元类,这里直接塞入了一个add方法,这样所有被这个元类创建的类都可以使用这个方法</p>
<h4 data-id="heading-2">元类的意义</h4>
<p>控制类的创建过程</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMeta</span>(<span class="hljs-title class_ inherited__">type</span>):
<span class="hljs-meta">  	@classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__prepare__</span>(<span class="hljs-params">metacls, name, bases</span>):    <span class="hljs-comment"># 1. 控制类定义体的执行环境</span>
        ...
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, name, bases, ns</span>):    <span class="hljs-comment"># 2. 控制类对象的创建</span>
        ...
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">cls, name, bases, ns</span>):   <span class="hljs-comment"># 3. 控制类对象的初始化</span>
        ...
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">cls, *args</span>):             <span class="hljs-comment"># 4. 控制实例的创建</span>
        ...
</code></pre>
<p>例子: 自动注册搜集类</p>
<pre><code class="hljs language-python" lang="python">registry = {}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterMeta</span>(<span class="hljs-title class_ inherited__">type</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, name, bases, ns</span>):
        klass = <span class="hljs-built_in">super</span>().__new__(cls, name, bases, ns)
        <span class="hljs-keyword">if</span> name != <span class="hljs-string">'Base'</span>:
            registry[name] = klass  
        <span class="hljs-keyword">return</span> klass

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span>(metaclass=RegisterMeta): <span class="hljs-keyword">pass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-title class_ inherited__">Base</span>): <span class="hljs-keyword">pass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-title class_ inherited__">Base</span>): <span class="hljs-keyword">pass</span>

<span class="hljs-built_in">print</span>(registry)  <span class="hljs-comment"># {'Dog': &lt;class Dog&gt;, 'Cat': &lt;class Cat&gt;}</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">cls</span>):
    original_init = cls.__init__
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">new_init</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        original_init(self, *args, **kwargs)
        registry.append(self) 
    cls.__init__ = new_init
    <span class="hljs-keyword">return</span> cls

<span class="hljs-meta">@register</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Handler</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self.name = name

h1 = Handler(<span class="hljs-string">"h1"</span>)
h2 = Handler(<span class="hljs-string">"h2"</span>)
<span class="hljs-built_in">print</span>(registry)  
</code></pre>
<h4 data-id="heading-3">和装饰器的区别</h4>
<p>装饰器是使用了闭包函数,常常用来管理实例,两者使用的场景:</p>


















































<table><thead><tr><th><strong>场景</strong></th><th><strong>装饰器</strong></th><th><strong>元类</strong></th></tr></thead><tbody><tr><td><strong>单个类增强</strong></td><td>✓</td><td>✗  没必要,太重</td></tr><tr><td><strong>可选功能 (用不用随意)</strong></td><td>✓</td><td>✗ 一般也是具体的增强</td></tr><tr><td><strong>修改实例行为</strong></td><td>✓</td><td>✗ 实例管理</td></tr><tr><td><strong>所有子类自动继承行为</strong></td><td>✗</td><td>✓</td></tr><tr><td><strong>类定义时验证</strong></td><td>△ 如果特定一处用,可以用装饰器</td><td>✓</td></tr><tr><td><strong>控制类的创建过程</strong></td><td>✗</td><td>✓</td></tr><tr><td><strong>框架级别 (ORM/序列化)</strong></td><td>✗</td><td>✓</td></tr><tr><td><strong>需要 <code>__prepare__</code> 注入环境</strong></td><td>✗</td><td>✓</td></tr></tbody></table>
<h3 data-id="heading-4">类,实例和元类的关系</h3>
<h4 data-id="heading-5">实例查找图谱</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81833a107cbe4cbbb3a6068c54372af0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmVyYmFubnVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766909953&amp;x-signature=Wp0y3CSz4xXj4rSu1ePTj2xOSoI%3D" alt="class-attribute-lookup-v3.png" loading="lazy"/></p>
<p>解释:</p>
<p>1.type(obj) 的 MRO 找 data descriptor</p>
<p>2.如果查询不到再回到<code>obj.__dict__</code>获取</p>
<p>3.type(obj) 的 MRO 找 non-data / 普通属性</p>
<ol start="4">
<li>如果还是获取不到,<code>__getattr__ </code>兜底</li>
</ol>
<p><strong>注意:不会走metaclass查询属性方法!</strong></p>
<p><strong>mro会扫两遍</strong></p>
<h4 data-id="heading-6">类查询图谱</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90b51aa30e8c4090b98512ea36f4c9f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmVyYmFubnVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766909953&amp;x-signature=l0D2XQGL1Khg6M9pWfuyUjl%2FLjs%3D" alt="class-creation.png" loading="lazy"/></p>
<p>解释</p>
<ol>
<li>Metaclass MRO 找 data descriptor [M → type]</li>
<li>Class MRO 找 任何 descriptor 或普通属性 [Class → bases → object]</li>
<li>Metaclass MRO 找 non-data descriptor 或普通属性 [M → type]</li>
<li>Metaclass.<strong>getattr</strong> 兜底</li>
</ol>
<p><strong>会查找元类的<code>__dict__</code>属性</strong></p>
<p><strong>mro扫描两次</strong></p>
<h4 data-id="heading-7">magic method</h4>
<blockquote>
<p>One distinctive feature of Python is magic methods: they allow the programmer to override behavior for various operators and behavior of objects.</p>
</blockquote>
<p><strong>Magic Method 隐式调用（len(obj)、obj + x）, 直接查 type(obj)，跳过 <code>instance.__dict__</code> ,和普通属性查找不同</strong></p>
<h4 data-id="heading-8">属性查找示例代码</h4>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-comment"># 继承链: C -&gt; B -&gt; A -&gt; object</span>
<span class="hljs-comment"># 元类链: MyMeta -&gt; type</span>


<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Part 0: 结构定义"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)


<span class="hljs-comment"># ---------- Data Descriptor ----------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataDescriptor</span>:
    <span class="hljs-string">"""Data descriptor: 有 __get__ 和 __set__"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self.name = name

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, instance, owner</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    [DataDescriptor.__get__] name=<span class="hljs-subst">{self.name}</span>, instance=<span class="hljs-subst">{instance}</span>, owner=<span class="hljs-subst">{owner}</span>"</span>)
        <span class="hljs-keyword">if</span> instance <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"DataDesc(<span class="hljs-subst">{self.name}</span>)"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, instance, value</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    [DataDescriptor.__set__] name=<span class="hljs-subst">{self.name}</span>, value=<span class="hljs-subst">{value}</span>"</span>)


<span class="hljs-comment"># ---------- Non-Data Descriptor ----------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NonDataDescriptor</span>:
    <span class="hljs-string">"""Non-data descriptor: 只有 __get__"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self.name = name

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, instance, owner</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    [NonDataDescriptor.__get__] name=<span class="hljs-subst">{self.name}</span>, instance=<span class="hljs-subst">{instance}</span>, owner=<span class="hljs-subst">{owner}</span>"</span>)
        <span class="hljs-keyword">if</span> instance <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"NonDataDesc(<span class="hljs-subst">{self.name}</span>)"</span>


<span class="hljs-comment"># ---------- Metaclass ----------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMeta</span>(<span class="hljs-title class_ inherited__">type</span>):
    <span class="hljs-string">"""自定义元类"""</span>

    <span class="hljs-comment"># 元类上的 data descriptor</span>
    meta_data_desc = DataDescriptor(<span class="hljs-string">"meta_data_desc"</span>)

    <span class="hljs-comment"># 元类上的 non-data descriptor</span>
    meta_nondata_desc = NonDataDescriptor(<span class="hljs-string">"meta_nondata_desc"</span>)

    <span class="hljs-comment"># 元类上的普通属性</span>
    meta_attr = <span class="hljs-string">"MyMeta.meta_attr"</span>

    <span class="hljs-comment"># 元类上的 __len__（magic method）</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">cls</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    [MyMeta.__len__] called on <span class="hljs-subst">{cls}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-number">999</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">cls, name</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    [MyMeta.__getattr__] name=<span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"MyMeta.__getattr__(<span class="hljs-subst">{name}</span>)"</span>


<span class="hljs-comment"># ---------- Class A (基类) ----------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(metaclass=MyMeta):
    <span class="hljs-comment"># A 上的 data descriptor</span>
    a_data_desc = DataDescriptor(<span class="hljs-string">"a_data_desc"</span>)

    <span class="hljs-comment"># A 上的 non-data descriptor</span>
    a_nondata_desc = NonDataDescriptor(<span class="hljs-string">"a_nondata_desc"</span>)

    <span class="hljs-comment"># A 上的普通属性</span>
    a_attr = <span class="hljs-string">"A.a_attr"</span>

    <span class="hljs-comment"># 会被 B 覆盖的属性</span>
    inherited_attr = <span class="hljs-string">"A.inherited_attr"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    [A.__len__] called on <span class="hljs-subst">{self}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    [A.__getattr__] name=<span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"A.__getattr__(<span class="hljs-subst">{name}</span>)"</span>


<span class="hljs-comment"># ---------- Class B (中间类) ----------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>(<span class="hljs-title class_ inherited__">A</span>):
    <span class="hljs-comment"># B 上的 data descriptor</span>
    b_data_desc = DataDescriptor(<span class="hljs-string">"b_data_desc"</span>)

    <span class="hljs-comment"># 覆盖 A 的属性</span>
    inherited_attr = <span class="hljs-string">"B.inherited_attr"</span>

    <span class="hljs-comment"># B 上的普通属性</span>
    b_attr = <span class="hljs-string">"B.b_attr"</span>


<span class="hljs-comment"># ---------- Class C (最终类) ----------</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span>(<span class="hljs-title class_ inherited__">B</span>):
    <span class="hljs-comment"># C 上的 data descriptor</span>
    c_data_desc = DataDescriptor(<span class="hljs-string">"c_data_desc"</span>)

    <span class="hljs-comment"># C 上的 non-data descriptor</span>
    c_nondata_desc = NonDataDescriptor(<span class="hljs-string">"c_nondata_desc"</span>)

    <span class="hljs-comment"># C 上的普通属性</span>
    c_attr = <span class="hljs-string">"C.c_attr"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 实例属性</span>
        self.instance_attr = <span class="hljs-string">"c.__dict__['instance_attr']"</span>
        <span class="hljs-comment"># 尝试覆盖 non-data descriptor</span>
        self.__dict__[<span class="hljs-string">'c_nondata_desc'</span>] = <span class="hljs-string">"c.__dict__['c_nondata_desc']"</span>
        <span class="hljs-comment"># 尝试覆盖 data descriptor (不会生效)</span>
        self.__dict__[<span class="hljs-string">'c_data_desc'</span>] = <span class="hljs-string">"c.__dict__['c_data_desc']"</span>


<span class="hljs-comment"># 创建实例</span>
c = C()

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"""
继承链 (MRO):
  C.__mro__ = <span class="hljs-subst">{C.__mro__}</span>

实例化链:
  c.__class__ = <span class="hljs-subst">{c.__class__}</span>
  C.__class__ = <span class="hljs-subst">{C.__class__}</span>
  MyMeta.__class__ = <span class="hljs-subst">{MyMeta.__class__}</span>

c.__dict__ = <span class="hljs-subst">{c.__dict__}</span>
"""</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Part 1: Instance 属性查找 (c.attr)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 1.1 Data Descriptor 优先于 instance.__dict__ ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.c_data_desc ="</span>, c.c_data_desc)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 虽然 c.__dict__ 有 'c_data_desc'，但 data descriptor 优先"</span>)
c_dict_c_data_desc=c.__dict__[<span class="hljs-string">"c_data_desc"</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"c.__dict__中c_data_desc的值是<span class="hljs-subst">{c_dict_c_data_desc}</span>,这个值来自于instance的__dict__，但没有被访问到"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 1.2 instance.__dict__ 优先于 Non-Data Descriptor ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.c_nondata_desc ="</span>, c.c_nondata_desc)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  → c.__dict__['c_nondata_desc'] 覆盖了 non-data descriptor"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 1.3 instance.__dict__ 普通属性 ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.instance_attr ="</span>, c.instance_attr)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 1.4 沿 MRO 找 Non-Data Descriptor (A 上定义的) ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.a_nondata_desc ="</span>, c.a_nondata_desc)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 1.5 沿 MRO 找普通类属性 ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.a_attr ="</span>, c.a_attr)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.b_attr ="</span>, c.b_attr)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.inherited_attr ="</span>, c.inherited_attr, <span class="hljs-string">"(B 覆盖了 A)"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 1.6 __getattr__ 兜底 ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.not_exist ="</span>, c.not_exist)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 1.7 Metaclass 属性对 instance 不可见 ---"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.meta_attr ="</span>, c.meta_attr)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 报错！instance 不会查 metaclass ,走兜底检查__getattr__"</span>)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Part 2: Class 属性查找 (C.attr)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 2.1 Metaclass Data Descriptor 优先 ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"C.meta_data_desc ="</span>, C.meta_data_desc)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 2.2 Class MRO 上的 Descriptor ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"C.c_data_desc ="</span>, C.c_data_desc)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  → instance=None 说明是通过类访问"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 2.3 Class MRO 上的普通属性 ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"C.c_attr ="</span>, C.c_attr)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"C.a_attr ="</span>, C.a_attr)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 2.4 Metaclass Non-Data Descriptor ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"C.meta_nondata_desc ="</span>, C.meta_nondata_desc)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 2.5 Metaclass 普通属性 ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"C.meta_attr ="</span>, C.meta_attr)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 2.6 Metaclass __getattr__ 兜底 ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"C.class_not_exist ="</span>, C.class_not_exist)

<span class="hljs-comment"># ============================================</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Part 3: Magic Method 隐式调用"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 3.1 len(instance) 直接查 type(instance) ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"len(c) ="</span>, <span class="hljs-built_in">len</span>(c))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 直接调用 A.__len__，跳过 instance.__dict__"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 3.2 len(Class) 直接查 type(Class) 即 Metaclass ---"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"len(C) ="</span>, <span class="hljs-built_in">len</span>(C))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 直接调用 MyMeta.__len__"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 3.3 对比：显式调用 vs 隐式调用 ---"</span>)
c.__len__ = <span class="hljs-keyword">lambda</span>: <span class="hljs-number">777</span>  <span class="hljs-comment"># 塞进 instance.__dict__</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"c.__len__() ="</span>, c.__len__(), <span class="hljs-string">"  (显式调用，走正常属性链)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"len(c) ="</span>, <span class="hljs-built_in">len</span>(c), <span class="hljs-string">"       (隐式调用，跳过 instance.__dict__)"</span>)

</code></pre>
<h3 data-id="heading-9">类创建流程</h3>
<blockquote>
<ul>
<li><code>Metaclass.__prepare__</code> just returns the namespace object (a dictionary-like object as explained before).</li>
<li><code>Metaclass.__new__</code> returns the <code>Class</code> object.</li>
<li><code>MetaMetaclass.__call__</code> returns whatever <code>Metaclass.__new__</code> returned (and if it returned an instance of <code>Metaclass</code> it will also call <code>Metaclass.__init__</code> on it).</li>
</ul>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bb23742d9bd449cb12279d4da9a2bd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmVyYmFubnVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766909953&amp;x-signature=Tu%2BT2YFpGgFEojuRFPqqK6NpdGs%3D" alt="object-attribute-lookup-v3.png" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMeta</span>(<span class="hljs-title class_ inherited__">type</span>):

    <span class="hljs-comment"># 1. 类定义前：准备 namespace</span>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__prepare__</span>(<span class="hljs-params">metacls, name, bases, **kwargs</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[1] __prepare__: 准备 <span class="hljs-subst">{name}</span> 的 namespace"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    metacls = <span class="hljs-subst">{metacls}</span>"</span>)
        namespace = {<span class="hljs-string">'injected'</span>: <span class="hljs-number">100</span>}
        <span class="hljs-keyword">return</span> namespace

    <span class="hljs-comment"># 2. 类定义后：创建类对象</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">metacls, name, bases, namespace</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[2] __new__: 创建类 <span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    namespace = <span class="hljs-subst">{<span class="hljs-built_in">dict</span>(namespace)}</span>"</span>)
        cls = <span class="hljs-built_in">super</span>().__new__(metacls, name, bases, namespace)
        <span class="hljs-keyword">return</span> cls

    <span class="hljs-comment"># 3. 类对象创建后：初始化类对象</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">cls, name, bases, namespace</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[3] __init__: 初始化类 <span class="hljs-subst">{name}</span>"</span>)
        cls.added_by_init = <span class="hljs-string">"元类 __init__ 添加的"</span>
        <span class="hljs-built_in">super</span>().__init__(name, bases, namespace)

    <span class="hljs-comment"># 4. 类被调用时：控制实例创建</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[4] __call__: 创建 <span class="hljs-subst">{cls.__name__}</span> 的实例"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    args = <span class="hljs-subst">{args}</span>"</span>)
        instance = <span class="hljs-built_in">super</span>().__call__(*args, **kwargs)
        instance.added_by_call = <span class="hljs-string">"元类 __call__ 添加的"</span>
        <span class="hljs-keyword">return</span> instance

</code></pre>
<h3 data-id="heading-10">总结</h3>
<p>实例只能看到类定义的属性，但看不到元类定义的属性。类既能看到自己定义的，也能看到元类定义的。唯一的例外是魔术方法，它永远只看 type(obj)。</p>
<p>双轨机制</p>
<h3 data-id="heading-11">参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.ionelmc.ro%2F2015%2F02%2F09%2Funderstanding-python-metaclasses%2F" target="_blank" title="https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/" ref="nofollow noopener noreferrer">Understanding Python metaclasses</a></p>
<h3 data-id="heading-12">个人博客</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Felliot-blog.com%2Fposts%2F202512%2Fpython_metaclass%2F" target="_blank" title="https://elliot-blog.com/posts/202512/python_metaclass/" ref="nofollow noopener noreferrer">elliot-blog.com/posts/20251…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（五）]]></title>    <link>https://juejin.cn/post/7585463258691616777</link>    <guid>https://juejin.cn/post/7585463258691616777</guid>    <pubDate>2025-12-20T16:02:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258691616777" data-draft-id="7585706951603322906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（五）"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-20T16:02:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="名字被你们想完了"/> <meta itemprop="url" content="https://juejin.cn/user/3065854916834782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（五）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3065854916834782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    名字被你们想完了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T16:02:23.000Z" title="Sat Dec 20 2025 16:02:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（五）</h2>
<p>Flutter: 3.35.6</p>
<p>前面我们简单实现了属性的抽取和元素的移动，接下来我们实现元素的旋转（因为旋转涉及到角度的变化，所以先行实现），因为原理在之前的单个中已经分析了，所以这里依然以代码结合详细注释来说明，只对特别注意的点单独提取出来说明。</p>
<p>因为前面我们抽取了响应区域的代码，我们应该能够了解到，响应操作的区域不止一个，所以直接提取列表存储响应区域。下面就该讨论如何渲染这些区域，第一种方式就是我们直接以元素自身为参考，定位这些区域，然后用选中状态判断，选中就展示，取消就隐藏；另外一种方式就是所有子元素共用一个，通过选中元素的状态去控制。这里选择的是第一种方式，不需要复杂的计算：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">用于设置一些初始化值</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstantsConfig</span> </span>{
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">/// <span class="markdown">元素的操作区域</span></span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;ResponseAreaModel&gt; baseAreaList = [
    <span class="hljs-comment">// 旋转</span>
    ResponseAreaModel(
      areaWidth: <span class="hljs-number">20</span>,
      areaHeight: <span class="hljs-number">20</span>,
      xRatio: <span class="hljs-number">1</span>,
      yRatio: <span class="hljs-number">0</span>,
      status: ElementStatus.rotate,
      icon: <span class="hljs-string">'assets/images/icon_rotate.png'</span>,
      trigger: TriggerMethod.move,
    ),
  ];
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">抽取渲染的元素</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Positioned(
      <span class="hljs-comment">// 其他省略...</span>

      <span class="hljs-comment">// 新增旋转功能</span>
      child: Transform.rotate(
        angle: elementItem.rotationAngle,
        child: Container(
          <span class="hljs-comment">// 其他省略...</span>

          <span class="hljs-comment">// 新增区域的渲染</span>
          child: selected ? Stack(
            clipBehavior: Clip.none,
            children: [
              ...ConstantsConfig.baseAreaList.map((item) =&gt; Positioned(
                top: elementItem.elementHeight * item.yRatio - item.areaHeight / <span class="hljs-number">2</span>,
                left: elementItem.elementWidth * item.xRatio - item.areaWidth / <span class="hljs-number">2</span>,
                child: Image.asset(
                  item.icon,
                  width: item.areaWidth,
                  height: item.areaHeight,
                ),
              )),
            ],
          ) : <span class="hljs-keyword">null</span>,
        ),
      )
    );
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b00e8aa438446e0a0b03b1f61df7783~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851343&amp;x-signature=f5f8ePR6S%2Fpr1JBh5n84tTBUHNE%3D" alt="image01.gif" loading="lazy"/></p>
<p>这样我们就实现了旋转区域的渲染，接下来就实现拖动旋转功能。</p>
<p>还值得注意的是，在单个的时候我们的坐标系都是以元素自身为参考，所以旋转的时候参考的坐标系也跟着旋转了，所以在计算旋转后的点坐标时我们使用了 <code>final deg = rotateNumber * pi / 180;</code> 进行还原操作，但在手势提升到外层容器了后，旋转都是元素自身，坐标系始终是以外层容器为参考，所以不需要进行还原。接下来实现元素的旋转（原理之前都分析了，所以这里直接给出一些新增的关键代码代码加注释）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">以传入元素为参考确定某点旋转后的坐标</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">以传入的[item]为参考，计算原坐标[x]和[y]旋转后的坐标</span></span>
Offset _rotatePoint({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y,
  <span class="hljs-keyword">required</span> ElementModel item,
}) {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> deg = item.rotationAngle;
  <span class="hljs-comment">// 确定旋转中心，坐标系是以外层容器为基准</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> centerX = item.x + item.elementWidth / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> centerY = item.y + item.elementHeight / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> diffX = x - centerX;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> diffY = y - centerY;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> dx = diffX * cos(deg) - diffY * sin(deg) + centerX;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> dy = diffX * sin(deg) + diffY * cos(deg) + centerY;

  <span class="hljs-keyword">return</span> Offset(dx, dy);
}

<span class="hljs-comment">/// <span class="markdown">判断点击落点是否在元素的某个操作区域</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">以传入的[item]元素为参考，</span></span>
<span class="hljs-comment">/// <span class="markdown">判断当前点击的坐标[x]和[y]是否落在[item]元素的某个响应区域</span></span>
ElementStatus? _getElementZone({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y,
  <span class="hljs-keyword">required</span> ElementModel item,
}) {
  ElementStatus? tempStatus;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ConstantsConfig.baseAreaList.length; i++) {
    <span class="hljs-keyword">final</span> ResponseAreaModel currentArea = ConstantsConfig.baseAreaList[i];
    <span class="hljs-comment">// 计算操旋转过后的操作区域的中心点坐标</span>
    <span class="hljs-keyword">final</span> Offset pos = _rotatePoint(
      x: item.x + item.elementWidth * currentArea.xRatio,
      y: item.y + item.elementHeight * currentArea.yRatio,
      item: item,
    );
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> dx = pos.dx;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> dy = pos.dy;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> areaCW = currentArea.areaWidth / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> areaCH = currentArea.areaHeight / <span class="hljs-number">2</span>;

    <span class="hljs-comment">// 以区域中心点计算区域边界值和坐标进行比较</span>
    <span class="hljs-keyword">if</span> (
      x &gt;= dx - areaCW &amp;&amp;
      x &lt;= dx + areaCW &amp;&amp;
      y &gt;= dy - areaCH &amp;&amp;
      y &lt;= dy + areaCH
    ) {
      tempStatus = currentArea.status;
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">return</span> tempStatus;
}

<span class="hljs-comment">/// <span class="markdown">判断点击的区域</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">以传入的[item]元素为参考，</span></span>
<span class="hljs-comment">/// <span class="markdown">判断当前点击的坐标[x]和[y]落在[item]元素的哪个响应区域</span></span>
ElementStatus? _onDownZone({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y,
  <span class="hljs-keyword">required</span> ElementModel item,
}) {
  <span class="hljs-comment">// 先判断是否在响应对应操作的区域</span>
  <span class="hljs-keyword">final</span> ElementStatus? areaStatus = _getElementZone(x: x, y: y, item: item);
  <span class="hljs-keyword">if</span> (areaStatus != <span class="hljs-keyword">null</span>) {
    <span class="hljs-keyword">return</span> areaStatus;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_insideElement(x: x, y: y, item: item)) {
    <span class="hljs-comment">// 因为加入旋转，所以单独抽取落点是否在元素内部的方法</span>
    <span class="hljs-keyword">return</span> ElementStatus.move;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
}

<span class="hljs-comment">/// <span class="markdown">判断点击落点是否在元素内部</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">以传入的[item]元素为参考，</span></span>
<span class="hljs-comment">/// <span class="markdown">判断当前点击的坐标[x]和[y]是否落在[item]元素的内部</span></span>
<span class="hljs-built_in">bool</span> _insideElement({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y,
  <span class="hljs-keyword">required</span> ElementModel item,
}) {
  <span class="hljs-built_in">bool</span> isInside = <span class="hljs-keyword">false</span>;

  <span class="hljs-comment">// 计算元素的四个顶点坐标</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Offset&gt; square = [
    _rotatePoint(
      x: item.x,
      y: item.y,
      item: item,
    ),
    _rotatePoint(
      x: item.x + item.elementWidth,
      y: item.y,
      item: item,
    ),
    _rotatePoint(
      x: item.x + item.elementWidth,
      y: item.y + item.elementHeight,
      item: item,
    ),
    _rotatePoint(
      x: item.x,
      y: item.y + item.elementHeight,
      item: item,
    ),
  ];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, j = square.length - <span class="hljs-number">1</span>; i &lt; square.length; j = i++) {
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> xi = square[i].dx;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> yi = square[i].dy;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> xj = square[j].dx;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> yj = square[j].dy;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> intersect = yi &gt; y != yj &gt; y &amp;&amp; x &lt; (xj - xi) * (y - yi) / (yj - yi) + xi;

    <span class="hljs-keyword">if</span> (intersect) isInside = !isInside;
  }

  <span class="hljs-keyword">return</span> isInside;
}

<span class="hljs-comment">/// <span class="markdown">处理元素旋转</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">通过移动点坐标[x]和[y]与按下的初始坐标计算旋转的角度</span></span>
_onRotate({<span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x, <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y}) {
  <span class="hljs-keyword">if</span> (_currentElement == <span class="hljs-keyword">null</span> || _temporary == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> centerX = _currentElement!.x + _currentElement!.elementWidth / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> centerY = _currentElement!.y + _currentElement!.elementHeight / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> angleStart = atan2(
    _startPosition.dy - centerY,
    _startPosition.dx - centerX,
  );
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> angleEnd = atan2(y - centerY, x - centerX);

  _currentElement = _currentElement!.copyWith(
    rotationAngle: _temporary!.rotationAngle + angleEnd - angleStart,
  );
  _onChange();
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d53f0dada9db4d90b9d0c535c65a2be3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851343&amp;x-signature=xEYIHsBtUXyd4iVjrlc0Wtc9sJ8%3D" alt="image02.gif" loading="lazy"/></p>
<p>这样我们就简单完成了旋转功能。</p>
<p>其实现在我们对于区域的实现就有个大概的步骤了：</p>
<ol>
<li>向区域列表中新增一个区域</li>
<li>手势响应的时候判断是否在这个区域（判断区域逻辑）</li>
<li>在这个区域执行相应的（功能实现逻辑）</li>
</ol>
<p>按照上面的步骤，接下来我们快速实现一下缩放的功能。之前我们使用的是以宽度为基准实现的元素缩放，这样如果y变化大于x的变化，就会不是很协调，现在我们使用新的一种计算方式，以初始按下的坐标和中心点坐标的距离和结束点坐标到中心点坐标的距离来计算缩放的比例，通过这个比例再去计算宽高，这样可能稍微会协调一点。不过这样就需要记录初始的宽高（简单说明一下，对于完整的单次操作，在移动过程中，我们的变换都是基于上一次的状态来叠加的，所以变换过程中，使用初始状态加上变换的差值就可以得到移动过程中的状态）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>

<span class="hljs-comment">// 缩放</span>
ResponseAreaModel(
  areaWidth: <span class="hljs-number">20</span>,
  areaHeight: <span class="hljs-number">20</span>,
  xRatio: <span class="hljs-number">1</span>,
  yRatio: <span class="hljs-number">1</span>,
  status: ElementStatus.scale,
  icon: <span class="hljs-string">'assets/images/icon_scale.png'</span>,
  trigger: TriggerMethod.move,
),
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">处理元素缩放</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">通过移动点坐标[x]和[y]与按下的初始坐标，</span></span>
<span class="hljs-comment">/// <span class="markdown">通过两个坐标距离中心点的距离计算缩放比例</span></span>
<span class="hljs-keyword">void</span> _onScale({<span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x, <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y}) {
  <span class="hljs-keyword">if</span> (_currentElement == <span class="hljs-keyword">null</span> || _temporary == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> oWidth = _temporary!.width;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> oHeight = _temporary!.height;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> oX = _temporary!.x;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> oY = _temporary!.y;
  <span class="hljs-comment">// 中心点坐标，因为缩放不涉及到移动，</span>
  <span class="hljs-comment">// 所以中心点其实是没变的，用最初的值计算就行</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> centerX = oX + oWidth / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> centerY = oY + oHeight / <span class="hljs-number">2</span>;
  <span class="hljs-comment">// 按下点与中心点的距离</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> lineStart = sqrt(
    pow(centerX - _startPosition.dx, <span class="hljs-number">2</span>) + pow(centerY - _startPosition.dy, <span class="hljs-number">2</span>),
  );

  <span class="hljs-comment">// 极地极低的概率出现0，因为真实手指点击到原始正中心点的概率太低了</span>
  <span class="hljs-keyword">if</span> (lineStart == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> lineEnd = sqrt(pow(centerX - x, <span class="hljs-number">2</span>) + pow(centerY - y, <span class="hljs-number">2</span>));
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> resizeRatio = lineEnd / lineStart;
  <span class="hljs-built_in">double</span> newW = oWidth * resizeRatio;
  <span class="hljs-built_in">double</span> newH = oHeight * resizeRatio;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> minSize = ConstantsConfig.minSize;

  <span class="hljs-comment">// 以短边为基准来计算最小宽高</span>
  <span class="hljs-keyword">if</span> (oWidth &lt;= oHeight &amp;&amp; newW &lt; minSize) {
    newW = minSize;
    newH = minSize * oHeight / oWidth;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oHeight &lt; oWidth &amp;&amp; newH &lt; minSize) {
    newH = minSize;
    newW = minSize * oWidth / oHeight;
  }

  <span class="hljs-comment">// 以长边为基准来计算最大宽高</span>
  <span class="hljs-keyword">if</span> (oWidth &gt;= oHeight &amp;&amp; newW &gt;= _containerWidth) {
    newW = _containerWidth;
    newH = _containerWidth * oHeight / oWidth;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oHeight &gt; oWidth &amp;&amp; newH &gt;= _containerHeight) {
    newH = _containerHeight;
    newW = _containerHeight * oWidth / oHeight;
  }

  <span class="hljs-keyword">if</span> (
    newW == _currentElement?.elementWidth &amp;&amp;
    newH == _currentElement?.elementHeight
  ) {
    <span class="hljs-keyword">return</span>;
  }

  _currentElement = _currentElement?.copyWith(
    elementWidth: newW,
    elementHeight: newH,
    x: oX - (newW - oWidth) / <span class="hljs-number">2</span>,
    y: oY - (newH - oHeight) / <span class="hljs-number">2</span>,
  );
  _onChange();
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1f087008014c61bad0257bd8166d74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851343&amp;x-signature=ne5K10YwpyDfSXmVu1c1D%2BOk3gw%3D" alt="image03.gif" loading="lazy"/></p>
<p>这样我们就简单将前面单个元素的操作复刻实现了，接下来我们再多加入几个元素看下效果：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>

<span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;ElementModel&gt; _elementList = [
  ElementModel(
    id: <span class="hljs-built_in">DateTime</span>.now().millisecondsSinceEpoch,
    elementWidth: <span class="hljs-number">100</span>,
    elementHeight: <span class="hljs-number">100</span>,
  ),
  ElementModel(
    id: <span class="hljs-built_in">DateTime</span>.now().millisecondsSinceEpoch - <span class="hljs-number">10</span>,
    elementWidth: <span class="hljs-number">80</span>,
    elementHeight: <span class="hljs-number">120</span>,
    x: <span class="hljs-number">50</span>,
    y: <span class="hljs-number">120</span>,
  ),
  ElementModel(
    id: <span class="hljs-built_in">DateTime</span>.now().millisecondsSinceEpoch + <span class="hljs-number">10</span>,
    elementWidth: <span class="hljs-number">60</span>,
    elementHeight: <span class="hljs-number">140</span>,
    x: <span class="hljs-number">100</span>,
    y: <span class="hljs-number">280</span>,
  ),
];
</code></pre>
<p>运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5d1804c00d1465f8649411b455aaae7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851343&amp;x-signature=%2F7OHQH47YZIWXUSTfR2lyMm3p8k%3D" alt="image04.gif" loading="lazy"/></p>
<p>可以看到，这样就简单实现了多个元素的变换。代码还有优化空间，让我们一步一步来，不着急。</p>
<p>感兴趣的也可以关注我的微信公众号【前端学习小营地】，不定时会分享一些小功能～</p>
<p>今天的分享到此结束了，感谢阅读～拜拜～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入源码：React 19 useActionState 与 Next.js Server Actions 的完美融合]]></title>    <link>https://juejin.cn/post/7585463258691698697</link>    <guid>https://juejin.cn/post/7585463258691698697</guid>    <pubDate>2025-12-20T19:53:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258691698697" data-draft-id="7585484081436409907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 深入源码：React 19 useActionState 与 Next.js Server Actions 的完美融合"/> <meta itemprop="keywords" content="React.js,Next.js"/> <meta itemprop="datePublished" content="2025-12-20T19:53:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bytemanx"/> <meta itemprop="url" content="https://juejin.cn/user/4059855780846936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             深入源码：React 19 useActionState 与 Next.js Server Actions 的完美融合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059855780846936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bytemanx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T19:53:43.000Z" title="Sat Dec 20 2025 19:53:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文深入探讨 React 19 的新 Hook <code>useActionState</code>（原 <code>useFormState</code>），结合 Next.js 源码分析其在 Progressive Enhancement（渐进增强）和 Server Actions 中的核心机制。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>在 React 19 中，<code>useActionState</code> 是一个非常重要的新 Hook，它专门用于处理 Form Actions 的状态。如果你之前使用过 <code>useFormState</code>，其实它们是同一个东西，只是名字变了。</p>
<p>它的核心作用是：<strong>允许你在 Form Action 提交时，获取服务器返回的状态（如错误信息、成功提示），并根据这个状态更新 UI。</strong></p>
<p>但更重要的是，当它与 Next.js App Router 结合时，它展现出了强大的<strong>渐进增强</strong>（Progressive Enhancement）能力——即使 JavaScript 被禁用，表单依然可以正常提交并更新状态。</p>
<p>今天我们就通过源码分析，看看 Next.js 是如何实现这一点的。</p>
<h2 data-id="heading-1">1. 实战：useActionState 的基本用法</h2>
<p>首先，我们看一个简单的 Todo List 例子。这个例子来源于 Next.js 官方示例 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Ftree%2Fv16.1.0%2Fexamples%2Fnext-forms" target="_blank" title="https://github.com/vercel/next.js/tree/v16.1.0/examples/next-forms" ref="nofollow noopener noreferrer">next-forms</a>。</p>
<h3 data-id="heading-2">Server Action (<code>app/actions.ts</code>)</h3>
<p>这是运行在服务端的代码，负责处理数据库操作。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-string">"use server"</span>;

<span class="hljs-keyword">import</span> { revalidatePath } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/cache"</span>;
<span class="hljs-keyword">import</span> postgres <span class="hljs-keyword">from</span> <span class="hljs-string">"postgres"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-comment">// ...数据库连接代码...</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createTodo</span>(<span class="hljs-params">
  prevState: { message: <span class="hljs-built_in">string</span> },
  formData: FormData,
</span>) {
  <span class="hljs-keyword">const</span> schema = z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">todo</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>),
  });
  
  <span class="hljs-keyword">const</span> parse = schema.<span class="hljs-title function_">safeParse</span>({
    <span class="hljs-attr">todo</span>: formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">"todo"</span>),
  });

  <span class="hljs-keyword">if</span> (!parse.<span class="hljs-property">success</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"Failed to create todo"</span> };
  }

  <span class="hljs-keyword">const</span> data = parse.<span class="hljs-property">data</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> sql<span class="hljs-string">`
      INSERT INTO todos (text)
      VALUES (<span class="hljs-subst">${data.todo}</span>)
    `</span>;

    <span class="hljs-title function_">revalidatePath</span>(<span class="hljs-string">"/"</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">`Added todo <span class="hljs-subst">${data.todo}</span>`</span> };
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"Failed to create todo"</span> };
  }
}
</code></pre>
<p>注意 <code>createTodo</code> 的签名：它接收 <code>prevState</code> 作为第一个参数。这就是 <code>useActionState</code> 注入的状态。</p>
<h3 data-id="heading-3">Client Component (<code>app/add-form.tsx</code>)</h3>
<p>这是客户端组件，使用 <code>useActionState</code> 绑定 Server Action。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-string">"use client"</span>;

<span class="hljs-keyword">import</span> { useActionState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { useFormStatus } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom"</span>;
<span class="hljs-keyword">import</span> { createTodo } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/app/actions"</span>;

<span class="hljs-keyword">const</span> initialState = {
  <span class="hljs-attr">message</span>: <span class="hljs-string">""</span>,
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SubmitButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { pending } = <span class="hljs-title function_">useFormStatus</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">aria-disabled</span>=<span class="hljs-string">{pending}</span>&gt;</span>
      Add
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AddForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// useActionState 接收 action 和初始状态</span>
  <span class="hljs-comment">// 返回最新的 state 和一个新的 dispatch action</span>
  <span class="hljs-keyword">const</span> [state, formAction] = <span class="hljs-title function_">useActionState</span>(createTodo, initialState);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{formAction}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">"todo"</span>&gt;</span>Enter Task<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"todo"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"todo"</span> <span class="hljs-attr">required</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SubmitButton</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">aria-live</span>=<span class="hljs-string">"polite"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"sr-only"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"status"</span>&gt;</span>
        {state?.message}
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<p>这个模式非常优雅：</p>
<ol>
<li><strong>初始状态</strong>：<code>message</code> 为空。</li>
<li><strong>提交</strong>：用户点击按钮，<code>formAction</code> 触发 <code>createTodo</code>。</li>
<li><strong>更新</strong>：Server Action 执行完毕返回新对象（如 <code>{ message: "Added todo..." }</code>），<code>state</code> 自动更新，UI 重新渲染。</li>
</ol>
<h2 data-id="heading-4">2. 核心优势一：无 JS 支持 (Progressive Enhancement)</h2>
<p>大家觉得，如果我禁用了浏览器的 JavaScript，这个表单还能工作吗？</p>
<p>答案是：<strong>可以！</strong></p>
<p>看看这个效果（JS 被禁用）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74bb2145da2944a880cab694e5dfd14d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766865223&amp;x-signature=wjN1A08mVy7xlUtTlbWNNWtb9W4%3D" alt="disable JS 情况下请求JS失败图" loading="lazy"/></p>
<p>虽然 JS 加载失败，但提交表单依然可以更新页面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ef5346a0b8446b80b32cb427aae876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766865223&amp;x-signature=i0uX3sKNMhwWnM3Sm57ahvHaUVI%3D" alt="useActionState在disable JS的条件下依然可以工作" loading="lazy"/></p>
<h3 data-id="heading-5">原理分析：MPA 模式</h3>
<p>当 JS 被禁用时，<code>&lt;form&gt;</code> 会退化为标准的 HTML 表单提交。浏览器会发送一个 <code>POST</code> 请求到当前 URL。</p>
<p>Next.js 的服务器端处理逻辑主要在 <code>packages/next/src/server/app-render/action-handler.ts</code> 中。</p>
<h4 data-id="heading-6">1. 识别请求类型</h4>
<p>Next.js 会检查请求是否是 Server Action。有趣的是，它会区分 <strong>Fetch Action</strong>（有 JS，AJAX 请求）和 <strong>MPA Action</strong>（无 JS，表单 POST）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fblob%2Fv16.1.0%2Fpackages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts%23L547" target="_blank" title="https://github.com/vercel/next.js/blob/v16.1.0/packages/next/src/server/app-render/action-handler.ts#L547" ref="nofollow noopener noreferrer">next.js/packages/ne…</a></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// next.js/packages/next/src/server/app-render/action-handler.ts</span>

<span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> {
    actionId,
    isMultipartAction,
    isFetchAction, <span class="hljs-comment">// 关键点：是否有 Next-Action 头或相关标识</span>
    <span class="hljs-comment">// ...</span>
  } = <span class="hljs-title function_">getServerActionRequestMetadata</span>(req)
<span class="hljs-comment">// ...</span>
</code></pre>
<h4 data-id="heading-7">2. 处理 MPA Action</h4>
<p>如果 <code>isFetchAction</code> 为 false（即无 JS 环境），Next.js 会走另一条路：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fblob%2Fv16.1.0%2Fpackages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts%23L771" target="_blank" title="https://github.com/vercel/next.js/blob/v16.1.0/packages/next/src/server/app-render/action-handler.ts#L771" ref="nofollow noopener noreferrer">next.js/packages/ne…</a></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Multipart POST, but not a fetch action.</span>
<span class="hljs-comment">// Potentially an MPA action, we have to try decoding it to check.</span>

<span class="hljs-keyword">const</span> action = <span class="hljs-keyword">await</span> <span class="hljs-title function_">decodeAction</span>(formData, serverModuleMap)
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> action === <span class="hljs-string">'function'</span>) {
  <span class="hljs-comment">// 这是一个 MPA action (无 JS)</span>
  
  <span class="hljs-comment">// 执行 Action</span>
  <span class="hljs-keyword">const</span> { actionResult } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">executeActionAndPrepareForRender</span>(
    action,
    [], <span class="hljs-comment">// MPA 模式下没有额外的绑定参数</span>
    workStore,
    requestStore,
    actionWasForwarded
  )

  <span class="hljs-comment">// 关键：解码 Form State</span>
  <span class="hljs-keyword">const</span> formState = <span class="hljs-keyword">await</span> <span class="hljs-title function_">decodeFormState</span>(
    actionResult,
    formData,
    serverModuleMap
  )

  <span class="hljs-comment">// Skip the fetch path.</span>
  <span class="hljs-comment">// We need to render a full HTML version of the page for the response</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'done'</span>,
    <span class="hljs-attr">result</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// 这里的 undefined 意味着后续会继续进行页面渲染 (App Render)</span>
    formState, <span class="hljs-comment">// 把 Action 的执行结果传递给页面渲染流程</span>
  }
}
</code></pre>
<p><strong>核心流程：</strong></p>
<ol>
<li><strong>解析 FormData</strong>：Next.js 从 POST body 中解析出 <code>actionId</code>（这是一个隐藏字段，React 生成的）。</li>
<li><strong>执行 Action</strong>：找到对应的 Server Action 函数并执行。</li>
<li><strong>携带 State 重新渲染</strong>：它<strong>不会</strong>返回 JSON，而是带着 <code>formState</code>（Action 的返回值）重新渲染整个页面（Full Page Render）。</li>
<li><strong>HTML 返回</strong>：浏览器收到的是一个新的 HTML 页面，其中包含了更新后的 UI 和数据。</li>
</ol>
<p>这就是为什么禁用 JS 也能工作！Next.js 自动帮我们处理了"回退到传统表单提交"的所有逻辑。</p>
<h2 data-id="heading-8">3. 核心优势二：客户端交互与局部更新</h2>
<p>当 JS 启用时，React 会接管表单提交。</p>
<h3 data-id="heading-9">客户端劫持 (<code>app-call-server.ts</code>)</h3>
<p>当表单提交时，Next.js 的客户端逻辑会拦截它。注意，这里使用了 React 的 <code>startTransition</code>（参考：<a href="https://juejin.cn/post/7582890166358425626" target="_blank" title="https://juejin.cn/post/7582890166358425626">深入理解 React 的 startTransition</a>）来标记非紧急更新，保持 UI 响应性：</p>
<p>源码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fblob%2Fv16.1.0%2Fpackages%2Fnext%2Fsrc%2Fclient%2Fapp-call-server.ts%23L5" target="_blank" title="https://github.com/vercel/next.js/blob/v16.1.0/packages/next/src/client/app-call-server.ts#L5" ref="nofollow noopener noreferrer">packages/next/src/client/app-call-server.ts#L5</a></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callServer</span>(<span class="hljs-params">actionId: <span class="hljs-built_in">string</span>, actionArgs: <span class="hljs-built_in">any</span>[]</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">dispatchAppRouterAction</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">ACTION_SERVER_ACTION</span>,
        actionId,
        actionArgs,
        resolve,
        reject,
      })
    })
  })
}
</code></pre>
<h3 data-id="heading-10">发送请求 (<code>server-action-reducer.ts</code>)</h3>
<p>请求会通过 <code>fetchServerAction</code> 发送。注意，这次是 <code>fetch</code> 请求，且带有特殊的 Header：</p>
<p>源码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fblob%2Fv16.1.0%2Fpackages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts%23L96" target="_blank" title="https://github.com/vercel/next.js/blob/v16.1.0/packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts#L96" ref="nofollow noopener noreferrer">packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts#L96</a></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchServerAction</span>(<span class="hljs-params"><span class="hljs-comment">/*...*/</span></span>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">headers</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
    <span class="hljs-title class_">Accept</span>: <span class="hljs-variable constant_">RSC_CONTENT_TYPE_HEADER</span>, <span class="hljs-comment">// 告诉服务器我要 RSC Payload (Flight Data)</span>
    [<span class="hljs-variable constant_">ACTION_HEADER</span>]: actionId,       <span class="hljs-comment">// Next-Action: &lt;id&gt;</span>
    [<span class="hljs-variable constant_">NEXT_ROUTER_STATE_TREE_HEADER</span>]: <span class="hljs-title function_">prepareFlightRouterStateForRequest</span>(state.<span class="hljs-property">tree</span>),
    <span class="hljs-comment">// ...</span>
  }
  
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(state.<span class="hljs-property">canonicalUrl</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>, headers, body })
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-11">优势</h3>
<ol>
<li><strong>局部更新</strong>：服务器返回的是 RSC Payload（Diff），React 只更新变动的部分，页面不刷新，滚动条位置保留。</li>
<li><strong>Pending 状态</strong>：<code>useFormStatus</code> 可以立即读取 <code>pending</code> 状态，展示 Loading 动画。这是传统 HTML 表单做不到的。</li>
</ol>
<h2 data-id="heading-12">4. 核心优势三：Server-Side UI Updates (RSC 集成)</h2>
<p>这是 <code>useActionState</code> + Next.js 最强大的地方。</p>
<p>传统的 API 请求流程是：
<code>Client 请求 -&gt; Server 处理 -&gt; Server 返回 JSON -&gt; Client 解析 JSON -&gt; Client 更新 State -&gt; Client 重新渲染组件</code></p>
<p>Next.js Server Actions 的流程是：
<code>Client 请求 -&gt; Server 处理 -&gt; Server 重新渲染组件 (RSC) -&gt; Server 返回 UI 补丁 (Flight Data) -&gt; Client 应用补丁</code></p>
<h3 data-id="heading-13">源码验证</h3>
<p>在 <code>action-handler.ts</code> 中，当 Action 执行完后：</p>
<p>源码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fblob%2Fv16.1.0%2Fpackages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts%23L1081" target="_blank" title="https://github.com/vercel/next.js/blob/v16.1.0/packages/next/src/server/app-render/action-handler.ts#L1081" ref="nofollow noopener noreferrer">packages/next/src/server/app-render/action-handler.ts#L1081</a></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ... Action 执行完毕 ...</span>

<span class="hljs-comment">// For form actions, we need to continue rendering the page.</span>
<span class="hljs-keyword">if</span> (isFetchAction) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'done'</span>,
    <span class="hljs-attr">result</span>: <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateFlight</span>(req, ctx, requestStore, {
      <span class="hljs-attr">actionResult</span>: <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(actionResult),
      <span class="hljs-comment">// ...</span>
    }),
  }
}
</code></pre>
<p><code>generateFlight</code> 会生成 React Server Component 的序列化数据。</p>
<p>这意味着，如果在 Action 中调用了 <code>revalidatePath('/')</code>：</p>
<ol>
<li>Next.js 会在服务器上重新渲染首页。</li>
<li>你的 <code>todos</code> 列表（从数据库读取）会在<strong>服务器端</strong>更新。</li>
<li>新的 UI 结构（包含新添加的 todo）会被发送给客户端。</li>
<li>客户端直接合并 DOM，不需要在客户端写一行 <code>todos.push(newTodo)</code> 的状态管理代码！</li>
</ol>
<p><strong>Form 状态与 UI 更新同步</strong>：<code>useActionState</code> 拿到了 <code>message</code>，而页面列表通过 RSC 更新了。</p>
<h2 data-id="heading-14">5. 其他优势</h2>
<h3 data-id="heading-15">安全性 (CSRF 自动防护)</h3>
<p>在 <code>action-handler.ts</code> 中，Next.js 内置了 Origin 检查，防止 CSRF 攻击：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Fblob%2Fv16.1.0%2Fpackages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts%23L622" target="_blank" title="https://github.com/vercel/next.js/blob/v16.1.0/packages/next/src/server/app-render/action-handler.ts#L622" ref="nofollow noopener noreferrer">next.js/packages/ne…</a></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// next.js/packages/next/src/server/app-render/action-handler.ts</span>
<span class="hljs-comment">// This is to prevent CSRF attacks. </span>
<span class="hljs-keyword">if</span> (!originDomain) {
  <span class="hljs-comment">// ... warning</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!host || originDomain !== host.<span class="hljs-property">value</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCsrfOriginAllowed</span>(originDomain, serverActions?.<span class="hljs-property">allowedOrigins</span>)) {
    <span class="hljs-comment">// Allowed</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Block attack</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`... Aborting the action.`</span>)
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<h3 data-id="heading-16">简化代码</h3>
<p>对比一下传统做法：</p>
<ul>
<li><strong>传统</strong>：<code>onSubmit</code>, <code>e.preventDefault()</code>, <code>fetch('/api/...')</code>, <code>await res.json()</code>, <code>if (res.ok) ... else ...</code>，还要处理 Loading。</li>
<li><strong>Next.js</strong>：一个 <code>action</code> 属性搞定。错误处理和 Loading 状态都通过 Hook 自动管理。</li>
</ul>
<h2 data-id="heading-17">总结</h2>
<p><code>useActionState</code> 不仅仅是一个状态管理 Hook，在 Next.js 中，它是连接客户端表单与服务端逻辑的桥梁。</p>
<p>它的优势在于：</p>
<ol>
<li><strong>渐进增强</strong>：JS 挂了？没问题，MPA 模式顶上。</li>
<li><strong>开发体验</strong>：像写普通函数一样写后端逻辑，不需要手动 fetch。</li>
<li><strong>RSC 融合</strong>：一次请求，同时完成"状态更新"和"UI 重新渲染"。</li>
<li><strong>性能优化</strong>：底层使用 <code>startTransition</code>，保持 UI 响应性，避免阻塞渲染。</li>
<li><strong>安全可靠</strong>：内置 CSRF 防护。</li>
</ol>
<p>下次写表单时，试试 <code>useActionState</code>，感受一下现代 React 开发的魅力吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nicegui 3.4.0 可以缩小组件之间的间距 label botton input textarea]]></title>    <link>https://juejin.cn/post/7585476892977201186</link>    <guid>https://juejin.cn/post/7585476892977201186</guid>    <pubDate>2025-12-21T01:02:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585476892977201186" data-draft-id="7585555806666850338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nicegui 3.4.0 可以缩小组件之间的间距 label botton input textarea"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-21T01:02:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PieroPC"/> <meta itemprop="url" content="https://juejin.cn/user/1998231182522521"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nicegui 3.4.0 可以缩小组件之间的间距 label botton input textarea
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1998231182522521/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PieroPC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T01:02:13.000Z" title="Sun Dec 21 2025 01:02:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b57cace516cd4a2491df172e54860aeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGllcm9QQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766883732&amp;x-signature=7OTEBn4O58qfO2dCl%2Fs%2F8dR5Ex4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">缩小输入框之间的间距：</h2>
<h3 data-id="heading-1">1. <strong>使用紧凑布局容器</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-0'</span>):  <span class="hljs-comment"># 设置间距为0</span>
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'输入框1'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'输入框2'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'输入框3'</span>)
</code></pre>
<h3 data-id="heading-2">2. <strong>自定义间距类</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 方法1: 使用Tailwind CSS类</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1'</span>):  <span class="hljs-comment"># 设置较小的间距（0.25rem）</span>
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'姓名'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'邮箱'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'电话'</span>)

<span class="hljs-comment"># 方法2: 更小的间距</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-px'</span>):  <span class="hljs-comment"># 最小间距（1px）</span>
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'用户名'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'密码'</span>)
</code></pre>
<h3 data-id="heading-3">3. <strong>使用网格布局减少间距</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 网格布局可以更精确控制</span>
<span class="hljs-keyword">with</span> ui.grid(columns=<span class="hljs-number">1</span>).classes(<span class="hljs-string">'gap-1'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'项目1'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'项目2'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'项目3'</span>)
</code></pre>
<h3 data-id="heading-4">4. <strong>自定义CSS样式</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 全局减少所有输入框间距</span>
ui.add_css(<span class="hljs-string">'''
    .nicegui-content .q-field {
        margin-bottom: 4px !important;
    }
    .nicegui-content .q-field__control {
        min-height: 40px !important;
    }
'''</span>)

<span class="hljs-comment"># 或者针对特定容器</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'my-container'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'测试1'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'测试2'</span>)
    
ui.add_css(<span class="hljs-string">'''
    .my-container .q-field {
        margin-bottom: 2px !important;
    }
'''</span>)
</code></pre>
<h3 data-id="heading-5">5. <strong>使用紧凑模式</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建紧凑的表单</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'compact-form'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'字段A'</span>).classes(<span class="hljs-string">'my-1'</span>)  <span class="hljs-comment"># 上下边距1</span>
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'字段B'</span>).classes(<span class="hljs-string">'my-1'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'字段C'</span>).classes(<span class="hljs-string">'my-1'</span>)

ui.add_css(<span class="hljs-string">'''
    .compact-form .q-field {
        margin-bottom: 4px;
    }
    .compact-form .q-field__label {
        font-size: 12px;
        margin-bottom: 2px;
    }
'''</span>)
</code></pre>
<h3 data-id="heading-6">6. <strong>水平排列减少垂直间距</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 如果合适，可以考虑水平排列</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center gap-2'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'名字'</span>).classes(<span class="hljs-string">'w-32'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'姓氏'</span>).classes(<span class="hljs-string">'w-32'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'年龄'</span>).classes(<span class="hljs-string">'w-20'</span>)
</code></pre>
<h3 data-id="heading-7">7. <strong>完整示例</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> nicegui <span class="hljs-keyword">import</span> ui

<span class="hljs-comment"># 方法1: 使用紧凑列</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1 w-64'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'用户名'</span>).props(<span class="hljs-string">'dense'</span>)  <span class="hljs-comment"># dense属性让输入框更紧凑</span>
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'密码'</span>).props(<span class="hljs-string">'dense outlined'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'确认密码'</span>).props(<span class="hljs-string">'dense outlined'</span>)

ui.separator()

<span class="hljs-comment"># 方法2: 自定义间距</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'my-form w-64'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'邮箱地址'</span>).classes(<span class="hljs-string">'mb-1'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'手机号码'</span>).classes(<span class="hljs-string">'mb-1'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'地址'</span>).classes(<span class="hljs-string">'mb-1'</span>)

<span class="hljs-comment"># 自定义CSS</span>
ui.add_css(<span class="hljs-string">'''
    .my-form .q-field {
        margin-bottom: 2px;
    }
    .my-form .q-field__control {
        min-height: 36px;
    }
'''</span>)

ui.run()
</code></pre>
<h3 data-id="heading-8">建议：</h3>
<ol>
<li><strong>先尝试 <code>gap-1</code> 或 <code>gap-0.5</code></strong> - 这些通常是合适的紧凑间距</li>
<li><strong>配合使用 <code>props('dense')</code></strong> - 让输入框内部也更紧凑</li>
<li><strong>使用网格布局</strong> - 对于需要精确控制的情况</li>
</ol>
<p>根据你的具体布局需求，可以组合使用这些方法。</p>
<h2 data-id="heading-9">对于 <code>ui.textarea</code>，缩小间距</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53393c6c33df4a1fa9ed6fa6b681c5f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGllcm9QQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766883732&amp;x-signature=b0lk4yyMWumJwaznfmdLvh9MCy4%3D" alt="image.png" loading="lazy"/></p>
<p>对于 <code>ui.textarea</code>，同样可以使用类似的方法缩小间距。以下是针对 <code>ui.textarea</code> 的具体方案：</p>
<h3 data-id="heading-10">1. <strong>使用紧凑布局容器</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基本的紧凑布局</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1'</span>):  <span class="hljs-comment"># 小间距</span>
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'标题'</span>)
    ui.textarea(label=<span class="hljs-string">'内容描述'</span>).props(<span class="hljs-string">'rows=3'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'标签'</span>)
</code></pre>
<h3 data-id="heading-11">2. <strong>自定义textarea样式</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 减少特定textarea的间距</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1 w-full'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'主题'</span>)
    
    <span class="hljs-comment"># 使用props调整textarea特性</span>
    ui.textarea(label=<span class="hljs-string">'详细内容'</span>) \
        .props(<span class="hljs-string">'''
            dense
            outlined
            autogrow
            rows=3
        '''</span>) \
        .classes(<span class="hljs-string">'mb-1'</span>)  <span class="hljs-comment"># 单独控制下边距</span>
    
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'联系方式'</span>)
</code></pre>
<h3 data-id="heading-12">3. <strong>多个textarea紧凑排列</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'compact-textareas gap-1'</span>):
    ui.textarea(label=<span class="hljs-string">'需求描述'</span>).props(<span class="hljs-string">'rows=2 dense'</span>)
    ui.textarea(label=<span class="hljs-string">'技术要求'</span>).props(<span class="hljs-string">'rows=2 dense'</span>)
    ui.textarea(label=<span class="hljs-string">'备注说明'</span>).props(<span class="hljs-string">'rows=1 dense'</span>)

ui.add_css(<span class="hljs-string">'''
    .compact-textareas .q-field {
        margin-bottom: 4px !important;
    }
    .compact-textareas textarea {
        min-height: 60px !important;
    }
'''</span>)
</code></pre>
<h3 data-id="heading-13">4. <strong>表单中混合使用input和textarea</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建紧凑表单</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'w-96 gap-1'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'项目名称'</span>).props(<span class="hljs-string">'dense outlined'</span>)
    
    ui.textarea(label=<span class="hljs-string">'项目描述'</span>) \
        .props(<span class="hljs-string">'dense outlined autogrow rows=2'</span>) \
        .classes(<span class="hljs-string">'min-h-[80px]'</span>)
    
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'负责人'</span>).props(<span class="hljs-string">'dense outlined'</span>)
    
    ui.textarea(label=<span class="hljs-string">'注意事项'</span>) \
        .props(<span class="hljs-string">'dense outlined rows=1'</span>) \
        .classes(<span class="hljs-string">'min-h-[50px]'</span>)
    
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'截止日期'</span>).props(<span class="hljs-string">'dense outlined'</span>)
</code></pre>
<h3 data-id="heading-14">5. <strong>使用网格布局精确控制</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用网格布局控制间距</span>
<span class="hljs-keyword">with</span> ui.grid(columns=<span class="hljs-number">1</span>).classes(<span class="hljs-string">'gap-1 w-full'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'标题'</span>).props(<span class="hljs-string">'dense'</span>)
    
    ui.textarea(label=<span class="hljs-string">'正文内容'</span>) \
        .props(<span class="hljs-string">'dense autogrow rows=4'</span>) \
        .classes(<span class="hljs-string">'col-span-1'</span>)
    
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-2 w-full'</span>):
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'分类'</span>).props(<span class="hljs-string">'dense'</span>).classes(<span class="hljs-string">'flex-grow'</span>)
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'优先级'</span>).props(<span class="hljs-string">'dense'</span>).classes(<span class="hljs-string">'w-24'</span>)
</code></pre>
<h3 data-id="heading-15">6. <strong>自定义高度和间距</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 控制textarea的高度和间距</span>
ui.textarea(label=<span class="hljs-string">'评论'</span>) \
    .props(<span class="hljs-string">'dense outlined rows=2'</span>) \
    .classes(<span class="hljs-string">'''
        mb-1
        min-h-[80px]
        max-h-[120px]
    '''</span>)

<span class="hljs-comment"># 或者使用style直接设置</span>
ui.textarea(label=<span class="hljs-string">'备注'</span>) \
    .style(<span class="hljs-string">'margin-bottom: 4px; min-height: 60px;'</span>)
</code></pre>
<h3 data-id="heading-16">7. <strong>完整示例：评论表单</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> nicegui <span class="hljs-keyword">import</span> ui

<span class="hljs-comment"># 紧凑的评论表单</span>
<span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-96'</span>):
    ui.label(<span class="hljs-string">'发表评论'</span>).classes(<span class="hljs-string">'text-lg font-bold mb-2'</span>)
    
    <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1'</span>):
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'姓名'</span>).props(<span class="hljs-string">'dense outlined'</span>)
        
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'邮箱'</span>).props(<span class="hljs-string">'dense outlined'</span>)
        
        ui.textarea(label=<span class="hljs-string">'评论内容'</span>) \
            .props(<span class="hljs-string">'''
                dense
                outlined
                autogrow
                rows=2
                counter
                maxlength=200
            '''</span>) \
            .classes(<span class="hljs-string">'min-h-[80px] mb-1'</span>)
        
        <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'justify-end gap-2'</span>):
            ui.button(<span class="hljs-string">'取消'</span>, color=<span class="hljs-string">'gray'</span>)
            ui.button(<span class="hljs-string">'提交'</span>, color=<span class="hljs-string">'primary'</span>)

ui.separator()

<span class="hljs-comment"># 另一种方式：使用自定义CSS类</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'compact-form w-96'</span>):
    ui.textarea(label=<span class="hljs-string">'需求说明'</span>) \
        .props(<span class="hljs-string">'dense rows=3'</span>) \
        .classes(<span class="hljs-string">'form-field'</span>)
    
    ui.textarea(label=<span class="hljs-string">'实现方案'</span>) \
        .props(<span class="hljs-string">'dense rows=3'</span>) \
        .classes(<span class="hljs-string">'form-field'</span>)
    
    ui.textarea(label=<span class="hljs-string">'测试要点'</span>) \
        .props(<span class="hljs-string">'dense rows=2'</span>) \
        .classes(<span class="hljs-string">'form-field'</span>)

<span class="hljs-comment"># 自定义CSS</span>
ui.add_css(<span class="hljs-string">'''
    .compact-form .form-field {
        margin-bottom: 4px !important;
    }
    .compact-form .q-field__control {
        min-height: 40px !important;
    }
    .compact-form textarea {
        padding: 6px !important;
        font-size: 14px !important;
    }
'''</span>)

ui.run()
</code></pre>
<h3 data-id="heading-17">8. <strong>响应式布局中的textarea</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在不同设备上保持紧凑</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'''
    gap-1 
    sm:gap-2 
    md:gap-1
    w-full
    max-w-2xl
'''</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'标题'</span>).props(<span class="hljs-string">'dense'</span>)
    
    ui.textarea(label=<span class="hljs-string">'内容'</span>) \
        .props(<span class="hljs-string">'dense autogrow'</span>) \
        .classes(<span class="hljs-string">'''
            min-h-[100px]
            sm:min-h-[120px]
            md:min-h-[150px]
        '''</span>)
    
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'标签'</span>).props(<span class="hljs-string">'dense'</span>)
</code></pre>
<h3 data-id="heading-18">主要技巧总结：</h3>
<ol>
<li><strong>使用 <code>props('dense')</code></strong> - 这是让textarea变紧凑的最有效方法</li>
<li><strong>配合 <code>rows</code> 属性</strong> - 控制默认显示行数</li>
<li><strong>使用 <code>gap-1</code> 或更小的间距类</strong></li>
<li><strong>用 <code>min-h-[]</code> 控制最小高度</strong> - 避免textarea太小</li>
<li><strong>考虑使用 <code>autogrow</code></strong> - 让textarea根据内容自动调整高度</li>
</ol>
<p>根据你的具体需求选择合适的组合方式！</p>
<h2 data-id="heading-19">对于 <code>ui.button</code> 的间距调整</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0cb5b4bdf964f4cb2f0175e16ff94e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGllcm9QQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766883732&amp;x-signature=3NgmR7Nk78Hfbpv7qPUc0YxaZsk%3D" alt="image.png" loading="lazy"/></p>
<p>对于 <code>ui.button</code> 的间距调整，这里有多种方法：</p>
<h3 data-id="heading-20">1. <strong>按钮组紧凑排列</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 水平按钮组</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-1'</span>):  <span class="hljs-comment"># 小间距</span>
    ui.button(<span class="hljs-string">'保存'</span>, color=<span class="hljs-string">'primary'</span>)
    ui.button(<span class="hljs-string">'取消'</span>, color=<span class="hljs-string">'gray'</span>)
    ui.button(<span class="hljs-string">'删除'</span>, color=<span class="hljs-string">'red'</span>)

<span class="hljs-comment"># 垂直按钮组</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1 w-32'</span>):
    ui.button(<span class="hljs-string">'选项一'</span>, color=<span class="hljs-string">'primary'</span>)
    ui.button(<span class="hljs-string">'选项二'</span>, color=<span class="hljs-string">'secondary'</span>)
    ui.button(<span class="hljs-string">'选项三'</span>, color=<span class="hljs-string">'accent'</span>)
</code></pre>
<h3 data-id="heading-21">2. <strong>紧凑按钮样式</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用dense属性</span>
ui.button(<span class="hljs-string">'紧凑按钮'</span>, color=<span class="hljs-string">'primary'</span>).props(<span class="hljs-string">'dense'</span>)

<span class="hljs-comment"># 组合使用</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-0.5'</span>):
    ui.button(<span class="hljs-string">'新建'</span>).props(<span class="hljs-string">'dense outline'</span>)
    ui.button(<span class="hljs-string">'编辑'</span>).props(<span class="hljs-string">'dense outline'</span>)
    ui.button(<span class="hljs-string">'删除'</span>).props(<span class="hljs-string">'dense outline'</span>)
</code></pre>
<h3 data-id="heading-22">3. <strong>表单中的紧凑按钮</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'w-64 gap-2'</span>):
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'用户名'</span>).props(<span class="hljs-string">'dense'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'密码'</span>).props(<span class="hljs-string">'dense type=password'</span>)
    
    <span class="hljs-comment"># 按钮行使用更小间距</span>
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-1 justify-end'</span>):
        ui.button(<span class="hljs-string">'登录'</span>, color=<span class="hljs-string">'primary'</span>).props(<span class="hljs-string">'dense'</span>)
        ui.button(<span class="hljs-string">'重置'</span>, color=<span class="hljs-string">'gray'</span>).props(<span class="hljs-string">'dense flat'</span>)
</code></pre>
<h3 data-id="heading-23">4. <strong>图标按钮紧凑排列</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 图标按钮工具栏</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-0.5 items-center'</span>):
    ui.button(icon=<span class="hljs-string">'format_bold'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.button(icon=<span class="hljs-string">'format_italic'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.button(icon=<span class="hljs-string">'format_underlined'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.button(icon=<span class="hljs-string">'format_color_text'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.separator().props(<span class="hljs-string">'vertical'</span>).classes(<span class="hljs-string">'mx-1'</span>)
    ui.button(icon=<span class="hljs-string">'undo'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.button(icon=<span class="hljs-string">'redo'</span>).props(<span class="hljs-string">'dense flat'</span>)
</code></pre>
<h3 data-id="heading-24">5. <strong>自定义按钮样式和间距</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 自定义按钮类</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'compact-buttons'</span>):
    ui.button(<span class="hljs-string">'操作1'</span>).classes(<span class="hljs-string">'compact-btn'</span>)
    ui.button(<span class="hljs-string">'操作2'</span>).classes(<span class="hljs-string">'compact-btn'</span>)
    ui.button(<span class="hljs-string">'操作3'</span>).classes(<span class="hljs-string">'compact-btn'</span>)

ui.add_css(<span class="hljs-string">'''
    .compact-buttons {
        gap: 2px !important;
    }
    .compact-btn {
        padding: 4px 8px !important;
        font-size: 12px !important;
        min-height: 28px !important;
    }
'''</span>)
</code></pre>
<h3 data-id="heading-25">6. <strong>按钮与其他元素的紧凑布局</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 输入框带按钮</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1 w-80'</span>):
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center gap-1 w-full'</span>):
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'搜索内容'</span>).props(<span class="hljs-string">'dense'</span>).classes(<span class="hljs-string">'flex-grow'</span>)
        ui.button(<span class="hljs-string">'搜索'</span>, icon=<span class="hljs-string">'search'</span>).props(<span class="hljs-string">'dense'</span>)
    
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center gap-1 w-full'</span>):
        ui.textarea(label=<span class="hljs-string">'消息'</span>).props(<span class="hljs-string">'dense rows=2'</span>).classes(<span class="hljs-string">'flex-grow'</span>)
        ui.button(<span class="hljs-string">'发送'</span>, icon=<span class="hljs-string">'send'</span>).props(<span class="hljs-string">'dense'</span>).classes(<span class="hljs-string">'self-end'</span>)
</code></pre>
<h3 data-id="heading-26">7. <strong>导航栏/工具栏紧凑按钮</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 紧凑工具栏</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center gap-1 p-2 bg-gray-100 rounded'</span>):
    ui.button(<span class="hljs-string">'文件'</span>, icon=<span class="hljs-string">'folder'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.button(<span class="hljs-string">'编辑'</span>, icon=<span class="hljs-string">'edit'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.button(<span class="hljs-string">'视图'</span>, icon=<span class="hljs-string">'visibility'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.button(<span class="hljs-string">'工具'</span>, icon=<span class="hljs-string">'build'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.space()  <span class="hljs-comment"># 占位</span>
    ui.button(icon=<span class="hljs-string">'notifications'</span>).props(<span class="hljs-string">'dense flat'</span>)
    ui.button(icon=<span class="hljs-string">'account_circle'</span>).props(<span class="hljs-string">'dense flat'</span>)
</code></pre>
<h3 data-id="heading-27">8. <strong>完整示例：紧凑表单</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> nicegui <span class="hljs-keyword">import</span> ui

<span class="hljs-comment"># 登录表单</span>
<span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-80'</span>):
    ui.label(<span class="hljs-string">'系统登录'</span>).classes(<span class="hljs-string">'text-lg font-bold mb-3'</span>)
    
    <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-2'</span>):
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'用户名'</span>).props(<span class="hljs-string">'dense outlined'</span>)
        ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'密码'</span>).props(<span class="hljs-string">'dense outlined type=password'</span>)
        
        <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center justify-between'</span>):
            ui.checkbox(<span class="hljs-string">'记住登录'</span>)
            
            <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-1'</span>):
                ui.button(<span class="hljs-string">'注册'</span>, color=<span class="hljs-string">'gray'</span>).props(<span class="hljs-string">'dense flat'</span>)
                ui.button(<span class="hljs-string">'登录'</span>, color=<span class="hljs-string">'primary'</span>).props(<span class="hljs-string">'dense'</span>)
    
    ui.separator().classes(<span class="hljs-string">'my-2'</span>)
    
    <span class="hljs-comment"># 社交登录按钮</span>
    ui.label(<span class="hljs-string">'快速登录'</span>).classes(<span class="hljs-string">'text-sm text-gray-500 mb-1'</span>)
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-1 justify-center'</span>):
        ui.button(icon=<span class="hljs-string">'img:https://www.google.com/favicon.ico'</span>).props(<span class="hljs-string">'dense round'</span>)
        ui.button(icon=<span class="hljs-string">'img:https://github.com/favicon.ico'</span>).props(<span class="hljs-string">'dense round'</span>)
        ui.button(icon=<span class="hljs-string">'img:https://facebook.com/favicon.ico'</span>).props(<span class="hljs-string">'dense round'</span>)

<span class="hljs-comment"># 数据表格操作按钮</span>
<span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-full mt-4'</span>):
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center justify-between mb-3'</span>):
        ui.label(<span class="hljs-string">'用户列表'</span>).classes(<span class="hljs-string">'text-lg font-bold'</span>)
        
        <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-1'</span>):
            ui.button(<span class="hljs-string">'新增'</span>, icon=<span class="hljs-string">'add'</span>, color=<span class="hljs-string">'primary'</span>).props(<span class="hljs-string">'dense'</span>)
            ui.button(<span class="hljs-string">'导入'</span>, icon=<span class="hljs-string">'upload'</span>).props(<span class="hljs-string">'dense outline'</span>)
            ui.button(<span class="hljs-string">'导出'</span>, icon=<span class="hljs-string">'download'</span>).props(<span class="hljs-string">'dense outline'</span>)
            ui.button(<span class="hljs-string">'刷新'</span>, icon=<span class="hljs-string">'refresh'</span>).props(<span class="hljs-string">'dense flat'</span>)
    
    <span class="hljs-comment"># 模拟表格</span>
    <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1'</span>):
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
            <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center gap-2 p-2 hover:bg-gray-50'</span>):
                ui.label(<span class="hljs-string">f'用户 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>'</span>)
                ui.space()
                <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-0.5'</span>):
                    ui.button(icon=<span class="hljs-string">'edit'</span>).props(<span class="hljs-string">'dense flat size=sm'</span>)
                    ui.button(icon=<span class="hljs-string">'delete'</span>).props(<span class="hljs-string">'dense flat size=sm color=red'</span>)

ui.run()
</code></pre>
<h3 data-id="heading-28">9. <strong>使用CSS自定义按钮样式</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 超紧凑按钮</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'ultra-compact'</span>):
    ui.button(<span class="hljs-string">'按钮1'</span>)
    ui.button(<span class="hljs-string">'按钮2'</span>)
    ui.button(<span class="hljs-string">'按钮3'</span>)

ui.add_css(<span class="hljs-string">'''
    .ultra-compact {
        gap: 1px !important;
    }
    .ultra-compact button {
        margin: 0 !important;
        padding: 2px 6px !important;
        min-width: 0 !important;
        font-size: 11px !important;
        border-radius: 2px !important;
    }
'''</span>)
</code></pre>
<h3 data-id="heading-29">10. <strong>响应式按钮间距</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 根据屏幕大小调整按钮间距</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'''
    gap-1 
    sm:gap-2 
    md:gap-1
    lg:gap-0.5
'''</span>):
    ui.button(<span class="hljs-string">'首页'</span>, icon=<span class="hljs-string">'home'</span>).props(<span class="hljs-string">'dense'</span>)
    ui.button(<span class="hljs-string">'产品'</span>, icon=<span class="hljs-string">'shopping_bag'</span>).props(<span class="hljs-string">'dense'</span>)
    ui.button(<span class="hljs-string">'服务'</span>, icon=<span class="hljs-string">'handyman'</span>).props(<span class="hljs-string">'dense'</span>)
    ui.button(<span class="hljs-string">'关于'</span>, icon=<span class="hljs-string">'info'</span>).props(<span class="hljs-string">'dense'</span>)
    ui.button(<span class="hljs-string">'联系'</span>, icon=<span class="hljs-string">'contact_mail'</span>).props(<span class="hljs-string">'dense'</span>)
</code></pre>
<h3 data-id="heading-30">主要技巧：</h3>
<ol>
<li><strong>使用 <code>props('dense')</code></strong> - 减小按钮内边距</li>
<li><strong>设置 <code>gap-1</code> 或更小</strong> - 控制按钮间距</li>
<li><strong>图标按钮用 <code>flat</code></strong> - 去掉背景更紧凑</li>
<li><strong>自定义CSS</strong> - 精确控制边距和大小</li>
<li><strong>考虑使用 <code>size=sm</code></strong> - 更小的按钮尺寸</li>
</ol>
<p>根据具体场景选择合适的方法！</p>
<h2 data-id="heading-31">对于 <code>ui.label</code> 的间距调整</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ddf9d2330f24124b9e8be82c04a6957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGllcm9QQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766883732&amp;x-signature=C%2F3CVex2JuXn8NWs7mOcxG6RCR8%3D" alt="image.png" loading="lazy"/></p>
<p>对于 <code>ui.label</code> 的间距调整，这里有一些实用的方法：</p>
<h3 data-id="heading-32">1. <strong>标签与输入框紧凑排列</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基本紧凑布局</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1'</span>):
    ui.label(<span class="hljs-string">'基本信息'</span>).classes(<span class="hljs-string">'text-sm font-medium mb-0.5'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'姓名'</span>).props(<span class="hljs-string">'dense'</span>)
    ui.<span class="hljs-built_in">input</span>(label=<span class="hljs-string">'年龄'</span>).props(<span class="hljs-string">'dense'</span>)
</code></pre>
<h3 data-id="heading-33">2. <strong>表单标签紧凑样式</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 紧凑的表单标签</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'w-64 gap-1'</span>):
    ui.label(<span class="hljs-string">'用户名:'</span>).classes(<span class="hljs-string">'''
        text-sm 
        font-medium 
        mb-0 
        -mt-1
    '''</span>)
    ui.<span class="hljs-built_in">input</span>(placeholder=<span class="hljs-string">'请输入用户名'</span>).props(<span class="hljs-string">'dense'</span>)
    
    ui.label(<span class="hljs-string">'密码:'</span>).classes(<span class="hljs-string">'text-sm font-medium mb-0 mt-1'</span>)
    ui.<span class="hljs-built_in">input</span>(placeholder=<span class="hljs-string">'请输入密码'</span>).props(<span class="hljs-string">'dense type=password'</span>)
</code></pre>
<h3 data-id="heading-34">3. <strong>行内标签紧凑排列</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 水平布局紧凑标签</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center gap-1'</span>):
    ui.label(<span class="hljs-string">'状态:'</span>).classes(<span class="hljs-string">'text-sm'</span>)
    ui.toggle([<span class="hljs-string">'启用'</span>, <span class="hljs-string">'停用'</span>], value=<span class="hljs-string">'启用'</span>).props(<span class="hljs-string">'dense'</span>)
    ui.space()
    ui.label(<span class="hljs-string">'优先级:'</span>).classes(<span class="hljs-string">'text-sm'</span>)
    ui.select([<span class="hljs-string">'高'</span>, <span class="hljs-string">'中'</span>, <span class="hljs-string">'低'</span>], value=<span class="hljs-string">'中'</span>).props(<span class="hljs-string">'dense'</span>)
</code></pre>
<h3 data-id="heading-35">4. <strong>标题标签紧凑样式</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 紧凑的标题区域</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1'</span>):
    ui.label(<span class="hljs-string">'用户设置'</span>).classes(<span class="hljs-string">'''
        text-lg 
        font-bold 
        mb-1
    '''</span>)
    
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center gap-2'</span>):
        ui.label(<span class="hljs-string">'个人资料'</span>).classes(<span class="hljs-string">'text-base font-medium'</span>)
        ui.button(<span class="hljs-string">'编辑'</span>, icon=<span class="hljs-string">'edit'</span>).props(<span class="hljs-string">'dense size=sm'</span>)
    
    ui.separator().classes(<span class="hljs-string">'my-1'</span>)
</code></pre>
<h3 data-id="heading-36">5. <strong>卡片内的紧凑标签</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 紧凑卡片布局</span>
<span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-80 p-3'</span>):
    <span class="hljs-comment"># 卡片标题紧凑</span>
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center justify-between mb-2'</span>):
        ui.label(<span class="hljs-string">'订单信息'</span>).classes(<span class="hljs-string">'text-base font-bold'</span>)
        ui.label(<span class="hljs-string">'ID: 202312345'</span>).classes(<span class="hljs-string">'text-xs text-gray-500'</span>)
    
    <span class="hljs-comment"># 内容区域紧凑</span>
    <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-0.5'</span>):
        ui.label(<span class="hljs-string">'客户: 张三'</span>).classes(<span class="hljs-string">'text-sm'</span>)
        ui.label(<span class="hljs-string">'电话: 13800138000'</span>).classes(<span class="hljs-string">'text-sm'</span>)
        ui.label(<span class="hljs-string">'地址: 北京市朝阳区'</span>).classes(<span class="hljs-string">'text-sm'</span>)
        ui.label(<span class="hljs-string">'金额: ¥1280.00'</span>).classes(<span class="hljs-string">'text-sm font-medium'</span>)
</code></pre>
<h3 data-id="heading-37">6. <strong>表格/列表中的紧凑标签</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 紧凑的数据列表</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-0'</span>):
    <span class="hljs-comment"># 表头</span>
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'bg-gray-100 p-2 gap-2'</span>):
        ui.label(<span class="hljs-string">'姓名'</span>).classes(<span class="hljs-string">'w-24 text-sm font-medium'</span>)
        ui.label(<span class="hljs-string">'部门'</span>).classes(<span class="hljs-string">'w-32 text-sm font-medium'</span>)
        ui.label(<span class="hljs-string">'状态'</span>).classes(<span class="hljs-string">'w-20 text-sm font-medium'</span>)
        ui.label(<span class="hljs-string">'操作'</span>).classes(<span class="hljs-string">'flex-grow text-sm font-medium'</span>)
    
    <span class="hljs-comment"># 数据行</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
        <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center p-2 border-b gap-2 hover:bg-gray-50'</span>):
            ui.label(<span class="hljs-string">f'员工<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>'</span>).classes(<span class="hljs-string">'w-24 text-sm'</span>)
            ui.label(<span class="hljs-string">f'部门<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>'</span>).classes(<span class="hljs-string">'w-32 text-sm'</span>)
            ui.label(<span class="hljs-string">'在职'</span>).classes(<span class="hljs-string">'w-20 text-xs text-green-600'</span>)
            <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'gap-1'</span>):
                ui.button(<span class="hljs-string">'查看'</span>, icon=<span class="hljs-string">'visibility'</span>).props(<span class="hljs-string">'dense flat size=sm'</span>)
                ui.button(<span class="hljs-string">'编辑'</span>, icon=<span class="hljs-string">'edit'</span>).props(<span class="hljs-string">'dense flat size=sm'</span>)
</code></pre>
<h3 data-id="heading-38">7. <strong>标签与图标紧凑组合</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 带图标的紧凑标签</span>
<span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center gap-1'</span>):
    ui.icon(<span class="hljs-string">'info'</span>, color=<span class="hljs-string">'blue'</span>, size=<span class="hljs-string">'sm'</span>)
    ui.label(<span class="hljs-string">'这是一条提示信息'</span>).classes(<span class="hljs-string">'text-sm text-blue-600'</span>)
</code></pre>
<h3 data-id="heading-39">8. <strong>完整示例：紧凑设置面板</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> nicegui <span class="hljs-keyword">import</span> ui

<span class="hljs-comment"># 设置面板</span>
<span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-96'</span>):
    <span class="hljs-comment"># 面板标题</span>
    ui.label(<span class="hljs-string">'系统设置'</span>).classes(<span class="hljs-string">'text-lg font-bold mb-3'</span>)
    
    <span class="hljs-comment"># 设置项分组</span>
    ui.label(<span class="hljs-string">'外观设置'</span>).classes(<span class="hljs-string">'text-base font-medium mb-2 -mt-1'</span>)
    <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1 ml-3'</span>):
        <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center justify-between'</span>):
            ui.label(<span class="hljs-string">'主题模式'</span>).classes(<span class="hljs-string">'text-sm'</span>)
            ui.select([<span class="hljs-string">'自动'</span>, <span class="hljs-string">'浅色'</span>, <span class="hljs-string">'深色'</span>], value=<span class="hljs-string">'自动'</span>).props(<span class="hljs-string">'dense'</span>).classes(<span class="hljs-string">'w-32'</span>)
        
        <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center justify-between'</span>):
            ui.label(<span class="hljs-string">'字体大小'</span>).classes(<span class="hljs-string">'text-sm'</span>)
            ui.slider(<span class="hljs-built_in">min</span>=<span class="hljs-number">12</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">18</span>, value=<span class="hljs-number">14</span>).classes(<span class="hljs-string">'w-32'</span>)
    
    ui.separator().classes(<span class="hljs-string">'my-2'</span>)
    
    ui.label(<span class="hljs-string">'通知设置'</span>).classes(<span class="hljs-string">'text-base font-medium mb-2'</span>)
    <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-1 ml-3'</span>):
        <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center justify-between'</span>):
            ui.label(<span class="hljs-string">'消息通知'</span>).classes(<span class="hljs-string">'text-sm'</span>)
            ui.switch().props(<span class="hljs-string">'dense'</span>)
        
        <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'items-center justify-between'</span>):
            ui.label(<span class="hljs-string">'邮件提醒'</span>).classes(<span class="hljs-string">'text-sm'</span>)
            ui.switch().props(<span class="hljs-string">'dense'</span>)
    
    ui.separator().classes(<span class="hljs-string">'my-2'</span>)
    
    <span class="hljs-comment"># 按钮区域</span>
    <span class="hljs-keyword">with</span> ui.row().classes(<span class="hljs-string">'justify-end gap-1'</span>):
        ui.button(<span class="hljs-string">'取消'</span>, color=<span class="hljs-string">'gray'</span>).props(<span class="hljs-string">'dense'</span>)
        ui.button(<span class="hljs-string">'保存设置'</span>, color=<span class="hljs-string">'primary'</span>).props(<span class="hljs-string">'dense'</span>)

<span class="hljs-comment"># 状态显示面板</span>
<span class="hljs-keyword">with</span> ui.card().classes(<span class="hljs-string">'w-80 mt-4'</span>):
    ui.label(<span class="hljs-string">'系统状态'</span>).classes(<span class="hljs-string">'text-lg font-bold mb-2'</span>)
    
    <span class="hljs-keyword">with</span> ui.grid(columns=<span class="hljs-number">2</span>).classes(<span class="hljs-string">'gap-2'</span>):
        <span class="hljs-comment"># 状态项</span>
        <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-0.5 p-2 bg-blue-50 rounded'</span>):
            ui.label(<span class="hljs-string">'CPU使用率'</span>).classes(<span class="hljs-string">'text-xs text-gray-500'</span>)
            ui.label(<span class="hljs-string">'42%'</span>).classes(<span class="hljs-string">'text-lg font-bold text-blue-600'</span>)
        
        <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-0.5 p-2 bg-green-50 rounded'</span>):
            ui.label(<span class="hljs-string">'内存使用'</span>).classes(<span class="hljs-string">'text-xs text-gray-500'</span>)
            ui.label(<span class="hljs-string">'3.2/8 GB'</span>).classes(<span class="hljs-string">'text-lg font-bold text-green-600'</span>)
        
        <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-0.5 p-2 bg-yellow-50 rounded'</span>):
            ui.label(<span class="hljs-string">'在线用户'</span>).classes(<span class="hljs-string">'text-xs text-gray-500'</span>)
            ui.label(<span class="hljs-string">'128'</span>).classes(<span class="hljs-string">'text-lg font-bold text-yellow-600'</span>)
        
        <span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'gap-0.5 p-2 bg-purple-50 rounded'</span>):
            ui.label(<span class="hljs-string">'请求数'</span>).classes(<span class="hljs-string">'text-xs text-gray-500'</span>)
            ui.label(<span class="hljs-string">'2.4k'</span>).classes(<span class="hljs-string">'text-lg font-bold text-purple-600'</span>)

ui.run()
</code></pre>
<h3 data-id="heading-40">9. <strong>标签的CSS自定义</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 超紧凑标签</span>
ui.label(<span class="hljs-string">'紧凑标签'</span>).classes(<span class="hljs-string">'compact-label'</span>)

<span class="hljs-comment"># 标签组</span>
<span class="hljs-keyword">with</span> ui.column().classes(<span class="hljs-string">'compact-labels gap-0'</span>):
    ui.label(<span class="hljs-string">'项目1'</span>)
    ui.label(<span class="hljs-string">'项目2'</span>)
    ui.label(<span class="hljs-string">'项目3'</span>)

ui.add_css(<span class="hljs-string">'''
    /* 单个标签紧凑 */
    .compact-label {
        margin: 0 !important;
        padding: 2px 4px !important;
        font-size: 12px !important;
        line-height: 1.2 !important;
    }
    
    /* 标签组紧凑 */
    .compact-labels .nicegui-label {
        margin-bottom: 2px !important;
        padding: 1px 0 !important;
        font-size: 13px !important;
    }
    
    /* 表单标签紧凑 */
    .form-label {
        display: block;
        margin-bottom: 3px !important;
        font-size: 13px !important;
        font-weight: 500 !important;
    }
'''</span>)

<span class="hljs-comment"># 使用自定义类</span>
ui.label(<span class="hljs-string">'用户名'</span>).classes(<span class="hljs-string">'form-label'</span>)
ui.<span class="hljs-built_in">input</span>()
</code></pre>
<h3 data-id="heading-41">10. <strong>响应式标签间距</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 根据不同屏幕调整标签间距</span>
ui.label(<span class="hljs-string">'响应式标签'</span>).classes(<span class="hljs-string">'''
    mb-1
    sm:mb-2
    md:mb-1
    lg:mb-0.5
    text-sm
    sm:text-base
    md:text-sm
    lg:text-xs
'''</span>)
</code></pre>
<h3 data-id="heading-42">主要技巧：</h3>
<ol>
<li><strong>使用负边距</strong> - <code>-mt-1</code>、<code>-mb-1</code> 可以减小上下间距</li>
<li><strong>设置 <code>mb-0</code> 或 <code>mt-0</code></strong> - 清除默认边距</li>
<li><strong>配合 <code>gap-0.5</code> 或 <code>gap-1</code></strong> - 容器级别控制</li>
<li><strong>使用小字号</strong> - <code>text-sm</code>、<code>text-xs</code> 让标签更紧凑</li>
<li><strong>行内布局</strong> - 与 <code>ui.row()</code> 配合实现水平紧凑排列</li>
</ol>
<p>选择适合你布局需求的方法！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数组 forEach]]></title>    <link>https://juejin.cn/post/7585485074038521862</link>    <guid>https://juejin.cn/post/7585485074038521862</guid>    <pubDate>2025-12-21T02:27:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485074038521862" data-draft-id="7585474459777318948" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数组 forEach "/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-21T02:27:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="写代码的皮筏艇"/> <meta itemprop="url" content="https://juejin.cn/user/4196178024218520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数组 forEach 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4196178024218520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    写代码的皮筏艇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T02:27:12.000Z" title="Sun Dec 21 2025 02:27:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>1. 基本原理和实现</strong></h2>
<h3 data-id="heading-1"><strong>原生实现原理</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟实现 forEach</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myForEach</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback, thisArg</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'this is null or not defined'</span>);
  }
  
  <span class="hljs-comment">// 转换为对象</span>
  <span class="hljs-keyword">const</span> O = <span class="hljs-title class_">Object</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-comment">// 转换为数字（length）</span>
  <span class="hljs-keyword">const</span> len = O.<span class="hljs-property">length</span> &gt;&gt;&gt; <span class="hljs-number">0</span>;  <span class="hljs-comment">// 无符号右移确保是正整数</span>
  
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(callback + <span class="hljs-string">' is not a function'</span>);
  }
  
  <span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (k &lt; len) {
    <span class="hljs-comment">// 检查索引是否存在（处理稀疏数组）</span>
    <span class="hljs-keyword">if</span> (k <span class="hljs-keyword">in</span> O) {
      <span class="hljs-comment">// 执行回调，传递三个参数</span>
      callback.<span class="hljs-title function_">call</span>(thisArg, O[k], k, O);
    }
    k++;
  }
};

<span class="hljs-comment">// 使用示例</span>
[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">myForEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item, index);
});
</code></pre>
<h2 data-id="heading-2"><strong>2. 详细参数解析</strong></h2>
<pre><code class="hljs language-c" lang="c">arr.forEach(callback(currentValue, index, <span class="hljs-built_in">array</span>), thisArg)
</code></pre>
<h3 data-id="heading-3"><strong>参数详解：</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> }
];

<span class="hljs-comment">// 1. 完整参数使用</span>
users.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">user, index, array</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`用户<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>:`</span>, user.<span class="hljs-property">name</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'总人数:'</span>, array.<span class="hljs-property">length</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'this:'</span>, <span class="hljs-variable language_">this</span>);  <span class="hljs-comment">// thisArg 参数</span>
}, { <span class="hljs-attr">prefix</span>: <span class="hljs-string">'用户信息：'</span> });

<span class="hljs-comment">// 2. 箭头函数 vs 普通函数</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">data</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],
  <span class="hljs-attr">multiplier</span>: <span class="hljs-number">2</span>,
  
  <span class="hljs-title function_">processData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 箭头函数 - 继承外层 this</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item * <span class="hljs-variable language_">this</span>.<span class="hljs-property">multiplier</span>);  <span class="hljs-comment">// ✅ 正确访问 this.multiplier</span>
    });
    
    <span class="hljs-comment">// 普通函数 - 需要 bind 或 thisArg</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item * <span class="hljs-variable language_">this</span>.<span class="hljs-property">multiplier</span>);  <span class="hljs-comment">// ❌ this 指向 undefined 或全局</span>
    }, <span class="hljs-variable language_">this</span>);  <span class="hljs-comment">// ✅ 传递 thisArg</span>
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item * <span class="hljs-variable language_">this</span>.<span class="hljs-property">multiplier</span>);  
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));  <span class="hljs-comment">// ✅ 使用 bind</span>
  }
};
</code></pre>
<h2 data-id="heading-4"><strong>3. 核心特点详解</strong></h2>
<h3 data-id="heading-5"><strong>特点 1：遍历顺序固定</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>];

<span class="hljs-comment">// 总是按索引顺序执行</span>
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index, item);  <span class="hljs-comment">// 0 'a', 1 'b', 2 'c'</span>
});

<span class="hljs-comment">// 即使有异步操作，顺序也不会改变</span>
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">async</span> (item, index) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>));
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index, item);  <span class="hljs-comment">// 顺序依然是 0,1,2</span>
});
</code></pre>
<h3 data-id="heading-6"><strong>特点 2：跳过空位（稀疏数组）</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建稀疏数组</span>
<span class="hljs-keyword">const</span> sparseArray = [<span class="hljs-number">1</span>, , <span class="hljs-number">3</span>];  <span class="hljs-comment">// 第二个元素是 empty</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sparseArray.<span class="hljs-property">length</span>);  <span class="hljs-comment">// 3</span>

sparseArray.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index, item);
  <span class="hljs-comment">// 输出:</span>
  <span class="hljs-comment">// 0 1</span>
  <span class="hljs-comment">// 2 3</span>
  <span class="hljs-comment">// 注意：索引 1 被跳过了</span>
});

<span class="hljs-comment">// 与 for 循环对比</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; sparseArray.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i, sparseArray[i]);
  <span class="hljs-comment">// 输出:</span>
  <span class="hljs-comment">// 0 1</span>
  <span class="hljs-comment">// 1 undefined  ← 这里不同！</span>
  <span class="hljs-comment">// 2 3</span>
}
</code></pre>
<h3 data-id="heading-7"><strong>特点 3：在第一次调用前确定长度</strong></h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>

arr.forEach((item, index, array) =&gt; {
  console.log(`处理 ${item}`)<span class="hljs-comment">;</span>
  
  // 修改数组不会影响遍历次数
  if (<span class="hljs-attr">index</span> === <span class="hljs-number">0</span>) {
    array.push(6)<span class="hljs-comment">;   // 不会被处理</span>
    array.pop()<span class="hljs-comment">;     // 不会减少处理次数</span>
    <span class="hljs-attr">array.length</span> = <span class="hljs-number">3</span><span class="hljs-comment">; // 仍然会处理所有原始元素</span>
  }
})<span class="hljs-comment">;</span>

// 输出: 处理 1, 处理 2, 处理 3, 处理 4, 处理 5
</code></pre>
<h2 data-id="heading-8"><strong>4. 重要注意事项</strong></h2>
<h3 data-id="heading-9"><strong>⚠️ 注意点 1：无法中断</strong></h3>
<pre><code class="hljs language-ini" lang="ini">// ❌ 这些都无法中断 forEach
<span class="hljs-section">[1, 2, 3, 4, 5]</span>.forEach(<span class="hljs-attr">item</span> =&gt; {
  console.log(item)<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">item</span> === <span class="hljs-number">3</span>) {
    break<span class="hljs-comment">;      // ❌ SyntaxError</span>
    continue<span class="hljs-comment">;   // ❌ SyntaxError</span>
    return<span class="hljs-comment">;     // ❌ 只退出当前回调，继续下一个</span>
  }
})<span class="hljs-comment">;</span>

// ✅ 替代方案
// 方案1: for...of
for (const item of <span class="hljs-section">[1, 2, 3, 4, 5]</span>) {
  if (<span class="hljs-attr">item</span> === <span class="hljs-number">3</span>) break<span class="hljs-comment">;</span>
  console.log(item)<span class="hljs-comment">;</span>
}

// 方案2: some() 或 every()
<span class="hljs-section">[1, 2, 3, 4, 5]</span>.some(<span class="hljs-attr">item</span> =&gt; {
  console.log(item)<span class="hljs-comment">;</span>
  return <span class="hljs-attr">item</span> === <span class="hljs-number">3</span><span class="hljs-comment">;  // 返回 true 停止遍历</span>
})<span class="hljs-comment">;</span>

<span class="hljs-section">[1, 2, 3, 4, 5]</span>.every(<span class="hljs-attr">item</span> =&gt; {
  console.log(item)<span class="hljs-comment">;</span>
  return item !== 3<span class="hljs-comment">;  // 返回 false 停止遍历</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-10"><strong>⚠️ 注意点 2：异步处理问题</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 异步操作不会按预期等待</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processArray</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始'</span>);
  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">async</span> (item) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'结束'</span>);  <span class="hljs-comment">// 立即执行</span>
}
<span class="hljs-comment">// 输出: 开始 → 结束 → (100ms后) 1 2 3</span>

<span class="hljs-comment">// ✅ 替代方案</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processArrayCorrectly</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始'</span>);
  
  <span class="hljs-comment">// 方案1: for...of 配合 await</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
  }
  
  <span class="hljs-comment">// 方案2: 使用 Promise.all（并行）</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(arr.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> (item) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
  }));
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'结束'</span>);
}
</code></pre>
<h3 data-id="heading-11"><strong>⚠️ 注意点 3：修改原数组的风险</strong></h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>

// ❌ 危险：在遍历时添加/删除元素
arr.forEach((item, index, array) =&gt; {
  console.log(item)<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">item</span> === <span class="hljs-number">2</span>) {
    array.push(100)<span class="hljs-comment">;  // 可能导致意外行为</span>
    array.splice(index, 1)<span class="hljs-comment">;  // 改变索引，可能跳过元素</span>
  }
})<span class="hljs-comment">;</span>

// ✅ 安全做法：先复制或使用其他方法
const <span class="hljs-attr">arrCopy</span> = [...arr]<span class="hljs-comment">;</span>
arrCopy.forEach(<span class="hljs-attr">item</span> =&gt; {
  // 安全的处理
})<span class="hljs-comment">;</span>

// 或者处理完后统一修改
const <span class="hljs-attr">result</span> = []<span class="hljs-comment">;</span>
arr.forEach(<span class="hljs-attr">item</span> =&gt; {
  result.push(item * 2)<span class="hljs-comment">;  // 不修改原数组</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-12"><strong>⚠️ 注意点 4：性能考虑</strong></h3>
<pre><code class="hljs language-ini" lang="ini">// forEach 与 for 循环的性能对比
const <span class="hljs-attr">largeArray</span> = new Array(<span class="hljs-number">1000000</span>).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>

console.time('forEach')<span class="hljs-comment">;</span>
let <span class="hljs-attr">sum1</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
largeArray.forEach(<span class="hljs-attr">num</span> =&gt; {
  sum1 += num<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
console.timeEnd('forEach')<span class="hljs-comment">;</span>

console.time('for loop')<span class="hljs-comment">;</span>
let <span class="hljs-attr">sum2</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; largeArray.length; i++) {</span>
  sum2 += largeArray<span class="hljs-section">[i]</span><span class="hljs-comment">;</span>
}
console.timeEnd('for loop')<span class="hljs-comment">;</span>

// 结果：for 循环通常更快（但现代JS引擎优化很好）
</code></pre>
<h2 data-id="heading-13"><strong>5. 实际应用场景</strong></h2>
<h3 data-id="heading-14"><strong>场景 1：DOM 操作</strong></h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 批量操作 DOM 元素</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.items'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">element, index</span>) =&gt;</span> {
  element.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'processed'</span>);
  element.<span class="hljs-property">dataset</span>.<span class="hljs-property">index</span> = index;
  element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleClick);
});
</code></pre>
<h3 data-id="heading-15"><strong>场景 2：副作用操作</strong></h3>
<pre><code class="hljs language-ini" lang="ini">// 纯副作用，不需要返回值
const <span class="hljs-attr">logs</span> = []<span class="hljs-comment">;</span>
const <span class="hljs-attr">data</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>

// 记录日志
data.forEach(<span class="hljs-attr">item</span> =&gt; {
  logs.push(`Processing item ${item}`)<span class="hljs-comment">;</span>
  console.log(`Processing: ${item}`)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// 更新外部状态
const <span class="hljs-attr">cache</span> = new Map()<span class="hljs-comment">;</span>
const <span class="hljs-attr">objects</span> = [{id: <span class="hljs-number">1</span>}, {id: <span class="hljs-number">2</span>}]<span class="hljs-comment">;</span>
objects.forEach(<span class="hljs-attr">obj</span> =&gt; {
  cache.set(obj.id, obj)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-16"><strong>场景 3：链式操作的第一步</strong></h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">result</span> = [
  {name: <span class="hljs-string">'Alice'</span>, age: <span class="hljs-number">25</span>},
  {name: <span class="hljs-string">'Bob'</span>, age: <span class="hljs-number">30</span>},
  {name: <span class="hljs-string">'Charlie'</span>, age: <span class="hljs-number">25</span>}
]<span class="hljs-comment">;</span>

// forEach 作为预处理
const <span class="hljs-attr">ageGroups</span> = {}<span class="hljs-comment">;</span>
result.forEach(<span class="hljs-attr">person</span> =&gt; {
  const <span class="hljs-attr">age</span> = person.age<span class="hljs-comment">;</span>
  if (!ageGroups<span class="hljs-section">[age]</span>) {
    ageGroups<span class="hljs-section">[age]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>

// 然后进行其他操作
Object.keys(ageGroups).forEach(<span class="hljs-attr">age</span> =&gt; {
  ageGroups<span class="hljs-section">[age]</span> = result.filter(<span class="hljs-attr">p</span> =&gt; p.age === parseInt(age))<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-17"><strong>6. 最佳实践</strong></h2>
<h3 data-id="heading-18"><strong>实践 1：明确使用意图</strong></h3>
<pre><code class="hljs language-ini" lang="ini">// ✅ 好的使用
// 1. 执行副作用
elements.forEach(<span class="hljs-attr">el</span> =&gt; el.classList.add(<span class="hljs-string">'active'</span>))<span class="hljs-comment">;</span>

// 2. 更新外部状态
data.forEach(<span class="hljs-attr">item</span> =&gt; updateCache(item))<span class="hljs-comment">;</span>

// 3. 简单的数据处理
items.forEach(<span class="hljs-attr">item</span> =&gt; console.log(item))<span class="hljs-comment">;</span>

// ❌ 不好的使用
// 1. 需要返回值时（应用 map）
const <span class="hljs-attr">doubled</span> = []<span class="hljs-comment">;</span>
arr.forEach(<span class="hljs-attr">x</span> =&gt; doubled.push(x * <span class="hljs-number">2</span>))<span class="hljs-comment">;  // ❌ 用 map 更好</span>

// 2. 需要过滤时（应用 filter）
const <span class="hljs-attr">filtered</span> = []<span class="hljs-comment">;</span>
arr.forEach(<span class="hljs-attr">x</span> =&gt; {
  if (x &gt; 5) filtered.push(x)<span class="hljs-comment">;  // ❌ 用 filter 更好</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-19"><strong>实践 2：错误处理</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误会中断整个遍历</span>
<span class="hljs-keyword">try</span> {
  [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Oops'</span>);
  });
} <span class="hljs-keyword">catch</span> (e) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到错误'</span>);  <span class="hljs-comment">// 整个遍历停止</span>
}

<span class="hljs-comment">// ✅ 在回调内部处理错误</span>
[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 可能出错的操作</span>
    <span class="hljs-title function_">riskyOperation</span>(item);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`处理 <span class="hljs-subst">${item}</span> 时出错:`</span>, error);
    <span class="hljs-comment">// 继续处理下一个</span>
  }
});
</code></pre>
<h3 data-id="heading-20"><strong>实践 3：性能优化</strong></h3>
<pre><code class="hljs language-ini" lang="ini">// 提前缓存长度（虽然 forEach 内部会做，但某些情况有用）
const <span class="hljs-attr">items</span> = document.querySelectorAll(<span class="hljs-string">'.item'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">itemsArray</span> = Array.from(items)<span class="hljs-comment">;</span>

// 批量操作减少重绘
const <span class="hljs-attr">fragment</span> = document.createDocumentFragment()<span class="hljs-comment">;</span>
itemsArray.forEach(<span class="hljs-attr">item</span> =&gt; {
  const <span class="hljs-attr">clone</span> = item.cloneNode(<span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>
  // 修改 clone...
  fragment.appendChild(clone)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
document.body.appendChild(fragment)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-21"><strong>总结</strong></h2>
<h3 data-id="heading-22"><strong>✅ 使用 forEach 当：</strong></h3>
<ol>
<li>只需要副作用，不关心返回值</li>
<li>操作顺序不重要，也不需要中断</li>
<li>代码可读性比极致性能更重要</li>
<li>处理 DOM 操作或 I/O 副作用</li>
</ol>
<h3 data-id="heading-23"><strong>❌ 避免 forEach 当：</strong></h3>
<ol>
<li>需要提前终止循环（用 <code>for...of</code> 或 <code>some/every</code>）</li>
<li>处理异步操作（用 <code>for...of</code> 或 <code>Promise.all</code> + <code>map</code>）</li>
<li>需要转换数组（用 <code>map</code>）</li>
<li>需要过滤数组（用 <code>filter</code>）</li>
<li>需要计算结果（用 <code>reduce</code>）</li>
<li>性能关键路径（考虑 <code>for</code> 循环）</li>
<li>需要链式调用（结合具体业务）</li>
</ol>
<h5 data-id="heading-24"><strong>forEach 没有返回值，不修改原数组。当使用时可以给其他数组做中间方法</strong></h5></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【开源项目技术分享】@host-navs 站导，一个简洁高效的网站链接导航工具站]]></title>    <link>https://juejin.cn/post/7585600621521649704</link>    <guid>https://juejin.cn/post/7585600621521649704</guid>    <pubDate>2025-12-21T04:42:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585600621521649704" data-draft-id="7585574047074844672" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【开源项目技术分享】@host-navs  站导，一个简洁高效的网站链接导航工具站"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-21T04:42:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="discode"/> <meta itemprop="url" content="https://juejin.cn/user/888061126511726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【开源项目技术分享】@host-navs  站导，一个简洁高效的网站链接导航工具站
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888061126511726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    discode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T04:42:10.000Z" title="Sun Dec 21 2025 04:42:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">项目背景与设计理念</h2>
<p>在日常开发工作中，我们经常需要访问各种网络资源，但浏览器自带书签管理以及一些主流的在线导航工具站存在如数据共享限制、数据安全管控等不便之处，尤其是在公司内网或企业级局域网等类似环境中。基于此，我通过 AI 赋能，设计并实现了 <strong>host-navs 站导</strong>, 一个以 <strong>配置即数据</strong> 为核心设计理念的纯前端且简洁高效的网站链接导航工具站。</p>
<p>核心设计思想：</p>
<ul>
<li>使用 YAML 配置文件管理所有导航数据，实现数据与逻辑分离</li>
<li>采用模块化设计，确保代码可维护性和扩展性</li>
<li>优先考虑性能和用户体验，实现流畅的交互效果</li>
<li>支持多端适配，提供一致的跨设备体验</li>
<li>代码基于 MIT 开源协议共享且轻量易用</li>
</ul>
<h2 data-id="heading-1">技术栈与架构设计</h2>
<h3 data-id="heading-2">技术选型</h3>
<ul>
<li><strong>HTML5</strong> - 语义化页面结构</li>
<li><strong>JavaScript (ES6+)</strong> - 核心交互逻辑</li>
<li><strong>Tailwind CSS</strong> - 原子化 CSS 框架，实现高效样式开发</li>
<li><strong>js-yaml</strong> - YAML 解析库，处理配置文件</li>
</ul>
<h3 data-id="heading-3">页面框架</h3>
<pre><code class="hljs language-text" lang="text">╭─────────────╮
│  HOST NAVS  │  ←  天青色 + 泥陶色 LOGO
╰─────────────╯

┌─────────────────────────────────────────────────────────┐
│  LOGO                                     站点名称       │
│                                           站点描述       │
├─────────────────────────────────────────────────────────┤
│  🔍 搜索链接...                      [📱卡片] [📋列表]     │
├─────────────────────────────────────────────────────────┤
│  [特别鸣谢 n] [学习资源 n] [助手工具 n] [谁在使用 n]          │
├─────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                    │
│  │ Github  │ │ VS Code │ │  Claude │                    │
│  │  GIT    │ │  Code   │ │    AI   │   ← 支持滚动        │
│  └─────────┘ └─────────┘ └─────────┘                    │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-4">页面预览</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54e7d641c2d94af3ad1015e2f5606f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGlzY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766899262&amp;x-signature=uqeatCLr3cA3ZDAPskFvCPq3RnA%3D" alt="host-navs.png" loading="lazy"/></p>
<blockquote>
<p>项目实际页面截图（位于 <code>assets/host-navs.png</code>）</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29cc7204d58b4a54b9db4830ca0d9910~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGlzY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766899262&amp;x-signature=wi7GHDhPkjFNDLgFOVseuqf55vg%3D" alt="host-navs-138.png" loading="lazy"/></p>
<blockquote>
<p>项目实际页面截图（位于 <code>assets/host-navs-138.png</code>）</p>
</blockquote>
<h2 data-id="heading-5">部分核心功能技术实现说明</h2>
<h3 data-id="heading-6">1. YAML 配置驱动机制</h3>
<p><strong>实现思路</strong>：将所有导航数据存储在 <code>host.conf</code> 文件中，通过 <code>js-yaml</code> 库解析为 JavaScript 对象，再进行配置验证和规范化处理，将数据动态渲染到页面上。</p>
<p><strong>host.conf</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 主站配置</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">站导</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">一个简洁高效的网站链接导航工具站</span>

<span class="hljs-comment"># 配置数据调试输出(浏览器控制台)</span>
<span class="hljs-attr">console_output:</span> <span class="hljs-literal">false</span>

<span class="hljs-comment"># 图标配置</span>
<span class="hljs-attr">use_text_icon:</span> <span class="hljs-literal">false</span>       <span class="hljs-comment"># true: 只使用文字图标</span>
<span class="hljs-attr">use_google_favicon:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># true: 使用 Google Favicon API</span>

<span class="hljs-comment"># 固定快捷导航</span>
<span class="hljs-attr">fixed_navs:</span>
  <span class="hljs-attr">fixed:</span>
    <span class="hljs-attr">top:</span> <span class="hljs-number">50</span><span class="hljs-string">%</span>
    <span class="hljs-attr">right:</span> <span class="hljs-string">16px</span>
  <span class="hljs-attr">items:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GitHub</span>
      <span class="hljs-attr">short_name:</span> <span class="hljs-string">GIT</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">代码托管平台</span>
      <span class="hljs-attr">nav_to:</span> <span class="hljs-string">https://github.com</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Gitee</span>
      <span class="hljs-attr">short_name:</span> <span class="hljs-string">GIT</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">国内代码托管平台</span>
      <span class="hljs-attr">nav_to:</span> <span class="hljs-string">https://gitee.com</span>

<span class="hljs-comment"># 导航分组</span>
<span class="hljs-attr">navs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">常用工具</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">日常工作中常用的工具网站</span>
    <span class="hljs-attr">items:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GitHub</span>
        <span class="hljs-attr">short_name:</span> <span class="hljs-string">GIT</span> <span class="hljs-comment"># 可选，文字图标简称（最多4字符）</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">GitHub代码托管平台</span>
        <span class="hljs-attr">nav_to:</span> <span class="hljs-string">https://github.com</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">VS</span> <span class="hljs-string">Code</span>
        <span class="hljs-attr">short_name:</span> <span class="hljs-string">CODE</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">VS</span> <span class="hljs-string">Code开源代码编辑器</span>
        <span class="hljs-attr">nav_to:</span> <span class="hljs-string">https://code.visualstudio.com/</span>
</code></pre>
<p><strong>配置项说明</strong>：</p>



































































































































<table><thead><tr><th>配置项</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>name</code></td><td>string</td><td>✅</td><td>站点名称</td></tr><tr><td><code>description</code></td><td>string</td><td>❌</td><td>站点描述</td></tr><tr><td><code>console_output</code></td><td>boolean</td><td>❌</td><td>配置数据调试输出(浏览器控制台)</td></tr><tr><td><code>use_text_icon</code></td><td>boolean</td><td>❌</td><td>是否只使用文字图标</td></tr><tr><td><code>use_google_favicon</code></td><td>boolean</td><td>❌</td><td>是否使用 Google Favicon API</td></tr><tr><td><code>navs</code></td><td>array</td><td>✅</td><td>导航分组集合</td></tr><tr><td><code>navs[].name</code></td><td>string</td><td>✅</td><td>分组名称</td></tr><tr><td><code>navs[].description</code></td><td>string</td><td>❌</td><td>分组描述</td></tr><tr><td><code>navs[].items</code></td><td>array</td><td>✅</td><td>链接集合</td></tr><tr><td><code>navs[].items[].name</code></td><td>string</td><td>✅</td><td>链接名称</td></tr><tr><td><code>navs[].items[].short_name</code></td><td>string</td><td>❌</td><td>链接简称（用于文字图标）</td></tr><tr><td><code>navs[].items[].description</code></td><td>string</td><td>❌</td><td>链接描述</td></tr><tr><td><code>navs[].items[].nav_to</code></td><td>string</td><td>✅</td><td>链接地址</td></tr><tr><td><code>fixed_navs</code></td><td>object</td><td>❌</td><td>右侧固定快捷导航配置（可选）</td></tr><tr><td><code>fixed_navs.fixed</code></td><td>object</td><td>❌</td><td>位置设置，允许 top/right/bottom/left（值为数字(px)或字符串，例如 '50%'）</td></tr><tr><td><code>fixed_navs.fixed.top</code></td><td>string\number</td><td>❌</td><td>顶部位置，数字视为 px，例如 20 或 '10px' 或 '50%'</td></tr><tr><td><code>fixed_navs.fixed.right</code></td><td>string\number</td><td>❌</td><td>右侧位置</td></tr><tr><td><code>fixed_navs.fixed.bottom</code></td><td>string\number</td><td>❌</td><td>下方位置</td></tr><tr><td><code>fixed_navs.fixed.left</code></td><td>string\number</td><td>❌</td><td>左侧位置</td></tr><tr><td><code>fixed_navs.items</code></td><td>array</td><td>❌</td><td>固定图标项，子字段同 <code>navs[].items[]</code>（name/short_name/description/nav_to）</td></tr></tbody></table>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 异步加载并解析 YAML 配置</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadConfig</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"host.conf"</span>);
  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${response.status}</span>: <span class="hljs-subst">${response.statusText}</span>`</span>);
  }
  <span class="hljs-keyword">const</span> yamlText = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">text</span>();

  <span class="hljs-comment">// 使用 js-yaml 库解析 YAML</span>
  <span class="hljs-keyword">const</span> config = jsyaml.<span class="hljs-title function_">load</span>(yamlText);

  <span class="hljs-comment">// 验证配置结构</span>
  <span class="hljs-keyword">if</span> (!config || <span class="hljs-keyword">typeof</span> config !== <span class="hljs-string">"object"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"配置文件格式错误：不是有效的YAML对象"</span>);
  }
  <span class="hljs-keyword">if</span> (!config.<span class="hljs-property">name</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"配置文件缺少必要字段：name"</span>);
  }
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(config.<span class="hljs-property">navs</span>)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"配置文件缺少必要字段：navs (应为数组)"</span>);
  }

  <span class="hljs-comment">// 规范化配置</span>
  <span class="hljs-keyword">const</span> normalizedConfig = {
    <span class="hljs-attr">name</span>: config.<span class="hljs-property">name</span>,
    <span class="hljs-attr">description</span>: config.<span class="hljs-property">description</span> || <span class="hljs-string">""</span>,
    <span class="hljs-attr">console_output</span>: config.<span class="hljs-property">console_output</span> === <span class="hljs-literal">true</span>,
    <span class="hljs-attr">use_text_icon</span>: config.<span class="hljs-property">use_text_icon</span> === <span class="hljs-literal">true</span>,
    <span class="hljs-attr">use_google_favicon</span>: config.<span class="hljs-property">use_google_favicon</span> === <span class="hljs-literal">true</span>,
    <span class="hljs-attr">navs</span>: config.<span class="hljs-property">navs</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">nav, index</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!nav.<span class="hljs-property">name</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`第 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span> 个分组缺少 name 字段`</span>);
      }
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">name</span>: nav.<span class="hljs-property">name</span>,
        <span class="hljs-attr">description</span>: nav.<span class="hljs-property">description</span> || <span class="hljs-string">""</span>,
        <span class="hljs-attr">items</span>: <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(nav.<span class="hljs-property">items</span>)
          ? nav.<span class="hljs-property">items</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> ({
              <span class="hljs-attr">name</span>: item.<span class="hljs-property">name</span> || <span class="hljs-string">"未命名链接"</span>,
              <span class="hljs-attr">short_name</span>: item.<span class="hljs-property">short_name</span> || <span class="hljs-string">""</span>,
              <span class="hljs-attr">description</span>: item.<span class="hljs-property">description</span> || <span class="hljs-string">""</span>,
              <span class="hljs-attr">nav_to</span>: item.<span class="hljs-property">nav_to</span> || <span class="hljs-string">"#"</span>,
            }))
          : [],
      };
    }),
    <span class="hljs-comment">// 固定导航配置处理...</span>
  };

  <span class="hljs-keyword">return</span> normalizedConfig;
}
</code></pre>
<p><strong>设计优势</strong>：</p>
<ul>
<li>数据与逻辑完全分离，便于维护和扩展</li>
<li>严格的配置验证，确保数据完整性</li>
<li>自动规范化处理，提高代码健壮性</li>
<li>支持动态更新配置，无需重新部署</li>
</ul>
<h3 data-id="heading-7">2. 网站图标获取策略机制</h3>
<p><strong>实现思路</strong>：设计了多级图标获取策略，通过 host.conf 策略配置实现站点图标的加载，包括原生 favicon 尝试、Google Favicon 服务和文字图标降级，确保每个链接都能显示合适的图标。</p>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取网站原生 favicon 地址（多种可能路径）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getNativeFaviconUrls</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> urlObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url);
    <span class="hljs-keyword">const</span> origin = urlObj.<span class="hljs-property">origin</span>;
    <span class="hljs-comment">// 可根据预览情况添加更多规则，如本站的 /svgs/favicon.svg 等路径</span>
    <span class="hljs-keyword">return</span> [
      <span class="hljs-string">`<span class="hljs-subst">${origin}</span>/favicon.ico`</span>,
      <span class="hljs-string">`<span class="hljs-subst">${origin}</span>/favicon.png`</span>,
      <span class="hljs-string">`<span class="hljs-subst">${origin}</span>/favicon.svg`</span>,
      <span class="hljs-string">`<span class="hljs-subst">${origin}</span>/apple-touch-icon.png`</span>,
      <span class="hljs-string">`<span class="hljs-subst">${origin}</span>/assets/favicon.ico`</span>,
      <span class="hljs-string">`<span class="hljs-subst">${origin}</span>/static/favicon.ico`</span>,
      <span class="hljs-string">`<span class="hljs-subst">${origin}</span>/images/favicon.ico`</span>,
    ];
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> [];
  }
}

<span class="hljs-comment">// 获取 Google favicon 服务地址</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getGoogleFaviconUrl</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> urlObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url);
    <span class="hljs-keyword">return</span> <span class="hljs-string">`https://www.google.com/s2/favicons?domain=<span class="hljs-subst">${urlObj.hostname}</span>&amp;sz=64`</span>;
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-comment">// 生成文字缩写（支持中英文）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getTextAbbr</span>(<span class="hljs-params">item</span>) {
  <span class="hljs-keyword">const</span> name = item.<span class="hljs-property">name</span>;
  <span class="hljs-keyword">const</span> shortName = item.<span class="hljs-property">short_name</span>;
  <span class="hljs-comment">// 优先使用配置的简称</span>
  <span class="hljs-keyword">if</span> (shortName &amp;&amp; shortName.<span class="hljs-title function_">trim</span>()) {
    <span class="hljs-keyword">return</span> shortName.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>);
  }

  <span class="hljs-comment">// 中文：取前两个字</span>
  <span class="hljs-keyword">const</span> chineseMatch = name.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/[\u4e00-\u9fa5]/g</span>);
  <span class="hljs-keyword">if</span> (chineseMatch &amp;&amp; chineseMatch.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> chineseMatch.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
  }
  <span class="hljs-keyword">if</span> (chineseMatch &amp;&amp; chineseMatch.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> chineseMatch[<span class="hljs-number">0</span>];
  }

  <span class="hljs-comment">// 英文：取单词首字母（最多2个）或前两个字符</span>
  <span class="hljs-keyword">const</span> words = name.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/[\s\-_\/]+/</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">w</span>) =&gt;</span> w.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span> (words.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> words
      .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">w</span>) =&gt;</span> w[<span class="hljs-number">0</span>].<span class="hljs-title function_">toUpperCase</span>())
      .<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (words.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> name.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>).<span class="hljs-title function_">toUpperCase</span>();
  }

  <span class="hljs-keyword">return</span> name.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>).<span class="hljs-title function_">toUpperCase</span>();
}
</code></pre>
<p><strong>图标获取策略</strong>：</p>
<pre><code class="hljs language-text" lang="text">┌─────────────────────────────────────────────────┐
│              图标配置优先级                       │
├─────────────────────────────────────────────────┤
│                                                 │
│  use_text_icon: true                            │
│       ↓                                         │
│  ┌─────────────────────────────────┐            │
│  │  直接显示文字缩写（推荐局域网使用）   │            │
│  │  short_name &gt; 中文前2字 &gt; 英文缩写 │            │
│  └─────────────────────────────────┘            │
│                                                 │
│  use_text_icon: false                           │
│  use_google_favicon: true                       │
│       ↓                                         │
│  ┌─────────────────────────────────┐            │
│  │  使用 Google Favicon API         │            │
│  │  失败后显示文字缩写                │            │
│  └─────────────────────────────────┘            │
│                                                 │
│  use_text_icon: false                           │
│  use_google_favicon: false                      │
│       ↓                                         │
│  ┌─────────────────────────────────┐            │
│  │  尝试网站原生 favicon             │            │
│  │  /favicon.ico                   │            │
│  │  /favicon.png                   │            │
│  │  /apple-touch-icon.png          │            │
│  │  全部失败后显示文字缩写             │            │
│  └─────────────────────────────────┘            │
│                                                 │
└─────────────────────────────────────────────────┘
</code></pre>
<p><strong>技术亮点</strong>：</p>
<ul>
<li>配置优先，多路径原生 favicon 尝试，提高成功率</li>
<li>支持 Google Favicon 服务作为备选</li>
<li>智能文字图标生成，支持中英文混合场景</li>
<li>图标加载失败自动降级机制</li>
<li>使用 <code>loading="lazy"</code> 实现图标懒加载</li>
</ul>
<h3 data-id="heading-8">3. 实时搜索功能实现</h3>
<p><strong>实现思路</strong>：采用前端实时搜索，通过正则表达式匹配链接的名称、描述和 URL，高亮关键词，实现即时响应的搜索体验。</p>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 搜索处理函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSearch</span>(<span class="hljs-params">e</span>) {
  searchKeyword = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
  <span class="hljs-keyword">const</span> clearBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"clear-search"</span>);
  clearBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"hidden"</span>, !searchKeyword);
  <span class="hljs-title function_">renderLinks</span>();
}

<span class="hljs-comment">// 清除搜索</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">clearSearch</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"search-input"</span>);
  input.<span class="hljs-property">value</span> = <span class="hljs-string">""</span>;
  searchKeyword = <span class="hljs-string">""</span>;
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"clear-search"</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">"hidden"</span>);
  <span class="hljs-title function_">renderLinks</span>();
  input.<span class="hljs-title function_">focus</span>();
}

<span class="hljs-comment">// 高亮关键词</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">highlightKeyword</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-keyword">if</span> (!searchKeyword || !text) <span class="hljs-keyword">return</span> text;
  <span class="hljs-keyword">const</span> escaped = searchKeyword.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[.*+?^${}()|[\]\\]/g</span>, <span class="hljs-string">"\\$&amp;"</span>);
  <span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`(<span class="hljs-subst">${escaped}</span>)`</span>, <span class="hljs-string">"gi"</span>);
  <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">replace</span>(
    regex,
    <span class="hljs-string">'&lt;mark class="bg-yellow-200 text-yellow-900 rounded px-0.5"&gt;$1&lt;/mark&gt;'</span>
  );
}
</code></pre>
<h2 data-id="heading-9">性能优化策略</h2>
<ol>
<li>
<p><strong>图标懒加载</strong>：</p>
<ul>
<li>使用 <code>loading="lazy"</code> 属性实现图标延迟加载</li>
<li>优化图标请求顺序，优先加载可见区域图标</li>
<li>支持文字图标降级，避免图标加载失败影响用户体验</li>
</ul>
</li>
<li>
<p><strong>DOM 操作优化</strong>：</p>
<ul>
<li>批量 DOM 更新，通过 <code>innerHTML</code> 一次性生成所有链接 HTML</li>
<li>减少 DOM 节点数量，使用语义化标签</li>
<li>合理使用 CSS 类切换，避免频繁样式计算</li>
</ul>
</li>
<li>
<p><strong>搜索性能优化</strong>：</p>
<ul>
<li>使用字符串 <code>includes()</code> 方法进行高效匹配</li>
<li>搜索关键词小写转换，实现大小写不敏感搜索</li>
<li>实时搜索与结果渲染结合，减少不必要的函数调用</li>
</ul>
</li>
<li>
<p><strong>资源加载优化</strong>：</p>
<ul>
<li>内联关键 JavaScript，减少 HTTP 请求</li>
<li>优化 SVG 图标，减少文件大小</li>
<li>合理使用 Tailwind CSS 工具类，减少自定义 CSS 体积</li>
</ul>
</li>
</ol>
<h2 data-id="heading-10">部署与 CI/CD 实现</h2>
<h3 data-id="heading-11">静态部署架构</h3>
<p>由于项目是纯前端应用，部署非常简单，可以直接部署到任何静态托管服务：</p>
<ul>
<li><strong>Nginx</strong>：自定义服务器部署</li>
<li><strong>GitHub Pages</strong>：通过 GitHub Actions 自动部署</li>
<li><strong>Vercel</strong>：实时预览和自动部署</li>
<li>etc...</li>
</ul>
<h3 data-id="heading-12">Nginx 部署配置示例</h3>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    server_name host-nav.example.com;
    root /var/www/host-navs/public;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    # 缓存静态资源
    location ~* \.(svg|ico)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}
</code></pre>
<h3 data-id="heading-13">CI/CD 配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># GitHub Actions 配置示例</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">GitHub</span> <span class="hljs-string">Pages</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">peaceiris/actions-gh-pages@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">github_token:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">publish_dir:</span> <span class="hljs-string">./public</span>
</code></pre>
<pre><code class="hljs language-text" lang="text">Vercel 部署（通过监听github push等事件,自动触发构建与部署）
通过 Vercel 平台导入你的 GitHub 项目，集成后即可进行自动化配置部署
</code></pre>
<h2 data-id="heading-14">项目地址</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flinshangchun%2Fhost-navs" target="_blank" title="https://github.com/linshangchun/host-navs" ref="nofollow noopener noreferrer">GitHub Repo</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flinshangchun%2Fhost-navs" target="_blank" title="https://gitee.com/linshangchun/host-navs" ref="nofollow noopener noreferrer">Gitee Repo</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flinshangchun.github.io%2Fhost-navs%2F" target="_blank" title="https://linshangchun.github.io/host-navs/" ref="nofollow noopener noreferrer">host-navs 站导@Github Deploy 在线预览</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhost-navs.vercel.app%2F" target="_blank" title="https://host-navs.vercel.app/" ref="nofollow noopener noreferrer">host-navs 站导@Vercel Deploy 在线预览</a></li>
</ul>
<h2 data-id="heading-15">致谢</h2>
<p>感谢以下开源项目和服务：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">Tailwind CSS</a> - 现代化 CSS 框架</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnodeca%2Fjs-yaml" target="_blank" title="https://github.com/nodeca/js-yaml" ref="nofollow noopener noreferrer">js-yaml</a> - 强大的 YAML 解析库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fs2%2Ffavicons" target="_blank" title="https://www.google.com/s2/favicons" ref="nofollow noopener noreferrer">Google Favicon Service</a> - 提供可靠的图标服务</li>
</ul>
<hr/>
<h2 data-id="heading-16">最后</h2>
<ul>
<li>🚀 更多功能细节的设计与实现请查阅项目源码，欢迎不吝赐教与 Star。</li>
<li>🚀 如果你正在使用本站，欢迎提注 issue，格式如 navs[].items[]；诚邀一起共建优质资源·网站链接·聚合共享·网链平台。</li>
<li>🚀 如果你对项目感兴趣，欢迎参与贡献，诚邀一起完善【<strong>host-navs 站导</strong>】网站链接导航工具站。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day03-APIs]]></title>    <link>https://juejin.cn/post/7585555806667309090</link>    <guid>https://juejin.cn/post/7585555806667309090</guid>    <pubDate>2025-12-21T04:51:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585555806667309090" data-draft-id="7584370833704255503" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day03-APIs "/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-21T04:51:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瘦的可以下饭了"/> <meta itemprop="url" content="https://juejin.cn/user/895474817042060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day03-APIs 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474817042060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瘦的可以下饭了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T04:51:58.000Z" title="Sun Dec 21 2025 04:51:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h3 data-id="heading-0">highlight: atelier-plateau-light
theme: z-blue</h3>
<h2 data-id="heading-1">1. 全选文本框案例</h2>
<blockquote>
<p>1.注意这个伪类选择器</p>
<p>可以直接识选中的对象
<code>/* 选择被勾选的复选框 */     .ck:checked {       width: 20px;       height: 20px;} </code></p>
<ol start="2">
<li>这种All选择的对象想要设置事件时也要用for循环遍历设置</li>
</ol>
</blockquote>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
    <span class="hljs-comment">// 获取大按钮对象</span>
    <span class="hljs-keyword">const</span> checkAll = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#checkAll'</span>)
    <span class="hljs-comment">// 获取所有小按钮的对象</span>
    <span class="hljs-keyword">const</span> cks = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.ck'</span>)
    <span class="hljs-comment">// 设置事件：点击大复选框，小的跟着变化</span>
    checkAll.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
      <span class="hljs-comment">// 我们要去便利cks中的每一个对象，让它们的状态和大复选框一致</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i= <span class="hljs-number">0</span> ; i &lt; cks.<span class="hljs-property">length</span>; i++){
      cks[i].<span class="hljs-property">checked</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">checked</span> <span class="hljs-comment">// chcked是属性,也可以写成checkAll.checked</span>
      }
    })
    <span class="hljs-comment">// 实现功能：当所有的小按钮被选的时候，大按钮被选中</span>
    <span class="hljs-comment">// 要给所有的小复选框添加点击事件，用循环实现</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cks.<span class="hljs-property">length</span>; i++){
        cks[i].<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
          <span class="hljs-comment">// for(let i = 0; i &lt; cks.length; i++){</span>
          <span class="hljs-comment">//   if(cks[i].checked === false){</span>
          <span class="hljs-comment">//     break</span>
          <span class="hljs-comment">//   }</span>
          <span class="hljs-comment">//   if(i === cks.length - 1){</span>
          <span class="hljs-comment">//     checkAll.checked = true</span>
          <span class="hljs-comment">//   }</span>
          <span class="hljs-comment">// }</span>
          checkAll.<span class="hljs-property">checked</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.ck:checked'</span>).<span class="hljs-property">length</span> === cks.<span class="hljs-property">length</span>
        })
        }
  &lt;/script&gt;
</code></pre>
<h2 data-id="heading-2">2.事件流</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/987e8d9681ee49a3990dcf33c33b56a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=3xJ2w%2Bp8ckWvp629Hxeyuu1b7lc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">3.事件捕获</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf9ab65a0def464ca8dc90792da11be6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=HQJGNfRK%2F7y8gUqvuICCGMihL3A%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
        
        <span class="hljs-keyword">const</span> father = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.father'</span>)
        <span class="hljs-keyword">const</span> son = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.son'</span>)

        father.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'我是爸爸'</span>)
        },<span class="hljs-literal">true</span>)

        son.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'我是儿子'</span>)
        },<span class="hljs-literal">true</span>)
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'我是爷爷'</span>)
        },<span class="hljs-literal">true</span>)
    &lt;/script&gt;
</code></pre>
<h2 data-id="heading-4">4.事件冒泡（重要）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e181302fc1fe4e5b972fc9e29a107428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=NBweXQqbU1e%2BVRc52%2FCD6FVIMfo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">5.阻止冒泡（重要）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26f6e2af2931414090ce4610158c850c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=E6%2BZ2QS7Gi2R4lCfyqMeVAEz%2Fus%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'我是爷爷'</span>)
        })
        
        <span class="hljs-keyword">const</span> father = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.father'</span>)
        <span class="hljs-keyword">const</span> son = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.son'</span>)

        father.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'我是爸爸'</span>)
        })

        son.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'我是儿子'</span>)
            e.<span class="hljs-title function_">stopPropagation</span>()
        })
        
    &lt;/script&gt;
</code></pre>
<h2 data-id="heading-6">6.解绑事件</h2>
<h3 data-id="heading-7">6.1 L0事件移除</h3>
<blockquote>
<p>如果是用on创建的方法，如<code> button.onclick = function(){}</code>,可以用 <code>button.onclick = null</code>解绑</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b06a6b14a2c4622b7ea7893eda614b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=GJJ0nfpCqOmwYcz1NLtPRODwYYo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">6.2 L2事件移除</h3>
<blockquote>
<p>L2中匿名函数无法被解绑</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
        <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'button'</span>)
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'点击了'</span>)
        }
        btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,fn)
        <span class="hljs-comment">// 事件移除解绑</span>
        btn.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>,fn)
    &lt;/script&gt;
</code></pre>
<h3 data-id="heading-9">6.3 mouseover和mouseenter的区别</h3>
<ul>
<li>推荐用mouseenter来阻止冒泡</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f49df5c4c7342bd9f507636c93868c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=f6VgllO1g5O56KEUGNi3U6QRiuk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-10">7.事件委托</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f45f9559ce4b4eb08ce8209ec2c2fafd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=OBwBvrOcMXPIjlzn9nkG6rLe%2Bxs%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>第1个孩子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>第2个孩子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>第3个孩子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>第4个孩子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>第5个孩子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>别让我别红<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 点击每个小li，当前li变成红色，点它的其它孩子不变色</span>
        <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'ul'</span>)
        <span class="hljs-comment">// 把事件委托给父级</span>
        <span class="hljs-comment">// 但是要拿到点击的元素</span>
        ul.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>){
            
            <span class="hljs-comment">//e.target就是实际点击的对象·</span>
            <span class="hljs-keyword">if</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">tagName</span> === <span class="hljs-string">'LI'</span>){
                e.<span class="hljs-property">target</span>.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'red'</span>
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">dir</span>(e.<span class="hljs-property">target</span>);
            }
        })
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
&lt;/body&gt;
</code></pre>
<h2 data-id="heading-11">8.利用数组委托实现tab栏切换</h2>
<blockquote>
<p>用到了自定义属性以及两种解决方法</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>tab栏切换<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    * {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    }

    <span class="hljs-selector-class">.tab</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">590px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">340px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e4e4e4</span>;
    }

    <span class="hljs-selector-class">.tab-nav</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">60px</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">justify-content</span>: space-between;
    }

    <span class="hljs-selector-class">.tab-nav</span> <span class="hljs-selector-tag">h3</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
      <span class="hljs-attribute">font-weight</span>: normal;
      <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20px</span>;
    }

    <span class="hljs-selector-class">.tab-nav</span> <span class="hljs-selector-tag">ul</span> {
      <span class="hljs-attribute">list-style</span>: none;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">justify-content</span>: flex-end;
    }

    <span class="hljs-selector-class">.tab-nav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    }

    <span class="hljs-selector-class">.tab-nav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span> {
      <span class="hljs-attribute">text-decoration</span>: none;
      <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">2px</span> solid transparent;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
    }

    <span class="hljs-selector-class">.tab-nav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.active</span> {
      <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#e1251b</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#e1251b</span>;
    }

    <span class="hljs-selector-class">.tab-content</span> {
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">16px</span>;
    }

    <span class="hljs-selector-class">.tab-content</span> <span class="hljs-selector-class">.item</span> {
      <span class="hljs-attribute">display</span>: none;
    }

    <span class="hljs-selector-class">.tab-content</span> <span class="hljs-selector-class">.item</span><span class="hljs-selector-class">.active</span> {
      <span class="hljs-attribute">display</span>: block;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab-nav"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>每日特价<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"active"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:;"</span> <span class="hljs-attr">data-id</span> = <span class="hljs-string">"0"</span> &gt;</span>精选<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:;"</span> <span class="hljs-attr">data-id</span> = <span class="hljs-string">"1"</span>&gt;</span>美食<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:;"</span> <span class="hljs-attr">data-id</span> = <span class="hljs-string">"2"</span>&gt;</span>百货<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:;"</span> <span class="hljs-attr">data-id</span> = <span class="hljs-string">"3"</span>&gt;</span>个护<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:;"</span> <span class="hljs-attr">data-id</span> = <span class="hljs-string">"4"</span>&gt;</span>预告<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item active"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./images/tab00.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./images/tab01.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./images/tab02.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./images/tab03.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./images/tab04.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 功能：采取事件委托的方式实现tab栏切换</span>
    <span class="hljs-comment">// 将事件委托给a的父类ul</span>

    <span class="hljs-comment">// 获取ul对象</span>
    <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.tab-nav ul'</span>)
    <span class="hljs-comment">// 获取item对象，就不需要用nth-child了</span>
    <span class="hljs-keyword">const</span> items = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.tab-content .item'</span>)
    <span class="hljs-comment">// 设置事件</span>
    ul.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>){
        <span class="hljs-keyword">if</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">tagName</span> === <span class="hljs-string">'A'</span>){
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.tab-nav .active'</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>)
            <span class="hljs-comment">// this指向ul，不能用this</span>
            e.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>)
        }
        <span class="hljs-comment">//利用自定义属性来获取下面对应的图片  data-id</span>
        <span class="hljs-comment">// 先删除active</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.tab-content .active'</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>)
        <span class="hljs-comment">// 利用自定义属性来获取顺序</span>
        <span class="hljs-keyword">const</span> i = +e.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">id</span> <span class="hljs-comment">// 要进行隐式转换</span>
        <span class="hljs-comment">// document.querySelector(`.tab-content .item:nth-child(${num+1})`).classList.add('active')</span>
        items[i].<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>)
        
        
    })
    
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-12">9.阻止默认行为</h2>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://www.itcast.cn"</span>&gt;</span> 
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"点击跳转"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http:www.baidu.com"</span>&gt;</span>百度一下<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> form = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'form'</span>)
        form.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>){
            <span class="hljs-comment">// 阻止默认行为，提交</span>
            e.<span class="hljs-title function_">preventDefault</span>()
        })
        <span class="hljs-comment">// 把链接的默认行为阻止</span>
        <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'a'</span>)
        <span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>){
            <span class="hljs-comment">// 阻止默认行为，提交</span>
            e.<span class="hljs-title function_">preventDefault</span>()
        })
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-13">10.其它事件</h2>
<h3 data-id="heading-14">10.1 页面加载事件</h3>
<blockquote>
<p>1.有些时候，js会写在body上面，正常来说，代码会从上往下执行，那js代码就会执行失败，所以说就需要load事件来保证页面加载完毕之后，再执行对应的函数。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af5c980beb264245b3c21d73f4cdd3d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=NfrxYsqw0Zc%2BTcGokiDRwv59gJg%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 页面加载事件，所有资源加载完</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
            <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'button'</span>)
            btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'哈哈'</span>);
        })
        })
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>点我呀<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<blockquote>
<p>1.另一种加载事件比较特殊，它可以实现图片还没有加载完全的时候已经可以实现交互效果了，只需要加载DOM元素就可以了，不需要等待图片的加载，所以比load要快。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fe6943acecd4619a606a9013f902fa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=Xl6cjyd6gd5qfjn2%2FgffmZ4HHVE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-15">10.2 页面滚动事件</h3>
<blockquote>
<p>1.很多时候用户滚动时要产生一些效果，而且不仅仅是页面可以滚动，很多标签也可以滚动</p>
<p>2.要了解scrollTop和scrollLeft属性，可以手写一个div然后拉动的时候输出scrollTop，这个可读写所以我们也能做到一打开页面滚动条就在中间位置。</p>
<p>3.我们日常很多时候滚动全屏时用的是html标签，获取html标签的方式是<strong>document.documentElement</strong>，然后可以设置滑动多少距离发生对应的事件</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a2f7a8e903d4ee8b8c36bfe7b07abbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=UPO67keiHq1%2FA7QvywLbxIvqWT8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">div</span> {
            <span class="hljs-attribute">overflow</span>: scroll;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid black;
            <span class="hljs-attribute">color</span>:black;

        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊
        啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊
        啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊
        啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊
        啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊
        啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊
        啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊
        啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
      <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'div'</span>)
      div.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`scrollTop=<span class="hljs-subst">${div.scrollTop}</span>,scrollLeft=<span class="hljs-subst">${div.scrollLeft}</span>`</span>)
      })
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-16">11.页面尺寸事件</h2>
<blockquote>
<p>1 resize可以实现窗口尺寸变化时触发对应的事件，可以直接用wondow对象调用</p>
<p>2.clientWidth和clientHeight这两个元素可以使用用js获取对象的宽和高（不包含margin、border和滚动条，包括padding）</p>
<p>3.flexible源码就利用了这个事件</p>
</blockquote>
<h2 data-id="heading-17">12.元素尺寸与位置</h2>
<h3 data-id="heading-18">12.1 元素尺寸</h3>
<blockquote>
<p>1.offsetWidth和offsetHeight两个元素可以获取元素的自身宽高（包含padding和border），获取出来的是数值，便于计算</p>
<p>2.获取的是可视宽高，隐藏的盒子返回0</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b33e1c0ec5d4405a0c908ccf190c33f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766897520&amp;x-signature=Rvgt7fOh9KHh2LZMVE3hVAHcnkY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-19">12.2 元素位置(核心)</h3>
<blockquote>
<p>1.明白<code>offsetLeft</code>和<code>ofsetTop</code>属性，它们可以获取元素的定位，但是是相对于带有定位的父级的距离，如果都没有就以文档左上角为准。</p>
<p>2.好处是：比如滚轮滚到某个元素的时候触发事件，就不需要用具体数值了（因为网页添加新元素具体的数字会改变）</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
        <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'div'</span>)
        <span class="hljs-keyword">const</span> p = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'p'</span>)
        <span class="hljs-comment">// offsetLeft是检测盒子距离最近一级带有定位元素的祖先元素</span>
        <span class="hljs-comment">// 在div中添加一个position: relative 那么p的offsetLeft就会变成50</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(div.<span class="hljs-property">offsetLeft</span>)  <span class="hljs-comment">// 108</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">offsetLeft</span>) <span class="hljs-comment">// 158</span>
        
        
    &lt;/script&gt;
    
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS 倒计时组件实战：性能优化篇 - 从100ms刷新到流畅体验]]></title>    <link>https://juejin.cn/post/7585490245007065094</link>    <guid>https://juejin.cn/post/7585490245007065094</guid>    <pubDate>2025-12-21T04:55:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585490245007065094" data-draft-id="7585502118460227603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS 倒计时组件实战：性能优化篇 - 从100ms刷新到流畅体验"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-21T04:55:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Archilect"/> <meta itemprop="url" content="https://juejin.cn/user/1505660538979515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS 倒计时组件实战：性能优化篇 - 从100ms刷新到流畅体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1505660538979515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Archilect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T04:55:10.000Z" title="Sun Dec 21 2025 04:55:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS 倒计时组件实战：性能优化篇 - 从100ms刷新到流畅体验</h2>
<blockquote>
<p>本文是《HarmonyOS ArkTS 企业级倒计时组件设计与实现》系列的第四篇，将深入探讨倒计时组件的性能优化技巧。适合性能优化工程师和高级开发者，学习如何在实际项目中优化组件性能。</p>
</blockquote>
<h3 data-id="heading-1">📋 前言</h3>
<p>倒计时组件需要每100ms更新一次，这意味着在1分钟内会触发600次更新。如果性能优化不当，会导致：</p>
<ul>
<li>页面卡顿</li>
<li>电池消耗增加</li>
<li>用户体验下降</li>
</ul>
<p>本文将分享倒计时组件性能优化的实战经验，从渲染优化到内存管理，全方位提升组件性能。</p>
<h3 data-id="heading-2">🎯 性能优化目标</h3>
<h4 data-id="heading-3">关键指标</h4>
<ol>
<li><strong>渲染性能</strong>：每次更新耗时 &lt; 5ms</li>
<li><strong>内存占用</strong>：组件内存占用 &lt; 2MB</li>
<li><strong>CPU使用率</strong>：后台运行CPU使用率 &lt; 5%</li>
<li><strong>电池消耗</strong>：长时间运行不影响电池寿命</li>
</ol>
<h4 data-id="heading-4">性能瓶颈分析</h4>
<p>倒计时组件的主要性能瓶颈：</p>
<ol>
<li><strong>频繁的UI更新</strong>：每100ms触发一次渲染</li>
<li><strong>定时器开销</strong>：setInterval 的调用成本</li>
<li><strong>状态更新</strong>：@Local 变量的响应式更新</li>
<li><strong>内存泄漏</strong>：定时器和事件监听器未清理</li>
</ol>
<h3 data-id="heading-5">🚀 渲染性能优化</h3>
<h4 data-id="heading-6">1. @Local 变量的响应式机制</h4>
<p>在 HarmonyOS ArkTS 中，<code>@Local</code> 装饰的变量变化会自动触发UI更新。我们需要理解这个机制，避免不必要的更新。</p>
<h5 data-id="heading-7">优化前的问题</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 问题：每次定时器回调都会更新所有变量</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> -= <span class="hljs-number">0.1</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">D</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> / (<span class="hljs-number">24</span> * <span class="hljs-number">3600</span>))
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hh</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> % (<span class="hljs-number">24</span> * <span class="hljs-number">3600</span>)) / <span class="hljs-number">3600</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mm</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> % <span class="hljs-number">3600</span>) / <span class="hljs-number">60</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ss</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> % <span class="hljs-number">60</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ms</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> % <span class="hljs-number">1</span>) * <span class="hljs-number">10</span>)
  <span class="hljs-comment">// 每次更新都会触发5次UI重渲染</span>
}, <span class="hljs-number">100</span>)
</code></pre>
<h5 data-id="heading-8">优化方案</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 优化：只在值真正变化时更新</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> - <span class="hljs-number">0.1</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> * <span class="hljs-number">10</span>) / <span class="hljs-number">10</span>
  
  <span class="hljs-comment">// 只在需要时更新分段数字</span>
  <span class="hljs-keyword">const</span> newD = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> / (<span class="hljs-number">24</span> * <span class="hljs-number">3600</span>))
  <span class="hljs-keyword">if</span> (newD !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">D</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">D</span> = newD
  }
  
  <span class="hljs-keyword">const</span> newHh = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> % (<span class="hljs-number">24</span> * <span class="hljs-number">3600</span>)) / <span class="hljs-number">3600</span>)
  <span class="hljs-keyword">if</span> (newHh !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">hh</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hh</span> = newHh
  }
  
  <span class="hljs-comment">// ... 其他分段数字类似</span>
}, <span class="hljs-number">100</span>)
</code></pre>
<p><strong>优化效果：</strong></p>
<ul>
<li>减少不必要的UI更新</li>
<li>降低渲染次数（从每次5次减少到实际变化次数）</li>
<li>提升流畅度</li>
</ul>
<h4 data-id="heading-9">2. 条件渲染优化</h4>
<p>使用标志位驱动渲染，避免不必要的组件创建：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 优化：使用标志位控制，只渲染需要的元素</span>
<span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeFormatFlags</span>[<span class="hljs-string">'hh'</span>]) {
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">padZero</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">hh</span>)) <span class="hljs-comment">// 只在需要时创建</span>
    }
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p><strong>对比传统方式：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 不优化：所有元素都创建，只是隐藏</span>
<span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">padZero</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">hh</span>))
      .<span class="hljs-title function_">opacity</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeFormatFlags</span>[<span class="hljs-string">'hh'</span>] ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>) <span class="hljs-comment">// 仍然创建了组件</span>
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p><strong>优化效果：</strong></p>
<ul>
<li>减少组件创建数量</li>
<li>降低内存占用</li>
<li>提升渲染性能</li>
</ul>
<h4 data-id="heading-10">3. 样式切换优化</h4>
<p>样式切换时，避免不必要的重渲染：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">decideHowToUpdateStyle</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> newIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNewStyleIndex</span>()
  
  <span class="hljs-comment">// 优化：只在索引真正变化时更新</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleIndex</span> === newIndex || newIndex == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-comment">// 避免不必要的更新</span>
  }
  
  <span class="hljs-comment">// 样式索引有变化，更新样式</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateCustomStyle</span>(newIndex)
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decideWhatToShow</span>()
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleIndex</span> = newIndex
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>比较索引而不是完整对象</li>
<li>提前返回，避免后续计算</li>
<li>批量更新，减少渲染次数</li>
</ul>
<h3 data-id="heading-11">⏱️ 定时器优化</h3>
<h4 data-id="heading-12">1. 100ms 间隔的选择依据</h4>
<p>为什么选择100ms而不是更小的间隔？</p>
<h5 data-id="heading-13">性能测试数据</h5>









































<table><thead><tr><th>刷新间隔</th><th>CPU使用率</th><th>流畅度</th><th>电池消耗</th></tr></thead><tbody><tr><td>10ms</td><td>15%</td><td>极流畅</td><td>高</td></tr><tr><td>50ms</td><td>8%</td><td>流畅</td><td>中</td></tr><tr><td><strong>100ms</strong></td><td><strong>5%</strong></td><td><strong>流畅</strong></td><td><strong>低</strong></td></tr><tr><td>200ms</td><td>3%</td><td>一般</td><td>极低</td></tr><tr><td>1000ms</td><td>1%</td><td>卡顿</td><td>极低</td></tr></tbody></table>
<p><strong>结论：</strong> 100ms是流畅度和性能的最佳平衡点。</p>
<h5 data-id="heading-14">用户体验测试</h5>
<ul>
<li><strong>10ms</strong>：用户感觉不到差异，但CPU消耗高</li>
<li><strong>50ms</strong>：流畅，但电池消耗增加</li>
<li><strong>100ms</strong>：流畅，性能好（推荐）</li>
<li><strong>200ms</strong>：轻微卡顿，但可接受</li>
<li><strong>1000ms</strong>：明显卡顿，体验差</li>
</ul>
<h4 data-id="heading-15">2. setInterval vs requestAnimationFrame</h4>
<h5 data-id="heading-16">setInterval 的优势</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用 setInterval</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">timerId</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshTimeNumber</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> -= <span class="hljs-number">0.1</span>
}, <span class="hljs-number">100</span>)
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>✅ 固定间隔，时间精确</li>
<li>✅ 不依赖浏览器渲染帧率</li>
<li>✅ 适合倒计时这种需要精确时间的场景</li>
</ul>
<h5 data-id="heading-17">requestAnimationFrame 的问题</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 不推荐：requestAnimationFrame</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshTimeNumber</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> -= <span class="hljs-number">0.1</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(update)
}
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>❌ 依赖浏览器帧率（通常60fps，约16.7ms）</li>
<li>❌ 时间不精确，不适合倒计时</li>
<li>❌ 页面不可见时可能暂停</li>
</ul>
<p><strong>结论：</strong> 倒计时组件使用 <code>setInterval</code> 更合适。</p>
<h4 data-id="heading-18">3. 低电量模式降频策略</h4>
<p>在低电量模式下，可以降低刷新频率：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检测低电量模式</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">getInterval</span>(): <span class="hljs-built_in">number</span> {
  <span class="hljs-comment">// 检测设备电量（需要系统API支持）</span>
  <span class="hljs-keyword">const</span> batteryLevel = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getBatteryLevel</span>()
  
  <span class="hljs-keyword">if</span> (batteryLevel &lt; <span class="hljs-number">20</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">200</span> <span class="hljs-comment">// 低电量时降低刷新频率</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (batteryLevel &lt; <span class="hljs-number">50</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">150</span>
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-number">100</span> <span class="hljs-comment">// 正常频率</span>
}

<span class="hljs-title function_">startCountdown</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> interval = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInterval</span>()
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timerId</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ...</span>
  }, interval)
}
</code></pre>
<p><strong>注意：</strong> HarmonyOS 可能不直接提供电池API，可以通过系统设置或用户配置实现。</p>
<h3 data-id="heading-19">🎨 样式切换优化</h3>
<h4 data-id="heading-20">1. 避免不必要的样式更新</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">decideHowToUpdateStyle</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> newIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNewStyleIndex</span>()
  
  <span class="hljs-comment">// 优化：索引没变时，不改变样式</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleIndex</span> === newIndex || newIndex == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-comment">// 提前返回，避免不必要的计算</span>
  }
  
  <span class="hljs-comment">// 样式索引有变化，更新样式</span>
  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'样式索引：从'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleIndex</span> + <span class="hljs-string">'变为：'</span> + newIndex)
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateCustomStyle</span>(newIndex)
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decideWhatToShow</span>()
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleIndex</span> = newIndex
}
</code></pre>
<p><strong>优化点：</strong></p>
<ul>
<li>比较索引而不是完整对象</li>
<li>提前返回，避免后续计算</li>
<li>批量更新，减少渲染次数</li>
</ul>
<h4 data-id="heading-21">2. 区间查找优化</h4>
<p>当前使用 <code>findIndex</code> 查找样式区间，时间复杂度 O(n)：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">getNewStyleIndex</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>?.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> time1 = c.<span class="hljs-property">beginSec</span>
    <span class="hljs-keyword">const</span> time2 = c.<span class="hljs-property">endSec</span>
    <span class="hljs-keyword">if</span> (time1 == <span class="hljs-literal">null</span> || time2 == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    <span class="hljs-keyword">const</span> withinBound = (time1 &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span>) &amp;&amp; 
      ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> &lt; time2 + <span class="hljs-number">1</span>) || (<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span>))
    <span class="hljs-keyword">return</span> withinBound
  })
}
</code></pre>
<p><strong>优化建议：</strong></p>
<p>如果样式配置数量很多（&gt;10个），可以使用二分查找：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 优化：二分查找（需要配置按时间排序）</span>
<span class="hljs-title function_">getNewStyleIndex</span>(): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  }
  
  <span class="hljs-comment">// 二分查找</span>
  <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> right = <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
  
  <span class="hljs-keyword">while</span> (left &lt;= right) {
    <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>)
    <span class="hljs-keyword">const</span> config = <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>[mid]
    
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">beginSec</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> &amp;&amp; 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> &lt; config.<span class="hljs-property">endSec</span> + <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span> mid
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> &lt; config.<span class="hljs-property">beginSec</span>) {
      right = mid - <span class="hljs-number">1</span>
    } <span class="hljs-keyword">else</span> {
      left = mid + <span class="hljs-number">1</span>
    }
  }
  
  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
}
</code></pre>
<p><strong>性能对比：</strong></p>
<ul>
<li><code>findIndex</code>：O(n)，适合配置少（&lt;10个）</li>
<li>二分查找：O(log n)，适合配置多（&gt;10个）</li>
</ul>
<p><strong>注意：</strong> 需要配置按时间排序，且当前场景配置数量少，使用 <code>findIndex</code> 即可。</p>
<h3 data-id="heading-22">💾 内存管理</h3>
<h4 data-id="heading-23">1. 定时器清理机制</h4>
<p>定时器是内存泄漏的常见原因，必须正确清理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 必须清理定时器</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopCountdown</span>()
  
  <span class="hljs-comment">// 清理事件监听器</span>
  emitter.<span class="hljs-title function_">off</span>(<span class="hljs-variable constant_">PAGE_HIDE_EVENT</span>)
  emitter.<span class="hljs-title function_">off</span>(<span class="hljs-variable constant_">PAGE_SHOW_EVENT</span>)
  
  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'倒计时移除'</span>)
}

<span class="hljs-title function_">stopCountdown</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-title class_">TimerStatus</span>.<span class="hljs-property">IDLE</span>
  
  <span class="hljs-comment">// 清理定时器</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timerId</span> !== <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timerId</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timerId</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// 重置ID</span>
  }
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> = <span class="hljs-number">0</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshTimeNumber</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span>)
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>在 <code>aboutToDisappear</code> 中必须清理</li>
<li>清理后重置 <code>timerId</code> 为 0</li>
<li>同时清理事件监听器</li>
</ul>
<h4 data-id="heading-24">2. 事件监听器管理</h4>
<p>页面显示/隐藏事件监听器也需要清理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">ignorePause</span>) {
    emitter.<span class="hljs-title function_">on</span>(<span class="hljs-variable constant_">PAGE_SHOW_EVENT</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startCountdown</span>())
    emitter.<span class="hljs-title function_">on</span>(<span class="hljs-variable constant_">PAGE_HIDE_EVENT</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pauseCountdown</span>())
  }
}

<span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 必须清理事件监听器</span>
  emitter.<span class="hljs-title function_">off</span>(<span class="hljs-variable constant_">PAGE_HIDE_EVENT</span>)
  emitter.<span class="hljs-title function_">off</span>(<span class="hljs-variable constant_">PAGE_SHOW_EVENT</span>)
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>注意：</strong></p>
<ul>
<li>使用 <code>emitter.off</code> 清理监听器</li>
<li>确保监听器函数引用一致（使用箭头函数或绑定）</li>
</ul>
<h4 data-id="heading-25">3. 对象引用清理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopCountdown</span>()
  
  <span class="hljs-comment">// 清理对象引用</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">countDownCallback</span> = <span class="hljs-literal">undefined</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span> = <span class="hljs-literal">undefined</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataPath</span> = {}
  
  <span class="hljs-comment">// 清理事件监听器</span>
  emitter.<span class="hljs-title function_">off</span>(<span class="hljs-variable constant_">PAGE_HIDE_EVENT</span>)
  emitter.<span class="hljs-title function_">off</span>(<span class="hljs-variable constant_">PAGE_SHOW_EVENT</span>)
}
</code></pre>
<p><strong>注意：</strong> 虽然 TypeScript/ArkTS 有垃圾回收，但显式清理可以：</p>
<ul>
<li>提前释放内存</li>
<li>避免循环引用</li>
<li>便于调试</li>
</ul>
<h3 data-id="heading-26">📊 性能监控</h3>
<h4 data-id="heading-27">1. 渲染性能监控</h4>
<p>可以添加性能监控代码（开发环境）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-attr">renderCount</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
<span class="hljs-keyword">private</span> <span class="hljs-attr">lastRenderTime</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>

<span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 性能监控（仅开发环境）</span>
  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderCount</span>++
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lastRenderTime</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> interval = now - <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastRenderTime</span>
      <span class="hljs-keyword">if</span> (interval &gt; <span class="hljs-number">20</span>) { <span class="hljs-comment">// 超过20ms警告</span>
        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`渲染间隔过长: <span class="hljs-subst">${interval}</span>ms, 总渲染次数: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.renderCount}</span>`</span>)
      }
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastRenderTime</span> = now
  }
  
  <span class="hljs-comment">// ... 正常渲染逻辑</span>
}
</code></pre>
<h4 data-id="heading-28">2. 内存占用监控</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 监控内存占用（需要系统API支持）</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">checkMemoryUsage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-comment">// HarmonyOS 可能提供内存监控API</span>
    <span class="hljs-comment">// const memoryInfo = getMemoryInfo()</span>
    <span class="hljs-comment">// Logger.info(TAG, `内存占用: ${memoryInfo.used}MB`)</span>
  }
}
</code></pre>
<h3 data-id="heading-29">🎯 性能优化 checklist</h3>
<h4 data-id="heading-30">渲染优化</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 避免不必要的 @Local 变量更新</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 使用条件渲染而不是 opacity</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 样式切换时提前返回</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 批量更新状态</li>
</ul>
<h4 data-id="heading-31">定时器优化</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 使用合适的刷新间隔（100ms）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 正确清理定时器</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 考虑低电量模式降频</li>
</ul>
<h4 data-id="heading-32">内存管理</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 清理定时器</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 清理事件监听器</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 清理对象引用</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 避免循环引用</li>
</ul>
<h4 data-id="heading-33">性能监控</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 添加渲染性能监控（开发环境）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 添加内存占用监控（开发环境）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 记录性能日志</li>
</ul>
<h3 data-id="heading-34">💡 最佳实践</h3>
<h4 data-id="heading-35">1. 性能优化的原则</h4>
<ul>
<li>✅ <strong>先测量，后优化</strong>：使用性能监控工具找出瓶颈</li>
<li>✅ <strong>优化关键路径</strong>：优先优化频繁执行的代码</li>
<li>✅ <strong>平衡性能和可维护性</strong>：不要为了性能牺牲代码质量</li>
<li>❌ <strong>过早优化</strong>：不要在没有性能问题时过度优化</li>
</ul>
<h4 data-id="heading-36">2. 倒计时组件的优化重点</h4>
<ol>
<li><strong>定时器管理</strong>：正确清理，避免泄漏</li>
<li><strong>渲染优化</strong>：减少不必要的更新</li>
<li><strong>内存管理</strong>：清理所有资源</li>
<li><strong>样式切换</strong>：避免不必要的计算</li>
</ol>
<h4 data-id="heading-37">3. 性能测试建议</h4>
<ul>
<li>长时间运行测试（1小时+）</li>
<li>内存泄漏检测</li>
<li>CPU使用率监控</li>
<li>电池消耗测试</li>
</ul>
<h3 data-id="heading-38">🎓 总结</h3>
<p>本文分享了倒计时组件性能优化的实战经验：</p>
<ol>
<li><strong>渲染性能优化</strong>：减少不必要的UI更新</li>
<li><strong>定时器优化</strong>：选择合适的刷新间隔</li>
<li><strong>样式切换优化</strong>：避免不必要的计算</li>
<li><strong>内存管理</strong>：正确清理所有资源</li>
</ol>
<p><strong>关键要点：</strong></p>
<ul>
<li>100ms是流畅度和性能的最佳平衡点</li>
<li>使用 <code>setInterval</code> 而不是 <code>requestAnimationFrame</code></li>
<li>必须清理定时器和事件监听器</li>
<li>性能优化要基于实际测量</li>
</ul>
<p>在下一篇文章中，我们将探讨高级特性：时间区间样式切换的动态配置系统。</p>
<hr/>
<p><strong>系列文章导航：</strong></p>
<ul>
<li>[第1篇] 基础篇：从需求分析到基础实现</li>
<li>[第2篇] 设计模式反思篇：当AI建议用策略模式时，我选择了质疑</li>
<li>[第3篇] 设计模式实践篇：标志位驱动渲染与状态机模式</li>
<li>[第4篇] 性能优化篇：从100ms刷新到流畅体验（本文）</li>
<li>[第5篇] 高级特性篇：时间区间样式切换</li>
<li>[第6篇] 工程实践篇：测试与质量保证</li>
<li>[第7篇] 总结篇：最佳实践与思考</li>
</ul>
<p><strong>讨论：</strong>
你在项目中是如何优化组件性能的？欢迎在评论区分享你的经验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS 倒计时组件实战：高级特性篇 - 时间区间样式切换的动态配置系统]]></title>    <link>https://juejin.cn/post/7585485074038734854</link>    <guid>https://juejin.cn/post/7585485074038734854</guid>    <pubDate>2025-12-21T04:56:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485074038734854" data-draft-id="7585485074038718470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS 倒计时组件实战：高级特性篇 - 时间区间样式切换的动态配置系统"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-21T04:56:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Archilect"/> <meta itemprop="url" content="https://juejin.cn/user/1505660538979515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS 倒计时组件实战：高级特性篇 - 时间区间样式切换的动态配置系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1505660538979515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Archilect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T04:56:45.000Z" title="Sun Dec 21 2025 04:56:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS 倒计时组件实战：高级特性篇 - 时间区间样式切换的动态配置系统</h2>
<blockquote>
<p>本文是《HarmonyOS ArkTS 企业级倒计时组件设计与实现》系列的第五篇，将深入探讨时间区间样式切换的动态配置系统。适合高级开发者和技术专家，学习如何设计可扩展的配置系统。</p>
</blockquote>
<h3 data-id="heading-1">📋 前言</h3>
<p>在实际业务场景中，倒计时组件需要在不同的时间区间显示不同的样式。例如：</p>
<ul>
<li>最后10秒：显示红色警告样式</li>
<li>最后1分钟：显示黄色提醒样式</li>
<li>其他时间：显示默认样式</li>
</ul>
<p>这种需求需要一个灵活的动态配置系统。本文将分享如何设计并实现这样一个系统。</p>
<h3 data-id="heading-2">🎯 需求分析</h3>
<h4 data-id="heading-3">业务场景</h4>
<ol>
<li><strong>秒杀倒计时</strong>：最后10秒变红，营造紧张感</li>
<li><strong>活动倒计时</strong>：不同时间段显示不同提示文字</li>
<li><strong>限时优惠</strong>：剩余时间少时显示"即将结束"</li>
</ol>
<h4 data-id="heading-4">功能需求</h4>
<ol>
<li><strong>时间区间配置</strong>：支持配置多个时间区间</li>
<li><strong>样式类型</strong>：每个区间支持4种样式类型</li>
<li><strong>动态切换</strong>：根据剩余时间自动切换样式</li>
<li><strong>配置验证</strong>：确保配置的正确性</li>
</ol>
<h3 data-id="heading-5">🏗️ 配置系统设计</h3>
<h4 data-id="heading-6">1. 配置数据结构</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomStyle</span> {
  <span class="hljs-attr">beginSec</span>: <span class="hljs-built_in">number</span>      <span class="hljs-comment">// 区间开始时间（秒）</span>
  <span class="hljs-attr">endSec</span>: <span class="hljs-built_in">number</span>        <span class="hljs-comment">// 区间结束时间（秒）</span>
  <span class="hljs-attr">showStyle</span>: <span class="hljs-built_in">number</span>     <span class="hljs-comment">// 样式类型：0-3</span>
  prefixText?: <span class="hljs-built_in">string</span>   <span class="hljs-comment">// 前缀文本</span>
  suffixText?: <span class="hljs-built_in">string</span>   <span class="hljs-comment">// 后缀文本</span>
  text?: <span class="hljs-built_in">string</span>         <span class="hljs-comment">// 自定义文本（样式类型3使用）</span>
}

<span class="hljs-comment">// 配置示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">customStyleConfigs</span>: <span class="hljs-title class_">CustomStyle</span>[] = [
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">0</span>,        <span class="hljs-comment">// 最后10秒</span>
    <span class="hljs-attr">endSec</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">2</span>,       <span class="hljs-comment">// 仅显示秒</span>
    <span class="hljs-attr">prefixText</span>: <span class="hljs-string">'仅剩'</span>,
    <span class="hljs-attr">suffixText</span>: <span class="hljs-string">'秒'</span>
  },
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">10</span>,       <span class="hljs-comment">// 10-60秒</span>
    <span class="hljs-attr">endSec</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">0</span>,       <span class="hljs-comment">// 标准时间格式</span>
    <span class="hljs-attr">prefixText</span>: <span class="hljs-string">'剩余'</span>
  },
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">60</span>,       <span class="hljs-comment">// 1分钟以上</span>
    <span class="hljs-attr">endSec</span>: <span class="hljs-number">3600</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">1</span>,       <span class="hljs-comment">// 天+小时格式</span>
    <span class="hljs-attr">text</span>: <span class="hljs-string">'活动进行中'</span>
  }
]
</code></pre>
<h4 data-id="heading-7">2. 样式类型定义</h4>






























<table><thead><tr><th>样式类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>0</td><td>标准时间格式</td><td><code>hh:mm:ss</code> 或 <code>mm:ss</code></td></tr><tr><td>1</td><td>天+小时格式</td><td><code>D天hh小时</code></td></tr><tr><td>2</td><td>仅秒格式</td><td><code>ss</code> 或 <code>ss.ms</code></td></tr><tr><td>3</td><td>自定义文本</td><td><code>即将开始</code></td></tr></tbody></table>
<h4 data-id="heading-8">3. 配置验证</h4>
<p>在初始化时验证配置的正确性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">validateCustomStyleConfigs</span>(<span class="hljs-attr">configs</span>: <span class="hljs-title class_">CustomStyle</span>[]): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (!configs || configs.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 空配置是合法的</span>
  }
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> config <span class="hljs-keyword">of</span> configs) {
    <span class="hljs-comment">// 验证时间区间</span>
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">beginSec</span> == <span class="hljs-literal">null</span> || config.<span class="hljs-property">endSec</span> == <span class="hljs-literal">null</span>) {
      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'配置错误：时间区间不能为空'</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">beginSec</span> &gt;= config.<span class="hljs-property">endSec</span>) {
      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'配置错误：开始时间必须小于结束时间'</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-comment">// 验证样式类型</span>
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">showStyle</span> &lt; <span class="hljs-number">0</span> || config.<span class="hljs-property">showStyle</span> &gt; <span class="hljs-number">3</span>) {
      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'配置错误：样式类型必须在0-3之间'</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-comment">// 验证自定义文本</span>
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">showStyle</span> === <span class="hljs-number">3</span> &amp;&amp; !config.<span class="hljs-property">text</span>) {
      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'配置错误：样式类型3必须提供text'</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
</code></pre>
<h3 data-id="heading-9">🔍 区间查找算法</h3>
<h4 data-id="heading-10">1. 基础实现（findIndex）</h4>
<p>当前使用 <code>findIndex</code> 查找匹配的样式区间：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">getNewStyleIndex</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 数组为空返回undefined</span>
  <span class="hljs-comment">// 数组存在，不在时间区间，返回-1</span>
  <span class="hljs-comment">// undefined和-1都显示默认时间样式</span>
  
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>?.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> time1 = c.<span class="hljs-property">beginSec</span> <span class="hljs-comment">// 左端</span>
    <span class="hljs-keyword">const</span> time2 = c.<span class="hljs-property">endSec</span>   <span class="hljs-comment">// 右端</span>
    
    <span class="hljs-keyword">if</span> (time1 == <span class="hljs-literal">null</span> || time2 == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-comment">// 判断是否在区间内</span>
    <span class="hljs-keyword">const</span> withinBound = (time1 &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span>) &amp;&amp; 
      ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> &lt; time2 + <span class="hljs-number">1</span>) || (<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span>))
    
    <span class="hljs-keyword">return</span> withinBound
  }) <span class="hljs-comment">// 返回 0-3，-1/undefined</span>
}
</code></pre>
<p><strong>算法分析：</strong></p>
<ul>
<li>时间复杂度：O(n)，n为配置数量</li>
<li>空间复杂度：O(1)</li>
<li>适用场景：配置数量少（&lt;10个）</li>
</ul>
<p><strong>边界处理：</strong></p>
<ul>
<li><code>this.remainingTime === this.totalTime</code>：初始状态，显示第一个匹配的样式</li>
<li><code>time2 + 1</code>：包含结束边界</li>
</ul>
<h4 data-id="heading-11">2. 优化方案（二分查找）</h4>
<p>如果配置数量很多（&gt;10个），可以使用二分查找优化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">getNewStyleIndex</span>(): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  }
  
  <span class="hljs-comment">// 假设配置已按时间排序</span>
  <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> right = <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
  
  <span class="hljs-keyword">while</span> (left &lt;= right) {
    <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>)
    <span class="hljs-keyword">const</span> config = <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>[mid]
    
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">beginSec</span> == <span class="hljs-literal">null</span> || config.<span class="hljs-property">endSec</span> == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">continue</span>
    }
    
    <span class="hljs-comment">// 判断是否在区间内</span>
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">beginSec</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> &amp;&amp; 
        (<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> &lt; config.<span class="hljs-property">endSec</span> + <span class="hljs-number">1</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span>)) {
      <span class="hljs-keyword">return</span> mid
    }
    
    <span class="hljs-comment">// 在区间左侧</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">remainingTime</span> &lt; config.<span class="hljs-property">beginSec</span>) {
      right = mid - <span class="hljs-number">1</span>
    } 
    <span class="hljs-comment">// 在区间右侧</span>
    <span class="hljs-keyword">else</span> {
      left = mid + <span class="hljs-number">1</span>
    }
  }
  
  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
}
</code></pre>
<p><strong>算法分析：</strong></p>
<ul>
<li>时间复杂度：O(log n)</li>
<li>空间复杂度：O(1)</li>
<li>适用场景：配置数量多（&gt;10个），且已排序</li>
</ul>
<p><strong>注意：</strong> 需要确保配置按时间排序，可以在初始化时排序：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>) {
    <span class="hljs-comment">// 按开始时间排序</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> 
      (a.<span class="hljs-property">beginSec</span> ?? <span class="hljs-number">0</span>) - (b.<span class="hljs-property">beginSec</span> ?? <span class="hljs-number">0</span>)
    )
  }
}
</code></pre>
<h4 data-id="heading-12">3. 算法选择建议</h4>

























<table><thead><tr><th>配置数量</th><th>推荐算法</th><th>时间复杂度</th></tr></thead><tbody><tr><td>&lt; 10个</td><td>findIndex</td><td>O(n)</td></tr><tr><td>10-50个</td><td>findIndex（足够快）</td><td>O(n)</td></tr><tr><td>&gt; 50个</td><td>二分查找</td><td>O(log n)</td></tr></tbody></table>
<p><strong>当前场景：</strong> 通常配置数量 &lt; 10个，使用 <code>findIndex</code> 即可。</p>
<h3 data-id="heading-13">🎨 样式切换机制</h3>
<h4 data-id="heading-14">1. 切换时机控制</h4>
<p>只在样式索引真正变化时切换：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">decideHowToUpdateStyle</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> newIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNewStyleIndex</span>()
  
  <span class="hljs-comment">// 优化：索引没变时，不改变样式</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleIndex</span> === newIndex || newIndex == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-comment">// 避免不必要的更新</span>
  }
  
  <span class="hljs-comment">// 样式索引有变化，更新样式</span>
  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'样式索引：从'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleIndex</span> + <span class="hljs-string">'变为：'</span> + newIndex)
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateCustomStyle</span>(newIndex)
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decideWhatToShow</span>()
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleIndex</span> = newIndex
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>比较索引而不是完整对象</li>
<li>提前返回，避免不必要的计算</li>
<li>批量更新，减少渲染次数</li>
</ul>
<h4 data-id="heading-15">2. 样式更新</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">updateCustomStyle</span>(<span class="hljs-params">newIndex: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleConfig</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span>?.[newIndex]
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleType</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleConfig</span>?.<span class="hljs-property">showStyle</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activePre</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleConfig</span>?.<span class="hljs-property">prefixText</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeSuf</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleConfig</span>?.<span class="hljs-property">suffixText</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomizedText</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleConfig</span>?.<span class="hljs-property">text</span>
}
</code></pre>
<h4 data-id="heading-16">3. 格式决定</h4>
<p>格式选择逻辑沿用第2篇的轻量策略/表驱动方案decideWhatToShow，详情可见《设计模式反思篇》</p>
<h3 data-id="heading-17">🔧 扩展性设计</h3>
<h4 data-id="heading-18">1. 添加新的样式类型</h4>
<p>如果需要添加新的样式类型（如类型4），只需：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 扩展样式类型定义</span>
<span class="hljs-comment">// showStyle: 4 表示新样式</span>

<span class="hljs-comment">// 2. 在 decideWhatToShow 中添加处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">occasions</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
  <span class="hljs-comment">// ... 现有配置</span>
  <span class="hljs-string">'启用自定义4'</span>: <span class="hljs-string">'新样式格式'</span>,
}

<span class="hljs-comment">// 3. 在 build 中添加渲染逻辑（如需要）</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">activeCustomStyleType</span> === <span class="hljs-number">4</span>) {
  <span class="hljs-comment">// 新样式的渲染逻辑</span>
}
</code></pre>
<h4 data-id="heading-19">2. 配置系统的扩展接口</h4>
<p>可以设计配置系统的扩展接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">StyleConfigExtension</span> {
  <span class="hljs-comment">// 自定义样式验证</span>
  validate?(<span class="hljs-attr">config</span>: <span class="hljs-title class_">CustomStyle</span>): <span class="hljs-built_in">boolean</span>
  
  <span class="hljs-comment">// 自定义样式处理</span>
  process?(<span class="hljs-attr">config</span>: <span class="hljs-title class_">CustomStyle</span>, <span class="hljs-attr">remainingTime</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span>
  
  <span class="hljs-comment">// 自定义渲染逻辑</span>
  render?(<span class="hljs-attr">config</span>: <span class="hljs-title class_">CustomStyle</span>): <span class="hljs-built_in">void</span>
}

<span class="hljs-comment">// 使用扩展</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExtendedCountdownView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">CountdownView</span> {
  <span class="hljs-keyword">private</span> styleExtension?: <span class="hljs-title class_">StyleConfigExtension</span>
  
  <span class="hljs-title function_">setStyleExtension</span>(<span class="hljs-params">extension: StyleConfigExtension</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">styleExtension</span> = extension
  }
  
  <span class="hljs-title function_">validateCustomStyleConfigs</span>(<span class="hljs-attr">configs</span>: <span class="hljs-title class_">CustomStyle</span>[]): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-comment">// 先执行基础验证</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">super</span>.<span class="hljs-title function_">validateCustomStyleConfigs</span>(configs)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-comment">// 执行扩展验证</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">styleExtension</span>?.<span class="hljs-property">validate</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> config <span class="hljs-keyword">of</span> configs) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">styleExtension</span>.<span class="hljs-title function_">validate</span>(config)) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
}
</code></pre>
<h4 data-id="heading-20">3. 配置热更新</h4>
<p>支持运行时更新配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">updateCustomStyleConfigs</span>(<span class="hljs-params">newConfigs: CustomStyle[]</span>) {
  <span class="hljs-comment">// 验证新配置</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateCustomStyleConfigs</span>(newConfigs)) {
    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'配置更新失败：配置验证不通过'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  
  <span class="hljs-comment">// 更新配置</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">customStyleConfigs</span> = newConfigs
  
  <span class="hljs-comment">// 重新计算当前样式</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">decideHowToUpdateStyle</span>()
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
</code></pre>
<h3 data-id="heading-21">🎯 实际应用案例</h3>
<h4 data-id="heading-22">案例1：秒杀倒计时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">seckillConfig</span>: <span class="hljs-title class_">CustomStyle</span>[] = [
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">endSec</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">2</span>,        <span class="hljs-comment">// 仅显示秒</span>
    <span class="hljs-attr">prefixText</span>: <span class="hljs-string">'仅剩'</span>,
    <span class="hljs-attr">suffixText</span>: <span class="hljs-string">'秒'</span>,
    <span class="hljs-comment">// 可以配合红色样式</span>
  },
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">endSec</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">0</span>,        <span class="hljs-comment">// 标准格式</span>
    <span class="hljs-attr">prefixText</span>: <span class="hljs-string">'剩余'</span>,
  },
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">endSec</span>: <span class="hljs-title class_">Infinity</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment">// 天+小时</span>
  }
]
</code></pre>
<h4 data-id="heading-23">案例2：活动倒计时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">activityConfig</span>: <span class="hljs-title class_">CustomStyle</span>[] = [
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">endSec</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">3</span>,        <span class="hljs-comment">// 自定义文本</span>
    <span class="hljs-attr">text</span>: <span class="hljs-string">'即将结束'</span>,
  },
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">60</span>,
    <span class="hljs-attr">endSec</span>: <span class="hljs-number">3600</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">0</span>,        <span class="hljs-comment">// 标准格式</span>
    <span class="hljs-attr">prefixText</span>: <span class="hljs-string">'剩余'</span>,
  },
  {
    <span class="hljs-attr">beginSec</span>: <span class="hljs-number">3600</span>,
    <span class="hljs-attr">endSec</span>: <span class="hljs-title class_">Infinity</span>,
    <span class="hljs-attr">showStyle</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment">// 天+小时</span>
    <span class="hljs-attr">text</span>: <span class="hljs-string">'活动进行中'</span>,
  }
]
</code></pre>
<h3 data-id="heading-24">💡 最佳实践</h3>
<h4 data-id="heading-25">1. 配置设计原则</h4>
<ul>
<li>✅ <strong>时间区间不重叠</strong>：避免样式冲突</li>
<li>✅ <strong>边界处理清晰</strong>：明确包含/排除边界</li>
<li>✅ <strong>默认样式兜底</strong>：不在任何区间时使用默认样式</li>
<li>✅ <strong>配置验证完善</strong>：确保配置正确性</li>
</ul>
<h4 data-id="heading-26">2. 性能优化建议</h4>
<ul>
<li>✅ <strong>提前返回</strong>：样式索引没变时不更新</li>
<li>✅ <strong>批量更新</strong>：一次性更新所有相关状态</li>
<li>✅ <strong>算法选择</strong>：根据配置数量选择合适算法</li>
<li>❌ <strong>避免频繁切换</strong>：合理设计时间区间</li>
</ul>
<h4 data-id="heading-27">3. 扩展性建议</h4>
<ul>
<li>✅ <strong>接口设计清晰</strong>：便于扩展新样式类型</li>
<li>✅ <strong>配置结构灵活</strong>：支持未来需求变化</li>
<li>✅ <strong>热更新支持</strong>：支持运行时更新配置</li>
<li>❌ <strong>避免过度设计</strong>：不要为了扩展而扩展</li>
</ul>
<h3 data-id="heading-28">🎓 总结</h3>
<p>本文深入探讨了时间区间样式切换的动态配置系统：</p>
<ol>
<li><strong>配置系统设计</strong>：灵活的数据结构和验证机制</li>
<li><strong>区间查找算法</strong>：findIndex vs 二分查找</li>
<li><strong>样式切换机制</strong>：优化切换时机，减少不必要的更新</li>
<li><strong>扩展性设计</strong>：支持新样式类型和配置热更新</li>
</ol>
<p><strong>关键要点：</strong></p>
<ul>
<li>配置验证确保正确性</li>
<li>算法选择根据配置数量</li>
<li>样式切换优化性能</li>
<li>扩展性设计面向未来</li>
</ul>
<p>在下一篇文章中，我们将探讨工程实践：测试与质量保证。</p>
<hr/>
<p><strong>系列文章导航：</strong></p>
<ul>
<li>[第1篇] 基础篇：从需求分析到基础实现</li>
<li>[第2篇] 设计模式反思篇：当AI建议用策略模式时，我选择了质疑</li>
<li>[第3篇] 设计模式实践篇：标志位驱动渲染与状态机模式</li>
<li>[第4篇] 性能优化篇：从100ms刷新到流畅体验</li>
<li>[第5篇] 高级特性篇：时间区间样式切换（本文）</li>
<li>[第6篇] 工程实践篇：测试与质量保证</li>
<li>[第7篇] 总结篇：最佳实践与思考</li>
</ul>
<p><strong>讨论：</strong>
你在项目中是如何设计配置系统的？欢迎在评论区分享你的经验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3中v-show如何通过CSS修改display属性控制条件显示？与v-if的应用场景该如何区分？]]></title>    <link>https://juejin.cn/post/7585693761532182562</link>    <guid>https://juejin.cn/post/7585693761532182562</guid>    <pubDate>2025-12-21T05:19:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585693761532182562" data-draft-id="7585706951603896346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3中v-show如何通过CSS修改display属性控制条件显示？与v-if的应用场景该如何区分？    "/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-21T05:19:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3中v-show如何通过CSS修改display属性控制条件显示？与v-if的应用场景该如何区分？    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T05:19:37.000Z" title="Sun Dec 21 2025 05:19:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Vue3条件渲染指令：v-show——基于CSS的条件显示与切换</h3>
<h4 data-id="heading-1">一、v-show是什么？和v-if有什么不一样？</h4>
<p>作为Vue3中最常用的条件渲染指令之一，v-show的核心作用是<strong>根据表达式的真假，切换元素的“视觉显示状态”</strong>——注意，是“视觉上”的，不是“存在与否”的。</p>
<p>我们先拿它和另一个常见指令v-if做个简单对比：</p>
<ul>
<li><strong>v-if</strong>：通过“销毁/重建DOM元素”实现条件显示（表达式为假时，元素从DOM树中移除；为真时重新创建）；</li>
<li><strong>v-show</strong>：通过“修改CSS的display属性”实现条件显示（元素始终在DOM树中，只是用<code>display: none</code>隐藏）。</li>
</ul>
<p>举个生活例子：如果把DOM比作衣柜，v-if是“把衣服拿出衣柜/放进衣柜”，v-show是“把衣服用布盖起来/掀开布”——衣服始终在衣柜里，只是看不看得到的问题。</p>
<h4 data-id="heading-2">二、v-show的工作原理：一句话讲清楚</h4>
<p>v-show的底层逻辑非常直白：</p>
<ol>
<li>当绑定的表达式（比如<code>isShow</code>）为<strong>真</strong>时，Vue会把元素的<code>display</code>属性恢复为它的<strong>默认值</strong>（比如<code>div</code>默认是<code>block</code>，<code>span</code>默认是<code>inline</code>）；</li>
<li>当表达式为<strong>假</strong>时，Vue强制把元素的<code>display</code>设为<code>none</code>，让元素“消失”。</li>
</ol>
<p>关键结论：<strong>v-show的元素永远不会离开DOM树，只是“藏起来”了</strong>。</p>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F8a1ddfac64b25062ac56403e4c1201d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/8a1ddfac64b25062ac56403e4c1201d2/" ref="nofollow noopener noreferrer">Vue3条件渲染中v-if系列指令如何合理使用与规避错误？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F218c3a59282c3b757447ee08a01937bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/218c3a59282c3b757447ee08a01937bb/" ref="nofollow noopener noreferrer">Vue3动态样式控制：ref、reactive、watch与computed的应用场景与区别是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1bab953e41f66ac53de099fa9fe76483%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1bab953e41f66ac53de099fa9fe76483/" ref="nofollow noopener noreferrer">Vue3中动态样式数组的后项覆盖规则如何与计算属性结合实现复杂状态样式管理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<h4 data-id="heading-3">三、v-show的最佳应用场景</h4>
<p>因为v-show不需要频繁操作DOM（只是改CSS），所以它的<strong>切换成本极低</strong>——适合用来处理“需要频繁显示/隐藏”的元素。比如：</p>
<ul>
<li>导航菜单的展开/收起；</li>
<li>Tab切换的内容面板；</li>
<li>弹窗的显示/隐藏；</li>
<li>表单的错误提示（频繁切换显示）。</li>
</ul>
<p>反过来说，如果元素的显示状态<strong>很少改变</strong>（比如用户权限判断：管理员才能看的按钮），那用v-if更合适——因为v-if会直接不渲染不需要的元素，节省初始渲染成本。</p>
<h4 data-id="heading-4">四、实战示例：用v-show做一个“开关”组件</h4>
<p>我们来写一个最简单的Demo：点击按钮切换一段文本的显示状态。代码用Vue3的<code>&lt;script setup&gt;</code>语法糖（最常用的写法）：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="v-show-demo"&gt;
    &lt;!-- 点击按钮触发toggleShow方法 --&gt;
    &lt;button @click="toggleShow" class="toggle-btn"&gt;
      {{ isShow ? '隐藏文本' : '显示文本' }}
    &lt;/button&gt;
    &lt;!-- 用v-show绑定isShow变量 --&gt;
    &lt;p v-show="isShow" class="text-content"&gt;
      我是被v-show控制的文本~ 点按钮试试！
    &lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 1. 引入Vue的ref函数（用来创建响应式变量）
import { ref } from 'vue'

// 2. 定义响应式变量isShow，初始值为true（文本默认显示）
const isShow = ref(true)

// 3. 定义切换函数：反转isShow的值
const toggleShow = () =&gt; {
  isShow.value = !isShow.value
}
&lt;/script&gt;

&lt;style scoped&gt;
.v-show-demo {
  padding: 20px;
  max-width: 300px;
  margin: 0 auto;
}
.toggle-btn {
  padding: 8px 16px;
  background: #42b983;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.text-content {
  margin-top: 10px;
  padding: 15px;
  background: #f5f5f5;
  border-radius: 4px;
}
&lt;/style&gt;
</code></pre>
<p><strong>代码解释</strong>：</p>
<ol>
<li><code>ref(true)</code>：创建一个响应式变量<code>isShow</code>，初始值为<code>true</code>（文本默认显示）；</li>
<li><code>@click="toggleShow"</code>：点击按钮触发<code>toggleShow</code>方法，反转<code>isShow</code>的值；</li>
<li><code>v-show="isShow"</code>：当<code>isShow</code>为<code>true</code>时，文本显示；为<code>false</code>时，文本隐藏（<code>display: none</code>）。</li>
</ol>
<p>运行这个组件，你会看到：点击按钮时，文本会“瞬间”显示/隐藏——因为只是改了CSS，没有DOM操作，所以切换非常流畅！</p>
<h4 data-id="heading-5">五、课后Quiz：测测你掌握了吗？</h4>
<p><strong>问题</strong>：请说出v-show和v-if的3个核心区别，并分别举一个适合的应用场景。</p>
<p><strong>答案解析</strong>：</p>
<ol>
<li><strong>渲染机制不同</strong>：v-show是修改CSS的display属性（元素始终在DOM中）；v-if是销毁/重建DOM元素（元素可能不在DOM中）。</li>
<li><strong>切换成本不同</strong>：v-show切换成本低（改CSS），适合频繁切换；v-if切换成本高（操作DOM），适合很少切换的场景。</li>
<li><strong>初始渲染成本不同</strong>：v-show初始会渲染所有元素（不管条件真假），初始成本高；v-if只渲染条件为真的元素，初始成本低。</li>
</ol>
<p><strong>应用场景举例</strong>：</p>
<ul>
<li>v-show：导航菜单的展开/收起（频繁切换）；</li>
<li>v-if：管理员专属按钮（只有管理员登录时才渲染，很少切换）。</li>
</ul>
<h4 data-id="heading-6">六、常见报错及解决方案</h4>
<p>在使用v-show时，新手常遇到这3个问题，帮你提前避坑：</p>
<h5 data-id="heading-7">1. 报错：v-show绑定的变量“isShow”未定义</h5>
<p><strong>原因</strong>：没有在<code>&lt;script&gt;</code>中声明<code>isShow</code>变量，或者声明了但不是响应式的。<br/>
<strong>解决</strong>：用<code>ref</code>或<code>reactive</code>定义响应式变量（必须从Vue中引入）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isShow = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>) <span class="hljs-comment">// 正确</span>
</code></pre>
<p><strong>预防</strong>：所有绑定到模板的变量，都要先声明为响应式变量。</p>
<h5 data-id="heading-8">2. 报错：v-show用在<code>&lt;template&gt;</code>标签上无效</h5>
<p><strong>原因</strong>：<code>&lt;template&gt;</code>是Vue的“虚拟容器”，不会被渲染成真实DOM元素——而v-show需要作用于<strong>真实DOM元素</strong>（比如<code>div</code>、<code>p</code>）。<br/>
<strong>解决</strong>：把v-show移到具体的HTML元素上，或者用v-if代替（v-if可以用在<code>&lt;template&gt;</code>上）：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 错误：template上用v-show --&gt;
&lt;template v-show="isShow"&gt;...&lt;/template&gt;

&lt;!-- 正确：用在div上 --&gt;
&lt;div v-show="isShow"&gt;...&lt;/div&gt;

&lt;!-- 或者用v-if在template上 --&gt;
&lt;template v-if="isShow"&gt;...&lt;/template&gt;
</code></pre>
<p><strong>预防</strong>：永远不要在<code>&lt;template&gt;</code>标签上用v-show。</p>
<h5 data-id="heading-9">3. 问题：v-show隐藏的元素还占空间？</h5>
<p><strong>原因</strong>：你可能混淆了<code>display: none</code>和<code>visibility: hidden</code>——<code>display: none</code>会让元素完全不占空间，而<code>visibility: hidden</code>会保留空间。如果元素隐藏后还占空间，大概率是<strong>自己加了<code>visibility</code>样式</strong>，或者元素的父级有固定高度。<br/>
<strong>解决</strong>：检查元素的CSS，确保没有<code>visibility: hidden</code>或<code>opacity: 0</code>的样式（这些会保留空间）；用浏览器的“检查元素”看一下元素的<code>display</code>属性是不是<code>none</code>。</p>
<h4 data-id="heading-10">参考链接</h4>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fconditional.html%23v-show" target="_blank" title="https://vuejs.org/guide/essentials/conditional.html#v-show" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 中 this 的设计哲学与运行机制]]></title>    <link>https://juejin.cn/post/7585686247286128691</link>    <guid>https://juejin.cn/post/7585686247286128691</guid>    <pubDate>2025-12-21T06:30:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247286128691" data-draft-id="7585645111875420187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 中 this 的设计哲学与运行机制"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-21T06:30:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 中 this 的设计哲学与运行机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T06:30:42.000Z" title="Sun Dec 21 2025 06:30:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 的世界里，<code>this</code> 是一个既基础又令人困惑的概念。它不像其他语言中的 <code>this</code> 那样固定指向当前对象实例，而是根据函数的<strong>调用方式</strong>动态决定其指向。这种灵活性赋予了 JavaScript 强大的表达能力，但也带来了不少陷阱。理解 <code>this</code> 的行为逻辑，是掌握 JavaScript 执行机制的关键一步。</p>
<h2 data-id="heading-0">作用域与 this：两种不同的查找机制</h2>
<p>JavaScript 中变量的查找依赖于<strong>词法作用域（Lexical Scope）</strong> 。这意味着，当一个函数内部引用某个变量时，引擎会沿着该函数声明时所处的作用域链向上查找，直到找到该变量或到达全局作用域。这种机制在编译阶段就已确定，与函数如何被调用无关。</p>
<p>然而，<code>this</code> 却是一个例外。它的值<strong>不是由函数定义的位置决定的，而是由函数调用的方式决定的</strong>。换句话说，<code>this</code> 属于<strong>执行上下文</strong>的一部分，只有在函数真正运行时才能确定其指向。这种设计使得 <code>this</code> 具有高度的动态性，但也打破了词法作用域的一致性，成为初学者最容易混淆的点之一。</p>
<h2 data-id="heading-1">this 的四种典型指向场景</h2>
<h3 data-id="heading-2">1. 作为对象方法调用：指向所属对象</h3>
<p>当一个函数作为对象的属性被调用时，<code>this</code> 指向该对象本身。这是最符合直觉的用法，也是面向对象编程中访问实例属性的标准方式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"极客时间"</span>,
  <span class="hljs-attr">showThis</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// "极客时间"</span>
  }
};
myObj.<span class="hljs-title function_">showThis</span>(); <span class="hljs-comment">// this 指向 myObj</span>
</code></pre>
<p>在这个例子中，<code>showThis</code> 是 <code>myObj</code> 的方法，调用时 <code>this</code> 自然指向 <code>myObj</code>，从而可以正确访问其 <code>name</code> 属性。</p>
<h3 data-id="heading-3">2. 作为普通函数调用：指向全局对象（或 undefined）</h3>
<p>如果将同一个函数从对象中“取出”并作为普通函数调用，<code>this</code> 的指向就会发生根本变化：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">foo</span> = myObj.showThis<span class="hljs-comment">;</span>
foo()<span class="hljs-comment">; // this 指向 window（非严格模式）或 undefined（严格模式）</span>
</code></pre>
<p>此时，<code>foo</code> 不再是作为对象方法被调用，而是一个独立的函数。在非严格模式下，JavaScript 会将 <code>this</code> 默认绑定到全局对象（浏览器中为 <code>window</code>）；而在严格模式下，则直接设为 <code>undefined</code>，避免意外污染全局环境。</p>
<p>这种行为源于早期 JavaScript 的设计妥协：为了简化实现，作者让所有未明确绑定的函数默认指向全局对象。虽然方便，却容易导致全局变量污染——尤其是使用 <code>var</code> 声明的变量会自动挂载到 <code>window</code> 上。现代开发中，推荐使用 <code>let/const</code> 和严格模式来规避此类问题。</p>
<h3 data-id="heading-4">3. 显式绑定：call、apply 与 bind</h3>
<p>JavaScript 提供了 <code>call</code>、<code>apply</code> 和 <code>bind</code> 方法，允许开发者<strong>显式指定函数调用时的 <code>this</code> 值</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">function updateName() {
  <span class="hljs-attr">this.myName</span> = <span class="hljs-string">"极客时间"</span><span class="hljs-comment">;</span>
}

const <span class="hljs-attr">bar</span> = { myName: <span class="hljs-string">"极客邦"</span> }<span class="hljs-comment">;</span>
updateName.call(bar)<span class="hljs-comment">;</span>
console.log(bar.myName)<span class="hljs-comment">; // "极客时间"</span>
</code></pre>
<p>通过 <code>call(bar)</code>，我们强制让 <code>updateName</code> 函数在执行时将 <code>this</code> 绑定到 <code>bar</code> 对象上，从而成功修改其属性。这种方式常用于借用方法、实现继承或在回调中保持上下文。</p>
<h3 data-id="heading-5">4. 构造函数调用：指向新创建的实例</h3>
<p>当函数通过 <code>new</code> 关键字调用时，JavaScript 会自动创建一个新对象，并将 <code>this</code> 绑定到该对象上：</p>
<pre><code class="hljs language-ini" lang="ini">function CreateObj() {
  <span class="hljs-attr">this.name</span> = <span class="hljs-string">"新实例"</span><span class="hljs-comment">;</span>
}
const <span class="hljs-attr">obj</span> = new CreateObj()<span class="hljs-comment">;</span>
console.log(obj.name)<span class="hljs-comment">; // "新实例"</span>
</code></pre>
<p>在此过程中，<code>this</code> 指向由构造函数生成的新实例，使得我们可以在构造函数内部初始化实例属性。这也是早期 JavaScript 实现“类”语义的核心机制。</p>
<h2 data-id="heading-6">事件处理中的 this</h2>
<p>在 DOM 事件处理中，<code>this</code> 通常指向触发事件的元素：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"btn"</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 指向 #btn 元素</span>
});
</code></pre>
<p>这是因为事件监听器在被调用时，其上下文被自动绑定到目标元素上。这一特性极大地方便了对触发元素的操作，无需额外查询 DOM。</p>
<h2 data-id="heading-7">自由变量与 this 的对比</h2>
<p>值得注意的是，函数内部对<strong>自由变量</strong>（即非参数、非局部变量，来自外层作用域的变量）的访问，依然遵循词法作用域规则，与 <code>this</code> 无关：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">myName</span> = <span class="hljs-string">'极客邦'</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">bar</span> = {
  myName: "time.geekbang.com",
  printName: function() {
    console.log(myName)<span class="hljs-comment">;        // "极客邦"（来自外层作用域）</span>
    console.log(this.myName)<span class="hljs-comment">;   // 取决于调用方式</span>
  }
}<span class="hljs-comment">;</span>

bar.printName()<span class="hljs-comment">; // this.myName → "time.geekbang.com"</span>
const <span class="hljs-attr">fn</span> = bar.printName<span class="hljs-comment">;</span>
fn()<span class="hljs-comment">;           // this.myName → undefined 或 window.myName（若存在）</span>
</code></pre>
<p>这里，<code>myName</code> 的值始终由声明位置决定，而 <code>this.myName</code> 则随调用方式变化。这清晰地展示了词法作用域与动态 <code>this</code> 之间的根本区别。</p>
<h2 data-id="heading-8">设计反思：灵活还是隐患？</h2>
<p>JavaScript 将 <code>this</code> 的绑定推迟到运行时，确实提供了极大的灵活性——同一个函数可以在不同上下文中复用，实现多态行为。但这种设计也牺牲了可预测性。许多 bug 源于开发者误以为 <code>this</code> 会“记住”定义时的上下文，而实际上它完全取决于调用方式。</p>
<p>正因如此，ES6 引入了箭头函数，其 <code>this</code> <strong>继承自外层词法作用域</strong>，不再受调用方式影响。这在回调、事件处理器等场景中大大减少了 <code>this</code> 绑定错误。但在传统函数中，理解 <code>this</code> 的动态本质仍是必备技能。</p>
<h2 data-id="heading-9">结语</h2>
<p><code>this</code> 是 JavaScript 执行模型中一个独特而关键的概念。它不遵循词法作用域，而是由函数调用方式动态决定，体现了语言“运行时绑定”的哲学。掌握其在不同场景下的指向规则——对象方法、普通函数、显式绑定、构造调用和事件处理——是编写健壮代码的前提。</p>
<p>尽管 <code>this</code> 的设计曾引发争议，但它也成就了 JavaScript 的高度灵活性。只要理解其运行机制，开发者就能驾驭这一特性，构建出既高效又可维护的应用程序。在现代开发中，结合严格模式、箭头函数和模块化思想，我们可以最大限度地发挥 <code>this</code> 的优势，同时规避其潜在风险。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在PySide6/PyQt6的项目中封装一些基础类库，包括文件对话框、字体对话框、颜色对话框、消息对话框等内容]]></title>    <link>https://juejin.cn/post/7585645111875665947</link>    <guid>https://juejin.cn/post/7585645111875665947</guid>    <pubDate>2025-12-21T08:41:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585645111875665947" data-draft-id="7585686247286308915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在PySide6/PyQt6的项目中封装一些基础类库，包括文件对话框、字体对话框、颜色对话框、消息对话框等内容"/> <meta itemprop="keywords" content="前端,PyQt"/> <meta itemprop="datePublished" content="2025-12-21T08:41:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="伍华聪"/> <meta itemprop="url" content="https://juejin.cn/user/122769398839592"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在PySide6/PyQt6的项目中封装一些基础类库，包括文件对话框、字体对话框、颜色对话框、消息对话框等内容
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/122769398839592/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    伍华聪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T08:41:44.000Z" title="Sun Dec 21 2025 08:41:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在我们实际开发项目的时候，有时候为了使用方便，会针对一些常用到的内容进行一定的封装处理，以降低使用的难度和减少相关代码，本篇随笔介绍在PySide6/PyQt6的项目中封装一些基础类库，包括文件对话框、字体对话框、颜色对话框、消息对话框等内容。</p>
<h3 data-id="heading-0">1、常用对话框处理封装的优点</h3>
<p>对常用对话框的调用（包括文件对话框、字体对话框、颜色对话框、消息对话框等内容），可能调用的时候，会遇到一些问题，如对于常用的文件目录对话框，可能会出现下面一些问题：</p>
<ul>
<li>参数顺序难记</li>
<li>单选 / 多选 / 保存 / 目录 API 不统一</li>
<li>最近路径不好维护</li>
<li>每个窗口都写一遍</li>
</ul>
<p>如果对它进行一定的封装，可以实现更多可选参数的设置以及更好的支持：</p>
<p>✅ 打开单文件<br/>
✅ 打开多文件<br/>
✅ 保存文件<br/>
✅ 选择目录<br/>
✅ 文件过滤器常量<br/>
✅ 最近目录记忆（进程级 / 可扩展到配置）<br/>
✅ Windows / macOS / Linux 兼容</p>
<p>如果对这些对话框进行辅助类的统一封装，会具有以下是一些主要的优点：</p>
<p>1）<strong>代码复用</strong></p>
<p>封装常用对话框可以避免重复代码。你可以定义一个统一的函数或类来处理所有常用对话框操作，从而在多个地方复用这段代码。</p>
<p>2）<strong>一致性</strong></p>
<p>通过封装，你可以确保所有常用对话框的外观和行为一致。这有助于提高用户体验，使用户在应用程序中获得统一的交互方式。</p>
<p>3） <strong>简化调用</strong></p>
<p>封装可以简化调用过程。你可以将常用的参数设置（如标题、图标、按钮类型等）预先定义好，从而在调用时减少参数输入。</p>
<p>4）<strong>易于维护</strong></p>
<p>当需要更改对话框的行为或样式时，只需在封装函数中进行修改，而不必在应用程序中的每个调用点进行更改。这使得维护变得更加简单和高效。</p>
<p>5）<strong>增强可读性</strong></p>
<p>通过使用封装的函数或类，代码变得更易读。其他开发者可以一眼看出对话框的作用，而不必深入了解其具体实现。</p>
<p>6）<strong>集中管理</strong></p>
<p>封装有助于集中管理对话框的逻辑，比如处理用户输入、响应用户选择等。这样可以更方便地进行逻辑更新或错误处理。</p>
<p>7） <strong>扩展性</strong></p>
<p>如果将来需要增加新的对话框或修改现有对话框的逻辑，封装使得扩展更加容易。你可以在封装的基础上进行扩展，而不影响现有的代码结构。</p>
<h2 data-id="heading-1">2、文件对话框的封装</h2>
<p>如果我们对文件对话框进行封装，那么需要考虑打开、保存文件对话框等常规操作，而文件的格式有多种多样，我们为了方便，可以提供更细节的函数选择具体的文件，如文本文件、Excel文件等。</p>
<pre><code class="hljs language-ini" lang="ini">class FileDialogUtil:
    """文件、目录对话框工具类"""

    <span class="hljs-comment"># 定义文件过滤器</span>
    <span class="hljs-attr">all_filter</span> = <span class="hljs-string">"All File (*.*);;*.*"</span>
    <span class="hljs-attr">word_filter</span> = <span class="hljs-string">"Word (*.doc);;*.doc;;Word (*.docx);;*.docx;;All File (*.*);;*.*"</span>
    <span class="hljs-attr">excel_filter</span> = <span class="hljs-string">"Excel (*.xls);;*.xls;;Excel (*.xlsx);;*.xlsx;;All File (*.*);;*.*"</span>
    <span class="hljs-attr">pdf_filter</span> = <span class="hljs-string">"PDF (*.pdf);;*.pdf;;All File (*.*);;*.*"</span>
    <span class="hljs-attr">image_filter</span> = <span class="hljs-string">"Image Files (*.BMP;*.bmp;*.JPG;*.jpg;*.GIF;*.gif;*.png;*.PNG);;*.BMP;*.bmp;*.JPG;*.jpg;*.GIF;*.gif;*.png;*.PNG;;All File (*.*);;*.*"</span>
    <span class="hljs-attr">html_filter</span> = <span class="hljs-string">"HTML files (*.html;*.htm);;*.html;*.htm;;All files (*.*);;*.*"</span>
    <span class="hljs-attr">access_filter</span> = <span class="hljs-string">"Access (*.mdb);;*.mdb;;All File (*.*);;*.*"</span>
    <span class="hljs-attr">zip_filter</span> = <span class="hljs-string">"Zip (*.zip);;*.zip;;Rar (*.rar);;*.rar;;All files (*.*);;*.*"</span>
    <span class="hljs-attr">config_filter</span> = <span class="hljs-string">"Configuration Files (*.cfg);;*.cfg;;All File (*.*);;*.*"</span>
    <span class="hljs-attr">txt_filter</span> = <span class="hljs-string">"Text (*.txt);;*.txt;;All files (*.*);;*.*"</span>
    <span class="hljs-attr">xml_filter</span> = <span class="hljs-string">"XML Files (*.xml);;*.xml;;All files (*.*);;*.*"</span>
    <span class="hljs-attr">rar_filter</span> = <span class="hljs-string">"Rar (*.rar);;*.rar;;All files (*.*);;*.*"</span>
    <span class="hljs-attr">sqlite_filter</span> = <span class="hljs-string">"Sqlite Files (*.db);;*.db;;All files (*.*);;*.*"</span>
    <span class="hljs-attr">python_filter</span> = <span class="hljs-string">"Python Files (*.py);;*.py;;All files (*.*);;*.*"</span>
    <span class="hljs-attr">csv_filter</span> = <span class="hljs-string">"CSV Files (*.csv);;*.csv;;All files (*.*);;*.*"</span>

    @staticmethod
    def open_file(
        parent: <span class="hljs-attr">QWidget</span> = None,
        multiple: <span class="hljs-attr">bool</span> = <span class="hljs-literal">False</span>,
        title: <span class="hljs-attr">str</span> = <span class="hljs-string">"打开文件"</span>,
        filter: <span class="hljs-attr">str</span> = all_filter,
        filename: <span class="hljs-attr">str</span> = <span class="hljs-string">""</span>,
        initial_directory: <span class="hljs-attr">str</span> = os.getcwd(),
    ) -&gt; str:
        """
        打开文件对话框

        :param parent: 父窗口
        :param multiple: 是否多选
        :param title: 对话框标题
        :param filename: 默认文件名
        :param filter: 文件过滤器
        :param initial_directory: 默认目录
        :return: 选中的文件路径,如果是多选,则返回以逗号分隔的多个文件路径
        """

        <span class="hljs-comment"># 创建文件对话框</span>
        <span class="hljs-attr">dialog</span> = QFileDialog(parent)
        dialog.setWindowTitle(title)
        dialog.setFileMode(
            QFileDialog.FileMode.ExistingFiles
            if multiple
            else QFileDialog.FileMode.ExistingFile
        )
        dialog.setNameFilter(filter)
        dialog.setDirectory(initial_directory)
        dialog.selectFile(filename)

        <span class="hljs-comment"># 执行对话框并获取文件路径</span>
        <span class="hljs-attr">result</span> = <span class="hljs-string">""</span>
        if dialog.exec():
            if multiple:
                <span class="hljs-attr">file_paths</span> = dialog.selectedFiles()
                <span class="hljs-attr">result</span> = <span class="hljs-string">","</span>.join(file_paths)  <span class="hljs-comment"># 将文件路径连接成一个字符串</span>
            else:
                <span class="hljs-attr">result</span> = dialog.selectedFiles()[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 获取单个文件路径</span>

        return result
</code></pre>
<p>当然上面 open_file 传入的是所有文件的格式，如果我们需要跟进一步选择Excel格式，就需要传入对应的后缀名参数常量即可。如下所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b8643ad9f9e48e59424ee407d29e4d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766911303&amp;x-signature=CtobPYIOX9Cx5ykmqzD1zlkB2aE%3D" alt="image" loading="lazy"/></p>
<p> 而如果要弹出保存文件对话框的操作，那么我们也是如法炮制即可。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save_file</span>(<span class="hljs-params">
        parent: QWidget = <span class="hljs-literal">None</span>,
        title: <span class="hljs-built_in">str</span> = <span class="hljs-string">"保存文件"</span>,
        <span class="hljs-built_in">filter</span>: <span class="hljs-built_in">str</span> = all_filter,
        filename: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>,
        initial_directory: <span class="hljs-built_in">str</span> = os.getcwd(<span class="hljs-params"/>),
    </span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""以指定的标题弹出保存文件对话框

        :param title: 对话框标题
        :param filename: 默认文件名
        :param filter: 文件过滤器
        :param initial_directory: 默认目录
        :return: 选中的文件路径
        """</span>
        <span class="hljs-comment"># 创建保存文件对话框</span>
        dialog = QFileDialog(parent)
        dialog.setWindowTitle(title)
        dialog.setAcceptMode(QFileDialog.AcceptMode.AcceptSave)  <span class="hljs-comment"># 设置为保存模式</span>
        dialog.setNameFilter(<span class="hljs-built_in">filter</span>)
        dialog.setDirectory(initial_directory)
        dialog.selectFile(filename)

        <span class="hljs-comment"># 执行对话框并获取文件路径</span>
        result = <span class="hljs-string">""</span>
        <span class="hljs-keyword">if</span> dialog.<span class="hljs-built_in">exec</span>():
            result = dialog.selectedFiles()[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 获取选中的文件路径</span>

        <span class="hljs-keyword">return</span> result
</code></pre>
<p>其他类型格式的，只需要传入对应的filter格式即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/276db7f69edc4c5ba2d50f45d17318df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766911303&amp;x-signature=05Cn1m6IYPRYyyLsrYcToW1diIA%3D" alt="image" loading="lazy"/></p>
<p> 选择目录也是类似的处理</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_dir</span>(<span class="hljs-params">
        parent: QWidget = <span class="hljs-literal">None</span>,
        title: <span class="hljs-built_in">str</span> = <span class="hljs-string">"选择目录"</span>,
        initial_directory: <span class="hljs-built_in">str</span> = os.getcwd(<span class="hljs-params"/>),
    </span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""显示目录选择对话框"""</span>

        <span class="hljs-comment"># 创建文件对话框</span>
        dialog = QFileDialog(parent)
        dialog.setWindowTitle(title)
        dialog.setFileMode(QFileDialog.FileMode.Directory)  <span class="hljs-comment"># 设置为目录选择模式</span>
        dialog.setOption(QFileDialog.Option.ShowDirsOnly, <span class="hljs-literal">True</span>)  <span class="hljs-comment"># 只显示目录</span>
        dialog.setDirectory(initial_directory)

        <span class="hljs-comment"># 执行对话框并获取选中的目录</span>
        result = <span class="hljs-string">""</span>
        <span class="hljs-keyword">if</span> dialog.<span class="hljs-built_in">exec</span>():
            result = dialog.selectedFiles()[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 获取选中的目录路径</span>

        <span class="hljs-built_in">print</span>(result)
        <span class="hljs-keyword">return</span> result
</code></pre>
<p>选择多个目录，如下效果</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c792726f00e8441dad7a158441b27643~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766911303&amp;x-signature=2bJVuMxUy6sh3IYM1zbIbhmOfBY%3D" alt="image" loading="lazy"/></p>
<p>这样我们在一些窗体上使用保存Excel或者PDF文件的时候，直接使用它的函数调用即可，比较简单了。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">export_to_pdf</span>(<span class="hljs-params">self, setting: PrintSetting</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""将 QTableView 的数据导出为 PDF, 成功返回文件路径，失败返回空字符串"""</span>

        pdf_file = FileDialogUtil.save_pdf(filename=<span class="hljs-string">f"<span class="hljs-subst">{setting.print_title}</span>.pdf"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pdf_file:
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>

        <span class="hljs-comment"># 创建 QPrinter，PDF格式</span>
        printer = QPrinter(QPrinter.PrinterMode.HighResolution)
        printer.setOutputFormat(QPrinter.OutputFormat.PdfFormat)
        printer.setOutputFileName(pdf_file)  <span class="hljs-comment"># 输出 PDF 文件</span>

        <span class="hljs-comment"># 打印的处理</span>
        printer.setPageSize(setting.page_size)
        printer.setPageOrientation(setting.page_orientation)
        self.print_cols = setting.print_cols  <span class="hljs-comment"># 打印指定列的索引列表</span>
        self.print_title = setting.print_title  <span class="hljs-comment"># 打印标题</span>
        self.settings = setting  <span class="hljs-comment"># 保存打印设置</span>

        <span class="hljs-comment"># 打印输出</span>
        self.print_preview_paint(printer)
        <span class="hljs-keyword">return</span> pdf_file
</code></pre>
<h3 data-id="heading-2">3、封装常用消息对话框</h3>
<p>封装的消息提示对话框包括个各种常用的对话框，如下所示：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/732a8aa4343441e5af439703088b3ca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766911303&amp;x-signature=SD%2BynXiW7BcH%2FFcBG5%2BdO01qhG4%3D" alt="" loading="lazy"/></p>
<p>首先我们需要定义一个独立的消息对话框类MessageUtil，如下所示。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageUtil</span>:
    <span class="hljs-string">"""
    封装了常用的消息对话框，以方便使用常用对话框消息。
    包括提示信息、警告信息、错误信息、确认信息、询问信息、输入信息、
    选择信息、多选信息、文件选择信息、目录选择信息、字体选择信息、颜色选择信息、进度条信息等。
    """</span>

    <span class="hljs-comment"># 常用消息对话框的标题</span>
    CAPTION_TIPS = <span class="hljs-string">"提示信息"</span>
    CAPTION_WARNING = <span class="hljs-string">"警告信息"</span>
    CAPTION_ERROR = <span class="hljs-string">"错误信息"</span>
    CAPTION_CONFIRM = <span class="hljs-string">"确认信息"</span>
 
<span class="hljs-meta">   @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">show_message</span>(<span class="hljs-params">
        message: <span class="hljs-built_in">str</span>,
        title: <span class="hljs-built_in">str</span> = CAPTION_TIPS,
        extended_message=<span class="hljs-literal">None</span>,
        parent=<span class="hljs-literal">None</span>,
        icon: QMessageBox.Icon = QMessageBox.Icon.Information,
        buttons: QMessageBox.StandardButton = QMessageBox.StandardButton.Ok,
    </span>) -&gt; QMessageBox.StandardButton:
        <span class="hljs-string">"""
        通用消息框显示函数
        """</span>
        msg_box = QMessageBox(parent)
        msg_box.setWindowTitle(title)
        msg_box.setText(message)

        <span class="hljs-comment"># 设置详细信息，在消息框的底部显示。</span>
        <span class="hljs-keyword">if</span> extended_message:
            <span class="hljs-comment"># 创建 TextSplitter 实例，设置每行最大字符数为 30</span>
            splitter = TextSplitter(max_line_length=<span class="hljs-number">80</span>)
            <span class="hljs-comment"># 使用 splitter 来分割文本</span>
            extended_message = splitter.split(extended_message)
            msg_box.setDetailedText(extended_message)

        msg_box.setDetailedText(extended_message)
        msg_box.setIcon(icon)
        msg_box.setStandardButtons(buttons)
        <span class="hljs-comment"># 设置窗口图标</span>
        app_icon = QIcon(<span class="hljs-string">"app/images/app.ico"</span>)
        msg_box.setWindowIcon(app_icon)
        <span class="hljs-keyword">return</span> msg_box.<span class="hljs-built_in">exec</span>()
</code></pre>
<p>然后统一对常用的消息进行函数封装，如一般消息、警告消息、错误消息，提示消息等，只需要对上面函数的简单调用，传递不同的参数就可以。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca0b204fcb544f4288358778bd9b638c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766911303&amp;x-signature=2%2BiDrhF3proapgi7jYdRxZCevNc%3D" alt="image" loading="lazy"/></p>
<p>有了这样的封装，我们可以在窗体中直接调用，不需要记住太多的参数了，比较简单，如下面的删除操作处理。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">    @asyncSlot()</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">OnDelete</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""弹出删除对话框"""</span>
        selected_rows = self.table_view.selectionModel().selectedRows()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> selected_rows:
            MessageUtil.show_info(<span class="hljs-string">"请选择要操作的行"</span>)
            <span class="hljs-keyword">return</span>
        <span class="hljs-comment"># 确认删除</span>
        result = MessageUtil.show_confirm(<span class="hljs-string">"确认删除选中的行？"</span>, <span class="hljs-string">"确认删除"</span>)
        <span class="hljs-keyword">if</span> result:
            <span class="hljs-comment"># 遍历选定的行，删除主键值对应的记录</span>
            <span class="hljs-built_in">list</span> = []
            <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> selected_rows:
                entity_id = self.table_model.GetPrimaryKeyValue(index.row())
                <span class="hljs-keyword">if</span> entity_id:
                    <span class="hljs-built_in">list</span>.append(entity_id)
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">await</span> self.OnDeleteByIdList(<span class="hljs-built_in">list</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                MessageUtil.show_error(<span class="hljs-string">f"删除失败：<span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<p> 为了了解常用对话框的操作，我们还编写一个简单的测试界面来展示效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee23f9ae1578402abba65769e6e2dde7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766911303&amp;x-signature=QaACROnO4SHCHXKRvxEs4oA%2B%2Fa8%3D" alt="image" loading="lazy"/></p>
<p><strong>字体对话框</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61b34c6d97354371995d85e354d4b2ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766911303&amp;x-signature=R6jfeuCWFx9ClOPmKqt3t8Ulzkc%3D" alt="image" loading="lazy"/></p>
<p>封装字体对话框函数如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">show_font_dialog</span>(<span class="hljs-params">parent=<span class="hljs-literal">None</span>, font=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[QFont, <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        显示字体选择对话框
        :param parent: 父窗口
        :param font: 默认字体，如果没有提供，使用系统默认字体
        :return: 选择的字体，成功时返回 (QFont, True)，失败时返回 (None, False)
        """</span>
        <span class="hljs-comment"># 如果没有提供默认字体，则使用系统默认字体</span>
        <span class="hljs-keyword">if</span> font <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            font = QApplication.font()  <span class="hljs-comment"># 获取系统默认字体</span>

        <span class="hljs-comment"># 打开字体选择对话框</span>
        ok, selected_font = QFontDialog.getFont(font, parent)

        <span class="hljs-comment"># 返回选择的字体和是否成功</span>
        <span class="hljs-keyword">return</span> selected_font, ok
</code></pre>
<p>调用代码如下所示。</p>
<pre><code class="hljs language-ruby" lang="ruby">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_select_font</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        myfont = <span class="hljs-variable language_">self</span>.message.font()  <span class="hljs-comment"># 获取当前字体</span>
        font_data = <span class="hljs-title class_">MessageUtil</span>.show_font_dialog(<span class="hljs-variable language_">self</span>, myfont)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 打开字体选择对话框</span>
        <span class="hljs-keyword">if</span> <span class="hljs-symbol">font_data:</span>
            <span class="hljs-variable language_">self</span>.message.setFont(
                <span class="hljs-title class_">QFont</span>(font_data.family(), font_data.pointSize())
            )  <span class="hljs-comment"># 设置字体</span>
            <span class="hljs-variable language_">self</span>.message.update()  <span class="hljs-comment"># 刷新显示</span>
</code></pre>
<p><strong>颜色对话框</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6bcfccaa0434e62b83f92f1a0a806e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766911303&amp;x-signature=55gWJpNVgw%2BIRTL3sVBDyGrB9Ic%3D" alt="image" loading="lazy"/></p>
<p>封装颜色对话框函数如下：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">show_colour_dialog</span>(<span class="hljs-params">parent=<span class="hljs-literal">None</span>, colour=<span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[QColor, <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        显示颜色选择对话框
        :param parent: 父窗口
        :param colour: 默认颜色，如果没有提供，使用黑色
        :return: 选择的颜色，成功时返回 (QColor, True)，失败时返回 (None, False)
        """</span>
        <span class="hljs-comment"># 如果没有提供默认颜色，则使用黑色</span>
        <span class="hljs-keyword">if</span> colour <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            colour = QColor(Qt.GlobalColor.black)

        <span class="hljs-comment"># 打开颜色选择对话框</span>
        selected_colour = QColorDialog.getColor(colour, parent)

        <span class="hljs-comment"># 返回选择的颜色和是否成功</span>
        <span class="hljs-keyword">return</span> selected_colour, selected_colour.isValid()
</code></pre>
<p>调用代码如下所示。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_select_colour</span>(<span class="hljs-params">self</span>):
        color = self.message.palette().color(QPalette.ColorRole.WindowText)
        color_data = MessageUtil.show_colour_dialog(self, color)[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">if</span> color_data:
            self.message.setStyleSheet(<span class="hljs-string">f"color: <span class="hljs-subst">{color_data.name()}</span>;"</span>)
            self.message.update()  <span class="hljs-comment"># 刷新显示</span>
</code></pre>
<p>通过上面的简单封装，我们就可以很容易的记得相关的处理函数，并且尽可能的减少了相关的参数传递，这样我们在使用的时候，更加方便灵活了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[也是吃上细糠了。用上了Claude Code的无限中转API]]></title>    <link>https://juejin.cn/post/7585693761532575778</link>    <guid>https://juejin.cn/post/7585693761532575778</guid>    <pubDate>2025-12-21T08:58:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585693761532575778" data-draft-id="7585574047075450880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="也是吃上细糠了。用上了Claude Code的无限中转API"/> <meta itemprop="keywords" content="Cursor,AI编程,Claude"/> <meta itemprop="datePublished" content="2025-12-21T08:58:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="极客密码"/> <meta itemprop="url" content="https://juejin.cn/user/976022055165608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            也是吃上细糠了。用上了Claude Code的无限中转API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022055165608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    极客密码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T08:58:54.000Z" title="Sun Dec 21 2025 08:58:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>从 <code>Cursor</code> 切换到 <code>Claude Code</code> 一段时间了</p>
<p>搭配 <code>Claude Code for Vs Code</code> 插件使用 非常丝滑</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5a3eecbd96c4fcebc64897fbd7aa639~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766912334&amp;x-signature=h30w%2Byyqc7SHlDFV1468PtO3kLc%3D" alt="插件" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8af5f4438c8946ca93b6cdd3970d2b15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766912334&amp;x-signature=lDQ4M0kObyMWs3BZQi5vBcpXVXE%3D" alt="插件主界面" loading="lazy"/></p>
<p>除了没有 <code>Tab Completions</code> 之外，其他体验相较于 Cursor 几乎没有差别</p>
<h3 data-id="heading-1">用 Claude Code 做了什么</h3>
<p>期间用它 VibeCoding 了一个应用   <a href="https://link.juejin.cn?target=https%3A%2F%2Fecharts.me" target="_blank" title="https://echarts.me" ref="nofollow noopener noreferrer">echarts.me</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3584a4e4a7fa4592990392fdf44f3c7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766912334&amp;x-signature=ybMexHeeTVHiKP70S5AJvr3UpCU%3D" alt="Echarts.Me" loading="lazy"/></p>
<p>这是一个用自然语言描述生成图表的应用，后续会写一篇文章单独介绍它</p>
<p>也写了一个 <code>Claude Code</code> 的 API 商家快速切换的 Cli 工具:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40claude-cli%2Fccs" target="_blank" title="https://www.npmjs.com/package/@claude-cli/ccs" ref="nofollow noopener noreferrer">www.npmjs.com/package/@cl…</a></p>
<p>当然，正常工作中也解决了不少的问题</p>
<h3 data-id="heading-2">地址呢？上链接！</h3>
<p>这就贴上链接哈，我用的是这家中转 API</p>
<p>因为他们家有付费用户，所以稳定性非常有保障，这么多天用下来的体验就是：<code>模型很强，API很稳，响应很快</code></p>
<p><code>https://api.code-relay.com/register?aff=seMc</code></p>
<p>【用上面的链接注册赠送 30 刀额度，日常使用两个礼拜应该是够的】</p>
<p>同时，他们家与官方的 API 价格相比，也非常便宜，贴个图感受一下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f3ebaf898974bac9acaa1141f227659~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766912334&amp;x-signature=TTCXvYka94qjcs8c73TECek5B3c%3D" alt="价格" loading="lazy"/></p>
<p>再说回标题白嫖的事儿，其实通过邀请链接注册除了给被邀请的新用户赠送的 30 刀，还会给邀请人赠送 25 刀额度</p>
<p>所以，理论上来说，就是无限白嫖！</p>
<p>嗯，怎么能不算呢？？？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app，你的最佳vibe coding搭子]]></title>    <link>https://juejin.cn/post/7585758163435192326</link>    <guid>https://juejin.cn/post/7585758163435192326</guid>    <pubDate>2025-12-21T07:30:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585758163435192326" data-draft-id="7585758163435175942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app，你的最佳vibe coding搭子"/> <meta itemprop="keywords" content="uni-app,VibeCoding"/> <meta itemprop="datePublished" content="2025-12-21T07:30:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CHB"/> <meta itemprop="url" content="https://juejin.cn/user/3298190613284270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app，你的最佳vibe coding搭子
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3298190613284270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CHB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T07:30:29.000Z" title="Sun Dec 21 2025 07:30:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI写代码的能力，在飞速发展。</p>
<p>上半年，还感慨于AI在IDE里猜你要写的代码越来越准，下半年突然发现没必要让AI猜了，AI Chat已经可以vibe coding了。</p>
<p>只要把需求给AI写清楚，好的AI已经可以搞定常规业务代码了，尤其是web平台。一些库的翻译、胶水代码生成，也特别的方便。</p>
<ul>
<li>略懂技术的产品经理和运营，现在可以完成简单应用了。</li>
<li>只懂1门技术的工程师，现在可以变成全栈了。</li>
</ul>
<p>当然在vibe coding这个新时代，开发者们有了新的痛点，需要新的解决方案。</p>
<h2 data-id="heading-0">1、虽然90%可以vibe，剩下的10%会卡你商用</h2>
<p>vibe coding就是你无需关注代码写的具体是什么，你写需求指挥AI就好了。</p>
<p>在做原型时，这几乎没有问题了。</p>
<p>但如果真的要商用上线一个应用，你会在和AI交锋数轮仍不达预期后，明白一个道理，还是得能看懂AI写的代码。</p>
<p>这时技术栈的重要性就体现出来了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27bfc655242e46b68cc551bf19ba8028~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0hC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766907029&amp;x-signature=hHp8SmJFMVUwd82etN4KvFEYQsw%3D" alt="image.png" loading="lazy"/></p>
<p>如果当初开始vibe coding时，不指定技术栈，AI高概率会给你生成基于react框架的代码，或者做App的话使用各平台的原生编程语言。</p>
<p>因为在美国那边，最流行的框架确实是react，而不是易用性更高的vue。</p>
<p>但学习react需要更高的门槛，招聘相应的维护工程师也更昂贵。在中国更广泛的是vue。</p>
<p>如果在做app时，ai给你生成了各个平台的原生语言，那学习和维护更是噩梦。</p>
<p>所以，uni-app的易用性、多端1套代码的优势就非常明显了。</p>
<p>你只需要了解最简单的编程语言js、最简单的响应式框架vue，就能搞定那AI搞不定的10%。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/535526844fda427dba6a8d48fc824954~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0hC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766907029&amp;x-signature=9pQ1D3CCLCrNQXoK2UunlBU%2F6YE%3D" alt="uni-multiply.png" loading="lazy"/></p>
<h2 data-id="heading-1">2、虽然代码可以让AI生成，但服务器部署运维会卡你商用</h2>
<p>当你兴奋地用AI写好代码后，突然发现自己不懂服务器。怎么购买？怎么部署？怎么运维？数据量上来后怎么扩容？被攻击时怎么防护？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0e4782041a4cc0b2e75bb2021d8263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0hC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766907029&amp;x-signature=VaHLggp08Ic45ru0L6xNIgAzRU0%3D" alt="image.png" loading="lazy"/></p>
<p>其实uniCloud就是专门解决这类问题的。uniCloud是一个基于js的serverless云服务，让云资源像用电一样方便，它自动处理伸缩扩容、自动处理安全防护。它是无可争议的最简单的云资源使用方案。</p>
<p>但是如果在开始vibe coding时没选好技术栈，AI写下了php、java等服务器代码，那你在学习掌握和运维方面都会头疼。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1f9572958bf4a0197a0a0d28ab7923e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0hC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766907029&amp;x-signature=lyGxHx%2FMFiGXBT0cdtN%2BorLFpqI%3D" alt="image.png" loading="lazy"/></p>
<p>而uni-app 和 uniCloud，互相搭配效果更佳。一门js语言，解决全部客户端，以及服务器。</p>
<p>所以vibe coding的时候，一定要记得先告诉AI：客户端框架选用uni-app，服务器框架选用uniCloud。</p>
<h2 data-id="heading-2">2、鸿蒙App的开发好伴侣</h2>
<p>鸿蒙App使用ArkTS开发，而国外优秀的AI Coding工具，都不太擅长鸿蒙开发。</p>
<p>但每个AI，都擅长uni-app开发。而uni-app可以一套代码直接编译到鸿蒙。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a168b98095a4252ac0e6daf22158bd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0hC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766907029&amp;x-signature=75MXN%2Fr0%2BK8zeAO6BNWsL%2BI1HUs%3D" alt="image" loading="lazy"/></p>
<p>这导致一个有趣的现象，uni-app成为了鸿蒙的AI开发最佳伴侣。实际上，鸿蒙应用商店中，uni-app已经成为贡献应用数量最多的跨平台开发框架。</p>
<h2 data-id="heading-3">4、全流程AI自动化</h2>
<p>AI写好代码，能自动运行、提取手机日志、查报错、然后自修复吗？</p>
<p>AI能自动写自动化测试脚本并执行吗？</p>
<p>这些高自动化场景，uni-app 已通过丰富的 MCP 协议与 CLI 命令实现 — AI 可直接调用，全流程无需手动介入。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25cf2ac8b72142b88ef293de2be6e5e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ0hC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766907029&amp;x-signature=vKKGhM%2BFuXjpPUUEGxc0nrY%2BNcw%3D" alt="image.png" loading="lazy"/></p>
<p>过去，大量开发者陷入低效开发循环：频繁在IDE、浏览器控制台、AI工具间切换，重复执行“改代码→查日志→粘贴至AI”的机械操作，既枯燥又极度耗时！</p>
<p>如今，HBuilderX CLI 彻底终结这一低效模式：日志自动提取和分析，AI实时掌握项目全量上下文，开发迭代效率直接翻倍！</p>
<p>尤其是在uts开发中，由于强类型约束造成很多历史代码无法通过编译。</p>
<p>有了全自动，就可以让AI来把传统的js/ts 代码转换为uts代码了。</p>
<h3 data-id="heading-4">自动分析日志、自动修复报错</h3>
<ol>
<li>
<p>在HBuilderX中新建uni-app项目</p>
</li>
<li>
<p>将项目先运行起来，比如运行到浏览器、小程序或App</p>
</li>
<li>
<p>在项目根目录启动AI交互终端，确保AI可获取项目全量上下文；</p>
</li>
<li>
<p>向AI发送指令，完成Web端功能开发与日志校验，例如：</p>
</li>
</ol>
<pre><code class="hljs language-shell" lang="shell">请在 /pages/index/index.vue 实现商品列表功能，
完成后执行HBuilderX CLI命令获取日志， 
`C:\hbuilderx\hx_alpha\cli.exe logcat web --browser Chrome --project yourprojectname`。
若检测到日志报错，请根据报错自动修复，
修复后重新读取日志，循环迭代优化直至没有报错。
</code></pre>
<p>以上cli命令的用法详见教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhx.dcloud.net.cn%2Fcli%2Flogcat-web" target="_blank" title="https://hx.dcloud.net.cn/cli/logcat-web" ref="nofollow noopener noreferrer">hx.dcloud.net.cn/cli/logcat-…</a></p>
<p>实际开发中，可以把各种运行命令整理到package.json中，</p>
<p>在uts开发中，自修复这个功能尤其方便。</p>
<p>把uts和ts的几十条差异发给AI，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.dcloud.net.cn%2Funi-app-x%2Futs%2Futs_diff_ts.html" target="_blank" title="https://doc.dcloud.net.cn/uni-app-x/uts/uts_diff_ts.html" ref="nofollow noopener noreferrer">doc.dcloud.net.cn/uni-app-x/u…</a>；然后让AI自动提取Android平台的日志进行自修复。你就可以喝着咖啡坐等AI把js/ts转换为uts了。</p>
<h3 data-id="heading-5">截图对比与自动化测试</h3>
<p>若仅靠日志无法定位界面问题，可通过“uni-app自动化测试插件”实现截图对比与全量测试：</p>
<ol>
<li>
<p>插件安装：在插件市场搜索“uni-app自动化测试插件”，点击导入即可完成安装；</p>
</li>
<li>
<p>向AI发送指令：</p>
</li>
</ol>
<pre><code class="hljs language-shell" lang="shell">请基于以下规范，实现测试用例自动生成、Web/Android/iOS多端测试执行，
并支持全流程迭代优化——测试后自动返回含未通过用例标注的报告，
持续优化代码直至所有用例全部通过：
1. 页面深度分析：
   精准提取组件/事件、交互流程、API调用逻辑及输入输出关键节点；
2. 全面测试用例生成：
   覆盖功能测试、渲染效果验证、API接口测试、边界场景验证及页面跳转逻辑测试；
3. 标准化执行规范：
   测试文件统一命名为 *.test.js（需与对应页面文件同级存放），严格遵循Jest语法规范，确保各测试用例相互独立、无依赖；
4. 多端测试运行命令：
   - Web端测试：npm run test:web -- --browser 浏览器名；
   - Android端测试：npm run test:app-android；
   - iOS端测试：npm run test:app-ios
</code></pre>
<p>无需手动编写测试用例、反复调试代码！用AI实现跨端测试全自动化，将精力聚焦核心功能开发，让跨端测试高效又省心，即刻体验！</p>
<h2 data-id="heading-6">5、总结：</h2>
<p>AI是高效的“代码生成器”，但不是“多端开发解决方案”。不应该用AI把ts代码编译为js，因为ts编译器才是专业稳定做这事的角色。</p>
<p>AI的智能搭配专业跨平台工具，才能最大化开发者的投入产出比。</p>
<p>uni-app 和 uniCloud，会成为你vibe coding的最佳伙伴。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty + Sa-Token 实现 WebSocket 握手认证]]></title>    <link>https://juejin.cn/post/7585490245006950406</link>    <guid>https://juejin.cn/post/7585490245006950406</guid>    <pubDate>2025-12-21T03:14:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585490245006950406" data-draft-id="7585490245006934022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty + Sa-Token 实现 WebSocket 握手认证"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-21T03:14:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Charlie_Byte"/> <meta itemprop="url" content="https://juejin.cn/user/1968540037686224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty + Sa-Token 实现 WebSocket 握手认证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1968540037686224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Charlie_Byte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T03:14:23.000Z" title="Sun Dec 21 2025 03:14:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">认证时机：HTTP 握手阶段</h2>
<p>首先了解，WebSocket 连接建立前，客户端会先发起一个 <strong>HTTP Upgrade 请求</strong>（握手）。此时连接仍是 HTTP 协议，可以携带 Cookie、Header 或 Query 参数。</p>
<blockquote>
<p>关键点来了：<strong>认证可以在这一步搞定</strong>！<br/>
一旦握手成功、协议升级成 WebSocket，后面就没法再用 HTTP 那套鉴权方式了。所以可以就得趁这个“窗口期”，把身份验证拦下来处理。</p>
</blockquote>
<p>本文正是利用这一点，完成拦截并验证握手请求。</p>
<h2 data-id="heading-1">核心逻辑解析</h2>
<h3 data-id="heading-2">拦截 FullHttpRequest</h3>
<p>Netty 是事件驱动的，所有进来的数据都走 <code>channelRead</code>。但我们只关心完整的 HTTP 请求（<code>FullHttpRequest</code>），别的比如字节流、WebSocket 帧啥的，直接往后传就行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (!(object <span class="hljs-keyword">instanceof</span> FullHttpRequest req)) {
    ctx.fireChannelRead(object);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<h3 data-id="heading-3">从 URI 中提取 Token</h3>
<p>前端一般会把 Token 放在查询参数里，比如：</p>
<pre><code class="hljs language-text" lang="text">GET /ws?token=abc123xyz HTTP/1.1
</code></pre>
<p>我们用 Hutool 的 <code>UrlBuilder</code> 轻松解析出来，但如果没传或者传了个空的，那就直接拒绝。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> Optional.of(UrlBuilder.ofHttp(uri))
        .map(UrlBuilder::getQuery)
        .map(query -&gt; query.get(<span class="hljs-string">"token"</span>))
        .map(CharSequence::toString)
        .filter(StrUtil::isNotBlank)
        .orElse(<span class="hljs-literal">null</span>);
</code></pre>
<h3 data-id="heading-4">用 Sa-Token 验证 Token，并绑定用户</h3>
<p>假设你已经配好了 Sa-Token，用户登录后调过 <code>login</code> 方法，那现在就可以反查：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> (String) StpUtil.getLoginIdByToken(token);
</code></pre>
<p>如果 Token 无效或过期，Sa-Token 会抛出 <code>NotLoginException</code>。此时我们返回 <code>401 Unauthorized</code>，顺便关掉连接。</p>
<p>要是验证通过了，就把用户 ID 存到当前 Netty Channel 的属性里，这样后面处理消息的时候，随便哪个 Handler 都能拿，这就实现了“一次认证，全程可用”。</p>
<pre><code class="hljs language-java" lang="java">ctx.channel().attr(USER_ID_ATTR).set(userId);
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> ctx.channel().attr(WsAuthHandshakeHandler.USER_ID_ATTR).get();
</code></pre>
<h3 data-id="heading-5">清理 URI 查询参数</h3>
<p>WebSocket 协议有个小讲究：Upgrade 请求的路径最好干净点，别带 query string。比如 <code>/ws?token=xxx</code> 应该变成 <code>/ws</code>。</p>
<p>为啥？因为后面的 <code>WebSocketServerProtocolHandler</code> 是靠路径匹配的，带参数可能匹配不上。</p>
<p>所以我们认证完就清理一下，确保后续 <code>WebSocketServerProtocolHandler</code> 能正确匹配路由</p>
<pre><code class="hljs language-java" lang="java">req.setUri(UrlBuilder.ofHttp(req.uri()).getPath().toString());
</code></pre>
<h3 data-id="heading-6">Apifox 测试 WebSocket</h3>
<p>想看看效果？可以用 Apifox 模拟 WebSocket 连接。</p>
<p><strong>获取有效 Token</strong></p>
<p>先调用你系统中 Sa-Token 的登录接口，获得返回后的 Token 值，例如：</p>
<pre><code class="hljs language-text" lang="text">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.xxxx
</code></pre>
<p><strong>新建 WebSocket 请求</strong></p>
<p>在 Apifox 中点击新建请求 → 选择协议类型为 WebSocket，输入 WebSocket 地址：</p>
<pre><code class="hljs language-text" lang="text">ws://localhost:8934/im?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.xxxxx
</code></pre>
<p><strong>测试场景一：不带 Token</strong></p>
<p>在未携带 Token 的情况下尝试建立 WebSocket 连接，看是否能够正常连接：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66ac4c3782844dc7b23e67a197ef9535~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZV9CeXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766892007&amp;x-signature=wIKEP5JZONfG1%2FdM7AJtfkkIvDI%3D" alt="Pasted image 20251221104621.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44825e5ce7e74d18acbda4562e691f4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZV9CeXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766892007&amp;x-signature=lqvPt%2FocBHhCvyQN0x%2FTzqe2l6A%3D" alt="Pasted image 20251221104641.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66ec63dfebcb401ab0e138fcd9b32a3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZV9CeXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766892007&amp;x-signature=HZBweaoN33Sxj2iDFObFHZhxOuY%3D" alt="Pasted image 20251221104659.png" loading="lazy"/></p>
<p><strong>测试场景二：带上有效 Token</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03be29299f48499ca3626668071849dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZV9CeXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766892007&amp;x-signature=rILCUHqnmK91zMeNUCUcQuN%2BgNQ%3D" alt="Pasted image 20251221104737.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c285eb599e604e6089578442a8dc47f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZV9CeXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766892007&amp;x-signature=oejdxDJB8jSs5iVk4LdLNuwWo2s%3D" alt="Pasted image 20251221105032.png" loading="lazy"/></p>
<h2 data-id="heading-7">完整代码</h2>
<blockquote>
<p>带注释，放心抄</p>
</blockquote>
<h3 data-id="heading-8">WsAuthHandshakeHandler.java</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> io.jiangbyte.app.handler;

<span class="hljs-keyword">import</span> cn.dev33.satoken.exception.NotLoginException;
<span class="hljs-keyword">import</span> cn.dev33.satoken.stp.StpUtil;
<span class="hljs-keyword">import</span> cn.hutool.core.net.url.UrlBuilder;
<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> io.jiangbyte.app.constant.ChannelAttrKey;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;
<span class="hljs-keyword">import</span> io.netty.handler.codec.http.*;
<span class="hljs-keyword">import</span> io.netty.util.AttributeKey;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Scope;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span> Charlie
 * <span class="hljs-doctag">@version</span> v1.0
 * <span class="hljs-doctag">@date</span> 19/12/2025
 * <span class="hljs-doctag">@description</span> WebSocket 握手认证处理器
 * 在 WebSocket 协议升级前（即 HTTP 握手阶段），验证客户端携带的 token 是否合法
 * 并将认证通过的用户 ID 绑定到当前 Channel 上，供后续 WebSocket 通信使用
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WsAuthHandshakeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-comment">// 定义一个 AttributeKey，用于在 Netty Channel 上存储用户 ID</span>
    <span class="hljs-comment">// 后续的 Handler 或业务逻辑可以通过 ctx.channel().attr(USER_ID_ATTR).get() 获取用户身份</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AttributeKey&lt;String&gt; USER_ID_ATTR = AttributeKey.valueOf(<span class="hljs-string">"USER_ID"</span>);


    <span class="hljs-comment">/**
     * 重写 ChannelInboundHandlerAdapter 的 channelRead 方法
     * 处理入站的 HTTP 请求（WebSocket 握手请求）
     *
     * <span class="hljs-doctag">@param</span> ctx    Channel 上下文，用于操作 Channel（如写回响应、关闭连接等）
     * <span class="hljs-doctag">@param</span> object 入站的数据对象
     * <span class="hljs-doctag">@throws</span> Exception 抛出异常时 Netty 会触发异常处理流程
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object object)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 判断接收到的对象是否是 FullHttpRequest（完整的 HTTP 请求）</span>
        <span class="hljs-comment">// 如果不是，则直接传递给下一个 Handler 处理</span>
        <span class="hljs-keyword">if</span> (!(object <span class="hljs-keyword">instanceof</span> FullHttpRequest req)) {
            ctx.fireChannelRead(object); <span class="hljs-comment">// 继续向后传递事件</span>
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 获取请求的完整 URI（包含路径和查询参数，如 /ws?token=abc123）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> req.uri();
        <span class="hljs-comment">// 获取客户端的远程地址（IP:Port），若无法获取则默认为 "unknown"</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">remoteAddr</span> <span class="hljs-operator">=</span> Optional.ofNullable(ctx.channel().remoteAddress()).map(Object::toString).orElse(<span class="hljs-string">"unknown"</span>);

        <span class="hljs-comment">// 从 URI 中提取 token 参数：</span>
        <span class="hljs-comment">// 1. 使用 Hutool 的 UrlBuilder 解析 HTTP URL</span>
        <span class="hljs-comment">// 2. 获取查询参数（query string）</span>
        <span class="hljs-comment">// 3. 从中取出 "token" 参数值</span>
        <span class="hljs-comment">// 4. 转为字符串并过滤掉空白值</span>
        <span class="hljs-comment">// 5. 若不存在有效 token，则返回 null</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> Optional.of(UrlBuilder.ofHttp(uri))
                .map(UrlBuilder::getQuery)          <span class="hljs-comment">// 获取 Query 对象</span>
                .map(query -&gt; query.get(<span class="hljs-string">"token"</span>))   <span class="hljs-comment">// 获取 token 参数值（可能为 null）</span>
                .map(CharSequence::toString)        <span class="hljs-comment">// 转为 String</span>
                .filter(StrUtil::isNotBlank)        <span class="hljs-comment">// 过滤掉 null 或空白字符串</span>
                .orElse(<span class="hljs-literal">null</span>);

        <span class="hljs-comment">// 如果 token 为空或空白，记录警告日志并返回 401 未授权响应</span>
        <span class="hljs-keyword">if</span> (StrUtil.isBlank(token)) {
            log.warn(<span class="hljs-string">"ws_auth_fail reason='missing_token' remote_addr={} uri={}"</span>, mask(remoteAddr), mask(uri));
            unauthorized(ctx);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用 Sa-Token 根据 token 获取对应的登录用户 ID</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> (String) StpUtil.getLoginIdByToken(token);

            log.info(<span class="hljs-string">"ws_auth_success user_id={} token_prefix={} remote_addr={} uri={}"</span>, userId, mask(token), mask(remoteAddr), mask(uri));

            <span class="hljs-comment">// 将用户 ID 绑定到当前 Channel 的属性中，供后续 Handler 使用</span>
            ctx.channel().attr(USER_ID_ATTR).set(userId);

            <span class="hljs-comment">// 清除 URI 中的查询参数（只保留路径），因为 WebSocket 协议升级时不需要 query string</span>
            <span class="hljs-comment">// eg：/ws?token=abc → /ws</span>
            req.setUri(UrlBuilder.ofHttp(req.uri()).getPath().toString());
        } <span class="hljs-keyword">catch</span> (NotLoginException e) {
            <span class="hljs-comment">// 如果 token 无效、过期或不存在，Sa-Token 会抛出 NotLoginException</span>
            log.warn(<span class="hljs-string">"ws_auth_fail reason='invalid_or_expired_token' remote_addr={} uri={}"</span>, mask(remoteAddr), mask(uri));
            unauthorized(ctx);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 认证通过，继续将请求传递给下一个 Handler（通常是 WebSocketServerProtocolHandler）</span>
        ctx.fireChannelRead(object);
    }

    <span class="hljs-comment">/**
     * 对 token 进行脱敏处理，防止敏感信息泄露到日志中
     * 规则：保留前6个字符，其余用 "***" 替代
     *
     * <span class="hljs-doctag">@param</span> token 原始 token 字符串
     * <span class="hljs-doctag">@return</span> 脱敏后的字符串，如 "abc123***"
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">mask</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-comment">// 如果 token 为 null 或长度 ≤6，直接返回（null 返回 "null" 字符串，避免 NPE）</span>
        <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span> || token.length() &lt;= <span class="hljs-number">6</span>) {
            <span class="hljs-keyword">return</span> StrUtil.isBlank(token) ? <span class="hljs-string">"null"</span> : token;
        }
        <span class="hljs-comment">// 截取前6位 + "***"</span>
        <span class="hljs-keyword">return</span> token.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) + <span class="hljs-string">"***"</span>;
    }

    <span class="hljs-comment">/**
     * 向客户端发送 HTTP 401 Unauthorized 响应，并关闭连接
     *
     * <span class="hljs-doctag">@param</span> ctx Channel 上下文
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unauthorized</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> {
        <span class="hljs-comment">// 创建一个 HTTP/1.1 401 响应，body 为空</span>
        <span class="hljs-type">FullHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.UNAUTHORIZED);
        <span class="hljs-comment">// 设置响应头：Content-Length 为 0，Connection 为 close（立即关闭连接）</span>
        response.headers()
                .setInt(HttpHeaderNames.CONTENT_LENGTH, <span class="hljs-number">0</span>)
                .set(HttpHeaderNames.CONNECTION, <span class="hljs-string">"close"</span>);
        <span class="hljs-comment">// 将响应写入并刷出到客户端，完成后关闭 Channel</span>
        ctx.writeAndFlush(response).addListener(future -&gt; ctx.channel().close());
    }
}

</code></pre>
<h3 data-id="heading-9">Netty 服务端配置（关键部分）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">bootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
bootstrap.group(bossGroup, workerGroup)
		.channel(NioServerSocketChannel.class)
		.childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;Channel&gt;() {
			<span class="hljs-meta">@Override</span>
			<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(Channel ch)</span> {
				<span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
				p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IdleStateHandler</span>(<span class="hljs-number">60</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
				p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpServerCodec</span>());
				p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChunkedWriteHandler</span>());
				p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpObjectAggregator</span>(<span class="hljs-number">65535</span>));

				<span class="hljs-comment">// 认证拦截器放这儿！</span>
				p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WsAuthHandshakeHandler</span>());

				<span class="hljs-comment">// WebSocket 协议升级处理器：</span>
				<span class="hljs-comment">// - 路径为 "/im"</span>
				<span class="hljs-comment">// - 子协议为 null（不指定）</span>
				<span class="hljs-comment">// - 允许发送 Ping/Pong 心跳帧（true）</span>
				p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketServerProtocolHandler</span>(props.getWs().getPath(), <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>));

				<span class="hljs-comment">// ...</span>
			}
		})
		.option(ChannelOption.SO_BACKLOG, <span class="hljs-number">128</span>)
		.childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-literal">true</span>);
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Java注解、反射与动态代理：打造简易ORM框架]]></title>    <link>https://juejin.cn/post/7585686247285882931</link>    <guid>https://juejin.cn/post/7585686247285882931</guid>    <pubDate>2025-12-21T03:35:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247285882931" data-draft-id="7585743487258083337" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Java注解、反射与动态代理：打造简易ORM框架"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-21T03:35:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="别NULL了"/> <meta itemprop="url" content="https://juejin.cn/user/747323639993624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Java注解、反射与动态代理：打造简易ORM框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639993624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    别NULL了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T03:35:55.000Z" title="Sun Dec 21 2025 03:35:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Java开发中，ORM（对象关系映射）框架早已成为标配，像MyBatis、Hibernate这类成熟框架，极大地简化了数据库操作，让我们无需手动编写繁琐的SQL语句。本文将从零开始，基于Java注解、反射和动态代理三大核心技术，实现一个具备基础CRUD功能的简易ORM框架（miniorm）。</p>
<h2 data-id="heading-0">一、ORM核心原理初探</h2>
<p>ORM的核心思想是建立Java实体类与数据库表之间的映射关系，通过操作实体类来间接操作数据库。其底层依赖三大关键技术：</p>
<ul>
<li>
<p><strong>注解</strong>：用于标记实体类与表、字段与列、主键等映射关系，是ORM框架的“配置契约”。</p>
</li>
<li>
<p><strong>反射</strong>：通过反射解析实体类上的注解信息，获取类名、字段名、字段值等，为SQL生成提供数据支撑。</p>
</li>
<li>
<p><strong>动态代理</strong>：拦截DAO层接口的方法调用，自动生成并执行对应的SQL语句，实现“无实现类却能执行数据库操作”的魔法。</p>
</li>
</ul>
<p>miniorm框架将围绕这三大技术，实现“实体类注解映射-自动生成SQL-动态执行数据库操作”的完整链路，支持基础的插入、查询（主键）、更新、删除功能。</p>
<h2 data-id="heading-1">二、miniorm框架设计与实现</h2>
<h3 data-id="heading-2">2.1 项目结构规划</h3>
<p>先梳理清晰的项目结构，确保代码分层合理、职责明确：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f88f7f69fe1c42a295b1c2f29ae94f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YirTlVMTOS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766892955&amp;x-signature=qeUW%2FZR0UrCuULcHYYj5n4KZzjM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 第一步：定义核心注解（映射契约）</h3>
<p>我们需要3个核心注解，分别用于标记实体类与表、主键字段、普通字段与列的映射关系。注解的保留策略必须为<code>RUNTIME</code>，确保运行时能通过反射获取。</p>
<h4 data-id="heading-4">2.2.1 @Entity：实体类与表映射</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 标记实体类与数据库表的映射关系，可指定表名（默认用类名）
 */</span>
<span class="hljs-meta">@Target(ElementType.TYPE)</span>  <span class="hljs-comment">// 仅作用于类</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>  <span class="hljs-comment">// 运行时保留</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Entity {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;  <span class="hljs-comment">// 表名，默认空（使用类名）</span>
}
</code></pre>
<h4 data-id="heading-5">2.2.2 @Id：标记主键字段</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 标记实体类的主键字段
 */</span>
<span class="hljs-meta">@Target(ElementType.FIELD)</span>  <span class="hljs-comment">// 作用于字段</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Id {
    String <span class="hljs-title function_">generator</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"manual"</span>;  <span class="hljs-comment">// 主键生成策略，默认手动输入</span>
}
</code></pre>
<h4 data-id="heading-6">2.2.3 @Column：普通字段与列映射</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 标记实体类字段与数据库列的映射关系，可指定列名（默认用字段名）
 */</span>
<span class="hljs-meta">@Target(ElementType.FIELD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Column {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;  <span class="hljs-comment">// 列名，默认空（使用字段名）</span>
}
</code></pre>
<h3 data-id="heading-7">2.3 第二步：数据库连接工具（JDBC+连接池）</h3>
<p>数据库操作离不开JDBC，为了提升性能，我们使用HikariCP连接池管理连接（比原生JDBC更高效、更易维护）。创建JDBCUtil工具类，负责加载配置、获取连接、关闭资源。</p>
<h4 data-id="heading-8">2.3.1 数据库配置文件（db.properties）</h4>
<pre><code class="hljs language-properties" lang="properties">
# 数据库连接配置
jdbc.driver=com.mysql.cj.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/miniorm?useSSL=false&amp;serverTimezone=UTC&amp;characterEncoding=utf8
jdbc.username=root  # 你的数据库用户名
jdbc.password=123456  # 你的数据库密码
</code></pre>
<h4 data-id="heading-9">2.3.2 JDBC工具类（DbHelper.java）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DbHelper</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HikariDataSource DATA_SOURCE;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 加载配置文件</span>
            <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
            props.load(DbHelper.class.getClassLoader().getResourceAsStream(<span class="hljs-string">"db.properties"</span>));

            <span class="hljs-comment">// 初始化HikariCP</span>
            <span class="hljs-type">HikariConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariConfig</span>();
            config.setJdbcUrl(props.getProperty(<span class="hljs-string">"jdbc.url"</span>));
            config.setUsername(props.getProperty(<span class="hljs-string">"jdbc.username"</span>));
            config.setPassword(props.getProperty(<span class="hljs-string">"jdbc.password"</span>));
            config.setDriverClassName(props.getProperty(<span class="hljs-string">"jdbc.driver"</span>));

            <span class="hljs-comment">// 连接池配置（可选）</span>
            config.setMaximumPoolSize(<span class="hljs-number">10</span>);
            config.setMinimumIdle(<span class="hljs-number">5</span>);

            DATA_SOURCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>(config);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"初始化数据库连接池失败"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 获取数据库连接
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> DATA_SOURCE.getConnection();
    }

    <span class="hljs-comment">/**
     * 关闭连接（连接池会回收连接，此处仅关闭Statement/ResultSet）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(Connection conn, java.sql.PreparedStatement ps, java.sql.ResultSet rs)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) rs.close();
            <span class="hljs-keyword">if</span> (ps != <span class="hljs-literal">null</span>) ps.close();
            <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) conn.close(); <span class="hljs-comment">// 连接池的close是归还连接</span>
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-comment">/**
     * 关闭连接
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(Connection conn)</span> {
        close(conn, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h3 data-id="heading-10">2.4 第三步：SQL生成工具（反射解析注解）</h3>
<p>这是ORM框架的核心之一：通过反射解析实体类的注解信息，自动生成插入、查询、更新、删除的SQL语句。创建SqlUtil工具类，封装SQL生成逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlUtil</span> {

    <span class="hljs-comment">/**
     * 生成插入SQL
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; String <span class="hljs-title function_">generateInsertSql</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        <span class="hljs-comment">// 1. 获取表名</span>
        <span class="hljs-type">Entity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> clazz.getAnnotation(Entity.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> entity.value().isEmpty() ? clazz.getSimpleName() : entity.value();

        <span class="hljs-comment">// 2. 解析字段和列名</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">columns</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">placeholders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        Field[] fields = clazz.getDeclaredFields();
        <span class="hljs-keyword">for</span> (Field field : fields) {
            <span class="hljs-comment">// 跳过静态字段</span>
            <span class="hljs-keyword">if</span> (java.lang.reflect.Modifier.isStatic(field.getModifiers())) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-comment">// 获取列名</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> getColumnName(field);
            columns.append(columnName).append(<span class="hljs-string">","</span>);
            placeholders.append(<span class="hljs-string">"?,"</span>);
        }

        <span class="hljs-comment">// 移除最后一个逗号</span>
        columns.deleteCharAt(columns.length() - <span class="hljs-number">1</span>);
        placeholders.deleteCharAt(placeholders.length() - <span class="hljs-number">1</span>);

        <span class="hljs-comment">// 3. 生成SQL</span>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"INSERT INTO %s (%s) VALUES (%s)"</span>, tableName, columns, placeholders);
    }

    <span class="hljs-comment">/**
     * 生成根据主键查询的SQL
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; String <span class="hljs-title function_">generateSelectByIdSql</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        <span class="hljs-comment">// 1. 获取表名</span>
        <span class="hljs-type">Entity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> clazz.getAnnotation(Entity.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> entity.value().isEmpty() ? clazz.getSimpleName() : entity.value();

        <span class="hljs-comment">// 2. 获取主键列名</span>
        <span class="hljs-type">Field</span> <span class="hljs-variable">idField</span> <span class="hljs-operator">=</span> getIdField(clazz);
        <span class="hljs-type">String</span> <span class="hljs-variable">idColumnName</span> <span class="hljs-operator">=</span> getColumnName(idField);

        <span class="hljs-comment">// 3. 生成SQL</span>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"SELECT * FROM %s WHERE %s = ?"</span>, tableName, idColumnName);
    }

    <span class="hljs-comment">/**
     * 生成更新SQL（根据主键）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; String <span class="hljs-title function_">generateUpdateSql</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        <span class="hljs-comment">// 1. 获取表名</span>
        <span class="hljs-type">Entity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> clazz.getAnnotation(Entity.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> entity.value().isEmpty() ? clazz.getSimpleName() : entity.value();

        <span class="hljs-comment">// 2. 解析字段和列名（排除主键）</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">setClause</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-type">Field</span> <span class="hljs-variable">idField</span> <span class="hljs-operator">=</span> getIdField(clazz);
        <span class="hljs-type">String</span> <span class="hljs-variable">idColumnName</span> <span class="hljs-operator">=</span> getColumnName(idField);

        Field[] fields = clazz.getDeclaredFields();
        <span class="hljs-keyword">for</span> (Field field : fields) {
            <span class="hljs-keyword">if</span> (java.lang.reflect.Modifier.isStatic(field.getModifiers()) || field.equals(idField)) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> getColumnName(field);
            setClause.append(columnName).append(<span class="hljs-string">" = ?,"</span>);
        }

        <span class="hljs-comment">// 移除最后一个逗号</span>
        setClause.deleteCharAt(setClause.length() - <span class="hljs-number">1</span>);

        <span class="hljs-comment">// 3. 生成SQL</span>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"UPDATE %s SET %s WHERE %s = ?"</span>, tableName, setClause, idColumnName);
    }

    <span class="hljs-comment">/**
     * 生成根据主键删除的SQL
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; String <span class="hljs-title function_">generateDeleteByIdSql</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        <span class="hljs-comment">// 1. 获取表名</span>
        <span class="hljs-type">Entity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> clazz.getAnnotation(Entity.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> entity.value().isEmpty() ? clazz.getSimpleName() : entity.value();

        <span class="hljs-comment">// 2. 获取主键列名</span>
        <span class="hljs-type">Field</span> <span class="hljs-variable">idField</span> <span class="hljs-operator">=</span> getIdField(clazz);
        <span class="hljs-type">String</span> <span class="hljs-variable">idColumnName</span> <span class="hljs-operator">=</span> getColumnName(idField);

        <span class="hljs-comment">// 3. 生成SQL</span>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"DELETE FROM %s WHERE %s = ?"</span>, tableName, idColumnName);
    }

    <span class="hljs-comment">/**
     * 获取字段对应的列名
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getColumnName</span><span class="hljs-params">(Field field)</span> {
        <span class="hljs-type">Column</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> field.getAnnotation(Column.class);
        <span class="hljs-keyword">return</span> column != <span class="hljs-literal">null</span> &amp;&amp; !column.value().isEmpty() ? column.value() : field.getName();
    }

    <span class="hljs-comment">/**
     * 获取主键字段
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Field <span class="hljs-title function_">getIdField</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        Field[] fields = clazz.getDeclaredFields();
        <span class="hljs-keyword">for</span> (Field field : fields) {
            <span class="hljs-keyword">if</span> (field.isAnnotationPresent(Id.class)) {
                <span class="hljs-keyword">return</span> field;
            }
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"实体类未标记@Id主键字段："</span> + clazz.getName());
    }

    <span class="hljs-comment">/**
     * 获取实体类的字段值（包括私有字段）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getFieldValue</span><span class="hljs-params">(Object obj, Field field)</span> <span class="hljs-keyword">throws</span> IllegalAccessException {
        field.setAccessible(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">return</span> field.get(obj);
    }

    <span class="hljs-comment">/**
     * 设置实体类的字段值（包括私有字段）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, Field field, Object value)</span> <span class="hljs-keyword">throws</span> IllegalAccessException {
        field.setAccessible(<span class="hljs-literal">true</span>);
        field.set(obj, value);
    }

    <span class="hljs-comment">/**
     * 获取实体类的所有字段与列名的映射
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Map&lt;String, Field&gt; <span class="hljs-title function_">getColumnFieldMap</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        Map&lt;String, Field&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        Field[] fields = clazz.getDeclaredFields();
        <span class="hljs-keyword">for</span> (Field field : fields) {
            <span class="hljs-keyword">if</span> (java.lang.reflect.Modifier.isStatic(field.getModifiers())) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> getColumnName(field);
            map.put(columnName, field);
        }
        <span class="hljs-keyword">return</span> map;
    }
}
</code></pre>
<h3 data-id="heading-11">2.5 第四步：动态代理实现DAO增强</h3>
<p>我们约定DAO接口的方法名（如insertUser、selectByIdUser），通过JDK动态代理拦截这些方法调用，自动执行对应的数据库操作。核心是实现InvocationHandler接口，重写invoke方法。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DaoProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-comment">// 实体类的Class对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; entityClass;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DaoProxy</span><span class="hljs-params">(Class&lt;?&gt; entityClass)</span> {
        <span class="hljs-built_in">this</span>.entityClass = entityClass;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取连接</span>
            conn = DbHelper.getConnection();

            <span class="hljs-comment">// 处理插入操作</span>
            <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"insert"</span>)) {
                <span class="hljs-keyword">return</span> handleInsert(conn, ps, args[<span class="hljs-number">0</span>]);
            }

            <span class="hljs-comment">// 处理根据主键查询操作</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"selectById"</span>)) {
                <span class="hljs-keyword">return</span> handleSelectById(conn, ps, rs, args[<span class="hljs-number">0</span>]);
            }

            <span class="hljs-comment">// 处理更新操作</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"update"</span>)) {
                <span class="hljs-keyword">return</span> handleUpdate(conn, ps, args[<span class="hljs-number">0</span>]);
            }

            <span class="hljs-comment">// 处理根据主键删除操作</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"deleteById"</span>)) {
                <span class="hljs-keyword">return</span> handleDeleteById(conn, ps, args[<span class="hljs-number">0</span>]);
            }

            <span class="hljs-comment">// 未匹配的方法，执行原方法（如果有实现）</span>
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> method.invoke(proxy, args);
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 每次处理结束执行连接的关闭</span>
            DbHelper.close(conn, ps, rs);
        }
    }

    <span class="hljs-comment">/**
     * 处理插入操作
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handleInsert</span><span class="hljs-params">(Connection conn, PreparedStatement ps, Object entity)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> SqlUtil.generateInsertSql(entityClass);
        ps = conn.prepareStatement(sql);

        <span class="hljs-comment">// 设置参数</span>
        Field[] fields = entityClass.getDeclaredFields();
        <span class="hljs-type">int</span> <span class="hljs-variable">paramIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (Field field : fields) {
            <span class="hljs-keyword">if</span> (java.lang.reflect.Modifier.isStatic(field.getModifiers())) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> SqlUtil.getFieldValue(entity, field);
            ps.setObject(paramIndex++, value);
        }

        <span class="hljs-keyword">return</span> ps.executeUpdate();
    }

    <span class="hljs-comment">/**
     * 处理根据主键查询操作
     */</span>
    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">handleSelectById</span><span class="hljs-params">(Connection conn, PreparedStatement ps, ResultSet rs, Object id)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> SqlUtil.generateSelectByIdSql(entityClass);
        ps = conn.prepareStatement(sql);
        ps.setObject(<span class="hljs-number">1</span>, id);
        rs = ps.executeQuery();

        <span class="hljs-keyword">if</span> (rs.next()) {
            <span class="hljs-comment">// 创建实体对象</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> entityClass.getDeclaredConstructor().newInstance();
            Map&lt;String, Field&gt; columnFieldMap = SqlUtil.getColumnFieldMap(entityClass);
            <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> rs.getMetaData();
            <span class="hljs-type">int</span> <span class="hljs-variable">columnCount</span> <span class="hljs-operator">=</span> metaData.getColumnCount();

            <span class="hljs-comment">// 封装结果集到实体对象</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= columnCount; i++) {
                <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> metaData.getColumnName(i);
                <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> columnFieldMap.get(columnName);
                <span class="hljs-keyword">if</span> (field != <span class="hljs-literal">null</span>) {
                    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rs.getObject(columnName);
                    SqlUtil.setFieldValue(entity, field, value);
                }
            }

            <span class="hljs-keyword">return</span> entity;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">/**
     * 处理更新操作
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handleUpdate</span><span class="hljs-params">(Connection conn, PreparedStatement ps, Object entity)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> SqlUtil.generateUpdateSql(entityClass);
        ps = conn.prepareStatement(sql);

        <span class="hljs-comment">// 设置参数（先设置普通字段，最后设置主键）</span>
        <span class="hljs-type">Field</span> <span class="hljs-variable">idField</span> <span class="hljs-operator">=</span> SqlUtil.getIdField(entityClass);
        Field[] fields = entityClass.getDeclaredFields();
        <span class="hljs-type">int</span> <span class="hljs-variable">paramIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

        <span class="hljs-keyword">for</span> (Field field : fields) {
            <span class="hljs-keyword">if</span> (java.lang.reflect.Modifier.isStatic(field.getModifiers()) || field.equals(idField)) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> SqlUtil.getFieldValue(entity, field);
            ps.setObject(paramIndex++, value);
        }

        <span class="hljs-comment">// 设置主键参数</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">idValue</span> <span class="hljs-operator">=</span> SqlUtil.getFieldValue(entity, idField);
        ps.setObject(paramIndex, idValue);

        <span class="hljs-keyword">return</span> ps.executeUpdate();
    }

    <span class="hljs-comment">/**
     * 处理根据主键删除操作
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handleDeleteById</span><span class="hljs-params">(Connection conn, PreparedStatement ps, Object id)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> SqlUtil.generateDeleteByIdSql(entityClass);
        ps = conn.prepareStatement(sql);
        ps.setObject(<span class="hljs-number">1</span>, id);

        <span class="hljs-keyword">return</span> ps.executeUpdate();
    }
}

</code></pre>
<h3 data-id="heading-12">2.6 第五步：会话管理（Session与SessionFactory）</h3>
<p>为了让框架使用更友好，我们封装Session和SessionFactory类，负责创建代理对象和管理会话（采用单例模式确保SessionFactory唯一）。</p>
<h4 data-id="heading-13">Session.java（会话类，获取DAO代理）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 会话类：提供获取DAO代理对象的入口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Session</span> {
    <span class="hljs-comment">/**
     * 获取DAO接口的动态代理对象
     * <span class="hljs-doctag">@param</span> daoInterface DAO接口Class
     * <span class="hljs-doctag">@param</span> entityClass 对应的实体类Class
     * <span class="hljs-doctag">@param</span> &lt;T&gt; DAO接口类型
     * <span class="hljs-doctag">@return</span> DAO代理对象
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getDao</span><span class="hljs-params">(Class&lt;T&gt; daoInterface, Class&lt;?&gt; entityClass)</span> {
        <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(
                daoInterface.getClassLoader(),  <span class="hljs-comment">// 类加载器</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{daoInterface},      <span class="hljs-comment">// 要代理的接口</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DaoProxy</span>(entityClass)       <span class="hljs-comment">// 代理处理器</span>
        );
    }
}
</code></pre>
<h4 data-id="heading-14">SessionFactory.java（会话工厂，单例）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 会话工厂类：单例模式，负责创建Session对象
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionFactory</span> {
    <span class="hljs-comment">// 单例实例（饿汉式）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionFactory</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Session session;

    <span class="hljs-comment">// 私有构造器，防止外部实例化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">SessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.session = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Session</span>();
    }

    <span class="hljs-comment">/**
     * 获取单例SessionFactory
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> INSTANCE;
    }

    <span class="hljs-comment">/**
     * 打开一个会话（获取Session）
     */</span>
    <span class="hljs-keyword">public</span> Session <span class="hljs-title function_">openSession</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> session;
    }
}
</code></pre>
<h3 data-id="heading-15">2.7 Maven依赖（pom.xml）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.com.notnull.orm<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mini-orm<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>25<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>25<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 简单日志框架,避免HikariCP无日志实现警告 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-simple<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h3 data-id="heading-16">3. 测试验证</h3>
<h4 data-id="heading-17">3.1 新建测试项目</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0da18af6f54a15adbb6561a4439b02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YirTlVMTOS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766892955&amp;x-signature=igj6EGTWx1UHQ9A6hikrIGxcbaM%3D" alt="" loading="lazy"/></p>
<p>使用maven(<code>mvn install</code>)将<code>miniorm</code>安装到本地仓库。</p>
<p>创建一个新项目：miniorm-test，引入刚刚安装到本地的miniorm。因为<code>mini-rom</code>已经导入mysql驱动，所以测试项目不再引入。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.com.notnull.ormtest<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>miniorm-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>25<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>25<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 导入本地的mini-orm --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.com.notnull.orm<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mini-orm<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h5 data-id="heading-18">创建类<code>User</code>和<code>UserDao</code></h5>
<p>User：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity("user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-comment">/**
     * 数据库使用username字段，映射到Java的name字段
     */</span>
    <span class="hljs-meta">@Column("username")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column</span>
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-meta">@Column</span>
    <span class="hljs-keyword">private</span> Integer age;
</code></pre>
<p>UserDao:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> {

    <span class="hljs-comment">/**
     * 插入用户
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">insertUser</span><span class="hljs-params">(User user)</span>;

    <span class="hljs-comment">/**
     * 根据主键查询用户
     */</span>
    User <span class="hljs-title function_">selectByIdUser</span><span class="hljs-params">(Long id)</span>;

    <span class="hljs-comment">/**
     * 更新用户
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span>;

    <span class="hljs-comment">/**
     * 根据主键删除用户
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">deleteByIdUser</span><span class="hljs-params">(Long id)</span>;
}
</code></pre>
<h5 data-id="heading-19">数据库表创建脚本</h5>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 创建数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> miniorm;
USE miniorm;

<span class="hljs-comment">-- 创建user表（与User实体类对应）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-keyword">user</span> (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    age <span class="hljs-type">INT</span>
);
</code></pre>
<h5 data-id="heading-20">创建db.properties配置文件</h5>
<p>因为现在<code>mini-orm</code>默认读取类路径下的<code>db.properties</code>配置数据库。所在在测试项目resources目录配置创建<code>db.properties</code></p>
<pre><code class="hljs language-properties" lang="properties">jdbc.driver=com.mysql.cj.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/miniorm?useSSL=false&amp;serverTimezone=UTC&amp;characterEncoding=utf8&amp;allowPublicKeyRetrieval=true
jdbc.username=root
jdbc.password=root
</code></pre>
<h5 data-id="heading-21">单元测试</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(UserDaoTest.class);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">"Jack"</span>, <span class="hljs-string">"fdsjgea"</span>, <span class="hljs-number">18</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UserDao userDao;

    <span class="hljs-meta">@BeforeAll</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> SessionFactory.getInstance().openSession();
        userDao = session.getDao(UserDao.class, User.class);
    }

    <span class="hljs-meta">@DisplayName("插入测试")</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertUserTest</span><span class="hljs-params">()</span> {
        userDao.insertUser(user);
    }

    <span class="hljs-meta">@DisplayName("根据id查询测试")</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">selectByIdTest</span><span class="hljs-params">()</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">userByDb</span> <span class="hljs-operator">=</span> userDao.selectByIdUser(<span class="hljs-number">1L</span>);
        Assertions.assertNotNull(userByDb);
        logger.info(userByDb.toString());
    }

    <span class="hljs-meta">@DisplayName("更新测试")</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserTest</span><span class="hljs-params">()</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">userByDb</span> <span class="hljs-operator">=</span> userDao.selectByIdUser(<span class="hljs-number">1L</span>);
        userByDb.setName(<span class="hljs-string">"Tom"</span>);
        userDao.updateUser(userByDb);
        userByDb = userDao.selectByIdUser(<span class="hljs-number">1L</span>);
        Assertions.assertEquals(<span class="hljs-string">"Tom"</span>, userByDb.getName());
    }

    <span class="hljs-meta">@DisplayName("根据id删除测试")</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUserTest</span><span class="hljs-params">()</span> {
        userDao.deleteByIdUser(<span class="hljs-number">1L</span>);
        <span class="hljs-type">User</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userDao.selectByIdUser(<span class="hljs-number">1L</span>);
        Assertions.assertNull(result);
    }
}
</code></pre>
<p><strong>测试结果</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9d58747feae42348315e5aff247b1f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YirTlVMTOS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766892955&amp;x-signature=ZceBWzo5UAYSK54qMQ4Zun%2FFfQo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-22">三、总结</h2>
<p>可以看到，在测试项目中只使用了一个实体类User和一个Dao接口UserDao，我们就完成了数据库的增删改查，没有编写一行Sql语句，这就是全自动ORM。</p>
<p>miniorm框架的完整工作流程可总结为3步：</p>
<ol>
<li>
<p><strong>注解约定</strong>：通过@Entity、@Id、@Column定义实体与表的映射关系。</p>
</li>
<li>
<p><strong>反射解析</strong>：SQLUtil通过反射读取注解信息，生成对应的SQL语句。</p>
</li>
<li>
<p><strong>动态代理</strong>：DaoProxy拦截DAO接口方法调用，执行SQL并封装结果（无需手动实现DAO）。</p>
</li>
</ol>
<p>反射、注解、动态代理是Java非常重要的特性，它们共同作为很多框架的底层实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[设计模式之桥接模式：从原理到实战]]></title>    <link>https://juejin.cn/post/7585490245007015942</link>    <guid>https://juejin.cn/post/7585490245007015942</guid>    <pubDate>2025-12-21T04:00:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585490245007015942" data-draft-id="7585468725333196854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="设计模式之桥接模式：从原理到实战"/> <meta itemprop="keywords" content="设计模式"/> <meta itemprop="datePublished" content="2025-12-21T04:00:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            设计模式之桥接模式：从原理到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T04:00:07.000Z" title="Sun Dec 21 2025 04:00:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解设计模式之桥接模式：从原理到实战</h2>
<h3 data-id="heading-1">前言</h3>
<p>在软件开发中，我们经常会遇到这样的场景：一个系统需要在多个维度上扩展，如果使用传统的继承方式，很容易导致类的数量爆炸式增长。比如，你需要实现不同形状（圆形、方形、三角形）和不同颜色（红色、蓝色、绿色）的图形，如果每种组合都创建一个类，就需要 3 × 3 = 9 个类。如果再增加一个维度，类的数量将成几何级数增长。</p>
<p><strong>桥接模式（Bridge Pattern）</strong> 正是为解决这类多维度变化问题而生的设计模式。它通过将抽象部分与实现部分分离，使它们可以独立变化，从而避免了类爆炸问题。</p>
<p>今天，我们就来深入探讨桥接模式，结合实际生产案例和开源框架源码，帮助大家彻底掌握这一重要的设计模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2bcc4b24a0141e2bf6d9860c4ed6e9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766894407&amp;x-signature=YbSKEWyFRVkUM%2FWt0d0rXqMIVKU%3D" alt="01_bridge_concept.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">一、什么是桥接模式？</h3>
<h4 data-id="heading-3">1.1 定义</h4>
<p><strong>桥接模式</strong>是一种结构型设计模式，它将抽象部分与实现部分分离，使它们都可以独立地变化。桥接模式通过组合关系代替继承关系，从而降低了抽象和实现这两个可变维度的耦合度。</p>
<h4 data-id="heading-4">1.2 核心思想</h4>
<ul>
<li><strong>分离抽象与实现</strong>：将系统分为抽象层和实现层两个独立的维度</li>
<li><strong>使用组合代替继承</strong>：抽象层持有实现层的引用，通过委托调用实现</li>
<li><strong>双向独立扩展</strong>：抽象和实现可以各自独立扩展，互不影响</li>
</ul>
<h4 data-id="heading-5">1.3 模式结构</h4>
<p>桥接模式包含以下角色：</p>

























<table><thead><tr><th>角色</th><th>说明</th></tr></thead><tbody><tr><td><strong>Abstraction（抽象类）</strong></td><td>定义抽象部分的接口，持有Implementor引用</td></tr><tr><td><strong>RefinedAbstraction（扩充抽象类）</strong></td><td>扩展Abstraction，增加新功能</td></tr><tr><td><strong>Implementor（实现接口）</strong></td><td>定义实现部分的接口</td></tr><tr><td><strong>ConcreteImplementor（具体实现）</strong></td><td>实现Implementor接口</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7dc9dcc6a344a77b9d21e44e589c980~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766894407&amp;x-signature=VOiJgVPvfISacVLlar2dzmIgWkU%3D" alt="02_bridge_structure.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-6">二、经典案例：跨平台消息发送系统</h3>
<p>让我们从一个实际的例子开始——企业级消息发送系统。系统需要支持多种消息类型（普通消息、紧急消息、加密消息等）和多种发送渠道（邮件、短信、微信、钉钉等）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a1860c46dca41028e07ac7d2d0a75b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766894407&amp;x-signature=akIfPDcowTtLRWgBBtj8%2F3reL2w%3D" alt="03_message_system.png" loading="lazy"/></p>
<h4 data-id="heading-7">2.1 实现接口：消息发送器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 消息发送器接口（实现部分）
 * 定义具体的发送实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageSender</span> {

    <span class="hljs-comment">/**
     * 发送消息
     * <span class="hljs-doctag">@param</span> message 消息内容
     * <span class="hljs-doctag">@param</span> receiver 接收者
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message, String receiver)</span>;

    <span class="hljs-comment">/**
     * 获取发送器名称
     */</span>
    String <span class="hljs-title function_">getSenderName</span><span class="hljs-params">()</span>;
}
</code></pre>
<h4 data-id="heading-8">2.2 具体实现：各种发送渠道</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 邮件发送器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageSender</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message, String receiver)</span> {
        System.out.println(<span class="hljs-string">"=== 邮件发送 ==="</span>);
        System.out.println(<span class="hljs-string">"收件人: "</span> + receiver);
        System.out.println(<span class="hljs-string">"内容: "</span> + message);
        System.out.println(<span class="hljs-string">"通过SMTP协议发送邮件..."</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSenderName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"邮件"</span>;
    }
}

<span class="hljs-comment">/**
 * 短信发送器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageSender</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message, String receiver)</span> {
        System.out.println(<span class="hljs-string">"=== 短信发送 ==="</span>);
        System.out.println(<span class="hljs-string">"手机号: "</span> + receiver);
        System.out.println(<span class="hljs-string">"内容: "</span> + message);
        System.out.println(<span class="hljs-string">"通过短信网关发送..."</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSenderName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"短信"</span>;
    }
}

<span class="hljs-comment">/**
 * 微信发送器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageSender</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message, String receiver)</span> {
        System.out.println(<span class="hljs-string">"=== 微信发送 ==="</span>);
        System.out.println(<span class="hljs-string">"微信号: "</span> + receiver);
        System.out.println(<span class="hljs-string">"内容: "</span> + message);
        System.out.println(<span class="hljs-string">"通过微信API发送..."</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSenderName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"微信"</span>;
    }
}

<span class="hljs-comment">/**
 * 钉钉发送器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DingTalkSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageSender</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String message, String receiver)</span> {
        System.out.println(<span class="hljs-string">"=== 钉钉发送 ==="</span>);
        System.out.println(<span class="hljs-string">"钉钉账号: "</span> + receiver);
        System.out.println(<span class="hljs-string">"内容: "</span> + message);
        System.out.println(<span class="hljs-string">"通过钉钉机器人发送..."</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSenderName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"钉钉"</span>;
    }
}
</code></pre>
<h4 data-id="heading-9">2.3 抽象类：消息抽象</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 消息抽象类（抽象部分）
 * 定义消息的高层逻辑
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMessage</span> {

    <span class="hljs-comment">// 持有实现部分的引用（桥接）</span>
    <span class="hljs-keyword">protected</span> MessageSender sender;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractMessage</span><span class="hljs-params">(MessageSender sender)</span> {
        <span class="hljs-built_in">this</span>.sender = sender;
    }

    <span class="hljs-comment">/**
     * 发送消息（抽象方法，由子类实现具体逻辑）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String content, String receiver)</span>;

    <span class="hljs-comment">/**
     * 设置发送器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSender</span><span class="hljs-params">(MessageSender sender)</span> {
        <span class="hljs-built_in">this</span>.sender = sender;
    }
}
</code></pre>
<h4 data-id="heading-10">2.4 扩充抽象类：具体消息类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 普通消息
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonMessage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMessage</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CommonMessage</span><span class="hljs-params">(MessageSender sender)</span> {
        <span class="hljs-built_in">super</span>(sender);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String content, String receiver)</span> {
        System.out.println(<span class="hljs-string">"\n【普通消息】"</span>);
        sender.sendMessage(content, receiver);
    }
}

<span class="hljs-comment">/**
 * 紧急消息
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UrgentMessage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMessage</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UrgentMessage</span><span class="hljs-params">(MessageSender sender)</span> {
        <span class="hljs-built_in">super</span>(sender);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String content, String receiver)</span> {
        System.out.println(<span class="hljs-string">"\n【紧急消息 - 高优先级】"</span>);
        <span class="hljs-comment">// 添加紧急标识</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">urgentContent</span> <span class="hljs-operator">=</span> <span class="hljs-string">"【紧急】"</span> + content + <span class="hljs-string">" - 请立即处理！"</span>;
        sender.sendMessage(urgentContent, receiver);
        <span class="hljs-comment">// 可以添加额外逻辑，如重复发送、记录日志等</span>
        System.out.println(<span class="hljs-string">"已标记为紧急消息并记录日志"</span>);
    }
}

<span class="hljs-comment">/**
 * 加密消息
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncryptedMessage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMessage</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EncryptedMessage</span><span class="hljs-params">(MessageSender sender)</span> {
        <span class="hljs-built_in">super</span>(sender);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String content, String receiver)</span> {
        System.out.println(<span class="hljs-string">"\n【加密消息】"</span>);
        <span class="hljs-comment">// 加密内容</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">encryptedContent</span> <span class="hljs-operator">=</span> encrypt(content);
        sender.sendMessage(encryptedContent, receiver);
        System.out.println(<span class="hljs-string">"消息已加密发送"</span>);
    }

    <span class="hljs-comment">/**
     * 模拟加密
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String content)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ENCRYPTED["</span> + content + <span class="hljs-string">"]"</span>;
    }
}
</code></pre>
<h4 data-id="heading-11">2.5 使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BridgeDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建不同的发送器（实现部分）</span>
        <span class="hljs-type">MessageSender</span> <span class="hljs-variable">emailSender</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmailSender</span>();
        <span class="hljs-type">MessageSender</span> <span class="hljs-variable">smsSender</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsSender</span>();
        <span class="hljs-type">MessageSender</span> <span class="hljs-variable">wechatSender</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WechatSender</span>();
        <span class="hljs-type">MessageSender</span> <span class="hljs-variable">dingTalkSender</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DingTalkSender</span>();

        <span class="hljs-comment">// 场景1：普通消息 + 邮件发送</span>
        <span class="hljs-type">AbstractMessage</span> <span class="hljs-variable">message1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonMessage</span>(emailSender);
        message1.send(<span class="hljs-string">"系统升级通知"</span>, <span class="hljs-string">"user@example.com"</span>);

        <span class="hljs-comment">// 场景2：紧急消息 + 短信发送</span>
        <span class="hljs-type">AbstractMessage</span> <span class="hljs-variable">message2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrgentMessage</span>(smsSender);
        message2.send(<span class="hljs-string">"服务器CPU使用率超过90%"</span>, <span class="hljs-string">"13800138000"</span>);

        <span class="hljs-comment">// 场景3：加密消息 + 微信发送</span>
        <span class="hljs-type">AbstractMessage</span> <span class="hljs-variable">message3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EncryptedMessage</span>(wechatSender);
        message3.send(<span class="hljs-string">"敏感数据报告"</span>, <span class="hljs-string">"wechat_id_123"</span>);

        <span class="hljs-comment">// 场景4：运行时切换发送器</span>
        <span class="hljs-type">AbstractMessage</span> <span class="hljs-variable">message4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonMessage</span>(emailSender);
        message4.send(<span class="hljs-string">"第一次通知"</span>, <span class="hljs-string">"user@example.com"</span>);

        <span class="hljs-comment">// 动态切换为钉钉发送</span>
        message4.setSender(dingTalkSender);
        message4.send(<span class="hljs-string">"第二次通知（切换到钉钉）"</span>, <span class="hljs-string">"dingtalk_id_456"</span>);
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-makefile" lang="makefile">【普通消息】
=== 邮件发送 ===
<span class="hljs-section">收件人: user@example.com</span>
<span class="hljs-section">内容: 系统升级通知</span>
通过SMTP协议发送邮件...

【紧急消息 - 高优先级】
=== 短信发送 ===
<span class="hljs-section">手机号: 13800138000</span>
<span class="hljs-section">内容: 【紧急】服务器CPU使用率超过90% - 请立即处理！</span>
通过短信网关发送...
已标记为紧急消息并记录日志

【加密消息】
=== 微信发送 ===
<span class="hljs-section">微信号: wechat_id_123</span>
<span class="hljs-section">内容: ENCRYPTED[敏感数据报告]</span>
通过微信API发送...
消息已加密发送

【普通消息】
=== 邮件发送 ===
<span class="hljs-section">收件人: user@example.com</span>
<span class="hljs-section">内容: 第一次通知</span>
通过SMTP协议发送邮件...

【普通消息】
=== 钉钉发送 ===
<span class="hljs-section">钉钉账号: dingtalk_id_456</span>
<span class="hljs-section">内容: 第二次通知（切换到钉钉）</span>
通过钉钉机器人发送...
</code></pre>
<hr/>
<h3 data-id="heading-12">三、开源框架中的桥接模式</h3>
<p>桥接模式在各大开源框架中被广泛使用，让我们看几个经典案例。</p>
<h4 data-id="heading-13">3.1 JDBC 驱动架构</h4>
<p>JDBC（Java Database Connectivity）是桥接模式最经典的应用之一。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/452f5517f02344da812530e18ca4e81b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766894407&amp;x-signature=hm9DL3ziF4Nrg8%2FuE%2BBtJnU3YOk%3D" alt="04_jdbc_architecture.png" loading="lazy"/></p>
<h5 data-id="heading-14">3.1.1 JDBC API（抽象层）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * JDBC 核心接口 - 抽象层
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Connection</span> {
    Statement <span class="hljs-title function_">createStatement</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;
    PreparedStatement <span class="hljs-title function_">prepareStatement</span><span class="hljs-params">(String sql)</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Statement</span> {
    ResultSet <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-type">int</span> <span class="hljs-title function_">executeUpdate</span><span class="hljs-params">(String sql)</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResultSet</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">next</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;
    String <span class="hljs-title function_">getString</span><span class="hljs-params">(String columnLabel)</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-type">int</span> <span class="hljs-title function_">getInt</span><span class="hljs-params">(String columnLabel)</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;
}
</code></pre>
<h5 data-id="heading-15">3.1.2 使用示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 加载驱动（实现层）</span>
        <span class="hljs-comment">// MySQL: com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-comment">// Oracle: oracle.jdbc.driver.OracleDriver</span>
        <span class="hljs-comment">// PostgreSQL: org.postgresql.Driver</span>

        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jdbc:mysql://localhost:3306/mydb"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">"root"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">"password"</span>;

        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, user, password);
             <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();
             <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery(<span class="hljs-string">"SELECT * FROM users"</span>)) {

            <span class="hljs-keyword">while</span> (rs.next()) {
                System.out.println(<span class="hljs-string">"User: "</span> + rs.getString(<span class="hljs-string">"name"</span>));
            }

        } <span class="hljs-keyword">catch</span> (SQLException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>桥接模式的体现：</strong></p>
<ul>
<li><strong>抽象层</strong>：<code>Connection</code>、<code>Statement</code>、<code>ResultSet</code> 等接口</li>
<li><strong>实现层</strong>：各数据库厂商的驱动实现（MySQL Driver、Oracle Driver等）</li>
<li><strong>桥接关系</strong>：应用程序依赖抽象接口，通过DriverManager桥接到具体驱动</li>
<li><strong>优势</strong>：更换数据库只需修改连接URL和驱动，应用代码无需改动</li>
</ul>
<h4 data-id="heading-16">3.2 SLF4J 日志框架</h4>
<p>SLF4J（Simple Logging Facade for Java）也是桥接模式的经典应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ddfcd6c85d44fe081208f3c2f5c4435~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766894407&amp;x-signature=cqH5dDa%2F0WiVTHPor1fxzxfbIFQ%3D" alt="07_slf4j_architecture.png" loading="lazy"/></p>
<h5 data-id="heading-17">3.2.1 SLF4J API（抽象层）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * SLF4J Logger 接口 - 抽象层
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Logger</span> {

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">trace</span><span class="hljs-params">(String msg)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">(String msg)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">info</span><span class="hljs-params">(String msg)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">warn</span><span class="hljs-params">(String msg)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String msg)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String msg, Throwable t)</span>;
}

<span class="hljs-comment">/**
 * LoggerFactory - 获取Logger实例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerFactory</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Logger <span class="hljs-title function_">getLogger</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> {
        <span class="hljs-comment">// 通过绑定层选择具体的日志实现</span>
        <span class="hljs-keyword">return</span> getILoggerFactory().getLogger(clazz.getName());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Logger <span class="hljs-title function_">getLogger</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> getILoggerFactory().getLogger(name);
    }
}
</code></pre>
<h5 data-id="heading-18">3.2.2 使用示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-comment">// 使用SLF4J API（抽象层）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(UserService.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(String username)</span> {
        log.info(<span class="hljs-string">"开始创建用户: {}"</span>, username);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务逻辑</span>
            log.debug(<span class="hljs-string">"执行用户创建逻辑..."</span>);

            log.info(<span class="hljs-string">"用户创建成功: {}"</span>, username);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"用户创建失败"</span>, e);
        }
    }
}
</code></pre>
<p><strong>桥接模式的体现：</strong></p>
<ul>
<li><strong>抽象层</strong>：SLF4J的<code>Logger</code>接口</li>
<li><strong>实现层</strong>：Logback、Log4j2、Log4j、JUL等日志框架</li>
<li><strong>绑定层</strong>：<code>slf4j-logback</code>、<code>slf4j-log4j2</code>等绑定依赖</li>
<li><strong>优势</strong>：应用代码只依赖SLF4J API，切换日志框架只需更换Maven依赖</li>
</ul>
<p><strong>Maven依赖示例：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SLF4J API（抽象层） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Logback实现（二选一） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 或者使用Log4j2实现
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j-slf4j2-impl&lt;/artifactId&gt;
    &lt;version&gt;2.20.0&lt;/version&gt;
&lt;/dependency&gt;
--&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-19">四、桥接模式 vs 适配器模式</h3>
<p>这两种模式都涉及到接口转换，但使用场景和目的不同。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6484a04fda0d4864b2060008800cd07f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766894407&amp;x-signature=4TqXkN4BMq0xES%2B8L51h5cjSKfg%3D" alt="05_bridge_vs_adapter.png" loading="lazy"/></p>
<h4 data-id="heading-20">4.1 核心区别</h4>



































<table><thead><tr><th>特征</th><th>桥接模式</th><th>适配器模式</th></tr></thead><tbody><tr><td><strong>使用时机</strong></td><td>设计初期，预先规划</td><td>开发后期，解决兼容问题</td></tr><tr><td><strong>目的</strong></td><td>将抽象与实现分离</td><td>让不兼容的接口能一起工作</td></tr><tr><td><strong>结构</strong></td><td>抽象持有实现引用</td><td>适配器包装被适配者</td></tr><tr><td><strong>扩展性</strong></td><td>两个维度独立扩展</td><td>主要解决接口转换</td></tr><tr><td><strong>使用场景</strong></td><td>JDBC、日志框架、UI组件</td><td>第三方库集成、旧系统改造</td></tr></tbody></table>
<h4 data-id="heading-21">4.2 代码对比</h4>
<p><strong>桥接模式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设计初期就规划好抽象和实现分离</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">protected</span> DrawingAPI drawingAPI;  <span class="hljs-comment">// 桥接到实现</span>

    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">Shape</span><span class="hljs-params">(DrawingAPI drawingAPI)</span> {
        <span class="hljs-built_in">this</span>.drawingAPI = drawingAPI;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Circle</span><span class="hljs-params">(DrawingAPI drawingAPI)</span> {
        <span class="hljs-built_in">super</span>(drawingAPI);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> {
        drawingAPI.drawCircle();  <span class="hljs-comment">// 委托给实现</span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-type">Shape</span> <span class="hljs-variable">circle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenGLAPI</span>());
circle.draw();  <span class="hljs-comment">// 使用OpenGL绘制圆形</span>
</code></pre>
<p><strong>适配器模式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 旧系统接口（无法修改）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OldPaymentSystem</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">oldPay</span><span class="hljs-params">(String account, <span class="hljs-type">double</span> amount)</span> {
        System.out.println(<span class="hljs-string">"旧系统支付: "</span> + amount);
    }
}

<span class="hljs-comment">// 新系统接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentService</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(PaymentRequest request)</span>;
}

<span class="hljs-comment">// 适配器：让旧系统兼容新接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">OldPaymentSystem</span> <span class="hljs-variable">oldSystem</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OldPaymentSystem</span>();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(PaymentRequest request)</span> {
        <span class="hljs-comment">// 转换接口调用</span>
        oldSystem.oldPay(request.getAccount(), request.getAmount());
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-type">PaymentService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentAdapter</span>();
service.pay(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentRequest</span>(<span class="hljs-string">"123"</span>, <span class="hljs-number">100.0</span>));
</code></pre>
<h4 data-id="heading-22">4.3 选择建议</h4>
<ul>
<li><strong>选择桥接模式</strong>：系统设计初期，预见到会有多个维度的变化</li>
<li><strong>选择适配器模式</strong>：系统已经开发完成，需要集成不兼容的接口</li>
</ul>
<hr/>
<h3 data-id="heading-23">五、桥接模式的应用场景</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80561cad145548048c171ac198ef3815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766894407&amp;x-signature=QIXylcil9d%2FJwSLPEB1zEaQ3svg%3D" alt="06_application_scenarios.png" loading="lazy"/></p>
<h4 data-id="heading-24">5.1 典型应用场景</h4>
<ol>
<li>
<p><strong>数据库驱动系统</strong></p>
<ul>
<li>抽象：数据库操作API</li>
<li>实现：MySQL、Oracle、PostgreSQL等驱动</li>
</ul>
</li>
<li>
<p><strong>日志框架</strong></p>
<ul>
<li>抽象：日志API（SLF4J）</li>
<li>实现：Logback、Log4j2、JUL等</li>
</ul>
</li>
<li>
<p><strong>消息发送系统</strong></p>
<ul>
<li>抽象：消息类型（普通、紧急、加密）</li>
<li>实现：发送渠道（邮件、短信、微信）</li>
</ul>
</li>
</ol>
<h4 data-id="heading-25">5.2 适用条件</h4>
<ul>
<li><strong>多维度变化</strong>：系统需要在多个维度上扩展</li>
<li><strong>避免类爆炸</strong>：继承层次会导致类数量急剧增加</li>
<li><strong>运行时切换</strong>：需要在运行时动态选择实现</li>
<li><strong>抽象实现分离</strong>：抽象和实现需要独立演化</li>
</ul>
<hr/>
<h3 data-id="heading-26">六、最佳实践与注意事项</h3>
<h4 data-id="heading-27">6.1 设计原则</h4>
<ol>
<li>
<p><strong>明确抽象和实现的职责</strong></p>
<ul>
<li>抽象层：定义高层业务逻辑</li>
<li>实现层：定义底层操作</li>
</ul>
</li>
<li>
<p><strong>使用组合而非继承</strong></p>
<ul>
<li>抽象持有实现的引用</li>
<li>通过委托调用实现</li>
</ul>
</li>
<li>
<p><strong>确保两个维度可以独立变化</strong></p>
<ul>
<li>新增抽象子类不影响实现</li>
<li>新增实现类不影响抽象</li>
</ul>
</li>
</ol>
<h4 data-id="heading-28">6.2 Spring集成示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 使用Spring管理桥接模式
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MessageSender <span class="hljs-title function_">emailSender</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmailSender</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MessageSender <span class="hljs-title function_">smsSender</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsSender</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MessageSender <span class="hljs-title function_">wechatSender</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WechatSender</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MessageFactory <span class="hljs-title function_">messageFactory</span><span class="hljs-params">(List&lt;MessageSender&gt; senders)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageFactory</span>(senders);
    }
}

<span class="hljs-comment">/**
 * 消息工厂
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageFactory</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, MessageSender&gt; senderMap;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MessageFactory</span><span class="hljs-params">(List&lt;MessageSender&gt; senders)</span> {
        <span class="hljs-built_in">this</span>.senderMap = senders.stream()
                .collect(Collectors.toMap(
                    MessageSender::getSenderName,
                    Function.identity()
                ));
    }

    <span class="hljs-comment">/**
     * 创建消息
     */</span>
    <span class="hljs-keyword">public</span> AbstractMessage <span class="hljs-title function_">createMessage</span><span class="hljs-params">(String type, String senderName)</span> {
        <span class="hljs-type">MessageSender</span> <span class="hljs-variable">sender</span> <span class="hljs-operator">=</span> senderMap.get(senderName);
        <span class="hljs-keyword">if</span> (sender == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未知的发送器: "</span> + senderName);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span> (type) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"common"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonMessage</span>(sender);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"urgent"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrgentMessage</span>(sender);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"encrypted"</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">EncryptedMessage</span>(sender);
            <span class="hljs-keyword">default</span> -&gt; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未知的消息类型: "</span> + type);
        };
    }
}

<span class="hljs-comment">/**
 * 使用工厂创建消息
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MessageFactory messageFactory;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNotification</span><span class="hljs-params">(String type, String channel, String content, String receiver)</span> {
        <span class="hljs-type">AbstractMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> messageFactory.createMessage(type, channel);
        message.send(content, receiver);
    }
}
</code></pre>
<h4 data-id="heading-29">6.3 常见陷阱</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误示例：抽象类直接依赖具体实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadShape</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">OpenGLAPI</span> <span class="hljs-variable">api</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenGLAPI</span>();  <span class="hljs-comment">// 直接依赖具体类</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> {
        api.drawCircle();
    }
}

<span class="hljs-comment">// ✅ 正确示例：依赖抽象接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodShape</span> {
    <span class="hljs-keyword">protected</span> DrawingAPI api;  <span class="hljs-comment">// 依赖接口</span>

    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">GoodShape</span><span class="hljs-params">(DrawingAPI api)</span> {
        <span class="hljs-built_in">this</span>.api = api;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// ❌ 错误示例：实现类持有抽象引用（反向依赖）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadOpenGLAPI</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DrawingAPI</span> {
    <span class="hljs-keyword">private</span> Shape shape;  <span class="hljs-comment">// 实现不应该持有抽象</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setShape</span><span class="hljs-params">(Shape shape)</span> {
        <span class="hljs-built_in">this</span>.shape = shape;
    }
}

<span class="hljs-comment">// ✅ 正确示例：实现类独立</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodOpenGLAPI</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DrawingAPI</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drawCircle</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 独立的实现，不依赖抽象</span>
        System.out.println(<span class="hljs-string">"使用OpenGL绘制圆形"</span>);
    }
}
</code></pre>
<h4 data-id="heading-30">6.4 性能考虑</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 使用对象池优化性能
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageSenderPool</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, MessageSender&gt; pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MessageSenderPool</span><span class="hljs-params">(List&lt;MessageSender&gt; senders)</span> {
        senders.forEach(sender -&gt;
            pool.put(sender.getSenderName(), sender)
        );
    }

    <span class="hljs-keyword">public</span> MessageSender <span class="hljs-title function_">getSender</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">MessageSender</span> <span class="hljs-variable">sender</span> <span class="hljs-operator">=</span> pool.get(name);
        <span class="hljs-keyword">if</span> (sender == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未找到发送器: "</span> + name);
        }
        <span class="hljs-keyword">return</span> sender;
    }
}
</code></pre>
<h4 data-id="heading-31">6.5 适用场景总结</h4>
<p><strong>适合使用桥接模式：</strong></p>
<ul>
<li>✅ 系统需要在抽象化和具体化之间增加更多的灵活性</li>
<li>✅ 一个类存在两个或多个独立变化的维度</li>
<li>✅ 不希望使用继承导致类数量急剧增加</li>
<li>✅ 需要在运行时切换实现</li>
</ul>
<p><strong>不适合使用桥接模式：</strong></p>
<ul>
<li>❌ 系统只有一个维度的变化</li>
<li>❌ 抽象和实现紧密耦合，无法分离</li>
<li>❌ 系统规模较小，使用桥接模式反而增加复杂度</li>
</ul>
<hr/>
<h3 data-id="heading-32">七、总结</h3>
<p>桥接模式是一种优雅的结构型设计模式，它通过将抽象与实现分离，实现了系统的高度灵活性和可扩展性。</p>
<p><strong>核心要点：</strong></p>
<ol>
<li><strong>分离抽象与实现</strong>：两个独立的继承层次</li>
<li><strong>使用组合关系</strong>：抽象持有实现的引用</li>
<li><strong>独立扩展</strong>：两个维度可以独立变化</li>
<li><strong>避免类爆炸</strong>：有效控制类的数量</li>
</ol>
<p>掌握桥接模式，可以帮助我们设计出更加灵活、易于扩展的系统架构。在实际项目中，当遇到多维度变化的场景时，不妨考虑使用桥接模式来优化设计！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[进程调度：深入Linux内核架构读书笔记]]></title>    <link>https://juejin.cn/post/7585534343562084402</link>    <guid>https://juejin.cn/post/7585534343562084402</guid>    <pubDate>2025-12-21T04:11:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585534343562084402" data-draft-id="7585686247285932083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="进程调度：深入Linux内核架构读书笔记"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-21T04:11:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风的归宿55"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779297303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            进程调度：深入Linux内核架构读书笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779297303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风的归宿55
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T04:11:59.000Z" title="Sun Dec 21 2025 04:11:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在读深入Linux内核架构这本书，他通过部分linux内核源码，介绍了linux内核的实现逻辑，这本书还是不错的，推荐大家读一读，不过里面虽然精简了大部分的代码，但是还是有不少的代码量，读起来还是有点烧脑的。 这里就通过文字描述的部分，精简汇总下Linux进行进程调度的流程，让大家对Linux进程调度有个更直观的认识。</p>
<h4 data-id="heading-0">进程</h4>
<p>什么是进程，简单的说，他是一个 正在执行中的程序，他用友自己独立的地址空间，内存，数据栈以及其他资源。 可以这么理解，程序是静态的文件，而进程就是程序的一次执行过程，为什么说是一次，因为可以启动多个进程执行相同的程序。</p>
<p>操作系统上跑的有两种进程，用户进程和内核进程，用户进程就是用户启动的进程，内核进程可以理解为操作系统启动的程序，权利会比较高，如果在linux上使用ps 查看进程，使用[]包起来的就是内核进程，如 [kthreadd] 。</p>
<h6 data-id="heading-1">核心态和用户态</h6>
<p>为了确保系统的安全性，内核将内存的虚拟地址空间分为了两部分，分为核心态和用户态，用户启动的程序都处于用户态，无法访问到核心态的数据，也不能读取和操作内核空间中的代码，只有内核线程才能进入核心态并读取数据，这样就保证了系统的安全。那如果用户的程序确实需要使用系统的功能呢？<strong>那就可以通过系统调用的方式向内核发起请求，让内核帮忙执行系统功能</strong>，执行完成后再切换回用户态的程序。</p>
<p>还有一种从内核态切换到核心态的方式，那就是中断。<strong>系统调用是由用户程序主动发起的，而中断则不一样，是由硬件或者内核发起的，是不可预测的</strong>，比如你的程序正在执行，突然有个网卡接收到数据并处理好了，他就会触发一个中断，让内核快点处理他的数据，不然硬件那边可能会有问题，此时用户进程就会被中断，让出cpu给内核执行中断程序。</p>
<h6 data-id="heading-2">抢占</h6>
<p>这里就涉及到一个<strong>抢占</strong>的概念，比如上面说的，你的用户进程被中断给抢占了，cpu让给内核执行中断代码了。不同的进程拥有不同的优先级，因此被抢占的概率也不一样。</p>
<ol>
<li>用户普通进程总是可能被抢占的</li>
<li>如果系统处于核心态并正在处理系统调用，一般是无法被抢占的，除非出现了中断。不过内核进程有可能在一些不能被中断的地方加了屏蔽中断的代码，避免出现错误，等内核执行完了必要部分再执行中断代码。</li>
<li>中断具有最高优先级，可以暂停处于用户态和核心态的进程，因为在中断触发后必须尽快处理</li>
</ol>
<h6 data-id="heading-3">进程创建</h6>
<p>进程的创建一般可以通过fork和exec系统调用，fork会生成当前进程的一个副本，即生成了一个和父进程共享数据的子进程，而exec则是从一个可执行的二进制文件加载另一个应用程序来代替当前运行的程序，换句话说，加载了一个新程序。</p>
<p>通过fork调用生成的子进程和父进程拥有相同的数据，如果每次调用都将内存数据拷贝一份，那性能就会比较差，内核采用了一种写时复制的方式，fork出来的子进程和父进程共享只读的内存空间，只要有一个进程试图写入数据，就会触发缺页异常，然后进行复制数据用于写入。这样只有在确实需要写入数据时才进行内存拷贝，提高了性能。</p>
<h6 data-id="heading-4">命名空间</h6>
<p>内核中有命名空间的这个概念，是为了进行隔离，比如一台电脑上有多个用户在使用，就可以创建不同的命名空间，这样其他用户就看不见机器上有别的用户程序在执行，好像独占了这台电脑一样。不同的命名空间会进行许多资源的隔离，比如程序的pid隔离，文件系统隔离等，这个就不详细说了，现在的容器也是基于命名空间实现了其部分的隔离机制。</p>
<p>进程的pid，是每个进程在操作系统中的唯一id，每个进程的id不能重复，内核是通过位图来实现唯一id的生成的，位图是使用一个比较长的内存空间，这段空间中的每一位都代表一个数字，如果这个数字被使用了，就置为1，没被使用，就是0，内核可以通过检查最近的一个非0的位，来给程序找一个唯一的未使用的进程id。</p>
<p>每个系统都有个pid是1的进程，他是操作系统第一个启动的进程，如果你使用过容器，会发现每个容器内也有个pid是1的进程，而在主机上，这个进程的pid又是别的数字，这个是什么原因呢？ 其实这就和之前介绍的命名空间有关系，进程的pid是在指定的命名空间中唯一，而命名空间也有层级关系。</p>
<p>比如在操作系统上启动了一个容器，这个容器的进程和操作系统上启动的其实是同一个，只不过操作系统在启动容器时生成了一个子命名空间，然后在这个子命名空间中给进程分配了一个0的pid。 当你在主机上查询ps时，你查看到的是主机上命名空间中进程的pid，当你进入容器时，其实也是进入了对应的子命名空间，使用ps查看到的就是子命名空间中的程序的pid，也就是0。</p>
<h4 data-id="heading-5">进程调度</h4>
<p>一般在操作系统上会同时运行多个进程，进程的数量比实际的物理cpu内核数要多，但是你发现这些进程总是同时运行的，这是什么原因呢？ 其实这就是内核通过进程调度，在一定时间内，比如一秒，把每个进程的代码都跑一下，这样看起来就好像是所有进程都在同时运行，这叫并发执行，其实是内核通过调度器把cpu不断的分配给各个进程执行而造成的幻象。而内核是怎么将cpu分配给不同的进程执行的？这就涉及到了调度器</p>
<h6 data-id="heading-6">调度器</h6>
<p>调度器负责将cpu分配给不同的进程执行，他会在两种情况下被激活，然后进行进程调度。</p>
<ol>
<li>当前执行中的进程打算进入睡眠，或者出于其他原因主动放弃cpu，这时当进程执行让出cpu的系统调用，就会进入内核态，执行调度器的逻辑进行调度</li>
<li>另一种是通过周期性的机制，以固定频率运行，不时检测是否有必要进行进程切换。比如硬件定时会触发一个中断，抢占普通程序，让cpu执行调度器的逻辑进行调度。</li>
</ol>
<h6 data-id="heading-7">进程生命周期</h6>
<p>进程不总是可以运行的，有可能他在等待事件。比如一个服务端程序，在没有请求进来时，他可能无事可做，这时候如果调度器把cpu让给这个进程执行，他也做不了事情，那在调度器被下一次的中断拉起前，cpu都空闲着，资源被浪费了。<strong>因此调度器需要知道进程的状态，将cpu分配到无事可做的进程是没有意义的。</strong></p>
<p>这里就产生了进程的生命周期，用于调度器针对不同生命周期的进程执行不同的操作。生命周期有：</p>
<ol>
<li>运行，这时进程处于运行中</li>
<li>就绪，此时进程已经做好了准备，只要cpu被让给进程，就能开始执行有意义的工作，这种状态的进程会被放到就绪队列中，调度器也是从就绪队列中挑进程进行调度执行的。</li>
<li>阻塞，此时进程在等待一个事件，从而自愿陷入了这个状态，此时给进程分配cpu是没有意义的，因为他等待的事件到来之前，他无法正常的工作，此时进程不会被调度。</li>
<li>终止，进程执行完毕或者被终止了，就会进入此状态。</li>
</ol>
<h6 data-id="heading-8">调度的公平性</h6>
<p>在调度器执行调度逻辑时，他需要确保调度的公平性，避免某些进程长时间得不到执行。这样就需要一个算法来确保调度的公平性，但是应该怎么判断是否公平呢？</p>
<p>我们可以这样做，在进程刚被调度时记录一个时间，当进程调度完毕，调度器准备把cpu给下个进程时，再记录个时间，这两个时间的差值就是进程的执行时间，我们可以把进程的所有执行时间加起来并记录成cpu执行总时间，作为调度的依据。</p>
<p>因为调度的不公平性可以通过cpu执行总时间看出来，要是有的进程的cpu执行总时间特别小，那就说明他收到了不公平的待遇，那下次调度就应该优先考虑此进程，那么，我们只要每次调度都找cpu执行总时间 最小的那个进程，不就可以尽量保证调度的公平性了么。</p>
<p>而调度器是这样实现的，他在就绪队列的数据结构上增加了一个红黑树，每个节点对应一个待调度的进程，他将所有进程的累计cpu执行时间(后续称为vruntime)中 最小的那个值记录为min_vruntime，作为一个就绪队列的属性存储。因为cpu使用时间总是会增加的，所以这个值也总是递增的。 然后他又会将  进程的vruntime - min_vruntime 作为进程在红黑树中的key，这样，运行时间最短的进程就会被排到红黑树的最左边，<strong>调度器只要每次都调度红黑树最左边的进程就行了</strong>。</p>
<blockquote>
<p>红黑树是一种树状的结构，他是根据节点的key进行排序，最小的节点会被排到最左下角的地方，有兴趣可以自己深入了解下</p>
</blockquote>
<p>通过这种方式，内核实现了两种机制：</p>
<ol>
<li>在进程运行时，其vruntime总是增加的，因此他在红黑树中总是向右移动，运行的越久的进程，总是越晚被调度，进程运行的越久，其vruntime - min_vruntime的值就越大，越晚被调度。</li>
<li>如果进程进入睡眠，则其vruntime保持不变，因为就绪队列的min_vruntime总是单调递增的，因此vruntime - min_vruntime的值就会越来越小，因此在进程醒来后，在红黑树的位置就会更靠左，更容易被调度。</li>
</ol>
<h6 data-id="heading-9">优先级</h6>
<p>进程是有优先级的，优先级越高的进程就会被越优先调度，这样可以保证重要的任务优先得到执行，但是应该怎么控制优先级和公平性的平衡呢？</p>
<p>首先，进程被分为了几种类型，有实时进程，普通进程和批量执行进程，其中实时进程优先级最高，但是我们平时一般用不到，普通进程是日常最常用的，可以通过nice系统调用修改其优先级，而批量执行进程是优先级最低的。</p>
<p>内核为了实现不同进程的优先级方案，是针对不同类型的进程实现了不同的调度类，用于使用不同的算法来判断接下来运行哪个进程，目前的调度策略有这些：</p>
<ol>
<li>实时调度类，用于调度实时进程，会被内核优先执行，因此实时进程的优先级总是高于普通进程的。</li>
<li>完全公平调度类，用于调度普通进程，优先级在实时进程之后</li>
<li>在无事可做时调度空闲进程</li>
</ol>
<h6 data-id="heading-10">完全公平调度类的优先级实现方案</h6>
<p>系统是通过一个数字来定义进程的优先级的，其中0-99给实时进程保留，100-139留给了普通进程，内核会将nice值的-20到19 映射到100-139，比如nice值为0的进程的全局优先级就是120，从这里也可以看出，实时进程总是优先于普通进程的。</p>
<p>为了完成优先级的调度，完全公平类调度引入了一个虚拟时间的概念，之前用于进程调度的累计cpu执行时间(vruntime）就会使用虚拟时间计算，那为什么要引入一个虚拟时间呢？直接用物理时间不行么？</p>
<p>调度器就是通过虚拟时间来实现优先级的调度的，他会根据进程的优先级，每个优先级的值对应一个比例值，将比例值乘以实际的物理时间，就得到了虚拟时间，这样他就可以通过优先级控制进程被调度的快慢了。</p>
<p>举个例子，nice值是0优先级会被作为一个标准，其虚拟时间是和物理时间完全一致，比例值为1，而优先级越高的，就会被授予一个较小的比例值，比如0.5，优先级低的，会被授予一个较大的比例值，比如1.5。 运行相同的物理时间t之后:</p>
<ol>
<li>nice值是0的进程，其虚拟时间就是 vruntime = t* 1 = t</li>
<li>高优先级的进程，其虚拟时间是 vruntime = 0.5*t = 0.5t</li>
<li>低优先级的进程，其虚拟时间是 vruntime = 1.5*t = 1.5t</li>
</ol>
<p>之前说过，调度器优先调度vruntime最小的进程，因此在占用相同的cpu时间的情况下，就会优先调度 优先级高的进程，因为其vruntime值最低。</p>
<p>当然，上面只是一个简单的描述，实际上这个比例是经过精心计算的一个值。</p>
<p>同时，因为进程调度时也会出现上下文切换，这个行为是有系统开销的，为了避免频繁的进行上下文切换，内核设置了一个最低运行时间，也就是进程被调度后，最少会使用一个固定的cpu时间，避免被频繁切换，把宝贵的cpu时间都浪费在无用的上下文切换上了。</p>
<p>当然，也有一个对应的最大进程运行时间，避免其他进程无法被调度执行。</p>
<h4 data-id="heading-11">结语</h4>
<p>以上就是本次的进程调度相关的内容了，希望对读者有所帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 微服务数据库实现全解析：读写分离、缓存防护与生产级优化实战]]></title>    <link>https://juejin.cn/post/7585693761532084258</link>    <guid>https://juejin.cn/post/7585693761532084258</guid>    <pubDate>2025-12-21T04:38:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585693761532084258" data-draft-id="7585452404113457167" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 微服务数据库实现全解析：读写分离、缓存防护与生产级优化实战"/> <meta itemprop="keywords" content="后端,Go,数据库"/> <meta itemprop="datePublished" content="2025-12-21T04:38:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码扳手"/> <meta itemprop="url" content="https://juejin.cn/user/177501539672379"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 微服务数据库实现全解析：读写分离、缓存防护与生产级优化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/177501539672379/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码扳手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T04:38:10.000Z" title="Sun Dec 21 2025 04:38:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在微服务架构中，数据访问层的设计直接影响着整个系统的性能和稳定性。今天我们深入剖析一套生产级 Go 数据库访问框架，揭秘如何通过读写分离、缓存防护和连接池优化等技术手段，打造高性能、高可用的数据访问层。</p>
</blockquote>
<h2 data-id="heading-0">🎯 引言</h2>
<p>在前面几篇文章中，我们探讨了EasyMs 微服务配置治理、授权中心等内容。</p>
<p>今天，我们将聚焦于微服务架构中最关键的一环——数据库访问层的实现。无论是电商系统的大促峰值，还是社交平台的实时互动，背后都离不开一套稳定高效的数据访问层支撑。</p>
<p>在高并发面前，往往最头疼的就是数据库访问层，今天我带大家一起来看看数据库访问层我们该做些什么？</p>
<h2 data-id="heading-1">🔌 统一抽象：为什么我们需要数据库接口？</h2>
<p>其实统一抽象，一直都是为了未来（扩展，因为需求无时无刻不在变化，我们随时要做好应万变的准备），在我还没有接触 Go 在基于C# 写抽象的接口层时，老是有同事埋怨 “为什么要接口层，这不多余吗？”(插上一句：曾经不少人老是问我 “你的接口为什么要用 async await ? 那是走秀吗？”，面对这些问题我只能一笑而过。)</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Database <span class="hljs-keyword">interface</span> {
    AutoMigrate(models ...<span class="hljs-keyword">interface</span>{}) <span class="hljs-type">error</span>
    Insert(value <span class="hljs-keyword">interface</span>{}) <span class="hljs-type">error</span>
    Query(dest <span class="hljs-keyword">interface</span>{}, query <span class="hljs-type">string</span>, args ...<span class="hljs-keyword">interface</span>{}) <span class="hljs-type">error</span>
    Update(model <span class="hljs-keyword">interface</span>{}, updates <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}) <span class="hljs-type">error</span>
    Delete(model <span class="hljs-keyword">interface</span>{}, conds ...<span class="hljs-keyword">interface</span>{}) <span class="hljs-type">error</span>
    
    Count(query <span class="hljs-type">string</span>, args ...<span class="hljs-keyword">interface</span>{}) (<span class="hljs-type">int64</span>, <span class="hljs-type">error</span>)
    Where(query <span class="hljs-type">string</span>, args ...<span class="hljs-keyword">interface</span>{}) *gorm.DB
    Order(query <span class="hljs-type">string</span>) *gorm.DB
    Limit(limit <span class="hljs-type">int</span>) *gorm.DB
    
    GetDB() *gorm.DB
    GetType() <span class="hljs-type">string</span>
    Begin() (TxTransaction, <span class="hljs-type">error</span>)
}
</code></pre>
<p>这个看似简单的接口定义，实则蕴含着深刻的工程智慧。通过接口抽象，我们实现了：</p>
<ol>
<li><strong>解耦业务逻辑与数据存储</strong>：业务代码无需关心底层是 MySQL 还是 PostgreSQL，甚至可能是ElasticSearch,都无所谓；</li>
<li><strong>便于测试</strong>：可以通过 Mock 实现轻松编写单元测试，运维把本地数据库集群搞坏了，我照样有数据开发，管它上游如何折腾，不耽误我的工作就行；</li>
<li><strong>支持平滑迁移</strong>：当需要更换数据库时，只需替换工厂实现，一个配置项，轻松搞定；经理说新的数据库有问题，要撤回，还是一个配置项的活。</li>
</ol>
<p>说了这么多，应该回答那些问“为什么要接口层”的朋友了吧。</p>
<h2 data-id="heading-2">🏭 工厂模式：优雅地管理多数据库支持</h2>
<p>面对日益复杂的数据库生态，如何优雅地支持多种数据库？答案就是工厂模式：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> DatabaseFactory <span class="hljs-keyword">interface</span> {
    CreateDatabase(dbType <span class="hljs-type">string</span>, connStr <span class="hljs-type">string</span>) (Database, <span class="hljs-type">error</span>)
    CreateDatabaseWithPool(dbType <span class="hljs-type">string</span>, connStr <span class="hljs-type">string</span>, cfg <span class="hljs-keyword">interface</span>{}) (Database, <span class="hljs-type">error</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *DefaultDatabaseFactory)</span></span> createDatabase(dbType <span class="hljs-type">string</span>, connStr <span class="hljs-type">string</span>, cfg <span class="hljs-keyword">interface</span>{}) (Database, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">var</span> dialector gorm.Dialector

    <span class="hljs-keyword">switch</span> dbType {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"mysql"</span>:
        dialector = mysql.Open(connStr)
    <span class="hljs-keyword">case</span> <span class="hljs-string">"postgres"</span>:
        dialector = postgres.Open(connStr)
    <span class="hljs-keyword">case</span> <span class="hljs-string">"sqlserver"</span>:
        dialector = sqlserver.Open(connStr)
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"unsupported database type: %s"</span>, dbType)
    }

    <span class="hljs-comment">// 创建数据库连接</span>
    db, err := gorm.Open(dialector, &amp;gorm.Config{
        SkipDefaultTransaction: <span class="hljs-literal">true</span>,
        DisableForeignKeyConstraintWhenMigrating: <span class="hljs-literal">true</span>,
    })
    
    <span class="hljs-comment">// ... 连接池配置逻辑</span>
    
    <span class="hljs-comment">// 根据数据库类型返回相应实现</span>
    <span class="hljs-keyword">switch</span> dbType {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"postgres"</span>:
        <span class="hljs-keyword">return</span> NewPostgresDatabase(db), <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"mysql"</span>:
        <span class="hljs-keyword">return</span> NewMysqlDatabase(db), <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> &amp;EasyDatabase{DB: db, DBType: dbType}, <span class="hljs-literal">nil</span>
    }
}
</code></pre>
<p>这种设计不仅消除了重复代码，还为我们未来的扩展预留了充足空间。上面的为什么用接口已经说了很多了，这里就不再重复了。</p>
<h2 data-id="heading-3">🧮 PostgreSQL 数组类型：从痛点到优化</h2>
<p>这次 EasyMs 首选数据为什么是Postres？不为别的，只为开源，可控。</p>
<p>PostgreSQL 的数组类型是其一大特色，但也是许多 Go 开发者的痛点, 太多人往这个坑里跳。我们通过巧妙的设计解决了这个问题：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> (
    postgresArrayTypeMap = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]reflect.Type{
        <span class="hljs-string">"text[]"</span>:             reflect.TypeOf(PgStringArray{}),
        <span class="hljs-string">"varchar[]"</span>:          reflect.TypeOf(PgStringArray{}),
        <span class="hljs-string">"integer[]"</span>:          reflect.TypeOf(PgIntArray{}),
        <span class="hljs-string">"bigint[]"</span>:           reflect.TypeOf(PgIntArray{}),
        ...
    }

    typeCheckCache = sync.Map{} <span class="hljs-comment">// 并发安全的缓存</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getArrayTypeInfo</span><span class="hljs-params">(field reflect.StructField)</span></span> *ArrayTypeInfo {
    cacheKey := field.Type.String() + <span class="hljs-string">":"</span> + field.Tag.Get(<span class="hljs-string">"gorm"</span>)

    <span class="hljs-keyword">if</span> cached, ok := typeCheckCache.Load(cacheKey); ok {
        <span class="hljs-keyword">return</span> cached.(*ArrayTypeInfo)
    }

    <span class="hljs-comment">// 类型匹配逻辑...</span>
    
    typeCheckCache.Store(cacheKey, typeInfo)
    <span class="hljs-keyword">return</span> typeInfo
}
</code></pre>
<p>通过类型映射和缓存机制，我们大幅提升了数组类型处理的性能，同时保证了类型安全性。</p>
<h2 data-id="heading-4">🔄 读写分离：应对高并发的杀手锏</h2>
<p>面对高并发场景，关系型数据库的痛，如何有效的解决呢，有人不停的在索引优化上下功夫，当然没错，也因此我们一直在优化的路上，可真正能解决问题的方法是什么呢？那就是读写分离。读写分离是提升系统吞吐量的有效手段：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> ReadWriteSplitDatabase <span class="hljs-keyword">struct</span> {
    master      *gorm.DB   <span class="hljs-comment">// 主数据库（写操作）</span>
    replicas    []*gorm.DB <span class="hljs-comment">// 从数据库列表（读操作）</span>
    nextReplica <span class="hljs-type">uint32</span>     <span class="hljs-comment">// 下一个从库索引（用于轮询）</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *ReadWriteSplitDatabase)</span></span> getNextReplica() *gorm.DB {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rw.replicas) == <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> rw.master
    }

    next := atomic.AddUint32(&amp;rw.nextReplica, <span class="hljs-number">1</span>)
    index := (<span class="hljs-type">int</span>(next) - <span class="hljs-number">1</span>) % <span class="hljs-built_in">len</span>(rw.replicas)
    <span class="hljs-keyword">return</span> rw.replicas[index]
}
</code></pre>
<p>这套实现支持轮询和随机两种负载均衡策略，确保读请求均匀分布到各个从库，最大化利用硬件资源。</p>
<p><strong>用空间来换时间，一直是解决各类速率问题的关键思路</strong>。</p>
<h2 data-id="heading-5">🛡️ Redis 缓存防护：三剑客防穿透、击穿与雪崩</h2>
<p>缓存虽好，但若使用不当反而会成为系统的瓶颈。我们实现了完整的缓存防护机制：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *EasyRedis)</span></span> GetCacheWithProtection(
    key <span class="hljs-type">string</span>, 
    nullCacheExpire, mutexExpire <span class="hljs-type">int</span>, 
    fallback <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">error</span>)) (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">error</span>) {
    
    <span class="hljs-keyword">const</span> maxRetries = <span class="hljs-number">3</span>
    <span class="hljs-comment">// 限制重试次数，防止无限递归</span>
    
    ctx := context.Background()

    <span class="hljs-comment">// 1. 尝试从缓存获取</span>
    val, err := r.redis.Get(ctx, key).Result()
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 缓存命中处理...</span>
        <span class="hljs-keyword">return</span> result, <span class="hljs-literal">nil</span>
    }

    <span class="hljs-comment">// 2. 缓存未命中，尝试获取互斥锁</span>
    lockKey := key + <span class="hljs-string">":mutex"</span>
    lockAcquired, err := r.acquireLock(lockKey, mutexExpire)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> fallback()
    }

    <span class="hljs-keyword">if</span> !lockAcquired {
        <span class="hljs-comment">// 未获取到锁，短暂等待后重试</span>
        time.Sleep(time.Millisecond * time.Duration(<span class="hljs-number">10</span>+rand.Intn(<span class="hljs-number">100</span>)))
        <span class="hljs-keyword">return</span> r.getCacheWithProtection(key, nullCacheExpire, mutexExpire, fallback, retries+<span class="hljs-number">1</span>)
    }

    <span class="hljs-comment">// 3. 获取到锁，查询数据源</span>
    <span class="hljs-keyword">defer</span> r.releaseLock(lockKey)
    result, err := fallback()
    <span class="hljs-comment">// ... 缓存写入逻辑</span>
    
    <span class="hljs-keyword">return</span> result, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>这套机制有效防范了缓存三大问题：</p>
<ul>
<li><strong>穿透</strong>：通过空值缓存防止恶意请求直达数据库</li>
<li><strong>击穿</strong>：通过分布式锁确保同一时间只有一个请求查询数据库</li>
<li><strong>雪崩</strong>：通过随机过期时间避免大量缓存同时失效</li>
</ul>
<p>说到Redis的三大元凶，感兴趣的朋友可以去看一下不久前发布的文章&lt;《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy_HlCCIxJUeFckAhS6rBVw" target="_blank" title="https://mp.weixin.qq.com/s/y_HlCCIxJUeFckAhS6rBVw" ref="nofollow noopener noreferrer">别再栽在中间件上了：Golang 面试真正的分水岭</a>》。</p>
<h2 data-id="heading-6">🚀 生产环境部署考量</h2>
<p>我们完成了数据库层的代码，在生产环境中，这套数据库访问层还需要考虑：</p>
<ol>
<li><strong>监控告警</strong>：通过 Prometheus 等工具监控数据库连接数、查询延迟等关键指标</li>
<li><strong>慢查询日志</strong>：记录超过阈值的 SQL 查询，便于性能优化，这一部分很容易被忽视，但是确是最有用的，很多时候它可以拿来化解燃眉之急，前几天文章中提到的“<strong>限流、熔断、降级、隔离</strong>”对象最优先谁？就是它，运维工作，一拿一个准。</li>
<li><strong>故障转移</strong>：实现主从切换和故障自动恢复机制，我们从来不信没有故障得系统，这就是程序员得危机意识，危机来了，你得留好跑的方向啊.</li>
<li><strong>配置热更新</strong>：支持运行时动态调整连接池参数, 光有监控还不够，你得有拿回资源控制权的方法啊，配置就是你的杀手锏。</li>
</ol>
<h2 data-id="heading-7">📝 总结</h2>
<p>通过这篇文章，我们深入剖析了一套生产级 Go 数据库访问框架的设计与基本实现。从统一接口抽象到多数据库支持，从 PostgreSQL 数组类型优化到读写分离，再到 Redis 缓存防护，每一个环节都体现了工程实践的智慧。<strong>每一个环节都不是孤立存在的。</strong></p>
<p>这套实现已经在多个高并发项目中得到验证，能够稳定支撑日均千万级的数据库访问需求。当然，技术永远在演进，我们也期待社区能有更多的创新方案涌现。我们不求最好，但要求最稳，只有可控权要握在自己手上才能让我们睡得踏实。</p>
<p><strong>项目完整代码已开源</strong>：</p>
<ul>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flouis-xie-programmer%2Feasyms.golang" target="_blank" title="https://github.com/louis-xie-programmer/easyms.golang" ref="nofollow noopener noreferrer">github.com/louis-xie-p…</a></li>
<li><strong>Gitee</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flouis_xie%2Feasyms.golang" target="_blank" title="https://gitee.com/louis_xie/easyms.golang" ref="nofollow noopener noreferrer">gitee.com/louis_xie/e…</a></li>
</ul>
<hr/>
<p><em>如果你觉得这篇文章对你有帮助，欢迎分享给更多需要的朋友。在下一篇文章中，我们继续迭代 EasyMs，它是一个c初生儿, 还有很长的路要走，敬请期待！</em></p>
<p><strong>参考资料：</strong></p>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgorm.io%2Fdocs%2F" target="_blank" title="https://gorm.io/docs/" ref="nofollow noopener noreferrer">GORM 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Ftopics%2Fdistlock" target="_blank" title="https://redis.io/topics/distlock" ref="nofollow noopener noreferrer">Redis 分布式锁实现指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.postgresql.org%2Fdocs%2Fcurrent%2Farrays.html" target="_blank" title="https://www.postgresql.org/docs/current/arrays.html" ref="nofollow noopener noreferrer">PostgreSQL 数组类型最佳实践</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上下文工程：从 Manus 实践看 AI 智能体的成本与性能优化]]></title>    <link>https://juejin.cn/post/7585600621522042920</link>    <guid>https://juejin.cn/post/7585600621522042920</guid>    <pubDate>2025-12-21T07:47:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585600621522042920" data-draft-id="7585555806667538466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上下文工程：从 Manus 实践看 AI 智能体的成本与性能优化"/> <meta itemprop="keywords" content="AI编程,Agent,人工智能"/> <meta itemprop="datePublished" content="2025-12-21T07:47:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pursue_LLL"/> <meta itemprop="url" content="https://juejin.cn/user/817692379722311"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上下文工程：从 Manus 实践看 AI 智能体的成本与性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379722311/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pursue_LLL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T07:47:16.000Z" title="Sun Dec 21 2025 07:47:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Manus 与 LangChain 团队进行了一场深度对话，话题聚焦在一个被长期忽视的技术命题：<strong>上下文工程</strong>。</p>
<p>为什么说被忽视？因为大多数智能体开发者把精力放在提示词调优、模型选型、工具设计上，却很少系统性地思考「上下文本身」该如何管理。而 Manus 的实践表明，这恰恰是生产环境中最影响成本和性能的因素。</p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75d5ecc98a824ae98a27172a71dc238e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUHVyc3VlX0xMTA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766908036&amp;x-signature=mAP41Avw%2Bl4FRXXO1WrKSLpe%2F%2Bc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、核心问题：上下文腐烂</h2>
<h3 data-id="heading-1">1.1 什么是上下文腐烂？</h3>
<p>智能体与普通聊天机器人的关键区别在于：它需要频繁调用工具，而每次工具调用的结果都会被追加到上下文中。</p>
<p>想象一个典型的智能体任务：用户要求「分析这个 CSV 文件并生成报告」。智能体可能需要：</p>
<ol>
<li>读取 CSV 文件（工具调用 1，返回 5000 tokens 的文件内容）</li>
<li>分析数据结构（工具调用 2，返回 1000 tokens 的分析结果）</li>
<li>执行 Python 代码进行统计（工具调用 3-10，每次返回数百 tokens）</li>
<li>搜索相关背景知识（工具调用 11-15，每次返回 2000 tokens）</li>
<li>生成图表（工具调用 16-20）</li>
<li>撰写报告（工具调用 21-25）</li>
</ol>
<p>每一次工具调用的完整输入和输出都会被追加到上下文中。到第 25 次调用时，上下文可能已经膨胀到 50k-100k tokens。</p>
<p>Manus 披露的数据：</p>
<ul>
<li>平均每个任务涉及 <strong>50+ 次工具调用</strong></li>
<li>任务长度大约每 <strong>7 个月翻一番</strong></li>
<li>复杂任务可能涉及 <strong>上千次工具调用</strong></li>
</ul>
<h3 data-id="heading-2">1.2 上下文腐烂的三重后果</h3>
<p><strong>第一，成本急剧增加</strong></p>
<p>以 Claude 3 Sonnet 为例，输入价格为 $3/百万 tokens。一个 50 次工具调用的任务，假设每轮平均上下文为 30k tokens：</p>
<pre><code class="hljs language-ini" lang="ini">总输入成本 = 50 × 30,000 × $3/1,000,<span class="hljs-attr">000</span> = <span class="hljs-variable">$4</span>.<span class="hljs-number">5</span>

如果任务需要重试或涉及多轮迭代，成本会快速累积到数十美元。
</code></pre>
<p><strong>第二，延迟累积</strong></p>
<p>处理更长的上下文需要更多时间。首 token 延迟与上下文长度正相关：</p>
<ul>
<li>10k tokens: ~500ms</li>
<li>50k tokens: ~2s</li>
<li>100k tokens: ~5s</li>
</ul>
<p>对于需要实时交互的场景，这种延迟是不可接受的。</p>
<p><strong>第三，性能下降</strong></p>
<p>研究表明，模型性能会随着上下文长度而衰减。大多数模型在远低于上下文上限时就开始出现问题：</p>
<ul>
<li><strong>重复生成</strong>：模型开始重复之前说过的内容</li>
<li><strong>推理变慢</strong>：复杂推理能力下降</li>
<li><strong>遗忘早期内容</strong>：中间迷失现象</li>
<li><strong>指令遵循能力下降</strong>：更容易偏离用户的原始意图</li>
</ul>
<p>这种现象被称为「上下文腐烂」，通常在 200k tokens 左右开始显现。</p>
<hr/>
<h2 data-id="heading-3">二、最重要的单一指标：KV 缓存命中率</h2>
<h3 data-id="heading-4">2.1 为什么是 KV 缓存？</h3>
<p>Manus 团队的判断：</p>
<blockquote>
<p>「如果只能选择一个指标，键值缓存命中率是生产阶段智能体最重要的单一指标。」</p>
</blockquote>
<p>这个判断基于一个关键事实：<strong>智能体的输入输出比例约为 100:1</strong>。</p>
<p>普通聊天场景，用户输入 100 个字，模型输出 500 个字，输入输出比例约 1:5。但智能体场景完全不同——每一轮对话都要把所有历史（系统提示词 + 工具定义 + 之前所有的对话和工具调用结果）传给模型，而模型输出可能只是一个工具调用请求。</p>
<pre><code class="hljs language-makefile" lang="makefile">典型智能体的一轮对话：
输入：50,000 tokens（历史上下文）
输出：500 tokens（一个工具调用）
<span class="hljs-section">比例：100:1</span>
</code></pre>
<p>这意味着，<strong>优化输入成本的效果是优化输出成本的 100 倍</strong>。</p>
<h3 data-id="heading-5">2.2 什么是提示词缓存？</h3>
<p>提示词缓存是模型提供商提供的优化机制：</p>
<blockquote>
<p>如果连续两次 API 调用的提示词<strong>前缀相同</strong>，第二次调用可以复用第一次的计算结果。</p>
</blockquote>
<p>大模型的推理过程分为两个阶段：</p>
<ol>
<li><strong>预填充阶段</strong>：处理输入的所有 tokens，生成 KV 缓存</li>
<li><strong>解码阶段</strong>：逐个生成输出 tokens</li>
</ol>
<p>预填充阶段的计算量与输入长度成正比，是主要的延迟来源。如果输入的前缀与之前的请求相同，就可以直接复用之前计算好的 KV 缓存，跳过预填充阶段的大部分计算。</p>
<h3 data-id="heading-6">2.3 缓存命中的收益</h3>
<p>以各厂商的定价为例：</p>





























<table><thead><tr><th>厂商</th><th>原价（$/百万 tokens）</th><th>缓存命中价</th><th>折扣率</th></tr></thead><tbody><tr><td>Anthropic (Claude)</td><td>$3.00</td><td>$0.30</td><td>90%</td></tr><tr><td>DeepSeek</td><td>$0.14</td><td>$0.014</td><td>90%</td></tr><tr><td>OpenAI</td><td>$2.50</td><td>$1.25</td><td>50%</td></tr></tbody></table>
<p><strong>缓存命中意味着</strong>：</p>
<ul>
<li><strong>成本降低 50-90%</strong></li>
<li><strong>延迟大幅减少</strong>（跳过预填充计算）</li>
<li><strong>吞吐量提升</strong>（相同算力可处理更多请求）</li>
</ul>
<p>对于一个日均百万次调用的智能体服务，缓存命中率从 50% 提升到 90%，每月可节省数十万美元。</p>
<h3 data-id="heading-7">2.4 前缀匹配的工作原理</h3>
<p>缓存基于<strong>字节级前缀匹配</strong>，这是理解所有优化策略的基础：</p>
<pre><code class="hljs language-ini" lang="ini">第一次调用:
<span class="hljs-section">[System Prompt]</span><span class="hljs-section">[Tool Definitions]</span><span class="hljs-section">[User Message 1]</span><span class="hljs-section">[Tool Output 1]</span>
                                                  ↑
                                           缓存写入到这里

第二次调用:
<span class="hljs-section">[System Prompt]</span><span class="hljs-section">[Tool Definitions]</span><span class="hljs-section">[User Message 1]</span><span class="hljs-section">[Tool Output 1]</span><span class="hljs-section">[User Message 2]</span>
└──────────────────────── 完全相同的前缀 ────────────────────────┘
                                 ↓
                           可以复用缓存！

第三次调用（前缀被破坏）:
<span class="hljs-section">[System Prompt v2]</span><span class="hljs-section">[Tool Definitions]</span><span class="hljs-section">[User Message 1]</span><span class="hljs-section">[Tool Output 1]</span><span class="hljs-section">[User Message 2]</span>
        ↑
  这里变了，后面的缓存全部失效！
</code></pre>
<p><strong>关键约束</strong>：</p>
<ul>
<li>缓存基于<strong>字节级</strong>前缀匹配，哪怕差一个空格也会失效</li>
<li>任何位置的修改都会破坏从该位置开始的缓存</li>
<li>前面的内容改变，后面的缓存<strong>全部失效</strong></li>
</ul>
<p>这就解释了为什么「前缀稳定性」如此重要——系统提示词和工具定义位于上下文的最前面，一旦变化，整个缓存链条都会断裂。</p>
<hr/>
<h2 data-id="heading-8">三、五个维度的平衡艺术</h2>
<p>Manus 将上下文工程分为五个相互关联的维度：</p>



































<table><thead><tr><th>维度</th><th>范畴</th><th>核心含义</th></tr></thead><tbody><tr><td><strong>卸载</strong></td><td>长期持久化</td><td>把信息从上下文搬到外部存储，跨任务复用</td></tr><tr><td><strong>缩减</strong></td><td>会话级上下文</td><td>过滤 + 压缩 + 摘要，减少当前会话的上下文体积</td></tr><tr><td><strong>检索</strong></td><td>信息恢复</td><td>从外部状态（文件系统、数据库）恢复被卸载或缩减的信息</td></tr><tr><td><strong>隔离</strong></td><td>架构设计</td><td>子智能体独立上下文，过程噪音不污染主上下文</td></tr><tr><td><strong>缓存</strong></td><td>推理优化</td><td>优化 KV 缓存命中率，降低推理成本</td></tr></tbody></table>
<h3 data-id="heading-9">3.1 五维度的相互作用</h3>
<pre><code class="hljs language-scss" lang="scss">                    ┌─────────────┐
                    │   缓存层    │
                    │ (推理优化)  │
                    └──────┬──────┘
                           │ 影响
                           ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   卸载      │◄──►│   缩减      │◄──►│   隔离      │
│ (长期存储)  │    │ (会话管理)  │    │ (架构设计)  │
└──────┬──────┘    └──────┬──────┘    └─────────────┘
       │                  │
       └────────┬─────────┘
                ▼
         ┌─────────────┐
         │   检索      │
         │ (信息恢复)  │
         └─────────────┘
</code></pre>
<p>这五个维度并非相互独立，而是存在复杂的相互作用：</p>
<blockquote>
<p>「卸载和检索使得缩减更为高效，而稳定的检索则使隔离变得安全。但隔离又会减慢上下文的传递速度，降低缩减的频率。然而，更多的隔离和缩减又会影响缓存效率和输出质量。所以，归根结底，上下文工程是一门艺术与科学，它要求在多个可能相互冲突的目标之间找到完美的平衡。这真的很难。」</p>
</blockquote>
<p>下面逐一展开。</p>
<hr/>
<h2 data-id="heading-10">四、上下文卸载：长期持久化</h2>
<p>卸载面向<strong>长期</strong>，目的是把信息从上下文搬到外部存储，实现跨任务复用。</p>
<h3 data-id="heading-11">4.1 为什么需要卸载？</h3>
<p>上下文窗口是「短期记忆」，有容量限制，且会话结束后消失。卸载的核心思想是：</p>
<blockquote>
<p>「信息被外部化了，没有真正丢失。只要信息能从外部状态重建，就应该从上下文中剔除。」</p>
</blockquote>
<p>卸载解决两类问题：</p>
<ol>
<li><strong>长期知识的持久化</strong>：用户偏好、项目背景、过往发现</li>
<li><strong>工具定义的外部化</strong>：减少工具占用的上下文空间</li>
</ol>
<h3 data-id="heading-12">4.2 长期记忆系统</h3>
<p>智能体可以主动将重要信息存储到外部，以便在未来的任务中复用。</p>
<p><strong>适合卸载的内容</strong>：</p>
<ul>
<li><strong>用户偏好</strong>：代码风格、语言习惯、输出格式偏好</li>
<li><strong>项目背景</strong>：技术栈、架构设计、团队规范</li>
<li><strong>任务历史</strong>：过往任务的关键发现、解决方案</li>
<li><strong>领域知识</strong>：专业术语、业务规则</li>
</ul>
<p><strong>记忆的存储形式</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user_123"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"memories"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户偏好使用 TypeScript 而非 JavaScript"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对话记录"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-12-20"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"importance"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"high"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"项目使用 Next.js 14 + Tailwind CSS"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"代码分析"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-12-18"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"importance"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"high"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>记忆的检索时机</strong>：</p>
<ul>
<li>新对话开始时，检索用户相关的长期记忆</li>
<li>遇到特定领域问题时，检索领域知识</li>
<li>任务规划时，检索过往类似任务的经验</li>
</ul>
<h3 data-id="heading-13">4.3 技能系统：工具定义的卸载</h3>
<p>随着系统变得越来越复杂，工具本身也会占用大量上下文：</p>
<blockquote>
<p>「上下文中工具过多会导致混乱，我们称之为'上下文混淆'，模型可能会调用错误的工具，甚至是不存在的工具。所以我们必须找到一种方法，也能卸载工具。」</p>
</blockquote>
<p><strong>问题分析</strong>：</p>
<p>假设一个智能体有 50 个工具，每个工具定义平均 500 tokens：</p>
<pre><code class="hljs language-ini" lang="ini">工具定义总占用 = 50 × <span class="hljs-attr">500</span> = <span class="hljs-number">25</span>,<span class="hljs-number">000</span> tokens
</code></pre>
<p>这 25k tokens 在<strong>每一轮对话</strong>都要传递给模型，即使大多数工具在当前任务中根本用不到。</p>
<p><strong>动态检索增强的问题</strong>：</p>
<p>一个常见的解决方案是对工具描述进行动态检索增强——根据当前任务按需加载工具。但这也会带来问题：</p>
<ol>
<li><strong>破坏缓存</strong>：工具定义位于上下文的前端，每次变动都会导致 KV 缓存重置</li>
<li><strong>历史混乱</strong>：模型过去对那些已被移除的工具的调用记录仍然存在于上下文中，这可能会误导模型</li>
</ol>
<p><strong>Manus 的解决方案：分层式行为空间</strong></p>
<p>Manus 试验了一种三层设计：</p>





























<table><thead><tr><th>层级</th><th>模型可见性</th><th>示例</th><th>上下文占用</th></tr></thead><tbody><tr><td><strong>第一层：函数调用</strong></td><td>可见</td><td>read_file, shell_exec, web_search</td><td>~5,000 tokens</td></tr><tr><td><strong>第二层：沙盒工具</strong></td><td>不可见</td><td>grep, ffmpeg, awk, curl</td><td>0</td></tr><tr><td><strong>第三层：软件包与 API</strong></td><td>不可见</td><td>Pandas, Numpy, requests, 外部 API</td><td>0</td></tr></tbody></table>
<p><strong>工作原理</strong>：</p>
<ul>
<li>模型只看到约 10 个核心「元工具」（如 <code>shell_exec</code>、<code>python_execute</code>）</li>
<li>通过这些元工具，模型可以调用第二、三层的任意工具</li>
<li>第二、三层的工具定义不进入上下文，而是存储在文件系统中</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户请求：「分析这个视频的音频质量」

传统方式（工具都在上下文中）：
<span class="hljs-selector-attr">[ffmpeg_tool]</span> <span class="hljs-selector-attr">[audio_analyzer_tool]</span> <span class="hljs-selector-attr">[spectral_tool]</span> ... 
→ <span class="hljs-number">50</span> 个工具定义，<span class="hljs-number">25</span>k tokens

Manus 方式（分层行为空间）：
<span class="hljs-selector-attr">[shell_exec_tool]</span> <span class="hljs-selector-attr">[python_execute_tool]</span>
→ 模型通过 shell_exec 调用 ffmpeg
→ <span class="hljs-number">2</span> 个工具定义，<span class="hljs-number">1</span>k tokens
</code></pre>
<p><strong>效果</strong>：</p>
<ul>
<li><strong>最大化缓存命中率</strong>：模型可见的工具定义极度稳定（约 10 个核心工具）</li>
<li><strong>零额外占用</strong>：第二、三层的海量工具不占用上下文</li>
<li><strong>无限扩展</strong>：熟悉 Linux/Python 就拥有无限工具箱</li>
</ul>
<h3 data-id="heading-14">4.4 Anthropic 的解决方案：技能系统</h3>
<p>Anthropic 在 Claude for Enterprise 中采用了另一种思路——技能系统（Skill System）。</p>
<p><strong>核心思想</strong>：</p>
<ul>
<li>把复杂工具的使用方法封装为「技能文档」</li>
<li>技能文档存储在文件系统中，不进入上下文</li>
<li>模型需要使用某个技能时，按需加载对应的技能文档</li>
</ul>
<p><strong>技能文档的结构</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 技能名称：数据可视化</span>

<span class="hljs-section">## 适用场景</span>
<span class="hljs-bullet">-</span> 需要生成图表、数据可视化
<span class="hljs-bullet">-</span> 支持的图表类型：折线图、柱状图、饼图、散点图

<span class="hljs-section">## 使用方法</span>
<span class="hljs-bullet">1.</span> 准备数据：确保数据为 CSV 或 JSON 格式
<span class="hljs-bullet">2.</span> 调用 python<span class="hljs-emphasis">_execute，使用 matplotlib 或 plotly
3. 保存图表到 /workspace/charts/

## 示例代码
​```python
import matplotlib.pyplot as plt
import pandas as pd

df = pd.read_</span>csv('data.csv')
plt.figure(figsize=(10, 6))
plt.bar(df['category'], df['value'])
plt.savefig('/workspace/charts/output.png')
​<span class="hljs-code">```

## 注意事项
- 中文需要设置字体：plt.rcParams['font.sans-serif'] = ['SimHei']
- 大数据集建议使用 plotly，支持交互式图表
</span></code></pre>
<p><strong>与 Manus 方案的对比</strong>：</p>






























<table><thead><tr><th>维度</th><th>Manus 分层行为空间</th><th>Anthropic 技能系统</th></tr></thead><tbody><tr><td><strong>抽象层次</strong></td><td>底层工具（shell、python）</td><td>高层能力（数据可视化、文档处理）</td></tr><tr><td><strong>学习曲线</strong></td><td>需要模型熟悉 Linux/Python</td><td>技能文档自包含，降低认知负担</td></tr><tr><td><strong>可维护性</strong></td><td>依赖模型的通用能力</td><td>技能文档可独立更新、版本管理</td></tr><tr><td><strong>缓存友好性</strong></td><td>工具定义极度稳定</td><td>技能按需加载，可能影响缓存</td></tr></tbody></table>
<p><strong>实际应用中的选择</strong>：</p>
<ul>
<li>Manus 方案适合技术能力强的场景，模型自由度高</li>
<li>技能系统适合标准化流程，可控性强，便于团队协作</li>
</ul>
<h3 data-id="heading-15">4.5 Scratchpad 模式：主动外部化</h3>
<p>除了系统自动的卸载，智能体还可以主动将关键发现写入文件（如 <code>/workspace/notes/</code>），这是独立于系统压缩/摘要的第一道防线。</p>






























<table><thead><tr><th>特性</th><th>主动外部化</th><th>系统压缩</th></tr></thead><tbody><tr><td><strong>触发者</strong></td><td>智能体自己（提示词引导）</td><td>系统自动（&gt; 阈值 tokens）</td></tr><tr><td><strong>存储内容</strong></td><td>提炼后的关键发现（50-200 tokens）</td><td>原始工具输出（5000+ tokens）</td></tr><tr><td><strong>恢复成本</strong></td><td>低（读取简短笔记）</td><td>高（读取原始大文件）</td></tr><tr><td><strong>存储位置</strong></td><td><code>/workspace/notes/</code>（用户可见）</td><td><code>.context/</code>（系统目录）</td></tr></tbody></table>
<p><strong>价值</strong>：在长对话中，主动外部化可避免恢复时重读大量原始数据。</p>
<hr/>
<h2 data-id="heading-16">五、上下文缩减：会话级管理</h2>
<p>缩减面向<strong>短期</strong>，目的是管理当前会话的上下文体积。包含三种策略：过滤、压缩、摘要。</p>
<h3 data-id="heading-17">5.1 过滤：入口拦截</h3>
<p>当工具返回超大结果时，系统自动拦截并转移到文件系统，同时生成智能预览传给模型。</p>
<p><strong>触发条件</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">单个工具结果</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">5000 </span><span class="hljs-string">tokens</span> <span class="hljs-string">→</span> <span class="hljs-string">触发过滤</span>
</code></pre>
<p><strong>任务感知的混合过滤策略</strong>：</p>
<p>关键设计是根据内容类型选择不同的过滤策略：</p>















































<table><thead><tr><th>内容类型</th><th>过滤器</th><th>策略详情</th><th>需要模型</th></tr></thead><tbody><tr><td><strong>JSON</strong></td><td>结构化过滤</td><td>提取键名、数组长度、嵌套结构</td><td>❌</td></tr><tr><td><strong>XML</strong></td><td>结构化过滤</td><td>提取标签层级、属性摘要</td><td>❌</td></tr><tr><td><strong>代码</strong></td><td>结构化过滤</td><td>提取函数/类签名、导入语句</td><td>❌</td></tr><tr><td><strong>HTML</strong></td><td>语义过滤</td><td>模型生成任务相关摘要</td><td>✅</td></tr><tr><td><strong>Markdown</strong></td><td>语义过滤</td><td>模型生成任务相关摘要</td><td>✅</td></tr><tr><td><strong>纯文本</strong></td><td>语义过滤</td><td>模型生成任务相关摘要</td><td>✅</td></tr></tbody></table>
<p><strong>为什么要区分？</strong></p>
<p>结构化内容有明确的语法结构，可以用代码快速提取关键信息，无需调用大模型，成本为零。</p>
<p>非结构化内容需要理解语义才能有效摘要，必须借助大模型。</p>
<p><strong>任务感知</strong>：</p>
<p>过滤器不只是机械地提取结构信息，而是根据用户的查询意图提取<strong>相关</strong>信息。</p>
<pre><code class="hljs language-arduino" lang="arduino">用户查询：「这个网页上有哪些产品的价格？」
工具返回：一个 <span class="hljs-number">50</span>,<span class="hljs-number">000</span> tokens 的网页 HTML

任务无关的过滤：提取所有 &lt;div&gt; 标签结构
任务感知的过滤：提取所有 <span class="hljs-keyword">class</span>=<span class="hljs-string">"price"</span> 和 <span class="hljs-keyword">class</span>=<span class="hljs-string">"product-name"</span> 的内容
</code></pre>
<p><strong>过滤后的格式</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">FILTERED: web_fetch_tool</span>
<span class="hljs-section">URL: https://example.com/products</span>
<span class="hljs-section">FILE: /workspace/.context/web_fetch_xxx.html</span>
<span class="hljs-section">PREVIEW: [任务相关的摘要，约 500 tokens]</span>
<span class="hljs-section">RECOVER: 需要完整内容时，读取上述文件</span>
</code></pre>
<h3 data-id="heading-18">5.2 压缩：可逆的紧凑格式</h3>
<p>当总上下文达到阈值时，系统将历史中的旧工具调用结果转换为紧凑格式。</p>
<p><strong>触发条件</strong>：</p>
<pre><code class="hljs">总上下文 &gt; 60,000 tokens（可配置）
且预计节省 &gt; 3,000 tokens（避免小清理破坏缓存）
</code></pre>
<p><strong>信息外部化</strong></p>
<p>Manus 的解释：</p>
<blockquote>
<p>「假设你有一个向文件写入的工具，它可能有两个字段：路径和内容。一旦工具执行完毕，你可以确保该文件已经存在于环境中。因此，在紧凑格式中，我们可以安全地去掉超长的内容字段，只保留路径。如果你的智能体足够聪明，当它需要再次读取该文件时，只需通过路径即可检索。」</p>
<p>「这样一来，没有任何信息真正丢失，只是被外部化了。我们认为这种可逆性至关重要，因为智能体需要基于之前的行为和观察进行链式预测，你永远不知道哪个过去的行为会在十步之后突然变得极其重要。这是无法预测的。」</p>
</blockquote>
<p><strong>完整格式 vs 紧凑格式</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">【完整格式 - <span class="hljs-number">5</span>,<span class="hljs-number">000</span> tokens】
{
  <span class="hljs-string">"tool"</span>: <span class="hljs-string">"web_search_tool"</span>,
  <span class="hljs-string">"arguments"</span>: {
    <span class="hljs-string">"query"</span>: <span class="hljs-string">"Claude API pricing 2024"</span>
  },
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"sources"</span>: [
      {
        <span class="hljs-string">"title"</span>: <span class="hljs-string">"Claude API Pricing | Anthropic"</span>,
        <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://www.anthropic.com/pricing"</span>,
        <span class="hljs-string">"snippet"</span>: <span class="hljs-string">"Claude 3.5 Sonnet: $3/M input tokens, $15/M output tokens..."</span>
      },
      // ... <span class="hljs-number">20</span> 个搜索结果，每个 <span class="hljs-number">200</span> tokens
    ],
    <span class="hljs-string">"summary"</span>: <span class="hljs-string">"Claude API 定价如下：..."</span>
  }
}

【紧凑格式 - <span class="hljs-number">150</span> tokens】
<span class="hljs-symbol">COMPACTED:</span> web_search_tool
<span class="hljs-symbol">QUERY:</span> Claude API pricing <span class="hljs-number">2024</span>
<span class="hljs-symbol">FILE:</span> /workspace/.context/web_search_20241220_153000.txt
<span class="hljs-symbol">RECOVER:</span> cat &lt;FILE&gt; <span class="hljs-keyword">with</span> bash_tool
<span class="hljs-symbol">META:</span> tokens_saved=<span class="hljs-number">4850</span> time=<span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">20</span>T15:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>
</code></pre>
<p><strong>压缩策略</strong>：</p>
<p>不同工具类型有不同的压缩规则：</p>



































<table><thead><tr><th>工具类型</th><th>保留字段</th><th>移除字段</th></tr></thead><tbody><tr><td><code>web_search_tool</code></td><td>query, source_count</td><td>完整搜索结果</td></tr><tr><td><code>file_write_tool</code></td><td>path</td><td>content（文件已存在）</td></tr><tr><td><code>file_read_tool</code></td><td>path</td><td>content（可重新读取）</td></tr><tr><td><code>code_execute_tool</code></td><td>code_summary, exit_code</td><td>完整输出</td></tr><tr><td><code>web_fetch_tool</code></td><td>url, status_code</td><td>网页内容</td></tr></tbody></table>
<p><strong>部分压缩策略</strong>：</p>
<p>压缩不意味着压缩整个历史记录。Manus 的做法是：</p>
<ul>
<li>只压缩<strong>最旧的 50%</strong> 的工具调用</li>
<li><strong>保留最近 5 次</strong>调用的完整格式</li>
<li>这样模型仍然有新鲜的示例来学习如何正确使用工具</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">对话历史（20</span> <span class="hljs-string">次工具调用）:</span>
<span class="hljs-string">┌──────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">调用</span> <span class="hljs-attr">1-10:</span> <span class="hljs-string">转为紧凑格式（节省约</span> <span class="hljs-number">40</span><span class="hljs-string">,000</span> <span class="hljs-string">tokens）</span>          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">调用</span> <span class="hljs-attr">11-15:</span> <span class="hljs-string">转为紧凑格式（节省约</span> <span class="hljs-number">20</span><span class="hljs-string">,000</span> <span class="hljs-string">tokens）</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">调用</span> <span class="hljs-attr">16-20:</span> <span class="hljs-string">保留完整格式（作为少样本示例）</span>               <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-19">5.3 摘要：不可逆的最后手段</h3>
<p>压缩也有其极限。最终，上下文仍然会增长并触及上限。这时，Manus 会将压缩与更传统的摘要结合起来，但做得非常谨慎。</p>
<p><strong>触发条件</strong>：</p>
<pre><code class="hljs">总上下文 &gt;= 150,000 tokens（可配置）
</code></pre>
<p><strong>为什么摘要是最后手段？</strong></p>
<p>摘要是<strong>不可逆</strong>操作，一旦执行，原始消息结构被替换，无法恢复。这与压缩的本质区别在于：</p>
<ul>
<li>压缩：信息外部化到文件，可以随时读回</li>
<li>摘要：信息被大模型重新生成，原始细节丢失</li>
</ul>
<p><strong>有损但可追溯策略</strong>：</p>
<p>Manus 的做法：</p>
<blockquote>
<p>「在进行摘要之前，我们可能会将上下文的关键部分卸载到文件中。有时，我们甚至会更激进，将整个摘要前的上下文转储为一个文本文件或日志文件，以便日后随时恢复。如果模型足够聪明，它甚至知道如何检索那些被摘要前的上下文。」</p>
</blockquote>
<p><strong>工作流程</strong>：</p>
<ol>
<li><strong>备份</strong>：将完整上下文转储到 <code>/workspace/.context/summary_dump_xxx.txt</code></li>
<li><strong>摘要</strong>：基于完整数据生成结构化摘要</li>
<li><strong>替换</strong>：上下文中只保留摘要 + 备份文件路径</li>
<li><strong>恢复</strong>：模型可用 grep 命令检索原始细节</li>
</ol>
<p><strong>结构化摘要格式</strong>：</p>
<p>关于摘要格式，建议使用固定模式而非自由形式：</p>
<blockquote>
<p>「不要使用自由形式的提示让 AI 生成所有内容，而是定义一个模式，就像一个有很多字段的表单，让 AI 去填写。如果你使用这种更结构化的模式，至少输出会比较稳定。」</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"user_goal"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析订单数据并生成销售报告"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"completed_actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"读取 orders.csv（10,000 条订单记录）"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"按月份统计销售额"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"分析退货原因分布"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"生成可视化图表 4 张"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"key_findings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"2024 年总销售额 $1.2M，同比增长 15%"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"退货率 5.2%，主要原因是尺寸问题（占 65%）"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"Q4 销售额占全年 40%"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files_modified"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"/workspace/reports/sales_2024.md"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"/workspace/charts/monthly_sales.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"/workspace/charts/return_reasons.png"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"pending_tasks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"生成 PDF 版本报告"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"last_action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"保存 Markdown 报告"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>保留最近调用的重要性</strong>：</p>
<p>Manus 的经验：</p>
<blockquote>
<p>「保留几个完整的工具调用和结果示例非常有帮助。因为这能让模型知道它上次停在了哪里，从而更平滑地继续工作。否则，你会发现摘要之后，模型有时会改变其风格和语气。」</p>
</blockquote>
<h3 data-id="heading-20">5.4 一个关键洞察：紧凑格式也占空间</h3>
<p>摘要不会「永远不触发」。关键在于<strong>紧凑格式本身也占空间</strong>（约 150 tokens/个）：</p>

































<table><thead><tr><th>工具调用数</th><th>紧凑格式累积</th><th>其他消息</th><th>总计</th><th>触发摘要？</th></tr></thead><tbody><tr><td>100</td><td>~15,000</td><td>20,000</td><td>35,000</td><td>❌</td></tr><tr><td>500</td><td>~75,000</td><td>30,000</td><td>105,000</td><td>❌</td></tr><tr><td>1000</td><td>~150,000</td><td>40,000</td><td>190,000</td><td>✅</td></tr></tbody></table>
<p>当对话非常长（上千次工具调用）时，紧凑格式累积最终会超过摘要阈值，此时必须触发摘要。</p>
<h3 data-id="heading-21">5.5 三者的执行顺序</h3>
<pre><code class="hljs language-markdown" lang="markdown">工具调用返回时
<span class="hljs-code">    │
    └─ 结果是否超大（&gt; 5k tokens）？
           │
           ├─ 是 → 【过滤】
           │       ├─ 完整结果存入文件
           │       ├─ 生成任务相关预览
           │       └─ 预览进入上下文
           │
           └─ 否 → 完整结果进入上下文
                       │
                       ↓
每轮对话结束后检查总上下文
    │
    ├─ 总上下文 &lt; 60k tokens
    │   └─ 正常运行，无需处理
    │
    ├─ 60k ~ 150k tokens
    │   └─ 【压缩】
    │       ├─ 检查压缩收益是否 &gt; 3k tokens
    │       ├─ 压缩最旧的 50% 工具调用
    │       ├─ 保留最近 5 次完整格式
    │       └─ 原始结果存入文件系统
    │
    └─ &gt; 150k tokens
        └─ 【摘要】
            ├─ 备份完整上下文到文件
            ├─ 生成结构化摘要
            ├─ 保留最近 5 次完整工具调用
            └─ 用摘要替换历史消息（不可逆）
</span></code></pre>
<h3 data-id="heading-22">5.6 阈值管理的经验值</h3>
<p>关于阈值的经验值：</p>
<blockquote>
<p>「通过大量的评估，确定那个'腐烂前'的阈值非常重要，通常在 128k 到 200k 之间。我们将它作为触发上下文缩减的信号。」</p>
</blockquote>
<p>根据场景调整阈值：</p>








































<table><thead><tr><th>场景</th><th>压缩阈值</th><th>摘要阈值</th><th>最小节省阈值</th><th>原因</th></tr></thead><tbody><tr><td>短对话（&lt;10 轮）</td><td>80k</td><td>180k</td><td>10k+</td><td>剩余轮数少，缓存价值高</td></tr><tr><td>长对话（&gt;30 轮）</td><td>60k</td><td>150k</td><td>2-3k</td><td>剩余轮数多，节省效果累积</td></tr><tr><td>研究任务</td><td>60k</td><td>150k</td><td>5k</td><td>大量工具调用，上下文增长快</td></tr><tr><td>实时交互</td><td>80k</td><td>180k</td><td>8k+</td><td>低延迟优先，避免频繁压缩</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-23">六、上下文隔离：子智能体的独立上下文</h2>
<p>这一策略来自 Anthropic 的多智能体架构设计。</p>
<h3 data-id="heading-24">6.1 为什么需要隔离？</h3>
<p>核心思想是：子智能体拥有独立的上下文窗口，其探索过程中的「噪音」不会污染主智能体的上下文。</p>
<p><strong>场景示例</strong>：</p>
<p>用户请求：「调研一下 2024 年最新的 AI Agent 框架，给出对比分析」</p>
<p>如果不使用隔离，主智能体需要：</p>
<ol>
<li>搜索「AI Agent 框架 2024」</li>
<li>访问 10+ 个网页，每个 5000 tokens</li>
<li>阅读多篇技术博客和论文</li>
<li>整理对比表格</li>
</ol>
<p>整个过程产生的上下文：10 × 5000 = 50,000+ tokens，全部进入主智能体上下文。</p>
<p><strong>使用隔离后</strong>：</p>
<ul>
<li>主智能体调用 <code>researcher_tool</code>，传入研究主题</li>
<li>子智能体在独立上下文中完成调研</li>
<li>子智能体返回精炼的摘要（~1000 tokens）+ 完整报告文件路径</li>
<li>主智能体上下文只增加 1000 tokens</li>
</ul>
<h3 data-id="heading-25">6.2 隔离的工作原理</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">主智能体上下文窗口</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span> [<span class="hljs-string">System</span> <span class="hljs-string">Prompt</span>] [<span class="hljs-string">Tools</span>] [<span class="hljs-attr">User:</span> <span class="hljs-string">调研</span> <span class="hljs-string">AI</span> <span class="hljs-string">Agent</span> <span class="hljs-string">框架</span>]           <span class="hljs-string">│</span>
<span class="hljs-string">│</span> [<span class="hljs-attr">Tool Call:</span> <span class="hljs-string">researcher_tool(topic="AI</span> <span class="hljs-string">Agent</span> <span class="hljs-string">框架</span> <span class="hljs-number">2024</span><span class="hljs-string">")]    │
│ [Tool Result: {summary: "</span><span class="hljs-string">..."</span>, <span class="hljs-attr">file:</span> <span class="hljs-string">"/reports/xxx.json"</span>}]  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">上下文增量：~1000</span> <span class="hljs-string">tokens</span>                                     <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────┘</span>

<span class="hljs-string">子智能体上下文窗口（独立）</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span> [<span class="hljs-attr">System Prompt:</span> <span class="hljs-string">你是研究员...</span>]                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span> [<span class="hljs-attr">web_search:</span> <span class="hljs-string">AI</span> <span class="hljs-string">Agent</span> <span class="hljs-string">框架</span> <span class="hljs-number">2024</span>] <span class="hljs-string">→</span> <span class="hljs-string">结果</span> <span class="hljs-number">5000 </span><span class="hljs-string">tokens</span>          <span class="hljs-string">│</span>
<span class="hljs-string">│</span> [<span class="hljs-attr">web_fetch:</span> <span class="hljs-string">langchain.com</span>] <span class="hljs-string">→</span> <span class="hljs-string">结果</span> <span class="hljs-number">8000 </span><span class="hljs-string">tokens</span>               <span class="hljs-string">│</span>
<span class="hljs-string">│</span> [<span class="hljs-attr">web_fetch:</span> <span class="hljs-string">crewai.com</span>] <span class="hljs-string">→</span> <span class="hljs-string">结果</span> <span class="hljs-number">6000 </span><span class="hljs-string">tokens</span>                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span> [<span class="hljs-attr">web_fetch:</span> <span class="hljs-string">autogen.com</span>] <span class="hljs-string">→</span> <span class="hljs-string">结果</span> <span class="hljs-number">7000 </span><span class="hljs-string">tokens</span>                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">...</span> <span class="hljs-string">更多搜索和访问</span> <span class="hljs-string">...</span>                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">上下文累积：~80,000</span> <span class="hljs-string">tokens（全部隔离，不影响主智能体）</span>         <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-26">6.3 隔离后的返回格式</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"topic"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AI Agent 框架 2024 对比分析"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"summary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"经过调研，2024 年主流的 AI Agent 框架包括 LangChain、CrewAI、AutoGen、Semantic Kernel 等。LangChain 生态最完善但学习曲线较陡；CrewAI 专注多智能体协作..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"key_points"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"LangChain: 生态最完善，社区活跃，但抽象层次多"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"CrewAI: 多智能体协作首选，API 简洁"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"AutoGen: 微软出品，与 Azure 深度集成"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"Semantic Kernel: 企业级首选，支持 .NET/Python/Java"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"comparison_table"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"详见完整报告"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_isolated"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_full_result_file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/workspace/research_results/ai_agent_frameworks_2024.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_full_result_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">85000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_read_instruction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"完整研究报告（85000 tokens）已保存，如需细节请读取上述文件"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-27">6.4 隔离的类比</h3>
<blockquote>
<p>「子智能体可能累积数万 token 的过程噪音，但这些 token 被隔离在其独立上下文中——主智能体只接收精炼后的结论。这类似于组织中的层级汇报：基层员工处理大量细节，向上级仅提交摘要和结论。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-28">七、缓存优化的核心原理</h2>
<h3 data-id="heading-29">7.1 Manus 的三条铁律</h3>
<p><strong>铁律一：保持提示前缀稳定</strong></p>
<blockquote>
<p>「由于大模型的自回归特性，即使是单个 token 的差异也会使该 token 之后的缓存失效。一个常见的错误是在系统提示的开头包含时间戳。」</p>
</blockquote>
<p><strong>❌ 错误做法</strong>：</p>
<pre><code class="hljs language-python" lang="python">system_prompt = <span class="hljs-string">f"""
当前时间：<span class="hljs-subst">{datetime.now()}</span>
你是一个专业的 AI 助手...
"""</span>
</code></pre>
<p>每次调用，时间戳都不同，导致整个系统提示词的缓存失效。</p>
<p><strong>✅ 正确做法</strong>：</p>
<pre><code class="hljs language-python" lang="python">system_prompt = <span class="hljs-string">"""
你是一个专业的 AI 助手。
动态上下文信息会在用户消息中提供。
"""</span>

user_message = <span class="hljs-string">f"""
[当前上下文]
时间：<span class="hljs-subst">{datetime.now()}</span>
用户偏好：<span class="hljs-subst">{preferences}</span>

[用户问题]
<span class="hljs-subst">{user_query}</span>
"""</span>
</code></pre>
<p><strong>铁律二：使上下文只追加</strong></p>
<blockquote>
<p>「避免修改之前的操作或观察。确保你的序列化是确定性的。许多编程语言和库在序列化 JSON 对象时不保证键顺序的稳定性。」</p>
</blockquote>
<p><strong>常见陷阱</strong>：</p>
<ol>
<li><strong>Python dict 序列化顺序不稳定</strong>（Python 3.7+ 已按插入顺序，但不同版本可能有差异）</li>
<li><strong>浮点数精度问题</strong>：<code>0.1 + 0.2</code> 可能产生 <code>0.30000000000000004</code></li>
<li><strong>随机 ID</strong>：每次生成不同的 UUID 或时间戳</li>
</ol>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 确保键顺序稳定</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">stable_serialize</span>(<span class="hljs-params">obj</span>):
    <span class="hljs-keyword">return</span> json.dumps(obj, sort_keys=<span class="hljs-literal">True</span>, ensure_ascii=<span class="hljs-literal">False</span>)
</code></pre>
<p><strong>铁律三：明确标记缓存断点</strong></p>
<blockquote>
<p>「某些模型提供商或推理框架不支持自动增量前缀缓存，而是需要在上下文中手动插入缓存断点。」</p>
</blockquote>
<p>Anthropic 的 <code>cache_control</code> 示例：</p>
<pre><code class="hljs language-python" lang="python">messages = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"你是一个专业的 AI 助手..."</span>,
                <span class="hljs-string">"cache_control"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"ephemeral"</span>}  <span class="hljs-comment"># 标记缓存断点</span>
            }
        ]
    },
    <span class="hljs-comment"># ... 后续消息</span>
]
</code></pre>
<h3 data-id="heading-30">7.2 工具定义的分层排序</h3>
<p>工具列表动态变化会破坏缓存前缀，因为工具定义位于上下文前部，任何更改都会使后续所有内容的缓存失效。</p>
<p><strong>解决方案</strong>：按稳定性分层排序</p>

































<table><thead><tr><th>层级</th><th>稳定性</th><th>变化频率</th><th>缓存价值</th><th>工具示例</th></tr></thead><tbody><tr><td><strong>CORE</strong></td><td>极高</td><td>几乎不变</td><td>最高</td><td>web_search, file_editor, shell</td></tr><tr><td><strong>COMMON</strong></td><td>高</td><td>很少变</td><td>高</td><td>web_fetch, memory_tool</td></tr><tr><td><strong>EXTENDED</strong></td><td>中</td><td>偶尔变</td><td>中</td><td>临时加载的技能、answer_user</td></tr></tbody></table>
<p><strong>分层结构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[System Prompt]</span>           ← 完全稳定，永远缓存
<span class="hljs-selector-attr">[Layer 1: 核心工具定义]</span>    ← 高度稳定，几乎不变 (web_search, file_editor)
<span class="hljs-selector-attr">[Layer 2: 常用工具定义]</span>    ← 相对稳定
<span class="hljs-selector-attr">[Layer 3: 动态/扩展工具]</span>   ← 易变区 (临时加载的技能)
<span class="hljs-selector-attr">[对话历史]</span>                ← 增量增长
</code></pre>
<p><strong>效果</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">第 1 轮: <span class="hljs-section">[System]</span><span class="hljs-section">[CORE: search,file,shell]</span><span class="hljs-section">[EXTENDED: planner]</span><span class="hljs-section">[History 1]</span>
第 2 轮: <span class="hljs-section">[System]</span><span class="hljs-section">[CORE: search,file,shell]</span><span class="hljs-section">[EXTENDED: memory]</span><span class="hljs-section">[History 1-2]</span>
                 |&lt;----- 这部分可缓存 -----&gt;|

虽然 EXTENDED 工具变了，但：
- System Prompt + CORE 工具部分仍然命中缓存
- 只有 EXTENDED 及之后需要重新计算
</code></pre>
<h3 data-id="heading-31">7.3 批量清理优于渐进清理</h3>
<p><strong>问题</strong>：渐进式清理（每次超过阈值就清理）会频繁破坏缓存。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">渐进式:</span>
  <span class="hljs-string">轮</span> <span class="hljs-attr">10:</span> <span class="hljs-string">上下文</span> <span class="hljs-string">62k</span> <span class="hljs-string">→</span> <span class="hljs-string">清理到</span> <span class="hljs-string">55k</span> <span class="hljs-string">→</span> <span class="hljs-string">缓存失效</span>
  <span class="hljs-string">轮</span> <span class="hljs-attr">15:</span> <span class="hljs-string">上下文</span> <span class="hljs-string">63k</span> <span class="hljs-string">→</span> <span class="hljs-string">清理到</span> <span class="hljs-string">58k</span> <span class="hljs-string">→</span> <span class="hljs-string">缓存失效</span>
  <span class="hljs-string">轮</span> <span class="hljs-attr">20:</span> <span class="hljs-string">上下文</span> <span class="hljs-string">65k</span> <span class="hljs-string">→</span> <span class="hljs-string">清理到</span> <span class="hljs-string">60k</span> <span class="hljs-string">→</span> <span class="hljs-string">缓存失效</span>
  <span class="hljs-string">(3</span> <span class="hljs-string">次缓存失效，3</span> <span class="hljs-string">次重建缓存的成本)</span>

<span class="hljs-string">批量式:</span>
  <span class="hljs-string">轮</span> <span class="hljs-attr">10-19:</span> <span class="hljs-string">上下文</span> <span class="hljs-string">62k</span> <span class="hljs-string">→</span> <span class="hljs-string">80k，积累，不清理</span>
  <span class="hljs-string">轮</span> <span class="hljs-attr">20:</span> <span class="hljs-string">上下文</span> <span class="hljs-string">85k</span> <span class="hljs-string">→</span> <span class="hljs-string">一次性清理到</span> <span class="hljs-string">50k</span> <span class="hljs-string">→</span> <span class="hljs-string">缓存失效</span>
  <span class="hljs-string">(1</span> <span class="hljs-string">次缓存失效，1</span> <span class="hljs-string">次重建缓存的成本)</span>
</code></pre>
<p><strong>实现方式</strong>：</p>
<pre><code class="hljs">tokens &lt; 60k        → 正常运行，不处理
60k &lt; tokens &lt; 120k → 开始积累，等待 N 轮后批量清理
tokens &gt; 120k       → 强制立即清理（紧急情况）
</code></pre>
<hr/>
<h2 data-id="heading-32">八、成本分析：压缩与缓存的博弈</h2>
<h3 data-id="heading-33">8.1 核心公式</h3>
<p>上下文工程与提示词缓存本质上是「数量减少」与「单价打折」之间的博弈。</p>
<p><strong>定义两个核心变量</strong>：</p>
<ul>
<li><code>R_comp</code>（压缩率）：上下文工程把 token 数量减少了多少。例如压缩 50%，<code>R_comp = 0.5</code></li>
<li><code>D_cache</code>（缓存折扣率）：命中缓存后的价格是原价的多少。例如 Claude 命中缓存后价格是原价的 10%，则 <code>D_cache = 0.1</code></li>
</ul>

<pre><code class="hljs language-scss" lang="scss">上下文工程的成本 = Input_orig × (<span class="hljs-number">1</span> - R_comp) × Price_base
缓存命中的成本   = Input_orig × D_cache × Price_base

盈亏平衡点：当 (<span class="hljs-number">1</span> - R_comp) = D_cache 时两者相等
</code></pre>
<h3 data-id="heading-34">8.2 结论：缓存通常完胜</h3>
<p>目前主流厂商（DeepSeek、Anthropic）的缓存折扣率约为 <strong>10%</strong>。这意味着：</p>
<ul>
<li>除非上下文工程能达到 <strong>90% 压缩率</strong>，否则单纯从成本角度看，不如直接用缓存</li>
<li>而 90% 的压缩率通常会<strong>严重丢失信息</strong>，导致模型变笨</li>
</ul>
<p><strong>示例计算</strong>：</p>
<p>假设原始输入 100k tokens，Claude 原价 $3/百万：</p>
<pre><code class="hljs language-ini" lang="ini">不压缩 + 缓存命中：100k × $0.3/<span class="hljs-attr">M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">03</span>
压缩 50% + 无缓存：50k × $3/<span class="hljs-attr">M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">15</span>
压缩 50% + 缓存命中：50k × $0.3/<span class="hljs-attr">M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">015</span>（最优）
</code></pre>
<p><strong>结论</strong>：压缩应该服务于缓存，而不是替代缓存。</p>
<h3 data-id="heading-35">8.3 场景化决策</h3>





























<table><thead><tr><th>场景</th><th>特点</th><th>策略</th><th>原因</th></tr></thead><tbody><tr><td><strong>静态长文本</strong></td><td>系统设定、知识库、少样本示例</td><td>死磕缓存，不压缩</td><td>缓存打 1 折，压缩反而破坏缓存</td></tr><tr><td><strong>动态长历史</strong></td><td>50 轮对话，接近窗口上限</td><td>必须用上下文工程</td><td>物理塞不进去是首要矛盾</td></tr><tr><td><strong>检索增强</strong></td><td>每次检索内容不同</td><td>混合策略 + 前缀增厚</td><td>系统提示词缓存 + 检索内容按需处理</td></tr></tbody></table>
<p><strong>前缀增厚策略</strong>：</p>
<p>对于检索增强场景，一个进阶技巧是让系统提示词变「厚」：</p>
<ul>
<li>加入 10-20 个高质量的少样本示例</li>
<li>把前缀从 500 tokens 扩展到 3000-5000 tokens</li>
<li>缓存收益从 5% 提升到 30-50%</li>
</ul>
<hr/>
<h2 data-id="heading-36">九、各模型提供商对比</h2>
<h3 data-id="heading-37">9.1 机制对比</h3>





















































<table><thead><tr><th>提供商</th><th>触发方式</th><th>折扣率</th><th>写入成本</th><th>TTL</th><th>最小长度</th></tr></thead><tbody><tr><td><strong>Anthropic</strong></td><td>自动 + 显式</td><td>90%</td><td>原价 25%</td><td>5分钟/1小时</td><td>1024-4096</td></tr><tr><td><strong>OpenAI</strong></td><td>纯自动</td><td>50%</td><td>无</td><td>5-10 分钟</td><td>1024</td></tr><tr><td><strong>DeepSeek</strong></td><td>纯自动</td><td>~90%</td><td>无</td><td>动态</td><td>64</td></tr><tr><td><strong>Google</strong></td><td>显式 + 隐式</td><td>75%</td><td>$1/M/小时</td><td>1小时-1天</td><td>1k / 32k</td></tr><tr><td><strong>阿里云</strong></td><td>隐式 + 显式</td><td>80%/90%</td><td>隐式无/显式125%</td><td>不确定/5分钟</td><td>256 / 1024</td></tr></tbody></table>
<h3 data-id="heading-38">9.2 Anthropic (Claude) 的注意事项</h3>
<p>Claude 的缓存<strong>并非 100% 保证命中</strong>，存在以下限制：</p>
<ol>
<li>
<p><strong>精确匹配要求</strong>：缓存命中需要 <strong>100% 相同</strong>的提示词段，包括所有文本和图像的<strong>字节级一致</strong></p>
</li>
<li>
<p><strong>20 块回溯窗口</strong>：系统仅检查每个显式 <code>cache_control</code> 断点之前的<strong>最多 20 个块</strong>。如果修改发生在 20 个块之外，将<strong>无法命中缓存</strong></p>
</li>
<li>
<p><strong>并发请求限制</strong>：缓存条目仅在<strong>第一个响应开始后</strong>才可用。并行请求可能无法命中刚创建的缓存</p>
</li>
<li>
<p><strong>组织隔离</strong>：缓存在组织之间隔离，不同组织永远不会共享缓存</p>
</li>
</ol>
<p><strong>最小缓存长度要求</strong>：</p>

























<table><thead><tr><th>模型</th><th>最小缓存长度</th></tr></thead><tbody><tr><td>Claude Opus 4.5</td><td>4096 tokens</td></tr><tr><td>Claude Sonnet 4.x</td><td>1024 tokens</td></tr><tr><td>Claude Haiku 4.5</td><td>4096 tokens</td></tr><tr><td>Claude Haiku 3.x</td><td>2048 tokens</td></tr></tbody></table>
<h3 data-id="heading-39">9.3 阿里云的特殊机制</h3>
<p>阿里云的隐式缓存与显式缓存<strong>互斥</strong>，单个请求只能应用其中一种模式。</p>
<p><strong>隐式缓存</strong>（自动模式）：</p>
<ul>
<li>命中概率：<strong>不确定</strong>，由系统判定</li>
<li>即使请求上下文完全一致，仍可能未命中</li>
<li>优势：无额外写入成本</li>
</ul>
<p><strong>显式缓存</strong>（主动模式）：</p>
<ul>
<li>命中概率：<strong>确定性命中</strong></li>
<li>需要在 messages 中加入 <code>cache_control</code> 标记</li>
<li>写入成本：输入价格的 125%</li>
<li>命中价格：输入价格的 10%</li>
</ul>
<h3 data-id="heading-40">9.4 统一优化策略</h3>
<p><strong>好消息</strong>：所有提供商都基于相同的核心机制——<strong>前缀匹配</strong>。</p>
<p>这意味着优化策略具有通用性：</p>
<ol>
<li>✅ 保持前缀稳定</li>
<li>✅ 工具定义分层</li>
<li>✅ 只追加不删除</li>
<li>✅ 批量清理</li>
</ol>
<hr/>
<h2 data-id="heading-41">十、实践建议</h2>
<h3 data-id="heading-42">10.1 系统提示词设计</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 不推荐：每次调用都变化</span>
system = <span class="hljs-string">f"""
当前时间：<span class="hljs-subst">{datetime.now()}</span>
你是 AI 助手，帮助用户 <span class="hljs-subst">{user_name}</span> 完成任务。
"""</span>

<span class="hljs-comment"># ✅ 推荐：系统提示词稳定，动态信息放在用户消息中</span>
system = <span class="hljs-string">"""
你是一个专业的 AI 助手。
动态上下文信息会在每次对话中提供。
请根据上下文信息个性化地回应用户。
"""</span>

messages = [
    SystemMessage(content=system),  <span class="hljs-comment"># 稳定的前缀</span>
    HumanMessage(content=<span class="hljs-string">f"""
[当前上下文]
时间：<span class="hljs-subst">{datetime.now()}</span>
用户：<span class="hljs-subst">{user_name}</span>
偏好：<span class="hljs-subst">{user_preferences}</span>

[用户问题]
<span class="hljs-subst">{user_query}</span>
"""</span>),
]
</code></pre>
<h3 data-id="heading-43">10.2 工具定义顺序</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 按稳定性排序</span>
tools = [
    <span class="hljs-comment"># CORE 层：最稳定，放最前面</span>
    web_search_tool,
    file_editor_tool,
    shell_execute_tool,
    
    <span class="hljs-comment"># COMMON 层：相对稳定</span>
    web_fetch_tool,
    memory_tool,
    
    <span class="hljs-comment"># EXTENDED 层：可能变化，放最后</span>
    *dynamically_loaded_skills,
    answer_user_tool,
]
</code></pre>
<h3 data-id="heading-44">10.3 序列化的确定性</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> OrderedDict

<span class="hljs-keyword">def</span> <span class="hljs-title function_">stable_serialize</span>(<span class="hljs-params">data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""确保序列化结果的字节级一致性"""</span>
    <span class="hljs-keyword">return</span> json.dumps(
        data,
        sort_keys=<span class="hljs-literal">True</span>,        <span class="hljs-comment"># 键排序</span>
        ensure_ascii=<span class="hljs-literal">False</span>,    <span class="hljs-comment"># 保留中文</span>
        separators=(<span class="hljs-string">','</span>, <span class="hljs-string">':'</span>), <span class="hljs-comment"># 紧凑格式，无多余空格</span>
    )

<span class="hljs-comment"># 测试</span>
data = {<span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>}
<span class="hljs-keyword">assert</span> stable_serialize(data) == <span class="hljs-string">'{"a":1,"b":2}'</span>
</code></pre>
<h3 data-id="heading-45">10.4 监控指标</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 关键监控指标</span>
metrics = {
    <span class="hljs-string">"cache_hit_rate"</span>: <span class="hljs-string">"缓存命中率，目标 &gt; 80%"</span>,
    <span class="hljs-string">"context_length_p95"</span>: <span class="hljs-string">"上下文长度 P95，监控增长趋势"</span>,
    <span class="hljs-string">"compression_frequency"</span>: <span class="hljs-string">"压缩触发频率，过高说明阈值设置不合理"</span>,
    <span class="hljs-string">"summarization_count"</span>: <span class="hljs-string">"摘要触发次数，应该很少"</span>,
    <span class="hljs-string">"ttft_p95"</span>: <span class="hljs-string">"首 token 延迟 P95，反映缓存效果"</span>,
}
</code></pre>
<hr/>
<h2 data-id="heading-46">十一、写在最后</h2>
<p>上下文工程在智能体开发中越来越重要。</p>
<p>Manus 的实践数据：</p>
<ul>
<li><strong>推理次数</strong>：从平均 4.3 次降至 1.2 次（-72%）</li>
<li><strong>总成本</strong>：降低 72%</li>
</ul>
<p>这个效果来自两个层面的叠加：</p>
<ol>
<li><strong>缓存层</strong>：提高命中率，降低单次推理成本</li>
<li><strong>准确率层</strong>：减少失败重试，降低调用次数</li>
</ol>
<p>用 Manus 的话来说：</p>
<blockquote>
<p>「上下文工程是一门艺术与科学，它要求在多个可能相互冲突的目标之间找到完美的平衡。这真的很难。」</p>
</blockquote>
<p>如果只能做一件事，从监控缓存命中率开始。</p>
<hr/>
<h2 data-id="heading-47">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmanus.im%2Fblog%2FContext-Engineering-for-AI-Agents-Lessons-from-Building-Manus" target="_blank" title="https://manus.im/blog/Context-Engineering-for-AI-Agents-Lessons-from-Building-Manus" ref="nofollow noopener noreferrer">Manus Context Engineering</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bestblogs.dev%2Fvideo%2F087a1f3" target="_blank" title="https://www.bestblogs.dev/video/087a1f3" ref="nofollow noopener noreferrer">Context Engineering for AI Agents with LangChain and Manus</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg2NzY0MTkzOQ%3D%3D%26mid%3D2247493844" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg2NzY0MTkzOQ==&amp;mid=2247493844" ref="nofollow noopener noreferrer">Manus 与 LangChain 对话实录</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.langchain.com%2Fhow-agents-can-use-filesystems-for-context-engineering%2F" target="_blank" title="https://blog.langchain.com/how-agents-can-use-filesystems-for-context-engineering/" ref="nofollow noopener noreferrer">LangChain: How agents can use filesystems for context engineering</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fbuild-with-claude%2Fprompt-caching" target="_blank" title="https://platform.claude.com/docs/build-with-claude/prompt-caching" ref="nofollow noopener noreferrer">Anthropic Prompt Caching</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Fprompt-caching" target="_blank" title="https://platform.openai.com/docs/guides/prompt-caching" ref="nofollow noopener noreferrer">OpenAI Prompt Caching</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.google.dev%2Fgemini-api%2Fdocs%2Fcaching" target="_blank" title="https://ai.google.dev/gemini-api/docs/caching" ref="nofollow noopener noreferrer">Google Gemini 上下文缓存</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmodel-studio%2Fcontext-cache" target="_blank" title="https://help.aliyun.com/zh/model-studio/context-cache" ref="nofollow noopener noreferrer">阿里云 Context Cache</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MAUI库推荐二：MPowerKit]]></title>    <link>https://juejin.cn/post/7585534343562117170</link>    <guid>https://juejin.cn/post/7585534343562117170</guid>    <pubDate>2025-12-21T05:16:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585534343562117170" data-draft-id="7585553799298007086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MAUI库推荐二：MPowerKit"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-21T05:16:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NetCrossPlatform"/> <meta itemprop="url" content="https://juejin.cn/user/2656894684760382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MAUI库推荐二：MPowerKit
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2656894684760382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NetCrossPlatform
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T05:16:07.000Z" title="Sun Dec 21 2025 05:16:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">项目介绍</h2>
<p><code>MPowerKit</code> 是.NET MAUI 的导航框架。</p>
<p>项目支持常规/模式导航，打开/关闭窗口，多窗口、区域导航和弹出窗口。</p>
<p>项目灵感来自于Prism项目，Prism对MAUI的支持不是很友好。因此作者开发了针对MAUI的导航框架。提供了与Prism相同的MAUI应用程序导航原则，但实现方式完全不同。性能也略有提高。带来了正确的方式处理所有平台相同行为的系统返回按钮功能。</p>
<h2 data-id="heading-1">项目地址</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMPowerKit%2FNavigation" target="_blank" title="https://github.com/MPowerKit/Navigation" ref="nofollow noopener noreferrer">github.com/MPowerKit/N…</a></p>
<h2 data-id="heading-2">相关接口介绍</h2>
<h4 data-id="heading-3"><code>MPowerKit.Navigation.Core</code> 核心库的相关接口</h4>
<ul>
<li><code>IInitializeAware</code> 只有一个<code>void Initialize(INavigationParameters parameters);</code>方法，这个方法在页面和它的视图模型创建后立即执行，并且没有附加到可视化树。在该页的生存期内仅执行一次。如果你想让页面或者视图模型知道这个事件，必须实现这个接口。</li>
<li><code>IDestructible</code> 只实现<code>void Desctroy();</code>，从可视化树中分离出来并且在GC之后立即实行。按倒序连续的对导航堆栈中的每隔页面执行。在页面生存期内仅执行一次。如果你想让页面或者视图模型知道这个事件，必须实现这个接口。</li>
<li><code>INavigationAware</code> 此接口实现了两个方法
<ul>
<li><code>void OnNavigatedFrom(INavigationParameters parameters);</code> 返回上层页面时调用。</li>
<li><code>void OnNavigatedTo(INavigationParameters parameters);</code> 进入当前页面时调用。</li>
</ul>
</li>
<li><code>IPageLifecycleAware</code> 该接口绑定到Page类的生命周期事件。有两个接口方法：
<ul>
<li><code>void OnAppearing();</code> 当页面出现时执行。</li>
<li><code>void OnDisappearing();</code> 当页面消失时执行。</li>
</ul>
</li>
<li><code>IWindowLifecycleAware</code> 与Window类的生命周期事件绑定，有两个方法：<code>void OnResume();</code> 和 <code>void OnSleep();</code></li>
<li><code>ISystemBackButtonClickAware</code> 如果想要完全控制导航功能，需要在Page或者ViewModel中实现这个接口。只有一个方法：<code>bool OnSystemBackButtonClick();</code>。 此方法在单击系统返回按钮时执行，可在MAUI支持的所有平台上有效。返回值表示是否处理此事件。如果处理了，那么向后导航应该有开发人员处理。如果没有，在向后导航将由MAUI本身处理。</li>
<li><code>IActiveTabAware</code> 这个接口只有一个方法：<code>bool IsOnActiveTab { get; set; }</code>。用于表示页面是否在活动状态</li>
<li><code>IFlyoutPageFlyoutPresentedAware</code></li>
</ul>
<h2 data-id="heading-4">使用方法</h2>
<p>使用时在项目中引用对应的nuget包即可。可搜索<code>MPowerKit</code>，找到对应相关库即可。</p>
<ul>
<li><code>MPowerKit.Navigation</code> 导航功能</li>
<li><code>MPowerKit.Regions</code> 区域功能</li>
<li><code>MPowerKit.Navigation.Popups</code> 弹出功能</li>
</ul>
<p>根据自己的需要添加相关库即可。</p>
<h2 data-id="heading-5">MPowerKit.Navigation</h2>
<p>此库提供了必要的基础功能，并以完全MVVM的方式构建了丰富的应用程序，提供了不同页面之间的导航。</p>
<p>需要在MauiProgram中添加如下代码：</p>
<pre><code class="hljs language-ini" lang="ini">builder
    .UseMauiApp&lt;App&gt;()
    .UseMPowerKitNavigation(<span class="hljs-attr">mpowerBuilder</span> =&gt;
    {
        mpowerBuilder.ConfigureServices(<span class="hljs-attr">s</span> =&gt;
        {
            s.RegisterForNavigation&lt;MainPage&gt;()<span class="hljs-comment">;</span>
        })
        .OnAppStart("NavigationPage/MainPage")<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
</code></pre>
<p>启动应用程序时，以MainPage作为根页面启动。如果想要注册服务你可以在<code>ConfigureServices</code>中添加代码。在此库中已添加了必要的一下服务。如果你想进行扩展可以自己更改相关功能：</p>
<ul>
<li>MPowerKitWindow 注册为瞬态服务IMPowerKitWindow，并提供处理系统返回按钮和窗口生命周期的能力，如果需要更改<code>MPowerKitWindow</code>的实现或者改变西的后退按钮点击行为，可以扩展这个类并注册新的实现。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">mpowerBuilder.ConfigureServices(<span class="hljs-attr">s</span> =&gt;
{
    s.AddTransient&lt;IMPowerKitWindow, NewWindowThatExtendsMPowerKitWindow&gt;()<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>NavigationService 作为作用域服务注册，应用程序导航，如果需要覆盖它的一些基本实现，可以使用你的实现并使用如下注册：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">mpowerBuilder.ConfigureServices(<span class="hljs-attr">s</span> =&gt;
{
    s.AddScoped&lt;INavigationService, YourNavigationService&gt;()<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-6">注册页面</h4>
<p>方法一：</p>
<pre><code class="hljs language-csharp" lang="csharp">mpowerBuilder.ConfigureServices(s =&gt;
{
    s.RegisterForNavigation&lt;MainPage&gt;();  <span class="hljs-comment">//解析为`nameof`,没有指定视图模型，这意味着将BindingContext设置为new object</span>
})
</code></pre>
<p>方法二：</p>
<pre><code class="hljs language-csharp" lang="csharp">mpowerBuilder.ConfigureServices(s =&gt;
{
    s.RegisterForNavigation&lt;MainPage, MainPageViewModel&gt;();<span class="hljs-comment">//解析为`nameof`,并指定view model为`MainPageViewModel`</span>
})
</code></pre>
<p>方法三：</p>
<pre><code class="hljs language-csharp" lang="csharp">mpowerBuilder.ConfigureServices(s =&gt;
{
    s.RegisterForNavigation&lt;MainPage, MainPageViewModel&gt;(<span class="hljs-string">"TheAssociationNameForYourPage"</span>);<span class="hljs-comment">//解析为关联名称，这是首选方式,并指定view model为`MainPageViewModel`</span>
})
</code></pre>
<h4 data-id="heading-7">已注册页面</h4>
<ul>
<li><code>NavigationPage</code></li>
<li><code>TabNavigationPage</code></li>
<li><code>TabbedPage</code></li>
<li><code>FlyoutPage</code></li>
</ul>
<h4 data-id="heading-8">注册自己的行为</h4>
<p>如果需要使用已经附加的行为来解析页面，可以实现如下代码：</p>
<pre><code class="hljs language-ini" lang="ini">mpowerBuilder.ConfigureServices(<span class="hljs-attr">s</span> =&gt;
{
    // Register behaviors
    s.RegisterBehavior&lt;Page, SomeUsefulBehaviorYouWantToAttachToEachPageInYourApp&gt;()<span class="hljs-comment">;</span>
    s.RegisterBehavior&lt;SecondPage, SomeUsefulBehaviorYouWantToAttachOnlyToSecondPage&gt;()<span class="hljs-comment">;</span>
})
</code></pre>
<h4 data-id="heading-9">已存在的行为</h4>
<ul>
<li><code>PageLifecycleAwareBehavior</code> 负责处理页面的OnAppearing() 和OnDisappearing()事件，在应用中所有页面中已注册。</li>
<li><code>TabbedPageActiveTabAwareBehavior</code> 负责处理<code>TabbedPage</code>的<code>CurrentPageChanged</code>事件。</li>
<li><code>FlyoutPageFlyoutPresentedAwareBehavior</code> 负责处理<code>FlyoutPage</code>的<code>IsPresentedChanged</code> 事件</li>
</ul>
<h4 data-id="heading-10">配置应用启动</h4>
<p>大多数情况下，使用下面的设置足以在所需要页面启动应用程序。</p>
<pre><code class="hljs language-arduino" lang="arduino">mpowerBuilder.<span class="hljs-built_in">OnAppStart</span>(<span class="hljs-string">"NavigationPage/YourPage"</span>);
</code></pre>
<p>如果需要一些初始化的工作，可使用如下方法：</p>
<ul>
<li><code>OnInitialized()</code></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//方法一（无参）：</span>
mpowerBuilder.<span class="hljs-title class_">OnInitialized</span>(<span class="hljs-function">() =&gt;</span>
{
    <span class="hljs-comment">//your initializations</span>
});
<span class="hljs-comment">//方法二（带参）</span>
mpowerBuilder.<span class="hljs-title class_">OnInitialized</span>(<span class="hljs-function"><span class="hljs-params">serviceProvider</span> =&gt;</span>
{
    <span class="hljs-comment">//your initializations</span>
});
</code></pre>
<ul>
<li><code>OnAppStart</code> 当应用程序准备好导航到第一页面时执行，这是必须的，如果没有它，应用程序在开始就会崩溃。</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">mpowerBuilder.<span class="hljs-built_in">OnAppStart</span>(<span class="hljs-string">"NavigationPage/YourPage"</span>);
</code></pre>
<p>如果想在导航前执行一些异步方法，可用如下代码，提供一个登录功能。</p>
<pre><code class="hljs language-dart" lang="dart">mpowerBuilder.OnAppStart(<span class="hljs-keyword">async</span> (serviceProvider, navigationService) =&gt;
{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> IsUserLoggedIn())
    {
        <span class="hljs-keyword">await</span> navigationService.NavigateAsync(<span class="hljs-string">"NaviationPage/MainPage"</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">await</span> navigationService.NavigateAsync(<span class="hljs-string">"LoginPage"</span>);
});
</code></pre>
<h4 data-id="heading-11">使用</h4>
<p>要在应用中使用导航，你需要将<code>INavigationService</code>注入到你的页面或者视图的构造函数中，然后就可以导航到想要的页面</p>
<pre><code class="hljs language-csharp" lang="csharp">INavigationService _navigationService;

<span class="hljs-keyword">await</span> _navigationService.NavigateAsync(<span class="hljs-string">"YourPageAssociationName"</span>, optionalNavigationParameters, optionalIsModal, optionalIsAnimated);
</code></pre>
<p>每个页面或者VM都有自己的<code>INavigationService</code>实例，它被注册为作用域服务。
导航到页面：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">ValueTask&lt;NavigationResult&gt; <span class="hljs-title">NavigateAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> uri, INavigationParameters? navigationParameters = <span class="hljs-literal">null</span>, <span class="hljs-built_in">bool</span> modal = <span class="hljs-literal">false</span>, <span class="hljs-built_in">bool</span> animated = <span class="hljs-literal">true</span></span>)</span>;
</code></pre>
<h4 data-id="heading-12">返回</h4>
<p>要会到上一页或者根页，可以冲任何页面或者VM中执行此操作。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">ValueTask&lt;NavigationResult&gt; <span class="hljs-title">GoBackAsync</span>(<span class="hljs-params">INavigationParameters? parameters = <span class="hljs-literal">null</span>, <span class="hljs-built_in">bool</span> modal = <span class="hljs-literal">false</span>, <span class="hljs-built_in">bool</span> animated = <span class="hljs-literal">true</span></span>)</span>;
<span class="hljs-function">ValueTask&lt;NavigationResult&gt; <span class="hljs-title">GoBackToRootAsync</span>(<span class="hljs-params">INavigationParameters? parameters = <span class="hljs-literal">null</span>, <span class="hljs-built_in">bool</span> animated = <span class="hljs-literal">true</span></span>)</span>;
</code></pre>
<h4 data-id="heading-13">打开新窗口或者关闭窗口</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">ValueTask&lt;NavigationResult&gt; <span class="hljs-title">OpenNewWindowAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> uri, INavigationParameters? parameters = <span class="hljs-literal">null</span></span>)</span>;
</code></pre>
<pre><code class="hljs language-ini" lang="ini">NavigationResult CloseWindow(Guid? <span class="hljs-attr">windowId</span> = null)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-14">MPowerKit.Navigation.Popups</h2>
<p>弹窗功能这个库基于 <code>MPowerKit.Navigation</code>和<code>MPowerKit.Popups</code></p>
<p>使用<code>UsePopupNavigation()</code>进行引用，如下所示：</p>
<pre><code class="hljs language-ini" lang="ini">builder
    .UseMauiApp&lt;App&gt;()
    .UseMPowerKitNavigation(<span class="hljs-attr">mpowerBuilder</span> =&gt;
    {
        mpowerBuilder.ConfigureServices(<span class="hljs-attr">s</span> =&gt;
        {
            s.RegisterForNavigation&lt;MainPage&gt;()<span class="hljs-comment">;</span>
            s.RegisterForNavigation&lt;TestPopupPage&gt;()<span class="hljs-comment">;</span>
        })
        .UsePopupNavigation()
        .OnAppStart("NavigationPage/MainPage")<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
</code></pre>
<p>注册Popup页面可参考<a href="#%E9%A1%B5%E9%9D%A2%E6%B3%A8%E5%86%8C" title="#%E9%A1%B5%E9%9D%A2%E6%B3%A8%E5%86%8C">注册页面</a></p>
<p>每一个弹出页面，必须集成库<code>MPowerKit.Popups</code>中的<code>PopupPage</code>。</p>
<p>可通过在构造函数中注册接口<code>IPopupDialogAware</code>实现弹窗功能，可进行参数传递和关闭功能。如下示例所示：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestPopupViewModel</span> : <span class="hljs-title">IPopupDialogAware</span>
{
    <span class="hljs-keyword">public</span> Action&lt;(Confirmation Confirmation, <span class="hljs-built_in">bool</span> Animated)&gt; RequestClose { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Cancel</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj = <span class="hljs-literal">null</span></span>)</span>
    {
        <span class="hljs-keyword">var</span> nparams = <span class="hljs-keyword">new</span> NavigationParameters
        {
            { NavigationConstants.CloseParameter, obj }
        };

        RequestClose?.Invoke((<span class="hljs-keyword">new</span> Confirmation(<span class="hljs-literal">false</span>, nparams), <span class="hljs-literal">true</span>));
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Confirm</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj = <span class="hljs-literal">null</span></span>)</span>
    {
        <span class="hljs-keyword">var</span> nparams = <span class="hljs-keyword">new</span> NavigationParameters
        {
            { NavigationConstants.CloseParameter, obj }
        };

        RequestClose?.Invoke((<span class="hljs-keyword">new</span> Confirmation(<span class="hljs-literal">true</span>, nparams), <span class="hljs-literal">true</span>));
    }
}
</code></pre>
<h2 data-id="heading-15">MPowerKit.Navigation.Regions</h2>
<p>与Prism的导航功能相似，但是实现方式不同。</p>
<p>添加UseMPowerKitRegions() 到MauiProgram.cs文件中：</p>
<pre><code class="hljs language-scss" lang="scss">builder
    <span class="hljs-selector-class">.UseMauiApp</span>&lt;App&gt;()
    <span class="hljs-selector-class">.UseMPowerKitRegions</span>();
</code></pre>
<pre><code class="hljs language-ini" lang="ini">builder
    .UseMauiApp&lt;App&gt;()
    .UseMPowerKitNavigation(<span class="hljs-attr">mpowerBuilder</span> =&gt;
    {
        mpowerBuilder.ConfigureServices(<span class="hljs-attr">s</span> =&gt;
        {
            s.RegisterForNavigation&lt;MainPage&gt;()<span class="hljs-comment">;</span>
            s.RegisterForNavigation&lt;RegionView1&gt;()<span class="hljs-comment">;</span>
        })
        .OnAppStart("NavigationPage/MainPage")<span class="hljs-comment">;</span>
    })
    .UseMPowerKitRegions()<span class="hljs-comment">;</span>
</code></pre>
<p>如果你将区域与MPowerKit.Navigation结合使用，你可以指定是否想要你的区域视图获得父页面的事件，如导航、销毁、生命周期等，只需要将<code>UsePageEventsInRegions()</code>到你代码中。</p>
<pre><code class="hljs language-csharp" lang="csharp">builder
    .UseMauiApp&lt;App&gt;()
    .UseMPowerKitNavigation(mpowerBuilder =&gt;
    {
        mpowerBuilder.ConfigureServices(s =&gt;
        {
            s.RegisterForNavigation&lt;MainPage&gt;();
            s.RegisterForNavigation&lt;RegionView1&gt;();
        })
        .UsePageEventsInRegions()<span class="hljs-comment">//此行代码</span>
        .OnAppStart(<span class="hljs-string">"NavigationPage/MainPage"</span>);
    })
    .UseMPowerKitRegions();
</code></pre>
<p>注册region页面可参考<a href="#%E9%A1%B5%E9%9D%A2%E6%B3%A8%E5%86%8C" title="#%E9%A1%B5%E9%9D%A2%E6%B3%A8%E5%86%8C">注册页面</a></p>
<h4 data-id="heading-16">使用</h4>
<p>每个区域应该有一个父容器，类型为<code>ContentView</code>。</p>
<pre><code class="hljs language-csharp" lang="csharp">添加命名空间：
xmlns:regions=<span class="hljs-string">"clr-namespace:MPowerKit.Regions;assembly=MPowerKit.Regions"</span>
<span class="hljs-comment">//添加一个简单的区域</span>
&lt;ContentView regions:RegionManager.RegionName=<span class="hljs-string">"YourVeryMeaningfulRegionName"</span> /&gt;

<span class="hljs-comment">//与Prism不同，它可以有一个动态名称，如下所示</span>
&lt;ContentView regions:RegionManager.RegionName=<span class="hljs-string">"{Binding DynamicString}"</span> /&gt;
</code></pre>
<blockquote>
<p>注意：区域名称必须为唯一的，否则应用会崩溃。</p>
</blockquote>
<ul>
<li><code>IRegionManager</code> 将此接口注入到页面或者VM的构造函数中，使用方法</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">IRegionManager _regionManager;

_regionManger.<span class="hljs-built_in">NavigateTo</span>(<span class="hljs-string">"YourRegionName"</span>, <span class="hljs-string">"RegionViewAssociationName"</span>, optionalNavigationParametersObject);
</code></pre>
<p>此文已在公众号：MAUI与Avalonia开启原创，欢迎关注与转载。</p>
<h2 data-id="heading-17">以往精品</h2>
<p>1、<a href="https://juejin.cn/post/7583535861645983790" target="_blank" title="https://juejin.cn/post/7583535861645983790">MAUI库推荐一：MAUIIcons项目介绍 MAUIIcons是对Maui可用的Icon集合库。可以方便的在Maui上 - 掘金</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让我们把这个 expense 工具从 n8n 迁移到 Elastic One Workflow]]></title>    <link>https://juejin.cn/post/7585555806667391010</link>    <guid>https://juejin.cn/post/7585555806667391010</guid>    <pubDate>2025-12-21T05:18:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585555806667391010" data-draft-id="7585574047074975744" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让我们把这个 expense 工具从 n8n 迁移到 Elastic One Workflow"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-21T05:18:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让我们把这个 expense 工具从 n8n 迁移到 Elastic One Workflow
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T05:18:47.000Z" title="Sun Dec 21 2025 05:18:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fvladimir_filonov" title="https://discuss.elastic.co/u/vladimir_filonov" target="_blank" ref="nofollow noopener noreferrer">Vladimir_Filonov</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9073a4c67d174d2ba84b4abb9ce740eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766899126&amp;x-signature=iJYO8%2FYoSsACj0coHIsTSr0Wz5E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">使用 Elastic One Workflow、Gemini 和 Telegram 构建对话式费用助手</h2>
<p>不久前，我偶然看到 Som 的一篇非常棒的实战指南（昨天发布）：</p>
<p>“<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-3rd-2025-en-build-a-conversational-expense-assistant-using-elasticsearch-agent-builder-with-telegram-n8n-and-aws-bedrock%2F383585" title="https://discuss.elastic.co/t/dec-3rd-2025-en-build-a-conversational-expense-assistant-using-elasticsearch-agent-builder-with-telegram-n8n-and-aws-bedrock/383585" target="_blank" ref="nofollow noopener noreferrer">使用 Elasticsearch Agent Builder、Telegram、n8n 和 Bedrock 构建对话式费用助手</a>”（发布前会有修改）</p>
<p>这个想法非常优雅。Telegram 作为聊天 UI，n8n 负责整体编排，STT，Bedrock 用于意图识别和信息抽取，Elasticsearch + Agent Builder 用于存储和查询。非常干净。出奇地流畅。说实话？它立刻给了我灵感。这种情况在技术类实战文章中并不常见。</p>
<p>但由于我大部分时间都在使用 Elastic 的 Workflow Engine，我开始思考：</p>
<blockquote>
<p>“如果我重新创建一个简化版的 Som 助手，但用 <strong>Elastic One Workflow</strong> 作为编排器，而不是 n8n，会怎么样？”</p>
</blockquote>
<p>同样的想法，同样“和你的费用对话”的魔法，但整个流程原生运行在 Elastic 中。这看起来应该是可行的。而且确实基本可行。</p>
<p>One Workflow 还处于早期阶段，还没有 n8n 那么完整的能力。我做了一些简化：使用 Gemini 来完成 LLM 相关任务（一部分是为了 LLM 多样性，一部分是因为我想试试它），并且使用轮询 Telegram 而不是 webhooks。轮询运行得不错，不过 webhooks 会更好。</p>
<p>于是我把它做出来了。这是一个紧凑的费用助手。支持语音和文本。进行意图分类。将结构化费用数据连同语义 embedding 一起索引。使用 ES|QL 工具做分析。在 Telegram 中直接回复。这大概就是整体情况。</p>
<p>和 Som 版本的主要区别？Elastic One Workflow 替代了 n8n，Gemini 替代了 Bedrock，我使用的是定时轮询而不是 Telegram webhooks。一切都发生在 Elastic 内部，这正是重点所在。我并不是想做一个 1:1 的克隆 —— 只是想看看当所有东西都放在 ELK stack 里时，同样的想法会是什么效果。不过说实话，我并不确定长期来看每 15 秒轮询一次是不是最好的方式。Webhooks 会更干净，但 One Workflow 目前还不支持。所以只能用轮询。</p>
<p>它每 15 秒轮询一次 Telegram。把语音转换成文本 —— 我用的是 Deepgram，不过任何 STT 服务都可以。使用 Gemini 将意图分类为 INGEST 或 QUERY。然后要么索引费用数据，要么通过 Agent Builder 工具运行 ES|QL 查询。如果置信度较低？它会请求澄清。整个流程在完成初始设置之后其实相当直接。</p>
<p>image_placeholder.png</p>
<p>你需要具备带有 Agent Builder 和 inference endpoints 的 Elasticsearch。在 GCP 上通过 Vertex AI 配置好 Gemini。一个 Telegram bot token（如果你还没有，可以从 @BotFatherBotFather 获取）。以及一个 STT 提供方 —— 我使用的是 Deepgram，因为它很容易设置，不过也有其他选择。</p>
<h2 data-id="heading-1">设置索引</h2>
<p>首先创建 Elasticsearch 索引。这里没有什么复杂的东西：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT /expenses
2.  {
3.    <span class="hljs-string">"mappings"</span>: {
4.      <span class="hljs-string">"properties"</span>: {
5.        <span class="hljs-string">"@timestamp"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span> },
6.        <span class="hljs-string">"amount"</span>:       { <span class="hljs-string">"type"</span>: <span class="hljs-string">"float"</span> },
7.        <span class="hljs-string">"merchant"</span>:     { <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span> },
8.        <span class="hljs-string">"category"</span>:     { <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span> },
9.        <span class="hljs-string">"payment_method"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span> },
10.        <span class="hljs-string">"raw_transcript"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span> },
11.        <span class="hljs-string">"user_id"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span> },
12.        <span class="hljs-string">"telegram_chat_id"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span> },
13.        <span class="hljs-string">"semantic_text"</span>: {
14.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"semantic_text"</span>,
15.          <span class="hljs-string">"inference_id"</span>: <span class="hljs-string">"gemini_embeddings"</span>
16.        }
17.      }
18.    }
19.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<h2 data-id="heading-2">设置 Gemini</h2>
<p>这一部分比我预期花了更长时间。GCP 的设置比较繁琐。你知道流程：创建一个项目，启用 Vertex AI API，创建一个带有 Vertex AI User 角色的服务账号，下载 JSON key。选择一个 Vertex AI 可用的区域 —— 我用的是 us-central1，因为我之前已经配置好了。也许有更好的区域，我并没有仔细研究。</p>
<p>然后在 Kibana 中，进入 Stack Management → Connectors，创建一个 Gemini connector。名字随便取。将 API URL 设置为你所在区域的 endpoint。填入你的 project ID 和 region。模型使用 gemini-2.5-pro（或者你想用的其他版本）。把整个服务账号 JSON 粘贴到 credentials 字段里。是整个 JSON，不是其中的一部分。我第一次就犯了这个错误。</p>
<p>对于 embeddings，你需要一个 inference endpoint。像这样创建它：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _inference/text_embedding/gemini_embeddings
2.  {
3.    <span class="hljs-string">"service"</span>: <span class="hljs-string">"googlevertexai"</span>,
4.    <span class="hljs-string">"service_settings"</span>: {
5.      <span class="hljs-string">"project_id"</span>: <span class="hljs-string">"my-gemini-project-12345"</span>,
6.      <span class="hljs-string">"location"</span>: <span class="hljs-string">"us-central1"</span>,
7.      <span class="hljs-string">"model_id"</span>: <span class="hljs-string">"text-embedding-004"</span>
8.    }
9.  }

`AI写代码
</code></pre>
<p>然后在 Kibana 中创建 .inference connector。路径：Stack Management → Connectors → AI Connector。<br/>
将 task type 设置为 text_embedding，provider 设置为 googlevertexai，inference ID 设置为 gemini_embeddings —— 这必须与你在索引映射中使用的一致，否则无法工作。在 secrets 部分粘贴相同的服务账号 JSON。保存时，connector 会自动创建/更新 inference endpoint。至少理论上是这样，我当时刷新了几次才生效。</p>
<p>重要提示：inference_id 必须与你的索引映射一致。在你能用 semantic_text 字段索引文档之前，endpoint 必须存在。Elasticsearch 在索引时会自动生成 embeddings。至少文档是这么说的 —— 我最初遇到了一些问题，但最终还是成功了。</p>
<p>示例文档：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  POST /expenses/_doc
2.  {
3.    <span class="hljs-string">"@timestamp"</span>: <span class="hljs-string">"2025-01-15T10:30:00Z"</span>,
4.    <span class="hljs-string">"amount"</span>: 250.0,
5.    <span class="hljs-string">"merchant"</span>: <span class="hljs-string">"cafe"</span>,
6.    <span class="hljs-string">"category"</span>: <span class="hljs-string">"food"</span>,
7.    <span class="hljs-string">"payment_method"</span>: <span class="hljs-string">"credit_card"</span>,
8.    <span class="hljs-string">"raw_transcript"</span>: <span class="hljs-string">"Spent 250 on lunch at the cafe"</span>,
9.    <span class="hljs-string">"semantic_text"</span>: <span class="hljs-string">"Spent 250 on lunch at the cafe"</span>,
10.    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"user123"</span>,
11.    <span class="hljs-string">"telegram_chat_id"</span>: <span class="hljs-string">"chat456"</span>
12.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>semantic_text 字段会自动生成 embeddings。你可以检查它是否成功，尽管我不完全确定失败时的输出是什么。我只是根据查询返回了结果，就假设它成功了：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  GET /expenses/_search
2.  {
3.    <span class="hljs-string">"_source"</span>: {
4.      <span class="hljs-string">"includes"</span>: [<span class="hljs-string">"*"</span>, <span class="hljs-string">"_inference_fields"</span>]
5.    },
6.    <span class="hljs-string">"query"</span>: {
7.      <span class="hljs-string">"match_all"</span>: {}
8.    },
9.    <span class="hljs-string">"size"</span>: 1
10.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<h2 data-id="heading-3">创建 ES|QL 工具</h2>
<p>我为 Agent Builder 创建了两个 ES|QL 工具。嗯，我本来想创建更多，但这两个已经足够我的需求了。如果需要，之后可能还可以添加更多。第一个按日期范围搜索：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  POST kbn://api/agent_builder/tools
2.  {
3.    <span class="hljs-string">"id"</span>: <span class="hljs-string">"search_expenses_by_date"</span>,
4.    <span class="hljs-string">"type"</span>: <span class="hljs-string">"esql"</span>,
5.    <span class="hljs-string">"description"</span>: <span class="hljs-string">"Search expenses within a date range. Returns amount, merchant, category, and payment method."</span>,
6.    <span class="hljs-string">"tags"</span>: [<span class="hljs-string">"expenses"</span>, <span class="hljs-string">"analytics"</span>],
7.    <span class="hljs-string">"configuration"</span>: {
8.      <span class="hljs-string">"query"</span>: <span class="hljs-string">"FROM expenses | WHERE @timestamp &gt;= ?start_date AND @timestamp &lt;= ?end_date | WHERE category == ?category | STATS total = SUM(amount) BY category, payment_method | SORT total DESC"</span>,
9.      <span class="hljs-string">"params"</span>: {
10.        <span class="hljs-string">"start_date"</span>: {
11.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>,
12.          <span class="hljs-string">"description"</span>: <span class="hljs-string">"Start date in ISO format (e.g., 2025-01-01)"</span>
13.        },
14.        <span class="hljs-string">"end_date"</span>: {
15.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>,
16.          <span class="hljs-string">"description"</span>: <span class="hljs-string">"End date in ISO format (e.g., 2025-01-31)"</span>
17.        },
18.        <span class="hljs-string">"category"</span>: {
19.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>,
20.          <span class="hljs-string">"description"</span>: <span class="hljs-string">"Category filter (optional - use empty string for all categories)"</span>,
21.          <span class="hljs-string">"optional"</span>: <span class="hljs-literal">true</span>,
22.          <span class="hljs-string">"defaultValue"</span>: <span class="hljs-string">""</span>
23.        }
24.      }
25.    }
26.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>ES|QL 工具使用 ?param_name 语法。category 参数是可选的 —— 空字符串返回所有类别。我想是这样，我没有测试所有边界情况。可能本该测试，但对我的用例来说已经可以用了。</p>
<p>第二个工具做语义搜索。这比我预期的更有用。语义搜索效果实际上相当不错：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  POST kbn://api/agent_builder/tools
2.  {
3.    <span class="hljs-string">"id"</span>: <span class="hljs-string">"semantic_search_expenses"</span>,
4.    <span class="hljs-string">"type"</span>: <span class="hljs-string">"esql"</span>,
5.    <span class="hljs-string">"description"</span>: <span class="hljs-string">"Semantically search expenses using natural language query. Useful for finding expenses by description, merchant name, or context."</span>,
6.    <span class="hljs-string">"tags"</span>: [<span class="hljs-string">"expenses"</span>, <span class="hljs-string">"semantic-search"</span>],
7.    <span class="hljs-string">"configuration"</span>: {
8.      <span class="hljs-string">"query"</span>: <span class="hljs-string">"FROM expenses METADATA _score | WHERE MATCH(semantic_text, ?query) | SORT _score DESC, @timestamp DESC | LIMIT ?limit"</span>,
9.      <span class="hljs-string">"params"</span>: {
10.        <span class="hljs-string">"query"</span>: {
11.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
12.          <span class="hljs-string">"description"</span>: <span class="hljs-string">"Natural language search query"</span>
13.        },
14.        <span class="hljs-string">"limit"</span>: {
15.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"integer"</span>,
16.          <span class="hljs-string">"description"</span>: <span class="hljs-string">"Maximum number of results"</span>,
17.          <span class="hljs-string">"optional"</span>: <span class="hljs-literal">true</span>,
18.          <span class="hljs-string">"defaultValue"</span>: 10
19.        }
20.      }
21.    }
22.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>MATCH 函数在 semantic_text 字段上使用映射中的 inference endpoint 执行语义搜索。你需要使用 METADATA _score 按相关性排序 —— 我是在疑惑为什么结果没有正确排序后才学到这一点的。错误信息也不是特别有帮助。</p>
<h2 data-id="heading-4">工作流</h2>
<p>这个工作流每 15 秒运行一次。轮询 Telegram。处理消息。它很长，因为要处理语音和文本、意图分类、置信度检查、路由。可能可以更短，但我没怎么优化。如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">`</span>

<span class="hljs-attr">1.  name:</span> <span class="hljs-string">"Expense Assistant Workflow"</span>
<span class="hljs-attr">2.  description:</span> <span class="hljs-string">"Scheduled workflow that polls Telegram and processes expense messages"</span>
<span class="hljs-attr">3.  enabled:</span> <span class="hljs-literal">true</span>

<span class="hljs-attr">5.  triggers:</span>
<span class="hljs-attr">6.    - type:</span> <span class="hljs-string">scheduled</span>
<span class="hljs-attr">7.      with:</span>
<span class="hljs-attr">8.        every:</span> <span class="hljs-string">"15s"</span>

<span class="hljs-attr">10.  consts:</span>
<span class="hljs-attr">11.    telegram_bot_token:</span> <span class="hljs-string">"&lt;TELEGRAM_BOT_TOKEN&gt;"</span>
<span class="hljs-attr">12.    telegram_api_url:</span> <span class="hljs-string">"https://api.telegram.org/bot"</span>
<span class="hljs-attr">13.    last_update_id:</span> <span class="hljs-number">0</span>  <span class="hljs-comment"># This will be stored/retrieved from Elasticsearch</span>

<span class="hljs-attr">15.  steps:</span>
<span class="hljs-number">16</span><span class="hljs-string">.</span>      <span class="hljs-comment"># Step 1: Poll Telegram for new messages</span>
<span class="hljs-attr">17.      - name:</span> <span class="hljs-string">poll_telegram</span>
<span class="hljs-attr">18.        type:</span> <span class="hljs-string">http</span>
<span class="hljs-attr">19.        with:</span>
<span class="hljs-attr">20.          url:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ consts.telegram_api_url }}</span><span class="hljs-template-variable">{{ consts.telegram_bot_token }}</span>/getUpdates"</span>
<span class="hljs-attr">21.          method:</span> <span class="hljs-string">GET</span>
<span class="hljs-attr">22.          body:</span>
<span class="hljs-attr">23.            offset:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.get_last_update_id.output._source.last_update_id | default: 0 | plus: 1 }}</span>"</span>
<span class="hljs-attr">24.        on-failure:</span>
<span class="hljs-attr">25.          continue:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># Skip if there's a conflict, will retry on next run</span>

<span class="hljs-number">27</span><span class="hljs-string">.</span>      <span class="hljs-comment"># Step 2: Check if there are new messages</span>
<span class="hljs-attr">28.      - name:</span> <span class="hljs-string">check_new_messages</span>
<span class="hljs-attr">29.        type:</span> <span class="hljs-string">if</span>
<span class="hljs-attr">30.        condition:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.poll_telegram.output.result }}</span>"</span>
<span class="hljs-attr">31.        steps:</span>
<span class="hljs-number">32</span><span class="hljs-string">.</span>          <span class="hljs-comment"># Step 3: Process each message</span>
<span class="hljs-attr">33.          - name:</span> <span class="hljs-string">process_messages</span>
<span class="hljs-attr">34.            type:</span> <span class="hljs-string">foreach</span>
<span class="hljs-attr">35.            foreach:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.poll_telegram.output.result | json: 2 }}</span>"</span>
<span class="hljs-attr">36.            steps:</span>
<span class="hljs-number">37</span><span class="hljs-string">.</span>              <span class="hljs-comment"># Extract message data from Telegram update</span>
<span class="hljs-attr">38.              - name:</span> <span class="hljs-string">extract_message_data</span>
<span class="hljs-attr">39.                type:</span> <span class="hljs-string">console</span>
<span class="hljs-attr">40.                with:</span>
<span class="hljs-attr">41.                  message:</span> <span class="hljs-string">"Processing message from user <span class="hljs-template-variable">{{ foreach.item.message.from.id | json: 2 }}</span>"</span>

<span class="hljs-number">43</span><span class="hljs-string">.</span>              <span class="hljs-comment"># Check if message has text or voice</span>
<span class="hljs-attr">44.              - name:</span> <span class="hljs-string">check_message_type</span>
<span class="hljs-attr">45.                type:</span> <span class="hljs-string">if</span>
<span class="hljs-attr">46.                condition:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ foreach.item.message.voice != null or foreach.item.message.audio != null }}</span>"</span>
<span class="hljs-attr">47.                steps:</span>
<span class="hljs-number">48</span><span class="hljs-string">.</span>                  <span class="hljs-comment"># Voice message - get file and transcribe</span>
<span class="hljs-attr">49.                  - name:</span> <span class="hljs-string">get_voice_file</span>
<span class="hljs-attr">50.                    type:</span> <span class="hljs-string">http</span>
<span class="hljs-attr">51.                    with:</span>
<span class="hljs-attr">52.                      url:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ consts.telegram_api_url }}</span><span class="hljs-template-variable">{{ consts.telegram_bot_token }}</span>/getFile"</span>
<span class="hljs-attr">53.                      method:</span> <span class="hljs-string">GET</span>
<span class="hljs-attr">54.                      body:</span>
<span class="hljs-attr">55.                        file_id:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ foreach.item.message.voice.file_id | default: foreach.item.message.audio.file_id }}</span>"</span>

<span class="hljs-attr">57.                  - name:</span> <span class="hljs-string">transcribe_voice</span>
<span class="hljs-attr">58.                    type:</span> <span class="hljs-string">http</span>
<span class="hljs-attr">59.                    with:</span>
<span class="hljs-attr">60.                      url:</span> <span class="hljs-string">"https://api.deepgram.com/v1/listen"</span>
<span class="hljs-attr">61.                      method:</span> <span class="hljs-string">POST</span>
<span class="hljs-attr">62.                      headers:</span>
<span class="hljs-attr">63.                        Authorization:</span> <span class="hljs-string">"Token YOUR_DEEPGRAM_KEY"</span>
<span class="hljs-attr">64.                        Content-Type:</span> <span class="hljs-string">"application/json"</span>
<span class="hljs-attr">65.                      body:</span>
<span class="hljs-attr">66.                        url:</span> <span class="hljs-string">"https://api.telegram.org/file/bot<span class="hljs-template-variable">{{ consts.telegram_bot_token }}</span>/<span class="hljs-template-variable">{{ steps.get_voice_file.output.result.file_path }}</span>"</span>
<span class="hljs-attr">67.                    on-failure:</span>
<span class="hljs-attr">68.                      fallback:</span>
<span class="hljs-attr">69.                        - name:</span> <span class="hljs-string">fallback_transcription</span>
<span class="hljs-attr">70.                          type:</span> <span class="hljs-string">http</span>
<span class="hljs-attr">71.                          with:</span>
<span class="hljs-attr">72.                            url:</span> <span class="hljs-string">"http://localhost:8000/transcribe"</span>
<span class="hljs-attr">73.                            method:</span> <span class="hljs-string">POST</span>
<span class="hljs-attr">74.                            body:</span>
<span class="hljs-attr">75.                              audio_url:</span> <span class="hljs-string">"https://api.telegram.org/file/bot<span class="hljs-template-variable">{{ consts.telegram_bot_token }}</span>/<span class="hljs-template-variable">{{ steps.get_voice_file.output.result.file_path }}</span>"</span>
<span class="hljs-attr">76.                else:</span>
<span class="hljs-number">77</span><span class="hljs-string">.</span>                  <span class="hljs-comment"># Text message</span>
<span class="hljs-attr">78.                  - name:</span> <span class="hljs-string">use_text_directly</span>
<span class="hljs-attr">79.                    type:</span> <span class="hljs-string">console</span>
<span class="hljs-attr">80.                    with:</span>
<span class="hljs-attr">81.                      message:</span> <span class="hljs-string">"Processing text message: <span class="hljs-template-variable">{{ foreach.item.message.text | json: 2 }}</span>"</span>

<span class="hljs-number">83</span><span class="hljs-string">.</span>              <span class="hljs-comment"># Extract transcript (from voice or text)</span>
<span class="hljs-attr">84.              - name:</span> <span class="hljs-string">get_transcript</span>
<span class="hljs-attr">85.                type:</span> <span class="hljs-string">console</span>
<span class="hljs-attr">86.                with:</span>
<span class="hljs-attr">87.                  message:</span> <span class="hljs-string">"Transcript: <span class="hljs-template-variable">{{ steps.transcribe_voice.output.results?.channels[0]?.alternatives[0]?.transcript or foreach.item.message.text }}</span>"</span>

<span class="hljs-number">89</span><span class="hljs-string">.</span>              <span class="hljs-comment"># Intent Classification</span>
<span class="hljs-attr">90.              - name:</span> <span class="hljs-string">classify_intent</span>
<span class="hljs-attr">91.                type:</span> <span class="hljs-string">.gemini</span>
<span class="hljs-attr">92.                connector-id:</span> <span class="hljs-string">"gemini-expense-assistant-connector-id"</span>
<span class="hljs-attr">93.                with:</span>
<span class="hljs-attr">94.                  subAction:</span> <span class="hljs-string">invokeAI</span>
<span class="hljs-attr">95.                  subActionParams:</span>
<span class="hljs-attr">96.                    model:</span> <span class="hljs-string">"gemini-2.5-pro"</span>
<span class="hljs-attr">97.                    messages:</span>
<span class="hljs-attr">98.                      - role:</span> <span class="hljs-string">user</span>
<span class="hljs-attr">99.                        content:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.transcribe_voice.output.results?.channels[0]?.alternatives[0]?.transcript or foreach.item.message.text }}</span>"</span>
<span class="hljs-attr">100.                    systemInstruction:</span> <span class="hljs-string">|</span>
<span class="hljs-number">101</span><span class="hljs-string">.</span>                      <span class="hljs-string">You</span> <span class="hljs-string">are</span> <span class="hljs-string">an</span> <span class="hljs-string">intent</span> <span class="hljs-string">classifier</span> <span class="hljs-string">for</span> <span class="hljs-string">an</span> <span class="hljs-string">expense</span> <span class="hljs-string">assistant.</span>
<span class="hljs-number">102</span><span class="hljs-string">.</span>                      <span class="hljs-string">Classify</span> <span class="hljs-string">the</span> <span class="hljs-string">user's</span> <span class="hljs-attr">message as either:</span>
<span class="hljs-attr">103.                      - INGEST:</span> <span class="hljs-string">User</span> <span class="hljs-string">wants</span> <span class="hljs-string">to</span> <span class="hljs-string">add/record</span> <span class="hljs-string">an</span> <span class="hljs-string">expense</span> <span class="hljs-string">(e.g.,</span> <span class="hljs-string">"Spent 250 on lunch"</span><span class="hljs-string">,</span> <span class="hljs-string">"Add dinner for 350"</span><span class="hljs-string">)</span>
<span class="hljs-attr">104.                      - QUERY:</span> <span class="hljs-string">User</span> <span class="hljs-string">wants</span> <span class="hljs-string">to</span> <span class="hljs-string">query/search</span> <span class="hljs-string">expenses</span> <span class="hljs-string">(e.g.,</span> <span class="hljs-string">"How much did I spend last week?"</span><span class="hljs-string">,</span> <span class="hljs-string">"Show my food expenses"</span><span class="hljs-string">)</span>

<span class="hljs-attr">106.                      Always respond with valid JSON only:</span>
<span class="hljs-number">107</span><span class="hljs-string">.</span>                      {
<span class="hljs-number">108</span><span class="hljs-string">.</span>                        <span class="hljs-attr">"intent":</span> <span class="hljs-string">"INGEST"</span> <span class="hljs-string">or</span> <span class="hljs-string">"QUERY"</span>,
<span class="hljs-number">109</span><span class="hljs-string">.</span>                        <span class="hljs-attr">"confidence":</span> <span class="hljs-number">0.0</span><span class="hljs-number">-1.0</span>,
<span class="hljs-number">110</span><span class="hljs-string">.</span>                        <span class="hljs-attr">"reasoning":</span> <span class="hljs-string">"brief explanation"</span>
<span class="hljs-number">111</span><span class="hljs-string">.</span>                      }

<span class="hljs-attr">113.              - name:</span> <span class="hljs-string">check_confidence</span>
<span class="hljs-attr">114.                type:</span> <span class="hljs-string">if</span>
<span class="hljs-number">115</span><span class="hljs-string">.</span>                <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> This condition needs to be adjusted based on your workflow structure.</span>
<span class="hljs-number">116</span><span class="hljs-string">.</span>                <span class="hljs-comment"># The template extracts the confidence, but KQL needs a field name to compare.</span>
<span class="hljs-number">117</span><span class="hljs-string">.</span>                <span class="hljs-comment"># Consider restructuring to extract the confidence value first, then reference it.</span>
<span class="hljs-attr">118.                condition:</span> <span class="hljs-string">"confidence &lt; 0.7"</span>
<span class="hljs-attr">119.                steps:</span>
<span class="hljs-attr">120.                  - name:</span> <span class="hljs-string">request_clarification</span>
<span class="hljs-attr">121.                    type:</span> <span class="hljs-string">http</span>
<span class="hljs-attr">122.                    with:</span>
<span class="hljs-attr">123.                      url:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ consts.telegram_api_url }}</span><span class="hljs-template-variable">{{ consts.telegram_bot_token }}</span>/sendMessage"</span>
<span class="hljs-attr">124.                      method:</span> <span class="hljs-string">POST</span>
<span class="hljs-attr">125.                      headers:</span>
<span class="hljs-attr">126.                        Content-Type:</span> <span class="hljs-string">"application/json"</span>
<span class="hljs-attr">127.                      body:</span>
<span class="hljs-attr">128.                        chat_id:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ foreach.item.message.from.id | json: 2 }}</span>"</span>
<span class="hljs-attr">129.                        text:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.classify_intent.output.message.reasoning }}</span>. Could you please clarify: Are you trying to add an expense or ask about existing expenses?"</span>
<span class="hljs-attr">130.                else:</span>
<span class="hljs-attr">131.                  - name:</span> <span class="hljs-string">route_by_intent</span>
<span class="hljs-attr">132.                    type:</span> <span class="hljs-string">if</span>
<span class="hljs-number">133</span><span class="hljs-string">.</span>                    <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> This condition needs to be adjusted. KQL needs a field name.</span>
<span class="hljs-number">134</span><span class="hljs-string">.</span>                    <span class="hljs-comment"># Consider restructuring to extract the intent value first, then reference it.</span>
<span class="hljs-attr">135.                    condition:</span> <span class="hljs-string">"intent: INGEST"</span>
<span class="hljs-attr">136.                    steps:</span>
<span class="hljs-number">137</span><span class="hljs-string">.</span>                      <span class="hljs-comment"># INGEST BRANCH</span>
<span class="hljs-attr">138.                      - name:</span> <span class="hljs-string">extract_expense_data</span>
<span class="hljs-attr">139.                        type:</span> <span class="hljs-string">.gemini</span>
<span class="hljs-attr">140.                        connector-id:</span> <span class="hljs-string">"gemini-expense-assistant-connector-id"</span>
<span class="hljs-attr">141.                        with:</span>
<span class="hljs-attr">142.                          subAction:</span> <span class="hljs-string">invokeAI</span>
<span class="hljs-attr">143.                          subActionParams:</span>
<span class="hljs-attr">144.                            model:</span> <span class="hljs-string">"gemini-2.5-pro"</span>
<span class="hljs-attr">145.                            messages:</span>
<span class="hljs-attr">146.                              - role:</span> <span class="hljs-string">user</span>
<span class="hljs-attr">147.                                content:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.transcribe_voice.output.results?.channels[0]?.alternatives[0]?.transcript or foreach.item.message.text }}</span>"</span>
<span class="hljs-attr">148.                            systemInstruction:</span> <span class="hljs-string">|</span>
<span class="hljs-number">149</span><span class="hljs-string">.</span>                              <span class="hljs-string">Extract</span> <span class="hljs-string">expense</span> <span class="hljs-string">information</span> <span class="hljs-string">from</span> <span class="hljs-string">the</span> <span class="hljs-string">user's</span> <span class="hljs-string">message.</span>
<span class="hljs-attr">150.                              Return valid JSON with:</span>
<span class="hljs-number">151</span><span class="hljs-string">.</span>                              {
<span class="hljs-number">152</span><span class="hljs-string">.</span>                                <span class="hljs-attr">"amount":</span> <span class="hljs-string">number</span>,
<span class="hljs-number">153</span><span class="hljs-string">.</span>                                <span class="hljs-attr">"merchant":</span> <span class="hljs-string">string</span>,
<span class="hljs-number">154</span><span class="hljs-string">.</span>                                <span class="hljs-attr">"category":</span> <span class="hljs-string">string</span> <span class="hljs-string">(food</span>, <span class="hljs-string">transport</span>, <span class="hljs-string">entertainment</span>, <span class="hljs-string">etc.)</span>,
<span class="hljs-number">155</span><span class="hljs-string">.</span>                                <span class="hljs-attr">"payment_method":</span> <span class="hljs-string">string</span> <span class="hljs-string">(credit_card</span>, <span class="hljs-string">cash</span>, <span class="hljs-string">debit</span>, <span class="hljs-string">etc.)</span>,
<span class="hljs-number">156</span><span class="hljs-string">.</span>                                <span class="hljs-attr">"date":</span> <span class="hljs-string">string</span> <span class="hljs-string">(ISO</span> <span class="hljs-string">format</span>, <span class="hljs-string">default</span> <span class="hljs-string">to</span> <span class="hljs-string">today</span> <span class="hljs-string">if</span> <span class="hljs-string">not</span> <span class="hljs-string">specified)</span>
<span class="hljs-number">157</span><span class="hljs-string">.</span>                              }

<span class="hljs-attr">159.                      - name:</span> <span class="hljs-string">index_expense</span>
<span class="hljs-attr">160.                        type:</span> <span class="hljs-string">elasticsearch.index</span>
<span class="hljs-attr">161.                        with:</span>
<span class="hljs-attr">162.                          index:</span> <span class="hljs-string">"expenses"</span>
<span class="hljs-attr">163.                          document:</span>
<span class="hljs-number">164</span><span class="hljs-string">.</span>                            <span class="hljs-string">"@timestamp"</span><span class="hljs-string">:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.extract_expense_data.output.message.date | default: 'now' }}</span>"</span>
<span class="hljs-attr">165.                            amount:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.extract_expense_data.output.message.amount }}</span>"</span>
<span class="hljs-attr">166.                            merchant:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.extract_expense_data.output.message.merchant }}</span>"</span>
<span class="hljs-attr">167.                            category:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.extract_expense_data.output.message.category }}</span>"</span>
<span class="hljs-attr">168.                            payment_method:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.extract_expense_data.output.message.payment_method }}</span>"</span>
<span class="hljs-attr">169.                            raw_transcript:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.transcribe_voice.output.results?.channels[0]?.alternatives[0]?.transcript or foreach.item.message.text }}</span>"</span>
<span class="hljs-attr">170.                            semantic_text:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.transcribe_voice.output.results?.channels[0]?.alternatives[0]?.transcript or foreach.item.message.text }}</span>"</span>
<span class="hljs-attr">171.                            user_id:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ foreach.item.message.from.id | json: 1 }}</span>"</span>
<span class="hljs-attr">172.                            telegram_chat_id:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ foreach.item.message.chat.id | json: 1 }}</span>"</span>

<span class="hljs-attr">174.                      - name:</span> <span class="hljs-string">send_ingest_response</span>
<span class="hljs-attr">175.                        type:</span> <span class="hljs-string">http</span>
<span class="hljs-attr">176.                        with:</span>
<span class="hljs-attr">177.                          url:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ consts.telegram_api_url }}</span><span class="hljs-template-variable">{{ consts.telegram_bot_token }}</span>/sendMessage"</span>
<span class="hljs-attr">178.                          method:</span> <span class="hljs-string">POST</span>
<span class="hljs-attr">179.                          headers:</span>
<span class="hljs-attr">180.                            Content-Type:</span> <span class="hljs-string">"application/json"</span>
<span class="hljs-attr">181.                          body:</span>
<span class="hljs-attr">182.                                chat_id:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ foreach.item.message.from.id | json: 1 }}</span>"</span>
<span class="hljs-attr">183.                                text:</span> <span class="hljs-string">"✅ Added expense: <span class="hljs-template-variable">{{ steps.extract_expense_data.output.message.amount }}</span> at <span class="hljs-template-variable">{{ steps.extract_expense_data.output.message.merchant }}</span> (<span class="hljs-template-variable">{{ steps.extract_expense_data.output.message.category }}</span>)"</span>

<span class="hljs-attr">185.                    else:</span>
<span class="hljs-number">186</span><span class="hljs-string">.</span>                      <span class="hljs-comment"># QUERY BRANCH</span>
<span class="hljs-attr">187.                      - name:</span> <span class="hljs-string">query_agent</span>
<span class="hljs-attr">188.                        type:</span> <span class="hljs-string">http</span>
<span class="hljs-attr">189.                        with:</span>
<span class="hljs-attr">190.                          url:</span> <span class="hljs-string">"http://localhost:5601/api/agent_builder/mcp"</span>
<span class="hljs-attr">191.                          method:</span> <span class="hljs-string">POST</span>
<span class="hljs-attr">192.                          headers:</span>
<span class="hljs-attr">193.                            Authorization:</span> <span class="hljs-string">"ApiKey YOUR_API_KEY"</span>
<span class="hljs-attr">194.                            Content-Type:</span> <span class="hljs-string">"application/json"</span>
<span class="hljs-attr">195.                          body:</span>
<span class="hljs-attr">196.                            method:</span> <span class="hljs-string">"tools/call"</span>
<span class="hljs-attr">197.                            params:</span>
<span class="hljs-attr">198.                              name:</span> <span class="hljs-string">"semantic_search_expenses"</span>
<span class="hljs-attr">199.                              arguments:</span>
<span class="hljs-attr">200.                                query:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.transcribe_voice.output.results?.channels[0]?.alternatives[0]?.transcript or foreach.item.message.text }}</span>"</span>
<span class="hljs-attr">201.                                limit:</span> <span class="hljs-number">10</span>

<span class="hljs-attr">203.                      - name:</span> <span class="hljs-string">send_query_response</span>
<span class="hljs-attr">204.                        type:</span> <span class="hljs-string">http</span>
<span class="hljs-attr">205.                        with:</span>
<span class="hljs-attr">206.                          url:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ consts.telegram_api_url }}</span><span class="hljs-template-variable">{{ consts.telegram_bot_token }}</span>/sendMessage"</span>
<span class="hljs-attr">207.                          method:</span> <span class="hljs-string">POST</span>
<span class="hljs-attr">208.                          headers:</span>
<span class="hljs-attr">209.                            Content-Type:</span> <span class="hljs-string">"application/json"</span>
<span class="hljs-attr">210.                          body:</span>
<span class="hljs-attr">211.                            chat_id:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ foreach.item.message.from.id | json: 2 }}</span>"</span>
<span class="hljs-attr">212.                            text:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ steps.query_agent.output.content[0].text | default: 'I found your expense information.' }}</span>"</span>

<span class="hljs-number">214</span><span class="hljs-string">.</span>              <span class="hljs-comment"># Step 4: Update last_update_id (store in Elasticsearch for persistence)</span>
<span class="hljs-number">215</span><span class="hljs-string">.</span>              <span class="hljs-comment"># Update on every iteration - the last one will be the final value</span>
<span class="hljs-number">216</span><span class="hljs-string">.</span>              <span class="hljs-comment"># This avoids needing array[length-1] syntax which LiquidJS doesn't support</span>
<span class="hljs-attr">217.              - name:</span> <span class="hljs-string">update_last_update_id</span>
<span class="hljs-attr">218.                type:</span> <span class="hljs-string">elasticsearch.index</span>
<span class="hljs-attr">219.                with:</span>
<span class="hljs-attr">220.                  index:</span> <span class="hljs-string">"telegram-bot-state"</span>
<span class="hljs-attr">221.                  id:</span> <span class="hljs-string">"last_update_id"</span>
<span class="hljs-attr">222.                  document:</span>
<span class="hljs-attr">223.                    last_update_id:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ foreach.item.update_id }}</span>"</span>
<span class="hljs-attr">224.                    updated_at:</span> <span class="hljs-string">"now"</span>

<span class="hljs-string">`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)收起代码块![](https://csdnimg.cn/release/blogv2/dist/pc/img/arrowup-line-top-White.png)</span>
</code></pre>
<h2 data-id="heading-5">测试</h2>
<p>我发送了 “Spent 250 on lunch”（应该会被 ingest）和 “How much did I spend on food last week?”（应该会查询）。</p>
<p>结果失败了<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/895442f7d05542bb94eb8014cdce0696~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766899126&amp;x-signature=nVuc6ecayIDkeJnsBxNhBJC1pIg%3D" alt=":sweat_smile:" loading="lazy"/>.。唉，正如我之前提到的 —— One Workflow 还处于非常早期阶段，并不是所有东西都顺利运行。幸运的是，我已经找到了大部分 bug，最终工作流在我的本地环境中可以运行。所以，我只需要一点时间把所有问题整理到 PR 中并合并，希望很快你就能让一切正常工作 —— 我会更新这篇文章来保持信息同步 =)</p>
<h2 data-id="heading-6">我的收获</h2>
<p>重新实现 Som 的费用助手不仅仅是一次技术实验。这是一次机会，让我看到当编排、搜索、语义和 AI 推理全部在同一平台上运行时会发生什么。说实话？感觉非常协调。就像一切本该协同工作，这很少见。</p>
<p>Elastic 一直在存储和搜索数据方面非常强大。但看到一个工作流从 Telegram 拉取消息、处理语音或文本、用 Gemini 分类意图、丰富并索引文档、运行 ES|QL 分析、并提供对话式回复 —— 所有这些都不离开 Elastic 生态系统 —— 真是有趣。Elasticsearch 显然正在发展成不仅仅是搜索引擎的东西。它正在成为一个平台，让 AI agents 和操作性工作流可以真正融合，而不会相互冲突。</p>
<p>这个助手远不是最终状态。在基础搭建好之后，你可以在它之上构建很多东西。支出洞察。异常检测（“嘿，这笔支出看起来怪怪的…”）。月度总结。对话式仪表板。主动通知。预算管理。多用户 bot。常规功能。所有这些都由同一个引擎驱动，这正是它有趣的地方。</p>
<p>如果你想了解 AI agents 在与真实可观测数据配合时的表现 —— 而不仅仅是漂浮在云端的聊天完成 —— 这种项目是一种出乎意料的、非常直观的探索方式。至少比我预期的更直观。</p>
<p>也许你的支出终于会开始回答你的问题。我的还没有，但它们正越来越接近。</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-4th-2025-en-lets-migrate-this-expense-tool-from-n8n-to-elastic-one-workflow%2F383586" title="https://discuss.elastic.co/t/dec-4th-2025-en-lets-migrate-this-expense-tool-from-n8n-to-elastic-one-workflow/383586" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-4th-2…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>