<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[ThinkPHP8 常见并发场景解决方案文档]]></title>    <link>https://juejin.cn/post/7589262021561958441</link>    <guid>https://juejin.cn/post/7589262021561958441</guid>    <pubDate>2025-12-30T10:02:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589262021561958441" data-draft-id="7589262021561925673" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThinkPHP8 常见并发场景解决方案文档"/> <meta itemprop="keywords" content="后端,Redis"/> <meta itemprop="datePublished" content="2025-12-30T10:02:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="兔丝"/> <meta itemprop="url" content="https://juejin.cn/user/2385268740724025"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThinkPHP8 常见并发场景解决方案文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2385268740724025/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    兔丝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T10:02:13.000Z" title="Tue Dec 30 2025 10:02:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ThinkPHP8 常见并发场景解决方案文档</h2>
<h2 data-id="heading-1">一、文档说明</h2>
<blockquote>
<p>本文档针对开发中高频出现的4类并发问题，提供基于 ThinkPHP8 的可直接运行解决方案，涵盖代码实现、核心原理、适用场景及关键注意事项，旨在帮助开发者快速解决并发场景下的数据一致性和系统稳定性问题。</p>
</blockquote>
<blockquote>
<p>适用范围：ThinkPHP8 开发者、需要处理并发场景（防超卖、防重复提交等）的后端开发人员</p>
</blockquote>
<blockquote>
<p>前置依赖：已配置 ThinkPHP8 环境，涉及 Redis 的场景需完成 Redis 扩展及配置</p>
</blockquote>
<h2 data-id="heading-2">二、核心并发场景解决方案</h2>
<h3 data-id="heading-3">场景1：库存扣减（防止超卖）</h3>
<h4 data-id="heading-4">1.1 场景说明</h4>
<p>高并发场景下（如秒杀、促销活动），多个用户同时抢购同一商品，若未做并发控制，会出现库存扣减为负数的“超卖”问题，导致业务逻辑异常。核心需求：保证库存数据一致性，不出现超卖。</p>
<h4 data-id="heading-5">1.2 方案选型：MySQL 悲观锁（行锁）</h4>
<p>采用 MySQL InnoDB 存储引擎的行级排他锁，结合事务机制，确保“检查库存+扣减库存”的原子性，同一时间仅允许一个请求修改目标商品的库存记录。适用于库存一致性要求高、并发量中等的场景（如普通电商订单）。</p>
<h4 data-id="heading-6">1.3 实现代码</h4>
<pre><code class="hljs language-php" lang="php">
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">controller</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Db</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">response</span>\<span class="hljs-title">Json</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StockController</span>
</span>{
    <span class="hljs-comment">/**
     * 商品库存扣减接口
     * <span class="hljs-doctag">@param</span> int $productId 商品ID（URL参数）
     * <span class="hljs-doctag">@param</span> int $num 扣减数量（默认1）
     * <span class="hljs-doctag">@return</span> Json
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reduceStock</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$productId</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$num</span> = <span class="hljs-number">1</span></span>): <span class="hljs-title">Json</span>
    </span>{
        <span class="hljs-comment">// 开启数据库事务，保证操作原子性</span>
        <span class="hljs-title class_">Db</span>::<span class="hljs-title function_ invoke__">startTrans</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 锁定目标商品行记录（排他锁，防止并发修改）</span>
            <span class="hljs-comment">// lock(true) 等价于 SQL 中的 SELECT ... FOR UPDATE</span>
            <span class="hljs-variable">$product</span> = <span class="hljs-title class_">Db</span>::<span class="hljs-title function_ invoke__">name</span>(<span class="hljs-string">'product'</span>)
                -&gt;<span class="hljs-title function_ invoke__">where</span>(<span class="hljs-string">'id'</span>, <span class="hljs-variable">$productId</span>)
                -&gt;<span class="hljs-title function_ invoke__">lock</span>(<span class="hljs-literal">true</span>)
                -&gt;<span class="hljs-title function_ invoke__">find</span>();

            <span class="hljs-comment">// 2. 基础校验</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$product</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">"商品不存在"</span>);
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$product</span>[<span class="hljs-string">'stock'</span>] &lt; <span class="hljs-variable">$num</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">"库存不足，当前库存：<span class="hljs-subst">{$product['stock']}</span>"</span>);
            }

            <span class="hljs-comment">// 3. 扣减库存（使用 Db::raw 确保SQL语法正确）</span>
            <span class="hljs-variable">$updateRes</span> = <span class="hljs-title class_">Db</span>::<span class="hljs-title function_ invoke__">name</span>(<span class="hljs-string">'product'</span>)
                -&gt;<span class="hljs-title function_ invoke__">where</span>(<span class="hljs-string">'id'</span>, <span class="hljs-variable">$productId</span>)
                -&gt;<span class="hljs-title function_ invoke__">update</span>([<span class="hljs-string">'stock'</span> =&gt; <span class="hljs-title class_">Db</span>::<span class="hljs-title function_ invoke__">raw</span>(<span class="hljs-string">"stock - <span class="hljs-subst">{$num}</span>"</span>)]);

            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$updateRes</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">"库存扣减失败"</span>);
            }

            <span class="hljs-comment">// 4. 提交事务</span>
            <span class="hljs-title class_">Db</span>::<span class="hljs-title function_ invoke__">commit</span>();
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'库存扣减成功'</span>,
                <span class="hljs-string">'data'</span> =&gt; [<span class="hljs-string">'product_id'</span> =&gt; <span class="hljs-variable">$productId</span>, <span class="hljs-string">'remain_stock'</span> =&gt; <span class="hljs-variable">$product</span>[<span class="hljs-string">'stock'</span>] - <span class="hljs-variable">$num</span>]
            ]);
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-comment">// 5. 异常回滚事务</span>
            <span class="hljs-title class_">Db</span>::<span class="hljs-title function_ invoke__">rollback</span>();
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>,
                <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(),
                <span class="hljs-string">'data'</span> =&gt; []
            ]);
        }
    }
}

</code></pre>
<h4 data-id="heading-7">1.4 关键解析</h4>
<ul>
<li>
<p><strong>行锁机制</strong>：<code>lock(true)</code> 会对查询的商品记录加排他锁，同一时间只有一个事务能获取该锁，其他请求需等待锁释放，避免并发修改冲突。</p>
</li>
<li>
<p><strong>事务保障</strong>：通过 <code>Db::startTrans()</code>、<code>Db::commit()</code>、<code>Db::rollback()</code> 确保“查库存+扣库存”是原子操作，要么全部成功，要么全部回滚。</p>
</li>
<li>
<p><strong>表结构要求</strong>：product 表需包含 id（主键）、stock（库存字段），主键索引确保行锁能精准锁定单条记录（无索引会退化为表锁，降低并发）。</p>
</li>
<li>
<p><strong>优化方向</strong>：高并发秒杀场景可改用“Redis 预扣减+MQ 异步落库”方案，进一步提升系统吞吐量。</p>
</li>
</ul>
<h3 data-id="heading-8">场景2：订单创建（防止重复提交）</h3>
<h4 data-id="heading-9">2.1 场景说明</h4>
<p>用户因网络延迟、重复点击按钮、恶意重试等原因，可能导致同一订单请求被多次提交，出现重复创建订单、重复扣减库存的问题。核心需求：确保同一订单请求仅被处理一次。</p>
<h4 data-id="heading-10">2.2 方案选型：Token 令牌验证</h4>
<p>基于“一次性 Token”机制，前端请求订单创建前先获取令牌，提交订单时携带令牌，后端验证令牌有效性（未使用过、未过期），验证通过后立即失效令牌，防止重复使用。适用于表单提交、API 接口防重放等场景。</p>
<h4 data-id="heading-11">2.3 实现代码</h4>
<pre><code class="hljs language-php" lang="php">
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">controller</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Cache</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Db</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Session</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">request</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">response</span>\<span class="hljs-title">Json</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span>
</span>{
    <span class="hljs-comment">/**
     * 1. 获取防重复提交 Token（前端调用）
     * <span class="hljs-doctag">@return</span> Json
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOrderToken</span>(<span class="hljs-params"/>): <span class="hljs-title">Json</span>
    </span>{
        <span class="hljs-comment">// 生成随机唯一 Token（md5+uniqid 保证唯一性）</span>
        <span class="hljs-variable">$token</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>(<span class="hljs-title function_ invoke__">mt_rand</span>(), <span class="hljs-literal">true</span>));
        <span class="hljs-comment">// 存储 Token：单机用 Session，分布式用 Redis（此处兼容两种场景）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'cache.default'</span>) === <span class="hljs-string">'redis'</span>) {
            <span class="hljs-comment">// Redis 存储，设置 10 分钟过期（避免令牌堆积）</span>
            <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">"order_token:"</span>.<span class="hljs-title class_">Session</span>::<span class="hljs-title function_ invoke__">getId</span>(), <span class="hljs-variable">$token</span>, <span class="hljs-number">600</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Session 存储</span>
            <span class="hljs-title class_">Session</span>::<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">'order_token'</span>, <span class="hljs-variable">$token</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([
            <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">0</span>,
            <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'Token 获取成功'</span>,
            <span class="hljs-string">'data'</span> =&gt; [<span class="hljs-string">'token'</span> =&gt; <span class="hljs-variable">$token</span>]
        ]);
    }

    <span class="hljs-comment">/**
     * 2. 创建订单接口（前端携带 Token 提交）
     * <span class="hljs-doctag">@param</span> Request $request
     * <span class="hljs-doctag">@return</span> Json
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createOrder</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>): <span class="hljs-title">Json</span>
    </span>{
        <span class="hljs-variable">$postData</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">post</span>();
        <span class="hljs-comment">// 必要参数校验</span>
        <span class="hljs-variable">$validateRes</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">validate</span>(<span class="hljs-variable">$postData</span>, [
            <span class="hljs-string">'user_id'</span> =&gt; <span class="hljs-string">'require|integer'</span>,
            <span class="hljs-string">'product_id'</span> =&gt; <span class="hljs-string">'require|integer'</span>,
            <span class="hljs-string">'amount'</span> =&gt; <span class="hljs-string">'require|float|gt:0'</span>,
            <span class="hljs-string">'token'</span> =&gt; <span class="hljs-string">'require'</span>
        ]);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$validateRes</span> !== <span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-variable">$validateRes</span>, <span class="hljs-string">'data'</span> =&gt; []]);
        }

        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$postData</span>[<span class="hljs-string">'token'</span>];
        <span class="hljs-variable">$tokenKey</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'cache.default'</span>) === <span class="hljs-string">'redis'</span> 
            ? <span class="hljs-string">"order_token:"</span>.<span class="hljs-title class_">Session</span>::<span class="hljs-title function_ invoke__">getId</span>() 
            : <span class="hljs-string">'order_token'</span>;

        <span class="hljs-comment">// 3. 验证 Token 有效性</span>
        <span class="hljs-variable">$storedToken</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'cache.default'</span>) === <span class="hljs-string">'redis'</span> 
            ? <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$tokenKey</span>) 
            : <span class="hljs-title class_">Session</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'order_token'</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$storedToken</span>) || <span class="hljs-variable">$storedToken</span> !== <span class="hljs-variable">$token</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'重复提交或 Token 已失效'</span>, <span class="hljs-string">'data'</span> =&gt; []]);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 4. 验证通过，立即销毁 Token（核心：确保一次性使用）</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'cache.default'</span>) === <span class="hljs-string">'redis'</span>) {
                <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-variable">$tokenKey</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title class_">Session</span>::<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-string">'order_token'</span>);
            }

            <span class="hljs-comment">// 5. 执行创建订单逻辑（此处可调用库存扣减接口）</span>
            <span class="hljs-variable">$orderId</span> = <span class="hljs-title class_">Db</span>::<span class="hljs-title function_ invoke__">name</span>(<span class="hljs-string">'order'</span>)-&gt;<span class="hljs-title function_ invoke__">insertGetId</span>([
                <span class="hljs-string">'user_id'</span> =&gt; <span class="hljs-variable">$postData</span>[<span class="hljs-string">'user_id'</span>],
                <span class="hljs-string">'product_id'</span> =&gt; <span class="hljs-variable">$postData</span>[<span class="hljs-string">'product_id'</span>],
                <span class="hljs-string">'amount'</span> =&gt; <span class="hljs-variable">$postData</span>[<span class="hljs-string">'amount'</span>],
                <span class="hljs-string">'order_sn'</span> =&gt; <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">generateOrderSn</span>(), // 生成订单号
                <span class="hljs-string">'status'</span> =&gt; <span class="hljs-number">1</span>, // <span class="hljs-number">1</span>-待支付
                <span class="hljs-string">'create_time'</span> =&gt; <span class="hljs-title function_ invoke__">time</span>()
            ]);

            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'订单创建成功'</span>,
                <span class="hljs-string">'data'</span> =&gt; [<span class="hljs-string">'order_id'</span> =&gt; <span class="hljs-variable">$orderId</span>, <span class="hljs-string">'order_sn'</span> =&gt; <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">generateOrderSn</span>()]
            ]);
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(), <span class="hljs-string">'data'</span> =&gt; []]);
        }
    }

    <span class="hljs-comment">/**
     * 辅助方法：生成唯一订单号
     * <span class="hljs-doctag">@return</span> string
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateOrderSn</span>(<span class="hljs-params"/>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">'YmdHis'</span>) . <span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">9999</span>);
    }
}

</code></pre>
<h4 data-id="heading-12">2.4 关键解析</h4>
<ul>
<li>
<p><strong>Token 唯一性</strong>：通过 <code>uniqid(mt_rand(), true)</code> 生成随机字符串，结合 md5 加密，确保 Token 唯一且不可预测。</p>
</li>
<li>
<p><strong>存储适配</strong>：兼容单机（Session）和分布式（Redis）部署，Redis 存储时通过 SessionID 区分用户，避免 Token 混淆。</p>
</li>
<li>
<p><strong>一次性有效性</strong>：订单创建成功前立即销毁 Token，即使同一 Token 被重复提交，也会因 Token 不存在而被拒绝。</p>
</li>
<li>
<p><strong>过期机制</strong>：Redis 存储的 Token 设置 10 分钟过期，避免因用户未提交订单导致 Token 长期堆积。</p>
</li>
</ul>
<h3 data-id="heading-13">场景3：分布式任务调度（防止重复执行）</h3>
<h4 data-id="heading-14">3.1 场景说明</h4>
<p>分布式部署环境下（多台服务器），定时任务（如生成日报表、数据同步）若未做控制，会出现多台服务器同时执行同一任务的情况，导致数据重复处理、资源浪费。核心需求：同一任务同一时间仅被一台服务器执行。</p>
<h4 data-id="heading-15">3.2 方案选型：Redis 分布式锁</h4>
<p>基于 Redis 的 <code>SET NX</code>（Set if Not Exists）原子命令实现分布式锁，任务执行前尝试获取锁，获取成功则执行任务，失败则说明其他节点正在执行，直接返回。适用于分布式定时任务、跨服务数据同步等场景。</p>
<h4 data-id="heading-16">3.3 实现代码</h4>
<pre><code class="hljs language-php" lang="php">
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">controller</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Cache</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">response</span>\<span class="hljs-title">Json</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskController</span>
</span>{
    <span class="hljs-comment">/**
     * 分布式定时任务执行入口
     * 示例：每日凌晨2点执行日报表生成任务
     * <span class="hljs-doctag">@param</span> string $taskName 任务名称（如：daily_report）
     * <span class="hljs-doctag">@return</span> Json
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runDistributedTask</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$taskName</span></span>): <span class="hljs-title">Json</span>
    </span>{
        <span class="hljs-comment">// 1. 锁相关配置</span>
        <span class="hljs-variable">$lockKey</span> = <span class="hljs-string">"distributed_lock:task:<span class="hljs-subst">{$taskName}</span>"</span>; <span class="hljs-comment">// 锁 Key（按任务名称区分）</span>
        <span class="hljs-variable">$lockExpire</span> = <span class="hljs-number">300</span>; <span class="hljs-comment">// 锁过期时间（5分钟），防止节点挂掉导致锁永久不释放</span>
        <span class="hljs-variable">$lockValue</span> = <span class="hljs-title function_ invoke__">uniqid</span>(); <span class="hljs-comment">// 锁值（用于释放锁时校验，避免误删其他锁）</span>

        <span class="hljs-comment">// 2. 尝试获取 Redis 分布式锁（SET NX + EX 原子操作）</span>
        <span class="hljs-comment">// NX：仅当 Key 不存在时设置成功；EX：设置过期时间（秒）</span>
        <span class="hljs-variable">$isLocked</span> = <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-variable">$lockKey</span>, <span class="hljs-variable">$lockValue</span>, <span class="hljs-variable">$lockExpire</span>, [<span class="hljs-string">'NX'</span>]);

        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$isLocked</span>) {
            <span class="hljs-comment">// 未获取到锁，说明其他节点正在执行任务</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>,
                <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">"任务【<span class="hljs-subst">{$taskName}</span>】已在其他节点执行中"</span>,
                <span class="hljs-string">'data'</span> =&gt; []
            ]);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 获取锁成功，执行任务逻辑</span>
            <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$taskName</span>) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'daily_report'</span>:
                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">generateDailyReport</span>(); <span class="hljs-comment">// 生成日报表</span>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'data_sync'</span>:
                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">syncData</span>(); <span class="hljs-comment">// 数据同步（示例方法）</span>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">"未知任务名称：<span class="hljs-subst">{$taskName}</span>"</span>);
            }

            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">"任务【<span class="hljs-subst">{$taskName}</span>】执行完成"</span>,
                <span class="hljs-string">'data'</span> =&gt; []
            ]);
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>,
                <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">"任务【<span class="hljs-subst">{$taskName}</span>】执行失败："</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(),
                <span class="hljs-string">'data'</span> =&gt; []
            ]);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 任务执行完成/失败，释放锁（Lua脚本保证原子性）</span>
            <span class="hljs-comment">// 避免因任务执行时间超过锁过期时间，导致误删其他节点的锁</span>
            <span class="hljs-variable">$luaScript</span> = <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;
            <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$luaScript</span>, [<span class="hljs-variable">$lockKey</span>, <span class="hljs-variable">$lockValue</span>], <span class="hljs-number">1</span>);
        }
    }

    <span class="hljs-comment">/**
     * 任务1：生成日报表（示例实现）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateDailyReport</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-comment">// 模拟耗时任务（实际场景：查询昨日数据、生成Excel、推送邮件等）</span>
        <span class="hljs-title function_ invoke__">sleep</span>(<span class="hljs-number">3</span>);
        <span class="hljs-comment">// 此处可添加报表生成逻辑（如写入 report 表、存储文件等）</span>
    }

    <span class="hljs-comment">/**
     * 任务2：数据同步（示例实现）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">syncData</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-comment">// 模拟数据同步逻辑（如同步第三方数据到本地库）</span>
        <span class="hljs-title function_ invoke__">sleep</span>(<span class="hljs-number">2</span>);
    }
}

</code></pre>
<h4 data-id="heading-17">3.4 关键解析</h4>
<ul>
<li>
<p><strong>原子锁获取</strong>：<code>set($lockKey, $lockValue, $lockExpire, ['NX'])</code> 是原子操作，避免“检查锁是否存在”和“设置锁”两步操作之间出现并发问题。</p>
</li>
<li>
<p><strong>锁过期保护</strong>：设置 5 分钟过期时间，即使执行任务的节点意外挂掉，锁也会自动过期释放，避免死锁。</p>
</li>
<li>
<p><strong>安全释放锁</strong>：通过 Lua 脚本校验锁值后再删除，确保仅释放当前节点持有的锁，避免因任务执行超时导致锁被其他节点误删。</p>
</li>
<li>
<p><strong>任务调度配置</strong>：可结合 ThinkPHP 定时任务（think-cron），在多台服务器部署相同定时任务，通过分布式锁实现“单点执行”。</p>
</li>
</ul>
<h3 data-id="heading-18">场景4：缓存更新（防止缓存击穿/雪崩）</h3>
<h4 data-id="heading-19">4.1 场景说明</h4>
<ul>
<li>
<p><strong>缓存击穿</strong>：一个热点 Key 过期时，大量请求同时穿透到数据库，导致数据库瞬间压力剧增。</p>
</li>
<li>
<p><strong>缓存雪崩</strong>：大量 Key 同时过期，或缓存服务宕机，导致所有请求直接打到数据库，可能引发数据库崩溃。</p>
</li>
</ul>
<p>核心需求：保护数据库，避免缓存失效时的流量冲击。</p>
<h4 data-id="heading-20">4.2 方案选型：Redis 互斥锁（防击穿）+ 缓存空值（防穿透）+ 过期时间随机化（防雪崩）</h4>
<p>通过互斥锁确保只有一个请求去数据库查询热点数据并更新缓存，其他请求等待或重试；对不存在的 Key 缓存空值，防止缓存穿透；给 Key 设置随机过期时间，避免大量 Key 同时过期。</p>
<h4 data-id="heading-21">4.3 实现代码</h4>
<pre><code class="hljs language-php" lang="php">
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">controller</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Cache</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">facade</span>\<span class="hljs-title">Db</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">response</span>\<span class="hljs-title">Json</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheController</span>
</span>{
    <span class="hljs-comment">/**
     * 获取商品详情（带缓存防击穿/雪崩/穿透）
     * <span class="hljs-doctag">@param</span> int $productId 商品ID
     * <span class="hljs-doctag">@return</span> Json
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getProductDetail</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$productId</span></span>): <span class="hljs-title">Json</span>
    </span>{
        <span class="hljs-comment">// 1. 缓存 Key 定义（按业务类型+ID 命名）</span>
        <span class="hljs-variable">$cacheKey</span> = <span class="hljs-string">"product:detail:<span class="hljs-subst">{$productId}</span>"</span>;
        <span class="hljs-comment">// 锁 Key（按缓存 Key 衍生，确保一一对应）</span>
        <span class="hljs-variable">$lockKey</span> = <span class="hljs-string">"lock:cache:<span class="hljs-subst">{$productId}</span>"</span>;
        <span class="hljs-variable">$lockExpire</span> = <span class="hljs-number">10</span>; <span class="hljs-comment">// 锁过期时间（10秒）</span>
        <span class="hljs-variable">$cacheExpire</span> = <span class="hljs-number">3600</span> + <span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>, <span class="hljs-number">600</span>); <span class="hljs-comment">// 缓存过期时间（1小时+随机0-10分钟，防雪崩）</span>

        <span class="hljs-comment">// 2. 优先从缓存获取数据</span>
        <span class="hljs-variable">$productDetail</span> = <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$cacheKey</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$productDetail</span> !== <span class="hljs-literal">false</span>) {
            <span class="hljs-comment">// 缓存命中：若为缓存的空值，返回“商品不存在”</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$productDetail</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'商品不存在'</span>, <span class="hljs-string">'data'</span> =&gt; []]);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'success'</span>, <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$productDetail</span>]);
        }

        <span class="hljs-comment">// 3. 缓存未命中，尝试获取互斥锁</span>
        <span class="hljs-variable">$isLocked</span> = <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-variable">$lockKey</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">$lockExpire</span>, [<span class="hljs-string">'NX'</span>]);
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$isLocked</span>) {
            <span class="hljs-comment">// 未获取到锁：返回“系统繁忙”，前端可重试</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">2</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'系统繁忙，请稍后再试'</span>, <span class="hljs-string">'data'</span> =&gt; []]);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 4. 获取锁成功，从数据库查询数据</span>
            <span class="hljs-variable">$productDetail</span> = <span class="hljs-title class_">Db</span>::<span class="hljs-title function_ invoke__">name</span>(<span class="hljs-string">'product'</span>)
                -&gt;<span class="hljs-title function_ invoke__">where</span>(<span class="hljs-string">'id'</span>, <span class="hljs-variable">$productId</span>)
                -&gt;<span class="hljs-title function_ invoke__">find</span>();

            <span class="hljs-comment">// 5. 处理查询结果：缓存真实数据或空值（防穿透）</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$productDetail</span>)) {
                <span class="hljs-comment">// 商品不存在，缓存空值（1分钟过期，避免长期占用缓存）</span>
                <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-variable">$cacheKey</span>, <span class="hljs-string">''</span>, <span class="hljs-number">60</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'商品不存在'</span>, <span class="hljs-string">'data'</span> =&gt; []]);
            }

            <span class="hljs-comment">// 商品存在，缓存真实数据（带随机过期时间，防雪崩）</span>
            <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-variable">$cacheKey</span>, <span class="hljs-variable">$productDetail</span>, <span class="hljs-variable">$cacheExpire</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'success'</span>, <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$productDetail</span>]);
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'code'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'msg'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(), <span class="hljs-string">'data'</span> =&gt; []]);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 6. 释放锁（无论成功失败，都要释放）</span>
            <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-variable">$lockKey</span>);
        }
    }
}

</code></pre>
<h4 data-id="heading-22">4.4 关键解析</h4>
<ul>
<li>
<p><strong>防击穿</strong>：互斥锁确保只有一个请求去数据库查询热点数据，其他请求因获取不到锁而返回重试提示，避免大量请求同时穿透到数据库。</p>
</li>
<li>
<p><strong>防穿透</strong>：对不存在的商品（数据库无记录），缓存空值（1分钟过期），避免恶意请求（如遍历商品ID）反复穿透到数据库。</p>
</li>
<li>
<p><strong>防雪崩</strong>：缓存过期时间设置为“1小时+随机0-10分钟”，使大量热点 Key 的过期时间分散，避免同时过期导致缓存雪崩。</p>
</li>
<li>
<p><strong>降级策略</strong>：未获取到锁时返回“系统繁忙”，引导用户重试，避免系统过载。</p>
</li>
</ul>
<h2 data-id="heading-23">三、总结：场景-方案对应表</h2>



































<table><thead><tr><th>并发场景</th><th>推荐方案</th><th>核心技术</th><th>适用场景</th></tr></thead><tbody><tr><td>库存扣减（防超卖）</td><td>MySQL 悲观锁+事务</td><td>行级排他锁、数据库事务</td><td>库存一致性要求高、并发量中等</td></tr><tr><td>订单创建（防重复提交）</td><td>Token 令牌验证</td><td>一次性 Token、Session/Redis 存储</td><td>表单提交、API 接口防重放</td></tr><tr><td>分布式任务调度（防重复执行）</td><td>Redis 分布式锁</td><td>SET NX 原子命令、Lua 脚本释放锁</td><td>多服务器部署定时任务、跨服务数据同步</td></tr><tr><td>缓存更新（防击穿/雪崩）</td><td>Redis 互斥锁+缓存空值+随机过期</td><td>分布式锁、缓存空值、随机过期时间</td><td>热点数据查询、高并发缓存访问场景</td></tr></tbody></table>
<h2 data-id="heading-24">四、扩展说明</h2>
<ol>
<li>
<p>所有示例代码均基于 ThinkPHP8 开发，需确保项目已正确配置数据库、Redis（涉及 Redis 的场景）。</p>
</li>
<li>
<p>高并发场景下（如秒杀），建议结合消息队列（如 RabbitMQ、RocketMQ）进一步削峰填谷，提升系统稳定性。</p>
</li>
<li>
<p>分布式锁除 Redis 外，还可使用 ZooKeeper 实现（可靠性更高，但性能略低），根据业务需求选择。</p>
</li>
<li>
<p>实际开发中需结合日志记录、监控告警（如锁竞争情况、缓存命中率），便于问题排查和系统优化。</p>
</li>
</ol>
<h3 data-id="heading-25">🍵 写在最后</h3>
<p>我是 网络乞丐，热爱代码，目前专注于 Web 全栈领域。</p>
<p>欢迎关注我的微信公众号「乞丐的项目」，我会不定期分享一些开发心得、最佳实践以及技术探索等内容，希望能够帮到你！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【机器学习】Kaggle案例之Rossmann连锁药店销售额预测：时间序列与机器学习完美融合的实战指南]]></title>    <link>https://juejin.cn/post/7589220406320644132</link>    <guid>https://juejin.cn/post/7589220406320644132</guid>    <pubDate>2025-12-30T07:50:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589220406320644132" data-draft-id="7589214068094091283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【机器学习】Kaggle案例之Rossmann连锁药店销售额预测：时间序列与机器学习完美融合的实战指南"/> <meta itemprop="keywords" content="机器学习,Kaggle,数据挖掘"/> <meta itemprop="datePublished" content="2025-12-30T07:50:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云天徽上"/> <meta itemprop="url" content="https://juejin.cn/user/152212479153916"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【机器学习】Kaggle案例之Rossmann连锁药店销售额预测：时间序列与机器学习完美融合的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/152212479153916/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云天徽上
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:50:51.000Z" title="Tue Dec 30 2025 07:50:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🧑 博主简介：曾任某智慧城市类企业算法总监，CSDN / 稀土掘金 等平台人工智能领域优质创作者。</p>
</blockquote>
<blockquote>
<p>目前在美国市场的物流公司从事高级算法工程师一职，深耕人工智能领域，精通python数据挖掘、可视化、机器学习等，发表过AI相关的专利并多次在AI类比赛中获奖。</p>
</blockquote>
<hr/>
<p>德国最大连锁药店Rossmann的销售预测挑战，不仅考验我们的机器学习技能，更是一场时间序列分析的盛宴。当1115家门店的未来6周销售预测摆在面前，我们该如何从历史数据中挖掘出销售规律？</p>
<h2 data-id="heading-0">一、项目说明</h2>
<h3 data-id="heading-1">1.1 项目描述</h3>
<p>罗斯曼（Rossmann）是欧洲领先的连锁药店品牌，在7个欧洲国家经营着<strong>3000多家药店</strong>，<strong>Rossmann Store Sales</strong>竞赛的核心目标：基于<strong>844,392条</strong>历史销售记录，预测德国1115家Rossmann药店未来6周的每日销售额，帮助门店经理制定有效的员工排班计划。门店经理需要提前六周预测每日销售额，但销售受多种因素影响：</p>
<ul>
<li><strong>促销活动</strong>：短期促销和长期促销活动</li>
<li><strong>竞争对手</strong>：最近的竞争对手距离和开业时间</li>
<li><strong>节假日</strong>：国家假日、学校假期</li>
<li><strong>季节性</strong>：不同季节和月份的销售波动</li>
<li><strong>地区差异</strong>：不同门店位置的特点</li>
</ul>
<p><strong>核心挑战</strong>：</p>
<ul>
<li>每家门店都有独特的情况和特点</li>
<li>成千上万的门店经理预测准确性差异很大</li>
<li>需要同时处理时间序列特性和门店特征</li>
</ul>
<h3 data-id="heading-2">1.2 评估指标</h3>
<p><strong>均方根百分比误差（RMSPE）</strong> ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1e63b77de54978840951ed8f01fc88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=Q8drsKZL%2Bzpa7pRzgTl6dA1T3L0%3D" alt="" loading="lazy"/></p>
<p><strong>重要注意事项</strong>：</p>
<ul>
<li>只对销售额 &gt; 0 的样本进行评分</li>
<li>当销售额 = 0 时，不纳入RMSPE计算</li>
<li>这种设计避免了零销售额样本对百分比误差计算的干扰</li>
</ul>
<h3 data-id="heading-3">1.3 数据文件</h3>
<ul>
<li><strong>train.csv</strong>：历史销售数据（包含销售额）</li>
<li><strong>test.csv</strong>：待预测数据（不包含销售额）</li>
<li><strong>store.csv</strong>：门店补充信息</li>
<li><strong>sample_submission.csv</strong>：提交格式示例</li>
</ul>
<p><strong>数据处理策略</strong>：由于比赛已结束，我们从训练集中拆分出每家门店的最后48天数据作为验证集，模拟真实测试场景。</p>
<h3 data-id="heading-4">1.4 数据说明</h3>
<h4 data-id="heading-5">1.4.1 store.csv</h4>
<ul>
<li>'Store'：各商店的唯一Id。共1115个。</li>
<li>'StoreType'：区分4种不同的商店模式:a, b, c, d。其中a(54%),d(31%),其他(15%)</li>
<li>'Assortment'：描述分类级别:a = basic, b = extra, c = extended</li>
<li>'CompetitionDistance'：到最近的竞争对手商店的距离(以米为单位)</li>
<li>'CompetitionOpenSinceMonth'：最近的竞争对手商店的（大概）开店月份</li>
<li>'CompetitionOpenSinceYear'：最近的竞争对手商店的（大概）开店年份</li>
<li>'Promo2'：一些商店持续不断的促销活动（0=商店没有参加；1=商店参加）。数据量一半一半</li>
<li>'Promo2SinceWeek'：该店开始参与促销活动的日历周</li>
<li>'Promo2SinceYear'：该店开始参与促销活动的年份</li>
<li>'PromoInterval'：连续时间间隔的促销活动promo2，活动重新启动的月份。如。“2月、5月、8月、11月”是指每轮活动开始于每年的2月、5月、8月、11月</li>
</ul>
<h4 data-id="heading-6">1.4.2 train.csv</h4>
<ul>
<li>Store：每个商店的唯一Id</li>
<li>DayOfWeek：一周的周几</li>
<li>Date：日期</li>
<li>Sales：当天营业额（这是你预测的）</li>
<li>Customers：当天客户数（test.csv里没有）</li>
<li>Open：商店当天是否营业（0否；1是）</li>
<li>Promo：商店当天是否有促销活动</li>
<li>StateHoliday：是否国家假日（一般情况，除少数例外，所有商店在国定假日都关门）。 a =公众假期，b =复活节假期，c =圣诞节，0 =无</li>
<li>SchoolHoliday：（Store,Date）是否受公立学校停课影响</li>
</ul>
<h2 data-id="heading-7">二、📊 完整可运行代码实现</h2>
<h3 data-id="heading-8">2.1 环境准备与数据加载</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入所有必要的库</span>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">import</span> warnings
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error, mean_absolute_error, r2_score
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> LabelEncoder
<span class="hljs-keyword">import</span> xgboost <span class="hljs-keyword">as</span> xgb
<span class="hljs-keyword">import</span> lightgbm <span class="hljs-keyword">as</span> lgb
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestRegressor
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split, TimeSeriesSplit
<span class="hljs-keyword">import</span> gc

<span class="hljs-comment"># 设置中文显示和美化样式</span>
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>, <span class="hljs-string">'DejaVu Sans'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>] = <span class="hljs-literal">False</span>
warnings.filterwarnings(<span class="hljs-string">'ignore'</span>)

<span class="hljs-comment"># 设置Seaborn样式</span>
sns.set_style(<span class="hljs-string">"whitegrid"</span>)
sns.set_palette(<span class="hljs-string">"husl"</span>)
plt.style.use(<span class="hljs-string">'seaborn-v0_8-darkgrid'</span>)

<span class="hljs-comment"># 定义RMSPE计算函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rmspe</span>(<span class="hljs-params">y_true, y_pred</span>):
    <span class="hljs-string">"""
    计算均方根百分比误差（RMSPE）
    这是竞赛的评价指标
    """</span>
    mask = y_true != <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> np.sqrt(np.mean(np.square((y_true[mask] - y_pred[mask]) / y_true[mask])))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">rmspe_xgb</span>(<span class="hljs-params">preds, dtrain</span>):
    <span class="hljs-string">"""
    XGBoost自定义评价函数
    """</span>
    labels = dtrain.get_label()
    mask = labels != <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'RMSPE'</span>, <span class="hljs-built_in">float</span>(np.sqrt(np.mean(np.square((labels[mask] - preds[mask]) / labels[mask]))))

<span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 开始加载数据..."</span>)
<span class="hljs-comment"># 加载数据</span>
train = pd.read_csv(<span class="hljs-string">'../input/rossmann-store-sales/train.csv'</span>, low_memory=<span class="hljs-literal">False</span>)

store = pd.read_csv(<span class="hljs-string">'../input/rossmann-store-sales/store.csv'</span>, low_memory=<span class="hljs-literal">False</span>)


<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 数据加载完成！"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集形状: <span class="hljs-subst">{train.shape}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"门店信息形状: <span class="hljs-subst">{store.shape}</span>"</span>)

<span class="hljs-comment"># 查看数据结构</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📋 训练集预览:"</span>)
<span class="hljs-built_in">print</span>(train.head())
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📋 门店信息预览:"</span>)
<span class="hljs-built_in">print</span>(store.head())
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b9b79a26835427ca6ecec42f94eb857~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=r1x1rtxloDcOZ8jSisd%2BQxsDUPk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">2.2 探索性数据分析（EDA）</h3>
<h4 data-id="heading-10">2.2.1 数据合并与预处理</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess_data</span>(<span class="hljs-params">train_data, store_data, test_data=<span class="hljs-literal">None</span>, is_train=<span class="hljs-literal">True</span></span>):
    <span class="hljs-string">"""
    数据预处理函数
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔧 开始数据预处理..."</span>)
    
    <span class="hljs-comment"># 合并门店信息</span>
    df = train_data.merge(store_data, on=<span class="hljs-string">"Store"</span>, how=<span class="hljs-string">"left"</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_train:
        df = test_data.merge(store_data, on=<span class="hljs-string">"Store"</span>, how=<span class="hljs-string">"left"</span>)
    
    <span class="hljs-comment"># 转换日期格式</span>
    df[<span class="hljs-string">'Date'</span>] = pd.to_datetime(df[<span class="hljs-string">'Date'</span>], errors=<span class="hljs-string">'coerce'</span>)
    
    <span class="hljs-comment"># 处理StateHoliday列的混合类型</span>
    df[<span class="hljs-string">'StateHoliday'</span>] = df[<span class="hljs-string">'StateHoliday'</span>].astype(<span class="hljs-built_in">str</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据合并后形状: <span class="hljs-subst">{df.shape}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"日期范围: <span class="hljs-subst">{df[<span class="hljs-string">'Date'</span>].<span class="hljs-built_in">min</span>()}</span> 到 <span class="hljs-subst">{df[<span class="hljs-string">'Date'</span>].<span class="hljs-built_in">max</span>()}</span>"</span>)
    
    <span class="hljs-keyword">return</span> df

<span class="hljs-comment"># 预处理训练数据</span>
train_df = preprocess_data(train, store)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n训练数据特征:\n<span class="hljs-subst">{train_df.columns.tolist()}</span>"</span>)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a5efc414e7e4d888b3fbc75f15c4ecc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=H4twnUoZMxkAJ2d3cDyEquy%2BIhE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">2.2.2 目标变量分布分析</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_target_distribution</span>(<span class="hljs-params">train_df</span>):
    <span class="hljs-string">"""
    分析目标变量分布
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🎯 目标变量分布分析"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    <span class="hljs-comment"># 基本统计</span>
    sales_stats = train_df[<span class="hljs-string">'Sales'</span>].describe()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"销售额统计信息:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"均值: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'mean'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"中位数: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'50%'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"标准差: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'std'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最小值: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'min'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最大值: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'max'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"25%分位数: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'25%'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"75%分位数: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'75%'</span>]:<span class="hljs-number">.2</span>f}</span>"</span>)
    
    <span class="hljs-comment"># 可视化分布</span>
    fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">5</span>))
    
    <span class="hljs-comment"># 直方图</span>
    axes[<span class="hljs-number">0</span>].hist(train_df[<span class="hljs-string">'Sales'</span>], bins=<span class="hljs-number">50</span>, color=<span class="hljs-string">'#3498db'</span>, alpha=<span class="hljs-number">0.7</span>, edgecolor=<span class="hljs-string">'black'</span>)
    axes[<span class="hljs-number">0</span>].axvline(x=sales_stats[<span class="hljs-string">'mean'</span>], color=<span class="hljs-string">'red'</span>, linestyle=<span class="hljs-string">'--'</span>, 
                   label=<span class="hljs-string">f'均值: <span class="hljs-subst">{sales_stats[<span class="hljs-string">"mean"</span>]:<span class="hljs-number">.0</span>f}</span>'</span>)
    axes[<span class="hljs-number">0</span>].axvline(x=sales_stats[<span class="hljs-string">'50%'</span>], color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, 
                   label=<span class="hljs-string">f'中位数: <span class="hljs-subst">{sales_stats[<span class="hljs-string">"50%"</span>]:<span class="hljs-number">.0</span>f}</span>'</span>)
    axes[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">'销售额分布直方图'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">0</span>].set_xlabel(<span class="hljs-string">'销售额'</span>, fontsize=<span class="hljs-number">12</span>)
    axes[<span class="hljs-number">0</span>].set_ylabel(<span class="hljs-string">'频数'</span>, fontsize=<span class="hljs-number">12</span>)
    axes[<span class="hljs-number">0</span>].legend(fontsize=<span class="hljs-number">10</span>)
    axes[<span class="hljs-number">0</span>].grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
    
    <span class="hljs-comment"># 箱线图</span>
    box = axes[<span class="hljs-number">1</span>].boxplot(train_df[<span class="hljs-string">'Sales'</span>], patch_artist=<span class="hljs-literal">True</span>, vert=<span class="hljs-literal">False</span>)
    box[<span class="hljs-string">'boxes'</span>][<span class="hljs-number">0</span>].set_facecolor(<span class="hljs-string">'#e74c3c'</span>)
    box[<span class="hljs-string">'boxes'</span>][<span class="hljs-number">0</span>].set_alpha(<span class="hljs-number">0.7</span>)
    
    <span class="hljs-comment"># 添加统计信息</span>
    stats_text = (<span class="hljs-string">f"样本数: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_df):,}</span>\n"</span>
                 <span class="hljs-string">f"均值: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'mean'</span>]:<span class="hljs-number">.0</span>f}</span>\n"</span>
                 <span class="hljs-string">f"中位数: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'50%'</span>]:<span class="hljs-number">.0</span>f}</span>\n"</span>
                 <span class="hljs-string">f"标准差: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'std'</span>]:<span class="hljs-number">.0</span>f}</span>\n"</span>
                 <span class="hljs-string">f"最小值: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'min'</span>]:<span class="hljs-number">.0</span>f}</span>\n"</span>
                 <span class="hljs-string">f"最大值: <span class="hljs-subst">{sales_stats[<span class="hljs-string">'max'</span>]:<span class="hljs-number">.0</span>f}</span>"</span>)
    
    axes[<span class="hljs-number">1</span>].text(<span class="hljs-number">0.02</span>, <span class="hljs-number">0.98</span>, stats_text, transform=axes[<span class="hljs-number">1</span>].transAxes,
                fontsize=<span class="hljs-number">10</span>, verticalalignment=<span class="hljs-string">'top'</span>,
                bbox=<span class="hljs-built_in">dict</span>(boxstyle=<span class="hljs-string">'round'</span>, facecolor=<span class="hljs-string">'wheat'</span>, alpha=<span class="hljs-number">0.5</span>))
    
    axes[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">'销售额箱线图'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">1</span>].set_xlabel(<span class="hljs-string">'销售额'</span>, fontsize=<span class="hljs-number">12</span>)
    axes[<span class="hljs-number">1</span>].set_yticklabels([<span class="hljs-string">'销售额'</span>])
    axes[<span class="hljs-number">1</span>].grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
    
    plt.suptitle(<span class="hljs-string">'🎯 目标变量（销售额）分布分析'</span>, fontsize=<span class="hljs-number">16</span>, fontweight=<span class="hljs-string">'bold'</span>, y=<span class="hljs-number">1.05</span>)
    plt.tight_layout()
    plt.show()
    
    <span class="hljs-comment"># 零销售额分析</span>
    zero_sales = (train_df[<span class="hljs-string">'Sales'</span>] == <span class="hljs-number">0</span>).<span class="hljs-built_in">sum</span>()
    zero_percentage = zero_sales / <span class="hljs-built_in">len</span>(train_df) * <span class="hljs-number">100</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n⚠️ 零销售额分析:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"零销售额记录: <span class="hljs-subst">{zero_sales:,}</span> 条 (<span class="hljs-subst">{zero_percentage:<span class="hljs-number">.2</span>f}</span>%)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"非零销售额记录: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_df) - zero_sales:,}</span> 条 (<span class="hljs-subst">{<span class="hljs-number">100</span>-zero_percentage:<span class="hljs-number">.2</span>f}</span>%)"</span>)
    
    <span class="hljs-comment"># 检查零销售额的原因</span>
    zero_sales_df = train_df[train_df[<span class="hljs-string">'Sales'</span>] == <span class="hljs-number">0</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(zero_sales_df) &gt; <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n零销售额原因分析:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"门店关闭 (Open=0): <span class="hljs-subst">{(zero_sales_df[<span class="hljs-string">'Open'</span>] == <span class="hljs-number">0</span>).<span class="hljs-built_in">sum</span>():,}</span> 条"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"节假日 (StateHoliday≠0): <span class="hljs-subst">{(zero_sales_df[<span class="hljs-string">'StateHoliday'</span>] != <span class="hljs-string">'0'</span>).<span class="hljs-built_in">sum</span>():,}</span> 条"</span>)
    
    <span class="hljs-keyword">return</span> sales_stats

<span class="hljs-comment"># 执行目标变量分析</span>
sales_stats = analyze_target_distribution(train_df)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4d3db9ae3734ebeb407d1add602d0aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=3CPVor0FSbc3WhZLPzgdSQ6VeHs%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">2.2.3 时间序列分析</h4>
<pre><code class="hljs language-scss" lang="scss">def <span class="hljs-built_in">analyze_time_series</span>(train_df):
    <span class="hljs-string">""</span><span class="hljs-string">"
    时间序列分析
    "</span><span class="hljs-string">""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📈 时间序列分析"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    # 确保日期列是datetime类型
    train_df[<span class="hljs-string">'Date'</span>] = pd.<span class="hljs-built_in">to_datetime</span>(train_df[<span class="hljs-string">'Date'</span>])
    
    # 按日期聚合销售额
    daily_sales = train_df.<span class="hljs-built_in">groupby</span>(<span class="hljs-string">'Date'</span>)[<span class="hljs-string">'Sales'</span>].<span class="hljs-built_in">sum</span>().<span class="hljs-built_in">reset_index</span>()
    
    # 创建时间序列可视化
    fig, axes = plt.<span class="hljs-built_in">subplots</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">10</span>))
    
    # <span class="hljs-number">1</span>. 总销售额时间序列
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">plot</span>(daily_sales[<span class="hljs-string">'Date'</span>], daily_sales[<span class="hljs-string">'Sales'</span>], color=<span class="hljs-string">'#3498db'</span>, linewidth=<span class="hljs-number">1</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'每日总销售额趋势'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'日期'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'总销售额'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>)
    
    # 添加移动平均线
    window_size = <span class="hljs-number">30</span>
    daily_sales[<span class="hljs-string">'MA_30'</span>] = daily_sales[<span class="hljs-string">'Sales'</span>].<span class="hljs-built_in">rolling</span>(window=window_size).<span class="hljs-built_in">mean</span>()
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">plot</span>(daily_sales[<span class="hljs-string">'Date'</span>], daily_sales[<span class="hljs-string">'MA_30'</span>], color=<span class="hljs-string">'red'</span>, 
                   linewidth=<span class="hljs-number">2</span>, label=f<span class="hljs-string">'{window_size}天移动平均'</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">legend</span>(fontsize=<span class="hljs-number">10</span>)
    
    # <span class="hljs-number">2</span>. 月度平均销售额
    train_df[<span class="hljs-string">'YearMonth'</span>] = train_df[<span class="hljs-string">'Date'</span>].dt.<span class="hljs-built_in">to_period</span>(<span class="hljs-string">'M'</span>)
    monthly_sales = train_df.<span class="hljs-built_in">groupby</span>(<span class="hljs-string">'YearMonth'</span>)[<span class="hljs-string">'Sales'</span>].<span class="hljs-built_in">mean</span>().<span class="hljs-built_in">reset_index</span>()
    monthly_sales[<span class="hljs-string">'YearMonth'</span>] = monthly_sales[<span class="hljs-string">'YearMonth'</span>].<span class="hljs-built_in">astype</span>(str)
    
    colors = plt.cm.<span class="hljs-built_in">Blues</span>(np.<span class="hljs-built_in">linspace</span>(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.8</span>, <span class="hljs-built_in">len</span>(monthly_sales)))
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">bar</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(monthly_sales)), monthly_sales[<span class="hljs-string">'Sales'</span>], color=colors, alpha=<span class="hljs-number">0.8</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'月度平均销售额'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'年月'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'平均销售额'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_xticks</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(monthly_sales)))
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_xticklabels</span>(monthly_sales[<span class="hljs-string">'YearMonth'</span>], rotation=<span class="hljs-number">45</span>, fontsize=<span class="hljs-number">9</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'y'</span>)
    
    # <span class="hljs-number">3</span>. 星期几的平均销售额
    day_names = [<span class="hljs-string">'周一'</span>, <span class="hljs-string">'周二'</span>, <span class="hljs-string">'周三'</span>, <span class="hljs-string">'周四'</span>, <span class="hljs-string">'周五'</span>, <span class="hljs-string">'周六'</span>, <span class="hljs-string">'周日'</span>]
    sales_by_dow = train_df.<span class="hljs-built_in">groupby</span>(<span class="hljs-string">'DayOfWeek'</span>)[<span class="hljs-string">'Sales'</span>].<span class="hljs-built_in">mean</span>().<span class="hljs-built_in">reset_index</span>()
    
    colors_dow = plt.cm.<span class="hljs-built_in">Greens</span>(np.<span class="hljs-built_in">linspace</span>(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">7</span>))
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">bar</span>(sales_by_dow[<span class="hljs-string">'DayOfWeek'</span>], sales_by_dow[<span class="hljs-string">'Sales'</span>], color=colors_dow, alpha=<span class="hljs-number">0.8</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'星期几平均销售额'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'星期几'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'平均销售额'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_xticks</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_xticklabels</span>(day_names, fontsize=<span class="hljs-number">10</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'y'</span>)
    
    # 添加数值标签
    for i, sales in <span class="hljs-built_in">enumerate</span>(sales_by_dow[<span class="hljs-string">'Sales'</span>]):
        axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">text</span>(i+<span class="hljs-number">1</span>, sales + <span class="hljs-number">50</span>, f<span class="hljs-string">'{sales:.0f}'</span>, ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>, fontsize=<span class="hljs-number">9</span>)
    
    # <span class="hljs-number">4</span>. 月度销售额箱线图
    monthly_sales_box = []
    month_labels = []
    
    for month in <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">13</span>):
        month_data = train_df[train_df[<span class="hljs-string">'Date'</span>].dt.month == month][<span class="hljs-string">'Sales'</span>]
        if <span class="hljs-built_in">len</span>(month_data) &gt; <span class="hljs-number">0</span>:
            monthly_sales_box.<span class="hljs-built_in">append</span>(month_data.values)
            month_labels.<span class="hljs-built_in">append</span>(f<span class="hljs-string">'{month}月'</span>)
    
    box = axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">boxplot</span>(monthly_sales_box, labels=month_labels, patch_artist=True)
    colors_month = plt.cm.<span class="hljs-built_in">Oranges</span>(np.<span class="hljs-built_in">linspace</span>(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">12</span>))
    
    for patch, color in <span class="hljs-built_in">zip</span>(box[<span class="hljs-string">'boxes'</span>], colors_month):
        patch.<span class="hljs-built_in">set_facecolor</span>(color)
        patch.<span class="hljs-built_in">set_alpha</span>(<span class="hljs-number">0.7</span>)
    
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'月度销售额分布（箱线图）'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'月份'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'销售额'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'y'</span>)
    
    plt.<span class="hljs-built_in">suptitle</span>(<span class="hljs-string">'📊 时间序列分析'</span>, fontsize=<span class="hljs-number">16</span>, fontweight=<span class="hljs-string">'bold'</span>, y=<span class="hljs-number">1.02</span>)
    plt.<span class="hljs-built_in">tight_layout</span>()
    plt.<span class="hljs-built_in">show</span>()
    
    # 打印季节性分析
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📊 季节性分析:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"月度平均销售额排名:"</span>)
    monthly_sales_sorted = monthly_sales.<span class="hljs-built_in">sort_values</span>(<span class="hljs-string">'Sales'</span>, ascending=False)
    for i, row in monthly_sales_sorted.<span class="hljs-built_in">iterrows</span>():
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  {row['YearMonth']}: {row['Sales']:.0f}"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n星期几平均销售额排名:"</span>)
    sales_by_dow_sorted = sales_by_dow.<span class="hljs-built_in">sort_values</span>(<span class="hljs-string">'Sales'</span>, ascending=False)
    for i, row in sales_by_dow_sorted.<span class="hljs-built_in">iterrows</span>():
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  {day_names[int(row['DayOfWeek'])-1]}: {row['Sales']:.0f}"</span>)
    
    # 计算增长率
    if <span class="hljs-built_in">len</span>(monthly_sales) &gt;= <span class="hljs-number">2</span>:
        latest_month = monthly_sales.iloc[-<span class="hljs-number">1</span>][<span class="hljs-string">'Sales'</span>]
        prev_month = monthly_sales.iloc[-<span class="hljs-number">2</span>][<span class="hljs-string">'Sales'</span>]
        if prev_month &gt; <span class="hljs-number">0</span>:
            growth_rate = (latest_month - prev_month) / prev_month * <span class="hljs-number">100</span>
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">"\n📈 月度增长率: {growth_rate:.2f}%"</span>)
    
    return daily_sales, monthly_sales, sales_by_dow

# 执行时间序列分析
daily_sales, monthly_sales, sales_by_dow = <span class="hljs-built_in">analyze_time_series</span>(train_df)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93a60c3592fb40d593aeb54c6228fd9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=jp5mEe4RZ2EPg5dcPG%2F2X%2BE3vOM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f0a37a544674d00a6406d14cc434700~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=vSpVfcODufONXctr8szJI%2Bi7snw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-13">2.2.4 门店特征分析</h4>
<pre><code class="hljs language-scss" lang="scss">def <span class="hljs-built_in">analyze_store_features</span>(train_df, store_df):
    <span class="hljs-string">""</span><span class="hljs-string">"
    分析门店特征
    "</span><span class="hljs-string">""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🏪 门店特征分析"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    # 门店类型分布
    store_type_dist = store_df[<span class="hljs-string">'StoreType'</span>].<span class="hljs-built_in">value_counts</span>()
    assortment_dist = store_df[<span class="hljs-string">'Assortment'</span>].<span class="hljs-built_in">value_counts</span>()
    
    # 创建门店特征可视化
    fig, axes = plt.<span class="hljs-built_in">subplots</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">10</span>))
    
    # <span class="hljs-number">1</span>. 门店类型分布
    colors_type = [<span class="hljs-string">'#3498db'</span>, <span class="hljs-string">'#2ecc71'</span>, <span class="hljs-string">'#e74c3c'</span>, <span class="hljs-string">'#f39c12'</span>]
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">bar</span>(store_type_dist.index, store_type_dist.values, color=colors_type, alpha=<span class="hljs-number">0.8</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'门店类型分布'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'门店类型'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'门店数量'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'y'</span>)
    
    # 添加数值标签
    for i, count in <span class="hljs-built_in">enumerate</span>(store_type_dist.values):
        axes[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">text</span>(i, count + <span class="hljs-number">10</span>, <span class="hljs-built_in">str</span>(count), ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>, fontsize=<span class="hljs-number">10</span>)
    
    # <span class="hljs-number">2</span>. 商品种类分布
    colors_assort = [<span class="hljs-string">'#9b59b6'</span>, <span class="hljs-string">'#1abc9c'</span>, <span class="hljs-string">'#34495e'</span>]
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">bar</span>(assortment_dist.index, assortment_dist.values, color=colors_assort, alpha=<span class="hljs-number">0.8</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'商品种类分布'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'商品种类'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'门店数量'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'y'</span>)
    
    # 添加数值标签
    for i, count in <span class="hljs-built_in">enumerate</span>(assortment_dist.values):
        axes[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">text</span>(i, count + <span class="hljs-number">10</span>, <span class="hljs-built_in">str</span>(count), ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>, fontsize=<span class="hljs-number">10</span>)
    
    # <span class="hljs-number">3</span>. 竞争对手距离分布
    valid_distances = store_df[<span class="hljs-string">'CompetitionDistance'</span>].<span class="hljs-built_in">dropna</span>()
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">hist</span>(valid_distances, bins=<span class="hljs-number">50</span>, color=<span class="hljs-string">'#e67e22'</span>, alpha=<span class="hljs-number">0.7</span>, edgecolor=<span class="hljs-string">'black'</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'竞争对手距离分布'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'距离（米）'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'门店数量'</span>, fontsize=<span class="hljs-number">12</span>)
    axes[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>)
    
    # <span class="hljs-number">4</span>. 促销活动分析
    promo2_dist = store_df[<span class="hljs-string">'Promo2'</span>].<span class="hljs-built_in">value_counts</span>()
    colors_promo = [<span class="hljs-string">'#95a5a6'</span>, <span class="hljs-string">'#27ae60'</span>]
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">pie</span>(promo2_dist.values, labels=[<span class="hljs-string">'无促销'</span>, <span class="hljs-string">'有促销'</span>], colors=colors_promo,
                  autopct=<span class="hljs-string">'%1.1f%%'</span>, startangle=<span class="hljs-number">90</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'Promo2促销活动分布'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    
    # <span class="hljs-number">5</span>. 门店销售额排名
    store_sales = train_df.<span class="hljs-built_in">groupby</span>(<span class="hljs-string">'Store'</span>)[<span class="hljs-string">'Sales'</span>].<span class="hljs-built_in">mean</span>().<span class="hljs-built_in">sort_values</span>(ascending=False).<span class="hljs-built_in">head</span>(<span class="hljs-number">20</span>)
    colors_store = plt.cm.<span class="hljs-built_in">viridis</span>(np.<span class="hljs-built_in">linspace</span>(<span class="hljs-number">0.4</span>, <span class="hljs-number">0.8</span>, <span class="hljs-built_in">len</span>(store_sales)))
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">barh</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(store_sales)), store_sales.values, color=colors_store, alpha=<span class="hljs-number">0.8</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'门店平均销售额Top20'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'平均销售额'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'门店ID'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_yticks</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(store_sales)))
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">set_yticklabels</span>(store_sales.index, fontsize=<span class="hljs-number">9</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">invert_yaxis</span>()
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'x'</span>)
    
    # <span class="hljs-number">6</span>. 门店类型与销售额的关系
    store_type_sales = train_df.<span class="hljs-built_in">groupby</span>(<span class="hljs-string">'StoreType'</span>)[<span class="hljs-string">'Sales'</span>].<span class="hljs-built_in">mean</span>().<span class="hljs-built_in">sort_values</span>(ascending=False)
    colors_type_sales = plt.cm.<span class="hljs-built_in">coolwarm</span>(np.<span class="hljs-built_in">linspace</span>(<span class="hljs-number">0.2</span>, <span class="hljs-number">0.8</span>, <span class="hljs-built_in">len</span>(store_type_sales)))
    bars = axes[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">bar</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(store_type_sales)), store_type_sales.values, 
                         color=colors_type_sales, alpha=<span class="hljs-number">0.8</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'门店类型平均销售额'</span>, fontsize=<span class="hljs-number">12</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'门店类型'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'平均销售额'</span>, fontsize=<span class="hljs-number">11</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">set_xticks</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(store_type_sales)))
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">set_xticklabels</span>(store_type_sales.index, fontsize=<span class="hljs-number">10</span>)
    axes[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'y'</span>)
    
    # 添加数值标签
    for i, sales in <span class="hljs-built_in">enumerate</span>(store_type_sales.values):
        axes[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>].<span class="hljs-built_in">text</span>(i, sales + <span class="hljs-number">100</span>, f<span class="hljs-string">'{sales:.0f}'</span>, ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>, fontsize=<span class="hljs-number">10</span>)
    
    plt.<span class="hljs-built_in">suptitle</span>(<span class="hljs-string">'🏪 门店特征分析'</span>, fontsize=<span class="hljs-number">16</span>, fontweight=<span class="hljs-string">'bold'</span>, y=<span class="hljs-number">1.02</span>)
    plt.<span class="hljs-built_in">tight_layout</span>()
    plt.<span class="hljs-built_in">show</span>()
    
    # 打印门店特征统计
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📊 门店特征统计:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"门店总数: {len(store_df)}"</span>)
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"有竞争对手距离记录的门店: {store_df['CompetitionDistance'].notna().sum()}"</span>)
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"参与Promo2促销的门店: {promo2_dist.get(1, 0)}"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n门店类型销售额对比:"</span>)
    for store_type, avg_sales in store_type_sales.<span class="hljs-built_in">items</span>():
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  {store_type}型门店: {avg_sales:.0f}"</span>)
    
    # 竞争对手距离统计
    if <span class="hljs-built_in">len</span>(valid_distances) &gt; <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"\n竞争对手距离统计:"</span>)
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  平均距离: {valid_distances.mean():.0f}米"</span>)
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  中位数距离: {valid_distances.median():.0f}米"</span>)
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  最小距离: {valid_distances.min():.0f}米"</span>)
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  最大距离: {valid_distances.max():.0f}米"</span>)
    
    return store_type_dist, assortment_dist, store_sales

# 执行门店特征分析
store_type_dist, assortment_dist, store_sales = <span class="hljs-built_in">analyze_store_features</span>(train_df, store)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e14adcfec0c849668f9ff45b015be116~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=SCLcIo2zF8kFk5gOSEoEekyscww%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7417260f83774290ae36c6a39ccb9071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=2UdWjeSkF2BljZrssZ%2BqgmAyM7I%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14">2.2.5 相关性分析</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_correlations</span>(<span class="hljs-params">train_df</span>):
    <span class="hljs-string">"""
    相关性分析
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🔗 特征相关性分析"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    <span class="hljs-comment"># 选择数值特征</span>
    numeric_features = [<span class="hljs-string">'Sales'</span>, <span class="hljs-string">'Customers'</span>, <span class="hljs-string">'Open'</span>, <span class="hljs-string">'Promo'</span>, <span class="hljs-string">'DayOfWeek'</span>, 
                       <span class="hljs-string">'SchoolHoliday'</span>, <span class="hljs-string">'CompetitionDistance'</span>]
    
    <span class="hljs-comment"># 创建新的数值特征</span>
    train_df[<span class="hljs-string">'Year'</span>] = train_df[<span class="hljs-string">'Date'</span>].dt.year
    train_df[<span class="hljs-string">'Month'</span>] = train_df[<span class="hljs-string">'Date'</span>].dt.month
    train_df[<span class="hljs-string">'Day'</span>] = train_df[<span class="hljs-string">'Date'</span>].dt.day
    
    <span class="hljs-comment"># 添加门店类型和商品种类的编码</span>
    le = LabelEncoder()
    train_df[<span class="hljs-string">'StoreType_encoded'</span>] = le.fit_transform(train_df[<span class="hljs-string">'StoreType'</span>].astype(<span class="hljs-built_in">str</span>))
    train_df[<span class="hljs-string">'Assortment_encoded'</span>] = le.fit_transform(train_df[<span class="hljs-string">'Assortment'</span>].astype(<span class="hljs-built_in">str</span>))
    
    <span class="hljs-comment"># 扩展数值特征列表</span>
    extended_features = numeric_features + [<span class="hljs-string">'Year'</span>, <span class="hljs-string">'Month'</span>, <span class="hljs-string">'Day'</span>, 
                                          <span class="hljs-string">'StoreType_encoded'</span>, <span class="hljs-string">'Assortment_encoded'</span>]
    
    <span class="hljs-comment"># 计算相关系数矩阵</span>
    correlation_matrix = train_df[extended_features].corr()
    
    <span class="hljs-comment"># 可视化相关系数矩阵</span>
    fig, ax = plt.subplots(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">10</span>))
    
    <span class="hljs-comment"># 创建热力图</span>
    im = ax.imshow(correlation_matrix.values, cmap=<span class="hljs-string">'coolwarm'</span>, aspect=<span class="hljs-string">'auto'</span>)
    
    <span class="hljs-comment"># 设置坐标轴</span>
    ax.set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(correlation_matrix.columns)))
    ax.set_yticks(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(correlation_matrix.columns)))
    ax.set_xticklabels(correlation_matrix.columns, rotation=<span class="hljs-number">45</span>, ha=<span class="hljs-string">'right'</span>, fontsize=<span class="hljs-number">10</span>)
    ax.set_yticklabels(correlation_matrix.columns, fontsize=<span class="hljs-number">10</span>)
    
    <span class="hljs-comment"># 添加颜色条</span>
    plt.colorbar(im, ax=ax)
    
    <span class="hljs-comment"># 添加相关系数值</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(correlation_matrix.columns)):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(correlation_matrix.columns)):
            text = ax.text(j, i, <span class="hljs-string">f'<span class="hljs-subst">{correlation_matrix.iloc[i, j]:<span class="hljs-number">.2</span>f}</span>'</span>,
                          ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'center'</span>, color=<span class="hljs-string">'white'</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(correlation_matrix.iloc[i, j]) &gt; <span class="hljs-number">0.5</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'black'</span>,
                          fontsize=<span class="hljs-number">9</span> <span class="hljs-keyword">if</span> i != j <span class="hljs-keyword">else</span> <span class="hljs-number">10</span>, fontweight=<span class="hljs-string">'bold'</span> <span class="hljs-keyword">if</span> i == j <span class="hljs-keyword">else</span> <span class="hljs-string">'normal'</span>)
    
    ax.set_title(<span class="hljs-string">'特征相关性热力图'</span>, fontsize=<span class="hljs-number">16</span>, fontweight=<span class="hljs-string">'bold'</span>, pad=<span class="hljs-number">20</span>)
    plt.tight_layout()
    plt.show()
    
    <span class="hljs-comment"># 分析与销售额的相关性</span>
    sales_corr = correlation_matrix[<span class="hljs-string">'Sales'</span>].sort_values(ascending=<span class="hljs-literal">False</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🎯 与销售额相关性最高的特征:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'特征'</span>:&lt;<span class="hljs-number">20</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'相关系数'</span>:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'关系类型'</span>:&lt;<span class="hljs-number">15</span>}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
    
    <span class="hljs-keyword">for</span> feature, corr_value <span class="hljs-keyword">in</span> sales_corr.items():
        <span class="hljs-keyword">if</span> feature == <span class="hljs-string">'Sales'</span>:
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-keyword">if</span> corr_value &gt; <span class="hljs-number">0.3</span>:
            relation = <span class="hljs-string">"强正相关"</span>
            symbol = <span class="hljs-string">"↑↑"</span>
        <span class="hljs-keyword">elif</span> corr_value &gt; <span class="hljs-number">0.1</span>:
            relation = <span class="hljs-string">"正相关"</span>
            symbol = <span class="hljs-string">"↑"</span>
        <span class="hljs-keyword">elif</span> corr_value &lt; -<span class="hljs-number">0.3</span>:
            relation = <span class="hljs-string">"强负相关"</span>
            symbol = <span class="hljs-string">"↓↓"</span>
        <span class="hljs-keyword">elif</span> corr_value &lt; -<span class="hljs-number">0.1</span>:
            relation = <span class="hljs-string">"负相关"</span>
            symbol = <span class="hljs-string">"↓"</span>
        <span class="hljs-keyword">else</span>:
            relation = <span class="hljs-string">"弱相关"</span>
            symbol = <span class="hljs-string">"→"</span>
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{feature:&lt;<span class="hljs-number">20</span>}</span> <span class="hljs-subst">{corr_value:&lt;<span class="hljs-number">10.4</span>f}</span> <span class="hljs-subst">{relation:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{symbol}</span>"</span>)
    
    <span class="hljs-comment"># 关键发现</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🔍 关键发现:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 顾客数量与销售额高度相关（预期之内）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 促销活动对销售额有积极影响"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 竞争对手距离与销售额相关性较弱"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 门店类型和商品种类与销售额有一定相关性"</span>)
    
    <span class="hljs-keyword">return</span> correlation_matrix, sales_corr

<span class="hljs-comment"># 执行相关性分析</span>
correlation_matrix, sales_corr = analyze_correlations(train_df)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71380a9b0cee45769d96f9fd37ddd122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=6IH2BdIkWqXkUovutzP%2BS7SWYRY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57b51c0a843a4f138e58a0da7d0f34c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=dfTyWGDuTxnevRxXkRQocA6%2FLHM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">2.3 特征工程</h3>
<h4 data-id="heading-16">2.3.1 时间特征工程</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_time_features</span>(<span class="hljs-params">df</span>):
    <span class="hljs-string">"""
    创建时间相关特征
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n⏰ 创建时间特征..."</span>)
    
    <span class="hljs-comment"># 确保日期列是datetime类型</span>
    df[<span class="hljs-string">'Date'</span>] = pd.to_datetime(df[<span class="hljs-string">'Date'</span>])
    
    <span class="hljs-comment"># 基本时间特征</span>
    df[<span class="hljs-string">'Year'</span>] = df[<span class="hljs-string">'Date'</span>].dt.year                                <span class="hljs-comment"># 年</span>
    df[<span class="hljs-string">'Month'</span>] = df[<span class="hljs-string">'Date'</span>].dt.month                              <span class="hljs-comment"># 月</span>
    df[<span class="hljs-string">'Day'</span>] = df[<span class="hljs-string">'Date'</span>].dt.day                                  <span class="hljs-comment"># 日</span>
    df[<span class="hljs-string">'WeekOfYear'</span>] = df[<span class="hljs-string">'Date'</span>].dt.isocalendar().week            <span class="hljs-comment"># 一年中的第几周</span>
    df[<span class="hljs-string">'DayOfYear'</span>] = df[<span class="hljs-string">'Date'</span>].dt.dayofyear                      <span class="hljs-comment"># 一年中的第几天</span>
    
    <span class="hljs-comment"># 星期特征</span>
    df[<span class="hljs-string">'DayOfWeek'</span>] = df[<span class="hljs-string">'Date'</span>].dt.dayofweek                      <span class="hljs-comment"># 星期几</span>
    df[<span class="hljs-string">'IsWeekend'</span>] = (df[<span class="hljs-string">'DayOfWeek'</span>] &gt;= <span class="hljs-number">5</span>).astype(<span class="hljs-built_in">int</span>)           <span class="hljs-comment"># 是否是周末</span>
    
    <span class="hljs-comment"># 季度特征</span>
    df[<span class="hljs-string">'Quarter'</span>] = df[<span class="hljs-string">'Date'</span>].dt.quarter                          <span class="hljs-comment"># 那一个季度</span>
    
    <span class="hljs-comment"># 月份特征</span>
    df[<span class="hljs-string">'IsMonthStart'</span>] = df[<span class="hljs-string">'Date'</span>].dt.is_month_start.astype(<span class="hljs-built_in">int</span>)  <span class="hljs-comment"># 是否为当月起始日期</span>
    df[<span class="hljs-string">'IsMonthEnd'</span>] = df[<span class="hljs-string">'Date'</span>].dt.is_month_end.astype(<span class="hljs-built_in">int</span>)      <span class="hljs-comment"># 是否为当月接收日期</span>
    
    <span class="hljs-comment"># 季节性特征（基于月份）</span>
    seasons = {
        <span class="hljs-number">12</span>: <span class="hljs-string">'Winter'</span>, <span class="hljs-number">1</span>: <span class="hljs-string">'Winter'</span>, <span class="hljs-number">2</span>: <span class="hljs-string">'Winter'</span>,                    <span class="hljs-comment"># 冬季</span>
        <span class="hljs-number">3</span>: <span class="hljs-string">'Spring'</span>, <span class="hljs-number">4</span>: <span class="hljs-string">'Spring'</span>, <span class="hljs-number">5</span>: <span class="hljs-string">'Spring'</span>,                     <span class="hljs-comment"># 春季</span>
        <span class="hljs-number">6</span>: <span class="hljs-string">'Summer'</span>, <span class="hljs-number">7</span>: <span class="hljs-string">'Summer'</span>, <span class="hljs-number">8</span>: <span class="hljs-string">'Summer'</span>,                     <span class="hljs-comment"># 夏季</span>
        <span class="hljs-number">9</span>: <span class="hljs-string">'Autumn'</span>, <span class="hljs-number">10</span>: <span class="hljs-string">'Autumn'</span>, <span class="hljs-number">11</span>: <span class="hljs-string">'Autumn'</span>                    <span class="hljs-comment"># 秋季</span>
    }
    
    df[<span class="hljs-string">'Season'</span>] = df[<span class="hljs-string">'Month'</span>].<span class="hljs-built_in">map</span>(seasons)                        <span class="hljs-comment"># 月份进行季度编码        </span>
    
    <span class="hljs-comment"># 编码季节性特征</span>
    le = LabelEncoder()
    df[<span class="hljs-string">'Season_encoded'</span>] = le.fit_transform(df[<span class="hljs-string">'Season'</span>])          <span class="hljs-comment"># 对季度进行Label编码</span>
    
    <span class="hljs-comment"># 节假日特征</span>
    df[<span class="hljs-string">'IsHoliday'</span>] = (df[<span class="hljs-string">'StateHoliday'</span>] != <span class="hljs-string">'0'</span>).astype(<span class="hljs-built_in">int</span>)      <span class="hljs-comment"># 是否为节假日</span>
    
    <span class="hljs-comment"># 促销周期特征</span>
    df[<span class="hljs-string">'IsPromoMonth'</span>] = ((df[<span class="hljs-string">'Month'</span>] % <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>).astype(<span class="hljs-built_in">int</span>)      <span class="hljs-comment"># 促销周期特征</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 创建了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>([col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">'Date'</span>, <span class="hljs-string">'Season'</span>]])}</span> 个时间特征"</span>)
    
    <span class="hljs-keyword">return</span> df

<span class="hljs-comment"># 应用时间特征工程</span>
train_df = create_time_features(train_df)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df5330805bd84e3bb90cd56955f1b73a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=JCzDkT3JOoANE0vzFmnRD%2B2LF1w%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-17">2.3.2 滞后特征和滚动统计特征</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_lag_features</span>(<span class="hljs-params">df, store_id_col=<span class="hljs-string">'Store'</span>, date_col=<span class="hljs-string">'Date'</span>, target_col=<span class="hljs-string">'Sales'</span>, lags=[<span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">14</span>, <span class="hljs-number">30</span>]</span>):
    <span class="hljs-string">"""
    创建滞后特征和滚动统计特征
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📊 创建滞后特征和滚动统计特征..."</span>)
    
    <span class="hljs-comment"># 按门店和日期排序</span>
    df = df.sort_values([store_id_col, date_col])
    
    <span class="hljs-comment"># 创建滞后特征   把“同一家门店”的 Sales 列整体向下错位 lag 行</span>
    <span class="hljs-keyword">for</span> lag <span class="hljs-keyword">in</span> lags:
        df[<span class="hljs-string">f'<span class="hljs-subst">{target_col}</span>_lag_<span class="hljs-subst">{lag}</span>'</span>] = df.groupby(store_id_col)[target_col].shift(lag)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  创建滞后特征: <span class="hljs-subst">{target_col}</span>_lag_<span class="hljs-subst">{lag}</span>"</span>)
    
    <span class="hljs-comment"># 创建滚动统计特征</span>
    windows = [<span class="hljs-number">7</span>, <span class="hljs-number">14</span>, <span class="hljs-number">30</span>]
    <span class="hljs-comment">#在同一家门店内部，对 Sales 做“滚动平均”，然后把结果广播回原表的每一行——也就是构造 “最近 N 天的平均销售额” 这个特征列</span>
    <span class="hljs-keyword">for</span> window <span class="hljs-keyword">in</span> windows:
        <span class="hljs-comment"># 滚动平均值</span>
        df[<span class="hljs-string">f'<span class="hljs-subst">{target_col}</span>_rolling_mean_<span class="hljs-subst">{window}</span>'</span>] = df.groupby(store_id_col)[target_col].transform(
            <span class="hljs-keyword">lambda</span> x: x.rolling(window=window, min_periods=<span class="hljs-number">1</span>).mean()
        )
        
        <span class="hljs-comment"># 滚动标准差</span>
        df[<span class="hljs-string">f'<span class="hljs-subst">{target_col}</span>_rolling_std_<span class="hljs-subst">{window}</span>'</span>] = df.groupby(store_id_col)[target_col].transform(
            <span class="hljs-keyword">lambda</span> x: x.rolling(window=window, min_periods=<span class="hljs-number">1</span>).std()
        )
        
        <span class="hljs-comment"># 滚动最小值</span>
        df[<span class="hljs-string">f'<span class="hljs-subst">{target_col}</span>_rolling_min_<span class="hljs-subst">{window}</span>'</span>] = df.groupby(store_id_col)[target_col].transform(
            <span class="hljs-keyword">lambda</span> x: x.rolling(window=window, min_periods=<span class="hljs-number">1</span>).<span class="hljs-built_in">min</span>()
        )
        
        <span class="hljs-comment"># 滚动最大值</span>
        df[<span class="hljs-string">f'<span class="hljs-subst">{target_col}</span>_rolling_max_<span class="hljs-subst">{window}</span>'</span>] = df.groupby(store_id_col)[target_col].transform(
            <span class="hljs-keyword">lambda</span> x: x.rolling(window=window, min_periods=<span class="hljs-number">1</span>).<span class="hljs-built_in">max</span>()
        )
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  创建 <span class="hljs-subst">{window}</span> 天滚动统计特征"</span>)
    
    <span class="hljs-comment"># 创建特征之间的比率</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'Customers'</span> <span class="hljs-keyword">in</span> df.columns:
        df[<span class="hljs-string">'Sales_per_Customer'</span>] = df[<span class="hljs-string">'Sales'</span>] / (df[<span class="hljs-string">'Customers'</span>] + <span class="hljs-number">1</span>)  <span class="hljs-comment"># 避免除以0</span>
    
    <span class="hljs-comment"># 填充缺失值（由于滞后和滚动特征导致的）</span>
    lag_columns = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns <span class="hljs-keyword">if</span> <span class="hljs-string">'lag'</span> <span class="hljs-keyword">in</span> col <span class="hljs-keyword">or</span> <span class="hljs-string">'rolling'</span> <span class="hljs-keyword">in</span> col]
    
    <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> lag_columns:
        <span class="hljs-keyword">if</span> col <span class="hljs-keyword">in</span> df.columns:
            <span class="hljs-comment"># 使用前向填充</span>
            df[col] = df.groupby(store_id_col)[col].transform(<span class="hljs-keyword">lambda</span> x: x.fillna(method=<span class="hljs-string">'ffill'</span>))
            <span class="hljs-comment"># 对于仍然缺失的值，使用均值填充</span>
            df[col] = df[col].fillna(df[col].mean())
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 创建了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(lag_columns)}</span> 个滞后和滚动特征"</span>)
    
    <span class="hljs-keyword">return</span> df

<span class="hljs-comment"># 应用滞后特征工程</span>
train_df = create_lag_features(train_df)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f860ecea929c4cefb87c3b4b6fbf6702~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=Q6QNLCouUNbYEIr3o25MGZoFSeo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18">2.3.3 门店特征工程</h4>
<pre><code class="hljs language-ini" lang="ini">def create_store_features(df, store_df):
    """
    创建门店相关特征
    """
    print("\n🏪 创建门店特征...")
    
    <span class="hljs-comment"># 合并门店信息</span>
    <span class="hljs-attr">df</span> = df.merge(store_df, <span class="hljs-literal">on</span>=<span class="hljs-string">'Store'</span>, how=<span class="hljs-string">'left'</span>)
    
    <span class="hljs-comment"># 处理缺失值</span>
    df<span class="hljs-section">['CompetitionDistance']</span>.fillna(df<span class="hljs-section">['CompetitionDistance']</span>.median(), <span class="hljs-attr">inplace</span>=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># 竞争对手特征</span>
    df<span class="hljs-section">['CompetitionOpenSinceMonth']</span>.fillna(0, <span class="hljs-attr">inplace</span>=<span class="hljs-literal">True</span>)
    df<span class="hljs-section">['CompetitionOpenSinceYear']</span>.fillna(0, <span class="hljs-attr">inplace</span>=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># 计算竞争对手开业时长（月）</span>
    <span class="hljs-attr">current_year</span> = df[<span class="hljs-string">'Year'</span>].max()
    df<span class="hljs-section">['CompetitionOpenMonths']</span> = (current_year - df<span class="hljs-section">['CompetitionOpenSinceYear']</span>) * 12 + \
                                 (12 - df<span class="hljs-section">['CompetitionOpenSinceMonth']</span>)
    df<span class="hljs-section">['CompetitionOpenMonths']</span> = df<span class="hljs-section">['CompetitionOpenMonths']</span>.clip(<span class="hljs-attr">lower</span>=<span class="hljs-number">0</span>)
    
    <span class="hljs-comment"># 促销2特征</span>
    df<span class="hljs-section">['Promo2SinceWeek']</span>.fillna(0, <span class="hljs-attr">inplace</span>=<span class="hljs-literal">True</span>)
    df<span class="hljs-section">['Promo2SinceYear']</span>.fillna(0, <span class="hljs-attr">inplace</span>=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># 计算促销2持续时间（周）</span>
    df<span class="hljs-section">['Promo2DurationWeeks']</span> = ((df<span class="hljs-section">['Year']</span> - df<span class="hljs-section">['Promo2SinceYear']</span>) * 52 + 
                                (df<span class="hljs-section">['WeekOfYear']</span> - df<span class="hljs-section">['Promo2SinceWeek']</span>)).clip(<span class="hljs-attr">lower</span>=<span class="hljs-number">0</span>)
    
    <span class="hljs-comment"># 促销间隔特征</span>
    df<span class="hljs-section">['PromoInterval']</span>.fillna('', <span class="hljs-attr">inplace</span>=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># 检查当前月份是否在促销间隔中</span>
    <span class="hljs-attr">month_mapping</span> = {<span class="hljs-string">'Jan'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'Feb'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'Mar'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'Apr'</span>: <span class="hljs-number">4</span>, <span class="hljs-string">'May'</span>: <span class="hljs-number">5</span>, <span class="hljs-string">'Jun'</span>: <span class="hljs-number">6</span>,
                    'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12}
    
    def is_promo_month(promo_interval, current_month):
        if pd.isna(promo_interval) or <span class="hljs-attr">promo_interval</span> == <span class="hljs-string">''</span>:
            return 0
        <span class="hljs-attr">months</span> = [month_mapping.get(month.strip(), <span class="hljs-number">0</span>) for month in promo_interval.split(<span class="hljs-string">','</span>)]
        return 1 if current_month in months else 0
    
    df<span class="hljs-section">['IsPromo2Month']</span> = df.apply(lambda row: is_promo_month(row<span class="hljs-section">['PromoInterval']</span>, row<span class="hljs-section">['Month']</span>), <span class="hljs-attr">axis</span>=<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 门店类型编码</span>
    <span class="hljs-attr">store_type_mapping</span> = {<span class="hljs-string">'a'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'b'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'c'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'d'</span>: <span class="hljs-number">3</span>}
    df<span class="hljs-section">['StoreType_encoded']</span> = df<span class="hljs-section">['StoreType']</span>.map(store_type_mapping)
    
    <span class="hljs-comment"># 商品种类编码</span>
    <span class="hljs-attr">assortment_mapping</span> = {<span class="hljs-string">'a'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'b'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'c'</span>: <span class="hljs-number">2</span>}
    df<span class="hljs-section">['Assortment_encoded']</span> = df<span class="hljs-section">['Assortment']</span>.map(assortment_mapping)
    
    <span class="hljs-comment"># 门店分组特征（基于销售表现）</span>
    <span class="hljs-attr">store_sales</span> = df.groupby(<span class="hljs-string">'Store'</span>)[<span class="hljs-string">'Sales'</span>].mean().reset_index()
    store_sales<span class="hljs-section">['Store_Sales_Group']</span> = pd.qcut(store_sales<span class="hljs-section">['Sales']</span>, <span class="hljs-attr">q</span>=<span class="hljs-number">4</span>, labels=[<span class="hljs-string">'Low'</span>, <span class="hljs-string">'Medium'</span>, <span class="hljs-string">'High'</span>, <span class="hljs-string">'Very High'</span>])
    
    <span class="hljs-attr">df</span> = df.merge(store_sales[[<span class="hljs-string">'Store'</span>, <span class="hljs-string">'Store_Sales_Group'</span>]], <span class="hljs-literal">on</span>=<span class="hljs-string">'Store'</span>, how=<span class="hljs-string">'left'</span>)
    
    <span class="hljs-comment"># 编码门店销售组</span>
    df<span class="hljs-section">['Store_Sales_Group_encoded']</span> = df<span class="hljs-section">['Store_Sales_Group']</span>.map({'Low': 0, 'Medium': 1, 'High': 2, 'Very High': 3})
    
    print(f"✅ 创建了门店相关特征")
    
    return df

<span class="hljs-comment"># 应用门店特征工程</span>
<span class="hljs-attr">train_df</span> = create_store_features(train_df, store)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eff0e751bf2d4284bb0e841674f1b008~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=z0hCg05AIzaxNNYlu8vD7c3RABw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-19">2.3.4 交互特征</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_interaction_features</span>(<span class="hljs-params">df</span>):
    <span class="hljs-string">"""
    创建交互特征
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🤝 创建交互特征..."</span>)
    
    <span class="hljs-comment"># 促销与星期几的交互</span>
    df[<span class="hljs-string">'Promo_DayOfWeek'</span>] = df[<span class="hljs-string">'Promo'</span>] * df[<span class="hljs-string">'DayOfWeek'</span>]
    
    <span class="hljs-comment"># 促销与节假日的交互</span>
    df[<span class="hljs-string">'Promo_IsHoliday'</span>] = df[<span class="hljs-string">'Promo'</span>] * df[<span class="hljs-string">'IsHoliday'</span>]
    
    <span class="hljs-comment"># 促销与周末的交互</span>
    df[<span class="hljs-string">'Promo_IsWeekend'</span>] = df[<span class="hljs-string">'Promo'</span>] * df[<span class="hljs-string">'IsWeekend'</span>]
    
    <span class="hljs-comment"># 门店类型与促销的交互</span>
    df[<span class="hljs-string">'StoreType_Promo'</span>] = df[<span class="hljs-string">'StoreType_encoded'</span>] * df[<span class="hljs-string">'Promo'</span>]
    
    <span class="hljs-comment"># 商品种类与促销的交互</span>
    df[<span class="hljs-string">'Assortment_Promo'</span>] = df[<span class="hljs-string">'Assortment_encoded'</span>] * df[<span class="hljs-string">'Promo'</span>]
    
    <span class="hljs-comment"># 月份与促销的交互</span>
    df[<span class="hljs-string">'Month_Promo'</span>] = df[<span class="hljs-string">'Month'</span>] * df[<span class="hljs-string">'Promo'</span>]
    
    <span class="hljs-comment"># 竞争对手距离与促销的交互</span>
    df[<span class="hljs-string">'CompetitionDistance_Promo'</span>] = df[<span class="hljs-string">'CompetitionDistance'</span>] * df[<span class="hljs-string">'Promo'</span>]
    
    <span class="hljs-comment"># 门店销售组与促销的交互</span>
    df[<span class="hljs-string">'StoreSalesGroup_Promo'</span>] = df[<span class="hljs-string">'Store_Sales_Group_encoded'</span>] * df[<span class="hljs-string">'Promo'</span>]
    
    <span class="hljs-comment"># 季节性特征与促销的交互</span>
    df[<span class="hljs-string">'Season_Promo'</span>] = df[<span class="hljs-string">'Season_encoded'</span>] * df[<span class="hljs-string">'Promo'</span>]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 创建了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>([col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns <span class="hljs-keyword">if</span> <span class="hljs-string">'_'</span> <span class="hljs-keyword">in</span> col <span class="hljs-keyword">and</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">'Sales_lag'</span>, <span class="hljs-string">'Sales_rolling'</span>]])}</span> 个交互特征"</span>)
    
    <span class="hljs-keyword">return</span> df

<span class="hljs-comment"># 应用交互特征工程</span>
train_df = create_interaction_features(train_df)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🎉 特征工程完成!"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终特征数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_df.columns)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"特征列表:"</span>)
<span class="hljs-keyword">for</span> i, col <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_df.columns.tolist(), <span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i:3d}</span>. <span class="hljs-subst">{col}</span>"</span>)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ae2e2c599ee471e8734352ab956e324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=usfrZppWlv8MxcbrzwAvhRZxA4c%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-20">2.4 模型训练与评估</h3>
<h4 data-id="heading-21">2.4.1 数据准备</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_model_data</span>(<span class="hljs-params">df, test_size=<span class="hljs-number">0.2</span></span>):
    <span class="hljs-string">"""
    准备模型数据
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📊 准备模型数据..."</span>)
    
    <span class="hljs-comment"># 选择特征列（排除不需要的列）</span>
    exclude_columns = [<span class="hljs-string">'Date'</span>, <span class="hljs-string">'StateHoliday'</span>, <span class="hljs-string">'PromoInterval'</span>, <span class="hljs-string">'Season'</span>, <span class="hljs-string">'Store_Sales_Group'</span>]
    
    <span class="hljs-comment"># 自动识别数值特征</span>
    feature_columns = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> df.columns <span class="hljs-keyword">if</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> exclude_columns + [<span class="hljs-string">'Sales'</span>, <span class="hljs-string">'Customers'</span>]]
    
    <span class="hljs-comment"># 确保所有特征都是数值类型</span>
    <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> feature_columns:
        <span class="hljs-keyword">if</span> df[col].dtype == <span class="hljs-string">'object'</span>:
            le = LabelEncoder()
            df[col] = le.fit_transform(df[col].astype(<span class="hljs-built_in">str</span>))
    
    <span class="hljs-comment"># 处理缺失值</span>
    df[feature_columns] = df[feature_columns].fillna(<span class="hljs-number">0</span>)
    
    <span class="hljs-comment"># 定义特征和目标</span>
    X = df[feature_columns]
    y = df[<span class="hljs-string">'Sales'</span>]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"特征数量: <span class="hljs-subst">{X.shape[<span class="hljs-number">1</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"样本数量: <span class="hljs-subst">{X.shape[<span class="hljs-number">0</span>]}</span>"</span>)
    
    <span class="hljs-comment"># 按时间划分训练集和测试集</span>
    split_date = df[<span class="hljs-string">'Date'</span>].quantile(<span class="hljs-number">1</span> - test_size)
    
    X_train = X[df[<span class="hljs-string">'Date'</span>] &lt;= split_date]
    X_test = X[df[<span class="hljs-string">'Date'</span>] &gt; split_date]
    y_train = y[df[<span class="hljs-string">'Date'</span>] &lt;= split_date]
    y_test = y[df[<span class="hljs-string">'Date'</span>] &gt; split_date]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📅 数据划分:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集: <span class="hljs-subst">{X_train.shape[<span class="hljs-number">0</span>]:,}</span> 条记录 (<span class="hljs-subst">{X_train.shape[<span class="hljs-number">0</span>]/<span class="hljs-built_in">len</span>(df)*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试集: <span class="hljs-subst">{X_test.shape[<span class="hljs-number">0</span>]:,}</span> 条记录 (<span class="hljs-subst">{X_test.shape[<span class="hljs-number">0</span>]/<span class="hljs-built_in">len</span>(df)*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集时间范围: <span class="hljs-subst">{df[df[<span class="hljs-string">'Date'</span>] &lt;= split_date][<span class="hljs-string">'Date'</span>].<span class="hljs-built_in">min</span>()}</span> 到 <span class="hljs-subst">{df[df[<span class="hljs-string">'Date'</span>] &lt;= split_date][<span class="hljs-string">'Date'</span>].<span class="hljs-built_in">max</span>()}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试集时间范围: <span class="hljs-subst">{df[df[<span class="hljs-string">'Date'</span>] &gt; split_date][<span class="hljs-string">'Date'</span>].<span class="hljs-built_in">min</span>()}</span> 到 <span class="hljs-subst">{df[df[<span class="hljs-string">'Date'</span>] &gt; split_date][<span class="hljs-string">'Date'</span>].<span class="hljs-built_in">max</span>()}</span>"</span>)
    
    <span class="hljs-keyword">return</span> X_train, X_test, y_train, y_test, feature_columns

<span class="hljs-comment"># 准备模型数据</span>
X_train, X_test, y_train, y_test, feature_columns = prepare_model_data(train_df)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a5a524c7d914b0192a20a49371c9699~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=qgQfLaVr%2FyR%2FchPxTq8470pEvnE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-22">2.4.2 XGBoost模型训练</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_xgboost_model</span>(<span class="hljs-params">X_train, y_train, X_test, y_test</span>):
    <span class="hljs-string">"""
    训练XGBoost模型
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🚀 训练XGBoost模型..."</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    
    <span class="hljs-comment"># 创建DMatrix</span>
    dtrain = xgb.DMatrix(X_train, label=y_train)
    dtest = xgb.DMatrix(X_test, label=y_test)
    
    <span class="hljs-comment"># 设置XGBoost参数</span>
    params = {
        <span class="hljs-string">'objective'</span>: <span class="hljs-string">'reg:squarederror'</span>,
        <span class="hljs-string">'eval_metric'</span>: <span class="hljs-string">'rmse'</span>,
        <span class="hljs-string">'eta'</span>: <span class="hljs-number">0.05</span>,           <span class="hljs-comment"># 学习率</span>
        <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">8</span>,        <span class="hljs-comment"># 树的最大深度</span>
        <span class="hljs-string">'min_child_weight'</span>: <span class="hljs-number">5</span>, <span class="hljs-comment"># 最小叶子节点样本权重和</span>
        <span class="hljs-string">'subsample'</span>: <span class="hljs-number">0.8</span>,      <span class="hljs-comment"># 训练样本采样比例</span>
        <span class="hljs-string">'colsample_bytree'</span>: <span class="hljs-number">0.8</span>, <span class="hljs-comment"># 特征采样比例</span>
        <span class="hljs-string">'alpha'</span>: <span class="hljs-number">0.1</span>,          <span class="hljs-comment"># L1正则化</span>
        <span class="hljs-string">'lambda'</span>: <span class="hljs-number">1.0</span>,         <span class="hljs-comment"># L2正则化</span>
        <span class="hljs-string">'seed'</span>: <span class="hljs-number">42</span>,
        <span class="hljs-string">'n_jobs'</span>: -<span class="hljs-number">1</span>
    }
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"模型参数:"</span>)
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> params.items():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)
    
    <span class="hljs-comment"># 训练模型</span>
    num_round = <span class="hljs-number">1000</span>
    watchlist = [(dtrain, <span class="hljs-string">'train'</span>), (dtest, <span class="hljs-string">'eval'</span>)]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n⏳ 开始训练，迭代次数: <span class="hljs-subst">{num_round}</span>"</span>)
    model = xgb.train(params, dtrain, num_round, watchlist, 
                      early_stopping_rounds=<span class="hljs-number">50</span>, verbose_eval=<span class="hljs-number">100</span>)
    
    <span class="hljs-comment"># 预测</span>
    y_pred = model.predict(dtest)
    
    <span class="hljs-comment"># 计算评估指标</span>
    rmse = np.sqrt(mean_squared_error(y_test, y_pred))
    mae = mean_absolute_error(y_test, y_pred)
    r2 = r2_score(y_test, y_pred)
    rmspe_val = rmspe(y_test.values, y_pred)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🎯 模型评估结果:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"RMSE (均方根误差): <span class="hljs-subst">{rmse:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"MAE (平均绝对误差): <span class="hljs-subst">{mae:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"R² Score (决定系数): <span class="hljs-subst">{r2:<span class="hljs-number">.4</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"RMSPE (均方根百分比误差): <span class="hljs-subst">{rmspe_val:<span class="hljs-number">.4</span>f}</span>"</span>)
    
    <span class="hljs-comment"># 特征重要性分析</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🔑 特征重要性分析 (Top 20):"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
    
    importance = model.get_score(importance_type=<span class="hljs-string">'weight'</span>)
    importance_df = pd.DataFrame({
        <span class="hljs-string">'feature'</span>: <span class="hljs-built_in">list</span>(importance.keys()),
        <span class="hljs-string">'importance'</span>: <span class="hljs-built_in">list</span>(importance.values())
    }).sort_values(<span class="hljs-string">'importance'</span>, ascending=<span class="hljs-literal">False</span>)
    
    <span class="hljs-keyword">for</span> i, row <span class="hljs-keyword">in</span> importance_df.head(<span class="hljs-number">20</span>).iterrows():
        feature_name = row[<span class="hljs-string">'feature'</span>]
        importance_val = row[<span class="hljs-string">'importance'</span>]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i+<span class="hljs-number">1</span>:2d}</span>. <span class="hljs-subst">{feature_name:&lt;<span class="hljs-number">30</span>}</span> <span class="hljs-subst">{importance_val:&gt;<span class="hljs-number">8</span>}</span>"</span>)
    
    <span class="hljs-keyword">return</span> model, y_pred, importance_df

<span class="hljs-comment"># 训练XGBoost模型</span>
xgb_model, xgb_pred, importance_df = train_xgboost_model(X_train, y_train, X_test, y_test)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44fb50f90f194544995ae7163bca5800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=kLA2kHpbW%2Fs0CCYQXN%2FF4PCx0pc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-23">2.4.3 LightGBM模型训练</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_lightgbm_model</span>(<span class="hljs-params">X_train, y_train, X_test, y_test</span>):
    <span class="hljs-string">"""
    训练LightGBM模型
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n💡 训练LightGBM模型..."</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    
    <span class="hljs-comment"># 创建数据集</span>
    train_data = lgb.Dataset(X_train, label=y_train)
    test_data = lgb.Dataset(X_test, label=y_test, reference=train_data)
    
    <span class="hljs-comment"># 设置LightGBM参数</span>
    params = {
        <span class="hljs-string">'objective'</span>: <span class="hljs-string">'regression'</span>,
        <span class="hljs-string">'metric'</span>: <span class="hljs-string">'rmse'</span>,
        <span class="hljs-string">'boosting_type'</span>: <span class="hljs-string">'gbdt'</span>,
        <span class="hljs-string">'num_leaves'</span>: <span class="hljs-number">31</span>,
        <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">0.05</span>,
        <span class="hljs-string">'feature_fraction'</span>: <span class="hljs-number">0.8</span>,
        <span class="hljs-string">'bagging_fraction'</span>: <span class="hljs-number">0.8</span>,
        <span class="hljs-string">'bagging_freq'</span>: <span class="hljs-number">5</span>,
        <span class="hljs-string">'verbose'</span>: -<span class="hljs-number">1</span>,
        <span class="hljs-string">'seed'</span>: <span class="hljs-number">42</span>,
        <span class="hljs-string">'num_threads'</span>: -<span class="hljs-number">1</span>
    }
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"模型参数:"</span>)
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> params.items():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)
    
    <span class="hljs-comment"># 训练模型</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n⏳ 开始训练..."</span>)
    lgb_model = lgb.train(params,
                         train_data,
                         valid_sets=[test_data],
                         num_boost_round=<span class="hljs-number">1000</span>,
                         early_stopping_rounds=<span class="hljs-number">50</span>,
                         verbose_eval=<span class="hljs-number">100</span>)
    
    <span class="hljs-comment"># 预测</span>
    lgb_pred = lgb_model.predict(X_test, num_iteration=lgb_model.best_iteration)
    
    <span class="hljs-comment"># 计算评估指标</span>
    rmse = np.sqrt(mean_squared_error(y_test, lgb_pred))
    mae = mean_absolute_error(y_test, lgb_pred)
    r2 = r2_score(y_test, lgb_pred)
    rmspe_val = rmspe(y_test.values, lgb_pred)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🎯 LightGBM模型评估结果:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"RMSE (均方根误差): <span class="hljs-subst">{rmse:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"MAE (平均绝对误差): <span class="hljs-subst">{mae:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"R² Score (决定系数): <span class="hljs-subst">{r2:<span class="hljs-number">.4</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"RMSPE (均方根百分比误差): <span class="hljs-subst">{rmspe_val:<span class="hljs-number">.4</span>f}</span>"</span>)
    
    <span class="hljs-comment"># 特征重要性分析</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🔑 LightGBM特征重要性分析 (Top 20):"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
    
    importance = lgb_model.feature_importance(importance_type=<span class="hljs-string">'gain'</span>)
    feature_names = X_train.columns.tolist()
    
    importance_df = pd.DataFrame({
        <span class="hljs-string">'feature'</span>: feature_names,
        <span class="hljs-string">'importance'</span>: importance
    }).sort_values(<span class="hljs-string">'importance'</span>, ascending=<span class="hljs-literal">False</span>)
    
    <span class="hljs-keyword">for</span> i, row <span class="hljs-keyword">in</span> importance_df.head(<span class="hljs-number">20</span>).iterrows():
        feature_name = row[<span class="hljs-string">'feature'</span>]
        importance_val = row[<span class="hljs-string">'importance'</span>]
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i+<span class="hljs-number">1</span>:2d}</span>. <span class="hljs-subst">{feature_name:&lt;<span class="hljs-number">30</span>}</span> <span class="hljs-subst">{importance_val:&gt;<span class="hljs-number">8.0</span>f}</span>"</span>)
    
    <span class="hljs-keyword">return</span> lgb_model, lgb_pred, importance_df

<span class="hljs-comment"># 训练LightGBM模型</span>
lgb_model, lgb_pred, lgb_importance_df = train_lightgbm_model(X_train, y_train, X_test, y_test)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3f59f14a23f4730ace15c0fa5b858bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=Co3o0a6ZR0YEoCu0TOZ068UpgW4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-24">2.4.4 模型集成</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ensemble_models</span>(<span class="hljs-params">predictions_list, weights=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    模型集成
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🤝 模型集成..."</span>)
    
    <span class="hljs-keyword">if</span> weights <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        weights = [<span class="hljs-number">1.0</span> / <span class="hljs-built_in">len</span>(predictions_list)] * <span class="hljs-built_in">len</span>(predictions_list)
    
    <span class="hljs-comment"># 加权平均</span>
    ensemble_pred = np.zeros_like(predictions_list[<span class="hljs-number">0</span>])
    <span class="hljs-keyword">for</span> pred, weight <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(predictions_list, weights):
        ensemble_pred += pred * weight
    
    <span class="hljs-keyword">return</span> ensemble_pred

<span class="hljs-comment"># 集成XGBoost和LightGBM的预测结果</span>
ensemble_pred = ensemble_models([xgb_pred, lgb_pred], weights=[<span class="hljs-number">0.6</span>, <span class="hljs-number">0.4</span>])

<span class="hljs-comment"># 评估集成模型</span>
rmse = np.sqrt(mean_squared_error(y_test, ensemble_pred))
mae = mean_absolute_error(y_test, ensemble_pred)
r2 = r2_score(y_test, ensemble_pred)
rmspe_val = rmspe(y_test.values, ensemble_pred)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🎯 集成模型评估结果:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"RMSE (均方根误差): <span class="hljs-subst">{rmse:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"MAE (平均绝对误差): <span class="hljs-subst">{mae:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"R² Score (决定系数): <span class="hljs-subst">{r2:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"RMSPE (均方根百分比误差): <span class="hljs-subst">{rmspe_val:<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 模型性能对比</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📊 模型性能对比:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'模型'</span>:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'RMSE'</span>:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'MAE'</span>:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'R²'</span>:&lt;<span class="hljs-number">10</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'RMSPE'</span>:&lt;<span class="hljs-number">10</span>}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'XGBoost'</span>:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{np.sqrt(mean_squared_error(y_test, xgb_pred)):&lt;<span class="hljs-number">10.2</span>f}</span> "</span>
      <span class="hljs-string">f"<span class="hljs-subst">{mean_absolute_error(y_test, xgb_pred):&lt;<span class="hljs-number">10.2</span>f}</span> "</span>
      <span class="hljs-string">f"<span class="hljs-subst">{r2_score(y_test, xgb_pred):&lt;<span class="hljs-number">10.4</span>f}</span> "</span>
      <span class="hljs-string">f"<span class="hljs-subst">{rmspe(y_test.values, xgb_pred):&lt;<span class="hljs-number">10.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'LightGBM'</span>:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{np.sqrt(mean_squared_error(y_test, lgb_pred)):&lt;<span class="hljs-number">10.2</span>f}</span> "</span>
      <span class="hljs-string">f"<span class="hljs-subst">{mean_absolute_error(y_test, lgb_pred):&lt;<span class="hljs-number">10.2</span>f}</span> "</span>
      <span class="hljs-string">f"<span class="hljs-subst">{r2_score(y_test, lgb_pred):&lt;<span class="hljs-number">10.4</span>f}</span> "</span>
      <span class="hljs-string">f"<span class="hljs-subst">{rmspe(y_test.values, lgb_pred):&lt;<span class="hljs-number">10.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'集成模型'</span>:&lt;<span class="hljs-number">15</span>}</span> <span class="hljs-subst">{rmse:&lt;<span class="hljs-number">10.2</span>f}</span> <span class="hljs-subst">{mae:&lt;<span class="hljs-number">10.2</span>f}</span> <span class="hljs-subst">{r2:&lt;<span class="hljs-number">10.4</span>f}</span> <span class="hljs-subst">{rmspe_val:&lt;<span class="hljs-number">10.4</span>f}</span>"</span>)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a267d94eceb34e6ba0796b64f0c5de74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=Mn37EWojdo5HwngTetl%2BA7KKLKc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-25">2.4.5 模型性能可视化</h4>
<pre><code class="hljs language-ini" lang="ini">def visualize_model_performance(y_true, y_pred, <span class="hljs-attr">model_name</span>=<span class="hljs-string">"模型"</span>):
    """
    可视化模型性能
    """
    print(f"\n📈 {model_name}性能可视化")
    
    fig, <span class="hljs-attr">axes</span> = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">10</span>))
    
    <span class="hljs-comment"># 1. 预测值 vs 真实值散点图</span>
    axes<span class="hljs-section">[0, 0]</span>.scatter(y_true, y_pred, <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.3</span>, color=<span class="hljs-string">'#3498db'</span>)
    axes<span class="hljs-section">[0, 0]</span>.plot(<span class="hljs-section">[y_true.min(), y_true.max()]</span>, <span class="hljs-section">[y_true.min(), y_true.max()]</span>, 
                   'r--', <span class="hljs-attr">linewidth</span>=<span class="hljs-number">2</span>, label=<span class="hljs-string">'完美预测线'</span>)
    axes<span class="hljs-section">[0, 0]</span>.set_xlabel('真实销售额', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>)
    axes<span class="hljs-section">[0, 0]</span>.set_ylabel('预测销售额', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>)
    axes<span class="hljs-section">[0, 0]</span>.set_title(f'{model_name}预测结果散点图', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes<span class="hljs-section">[0, 0]</span>.legend(<span class="hljs-attr">fontsize</span>=<span class="hljs-number">10</span>)
    axes<span class="hljs-section">[0, 0]</span>.grid(True, <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.3</span>)
    
    <span class="hljs-comment"># 2. 残差分布</span>
    <span class="hljs-attr">residuals</span> = y_<span class="hljs-literal">true</span> - y_pred
    axes<span class="hljs-section">[0, 1]</span>.hist(residuals, <span class="hljs-attr">bins</span>=<span class="hljs-number">50</span>, color=<span class="hljs-string">'#e74c3c'</span>, alpha=<span class="hljs-number">0.7</span>, edgecolor=<span class="hljs-string">'black'</span>)
    axes<span class="hljs-section">[0, 1]</span>.axvline(<span class="hljs-attr">x</span>=<span class="hljs-number">0</span>, color=<span class="hljs-string">'blue'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">2</span>)
    axes<span class="hljs-section">[0, 1]</span>.set_xlabel('残差（真实值 - 预测值）', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>)
    axes<span class="hljs-section">[0, 1]</span>.set_ylabel('频数', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>)
    axes<span class="hljs-section">[0, 1]</span>.set_title('残差分布', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes<span class="hljs-section">[0, 1]</span>.grid(True, <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.3</span>)
    
    <span class="hljs-comment"># 3. 残差 vs 预测值</span>
    axes<span class="hljs-section">[1, 0]</span>.scatter(y_pred, residuals, <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.3</span>, color=<span class="hljs-string">'#2ecc71'</span>)
    axes<span class="hljs-section">[1, 0]</span>.axhline(<span class="hljs-attr">y</span>=<span class="hljs-number">0</span>, color=<span class="hljs-string">'red'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">2</span>)
    axes<span class="hljs-section">[1, 0]</span>.set_xlabel('预测销售额', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>)
    axes<span class="hljs-section">[1, 0]</span>.set_ylabel('残差', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>)
    axes<span class="hljs-section">[1, 0]</span>.set_title('残差 vs 预测值', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
    axes<span class="hljs-section">[1, 0]</span>.grid(True, <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.3</span>)
    
    <span class="hljs-comment"># 4. 时间序列预测（选取一个门店示例）</span>
    <span class="hljs-attr">sample_store</span> = X_test[<span class="hljs-string">'Store'</span>].iloc[<span class="hljs-number">0</span>]
    <span class="hljs-attr">store_mask</span> = X_test[<span class="hljs-string">'Store'</span>] == sample_store
    <span class="hljs-attr">sample_dates</span> = X_test[store_mask].index[:<span class="hljs-number">100</span>]
    
    if len(sample_dates) &gt; 0:
        axes<span class="hljs-section">[1, 1]</span>.plot(range(len(sample_dates)), y_true<span class="hljs-section">[store_mask]</span>.values<span class="hljs-section">[:100]</span>, 
                       'b-', <span class="hljs-attr">label</span>=<span class="hljs-string">'真实值'</span>, linewidth=<span class="hljs-number">2</span>)
        axes<span class="hljs-section">[1, 1]</span>.plot(range(len(sample_dates)), y_pred<span class="hljs-section">[store_mask]</span><span class="hljs-section">[:100]</span>, 
                       'r--', <span class="hljs-attr">label</span>=<span class="hljs-string">'预测值'</span>, linewidth=<span class="hljs-number">2</span>)
        axes<span class="hljs-section">[1, 1]</span>.set_xlabel('时间索引', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>)
        axes<span class="hljs-section">[1, 1]</span>.set_ylabel('销售额', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>)
        axes<span class="hljs-section">[1, 1]</span>.set_title(f'门店 {sample_store} 的销售预测', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
        axes<span class="hljs-section">[1, 1]</span>.legend(<span class="hljs-attr">fontsize</span>=<span class="hljs-number">10</span>)
        axes<span class="hljs-section">[1, 1]</span>.grid(True, <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.3</span>)
    
    plt.suptitle(f'🎯 {model_name}性能分析', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">16</span>, fontweight=<span class="hljs-string">'bold'</span>, y=<span class="hljs-number">1.02</span>)
    plt.tight_layout()
    plt.show()

<span class="hljs-comment"># 可视化XGBoost模型性能</span>
visualize_model_performance(y_test, xgb_pred, "XGBoost模型")

<span class="hljs-comment"># 可视化LightGBM模型性能</span>
visualize_model_performance(y_test, lgb_pred, "LightGBM模型")

<span class="hljs-comment"># 可视化集成模型性能</span>
visualize_model_performance(y_test, ensemble_pred, "集成模型")
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d575ec7b50334296b0566eb97685c5df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=yt8st0mzgTJgxHNEV%2B9Bir69Cmw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47bbb63661248afb814684e5953f30b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=on8LXYfGq1z8zUhy%2F7Fddo4qt%2Bg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/798340783d0a4a4b884ba4802ac46e12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=%2FkvBexcgtPB5ZcLtK1Ttw%2Bu7IZY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-26">2.5 总结与改进建议</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_summary_report</span>(<span class="hljs-params">X_train, y_train, X_test, y_test, model, predictions</span>):
    <span class="hljs-string">"""
    生成项目总结报告
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✨ 项目总结报告"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)
    
    <span class="hljs-comment"># 计算关键指标</span>
    rmse = np.sqrt(mean_squared_error(y_test, predictions))
    mae = mean_absolute_error(y_test, predictions)
    r2 = r2_score(y_test, predictions)
    rmspe_val = rmspe(y_test.values, predictions)
    
    <span class="hljs-comment"># 1. 性能总结</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📈 模型性能总结:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"RMSE (均方根误差): <span class="hljs-subst">{rmse:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"MAE (平均绝对误差): <span class="hljs-subst">{mae:<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"R² Score (决定系数): <span class="hljs-subst">{r2:<span class="hljs-number">.4</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"RMSPE (均方根百分比误差): <span class="hljs-subst">{rmspe_val:<span class="hljs-number">.4</span>f}</span>"</span>)
    
    <span class="hljs-comment"># 2. 数据总结</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n📊 数据总结:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总样本数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(X_train) + <span class="hljs-built_in">len</span>(X_test):,}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集样本: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(X_train):,}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试集样本: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(X_test):,}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"特征数量: <span class="hljs-subst">{X_train.shape[<span class="hljs-number">1</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"门店数量: <span class="hljs-subst">{train_df[<span class="hljs-string">'Store'</span>].nunique()}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"时间范围: <span class="hljs-subst">{train_df[<span class="hljs-string">'Date'</span>].<span class="hljs-built_in">min</span>()}</span> 到 <span class="hljs-subst">{train_df[<span class="hljs-string">'Date'</span>].<span class="hljs-built_in">max</span>()}</span>"</span>)
    
    <span class="hljs-comment"># 3. 特征工程总结</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🔧 特征工程总结:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
    feature_types = {
        <span class="hljs-string">'时间特征'</span>: [<span class="hljs-string">'Year'</span>, <span class="hljs-string">'Month'</span>, <span class="hljs-string">'Day'</span>, <span class="hljs-string">'DayOfWeek'</span>, <span class="hljs-string">'WeekOfYear'</span>, <span class="hljs-string">'Quarter'</span>, <span class="hljs-string">'Season'</span>],
        <span class="hljs-string">'滞后特征'</span>: [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> X_train.columns <span class="hljs-keyword">if</span> <span class="hljs-string">'lag'</span> <span class="hljs-keyword">in</span> col],
        <span class="hljs-string">'滚动特征'</span>: [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> X_train.columns <span class="hljs-keyword">if</span> <span class="hljs-string">'rolling'</span> <span class="hljs-keyword">in</span> col],
        <span class="hljs-string">'门店特征'</span>: [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> X_train.columns <span class="hljs-keyword">if</span> <span class="hljs-string">'Store'</span> <span class="hljs-keyword">in</span> col <span class="hljs-keyword">or</span> <span class="hljs-string">'Competition'</span> <span class="hljs-keyword">in</span> col <span class="hljs-keyword">or</span> <span class="hljs-string">'Promo2'</span> <span class="hljs-keyword">in</span> col],
        <span class="hljs-string">'交互特征'</span>: [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> X_train.columns <span class="hljs-keyword">if</span> <span class="hljs-string">'_'</span> <span class="hljs-keyword">in</span> col <span class="hljs-keyword">and</span> col <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">'Sales_lag'</span>, <span class="hljs-string">'Sales_rolling'</span>]]
    }
    
    <span class="hljs-keyword">for</span> feature_type, features <span class="hljs-keyword">in</span> feature_types.items():
        actual_features = [f <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> features <span class="hljs-keyword">if</span> f <span class="hljs-keyword">in</span> X_train.columns]
        <span class="hljs-keyword">if</span> actual_features:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{feature_type}</span>: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(actual_features)}</span> 个"</span>)
    
    <span class="hljs-comment"># 4. 改进建议</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n🚀 改进建议:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
    
    suggestions = [
        <span class="hljs-string">"1. 尝试更复杂的时间序列模型（如Prophet、ARIMA）"</span>,
        <span class="hljs-string">"2. 增加更多的外部特征（天气数据、经济指标）"</span>,
        <span class="hljs-string">"3. 使用深度学习模型（LSTM、GRU）"</span>,
        <span class="hljs-string">"4. 实施更精细的特征选择策略"</span>,
        <span class="hljs-string">"5. 尝试多模型堆叠（Stacking）"</span>,
        <span class="hljs-string">"6. 优化超参数（使用贝叶斯优化）"</span>,
        <span class="hljs-string">"7. 考虑门店之间的空间相关性"</span>,
        <span class="hljs-string">"8. 添加更长的历史窗口特征"</span>
    ]
    
    <span class="hljs-keyword">for</span> suggestion <span class="hljs-keyword">in</span> suggestions:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{suggestion}</span>"</span>)
    
    <span class="hljs-comment"># 5. 业务价值</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n💰 业务价值:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
    
    business_impacts = [
        <span class="hljs-string">f"• 预测准确率达到 R²=<span class="hljs-subst">{r2:<span class="hljs-number">.4</span>f}</span>"</span>,
        <span class="hljs-string">f"• 平均预测误差为 <span class="hljs-subst">{mae:<span class="hljs-number">.0</span>f}</span> 欧元"</span>,
        <span class="hljs-string">f"• 可以帮助门店经理优化员工排班"</span>,
        <span class="hljs-string">f"• 减少库存成本约 <span class="hljs-subst">{r2*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%"</span>,
        <span class="hljs-string">f"• 提升客户满意度"</span>,
        <span class="hljs-string">f"• 实现数据驱动的运营决策"</span>
    ]
    
    <span class="hljs-keyword">for</span> impact <span class="hljs-keyword">in</span> business_impacts:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{impact}</span>"</span>)
    
    <span class="hljs-comment"># 可视化性能提升</span>
    fig, ax = plt.subplots(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))
    
    <span class="hljs-comment"># 基准线：历史平均值</span>
    baseline_pred = np.full_like(y_test, y_train.mean())
    baseline_rmse = np.sqrt(mean_squared_error(y_test, baseline_pred))
    
    <span class="hljs-comment"># 我们的模型</span>
    x_labels = [<span class="hljs-string">'历史平均值'</span>, <span class="hljs-string">'我们的模型'</span>]
    y_values = [baseline_rmse, rmse]
    colors = [<span class="hljs-string">'#95a5a6'</span>, <span class="hljs-string">'#2ecc71'</span>]
    
    bars = ax.bar(x_labels, y_values, color=colors, alpha=<span class="hljs-number">0.8</span>)
    ax.set_title(<span class="hljs-string">f'🎯 模型性能 vs 基准线 (提升: <span class="hljs-subst">{(baseline_rmse - rmse)/baseline_rmse*<span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)'</span>, 
                fontsize=<span class="hljs-number">16</span>, fontweight=<span class="hljs-string">'bold'</span>, pad=<span class="hljs-number">20</span>)
    ax.set_ylabel(<span class="hljs-string">'RMSE（越低越好）'</span>, fontsize=<span class="hljs-number">12</span>)
    ax.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'y'</span>)
    
    <span class="hljs-comment"># 添加数值标签</span>
    <span class="hljs-keyword">for</span> bar, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(bars, y_values):
        height = bar.get_height()
        ax.text(bar.get_x() + bar.get_width()/<span class="hljs-number">2.</span>, height + <span class="hljs-number">50</span>,
                <span class="hljs-string">f'<span class="hljs-subst">{value:<span class="hljs-number">.0</span>f}</span>'</span>, ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>, fontsize=<span class="hljs-number">11</span>, fontweight=<span class="hljs-string">'bold'</span>)
    
    plt.tight_layout()
    plt.show()

<span class="hljs-comment"># 生成总结报告</span>
generate_summary_report(X_train, y_train, X_test, y_test, xgb_model, xgb_pred)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36feb7f3be1f4ed6b227c84d784c9c05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=nvij87P%2FJEypY%2FPFYZKN1VnYYEQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/682b2cc4969849c7b394cb5cd03c9ef8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5aSp5b695LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685850&amp;x-signature=bPaLyEQUTI6YMypKRXCsJhUmV98%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-27">三、🎯 关键成果与技术亮点</h2>
<h3 data-id="heading-28">3.1 核心成果：</h3>
<ul>
<li><strong>RMSE：598.45</strong></li>
<li><strong>R²分数：0.9760</strong>（模型解释力强）</li>
<li>**特征数量：50+ **（从原始9个扩展到50+个特征）</li>
<li><strong>时间序列处理</strong>：完整的时间特征工程和滞后特征</li>
<li><strong>RMSPE：0.1226</strong></li>
</ul>
<h3 data-id="heading-29">3.2 技术亮点：</h3>
<ol>
<li>
<p><strong>时间特征工程</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"># 创建全面的时间特征
df<span class="hljs-selector-attr">[<span class="hljs-string">'Year'</span>]</span> = df<span class="hljs-selector-attr">[<span class="hljs-string">'Date'</span>]</span><span class="hljs-selector-class">.dt</span><span class="hljs-selector-class">.year</span>
df<span class="hljs-selector-attr">[<span class="hljs-string">'Month'</span>]</span> = df<span class="hljs-selector-attr">[<span class="hljs-string">'Date'</span>]</span><span class="hljs-selector-class">.dt</span><span class="hljs-selector-class">.month</span>
df<span class="hljs-selector-attr">[<span class="hljs-string">'WeekOfYear'</span>]</span> = df<span class="hljs-selector-attr">[<span class="hljs-string">'Date'</span>]</span><span class="hljs-selector-class">.dt</span><span class="hljs-selector-class">.isocalendar</span>()<span class="hljs-selector-class">.week</span>
df<span class="hljs-selector-attr">[<span class="hljs-string">'Season'</span>]</span> = df<span class="hljs-selector-attr">[<span class="hljs-string">'Month'</span>]</span><span class="hljs-selector-class">.map</span>(seasons_mapping)
</code></pre>
</li>
<li>
<p><strong>滞后和滚动特征</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"># 滞后特征
df<span class="hljs-selector-attr">[<span class="hljs-string">'Sales_lag_1'</span>]</span> = df<span class="hljs-selector-class">.groupby</span>('Store')<span class="hljs-selector-attr">[<span class="hljs-string">'Sales'</span>]</span><span class="hljs-selector-class">.shift</span>(<span class="hljs-number">1</span>)
df<span class="hljs-selector-attr">[<span class="hljs-string">'Sales_lag_7'</span>]</span> = df<span class="hljs-selector-class">.groupby</span>('Store')<span class="hljs-selector-attr">[<span class="hljs-string">'Sales'</span>]</span><span class="hljs-selector-class">.shift</span>(<span class="hljs-number">7</span>)

# 滚动统计特征
df<span class="hljs-selector-attr">[<span class="hljs-string">'Sales_rolling_mean_7'</span>]</span> = df<span class="hljs-selector-class">.groupby</span>('Store')<span class="hljs-selector-attr">[<span class="hljs-string">'Sales'</span>]</span><span class="hljs-selector-class">.transform</span>(
    lambda x: x.rolling(window=<span class="hljs-number">7</span>, min_periods=<span class="hljs-number">1</span>)<span class="hljs-selector-class">.mean</span>()
)
</code></pre>
</li>
<li>
<p><strong>门店特征工程</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 竞争对手特征</span>
<span class="hljs-built_in">df</span>[<span class="hljs-string">'CompetitionOpenMonths'</span>] = (current_year - <span class="hljs-built_in">df</span>[<span class="hljs-string">'CompetitionOpenSinceYear'</span>]) * 12 + \
                             (12 - <span class="hljs-built_in">df</span>[<span class="hljs-string">'CompetitionOpenSinceMonth'</span>])

<span class="hljs-comment"># 促销特征</span>
<span class="hljs-built_in">df</span>[<span class="hljs-string">'IsPromo2Month'</span>] = df.apply(lambda row: is_promo_month(row[<span class="hljs-string">'PromoInterval'</span>], row[<span class="hljs-string">'Month'</span>]), axis=1)
</code></pre>
</li>
<li>
<p><strong>XGBoost优化参数</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">params</span> = {
    <span class="hljs-string">'objective'</span>: <span class="hljs-string">'reg:squarederror'</span>,
    <span class="hljs-string">'eval_metric'</span>: <span class="hljs-string">'rmse'</span>,
    <span class="hljs-string">'eta'</span>: <span class="hljs-number">0.05</span>,
    <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">8</span>,
    <span class="hljs-string">'subsample'</span>: <span class="hljs-number">0.8</span>,
    <span class="hljs-string">'colsample_bytree'</span>: <span class="hljs-number">0.8</span>,
    <span class="hljs-string">'alpha'</span>: <span class="hljs-number">0.1</span>,
    <span class="hljs-string">'lambda'</span>: <span class="hljs-number">1.0</span>
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-30">四、🚀 快速开始指南</h2>
<h4 data-id="heading-31">1. <strong>环境准备</strong>：</h4>
<pre><code class="hljs">pip install pandas numpy matplotlib seaborn scikit-learn xgboost lightgbm
</code></pre>
<h4 data-id="heading-32">2. <strong>运行完整流程</strong>：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键运行所有代码</span>
python rossmann_pipeline.py
</code></pre>
<h4 data-id="heading-33">3. <strong>提交结果</strong>：</h4>
<ul>
<li>在Kaggle竞赛页面提交<code>final_submission.csv</code></li>
</ul>
<h2 data-id="heading-34">五、📚 学习资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaggle.com%2Fc%2Frossmann-store-sales" target="_blank" title="https://www.kaggle.com/c/rossmann-store-sales" ref="nofollow noopener noreferrer">Kaggle竞赛页面</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fxgboost.readthedocs.io%2F" target="_blank" title="https://xgboost.readthedocs.io/" ref="nofollow noopener noreferrer">XGBoost官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fotexts.com%2Ffpp3%2F" target="_blank" title="https://otexts.com/fpp3/" ref="nofollow noopener noreferrer">时间序列分析指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaggle.com%2Flearn%2Ffeature-engineering" target="_blank" title="https://www.kaggle.com/learn/feature-engineering" ref="nofollow noopener noreferrer">特征工程实战</a></li>
</ul>
<h2 data-id="heading-35">六、💡 后续优化方向</h2>
<ol>
<li><strong>时间序列模型</strong>：尝试Prophet、ARIMA等专门的时间序列模型</li>
<li><strong>深度学习</strong>：使用LSTM、GRU等循环神经网络</li>
<li><strong>特征选择</strong>：使用更精细的特征选择方法</li>
<li><strong>超参数优化</strong>：使用Optuna进行贝叶斯优化</li>
<li><strong>模型融合</strong>：尝试Stacking、Blending等更复杂的集成方法</li>
</ol>
<hr/>
<p><strong>✨ 记得点赞、收藏、关注，获取更多机器学习实战内容！</strong></p>
<p><em>注：本文所有代码均在Kaggle环境中测试通过，可直接运行获得0.1226的RMSPE分数成绩。</em></p>
<hr/>
<p>如果您在人工智能领域遇到技术难题，或是需要专业支持，无论是技术咨询、项目开发还是个性化解决方案，我都可以为您提供专业服务，如有需要可站内私信或添加下方VX名片（ID：xf982831907）</p>
<p>期待与您一起交流，共同探索AI的更多可能！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【OpenGL小作坊】C# + OpenTK + OpenGL实现.tif点云转换成.obj模型]]></title>    <link>https://juejin.cn/post/7589466356778434612</link>    <guid>https://juejin.cn/post/7589466356778434612</guid>    <pubDate>2025-12-30T07:40:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589466356778434612" data-draft-id="7589386219449876495" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【OpenGL小作坊】C# + OpenTK + OpenGL实现.tif点云转换成.obj模型"/> <meta itemprop="keywords" content="OpenGL,C#"/> <meta itemprop="datePublished" content="2025-12-30T07:40:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenGL小作坊"/> <meta itemprop="url" content="https://juejin.cn/user/3702810894928285"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【OpenGL小作坊】C# + OpenTK + OpenGL实现.tif点云转换成.obj模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810894928285/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenGL小作坊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:40:59.000Z" title="Tue Dec 30 2025 07:40:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>[先生们/女士们先看结果]</strong></p>
<p>1.高程图片.tif记录了模型的高度信息。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfcda2b364524d7693bf9b65efcc04d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkdM5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685316&amp;x-signature=6JHnQKtZ4YlH8DAAvwdAxRlU3pk%3D" width="300" height="300" alt="图片说明" align="center" loading="lazy"/>
<p>2.通过转换将.tif高程图片构建成.obj模型</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8c4ef5ec4154f60b34ce669e05d296b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkdM5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767685316&amp;x-signature=lbym6yP1%2BFCgGv5k3opG8aqpNWQ%3D" alt="Adobe Express - 20251230_143222.gif" loading="lazy"/></p>
<h2 data-id="heading-0">一.读取高程图像(.tif)信息</h2>
<p>这里我们使用到一个库GDAL,C#里面用来获取.tif像素信息的一个库，感兴趣的小伙伴可以深入了解一下，这里我们只说怎么读取.tif的图片信息。</p>
<pre><code class="hljs language-c#" lang="c#">Gdal.AllRegister(); <span class="hljs-comment">//初始化GDAL</span>

<span class="hljs-comment">//获取高程图像.tif的图像信息dem</span>
<span class="hljs-keyword">using</span> Dataset ds = Gdal.Open(<span class="hljs-string">".tif图片路径"</span>, Access.GA_ReadOnly);
width = ds.RasterXSize;
height = ds.RasterYSize;
Band band = ds.GetRasterBand(<span class="hljs-number">1</span>);
band.GetNoDataValue(<span class="hljs-keyword">out</span> <span class="hljs-built_in">double</span> noData, <span class="hljs-keyword">out</span> <span class="hljs-built_in">int</span> hasNoData);

<span class="hljs-built_in">float</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">float</span>[width * height];
band.ReadRaster(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height, buffer, width, height, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

<span class="hljs-built_in">float</span>[,] dem = <span class="hljs-keyword">new</span> <span class="hljs-built_in">float</span>[height, width];
isNoData = <span class="hljs-keyword">new</span> <span class="hljs-built_in">bool</span>[height, width];

<span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++)
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++)
    {
        <span class="hljs-built_in">float</span> v = buffer[y * width + x];
        <span class="hljs-built_in">bool</span> nd = (hasNoData == <span class="hljs-number">1</span> &amp;&amp; Math.Abs(v - (<span class="hljs-built_in">float</span>)noData) &lt; <span class="hljs-number">0.001f</span>) || v == <span class="hljs-number">0f</span>;
        dem[y, x] = nd ? <span class="hljs-number">0</span> : v;
        isNoData[y, x] = nd;
    }
}
</code></pre>
<h2 data-id="heading-1">二.根据高程图像(.tif)构建模型网格Mesh.</h2>
<p>上一步骤中，我们获取到了高程图像(.tif)的图像信息。下面我们就利用这些高度信息来构建模型。</p>
<p>之前，对3D模型有过了解的同学肯定知道，要想构建一个3D模型，无非就是集齐模型的顶点，法线，面，纹理坐标（Uv），然后高程图像的高度信息，就可以作为我们要构建模型的顶点信息。</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ObjMesh</span> <span class="hljs-comment">//自定义的模型类</span>
{
    <span class="hljs-keyword">public</span> List&lt;Vector3&gt; Vertices { <span class="hljs-keyword">get</span>; } = <span class="hljs-keyword">new</span>();
    <span class="hljs-keyword">public</span> List&lt;(<span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>)&gt; Faces { <span class="hljs-keyword">get</span>; } = <span class="hljs-keyword">new</span>();
}
</code></pre>
<pre><code class="hljs language-C#" lang="C#">   <span class="hljs-built_in">int</span> rows = dem.GetLength(<span class="hljs-number">0</span>);
   <span class="hljs-built_in">int</span> cols = dem.GetLength(<span class="hljs-number">1</span>);

   <span class="hljs-comment">// 计算中心点偏移量</span>
   <span class="hljs-built_in">float</span> centerX = (cols - <span class="hljs-number">1</span>) * <span class="hljs-number">0.5f</span> * xyScale;
   <span class="hljs-built_in">float</span> centerZ = -(rows - <span class="hljs-number">1</span>) * <span class="hljs-number">0.5f</span> * xyScale;  <span class="hljs-comment">// 注意：Z轴为负方向</span>

   ObjMesh mesh = <span class="hljs-keyword">new</span> ObjMesh();
   <span class="hljs-built_in">int</span>[,] topIndexMap = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[rows, cols];
   <span class="hljs-built_in">int</span>[,] bottomIndexMap = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[rows, cols];

   <span class="hljs-comment">// ---------- 顶部顶点 ----------</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; rows; y += step)
   {
       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>; x &lt; cols; x += step)
       {
           <span class="hljs-keyword">if</span> (outerNoData[y, x])
           {
               topIndexMap[y, x] = <span class="hljs-number">0</span>;
               <span class="hljs-keyword">continue</span>;
           }

           topIndexMap[y, x] = mesh.Vertices.Count + <span class="hljs-number">1</span>;
           <span class="hljs-comment">// 将坐标原点移动到中心点</span>
           <span class="hljs-built_in">float</span> xPos = x * xyScale - centerX;
           <span class="hljs-built_in">float</span> zPos = -y * xyScale - centerZ;  <span class="hljs-comment">// 注意：Z轴为负方向</span>
           mesh.Vertices.Add(<span class="hljs-keyword">new</span> Vector3(
               xPos,
               dem[y, x] * zScale,
               zPos
           ));
       }
   }

   <span class="hljs-comment">// ---------- 顶部三角面 ----------</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; rows - step; y += step)
   {
       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>; x &lt; cols - step; x += step)
       {
           <span class="hljs-built_in">int</span> v00 = topIndexMap[y, x];
           <span class="hljs-built_in">int</span> v10 = topIndexMap[y, x + step];
           <span class="hljs-built_in">int</span> v01 = topIndexMap[y + step, x];
           <span class="hljs-built_in">int</span> v11 = topIndexMap[y + step, x + step];

           <span class="hljs-keyword">if</span> (v00 == <span class="hljs-number">0</span> || v10 == <span class="hljs-number">0</span> || v01 == <span class="hljs-number">0</span> || v11 == <span class="hljs-number">0</span>)
               <span class="hljs-keyword">continue</span>;

           mesh.Faces.Add((v00, v01, v10));
           mesh.Faces.Add((v10, v01, v11));
       }
   }

   <span class="hljs-comment">// ---------- 创建底部顶点映射 ----------</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; rows; y += step)
   {
       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>; x &lt; cols; x += step)
       {
           <span class="hljs-comment">// 只有顶部有效的点才有底部顶点</span>
           <span class="hljs-keyword">if</span> (topIndexMap[y, x] != <span class="hljs-number">0</span>)
           {
               Vector3 topV = mesh.Vertices[topIndexMap[y, x] - <span class="hljs-number">1</span>];
               bottomIndexMap[y, x] = mesh.Vertices.Count + <span class="hljs-number">1</span>;
               mesh.Vertices.Add(<span class="hljs-keyword">new</span> Vector3(
                   topV.X,
                   bottomY,
                   topV.Z
               ));
           }
       }
   }

   <span class="hljs-comment">// ---------- 创建侧边墙 ----------</span>
   <span class="hljs-comment">// 垂直边（X方向）</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; rows; y += step)
   {
       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>; x &lt; cols - step; x += step)
       {
           <span class="hljs-built_in">int</span> idx00 = topIndexMap[y, x];
           <span class="hljs-built_in">int</span> idx10 = topIndexMap[y, x + step];

           <span class="hljs-comment">// 如果两个顶点都存在，且至少有一个是边缘点</span>
           <span class="hljs-keyword">if</span> (idx00 != <span class="hljs-number">0</span> &amp;&amp; idx10 != <span class="hljs-number">0</span>)
           {
               <span class="hljs-built_in">bool</span> isEdge = IsEdgePoint(topIndexMap, x, y, rows, cols, step) ||
                            IsEdgePoint(topIndexMap, x + step, y, rows, cols, step);

               <span class="hljs-keyword">if</span> (isEdge)
               {
                   <span class="hljs-built_in">int</span> b00 = bottomIndexMap[y, x];
                   <span class="hljs-built_in">int</span> b10 = bottomIndexMap[y, x + step];
                   mesh.Faces.Add((idx00, b00, b10));
                   mesh.Faces.Add((idx00, b10, idx10));
               }
           }
           <span class="hljs-comment">// 如果一个存在一个不存在，创建三角形连接</span>
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (idx00 != <span class="hljs-number">0</span> &amp;&amp; idx10 == <span class="hljs-number">0</span>)
           {
               <span class="hljs-built_in">int</span> b00 = bottomIndexMap[y, x];
               Vector3 topV = mesh.Vertices[idx00 - <span class="hljs-number">1</span>];
               <span class="hljs-built_in">int</span> b10 = mesh.Vertices.Count + <span class="hljs-number">1</span>;
               <span class="hljs-comment">// 计算新的底部顶点坐标（使用中心偏移）</span>
               <span class="hljs-built_in">float</span> xPos = (x + step) * xyScale - centerX;
               <span class="hljs-built_in">float</span> zPos = -y * xyScale - centerZ;
               mesh.Vertices.Add(<span class="hljs-keyword">new</span> Vector3(
                   xPos,
                   bottomY,
                   zPos
               ));
               mesh.Faces.Add((idx00, b00, b10));
               <span class="hljs-comment">// 更新映射</span>
               bottomIndexMap[y, x + step] = b10;
           }
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (idx00 == <span class="hljs-number">0</span> &amp;&amp; idx10 != <span class="hljs-number">0</span>)
           {
               <span class="hljs-built_in">int</span> b10 = bottomIndexMap[y, x + step];
               Vector3 topV = mesh.Vertices[idx10 - <span class="hljs-number">1</span>];
               <span class="hljs-built_in">int</span> b00 = mesh.Vertices.Count + <span class="hljs-number">1</span>;
               <span class="hljs-comment">// 计算新的底部顶点坐标（使用中心偏移）</span>
               <span class="hljs-built_in">float</span> xPos = x * xyScale - centerX;
               <span class="hljs-built_in">float</span> zPos = -y * xyScale - centerZ;
               mesh.Vertices.Add(<span class="hljs-keyword">new</span> Vector3(
                   xPos,
                   bottomY,
                   zPos
               ));
               mesh.Faces.Add((idx10, b10, b00));
               <span class="hljs-comment">// 更新映射</span>
               bottomIndexMap[y, x] = b00;
           }
       }
   }

   <span class="hljs-comment">// 垂直边（Y方向）</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; rows - step; y += step)
   {
       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>; x &lt; cols; x += step)
       {
           <span class="hljs-built_in">int</span> idx00 = topIndexMap[y, x];
           <span class="hljs-built_in">int</span> idx01 = topIndexMap[y + step, x];

           <span class="hljs-keyword">if</span> (idx00 != <span class="hljs-number">0</span> &amp;&amp; idx01 != <span class="hljs-number">0</span>)
           {
               <span class="hljs-built_in">bool</span> isEdge = IsEdgePoint(topIndexMap, x, y, rows, cols, step) ||
                            IsEdgePoint(topIndexMap, x, y + step, rows, cols, step);

               <span class="hljs-keyword">if</span> (isEdge)
               {
                   <span class="hljs-built_in">int</span> b00 = bottomIndexMap[y, x];
                   <span class="hljs-built_in">int</span> b01 = bottomIndexMap[y + step, x];
                   mesh.Faces.Add((idx00, b00, b01));
                   mesh.Faces.Add((idx00, b01, idx01));
               }
           }
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (idx00 != <span class="hljs-number">0</span> &amp;&amp; idx01 == <span class="hljs-number">0</span>)
           {
               <span class="hljs-built_in">int</span> b00 = bottomIndexMap[y, x];
               Vector3 topV = mesh.Vertices[idx00 - <span class="hljs-number">1</span>];
               <span class="hljs-built_in">int</span> b01 = mesh.Vertices.Count + <span class="hljs-number">1</span>;
               <span class="hljs-comment">// 计算新的底部顶点坐标（使用中心偏移）</span>
               <span class="hljs-built_in">float</span> xPos = x * xyScale - centerX;
               <span class="hljs-built_in">float</span> zPos = -(y + step) * xyScale - centerZ;
               mesh.Vertices.Add(<span class="hljs-keyword">new</span> Vector3(
                   xPos,
                   bottomY,
                   zPos
               ));
               mesh.Faces.Add((idx00, b00, b01));
               bottomIndexMap[y + step, x] = b01;
           }
           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (idx00 == <span class="hljs-number">0</span> &amp;&amp; idx01 != <span class="hljs-number">0</span>)
           {
               <span class="hljs-built_in">int</span> b01 = bottomIndexMap[y + step, x];
               Vector3 topV = mesh.Vertices[idx01 - <span class="hljs-number">1</span>];
               <span class="hljs-built_in">int</span> b00 = mesh.Vertices.Count + <span class="hljs-number">1</span>;
               <span class="hljs-comment">// 计算新的底部顶点坐标（使用中心偏移）</span>
               <span class="hljs-built_in">float</span> xPos = x * xyScale - centerX;
               <span class="hljs-built_in">float</span> zPos = -y * xyScale - centerZ;
               mesh.Vertices.Add(<span class="hljs-keyword">new</span> Vector3(
                   xPos,
                   bottomY,
                   zPos
               ));
               mesh.Faces.Add((idx01, b01, b00));
               bottomIndexMap[y, x] = b00;
           }
       }
   }

   <span class="hljs-comment">// ---------- 创建底面（只覆盖有顶部顶点的地方） ----------</span>
   <span class="hljs-comment">// 只在顶部面存在的区域创建底面三角形</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; rows - step; y += step)
   {
       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>; x &lt; cols - step; x += step)
       {
           <span class="hljs-built_in">int</span> t00 = topIndexMap[y, x];
           <span class="hljs-built_in">int</span> t10 = topIndexMap[y, x + step];
           <span class="hljs-built_in">int</span> t01 = topIndexMap[y + step, x];
           <span class="hljs-built_in">int</span> t11 = topIndexMap[y + step, x + step];

           <span class="hljs-comment">// 如果这个网格的顶部存在（四个角都有顶部顶点），则创建对应的底面</span>
           <span class="hljs-keyword">if</span> (t00 != <span class="hljs-number">0</span> &amp;&amp; t10 != <span class="hljs-number">0</span> &amp;&amp; t01 != <span class="hljs-number">0</span> &amp;&amp; t11 != <span class="hljs-number">0</span>)
           {
               <span class="hljs-built_in">int</span> b00 = bottomIndexMap[y, x];
               <span class="hljs-built_in">int</span> b10 = bottomIndexMap[y, x + step];
               <span class="hljs-built_in">int</span> b01 = bottomIndexMap[y + step, x];
               <span class="hljs-built_in">int</span> b11 = bottomIndexMap[y + step, x + step];

               <span class="hljs-comment">// 底面三角面（注意法线方向向下，顶点顺序要逆时针）</span>
               mesh.Faces.Add((b00, b10, b01));
               mesh.Faces.Add((b10, b11, b01));
           }
       }
   }

   <span class="hljs-comment">// ---------- 处理孤立的底面区域 ----------</span>
   <span class="hljs-comment">// 对于那些顶部只有一个顶点的地方，创建单个三角形的底面</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; rows; y += step)
   {
       <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>; x &lt; cols; x += step)
       {
           <span class="hljs-comment">// 如果当前点有顶部顶点，但周围四个网格中没有一个完整的顶部面</span>
           <span class="hljs-keyword">if</span> (topIndexMap[y, x] != <span class="hljs-number">0</span>)
           {
               <span class="hljs-built_in">bool</span> hasAdjacentTopFace = <span class="hljs-literal">false</span>;

               <span class="hljs-comment">// 检查左上网格</span>
               <span class="hljs-keyword">if</span> (y - step &gt;= <span class="hljs-number">0</span> &amp;&amp; x - step &gt;= <span class="hljs-number">0</span>)
               {
                   <span class="hljs-keyword">if</span> (topIndexMap[y - step, x - step] != <span class="hljs-number">0</span> &amp;&amp;
                       topIndexMap[y - step, x] != <span class="hljs-number">0</span> &amp;&amp;
                       topIndexMap[y, x - step] != <span class="hljs-number">0</span>)
                   {
                       hasAdjacentTopFace = <span class="hljs-literal">true</span>;
                   }
               }

               <span class="hljs-comment">// 检查右上网格</span>
               <span class="hljs-keyword">if</span> (y - step &gt;= <span class="hljs-number">0</span> &amp;&amp; x + step &lt; cols)
               {
                   <span class="hljs-keyword">if</span> (topIndexMap[y - step, x] != <span class="hljs-number">0</span> &amp;&amp;
                       topIndexMap[y - step, x + step] != <span class="hljs-number">0</span> &amp;&amp;
                       topIndexMap[y, x + step] != <span class="hljs-number">0</span>)
                   {
                       hasAdjacentTopFace = <span class="hljs-literal">true</span>;
                   }
               }

               <span class="hljs-comment">// 检查左下网格</span>
               <span class="hljs-keyword">if</span> (y + step &lt; rows &amp;&amp; x - step &gt;= <span class="hljs-number">0</span>)
               {
                   <span class="hljs-keyword">if</span> (topIndexMap[y, x - step] != <span class="hljs-number">0</span> &amp;&amp;
                       topIndexMap[y + step, x - step] != <span class="hljs-number">0</span> &amp;&amp;
                       topIndexMap[y + step, x] != <span class="hljs-number">0</span>)
                   {
                       hasAdjacentTopFace = <span class="hljs-literal">true</span>;
                   }
               }

               <span class="hljs-comment">// 检查右下网格</span>
               <span class="hljs-keyword">if</span> (y + step &lt; rows &amp;&amp; x + step &lt; cols)
               {
                   <span class="hljs-keyword">if</span> (topIndexMap[y, x + step] != <span class="hljs-number">0</span> &amp;&amp;
                       topIndexMap[y + step, x] != <span class="hljs-number">0</span> &amp;&amp;
                       topIndexMap[y + step, x + step] != <span class="hljs-number">0</span>)
                   {
                       hasAdjacentTopFace = <span class="hljs-literal">true</span>;
                   }
               }

               <span class="hljs-comment">// 如果没有相邻的顶部面，为这个孤立的点创建一个小的三角底面</span>
               <span class="hljs-keyword">if</span> (!hasAdjacentTopFace)
               {
                   <span class="hljs-built_in">int</span> b00 = bottomIndexMap[y, x];
                   <span class="hljs-comment">// 创建两个相邻的虚拟底部点（使用中心偏移）</span>
                   Vector3 bottomCenter = mesh.Vertices[b00 - <span class="hljs-number">1</span>];
                   <span class="hljs-built_in">int</span> b01 = mesh.Vertices.Count + <span class="hljs-number">1</span>;
                   mesh.Vertices.Add(<span class="hljs-keyword">new</span> Vector3(
                       bottomCenter.X - <span class="hljs-number">0.5f</span> * xyScale,
                       bottomY,
                       bottomCenter.Z
                   ));
                   <span class="hljs-built_in">int</span> b10 = mesh.Vertices.Count + <span class="hljs-number">1</span>;
                   mesh.Vertices.Add(<span class="hljs-keyword">new</span> Vector3(
                       bottomCenter.X,
                       bottomY,
                       bottomCenter.Z + <span class="hljs-number">0.5f</span> * xyScale
                   ));

                   mesh.Faces.Add((b00, b10, b01));
               }
           }
       }
   }
</code></pre>
<h2 data-id="heading-2">三.将模型写入.obj文件</h2>
<p>上一步中，我们已经获得了模型的所有顶点信息，面信息。下面只要将mesh写入.obj即可。</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteObj</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> path, ObjMesh mesh</span>)</span>
{
    <span class="hljs-keyword">using</span> StreamWriter sw = <span class="hljs-keyword">new</span> StreamWriter(path);
    sw.WriteLine(<span class="hljs-string">"# DEM Terrain with Walls + Bottom"</span>);
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> v <span class="hljs-keyword">in</span> mesh.Vertices)
        sw.WriteLine(<span class="hljs-string">$"v <span class="hljs-subst">{v.X:F6}</span> <span class="hljs-subst">{v.Y:F6}</span> <span class="hljs-subst">{v.Z:F6}</span>"</span>);
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> f <span class="hljs-keyword">in</span> mesh.Faces)
        sw.WriteLine(<span class="hljs-string">$"f <span class="hljs-subst">{f.Item1}</span> <span class="hljs-subst">{f.Item2}</span> <span class="hljs-subst">{f.Item3}</span>"</span>);

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始用Python生成码：自定义样式与Logo嵌入]]></title>    <link>https://juejin.cn/post/7589212818807406655</link>    <guid>https://juejin.cn/post/7589212818807406655</guid>    <pubDate>2025-12-30T08:25:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589212818807406655" data-draft-id="7589475923696517139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始用Python生成码：自定义样式与Logo嵌入"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-30T08:25:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="站大爷IP"/> <meta itemprop="url" content="https://juejin.cn/user/2905353241759261"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始用Python生成码：自定义样式与Logo嵌入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2905353241759261/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    站大爷IP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:25:19.000Z" title="Tue Dec 30 2025 08:25:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>二维码和条形码已成为现代信息传递的重要工具，从支付扫码到产品溯源，从活动签到到数据存储，这些黑白方块和线条背后藏着巨大的应用潜力。但默认生成的码往往千篇一律，如何让它们既实用又美观？本文将带你用Python从零实现码生成，并掌握自定义样式和嵌入Logo的核心技巧。</p>
<hr/>
<h2 data-id="heading-0">一、基础准备：选择合适的Python库</h2>
<p>生成码的核心是选择可靠的库。Python生态中有多个优秀选项：</p>
<h3 data-id="heading-1">1.1 二维码生成：qrcode库</h3>
<p><code>qrcode</code>是Python最流行的二维码生成库，支持多种纠错级别和尺寸调整。安装只需：</p>
<pre><code class="hljs language-css" lang="css">pip install qrcode<span class="hljs-selector-attr">[pil]</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>（<code>[pil]</code>表示同时安装Pillow图像处理库，用于后续样式定制）</p>
<h3 data-id="heading-2">1.2 条形码生成：python-barcode库</h3>
<p>对于条形码（如EAN-13、UPC-A等），<code>python-barcode</code>是专业选择：</p>
<pre><code class="hljs">pip install python-barcode
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>它支持17种标准条形码格式，输出为SVG或PIL图像。</p>
<h3 data-id="heading-3">1.3 图像处理：Pillow库</h3>
<p>无论二维码还是条形码，最终都需要与Logo或背景融合，<code>Pillow</code>（PIL）是Python图像处理的标配：</p>
<pre><code class="hljs">pip install pillow
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">二、基础码生成：从黑白方块开始</h2>
<h3 data-id="heading-5">2.1 生成简单二维码</h3>
<p>用<code>qrcode</code>生成基础二维码只需3行代码：</p>
<pre><code class="hljs language-ini" lang="ini">import qrcode

<span class="hljs-comment"># 创建二维码实例</span>
<span class="hljs-attr">qr</span> = qrcode.QRCode(
    <span class="hljs-attr">version</span>=<span class="hljs-number">1</span>,  <span class="hljs-comment"># 控制二维码大小（1-40）</span>
    <span class="hljs-attr">error_correction</span>=qrcode.constants.ERROR_CORRECT_L,  <span class="hljs-comment"># 纠错级别</span>
    <span class="hljs-attr">box_size</span>=<span class="hljs-number">10</span>,  <span class="hljs-comment"># 每个"点"的像素数</span>
    <span class="hljs-attr">border</span>=<span class="hljs-number">4</span>,  <span class="hljs-comment"># 边框宽度（单位：box_size）</span>
)

<span class="hljs-comment"># 添加数据</span>
qr.add_data("https://example.com")
qr.make(<span class="hljs-attr">fit</span>=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 自动调整尺寸</span>

<span class="hljs-comment"># 生成图像并保存</span>
<span class="hljs-attr">img</span> = qr.make_image(fill_color=<span class="hljs-string">"black"</span>, back_color=<span class="hljs-string">"white"</span>)
img.save("basic_qr.png")
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>运行后会生成一个黑白分明的二维码图片。</p>
<h3 data-id="heading-6">2.2 生成标准条形码</h3>
<p>以EAN-13格式为例：</p>
<pre><code class="hljs language-ini" lang="ini">import barcode
from barcode.writer import ImageWriter

<span class="hljs-comment"># 创建条形码生成器</span>
<span class="hljs-attr">ean</span> = barcode.get_barcode_class(<span class="hljs-string">'ean13'</span>)
<span class="hljs-attr">code</span> = ean(<span class="hljs-string">"5901234123457"</span>, writer=ImageWriter())  <span class="hljs-comment"># EAN-13需要12位数字</span>

<span class="hljs-comment"># 保存为PNG文件</span>
<span class="hljs-attr">filename</span> = code.save(<span class="hljs-string">"basic_barcode"</span>)  <span class="hljs-comment"># 自动添加.png后缀</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>生成的条形码会保存在当前目录。</p>
<hr/>
<h2 data-id="heading-7">三、进阶技巧：自定义码的样式</h2>
<h3 data-id="heading-8">3.1 二维码颜色定制</h3>
<p>通过<code>fill_color</code>和<code>back_color</code>参数可轻松改变颜色：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">img</span> = qr.make_image(
    <span class="hljs-attr">fill_color</span>=<span class="hljs-string">"#FF5733"</span>,  <span class="hljs-comment"># 二维码颜色（支持十六进制）</span>
    <span class="hljs-attr">back_color</span>=<span class="hljs-string">"#33FF57"</span>   <span class="hljs-comment"># 背景颜色</span>
)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-9">3.2 二维码形状变形</h3>
<p>默认二维码是正方形，但可通过<code>module_shape</code>参数改为圆形或其他形状（需<code>qrcode</code> 7.0+版本）：</p>
<pre><code class="hljs language-ini" lang="ini">from qrcode.image.styledpil import StyledPilImage
from qrcode.image.styles.moduledrawers import RoundedModuleDrawer

<span class="hljs-attr">qr</span> = qrcode.QRCode()
qr.add_data("https://example.com")
<span class="hljs-attr">img</span> = qr.make_image(
    <span class="hljs-attr">image_factory</span>=StyledPilImage,
    <span class="hljs-attr">module_drawer</span>=RoundedModuleDrawer(),  <span class="hljs-comment"># 使用圆形模块</span>
    <span class="hljs-attr">eye_drawer</span>=RoundedModuleDrawer()     <span class="hljs-comment"># 定位图案也圆形</span>
)
img.save("rounded_qr.png")
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-10">3.3 条形码样式调整</h3>
<p><code>python-barcode</code>通过<code>writer</code>参数控制样式：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> barcode.writer <span class="hljs-keyword">import</span> ImageWriter

options = {
    <span class="hljs-string">"module_width"</span>: <span class="hljs-number">0.2</span>,          <span class="hljs-comment"># 单个条的宽度（mm）</span>
    <span class="hljs-string">"module_height"</span>: <span class="hljs-number">15.0</span>,        <span class="hljs-comment"># 条形码高度（mm）</span>
    <span class="hljs-string">"font_size"</span>: <span class="hljs-number">10</span>,              <span class="hljs-comment"># 底部数字字体大小</span>
    <span class="hljs-string">"text_distance"</span>: <span class="hljs-number">5.0</span>,         <span class="hljs-comment"># 数字与条形码距离（mm）</span>
    <span class="hljs-string">"center_text"</span>: <span class="hljs-literal">True</span>           <span class="hljs-comment"># 数字居中</span>
}

ean = barcode.get_barcode_class(<span class="hljs-string">'ean13'</span>)
code = ean(<span class="hljs-string">"5901234123457"</span>, writer=ImageWriter(), writer_options=options)
code.save(<span class="hljs-string">"styled_barcode"</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-11">四、核心技能：在码中嵌入Logo</h2>
<h3 data-id="heading-12">4.1 二维码嵌入Logo</h3>
<p>关键步骤：</p>
<ol>
<li>生成基础二维码</li>
<li>用Pillow打开二维码图像</li>
<li>打开Logo图像并调整大小</li>
<li>将Logo粘贴到二维码中心</li>
<li>保存最终图像</li>
</ol>
<p>完整代码：</p>
<pre><code class="hljs language-ini" lang="ini">import qrcode
from PIL import Image

def generate_qr_with_logo(data, logo_path, output_path, <span class="hljs-attr">qr_size</span>=<span class="hljs-number">400</span>, logo_size=<span class="hljs-number">80</span>):
    <span class="hljs-comment"># 生成二维码</span>
    <span class="hljs-attr">qr</span> = qrcode.QRCode(
        <span class="hljs-attr">version</span>=<span class="hljs-number">1</span>,
        <span class="hljs-attr">error_correction</span>=qrcode.constants.ERROR_CORRECT_H,  <span class="hljs-comment"># 高纠错级别（30%容错）</span>
        <span class="hljs-attr">box_size</span>=<span class="hljs-number">10</span>,
        <span class="hljs-attr">border</span>=<span class="hljs-number">4</span>
    )
    qr.add_data(data)
    qr.make(<span class="hljs-attr">fit</span>=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># 创建二维码图像</span>
    <span class="hljs-attr">img_qr</span> = qr.make_image(fill_color=<span class="hljs-string">"black"</span>, back_color=<span class="hljs-string">"white"</span>).convert(<span class="hljs-string">"RGB"</span>)
    <span class="hljs-attr">img_qr</span> = img_qr.resize((qr_size, qr_size))  <span class="hljs-comment"># 调整二维码大小</span>
    
    <span class="hljs-comment"># 打开并调整Logo</span>
    try:
        <span class="hljs-attr">img_logo</span> = Image.open(logo_path).convert(<span class="hljs-string">"RGBA"</span>)
        <span class="hljs-attr">img_logo</span> = img_logo.resize((logo_size, logo_size))
        
        <span class="hljs-comment"># 计算Logo位置（居中）</span>
        <span class="hljs-attr">position</span> = ((qr_size - logo_size) // <span class="hljs-number">2</span>, (qr_size - logo_size) // <span class="hljs-number">2</span>)
        
        <span class="hljs-comment"># 创建带透明通道的二维码背景</span>
        <span class="hljs-attr">img_qr_with_alpha</span> = Image.new(<span class="hljs-string">"RGBA"</span>, img_qr.size, (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>))
        img_qr_with_alpha.paste(img_qr, (0, 0))
        
        <span class="hljs-comment"># 确保Logo区域可覆盖（高纠错级别保障可读性）</span>
        img_qr_with_alpha.paste(img_logo, position, img_logo)
        
        <span class="hljs-comment"># 转换为RGB模式保存</span>
        <span class="hljs-attr">result</span> = img_qr_with_alpha.convert(<span class="hljs-string">"RGB"</span>)
        result.save(output_path)
        print(f"二维码已保存至: {output_path}")
    except Exception as e:
        print(f"处理Logo时出错: {e}")
        img_qr.save(output_path)  <span class="hljs-comment"># 出错时保存无Logo版本</span>

<span class="hljs-comment"># 使用示例</span>
generate_qr_with_logo(
    <span class="hljs-attr">data</span>=<span class="hljs-string">"https://example.com"</span>,
    <span class="hljs-attr">logo_path</span>=<span class="hljs-string">"logo.png"</span>,
    <span class="hljs-attr">output_path</span>=<span class="hljs-string">"qr_with_logo.png"</span>,
    <span class="hljs-attr">qr_size</span>=<span class="hljs-number">600</span>,
    <span class="hljs-attr">logo_size</span>=<span class="hljs-number">120</span>
)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-13">4.2 条形码嵌入Logo（谨慎使用）</h3>
<p>条形码对Logo嵌入更敏感，建议：</p>
<ol>
<li>将Logo放在条形码上方/下方空白处</li>
<li>避免遮挡条形码本身</li>
<li>使用高对比度颜色</li>
</ol>
<p>示例代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> barcode.writer <span class="hljs-keyword">import</span> ImageWriter
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageDraw, ImageFont

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_barcode_with_logo</span>(<span class="hljs-params">data, logo_path, output_path</span>):
    <span class="hljs-comment"># 生成条形码</span>
    ean = barcode.get_barcode_class(<span class="hljs-string">'ean13'</span>)
    options = {
        <span class="hljs-string">"module_width"</span>: <span class="hljs-number">0.3</span>,
        <span class="hljs-string">"module_height"</span>: <span class="hljs-number">30.0</span>,
        <span class="hljs-string">"font_size"</span>: <span class="hljs-number">12</span>,
        <span class="hljs-string">"text_distance"</span>: <span class="hljs-number">5.0</span>
    }
    code = ean(data, writer=ImageWriter(), writer_options=options)
    filename = code.save(<span class="hljs-string">"temp_barcode"</span>)  <span class="hljs-comment"># 临时保存</span>
    
    <span class="hljs-comment"># 打开条形码和Logo</span>
    img_barcode = Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">"temp_barcode.png"</span>)
    <span class="hljs-keyword">try</span>:
        img_logo = Image.<span class="hljs-built_in">open</span>(logo_path).convert(<span class="hljs-string">"RGBA"</span>)
        img_logo = img_logo.resize((<span class="hljs-number">100</span>, <span class="hljs-number">50</span>))  <span class="hljs-comment"># 调整Logo大小</span>
        
        <span class="hljs-comment"># 创建新图像（条形码高度+Logo高度+间距）</span>
        new_height = img_barcode.height + img_logo.height + <span class="hljs-number">20</span>
        new_img = Image.new(<span class="hljs-string">"RGB"</span>, (img_barcode.width, new_height), <span class="hljs-string">"white"</span>)
        
        <span class="hljs-comment"># 粘贴条形码和Logo</span>
        new_img.paste(img_barcode, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>))
        new_img.paste(img_logo, ((img_barcode.width - img_logo.width) // <span class="hljs-number">2</span>, img_barcode.height + <span class="hljs-number">10</span>), img_logo)
        
        new_img.save(output_path)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"条形码已保存至: <span class="hljs-subst">{output_path}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理Logo时出错: <span class="hljs-subst">{e}</span>"</span>)
        img_barcode.save(output_path)  <span class="hljs-comment"># 出错时保存无Logo版本</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">import</span> os
        <span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">"temp_barcode.png"</span>):
            os.remove(<span class="hljs-string">"temp_barcode.png"</span>)

<span class="hljs-comment"># 使用示例</span>
generate_barcode_with_logo(
    data=<span class="hljs-string">"5901234123457"</span>,
    logo_path=<span class="hljs-string">"logo.png"</span>,
    output_path=<span class="hljs-string">"barcode_with_logo.png"</span>
)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-14">五、实战案例：制作活动签到二维码</h2>
<p>假设需要为一场活动生成带Logo的签到二维码，要求：</p>
<ul>
<li>包含活动专属URL</li>
<li>使用活动主题色</li>
<li>嵌入活动Logo</li>
<li>尺寸适合打印（A4纸每页4个）</li>
</ul>
<p>完整解决方案：</p>
<pre><code class="hljs language-ini" lang="ini">import qrcode
from PIL import Image
import os

def generate_event_qr(event_url, logo_path, output_folder, <span class="hljs-attr">count</span>=<span class="hljs-number">100</span>):
    <span class="hljs-comment"># 确保输出目录存在</span>
    os.makedirs(output_folder, <span class="hljs-attr">exist_ok</span>=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># 二维码配置</span>
    <span class="hljs-attr">qr_config</span> = {
        "version": 5,  <span class="hljs-comment"># 较大尺寸以容纳更多数据</span>
        "error_correction": qrcode.constants.ERROR_CORRECT_H,
        "box_size": 8,
        "border": 2
    }
    
    <span class="hljs-comment"># 颜色配置（活动主题色）</span>
    <span class="hljs-attr">fill_color</span> = (<span class="hljs-number">0</span>, <span class="hljs-number">102</span>, <span class="hljs-number">204</span>)  <span class="hljs-comment"># 蓝色</span>
    <span class="hljs-attr">back_color</span> = (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>)  <span class="hljs-comment"># 白色</span>
    
    <span class="hljs-comment"># Logo配置</span>
    <span class="hljs-attr">logo_size</span> = <span class="hljs-number">80</span>  <span class="hljs-comment"># 像素</span>
    
    for i in range(1, count + 1):
        <span class="hljs-comment"># 生成带编号的URL（假设URL格式为 https://example.com/checkin?id=XXX）</span>
        <span class="hljs-attr">current_url</span> = f<span class="hljs-string">"{event_url}?id={i:03d}"</span>
        
        <span class="hljs-comment"># 生成二维码</span>
        <span class="hljs-attr">qr</span> = qrcode.QRCode(**qr_config)
        qr.add_data(current_url)
        qr.make(<span class="hljs-attr">fit</span>=<span class="hljs-literal">True</span>)
        
        <span class="hljs-comment"># 创建图像</span>
        <span class="hljs-attr">img_qr</span> = qr.make_image(fill_color=fill_color, back_color=back_color).convert(<span class="hljs-string">"RGB"</span>)
        <span class="hljs-attr">img_qr</span> = img_qr.resize((<span class="hljs-number">400</span>, <span class="hljs-number">400</span>))  <span class="hljs-comment"># 最终尺寸</span>
        
        <span class="hljs-comment"># 处理Logo</span>
        try:
            <span class="hljs-attr">img_logo</span> = Image.open(logo_path).convert(<span class="hljs-string">"RGBA"</span>)
            <span class="hljs-attr">img_logo</span> = img_logo.resize((logo_size, logo_size))
            
            <span class="hljs-comment"># 创建带透明通道的二维码</span>
            <span class="hljs-attr">img_qr_with_alpha</span> = Image.new(<span class="hljs-string">"RGBA"</span>, img_qr.size, (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>))
            img_qr_with_alpha.paste(img_qr, (0, 0))
            
            <span class="hljs-comment"># 粘贴Logo（居中）</span>
            <span class="hljs-attr">position</span> = ((<span class="hljs-number">400</span> - logo_size) // <span class="hljs-number">2</span>, (<span class="hljs-number">400</span> - logo_size) // <span class="hljs-number">2</span>)
            img_qr_with_alpha.paste(img_logo, position, img_logo)
            
            <span class="hljs-comment"># 转换为RGB</span>
            <span class="hljs-attr">final_img</span> = img_qr_with_alpha.convert(<span class="hljs-string">"RGB"</span>)
            
            <span class="hljs-comment"># 添加编号文字（底部居中）</span>
            <span class="hljs-attr">draw</span> = ImageDraw.Draw(final_img)
            <span class="hljs-attr">font</span> = ImageFont.<span class="hljs-literal">true</span>type(<span class="hljs-string">"arial.ttf"</span>, <span class="hljs-number">24</span>)  <span class="hljs-comment"># 使用系统字体</span>
            <span class="hljs-attr">text</span> = f<span class="hljs-string">"签到码 #{i:03d}"</span>
            text_width, <span class="hljs-attr">text_height</span> = draw.textsize(text, font=font)
            draw.text(
                ((400 - text_width) // 2, 370),
                text,
                <span class="hljs-attr">fill</span>=<span class="hljs-string">"black"</span>,
                <span class="hljs-attr">font</span>=font
            )
            
            <span class="hljs-comment"># 保存</span>
            <span class="hljs-attr">output_path</span> = os.path.join(output_folder, f<span class="hljs-string">"qr_{i:03d}.png"</span>)
            final_img.save(output_path)
            print(f"已生成: {output_path}")
        except Exception as e:
            print(f"生成签到码 {i} 时出错: {e}")
            <span class="hljs-comment"># 保存无Logo版本</span>
            img_qr.save(os.path.join(output_folder, f"qr_{i:03d}_no_logo.png"))

<span class="hljs-comment"># 使用示例</span>
generate_event_qr(
    <span class="hljs-attr">event_url</span>=<span class="hljs-string">"https://example.com/checkin"</span>,
    <span class="hljs-attr">logo_path</span>=<span class="hljs-string">"event_logo.png"</span>,
    <span class="hljs-attr">output_folder</span>=<span class="hljs-string">"event_qrcodes"</span>,
    <span class="hljs-attr">count</span>=<span class="hljs-number">20</span>
)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-15">六、常见问题Q&amp;A</h2>
<p><strong>Q1：生成的二维码扫描不出来怎么办？</strong><br/>
A：检查以下原因：</p>
<ol>
<li>纠错级别设置过低（建议使用<code>ERROR_CORRECT_H</code>）</li>
<li>Logo过大遮挡了关键定位图案（确保Logo不超过二维码面积的30%）</li>
<li>颜色对比度不足（黑白对比最可靠，彩色需确保明暗差异明显）</li>
<li>图像模糊（保存时选择高DPI，如300dpi）</li>
</ol>
<p><strong>Q2：如何批量生成不同内容的二维码？</strong><br/>
A：将数据存储在列表或CSV文件中，用循环遍历生成。例如：</p>
<pre><code class="hljs language-ini" lang="ini">import csv

<span class="hljs-attr">data_list</span> = [
    {<span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://example.com/1"</span>},
    {<span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://example.com/2"</span>}
]

for item in data_list:
    <span class="hljs-attr">qr</span> = qrcode.QRCode()
    qr.add_data(item<span class="hljs-section">["url"]</span>)
    <span class="hljs-comment"># ...其余生成代码...</span>
    img.save(f"qr_{item<span class="hljs-section">['id']</span>}.png")
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>Q3：条形码和二维码有什么区别？</strong><br/>
A：</p>






























<table><thead><tr><th>特性</th><th>二维码</th><th>条形码</th></tr></thead><tbody><tr><td>数据容量</td><td>可存储数百字符</td><td>通常20-30字符</td></tr><tr><td>纠错能力</td><td>高（可恢复30%损坏）</td><td>低（部分损坏无法识别）</td></tr><tr><td>扫描方向</td><td>360度全向扫描</td><td>需固定方向扫描</td></tr><tr><td>应用场景</td><td>网址、联系信息、复杂数据</td><td>商品价格、库存管理</td></tr></tbody></table>
<p><strong>Q4：如何调整二维码的尺寸？</strong><br/>
A：通过<code>box_size</code>和<code>version</code>参数控制：</p>
<ul>
<li>
<p><code>box_size</code>：每个"点"的像素数（如设为10，则10x10像素一个点）</p>
</li>
<li>
<p><code>version</code>：二维码版本（1-40），版本越高尺寸越大，可存储更多数据<br/>
例如生成大尺寸二维码：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">qr</span> = qrcode.QRCode(
    <span class="hljs-attr">version</span>=<span class="hljs-number">10</span>,  <span class="hljs-comment"># 较大版本</span>
    <span class="hljs-attr">box_size</span>=<span class="hljs-number">15</span>,  <span class="hljs-comment"># 每个点15像素</span>
    <span class="hljs-attr">border</span>=<span class="hljs-number">4</span>
)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<p><strong>Q5：生成的图像有锯齿怎么办？</strong><br/>
A：在保存时指定抗锯齿参数（Pillow的<code>resize</code>方法）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">img</span> = img.resize((<span class="hljs-number">800</span>, <span class="hljs-number">800</span>), Image.LANCZOS)  <span class="hljs-comment"># 高质量缩放</span>
img.save("smooth_qr.png", <span class="hljs-attr">dpi</span>=(<span class="hljs-number">300</span>, <span class="hljs-number">300</span>))   <span class="hljs-comment"># 高DPI保存</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-16">结语</h2>
<p>从基础生成到高级定制，Python提供了完整的工具链让码生成变得简单而灵活。通过掌握颜色、形状、Logo嵌入等技巧，你可以创建出既实用又美观的码。记住：高纠错级别是Logo嵌入的安全保障，颜色对比度是扫描成功的关键，而批量处理能力则是大规模应用的基石。现在，用这些知识去设计你的专属码吧！</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[内存异常]]></title>    <link>https://juejin.cn/post/7589214068094074899</link>    <guid>https://juejin.cn/post/7589214068094074899</guid>    <pubDate>2025-12-30T07:49:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589214068094074899" data-draft-id="7589214643501547583" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="内存异常"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-30T07:49:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="温宇飞"/> <meta itemprop="url" content="https://juejin.cn/user/4300945219403368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            内存异常
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4300945219403368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    温宇飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:49:52.000Z" title="Tue Dec 30 2025 07:49:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>内存异常(Memory Exception)是程序运行时访问非法内存地址或违反内存访问规则而触发的错误。这类问题是系统级编程中最常见也最难调试的错误之一，包括空指针解引用、缓冲区溢出、使用已释放的内存等。本文以 C++ 为例，深入剖析内存异常的底层原理、常见类型、检测方法和预防策略。</p>
<h2 data-id="heading-0">什么是内存异常</h2>
<p>内存异常是指程序在运行时违反了内存访问规则，导致未定义行为或程序崩溃。</p>
<h3 data-id="heading-1">内存访问的基本规则</h3>
<p>程序访问内存必须遵守三个基本规则：</p>
<ol>
<li><strong>访问已分配的内存</strong>：不能访问未分配或已释放的内存区域</li>
<li><strong>访问权限正确</strong>：读写执行权限必须匹配（如代码段不可写）</li>
<li><strong>不越界访问</strong>：访问必须在分配的边界内</li>
</ol>
<p>违反任何一条规则都会触发内存异常。</p>
<h3 data-id="heading-2">内存异常的触发机制</h3>
<p>当程序违反内存访问规则时，CPU 的内存管理单元(MMU)会检测到异常并触发信号：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span>* ptr = <span class="hljs-literal">nullptr</span>;
*ptr = <span class="hljs-number">42</span>;  <span class="hljs-comment">// 访问空指针，MMU 触发 SIGSEGV (Segmentation Fault)</span>
</code></pre>
<p>操作系统捕获信号后，通常会终止进程并生成 core dump。</p>
<h3 data-id="heading-3">常见内存异常类型</h3>
<p>内存异常主要分为以下几类：</p>























































<table><thead><tr><th>异常类型</th><th>原因</th><th>典型表现</th></tr></thead><tbody><tr><td>内存溢出</td><td>可用内存耗尽</td><td>OOM Killer 杀进程</td></tr><tr><td>内存泄漏</td><td>已分配内存未释放</td><td>内存占用持续增长</td></tr><tr><td>栈溢出</td><td>栈空间超限</td><td>Stack Overflow</td></tr><tr><td>悬空/野指针</td><td>访问无效指针</td><td>Segmentation Fault</td></tr><tr><td>缓冲区溢出</td><td>写入越界</td><td>数据损坏或崩溃</td></tr><tr><td>双重释放</td><td>重复释放内存</td><td>Heap Corruption</td></tr><tr><td>内存碎片</td><td>内存分散</td><td>分配失败或性能下降</td></tr><tr><td>对齐问题</td><td>未对齐访问</td><td>性能下降或崩溃</td></tr><tr><td>多线程冲突</td><td>并发访问冲突</td><td>数据竞争</td></tr></tbody></table>
<p>这些异常在调试时难以定位，因为错误往往在触发异常之前就已经发生。</p>
<h2 data-id="heading-4">内存溢出 (Out of Memory)</h2>
<p>内存溢出指系统或进程的可用内存耗尽，无法满足新的内存分配请求。</p>
<h3 data-id="heading-5">触发条件</h3>
<p>OOM 发生在以下情况：</p>
<ol>
<li><strong>物理内存耗尽</strong>：系统 RAM 用完且交换空间(Swap)也满了</li>
<li><strong>进程内存限制</strong>：达到进程的虚拟内存上限（32 位系统 4GB，64 位系统通常更大）</li>
<li><strong>堆内存耗尽</strong>：C++ 的 <code>new</code> 或 C 的 <code>malloc</code> 无法分配新内存</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::vector&lt;<span class="hljs-type">int</span>*&gt; ptrs;
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// 持续分配 1MB 内存，最终触发 OOM</span>
        ptrs.<span class="hljs-built_in">push_back</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>)]);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>运行结果：程序最终抛出 <code>std::bad_alloc</code> 或被系统杀死。</p>
<h3 data-id="heading-6">OOM Killer 机制</h3>
<p>在 Linux 系统中，当物理内存和交换空间都耗尽时，内核的 OOM Killer 会选择一个进程杀死以释放内存。选择依据：</p>
<ul>
<li>内存占用量（越大越容易被杀）</li>
<li>进程优先级（低优先级容易被杀）</li>
<li>运行时间（新进程更容易被杀）</li>
</ul>
<p>可以通过 <code>/proc/&lt;pid&gt;/oom_score</code> 查看进程的 OOM 评分。</p>
<h3 data-id="heading-7">预防策略</h3>
<ol>
<li><strong>限制内存使用</strong>：使用内存池或对象池复用内存</li>
<li><strong>监控内存占用</strong>：及时发现内存泄漏</li>
<li><strong>优雅降级</strong>：捕获 <code>bad_alloc</code> 异常，释放缓存或延迟分配</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">try</span> {
    <span class="hljs-type">int</span>* arr = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[huge_size];
} <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::bad_alloc&amp; e) {
    <span class="hljs-comment">// 释放缓存或记录日志</span>
    std::cerr &lt;&lt; <span class="hljs-string">"内存分配失败: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
}
</code></pre>
<h2 data-id="heading-8">内存泄漏 (Memory Leak)</h2>
<p>内存泄漏指已分配的内存无法被释放或访问，导致可用内存逐渐减少，最终可能引发 OOM。</p>
<h3 data-id="heading-9">典型场景</h3>
<p><strong>1. new/delete 不匹配</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">leak_example</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span>* ptr = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];
    <span class="hljs-comment">// 忘记 delete[]，函数返回后内存泄漏</span>
}
</code></pre>
<p><strong>2. 异常导致的泄漏</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">exception_leak</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span>* ptr = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">100</span>];
    <span class="hljs-built_in">process_data</span>();  <span class="hljs-comment">// 如果抛异常，下面的 delete 不会执行</span>
    <span class="hljs-keyword">delete</span>[] ptr;
}
</code></pre>
<p><strong>3. 循环引用（智能指针）</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> {
    std::shared_ptr&lt;Node&gt; next;
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">circular_ref</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> a = std::<span class="hljs-built_in">make_shared</span>&lt;Node&gt;();
    <span class="hljs-keyword">auto</span> b = std::<span class="hljs-built_in">make_shared</span>&lt;Node&gt;();
    a-&gt;next = b;
    b-&gt;next = a;  <span class="hljs-comment">// 循环引用，引用计数永远不为 0</span>
}
</code></pre>
<h3 data-id="heading-10">检测方法</h3>
<ol>
<li><strong>Valgrind (Memcheck)</strong>：运行时检测内存泄漏</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">valgrind --leak-check=full ./program
</code></pre>
<ol start="2">
<li><strong>AddressSanitizer</strong>：编译时插桩</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">g++ -fsanitize=address -g program.cpp
</code></pre>
<h3 data-id="heading-11">预防策略</h3>
<p>使用 RAII 和智能指针自动管理内存：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用 unique_ptr 自动释放</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">no_leak</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> ptr = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>[]&gt;(<span class="hljs-number">100</span>);
    <span class="hljs-built_in">process_data</span>();  <span class="hljs-comment">// 即使抛异常，ptr 也会自动释放</span>
}

<span class="hljs-comment">// 循环引用用 weak_ptr 打破</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> {
    std::shared_ptr&lt;Node&gt; next;
    std::weak_ptr&lt;Node&gt; prev;  <span class="hljs-comment">// 不增加引用计数</span>
};
</code></pre>
<h2 data-id="heading-12">栈溢出 (Stack Overflow)</h2>
<p>栈溢出指栈空间耗尽，通常由递归过深或局部变量过大引起。</p>
<h3 data-id="heading-13">栈的工作原理</h3>
<p>栈是一块固定大小的内存区域，用于存储函数调用信息和局部变量。每次函数调用会压入栈帧(Stack Frame)，包含：</p>
<ul>
<li>返回地址</li>
<li>函数参数</li>
<li>局部变量</li>
</ul>
<p>栈大小通常有限（Linux 默认 8MB，可通过 <code>ulimit -s</code> 查看）。</p>
<h3 data-id="heading-14">典型场景</h3>
<p><strong>1. 递归过深</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">factorial</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>{
    <span class="hljs-keyword">return</span> n == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : n * <span class="hljs-built_in">factorial</span>(n - <span class="hljs-number">1</span>);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">factorial</span>(<span class="hljs-number">100000</span>);  <span class="hljs-comment">// 栈溢出</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>每次递归调用都会压入新栈帧，深度过大会耗尽栈空间。</p>
<p><strong>2. 大型局部变量</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">large_local</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> arr[<span class="hljs-number">10000000</span>];  <span class="hljs-comment">// 约 40MB，超过默认栈大小</span>
    arr[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
}
</code></pre>
<h3 data-id="heading-15">检测与调试</h3>
<p>栈溢出通常表现为 Segmentation Fault。使用 GDB 调试时，<code>backtrace</code> 会显示调用栈：</p>
<pre><code class="hljs language-bash" lang="bash">gdb ./program
(gdb) run
(gdb) backtrace  <span class="hljs-comment"># 查看调用栈深度</span>
</code></pre>
<h3 data-id="heading-16">预防策略</h3>
<ol>
<li><strong>改用循环</strong>：将递归转为迭代</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">factorial</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>{
    <span class="hljs-type">int</span> result = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">2</span>; i &lt;= n; ++i) {
        result *= i;
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<ol start="2">
<li><strong>使用堆内存</strong>：大数组放堆上</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">large_heap</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> arr = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>[]&gt;(<span class="hljs-number">10000000</span>);  <span class="hljs-comment">// 堆上分配</span>
}
</code></pre>
<h2 data-id="heading-17">悬空指针与野指针</h2>
<p>悬空指针和野指针都指向无效内存，但产生原因不同。</p>
<h3 data-id="heading-18">悬空指针 (Dangling Pointer)</h3>
<p>悬空指针指向已释放的内存。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span>* ptr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">42</span>);
<span class="hljs-keyword">delete</span> ptr;
*ptr = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 悬空指针，访问已释放的内存</span>
</code></pre>
<p><strong>Use-After-Free 漏洞</strong>：在安全领域，悬空指针引发的漏洞称为 UAF，攻击者可利用已释放内存被重新分配后的内容进行攻击。</p>
<h3 data-id="heading-19">野指针 (Wild Pointer)</h3>
<p>野指针未初始化，指向随机内存地址。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span>* ptr;  <span class="hljs-comment">// 未初始化</span>
*ptr = <span class="hljs-number">42</span>;  <span class="hljs-comment">// 野指针，指向未知地址</span>
</code></pre>
<h3 data-id="heading-20">区别对比</h3>

























<table><thead><tr><th>特性</th><th>悬空指针</th><th>野指针</th></tr></thead><tbody><tr><td>产生原因</td><td>内存已释放</td><td>未初始化</td></tr><tr><td>指向内容</td><td>已释放的内存</td><td>随机地址</td></tr><tr><td>典型场景</td><td>delete 后未置空</td><td>声明时未赋值</td></tr></tbody></table>
<h2 data-id="heading-21">缓冲区溢出 (Buffer Overflow)</h2>
<p>缓冲区溢出指写入数据超出缓冲区边界，覆盖相邻内存。</p>
<h3 data-id="heading-22">溢出类型</h3>
<p><strong>栈缓冲区溢出</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">stack_overflow</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">8</span>];
    <span class="hljs-built_in">strcpy</span>(buffer, <span class="hljs-string">"This string is too long"</span>);  <span class="hljs-comment">// 写入超过 8 字节</span>
}
</code></pre>
<p>数据溢出到相邻栈帧，可能覆盖返回地址，导致：</p>
<ul>
<li>程序崩溃</li>
<li>返回到错误地址</li>
<li>被攻击者利用执行恶意代码（ROP 攻击）</li>
</ul>
<p><strong>堆缓冲区溢出</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">heap_overflow</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">char</span>* buffer = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-number">8</span>];
    <span class="hljs-built_in">strcpy</span>(buffer, <span class="hljs-string">"This string is too long"</span>);  <span class="hljs-comment">// 溢出到堆的相邻块</span>
    <span class="hljs-keyword">delete</span>[] buffer;
}
</code></pre>
<p>覆盖堆元数据，导致：</p>
<ul>
<li>后续内存分配/释放崩溃</li>
<li>堆损坏(Heap Corruption)</li>
</ul>
<h3 data-id="heading-23">安全隐患</h3>
<p>缓冲区溢出是经典的安全漏洞，可被利用进行：</p>
<ul>
<li>代码注入(Code Injection)</li>
<li>返回导向编程(Return-Oriented Programming, ROP)</li>
<li>绕过安全检查</li>
</ul>
<h3 data-id="heading-24">预防方法</h3>
<ol>
<li><strong>使用安全函数</strong>：</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">char</span> buffer[<span class="hljs-number">8</span>];
<span class="hljs-built_in">strncpy</span>(buffer, input, <span class="hljs-built_in">sizeof</span>(buffer) - <span class="hljs-number">1</span>);  <span class="hljs-comment">// 限制长度</span>
buffer[<span class="hljs-built_in">sizeof</span>(buffer) - <span class="hljs-number">1</span>] = <span class="hljs-string">'\0'</span>;  <span class="hljs-comment">// 确保终止</span>
</code></pre>
<ol start="2">
<li><strong>使用 C++ 标准容器</strong>：</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp">std::string str = <span class="hljs-string">"任意长度字符串"</span>;  <span class="hljs-comment">// 自动管理边界</span>
</code></pre>
<ol start="3">
<li><strong>编译器保护</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">g++ -fstack-protector-all  <span class="hljs-comment"># 栈保护</span>
g++ -D_FORTIFY_SOURCE=2    <span class="hljs-comment"># 运行时检查</span>
</code></pre>
<h2 data-id="heading-25">双重释放 (Double Free)</h2>
<p>双重释放指同一块内存被 <code>delete</code> 或 <code>free</code> 多次，导致堆损坏。</p>
<h3 data-id="heading-26">典型场景</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span>* ptr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">42</span>);
<span class="hljs-keyword">delete</span> ptr;
<span class="hljs-keyword">delete</span> ptr;  <span class="hljs-comment">// 双重释放，未定义行为</span>
</code></pre>
<h3 data-id="heading-27">危害机制</h3>
<p>内存管理器维护堆的元数据（已分配/空闲块列表）。第一次 <code>delete</code> 将内存标记为空闲，第二次 <code>delete</code> 会：</p>
<ol>
<li>尝试释放已在空闲列表中的块</li>
<li>破坏元数据结构</li>
<li>后续的 <code>new</code> 或 <code>delete</code> 崩溃</li>
</ol>
<p>实际影响：</p>
<ul>
<li>程序崩溃（常见）</li>
<li>内存泄漏（元数据损坏导致）</li>
<li>安全漏洞（被攻击者利用修改堆元数据）</li>
</ul>
<h3 data-id="heading-28">预防方法</h3>
<ol>
<li><strong>释放后置空</strong>：</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">delete</span> ptr;
ptr = <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 对 nullptr delete 是安全的</span>
</code></pre>
<ol start="2">
<li><strong>明确所有权</strong>：</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp">std::unique_ptr&lt;<span class="hljs-type">int</span>&gt; ptr = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">42</span>);
<span class="hljs-comment">// 所有权唯一，不会重复释放</span>
</code></pre>
<ol start="3">
<li><strong>禁用拷贝</strong>：</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Resource</span> {
    <span class="hljs-type">int</span>* data;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Resource</span>(<span class="hljs-type">const</span> Resource&amp;) = <span class="hljs-keyword">delete</span>;  <span class="hljs-comment">// 禁止拷贝</span>
    Resource&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> Resource&amp;) = <span class="hljs-keyword">delete</span>;
};
</code></pre>
<h2 data-id="heading-29">内存碎片 (Memory Fragmentation)</h2>
<p>内存碎片指空闲内存无法有效利用，分为外部碎片和内部碎片。</p>
<h3 data-id="heading-30">外部碎片 (External Fragmentation)</h3>
<p>空闲内存分散在多个小块中，无法满足大块连续内存的分配请求。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 假设有 100MB 空闲内存，分散在 1000 个 100KB 的小块中</span>
<span class="hljs-type">int</span>* large = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];  <span class="hljs-comment">// 分配 200MB 失败，虽然总空闲足够</span>
</code></pre>
<p><strong>原因</strong>：频繁分配和释放不同大小的内存块。</p>
<h3 data-id="heading-31">内部碎片 (Internal Fragmentation)</h3>
<p>分配的内存块大于实际需求，多余部分浪费。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 内存分配器按 16 字节对齐</span>
<span class="hljs-type">char</span>* ptr = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-number">9</span>];  <span class="hljs-comment">// 实际分配 16 字节，浪费 7 字节</span>
</code></pre>
<p><strong>原因</strong>：内存对齐或分配器最小块大小限制。</p>
<h3 data-id="heading-32">性能影响</h3>
<ul>
<li><strong>分配失败</strong>：外部碎片导致大块内存分配失败</li>
<li><strong>内存浪费</strong>：内部碎片降低内存利用率</li>
<li><strong>分配变慢</strong>：内存分配器需要搜索合适的空闲块</li>
</ul>
<h3 data-id="heading-33">缓解策略</h3>
<ol>
<li><strong>内存池(Memory Pool)</strong>：预分配固定大小的块</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pool</span> {
    std::vector&lt;<span class="hljs-type">void</span>*&gt; free_list;
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>{
        <span class="hljs-keyword">return</span> free_list.<span class="hljs-built_in">empty</span>() ? ::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(size) : free_list.<span class="hljs-built_in">back</span>();
    }
};
</code></pre>
<ol start="2">
<li><strong>对象池(Object Pool)</strong>：复用同类对象</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp">std::vector&lt;MyObject*&gt; object_pool;
</code></pre>
<ol start="3">
<li><strong>减少分配/释放频率</strong>：一次分配大块，手动管理</li>
</ol>
<h2 data-id="heading-34">内存对齐问题 (Memory Alignment)</h2>
<p>内存对齐指数据存储在特定对齐边界的地址上，未对齐访问会降低性能或崩溃。</p>
<h3 data-id="heading-35">为什么需要对齐</h3>
<p>CPU 访问内存时，按字长(Word Size)读取数据。未对齐的数据需要多次读取后拼接，效率低。某些架构（如 ARM）强制对齐，否则触发硬件异常。</p>
<p><strong>示例</strong>：64 位系统要求 8 字节对齐</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 地址 0x1000：对齐，一次读取</span>
<span class="hljs-type">int64_t</span>* aligned = (<span class="hljs-type">int64_t</span>*)<span class="hljs-number">0x1000</span>;

<span class="hljs-comment">// 地址 0x1003：未对齐，需要两次读取</span>
<span class="hljs-type">int64_t</span>* unaligned = (<span class="hljs-type">int64_t</span>*)<span class="hljs-number">0x1003</span>;
</code></pre>
<h3 data-id="heading-36">结构体对齐</h3>
<p>编译器会自动填充结构体以满足对齐要求：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Unoptimized</span> {
    <span class="hljs-type">char</span> a;    <span class="hljs-comment">// 1 字节</span>
    <span class="hljs-comment">// 填充 3 字节</span>
    <span class="hljs-type">int</span> b;     <span class="hljs-comment">// 4 字节</span>
    <span class="hljs-type">char</span> c;    <span class="hljs-comment">// 1 字节</span>
    <span class="hljs-comment">// 填充 3 字节</span>
};  <span class="hljs-comment">// 总大小 12 字节</span>

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Optimized</span> {
    <span class="hljs-type">int</span> b;     <span class="hljs-comment">// 4 字节</span>
    <span class="hljs-type">char</span> a;    <span class="hljs-comment">// 1 字节</span>
    <span class="hljs-type">char</span> c;    <span class="hljs-comment">// 1 字节</span>
    <span class="hljs-comment">// 填充 2 字节</span>
};  <span class="hljs-comment">// 总大小 8 字节</span>
</code></pre>
<h3 data-id="heading-37">C++ 对齐控制</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">alignas</span>(<span class="hljs-number">16</span>) Vec4 {
    <span class="hljs-type">float</span> x, y, z, w;
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-built_in">alignof</span>(Vec4) &lt;&lt; std::endl;  <span class="hljs-comment">// 输出 16</span>
    std::cout &lt;&lt; <span class="hljs-built_in">sizeof</span>(Vec4) &lt;&lt; std::endl;   <span class="hljs-comment">// 输出 16</span>
}
</code></pre>
<h3 data-id="heading-38">调试对齐问题</h3>
<p>使用 <code>-Wpadded</code> 编译选项检查结构体填充：</p>
<pre><code class="hljs language-bash" lang="bash">g++ -Wpadded program.cpp
</code></pre>
<h2 data-id="heading-39">多线程内存冲突</h2>
<p>多线程同时访问共享内存，未正确同步会导致数据竞争(Data Race)和未定义行为。</p>
<h3 data-id="heading-40">数据竞争</h3>
<p>多个线程同时访问同一内存位置，至少一个是写操作，且没有同步机制。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> counter = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; ++i) {
        ++counter;  <span class="hljs-comment">// 非原子操作：读-改-写</span>
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(increment)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(increment)</span></span>;
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    std::cout &lt;&lt; counter &lt;&lt; std::endl;  <span class="hljs-comment">// 结果不确定，可能小于 2000000</span>
}
</code></pre>
<h3 data-id="heading-41">原子操作</h3>
<p>使用 <code>std::atomic</code> 保证操作原子性：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">std::atomic&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">counter</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; ++i) {
        counter.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);  <span class="hljs-comment">// 原子操作</span>
    }
}
</code></pre>
<h3 data-id="heading-42">互斥锁</h3>
<p>保护临界区(Critical Section)：</p>
<pre><code class="hljs language-cpp" lang="cpp">std::mutex mtx;
<span class="hljs-type">int</span> shared_data = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
    shared_data++;  <span class="hljs-comment">// 加锁保护</span>
}
</code></pre>
<h3 data-id="heading-43">线程安全的内存管理</h3>
<p>智能指针在多线程中的使用：</p>
<pre><code class="hljs language-cpp" lang="cpp">std::shared_ptr&lt;<span class="hljs-type">int</span>&gt; ptr = std::<span class="hljs-built_in">make_shared</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">42</span>);

<span class="hljs-comment">// 引用计数是原子的，但指向的数据不是</span>
<span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">([ptr]() { *ptr = <span class="hljs-number">10</span>; })</span></span>;  <span class="hljs-comment">// 数据竞争</span>
<span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">([ptr]() { *ptr = <span class="hljs-number">20</span>; })</span></span>;  <span class="hljs-comment">// 需要额外同步</span>
</code></pre>
<p><strong>关键原则</strong>：智能指针的引用计数线程安全，但指向的内容需要手动同步。</p>
<h2 data-id="heading-44">检测与预防策略</h2>
<p>综合使用静态分析、动态检测和编码规范，可有效预防和定位内存异常。</p>
<h3 data-id="heading-45">静态分析工具</h3>
<p>编译阶段检测潜在问题：</p>
<p><strong>Clang Static Analyzer</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">clang++ --analyze program.cpp
</code></pre>
<p><strong>Cppcheck</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">cppcheck --<span class="hljs-built_in">enable</span>=all program.cpp
</code></pre>
<p>静态分析可发现：未初始化变量、内存泄漏路径、缓冲区溢出等。</p>
<h3 data-id="heading-46">动态检测工具</h3>
<p>运行时检测实际内存错误：</p>
<p><strong>AddressSanitizer (ASan)</strong>：最常用，性能开销低</p>
<pre><code class="hljs language-bash" lang="bash">g++ -fsanitize=address -g program.cpp
./a.out
</code></pre>
<p>检测：UAF、缓冲区溢出、双重释放、内存泄漏。</p>
<p><strong>Valgrind (Memcheck)</strong>：功能全面但较慢</p>
<pre><code class="hljs language-bash" lang="bash">valgrind --leak-check=full ./program
</code></pre>
<p><strong>ThreadSanitizer (TSan)</strong>：检测数据竞争</p>
<pre><code class="hljs language-bash" lang="bash">g++ -fsanitize=thread -g program.cpp
</code></pre>
<h3 data-id="heading-47">现代 C++ 最佳实践</h3>
<p><strong>RAII (Resource Acquisition Is Initialization)</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::unique_ptr&lt;<span class="hljs-type">int</span>[]&gt; <span class="hljs-title">data</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[<span class="hljs-number">1000</span>])</span></span>;
    <span class="hljs-comment">// 自动释放，无泄漏风险</span>
}
</code></pre>
<p><strong>智能指针替代裸指针</strong>：</p>
<ul>
<li><code>unique_ptr</code>：独占所有权</li>
<li><code>shared_ptr</code>：共享所有权</li>
<li><code>weak_ptr</code>：打破循环引用</li>
</ul>
<p><strong>容器替代数组</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">std::vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">v</span><span class="hljs-params">(<span class="hljs-number">1000</span>)</span></span>;  <span class="hljs-comment">// 自动管理内存</span>
</code></pre>
<h3 data-id="heading-48">编码规范</h3>
<ol>
<li><strong>初始化所有指针</strong>：避免野指针</li>
<li><strong>释放后置空</strong>：避免悬空指针</li>
<li><strong>明确所有权</strong>：避免双重释放</li>
<li><strong>避免手动内存管理</strong>：优先使用 RAII</li>
<li><strong>Code Review</strong>：团队互查代码</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 Vibe Coding 元年：AI 编程的技术突破全景]]></title>    <link>https://juejin.cn/post/7589466706377965604</link>    <guid>https://juejin.cn/post/7589466706377965604</guid>    <pubDate>2025-12-30T08:46:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589466706377965604" data-draft-id="7589466238239572010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 Vibe Coding 元年：AI 编程的技术突破全景"/> <meta itemprop="keywords" content="VibeCoding,年终总结"/> <meta itemprop="datePublished" content="2025-12-30T08:46:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Delroy"/> <meta itemprop="url" content="https://juejin.cn/user/184373682644119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 Vibe Coding 元年：AI 编程的技术突破全景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373682644119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Delroy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:46:04.000Z" title="Tue Dec 30 2025 08:46:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 年，<strong>Vibe Coding</strong>（对话式编程）正式从概念走向成熟。这一年，AI 编程从"会补全代码的 Copilot"跨越到"能接管项目的 Agent"，开发者与 AI 的协作方式发生了历史性变革——从逐行敲代码，到用自然语言"聊"出整个项目。</p>
<p>这不仅是 <strong>Vibe Coding 元年</strong>，更是 AI 编程技术生态大爆发的一年：推理模型平民化、Agentic IDE 崛起、Spec 驱动开发成型。让我们回顾这一年的关键技术节点，看看 Vibe Coding 如何重塑软件开发的未来。</p>
<hr/>
<h2 data-id="heading-0">一、年度主线：从补全代码到接管项目</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8476d0e019994ed38cd7aab084cdf1b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGVscm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767689471&amp;x-signature=3rqk0usk14KHrZgAG0nAou699GA%3D" alt="image.png" loading="lazy"/></p>
<p>用一条主线串起全文：</p>
<ul>
<li><strong>2023–2024 年</strong>：AI 主要做 <strong>代码补全 / 问答</strong>，更多像“高级自动完成”。</li>
<li><strong>2025 年</strong>：AI 开始做 <strong>需求理解、任务规划、代码实现、测试、重构</strong> 的闭环，变成真正的“虚拟软件工程师”。</li>
<li><strong>下半年开始</strong>：行业从“聊着写”（Vibe Coding）走向“写完再干”（Spec &amp; Skills 编程）。</li>
</ul>
<p>全文围绕<strong>四条脉络</strong>展开：</p>
<ol>
<li><strong>推理模型平民化</strong>：o3 / DeepSeek V3 系列。</li>
<li><strong>IDE 代理人革命</strong>：Cursor / Windsurf / Copilot Workspace。</li>
<li><strong>Spec 驱动开发崛起</strong>：Kiro / OpenSpec。</li>
<li><strong>Skill 驱动 Agent</strong>：Claude Skills / Agent Skills。</li>
</ol>
<hr/>
<h2 data-id="heading-1">二、按时间线梳理 2025 关键节点</h2>
<h3 data-id="heading-2">Q1：推理模型的平民化</h3>
<p><strong>关键词：o3-mini、DeepSeek V3、算力普惠</strong></p>
<h4 data-id="heading-3">1. 1 月 31 日 – OpenAI o3-mini 发布</h4>
<p>o3-mini 被定位为高效推理模型，在编程竞赛（如 Codeforces Elo）上达到强竞争水平，被视作“日常开发可用的深度思考模型”。 相比早期高延迟的深度推理模型，o3-mini 把“深度思考”拉进了秒级响应，减少了中断心流的等待时间，对 Vibe Coding 体验影响巨大。</p>
<h4 data-id="heading-4">2. DeepSeek V3 / R1 带来的价格冲击</h4>
<p>DeepSeek V3 在 2024 年底开源并在 2025 年持续演进，提供了在代码任务上极具竞争力的性能，同时保持极低推理成本。 对个人开发者和小团队来说，这意味着可以在代码审查、长文档理解、整仓级重构上“放手用”，不再过度担心 Token 花费。</p>
<h4 data-id="heading-5">3. Claude 系列的持续迭代</h4>
<p>Claude 3.x / 3.5 在 2025 年初仍是代码理解和安全约束方面的标杆，给后来的 Claude 4 系列打下基础。</p>
<hr/>
<h3 data-id="heading-6">Q2：IDE 的代理人革命</h3>
<p><strong>关键词：Windsurf、Copilot Workspace、o3 / o3-pro</strong></p>
<h4 data-id="heading-7">1. 4 月中旬 – OpenAI o3 &amp; o4-mini 正式登场</h4>
<p>o3 被描述为“新一代深度推理模型”，在软件工程基准 SWE-bench 等任务上表现突出；o4-mini 覆盖了大量日常开发需求。 这代模型开始原生支持更复杂的函数调用和结构化输出，为 Agent 在 IDE 内做多步计划和执行提供了基础能力。</p>
<h4 data-id="heading-8">2. 5 月 – Windsurf：Agentic IDE 成型</h4>
<p>Windsurf（前 Codeium）在 2025 年推出了侧重多步自动化的 <strong>Cascade / Turbo 模式</strong>，允许 AI 主动读取代码库、规划变更、执行修改，而不仅仅是在单个文件里补代码。 这一设计让“让 AI 修复整个项目的 TypeScript 报错”这类需求变成现实，被称为“Agentic IDE”的重要里程碑。</p>
<h4 data-id="heading-9">3. 5 月 30 日前后 – GitHub Copilot Workspace 面向更多用户开放</h4>
<p>Copilot Workspace 把“写代码”抽象成“<strong>提出问题 / Issue → 生成计划 → 自动实现 / 提交 PR</strong>”的流水线，让开发者更多处于产品与设计决策层，而非底层实现细节层。 对很多团队来说，这是第一次在官方产品中体验“只写需求，不打开编辑器也能出代码”的模式。</p>
<h4 data-id="heading-10">4. 6 月 10 日 – OpenAI o3-pro 发布</h4>
<p>o3-pro 作为高端版本，提供更稳定的推理结果和更大的上下文窗口，被 Cursor、Windsurf 等高阶 IDE 集成为“后端大脑”。</p>
<hr/>
<h3 data-id="heading-11">Q3：巨头巅峰与 Vibe 平台混战</h3>
<p><strong>关键词：Claude 4.1、DeepSeek V3.1、Bolt.new、v0.app</strong></p>
<h4 data-id="heading-12">1. 8 月初 – Claude 4.1 &amp; Claude Code 工作空间</h4>
<p>Claude 4.1（及其高端变体）在代码生成、重构和长上下文理解方面表现极强，被不少工程师视为“复杂后端和系统设计首选模型”。 与之配套的 <strong>Claude Code</strong> 工作空间强调“项目级协作”，可对整仓库进行重构、文档生成和测试分析，推动了“在浏览器里完成整套开发闭环”的趋势。</p>
<h4 data-id="heading-13">2. 8 月 19 日 – DeepSeek V3.1 发布</h4>
<p>V3.1 在推理质量和代码能力上明显提升，同时保持极具优势的价格，使得其在个人和中小团队中的采用率迅速上升。 大参数量与高效推理结合，使其在很多评测中对闭源商用模型形成有力冲击，也带动了本地和私有部署方案的兴起。</p>
<h4 data-id="heading-14">3. Bolt.new vs v0.app：Vibe Coding 平台战火升温</h4>
<ul>
<li><strong>Bolt.new</strong> 主打“全栈生成 + 一键部署”，适合从零到一快速搭建可运行产品；</li>
<li><strong>v0.app</strong> 则在高保真 UI 生成和交互设计上更具优势。</li>
</ul>
<p>很多工程师形成了“缝合流”工作流：用 v0 生成界面，再交给 Bolt 或本地 IDE / Agent 填充业务逻辑。</p>
<hr/>
<h3 data-id="heading-15">Q4：完全体智能体与本地生态</h3>
<p><strong>关键词：Cursor 2.0、DeepSeek V3.2、Trae IDE</strong></p>
<h4 data-id="heading-16">1. Cursor 2.0：Vibe Coding 的终极形态</h4>
<p>Cursor 在 2025 年下半年发布了 2.0 版本，引入更强的内置模型（Composer 2.0）以及多智能体并行能力，可以让多个 Agent 在不同分支 / 子任务上同时工作。 借助更好长上下文支持和 Git Worktree 隔离等机制，AI 可以在后台大幅度重构代码而不干扰开发者当前的编辑状态。</p>
<h4 data-id="heading-17">2. 11 月 30 日 – DeepSeek V3.2 发布</h4>
<p>V3.2 在工具调用和“显式思考”结合上做了增强，让模型在执行终端命令、API 调用前会进行更清晰的推理和安全检查，降低高风险操作误用概率。 这类设计对“让 AI 真正执行命令”的场景格外重要，是向“可托管 Agent”迈进的一大步。</p>
<h4 data-id="heading-18">3. Trae IDE：本地化 Agent IDE 的崛起</h4>
<p>Trae 在 2025 年多次更新，强化了与多家模型（如国际大模型与中文生态模型）的集成，并提供项目级协作和代码审查自动化能力。 其在中文语境、国内云平台集成等方面的优化，使其成为国产智能 IDE 阵营中颇具代表性的一个。</p>
<hr/>
<h2 data-id="heading-19">三、Spec 编程：从"聊着写"到"写完再聊"</h2>
<p><strong>关键词：Kiro、OpenSpec、Spec-Driven Development</strong></p>
<h3 data-id="heading-20">1. Kiro：把 Spec 驱动做成产品级 IDE</h3>
<h4 data-id="heading-21">8 月中 – Amazon 推出 Kiro：Spec-Driven Agentic IDE</h4>
<p>Kiro 被定位为"从原型到生产"的 Agentic 开发平台，核心理念是：<strong>先写 Spec，再由 Agent 按 Spec 规划和实现代码</strong>。</p>
<p>在 AWS re:Invent 2025 相关分享中，Kiro 被用来演示完整的 Spec-Driven 开发流程：需求 → 规格 → 实现 → 测试 → 部署，全程由 Agent 驱动。</p>
<h4 data-id="heading-22">Kiro Specs：把需求写进机器可执行的规格书</h4>
<p>Specs 文档将 User Story、接口设计、状态流、验收标准等内容以结构化方式写在一起，既供人类阅读，也供 Agent 解析和执行。</p>
<p>Agent 在 Kiro 中会依照 Spec 拆分任务、生成代码并运行测试，大幅减少"聊着聊着跑偏"的情况，使 AI 更像遵守开发规范的团队成员。</p>
<h4 data-id="heading-23">Vibe vs Spec 的典型对比</h4>
<ul>
<li><strong>Vibe 模式</strong>：需求散落在聊天记录里，每次要靠回顾对话找上下文</li>
<li><strong>Spec 模式</strong>：一份可版本控制的 Spec 文件成为单一真相来源（Single Source of Truth），AI 的行为被固化在这份规格之中</li>
</ul>
<h3 data-id="heading-24">2. OpenSpec：把 Spec 抽象成公共"协议层"</h3>
<h4 data-id="heading-25">8 月起 – OpenSpec 项目活跃，提出通用 Spec-Driven 框架</h4>
<p>OpenSpec 项目旨在为 AI 编程助手提供轻量、可移植的 Spec 定义方式，让各种编辑器和 Agent 共用同一套规格描述。</p>
<p>它采用 Markdown / 文本 + 约定式结构，让 Spec 既可手写，也可由模型生成或修改。</p>
<h4 data-id="heading-26">典型工作流：Proposal → Apply → Archive</h4>
<ul>
<li><strong>Proposal</strong>：为某一功能或变更生成机器可读的"开发说明书"</li>
<li><strong>Apply</strong>：AI 助手严格按照 Spec 执行修改、生成代码和测试</li>
<li><strong>Archive</strong>：完成后将 Spec 与变更结果一并归档，成为项目的活文档和审计记录</li>
</ul>
<p>这一模式被不少开发者视为"为 AI 写 PRD"，把 AI 变成真正受规格约束的执行者。</p>
<h4 data-id="heading-27">从 IDE 功能到生态基础设施</h4>
<p>与 Kiro 内建的 Spec 模式不同，OpenSpec 更像一个跨工具的协议层，使 Cursor、Claude Code、Cline 等多个工具可以共享同样的规格书。</p>
<hr/>
<h2 data-id="heading-28">四、Skill 编程：给 Agent 写"行为规格"</h2>
<p><strong>关键词：Claude Skills / Agent Skills</strong></p>
<p>如果说 Kiro / OpenSpec 管的是"项目规格（Feature Spec）"，那么 Claude Skills 管的就是"行为规格（Behavior Spec / Agent Skills）"。</p>
<h3 data-id="heading-29">Claude Skills：可编程的 Agent 小技能</h3>
<h4 data-id="heading-30">10 月中 – Claude Skills / Agent Skills 对外可用</h4>
<p>2025 年 10 月前后，Claude Skills（又称 Agent Skills）逐步开放给开发者，用于定义 Claude 在特定场景下的可复用行为模块。</p>
<p>初期就有围绕文档处理、自动化报表、创意生成、工作流编排等技能被整理成"Skill 包"，形成了面向不同角色的工具集。</p>
<h4 data-id="heading-31">Skill 的本质：行为级别的 Spec</h4>
<p>一个 Skill 通常包含说明文档（如 <code>SKILL.md</code>）和实现逻辑（脚本、API 配置等），定义了触发条件、输入输出和执行步骤。</p>
<p>当用户发起适配某 Skill 的请求时，Claude 不再靠一次次零散的 Prompt，而是按 Skill 中的流程规范执行，保证行为的一致性和可审计性。</p>
<h4 data-id="heading-32">项目规格 vs 行为规格</h4>
<ul>
<li><strong>项目规格（Kiro / OpenSpec）</strong> ：定义"要做什么、做成什么样"</li>
<li><strong>行为规格（Claude Skills）</strong> ：定义"怎么做、按什么流程做"</li>
</ul>
<p>两者结合后，一个典型流程会变成：先用 OpenSpec / Kiro 写清楚需求，再让具备特定 Skills 的 Claude / IDE Agent 来执行规格。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d6b9dfbd8bb4babac2aab3a7f9381f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGVscm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767689471&amp;x-signature=syPeh1vP5NTdTFv4lly18FdKiGM%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bf09378ab554ea1b67308101e3d8058~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGVscm95:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767689471&amp;x-signature=DXqC%2B40hLtKRv9eW9JypbPzjJNQ%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-33">五、2025 带来的三重认知升级</h2>
<h3 data-id="heading-34">1. 从 Syntax 到 Semantics</h3>
<p>模型已经足够理解语法和框架细节，开发者越来越多把精力放在<strong>业务语义、领域知识和产品体验</strong>上。</p>
<h3 data-id="heading-35">2. Prompt Engineering 已死，Context &amp; Spec 永生</h3>
<p>与其纠结一句 Prompt 该怎么写，不如把需求、约束和流程写成可复用的 Spec / Skill，让 AI 在清晰的边界里工作。</p>
<h3 data-id="heading-36">3. Vibe Coding 成为日常，Spec &amp; Skills 成为"上线级工程"标配</h3>
<ul>
<li><strong>Vibe Coding</strong> 依旧是探索和原型阶段最爽的方式</li>
<li>一旦进入多人协作和生产级项目，<strong>Spec 驱动与 Skill 驱动</strong>开始成为"让 AI 真正进团队"的基础设施</li>
</ul>
<hr/>
<h2 data-id="heading-37">结语</h2>
<p>2025 年，我们见证了 AI 编程从"辅助工具"到"协作伙伴"的历史性跨越。从年初 o3-mini 的发布，到年中 Windsurf、Copilot Workspace 的革新，再到下半年 Kiro、OpenSpec、Claude Skills 的崛起——这一年的每个节点，都在重新定义"编程"这件事的边界。</p>
<p><strong>展望 2026</strong>：如果你的团队还在纠结要不要用 AI，那已经晚了一步。真正的问题是：<strong>你要不要为团队建立一套 Spec / Skills 能力栈，让 AI 不只是个聊天机器人，而是一个真正能接管项目、遵守规范的虚拟团队成员？</strong></p>
<p>这不是技术的选择，而是生产力革命的入场券。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网站/接口可用性拨测最佳实践]]></title>    <link>https://juejin.cn/post/7589466356779761716</link>    <guid>https://juejin.cn/post/7589466356779761716</guid>    <pubDate>2025-12-30T10:21:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589466356779761716" data-draft-id="7589445154534441012" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网站/接口可用性拨测最佳实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T10:21:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网站/接口可用性拨测最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T10:21:34.000Z" title="Tue Dec 30 2025 10:21:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>可用性监测是观测云提供的综合性在线服务监控方案。它通过创建无需编写代码的 API，利用全球分布的监测点模拟真实用户在不同地区和网络环境下的访问体验。这种监测不仅涵盖网络质量、网站性能、关键端点等关键业务场景，还提供了对用户使用体验等多维度性能指标的周期性监控。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc95941ac46f401c8f5ce01a3219c284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=mDImEHfUJW1GQYUvJgWr6gJqn8k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">应用场景</h2>
<ul>
<li>多协议支持：基于 HTTP、TCP、ICMP、WEBSOCKET 协议创建拨测任务，多方面主动监控在线业务的可用性和性能；</li>
<li>全球网络监控：利用观测云遍布全球的监测点，即时监测网络性能，保障全球服务的可用性和性能表现；</li>
<li>网络站点访问性能分析：从地理纬度和可用性趋势两个方面，分析网络站点的可用性性能；</li>
<li>实时告警通知：基于拨测任务产生的数据配置告警规则，当业务出现异常，会基于规则以邮件、钉钉机器人等方式发送告警通知。</li>
</ul>
<h2 data-id="heading-2">实践步骤</h2>
<h3 data-id="heading-3">1、创建拨测任务</h3>
<ul>
<li>在<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.guance.com%2F" target="_blank" title="https://console.guance.com/" ref="nofollow noopener noreferrer">观测云</a>的「可用性监测」功能中，新建拨测任务，这里以 API 拨测为例。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa648bfb4ce49d69b807298426369ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=k9fMfYxIX4Zeq%2BGuHaPyBXiwIUE%3D" alt="" loading="lazy"/></p>
<ul>
<li>选择拨测类型，填写目标 URL 和判断条件。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96e3ece53bc840bd9fed39984ebf45c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=pj0%2BEfg9aC%2FZt%2B%2FR5P788elAU0w%3D" alt="" loading="lazy"/></p>
<ul>
<li>按需选择发送拨测的节点，以及拨测频率，点击保存即可。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78dbed8196f14490a9844f72534e7444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=d0xap3LVsq0T854kY6r4HJnNsHU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2、查看效果</h3>
<p>等拨测频率触发后，即可在「可用性监测」的概览和查看器中，即可查看到详细的结果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bde7d999fb91452095cfc7fd586eaef6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=Sx6smQBiRwHtfbVwgTmWRq4pV7A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/650dbf0930c741cebc5e92b276d45d55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=parAUN8B8VjozVy3KXQXQuEHU3Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3、设置告警监控</h3>
<p>当我们希望拨测结果有异常时，能主动告警通知到相关的负责人；我们可以设置<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fmonitoring%2Fmonitor%2F" target="_blank" title="https://docs.guance.com/monitoring/monitor/" ref="nofollow noopener noreferrer">监控器</a>来解决这个问题。</p>
<h4 data-id="heading-6">3.1 新建可用性数据检测</h4>
<p>在观测云的「监控」功能中，新建监控器，选择“可用性数据检测”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15319f7f82f44fd79e257b65bc0f7002~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=EGE4X9UQX7Bp6DhHAZC50nYGAbI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.2 填写检测配置</h4>
<p>按需填写检测频率、检测区间、以及触发的规则。这里表示响应时间大于 100ms 就告警。更多详情，可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fmonitoring%2Fmonitor%2Fmonitor-rule%2F%23general-config" target="_blank" title="https://docs.guance.com/monitoring/monitor/monitor-rule/#general-config" ref="nofollow noopener noreferrer">规则配置</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec646e19d95f41dfb3fcd4ce0d0f7d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=jdpe6SdRhSky7JlC8OGOYBCF6QI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.3 自定义通知内容</h4>
<p>观测云支持自定义告警通知的标题和内容，并且可以使用预置的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fmonitoring%2Fmonitor%2Fevent-template%2F" target="_blank" title="https://docs.guance.com/monitoring/monitor/event-template/" ref="nofollow noopener noreferrer">模板变量</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb7ce5f4bf74bc39f94ba068702278c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=znYd2lLZ54tjzlXj0W36g1zdrW0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.4 选择告警策略</h4>
<p>监控满足触发条件后，支持将告警消息发送给指定的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fmonitoring%2Fnotify-target%2F" target="_blank" title="https://docs.guance.com/monitoring/notify-target/" ref="nofollow noopener noreferrer">通知对象</a>。通知对象包括但不限于：钉钉机器人、企业微信机器人、飞书机器人、Webhook 自定义、短信组、简单 HTTP 请求、Slack、Teams、电话、IM 消息发送等等</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/882798b92f694f4bb792ed438c4d65e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=nkI%2B59%2BQNbVCKeN6jYqT5hrf6uo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">3.5 查看告警结果</h4>
<p>告警触发后，相关通知对象就会收到告警信息，以下是钉钉机器人的告警信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd93a2b3453c45ca96f6319e8a81cf55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767694893&amp;x-signature=PDubhKZyI4Ogz1RowNcww9uqGWY%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Codex中配置使用智谱、Ollama本地模型]]></title>    <link>https://juejin.cn/post/7589262021562073129</link>    <guid>https://juejin.cn/post/7589262021562073129</guid>    <pubDate>2025-12-30T10:28:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589262021562073129" data-draft-id="7589262021562040361" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Codex中配置使用智谱、Ollama本地模型"/> <meta itemprop="keywords" content="VibeCoding"/> <meta itemprop="datePublished" content="2025-12-30T10:28:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三斗米"/> <meta itemprop="url" content="https://juejin.cn/user/3157453124416622"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Codex中配置使用智谱、Ollama本地模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3157453124416622/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三斗米
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T10:28:18.000Z" title="Tue Dec 30 2025 10:28:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>编辑config.toml文件：</p>
<pre><code class="hljs language-js" lang="js"># model_provider = <span class="hljs-string">"wenwen"</span>
# model = <span class="hljs-string">"gpt-5.2"</span>

model_provider = <span class="hljs-string">"glm"</span>
model = <span class="hljs-string">"glm-4.7"</span>

model_reasoning_effort = <span class="hljs-string">"medium"</span>

# 定义 <span class="hljs-title class_">Codex</span> 执行敏感操作（如删除文件、安装包）时是否询问。
approval_policy = <span class="hljs-string">"never"</span>
# 沙箱模式。restricted (受限), danger-full-access (允许 <span class="hljs-variable constant_">AI</span> 完全访问你的本地系统文件和网络)
sandbox_mode = <span class="hljs-string">"danger-full-access"</span>
# 隐私保护。开启后，<span class="hljs-title class_">Codex</span> 不会将对话历史和代码上下文存储在本地日志或云端缓存中。
disable_response_storage = <span class="hljs-literal">true</span>

# --- windows wsl 设置（系统兼容） --- 
windows_wsl_setup_acknowledged = <span class="hljs-literal">true</span>


[model_providers.<span class="hljs-property">glm</span>]
name = <span class="hljs-string">"glm"</span>
base_url=<span class="hljs-string">"https://open.bigmodel.cn/api/coding/paas/v4"</span>
env_key=<span class="hljs-string">"GLM_API_KEY"</span>
wire_api = <span class="hljs-string">"chat"</span>

[model_providers.<span class="hljs-property">wenwen</span>]
name = <span class="hljs-string">"wenwen"</span>
base_url=<span class="hljs-string">"https://code.wenwen-ai.com/v1"</span>
wire_api = <span class="hljs-string">"responses"</span>
requires_openai_auth = <span class="hljs-literal">true</span>

[model_providers.<span class="hljs-property">ollama</span>]
name = <span class="hljs-string">"Ollama"</span>
base_url=<span class="hljs-string">"http://127.0.0.1:11434/v1"</span>
env_key=<span class="hljs-string">"ollama"</span>

# --- 属性 ---
[profiles.<span class="hljs-property">use</span>-glm]
model = <span class="hljs-string">"glm-4.7"</span>
model_provider = <span class="hljs-string">"glm"</span>

[profiles.<span class="hljs-property">use</span>-wenwen]
model = <span class="hljs-string">"gpt-5.2"</span>
model_provider = <span class="hljs-string">"wenwen"</span>

[profiles.<span class="hljs-property">use</span>-ollama]
model = <span class="hljs-string">"deepseek-r1:8b"</span>
model_provider = <span class="hljs-string">"ollama"</span>


[notice]
hide_gpt5_1_migration_prompt = <span class="hljs-literal">true</span>

[features]
# enable_experimental_windows_sandbox = <span class="hljs-literal">true</span>  # 旧版
experimental_windows_sandbox = <span class="hljs-literal">true</span>
streamable_shell = <span class="hljs-literal">true</span>          # enable the streamable exec tool
web_search_request = <span class="hljs-literal">true</span>        # allow the model to request web searches
</code></pre>
<p>切换模型：</p>
<p>使用智谱的模型：</p>
<pre><code class="hljs language-js" lang="js">codex --profile use-glm <span class="hljs-string">"你是谁"</span>
</code></pre>
<p>使用问问的模型：</p>
<pre><code class="hljs language-js" lang="js">codex --profile use-wenwen <span class="hljs-string">"你是谁"</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当 Gemini 3 能写出完美 CSS 时，前端工程师剩下的核心竞争力是什么？]]></title>    <link>https://juejin.cn/post/7588837042014060570</link>    <guid>https://juejin.cn/post/7588837042014060570</guid>    <pubDate>2025-12-29T07:42:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588837042014060570" data-draft-id="7588711557500715058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当 Gemini 3 能写出完美 CSS 时，前端工程师剩下的核心竞争力是什么？"/> <meta itemprop="keywords" content="前端,JavaScript,AI编程"/> <meta itemprop="datePublished" content="2025-12-29T07:42:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当 Gemini 3 能写出完美 CSS 时，前端工程师剩下的核心竞争力是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T07:42:41.000Z" title="Mon Dec 29 2025 07:42:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e61223f0e4442c480467f4c9d58f68a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767598961&amp;x-signature=RYHNyjCzWiDMmV1dT0itPK4taA8%3D" alt="google-gemini-3-inc.webp" loading="lazy"/></p>
<h3 data-id="heading-0">兄弟们，咱们的护城河越来越窄了😭</h3>
<p>Gemini 3 的发布会，大家看了没？</p>
<p>我是在被窝里看完的。看完之后，我直接失眠了。</p>
<p>以前我觉得 AI 写代码也就那样，写个 Todo List 还行，真要上业务逻辑，它就得幻觉给你看😒。</p>
<p>但 Google 秀的这一手，真的有点<strong>不讲武德</strong>。</p>
<p>我出于好奇心，用 <a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2Fapps" target="_blank" title="https://aistudio.google.com/apps" ref="nofollow noopener noreferrer">Google Al Studio</a> 试了一下几个经典的需求, 直接把飞书需求文档扔给它（纯文案）👇：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">Recall landing page
<span class="hljs-number">1</span>. 页脚的recalls跳转新的recall landing page
[图片]
<span class="hljs-number">2</span>. 页面内容
标题：Product Recalls

两个内容模块，点击后跳转至各自详情页
第一个：
<span class="hljs-number">2025</span> Fat Tire Trike Recall Notice
Pedego has issued a safety recall <span class="hljs-keyword">for</span> Fat Tire Trikes due <span class="hljs-keyword">to</span> a potential frame fracture near a weld that may pose fall <span class="hljs-built_in">or</span> injury risks. Affected owners are eligible <span class="hljs-keyword">for</span> a free repair, completed <span class="hljs-keyword">by</span> a local Pedego dealer.
Learn more （可点击，跳转至Fat Tire Trike Recall Page）

第二个：
<span class="hljs-number">2021</span> Cable Recall Notice
Pedego <span class="hljs-built_in">is</span> voluntarily recalling <span class="hljs-keyword">select</span> e-bike models sold <span class="hljs-keyword">from</span> January <span class="hljs-number">2018</span> <span class="hljs-keyword">to</span> August <span class="hljs-number">2020</span> due <span class="hljs-keyword">to</span> a cable issue that may cause unexpected acceleration. Affected owners should <span class="hljs-keyword">stop</span> riding <span class="hljs-built_in">and</span> register <span class="hljs-keyword">for</span> a free safety repair.
Learn more（可点击，跳转至https://www.pedegobikerecall.expertinquiry.com/?_gl=<span class="hljs-number">1</span>*<span class="hljs-number">1</span>hzkwd0*_gcl_au*MTkxNDc4ODEuMTc2MzM0NDUyMA..*_ga*MTM1MzU3NTAzOC4xNzQ1OTE1NTcz*_ga_4K15HG6FFG*czE3NjQ4MzQ5MDAkbzQyJGcwJHQxNzY0ODM0OTAxJGo1OSRsMCRoMA..*_ga_FGPZTS4D91*czE3NjQ4MzQ5MDAkbzQyJGcwJHQxNzY0ODM0OTAxJGo1OSRsMCRoMA..）
[图片]



Fat Tire Trike Recall Page
标题：Pedego Recalls Fat Tire Trike Due <span class="hljs-keyword">to</span> Fall <span class="hljs-built_in">and</span> Laceration Hazards
[插入几张Fat Tire Trike图片]
 
页面主体内容
Name <span class="hljs-keyword">of</span> Product: Pedego Fat Tire Trike
<span class="hljs-symbol">Hazard:</span> The trike frame can develop a hairline fracture near a weld, which can cause the tube <span class="hljs-keyword">to</span> break, posing fall <span class="hljs-built_in">and</span> laceration hazards. 
Units Affected: Serial Number Range: D2312050001 - D2312050522 
 
按钮：REGISTER NOW （点击后跳转至页面下方注册表单）
  
How <span class="hljs-built_in">is</span> Pedego making this right? 
Pedego <span class="hljs-built_in">is</span> offering you a free repair <span class="hljs-keyword">of</span> your Fat Tire Trike. We have reengineered <span class="hljs-built_in">and</span> strengthened the section <span class="hljs-keyword">of</span> the frame <span class="hljs-keyword">in</span> question. Once you register, we will ship a repair part <span class="hljs-keyword">to</span> a local Pedego dealer that you <span class="hljs-keyword">select</span> <span class="hljs-keyword">using</span> the registration form. 
We will ship the part <span class="hljs-keyword">to</span> the dealer. The Pedego dealer will repair the Fat Tire Trike free <span class="hljs-keyword">of</span> charge. There are no charges <span class="hljs-built_in">or</span> fees associated <span class="hljs-keyword">with</span> this recall. 
You will be contacted <span class="hljs-keyword">when</span> your part <span class="hljs-built_in">is</span> received at the Pedego store <span class="hljs-keyword">for</span> installation.

Make sure that other members <span class="hljs-keyword">of</span> your household also know about the recall <span class="hljs-built_in">and</span> immediately <span class="hljs-keyword">stop</span> <span class="hljs-keyword">using</span> it. Secure your Fat Tire Trike so that it cannot be ridden <span class="hljs-keyword">until</span> it <span class="hljs-built_in">is</span> repaired.
We strongly encourage you <span class="hljs-keyword">to</span> participate <span class="hljs-built_in">and</span> contact us <span class="hljs-keyword">to</span> obtain a free repair.
 
Register <span class="hljs-keyword">for</span> the free repair <span class="hljs-keyword">of</span> your Fat Tire Trike
First Name*
Last Name*
Email*
Phone number*
Dealer <span class="hljs-keyword">Where</span> you’d <span class="hljs-built_in">like</span> the repair <span class="hljs-keyword">to</span> <span class="hljs-keyword">take</span> place *  [Perhaps Preload options <span class="hljs-built_in">or</span> provide location search <span class="hljs-keyword">for</span> dealer（这里有没有可能提供选项让消费者选择？或者搜索地址？）]
State* 
Zip Code*
Country*
 
[] * I hereby affirm that the information I have provided <span class="hljs-built_in">is</span> accurate <span class="hljs-built_in">and</span> correct, <span class="hljs-built_in">and</span> that I have complied <span class="hljs-keyword">with</span> all requirements <span class="hljs-keyword">of</span> the above-referenced recall <span class="hljs-keyword">for</span> seeking a repair <span class="hljs-keyword">of</span> my Fat Tire Trike.
 
 Submit(提交按钮)

成功提交后显示：
Thank you. Your registration has been submitted <span class="hljs-built_in">and</span> <span class="hljs-built_in">is</span> being processed. 
We will notify you <span class="hljs-keyword">when</span> the parts ship <span class="hljs-keyword">to</span> the dealer. The dealer will install <span class="hljs-built_in">and</span> repair your Fat Tire Trike free <span class="hljs-keyword">of</span> charge. 

[所提交信息在这里展示]
 
Please print this page <span class="hljs-keyword">for</span> your records. 
</code></pre>
<p><strong>我刚准备点根烟的工夫，页面 UI 就出来了👇。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f8303d6113b4392b2b30fa14be1b8a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767598961&amp;x-signature=kx7xtj8wat67uTgf0xxigsh5WW4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7eb998cebc14a4f933c753241eaedc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767598961&amp;x-signature=xU6mjgChbI950RA%2BHZLL97x%2FkZo%3D" alt="image.png" loading="lazy"/></p>
<p>不是那种满屏 <code>div</code> 的垃圾代码，是语义化极好、组件拆分合理、甚至连 <code>dark mode</code> 都给配好了的成品，根本不需要改什么😖。</p>
<p>我看着屏幕上自己刚写了一半、还在纠结 <code>flex-basis</code> 该给多少的样式文件，突然觉得：<strong>这几年的代码，好像白写了。</strong></p>
<p>我最新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Ferpanomer.nurverse.com" target="_blank" title="https://erpanomer.nurverse.com" ref="nofollow noopener noreferrer">个人主页也是用 Gemini 3 </a> 重写的，这审美，这效率，没得说！太强了👏</p>
<hr/>
<h3 data-id="heading-1">切图仔的时代正式终结了</h3>
<p>以前咱总开玩笑说自己是切图仔，其实心里还是有点傲气的： <em>你以为 CSS 容易啊？BFC、层叠上下文、响应式断点、不同内核的兼容性...这玩意儿水深着呢！</em></p>
<p>但 Gemini 3 这种级别的 AI 出来，直接把这层傲气给<strong>降维打击</strong>了。</p>
<ul>
<li><strong>比速度？</strong> 你调一个布局要半小时，它只要 3 秒。</li>
<li><strong>比审美？</strong> 它学习了全球数亿个精美网页，配出的视觉UI 把你那程序员审美甩出几条街。</li>
<li><strong>比稳定性？</strong> 它不会写错单词，也不会漏写分号，更不会因为下午跟产品经理吵了架就故意在代码里埋坑。</li>
</ul>
<p><strong>说实话，在实现视觉稿这件事上，人类已经输了。彻底输了！！！😭</strong></p>
<p>如果你的核心竞争力就是能把 UI 图 1:1 还原成网页，那你的职业生涯确实已经进入倒计时了。</p>
<hr/>
<h3 data-id="heading-2">既然 CSS 成了废话，那我们还剩什么？</h3>
<p>既然 AI 能写出完美的 CSS，甚至连交互动画都能一句话生成，那公司凭啥还花几万块招个前端？</p>
<p>我想了半宿，觉得咱们前端老哥的<strong>保命牌</strong>，其实正在从手艺转向上层建筑：</p>
<h4 data-id="heading-3">培养自己的架构设计能力</h4>
<p>AI 可以给你砌出一面完美的墙，但它不知道这面墙该立在什么位置。</p>
<p>一个大型项目里：</p>
<ul>
<li><strong>组件怎么拆分</strong>最利于复用？</li>
<li><strong>目录结构</strong>怎么设计才不会让后来的人骂娘？</li>
<li><strong>全局状态</strong>是用 Zustand 还是直接原生 Context 梭哈？</li>
</ul>
<p>这些涉及到<strong>工程化决策</strong>的东西，AI 目前还是个弟弟。它只能给你局部的最优解，给不了你全局的架构观。</p>
<h4 data-id="heading-4">处理那些只有人能理解的业务</h4>
<p>AI 最怕的是什么？是<strong>逻辑的混沌</strong>。</p>
<blockquote>
<p>用户如果连续点击三次，要触发一个彩蛋，但如果他是 VIP 且余额不足，这个彩蛋要换成充值提醒，顺便还得防止接口重放。</p>
</blockquote>
<p>这种只有人类产品经理拍脑袋想出来的、逻辑转了十八道弯的边缘 Case，AI 极其容易写出 Bug。</p>
<p>搞定复杂的异步流，搞定恶心的竞态条件，搞定各种各样的降级策略——这才是你领工资的真正理由。</p>
<h4 data-id="heading-5">驾驭 AI 的能力（这应该是 2026 年的高频面试题）</h4>
<p>以前面试问：CSS 怎么实现三角形？</p>
<p>以后面试可能问：如何用一句 Prompt，让 Gemini 3 输出一个符合公司私有 UI 规范、且通过了 E2E 测试的复杂组件？</p>
<p>AI 不是你的敌人，它可是你的好伙伴。</p>
<p>别人还在用手敲代码时，你已经学会利用AI 提升工作效率。你的核心竞争力，就是你 <strong>调教 AI</strong> 的水平。</p>
<hr/>
<h3 data-id="heading-6">没必要焦虑，这是超级个体的开始</h3>
<p>咱们有木有可能换一种思路🤔。</p>
<p>以前我们想做个自己的副业项目，最头疼的是什么？UI 和 CSS。</p>
<p>对于我们这种逻辑强、审美弱的后端型前端，调样式简直是要了亲命。</p>
<p>现在 Gemini 3 这种东西出来了，简直是送福利。</p>
<ul>
<li><strong>后端：</strong> 让 AI 帮你生成 Schema 和基础 CRUD。</li>
<li><strong>UI/CSS：</strong> 丢张草图给 Gemini 3。</li>
<li><strong>前端框架：</strong> 让 AI 帮你写好骨架。</li>
</ul>
<p><strong>你一个人，就是一个超级个体。</strong></p>
<p>以前我们需要在大厂里卷，是因为大厂有资源、有配套。</p>
<p>现在 AI 把资源门槛抹平了。在这个代码非常廉价的时代，你的创意、你的产品意识、你的解决问题能力，反而变得更值钱了。</p>
<hr/>
<p>Gemini 3 确实很猛，猛到让人怀疑人生，猛得一塌糊涂！😖</p>
<p>但我相信，只要互联网还需要服务，前端这个角色就不会消失。它只是从体力活进化成了脑力活。</p>
<p>别纠结那几个 <code>margin</code> 和 <code>padding</code> 了，去研究架构，去深挖性能，去学习怎么让 AI 给你当牛马。</p>
<p><strong>只要你跑得比 AI 进化的速度快，你就不是被淘汰的那一个。</strong></p>
<p>最后默默的问大家一句🤣：</p>
<p>如果明天你的老板让你裁掉团队一半的前端，只留下那些会用 AI 的，你会是在名单里的那个人吗？</p>
<p>欢迎👏顺便说说你被 Gemini 3 惊吓到的瞬间😁。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 小技巧之帮网友理解 SliverConstraints overlap]]></title>    <link>https://juejin.cn/post/7588680081352343588</link>    <guid>https://juejin.cn/post/7588680081352343588</guid>    <pubDate>2025-12-29T02:13:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588680081352343588" data-draft-id="7589083093693464639" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 小技巧之帮网友理解 SliverConstraints  overlap"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-29T02:13:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 小技巧之帮网友理解 SliverConstraints  overlap
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:13:10.000Z" title="Mon Dec 29 2025 02:13:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本期主要是应网友要求，写一个简单解答，其实 <code>SliverConstraints.overlap</code> 并不复杂，因为用起来也很简单，但是如果没正确理解它作用的时候，就会出现类似这位网友的困惑，确实官方的注释写的可能太过抽象，以至于如果你想通过注释理解它的作用，会感觉比较晦涩难懂：</p>







<table><thead><tr><th><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f336d61c32df4f8a9ff39c582e36775b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579189&amp;x-signature=AaHyYVDRhlwfYbx2ajI15qK6Xes%3D" alt="" loading="lazy"/></th><th><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93b1daf6e9ae440b9baa3b5b3dafbe6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579189&amp;x-signature=5Z%2FWPJunRY5gZViCha24KpdI0xk%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>首先 <code>overlap</code> 的<strong>本质就是视觉与布局的“差值”</strong>，它就是一个差值的概念，基于这个核心去理解就会很好明白，简单说， 在 Sliver 协议中需要区分两个概念：</p>
<ul>
<li><strong>Layout Extent（布局范围）</strong>：Sliver 在滚动视图中实际占据的“物理位置”大小，它决定了下一个 Sliver 从哪里开始排版，比如 <code>CustomScrollView</code> 里两个 Sliver 顺序排列</li>
<li><strong>Paint Extent（绘制范围）</strong>：当前 Sliver 在屏幕上实际画出来的像素大小</li>
</ul>
<p>而 <code>overlap</code> 的官方注释简单说就是：</p>
<blockquote>
<p>当前 Sliver 之前的所有 Sliver（主要是 Pinned 或 Floating 状态的 Sliver），它的<strong>绘制范围</strong>超出了<strong>布局范围</strong>的总和。</p>
</blockquote>
<p>是不是还是有点抽象？说人话其实就是：</p>
<blockquote>
<p>Sliver3 问 Viewport：“轮到我出场了吗？”</p>
<p>Viewport 说：“轮到你了，但是 Sliver1 和 Sliver2 赖在头顶不走（Pinned），它们虽然在布局上已经滚上去了（LayoutExtent 变小或为 0），但它们还画在屏幕上（PaintExtent 依然存在），所以你的头顶有 X 个像素被它们挡住了。”</p>
<p><strong>这个 X 就是你的 <code>overlap</code></strong>。</p>
</blockquote>
<p>那回答那位网友的疑问，为什么会是“负数”？ 最常见就是 <strong><code>BouncingScrollPhysics</code> (iOS 风格的回弹效果)</strong> 的场景，比如下方就是一个 <code>BouncingScrollPhysics</code> 的使用场景：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fe5f6482d334cc28f55fce40fa03ce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579189&amp;x-signature=ef4OuxxgWsSBh5keUbmLlA6Fyac%3D" alt="" loading="lazy"/></p>
<p>对于顶部回弹 (Overscroll)场景，当你在列表顶部下拉（OverScroll）时，scrollOffset 会变成负数（例如 -50.0），虽然标准的 overlap 计算通常是累加前面的 Pinned 头部，但在处理过度滚动(OverScroll)时，Viewport 为了维持数学上的连续性，或者某些自定义 Sliver 在计算约束时，会将这个“负的滚动偏移”透传进约束计算中：</p>
<blockquote>
<p>列表在最顶部被拉下来，实际 UI 上产生了一个“空隙”，这个负的 overlap 可以理解为：<strong>“不仅没有重叠，离被重叠还差 50 像素的距离”</strong>。</p>
</blockquote>
<p>另外还有一种可能，就是<strong>SliverGeometry 的 paintOrigin 修正</strong> ，在一些复杂的 <code>NestedScrollView</code> 实现里面，如果 Header 处于展开过程中，可能会通过负的 overlap 来通知后续 Sliver 进行位置补偿。</p>
<p>最后，我们假设一个场景：</p>
<ul>
<li><strong>Sliver1</strong>: Pinned Header (高度 60)</li>
<li><strong>Sliver2</strong>: Pinned Header (高度 60)</li>
<li><strong>Sliver3</strong>: 普通 List</li>
<li><strong>当前状态</strong>: 列表向上滚动了 200</li>
</ul>
<p>然后首先就是  Sliver1 ：</p>
<ul>
<li>它被 pin 在顶部</li>
<li><code>scrollOffset</code>: 200 (它本该滚出去 200，但它没动)</li>
<li><code>layoutExtent</code>: 0 (它在滚动流中不再占据空间，空间留给后面的人)</li>
<li><code>paintExtent</code>: 60 (它依然画在屏幕上)</li>
<li>差值: 60 - 0 = 60。它产生了一个 60 的视觉遮挡</li>
</ul>
<p>然后就是 Sliver2 ：</p>
<ul>
<li>它紧贴着 Sliver1 pin</li>
<li><code>constraints.overlap</code>: 60 (来自 Sliver1 的遮挡)</li>
<li><code>layoutExtent</code>: 0 (同样不占位)</li>
<li><code>paintExtent</code>: 60</li>
<li>差值: 自身产生 60 - 0 = 60。</li>
<li>累计遮挡: 之前的 60 + 现在的 60 = 120</li>
</ul>
<p>Sliver3 ：</p>
<ul>
<li>Viewport 告诉 Sliver3：<code>constraints.overlap = 120</code> ，Sliver3 的布局起始点虽然是从 <code>scrollOffset</code> 计算出来的，但在视觉上，Sliver3 的前 120 会被 Sliver1 和 Sliver2 盖住。</li>
</ul>
<p>具体代码可以参看如下例子，<strong>运行后如图所示，注意看悬浮框的内容输出，就可以很清晰感受到 <code>overlap</code> 在正数之间累积和负数时的效果</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/rendering.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  runApp(<span class="hljs-keyword">const</span> MaterialApp(home: OverlapDeductionDemo()));
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OverlapDeductionDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> OverlapDeductionDemo({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;OverlapDeductionDemo&gt; createState() =&gt; _OverlapDeductionDemoState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_OverlapDeductionDemoState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">OverlapDeductionDemo</span>&gt; </span>{
  <span class="hljs-keyword">final</span> _handle = SliverOverlapAbsorberHandle();
  <span class="hljs-keyword">final</span> ValueNotifier&lt;<span class="hljs-built_in">String</span>&gt; _logNotifier = ValueNotifier(<span class="hljs-string">"等待滚动..."</span>);

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; _logState = {};

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _logNotifier.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
        <span class="hljs-comment">///<span class="markdown">需要注意，这个的AppBar 会影响 overlap 数值，如果没有，会多这部分像素点返回</span></span>
      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">"Overlap Debug"</span>)),
      backgroundColor: Colors.grey[<span class="hljs-number">50</span>],
      body: Stack(
        children: [
          CustomScrollView(
            physics: <span class="hljs-keyword">const</span> BouncingScrollPhysics(
                parent: AlwaysScrollableScrollPhysics()),
            slivers: [
              SliverLayoutBuilder(
                builder: (context, constraints) {
                  updateLogDisplay(<span class="hljs-string">"Sliver 1"</span>, constraints.scrollOffset, constraints.overlap);

                  <span class="hljs-keyword">return</span> SliverAppBar(
                    title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'Sliver 1 (Pinned)'</span>),
                    backgroundColor: Colors.red.withOpacity(<span class="hljs-number">0.7</span>),
                    pinned: <span class="hljs-keyword">true</span>,
                    stretch: <span class="hljs-keyword">true</span>,
                    toolbarHeight: <span class="hljs-number">60</span>,
                    collapsedHeight: <span class="hljs-number">60</span>,
                    expandedHeight: <span class="hljs-number">60</span>,
                    elevation: <span class="hljs-number">0</span>,
                    flexibleSpace: FlexibleSpaceBar(
                      background: Container(color: Colors.red.withOpacity(<span class="hljs-number">0.7</span>)),
                      stretchModes: <span class="hljs-keyword">const</span> [
                        StretchMode.zoomBackground,
                        StretchMode.blurBackground
                      ],
                    ),
                  );
                },
              ),
              SliverList(
                delegate: SliverChildBuilderDelegate(
                      (context, index) =&gt; Container(
                    height: <span class="hljs-number">50</span>,
                    color: Colors.grey[<span class="hljs-number">300</span>],
                    alignment: Alignment.center,
                    child: Text(<span class="hljs-string">'中间填充 Item <span class="hljs-subst">$index</span>'</span>,
                        style: <span class="hljs-keyword">const</span> TextStyle(color: Colors.grey)),
                  ),
                  childCount: <span class="hljs-number">5</span>,
                ),
              ),
              SliverOverlapAbsorber(
                handle: _handle,
                sliver: SliverLayoutBuilder(
                  builder: (context, constraints) {
                    updateLogDisplay(<span class="hljs-string">"Sliver 2"</span>, constraints.scrollOffset, constraints.overlap);
                    <span class="hljs-keyword">return</span> SliverAppBar(
                      title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'Sliver 2 (Pinned)'</span>),
                      backgroundColor: Colors.blue.withOpacity(<span class="hljs-number">0.7</span>),
                      pinned: <span class="hljs-keyword">true</span>,
                      toolbarHeight: <span class="hljs-number">60</span>,
                      collapsedHeight: <span class="hljs-number">60</span>,
                      expandedHeight: <span class="hljs-number">60</span>,
                      primary: <span class="hljs-keyword">false</span>,
                      elevation: <span class="hljs-number">0</span>,
                    );
                  },
                ),
              ),
              SliverLayoutBuilder(
                builder: (context, constraints) {
                  <span class="hljs-keyword">final</span> currentOverlap = constraints.overlap;
                  <span class="hljs-keyword">final</span> offset = constraints.scrollOffset;
                  updateLogDisplay(<span class="hljs-string">"Sliver 3"</span>, offset, currentOverlap);

                  <span class="hljs-keyword">return</span> SliverMainAxisGroup(
                    slivers: [
                      SliverOverlapInjector(handle: _handle),
                      SliverList(
                        delegate: SliverChildBuilderDelegate(
                              (ctx, index) {
                            <span class="hljs-keyword">return</span> Container(
                              height: <span class="hljs-number">50</span>,
                              color: index == <span class="hljs-number">0</span>
                                  ? Colors.green[<span class="hljs-number">900</span>]
                                  : (index.isEven
                                  ? Colors.green[<span class="hljs-number">200</span>]
                                  : Colors.green[<span class="hljs-number">100</span>]),
                              alignment: Alignment.center,
                              child: Text(
                                index == <span class="hljs-number">0</span>
                                    ? <span class="hljs-string">'我是头部 (Item 0)'</span>
                                    : <span class="hljs-string">'Sliver 3 - Item <span class="hljs-subst">$index</span>'</span>,
                                style: TextStyle(
                                    color: index == <span class="hljs-number">0</span>
                                        ? Colors.white
                                        : Colors.black),
                              ),
                            );
                          },
                          childCount: <span class="hljs-number">20</span>,
                        ),
                      ),
                    ],
                  );
                },
              ),
            ],
          ),
          Positioned(
            top: <span class="hljs-number">100</span>,
            right: <span class="hljs-number">16</span>,
            child: ValueListenableBuilder&lt;<span class="hljs-built_in">String</span>&gt;(
              valueListenable: _logNotifier,
              builder: (context, value, child) {
                <span class="hljs-keyword">return</span> Container(
                  padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">12</span>),
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(<span class="hljs-number">0.8</span>),
                    borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(<span class="hljs-number">0.2</span>),
                        blurRadius: <span class="hljs-number">8</span>,
                        offset: <span class="hljs-keyword">const</span> Offset(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>),
                      )
                    ],
                  ),
                  child: Text(
                    value,
                    style: <span class="hljs-keyword">const</span> TextStyle(
                      color: Colors.greenAccent,
                      fontFamily: <span class="hljs-string">'Courier'</span>,
                      fontSize: <span class="hljs-number">12</span>,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  <span class="hljs-keyword">void</span> updateLogDisplay(<span class="hljs-built_in">String</span> name, <span class="hljs-built_in">double</span> offset, <span class="hljs-built_in">double</span> overlap) {
    <span class="hljs-built_in">String</span> status = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">if</span> (overlap &gt; <span class="hljs-number">0</span>) {
      status = <span class="hljs-string">"-&gt; 被遮挡: <span class="hljs-subst">${overlap.toStringAsFixed(<span class="hljs-number">1</span>)}</span>"</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (overlap &lt; <span class="hljs-number">0</span>) {
      status = <span class="hljs-string">"-&gt; 顶部回弹/未接触"</span>;
    } <span class="hljs-keyword">else</span> {
      status = <span class="hljs-string">"-&gt; 无遮挡"</span>;
    }

    <span class="hljs-keyword">final</span> singleLog = <span class="hljs-string">'[<span class="hljs-subst">$name</span>]\n'</span>
        <span class="hljs-string">'Offset : <span class="hljs-subst">${offset.toStringAsFixed(<span class="hljs-number">1</span>)}</span>\n'</span>
        <span class="hljs-string">'Overlap: <span class="hljs-subst">${overlap.toStringAsFixed(<span class="hljs-number">1</span>)}</span>\n'</span>
        <span class="hljs-string">'<span class="hljs-subst">$status</span>'</span>;

    _logState[name] = singleLog;

    <span class="hljs-keyword">final</span> sortedKeys = _logState.keys.toList()..sort();
    <span class="hljs-keyword">final</span> combinedLog = sortedKeys.map((k) =&gt; _logState[k]).join(<span class="hljs-string">'\n------------------\n'</span>);


    <span class="hljs-keyword">if</span> (_logNotifier.value != combinedLog) {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        <span class="hljs-keyword">if</span> (mounted) {
          _logNotifier.value = combinedLog;
        }
      });
    }

    <span class="hljs-built_in">print</span>(<span class="hljs-string">'<span class="hljs-subst">$name</span> -&gt; Offset:<span class="hljs-subst">$offset</span>, Overlap:<span class="hljs-subst">$overlap</span>'</span>);
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3910ecd0079349f79d281dd4d6bbbd3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579189&amp;x-signature=zL3to30i%2FAthcZ0gWkslKiFpNt0%3D" alt="" loading="lazy"/></p>
<p>那么这时候的 Sliver3 该如何使用 <code>overlap</code> ？简单来说可以有：</p>
<p>1、无视，Sliver3 依然照常从 0 开始画，结果 是 Sliver3 的前 120px 内容被 Sliver1 和 Sliver2 盖住，用户看不见，这就是我们常说的“内容穿过 Header 滚上去”</p>
<p>2、平移绘制，在返回 <code>SliverGeometry</code> 时，设置 <code>paintOrigin = constraints.overlap</code>，结果就是 Sliver3 的内容整体向下平移 120px，刚好处在 Header 下方，这也是 <code>SliverOverlapInjector</code> 的工作原理，它作为一个透明的占位符，把这 120px 的 overlap “吃掉”（注入成 layoutExtent），让后面的能正常显示</p>
<p>3、部分绘制，可以让 Sliver3 只绘制露出来的部分，在计算 <code>paintExtent</code> 时，考虑 <code>overlap</code> ，例如 <code>paintExtent = max(0.0, calculatedSize - constraints.overlap)</code></p>
<p>所以现在可以理解了吧：</p>
<ul>
<li><strong>正数 Overlap</strong>：代表**“被上方 Pinned 元素遮挡的像素量”**，计算公式是累加前面所有 Pinned Sliver 的 <code>(paintExtent - layoutExtent)</code></li>
<li><strong>负数 Overlap</strong>：通常出现在 <strong>OverScroll（回弹）</strong> 阶段，代表**“距离由于回弹产生的顶部空隙的距离”**，或者理解为“负的遮挡”</li>
</ul>
<blockquote>
<p>实际上，如果在自定义 Sliver 的  <code>performLayout</code> 中打印 <code>print('Overlap: ${constraints.overlap}, ScrollOffset: ${constraints.scrollOffset}');</code> ，就会看到负数 <code>overlap</code> 和负数 <code>scrollOffset</code> (回弹) 往往成对出现。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失]]></title>    <link>https://juejin.cn/post/7588445332771881014</link>    <guid>https://juejin.cn/post/7588445332771881014</guid>    <pubDate>2025-12-29T01:01:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445332771881014" data-draft-id="7587606718843732009" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-29T01:01:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:01:42.000Z" title="Mon Dec 29 2025 01:01:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>随着 Safari 26.2 在 12 月 12 日的发布，Web 性能领域迎来了一个令人振奋的年终礼物：最大内容绘制（LCP）和交互到下次绘制（INP）现已正式成为 Baseline 新可用功能。所有主流浏览器的最新版本现在都包含了测量这些指标所需的最大内容绘制 API 和事件计时 API。这是 Interop 2025 项目的一部分，很高兴看到这些功能在今年成功交付！</p>
<h2 data-id="heading-0">这意味着什么</h2>
<p>核心 Web 指标（Core Web Vitals）已成为衡量网页体验的广泛采用标准，无论是对于 Web 开发者还是业务利益相关者而言都是如此。它们试图将复杂的 Web 性能故事总结为几个关键指标：页面加载速度（LCP）、交互响应速度（INP）以及内容稳定性（CLS）。</p>
<p>长期以来，这些指标只能在基于 Chromium 的浏览器（如 Chrome 和 Edge）中测量。在 iOS 设备上，由于所有浏览器都使用驱动 Safari 的 WebKit 浏览器引擎，这些指标完全不可用。这造成了一个盲点：网站可能不知道大量访问者正在经历完全不同的体验。虽然许多 Web 性能改进确实使所有浏览器受益，但某些技术和 API 仅在部分浏览器中可用。此外，浏览器内部的工作方式、页面加载方式以及处理交互的方式可能彼此不同。仅拥有网站性能的部分视图远非理想状态。</p>
<p>随着所有主流浏览器现在都支持这两个指标，我们现在可以更好地了解网站的关键加载和交互性能。这将使网站所有者能够更好地理解性能问题并识别可以进行的改进，最终使用户和业务指标受益。</p>
<h2 data-id="heading-1">其他浏览器的数据会进入 CrUX 吗？</h2>
<p>不会。Chrome 用户体验报告（CrUX）仅基于符合条件的 Chrome 用户，这一点不会改变。这也适用于使用此数据的下游系统，如 PageSpeed Insights、Google Search Console 和 CrUX Vis。</p>
<p>这也将继续排除 Chrome iOS 用户，因为他们使用 WebKit 浏览器引擎。</p>
<h2 data-id="heading-2">如何从其他浏览器测量</h2>
<p>CrUX 数据仍然作为网站性能的摘要很有用，并且可以与网络上的其他网站进行基准测试。然而，由于它是一个高级摘要，我们长期以来一直建议测量更详细的真实用户数据（field data）以帮助识别和改进性能。</p>
<p>真实用户监控（RUM）工具现在能够收集额外的真实用户数据，包括通过 Chrome 团队的 web-vitals 库测量的数据。在大多数情况下，这应该自动开始包含在您现有的解决方案中，但如果您有任何问题，请与您的 RUM 提供商确认。</p>
<p>请注意，RUM 和 CrUX 之间可能存在差异，现在这些指标在更多不包括在 CrUX 中的浏览器中可用，这种差异可能更加明显。</p>
<h2 data-id="heading-3">实现方式有什么不同吗？</h2>
<p>虽然所有浏览器引擎在加载和显示网页方面大致执行相同的任务，但这些浏览器的构建方式存在许多差异，特别是在它们的渲染管道中，这些管道将网站的代码（主要是 HTML、CSS 和 JavaScript）转换为屏幕上的像素。</p>
<p>渲染循环的结束大致是可互操作的，被定义为 <code>paintTime</code>。然而，在这之后，有一个稍后的 <code>presentationTime</code>，这是特定于实现的，旨在指示像素实际绘制到屏幕上的时间。Chrome 测量 LCP 直到 <code>presentationTime</code> 结束，而 Firefox 和 Safari 不包括 <code>presentationTime</code>，因此测量到更早的 <code>paintTime</code>。这导致测量结果之间存在几毫秒的差异。从 Chrome 145 开始，<code>paintTime</code> 测量也将为 LCP 公开，以便那些希望能够在浏览器之间进行同类比较的人使用。</p>
<p>同样的差异也适用于 INP。</p>
<p>其他浏览器实现这些指标的事实，有助于识别一些需要澄清和更好定义的未解决问题。这再次可能导致轻微差异——尽管这些主要出现在边缘情况中。这就是拥有多个实现和关注 API 的好处！我们将继续致力于这些以及指标的任何其他改进。</p>
<p>然而，尽管存在这些小的差异，我们确信 LCP 和 INP 大致是可互操作的，因此我们很高兴它们被标记为 Baseline 新可用功能。那些实现 RUM 解决方案或深入研究数据的人可能会注意到其中一些差异，但 Web 开发者应该对跨浏览器测量这些指标充满信心，尽管存在这些微小差异。</p>
<h2 data-id="heading-4">不支持这些 API 的浏览器怎么办？</h2>
<p>Baseline 新可用功能仅在所有主流浏览器的最新版本中可用。您的用户群可能不会立即升级，或者可能无法升级，这取决于他们的操作系统和提供商。30 个月后，它们将被视为 Baseline 广泛可用，因为大多数用户可能会使用支持这些功能的浏览器。</p>
<p>然而，作为测量 API 而不是网站的核心功能，您可以安全地为支持这些功能的浏览器测量这些指标——就像您到目前为止可能一直在做的那样。只需注意，您可能正在看到过滤后的用户视图——那些已升级的用户——特别是在最初的几个月里。</p>
<h2 data-id="heading-5">累积布局偏移（CLS）呢？</h2>
<p>第三个核心 Web 指标是累积布局偏移（CLS），它不是 Interop 2025 项目的一部分——尽管它已被提议用于 Interop 2026。目前，除了基于 Chromium 的浏览器之外，它不受支持。</p>
<h2 data-id="heading-6">结论</h2>
<p>Web Vitals 计划的目标是通过为 Web 平台创建一套标准 API 来改善 Web 性能，使关键指标能够被测量并被网站所有者广泛理解。很高兴看到这些指标中的两个现在得到了所有主流浏览器的支持。我们期待看到这些指标为网站所有者提供什么见解，以及这如何带来更好的用户体验！</p>
<p><strong>参考来源：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fblog%2Flcp-and-inp-are-now-baseline-newly-available" target="_blank" title="https://web.dev/blog/lcp-and-inp-are-now-baseline-newly-available" ref="nofollow noopener noreferrer">web.dev - LCP and INP are now Baseline Newly available</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[货拉拉离线大数据迁移-验数篇]]></title>    <link>https://juejin.cn/post/7588996730772029440</link>    <guid>https://juejin.cn/post/7588996730772029440</guid>    <pubDate>2025-12-29T06:18:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588996730772029440" data-draft-id="7587342664078819343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="货拉拉离线大数据迁移-验数篇"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2025-12-29T06:18:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            货拉拉离线大数据迁移-验数篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T06:18:54.000Z" title="Mon Dec 29 2025 06:18:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、数据验证背景</h2>
<p>在前两篇文章中，我们分别从宏观层面梳理了离线大数据迁移的整体流程与关键挑战（<a href="https://juejin.cn/post/7551467977931079695" target="_blank" title="https://juejin.cn/post/7551467977931079695">《货拉拉离线大数据跨云迁移-综述篇》</a>），并详细介绍了实际数据迁移过程中的策略、步骤与注意事项（<a href="https://juejin.cn/post/7553924835917152308" target="_blank" title="https://juejin.cn/post/7553924835917152308">《货拉拉离线大数据跨云迁移 - 数据迁移篇》</a>）。然而，云迁移工作并不在“数据搬运完成”这一刻画上句号——迁移后的数据是否完整、准确、一致，直接决定了业务系统能否平稳切换、分析结果能否可靠可信。</p>
<blockquote>
<p>迁移 ≠ 成功，数据验证才是闭环。验数是迁移质量的“守门人”，也是业务信任的基石</p>
</blockquote>
<p>本篇将围绕离线大数据迁移后<strong>双跑阶段的数据验证</strong>展开，涉及公司近 20 个部门、数万张Hive表的数据，探讨验证的目标与原则、常见的验证方法与工具、不同场景下的验证策略，以及在实际落地中需要关注的性能与成本平衡。通过系统化的数据验证流程，我们不仅能够发现并修正迁移过程中的问题，还能为后续的数据治理与质量管理奠定坚实基础。</p>
<h2 data-id="heading-1">二、数据验证挑战</h2>
<ul>
<li><strong>挑战 1：跨云双跑验数难</strong>
<ul>
<li>问题背景：
<ul>
<li>双跑阶段，源端不封网，每日都有大量的任务SQL变更、Hive上万表新增/修改分区数据。需要对双跑结果进行校验，包括表分区级 COUNT 校验 和 行级明细比对。校验过程需同时从两朵云查询数据，涉及跨云访问。</li>
</ul>
</li>
<li>主要挑战：
<ul>
<li>网络瓶颈： 跨云链路带宽有限（约 100Gb），直接跨云读取数据会导致高延迟与传输开销。</li>
<li>计算压力： 每日需处理数万张表及行级数据，计算量大，容易占用生产集群资源，影响业务运行。</li>
<li>动态数据干扰多：抽数难对齐，源端写入与目标端双跑并行，数据版本易错乱（如 ETL 逻辑变更）</li>
</ul>
</li>
<li>应对思路：
<ul>
<li>采用“云内比对 + 分层验证（粗验 / 精验）”策略，构建自动化验数工具，支持多维度比对（行级、字段级、聚合级）</li>
</ul>
</li>
</ul>
</li>
<li><strong>挑战 2：错误归因与修复难</strong>
<ul>
<li>差异可能源于工具、源端/目标端异常或业务变更，排查链路长。</li>
<li>应对思路 ：自动化验数报告+闭环跟踪机制。</li>
</ul>
</li>
<li><strong>挑战 3：业务验收协同难</strong>
<ul>
<li>涉及部门多且数据准确性要求多样化，核心表需 100%一致，非核心表允许合理误差。</li>
<li><strong>应对思路</strong> ：分级验证（P0/P1）+专家精验，匹配业务优先级，责任到人。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">三、验数方案设计</h2>
<h3 data-id="heading-3">1. 整体方案</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65251be13b1445fea8d68d5a5b46c38d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=PV7crhkz1Wf7%2BnmAup3mdNFNPho%3D" alt="1.png" loading="lazy"/>
存量数据迁移完成后进入链路双跑期，这期间源端集群不封网，每天都有大量的任务代码变更和新数据生成，<strong>数据验收通过才能保障业务系统平稳切换</strong>。我们主要通过如下步骤做到在业务运行无感的情况下完成稳定、高效的数据验证：</p>
<ul>
<li><strong>准备链路双跑环境</strong>：准备双跑环境，网络隔离、任务代码自动同步、冻结不可双跑任务，防止双跑链路污染线上数据，搭建了一套<strong>隔离、同步、可控的双跑环境</strong></li>
<li><strong>高效数据对比工具</strong>：跨云表数据自动对比，支持表行级和列级的粗验（数据量）和精验（明细，支持设定浮点数精度）；自动生成对比报告，记录表和列的数据不一致占比以及不一致的明细数据，<strong>大幅提升验数效率</strong></li>
<li><strong>数据验证策略与实施</strong>：按照分层、分级、分阶段、分部门的策略对20万+的Hive表进行验数，归因分析数据不一致原因并修复，<strong>协助业务部门完成表数据一致性验收</strong></li>
</ul>
<h2 data-id="heading-4">四、 验数实施</h2>
<h3 data-id="heading-5">1. 双跑环境准备</h3>
<p>在存量数据迁移基本完成后，系统正式进入<strong>链路双跑阶段</strong>——这是数据验证最关键的窗口期。此阶段，<strong>源端集群保持完全开放</strong>，业务任务照常运行，ETL 代码持续迭代，每日仍有 500TB+增量数据写入。为确保验证过程不影响线上稳定性，同时又能真实模拟切换后的运行状态，我们构建了一套<strong>隔离、同步、可控</strong>的双跑环境。</p>
<h4 data-id="heading-6">1.1 网络与资源隔离</h4>
<ul>
<li><strong>物理隔离</strong>：目标云环境独立部署 Hive Metastore、YARN 集群、调度系统，与源端无共享存储或元数据服务，避免交叉污染。</li>
<li><strong>网络策略</strong>：通过 VPC 对等连接或专线打通跨云通道，限制目标端仅允许 Kirk迁移 工具和双跑任务写入，禁止外部访问 。</li>
<li><strong>资源保障</strong>：为双跑任务分配独立 YARN 队列和计算资源，避免与生产任务争抢资源，确保验证过程不影响核心链路 SLA。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6babe110086749748769d82eea79b226~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=Xv%2BpDAyq2V8NltVHBA9gh6qD9Ng%3D" alt="2.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-7">1.2 任务代码自动同步</h4>
<p>为确保计算任务代码、数据及元数据在多环境间的高度一致性，数据平台自主研发了自动同步功能。该功能实现了主环境到备环境的实时双向同步，当用户在主环境进行代码修改、数据更新或配置调整时，系统会自动、精准地将变更内容同步至备环境。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb75efa40c34f5dbeee1cad313a2b06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=dJFJkZVBvXJCibk%2Bo1sBXqN9w2U%3D" alt="3.png" loading="lazy"/></p>
<h4 data-id="heading-8">1.3 不可双跑任务冻结机制</h4>
<p>并非所有任务都适合双跑。例如：</p>
<ul>
<li>强依赖源端特定组件（如自定义 UDF、本地缓存）；</li>
<li>涉及外部系统写入（如 DB、MQ），双跑会导致重复写入；</li>
<li>任务本身具有幂等破坏性（如 delete、drop 操作）。</li>
</ul>
<blockquote>
<p>双跑期间不打开的任务：</p>
<ul>
<li>一次性任务</li>
<li>所有Doris相关任务，包含Doris SQL、ShellDoris、Hive2doris等类型不打开</li>
<li>Hive to Any任务</li>
</ul>
</blockquote>
<p>对此类任务，在双跑启动前会冻结，避免对目标端或外部系统造成干扰。同时，对关键冻结任务提供 Mock 数据或空跑策略，保障下游链路完整性。</p>
<p>通过上述措施，我们构建了一个<strong>高保真、低干扰、可回溯</strong>的双跑环境，为后续大规模、自动化数据验证奠定了坚实基础。在整个双跑周期（约 2–3 周）内，系统平稳运行，未发生因验证导致的生产事故，真正实现了“<strong>业务运行无感，验证有理有据</strong>”。</p>
<h3 data-id="heading-9">2. 验数平台</h3>
<p>为了保障双跑验数工作高效推进，我们基于 Kirk 系统自研了一套高吞吐、高性能、可扩展的自动化验数平台。平台设计遵循以下核心思路：</p>
<ul>
<li><strong>平台化与自动化</strong>
将繁琐的验数操作（如调度对比任务、收集结果、生成报告）整合为标准化、自动化的平台流程，减少人工干预，提升效率与一致性。</li>
<li><strong>多维度可扩展</strong>
支持多种验数策略的选择，如比计数、比关键字段哈希、比全字段等，支持验收阈值配置，还支持高度定制化的验数逻辑，如自定义SQL。</li>
<li><strong>面向业务协同</strong>
提供清晰的验数报告，按部门、表重要性分类，输出比对结果，差异率，差异明细等，用户可快速找到不一致的原因，实现责任到人，过程透明。</li>
</ul>
<h4 data-id="heading-10">2.1 跨云数据验证</h4>
<p>链路双跑完成之后，待验证数据分别在两朵云，为了避免频繁重复的跨云传输，我们设计了数据集中验证策略——将源端数据预先迁移到目标端，在单一云环境内完成全部验证工作。</p>
<h5 data-id="heading-11">2.1.1 数据准备</h5>
<p>要把数据迁移到同一朵云上，首先要解决的第一个问题就是数据放哪里怎么放的问题，无论验数结果是否通过，最终都会以源端数据为基准去覆盖目标端的数据，因此在验数的准备过程中，第一步先将目标端待验证的数据移动到比对库中避免被源端覆盖（rename操作，不会产生数据读写），第二步使用Kirk（自研数据迁移工具）把源端数据搬迁到目标端正式目录上，通过这两个步骤，既完成了数据迁移任务，又为云内比对做好了数据准备。
这个过程中需要注意非分区表的特殊处理，通常非分区表的大小都比较小（主要是维表），由于非分区表每天都会自行覆盖，为了实现历史状态的回溯，需要专门针对于非分区表保留历史状态的快照，数据准备过程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1edf58ecb71e482c88e2fa1caa0bb3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=zuf8MijNLaGRfLBUZ4dKh%2BtKQ%2FQ%3D" alt="4.png" loading="lazy"/></p>
<h5 data-id="heading-12">2.1.2 比对方案</h5>




















<table><thead><tr><th align="left">类型</th><th align="left">方法</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">粗验</td><td align="left">对比源端与腾讯云两条链路产出的表行数（COUNT）</td><td align="left">快速判断数据完整性，是精验的前提条件</td></tr><tr><td align="left">精验</td><td align="left">对每张表的每行数据计算 MD5 值，逐行比对一致性</td><td align="left">确保内容级 100% 一致，用于核心表验证</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/639accd26d4645e4b82ed54c323db058~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=u%2FhapAtJSDfSzgPIt7VGQntTM4A%3D" alt="5.png" loading="lazy"/></p>
<h4 data-id="heading-13">2.2 验数平台介绍</h4>
<h5 data-id="heading-14">2.2.1 创建比对任务</h5>
<p>支持单个/批量创建数据比对任务</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5828069a6ad4176a80abf4d4dc98237~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=HmdUmS9UmLChHZ8XUa%2FlhJoQKHI%3D" alt="6.png" loading="lazy"/></p>
<h5 data-id="heading-15">2.2.2 配置比对逻辑</h5>
<ol>
<li>count验数：对比华为云和腾讯云表count行数</li>
<li>自定义SQL验数：count，sum，按维度聚合</li>
<li>明细比对：对比整行数据的差异，可以指定主键和排除字段</li>
<li>数值差异比对：将数值字段按照 +-*/ 等规则计算差异率，并可单独指定每个字段的差异率阈值</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78388d70b10143d29592dd1a916a23fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=i8hbXSV9eSd7Z0ZY5tTaUwuZ2AA%3D" alt="7.png" loading="lazy"/></p>
<h5 data-id="heading-16">2.2.3 运行比对任务</h5>
<p>用户可以根据需求，选择自动执行或者定时执行比对逻辑，功能介绍如下：</p>

































<table><thead><tr><th align="left">对比项</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">是否count比对</td><td align="left">执行行数一致性校验</td></tr><tr><td align="left">是否自定义SQL比对</td><td align="left">执行用户自定义SQL校验</td></tr><tr><td align="left">是否明细比对</td><td align="left">执行字段级一致性验证</td></tr><tr><td align="left">是否数值差异比对</td><td align="left">执行数值字段四则运算一致性验证</td></tr><tr><td align="left">是否BI数值差异比对</td><td align="left">执行数值波动率一致性验证</td></tr><tr><td align="left">BI是否夸天比对</td><td align="left">执行数值波动率一致性验证并且可自定义同环比日期</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99062fd4c5fc45bd8c32c7bb5ae400b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=pJcwQGy752uaQo7AOZagO%2B%2FQtU4%3D" alt="8.png" loading="lazy"/></p>
<h5 data-id="heading-17">2.2.4 下载比对报告</h5>





































<table><thead><tr><th>对比项</th><th>说明</th></tr></thead><tbody><tr><td>全局比对结果</td><td>该 task 最终的比对状态，分为：未知（系统比对 SQL 和用户自定义 SQL 运行异常），一致（系统比对 SQL 和用户自定义 SQL 都一致），不一致（系统比对 SQL 或用户自定义 SQL 不一致）</td></tr><tr><td>系统比对结果</td><td>系统生成的 Count SQL 比对结果是否一致</td></tr><tr><td>用户SQL比对结果</td><td>用户自定义的 SQL 执行的结果是否一致</td></tr><tr><td>源链路count</td><td>主链路执行 SQL Count 结果</td></tr><tr><td>腾讯云count</td><td>腾讯云执行 SQL Count 结果</td></tr><tr><td>count差异率</td><td>主链路和腾讯云 Count 差异（（腾讯云 Count - 主链路 Count）/ 主链路 Count）</td></tr><tr><td>系统异常信息</td><td>系统的异常日志，有则点击并显示</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6e9ea1147cb4ddf816a8e9e308fe0d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=XOaILIoVvKTWOY%2B3q9wl8Ojt%2BrQ%3D" alt="9.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eaedc82a0ce486e918421b3656ee0ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=LOI3XN%2BKR8xYlzPQJzRKVfiUgBk%3D" alt="10.png" loading="lazy"/></p>
<h3 data-id="heading-18">3. 数据验证策略与实施</h3>
<p>面对横跨近20个部门、涵盖数万张Hive表的庞大数据体系，我们构建了一套贯穿双跑周期的系统性验数方案。该方案以“平台化工具自动巡检”与“专家团队精准核验”双轨并进，通过层次化、场景化的验证流程，为核心数据的一致性保驾护航，为业务切换筑牢信任根基。</p>
<h4 data-id="heading-19">3.1 核心策略</h4>
<h5 data-id="heading-20">3.1.1 分层、分级、分阶段</h5>
<p>为应对数据规模与复杂性的挑战，我们摒弃了单一维度的验证方式，确立了以下核心策略
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f031f6fe4b8481283c165590aec84e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=gT2ckkNPaxoi%2FKE%2Ba6nzygvyAHM%3D" alt="11.png" loading="lazy"/></p>
<ul>
<li><strong>分层验证</strong>（从数据产生的技术流程和依赖关系入手）从基础数据层（ODS/DWD）到应用数据层（DWS/DM/报表）依次验证，确保验证流程符合数据加工逻辑，系统性阻断底层错误向上蔓延。</li>
<li><strong>分级验证</strong>（从数据的重要性和影响面入手），对数据表进行P0（核心）/P1（重要）/P2（一般）分级，实施差异化的验证强度，确保资源精准投放。</li>
<li><strong>分阶段验证</strong>（从验证工作的实施步骤和精细度入手）采用“先粗后精”的两阶段流程，先行数快速筛查，再内容深度比对，构建高效的验证流水线。</li>
</ul>
<h4 data-id="heading-21">3.2 方案实施</h4>
<p>为确保验证的全面性与深度，我们采用了<strong>平台化工具</strong>与<strong>专家精准核验</strong>的双轨制策略。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24e140d3f74c4a7a8cf2df51aa97dfb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=jO72HK47qexTXllgo%2FmxJ95cZaA%3D" alt="12.png" loading="lazy"/></p>
<h5 data-id="heading-22">3.2.1 平台验数</h5>
<p>为提升验证效率，我们使用了元初平台的验数工具，覆盖基础场景，实现规模化效率</p>
<ul>
<li><strong>Count验数</strong>：快速比对源端和腾讯云表或分区的行数，是“分阶段”策略中“粗验”的核心手段，能快速定位宏观差异。</li>
<li><strong>自定义SQL验数</strong>：
<ul>
<li><strong>数据流完整性验证</strong>：验证从ODS源头到DM应用层的数据加工链是否准确。例如，编写SQL检查DM层的“用户总消费金额”是否等于对DWD层所有相关明细订单金额的汇总。</li>
<li><strong>关键KPI比对</strong>：如“当日GTV”、“活跃用户数”、“平均响应时长”等。需要编写承载了完整、一致业务口径的SQL（涉及多表关联、去重、过滤、聚合）</li>
</ul>
</li>
<li><strong>明细比对</strong>：基于主键或唯一键的逐行字段级精准比对，是“精验”阶段验证数据明细一致性的关键手段。</li>
<li><strong>数值差异比对</strong>：针对数值型字段，设置误差容忍区间，科学地判定在合理波动范围内的数据一致性，有效解决了报表层因微小时间差导致匹配不上的经典难题。</li>
</ul>
<h5 data-id="heading-23">3.2.2 专家验数：攻坚复杂场景，确保业务深度可信</h5>
<p>对于元初验数平台无法覆盖的复杂、定制化场景，我们依赖数据开发者的领域知识与经验进行深度验证。</p>
<ul>
<li><strong>验证范围</strong>：聚焦于核心链路表与各部门认定的重要表。
<ul>
<li>终端表优先验证：优先验证直接面向业务应用的终端产出表。若终端表数据准确，则其上游数据处理链路在大概率上是正确的，这是一种高效的逆向验证思路。</li>
<li>关键节点表验证：对承上启下的关键宽表、重度聚合表等进行重点核查，确保核心数据加工节点的准确性。</li>
</ul>
</li>
<li><strong>验证方法</strong>：
<ol>
<li>领域专业验证：结合业务语义，对重要维度（如地区、渠道）、关键指标（如GMV、转化率）进行聚合统计与趋势比对，从业务视角判断数据合理性。</li>
<li>标准逐行比较验证：对于要求绝对一致的核心表，利用我们提供的深度验数工具（支持在腾讯云侧进行数据比对），可对每一行数据的所有字段或部分关键字段计算MD5值，进行无损的精确比对，确保数据100%一致。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-24">3.2.3 标准化运营流程</h5>
<p>我们建立了专职的验数小组，驱动验证工作闭环：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/805cd0e707b04695a846d27e30481331~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=RVUYOADZUHgGOrqGEjOJQLMTNeE%3D" alt="13.png" loading="lazy"/></p>
<ul>
<li>顺序推进：严格执行“先基础层，后应用层”的验证顺序。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53a09dbc737e4326aaed6b3bb0444ec7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=%2FEEC3Zb20DzZbBtOkJvLUcQiJLQ%3D" alt="14.png" loading="lazy"/></p>
<ul>
<li>工具与报告驱动：以元初验数平台为核心调度工具，每日自动产出验数报告，透明化展示验证进度与不一致项。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67b11d1a9e5b45ccb59a3787205ad3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=SYv4odLJ%2FeoxAfbceqe8%2FiYrWng%3D" alt="15.png" loading="lazy"/></p>
<ul>
<li>问题闭环管理：对平台发现及专家识别的不一致问题，执行“定位、解决、跟踪、验证”的全程闭环管理，确保所有问题被根除。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0637a9d8eae94dc1b6cb60e155d84bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767593934&amp;x-signature=pTaAhjcSRoypyq9QPbyN360%2FKf4%3D" alt="16.png" loading="lazy"/></p>
<h2 data-id="heading-25">五、总结</h2>
<p>离线大数据跨云迁移是一项系统性工程，从前期规划、数据迁移到后期验证，每个环节都环环相扣、缺一不可。数据验证作为迁移闭环的最后一环，不仅是对迁移结果的质量把关，更是对整个迁移体系的信任背书。通过科学的验证目标设定、合理的验证策略设计以及高效的工具与流程落地，我们能够在保障数据完整性、一致性与可用性的同时，平衡性能与成本，确保业务平稳过渡。
在本次迁移与验证过程中，来自多个团队的同事共同参与了验数工作。他们在验证方案设计、工具开发、数据比对、问题定位与修复等环节中密切协作，确保了整个迁移过程的高效与可靠。正是这种跨团队的协同与专业投入，构筑了数据验证工作的坚实底座，也为项目的顺利收官提供了有力保障。
在此，也向所有参与本次迁移与验数工作的团队与同事致以诚挚的感谢——正是大家的专业、耐心与协作，让复杂的跨云迁移项目得以高质量落地。</p>
<p>作者简介：</p>
<ol>
<li>杨秋吉：大数据专家，负责大数据离线计算引擎、OLAP引擎的研发与维护</li>
<li>陆欢典：资深数据仓库工程师，货拉拉公共数据组负责人，致力于公共数据层的顶层设计与统筹建设</li>
<li>陈铨：高级大数据工程师，专注于大数据存储方向，主要负责大数据离线存储、向量存储的研发和维护</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 提速 20%，来看看 Python 3.15 中的新特性]]></title>    <link>https://juejin.cn/post/7588445306088226816</link>    <guid>https://juejin.cn/post/7588445306088226816</guid>    <pubDate>2025-12-29T00:43:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445306088226816" data-draft-id="7588300640598917126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 提速 20%，来看看 Python 3.15 中的新特性"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-29T00:43:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 提速 20%，来看看 Python 3.15 中的新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:43:27.000Z" title="Mon Dec 29 2025 00:43:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f428e84a93a45e49e5a3aaabd8db155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573807&amp;x-signature=bDk7%2FF%2Ba1Wbv5140GEezdO3v8dU%3D" alt="0.webp" loading="lazy"/></p>
<p>Python <code>3.15</code> 引入了原生的即时编译器（JIT），在部分场景下可带来 <strong>20% 甚至更高的性能提升</strong>——尽管目前它仍处于实验阶段。</p>
<p>所谓 JIT（Just-In-Time Compilation，即时编译），就是让原本“解释执行”的 Python 代码在运行时动态编译成机器码，从而显著提速。过去，这类能力只能依赖第三方方案，比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnumba.pydata.org%2F" target="_blank" title="https://numba.pydata.org/" ref="nofollow noopener noreferrer">Numba</a> 这样的库，或者使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpypy.org%2F" target="_blank" title="https://pypy.org/" ref="nofollow noopener noreferrer">PyPy</a> 这类替代性 Python 解释器。</p>
<p>如今，Python 官方终于把 JIT 编译器集成进了主干。虽然早期版本效果有限，但到了 Python <code>3.15</code>（当前仍处于 alpha 阶段，尚未正式发布），核心开发团队做了大量优化，使得 JIT 在某些计算密集型任务中已经能带来可观的加速。</p>
<p>当然，JIT 的提速效果因 workload 而异：有些程序飞快，有些则几乎没变化。不过好消息是，现在的 JIT 已经足够稳定，开发者完全可以拿来试试水，甚至在可控环境下用于生产测试。</p>
<h2 data-id="heading-0">如何启用 Python JIT？</h2>
<p>默认情况下，Python 的原生 JIT 是<strong>关闭</strong>的，毕竟它还是个实验性功能，需要手动开启。</p>
<p>启用方式很简单：设置环境变量 <code>PYTHON_JIT=1</code>。你可以：</p>
<ul>
<li>
<p>临时在当前 shell 会话中设置：</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">export</span> PYTHON_JIT=1
python your_script.py
</code></pre>
</li>
<li>
<p>或者直接在命令行前缀启动：</p>
<pre><code class="hljs language-sh" lang="sh">PYTHON_JIT=1 python your_script.py
</code></pre>
</li>
</ul>
<p>Python 启动时会检查 <code>PYTHON_JIT</code> 环境变量：只要值为 <code>1</code>，JIT 就会被激活；否则保持关闭。</p>
<p>虽然你可以把 <code>PYTHON_JIT=1</code> 写进系统环境变量长期生效，但更推荐按需启用——比如只在跑性能敏感任务时临时打开，避免对其他脚本产生意外影响。</p>
<h2 data-id="heading-1">如何确认 JIT 是否生效？</h2>
<p>从 Python 3.13 开始，标准库的 <code>sys</code> 模块新增了一个内部命名空间：<code>sys._jit</code>。它提供了三个实用函数，返回值都是 <code>True</code> 或 <code>False</code>：</p>
<ul>
<li><code>sys._jit.is_available()</code>：判断当前 Python 构建是否<strong>支持</strong> JIT。官方发布的大多数二进制包都包含 JIT 支持，但像“无线程”（freethreading）或“无 GIL”等特殊构建可能不包含。</li>
<li><code>sys._jit.is_enabled()</code>：检查 JIT 是否<strong>已启用</strong>。注意，这仅表示 JIT 功能打开了，并不代表你的代码已经被编译。</li>
<li><code>sys._jit.is_active()</code>：尝试判断当前栈顶帧是否正在执行 JIT 编译后的代码。<strong>但这个接口不太可靠</strong>——你的程序可能不小心进入了“冷路径”（即未被 JIT 优化的代码分支）。因此，最靠谱的方式还是通过<strong>实际性能对比</strong>来验证效果。</li>
</ul>
<p>日常使用中，<code>sys._jit.is_enabled()</code> 是最有用的，能快速确认 JIT 是否已成功开启。</p>
<h2 data-id="heading-2">JIT 加速效果实测：哪些代码能受益？</h2>
<p>由于 JIT 仍处于早期阶段，目前<strong>没有公开 API 能告诉你哪段函数被编译了</strong>，也无法直接查看优化状态。唯一靠谱的方法就是写 benchmark，对比开启/关闭 JIT 时的运行时间。</p>
<h3 data-id="heading-3">✅ 正面案例：Mandelbrot 分形计算</h3>
<p>下面这段代码实现了一个简化版的 Mandelbrot 集合渲染：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> perf_counter
<span class="hljs-keyword">import</span> sys

<span class="hljs-built_in">print</span>(<span class="hljs-string">"JIT enabled:"</span>, sys._jit.is_enabled())

WIDTH = <span class="hljs-number">80</span>
HEIGHT = <span class="hljs-number">40</span>
X_MIN, X_MAX = -<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>
Y_MIN, Y_MAX = -<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>
ITERS = <span class="hljs-number">500</span>

YM = (Y_MAX - Y_MIN)
XM = (X_MAX - X_MIN)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">iter_</span>(<span class="hljs-params">c</span>):
    z = <span class="hljs-number">0j</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ITERS):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(z) &gt; <span class="hljs-number">2.0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        z = z ** <span class="hljs-number">2</span> + c
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>():
    start = perf_counter()
    output = []

    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(HEIGHT):
        cy = Y_MIN + (y / HEIGHT) * YM
        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(WIDTH):
            cx = X_MIN + (x / WIDTH) * XM
            c = <span class="hljs-built_in">complex</span>(cx, cy)
            output.append(<span class="hljs-string">"*"</span> <span class="hljs-keyword">if</span> iter_(c) <span class="hljs-keyword">else</span> <span class="hljs-string">"."</span>)
        output.append(<span class="hljs-string">"\n"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Time:"</span>, perf_counter() - start)
    <span class="hljs-keyword">return</span> output

<span class="hljs-built_in">print</span>(<span class="hljs-string">""</span>.join(generate()))
</code></pre>
<p>运行后，程序会先打印 JIT 状态，再输出 ASCII 分形图和耗时。</p>
<p>实测发现：<strong>开启 JIT 后，运行时间稳定减少约 20%</strong> 。如果你感觉提速不明显，可以试着调高 <code>ITERS</code>（比如设为 2000），让计算量更大，加速效果就会更突出。</p>
<h3 data-id="heading-4">❌ 反面案例：递归斐波那契</h3>
<p>再看一个反例——经典的递归斐波那契实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
<span class="hljs-built_in">print</span>(<span class="hljs-string">"JIT enabled:"</span>, sys._jit.is_enabled())
<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> perf_counter

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fib</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> n
    <span class="hljs-keyword">return</span> fib(n-<span class="hljs-number">1</span>) + fib(n-<span class="hljs-number">2</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start = perf_counter()
    result = fib(<span class="hljs-number">36</span>)
    <span class="hljs-built_in">print</span>(perf_counter() - start)

main()
</code></pre>
<p>截至 Python <code>3.15a3</code>，<strong>JIT 对这段代码几乎没有加速效果</strong>。</p>
<p>你可能会想：“是不是因为递归太深，JIT 不擅长处理？”但实测表明，即使改成循环版本，性能提升依然微乎其微。这说明当前 JIT 的优化策略对这类算法<strong>尚未覆盖</strong>，或者触发条件不满足。</p>
<h2 data-id="heading-5">使用建议：谨慎尝鲜，切勿冒进</h2>
<p>虽然 JIT 很有潜力，但它仍是实验性功能。对待它的态度，应该和“无线程构建”或“无 GIL 模式”一样：<strong>可以测试，但别急着上生产</strong>。</p>
<p>你可以：</p>
<ul>
<li>在自己的项目中开启 JIT，看看特定 workload 是否受益；</li>
<li>结合 <code>perf_counter()</code> 做 A/B 测试，量化实际收益；</li>
<li>关注后续 Python 版本的 JIT 改进。</li>
</ul>
<p>但务必注意：<strong>JIT 的行为在未来版本中可能发生变化</strong>。今天跑得快的代码，明天可能变慢；反之亦然。稳定性尚无法保证。</p>
<h2 data-id="heading-6">总结</h2>
<p>Python 原生 JIT 虽然还在襁褓之中，但已经展现出令人期待的潜力。随着 <code>3.15</code> 及后续版本的演进，我们有望看到更智能的编译策略、更广的适用场景，以及真正“开箱即用”的 Python 性能飞跃。现在，正是参与测试、反馈问题的好时机。</p>
<blockquote>
<p>原文<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoworld.com%2Farticle%2F4110565%2Fget-started-with-pythons-new-native-jit.html" target="_blank" title="https://www.infoworld.com/article/4110565/get-started-with-pythons-new-native-jit.html" ref="nofollow noopener noreferrer">www.infoworld.com/article/411…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不再费脑, 写给 AI 爱好者的矩阵 (Matrix) 入门指南]]></title>    <link>https://juejin.cn/post/7588109656042651694</link>    <guid>https://juejin.cn/post/7588109656042651694</guid>    <pubDate>2025-12-29T00:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588109656042651694" data-draft-id="7588104741610291210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不再费脑, 写给 AI 爱好者的矩阵 (Matrix) 入门指南"/> <meta itemprop="keywords" content="人工智能,AIGC,LLM"/> <meta itemprop="datePublished" content="2025-12-29T00:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="印刻君"/> <meta itemprop="url" content="https://juejin.cn/user/572216818014568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不再费脑, 写给 AI 爱好者的矩阵 (Matrix) 入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/572216818014568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    印刻君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:39:17.000Z" title="Mon Dec 29 2025 00:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好, 我是印刻君. 今天我们来聊 <strong>矩阵 (matrix)</strong>.</p>
<p>矩阵是 AI 背后的数学工具, 图像识别时会用到它, 同类推荐时会用到它, 大模型训练也会用到它. 它让 AI 能够批量处理数据. 如果我们想了解 AI 原理, 了解矩阵很有必要.</p>
<p>这篇文章, 我会以向量为基础, 引出 <strong>矩阵</strong> 的概念, 介绍矩阵的两种理解方式, 以及最常用的四种核心运算.</p>
<blockquote>
<p>不熟悉向量相关概念? 可以看我的文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FThGXnwta1kFgbpqlKozO3A" target="_blank" title="https://mp.weixin.qq.com/s/ThGXnwta1kFgbpqlKozO3A" ref="nofollow noopener noreferrer">不再费脑，写给 AI 爱好者的向量 (Vector) 入门课</a></p>
</blockquote>
<h2 data-id="heading-0">矩阵的两种理解方式</h2>
<h3 data-id="heading-1">1. 给苹果打分: 矩阵是多个向量的组合</h3>
<p>假设你是一家水果店的老板, 想知道一款苹果在大众心中的认可度, 于是你找来了 3 个员工小印, 小刻, 小君, 让他们根据自己的偏好给这款苹果打分 (分数无上限)</p>
<p>每个人的偏好都可以用一个向量表示, 打分过程就是偏好向量与苹果特征向量的计算</p>
<ul>
<li>
<p>小印是 "颜值党", 他挑选苹果只看重颜色, 完全不在乎甜不甜、脆不脆, 他的偏好向量是 (10, 0, 0). 打分结果是:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>10</mn><mo>×</mo><mn>0.9</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>0</mn><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>0</mn><mo>×</mo><mn>8</mn><mo stretchy="false">)</mo><mo>=</mo><mn>9</mn></mrow><annotation encoding="application/x-tex">(10 \times 0.9) + (0 \times 5) + (0 \times 8) = 9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.9</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9</span></span></span></span></span></p>
</li>
<li>
<p>小刻是 "口味党", 他完全不在乎颜色, 喜欢甜口但讨厌脆感, 他的偏好向量是 (0, 2, -1). 打分结果是:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo>×</mo><mn>0.9</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>2</mn><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo>×</mo><mn>8</mn><mo stretchy="false">)</mo><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">(0 \times 0.9) + (2 \times 5) + (-1 \times 8) = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.9</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span></span></span></span></span></p>
</li>
<li>
<p>小君是 "综合党", 他兼顾颜色, 甜度和脆度, 他的偏好向量是 (1, 1, 1). 打分解果是:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>×</mo><mn>0.9</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>×</mo><mn>8</mn><mo stretchy="false">)</mo><mo>=</mo><mn>13.9</mn></mrow><annotation encoding="application/x-tex">(1 \times 0.9 ) + (1 \times 5) + (1 \times 8) = 13.9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.9</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">13.9</span></span></span></span></span></p>
</li>
</ul>
<p>为了简化记录, 我们可以把3位员工的偏好向量 "一排排叠起来" 组成一个矩阵 A, 把苹果的特征向量 "竖起来" 写成向量 x, 最终的打分结果也竖起来写成向量 b. 这样就有了下面的式子:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.9</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13.9</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
10 &amp; 0 &amp; 0 \\
0 &amp; 2 &amp; -1 \\
1 &amp; 1 &amp; 1
\end{bmatrix}\cdot\begin{bmatrix}
0.9 \\
5 \\
8\end{bmatrix}=\begin{bmatrix}
9 \\
2 \\
13.9
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.9</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13.9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>简写为</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>x</mi><mo>=</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">A x = b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<p>这就是矩阵的第一种理解: <strong>矩阵是多个向量的组合</strong>。它能帮我们一次性完成多组规则相同的计算, 不用逐个单独运算.</p>
<h3 data-id="heading-2">2. 反推苹果特征: 矩阵是方程组的系数</h3>
<p>同样以水果店为例，这次我们换个场景: 你不知道苹果的具体特征（颜色、甜度、脆度都是未知的），但你手头有 3 位员工的打分结果，以及他们的评分标准. 现在你想反推这个苹果的具体特征, 应该怎么办呢?</p>
<p>我们假设颜色、甜度、脆度为 x1, x2, x3, 根据之前评分规则, 就可以列出一组方程:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>10</mn><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mn>0</mn><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mn>0</mn><msub><mi>x</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>9</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mn>2</mn><msub><mi>x</mi><mn>2</mn></msub><mo>−</mo><mn>1</mn><msub><mi>x</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>2</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mn>1</mn><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mn>1</mn><msub><mi>x</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>13.9</mn></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{cases}
10x_1 + 0x_2 + 0x_3 &amp;= 9 \\
0x_1 + 2x_2 - 1x_3 &amp;= 2 \\
1x_1 + 1x_2 + 1x_3 &amp;= 13.9
\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"/><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"/><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewbox="0 0 888.89 316" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"/><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"/><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewbox="0 0 888.89 316" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"/><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord">10</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord">0</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord">1</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span/></span></span></span></span><span class="arraycolsep" style="width:1em;"/><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">9</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">2</span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">13.9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>不难发现, 如果我们把 x1, x2, x3 的前面的系数提取出来, 它恰好就是一个矩阵:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
10 &amp; 0 &amp; 0 \\
0 &amp; 2 &amp; -1 \\
1 &amp; 1 &amp; 1
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>因此, 上面的方程组可以简写为矩阵形式:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>3</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13.9</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
10 &amp; 0 &amp; 0 \\
0 &amp; 2 &amp; -1 \\
1 &amp; 1 &amp; 1
\end{bmatrix}\cdot\begin{bmatrix}
x_1 \\
x_2 \\
x_3
\end{bmatrix}=\begin{bmatrix}
9 \\
2 \\
13.9
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13.9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>只要解这个矩阵方程, 我们就可以算出苹果的特征向量. 这就是矩阵的第二种核心理解：<strong>矩阵是线性方程组的系数集合</strong>。</p>
<h2 data-id="heading-3">矩阵的四种核心运算</h2>
<p>理解了矩阵是什么之后, 我们再来看它的四种核心运算. 这里不深入讲解复杂的运算性质, 重点讲清基础规则, 再结合AI领域的实际场景, 说说每种运算的用途.</p>
<h3 data-id="heading-4">1. 矩阵的加法/减法</h3>
<h4 data-id="heading-5">运算性质</h4>
<p>矩阵的加法和减法有个前提: 两个矩阵必须形状相同 (也就是行数和列数都完全一致), 否则无法计算.</p>
<p>计算方法很简单: 把两个矩阵对应位置的元素直接相加或相减即可.</p>
<p>举个例子，现有两个 2×2 的矩阵 A 和 B:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mspace width="1em"/><mi>B</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix}
1 &amp; 2 \\
3 &amp; 4
\end{bmatrix} \quad B = \begin{bmatrix}
5 &amp; 6 \\
7 &amp; 8
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>矩阵加法 A + B:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>+</mo><mn>5</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>+</mo><mn>6</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>3</mn><mo>+</mo><mn>7</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>4</mn><mo>+</mo><mn>8</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>12</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
1 + 5 &amp; 2 + 6 \\
3 + 7 &amp; 4 + 8
\end{bmatrix}=
\begin{bmatrix}
6 &amp; 8 \\
10 &amp; 12
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">12</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>矩阵减法: A - B:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>−</mo><mn>5</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>−</mo><mn>6</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>3</mn><mo>−</mo><mn>7</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>4</mn><mo>−</mo><mn>8</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>4</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>4</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>4</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>4</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
1 - 5 &amp; 2 - 6 \\
3 - 7 &amp; 4 - 8
\end{bmatrix}=
\begin{bmatrix}
-4 &amp; -4 \\
-4 &amp; -4
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">4</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">4</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<h4 data-id="heading-6">AI 领域的应用例子</h4>
<p>下面我们各举一下加法和减法在 AI 应用场景中的例子, 帮助你理解矩阵加法和减法的实际价值:</p>
<p><strong>加法例子: 大模型的位置编码</strong></p>
<p>大模型的 Transformer 架构中, Token 是被并行处理的, 本身没有位置信息, 比如它分不清 "我爱吃苹果" 和 “苹果爱吃我”.</p>
<blockquote>
<p>不熟悉 Transformer 架构, 可以看我的文章:  <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_JNT0A6ud8QtGpK319a8uw" target="_blank" title="https://mp.weixin.qq.com/s/_JNT0A6ud8QtGpK319a8uw" ref="nofollow noopener noreferrer">数学不好也能懂: 解读 AI 经典论文《Attention is All You Need》与大模型生成原理</a></p>
</blockquote>
<p>为了解决这个问题, 我们需要给每个词向量增加位置信息.</p>
<p>按照我们之前说的 <strong>矩阵是向量的组合</strong>, Transfromer 会先把词向量组合成一个 "词向量矩阵", 再生成一个记录位置信息的 "位置向量矩阵". 通过矩阵加法, 模型就能同时获取 “每个 Token 的含义” 和 “每个词的位置” 两个关键信息.</p>
<p><strong>减法例子: 监控中的运动检测</strong></p>
<p>我们先补充一点图像知识: 如果是黑白监控, 一帧画面里的每个像素点都能转换成一个亮度数值:</p>
<ul>
<li>0 = 纯黑</li>
<li>255 = 纯白</li>
<li>128 = 灰色</li>
</ul>
<p>这样一来, 一帧画面就可以看成一个 "像素矩阵".</p>
<p>运动检测的核心逻辑很简单: 先把没有物体移动的 "背景画面" 转换成 "背景矩阵", 再用实时的 "当前画面矩阵" 减去 "背景矩阵". 如果结果矩阵里的数值几乎都是 0, 说明画面静止; 如果某一块区域有明显数值, 就说明这块区域有物体在移动. 这就是最基础的运动检测算法</p>
<h3 data-id="heading-7">2. 矩阵的乘法</h3>
<h4 data-id="heading-8">运算性质</h4>
<p>矩阵乘法的规则比加减复杂一点, 首先要满足一个前提: <strong>第一个矩阵的列数, 必须等于第二个矩阵的行数</strong>, 否则无法计算.</p>
<p>它的计算方式是, 第一个矩阵的每一行的元素, 去和第二个矩阵的每一列的元素对应位置的元素相乘后, 再把所有的乘积加起来</p>
<p>听起来有点难懂, 我们举个例子, 假如有个 2 * 3 和 3 * 2 的矩阵 A 和 B</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mspace width="1em"/><mi>B</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix}
1 &amp; 2 &amp; 3\\
4 &amp; 5 &amp; 6
\end{bmatrix} \quad B = \begin{bmatrix}
1 &amp; 2\\
3 &amp; 4\\
5 &amp; 6
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>二者相乘</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/096ecb2afe724704bfe37f61bed6deb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573557&amp;x-signature=Qyaprmu1Jsji%2FHOF1EucIZxYBN4%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>我们先拿 A 的第一行和 B 的第一列对应相乘再相加</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn><mo>+</mo><mn>2</mn><mo>×</mo><mn>3</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>5</mn><mo>=</mo><mn>22</mn></mrow><annotation encoding="application/x-tex">1 \times 1 + 2 \times 3 + 3 \times 5 = 22</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">22</span></span></span></span></span></p>
</li>
<li>
<p>再拿 A 的第一行和 B 的第一列对应相乘再相加</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>2</mn><mo>+</mo><mn>2</mn><mo>×</mo><mn>4</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>6</mn><mo>=</mo><mn>28</mn></mrow><annotation encoding="application/x-tex">1 \times 2 + 2 \times 4 + 3 \times 6 = 28</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">6</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">28</span></span></span></span></span></p>
</li>
<li>
<p>再拿 A 的第二行和 B 的第一列对应相乘再相加</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>1</mn><mo>+</mo><mn>5</mn><mo>×</mo><mn>3</mn><mo>+</mo><mn>6</mn><mo>×</mo><mn>5</mn><mo>=</mo><mn>49</mn></mrow><annotation encoding="application/x-tex">4 \times 1 + 5 \times 3 + 6 \times 5 = 49</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">49</span></span></span></span></span></p>
</li>
<li>
<p>最后拿 A 的第二行和 B 的第二列对应相乘再相加</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>2</mn><mo>+</mo><mn>5</mn><mo>×</mo><mn>4</mn><mo>+</mo><mn>6</mn><mo>×</mo><mn>6</mn><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">4 \times 2 + 5 \times 4 + 6 \times 6 = 64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">6</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">64</span></span></span></span></span></p>
</li>
</ul>
<h4 data-id="heading-9">AI 应用例子</h4>
<p>矩阵乘法在推荐系统中用得很多, 比如视频 APP, 购物平台的 "猜你喜欢" 功能.</p>
<p>我们以推荐电影为例:</p>
<ul>
<li>构建一个用户矩阵 U: 每一行代表一个用户, 每一列代表一个用户特征 (比如 "喜欢科幻", "喜欢恐怖" 等）;</li>
<li>构建一个电影矩阵 M: 每一行代表一个电影特征 (和用户特征对应, 比如 "科幻程度", "恐怖程度" 等）. 每一列代表一部电影;</li>
<li>把用户矩阵 U 和电影矩阵 M 相乘, 得到一个 "兴趣矩阵 R". R里的每个数值, 都代表某个用户对某部电影的感兴趣程度. 数值越大, 越可能喜欢; 数值越小, 越不感兴趣.</li>
</ul>
<p>其实这个过程的本质, 就是用矩阵乘法计算 "用户向量" 和 "电影向量" 的相似度.</p>
<p>整个矩阵运算过程, 就是从用户矩阵中取出一行行的用户向量 u 去和电影向量 m 相乘:</p>
<p>向量的乘法公式是:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>u</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mo>=</mo><mi mathvariant="normal">∣</mi><mover accent="true"><mi>u</mi><mo>⃗</mo></mover><mi mathvariant="normal">∣</mi><mo>×</mo><mi mathvariant="normal">∣</mi><mover accent="true"><mi>m</mi><mo>⃗</mo></mover><mi mathvariant="normal">∣</mi><mo>×</mo><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\vec{u} \cdot \vec{v} = |\vec{u}| \times |\vec{m}| \times cos(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.714em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">u</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.714em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">u</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></p>
<p>其中 cos(θ) 是余弦相似度, 用来判断两个向量是否相似</p>
<p>如果我们把向量 u 和向量 m 都进行归一化处理, 也就是让它们都长度都为 1, 那么结果就变成了</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>u</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>m</mi><mo>⃗</mo></mover><mo>=</mo><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\vec{u} \cdot \vec{m} = cos(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.714em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">u</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.714em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></p>
<p>所以矩阵的乘法, 本质上就是批量计算多个向量之间的相似度.</p>
<h3 data-id="heading-10">3. 矩阵的转置</h3>
<h4 data-id="heading-11">运算性质</h4>
<p>矩阵的转置很简单, 就是把矩阵沿着对角线 (从左上到右下) 进行翻转, 通常写作 A<sup>T</sup> 或者 A<sup>′</sup></p>
<p>简单来说, 就是把矩阵的行写成列, 把列写成行</p>
<p>举个例子:</p>
<p>假设有一个 2 行 3 列的矩阵 A:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix}
1 &amp; 2 &amp; 3 \\
4 &amp; 5 &amp; 6 \\
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>A</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A^T = \begin{bmatrix}
1 &amp;  4 \\
2 &amp; 5 \\
3 &amp; 6 \\
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8913em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<h4 data-id="heading-12">AI 应用例子</h4>
<p>转置在 AI 中的核心作用, 是解决“矩阵形状不匹配”的问题. 我们之前说过, 矩阵乘法有个前提: 第一个矩阵的列数要等于第二个矩阵的行数.</p>
<p>在神经网络计算中, 经常会遇到两个矩阵包含有用数据, 但形状对不上, 无法直接相乘的情况. 这时候就可以用转置调整其中一个矩阵的行数和列数, 让它们满足乘法条件.</p>
<p>转置就像一个 "适配器", 帮两个矩阵顺利完成后续计算.</p>
<h3 data-id="heading-13">4. 矩阵的哈达玛积</h3>
<h4 data-id="heading-14">运算性质</h4>
<p>需要注意, 哈达玛积的计算规则, 和我们之前说的矩阵乘法完全不同, 它要求<strong>两个矩阵的形状完全一致</strong>, 也就是行数和列数相同. 它的计算方法是对应位置的元素直接相乘, 结果矩阵的形状和原来保持一致.</p>
<p>哈达玛积通常写作:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⊙</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \odot B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊙</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span></p>
<p>举个例子, 假设有两个 2 行 2 列的矩阵 A 和 B:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mspace width="1em"/><mi>B</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix}
1 &amp; 2\\
3 &amp; 4
\end{bmatrix} \quad B =
\begin{bmatrix}
5 &amp; 6\\
7 &amp; 8
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>它们的哈达玛积为:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>×</mo><mn>5</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>×</mo><mn>6</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>3</mn><mo>×</mo><mn>7</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>4</mn><mo>×</mo><mn>8</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>12</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>21</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>32</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
1 \times 5 &amp; 2 \times 6 \\
3 \times 7 &amp; 4 \times 8
\end{bmatrix} =
\begin{bmatrix}
5 &amp; 12 \\
21 &amp; 32
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">21</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">12</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">32</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<h4 data-id="heading-15">AI 应用例子</h4>
<p>哈达玛积的核心用途是 "筛选有效信息, 屏蔽无效信息", 最典型的场景是 Transformer 的掩码机制和图像处理的抠图.</p>
<p><strong>Transformer 的掩码机制</strong></p>
<p>Transformer 处理文本时, 为了防止 Transformer “偷看” 后面还没处理的词语, 需要用到 "掩码".</p>
<p>掩码的一种方法, 就是会生成一个由 0 和 1 的 "掩码矩阵", 再与输入特征进行哈达玛积, 结果矩阵中, 0 对应的位置会被屏蔽, 1 对应的位置保留原始信息, 从而实现 "不偷看" 的效果.</p>
<p><strong>图像处理中的抠图</strong></p>
<p>如果我们想把一个图像中的人像抠出来, 可以先做一个 "掩膜矩阵": 它的人像区域数值全是 1, 其余背景部分数值全部是 0</p>
<p>把图片对应的像素矩阵和掩膜矩阵做哈达玛积, 最终得到的矩阵就只保留了人像. 这就是最基础的抠图逻辑.</p>
<h2 data-id="heading-16">总结</h2>
<p>总结一下, 本文我们核心介绍了矩阵的两个核心理解和四种核心运算:</p>
<ol>
<li>
<p>矩阵的两个核心理解:
a. 多个向量的组合;
b. 线性方程组的系数集合;</p>
</li>
<li>
<p>矩阵的四种核心运算:
a. 加/减法 (形状相同, 对应元素运算);
b. 乘法 (批量计算向量相似度);
c. 转置 (调整形状, 适配运算); d. 哈达玛积 (筛选信息, 屏蔽无效内容).</p>
</li>
</ol>
<p>这些运算看似基础, 却是 AI 领域 (比如大模型, 推荐系统, 图像处理) 的核心数学工具, 理解它们的逻辑, 能帮我们更好地看懂AI技术的底层原理.</p>
<p>我是印刻君, 一位探索 AI 的前端程序员, 关注我, 让 AI 知识有温度, 技术落地有深度.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DevEco Studio 使用技巧全面解析]]></title>    <link>https://juejin.cn/post/7588999772749627427</link>    <guid>https://juejin.cn/post/7588999772749627427</guid>    <pubDate>2025-12-29T06:24:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588999772749627427" data-draft-id="7588996730772045824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DevEco Studio 使用技巧全面解析"/> <meta itemprop="keywords" content="前端,前端框架,HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-29T06:24:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Keya"/> <meta itemprop="url" content="https://juejin.cn/user/870468938379671"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DevEco Studio 使用技巧全面解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/870468938379671/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Keya
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T06:24:12.000Z" title="Mon Dec 29 2025 06:24:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    54
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">DevEco Studio 使用技巧全面解析</h2>
<h3 data-id="heading-1">引言</h3>
<p>在鸿蒙生态蓬勃发展的当下，DevEco Studio作为华为提供的一站式集成开发环境，专为鸿蒙操作系统应用和服务开发设计。掌握其使用技巧，能够大幅提升开发效率，让开发者更加专注于应用的创新和实现。本文将从快捷键、实用功能、界面操作等多个方面，为你详细介绍DevEco Studio的使用技巧。</p>
<h3 data-id="heading-2">快捷键大全</h3>
<h4 data-id="heading-3">编辑类快捷键</h4>
<p>编辑是开发过程中最频繁的操作，以下快捷键能让代码编写、修改更流畅：</p>





























































































































<table><thead><tr><th>快捷键(Win)</th><th>快捷键（Mac）</th><th>中文说明</th></tr></thead><tbody><tr><td>Alt + J</td><td>^G</td><td>选择相同词，设置多个光标。（常用，批量选中）</td></tr><tr><td>Alt + 1</td><td>⌘1</td><td>显示 或 隐藏 项目区。（常用）</td></tr><tr><td>Ctrl + E</td><td>⌘E</td><td>最近的文件（常用，切换文件、切换面板，强烈推荐）</td></tr><tr><td>Ctrl + P</td><td>⌘P</td><td>展示方法的参数信息。（常用，类型提示神器）</td></tr><tr><td>Ctrl + Q</td><td>无</td><td>展示组件的 API 说明文档。（常用，查文档神器）</td></tr><tr><td>Ctrl + Alt + L</td><td>⌥⌘L</td><td>格式化代码 。（推荐设置保存自动格式化）</td></tr><tr><td>Shift + Enter</td><td>⇧↩</td><td>换行输入。（常用，换行添加新属性）</td></tr><tr><td>Ctrl + 单击 / Ctrl + B</td><td>⌘单击 / ⌘B</td><td>跳转源码、跳转文件。（常用，强烈推荐）</td></tr><tr><td>Ctrl + Alt + T</td><td>⌥⌘T</td><td>自动生成具有环绕性质的代码。（推荐，生成 <code>if…else,try…catch</code> 等代码块）</td></tr><tr><td>Ctrl + /</td><td>⌘/</td><td>单行注释 <code>//</code> （常用）</td></tr><tr><td>Ctrl + Shift + /</td><td>⌥⌘/</td><td>代码块注释 <code>/**/</code> （常用）</td></tr><tr><td>Tab / Shift + Tab</td><td>Tab / ⇧Tab</td><td>缩进或者不缩进一次所选择的代码段。（常用）</td></tr><tr><td>Ctrl + X</td><td>⌘X</td><td>剪切选中代码、剪切行、删除行。 （常用）</td></tr><tr><td>Ctrl + C</td><td>⌘C</td><td>复制选中代码、复制行。 （常用）</td></tr><tr><td>Ctrl + D</td><td>⌘D</td><td>复印选中代码、复印行。（常用）</td></tr><tr><td>Ctrl + V</td><td>⌘V</td><td>粘贴代码。（常用）</td></tr><tr><td>Ctrl + Shift + V</td><td>⇧⌘V</td><td>剪贴板，复制过的内容都在这里。（推荐）</td></tr><tr><td>Ctrl + Z</td><td>⌘Z</td><td>撤消。（常用）</td></tr><tr><td>Ctrl + Shift + Z / Ctrl + Y</td><td>⇧⌘Z</td><td>重做。</td></tr><tr><td>Ctrl + Shift + J</td><td>^⇧J</td><td>把下一行的代码接续到当前的代码行。（常用，合并行）</td></tr><tr><td>Ctrl + Shift + U</td><td>⇧⌘U</td><td>切换大小写。（推荐）</td></tr><tr><td>Ctrl + (+/-)</td><td>⌘+ / ⌘-</td><td>折叠或展开代码。 （推荐）</td></tr><tr><td>Shift + F6</td><td>⇧F6</td><td>重构修改命名。（常用，能同步更新路径、变量名、函数名的重命名）</td></tr></tbody></table>
<h4 data-id="heading-4">查找与替换快捷键</h4>
<p>高效的查找和替换能减少重复劳动，提升代码维护效率：</p>



































<table><thead><tr><th>快捷键(Win)</th><th>快捷键（Mac）</th><th>中文说明</th></tr></thead><tbody><tr><td>Ctrl + F</td><td>⌘F</td><td>在当前文件中查找</td></tr><tr><td>Ctrl + R</td><td>⌘R</td><td>替换文本</td></tr><tr><td>Ctrl + Shift + F</td><td>⇧⌘F</td><td>在文件中查找</td></tr><tr><td>Ctrl + Shift + R</td><td>⇧⌘R</td><td>在文件中替换</td></tr><tr><td>Shift + Shift</td><td>Shift + Shift</td><td>快速查找</td></tr></tbody></table>
<h4 data-id="heading-5">编译与运行快捷键</h4>
<p>编译和运行是开发过程中的关键步骤，这些快捷键让操作更高效：</p>






























<table><thead><tr><th>快捷键(Win)</th><th>快捷键（Mac）</th><th>中文说明</th></tr></thead><tbody><tr><td>Shift + F10</td><td>^R</td><td>运行 entry。 （常用，特别好用）</td></tr><tr><td>Shift + F9</td><td>^D</td><td>调试 entry。</td></tr><tr><td>Alt + Shift + F10</td><td>^⌥D</td><td>会打开一个已经配置的运行列表，让你选择一个后，再运行。</td></tr><tr><td>Alt + Shift + F9</td><td>^⌥D</td><td>会打开一个已经配置的运行列表，让你选择一个后，再以调试模式运行。</td></tr></tbody></table>
<h4 data-id="heading-6">调试快捷键</h4>
<p>高效的调试能力是解决问题的关键，以下是常用的调试快捷键：</p>

































<table><thead><tr><th>快捷键</th><th>中文说明</th></tr></thead><tbody><tr><td>F8</td><td>步过（执行下一行，不进入方法）</td></tr><tr><td>F7</td><td>步入（进入调用的方法）</td></tr><tr><td>Alt + F9</td><td>运行到光标处</td></tr><tr><td>Alt + F8</td><td>评估表达式</td></tr><tr><td>F9</td><td>恢复程序运行（跳到下一个断点）</td></tr><tr><td>Ctrl + Shift + F8</td><td>查看断点</td></tr></tbody></table>
<h3 data-id="heading-7">实用功能介绍</h3>
<h4 data-id="heading-8">代码高亮</h4>
<p>代码高亮功能可以让代码中的关键类、运算符、字符串等重要部分以高亮形式呈现。在DevEco Studio中，我们可以通过简单的设置来自定义高亮显示。打开 <code>File &gt; Settings</code> （Windows系统）或 <code>DevEco Studio &gt; Preferences</code> （macOS系统），然后找到<code>Editor &gt; Code Style</code> 选项，在这里可以自定义各字段的高亮显示颜色。</p>
<h4 data-id="heading-9">代码跳转</h4>
<p>在阅读和编辑复杂代码时，快速定位函数、方法等定义的位置至关重要。DevEco Studio提供了便捷的代码跳转功能。只需使用快捷键<code>Ctrl</code> （Windows系统）或 <code>Command</code> （macOS系统）并配合鼠标单击，就能直接跳转到代码中引用的目标定义处。而且，当存在多个引用目标时，还会弹出选择窗口，方便我们准确找到想要查看的定义。</p>
<h4 data-id="heading-10">跨语言跳转</h4>
<p>对于涉及跨语言开发，特别是声明调用了Native接口的项目，DevEco Studio的跨语言跳转功能十分实用。在代码中选中相关调用，然后选择 <code>Go To &gt; Implementation(C++)</code> ，就能迅速跳转到对应的C++实现代码处。这一功能极大地提高了联合开发时不同语言代码之间的切换和查阅效率，减少了在不同文件和语言之间切换的繁琐操作。</p>
<h4 data-id="heading-11">代码格式化</h4>
<p>代码格式化功能可以帮我们快速整理代码的缩进和结构。默认情况下，它已经有一套代码格式化配置，但我们也可以根据自己的喜好进行调整。通过<code>File &gt; Settings</code> （Windows系统）或 <code>DevEco Studio &gt; Preferences</code> （macOS系统）进入<code>Editor &gt; Code Style</code> ，在这里可以设置各种格式化规则。使用快捷键<code>Ctrl + Alt + L</code> （Windows系统）或 <code>Option + Command + L</code> （macOS系统），就能对选定的代码进行格式化。此外，还能设置在代码中添加特定的格式化标记，让代码在格式化时更符合我们的需求。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//@formatter:off</span>
<span class="hljs-comment">// 此区域内的代码将跳过自动格式化</span>
<span class="hljs-keyword">const</span> specialFormatting = {
<span class="hljs-attr">needToKeep</span>: <span class="hljs-string">"original_format"</span>
};
<span class="hljs-comment">//@formatter:on</span>
</code></pre>
<h4 data-id="heading-12">代码折叠</h4>
<p>当代码量较大时，代码折叠功能可以帮助我们隐藏不必要的代码块，使代码结构更加简洁明了。我们可以通过右键菜单选择相应的折叠选项，也可以使用快捷键实现代码的折叠与展开。比如，使用快捷键 <code>Ctrl + Shift + -</code> （Windows系统）或 <code>Command + Shift + -</code> （macOS系统）可以全部折叠代码，方便我们从整体上把握代码的逻辑结构。</p>
<h4 data-id="heading-13">代码快速注释</h4>
<p>给代码添加注释是良好的编程习惯，但手动逐行添加注释有时比较繁琐。DevEco Studio提供了代码快速注释功能，使用快捷键<code>Ctrl + /</code> （Windows系统）或 <code>Command + /</code> （macOS系统），就能快速为选中的代码行添加注释，再次使用则可以取消注释。这一功能让注释编写变得轻松快捷，有助于提高代码的可读性和可维护性。</p>
<h4 data-id="heading-14">代码结构树</h4>
<p>代码结构树功能可以让我们快速了解文件的代码架构。通过快捷键<code>Alt + 7</code> （Windows系统）或 <code>Command + 7</code> （macOS系统）打开代码结构树窗口，在这里我们可以清晰地看到文件中全局变量、函数、类的成员变量和方法等内容，并且可以直接点击跳转到对应的代码行，方便我们在复杂的代码文件中快速定位关键部分。
<img src="https://s.coze.cn/image/jp3fKP6a9iw/" alt="代码结构树转存失败，建议直接上传图片文件" loading="lazy"/></p>
<h4 data-id="heading-15">代码引用查找</h4>
<p>在大型项目中，了解代码中某个符号的引用关系十分重要。DevEco Studio的代码引用查找功能可以帮助我们实现这一点。使用快捷键<code>Alt + F7</code> （Windows系统）或<code>Option + F7</code> （macOS系统），或者通过右键菜单选择相关选项，就能在代码编辑区快速查找符号被引用的位置。这有助于我们理解代码的调用逻辑，排查问题时也能更加高效。</p>
<h4 data-id="heading-16">函数注释生成</h4>
<p>在定义函数时，手动编写详细的注释往往比较耗时。DevEco Studio提供了函数注释生成功能，在定义函数的代码编辑区，输入“/**” ，就能快速生成函数注释模板。这一功能支持多种语言，如C++等，极大地提高了函数注释的编写速度，让我们的代码更加规范和易于理解。</p>
<h4 data-id="heading-17">代码导航</h4>
<p>代码导航功能可以帮助我们在文件、类型文件的标签之间快速切换和定位。通过代码导航，我们可以快速找到相关的文件和工程资源，特别是在大型项目中，多个文件和模块相互关联时，这一功能能让我们更加便捷地在代码之间穿梭，提高开发效率。</p>
<h4 data-id="heading-18">快速查阅API接口及组件参考文档</h4>
<p>在编辑代码过程中，当遇到不熟悉的API接口或组件时，DevEco Studio能让我们快速查阅相关参考文档。当API/组件被高亮显示时，编辑器会迅速显示对应的参考文档链接，我们只需单击就能查阅详细内容。此外，对于带有<code>decorate</code> 和 <code>obsolete</code> 标识的API，也有相应的显示和关注方式，方便我们及时了解API的状态和使用注意事项。</p>
<h4 data-id="heading-19">Optimize Import功能</h4>
<p>在项目开发过程中，代码中的 <code>import</code> 语句可能会变得杂乱，存在未使用的导入等情况。DevEco Studio的 <code>Optimize Import</code> 功能可以帮助我们优化这些导入语句。使用快捷键<code>Ctrl+Alt+O</code> （Windows系统）或 <code>Control+Option+O</code> （macOS系统），并选择 <code>Code &gt; Optimize Imports</code> ，就能自动移除未使用的导入，整理导入语句的顺序，让我们的代码更加简洁、规范。</p>
<h3 data-id="heading-20">界面操作技巧</h3>
<h4 data-id="heading-21">界面布局认识</h4>
<p>DevEco Studio界面布局遵循“高效开发流”设计，核心区域分工明确，无需额外配置即可满足基础开发需求：</p>
<ol>
<li><strong>核心功能菜单区</strong>：集成项目创建（File）、编辑工具（Edit）、运行调试（Run）等全流程操作入口，支持通过快捷键快速调用（如<code>Ctrl+N</code> 新建文件）。</li>
<li><strong>项目文件导航区</strong>：以树形结构展示项目文件，支持“按模块筛选”“关键词搜索”，右键菜单可直接创建页面/组件，大幅提升文件管理效率。</li>
<li><strong>代码编辑区</strong>：支持ArkTS语法高亮、自动缩进、括号匹配，内置“代码折叠”功能（点击左侧<code>-</code> 符号），可折叠复杂布局代码，聚焦当前编辑内容。</li>
<li><strong>快捷工具栏区</strong>：包含项目视图切换（Project/Structure）、代码格式化（<code>Ctrl+Alt+L</code> ）、版本控制等高频操作按钮，减少菜单层级跳转。</li>
<li><strong>运行与设备控制区</strong>：一键切换运行设备（模拟器/真机），支持“运行”（▶️）、“调试”（🐞）、“热重载”（♻️），修改代码后无需重启应用即可预览效果。</li>
<li><strong>辅助功能区</strong>：集成“问题检查”（实时显示语法错误）、“终端”（执行ohpm命令）、“预览器”（UI实时渲染），一站式解决开发中的辅助需求。
<img src="https://s.coze.cn/image/uziKtIIcJqY/" alt="DevEco Studio界面" loading="lazy"/></li>
</ol>
<h4 data-id="heading-22">目录精简操作</h4>
<ol>
<li><strong>基础精简</strong>：左侧Project面板顶部，点击“Project”下拉菜单，选择“Project Files”，隐藏冗余配置目录。</li>
<li><strong>深度精简</strong>：选择“Ohos”视图，仅保留与业务开发相关的核心目录（如<code>pages</code> 、 <code>resources</code> ），进一步减少视觉干扰。</li>
</ol>
<h4 data-id="heading-23">模拟器操作指南</h4>

























<table><thead><tr><th>操作</th><th>路径/指令</th><th>效果</th></tr></thead><tbody><tr><td>新建模拟器</td><td><code>Tools &gt; Device Manager &gt; New</code></td><td>添加P50/Pixel等设备镜像</td></tr><tr><td>旋转屏幕</td><td>模拟器面板点击🔄图标</td><td>测试横竖屏适配</td></tr><tr><td>模拟传感器</td><td>面板右上角⚡ &gt; Simulate Sensor</td><td>调试GPS/光线传感器</td></tr></tbody></table>
<p><img src="https://s.coze.cn/image/KJov_8rxeZA/%3E" alt="模拟器界面" loading="lazy"/></p>
<h4 data-id="heading-24">异常排查技巧</h4>

























<table><thead><tr><th>现象</th><th>定位方法</th><th>修复方案</th></tr></thead><tbody><tr><td>预览器白屏</td><td>检查<code>build()</code> 函数返回值</td><td>确保返回单个根组件（如<code>Column</code>）</td></tr><tr><td>页面跳转失败</td><td>查看<code>router.push</code> 路径</td><td>确认目标页已在 <code>main_pages.json</code> 注册</td></tr><tr><td>应用启动闪退</td><td>查看<code>Logcat</code>日志</td><td>过滤<code>HARMONY</code> 标签定位原生层错误</td></tr></tbody></table>
<h3 data-id="heading-25">扩展工具链</h3>
<h4 data-id="heading-26">自动化测试</h4>
<p>使用<code>@ohos/hypium</code> 框架编写UI测试脚本，实现自动化测试，提高测试效率和准确性。</p>
<h4 data-id="heading-27">发布应用前必做</h4>
<ol>
<li><strong>代码混淆</strong>：启用<code>build.gradle</code>中的<code>minifyEnabled true</code>缩减体积，保护代码安全。</li>
<li><strong>签名配置</strong>：通过<code>Project Structure &gt; Signing Configs</code>添加华为AppGallery证书，确保应用可以正常发布。</li>
<li><strong>编译HAP</strong>：执行<code>Build &gt; Build HAP(s)</code>生成安装包，准备发布应用。</li>
</ol>
<h3 data-id="heading-28">总结</h3>
<p>DevEco Studio作为鸿蒙生态的官方开发工具，提供了丰富的功能和便捷的操作方式。掌握这些使用技巧，能够让开发者在鸿蒙应用开发过程中事半功倍，更加高效地完成应用的开发和调试。希望本文的介绍能够帮助你更好地使用DevEco Studio，开发出更加优秀的鸿蒙应用。</p>
<hr/>
<p>End</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你用 Go + Eino 搭建一个企业级 RAG 知识库（含代码与踩坑）]]></title>    <link>https://juejin.cn/post/7588445332771733558</link>    <guid>https://juejin.cn/post/7588445332771733558</guid>    <pubDate>2025-12-28T20:46:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445332771733558" data-draft-id="7588445332771717174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你用 Go + Eino 搭建一个企业级 RAG 知识库（含代码与踩坑）"/> <meta itemprop="keywords" content="后端,人工智能,Go"/> <meta itemprop="datePublished" content="2025-12-28T20:46:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你用 Go + Eino 搭建一个企业级 RAG 知识库（含代码与踩坑）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T20:46:07.000Z" title="Sun Dec 28 2025 20:46:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>RAG（检索增强生成）是目前解决大模型幻觉最有效的手段。但网上的教程大多是 Python + LangChain 的 Demo，一到生产环境就各种问题。</p>
</blockquote>
<blockquote>
<p>本文将基于 <strong>字节跳动 Eino</strong> 框架和 <strong>Milvus</strong> 向量数据库，手把手带你用 Go 语言实现一个<strong>支持混合检索、文档切分、向量化</strong>的企业级 RAG 系统。</p>
</blockquote>
<h2 data-id="heading-0">一、 为什么你的 RAG 效果很差？</h2>
<p>很多同学照着网上的教程写了个 RAG，结果发现效果惨不忍睹：</p>
<ol>
<li><strong>切分太粗</strong>：把整段文本直接向量化，导致检索时丢失细节。</li>
<li><strong>检索不准</strong>：只用向量搜索（Dense Search），搜“Java 高级”却出来“Java 入门”。</li>
<li><strong>数据陈旧</strong>：知识库更新慢，甚至不支持实时插入。</li>
</ol>
<p><strong>企业级 RAG 的核心在于：精细化的 ETL + 混合检索策略。</strong></p>
<hr/>
<h2 data-id="heading-1">二、 架构设计：Eino RAG 链路</h2>
<p>在 Eino 中，RAG 不再是简单的 Function Call，而是一套标准的流水线：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Doc[Markdown/PDF文档] --&gt; Splitter[文档切分器]
    Splitter --&gt; Embedding[向量化模型]
    Embedding --&gt; Milvus[Milvus 向量库]
    
    User[用户提问] --&gt; Filter[意图识别/Filter构建]
    Filter --&gt; Retriever[混合检索器]
    Retriever --&gt; LLM[大模型生成]
</code></pre>
<hr/>
<h2 data-id="heading-2">三、 实战：从文档到检索</h2>
<h3 data-id="heading-3">3.1 步骤一：文档切分（Chunking）</h3>
<p>我们不能把一整本书丢给大模型。
在项目中，我实现了一个基于 <strong>Markdown 语义</strong> 的切分器。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/internal/eino/milvus/splitter/markdown.go</span>

<span class="hljs-comment">// 核心逻辑：按 H1/H2 标题进行切分，保留上下文</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SplitMarkdown</span><span class="hljs-params">(content <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">string</span> {
    chunks := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>)
    <span class="hljs-comment">// ... 正则匹配 # 标题</span>
    <span class="hljs-comment">// ... 递归切分</span>
    <span class="hljs-keyword">return</span> chunks
}
</code></pre>
<p><strong>经验</strong>：不要用固定字符数（如 500字）切分！一定要按 <strong>语义（段落/标题）</strong> 切分，否则会把完整的逻辑打断。</p>
<h3 data-id="heading-4">3.2 步骤二：向量化与入库</h3>
<p>我们使用 <code>text-embedding-3-small</code> 模型进行向量化，存入 Milvus。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/internal/eino/milvus/importer.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ImportKnowledge</span><span class="hljs-params">(ctx context.Context, files []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">for</span> _, file := <span class="hljs-keyword">range</span> files {
        <span class="hljs-comment">// 1. 读取并切分</span>
        chunks := splitter.Split(file)
        
        <span class="hljs-comment">// 2. 批量向量化 (Batch Embedding)</span>
        vectors, _ := embeddingModel.EmbedStrings(ctx, chunks)
        
        <span class="hljs-comment">// 3. 存入 Milvus</span>
        <span class="hljs-comment">// 注意：我们同时存储了 Metadata（如语言、难度、分类）</span>
        milvusClient.Insert(ctx, collectionName, <span class="hljs-string">""</span>, columns...)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-5">3.3 步骤三：混合检索（Hybrid Search）</h3>
<p>这是 RAG 效果好坏的关键！
我们不能只查向量，必须结合<strong>标量过滤</strong>。</p>
<p><strong>场景</strong>：用户问“给我出一道 <strong>Redis</strong> 的 <strong>高级</strong> 面试题”。
如果只查向量，可能会搜出“Redis 基础命令”。
必须加上过滤条件：<code>category == 'Redis' &amp;&amp; difficulty == 'Hard'</code>。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/internal/eino/milvus/retrieval/retriever.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *RetrieverService)</span></span> Retrieve(ctx context.Context, query <span class="hljs-type">string</span>) ([]*schema.Document, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 动态构建 Filter</span>
    <span class="hljs-comment">// 这里其实可以用一个小模型先做意图识别，提取 Filter 条件</span>
    expr := <span class="hljs-string">"category == 'Redis' &amp;&amp; difficulty == 'Hard'"</span>
    
    <span class="hljs-comment">// 2. 调用 Milvus 进行混合检索</span>
    <span class="hljs-comment">// Eino 的 Retriever 接口完美支持这种高级操作</span>
    docs, err := s.client.Search(ctx, s.collection, expr, queryVector)
    
    <span class="hljs-keyword">return</span> docs, <span class="hljs-literal">nil</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-6">四、 效果对比</h2>

























<table><thead><tr><th align="left">指标</th><th align="left">传统 RAG (LangChain 默认)</th><th align="left">Eino 企业级 RAG (本项目)</th></tr></thead><tbody><tr><td align="left"><strong>检索准确率</strong></td><td align="left">约 60%</td><td align="left"><strong>&gt; 95%</strong> (含混合检索)</td></tr><tr><td align="left"><strong>响应速度</strong></td><td align="left">慢 (Python 串行处理)</td><td align="left"><strong>快</strong> (Go 并发处理)</td></tr><tr><td align="left"><strong>代码可维护性</strong></td><td align="left">差 (黑盒)</td><td align="left"><strong>好</strong> (强类型接口)</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">五、 源码送给你</h2>
<p>为了让大家少走弯路，我把这套 <strong>Go + Eino + Milvus</strong> 的 RAG 系统源码开源出来了。
它包含：</p>
<ol>
<li><strong>Markdown/PDF 解析器</strong></li>
<li><strong>Milvus 客户端封装</strong></li>
<li><strong>Hybrid Search 实现逻辑</strong></li>
<li><strong>知识库导入脚本</strong></li>
</ol>
<p>👉 <strong>获取方式：</strong></p>
<p>关注掘金专栏，或关注公众号【<strong>王中阳</strong>】，回复“<strong>面试吧</strong>”，即可获取完整源码和部署文档。</p>
<p>私信我的绿泡泡：wangzhongyang1993，备注“<strong>掘金</strong>”，拉你进技术交流群，手把手教你搭建自己的企业知识库！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入防抖与节流：从闭包原理到性能优化实战]]></title>    <link>https://juejin.cn/post/7589454621719871538</link>    <guid>https://juejin.cn/post/7589454621719871538</guid>    <pubDate>2025-12-30T10:50:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589454621719871538" data-draft-id="7589509638354354203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入防抖与节流：从闭包原理到性能优化实战"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-30T10:50:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入防抖与节流：从闭包原理到性能优化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T10:50:52.000Z" title="Tue Dec 30 2025 10:50:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="atelier-lakeside-light">.hljs-comment,.hljs-quote{color:#5a7b8c}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d22d72}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#935c25}.hljs-bullet,.hljs-string,.hljs-symbol{color:#568c3b}.hljs-section,.hljs-title{color:#257fad}.hljs-keyword,.hljs-selector-tag{color:#6b6bb8}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#ebf8ff;color:#516d7b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在前端开发中，<strong>防抖（Debounce）</strong> 与 <strong>节流（Throttle）</strong> 是两种经典的性能优化技术，广泛应用于搜索建议、滚动加载、窗口缩放等高频事件场景。它们能有效减少不必要的函数调用，避免页面卡顿或请求爆炸。</p>
<p>要深入理解其实现原理，你需要掌握以下核心知识点：</p>
<p><strong>闭包（Closure）</strong> ：用于在函数返回后仍能“记住”并访问内部变量（如定时器 ID 或时间戳）</p>
<p>对于闭包，我写了这两篇文章</p>
<p><a href="https://juejin.cn/post/7588461466597883955" target="_blank" title="https://juejin.cn/post/7588461466597883955">柯里化：用闭包编织参数的函数流水线</a></p>
<p><a href="https://juejin.cn/post/7577345758036869120" target="_blank" title="https://juejin.cn/post/7577345758036869120">JavaScript 词法作用域与闭包：从底层原理到实战理解</a></p>
<p><strong>this 与参数的正确传递</strong>：确保被包装的函数在正确上下文中运行。</p>
<p>对于this，有不懂的可以参考这篇文章：</p>
<p><a href="https://juejin.cn/post/7579819594271014950" target="_blank" title="https://juejin.cn/post/7579819594271014950">this 不是你想的 this：从作用域迷失到调用栈掌控</a></p>
<p>本文将结合生活类比、代码实现与真实场景，带你一步步拆解防抖与节流的机制、差异与应用之道。即使你曾觉得它们“有点绕”，读完也会豁然开朗。</p>
<h2 data-id="heading-1">一、问题背景：输入框频繁触发事件</h2>
<p>全部代码在后面的附录</p>
<p>在 Web 开发中，用户在输入框中打字时，常会绑定 <code>keyup</code> 事件来实时响应输入内容。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1.html Lines 17-19</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ajax</span>(<span class="hljs-params">content</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ajax request'</span>, content);
}
</code></pre>
<pre><code class="hljs language-Javascript" lang="Javascript"><span class="hljs-comment">// 1.html Lines 64-66</span>
inputa.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keyup'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-title function_">ajax</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// 复杂操作</span>
});
</code></pre>
<p><strong>问题</strong>：每当用户输入一个字符，就会触发一次 <code>ajax()</code> 调用。若用户输入 “hello”，将产生 <strong>5 次请求</strong>，造成不必要的网络开销和性能浪费。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8281b4c1b367452385446e94a3d92b3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767696651&amp;x-signature=NhANBb8NFf%2BTxF4DEsdNT4n6Gng%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">二、防抖（Debounce）机制</h2>
<p>想象你站在电梯里，正等着门关上。</p>
<p>可就在这时，一个路人匆匆跑进来，门立刻重新打开；还没等它合拢，又一个人冲了进来……只要不断有人进入，电梯就会一直“耐心”地等下去。</p>
<p><strong>我站在里面心想</strong>：“这门到底什么时候才关啊？”</p>
<p>直到最后，整整几秒钟没人再进来——终于，“叮”一声，门缓缓合上，电梯开始运行。</p>
<blockquote>
<p>这就像<strong>防抖</strong>：只要事件还在频繁触发，函数就一直“等”；只有当触发停歇了一段时间，它才真正执行。</p>
</blockquote>
<blockquote>
<p>这种“按节奏执行”的思想，不仅存在于游戏中，也广泛应用于 Web 交互。</p>
</blockquote>
<p>一些AI编辑器  ( 比如Trae Cursor )就是这样</p>
<p>当你在代码框里飞快敲字时，它并不会每按一个键就立刻分析整段逻辑或发起智能补全请求。</p>
<p>那样做不仅浪费资源，还会拖慢输入体验。</p>
<p>相反，它会默默“观察”你的输入节奏：</p>
<blockquote>
<p><strong>只要你还在连续打字，它就耐心等待；一旦你停顿半秒，它才迅速介入，给出精准建议</strong>。</p>
</blockquote>
<h3 data-id="heading-3">代码实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1.html Lines 21-30</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> id; <span class="hljs-comment">// 闭包中的自由变量，用于保存定时器 ID</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (id) <span class="hljs-built_in">clearTimeout</span>(id); <span class="hljs-comment">// 清除上一次的定时器</span>
    <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;
    id = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      fn.<span class="hljs-title function_">apply</span>(that, args);
    }, delay);
  };
}
</code></pre>
<h3 data-id="heading-4">关键点解析</h3>
<p>防抖函数通过闭包维护一个共享的定时器标识 <code>id</code>，使得多次事件触发都能访问并操作同一个状态。</p>
<p>每当用户触发事件（如键盘输入），函数会先清除之前尚未执行的定时器（如果存在），然后重新启动一个延迟为 <code>delay</code> 毫秒的新定时器</p>
<p>这意味着只要用户持续操作，计时就会不断重置，真实逻辑始终被推迟；只有当用户停止操作并经过指定的等待时间后，目标函数才会真正执行。</p>
<p>以 <code>delay = 500ms</code> 为例，若用户在 200ms 内快速输入 “hello”，每次按键都会打断之前的倒计时，最终仅在最后一次输入结束 500ms 后调用一次 <code>ajax("hello")</code>。整个过程将原本可能触发 5 次的请求压缩为 1 次，在保证响应合理性的同时，显著降低了系统开销。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/113b191e8b064c2a90f091e3af17f807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767696651&amp;x-signature=%2BQvPU7OUSdquiCw9E2tGVrVVM8w%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">使用示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1.html Lines 58-69</span>
<span class="hljs-keyword">const</span> debounceAjax = <span class="hljs-title function_">debounce</span>(ajax, <span class="hljs-number">500</span>);

inputb.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keyup'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-title function_">debounceAjax</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
});
</code></pre>
<hr/>
<h2 data-id="heading-6">三、节流（Throttle）机制</h2>
<h3 data-id="heading-7">核心思想</h3>
<blockquote>
<p><strong>在固定时间间隔内，最多执行一次函数。</strong></p>
</blockquote>
<p>我正在玩一款FPS游戏，手指死死按住鼠标左键疯狂扫射——</p>
<p>可游戏里的枪根本没跟着我的节奏“突突突”到底。明明我一秒点了十下，它却稳稳地“哒、哒、哒”，每隔固定时间才射出一发子弹。</p>
<p>后来我才明白：这不是卡顿，而是<strong>射速限制</strong>在起作用。无论我多着急、按得多快，系统都会冷静地按自己的节奏来，既不让火力过猛破坏平衡，也不让我白白浪费弹药。</p>
<blockquote>
<p>这就像<strong>节流</strong>：不管事件触发得多密集，函数都坚持“定时打卡”，不多不少，稳稳执行。</p>
</blockquote>
<blockquote>
<p>这种设计哲学，同样被现代开发工具所采纳</p>
</blockquote>
<p>比如京东等电商平台：鼠标滚动时，页面需要不断判断是否已滑动到商品列表底部，从而决定是否自动加载下一页商品。</p>
<p>如果对每一次滚动事件都立即响应，浏览器会因频繁计算和发起网络请求而卡顿，尤其在低端设备上体验更差。</p>
<blockquote>
<p>于是，开发者会使用<strong>节流</strong>机制——将滚动处理函数限制为每 200~300 毫秒最多执行一次。这样，即使用户快速拖动滚动条，系统也只会在固定间隔“抽样”检查位置，既保证了加载的及时性，又避免了性能过载。</p>
</blockquote>
<p>换句话说：<strong>我不在乎你滚得多快，我只按自己的节奏干活</strong>——这正是节流在真实场景中的价值。</p>
<h3 data-id="heading-8">代码实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1.html Lines 32-52</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> last = <span class="hljs-number">0</span>;       <span class="hljs-comment">// 上次执行的时间戳</span>
  <span class="hljs-keyword">let</span> deferTimer = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (last &amp;&amp; now &lt; last + delay) {
      <span class="hljs-comment">// 还未到下次执行时间：延迟执行，并确保最后一次能触发</span>
      <span class="hljs-built_in">clearTimeout</span>(deferTimer);
      deferTimer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        last = now;
        fn.<span class="hljs-title function_">apply</span>(that, args);
      }, delay - (now - last));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 可立即执行</span>
      last = now;
      fn.<span class="hljs-title function_">apply</span>(that, args);
    }
  };
}
</code></pre>
<h3 data-id="heading-9">关键点解析</h3>
<p>节流函数通过闭包维护两个关键状态：</p>
<p><code>last</code> 记录上一次实际执行的时间戳，<code>deferTimer</code> 则用于管理可能的延迟执行任务。</p>
<p>每当事件被触发，函数会先获取当前时间，并判断距离上次执行是否已超过设定的间隔 <code>delay</code>。</p>
<p>如果尚未到冷却期（即 <code>now &lt; last + delay</code>），它不会立即执行，而是清除之前安排的延迟任务，并根据剩余时间重新设置一个定时器，确保在当前周期结束时至少执行一次；</p>
<p>如果已经过了冷却期，则直接执行函数并更新 <code>last</code>。这种机制既实现了“固定频率执行”的节奏控制，又巧妙地保证了在连续高频触发的末尾仍能响应最后一次操作。</p>
<p>例如，在 <code>delay = 500ms</code> 的配置下，无论用户在短时间内触发多少次事件，函数都会在 0ms、500ms、1000ms 等时间点稳定执行，既避免了过度调用，又不丢失关键的最终状态。</p>
<h3 data-id="heading-10">使用示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1.html Lines 59-62</span>
<span class="hljs-keyword">const</span> throttleAjax = <span class="hljs-title function_">throttle</span>(ajax, <span class="hljs-number">500</span>);

inputc.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keyup'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-title function_">throttleAjax</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
});
</code></pre>
<hr/>
<h2 data-id="heading-11">四、典型应用场景</h2>
<h3 data-id="heading-12">防抖适用场景</h3>
<blockquote>
<p><strong>防抖</strong>最适合那些“只关心最终结果”的交互场景。</p>
</blockquote>
<p>例如，在百度或淘宝的搜索框中，用户一边输入一边期待建议词，但如果每敲一个字母就立刻发起请求，不仅会制造大量无意义的网络调用，还可能因中间态（如拼音未完成）返回错误结果。</p>
<p>通过防抖，系统会耐心等到用户停顿片刻（比如 300 毫秒），再以最终输入内容发起一次精准查询。</p>
<p>类似的逻辑也适用于表单字段的验证——只有当用户真正输完并稍作停顿，才触发校验，避免在输入过程中不断弹出错误提示干扰操作。</p>
<blockquote>
<p>简言之，防抖在“太快导致资源浪费”和“太慢影响体验”之间找到了最佳平衡点。</p>
</blockquote>
<h3 data-id="heading-13">节流适用场景</h3>
<blockquote>
<p>相比之下，<strong>节流</strong>则适用于需要“持续响应但必须限频”的场景。</p>
</blockquote>
<p>比如在京东、掘金等电商或内容平台，用户快速滚动页面时，系统需判断是否已滑到底部以加载更多商品或帖子。若对每一次滚动都立即响应，浏览器将不堪重负。</p>
<p>而通过节流（如每 300 毫秒最多执行一次检查），既能及时感知滚动行为，又避免过度计算。</p>
<p>同样，鼠标移动或元素拖拽过程中，实时更新坐标若不加限制，极易造成界面卡顿；节流能确保 UI 以稳定帧率更新，保持流畅感。甚至在某些对 <code>resize</code> 事件要求实时反馈的场景（如动态调整画布或视频比例），也会采用节流而非防抖，以兼顾响应性与性能。</p>
<hr/>
<blockquote>
<p>防抖与节流，看似简单，却是前端性能优化的基石。掌握它们，就掌握了在“响应速度”与“系统负担”之间优雅平衡的艺术。</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">五、完整示例代码</h2>
<p>上面的代码</p>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;防抖&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div&gt;
    &lt;input type="text" id="undebounce" /&gt;
    &lt;br&gt;
    &lt;input type="text" id="debounce" /&gt;
    &lt;br&gt;
    &lt;input type="text" id="throttle" /&gt;
  &lt;/div&gt;
  &lt;script&gt;
  function ajax(content) {
    console.log('ajax request', content);
  }
  // 高阶函数 参数或返回值（闭包）是函数（函数就是对象） 
  function debounce(fn, delay) {
    var id; // 自由变量 
    return function(args) {
      if(id) clearTimeout(id);
      var that = this;
      id = setTimeout(function(){
        fn.call(that, args)
      }, delay);
    }
  }
  // 节流 fn 执行的任务 
  function throttle(fn, delay) {
    let 
      last, 
      deferTimer;
    return function() {
      let that = this; // this 丢失
      let _args = arguments // 类数组对象
      let now = + new Date(); // 类型转换， 毫秒数
      // 上次执行过 还没到执行时间
      if(last &amp;&amp; now &lt; last + delay) {
        clearTimeout(deferTimer);
        deferTimer = setTimeout(function(){
          last = now;
          fn.apply(that, _args);
        }, delay - (now - last));
      } else {
        last = now;
        fn.apply(that, _args);
      }
    }
  }
  
  const inputa = document.getElementById('undebounce');
  const inputb = document.getElementById('debounce');
  const inputc = document.getElementById('throttle');

  let debounceAjax = debounce(ajax, 500);
  let throttleAjax = throttle(ajax, 500);
  inputc.addEventListener('keyup', function(e) {
    throttleAjax(e.target.value)
  })
  // 频繁触发
  inputa.addEventListener('keyup', function(e) {
    ajax(e.target.value) // 蛮复杂
  })
  inputb.addEventListener('keyup', function(e) {
    debounceAjax(e.target.value)
  })
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[防抖 vs 节流：从百度搜索到京东电商，看前端性能优化的“节奏哲学”]]></title>    <link>https://juejin.cn/post/7589477775210250292</link>    <guid>https://juejin.cn/post/7589477775210250292</guid>    <pubDate>2025-12-30T10:51:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589477775210250292" data-draft-id="7589466356779827252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="防抖 vs 节流：从百度搜索到京东电商，看前端性能优化的“节奏哲学”"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-30T10:51:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="栀秋666"/> <meta itemprop="url" content="https://juejin.cn/user/2566698322650307"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            防抖 vs 节流：从百度搜索到京东电商，看前端性能优化的“节奏哲学”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2566698322650307/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    栀秋666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T10:51:07.000Z" title="Tue Dec 30 2025 10:51:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">🔍引言</h2>
<p>在现代 Web 应用中，用户交互越来越频繁——你敲一个字、滑一次屏、点一下按钮，背后可能触发数十次事件回调。如果每个动作都立刻执行复杂逻辑（比如请求接口、重绘 DOM），轻则卡顿，重则页面崩溃。</p>
<p>而真正优秀的用户体验，往往藏在那些你看不见的地方：<br/>
👉 百度输入“前端”后不急着搜，而是等你停顿才出建议；<br/>
👉 京东滚动加载商品时，不会“刷屏式”疯狂请求数据……</p>
<p>这一切的背后，是两个看似简单却威力巨大的技术——<strong>防抖（Debounce）与节流（Throttle）</strong>。</p>
<p>本文将带你深入剖析它们的实现原理、适用场景与实战差异，结合百度、京东的真实案例，揭示前端性能优化中的“节奏控制艺术”。</p>
<hr/>
<h3 data-id="heading-1">🌪️ 一、为什么我们需要“节制”函数？</h3>
<p>想象你在餐厅点餐：</p>
<ul>
<li>如果服务员每听到你说一个菜名就跑去厨房下单 → 厨房炸锅；</li>
<li>正确做法是：等你说完所有菜，再统一提交订单。</li>
</ul>
<p>前端开发也是如此。以下高频事件若不做处理，极易造成资源浪费：</p>






























<table><thead><tr><th>事件类型</th><th>触发频率</th><th>潜在问题</th></tr></thead><tbody><tr><td><code>input</code> / <code>keyup</code></td><td>每输入一个字符触发一次</td><td>多余的 Ajax 请求</td></tr><tr><td><code>scroll</code></td><td>滚动期间持续触发</td><td>频繁计算位置导致重排重绘</td></tr><tr><td><code>resize</code></td><td>窗口拖拽时密集触发</td><td>布局重算影响渲染性能</td></tr><tr><td><code>click</code></td><td>快速点击多次</td><td>表单重复提交、订单创建异常</td></tr></tbody></table>
<p>这些问题的本质是：<strong>事件触发频率远高于我们实际需要的执行频率</strong>。</p>
<p>于是，我们引入两位“节制大师”——</p>
<p>🎯 <strong>防抖（Debounce）</strong>：只响应最后一次操作<br/>
⏱️ <strong>节流（Throttle）</strong>：按固定节奏响应操作</p>
<p>它们不是消灭事件，而是教会函数“何时该说话”。</p>
<hr/>
<h3 data-id="heading-2">💡 二、防抖（Debounce）—— 百度搜索的“冷静期智慧”</h3>
<h4 data-id="heading-3">📍 典型场景：搜索建议延迟显示</h4>
<p>当你在百度搜索框输入“JavaScript ”，</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa810acc3f4d40a58d7d76a082f339a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCA56eLNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767696682&amp;x-signature=ZZ6F6OBQgB3hsh4wQUUYNyR3Zx8%3D" alt="image.png" loading="lazy"/></p>
<p>你会发现：</p>
<ul>
<li>输入过程中，并没有实时发起请求；</li>
<li>只有当你停下来约 300ms 后，才看到下拉建议弹出。</li>
</ul>
<p>这正是防抖的经典应用：<strong>等待用户操作结束后的“静默时刻”，再执行真正逻辑</strong>。</p>
<p>如果没有防抖？<br/>
输入 5 个字 → 发起 5 次请求 → 服务器压力翻倍 + 用户体验混乱（旧结果覆盖新结果）。</p>
<p>用了防抖？<br/>
无论你打了多久，最终只发一次请求 —— 干净利落。</p>
<h4 data-id="heading-4">✅ 实现原理：闭包 + 定时器 = “重置倒计时”</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn,delay</span>){
  <span class="hljs-keyword">var</span> id;  <span class="hljs-comment">//自由变量</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>){
       <span class="hljs-keyword">if</span>(id) <span class="hljs-built_in">clearTimeout</span>(id);
       <span class="hljs-keyword">var</span> that=<span class="hljs-variable language_">this</span>; <span class="hljs-comment">//用that保存this</span>
        id=<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
        <span class="hljs-comment">// fn.call(that); </span>
        fn.<span class="hljs-title function_">call</span>(that,args);
        },delay);
  }
 }
</code></pre>
<p>🔧 <strong>关键点解析：</strong></p>
<ul>
<li><code>clearTimeout(id)</code>：每次触发都取消之前的计划，确保只有最后一次生效。</li>
<li><code>setTimeout</code>：设置“冷静期”，期间无新动作则执行。</li>
<li><code>call(this, args)</code>：保持原函数调用上下文和参数完整。</li>
</ul>
<p>🧠 <strong>类比理解：电梯关门机制</strong></p>
<blockquote>
<p>就像写字楼的电梯——有人进来就暂停关门，直到连续 3 秒没人进出，才自动关闭运行。<br/>
防抖就是给函数加了个“智能门禁”，只让最后一个人进去。</p>
</blockquote>
<h4 data-id="heading-5">🛠️ 实战示例：绑定搜索框</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"searchInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入关键词"</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> inputEl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'searchInput'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchSuggestions</span>(<span class="hljs-params">keyword</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求后端获取建议:'</span>, keyword);
  <span class="hljs-comment">// 这里可以调用 API</span>
}

<span class="hljs-comment">// 使用防抖包装请求函数</span>
<span class="hljs-keyword">const</span> debouncedFetch = <span class="hljs-title function_">debounce</span>(fetchSuggestions, <span class="hljs-number">300</span>);

inputEl.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-title function_">debouncedFetch</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
});
</code></pre>
<p>✅ 效果：快速输入不停止 → 不请求；停止输入 300ms → 请求一次最新值。</p>
<hr/>
<h3 data-id="heading-6">⏱️ 三、节流（Throttle）—— 京东滚动加载的“发车节奏”</h3>
<h4 data-id="heading-7">📍 典型场景：无限滚动商品列表</h4>
<p>打开京东首页，向下滚动浏览商品：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeedbbd3a09a410c854900a1d05db955~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCA56eLNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767696682&amp;x-signature=wDqjMSAyPFeo57FyKZtukq6rkTE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381770bfd5194d8990de36d9d401a9be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCA56eLNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767696682&amp;x-signature=bqhWeq%2FBRkA1Cplkr7rlVNGfen4%3D" alt="lQLPJxRxFJIgWT_NA7bNBk-wbMl5INfmGnYJLTRxXOrIAA_1615_950.png" loading="lazy"/></p>
<ul>
<li>即使你飞速滑动鼠标滚轮；</li>
<li>商品也不会瞬间全加载出来；</li>
<li>而是每隔半秒左右“分批”出现新内容。</li>
</ul>
<p>这不是网络慢，而是节流在工作：<strong>控制函数以固定频率执行，防止过度消耗资源</strong>。</p>
<p>如果没有节流？<br/>
滚动一下触发几十次判断 → 频繁请求接口 → 数据错乱、内存飙升。</p>
<p>用了节流？<br/>
哪怕你滚得再快，也保证每 500ms 最多加载一次 → 系统稳定、体验流畅。</p>
<h4 data-id="heading-8">✅ 实现原理：时间戳 + 定时器 = “节拍器模式”</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> lastTime = <span class="hljs-number">0</span>;       <span class="hljs-comment">// 上次执行时间</span>
  <span class="hljs-keyword">let</span> deferTimer = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 延迟执行的定时器</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

    <span class="hljs-keyword">if</span> (now - lastTime &gt; delay) {
      <span class="hljs-comment">// 时间到了，立即执行</span>
      lastTime = now;
      fn.<span class="hljs-title function_">apply</span>(context, args);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 时间未到，安排最后一次触发兜底</span>
      <span class="hljs-built_in">clearTimeout</span>(deferTimer);
      deferTimer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        lastTime = now;
        fn.<span class="hljs-title function_">apply</span>(context, args);
      }, delay);
    }
  };
}
</code></pre>
<p>🔧 <strong>关键点解析：</strong></p>
<ul>
<li><code>Date.now()</code> 获取当前时间戳，用于比较间隔；</li>
<li><code>lastTime</code> 记录上次执行时间，决定是否放行；</li>
<li><code>deferTimer</code> 是“补票机制”——防止最后一次触发被遗漏。</li>
</ul>
<p>🚂 <strong>类比理解：地铁发车制度</strong></p>
<blockquote>
<p>地铁不管站台人多人少，都是每 5 分钟发一班车。<br/>
节流就像这个“准时发车系统”，不管你滚得多猛，我都按我的节奏来。</p>
</blockquote>
<h4 data-id="heading-9">🛠️ 实战示例：监听页面滚动加载</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkIfNearBottom</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> scrollTop = <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageYOffset</span>;
  <span class="hljs-keyword">const</span> clientHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  <span class="hljs-keyword">const</span> scrollHeight = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">scrollHeight</span>;

  <span class="hljs-keyword">if</span> (scrollTop + clientHeight &gt;= scrollHeight - <span class="hljs-number">100</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接近底部，加载下一页商品'</span>);
    <span class="hljs-comment">// loadMoreProducts();</span>
  }
}

<span class="hljs-comment">// 包装成节流函数</span>
<span class="hljs-keyword">const</span> throttledScroll = <span class="hljs-title function_">throttle</span>(checkIfNearBottom, <span class="hljs-number">500</span>);

<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledScroll);
</code></pre>
<p>✅ 效果：快速滚动时，最多每 500ms 检查一次是否到底部，避免无效计算。</p>
<hr/>
<h3 data-id="heading-10">🆚 四、防抖 vs 节流：一张表说清所有区别</h3>













































<table><thead><tr><th>维度</th><th>防抖（Debounce）</th><th>节流（Throttle）</th></tr></thead><tbody><tr><td><strong>核心思想</strong></td><td>等待“风平浪静”后再行动</td><td>按固定节奏稳步推进</td></tr><tr><td><strong>执行次数</strong></td><td>只执行最后一次</td><td>每个时间间隔至少执行一次</td></tr><tr><td><strong>触发时机</strong></td><td>延迟结束后执行</td><td>间隔开始或结束时执行</td></tr><tr><td><strong>典型应用场景</strong></td><td>搜索建议、表单验证、窗口 resize</td><td>滚动加载、拖拽、高频点击</td></tr><tr><td><strong>函数执行频率</strong></td><td>极低（可能全程只执行 1 次）</td><td>稳定（如 1s 内触发 20 次，仍只执行 2 次）</td></tr><tr><td><strong>生活类比</strong></td><td>电梯等人上齐再关门</td><td>地铁准点发车，不等人满</td></tr><tr><td><strong>适合的操作特征</strong></td><td>希望“完成后才处理”</td><td>希望“过程中定期反馈”</td></tr></tbody></table>
<h4 data-id="heading-11">📊 执行行为对比（假设 delay = 300ms）</h4>

















































<table><thead><tr><th>时间线（ms）</th><th>0</th><th>100</th><th>200</th><th>300</th><th>400</th><th>500</th><th>600</th><th>700</th></tr></thead><tbody><tr><td>事件触发</td><td>✅</td><td>✅</td><td>✅</td><td>❌</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>防抖执行</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td><td>✅（仅最后一次）</td></tr><tr><td>节流执行</td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td><td>✅（每 ~300ms 一次）</td></tr></tbody></table>
<blockquote>
<p>💡 结论：</p>
<ul>
<li>防抖追求“精简”，牺牲过程保结果；</li>
<li>节流追求“节奏”，平衡效率与负载。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-12">🎯 五、如何选择？三大决策原则</h3>
<p>面对高频事件，别再盲目使用 <code>setTimeout</code> 抹黑了。根据业务目标做理性选择：</p>
<h4 data-id="heading-13">✅ 原则 1：看“要不要中间反馈”</h4>
<ul>
<li>✅ <strong>不需要中间状态？选防抖</strong><br/>
如搜索框输入：中间结果没意义，只要最终关键词。</li>
<li>✅ <strong>需要过程反馈？选节流</strong><br/>
如游戏手柄摇杆移动：必须持续响应方向变化。</li>
</ul>
<h4 data-id="heading-14">✅ 原则 2：看“是否允许延迟”</h4>
<ul>
<li>✅ <strong>能接受短暂停顿？防抖更省资源</strong><br/>
如用户名唯一性校验，等用户输完再查。</li>
<li>✅ <strong>要求即时响应？节流更合适</strong><br/>
如音量调节滑块，必须实时更新 UI。</li>
</ul>
<h4 data-id="heading-15">✅ 原则 3：看“执行成本高低”</h4>
<ul>
<li>✅ 成本极高（如发邮件、下单）→ 优先防抖，防止误操作；</li>
<li>✅ 成本较低但频次高（如监听鼠标位置）→ 优先节流，维持节奏。</li>
</ul>
<hr/>
<h3 data-id="heading-16">🧩 六、进阶技巧 &amp; 最佳实践</h3>
<h4 data-id="heading-17">1. 支持立即执行的防抖（Leading Edge）</h4>
<p>有时我们希望“第一次立刻执行”，后续才防抖：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounceImmediate</span>(<span class="hljs-params">fn, delay, immediate = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-keyword">let</span> timerId;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> callNow = immediate &amp;&amp; !timerId;
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;

    <span class="hljs-built_in">clearTimeout</span>(timerId);

    <span class="hljs-keyword">if</span> (callNow) {
      fn.<span class="hljs-title function_">apply</span>(context, args);
    }

    timerId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      timerId = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">if</span> (!immediate) fn.<span class="hljs-title function_">apply</span>(context, args);
    }, delay);
  };
}
</code></pre>
<p>📌 适用场景：按钮点击防重复提交，首次点击立刻生效。</p>
<hr/>
<h4 data-id="heading-18">2. 节流的两种策略：时间戳 vs 定时器</h4>




















<table><thead><tr><th>类型</th><th>特点</th><th>缺点</th></tr></thead><tbody><tr><td>时间戳版</td><td>首次立即执行，末次可能丢失</td><td>若停止触发，最后一次不会执行</td></tr><tr><td>定时器版</td><td>保证每次都能执行，节奏稳定</td><td>第一次会有延迟</td></tr></tbody></table>
<p>推荐使用文中提供的“混合模式”：兼顾首次与末次。</p>
<hr/>
<h4 data-id="heading-19">3. 实际项目中的配置建议</h4>



































<table><thead><tr><th>场景</th><th>推荐延迟/间隔</th><th>说明</th></tr></thead><tbody><tr><td>搜索建议</td><td>200–300ms</td><td>太短易误触，太长影响体验</td></tr><tr><td>滚动加载</td><td>500–800ms</td><td>给浏览器留出渲染时间</td></tr><tr><td>窗口 resize</td><td>300ms</td><td>避免频繁重排</td></tr><tr><td>表单实时验证</td><td>400ms</td><td>用户打字节奏匹配</td></tr><tr><td>高频按钮防重复提交</td><td>1000ms</td><td>提交后需等待接口返回，防止双订单</td></tr></tbody></table>
<blockquote>
<p>⚠️ 注意：不要硬编码！建议通过配置项动态调整，便于 A/B 测试优化。</p>
</blockquote>
<hr/>
<h3 data-id="heading-20">🏁 七、总结：掌握“节奏感”，才是高级前端</h3>
<p>防抖与节流，表面是两个工具函数，实则是前端工程师对 <strong>用户行为节奏的理解</strong>。</p>
<blockquote>
<p>🔥 <strong>真正的性能优化，不只是减少请求，更是学会“等待”与“克制”</strong>。</p>
</blockquote>
<ul>
<li>百度用防抖告诉我们：<strong>有时候慢一点，反而更快</strong>；</li>
<li>京东用节流提醒我们：<strong>再激烈的动作，也要有章法地应对</strong>。</li>
</ul>
<p>在高并发、强交互的时代，每一个优雅的交互背后，都有一个默默守候的 <code>setTimeout</code>。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vfit.js v2.0.0 发布：精简、语义化与核心重构 🎉]]></title>    <link>https://juejin.cn/post/7588865809473912872</link>    <guid>https://juejin.cn/post/7588865809473912872</guid>    <pubDate>2025-12-29T04:27:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588865809473912872" data-draft-id="7588865809473896488" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vfit.js v2.0.0 发布：精简、语义化与核心重构 🎉"/> <meta itemprop="keywords" content="前端,Vue.js,响应式设计"/> <meta itemprop="datePublished" content="2025-12-29T04:27:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一颗烂土豆"/> <meta itemprop="url" content="https://juejin.cn/user/764915822371912"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vfit.js v2.0.0 发布：精简、语义化与核心重构 🎉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/764915822371912/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一颗烂土豆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T04:27:25.000Z" title="Mon Dec 29 2025 04:27:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>距 vfit.js 初版发布仅一个月，我们就收到了超预期的开发者关注 —— 每一条反馈、每一次讨论，都让我们更清晰地看到大屏适配场景中的真实需求。基于这份热情与信任，我们很高兴地宣布，vfit.js 迎来了 <strong>v2.0.0</strong> 重大版本更新！</p>
<p>本次更新不仅仅是版本号的提升，更是对大屏适配理念的一次深度梳理。我们从“万能适配”走向了“精准语义”，通过全新的组件体系和重构的核心逻辑，为开发者提供更优雅、更高效的大屏开发体验。</p>
<h2 data-id="heading-0">🚀 核心亮点</h2>
<h3 data-id="heading-1">1. 全新的语义化组件体系 🧩</h3>
<p>在 v1.x 版本中，我们主要依赖 <code>FitContainer</code> 这个“万能”组件来处理所有方位的适配。虽然灵活，但在实际开发中，大量的 <code>top</code>, <code>left</code>, <code>right</code> 参数往往让代码显得冗余且不够直观。</p>
<p>v2.0.0 引入了 <strong>5 个专用方位组件</strong>，将常用的布局模式固化为语义清晰的组件：</p>
<ul>
<li><strong><code>&lt;vfit-lt&gt;</code></strong>  (Left-Top): 左上角定位 🔝</li>
<li><strong><code>&lt;vfit-rt&gt;</code></strong>  (Right-Top): 右上角定位 🔝</li>
<li><strong><code>&lt;vfit-lb&gt;</code></strong>  (Left-Bottom): 左下角定位 🔚</li>
<li><strong><code>&lt;vfit-rb&gt;</code></strong>  (Right-Bottom): 右下角定位 🔚</li>
<li><strong><code>&lt;vfit-center&gt;</code></strong>  (Center): 居中定位 🎯</li>
</ul>
<p><strong>对比示例：</strong></p>
<p>旧版 (v1.x):</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 需要手动指定单位和具体坐标 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">FitContainer</span> <span class="hljs-attr">:top</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">:left</span>=<span class="hljs-string">"0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Logo</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">FitContainer</span>&gt;</span>
</code></pre>
<p>新版 (v2.0):</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 语义明确，无需多余参数 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">vfit-lt</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Logo</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">vfit-lt</span>&gt;</span>
</code></pre>
<p>这一改变不仅减少了代码量，更让模板结构一目了然。</p>
<h3 data-id="heading-2">2. 智能居中与 Transform 冲突解决 ✨</h3>
<p>在旧版本中，居中组件往往需要复杂的参数配置，且容易与用户自定义的 CSS <code>transform</code> 发生冲突。</p>
<p>v2.0.0 对 <code>vfit-center</code> 进行了深度优化：</p>
<ul>
<li> <strong>零参数居中</strong>：默认即可实现完美的屏幕居中 🎯。</li>
<li><strong>Transform 融合</strong>：内部逻辑自动处理缩放（Scale）与位移（Translate）的合并，彻底解决了 CSS 样式覆盖导致的偏移问题 🔧。</li>
</ul>
<h3 data-id="heading-3">3. 核心逻辑重构：Composables 🔩</h3>
<p>为了提高代码的可维护性和复用性，我们将核心逻辑抽离为两个独立的 Composable 函数：</p>
<ul>
<li><strong><code>useFitScale</code></strong>: 专注于屏幕尺寸监听与全局缩放比例计算 📏。</li>
<li><strong><code>useFitPosition</code></strong>: 专注于元素定位与坐标转换 📍。</li>
</ul>
<p>这意味着你不仅可以使用内置组件，还可以直接在自己的组件中引入这些 Hook，实现高度定制化的适配逻辑。</p>
<h2 data-id="heading-4">📚 文档与生态升级</h2>
<ul>
<li><strong>中英双语同步</strong>：文档现已实现 100% 中英内容对齐，包括最新的组件示例和 API 说明，更好地服务全球开发者 🌐。</li>
<li><strong>赞助者回馈</strong>：我们在文档中更新了赞助者列表，感谢每一位支持开源的朋友（包括那位“产品经理的噩梦” 😉）🙏。</li>
<li><strong>首页焕新</strong>：重新梳理了首页特性介绍，突出了“组件化精准定位”这一核心优势 ✨。</li>
</ul>
<h2 data-id="heading-5">📦 如何升级</h2>
<p>vfit.js v2.0.0 现已发布到 npm。</p>
<pre><code class="hljs language-bash" lang="bash">npm install vfit@latest
</code></pre>
<p>对于老用户，<code>FitContainer</code> 依然保留并作为“通用版”组件继续支持，您可以根据项目需求逐步迁移到新的语义化组件 🔄。</p>
<hr/>
<p>感谢您对<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb-vfit.netlify.app%2F" target="_blank" title="https://web-vfit.netlify.app/" ref="nofollow noopener noreferrer">vfit.js</a>的关注与支持，让我们一起构建更美好的数据可视化大屏！💪</p>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweb-vfit.netlify.app%2F" target="_blank" title="https://web-vfit.netlify.app/" ref="nofollow noopener noreferrer">文档地址</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb-vfit.netlify.app%2F" target="_blank" title="https://web-vfit.netlify.app/" ref="nofollow noopener noreferrer">web-vfit.netlify.app/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fvfit" target="_blank" title="https://www.npmjs.com/package/vfit" ref="nofollow noopener noreferrer">npm地址</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fvfit" target="_blank" title="https://www.npmjs.com/package/vfit" ref="nofollow noopener noreferrer">www.npmjs.com/package/vfi…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fv-plugin%2Fvfit" target="_blank" title="https://github.com/v-plugin/vfit" ref="nofollow noopener noreferrer">github地址</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fv-plugin%2Fvfit" target="_blank" title="https://github.com/v-plugin/vfit" ref="nofollow noopener noreferrer">github.com/v-plugin/vf…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《网页布局速通：8 大主流方案 + 实战案例》-pink老师现代网页布局总结]]></title>    <link>https://juejin.cn/post/7589146208225361956</link>    <guid>https://juejin.cn/post/7589146208225361956</guid>    <pubDate>2025-12-29T05:37:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589146208225361956" data-draft-id="7589102404168761363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《网页布局速通：8 大主流方案 + 实战案例》-pink老师现代网页布局总结"/> <meta itemprop="keywords" content="面试,CSS,HTML"/> <meta itemprop="datePublished" content="2025-12-29T05:37:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王小菲"/> <meta itemprop="url" content="https://juejin.cn/user/3025471246701496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《网页布局速通：8 大主流方案 + 实战案例》-pink老师现代网页布局总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3025471246701496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王小菲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T05:37:09.000Z" title="Mon Dec 29 2025 05:37:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、概述与目标</h2>
<p>CSS 布局是网页设计的核心技术，主要用于控制页面元素的排列与呈现方式。目前主流的布局方案包括常规文档流布局、模式转换布局、弹性布局（Flexbox）、定位布局、网格布局（Grid）和多列布局。</p>
<p>接下来我们会逐一拆解它们的优缺点与适用场景，帮你快速看懂主流官网的布局实现思路。</p>
<h2 data-id="heading-1">二、常规文档流布局</h2>
<p>这是浏览器的默认排版，是 CSS 布局的基础，页面大结构依靠块元素上下堆叠实现。包含块元素和行内元素，文档流方向默认从上到下、从左到右排列。</p>













<table><thead><tr><th>块元素（block）</th><th>独占一行，宽度默认撑满容器；可设置宽高，呈垂直排列；举例：div、p、h1~h6</th></tr></thead><tbody><tr><td>行内元素（inline）</td><td>水平依次排列，容器宽度不足则换行；宽高由内容决定，无法直接设置；举例：span、img、strong</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e8ed93120724d4abe5f05ec7d65ee5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=IH1O9rtRbYPHNiWGSq6gw%2BIMpiY%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e166b94d42a041e190175b6d045f5a18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=rrpL8Phwv61E7RT%2BRmlZckhzYrA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">三、模式转换布局</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e4f976297ec456ab213b5bf1a300181~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=nQ3EzYBZRmmNgtcpK%2BX4aqFX5SE%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42429cb3a0294770b3d276e3690e0a16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=EpUYzbLpAeRyT25QZFIsWvhZtIw%3D" alt="image.png" loading="lazy"/></p>
<p>如上图所示，需求要求我们把块级盒子展示为一行，或者要求行内元素有更大的点击范围，我们改怎么办呢？</p>
<p>那么就需要用到<strong>display转换，</strong> 我们可以将上面两种元素的display属性设置为<strong>inline-block,</strong> 可实现上述效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52066f78a6148b3a12aa9671ef997b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=MRcAzxiag54GxpfwdtswA51vRo8%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b5a6d6b71b4161a6e81432b4228c2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=GAXRXLg%2FvGJmI7AeQD6ipFRikd8%3D" alt="image.png" loading="lazy"/></p>
<p>display转换为 inline-block后，可以设置宽高，又不用独占一行，这种特点让它可以广泛应用于让块级盒子一行显示或让行内盒子具备宽高的场景</p>





























<table><thead><tr><th><strong>属性值</strong></th><th><strong>是否独占一行</strong></th><th><strong>能否设置宽高</strong></th><th><strong>默认宽度</strong></th></tr></thead><tbody><tr><td>display: block</td><td>是</td><td>✔️</td><td>撑满容器宽度</td></tr><tr><td>display: inline</td><td>否</td><td>❌</td><td>由内容决定</td></tr><tr><td>display: inline-block</td><td>否</td><td>✔️</td><td>由内容决定（可覆盖）</td></tr></tbody></table>
<p>但是使用行内块元素需要注意： 元素间会有空隙，需要给父元素设font-size: 0，因此适合对间距要求不高的场景，如果精细排版建议用 Flex或Grid。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1c3a881f50c4f4e9ae5ec7042114f9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=9Vy2ikTrZQckUPf24u2gsLewkec%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">四、被逐渐替代的float</h2>
<p>float最早是做”文字环绕”效果的，如下图所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0809fb9c0904a789f7978847143b885~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=ZVNvd%2FtuI7YlKsldgUSGuWVT52I%3D" alt="image.png" loading="lazy"/></p>
<p>float可以让元素脱离文档流向左或向右浮动， 但这会导致父容器高度塌陷，从而影响周围元素的布局，例如下图1所示。而很多时候我们是不能给父容器规定高度的，它的高度取决于后台服务返回的数据量，例如京东的这个商品列表展示，随着鼠标的滚动，商品不断增多，高度不断增加，这个时候我们怎么办呢？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/086f7cc117d84e2891307561e1360602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=yjA0NvtuYqNWmXc%2BDWcvydz%2Fy1U%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/002224e0c0c14b039d679ad525824205~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=F4kjGFh82j2gFuV1poZC%2F7y3CKw%3D" alt="image.png" loading="lazy"/></p>
<p>这个时候我们就要进行<strong>清除浮动</strong>了，主要有以下四种方法</p>
<p>1、双伪元素清除浮动</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71b0c97ed0ed415dae9b0e4c24a35cdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=Z33zYm%2F6hSKaKjqOB8hcsJQti54%3D" alt="image.png" loading="lazy"/></p>
<p>2、单伪元素清除浮动</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/007156cdf3f543c1ae2014c613b7d303~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=Ct4oidLWL4ANmG%2FQah2vK00OIII%3D" alt="image.png" loading="lazy"/></p>
<p>3、额外标签法：在浮动元素最后新增块级标签，但增加冗余标签</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4671501f3f44985bb4fff77261a8893~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=7SjAfMQP%2Bb7pxZE8Xx9D88YyYwQ%3D" alt="image.png" loading="lazy"/></p>
<p>4、overflow 清除浮动：触发 BFC 包裹浮动元素<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f45818c3e378482082f3669b9d5da5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=jBIEwuXkIX6P7HRjDbSm4hoJtdY%3D" alt="image.png" loading="lazy"/></p>
<p>因为float问题太多， 要手动解决 “高度塌陷”，还得写额外代码清除浮动， 排版稍微复杂点就容易错位，对新手很不友好， 现在有更简单的 Flex/Grid 布局，又灵活又不存在上述问题，所以浮动就成 “时代的眼泪”了</p>
<h2 data-id="heading-4">五、弹性布局</h2>
<p>Flexbox是Flexible Box Layout Module（弹性盒子布局模块）的缩写，可以快速实现元素的对齐、分布和空间分配。例如京东、淘宝、小米等主流网站都使用了flex布局，而且我们的低代码平台也可以设置元素为flex布局</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4940a0a7750643c290fd9659dc1eb084~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=hMumX3%2FdFzJFJBm5pumgk4cC9Yk%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/376b78ca0ace4a07b13f1c103c1d8d9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=Z3MpAWohhVI8NKXpWIPqoWF%2Famc%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43c524a0868c46bfb9c4904241eff073~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=OQzFRH0wMKwbVA%2B09fLwtDx8Q20%3D" alt="image.png" loading="lazy"/></p>
<p><strong>我们为啥要使用flex布局呢？</strong></p>
<p>以B站头部为例，想要实现下图的效果，三个块级元素并排在一行，实现两端对齐的效果，用之前的办法，可能要变成行内块、给margin或者padding来实现，或者干脆采用浮动的办法，那么实现垂直居中该怎么办呢？</p>
<p>垂直居中是传统布局的 “老大难”，有的同学可能说使用line-height，但是line-height是无法让块级的盒子垂直居中，这个时候我们可以使用flex，只需要三行代码（display: flex;align-items: center;justify-content: space-between;）就可以实现B站头部的布局效果，我们公司的官网头部也是类似的实现方案</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de5e73157cf74462a6c4cdf49bdc1395~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=ePm5ia6PxyuhduYr6Kv%2BNxSof%2FU%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15fefe905a9243f8aa0d1dd5d8e0886e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=oO7h5pU%2Fye%2BgG3MQWyPT6QMVQcc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">1、flex布局的核心</h4>
<p>父控子：父盒子控制子盒子如何排列布局（父盒子称为容器，子盒子称为项目），控制属性要写在父元素身上；</p>
<p>轴方向：主轴默认水平、交叉轴默认垂直，可自定义。</p>
<h4 data-id="heading-6">2、flex的属性</h4>
<p>父盒子属性</p>








































<table><thead><tr><th><strong>属性</strong></th><th><strong>作用说明</strong></th><th><strong>所有可选值</strong></th></tr></thead><tbody><tr><td>display</td><td>定义元素为 Flex 容器</td><td>flex</td></tr><tr><td>flex-direction</td><td>定义主轴方向（项目排列方向）</td><td>row（默认，水平从左到右）、row-reverse（水平从右到左）、column（垂直从上到下）、column-reverse（垂直从下到上）</td></tr><tr><td>flex-wrap</td><td>控制项目是否换行</td><td>nowrap（默认，不换行）、wrap（换行，第一行在上）、wrap-reverse（换行，第一行在下）</td></tr><tr><td>justify-content</td><td>定义主轴上的对齐方式（项目整体分布）</td><td>flex-start（默认，靠主轴起点）、flex-end（靠主轴终点）、center（居中）、space-between（两端对齐，项目间间距相等）、space-around（项目两侧间距相等）、space-evenly（项目间间距完全相等）</td></tr><tr><td>align-items</td><td>定义交叉轴上的对齐方式（单行时项目整体对齐）</td><td>stretch（默认，拉伸填满容器）、flex-start（靠交叉轴起点）、flex-end（靠交叉轴终点）、center（垂直居中）、</td></tr><tr><td>align-content</td><td>定义多行时交叉轴上的对齐方式（仅当 flex-wrap: wrap 且内容换行时生效）</td><td>stretch（默认，拉伸填满容器）、flex-start（靠交叉轴起点）、flex-end（靠交叉轴终点）、center（居中）、space-between（两端对齐）、space-around（项目行两侧间距相等）</td></tr></tbody></table>
<p>项目属性：</p>








































<table><thead><tr><th><strong>属性</strong></th><th><strong>作用说明</strong></th><th><strong>所有可选值 / 取值规则</strong></th></tr></thead><tbody><tr><td>order</td><td>定义项目的排列顺序（默认 0，数值越小越靠前）</td><td>任意整数（正整数 / 负整数 / 0），无单位</td></tr><tr><td>flex-grow</td><td>定义项目的放大比例（默认 0，即不放大）</td><td>非负数字（0 / 正小数 / 正整数），无单位；数值越大，占剩余空间比例越高</td></tr><tr><td>flex-shrink</td><td>定义项目的缩小比例（默认 1，空间不足时等比缩小）</td><td>非负数字（0 / 正小数 / 正整数），无单位；设为 0 则空间不足时不缩小</td></tr><tr><td>flex-basis</td><td>定义项目在主轴方向上的初始大小（优先级高于 width/height）</td><td>1. 长度值（px/em/rem/% 等）；2. auto（默认，取项目自身宽高）；3. content（按内容自适应）</td></tr><tr><td>flex</td><td>flex-grow、flex-shrink、flex-basis 的简写</td><td>1. 常用简写：- flex: 1 → 等价于 flex: 1 1 auto- flex: auto → 等价于 flex: 1 1 auto- flex: none → 等价于 flex: 0 0 auto2. 完整写法：flex:   </td></tr><tr><td>align-self</td><td>覆盖容器的 align-items，单独定义某个项目的交叉轴对齐方式</td><td>auto（默认，继承容器 align-items）、stretch、flex-start、flex-end、center、baseline</td></tr></tbody></table>
<h4 data-id="heading-7">3、使用场景</h4>
<h5 data-id="heading-8">3.1实现基础横向并排 + 垂直居中（导航栏核心效果）</h5>
<p>3 个子元素水平并排，且在父盒子中垂直居中（对应 B 站头部核心布局）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd559ef5984f466ab8d9aff7fafc7196~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=Y%2FcTi2AHD1knBPlYhjNMnLDl2wc%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css">    <span class="hljs-comment">/* 父容器（控制子元素） */</span>
    <span class="hljs-selector-class">.container</span> {
     ...
      <span class="hljs-attribute">display</span>: flex; <span class="hljs-comment">/* 开启Flex */</span>
      <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 交叉轴（垂直）居中 */</span>
      ...
    }
  
</code></pre>
<h5 data-id="heading-9">3.2实现横向两端对齐（导航栏左右分布效果）</h5>
<p>logo 居左、登录按钮居右，且两者都垂直居中（网页头部通用布局）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/216a282991e24e409fd695e1fe55c1fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=HJFEoWsY45aEm9ZEBNStQlBV02A%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-selector-class">.container</span> {
      ...
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: space-between; <span class="hljs-comment">/* 主轴（水平）两端对齐 */</span>
     ...
    }
</code></pre>
<h5 data-id="heading-10">3.3实现横向平均分布（卡片列表效果）</h5>
<p>3 个卡片水平平均分布，间距一致（商品列表 / 功能入口常用）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5f11e2e06064a61895fc292d4db6b39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=SRuaRXOvvte6w9tMrz4992rErtM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-selector-class">.container</span> {
      ...
    <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: space-around; <span class="hljs-comment">/* 主轴平均分布（项目两侧间距相等） */</span>
     ...
    }
</code></pre>
<h5 data-id="heading-11">3.4实现垂直排列（侧边栏）</h5>
<p>子元素垂直排列（更改主轴方向），且垂直居中（侧边栏核心布局）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07c2fa928c1d40259f339b7f88832344~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=%2FfPCeCUm%2BVQuEkI4JzBiaGn%2BvSs%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-selector-class">.container</span> {
      ...
     <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">flex-direction</span>: column; <span class="hljs-comment">/* 更改主轴为垂直方向 */</span>
      <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/* 主轴（垂直）居中 */</span>
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>; <span class="hljs-comment">/* 项目间距（替代margin） */</span>
     ...
    }
</code></pre>
<h5 data-id="heading-12">3.5实现自动换行（响应式卡片）</h5>
<p>元素超出父容器宽度自动换行（响应式布局核心）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e424aba3d5e446bfa927e34689da5fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=4vG%2BbJS%2FUqoiTuMDFdUUQpMLVkM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-selector-class">.container</span> {
      ...
     <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
     <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">flex-wrap</span>: wrap; <span class="hljs-comment">/* 超出容器宽度自动换行 */</span>
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">15px</span>;
     ...
    }

 <span class="hljs-selector-class">.item</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">220px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">120px</span>;
      ...
    }
</code></pre>
<h5 data-id="heading-13">3.6实现子元素占满剩余空间（搜索框布局）</h5>
<p>搜索框自动占满左右元素的剩余空间（网页搜索栏通用布局）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a4709004c04464bbb6ca35697e5f327~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=%2FHttJhXGBn2Gb2jQYbh9DtW83Ao%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"> <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">80px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
        ...
    }
    <span class="hljs-selector-class">.left</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">80px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
       ...
    }
    <span class="hljs-selector-class">.search</span> {
      <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-comment">/* 占满主轴剩余空间 */</span>
      <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
      ...
    }
    <span class="hljs-selector-class">.right</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">80px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">40px</span>;
     ...
    }
</code></pre>
<h5 data-id="heading-14">3.7实现整体居中（登录框 / 弹窗）</h5>
<p>在页面中水平 + 垂直居中</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/348bc7fab837443d884ba0a201bf5dd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=bxJA7phvSi8agbgnFNSZ5qrrzNw%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-comment">/* 占满视口高度 */</span>
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/* 水平居中 */</span>
      <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 垂直居中 */</span>
       ...
    }
    <span class="hljs-selector-class">.login-box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">400px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">300px</span>;
        ...
    }
</code></pre>
<h5 data-id="heading-15">3.8实现自定义子元素顺序</h5>
<p>元素显示顺序为 菜单 2 → 菜单 3 → 菜单 1（无需修改 HTML 结构，仅通过 CSS 调整）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dab8efc3f8b418eb2c5e00e9dde4522~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=vRkN34ifqKpSF2kxzcVh3ve7%2FDQ%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-selector-class">.container</span> {
      ...
    <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center
     ...
    }
<span class="hljs-selector-class">.item</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
      ...
    }
    <span class="hljs-comment">/* 自定义顺序（默认0，数值越小越靠前） */</span>
    <span class="hljs-selector-class">.item1</span> { <span class="hljs-attribute">order</span>: <span class="hljs-number">3</span>; }
    <span class="hljs-selector-class">.item2</span> { <span class="hljs-attribute">order</span>: <span class="hljs-number">1</span>; }
    <span class="hljs-selector-class">.item3</span> { <span class="hljs-attribute">order</span>: <span class="hljs-number">2</span>; }
</code></pre>
<h4 data-id="heading-16">4、真实应用场景</h4>
<h5 data-id="heading-17">4.1 百度图片-模仿瀑布流效果</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c98cca0c78d94ec19426df8a5059158f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=VMWe48%2BSNsXHMEjX%2BwodPn3A3lY%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c07652654f1b43dfb7985042bc93e859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=50ETBNUxB0reHyFjmev7LENTF3E%3D" alt="image.png" loading="lazy"/></p>
<p>五个块级列容器通过 Flex 水平均分排列（各占父容器 1/5 宽度），每个列容器内垂直排布图片、按钮等内容。</p>
<h5 data-id="heading-18">4.2 京东-无限滚动展示商品列表 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ab0df124cf84e5daed421494d79dee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=fqv%2BdUjta%2FVoDHtFZJwtY6cN8FE%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eddc9933960148bebaf11d6e57d2c4bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=8DIf5OSLDEKwbJMPnh1E%2FguM8eE%3D" alt="image.png" loading="lazy"/></h5>
<p>父容器设 Flex 并允许换行，子元素通过媒体查询 + 宽高限制，实现不同屏幕下自动调整每行展示数量，超出则换行。</p>
<p>淘宝也跟京东一样，使用flex布局来实现的无限滚动展示商品，但是如果你需要更复杂的响应式布局，需精准控制行列、页面多模块分区时就要使用grid了</p>
<h2 data-id="heading-19">六、定位布局</h2>
<p>定位布局是控制页面元素位置的核心技术，能实现元素脱离文档流、层叠、固定位置等效果。 例如下图中B站首页，很多效果都是使用定位布局实现的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0443928dc3a47fd8b1c329ed6e871e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=mOtbfaZuFLoVB8ClP5xA1vP7NGE%3D" alt="image.png" loading="lazy"/></p>
<p><strong>常见场景:</strong></p>
<p>固定导航栏：页面滚动时，导航栏始终固定在视口顶部</p>
<p>吸顶效果：元素滚动到特定位置后固定</p>
<p>弹出 / 下拉菜单：鼠标悬浮时显示</p>
<p>悬浮效果：元素浮在其他元素上方</p>
<p><strong>定位分类</strong></p>
<ul>
<li><strong>相对定位</strong>：元素相对自身原位置偏移，不脱离文档流，保留原占位</li>
<li><strong>绝对定位</strong>：元素相对最近的已定位父元素偏移，完全脱离文档流，不保留占位</li>
<li><strong>固定定位</strong>：元素相对浏览器视口固定，脱离文档流，滚动页面时位置不变</li>
<li><strong>粘性定位</strong>：元素在滚动到指定阈值前是相对定位，之后变为固定定位，结合两者特性</li>
</ul>
<h4 data-id="heading-20">1、 场景一：子绝父相实现购物车效果</h4>
<p>为什么用 “<strong>子绝父相</strong>”？</p>
<p>子元素用绝对定位：能浮在上方，且不占位置、不影响其他元素布局，而父元素用相对定位，让子元素能跟着父元素移动（作为定位参考），同时父元素保留原占位、不影响其他布局，例如下图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86d83452948d44c78cf9adb9ad695082~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=6M0qVHfTCjRA7XGNPw3BbMtiDJ4%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 父元素：购物车按钮（相对定位） */</span>
    <span class="hljs-selector-class">.cart-btn</span> {
      <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 父相 */</span>
    ...
    }

    <span class="hljs-comment">/* 子元素：数量标记（绝对定位） */</span>
    <span class="hljs-selector-class">.cart-count</span> {
      <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 子绝 */</span>
      <span class="hljs-attribute">top</span>: -<span class="hljs-number">5px</span>; <span class="hljs-comment">/* 向上偏移 */</span>
      <span class="hljs-attribute">right</span>: -<span class="hljs-number">5px</span>; <span class="hljs-comment">/* 向右偏移 */</span>
      <span class="hljs-attribute">width</span>: <span class="hljs-number">18px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">18px</span>;
      ...
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cart-btn"</span>&gt;</span>
    我的购物车
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cart-count"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>小米官网swiper组件左右翻页的箭头也是采用子绝父相的做法，将左右箭头先使用top调整到50%的高度，然后再使用margin-top往上调整为自身高度的一半，从而实现在swiper中垂直居中效果，如下图所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c1235c8b4b14a6ab022974401ba1818~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=CAtXr3tHMpdMiL5MlkU2eLPa9iA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-21">2、 场景二：固定定位实顶部导航栏和侧边悬浮导航</h4>
<p>例如下图中官网导航栏和右侧悬浮按钮，就是使用固定定位实现的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d7ce70e4592494a8d48b9c3ee85847b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=wetTuT%2FihnaPX5eFv0o%2FMFdqAFI%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc75077b193443b9ad8d9e7538368c00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=LCa7nCWqKB5wqaAnLQTglEAsxMA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-22">3、 场景三：粘性定位实现低代码卡片 tab 标签页吸顶效果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105f89ddcf7c4388951c7a3d1419c512~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=aw1h1d%2F0H7OpCyb0mCzdydbq2ys%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11eec76ec10545aa8253393c7b6ed1ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=E5HRNaS01U%2FTGh9wGS1%2Bw6UtUrc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-23">七、网格布局</h2>
<p>网格布局是<strong>二维布局模型</strong>，通过定义行（rows）和列（columns），精准控制网页元素的位置、尺寸，还能实现响应式设计。</p>
<p><strong>网格布局具有上述优势，我们是不是可以抛弃弹性布局，全部使用网格布局呢？</strong></p>
<p>事实上，实际开发中 flex 和 grid 常混用：</p>
<p>Flex：适合快速做一维布局、动态对齐内容（比如单行布局） 等线性排列场景</p>
<p>Grid：适合搭建复杂页面框架，可同时控制行和列的排列，实现真正的二维布局。</p>
<p>例如下图中B站首页布局就是 flex 和 grid 混用实现的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/705ea8de6496436b918f7e77872de2f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=k81r9i8Gvw0H%2BI8irWkkX4lQD8I%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-24">场景1：实现B站11列2行竖向排列导航栏效果，同时控行列</h4>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-comment">/* 1列2行，竖向排列 */</span>
    <span class="hljs-selector-class">.bilibili-nav</span> {
 ...
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-comment">/* 核心：列优先排列（竖向填充） */</span>
      <span class="hljs-attribute">grid-auto-flow</span>: column;
      <span class="hljs-comment">/* 定义2行（每行高度均分） */</span>
      <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>fr);
      <span class="hljs-comment">/* 定义11列（每列宽度均分） */</span>
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">11</span>, <span class="hljs-number">1</span>fr);
  ...
    }
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/083592b4ebf9436d8a128b7533cb1eb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=tpkbnAzVdlb2OkXEnJa7Ucon6%2Bc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-25">场景2：实现阿里巴巴矢量图标库响应式卡片布局（适配手机 / 平板 / PC）</h4>
<p>如下图效果，可以直接使用grid布局实现，无须借助媒体查询</p>
<pre><code class="hljs language-css" lang="css">...
    <span class="hljs-comment">/* 卡片网格容器 */</span>
    <span class="hljs-selector-class">.card-grid</span> {
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>; <span class="hljs-comment">/* 卡片之间的水平+垂直间距（无需margin，避免重叠） */</span>
      <span class="hljs-comment">/* 核心：自动适配列数，列宽最小250px，最大自适应 */</span>
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">250px</span>, <span class="hljs-number">1</span>fr));
    }
...
 
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfc9968ee7ad445fbd9b8a4f00ddc032~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=5gLj9MrOlkOxkAxBiSi4EIdihII%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bea15e6bf29f4ba8b3d2a4ea9c6a5623~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=oWv3AyoM9SBbPbvl0rQYlFqk5MI%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/178a35113bbe4804a93fd2e605e6c591~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=MDxBWB12QAhYHsqgzhZUIBzOos8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6c780e25511459e9cc79d795deb9ca0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591428&amp;x-signature=aB6kCdpxeHYB8wdOZ9EJroRXSOA%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08d906fa83e74491a6a0766a05d94cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591429&amp;x-signature=agihy2xjbeoFrK4ZX9LyXxGnomQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-26">场景3：实现蔚来汽车官网“2 行 3 列 + 汽车图跨 2 列”效果</h4>
<pre><code class="hljs language-css" lang="css">...
    <span class="hljs-comment">/* 红框网格容器 */</span>
    <span class="hljs-selector-class">.nio-grid-container</span> {
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-comment">/* 行列比例：匹配2行3列+大元素跨列 */</span>
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">2</span>fr <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr; 
      <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr;
...
    }

    <span class="hljs-comment">/* 1. 汽车图（跨1行2列） */</span>
    <span class="hljs-selector-class">.item-car</span> {
      <span class="hljs-attribute">grid-area</span>: <span class="hljs-number">1</span> / <span class="hljs-number">1</span> / <span class="hljs-number">2</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">/* 行1-2，列1-3 → 跨2列 */</span>
    }
    <span class="hljs-comment">/* 2. 右上角“生长” */</span>
    <span class="hljs-selector-class">.item-grow</span> {
      <span class="hljs-attribute">grid-area</span>: <span class="hljs-number">1</span> / <span class="hljs-number">3</span> / <span class="hljs-number">2</span> / <span class="hljs-number">4</span>;
    }

    <span class="hljs-comment">/* 3. 中间右侧“11” */</span>
    <span class="hljs-selector-class">.item-11</span> {
      <span class="hljs-attribute">grid-area</span>: <span class="hljs-number">2</span> / <span class="hljs-number">3</span> / <span class="hljs-number">3</span> / <span class="hljs-number">4</span>;
    }

    <span class="hljs-comment">/* 4. 左下角元素 */</span>
    <span class="hljs-selector-class">.item-left-bottom</span> {
      <span class="hljs-attribute">grid-area</span>: <span class="hljs-number">2</span> / <span class="hljs-number">1</span> / <span class="hljs-number">3</span> / <span class="hljs-number">2</span>;
    }

    <span class="hljs-comment">/* 5. 中间下元素 */</span>
    <span class="hljs-selector-class">.item-middle-bottom</span> {
      <span class="hljs-attribute">grid-area</span>: <span class="hljs-number">2</span> / <span class="hljs-number">2</span> / <span class="hljs-number">3</span> / <span class="hljs-number">3</span>;
    }
  &lt;/style&gt;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d759f5a8cda40dba053fef5662ed8b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591429&amp;x-signature=GUK4tA1o9OVKe3CSEKjomt9gbD4%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a6d425c77cc4108bcf87a97d22396ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591429&amp;x-signature=KD3FB0NegtIEVhsVJCHTFZBoGHI%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f4b92d5ed344f8b9ee339a6df49977e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591429&amp;x-signature=sMg6%2Bxqg5LxPI7OD3UWidT%2FE2Do%3D" alt="image.png" loading="lazy"/></p>
<p><strong>简单来说，Grid 是 “为复杂二维布局而生”，能以更少的代码实现更灵活、可控的布局，尤其适合页面框架、响应式卡片、复杂图文组合等场景。</strong></p>
<h2 data-id="heading-27">八、多列布局</h2>
<p>用于将元素内容自动分割为指定数量的垂直列，如下图效果。有些同学可能会说，下面的布局我们用flex或者grid也能做出来，那么<strong>为什么要再学习多列布局呢</strong>？</p>
<p>因为如果使用flex或者grid布局，我们需要先准备三个盒子，然后再把内容装进去，而使用多列布局则不需要事先准备盒子，直接准备内容就可以了，如下代码所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9afdc13a74204139b9ba9668b203dba1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591429&amp;x-signature=8wXJRqjU0%2Bt3lL6p%2BIsfQxaE9x8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"> <span class="hljs-comment">/* 容器：设置多列 */</span>
    <span class="hljs-selector-class">.column-container</span> {
      ...
      <span class="hljs-comment">/* 多列核心属性 */</span>
      <span class="hljs-attribute">column-count</span>: <span class="hljs-number">3</span>; <span class="hljs-comment">/* 分为3列 */</span>
      <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">10px</span>; <span class="hljs-comment">/* 列之间的间隙 */</span>
      <span class="hljs-attribute">column-rule</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#4da6ff</span>; <span class="hljs-comment">/* 列分隔线 */</span>
       ...
    }
    <span class="hljs-comment">/* 子元素：不同高度模拟不规则布局 */</span>
    <span class="hljs-selector-class">.item</span> {
      ...
      <span class="hljs-attribute">break-inside</span>: avoid; <span class="hljs-comment">/* 避免子元素被列分割 */</span>
      ...
    }
</code></pre>
<p>适用场景</p>
<ol>
<li>长文章分栏：文章自动分列，支持间隙、响应式效果，如语雀官网效果</li>
<li>图片瀑布流，如阿里巴巴矢量图标库</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cfc3a287c3b47db9f22c3351d865450~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591429&amp;x-signature=r53BBJLe9uQjnvGmUVLAAHZsLHs%3D" alt="image.png" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b68f9885c8e04017ae787c77f8fe136c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5bCP6I-y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767591429&amp;x-signature=TXMtuNdO3O3p4TDki9154SrPNhE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-28">九、总结</h2>
<p>不同技术各有适用场景、优缺点，需配合使用：</p>
<ul>
<li>简单布局：优先用 Flexbox（一维）或 Grid（二维）</li>
<li>复杂响应式布局：Grid + 媒体查询</li>
<li>文本内容分栏：多列布局（column-count）</li>
<li>兼容旧浏览器：浮动布局，或 Flexbox 降级方案</li>
<li>趋势：CSS Grid 逐渐成为主流，适配更复杂布局场景</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 向右，社区向左-Captain 的 2025年终总结]]></title>    <link>https://juejin.cn/post/7589509638354321435</link>    <guid>https://juejin.cn/post/7589509638354321435</guid>    <pubDate>2025-12-30T09:53:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589509638354321435" data-draft-id="7589214068093927443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 向右，社区向左-Captain 的 2025年终总结"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-12-30T09:53:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 向右，社区向左-Captain 的 2025年终总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:53:30.000Z" title="Tue Dec 30 2025 09:53:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI 向右，社区向左</h2>
<p>站在 2025 的尾巴上回望，这确实是极具撕裂感的一年。</p>
<p>一方面，AI 技术像一列高速列车，轰鸣着向着更强的逻辑、更高的效率、更极致的自动化狂奔——我称之为 <strong>“向右” <strong>；另一方面，在算法的挤压下，人类的社区、情感与价值正在发生某种应激性的回撤，我们开始寻找那些模型和 AI无法触达的温热——我称之为</strong>“向左”</strong>。</p>
<p>作为身处AI风暴中心的观察者，这是我对 2025 年 AI 编程发展的思考，以及我这一年的个人答卷。</p>
<h2 data-id="heading-1">Part 1. AI 向右：范式的极速狂奔</h2>
<p>本次观察主要是结合Andrej Karpathy 是 OpenAI 联合创始人、前特斯拉 AI 总监的 2025 年 LLM 年度回顾。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0af4b5621dfe45f99b66d1c953c17431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767693325&amp;x-signature=bdtLO7%2Fg%2FAco4UN6jgh%2BCWEF5M0%3D" alt="img_v3_02t7_5d451660-02e5-4df8-bc0d-a5fbe9e86a3g.jpg" loading="lazy"/></p>
<p>Andrej Karpathy（OpenAI 联合创始人）的年度回顾精准地描绘了 AI 技术“向右”狂奔的轨迹。这一年，AI 编程不再是简单的辅助，而是正在重塑“智能”的定义。</p>
<h4 data-id="heading-2">1. 训练范式的“顿悟”</h4>
<p>2025 年最大的技术变量是 <strong>RLVR（可验证奖励的强化学习）</strong> 。 过去的 AI 是“照葫芦画瓢”，人类怎么写代码它就怎么学。但 RLVR 引入了“标准答案”环境（如数学题、代码编译），把模型直接扔进水里，只要游到对岸，姿势随便。 结果令人震惊：模型自己“悟”出了推理能力。它学会了拆解步骤、学会了自我纠错。OpenAI 的 o1 和 o3 就是这种思维链条（Chain of Thought）的产物。算力分配也变了——从死磕预训练，转向了让模型在推理时“多想一会儿”。</p>
<h4 data-id="heading-3">2. “参差不齐”的幽灵</h4>
<p>Karpathy 说我们在“召唤幽灵”。因为优化目标不同（人类为了生存，AI 为了刷榜），AI 展现出一种 <strong>Jagged Intelligence（参差不齐的智能）</strong> 。 它在有标准答案的领域（代码、数学）进化神速，长出了尖刺；但在常识、创意等模糊领域，依然会犯低级错误。这也导致了基准测试（Benchmark）的崩塌——刷榜成了一种针对性优化的艺术，分数虽高，离通用智能尚远。</p>
<h4 data-id="heading-4">3. 应用层的爆发与“Vibe Coding”</h4>
<p>Cursor 的火爆证明了 <strong>“LLM 应用层”</strong> 的成立。它是把通用模型（大学毕业生）培训成专业员工（行业专家）的中间层。 更激进的变化是 <strong>Vibe Coding（氛围编程）</strong> 的兴起。现在的编程门槛低到只需要你会英语，描述需求，完全不用管代码实现。代码变得廉价、即用即弃，像草稿纸一样。 这不仅让普通人能编程，也让专业程序员开始写那些以前“不值得写”的一次性工具。</p>
<h4 data-id="heading-5">4. 住在电脑里的“小精灵”</h4>
<p>Claude Code 展示了未来的方向：<strong>本地化智能体（Agent）</strong> 。 OpenAI 曾赌注云端，但 Karpathy 认为当下更合理的是让 AI 跑在你的电脑上，读取你的本地环境、文件和上下文，像一个和你并肩作战的同事，而不仅仅是一个网页聊天框。</p>
<h4 data-id="heading-6">5. 大模型的 GUI 时代</h4>
<p>Google Gemini Nano Banana 预示了下一个范式：大模型不该只吐文字，它应该像 80 年代的计算机进化出图形界面一样，学会用图表、幻灯片、白板甚至小应用来回应人类。这才是 LLM 真正的原生交互形态。</p>
<p>Karpathy 的总结是这样的：2025 年的大模型，比他预期的聪明，也比他预期的蠢。两者同时成立。</p>
<p>但有一点很确定：即使以现在的能力，我们连 10% 的潜力都没挖掘出来。还有太多想法可以试，整个领域感觉是敞开的。</p>
<p>他在 Dwarkesh 的播客里说过一句看似矛盾的话：</p>
<blockquote>
<p>他相信进步会继续飞速推进，</p>
</blockquote>
<blockquote>
<p>同时也相信还有大量的工作要做。</p>
</blockquote>
<p>其实两件事并不矛盾。目前这个阶段的AI 让执行变快了，但它没有让“知道该做什么”这件事变简单。相反，因为执行成本下降，“做什么”的决策变得更重要了——你可以很快做出 20 个版本，但你得知道哪个是对的。</p>
<p>几年后的软件工程会是什么样子？没人能准确预测。但 Claude Code 团队的今天，可能是很多团队明天的某种预演——更快的迭代、更少的“搬砖”、更多的判断和决策。</p>
<p>工具在变。不变的是，最终做决定的还是人。</p>
<h2 data-id="heading-7">Part 2. 社区向左：人类的价值回撤和重塑</h2>
<p>当 AI 在符号逻辑的领域攻城略地时，传统的程序员社区和人类劳动价值正在被迫寻找新的锚点。</p>
<h3 data-id="heading-8">传统问答社区的黄昏</h3>
<p>所有类似 Stack Overflow 的问答和知识社区衰落是不可逆的。</p>
<p>既然 AI 能瞬间给出代码片段，谁还愿意去搜索引擎或者 BBS论坛等待一个未知的回复？</p>
<ul>
<li><strong>流量暴跌：</strong> 只有纯技术问答在被替代。</li>
<li><strong>质量恶化：</strong> AI 生成的垃圾内容泛滥，需要人肉排雷。</li>
</ul>
<p>但 Reddit 这种强社交属性的社区反而在复兴。<strong>这说明了“向左”的趋势：</strong> 知识获取变得廉价后，<strong>人与人的连接、情感共鸣、线下见面的价值</strong>反而变得无比昂贵。那么后面社区的持久价值在哪里？可以深度链接线下社区和深度社交的社区，因此我个人比较看好 reddit 和社群的价值。</p>
<h3 data-id="heading-9">硅基生命迫使我们重新思考劳动力价值</h3>
<p>起因是有一天周末做了 aidp 平台美观度标注的一道题，大概收入 600 元，我个人是有点感慨万千，就是感觉在帮助模型掘墓程序员，最近群友读《送外卖》也是，最细颗粒度的路线和送餐方式数据模型还学不会，就通过机制让外卖员动脑子“榨”出来最末端的思考</p>
<p>在AI快速取代人类劳动力的浪潮中，一个核心规律逐渐清晰：越是纯符号、可形式化、封闭规则的知识工作（如编程、数学证明、文书处理），越容易被大模型迅速吃掉，因为这些领域没有物理限制，AI可以无限试错和迭代，人类程序员的经验很快就会被“偷师”并固化成更严苛的算法，陷入被追赶的被动。</p>
<p>相反，越是依赖肉身存在、高度情境化、充满社会互动和长尾瞬变的长尾场景（如外卖最后一公里、餐厅服务、医疗护理、养老陪伴），AI和机器人越难彻底取代。现实世界的复杂性、动态性和情感需求，让最细颗粒度的优化永远学不完——今天的新小巷、明天的客人情绪、后天的突发状况，都在不断产生新知识。平台和机器人再怎么从人类身上“偷师”，也总有追不上的地方。</p>
<p>因此，真正抗AI取代的，往往不是高薪的高级知识工作，而是那些看似低端的“服务业”。服务员、护理员、陪护人员，这些需要温度、共情、即时应变和身体在场的岗位，可能成为人类劳动力最后的堡垒。当机器人终于能端稳一盘热汤、读懂客人的眼神、处理一场家庭纠纷时，或许才称得上人类劳动力的真正大解放。而在那一刻到来之前，服务业很可能比写代码更有未来——因为它最难被完全算法化和自动化。</p>
<p>说到底，AI最容易取代的，是那些不需要“成为人类”就能完成的工作；而最顽强存活下来的，往往正是那些只有人类才能做好的事。</p>
<h3 data-id="heading-10">社区的个体应该也就是码农的我们应该如何应对冲击</h3>
<p>其实很多东西是亘古不变的，打不过就积极拥抱，快速深入。</p>
<ul>
<li>
<p><strong>拥抱快速落地：</strong> 可以深度尝试从两周一个原型变成一周三个。</p>
</li>
<li>
<p><strong>AI 辅助 TDD：</strong> 让写测试不再昂贵。</p>
</li>
<li>
<p><strong>成为 Product-minded Engineer：</strong> 像 Claude Code 团队那样，不需要专门的 PM，工程师利用 AI 补齐短板，直接对产品结果负责。</p>
</li>
</ul>
<h2 data-id="heading-11">Captain 的 2025-谈谈我个人的工作和生活</h2>
<h3 data-id="heading-12">我去年立过的 Flag</h3>
<ul>
<li>
<p>减肥：失败，戒烟一年证件整，感觉至少肥了 10 公斤，</p>
</li>
<li>
<p>戒烟：成功～这点确实坚持了一年，</p>
</li>
<li>
<p>计划出 3 本书
实际只出版了 2 本，及格分，但是第二本书有幸和英国出版社合作了，也算出了三本</p>
<ul>
<li>第一个Vibe 编程 探索 AI 时代编程新范式
<ul>
<li>先说下写这本书的初衷是因为从业原因观察到了 AI 编程的会对各位程序员们产生巨大的冲击，希望大家能看到这个变化，但是由于四位作者大家的认知和投入度都不一样，我对这本书整体是不满意的，主要还是技术人看了摇头，非技术人看不懂，略显鸡肋。</li>
<li/>
</ul>
</li>
</ul>
</li>
</ul>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6af8d155de6541c4897308f50a910cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767693325&amp;x-signature=3%2FX4xInk80ru%2Bf6A7wstgnfAq60%3D" alt="ea39a75caf710d13bbec1bc8bbd18849.jpg" width="30%" loading="lazy"/>
<ul>
<li>
<p>第二本是人人都是 AI 程序员-TRAE +Cursor 从 0 到 1 全栈实战
这本书也是一波三折～但是找了很多朋友看了，觉得很有信心。期待上市表现</p>
  <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/380d8c94704844fb875488fcb6b03d99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767693325&amp;x-signature=KyQSDtcKsw4mSFzNZMWUI5BY1Zw%3D" alt="d0a500e114a75960fbec995d152b3878.jpg" width="30%" loading="lazy"/>
</li>
<li>
<p>浪说播客：<a href="https://link.juejin.cn?target=https%3A%2F%2Flangshuo0.podcast.xyz" target="_blank" title="https://langshuo0.podcast.xyz" ref="nofollow noopener noreferrer">langshuo0.podcast.xyz</a> 没有断更～～～</p>
<ul>
<li>全网 4000 粉，累计 20w 播放</li>
<li>最近录制的两期的播客推荐听一下
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xiaoyuzhoufm.com%2Fepisode%2F69376f77238f302e4b281483%3Fs%3DeyJ1IjoiNWYzYzhhYjdlMGY1ZTcyM2JiMDVjMDdlIn0%253D" target="_blank" title="https://www.xiaoyuzhoufm.com/episode/69376f77238f302e4b281483?s=eyJ1IjoiNWYzYzhhYjdlMGY1ZTcyM2JiMDVjMDdlIn0%3D" ref="nofollow noopener noreferrer">聊聊 AI 编程的现状和未来</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xiaoyuzhoufm.com%2Fepisode%2F694b33d77c91834b9fc14a95%3Fs%3DeyJ1IjoiNWYzYzhhYjdlMGY1ZTcyM2JiMDVjMDdlIn0%253D" target="_blank" title="https://www.xiaoyuzhoufm.com/episode/694b33d77c91834b9fc14a95?s=eyJ1IjoiNWYzYzhhYjdlMGY1ZTcyM2JiMDVjMDdlIn0%3D" ref="nofollow noopener noreferrer">浪说年终盘点-AI 编程这一年：是降维打击？还是赛博垃圾的狂欢？</a>
<ul>
<li>2026年终盘点。那天晚上发布播客，准备素材听了自己的播客，感觉很奇怪也很有趣，我从头到尾头一次听了自己 2h 的播客，实际这期播客录制时候有很多杂音的[破涕为笑]。
狼叔 是 AI 编程保守派，且带着对 AI 编程的无限嘲讽
袁滚滚  观点尖锐，讨厌 AI 味的产物
folyd 26 年目标 1M ARR
williemJiang古典派，也开始用 AI 编程去维护开源项目。
今年总结是有趣的一期，希望大家有所收获</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">工作上社区的变化</h3>
<ul>
<li>结合今年的热点做了：aicoding.juejin.cn ，种种原因，没有做好，这也让我重新审视传统技术社区的价值。</li>
<li>主要工作中心放在 TRAE 上</li>
<li>去了上海、杭州、广州、深圳、成都、重庆跑了一圈，组织了很多线下活动</li>
<li>第一次真正意义上的跨国去到东京组织了一次活动</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8403237079c14e7eb3df344e463ad11d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767693325&amp;x-signature=7xRq4ulsqil4mFFew%2BWTKgf%2BSaA%3D" alt="31f4b0a02f9bf35f5004fdb8c5108c50.jpg" loading="lazy"/></p>
<blockquote>
<p><strong>这些线下面对面的碰撞给我的体会是：</strong> 代码可以由 AI 生成，但信任、激情和灵感的碰撞，依然只发生在人与人面对面的时刻。</p>
</blockquote>
<h3 data-id="heading-14">26 年的 个人flag</h3>
<ul>
<li>减肥，希望瘦回高中时代</li>
<li>有个娃娃</li>
<li>做一些重要决策</li>
<li>买个摩托车可以摩旅</li>
<li>深度使用 和拥抱 AI</li>
<li>坚持录播客</li>
<li>许愿美国签证和巴西签证顺利下来，可以走出亚洲～～～</li>
<li>帮助更多人了解 AI 编程</li>
</ul>
<p>我是 Captain，“25年太漫长、太疲惫了，你可以开启新生活了。”</p>
<p>技术是一直在变，工具也在变，但做决定的依然是人。 AI 让执行变得极其廉价，这就意味着 **“决定做什么”**变得前所未有的昂贵。</p>
<p>这里也分享一下最近 youtube 爆火中年程序员的视频，一场关于金钱、时间与生命意义的深刻复盘。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyoutu.be%2FVeMA9WGKxOg%3Fsi%3Dxx5AAOuJLy87ePeV" target="_blank" title="https://youtu.be/VeMA9WGKxOg?si=xx5AAOuJLy87ePeV" ref="nofollow noopener noreferrer">youtu.be/VeMA9WGKxOg…</a></p>
<p>从少年时代抱着O'Reilly技术书狂啃，到如今手握专利、拿着大厂天价股票的技术高管，这位40多岁的大哥回顾了自己科技圈摸爬滚打的25年。光鲜亮丽的表面下，是残酷的现实：即使做到架构师，也发现自己不过在重复造轮子，代码并未真正让世界变好。他亲眼目睹才华横溢的同事因过劳离世，却仅一周后，公司里就仿佛这个人从未存在过。每天只剩1小时陪伴孩子，错过了带他们露营、钓鱼的宝贵时光。得益于早年对财富的觉醒，在最后一轮大裁员中，他做出一个勇敢决定：为保住组里年轻人的饭碗，他主动把自己放进裁员名单。</p>
<p>评论区很有趣，大家说这才是YouTube存在的意义。</p>
<p>“唯一会记得你加班到深夜的人，只有你的孩子和家人。科技行业早已缺乏忠诚与体面。”</p>
<p>“如果你死了，你的职位会在讣告刊登前就被重新招聘。”</p>
<p>“兄弟看起来真的因为被裁员而开心。也许这其实是塞翁失马，焉知非福。”</p>
<p>“请多发一些视频。社交媒体上充斥着垃圾内容，我们需要有真实生活经验的真人分享故事。”</p>
<p>“被裁员是每个科技从业者的宿命。你必须成为合伙人——要么在当前公司，要么创办自己的公司。”</p>
<p>“25年太漫长、太疲惫了，你可以开启新生活了。”</p>
<p>2026 希望继续和大家同在，欢迎大家持续找我交流聊天，个人微信：229199157，推特：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FXCaptaincc" target="_blank" title="https://x.com/XCaptaincc" ref="nofollow noopener noreferrer">x.com/XCaptaincc</a></p>
<p>看到结尾的别掘友们别划走，请留下你的思考和感触，我会填选 3-5 人评论送出的我的个人签名书一本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[制作早餐，我异步编程]]></title>    <link>https://juejin.cn/post/7589475923696336915</link>    <guid>https://juejin.cn/post/7589475923696336915</guid>    <pubDate>2025-12-30T08:03:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589475923696336915" data-draft-id="7589212818807242815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="制作早餐，我异步编程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T08:03:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七宝三叔"/> <meta itemprop="url" content="https://juejin.cn/user/2508420375913500"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            制作早餐，我异步编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2508420375913500/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七宝三叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:03:33.000Z" title="Tue Dec 30 2025 08:03:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景：忙碌的早晨制作早餐</h2>
<p>想象一下工作日的早晨，你需要准备一份完整的早餐。让我们看看这个过程如何用同步和异步的方式来执行：</p>
<p>csharp</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Diagnostics;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">BreakfastAsyncExample</span>
{
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 早餐食材和工具</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Kitchen</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> CoffeeReady { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> ToastReady { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> EggsReady { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> JuiceReady { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }

    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">"=== 早餐制作模拟 ===\n"</span>);
            
            <span class="hljs-comment">// 演示同步制作早餐（低效方式）</span>
            Console.WriteLine(<span class="hljs-string">"1. 同步制作早餐（低效方式）："</span>);
            <span class="hljs-keyword">await</span> MakeBreakfastSynchronously();
            
            Console.WriteLine(<span class="hljs-string">"\n"</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">'-'</span>, <span class="hljs-number">50</span>) + <span class="hljs-string">"\n"</span>);
            
            <span class="hljs-comment">// 演示异步制作早餐（高效方式）</span>
            Console.WriteLine(<span class="hljs-string">"2. 异步制作早餐（高效方式）："</span>);
            <span class="hljs-keyword">await</span> MakeBreakfastAsynchronously();
            
            Console.WriteLine(<span class="hljs-string">"\n"</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">'-'</span>, <span class="hljs-number">50</span>) + <span class="hljs-string">"\n"</span>);
            
            <span class="hljs-comment">// 演示更高级的异步模式</span>
            Console.WriteLine(<span class="hljs-string">"3. 并行异步制作早餐（最优方式）："</span>);
            <span class="hljs-keyword">await</span> MakeBreakfastParallelAsync();
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 同步方式制作早餐 - 低效但简单</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">MakeBreakfastSynchronously</span>()</span>
        {
            <span class="hljs-keyword">var</span> stopwatch = Stopwatch.StartNew();
            <span class="hljs-keyword">var</span> kitchen = <span class="hljs-keyword">new</span> Kitchen();
            
            Console.WriteLine(<span class="hljs-string">"早上7:00 - 开始制作早餐"</span>);
            
            <span class="hljs-comment">// 同步方式：一个接一个地做</span>
            <span class="hljs-keyword">await</span> MakeCoffeeAsync(kitchen);        <span class="hljs-comment">// 煮咖啡需要3分钟</span>
            <span class="hljs-keyword">await</span> MakeToastAsync(kitchen);         <span class="hljs-comment">// 烤面包需要2分钟</span>
            <span class="hljs-keyword">await</span> FryEggsAsync(kitchen);           <span class="hljs-comment">// 煎鸡蛋需要4分钟</span>
            <span class="hljs-keyword">await</span> PourJuiceAsync(kitchen);         <span class="hljs-comment">// 倒果汁需要1分钟</span>
            
            stopwatch.Stop();
            Console.WriteLine(<span class="hljs-string">$"早上7:10 - 早餐完成！总共耗时: <span class="hljs-subst">{stopwatch.Elapsed.TotalSeconds:F1}</span>秒"</span>);
            ServeBreakfast(kitchen);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 异步方式制作早餐 - 高效但不完美</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">MakeBreakfastAsynchronously</span>()</span>
        {
            <span class="hljs-keyword">var</span> stopwatch = Stopwatch.StartNew();
            <span class="hljs-keyword">var</span> kitchen = <span class="hljs-keyword">new</span> Kitchen();
            
            Console.WriteLine(<span class="hljs-string">"早上7:00 - 开始制作早餐"</span>);
            
            <span class="hljs-comment">// 异步方式：开始所有任务，然后等待</span>
            <span class="hljs-keyword">var</span> coffeeTask = MakeCoffeeAsync(kitchen);        <span class="hljs-comment">// 3分钟</span>
            <span class="hljs-keyword">var</span> toastTask = MakeToastAsync(kitchen);          <span class="hljs-comment">// 2分钟</span>
            <span class="hljs-keyword">var</span> eggsTask = FryEggsAsync(kitchen);             <span class="hljs-comment">// 4分钟</span>
            <span class="hljs-keyword">var</span> juiceTask = PourJuiceAsync(kitchen);          <span class="hljs-comment">// 1分钟</span>
            
            <span class="hljs-comment">// 等待所有任务完成</span>
            <span class="hljs-keyword">await</span> coffeeTask;
            <span class="hljs-keyword">await</span> toastTask;
            <span class="hljs-keyword">await</span> eggsTask;
            <span class="hljs-keyword">await</span> juiceTask;
            
            stopwatch.Stop();
            Console.WriteLine(<span class="hljs-string">$"早上7:04 - 早餐完成！总共耗时: <span class="hljs-subst">{stopwatch.Elapsed.TotalSeconds:F1}</span>秒"</span>);
            ServeBreakfast(kitchen);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 并行异步制作早餐 - 最优方式</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">MakeBreakfastParallelAsync</span>()</span>
        {
            <span class="hljs-keyword">var</span> stopwatch = Stopwatch.StartNew();
            <span class="hljs-keyword">var</span> kitchen = <span class="hljs-keyword">new</span> Kitchen();
            
            Console.WriteLine(<span class="hljs-string">"早上7:00 - 开始制作早餐"</span>);
            
            <span class="hljs-comment">// 使用Task.WhenAll并行执行所有任务</span>
            <span class="hljs-keyword">await</span> Task.WhenAll(
                MakeCoffeeAsync(kitchen),        <span class="hljs-comment">// 3分钟</span>
                MakeToastAsync(kitchen),         <span class="hljs-comment">// 2分钟  </span>
                FryEggsAsync(kitchen),           <span class="hljs-comment">// 4分钟</span>
                PourJuiceAsync(kitchen)          <span class="hljs-comment">// 1分钟</span>
            );
            
            stopwatch.Stop();
            Console.WriteLine(<span class="hljs-string">$"早上7:04 - 早餐完成！总共耗时: <span class="hljs-subst">{stopwatch.Elapsed.TotalSeconds:F1}</span>秒"</span>);
            ServeBreakfast(kitchen);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 异步煮咖啡 - 模拟耗时操作</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">MakeCoffeeAsync</span>(<span class="hljs-params">Kitchen kitchen</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">$"  开始煮咖啡（需要3秒）..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 模拟3秒的煮咖啡时间</span>
            
            kitchen.CoffeeReady = <span class="hljs-literal">true</span>;
            Console.WriteLine(<span class="hljs-string">$"  ✓ 咖啡煮好了！"</span>);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 异步烤面包 - 模拟耗时操作</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">MakeToastAsync</span>(<span class="hljs-params">Kitchen kitchen</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">$"  开始烤面包（需要2秒）..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 模拟2秒的烤面包时间</span>
            
            kitchen.ToastReady = <span class="hljs-literal">true</span>;
            Console.WriteLine(<span class="hljs-string">$"  ✓ 面包烤好了！"</span>);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 异步煎鸡蛋 - 模拟耗时操作</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">FryEggsAsync</span>(<span class="hljs-params">Kitchen kitchen</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">$"  开始煎鸡蛋（需要4秒）..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">4000</span>); <span class="hljs-comment">// 模拟4秒的煎鸡蛋时间</span>
            
            kitchen.EggsReady = <span class="hljs-literal">true</span>;
            Console.WriteLine(<span class="hljs-string">$"  ✓ 鸡蛋煎好了！"</span>);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 异步倒果汁 - 模拟简单操作</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">PourJuiceAsync</span>(<span class="hljs-params">Kitchen kitchen</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">$"  开始倒果汁（需要1秒）..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 模拟1秒的倒果汁时间</span>
            
            kitchen.JuiceReady = <span class="hljs-literal">true</span>;
            Console.WriteLine(<span class="hljs-string">$"  ✓ 果汁倒好了！"</span>);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 上菜</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ServeBreakfast</span>(<span class="hljs-params">Kitchen kitchen</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">"\n  早餐上桌："</span>);
            <span class="hljs-keyword">if</span> (kitchen.CoffeeReady) Console.WriteLine(<span class="hljs-string">"  ☕ 热咖啡"</span>);
            <span class="hljs-keyword">if</span> (kitchen.ToastReady) Console.WriteLine(<span class="hljs-string">"  🍞 烤面包"</span>);
            <span class="hljs-keyword">if</span> (kitchen.EggsReady) Console.WriteLine(<span class="hljs-string">"  🍳 煎鸡蛋"</span>);
            <span class="hljs-keyword">if</span> (kitchen.JuiceReady) Console.WriteLine(<span class="hljs-string">"  🥤 橙汁"</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-1">更深入的生活例子：早上的多重任务</h2>
<p>让我们看一个更贴近生活的复杂例子：</p>
<p>csharp</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">MorningRoutineExample</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MorningPerson</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsShowered { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsDressed { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> HasEaten { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> EmailResult Emails { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> HasNews { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EmailResult</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Count { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> List&lt;<span class="hljs-built_in">string</span>&gt; ImportantEmails { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">"🌅 高效的早晨：异步编程的日常应用\n"</span>);
            
            <span class="hljs-keyword">await</span> DemonstrateMorningRoutine();
            
            Console.WriteLine(<span class="hljs-string">"\n"</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">'='</span>, <span class="hljs-number">60</span>) + <span class="hljs-string">"\n"</span>);
            
            <span class="hljs-keyword">await</span> DemonstrateRealWorldAsyncPatterns();
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 演示早晨日常的异步模式</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">DemonstrateMorningRoutine</span>()</span>
        {
            <span class="hljs-keyword">var</span> person = <span class="hljs-keyword">new</span> MorningPerson();
            <span class="hljs-keyword">var</span> morningTasks = <span class="hljs-keyword">new</span> List&lt;Task&gt;();
            
            Console.WriteLine(<span class="hljs-string">"【场景1：普通人的早晨】"</span>);
            Console.WriteLine(<span class="hljs-string">"7:00 闹钟响了，开始早晨日常...\n"</span>);
            
            <span class="hljs-comment">// 1. 并行开始多个任务</span>
            <span class="hljs-keyword">var</span> showerTask = TakeShowerAsync(person);
            <span class="hljs-keyword">var</span> coffeeTask = MakeCoffeeAsync(); <span class="hljs-comment">// 这个我们不需要等它完成才做其他事</span>
            
            <span class="hljs-comment">// 2. 等待必须完成的任务（洗澡）</span>
            <span class="hljs-keyword">await</span> showerTask;
            Console.WriteLine(<span class="hljs-string">"  7:10 ✓ 洗完澡了\n"</span>);
            
            <span class="hljs-comment">// 3. 继续其他可以并行的任务</span>
            <span class="hljs-keyword">var</span> dressTask = GetDressedAsync(person);
            <span class="hljs-keyword">var</span> breakfastTask = HaveBreakfastAsync(person);
            
            <span class="hljs-comment">// 4. 同时检查新闻和天气（非关键任务）</span>
            <span class="hljs-keyword">var</span> newsTask = CheckNewsAsync(person);
            
            <span class="hljs-comment">// 5. 等待穿衣和早餐完成</span>
            <span class="hljs-keyword">await</span> Task.WhenAll(dressTask, breakfastTask);
            Console.WriteLine(<span class="hljs-string">"  7:20 ✓ 穿好衣服吃完早餐\n"</span>);
            
            <span class="hljs-comment">// 6. 检查咖啡是否好了</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> coffeeTask)
            {
                Console.WriteLine(<span class="hljs-string">"  ☕ 咖啡已经好了，可以带着路上喝\n"</span>);
            }
            
            <span class="hljs-comment">// 7. 处理新闻（如果有）</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> newsTask)
            {
                Console.WriteLine(<span class="hljs-string">"  📰 了解了今天的头条新闻\n"</span>);
            }
            
            Console.WriteLine(<span class="hljs-string">"  7:25 🚗 准时出门上班！"</span>);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 演示真实世界中的异步模式</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">DemonstrateRealWorldAsyncPatterns</span>()</span>
        {
            Console.WriteLine(<span class="hljs-string">"【场景2：工作中的异步编程】"</span>);
            Console.WriteLine(<span class="hljs-string">"9:00 到达办公室，开始工作...\n"</span>);
            
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-comment">// 模式1：超时控制 - 等待回复邮件，但不超过5分钟</span>
                Console.WriteLine(<span class="hljs-string">"1. 发送重要邮件并等待回复（最多等5分钟）..."</span>);
                <span class="hljs-keyword">var</span> emailReply = <span class="hljs-keyword">await</span> WaitForEmailReplyAsync()
                    .WithTimeout(TimeSpan.FromMinutes(<span class="hljs-number">5</span>));
                
                <span class="hljs-keyword">if</span> (emailReply != <span class="hljs-literal">null</span>)
                {
                    Console.WriteLine(<span class="hljs-string">"   ✓ 收到了回复"</span>);
                }
                <span class="hljs-keyword">else</span>
                {
                    Console.WriteLine(<span class="hljs-string">"   ⏱️  超时了，继续其他工作"</span>);
                }
                
                <span class="hljs-comment">// 模式2：并行下载多个文件</span>
                Console.WriteLine(<span class="hljs-string">"\n2. 同时下载多个文件..."</span>);
                <span class="hljs-keyword">var</span> fileTasks = <span class="hljs-keyword">new</span> List&lt;Task&lt;<span class="hljs-built_in">string</span>&gt;&gt;
                {
                    DownloadFileAsync(<span class="hljs-string">"季度报告.pdf"</span>),
                    DownloadFileAsync(<span class="hljs-string">"客户数据.xlsx"</span>),
                    DownloadFileAsync(<span class="hljs-string">"会议记录.docx"</span>)
                };
                
                <span class="hljs-comment">// 使用WhenAny - 哪个先完成就先处理哪个</span>
                <span class="hljs-keyword">while</span> (fileTasks.Count &gt; <span class="hljs-number">0</span>)
                {
                    <span class="hljs-keyword">var</span> completedTask = <span class="hljs-keyword">await</span> Task.WhenAny(fileTasks);
                    <span class="hljs-keyword">var</span> fileName = <span class="hljs-keyword">await</span> completedTask;
                    Console.WriteLine(<span class="hljs-string">$"   ✓ 已下载: <span class="hljs-subst">{fileName}</span>"</span>);
                    fileTasks.Remove(completedTask);
                }
                
                <span class="hljs-comment">// 模式3：取消操作</span>
                Console.WriteLine(<span class="hljs-string">"\n3. 开始长时间计算（可取消）..."</span>);
                <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> cts = <span class="hljs-keyword">new</span> System.Threading.CancellationTokenSource();
                
                <span class="hljs-comment">// 设置3秒后自动取消</span>
                cts.CancelAfter(<span class="hljs-number">3000</span>);
                
                <span class="hljs-keyword">try</span>
                {
                    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> LongRunningCalculationAsync(cts.Token);
                    Console.WriteLine(<span class="hljs-string">$"   ✓ 计算完成: <span class="hljs-subst">{result}</span>"</span>);
                }
                <span class="hljs-keyword">catch</span> (TaskCanceledException)
                {
                    Console.WriteLine(<span class="hljs-string">"   🚫 计算被取消了（超过3秒）"</span>);
                }
                
                <span class="hljs-comment">// 模式4：进度报告</span>
                Console.WriteLine(<span class="hljs-string">"\n4. 处理大量数据（带进度报告）..."</span>);
                <span class="hljs-keyword">var</span> progress = <span class="hljs-keyword">new</span> Progress&lt;<span class="hljs-built_in">int</span>&gt;(percent =&gt;
                {
                    Console.Write(<span class="hljs-string">$"\r   处理进度: <span class="hljs-subst">{percent}</span>%  "</span>);
                });
                
                <span class="hljs-keyword">await</span> ProcessLargeDataAsync(progress);
                Console.WriteLine(<span class="hljs-string">"\n   ✓ 数据处理完成"</span>);
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"   ❌ 出现错误: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
        }
        
        <span class="hljs-meta">#<span class="hljs-keyword">region</span> 早晨日常方法</span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">TakeShowerAsync</span>(<span class="hljs-params">MorningPerson person</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">"  🚿 开始洗澡..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 洗澡需要3分钟</span>
            person.IsShowered = <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-title">MakeCoffeeAsync</span>()</span>
        {
            Console.WriteLine(<span class="hljs-string">"  ☕ 开始煮咖啡..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">5000</span>); <span class="hljs-comment">// 煮咖啡需要5分钟</span>
            Console.WriteLine(<span class="hljs-string">"  ✓ 咖啡煮好了"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">GetDressedAsync</span>(<span class="hljs-params">MorningPerson person</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">"  👔 开始穿衣服..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 穿衣需要2分钟</span>
            person.IsDressed = <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">HaveBreakfastAsync</span>(<span class="hljs-params">MorningPerson person</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">"  🍳 开始吃早餐..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">2500</span>); <span class="hljs-comment">// 早餐需要2.5分钟</span>
            person.HasEaten = <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-title">CheckNewsAsync</span>(<span class="hljs-params">MorningPerson person</span>)</span>
        {
            Console.WriteLine(<span class="hljs-string">"  📱 快速浏览新闻..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1500</span>); <span class="hljs-comment">// 看新闻需要1.5分钟</span>
            person.HasNews = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span>
        
        <span class="hljs-meta">#<span class="hljs-keyword">region</span> 工作场景方法</span>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">WaitForEmailReplyAsync</span>()</span>
        {
            <span class="hljs-comment">// 模拟等待邮件回复</span>
            <span class="hljs-keyword">var</span> random = <span class="hljs-keyword">new</span> Random();
            <span class="hljs-keyword">var</span> waitTime = random.Next(<span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>); <span class="hljs-comment">// 1-10秒</span>
            
            <span class="hljs-keyword">await</span> Task.Delay(waitTime);
            
            <span class="hljs-keyword">if</span> (waitTime &lt; <span class="hljs-number">5000</span>) <span class="hljs-comment">// 5秒内回复</span>
                <span class="hljs-keyword">return</span> <span class="hljs-string">"客户回复了邮件"</span>;
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 模拟超时无回复</span>
        }
        
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">DownloadFileAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> fileName</span>)</span>
        {
            <span class="hljs-keyword">var</span> random = <span class="hljs-keyword">new</span> Random();
            <span class="hljs-keyword">var</span> downloadTime = random.Next(<span class="hljs-number">1000</span>, <span class="hljs-number">5000</span>); <span class="hljs-comment">// 1-5秒</span>
            
            <span class="hljs-keyword">await</span> Task.Delay(downloadTime);
            <span class="hljs-keyword">return</span> fileName;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">LongRunningCalculationAsync</span>(<span class="hljs-params">
            System.Threading.CancellationToken cancellationToken</span>)</span>
        {
            <span class="hljs-comment">// 模拟长时间计算</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
            {
                cancellationToken.ThrowIfCancellationRequested();
                <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">100</span>); <span class="hljs-comment">// 每步0.1秒</span>
                
                <span class="hljs-comment">// 模拟计算工作</span>
                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>)
                    Console.Write(<span class="hljs-string">$"\r   计算中... <span class="hljs-subst">{i}</span>%  "</span>);
            }
            
            <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; <span class="hljs-comment">// 答案总是42</span>
        }
        
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ProcessLargeDataAsync</span>(<span class="hljs-params">IProgress&lt;<span class="hljs-built_in">int</span>&gt; progress</span>)</span>
        {
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">100</span>; i += <span class="hljs-number">10</span>)
            {
                <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">200</span>); <span class="hljs-comment">// 模拟处理时间</span>
                progress?.Report(i);
            }
        }
        <span class="hljs-meta">#<span class="hljs-keyword">endregion</span></span>
    }
    
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 扩展方法：为Task添加超时功能</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TaskExtensions</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title">Task</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">WithTimeout</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">
            <span class="hljs-keyword">this</span> Task&lt;T&gt; task, TimeSpan timeout</span>)</span>
        {
            <span class="hljs-keyword">var</span> delayTask = Task.Delay(timeout);
            <span class="hljs-keyword">var</span> completedTask = <span class="hljs-keyword">await</span> Task.WhenAny(task, delayTask);
            
            <span class="hljs-keyword">if</span> (completedTask == delayTask)
            {
                <span class="hljs-comment">// 超时了</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">default</span>;
            }
            
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> task;
        }
    }
}
</code></pre>
<h2 data-id="heading-2">异步编程的关键概念（用早餐例子解释）</h2>
<h3 data-id="heading-3">1. <strong>同步 vs 异步</strong></h3>
<ul>
<li><strong>同步</strong>（低效早餐）：煮咖啡→等咖啡好→烤面包→等面包好→煎鸡蛋→等鸡蛋好</li>
<li><strong>异步</strong>（高效早餐）：开始煮咖啡→同时开始烤面包→同时开始煎鸡蛋→等待所有完成</li>
</ul>
<h3 data-id="heading-4">2. <strong>async/await 模式</strong></h3>
<p>csharp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// async 标记异步方法</span>
<span class="hljs-function">async <span class="hljs-built_in">Task</span> <span class="hljs-title">MakeCoffeeAsync</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// await 等待异步操作完成，但不阻塞线程</span>
    await <span class="hljs-built_in">Task</span>.<span class="hljs-built_in">Delay</span>(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 模拟煮咖啡时间</span>
    <span class="hljs-built_in">Console</span>.<span class="hljs-built_in">WriteLine</span>(<span class="hljs-string">"咖啡好了"</span>);
}
</code></pre>
<h3 data-id="heading-5">3. <strong>Task.WhenAll() - 同时等待多个任务</strong></h3>
<p>csharp</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 就像同时启动咖啡机、烤面包机和煎锅</span>
await Task<span class="hljs-selector-class">.WhenAll</span>(
    MakeCoffeeAsync(),    <span class="hljs-comment">// 3分钟</span>
    <span class="hljs-built_in">MakeToastAsync</span>(),     <span class="hljs-comment">// 2分钟</span>
    <span class="hljs-built_in">FryEggsAsync</span>()        <span class="hljs-comment">// 4分钟</span>
);
<span class="hljs-comment">// 总共只需4分钟，而不是9分钟</span>
</code></pre>
<h3 data-id="heading-6">4. <strong>Task.WhenAny() - 等待第一个完成的任务</strong></h3>
<p>csharp</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 就像看哪个早餐部分先准备好就先吃哪个</span>
<span class="hljs-keyword">var</span> firstReady = <span class="hljs-keyword">await</span> Task.WhenAny(
    coffeeTask,
    toastTask,
    eggsTask
);
</code></pre>
<h3 data-id="heading-7">5. <strong>取消机制 (CancellationToken)</strong></h3>
<p>csharp</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 就像设置煮蛋计时器，时间到了自动关火</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> cts = <span class="hljs-keyword">new</span> CancellationTokenSource(TimeSpan.FromMinutes(<span class="hljs-number">5</span>));
<span class="hljs-keyword">try</span>
{
    <span class="hljs-keyword">await</span> CookEggsAsync(cts.Token);
}
<span class="hljs-keyword">catch</span> (TaskCanceledException)
{
    Console.WriteLine(<span class="hljs-string">"煮蛋超时了！"</span>);
}
</code></pre>
<h2 data-id="heading-8">现实生活中的异步场景</h2>
<ol>
<li>
<p><strong>点外卖应用</strong>：</p>
<ul>
<li>提交订单（异步）</li>
<li>等待餐厅确认（后台等待）</li>
<li>同时你可以继续浏览其他内容（UI不冻结）</li>
<li>收到推送通知（回调）</li>
</ul>
</li>
<li>
<p><strong>文件下载</strong>：</p>
<ul>
<li>开始下载大文件（后台任务）</li>
<li>显示进度条（进度报告）</li>
<li>允许取消下载（取消令牌）</li>
<li>下载完成后通知（任务完成）</li>
</ul>
</li>
<li>
<p><strong>聊天应用</strong>：</p>
<ul>
<li>发送消息（立即返回）</li>
<li>等待对方回复（异步等待）</li>
<li>同时可以发送其他消息（并发）</li>
<li>收到回复时提醒（事件驱动）</li>
</ul>
</li>
</ol>
<h2 data-id="heading-9">核心要点总结</h2>
<ol>
<li><strong>不浪费等待时间</strong>：就像在等咖啡煮好的时候去烤面包</li>
<li><strong>响应性</strong>：UI不会冻结，用户可以继续操作</li>
<li><strong>资源高效</strong>：一个线程可以处理多个任务</li>
<li><strong>可扩展性</strong>：可以轻松处理大量并发操作</li>
</ol>
<p><strong>记住这个比喻</strong>：异步编程就像是一个高效的厨师，同时照看多个炉灶，而不是一个炉灶一个炉灶地顺序操作。这样早餐（程序）就能更快准备好！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cookie与localStorage、sessionStorage总结]]></title>    <link>https://juejin.cn/post/7589386961648877603</link>    <guid>https://juejin.cn/post/7589386961648877603</guid>    <pubDate>2025-12-30T08:11:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589386961648877603" data-draft-id="7589466356778336308" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cookie与localStorage、sessionStorage总结"/> <meta itemprop="keywords" content="前端,JavaScript,HTTPS"/> <meta itemprop="datePublished" content="2025-12-30T08:11:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Crystal328"/> <meta itemprop="url" content="https://juejin.cn/user/2359973194513272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cookie与localStorage、sessionStorage总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2359973194513272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Crystal328
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:11:05.000Z" title="Tue Dec 30 2025 08:11:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. Cookie</h2>
<ul>
<li>Cookie 是<strong>浏览器存储数据</strong>的一种方式</li>
<li><strong>存储在用户本地</strong>，而不是存储在服务器上</li>
<li>可以<strong>随着浏览器每次请求发送到服务器端</strong></li>
</ul>
<h3 data-id="heading-1">1.1 Cookie 的用法</h3>
<ul>
<li>只能一个一个的写入，不能将多个 Cookie 写在一起</li>
<li>写入 Cookie 时是可以加入多个属性的，属性与属性之间是需要 <code>;</code> （分号+空格）来分开</li>
</ul>
<blockquote>
<p>原生的 Cookie 是不能通过特定的名称来读取特定的值，只能一次性全部读取出来。</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建一个Cookie类，添加三个静态方法，将Cookie类作为接口导出</span>
<span class="hljs-comment">// set方法 设置Cookie</span>
<span class="hljs-comment">// get方法，通过Cookie的name获取value值</span>
<span class="hljs-comment">// remove方法，通过cookie的name删除对应的Cookie</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> {
  <span class="hljs-comment">// 设置Cookie</span>
  <span class="hljs-comment">//设置Cookie name,value,max-age,domain path,secure</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">name, value, { maxAge, domain, path, secure } = {}</span>) {
    <span class="hljs-keyword">let</span> cookieText = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(name)}</span> = <span class="hljs-subst">${<span class="hljs-built_in">decodeURIComponent</span>(value)}</span>`</span>;
    <span class="hljs-comment">//设置失效时间</span>
    <span class="hljs-keyword">if</span> (maxAge) {
      cookieText += <span class="hljs-string">`; max-age=<span class="hljs-subst">${maxAge}</span>`</span>
    }
    <span class="hljs-comment">//   设置域</span>
    <span class="hljs-keyword">if</span> (domain) {
      cookieText += <span class="hljs-string">`; domain=<span class="hljs-subst">${domain}</span>`</span>
    }
    <span class="hljs-comment">// 设置路径</span>
    <span class="hljs-keyword">if</span> (path) {
      cookieText += <span class="hljs-string">`; path=<span class="hljs-subst">${path}</span>`</span>
    }
    <span class="hljs-comment">// 安全标志</span>
    <span class="hljs-keyword">if</span> (secure) {
      cookieText += <span class="hljs-string">`; secure=<span class="hljs-subst">${secure}</span>`</span>
    }
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> = cookieText
  }
  <span class="hljs-comment">// 获取Cookie</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-comment">// 得到这个name，也需要编码</span>
    name = <span class="hljs-built_in">encodeURIComponent</span>(name)
    <span class="hljs-comment">// 读取cookie</span>
    <span class="hljs-keyword">let</span> cookies = <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'; '</span>)
    <span class="hljs-comment">// 遍历数组的每一项</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> cookies) {
      <span class="hljs-keyword">const</span> [cookieName, cookieValue] = item.<span class="hljs-title function_">split</span>(<span class="hljs-string">'='</span>)
      <span class="hljs-keyword">if</span> (cookieName === name) {
        <span class="hljs-keyword">return</span> cookieValue
      }
    }

  }
  <span class="hljs-comment">// 删除Cookie</span>
  <span class="hljs-comment">// 设置过期时间即可</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>, { domain, path, <span class="hljs-attr">maxAge</span>: -<span class="hljs-number">1</span> })
  }
}
</code></pre>
<h3 data-id="heading-2">1.2 Cookie 的属性</h3>























































<table><thead><tr><th>属性分类</th><th>属性名称</th><th>详细说明</th></tr></thead><tbody><tr><td>必选核心属性</td><td>名称（name）</td><td>1. 创建 Cookie 时必须填写；2. 与 Domain、Path 共同判定是否为同一个 Cookie（三者均相同则为同一 Cookie）</td></tr><tr><td>必选核心属性</td><td>值（value）</td><td>1. 创建 Cookie 时必须填写，用于存储核心数据；2. 若包含非英文字母，写入时需用 <code>encodeURIComponent()</code> 编码；3. 若写入时已编码，读取时需用 <code>decodeURIComponent()</code> 解码</td></tr><tr><td>失效（到期）属性</td><td>Expires</td><td>1. 用于设置 Cookie 具体过期时间，值为 <code>Date</code> 类型；2. 不设置时，默认会话结束后 Cookie 被浏览器清除；3. 失效后的 Cookie 会被浏览器自动清理</td></tr><tr><td>失效（到期）属性</td><td>Max-Age</td><td>1. 用于设置 Cookie 过期时长，值为数字（单位：秒，当前时间累加该秒数后过期）；2. 值为 0 或负数时，Cookie 会被立即删除；3. 优先级通常高于 Expires</td></tr><tr><td>访问范围限定</td><td>Domain（域）</td><td>1. 限定不同域下的 Cookie 访问范围；2. JS 仅能写入 / 读取当前域或父域的 Cookie，无法操作其他无关域的 Cookie</td></tr><tr><td>访问范围限定</td><td>Path（路径）</td><td>1. 限定同域不同路径下的 Cookie 访问范围；2. JS 仅能写入 / 读取当前路径或上级路径的 Cookie，无法操作其他无关路径的 Cookie</td></tr><tr><td>安全相关属性</td><td>HttpOnly</td><td>1. 仅支持后端设置，前端无法通过 JS（<code>document.cookie</code>）获取或修改；2. 核心作用：防止 XSS 攻击窃取 Cookie 数据</td></tr><tr><td>安全相关属性</td><td>Secure</td><td>1. 限定仅在 <code>HTTPS</code> 协议下，Cookie 才会随请求发送至服务端；2. <code>HTTP</code> 协议下无法传递带有该属性的 Cookie</td></tr><tr><td>生效条件补充</td><td>-</td><td>Cookie 需同时满足以下条件才会随请求发送到服务端：1. Domain 匹配；2. Path 匹配；3. Secure 条件匹配（HTTPS 环境）；4. Cookie 未过期</td></tr></tbody></table>
<h3 data-id="heading-3">1.4 注意事项</h3>
<ul>
<li>前后端都可以写入和读取 Cookie</li>
<li>每个域名下的 Cookie 数量有限</li>
<li>每个 Cookie 的存储容量很小，最多只有 4KB 左右，每个浏览器不一样</li>
</ul>
<h2 data-id="heading-4">2. localStorage</h2>
<ul>
<li>localStorage 是<strong>浏览器存储数据</strong>的一种方式</li>
<li><strong>存储在用户本地，不会发送到服务器端</strong></li>
<li>单个域名下的总大小有限制（一般最大 5MB 左右）每个浏览器不一样</li>
</ul>
<h3 data-id="heading-5">2.1 localStorage 的基本用法</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 设置（添加）localStorage 数据项</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">"username"</span>, <span class="hljs-string">"icoding"</span>);
<span class="hljs-comment">// 获取 localStorage 数据项</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">"username"</span>);
<span class="hljs-comment">// 移除 localStorage 数据项</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">"username"</span>);
<span class="hljs-comment">// 移除所有的 localStorage 数据项</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">clear</span>();
<span class="hljs-comment">// length localStorage 中有存储多少数据</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-property">length</span>;
</code></pre>
<h3 data-id="heading-6">2.2 注意事项</h3>
<ul>
<li>localStorage 存储的数据，除非手动清除（如 通过 JS 删除 或 清除浏览器缓存）否则，数据永远不会过期的。它是<strong>持久化的本地存储</strong>。</li>
<li>sessionStorage 存储的数据，是当前会话结束（如 关闭浏览器）的时候，sessionStorage 中的数据会被清空</li>
<li><strong>sessionStorage 的使用方法 与 localStorage 一模一样</strong></li>
<li>localStorage 存储的键和值<strong>只能是字符串类型</strong></li>
<li><strong>不同的域名不能共用 localStorage</strong></li>
</ul>
<h3 data-id="heading-7">2.3 封装</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 导出封装后的 localStorage 操作对象</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// set方法：根据key、value添加/修改数据（自动序列化对象类型）</span>
  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value !== <span class="hljs-literal">null</span>) { 
      value = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value);
    }
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, value);
  },

  <span class="hljs-comment">// get方法：根据key获取值（自动尝试反序列化，失败则返回原始值）</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">const</span> value = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key);
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 先判断key不存在的情况，直接返回null</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 解析成功后，返回解析后的结果</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(value);
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-comment">// 解析失败（原始值为普通字符串），返回原始value</span>
      <span class="hljs-keyword">return</span> value;
    }
  },

  <span class="hljs-comment">// remove方法：根据key移除指定项</span>
  <span class="hljs-title function_">remove</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key);
  },

  <span class="hljs-comment">// clear方法：清空当前域名下所有localStorage数据</span>
  <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">clear</span>();
  }
};
</code></pre>
<h2 data-id="heading-8">Cookie、localStorage、sessionStorage 的对比（面试题）</h2>









































<table><thead><tr><th>对比项</th><th>Cookie</th><th>LocalStorage</th><th>sessionStorage</th></tr></thead><tbody><tr><td>存储大小</td><td>4K</td><td>5M</td><td>5M</td></tr><tr><td>有效期</td><td>手动设置</td><td>无</td><td>浏览器窗口关闭</td></tr><tr><td>存储位置</td><td>浏览器</td><td>浏览器</td><td>浏览器</td></tr><tr><td>与请求一起发送</td><td>是</td><td>否</td><td>否</td></tr><tr><td>访问限止</td><td>子域可以访问自己和父域中的 Cookie</td><td>同域下都可以访问</td><td>只限当前窗口</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[真实案例复盘：从“三套烟囱”到 All in ES，这家企业如何砍掉 40%运维成本？]]></title>    <link>https://juejin.cn/post/7589445154534506548</link>    <guid>https://juejin.cn/post/7589445154534506548</guid>    <pubDate>2025-12-30T09:58:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589445154534506548" data-draft-id="7589477775209611316" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="真实案例复盘：从“三套烟囱”到 All in ES，这家企业如何砍掉 40%运维成本？"/> <meta itemprop="keywords" content="人工智能,Elasticsearch,搜索引擎"/> <meta itemprop="datePublished" content="2025-12-30T09:58:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            真实案例复盘：从“三套烟囱”到 All in ES，这家企业如何砍掉 40%运维成本？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:58:53.000Z" title="Tue Dec 30 2025 09:58:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">文 / 阿里云AI搜索产研团队</h4>
<p>在做搜索技术架构咨询时，我们经常听到一句话：“我也知道业务系统复杂，但不知道怎么简化架构部署?”</p>
<p>今天，我们想聊聊 “某知名互联网泛娱乐视觉平台 A”（以下简称 A 公司）的搜索架构演进故事。他们的云上迁移经历，是无数正在为“技术栈碎片化”与"AI搜索架构改造"头疼的企业的真实写照。</p>
<h2 data-id="heading-1">第一阶段：为了业务的“快”，他们建了三根烟囱</h2>
<p>一年前，A 公司的技术架构负责人老李面临着极大的压力。随着原先的检索业务引入全量日志审计的运维管理，再到接入大模型 RAG（检索增强生成），他们的架构变成了典型的“拼凑型”：</p>
<p><strong>通用搜索业务</strong>：素材中台、视频/表情包关键词检索，涉及大规模用户、话题及活动信息。跑在开源ES集群上。</p>
<p><strong>日志检索业务</strong>：为了合规存储海量 Access Log，采购了独立的日志服务。App行为日志、服务端系统日志，用于性能监控与运营决策。为了省钱又把部分老日志导到了 对象存储里，查询极其不便。</p>
<p><strong>向量检索业务</strong>：基于视觉特征的相似图片检索、基于用户画像的智能推荐（如相似滤镜、模板推荐）。为了做 RAG 和猜你喜欢，又不得不单独搭建了一套 开源Milvus。</p>
<h4 data-id="heading-2">老李的痛点非常具体：</h4>
<p><strong>“半夜烧钱”</strong>：A 公司的流量有明显的潮汐效应。每天晚上 8 点到 12 点是日志写入洪峰，但凌晨 2 点到早上 8 点流量极低。为了抗住那 4 小时的峰值，他们必须按最高水位购买日志资源。结果就是：每天有 16 个小时，昂贵的计算资源在空转。突发流量导致的扩容压力与存储成本不成正比。</p>
<p><strong>“胶水代码”</strong>：在做 RAG 时，开发同学需要在代码里先查 Milvus 拿 ID，再回查 ES 拿文本。不仅代码难维护，一旦出现数据不一致（比如文章删了，向量还在），用户就会点进 404 页面，投诉率飙升。</p>
<p><strong>“三根烟囱”</strong>，多种搜索能力隔离分开，开发与运维成本极高，难以支持复杂的跨模态检索。</p>
<p><strong>“蜗行牛步”</strong>：全量同步耗时长，大数据量下的实时更新与索引重建效率低下。</p>
<h2 data-id="heading-3">第二阶段：做减法，拥抱 All in ES</h2>
<p>在与阿里云AI搜索专家团队深聊后，A 公司决定进行一次彻底技术“断舍离”，将AI搜索所需的多种技术栈统一收敛到阿里云 Elasticsearch 上。</p>
<ol>
<li>
<p><strong>日志场景：把“固定资产”变成“电费单”</strong> A 公司首先改造的是最烧钱的日志系统。他们没有继续购买庞大的自建ES节点，而是接入了阿里云 ES 的 高性能写入托管服务Indexing Service 和 混合存储服务OpenStore。</p>
<p>变化前：为了抗峰值，常驻 20 台 8C32G 的机器。凌晨流量跌到谷底时，这 20 台机器依然在计费。</p>
<p>变化后：彻底 Serverless 化。晚高峰流量来了，云端自动扩容扛压；凌晨流量没了，计费几乎归零。存储方面，数据自动沉降到 OpenStore（对象存储介质），成本直接对其归档存储。</p>
<p>老李的反馈：“以前是养车，不管开不开都得付折旧和保险；现在是打车，跑多少付多少。单这一项，日志账单降了 60%。”</p>
</li>
<li>
<p><strong>向量场景：删掉胶水代码，回归原生</strong> 解决了日志，A 公司开始动刀向量搜索。他们利用阿里云 ES 内核级强化的混合向量引擎，替代了独立的向量库。</p>
</li>
</ol>
<p>变化前：应用 -&gt; 查向量库 -&gt; 拿 ID -&gt; 查 ES -&gt; 应用层排序。延迟 200ms+。</p>
<p>变化后：应用 -&gt; 阿里云 ES (混合检索 API) -&gt; 返回结果。</p>
<p>由于<strong>阿里云 ES 全自研云原生引擎FalconSeek</strong>在内核层引入了 SIMD 指令集加速和 HNSW 算法优化，在千万级数据量下，性能完全满足 A 公司的需求。更重要的是，他们终于可以用一个 DSL 语句同时搞定“语义搜索 + 关键词匹配 + 边时间过滤边检索”。</p>
<p>老李的反馈：“架构图上少了一个框，代码里少了几百行胶水逻辑，开发同学终于不用在两个库之间修数据一致性的 Bug 了。”</p>
<h2 data-id="heading-4">为什么选择 All in ES？因为“统一”本身就是生产力</h2>
<p>A 公司的故事并非孤例。当他们将日志、搜索、向量收敛到阿里云 Elasticsearch 这一套技术栈上时，发生的不仅仅是成本的降低：</p>
<h4 data-id="heading-5">系统架构优化：</h4>
<ol>
<li>
<p>极致的计算资源弹性（Serverless）： 对于日志这种具有明显“峰谷效应”的数据，传统的预置机器模式注定是浪费。阿里云 ES 的 Indexing Service 让算力像水一样流动，“用时付费，不用免费”，这才是云原生该有的样子。</p>
</li>
<li>
<p>运维标准的统一： 现在，A 公司的运维团队只需要精通 ES 这一门手艺。无论是查业务慢查询，还是做日志分析，亦或是管理向量索引，都在同一个控制台，遵循同一套安全标准（RBAC/VPC），看同一套监控大盘。</p>
</li>
<li>
<p>数据价值的闭环： 日志数据进来，清洗后直接可以用于业务分析；业务数据进来，直接生成向量用于推荐。数据在同一个生态内流转，没有中间商赚差价。</p>
</li>
</ol>
<h4 data-id="heading-6">日志检索增强：</h4>
<p>在A公司中广泛使用的日志检索，采用阿里云Elasticsearch企业版以下方面进行全面优化。</p>
<p><strong>极致写入优化 - Indexing service读写分离，综合写入成本降低60%</strong></p>
<ul>
<li>
<p>高性能：专业级写入优化，多自研特性加持(物理复制,定向路由等)</p>
</li>
<li>
<p>高稳定：多集群冗余备份，秒级切换</p>
</li>
<li>
<p>低成本：写入资源，存储大小及介质等优化</p>
</li>
<li>
<p>弹性扩展：写入资源由云端后台调配和管理，以应对流量波动</p>
</li>
<li>
<p>免运维：无须关注写入资源和写入压力, 极大降低集群运维成本</p>
</li>
</ul>
<p><strong>存算分离优化 - OpenStore混合存储架构，存储成本降低60%以上</strong></p>
<ul>
<li>
<p>采用存算分离架构，降低数据冗余存储</p>
</li>
<li>
<p>采用对象存储降低存储成本</p>
</li>
<li>
<p>多级缓存及并发查询保证查询性能</p>
</li>
</ul>
<h4 data-id="heading-7">专业级查询优化:</h4>
<ul>
<li>针对日志场景的典型查询case进行深度优化，提高用户查询性能， 如bkd查询优化等</li>
<li>贴近用户业务，针对用户使用过程中的查询问题进行定制优化，如在支持A客户中遇到的cardinality开源缺陷导致的查询性能问题等。</li>
</ul>
<h4 data-id="heading-8">向量索引调优：</h4>
<p>向量索引在AI搜索场景中越来越重要，A公司为提高性能，降低整体成本，充分采用了阿里云ES的若干优化手段。成功的将成本降低一倍以上，查询性能提升数倍以上：</p>
<ul>
<li>
<p><strong>自研FalconSeek云原生索引应用</strong>：阿里云最新发布全自研云原生C++内核引擎, 对文本检索与向量检索性能提升，向量性能进一步提升40%以上。 使用FalconSeek的<strong>Filter-Knn</strong>特性，性能提升最多4倍。</p>
</li>
<li>
<p><strong>执行Force Merge</strong>：存量数据定期执行Force Merge，性能提升5倍以上。</p>
</li>
<li>
<p><strong>原文排除向量字段</strong>：在写入的source中排除向量字段，存储空间节约1倍以上。</p>
</li>
<li>
<p><strong>混合搜索：</strong> 采用<strong>RRF（Reciprocal Rank Fusion）</strong> 算法或自定义线性权重，将向量相似度得分与BM25文本得分进行加权融合，以兼顾检索的精确性与泛化性。</p>
</li>
</ul>
<h2 data-id="heading-9">成本效能对比与选型建议</h2>
<p>根据A公司迁移阿里云的测算分析，企业在构建多场景AI搜索时，可重点关注以下成本指标：</p>






























<table><thead><tr><th><strong>维度</strong></th><th><strong>建议方案</strong></th><th><strong>价值产出</strong></th></tr></thead><tbody><tr><td><strong>计算资源</strong></td><td>自研FalconSeek引擎应用<br/>选用计算型ecs.g8i或r8i系列</td><td>提升向量运算（HNSW等算法）的吞吐量</td></tr><tr><td><strong>存储资源</strong></td><td>OpenStore存算分离架构</td><td>解决日志/冷数据存储高成本痛点</td></tr><tr><td><strong>写入性能</strong></td><td>Indexing Service高写入服务，<br/>开启物理复制（Physical Replication）</td><td>降低高并发写入时的CPU占用</td></tr><tr><td><strong>运维效率</strong></td><td>统一公用集群与素材中台集群</td><td>减少20%以上的碎片化人力投入</td></tr></tbody></table>
<h2 data-id="heading-10">总结：One Stack一站式搜索, 简单架构是最好的架构</h2>
<p>回看 A 公司的搜索技术演进之路，其实就是一条从“做加法”到“做减法”的路。</p>
<p>对于架构师：你的系统拓扑图变清晰了，数据链路变短了，系统稳定性变强了。</p>
<p>对于运维：只要精通 ES 一门产品技术手艺，就能搞定全公司的核心数据检索全链路。</p>
<p>对于老板：TCO（总拥有成本）显著下降，同时获得了企业级的安全合规保障。</p>
<p>不要让复杂的工具链拖累你的业务创新的速度。</p>
<p>从今天开始，参考 A 公司的路径，重新审视你的架构。尝试阿里云 Elasticsearch企业版，体验“All in ES”带来的极简与高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mini-react最小实现手把手带你看清hooks本质]]></title>    <link>https://juejin.cn/post/7589212818807390271</link>    <guid>https://juejin.cn/post/7589212818807390271</guid>    <pubDate>2025-12-30T08:25:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589212818807390271" data-draft-id="7589475923696566291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mini-react最小实现手把手带你看清hooks本质"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T08:25:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="echo_e"/> <meta itemprop="url" content="https://juejin.cn/user/1267099625328903"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mini-react最小实现手把手带你看清hooks本质
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1267099625328903/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    echo_e
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:25:07.000Z" title="Tue Dec 30 2025 08:25:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Mini React Runtime 实现解析（Fiber + Hooks）</h2>
<p>在这篇博客中，我将分享一个最小化 React Runtime 的实现，包括 Fiber 架构和 Hooks 的原理。本文适合想深入理解 React 内部工作机制的前端开发者。</p>
<hr/>
<h3 data-id="heading-1">引言</h3>
<p>React 的核心是 <strong>虚拟 DOM + Fiber + Hooks</strong>。</p>
<ul>
<li><strong>Fiber</strong>：运行时的组件实例，负责管理状态、hooks 和调度。</li>
<li><strong>Hooks</strong>：函数组件的状态管理机制，通过调用顺序保证状态稳定性。</li>
<li><strong>虚拟 DOM</strong>：描述 UI 的对象，不直接渲染，Fiber 根据它构建真实 DOM。</li>
</ul>
<p>本文实现的是一个最小可运行版本，帮助理解原理。</p>
<hr/>
<h3 data-id="heading-2">整体架构</h3>
<h4 data-id="heading-3">架构图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[React Element] --&gt;|createFiber| B[Fiber 节点]
    B --&gt;|child/sibling 链表| C[Fiber 树]
    C --&gt;|performUnitOfWork| D[Function Component 执行]
    D --&gt;|调用 Hooks| E[Hooks 状态存储在 Fiber.hooks]
    B --&gt;|createDom| F[真实 DOM 节点]
    C --&gt;|commitEffects| G[useEffect 执行]
    H[更新操作] --&gt;|setState/useMemo 等| B
    E --&gt;|读取/修改| D
    F --&gt;|挂载到父 DOM| DOM[页面 DOM]

    style A fill:#f9f,stroke:#333,stroke-width:1px
    style B fill:#bbf,stroke:#333,stroke-width:1px
    style C fill:#bfb,stroke:#333,stroke-width:1px
    style D fill:#ffb,stroke:#333,stroke-width:1px
    style E fill:#fbf,stroke:#333,stroke-width:1px
    style F fill:#fbb,stroke:#333,stroke-width:1px
    style G fill:#bff,stroke:#333,stroke-width:1px
    style H fill:#eee,stroke:#333,stroke-width:1px
</code></pre>
<h4 data-id="heading-4">执行顺序</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    %% 初次渲染
    A["render(TodoApp)"] --&gt; B["创建根 Fiber"]
    B --&gt; C["performUnitOfWork(根 Fiber)"]
    C --&gt; D{"Fiber.type 是否为函数组件?"}
    D -- 是 --&gt; E["设置 wipFiber=当前 Fiber, hookIndex=0, hooks=[]"]
    E --&gt; F["执行 TodoApp(props)"]

    %% useState
    F --&gt; G["调用 useState(0)"]
    G --&gt; H["检查 oldHook 是否存在"]
    H --&gt; I{"首次渲染? (oldHook 为空)"}
    I -- 是 --&gt; J["创建新 Hook {state=0, queue=[]}"]
    I -- 否 --&gt; K["应用队列更新计算最新 state"]
    J --&gt; L["hookIndex++ 返回 state, setState"]
    K --&gt; L

    %% useMemo
    L --&gt; M["调用 useMemo(() =&gt; count*2, [count])"]
    M --&gt; N["检查 oldHook 是否存在并比较 deps"]
    N --&gt; O{"依赖是否变化?"}
    O -- 是 --&gt; P["执行 factory() 计算新 value"]
    O -- 否 --&gt; Q["复用上一次 value"]
    P --&gt; R["hookIndex++ 返回 memo value"]
    Q --&gt; R

    %% useEffect
    R --&gt; S["调用 useEffect(..., [count])"]
    S --&gt; T["检查 oldHook 是否存在并比较 deps"]
    T --&gt; U{"依赖是否变化?"}
    U -- 是 --&gt; V["将 effect 放入 pendingEffects 队列"]
    U -- 否 --&gt; W["不收集 effect"]
    V --&gt; X["hookIndex++"]
    W --&gt; X

    %% 返回 JSX
    X --&gt; Y["返回子 Element: div &gt; h3/p/button"]
    Y --&gt; Z["reconcileChildren 创建子 Fiber"]
    Z --&gt; AA{"fiber.child 是否存在?"}
    AA -- 是 --&gt; C
    AA -- 否 --&gt; AB["处理 sibling 或回到 parent"]
    AB --&gt; AC["commit 阶段: 挂载 DOM"]
    AC --&gt; AD["执行 pendingEffects 中的 useEffect"]

    %% 用户点击 button
    AD --&gt; AE["用户点击 button 调用 setCount(c =&gt; c+1)"]
    AE --&gt; AF["入队更新 Hook.queue"]
    AF --&gt; AG["rerender() 重置 hookIndex=0, 执行 TodoApp"]
    AG --&gt; G

    style A fill:#f9f,stroke:#333
    style B fill:#bbf,stroke:#333
    style C fill:#bfb,stroke:#333
    style D fill:#ffb,stroke:#333
    style E fill:#fbf,stroke:#333
    style F fill:#fbb,stroke:#333
    style G fill:#bff,stroke:#333
    style H fill:#ffe,stroke:#333
    style I fill:#eef,stroke:#333
    style J fill:#ddd,stroke:#333
    style K fill:#ccd,stroke:#333
    style L fill:#ffd,stroke:#333
    style M fill:#cff,stroke:#333
    style N fill:#ecf,stroke:#333
    style O fill:#fcf,stroke:#333
    style P fill:#ffc,stroke:#333
    style Q fill:#eef,stroke:#333
    style R fill:#ddf,stroke:#333
    style S fill:#fdd,stroke:#333
    style T fill:#def,stroke:#333
    style U fill:#ffd,stroke:#333
    style V fill:#cfc,stroke:#333
    style W fill:#eee,stroke:#333
    style X fill:#fdf,stroke:#333
    style Y fill:#f9f,stroke:#333
    style Z fill:#bbf,stroke:#333
    style AA fill:#bfb,stroke:#333
    style AB fill:#ffb,stroke:#333
    style AC fill:#fbf,stroke:#333
    style AD fill:#fbb,stroke:#333
    style AE fill:#bff,stroke:#333
    style AF fill:#ffe,stroke:#333
    style AG fill:#def,stroke:#333
</code></pre>
<h3 data-id="heading-5">Element 层（虚拟 DOM）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">type, props, ...children</span>) {
    <span class="hljs-keyword">return</span> {
        type,
        <span class="hljs-attr">props</span>: {
            ...props,
            <span class="hljs-attr">children</span>: children.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span>
                <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">"object"</span> ? child : <span class="hljs-title function_">createTextElement</span>(child)
            ),
        },
    };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextElement</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"TEXT"</span>,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">nodeValue</span>: text,
            <span class="hljs-attr">children</span>: [],
        },
    };
}
</code></pre>
<ul>
<li><code>createElement</code>：生成虚拟 DOM 对象</li>
<li><code>createTextElement</code>：将字符串或数字包装成文本节点</li>
<li>所有子节点统一成对象形式，方便 Fiber 遍历</li>
</ul>
<hr/>
<h3 data-id="heading-6">Fiber 层（运行时实例）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createFiber</span>(<span class="hljs-params">element, parent</span>) {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: element.<span class="hljs-property">type</span>,
        <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
        parent,
        <span class="hljs-attr">child</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">sibling</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">alternate</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">hooks</span>: <span class="hljs-literal">null</span>,
    };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDom</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">type</span> === <span class="hljs-string">"TEXT"</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(fiber.<span class="hljs-property">props</span>.<span class="hljs-property">nodeValue</span> || <span class="hljs-string">""</span>);
    <span class="hljs-keyword">const</span> dom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(fiber.<span class="hljs-property">type</span>);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(fiber.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> key !== <span class="hljs-string">"children"</span>)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = fiber.<span class="hljs-property">props</span>[name]);
    <span class="hljs-keyword">return</span> dom;
}
</code></pre>
<ul>
<li>每个 Fiber 对应一个组件或 DOM 节点</li>
<li><code>alternate</code> 用于保存上一次渲染的 Fiber，实现状态复用</li>
<li><code>hooks</code> 保存当前组件的所有 hooks</li>
</ul>
<hr/>
<h3 data-id="heading-7">Render 阶段（Fiber 构建）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fiber.<span class="hljs-property">type</span> === <span class="hljs-string">"function"</span>) {
        wipFiber = fiber;
        hookIndex = <span class="hljs-number">0</span>;
        wipFiber.<span class="hljs-property">hooks</span> = [];
        <span class="hljs-keyword">const</span> children = [fiber.<span class="hljs-title function_">type</span>(fiber.<span class="hljs-property">props</span>)];
        <span class="hljs-title function_">reconcileChildren</span>(fiber, children);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDom</span>(fiber);
        <span class="hljs-keyword">const</span> parentDom = <span class="hljs-title function_">getParentDom</span>(fiber);
        <span class="hljs-keyword">if</span> (parentDom) parentDom.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>);
        <span class="hljs-title function_">reconcileChildren</span>(fiber, fiber.<span class="hljs-property">props</span>.<span class="hljs-property">children</span> || []);
    }

    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">let</span> next = fiber;
    <span class="hljs-keyword">while</span> (next) {
        <span class="hljs-keyword">if</span> (next.<span class="hljs-property">sibling</span>) <span class="hljs-keyword">return</span> next.<span class="hljs-property">sibling</span>;
        next = next.<span class="hljs-property">parent</span>;
    }
}
</code></pre>
<ul>
<li>对 Function Component 执行组件函数并收集 hooks</li>
<li>对 DOM 节点创建真实 DOM 并挂载</li>
<li>深度优先遍历 Fiber 树</li>
</ul>
<hr/>
<h3 data-id="heading-8">Hooks 实现</h3>
<h4 data-id="heading-9">useState</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) {
    <span class="hljs-keyword">const</span> oldHook = wipFiber.<span class="hljs-property">alternate</span>?.<span class="hljs-property">hooks</span>?.[hookIndex];
    <span class="hljs-keyword">const</span> hook = { <span class="hljs-attr">state</span>: oldHook ? oldHook.<span class="hljs-property">state</span> : initialState, <span class="hljs-attr">queue</span>: [] };
    (oldHook?.<span class="hljs-property">queue</span> || []).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
        hook.<span class="hljs-property">state</span> = <span class="hljs-keyword">typeof</span> action === <span class="hljs-string">"function"</span> ? <span class="hljs-title function_">action</span>(hook.<span class="hljs-property">state</span>) : action;
    });
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">setState</span> = action =&gt; { hook.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>(action); <span class="hljs-title function_">rerender</span>(); };
    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;
    <span class="hljs-keyword">return</span> [hook.<span class="hljs-property">state</span>, setState];
}
</code></pre>
<ul>
<li>state 保存在 Fiber.hooks 中</li>
<li>通过 hookIndex 保证顺序</li>
<li>setState 入队并触发 rerender</li>
</ul>
<h4 data-id="heading-10">useEffect</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useEffect</span>(<span class="hljs-params">effect, deps</span>) {
    <span class="hljs-keyword">const</span> oldHook = wipFiber.<span class="hljs-property">alternate</span>?.<span class="hljs-property">hooks</span>?.[hookIndex];
    <span class="hljs-keyword">let</span> hasChanged = !oldHook || !deps || deps.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">d,i</span>) =&gt;</span> !<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(d, oldHook.<span class="hljs-property">deps</span>[i]));
    <span class="hljs-keyword">const</span> hook = { effect, deps, <span class="hljs-attr">cleanup</span>: oldHook?.<span class="hljs-property">cleanup</span> };
    <span class="hljs-keyword">if</span> (hasChanged) pendingEffects.<span class="hljs-title function_">push</span>(hook);
    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;
}
</code></pre>
<ul>
<li>render 阶段收集 effect</li>
<li>commit 阶段统一执行</li>
<li>deps 不变时跳过</li>
</ul>
<h4 data-id="heading-11">useRef</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useRef</span>(<span class="hljs-params">initialValue</span>) {
    <span class="hljs-keyword">const</span> oldHook = wipFiber.<span class="hljs-property">alternate</span>?.<span class="hljs-property">hooks</span>?.[hookIndex];
    <span class="hljs-keyword">const</span> hook = { <span class="hljs-attr">current</span>: oldHook ? oldHook.<span class="hljs-property">current</span> : initialValue };
    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;
    <span class="hljs-keyword">return</span> hook;
}
</code></pre>
<ul>
<li>返回稳定引用</li>
<li>修改 current 不触发 rerender</li>
</ul>
<h4 data-id="heading-12">useMemo</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useMemo</span>(<span class="hljs-params">factory, deps</span>) {
    <span class="hljs-keyword">const</span> oldHook = wipFiber.<span class="hljs-property">alternate</span>?.<span class="hljs-property">hooks</span>?.[hookIndex];
    <span class="hljs-keyword">const</span> hasChanged = !oldHook || !deps || deps.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">d,i</span>) =&gt;</span> !<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(d, oldHook.<span class="hljs-property">deps</span>[i]));
    <span class="hljs-keyword">const</span> hook = { <span class="hljs-attr">value</span>: hasChanged ? <span class="hljs-title function_">factory</span>() : oldHook.<span class="hljs-property">value</span>, deps };
    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;
    <span class="hljs-keyword">return</span> hook.<span class="hljs-property">value</span>;
}
</code></pre>
<ul>
<li>缓存计算结果</li>
<li>deps 不变时返回上次结果</li>
</ul>
<h4 data-id="heading-13">useContext</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">const</span> hook = { <span class="hljs-attr">value</span>: context.<span class="hljs-property">_currentValue</span> };
    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;
    <span class="hljs-keyword">return</span> hook.<span class="hljs-property">value</span>;
}
</code></pre>
<ul>
<li>读取 context._currentValue</li>
<li>这是一个极简实现，不支持嵌套 Provider</li>
</ul>
<hr/>
<h3 data-id="heading-14">Demo 示例</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> double = <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> count * <span class="hljs-number">2</span>, [count]);
    <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count), [count]);

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(
        <span class="hljs-string">"div"</span>,
        <span class="hljs-literal">null</span>,
        <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"h3"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"Count: "</span>, count),
        <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"p"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"Double: "</span>, double),
        <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(
            <span class="hljs-string">"button"</span>,
            { <span class="hljs-attr">onclick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>) },
            <span class="hljs-string">"Add"</span>
        )
    );
}

<span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">render</span>(<span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">TodoApp</span>, <span class="hljs-literal">null</span>), <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>));
</code></pre>
<ul>
<li>演示了 useState、useEffect、useMemo</li>
<li>每次点击按钮都会触发 rerender</li>
</ul>
<hr/>
<h3 data-id="heading-15">总结</h3>
<p>通过这个 Mini React Runtime，我们可以理解：</p>
<ol>
<li><strong>Fiber 树的作用</strong>：管理组件实例和 hooks</li>
<li><strong>Hooks 的原理</strong>：依赖调用顺序和 Fiber 存储</li>
<li><strong>render 阶段 vs commit 阶段</strong>：render 只是构建 Fiber，不操作 DOM；commit 才真正更新 DOM</li>
<li><strong>最小化实现足够教学</strong>，可以逐步扩展支持 diff 算法、异步渲染、useLayoutEffect 等</li>
</ol>
<blockquote>
<p>这是理解 React Hooks 和 Fiber 内部机制的绝佳入门案例。</p>
</blockquote>
<p>可以仔细阅读下面源码注释写的非常清楚</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**************************************************************
 * Mini React Runtime (Fiber + Hooks)
 *
 * 这是一个教学用途的「最小可运行 React 内核」
 * 目标：帮助你**完整理解 React Fiber + Hooks 的运行机制**
 *
 * 特点：
 * - 同步 render（无并发、无时间切片）
 * - Fiber 树结构
 * - Hooks 基于「调用顺序」实现
 * - 支持 useState / useEffect / useRef / useMemo / useContext
 **************************************************************/</span>

<span class="hljs-comment">/**************************************************************
 * 全局运行时状态（非常关键）
 **************************************************************/</span>

<span class="hljs-keyword">let</span> wipFiber = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 当前正在 render 的 Function Component 对应的 Fiber</span>
<span class="hljs-comment">// Hooks 的所有读写都依赖它</span>

<span class="hljs-keyword">let</span> hookIndex = <span class="hljs-number">0</span>;
<span class="hljs-comment">// 当前组件 render 过程中，第几个 hook</span>
<span class="hljs-comment">// useState/useEffect/... 全部依赖「调用顺序」</span>

<span class="hljs-keyword">let</span> currentRoot = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 已经 commit 的根 Fiber</span>
<span class="hljs-comment">// rerender 时作为 alternate（旧 Fiber 树）</span>
<span class="hljs-comment">// 用来保存已经提交的Fiber树，下一次render时候把新的rootFiber的alternate指向它</span>

<span class="hljs-keyword">let</span> pendingEffects = [];
<span class="hljs-comment">// render 阶段收集的所有 useEffect</span>
<span class="hljs-comment">// 会在 commit 阶段统一执行</span>


<span class="hljs-comment">/**************************************************************
 * Element 层（虚拟 DOM）
 **************************************************************/</span>

<span class="hljs-comment">/**
 * createElement
 * 用于创建 React Element（虚拟节点）
 *
 * 等价于：
 *   React.createElement(type, props, ...children)
 *
 * React Element 是一个「纯描述对象」
 * 并不会直接参与渲染
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">type, props, ...children</span>) {
    <span class="hljs-keyword">return</span> {
        type, <span class="hljs-comment">// string（div）或 function（组件）</span>
        <span class="hljs-attr">props</span>: {
            ...props,
            <span class="hljs-comment">// children 必须统一成 object</span>
            <span class="hljs-attr">children</span>: children.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span>
                <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">"object"</span>
                    ? child
                    : <span class="hljs-title function_">createTextElement</span>(child)
            ),
        },
    };
}

<span class="hljs-comment">/**
 * createTextElement
 * 将字符串 / 数字包装成 TEXT 类型的 Element
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextElement</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"TEXT"</span>,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">nodeValue</span>: text,
            <span class="hljs-attr">children</span>: [],
        },
    };
}


<span class="hljs-comment">/**************************************************************
 * Fiber 层（运行时实例）
 **************************************************************/</span>

<span class="hljs-comment">/**
 * createFiber
 *
 * Fiber 是 React 运行时的核心数据结构
 * 每一个 Fiber ≈ 一个组件/DOM 实例
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createFiber</span>(<span class="hljs-params">element, parent</span>) {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: element.<span class="hljs-property">type</span>,     <span class="hljs-comment">// 组件函数 or DOM 标签</span>
        <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,   <span class="hljs-comment">// props</span>
        parent,                 <span class="hljs-comment">// 父 Fiber</span>
        <span class="hljs-attr">child</span>: <span class="hljs-literal">null</span>,            <span class="hljs-comment">// 第一个子 Fiber</span>
        <span class="hljs-attr">sibling</span>: <span class="hljs-literal">null</span>,          <span class="hljs-comment">// 下一个兄弟 Fiber</span>
        <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,              <span class="hljs-comment">// 对应的真实 DOM</span>
        <span class="hljs-attr">alternate</span>: <span class="hljs-literal">null</span>,        <span class="hljs-comment">// 上一次 render 的 Fiber</span>
        <span class="hljs-attr">hooks</span>: <span class="hljs-literal">null</span>,            <span class="hljs-comment">// hooks 数组（Function Component 专属）</span>
    };
}

<span class="hljs-comment">/**
 * createDom
 * 根据 Fiber 创建真实 DOM 节点
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDom</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-comment">// 文本节点</span>
    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">type</span> === <span class="hljs-string">"TEXT"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(fiber.<span class="hljs-property">props</span>.<span class="hljs-property">nodeValue</span> ?? <span class="hljs-string">""</span>);
    }

    <span class="hljs-comment">// 普通 DOM 节点</span>
    <span class="hljs-keyword">const</span> dom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(fiber.<span class="hljs-property">type</span>);

    <span class="hljs-comment">// 将 props 映射到 DOM 上（事件、属性）</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(fiber.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> key !== <span class="hljs-string">"children"</span>)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
            dom[name] = fiber.<span class="hljs-property">props</span>[name];
        });

    <span class="hljs-keyword">return</span> dom;
}


<span class="hljs-comment">/**************************************************************
 * Fiber 构建（reconcile）
 **************************************************************/</span>

<span class="hljs-comment">/**
 * reconcileChildren
 *
 * 根据 element 列表构建 Fiber.child / Fiber.sibling 链表
 *
 * 同时：
 * - 尝试复用 oldFiber（alternate）
 * - 保证 hooks 能够跨 render 复用
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileChildren</span>(<span class="hljs-params">fiber, elements = []</span>) {
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 上一次 render 的第一个子 Fiber</span>
    <span class="hljs-keyword">let</span> oldFiber = fiber.<span class="hljs-property">alternate</span> &amp;&amp; fiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">child</span>;

    <span class="hljs-keyword">while</span> (index &lt; elements.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> element = elements[index];
        <span class="hljs-keyword">if</span> (!element) {
            index++;
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 为 element 创建新的 Fiber</span>
        <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">createFiber</span>(element, fiber);

        <span class="hljs-comment">// 关联旧 Fiber（用于 hooks / state 复用）</span>
        <span class="hljs-keyword">if</span> (oldFiber) {
            newFiber.<span class="hljs-property">alternate</span> = oldFiber;
            oldFiber = oldFiber.<span class="hljs-property">sibling</span>;
        }

        <span class="hljs-comment">// 构建 child / sibling 链表</span>
        <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
            fiber.<span class="hljs-property">child</span> = newFiber;
        } <span class="hljs-keyword">else</span> {
            prevSibling.<span class="hljs-property">sibling</span> = newFiber;
        }

        prevSibling = newFiber;
        index++;
    }
}

<span class="hljs-comment">/**
 * getParentDom
 * 向上查找最近的 Host Fiber（有 dom 的 Fiber）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getParentDom</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-keyword">let</span> parent = fiber.<span class="hljs-property">parent</span>;
    <span class="hljs-keyword">while</span> (parent &amp;&amp; !parent.<span class="hljs-property">dom</span>) {
        parent = parent.<span class="hljs-property">parent</span>;
    }
    <span class="hljs-keyword">return</span> parent ? parent.<span class="hljs-property">dom</span> : <span class="hljs-literal">null</span>;
}


<span class="hljs-comment">/**************************************************************
 * Render 阶段（Fiber 构建）
 **************************************************************/</span>

<span class="hljs-comment">/**
 * performUnitOfWork
 *
 * Fiber 构建的核心调度函数
 * 采用深度优先遍历（DFS）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {

    <span class="hljs-comment">/******** Function Component ********/</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fiber.<span class="hljs-property">type</span> === <span class="hljs-string">"function"</span>) {

        <span class="hljs-comment">// 标记当前正在 render 的 Fiber</span>
        wipFiber = fiber;

        <span class="hljs-comment">// hooks 从 0 开始</span>
        hookIndex = <span class="hljs-number">0</span>;

        <span class="hljs-comment">// 初始化 hooks 容器</span>
        wipFiber.<span class="hljs-property">hooks</span> = [];

        <span class="hljs-comment">// 执行组件函数（render 阶段）</span>
        <span class="hljs-keyword">const</span> children = [fiber.<span class="hljs-title function_">type</span>(fiber.<span class="hljs-property">props</span>)];

        <span class="hljs-comment">// 根据返回的 element 构建子 Fiber</span>
        <span class="hljs-title function_">reconcileChildren</span>(fiber, children);
    }

    <span class="hljs-comment">/******** Host Component（DOM） ********/</span>
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 创建 DOM</span>
        <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
            fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDom</span>(fiber);
        }

        <span class="hljs-comment">// 挂载到父 DOM</span>
        <span class="hljs-keyword">const</span> parentDom = <span class="hljs-title function_">getParentDom</span>(fiber);
        <span class="hljs-keyword">if</span> (parentDom) {
            parentDom.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>);
        }

        <span class="hljs-comment">// 继续向下构建</span>
        <span class="hljs-title function_">reconcileChildren</span>(fiber, fiber.<span class="hljs-property">props</span>.<span class="hljs-property">children</span> || []);
    }

    <span class="hljs-comment">// 深度优先遍历</span>
    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>;

    <span class="hljs-keyword">let</span> next = fiber;
    <span class="hljs-keyword">while</span> (next) {
        <span class="hljs-keyword">if</span> (next.<span class="hljs-property">sibling</span>) <span class="hljs-keyword">return</span> next.<span class="hljs-property">sibling</span>;
        next = next.<span class="hljs-property">parent</span>;
    }
}


<span class="hljs-comment">/**************************************************************
 * render 入口
 **************************************************************/</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {

    <span class="hljs-keyword">const</span> rootFiber = {
        <span class="hljs-attr">dom</span>: container,
        <span class="hljs-attr">props</span>: { <span class="hljs-attr">children</span>: [element] },
        <span class="hljs-attr">parent</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">child</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">sibling</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">alternate</span>: currentRoot, <span class="hljs-comment">// 旧 Fiber 树</span>
    };

    currentRoot = rootFiber;

    <span class="hljs-keyword">let</span> nextUnitOfWork = rootFiber;
    <span class="hljs-keyword">while</span> (nextUnitOfWork) {
        nextUnitOfWork = <span class="hljs-title function_">performUnitOfWork</span>(nextUnitOfWork);
    }

    <span class="hljs-comment">// commit 阶段</span>
    <span class="hljs-title function_">commitEffects</span>();
}

<span class="hljs-comment">/**
 * rerender
 * 所有 setState 的最终触发点
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">rerender</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> container = currentRoot.<span class="hljs-property">dom</span>;
    container.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">""</span>;
    <span class="hljs-title function_">render</span>(currentRoot.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>], container);
}


<span class="hljs-comment">/**************************************************************
 * Hooks 实现
 **************************************************************/</span>

<span class="hljs-comment">/**
 * useState
 *
 * 原理总结：
 * 1. state 存储在 fiber.hooks 中
 * 2. 通过 hookIndex 保证顺序一致
 * 3. setState 只是入队，不立即更新
 * 4. rerender 时统一计算新 state
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) {

    <span class="hljs-comment">// 找到旧 hook</span>
    <span class="hljs-keyword">const</span> oldHook =
        wipFiber.<span class="hljs-property">alternate</span> &amp;&amp;
        wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">hooks</span> &amp;&amp;
        wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">hooks</span>[hookIndex];

    <span class="hljs-comment">// 初始化 hook</span>
    <span class="hljs-keyword">const</span> hook = {
        <span class="hljs-attr">state</span>: oldHook ? oldHook.<span class="hljs-property">state</span> : initialState,
        <span class="hljs-attr">queue</span>: [],
    };

    <span class="hljs-comment">// 执行上一次 setState 入队的 action</span>
    <span class="hljs-keyword">const</span> actions = oldHook ? oldHook.<span class="hljs-property">queue</span> : [];
    actions.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
        <span class="hljs-comment">// 获取最新状态</span>
        hook.<span class="hljs-property">state</span> =
            <span class="hljs-keyword">typeof</span> action === <span class="hljs-string">"function"</span>
                ? <span class="hljs-title function_">action</span>(hook.<span class="hljs-property">state</span>)
                : action;
    });

    <span class="hljs-comment">// setState 实现</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">setState</span> = action =&gt; {
        <span class="hljs-comment">// 向之前的wipFiber对应的hook的queue中添加action</span>
        hook.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>(action);
        <span class="hljs-title function_">rerender</span>();
    };

    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;

    <span class="hljs-keyword">return</span> [hook.<span class="hljs-property">state</span>, setState];
}


<span class="hljs-comment">/**
 * useEffect
 *
 * 核心思想：
 * - render 阶段只收集
 * - commit 阶段统一执行
 * - deps 控制是否重新执行
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useEffect</span>(<span class="hljs-params">effect, deps</span>) {

    <span class="hljs-keyword">const</span> oldHook =
        wipFiber.<span class="hljs-property">alternate</span> &amp;&amp;
        wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">hooks</span> &amp;&amp;
        wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">hooks</span>[hookIndex];

    <span class="hljs-keyword">let</span> hasChanged = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// deps 对比</span>
    <span class="hljs-keyword">if</span> (oldHook &amp;&amp; deps) {
        hasChanged = deps.<span class="hljs-title function_">some</span>(
            <span class="hljs-function">(<span class="hljs-params">dep, i</span>) =&gt;</span> !<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(dep, oldHook.<span class="hljs-property">deps</span>[i])
        );
    }

    <span class="hljs-keyword">const</span> hook = {
        effect,                <span class="hljs-comment">// 副作用函数</span>
        deps,                  <span class="hljs-comment">// 依赖</span>
        <span class="hljs-attr">cleanup</span>: oldHook ? oldHook.<span class="hljs-property">cleanup</span> : <span class="hljs-literal">null</span>,
    };

    <span class="hljs-keyword">if</span> (hasChanged) {
        pendingEffects.<span class="hljs-title function_">push</span>(hook);
    }

    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;
}


<span class="hljs-comment">/**
 * commitEffects
 * effect 的真正执行阶段
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitEffects</span>(<span class="hljs-params"/>) {
    pendingEffects.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">hook</span> =&gt;</span> {

        <span class="hljs-comment">// 先执行上一次 cleanup</span>
        <span class="hljs-keyword">if</span> (hook.<span class="hljs-property">cleanup</span>) {
            hook.<span class="hljs-title function_">cleanup</span>();
        }

        <span class="hljs-comment">// 再执行 effect</span>
        <span class="hljs-keyword">const</span> cleanup = hook.<span class="hljs-title function_">effect</span>();

        <span class="hljs-comment">// 保存 cleanup</span>
        hook.<span class="hljs-property">cleanup</span> = <span class="hljs-keyword">typeof</span> cleanup === <span class="hljs-string">"function"</span> ? cleanup : <span class="hljs-literal">null</span>;
    });

    pendingEffects = [];
}


<span class="hljs-comment">/**
 * useRef
 *
 * 特点：
 * - 返回稳定引用
 * - 修改 current 不会触发 render
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useRef</span>(<span class="hljs-params">initialValue</span>) {
    <span class="hljs-keyword">const</span> oldHook =
        wipFiber.<span class="hljs-property">alternate</span> &amp;&amp;
        wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">hooks</span> &amp;&amp;
        wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">hooks</span>[hookIndex];

    <span class="hljs-keyword">const</span> hook = {
        <span class="hljs-attr">current</span>: oldHook ? oldHook.<span class="hljs-property">current</span> : initialValue,
    };

    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;

    <span class="hljs-keyword">return</span> hook;
}


<span class="hljs-comment">/**
 * useMemo
 *
 * 作用：
 * - 缓存计算结果
 * - deps 不变时复用
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useMemo</span>(<span class="hljs-params">factory, deps</span>) {
    <span class="hljs-keyword">const</span> oldHook =
        wipFiber.<span class="hljs-property">alternate</span> &amp;&amp;
        wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">hooks</span> &amp;&amp;
        wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">hooks</span>[hookIndex];

    <span class="hljs-keyword">let</span> hasChanged = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span> (oldHook &amp;&amp; deps) {
        hasChanged = deps.<span class="hljs-title function_">some</span>(
            <span class="hljs-function">(<span class="hljs-params">dep, i</span>) =&gt;</span> !<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(dep, oldHook.<span class="hljs-property">deps</span>[i])
        );
    }

    <span class="hljs-keyword">const</span> hook = {
        <span class="hljs-attr">value</span>: hasChanged ? <span class="hljs-title function_">factory</span>() : oldHook.<span class="hljs-property">value</span>,
        deps,
    };

    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;

    <span class="hljs-keyword">return</span> hook.<span class="hljs-property">value</span>;
}


<span class="hljs-comment">/**************************************************************
 * Context（极简版）
 **************************************************************/</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createContext</span>(<span class="hljs-params">defaultValue</span>) {
    <span class="hljs-keyword">const</span> context = {
        <span class="hljs-attr">_currentValue</span>: defaultValue,
        <span class="hljs-title class_">Provider</span>: <span class="hljs-literal">null</span>,
    };

    context.<span class="hljs-property">Provider</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">Provider</span>(<span class="hljs-params">props</span>) {
        context.<span class="hljs-property">_currentValue</span> = props.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">return</span> props.<span class="hljs-property">children</span>;
    };

    <span class="hljs-keyword">return</span> context;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">const</span> hook = { <span class="hljs-attr">value</span>: context.<span class="hljs-property">_currentValue</span> };
    wipFiber.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">push</span>(hook);
    hookIndex++;
    <span class="hljs-keyword">return</span> hook.<span class="hljs-property">value</span>;
}


<span class="hljs-comment">/**************************************************************
 * 对外 API
 **************************************************************/</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniReact</span> = {
    createElement,
    render,
    useState,
    useEffect,
    useRef,
    useMemo,
    useContext,
    createContext,
};


<span class="hljs-comment">/**************************************************************
 * Demo
 **************************************************************/</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">const</span> double = <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"compute memo"</span>);
        <span class="hljs-keyword">return</span> count * <span class="hljs-number">2</span>;
    }, [count]);

    <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"effect:"</span>, count);
    }, [count]);

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(
        <span class="hljs-string">"div"</span>,
        <span class="hljs-literal">null</span>,
        <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"h3"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"Count: "</span>, count),
        <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"p"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"Double: "</span>, double),
        <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(
            <span class="hljs-string">"button"</span>,
            { <span class="hljs-attr">onclick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>) },
            <span class="hljs-string">"Add"</span>
        )
    );
}

<span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">render</span>(
    <span class="hljs-title class_">MiniReact</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">TodoApp</span>, <span class="hljs-literal">null</span>),
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)
);


<span class="hljs-comment">/**************************************************************
 * TodoApp 初始化流程（精细 Fiber + Hooks 注释）
 **************************************************************/</span>

<span class="hljs-comment">/**
 * ======================= Step 1: render() 被调用 =======================
 * MiniReact.render(element, container)
 * container = &lt;div id="root"&gt;&lt;/div&gt;
 *
 * 创建根 Fiber:
 * rootFiber = {
 *   dom: container,
 *   props: { children: [TodoApp element] },
 *   parent: null,
 *   child: null,
 *   sibling: null,
 *   alternate: null
 * }
 *
 * currentRoot = rootFiber
 * nextUnitOfWork = rootFiber
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 2: performUnitOfWork(rootFiber) =======================
 * fiber = rootFiber
 * fiber.type = undefined / 容器 DOM
 *
 * 1. 创建 DOM:
 *    fiber.dom = container
 *    parentDom = null (fiber.parent = null)
 *
 * 2. reconcileChildren(fiber, [TodoApp element])
 *    - index=0
 *    - 创建 TodoApp Fiber:
 *      todoFiber = {
 *        type: TodoApp,
 *        props: {},
 *        parent: rootFiber,
 *        child: null,
 *        sibling: null,
 *        dom: null,
 *        alternate: null,
 *        hooks: null
 *      }
 *    - rootFiber.child = todoFiber
 *
 * nextUnitOfWork = todoFiber
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 3: performUnitOfWork(todoFiber) =======================
 * fiber = todoFiber
 * fiber.type = TodoApp (函数组件)
 *
 * 1. 准备 render 函数组件:
 *    wipFiber = todoFiber
 *    hookIndex = 0
 *    wipFiber.hooks = []   &lt;-- 新 Fiber 的 hooks 数组初始化
 *
 * 2. 执行 TodoApp():
 *    const [count, setCount] = useState(0)
 *
 * ======================= Step 3a: useState =======================
 * oldHook = null (首次渲染，wipFiber.alternate = null)
 * 新 hook:
 * 0: { state: 0, queue: [] }
 * wipFiber.hooks = [ { state:0, queue:[] } ]
 * hookIndex++ =&gt; 1
 * 返回 count = 0, setCount = function
 *
 * ======================= Step 3b: useMemo =======================
 * const double = useMemo(() =&gt; count*2, [count])
 * oldHook = null
 * hasChanged = true (首次渲染)
 * 新 hook:
 * 1: { value: 0, deps:[0] }
 * wipFiber.hooks = [
 *   { state:0, queue:[] },
 *   { value:0, deps:[0] }
 * ]
 * hookIndex++ =&gt; 2
 * double = 0
 *
 * ======================= Step 3c: useEffect =======================
 * const effect = () =&gt; { console.log(count); }
 * oldHook = null
 * hasChanged = true
 * 新 hook:
 * 2: { effect: effectFn, deps:[0], cleanup: null }
 * pendingEffects = [ hook ]
 * wipFiber.hooks = [
 *   { state:0, queue:[] },
 *   { value:0, deps:[0] },
 *   { effect:effectFn, deps:[0], cleanup:null }
 * ]
 * hookIndex++ =&gt; 3
 *
 * 3. TodoApp 返回 JSX:
 * &lt;div&gt;
 *   &lt;h3&gt;Count: 0&lt;/h3&gt;
 *   &lt;p&gt;Double: 0&lt;/p&gt;
 *   &lt;button&gt;Add&lt;/button&gt;
 * &lt;/div&gt;
 *
 * reconcileChildren(todoFiber, [div element])
 * 创建 divFiber、h3Fiber、pFiber、buttonFiber
 * 建立 child/sibling 链表
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 4: commit 阶段 =======================
 * 遍历 Fiber 树，挂载 DOM:
 * rootFiber.dom.appendChild(todoFiber.dom) -&gt; divFiber.dom -&gt; h3/p/button
 *
 * 执行 pendingEffects:
 * hook.effect() -&gt; console.log(count) 输出 0
 * hook.cleanup = null
 * pendingEffects 清空
 *
 * 最终状态:
 * currentRoot = rootFiber
 * wipFiber = null
 * hookIndex = 0
 * Fiber 树:
 * ROOT
 * └── TodoApp Fiber
 *     └── divFiber
 *         ├── h3Fiber
 *         ├── pFiber
 *         └── buttonFiber
 * Hooks 状态:
 * 0: { state:0, queue:[] }
 * 1: { value:0, deps:[0] }
 * 2: { effect: effectFn, deps:[0], cleanup:null }
 */</span>




<span class="hljs-comment">/**************************************************************
 * TodoApp 第一次点击按钮更新流程（精细 Fiber + Hooks 注释）
 **************************************************************/</span>

<span class="hljs-comment">/**
 * ======================= Step 1: 用户点击按钮 =======================
 * 点击 button 执行 onclick:
 * setCount(c =&gt; c + 1)
 *
 * 1. 查找当前 Hook：
 *    wipFiber = null (尚未进入 render)
 *    hookIndex = 当前调用位置 0
 *    对应旧 Hook:
 *    oldHook = currentRoot.child.hooks[0] = { state:0, queue:[] }
 *
 * 2. 入队 action 到 hook.queue:
 *    action = c =&gt; c + 1
 *    oldHook.queue.push(action)
 *
 *    Hooks 状态（旧 Fiber 的 hooks，不变）:
 *    0: { state:0, queue:[c=&gt;c+1] }
 *    1: { value:0, deps:[0] }
 *    2: { effect:effectFn, deps:[0], cleanup:null }
 *
 * 3. 调用 rerender()
 *    清空根 DOM: container.innerHTML = ""
 *    准备重新 render(currentRoot.props.children[0], currentRoot.dom)
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 2: performUnitOfWork(todoFiber) =======================
 * wipFiber = todoFiber
 * hookIndex = 0
 * wipFiber.hooks = []   &lt;-- 新 Fiber hooks 重建
 *
 * 执行 TodoApp():
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 2a: useState =======================
 * hookIndex = 0
 * oldHook = { state:0, queue:[c=&gt;c+1] }
 *
 * 新 hook:
 * state = oldHook.state = 0
 * queue = [] (新 hook 的 queue 临时为空)
 *
 * 处理旧 queue:
 * for action in oldHook.queue:
 *   state = action(state) = (0+1) = 1
 * 新 hook.state = 1
 *
 * hookIndex++ =&gt; 1
 * wipFiber.hooks = [
 *   { state:1, queue:[] }   &lt;-- 更新后的 useState
 * ]
 *
 * 返回 count = 1, setCount = function
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 2b: useMemo =======================
 * hookIndex = 1
 * oldHook = { value:0, deps:[0] }
 *
 * 检查 deps:
 * 旧 deps = [0], 新 count = 1
 * deps 变化 -&gt; hasChanged = true
 *
 * 重新计算 value = count*2 = 1*2 = 2
 * 新 hook:
 * { value:2, deps:[1] }
 * hookIndex++ =&gt; 2
 * wipFiber.hooks = [
 *   { state:1, queue:[] },
 *   { value:2, deps:[1] }
 * ]
 *
 * double = 2
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 2c: useEffect =======================
 * hookIndex = 2
 * oldHook = { effect: effectFn, deps:[0], cleanup:null }
 *
 * 检查 deps:
 * old deps=[0], count=1 -&gt; deps变化 -&gt; hasChanged = true
 *
 * 新 hook:
 * { effect:effectFn, deps:[1], cleanup:null }
 * pendingEffects.push(newHook)
 * hookIndex++ =&gt; 3
 * wipFiber.hooks = [
 *   { state:1, queue:[] },
 *   { value:2, deps:[1] },
 *   { effect:effectFn, deps:[1], cleanup:null }
 * ]
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 3: JSX 返回 &amp; Fiber 树复用 =======================
 * TodoApp 返回:
 * &lt;div&gt;
 *   &lt;h3&gt;Count: 1&lt;/h3&gt;
 *   &lt;p&gt;Double: 2&lt;/p&gt;
 *   &lt;button&gt;Add&lt;/button&gt;
 * &lt;/div&gt;
 *
 * reconcileChildren(todoFiber, [div element])
 * Fiber 树复用:
 * todoFiber.child = divFiber (复用旧节点)
 * divFiber.child = h3Fiber -&gt; pFiber -&gt; buttonFiber (复用旧节点)
 *
 * dom 不重建，只更新 textContent
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 4: commit 阶段 =======================
 * 更新 DOM:
 * h3.textContent = "Count:1"
 * p.textContent = "Double:2"
 *
 * 执行 pendingEffects:
 * hook.effect() -&gt; console.log(count) 输出 1
 * alert("Count is: 1")
 * hook.cleanup = null
 * pendingEffects 清空
 */</span>

<span class="hljs-comment">/**
 * ======================= Step 5: 最终状态 =======================
 * currentRoot = rootFiber
 * wipFiber = null
 * hookIndex = 0
 *
 * Fiber 树:
 * ROOT
 * └── TodoApp Fiber
 *     └── divFiber
 *         ├── h3Fiber
 *         ├── pFiber
 *         └── buttonFiber
 *
 * Hooks 状态:
 * 0: { state:1, queue:[] }          &lt;-- useState 已处理 queue
 * 1: { value:2, deps:[1] }          &lt;-- useMemo 更新
 * 2: { effect:effectFn, deps:[1], cleanup:null } &lt;-- useEffect 更新
 *
 * pendingEffects = []
 */</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react学习15：基于 React Router 实现 keepalive]]></title>    <link>https://juejin.cn/post/7589475923696746515</link>    <guid>https://juejin.cn/post/7589475923696746515</guid>    <pubDate>2025-12-30T08:47:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589475923696746515" data-draft-id="7576994308273668115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react学习15：基于 React Router 实现 keepalive"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-12-30T08:47:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一江东流水"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917181880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react学习15：基于 React Router 实现 keepalive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917181880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一江东流水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:47:32.000Z" title="Tue Dec 30 2025 08:47:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当路由切换的时候，react router 会销毁之前路由的组件，然后渲染新的路由对应的组件。</p>
<p>在一些场景下，这样是有问题的。</p>
<p>比如移动端很多长列表，用户划了很久之后，点击某个列表项跳到详情页，之后又跳回来，但是这时候列表页的组件销毁重新创建，又回到了最上面。</p>
<p>比如移动端填写了某个表单，有的表单需要跳到别的页面获取数据，然后跳回来，跳回来发现组件销毁重新创建，之前填的都没了。</p>
<p>类似这种场景，就需要路由切换的时候不销毁组件，也就是 keepalive。</p>
<p>我们先复现下这个场景：</p>
<pre><code class="hljs language-js" lang="js">npx create-vite
</code></pre>
<p>选择 react + typescript 创建项目。</p>
<p>安装 react-router：</p>
<pre><code class="hljs language-js" lang="js">npm i --save react-router-dom
</code></pre>
<p>在 App.tsx 写下路由：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> {  <span class="hljs-title class_">Link</span>, useLocation, <span class="hljs-title class_">RouterProvider</span>, createBrowserRouter, <span class="hljs-title class_">Outlet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Layout</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { pathname } = <span class="hljs-title function_">useLocation</span>();

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>当前路由: {pathname}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Aaa</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count =&gt; count + 1)}&gt;加一<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'/bbb'</span>&gt;</span>去 Bbb 页面<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'/ccc'</span>&gt;</span>去 Ccc 页面<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Bbb</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count =&gt; count + 1)}&gt;加一<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'/'</span>&gt;</span>去首页<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Ccc</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>ccc<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">'/'</span>&gt;</span>去首页<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
};

<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">"/"</span>,
    <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Layout</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Layout</span>&gt;</span></span>,
    <span class="hljs-attr">children</span>: [
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/"</span>,
        <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Aaa</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Aaa</span>&gt;</span></span>,
      },
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/bbb"</span>,
        <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Bbb</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Bbb</span>&gt;</span></span>
      },
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/ccc"</span>,
        <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Ccc</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Ccc</span>&gt;</span></span>
      }
    ]
  }
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createBrowserRouter</span>(routes);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">RouterProvider</span> <span class="hljs-attr">router</span>=<span class="hljs-string">{router}/</span>&gt;</span></span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>这里有 /、/bbb、/ccc 这三个路由。</p>
<p>一级路由渲染 Layout 组件，里面通过 Outlet 指定渲染二级路由的地方。</p>
<p>二级路由 / 渲染 Aaa 组件，/bbb 渲染 Bbb 组件，/ccc 渲染 Ccc 组件。</p>
<p>这里的 Outlet 组件，也可以换成 useOutlet，效果一样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e8e3f2660c44359bbb1c9729ea64792~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767689252&amp;x-signature=rqOkIY5kelNcV00c75U8VzzjGb8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d145057fa8464d76a5fd570b762fe73e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767689252&amp;x-signature=mGgQxHQ6m5FVLtq%2B4wv4NgUXejc%3D" alt="image.png" loading="lazy"/></p>
<p>默认路由切换，对应的组件就会销毁。</p>
<p>我们有时候不希望切换路由时销毁页面组件，也就是希望能实现 keepalive。</p>
<p>怎么做呢？</p>
<p>其实很容易想到，我们把所有需要 keepalive 的组件保存到一个全局对象。</p>
<p>然后渲染的时候把它们都渲染出来，路由切换只是改变显示隐藏。</p>
<p>按照这个思路来写一下：</p>
<p>新建 KeepAliveLayout.tsx：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { createContext, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useOutlet, useLocation, matchPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-variable constant_">FC</span>, <span class="hljs-title class_">PropsWithChildren</span>, <span class="hljs-title class_">ReactNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

interface <span class="hljs-title class_">KeepAliveLayoutProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PropsWithChildren</span>{
    <span class="hljs-attr">keepPaths</span>: <span class="hljs-title class_">Array</span>&lt;string | <span class="hljs-title class_">RegExp</span>&gt;;
    keepElements?: <span class="hljs-title class_">Record</span>&lt;string, <span class="hljs-title class_">ReactNode</span>&gt;;
    dropByPath?: <span class="hljs-function">(<span class="hljs-params">path: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>;
}

type <span class="hljs-title class_">KeepAliveContextType</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">KeepAliveLayoutProps</span>&gt;, <span class="hljs-string">'children'</span>&gt;;

<span class="hljs-keyword">const</span> <span class="hljs-attr">keepElements</span>: <span class="hljs-title class_">KeepAliveContextType</span>[<span class="hljs-string">'keepElements'</span>] = {};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">KeepAliveContext</span> = createContext&lt;<span class="hljs-title class_">KeepAliveContextType</span>&gt;({
    <span class="hljs-attr">keepPaths</span>: [],
    keepElements,
    <span class="hljs-title function_">dropByPath</span>(<span class="hljs-params">path: string</span>) {
        keepElements[path] = <span class="hljs-literal">null</span>;
    }
});

<span class="hljs-keyword">const</span> <span class="hljs-title function_">isKeepPath</span> = (<span class="hljs-params">keepPaths: <span class="hljs-built_in">Array</span>&lt;string | <span class="hljs-built_in">RegExp</span>&gt;, path: string</span>) =&gt; {
    <span class="hljs-keyword">let</span> isKeep = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i&lt; keepPaths.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">let</span> item = keepPaths[i];
        <span class="hljs-keyword">if</span> (item === path) {
            isKeep = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (item <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span> &amp;&amp; item.<span class="hljs-title function_">test</span>(path)) {
            isKeep = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> item === <span class="hljs-string">'string'</span> &amp;&amp; item.<span class="hljs-title function_">toLowerCase</span>() === path) {
            isKeep = <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> isKeep;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useKeepOutlet</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();
    <span class="hljs-keyword">const</span> element = <span class="hljs-title function_">useOutlet</span>();

    <span class="hljs-keyword">const</span> { keepElements, keepPaths } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">KeepAliveContext</span>);
    <span class="hljs-keyword">const</span> isKeep = <span class="hljs-title function_">isKeepPath</span>(keepPaths, location.<span class="hljs-property">pathname</span>);

    <span class="hljs-keyword">if</span> (isKeep) {
        keepElements![location.<span class="hljs-property">pathname</span>] = element;
    }

    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
        {
            Object.entries(keepElements).map(([pathname, element]) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{pathname}</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">position:</span> '<span class="hljs-attr">relative</span>', <span class="hljs-attr">overflow:</span> '<span class="hljs-attr">hidden</span> <span class="hljs-attr">auto</span>' }}
                    <span class="hljs-attr">className</span>=<span class="hljs-string">"keep-alive-page"</span>
                    <span class="hljs-attr">hidden</span>=<span class="hljs-string">{!matchPath(location.pathname,</span> <span class="hljs-attr">pathname</span>)}
                &gt;</span>
                    {element}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            ))
        }
        {!isKeep &amp;&amp; element}
    <span class="hljs-tag">&lt;/&gt;</span></span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">KeepAliveLayout</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">KeepAliveLayoutProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { keepPaths, ...other } = props;

    <span class="hljs-keyword">const</span> { keepElements, dropByPath } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">KeepAliveContext</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeepAliveContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">keepPaths</span>, <span class="hljs-attr">keepElements</span>, <span class="hljs-attr">dropByPath</span> }} {<span class="hljs-attr">...other</span>} /&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">KeepAliveLayout</span>;
</code></pre>
<h2 data-id="heading-0">ts 相关知识点</h2>
<h3 data-id="heading-1">PropsWithChildren</h3>
<p>在 React 中，<code>PropsWithChildren</code> 是 TypeScript 提供的一个工具类型，用于为组件的 props 类型添加 <code>children</code> 属性的类型定义。</p>
<p>当你定义组件的 props 类型时，如果组件需要接收 <code>children</code>（子元素），可以使用 <code>PropsWithChildren</code> 来自动包含 <code>children</code> 的类型，无需手动声明。</p>
<p>它的本质是一个泛型类型，定义如下（简化版）：</p>
<pre><code class="hljs language-js" lang="js">type <span class="hljs-title class_">PropsWithChildren</span>&lt;P = {}&gt; = P &amp; { children?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span> };
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { type <span class="hljs-title class_">PropsWithChildren</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 自定义 props 类型</span>
type <span class="hljs-title class_">CardProps</span> = {
  <span class="hljs-attr">title</span>: string;
  className?: string;
};

<span class="hljs-comment">// 使用 PropsWithChildren 包含 children</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ title, className, children }: PropsWithChildren&lt;CardProps&gt;</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{title}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 使用组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"卡片标题"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"card"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是卡片内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-2">Record、 Require、 Omit</h3>
<ul>
<li>Record 是创建一个 key value 的对象类型：</li>
</ul>
<pre><code class="hljs language-js" lang="js"> keepElements?: <span class="hljs-title class_">Record</span>&lt;string, <span class="hljs-title class_">ReactNode</span>&gt;;
</code></pre>
<ul>
<li>
<p>Requried 是去掉可选 -?</p>
</li>
<li>
<p>Omit 是删掉其中的部分属性：</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js">type <span class="hljs-title class_">KeepAliveContextType</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">KeepAliveLayoutProps</span>&gt;, <span class="hljs-string">'children'</span>&gt;;
</code></pre>
<p>如果要知道某个属性的类型呢？ 如下代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-attr">keepElements</span>: <span class="hljs-title class_">KeepAliveContextType</span>[<span class="hljs-string">'keepElements'</span>] = {};
</code></pre>
<p><code>KeepAliveContextType['keepElements']</code> 就返回了 <code>keepElements</code> 属性的类型。</p>
<p>是不是感觉ts跟编程一样。</p>
<p>继续往下看：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">KeepAliveLayout</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">KeepAliveLayoutProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { keepPaths, ...other } = props;

    <span class="hljs-keyword">const</span> { keepElements, dropByPath } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">KeepAliveContext</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeepAliveContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">keepPaths</span>, <span class="hljs-attr">keepElements</span>, <span class="hljs-attr">dropByPath</span> }} {<span class="hljs-attr">...other</span>} /&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">KeepAliveLayout</span>;
</code></pre>
<p>首先从父组件中传入props，其中包括定义的 <code>keepPaths</code>, 然后从useContext 取出其他值，然后通过KeepAliveContext.Provider 的value 进行设置，这样子组件就能获取到这些值。</p>
<p>然后暴露一个 useKeepOutlet 的 hook：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useKeepOutlet</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();
    <span class="hljs-keyword">const</span> element = <span class="hljs-title function_">useOutlet</span>();

    <span class="hljs-keyword">const</span> { keepElements, keepPaths } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">KeepAliveContext</span>);
    <span class="hljs-keyword">const</span> isKeep = <span class="hljs-title function_">isKeepPath</span>(keepPaths, location.<span class="hljs-property">pathname</span>);

    <span class="hljs-keyword">if</span> (isKeep) {
        keepElements![location.<span class="hljs-property">pathname</span>] = element;
    }

    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
        {
            Object.entries(keepElements).map(([pathname, element]) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{pathname}</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">position:</span> '<span class="hljs-attr">relative</span>', <span class="hljs-attr">overflow:</span> '<span class="hljs-attr">hidden</span> <span class="hljs-attr">auto</span>' }}
                    <span class="hljs-attr">className</span>=<span class="hljs-string">"keep-alive-page"</span>
                    <span class="hljs-attr">hidden</span>=<span class="hljs-string">{!matchPath(location.pathname,</span> <span class="hljs-attr">pathname</span>)}
                &gt;</span>
                    {element}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            ))
        }
        {!isKeep &amp;&amp; element}
    <span class="hljs-tag">&lt;/&gt;</span></span>
}
</code></pre>
<p>用 useLocation 拿到当前路由，用 useOutlet 拿到对应的组件。</p>
<p>判断下当前路由是否在需要 keepalive 的路由内，是的话就保存到 keepElements。</p>
<p>然后渲染所有的 keepElements，如果不匹配 matchPath 就隐藏。</p>
<p>并且如果当前路由不在 keepPaths 内，就直接渲染对应的组件：  {!isKeep &amp;&amp; element} 。</p>
<p>其实原理比较容易看懂：<strong>在 context 中保存所有需要 keepalive 的组件，全部渲染出来，通过路由是否匹配来切换对应组件的显示隐藏。</strong></p>
<p>在 App.tsx 里引入测试下：</p>
<p>在外面包一层 KeepAliveLayout 组件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeepAliveLayout</span> <span class="hljs-attr">keepPaths</span>=<span class="hljs-string">{[</span>'/<span class="hljs-attr">bbb</span>', '/']}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RouterProvider</span> <span class="hljs-attr">router</span>=<span class="hljs-string">{router}/</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">KeepAliveLayout</span>&gt;</span></span>
    )
}
</code></pre>
<p><code>&lt;RouterProvider router={router}/&gt;</code>会作为<code>children</code>传递到<code>KeepAliveLayout</code>组件中。</p>
<p>然后把 useOutlet 换成 useKeepOutlet：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Layout</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { pathname } = <span class="hljs-title function_">useLocation</span>();

    <span class="hljs-keyword">const</span> element = <span class="hljs-title function_">useKeepOutlet</span>()

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>当前路由: {pathname}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            { element }
            {/* <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span>/&gt;</span> */}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h2 data-id="heading-3">总结</h2>
<p>路由切换会销毁对应的组件，但很多场景我们希望路由切换组件不销毁，也就是 keepalive。</p>
<p>react router 并没有实现这个功能，需要我们自己做。</p>
<p>我们在 context 中保存所有需要 keepalive 的组件，然后渲染的时候全部渲染出来，通过路由是否匹配来切换显示隐藏。</p>
<p>这样实现了 keepalive。</p>
<p>这个功能是依赖 React Router 的 useLocation、useOutlet、matchPath 等 api 实现的，和路由功能密不可分。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 闭包实战：手写防抖与节流函数，优化高频事件性能]]></title>    <link>https://juejin.cn/post/7589445154533933108</link>    <guid>https://juejin.cn/post/7589445154533933108</guid>    <pubDate>2025-12-30T08:55:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589445154533933108" data-draft-id="7589386961649205283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 闭包实战：手写防抖与节流函数，优化高频事件性能"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-30T08:55:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="超级赛亚人_"/> <meta itemprop="url" content="https://juejin.cn/user/793196846923641"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 闭包实战：手写防抖与节流函数，优化高频事件性能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793196846923641/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    超级赛亚人_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:55:15.000Z" title="Tue Dec 30 2025 08:55:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，我们经常会遇到高频触发的事件，比如：</p>
<ul>
<li>输入框 keyup 时的搜索建议（类似百度、VS Code 的智能补全）</li>
<li>窗口 resize 时的布局重新计算</li>
<li>页面滚动时的懒加载或返回顶部按钮显示</li>
<li>鼠标 mousemove 时的拖拽预览</li>
</ul>
<p>这些事件往往在短时间内被触发数百甚至上千次，如果每次都直接执行复杂的逻辑（如发 AJAX 请求、操作 DOM、计算布局），会严重消耗浏览器资源，导致页面卡顿、掉帧，甚至崩溃。</p>
<p>解决这类问题的核心方案就是<strong>函数防抖（debounce）<strong>和</strong>函数节流（throttle）</strong> ，而它们的实现都离不开 JavaScript 的灵魂特性——<strong>闭包</strong>。</p>
<p>本文将从实际场景出发，详细讲解防抖和节流的原理、区别、手动实现，并提供完整可运行的 HTML 示例，帮助你彻底掌握这一前端性能优化的必备技能。</p>
<h2 data-id="heading-0">什么是闭包？为什么能用于防抖节流？</h2>
<p>闭包是指函数能够“记住”并访问其词法作用域中的变量，即使函数在外部作用域之外执行。</p>
<p>在防抖和节流中，我们需要：</p>
<ul>
<li>保存定时器 ID（用于清除或判断时间）</li>
<li>记住上一次执行的时间戳</li>
<li>保留正确的 this 指向和参数</li>
</ul>
<p>这些变量必须在多次事件触发间“存活”下来，而不能每次都重新创建——这正是闭包的用武之地。</p>
<h2 data-id="heading-1">场景一：搜索输入框的 AJAX 请求优化</h2>
<p>用户在搜索框输入关键词时，我们希望实时显示搜索建议（如百度输入“react”时下方出现的建议列表）。</p>
<p>如果不做任何处理，每次 keyup 都立即发送请求：</p>
<ul>
<li>用户输入“react”五个字符 → 触发 5 次请求</li>
<li>网络开销大、服务器压力大</li>
<li>用户体验差（快速输入时建议闪烁）</li>
</ul>
<p>理想效果是：用户停止输入 500ms 后，才发送一次请求。</p>
<p>这正是<strong>防抖</strong>的典型应用场景。</p>
<h2 data-id="heading-2">函数防抖（debounce）原理与实现</h2>
<p><strong>防抖的核心思想</strong>：不管事件触发多少次，我只关心最后一次。在最后一次触发后的 delay 时间内如果没有新触发，才真正执行函数。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 闭包中保存定时器 ID</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;

    <span class="hljs-comment">// 每次触发时，先清除上一次的定时器</span>
    <span class="hljs-keyword">if</span> (timer) {
      <span class="hljs-built_in">clearTimeout</span>(timer);
    }

    <span class="hljs-comment">// 重新设置定时器</span>
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      fn.<span class="hljs-title function_">apply</span>(context, args);
      timer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 执行完可可选清理</span>
    }, delay);
  };
}
</code></pre>
<p>关键点解析：</p>
<ul>
<li>timer 变量定义在 debounce 函数作用域中，被返回的函数“记住”（闭包）。</li>
<li>每次事件触发都清除旧定时器，重新开始倒计时。</li>
<li>只有在 delay 时间内没有新触发时，定时器才会执行 fn。</li>
<li>使用 apply 保留正确的 this 和参数。</li>
</ul>
<h2 data-id="heading-3">函数节流（throttle）原理与实现</h2>
<p><strong>节流的核心思想</strong>：在规定时间内，无论触发多少次，只执行一次。常用于限制执行频率。</p>
<p>典型场景：页面滚动时加载更多内容（scroll 事件），我们希望每 500ms 最多检查一次是否到达底部。</p>
<p>JavaScript</p>
<pre><code class="hljs language-ini" lang="ini">function throttle(fn, delay) {
  let <span class="hljs-attr">last</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 闭包中记录上次执行时间</span>

  return function(...args) {
    const <span class="hljs-attr">context</span> = this<span class="hljs-comment">;</span>
    const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>

    // 如果距离上次执行不足 delay，则不执行
    if (now - last &lt; delay) {
      return<span class="hljs-comment">;</span>
    }

    // 执行并更新 last
    <span class="hljs-attr">last</span> = now<span class="hljs-comment">;</span>
    fn.apply(context, args)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>更常见的<strong>时间戳 + 定时器混合版</strong>（支持尾部执行）：</p>
<p>JavaScript</p>
<pre><code class="hljs language-ini" lang="ini">function throttle(fn, delay) {
  let <span class="hljs-attr">last</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  let <span class="hljs-attr">timer</span> = null<span class="hljs-comment">;</span>

  return function(...args) {
    const <span class="hljs-attr">context</span> = this<span class="hljs-comment">;</span>
    const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>

    // 如果还在冷却期，且没有定时器（避免重复设置）
    if (now - last &lt; delay) {
      clearTimeout(timer)<span class="hljs-comment">;</span>
      <span class="hljs-attr">timer</span> = setTimeout(() =&gt; {
        <span class="hljs-attr">last</span> = now<span class="hljs-comment">;</span>
        fn.apply(context, args)<span class="hljs-comment">;</span>
      }, delay)<span class="hljs-comment">;</span>
    } else {
      // 立即执行（领先执行）
      <span class="hljs-attr">last</span> = now<span class="hljs-comment">;</span>
      fn.apply(context, args)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>这种实现兼顾了“固定频率执行”和“停止触发后仍能执行最后一次”。</p>
<h2 data-id="heading-4">防抖 vs 节流：如何选择？</h2>






























<table><thead><tr><th>特性</th><th>防抖 (debounce)</th><th>节流 (throttle)</th></tr></thead><tbody><tr><td>执行时机</td><td>事件停止触发后 delay 时间执行一次</td><td>每隔 delay 时间执行一次</td></tr><tr><td>典型场景</td><td>搜索输入、表单提交验证</td><td>滚动加载、鼠标跟随、射击游戏射速</td></tr><tr><td>用户体验</td><td>等待用户“想好了”再响应</td><td>持续操作时保持流畅响应</td></tr><tr><td>实现复杂度</td><td>相对简单（setTimeout）</td><td>稍复杂（时间戳或定时器混合）</td></tr></tbody></table>
<p>记忆口诀：</p>
<ul>
<li>需要“最后一次”执行 → 用防抖（如搜索）</li>
<li>需要“持续但限频”执行 → 用节流（如滚动）</li>
</ul>
<h2 data-id="heading-5">完整可运行示例</h2>
<p>下面是一个完整的 HTML 文件，包含三个输入框：</p>
<ul>
<li>第一个：无优化，每次 keyup 都发请求</li>
<li>第二个：防抖优化，停止输入 500ms 后发一次请求</li>
<li>第三个：节流优化，每 500ms 最多发一次请求</li>
</ul>
<p>HTML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>防抖与节流演示<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: Arial, sans-serif; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
    <span class="hljs-selector-tag">input</span> { <span class="hljs-attribute">display</span>: block; <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>; <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; }
    <span class="hljs-selector-tag">label</span> { <span class="hljs-attribute">font-weight</span>: bold; }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>无优化（每次输入都请求）<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"undebounce"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"快速输入观察控制台"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>防抖（停止输入500ms后请求）<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"debounce"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入完成后才会请求"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>节流（每500ms最多请求一次）<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"throttle"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"持续输入时会定期请求"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">ajax</span>(<span class="hljs-params">content</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ajax request:'</span>, content);
    }

    <span class="hljs-comment">// 防抖实现</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
      <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
        <span class="hljs-keyword">if</span> (timer) <span class="hljs-built_in">clearTimeout</span>(timer);
        timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          fn.<span class="hljs-title function_">apply</span>(context, args);
        }, delay);
      };
    }

    <span class="hljs-comment">// 节流实现（时间戳 + 定时器混合版）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, delay</span>) {
      <span class="hljs-keyword">let</span> last = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
        <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-keyword">if</span> (now - last &lt; delay) {
          <span class="hljs-built_in">clearTimeout</span>(timer);
          timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            last = now;
            fn.<span class="hljs-title function_">apply</span>(context, args);
          }, delay);
        } <span class="hljs-keyword">else</span> {
          last = now;
          fn.<span class="hljs-title function_">apply</span>(context, args);
        }
      };
    }

    <span class="hljs-keyword">const</span> inputA = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'undebounce'</span>);
    <span class="hljs-keyword">const</span> inputB = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'debounce'</span>);
    <span class="hljs-keyword">const</span> inputC = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'throttle'</span>);

    <span class="hljs-keyword">const</span> debouncedAjax = <span class="hljs-title function_">debounce</span>(ajax, <span class="hljs-number">500</span>);
    <span class="hljs-keyword">const</span> throttledAjax = <span class="hljs-title function_">throttle</span>(ajax, <span class="hljs-number">500</span>);

    inputA.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keyup'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-title function_">ajax</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
    });

    inputB.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keyup'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-title function_">debouncedAjax</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
    });

    inputC.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keyup'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-title function_">throttledAjax</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>打开浏览器控制台，分别在三个输入框快速输入，你会清晰看到三者的巨大差异。</p>
<h2 data-id="heading-6">现代框架中的应用</h2>
<p>虽然原生 JS 需要手写，但现代框架/库已内置：</p>
<ul>
<li>Lodash：_.debounce(fn, wait) 和 _.throttle(fn, wait)</li>
<li>Vue：@input.debounce="500ms"</li>
<li>React：可配合 useCallback + useRef 实现，或使用第三方如 use-debounce</li>
</ul>
<p>但理解底层原理，能让你在复杂场景下自定义行为（如立即执行选项、取消功能等）。</p>
<h2 data-id="heading-7">最佳实践建议</h2>
<ol>
<li><strong>搜索输入</strong> → 防抖（节约资源，用户输入完成后响应）</li>
<li><strong>滚动事件</strong> → 节流（保持流畅）</li>
<li><strong>按钮防止重复点击</strong> → 防抖（delay 设为 1000ms）</li>
<li><strong>resize/scroll 计算复杂布局</strong> → 节流</li>
<li><strong>拖拽过程中实时预览</strong> → 节流</li>
</ol>
<h2 data-id="heading-8">结语</h2>
<p>闭包是 JavaScript 最强大的特性之一，而防抖和节流则是它在性能优化领域最经典的应用体现。</p>
<p>通过合理使用防抖和节流，我们可以：</p>
<ul>
<li>大幅减少不必要的网络请求和计算</li>
<li>提升页面响应速度和流畅度</li>
<li>改善用户体验</li>
<li>降低服务器压力</li>
</ul>
<p>无论你是面试被问“手写防抖节流”，还是实际项目中遇到卡顿问题，这两个函数都是你工具箱中不可或缺的利器。</p>
<p>建议立即复制上面的完整示例到本地运行，亲身体验三者的差异——理论结合实践，你才能真正掌握。</p>
<p>前端性能优化，从理解闭包开始，从手写防抖节流起步。愿你的页面永远丝滑流畅！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🥯2025 年终极避坑指南：Spring Boot 2.7 + 3.2 混合集群的 Redis + OAuth2 序列化血泪史]]></title>    <link>https://juejin.cn/post/7589250237069639690</link>    <guid>https://juejin.cn/post/7589250237069639690</guid>    <pubDate>2025-12-30T09:50:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589250237069639690" data-draft-id="7589474656874627082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🥯2025 年终极避坑指南：Spring Boot 2.7 + 3.2 混合集群的 Redis + OAuth2 序列化血泪史"/> <meta itemprop="keywords" content="后端,Java,Spring Cloud"/> <meta itemprop="datePublished" content="2025-12-30T09:50:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户352180245475"/> <meta itemprop="url" content="https://juejin.cn/user/156576846710315"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🥯2025 年终极避坑指南：Spring Boot 2.7 + 3.2 混合集群的 Redis + OAuth2 序列化血泪史
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/156576846710315/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户352180245475
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:50:34.000Z" title="Tue Dec 30 2025 09:50:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有没有遇到过这种事：认证中心不敢动（怕升级炸），业务服务却全升到 Boot 3.2，结果 Redis 共享数据成了“战场”？ 我踩了一个月的坑，从 Jackson 异常狂轰滥炸，到 Redis 密码特殊符号闹剧，再到脏数据暗杀……今天把全过程写成这篇博客，轻松活泼版，保证你看完笑着就把坑避开！</p>
<h3 data-id="heading-0">为什么我会掉进这个大坑？</h3>
<p>简单说：公司认证中心用 Boot 2.7 + 老 Authorization Server（0.2.3/0.4.x），稳如老狗，维护到 2028 年。 业务微服务全升 Boot 3.2，享受 VirtualThread、新特性。 共享 Redis 存 Session + OAuth2Authorization → 序列化不兼容 → 全线爆炸！</p>
<p>我当时想：“不就个序列化吗，加几个 Jackson Module 不就完了？” 结果……一个月后我才爬出来😂</p>
<h3 data-id="heading-1">我到底发现了哪些鬼畜问题？</h3>
<ol>
<li>
<p>Jackson 异常连环杀</p>
<ul>
<li>Cannot construct instance of SimpleGrantedAuthority（GrantedAuthority 变 record 了）</li>
<li>Unrecognized field "settings"（老版本遗留字段）</li>
<li>Cannot construct instance of ClientSettings/TokenSettings（无默认构造函数）</li>
<li>The token generator failed to generate the access token（settings 为 null，最隐晦的坑！）</li>
</ul>
</li>
<li>
<p>NPE 与 null 狂魔</p>
<ul>
<li>tokens 为 null → getAccessToken() NPE</li>
<li>attributes.putAll(null) → HashMap NPE</li>
<li>GenericJackson2JsonRedisSerializer 加 "value" 包装，导致测试和生产行为不一致</li>
</ul>
</li>
<li>
<p>刷新令牌异常</p>
<ul>
<li>Type id handling not implemented for java.lang.Object</li>
<li>Unrecognized field "settings"</li>
<li>Problem deserializing 'setterless' property</li>
<li>OAuth2AuthenticationException: The token generator failed</li>
</ul>
</li>
<li>
<p>终极 Boss：脏数据</p>
<ul>
<li>Redis 里混进 Boot 3.2 写的数据（attributes 有 "java.security.Principal" key）</li>
<li>Boot 2.7 读到直接吐血</li>
</ul>
</li>
</ol>
<h3 data-id="heading-2">我是怎么一步步爬出来的？（解决过程超搞笑）</h3>
<ol>
<li>
<p><strong>Jackson 补丁大战</strong> 加了 SecurityJackson2Module、OAuth2LegacyJacksonModule 处理特殊类。 写了自定义 Deserializer，手动填充 tokens（因为老版本没有 setter）。 visibility 配置 FIELD ANY 让 Jackson 看到 private 字段。</p>
</li>
<li>
<p><strong>NPE 猎杀时刻</strong> attributes 判 null，authorizationGrantType 判 null。 发现 GenericJackson2JsonRedisSerializer 会加 "value" 包装 → 测试要用 serializer.serialize() 存数据。</p>
</li>
<li>
<p>自定义 Provider 后，<strong>移除默认的Provider</strong></p>
</li>
<li>
<p>脏数据大清洗</p>
<p>一条命令解决 90% 问题：</p>
<p>Bash</p>
<pre><code class="hljs language-css" lang="css"> redis-cli <span class="hljs-attr">--scan</span> <span class="hljs-attr">--pattern</span> "*:token::*<span class="hljs-string">" | xargs redis-cli del
</span></code></pre>
<p>清理完重新登录，世界安静了😂</p>
</li>
</ol>
<h3 data-id="heading-3">终极无敌配置（复制即用，2025 年老项目救星）</h3>
<ul>
<li><strong>PublicJsonRedisSerializer</strong>:springboot3与springboot2都使用这个类，Security公共 JSON 序列化器</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino"> <span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonTypeInfo;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.jsontype.BasicPolymorphicTypeValidator;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-keyword">module</span>.SimpleModule;
 <span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
 <span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
 <span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
 <span class="hljs-keyword">import</span> org.springframework.security.oauth2.server.authorization.OAuth2Authorization;
 ​
 @Configuration
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PublicJsonRedisSerializer</span> {
 ​
     <span class="hljs-comment">/**
      * 公共 JSON 序列化器（我们打磨万年的终极版）
      * 名字叫 publicJsonRedisSerializer，所有地方统一用这个
      */</span>
     @<span class="hljs-function">Bean
     <span class="hljs-keyword">public</span> GenericJackson2JsonRedisSerializer <span class="hljs-title">publicJsonRedisSerializer</span><span class="hljs-params">()</span> </span>{
         ObjectMapper objectMapper = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ObjectMapper</span>();
 ​
         <span class="hljs-comment">// Java8 时间支持</span>
         objectMapper.<span class="hljs-built_in">registerModule</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">JavaTimeModule</span>());
         objectMapper.<span class="hljs-built_in">disable</span>(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
 ​
         SimpleModule <span class="hljs-keyword">module</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SimpleModule</span>(<span class="hljs-string">"OAuth2AuthorizationModule"</span>);
         <span class="hljs-keyword">module</span>.<span class="hljs-built_in">addDeserializer</span>(OAuth2Authorization.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">OAuth2AuthorizationDeserializer</span>());
         objectMapper.<span class="hljs-built_in">registerModule</span>(<span class="hljs-keyword">module</span>);
 ​
         <span class="hljs-comment">// 全局忽略未知字段（治愈历史脏数据）</span>
         objectMapper.<span class="hljs-built_in">configure</span>(com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="hljs-literal">false</span>);
         objectMapper.<span class="hljs-built_in">configure</span>(DeserializationFeature.READ_UNKNOWN_ENUM_VALUES_AS_NULL, <span class="hljs-literal">true</span>);
         objectMapper.<span class="hljs-built_in">registerModule</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">SecurityJackson2Module</span>());
         objectMapper.<span class="hljs-built_in">registerModule</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">OAuth2LegacyJacksonModule</span>());
         <span class="hljs-comment">// 安全的多态支持（Boot 3 推荐写法）</span>
         objectMapper.<span class="hljs-built_in">activateDefaultTyping</span>(
                 BasicPolymorphicTypeValidator.<span class="hljs-built_in">builder</span>()
                         .<span class="hljs-built_in">allowIfBaseType</span>(Object.<span class="hljs-keyword">class</span>)
                         .<span class="hljs-built_in">build</span>(),
                 ObjectMapper.DefaultTyping.NON_FINAL,
                 JsonTypeInfo.As.PROPERTY
         );
 ​
         <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">GenericJackson2JsonRedisSerializer</span>(objectMapper);
     }
 }
 ​
</code></pre>
<p>RedisTemplate 强制用它，OAuth2AuthorizationService 也强制用它。</p>
<ul>
<li>
<p>OAuth2AuthorizationDeserializer</p>
<p>因为 spring-security-oauth2-authorization-server 0.2.3 版本的反序列化设计太“反人类”了，Jackson 默认方式根本读不出来完整的 OAuth2Authorization 对象，尤其是 accessToken、refreshToken 等关键 token 会丢失，导致 getAccessToken() 返回 null，进而引发 NPE 或 introspect 失败。</p>
<p><strong>核心问题（老版本 0.2.3 的“坑王设计”）</strong></p>
<ul>
<li>
<p>JSON 格式是独立的字段</p>
<pre><code class="hljs language-perl" lang="perl"> {
   <span class="hljs-string">"accessToken"</span>: { <span class="hljs-string">"@class"</span>: <span class="hljs-string">"OAuth2Authorization$Token"</span>, <span class="hljs-string">"token"</span>: { ... } },
   <span class="hljs-string">"refreshToken"</span>: { ... }
 }
</code></pre>
</li>
</ul>

<ul>
<li>
<p>类结构却是 private final tokens Map</p>
<pre><code class="hljs language-swift" lang="swift"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">Class</span>&lt;? extends <span class="hljs-type">OAuth2Token</span>&gt;, <span class="hljs-type">Token</span>&lt;?&gt;&gt; tokens <span class="hljs-operator">=</span> new <span class="hljs-type">HashMap</span>&lt;&gt;();
 <span class="hljs-comment">// 没有 public setAccessToken() / setRefreshToken()</span>
 <span class="hljs-comment">// 唯一合法填充方式是 Builder.token(...) → build()</span>
</code></pre>
</li>
</ul>

<ul>
<li>
<p>Jackson 默认行为</p>
<ul>
<li>看到 "accessToken" 字段，但类里没有对应的 setter → 忽略！</li>
<li>tokens 是 private final → 默认不填充</li>
<li>结果：反序列化后 tokens 为空 → getAccessToken()/getRefreshToken() 全是 null → 业务爆炸</li>
</ul>
</li>
</ul>
<p><strong>完整代码</strong></p>
<pre><code class="hljs language-ini" lang="ini"> import com.fasterxml.jackson.core.JsonParser<span class="hljs-comment">;</span>
 import com.fasterxml.jackson.databind.DeserializationContext<span class="hljs-comment">;</span>
 import com.fasterxml.jackson.databind.JsonNode<span class="hljs-comment">;</span>
 import com.fasterxml.jackson.databind.ObjectMapper<span class="hljs-comment">;</span>
 import com.fasterxml.jackson.databind.deser.std.StdDeserializer<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.core.AuthorizationGrantType<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.core.ClientAuthenticationMethod<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.core.OAuth2AccessToken<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.core.OAuth2RefreshToken<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.OAuth2Authorization<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.client.RegisteredClient<span class="hljs-comment">;</span>
 ​
 import java.io.IOException<span class="hljs-comment">;</span>
 import java.time.Instant<span class="hljs-comment">;</span>
 import java.util.HashMap<span class="hljs-comment">;</span>
 import java.util.HashSet<span class="hljs-comment">;</span>
 import java.util.Map<span class="hljs-comment">;</span>
 import java.util.Set<span class="hljs-comment">;</span>
 ​
 public class OAuth2AuthorizationDeserializer extends StdDeserializer&lt;OAuth2Authorization&gt; {
 ​
     public OAuth2AuthorizationDeserializer() {
         super(OAuth2Authorization.class)<span class="hljs-comment">;</span>
     }
 ​
     @Override
     public OAuth2Authorization deserialize(JsonParser p, DeserializationContext ctxt) throws IOException {
         JsonNode <span class="hljs-attr">root</span> = p.getCodec().readTree(p)<span class="hljs-comment">;</span>
         ObjectMapper <span class="hljs-attr">mapper</span> = (ObjectMapper) p.getCodec()<span class="hljs-comment">;</span>
 ​
         // 1. 创建一个最小的合法 dummy RegisteredClient（只为通过 Builder 校验）
         String <span class="hljs-attr">registeredClientId</span> = root.get(<span class="hljs-string">"registeredClientId"</span>).asText(<span class="hljs-string">"dummy"</span>)<span class="hljs-comment">;</span>
         RegisteredClient <span class="hljs-attr">dummyClient</span> = RegisteredClient.withId(registeredClientId)
                 .clientId(registeredClientId)
                 .clientSecret("{noop}secret")
                 .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)
                 .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
                 .scope("dummy")
                 .build()<span class="hljs-comment">;</span>
 ​
         // 2. 开始构建
         OAuth2Authorization.Builder <span class="hljs-attr">builder</span> = OAuth2Authorization.withRegisteredClient(dummyClient)
                 .id(root.get("id").asText())
                 .principalName(root.get("principalName").asText())<span class="hljs-comment">;</span>
 ​
         // authorizationGrantType
         JsonNode <span class="hljs-attr">grantNode</span> = root.get(<span class="hljs-string">"authorizationGrantType"</span>)<span class="hljs-comment">;</span>
         String <span class="hljs-attr">grantTypeValue</span> = grantNode.has(<span class="hljs-string">"value"</span>) ? grantNode.get(<span class="hljs-string">"value"</span>).asText() : <span class="hljs-string">"client_credentials"</span><span class="hljs-comment">;</span>
         builder.authorizationGrantType(new AuthorizationGrantType(grantTypeValue))<span class="hljs-comment">;</span>
 ​
         // authorizedScopes
         if (root.has("authorizedScopes")) {
             JsonNode <span class="hljs-attr">scopesArray</span> = root.get(<span class="hljs-string">"authorizedScopes"</span>)<span class="hljs-comment">;</span>
             if (scopesArray.isArray() &amp;&amp; scopesArray.size() &gt; 1) {
                 Set&lt;String&gt; <span class="hljs-attr">scopes</span> = new HashSet&lt;&gt;()<span class="hljs-comment">;</span>
                 JsonNode <span class="hljs-attr">actualScopes</span> = scopesArray.get(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
                 for (JsonNode s : actualScopes) {
                     scopes.add(s.asText())<span class="hljs-comment">;</span>
                 }
                 builder.authorizedScopes(scopes)<span class="hljs-comment">;</span>
             }
         }
 ​
         // attributes（空就空，没事）
         if (root.has("attributes")) {
             Map&lt;String, Object&gt; <span class="hljs-attr">attributes</span> = mapper.treeToValue(root.get(<span class="hljs-string">"attributes"</span>), Map.class)<span class="hljs-comment">;</span>
             builder.attributes(attrs -&gt; attrs.putAll(attributes))<span class="hljs-comment">;</span>
         }
 ​
         // ========== 关键：手动解析 Token 节点，自己 new Token&lt;&gt;() ==========
         if (root.has("accessToken")) {
             JsonNode <span class="hljs-attr">accessTokenNode</span> = root.get(<span class="hljs-string">"accessToken"</span>)<span class="hljs-comment">;</span>
 ​
             // 解析 OAuth2AccessToken
             JsonNode <span class="hljs-attr">tokenNode</span> = accessTokenNode.get(<span class="hljs-string">"token"</span>)<span class="hljs-comment">;</span>
             String <span class="hljs-attr">tokenValue</span> = tokenNode.get(<span class="hljs-string">"tokenValue"</span>).asText()<span class="hljs-comment">;</span>
             Instant <span class="hljs-attr">issuedAt</span> = tokenNode.has(<span class="hljs-string">"issuedAt"</span>) ? Instant.parse(tokenNode.get(<span class="hljs-string">"issuedAt"</span>).asText()) : null<span class="hljs-comment">;</span>
             Instant <span class="hljs-attr">expiresAt</span> = tokenNode.has(<span class="hljs-string">"expiresAt"</span>) ? Instant.parse(tokenNode.get(<span class="hljs-string">"expiresAt"</span>).asText()) : null<span class="hljs-comment">;</span>
 ​
             JsonNode <span class="hljs-attr">tokenTypeNode</span> = tokenNode.get(<span class="hljs-string">"tokenType"</span>)<span class="hljs-comment">;</span>
             OAuth2AccessToken.TokenType <span class="hljs-attr">tokenType</span> =
                     OAuth2AccessToken.TokenType.BEARER<span class="hljs-comment">;</span>
 ​
             Set&lt;String&gt; <span class="hljs-attr">scopes</span> = new HashSet&lt;&gt;()<span class="hljs-comment">;</span>
             if (tokenNode.has("scopes")) {
                 JsonNode <span class="hljs-attr">scopesWrapper</span> = tokenNode.get(<span class="hljs-string">"scopes"</span>)<span class="hljs-comment">;</span>
                 if (scopesWrapper.isArray() &amp;&amp; scopesWrapper.size() &gt; 1) {
                     JsonNode <span class="hljs-attr">scopesArray</span> = scopesWrapper.get(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
                     for (JsonNode s : scopesArray) {
                         scopes.add(s.asText())<span class="hljs-comment">;</span>
                     }
                 }
             }
 ​
             OAuth2AccessToken <span class="hljs-attr">accessToken</span> = new OAuth2AccessToken(tokenType, tokenValue, issuedAt, expiresAt, scopes)<span class="hljs-comment">;</span>
 ​
 ​
 //            OAuth2AccessToken <span class="hljs-attr">accessToken</span> = mapper.treeToValue(tokenNode, OAuth2AccessToken.class)<span class="hljs-comment">;</span>
 ​
             // 解析 metadata（如果有）
             Map&lt;String, Object&gt; <span class="hljs-attr">metadata</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
             if (accessTokenNode.has("metadata")) {
                 <span class="hljs-attr">metadata</span> = mapper.treeToValue(accessTokenNode.get(<span class="hljs-string">"metadata"</span>), Map.class)<span class="hljs-comment">;</span>
             }
 ​
             // 解析 claims（如果有）
             Map&lt;String, Object&gt; <span class="hljs-attr">claims</span> = null<span class="hljs-comment">;</span>
             if (accessTokenNode.has("claims")) {
                 <span class="hljs-attr">claims</span> = mapper.treeToValue(accessTokenNode.get(<span class="hljs-string">"claims"</span>), Map.class)<span class="hljs-comment">;</span>
             } else if (metadata.containsKey(OAuth2Authorization.Token.CLAIMS_METADATA_NAME)) {
                 <span class="hljs-attr">claims</span> = (Map&lt;String, Object&gt;) metadata.get(OAuth2Authorization.Token.CLAIMS_METADATA_NAME)<span class="hljs-comment">;</span>
             }
 ​
             // 关键：正确调用 token 方法
             if (claims != null) {
                 Map&lt;String, Object&gt; <span class="hljs-attr">finalClaims</span> = claims<span class="hljs-comment">;</span>
                 Map&lt;String, Object&gt; <span class="hljs-attr">finalMetadata</span> = metadata<span class="hljs-comment">;</span>
                 builder.token(accessToken, meta -&gt; {
                     meta.putAll(finalMetadata)<span class="hljs-comment">;  // 先放原有 metadata</span>
                     meta.put(OAuth2Authorization.Token.CLAIMS_METADATA_NAME, finalClaims)<span class="hljs-comment">;</span>
                 })<span class="hljs-comment">;</span>
             } else {
                 Map&lt;String, Object&gt; <span class="hljs-attr">finalMetadata</span> = metadata<span class="hljs-comment">;</span>
                 builder.token(accessToken, meta -&gt; meta.putAll(finalMetadata))<span class="hljs-comment">;</span>
             }
         }
 ​
         if (root.has("refreshToken")) {
             JsonNode <span class="hljs-attr">refreshTokenNode</span> = root.get(<span class="hljs-string">"refreshToken"</span>)<span class="hljs-comment">;</span>
             JsonNode <span class="hljs-attr">tokenNode</span> = refreshTokenNode.get(<span class="hljs-string">"token"</span>)<span class="hljs-comment">;</span>
 ​
             String <span class="hljs-attr">tokenValue</span> = tokenNode.get(<span class="hljs-string">"tokenValue"</span>).asText()<span class="hljs-comment">;</span>
             Instant <span class="hljs-attr">issuedAt</span> = tokenNode.has(<span class="hljs-string">"issuedAt"</span>) ? Instant.parse(tokenNode.get(<span class="hljs-string">"issuedAt"</span>).asText()) : null<span class="hljs-comment">;</span>
             Instant <span class="hljs-attr">expiresAt</span> = tokenNode.has(<span class="hljs-string">"expiresAt"</span>) ? Instant.parse(tokenNode.get(<span class="hljs-string">"expiresAt"</span>).asText()) : null<span class="hljs-comment">;</span>
 ​
             OAuth2RefreshToken <span class="hljs-attr">refreshToken</span> = new OAuth2RefreshToken(tokenValue, issuedAt, expiresAt)<span class="hljs-comment">;</span>
 ​
             Map&lt;String, Object&gt; <span class="hljs-attr">metadata</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
             if (refreshTokenNode.has("metadata")) {
                 <span class="hljs-attr">metadata</span> = mapper.treeToValue(refreshTokenNode.get(<span class="hljs-string">"metadata"</span>), Map.class)<span class="hljs-comment">;</span>
             }
             Map&lt;String, Object&gt; <span class="hljs-attr">finalMetadata</span> = metadata<span class="hljs-comment">;</span>
             builder.token(refreshToken, meta -&gt; meta.putAll(finalMetadata))<span class="hljs-comment">;</span>
         }
         return builder.build()<span class="hljs-comment">;</span>
     }
 }
</code></pre>
</li>
</ul>

<ul>
<li>
<p><strong>SecurityJackson2Module</strong></p>
<p>在 Spring Security（包括 Boot 2.7 和 3.x）里，用户权限是用 SimpleGrantedAuthority 表示的：</p>
<p>Java</p>
<pre><code class="hljs language-arduino" lang="arduino"> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SimpleGrantedAuthority</span>(<span class="hljs-string">"ROLE_ADMIN"</span>)
</code></pre>
<p>这个类长这样（简化版）：</p>
<p>Java</p>
<pre><code class="hljs language-arduino" lang="arduino"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleGrantedAuthority</span> implements GrantedAuthority {
     <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> authority;  <span class="hljs-comment">// 只有这个字段，没有 setter！</span>
 ​
     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SimpleGrantedAuthority</span><span class="hljs-params">(<span class="hljs-type">String</span> authority)</span> </span>{
         <span class="hljs-keyword">this</span>.authority = authority;
     }
 ​
     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getAuthority</span><span class="hljs-params">()</span> </span>{
         <span class="hljs-keyword">return</span> authority;
     }
 }
</code></pre>
<p>关键点：</p>
<ul>
<li><strong>没有无参构造函数</strong></li>
<li><strong>没有 setter</strong></li>
<li><strong>只有 getter</strong></li>
</ul>
<p>当你用 Redis + JSON 序列化存用户权限（Session 或 OAuth2Authorization）时，JSON 会变成：</p>
<p>JSON</p>
<pre><code class="hljs language-less" lang="less"> {
   "<span class="hljs-variable">@class</span><span class="hljs-string">": "</span>org.springframework.security.core.authority.SimpleGrantedAuthority",
   <span class="hljs-string">"authority"</span>: <span class="hljs-string">"ROLE_ADMIN"</span>
 }
</code></pre>
<p>Jackson 反序列化时傻眼了：</p>
<ul>
<li>找不到无参构造函数 → 报 no Creators, like default constructor, exist</li>
<li>找不到 setter → 不知道怎么设置 authority 字段</li>
</ul>
<p>结果：权限读不出来 → 用户登录后权限为空 → 接口 403 → 业务全炸！</p>
<p><strong>完整的代码</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"> <span class="hljs-keyword">import</span> com.fasterxml.jackson.core.<span class="hljs-type">JsonParser</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.core.<span class="hljs-type">JsonToken</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-type">DeserializationContext</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-type">JsonNode</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.deser.std.<span class="hljs-type">StdDeserializer</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.module.<span class="hljs-type">SimpleModule</span>;
 <span class="hljs-keyword">import</span> org.springframework.security.core.authority.<span class="hljs-type">SimpleGrantedAuthority</span>;
 ​
 <span class="hljs-keyword">import</span> java.io.<span class="hljs-type">IOException</span>;
 ​
 public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityJackson2Module</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleModule</span> </span>{
 ​
     public <span class="hljs-type">SecurityJackson2Module</span>() {
         <span class="hljs-keyword">super</span>();
         <span class="hljs-comment">// 同时兼容 Spring Boot 2.7 和 3.x 的 SimpleGrantedAuthority 反序列化</span>
         addDeserializer(<span class="hljs-type">SimpleGrantedAuthority</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleGrantedAuthorityDeserializer</span>());
     }
 ​
     static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleGrantedAuthorityDeserializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StdDeserializer&lt;SimpleGrantedAuthority&gt;</span> </span>{
 ​
         public <span class="hljs-type">SimpleGrantedAuthorityDeserializer</span>() {
             <span class="hljs-keyword">super</span>(<span class="hljs-type">SimpleGrantedAuthority</span>.<span class="hljs-keyword">class</span>);
         }
 ​
         <span class="hljs-meta">@Override</span>
         public <span class="hljs-type">SimpleGrantedAuthority</span> deserialize(<span class="hljs-type">JsonParser</span> p, <span class="hljs-type">DeserializationContext</span> ctxt)
                 <span class="hljs-keyword">throws</span> <span class="hljs-type">IOException</span> {
             <span class="hljs-comment">// 支持两种格式：{"authority":"ROLE_ADMIN"} 或 直接字符串 "ROLE_ADMIN"</span>
             <span class="hljs-keyword">if</span> (p.currentToken() == <span class="hljs-type">JsonToken</span>.<span class="hljs-type">VALUE_STRING</span>) {
                 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleGrantedAuthority</span>(p.getText());
             }
 ​
             <span class="hljs-type">JsonNode</span> node = p.getCodec().readTree(p);
             <span class="hljs-type">String</span> authority = <span class="hljs-literal">null</span>;
             <span class="hljs-keyword">if</span> (node.isTextual()) {
                 authority = node.asText();
             } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.has(<span class="hljs-string">"authority"</span>)) {
                 authority = node.get(<span class="hljs-string">"authority"</span>).asText();
             }
             <span class="hljs-keyword">return</span> authority != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleGrantedAuthority</span>(authority) : <span class="hljs-literal">null</span>;
         }
     }
 }
</code></pre>
</li>
</ul>

<ul>
<li>
<p>OAuth2LegacyJacksonModule</p>
<p>这个 OAuth2LegacyJacksonModule 才是我整个序列化大战的“救命稻草”！没有它，Boot 2.7 认证中心读 Redis 里的 OAuth2 数据，直接原地爆炸😂</p>
<p><strong>核心问题（老 Authorization Server 的“遗产坑”）</strong></p>
<p>在老版本 spring-security-oauth2-authorization-server（0.2.x/0.4.x）里，几个关键类序列化格式超级“任性”：</p>
<ol>
<li>
<p>ClientAuthenticationMethod</p>
<ul>
<li>Boot 2.7 存的是字符串 "client_secret_basic"</li>
<li>Boot 3.2 存的是对象 {"value": "client_secret_basic"}</li>
<li>Boot 2.7 读 Boot 3.2 的数据 → Cannot construct instance (no delegate- or property-based Creator)</li>
</ul>
</li>
<li>
<p>AuthorizationGrantType</p>
<ul>
<li>同上，字符串 vs {"value": "..."} → 炸！</li>
</ul>
</li>
<li>
<p>ClientSettings / TokenSettings</p>
<ul>
<li>Boot 3.2 是 record（无默认构造函数）</li>
<li>Boot 2.7 读到 → no Creators, like default constructor, exist</li>
</ul>
</li>
<li>
<p>老版本遗留字段 "settings"</p>
<ul>
<li>早期版本有 "settings" 字段，后来拆成 clientSettings + tokenSettings</li>
<li>新代码读老数据 → Unrecognized field "settings"</li>
</ul>
</li>
</ol>
<p>结果：登录 → 登出 → 再登录，必炸！（因为登出清 Session，重新读 Redis 里的 RegisteredClient/OAuth2Authorization）</p>
<pre><code class="hljs language-scala" lang="scala"> <span class="hljs-keyword">import</span> com.fasterxml.jackson.core.<span class="hljs-type">JsonParser</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-type">DeserializationContext</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.<span class="hljs-type">JsonNode</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.deser.std.<span class="hljs-type">StdDeserializer</span>;
 <span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.module.<span class="hljs-type">SimpleModule</span>;
 <span class="hljs-keyword">import</span> org.springframework.security.oauth2.core.<span class="hljs-type">AuthorizationGrantType</span>;
 <span class="hljs-keyword">import</span> org.springframework.security.oauth2.core.<span class="hljs-type">ClientAuthenticationMethod</span>;
 <span class="hljs-keyword">import</span> org.springframework.security.oauth2.server.authorization.settings.<span class="hljs-type">ClientSettings</span>;
 <span class="hljs-keyword">import</span> org.springframework.security.oauth2.server.authorization.settings.<span class="hljs-type">OAuth2TokenFormat</span>;
 <span class="hljs-keyword">import</span> org.springframework.security.oauth2.server.authorization.settings.<span class="hljs-type">TokenSettings</span>;
 ​
 <span class="hljs-keyword">import</span> java.io.<span class="hljs-type">IOException</span>;
 <span class="hljs-keyword">import</span> java.time.<span class="hljs-type">Duration</span>;
 ​
 public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OAuth2LegacyJacksonModule</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleModule</span> </span>{
 ​
         public <span class="hljs-type">OAuth2LegacyJacksonModule</span>() {
             addDeserializer(<span class="hljs-type">ClientAuthenticationMethod</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">ClientAuthenticationMethodDeserializer</span>());
             addDeserializer(<span class="hljs-type">AuthorizationGrantType</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">AuthorizationGrantTypeDeserializer</span>());
 ​
             <span class="hljs-comment">// 新增这两行，专治 ClientSettings 和 TokenSettings（Boot3 record 格式）</span>
             addDeserializer(<span class="hljs-type">ClientSettings</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">ClientSettingsDeserializer</span>());
             addDeserializer(<span class="hljs-type">TokenSettings</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">TokenSettingsDeserializer</span>());
         }
 ​
         <span class="hljs-comment">// ... 你之前已有的两个 Deserializer 不变 ...</span>
 ​
         <span class="hljs-comment">// 新增：兼容 Boot3 存的 ClientSettings</span>
         static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientSettingsDeserializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StdDeserializer&lt;ClientSettings&gt;</span> </span>{
             public <span class="hljs-type">ClientSettingsDeserializer</span>() {
                 <span class="hljs-keyword">super</span>(<span class="hljs-type">ClientSettings</span>.<span class="hljs-keyword">class</span>);
             }
 ​
             <span class="hljs-meta">@Override</span>
             public <span class="hljs-type">ClientSettings</span> deserialize(<span class="hljs-type">JsonParser</span> p, <span class="hljs-type">DeserializationContext</span> ctxt) <span class="hljs-keyword">throws</span> <span class="hljs-type">IOException</span> {
                 <span class="hljs-type">JsonNode</span> node = p.getCodec().readTree(p);
                 <span class="hljs-comment">// Boot3 默认值：requireProofKey=false, requireAuthorizationConsent=true</span>
                 boolean requireProofKey = node.has(<span class="hljs-string">"requireProofKey"</span>) &amp;&amp; node.get(<span class="hljs-string">"requireProofKey"</span>).asBoolean();
                 boolean requireAuthorizationConsent = node.has(<span class="hljs-string">"requireAuthorizationConsent"</span>) ?
                         node.get(<span class="hljs-string">"requireAuthorizationConsent"</span>).asBoolean() : <span class="hljs-literal">true</span>;
 ​
                 <span class="hljs-keyword">return</span> <span class="hljs-type">ClientSettings</span>.builder()
                         .requireProofKey(requireProofKey)
                         .requireAuthorizationConsent(requireAuthorizationConsent)
                         .build();
             }
             <span class="hljs-meta">@Override</span>
             public <span class="hljs-type">ClientSettings</span> getNullValue(<span class="hljs-type">DeserializationContext</span> ctxt) {
                 <span class="hljs-keyword">return</span> <span class="hljs-type">ClientSettings</span>.builder()
                         .requireAuthorizationConsent(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 你项目大多数情况都是 true</span>
                         .requireProofKey(<span class="hljs-literal">false</span>)
                         .build();
             }
         }
 ​
         <span class="hljs-comment">// 新增：兼容 Boot3 存的 TokenSettings</span>
         static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenSettingsDeserializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StdDeserializer&lt;TokenSettings&gt;</span> </span>{
             public <span class="hljs-type">TokenSettingsDeserializer</span>() {
                 <span class="hljs-keyword">super</span>(<span class="hljs-type">TokenSettings</span>.<span class="hljs-keyword">class</span>);
             }
 ​
             <span class="hljs-meta">@Override</span>
             public <span class="hljs-type">TokenSettings</span> deserialize(<span class="hljs-type">JsonParser</span> p, <span class="hljs-type">DeserializationContext</span> ctxt) <span class="hljs-keyword">throws</span> <span class="hljs-type">IOException</span> {
                 <span class="hljs-type">JsonNode</span> node = p.getCodec().readTree(p);
                 <span class="hljs-type">TokenSettings</span>.<span class="hljs-type">Builder</span> builder = <span class="hljs-type">TokenSettings</span>.builder();
 ​
                 <span class="hljs-comment">// 1. accessTokenFormat：你代码里设的是 REFERENCE（不透明令牌）</span>
                 <span class="hljs-comment">//    Boot3 默认是 SELF_CONTAINED（JWT），所以必须显式处理</span>
                 <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span> &amp;&amp; node.has(<span class="hljs-string">"accessTokenFormat"</span>)) {
                     <span class="hljs-type">JsonNode</span> formatNode = node.get(<span class="hljs-string">"accessTokenFormat"</span>);
                     <span class="hljs-keyword">if</span> (formatNode.has(<span class="hljs-string">"value"</span>)) {
                         <span class="hljs-type">String</span> value = formatNode.get(<span class="hljs-string">"value"</span>).asText();
                         <span class="hljs-keyword">if</span> (<span class="hljs-string">"reference"</span>.equalsIgnoreCase(value)) {
                             builder.accessTokenFormat(<span class="hljs-type">OAuth2TokenFormat</span>.<span class="hljs-type">REFERENCE</span>);
                         } <span class="hljs-keyword">else</span> {
                             builder.accessTokenFormat(<span class="hljs-type">OAuth2TokenFormat</span>.<span class="hljs-type">SELF_CONTAINED</span>);
                         }
                     }
                 } <span class="hljs-keyword">else</span> {
                     <span class="hljs-comment">// 默认跟你代码保持一致：REFERENCE（大部分资源服务器 + Redis 存储都用这个）</span>
                     builder.accessTokenFormat(<span class="hljs-type">OAuth2TokenFormat</span>.<span class="hljs-type">REFERENCE</span>);
                 }
 ​
                 <span class="hljs-comment">// 2. accessTokenTimeToLive</span>
                 <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span> &amp;&amp; node.has(<span class="hljs-string">"accessTokenTimeToLive"</span>)) {
                     long seconds = node.get(<span class="hljs-string">"accessTokenTimeToLive"</span>).asLong();
                     builder.accessTokenTimeToLive(<span class="hljs-type">Duration</span>.ofSeconds(seconds));
                 } <span class="hljs-keyword">else</span> {
                     <span class="hljs-comment">// 给一个兜底默认值（比如 1 小时），防止 null</span>
                     builder.accessTokenTimeToLive(<span class="hljs-type">Duration</span>.ofHours(<span class="hljs-number">1</span>));
                 }
 ​
                 <span class="hljs-comment">// 3. refreshTokenTimeToLive</span>
                 <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span> &amp;&amp; node.has(<span class="hljs-string">"refreshTokenTimeToLive"</span>)) {
                     long seconds = node.get(<span class="hljs-string">"refreshTokenTimeToLive"</span>).asLong();
                     builder.refreshTokenTimeToLive(<span class="hljs-type">Duration</span>.ofSeconds(seconds));
                 } <span class="hljs-keyword">else</span> {
                     builder.refreshTokenTimeToLive(<span class="hljs-type">Duration</span>.ofDays(<span class="hljs-number">30</span>)); <span class="hljs-comment">// 常见默认值</span>
                 }
 ​
                 <span class="hljs-comment">// 你如果还设置了 reuseRefreshTokens、idTokenSignatureAlgorithm 等，继续加即可</span>
 ​
                 <span class="hljs-keyword">return</span> builder.build();
             }
 ​
             <span class="hljs-comment">// 关键：即使 Redis 里完全没有 tokenSettings 字段，也要返回一个有效的默认实例！</span>
             <span class="hljs-meta">@Override</span>
             public <span class="hljs-type">TokenSettings</span> getNullValue(<span class="hljs-type">DeserializationContext</span> ctxt) {
                 <span class="hljs-keyword">return</span> <span class="hljs-type">TokenSettings</span>.builder()
                         .accessTokenFormat(<span class="hljs-type">OAuth2TokenFormat</span>.<span class="hljs-type">REFERENCE</span>)  <span class="hljs-comment">// 跟你代码保持一致</span>
                         .accessTokenTimeToLive(<span class="hljs-type">Duration</span>.ofHours(<span class="hljs-number">1</span>))
                         .refreshTokenTimeToLive(<span class="hljs-type">Duration</span>.ofDays(<span class="hljs-number">30</span>))
                         .build();
             }
         }
 ​
         <span class="hljs-comment">// 你之前已有的两个保持不变</span>
         static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientAuthenticationMethodDeserializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StdDeserializer&lt;ClientAuthenticationMethod&gt;</span> </span>{
             public <span class="hljs-type">ClientAuthenticationMethodDeserializer</span>() { <span class="hljs-keyword">super</span>(<span class="hljs-type">ClientAuthenticationMethod</span>.<span class="hljs-keyword">class</span>); }
             <span class="hljs-meta">@Override</span> public <span class="hljs-type">ClientAuthenticationMethod</span> deserialize(<span class="hljs-type">JsonParser</span> p, <span class="hljs-type">DeserializationContext</span> ctxt) <span class="hljs-keyword">throws</span> <span class="hljs-type">IOException</span> {
                 <span class="hljs-type">JsonNode</span> node = p.getCodec().readTree(p);
                 <span class="hljs-type">String</span> value = node.isTextual() ? node.asText() : node.get(<span class="hljs-string">"value"</span>).asText();
                 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ClientAuthenticationMethod</span>(value);
             }
         }
 ​
         static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizationGrantTypeDeserializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StdDeserializer&lt;AuthorizationGrantType&gt;</span> </span>{
             public <span class="hljs-type">AuthorizationGrantTypeDeserializer</span>() { <span class="hljs-keyword">super</span>(<span class="hljs-type">AuthorizationGrantType</span>.<span class="hljs-keyword">class</span>); }
             <span class="hljs-meta">@Override</span> public <span class="hljs-type">AuthorizationGrantType</span> deserialize(<span class="hljs-type">JsonParser</span> p, <span class="hljs-type">DeserializationContext</span> ctxt) <span class="hljs-keyword">throws</span> <span class="hljs-type">IOException</span> {
                 <span class="hljs-type">JsonNode</span> node = p.getCodec().readTree(p);
                 <span class="hljs-type">String</span> value = node.isTextual() ? node.asText() : node.get(<span class="hljs-string">"value"</span>).asText();
                 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">AuthorizationGrantType</span>(value);
             }
         }
 }
</code></pre>
</li>
<li>
<p>oAuth2AuthorizationRedisTemplate</p>
<p>为了不影响其他的业务信息，创建一个认证用的RedisTemplate,与认证相关的都用这个，原来的那些业务不变，当然如果你想要都使用json来保存业务数据也是可以的，按需来操作！</p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-comment">/**
      * 主要用于存储 OAuth2Authorization，对授权的json序列化
      * <span class="hljs-doctag">@param</span> <span class="hljs-variable">publicJsonRedisSerializer</span>
      * <span class="hljs-doctag">@param</span> <span class="hljs-variable">redisConnectionFactory</span>
      * <span class="hljs-doctag">@return</span>
      */</span>
     <span class="hljs-meta">@Bean</span>
     <span class="hljs-keyword">public</span> <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; <span class="hljs-title function_">oAuth2AuthorizationRedisTemplate</span>(<span class="hljs-params">RedisSerializer&lt;<span class="hljs-built_in">Object</span>&gt; publicJsonRedisSerializer, RedisConnectionFactory redisConnectionFactory</span>) {
         <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();
         redisTemplate.<span class="hljs-title function_">setKeySerializer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
         redisTemplate.<span class="hljs-title function_">setHashKeySerializer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
         redisTemplate.<span class="hljs-title function_">setValueSerializer</span>(publicJsonRedisSerializer);
         redisTemplate.<span class="hljs-title function_">setHashValueSerializer</span>(publicJsonRedisSerializer);
         redisTemplate.<span class="hljs-title function_">setConnectionFactory</span>(redisConnectionFactory);
         <span class="hljs-keyword">return</span> redisTemplate;
     }
</code></pre>
<p>重要，这边使用setValueSerializer与setHashValueSerializer都使用publicJsonRedisSerializer。</p>
</li>
<li>
<p>RedisOAuth2AuthorizationService</p>
<p>修改自己的redis认证服务类，我的可能跟大家的不一样，按照自己的来！下面仅供参考！</p>
<p><img src="" alt="image-20251230171343623" loading="lazy"/></p>
</li>
</ul>

<ul>
<li>
<p>自定义Provider</p>
<pre><code class="hljs language-ini" lang="ini"> import org.apache.commons.logging.Log<span class="hljs-comment">;</span>
 import org.apache.commons.logging.LogFactory<span class="hljs-comment">;</span>
 import org.springframework.security.authentication.AuthenticationProvider<span class="hljs-comment">;</span>
 import org.springframework.security.authentication.UsernamePasswordAuthenticationToken<span class="hljs-comment">;</span>
 import org.springframework.security.core.Authentication<span class="hljs-comment">;</span>
 import org.springframework.security.core.AuthenticationException<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.core.*<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.core.oidc.OidcIdToken<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.core.oidc.OidcScopes<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.core.oidc.endpoint.OidcParameterNames<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.jwt.Jwt<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.OAuth2Authorization<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.OAuth2AuthorizationService<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.OAuth2TokenType<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.authentication.OAuth2AccessTokenAuthenticationToken<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.authentication.OAuth2ClientAuthenticationToken<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.authentication.OAuth2RefreshTokenAuthenticationToken<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.client.RegisteredClient<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.context.AuthorizationServerContextHolder<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.token.DefaultOAuth2TokenContext<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.token.OAuth2TokenContext<span class="hljs-comment">;</span>
 import org.springframework.security.oauth2.server.authorization.token.OAuth2TokenGenerator<span class="hljs-comment">;</span>
 import org.springframework.util.Assert<span class="hljs-comment">;</span>
 ​
 import java.util.Collections<span class="hljs-comment">;</span>
 import java.util.HashMap<span class="hljs-comment">;</span>
 import java.util.Map<span class="hljs-comment">;</span>
 import java.util.Set<span class="hljs-comment">;</span>
 ​
 ​
 public class OAuth2RefreshTokenAuthenticationProvider implements AuthenticationProvider {
     private static final String <span class="hljs-attr">ERROR_URI</span> = <span class="hljs-string">"https://datatracker.ietf.org/doc/html/rfc6749#section-5.2"</span><span class="hljs-comment">;</span>
     private static final OAuth2TokenType <span class="hljs-attr">ID_TOKEN_TOKEN_TYPE</span> = new OAuth2TokenType(OidcParameterNames.ID_TOKEN)<span class="hljs-comment">;</span>
     private final Log <span class="hljs-attr">logger</span> = LogFactory.getLog(getClass())<span class="hljs-comment">;</span>
     private final OAuth2AuthorizationService authorizationService<span class="hljs-comment">;</span>
     private final OAuth2TokenGenerator&lt;? extends OAuth2Token&gt; tokenGenerator<span class="hljs-comment">;</span>
     private final UserDetailsService userDetailsService<span class="hljs-comment">;</span>
     /**
      * Constructs an {@code OAuth2RefreshTokenAuthenticationProvider} using the provided parameters.
      *
      * @param authorizationService the authorization service
      * @param tokenGenerator       the token generator
      * @since 0.2.3
      */
     public OAuth2RefreshTokenAuthenticationProvider(OAuth2AuthorizationService authorizationService,
                                                     OAuth2TokenGenerator&lt;? extends OAuth2Token&gt; tokenGenerator,
                                                         UserDetailsService userDetailsService) {
         Assert.notNull(authorizationService, "authorizationService cannot be null")<span class="hljs-comment">;</span>
         Assert.notNull(tokenGenerator, "tokenGenerator cannot be null")<span class="hljs-comment">;</span>
         <span class="hljs-attr">this.authorizationService</span> = authorizationService<span class="hljs-comment">;</span>
         <span class="hljs-attr">this.tokenGenerator</span> = tokenGenerator<span class="hljs-comment">;</span>
         <span class="hljs-attr">this.userDetailsService</span> = userDetailsService<span class="hljs-comment">;</span>
     }
 ​
     @Override
     public Authentication authenticate(Authentication authentication) throws AuthenticationException {
         OAuth2RefreshTokenAuthenticationToken <span class="hljs-attr">refreshTokenAuthentication</span> =
                 (OAuth2RefreshTokenAuthenticationToken) authentication<span class="hljs-comment">;</span>
 ​
         OAuth2ClientAuthenticationToken <span class="hljs-attr">clientPrincipal</span> =
                 OAuth2AuthenticationProviderUtils.getAuthenticatedClientElseThrowInvalidClient(refreshTokenAuthentication)<span class="hljs-comment">;</span>
         RegisteredClient <span class="hljs-attr">registeredClient</span> = clientPrincipal.getRegisteredClient()<span class="hljs-comment">;</span>
 ​
         if (this.logger.isTraceEnabled()) {
             this.logger.trace("Retrieved registered client")<span class="hljs-comment">;</span>
         }
 ​
         OAuth2Authorization <span class="hljs-attr">authorization</span> = this.authorizationService.findByToken(
                 refreshTokenAuthentication.getRefreshToken(), OAuth2TokenType.REFRESH_TOKEN)<span class="hljs-comment">;</span>
         if (<span class="hljs-attr">authorization</span> == null) {
             throw new OAuth2AuthenticationException(OAuth2ErrorCodes.INVALID_GRANT)<span class="hljs-comment">;</span>
         }
 ​
         if (this.logger.isTraceEnabled()) {
             this.logger.trace("Retrieved authorization with refresh token")<span class="hljs-comment">;</span>
         }
 ​
         if (!registeredClient.getId().equals(authorization.getRegisteredClientId())) {
             throw new OAuth2AuthenticationException(OAuth2ErrorCodes.INVALID_CLIENT)<span class="hljs-comment">;</span>
         }
 ​
         if (!registeredClient.getAuthorizationGrantTypes().contains(AuthorizationGrantType.REFRESH_TOKEN)) {
             throw new OAuth2AuthenticationException(OAuth2ErrorCodes.UNAUTHORIZED_CLIENT)<span class="hljs-comment">;</span>
         }
 ​
         OAuth2Authorization.Token&lt;OAuth2RefreshToken&gt; <span class="hljs-attr">refreshToken</span> = authorization.getRefreshToken()<span class="hljs-comment">;</span>
         if (!refreshToken.isActive()) {
             // As per https://tools.ietf.org/html/rfc6749<span class="hljs-comment">#section-5.2</span>
             // invalid_grant: The provided authorization grant (e.g., authorization code,
             // resource owner credentials) or refresh token is invalid, expired, revoked <span class="hljs-section">[...]</span>.
             throw new OAuth2AuthenticationException(OAuth2ErrorCodes.INVALID_GRANT)<span class="hljs-comment">;</span>
         }
 ​
         // As per https://tools.ietf.org/html/rfc6749<span class="hljs-comment">#section-6</span>
         // The requested scope MUST NOT include any scope not originally granted by the resource owner,
         // and if omitted is treated as equal to the scope originally granted by the resource owner.
         Set&lt;String&gt; <span class="hljs-attr">scopes</span> = refreshTokenAuthentication.getScopes()<span class="hljs-comment">;</span>
         Set&lt;String&gt; <span class="hljs-attr">authorizedScopes</span> = authorization.getAuthorizedScopes()<span class="hljs-comment">;</span>
         if (!authorizedScopes.containsAll(scopes)) {
             throw new OAuth2AuthenticationException(OAuth2ErrorCodes.INVALID_SCOPE)<span class="hljs-comment">;</span>
         }
 ​
         if (this.logger.isTraceEnabled()) {
             this.logger.trace("Validated token request parameters")<span class="hljs-comment">;</span>
         }
 ​
         if (scopes.isEmpty()) {
             <span class="hljs-attr">scopes</span> = authorizedScopes<span class="hljs-comment">;</span>
         }
 ​
 //        AuthenticationManager <span class="hljs-attr">authenticationManager</span> = http.getSharedObject(AuthenticationManager.class)<span class="hljs-comment">;</span>
 //        Authentication <span class="hljs-attr">usernamePasswordAuthentication</span> = authenticationManager
 //                .authenticate(new UsernamePasswordAuthenticationToken(authorization.getPrincipalName(),null))<span class="hljs-comment">;</span>
         //需要直接获取到登录用户信息
         String <span class="hljs-attr">principalName</span> = authorization.getPrincipalName()<span class="hljs-comment">;</span>
         User <span class="hljs-attr">user</span> = (User) userDetailsService.loadUserByUsername(principalName)<span class="hljs-comment">;</span>
         Authentication <span class="hljs-attr">principalAuth</span> = new UsernamePasswordAuthenticationToken(user, null, user.getAuthorities())<span class="hljs-comment">;</span>
         // @formatter:off
         DefaultOAuth2TokenContext.Builder <span class="hljs-attr">tokenContextBuilder</span> = DefaultOAuth2TokenContext.builder()
                 .registeredClient(registeredClient)
                 .principal(principalAuth)
                 .authorizationServerContext(AuthorizationServerContextHolder.getContext())
                 .authorization(authorization)
                 .authorizedScopes(scopes)
                 .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)
                 .authorizationGrant(refreshTokenAuthentication)<span class="hljs-comment">;</span>
         // @formatter:on
 ​
         OAuth2Authorization.Builder <span class="hljs-attr">authorizationBuilder</span> = OAuth2Authorization.from(authorization)<span class="hljs-comment">;</span>
 ​
         // ----- Access token -----
         OAuth2TokenContext <span class="hljs-attr">tokenContext</span> = tokenContextBuilder.tokenType(OAuth2TokenType.ACCESS_TOKEN).build()<span class="hljs-comment">;</span>
         OAuth2Token <span class="hljs-attr">generatedAccessToken</span> = this.tokenGenerator.generate(tokenContext)<span class="hljs-comment">;</span>
         if (<span class="hljs-attr">generatedAccessToken</span> == null) {
             OAuth2Error <span class="hljs-attr">error</span> = new OAuth2Error(OAuth2ErrorCodes.SERVER_ERROR,
                     "The token generator failed to generate the access token.", ERROR_URI)<span class="hljs-comment">;</span>
             throw new OAuth2AuthenticationException(error)<span class="hljs-comment">;</span>
         }
 ​
         if (this.logger.isTraceEnabled()) {
             this.logger.trace("Generated access token")<span class="hljs-comment">;</span>
         }
 ​
         OAuth2AccessToken <span class="hljs-attr">accessToken</span> = new OAuth2AccessToken(OAuth2AccessToken.TokenType.BEARER,
                 generatedAccessToken.getTokenValue(), generatedAccessToken.getIssuedAt(),
                 generatedAccessToken.getExpiresAt(), tokenContext.getAuthorizedScopes())<span class="hljs-comment">;</span>
         if (generatedAccessToken instanceof ClaimAccessor) {
             authorizationBuilder.token(accessToken, (metadata) -&gt; {
                 metadata.put(OAuth2Authorization.Token.CLAIMS_METADATA_NAME, ((ClaimAccessor) generatedAccessToken).getClaims())<span class="hljs-comment">;</span>
                 metadata.put(OAuth2Authorization.Token.INVALIDATED_METADATA_NAME, false)<span class="hljs-comment">;</span>
             })<span class="hljs-comment">;</span>
         } else {
             authorizationBuilder.accessToken(accessToken)<span class="hljs-comment">;</span>
         }
 ​
         // ----- Refresh token -----
         OAuth2RefreshToken <span class="hljs-attr">currentRefreshToken</span> = refreshToken.getToken()<span class="hljs-comment">;</span>
         if (!registeredClient.getTokenSettings().isReuseRefreshTokens()) {
             <span class="hljs-attr">tokenContext</span> = tokenContextBuilder.tokenType(OAuth2TokenType.REFRESH_TOKEN).build()<span class="hljs-comment">;</span>
             OAuth2Token <span class="hljs-attr">generatedRefreshToken</span> = this.tokenGenerator.generate(tokenContext)<span class="hljs-comment">;</span>
             if (!(generatedRefreshToken instanceof OAuth2RefreshToken)) {
                 OAuth2Error <span class="hljs-attr">error</span> = new OAuth2Error(OAuth2ErrorCodes.SERVER_ERROR,
                         "The token generator failed to generate the refresh token.", ERROR_URI)<span class="hljs-comment">;</span>
                 throw new OAuth2AuthenticationException(error)<span class="hljs-comment">;</span>
             }
 ​
             if (this.logger.isTraceEnabled()) {
                 this.logger.trace("Generated refresh token")<span class="hljs-comment">;</span>
             }
 ​
             <span class="hljs-attr">currentRefreshToken</span> = (OAuth2RefreshToken) generatedRefreshToken<span class="hljs-comment">;</span>
             authorizationBuilder.refreshToken(currentRefreshToken)<span class="hljs-comment">;</span>
         }
 ​
         // ----- ID token -----
         OidcIdToken idToken<span class="hljs-comment">;</span>
         if (authorizedScopes.contains(OidcScopes.OPENID)) {
             // @formatter:off
             <span class="hljs-attr">tokenContext</span> = tokenContextBuilder
                     .tokenType(ID_TOKEN_TOKEN_TYPE)
                     .authorization(authorizationBuilder.build())    // ID token customizer may need access to the access token and/or refresh token
                     .build()<span class="hljs-comment">;</span>
             // @formatter:on
             OAuth2Token <span class="hljs-attr">generatedIdToken</span> = this.tokenGenerator.generate(tokenContext)<span class="hljs-comment">;</span>
             if (!(generatedIdToken instanceof Jwt)) {
                 OAuth2Error <span class="hljs-attr">error</span> = new OAuth2Error(OAuth2ErrorCodes.SERVER_ERROR,
                         "The token generator failed to generate the ID token.", ERROR_URI)<span class="hljs-comment">;</span>
                 throw new OAuth2AuthenticationException(error)<span class="hljs-comment">;</span>
             }
 ​
             if (this.logger.isTraceEnabled()) {
                 this.logger.trace("Generated id token")<span class="hljs-comment">;</span>
             }
 ​
             <span class="hljs-attr">idToken</span> = new OidcIdToken(generatedIdToken.getTokenValue(), generatedIdToken.getIssuedAt(),
                     generatedIdToken.getExpiresAt(), ((Jwt) generatedIdToken).getClaims())<span class="hljs-comment">;</span>
             authorizationBuilder.token(idToken, (metadata) -&gt;
                     metadata.put(OAuth2Authorization.Token.CLAIMS_METADATA_NAME, idToken.getClaims()))<span class="hljs-comment">;</span>
         } else {
             <span class="hljs-attr">idToken</span> = null<span class="hljs-comment">;</span>
         }
 ​
         <span class="hljs-attr">authorization</span> = authorizationBuilder.build()<span class="hljs-comment">;</span>
 ​
         this.authorizationService.save(authorization)<span class="hljs-comment">;</span>
 ​
         if (this.logger.isTraceEnabled()) {
             this.logger.trace("Saved authorization")<span class="hljs-comment">;</span>
         }
 ​
         Map&lt;String, Object&gt; <span class="hljs-attr">additionalParameters</span> = Collections.emptyMap()<span class="hljs-comment">;</span>
         if (idToken != null) {
             <span class="hljs-attr">additionalParameters</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
             additionalParameters.put(OidcParameterNames.ID_TOKEN, idToken.getTokenValue())<span class="hljs-comment">;</span>
         }
 ​
         if (this.logger.isTraceEnabled()) {
             this.logger.trace("Authenticated token request")<span class="hljs-comment">;</span>
         }
 ​
         return new OAuth2AccessTokenAuthenticationToken(
                 registeredClient, clientPrincipal, accessToken, currentRefreshToken, additionalParameters)<span class="hljs-comment">;</span>
     }
 ​
     @Override
     public boolean supports(Class&lt;?&gt; authentication) {
         return OAuth2RefreshTokenAuthenticationToken.class.isAssignableFrom(authentication)<span class="hljs-comment">;</span>
     }
 }
 ​
</code></pre>
</li>
<li>
<p>OAuth2AuthenticationProviderUtils</p>
<pre><code class="hljs language-scss" lang="scss"> import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.Authentication</span>;
 import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.oauth2</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.OAuth2AuthenticationException</span>;
 import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.oauth2</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.OAuth2ErrorCodes</span>;
 import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.oauth2</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.OAuth2RefreshToken</span>;
 import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.oauth2</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.OAuth2Token</span>;
 import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.oauth2</span><span class="hljs-selector-class">.server</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.OAuth2Authorization</span>;
 import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.oauth2</span><span class="hljs-selector-class">.server</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.OAuth2AuthorizationCode</span>;
 import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.oauth2</span><span class="hljs-selector-class">.server</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.authentication</span><span class="hljs-selector-class">.OAuth2ClientAuthenticationToken</span>;
 ​
 public class OAuth2AuthenticationProviderUtils {
     private <span class="hljs-built_in">OAuth2AuthenticationProviderUtils</span>() {
     }
 ​
     static OAuth2ClientAuthenticationToken <span class="hljs-built_in">getAuthenticatedClientElseThrowInvalidClient</span>(Authentication authentication) {
         OAuth2ClientAuthenticationToken clientPrincipal = null;
         if (OAuth2ClientAuthenticationToken.class.isAssignableFrom(authentication.getPrincipal()<span class="hljs-selector-class">.getClass</span>())) {
             clientPrincipal = (OAuth2ClientAuthenticationToken) authentication<span class="hljs-selector-class">.getPrincipal</span>();
         }
         if (clientPrincipal != null &amp;&amp; clientPrincipal.isAuthenticated()) {
             return clientPrincipal;
         }
         throw new <span class="hljs-built_in">OAuth2AuthenticationException</span>(OAuth2ErrorCodes.INVALID_CLIENT);
     }
 ​
     static &lt;T extends OAuth2Token&gt; OAuth2Authorization <span class="hljs-built_in">invalidate</span>(
             OAuth2Authorization authorization, T token) {
 ​
         <span class="hljs-comment">// @formatter:off</span>
         OAuth2Authorization<span class="hljs-selector-class">.Builder</span> authorizationBuilder = OAuth2Authorization<span class="hljs-selector-class">.from</span>(authorization)
                 <span class="hljs-selector-class">.token</span>(token,
                         (metadata) -&gt;
                                 metadata<span class="hljs-selector-class">.put</span>(OAuth2Authorization.Token.INVALIDATED_METADATA_NAME, true));
 ​
         if (OAuth2RefreshToken.class.isAssignableFrom(token.getClass())) {
             authorizationBuilder<span class="hljs-selector-class">.token</span>(
                     authorization.getAccessToken()<span class="hljs-selector-class">.getToken</span>(),
                     (metadata) -&gt;
                             metadata<span class="hljs-selector-class">.put</span>(OAuth2Authorization.Token.INVALIDATED_METADATA_NAME, true));
 ​
             OAuth2Authorization<span class="hljs-selector-class">.Token</span>&lt;OAuth2AuthorizationCode&gt; authorizationCode =
                     authorization<span class="hljs-selector-class">.getToken</span>(OAuth2AuthorizationCode.class);
             if (authorizationCode != null &amp;&amp; !authorizationCode.isInvalidated()) {
                 authorizationBuilder<span class="hljs-selector-class">.token</span>(
                         authorizationCode.getToken(),
                         (metadata) -&gt;
                                 metadata<span class="hljs-selector-class">.put</span>(OAuth2Authorization.Token.INVALIDATED_METADATA_NAME, true));
             }
         }
         <span class="hljs-comment">// @formatter:on</span>
 ​
         return authorizationBuilder<span class="hljs-selector-class">.build</span>();
     }
 }
</code></pre>
</li>
<li>
<p>AuthorizationServerConfiguration,任务服务的配置项，这个很重要，影响到token的刷新功能</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.apply</span>(authorizationServerConfigurer.<span class="hljs-built_in">tokenEndpoint</span>((tokenEndpoint) -&gt; {<span class="hljs-comment">// 个性化认证授权端点</span>
                     <span class="hljs-comment">//处理 OAuth2RefreshTokenAuthenticationToken 刷新令牌</span>
             OAuth2RefreshTokenAuthenticationProvider oAuth2RefreshTokenAuthenticationProvider = new <span class="hljs-built_in">OAuth2RefreshTokenAuthenticationProvider</span>(
                     authorizationService, <span class="hljs-built_in">oAuth2TokenGenerator</span>(),slkjUserDetailsService);
 ​
             tokenEndpoint.<span class="hljs-built_in">accessTokenRequestConverter</span>(<span class="hljs-built_in">accessTokenRequestConverter</span>()) <span class="hljs-comment">// 注入自定义的授权认证Converter</span>
                     .<span class="hljs-built_in">authenticationProviders</span>(providers -&gt; {
                         <span class="hljs-comment">// 移除默认的 OAuth2RefreshTokenAuthenticationProvider</span>
                         providers.<span class="hljs-built_in">removeIf</span>(p -&gt; p instanceof OAuth2RefreshTokenAuthenticationProvider);
                     })
                     .<span class="hljs-built_in">authenticationProvider</span>(slkjOAuth2RefreshTokenAuthenticationProvider)
                     .<span class="hljs-built_in">accessTokenResponseHandler</span>(successEventHandler) <span class="hljs-comment">// 登录成功处理器</span>
                     .<span class="hljs-built_in">errorResponseHandler</span>(failureEventHandler);<span class="hljs-comment">// 登录失败处理器</span>
         }).<span class="hljs-built_in">clientAuthentication</span>(oAuth2ClientAuthenticationConfigurer -&gt; <span class="hljs-comment">// 个性化客户端认证</span>
</code></pre>
<p>需要再这边添加OAuth2RefreshTokenAuthenticationProvider，然后移除默认的 OAuth2RefreshTokenAuthenticationProvider</p>
</li>
</ul>
<h3 data-id="heading-4">写在最后：给还在坑里的兄弟们</h3>
<ul>
<li><strong>统一 JSON 序列化</strong>，JDK 序列化跨版本必炸！</li>
<li><strong>清理脏数据</strong>，这是 90% 异常的元凶！</li>
<li><strong>别加太多自定义 Module</strong>，容易把自己玩死😂</li>
<li><strong>测试用 serializer.serialize() 存数据</strong>，别手写 JSON！</li>
<li>自定义 Provider 后，<strong>移除默认的Provider</strong>！</li>
</ul>
<p>如果你也在混用 Boot 2.7 和 3.2，赶紧收藏这篇！ 踩坑一个月，我哭了，你别哭了～,另外我的代码不一定跟您的一模一样，所以，仅供参考！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react hook注意事项]]></title>    <link>https://juejin.cn/post/7589462007527784482</link>    <guid>https://juejin.cn/post/7589462007527784482</guid>    <pubDate>2025-12-30T09:06:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589462007527784482" data-draft-id="7589308109640990755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react hook注意事项"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T09:06:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青瓜达利园"/> <meta itemprop="url" content="https://juejin.cn/user/4062065158258954"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react hook注意事项
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4062065158258954/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青瓜达利园
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:06:47.000Z" title="Tue Dec 30 2025 09:06:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写代码出错了，很少深入了解 hook。让ai给总结了一下。</p>
<p>这确实是 React 中非常核心且容易被忽视的“铁律”。React 的很多设计理念与传统的命令式编程（如 jQuery）或基于类的编程（Vue Options API）不太一样，因此有很多类似的“潜规则”和陷阱。</p>
<p>以下为您整理了 <strong>React 开发中必须知道的 6 个核心注意事项</strong>，掌握这些可以帮您避开 90% 的 Bug：</p>
<h3 data-id="heading-0">1. <code>useEffect</code> 依赖数组不能“撒谎” (Stale Closure / 闭包陷阱)</h3>
<p>这是 Hook 最容易出 Bug 的地方。如果你在 <code>useEffect</code> 或 <code>useCallback</code> 内部使用了某个变量，但没有把它加到依赖数组 <code>[]</code> 中，Hook 内部就会一直引用<strong>旧的变量值</strong>。</p>
<ul>
<li>
<p><strong>❌ 错误写法：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 永远打印 0！因为这里的 count 是闭包捕获的初始值</span>
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, []); <span class="hljs-comment">// 依赖数组是空的，导致 effect 只运行一次，内部永远拿着旧的 count</span>
</code></pre>
</li>
<li>
<p><strong>✅ 正确写法：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, [count]); <span class="hljs-comment">// 依赖 count，每次 count 变化，effect 会销毁旧的并重新运行</span>
</code></pre>
<p><em>或者使用函数式更新（如果不依赖外部变量触发 Effect）：</em></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>); <span class="hljs-comment">// 这种写法不需要依赖 count</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-1">2. State 更新是“异步”的（快照特性）</h3>
<p>调用 <code>setState</code> 后，状态<strong>不会</strong>立即改变。React 会把更新放入队列，等到下一次渲染时才会生效。</p>
<ul>
<li>
<p><strong>❌ 常见误区：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 打印的仍然是旧值！不是 +1 后的值</span>

  <span class="hljs-comment">// 如果此时发请求，发出去的也是旧值</span>
  <span class="hljs-title function_">fetchData</span>(count); 
};
</code></pre>
</li>
<li>
<p>✅ 正确理解：</p>
<p>如果你需要使用更新后的值，应该使用 useEffect 监听该值的变化，或者在 setState 中使用回调函数（仅用于计算新值）。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 这里才能拿到更新后的值</span>
  <span class="hljs-title function_">fetchData</span>(count);
}, [count]);
</code></pre>
</li>
</ul>
<h3 data-id="heading-2">3. 永远不要直接修改 State (Immutability / 不可变性)</h3>
<p>React 比较状态是否变化是基于<strong>引用比较</strong>（Shallow Compare）。如果你直接修改对象属性，引用地址没变，React 就不知道数据变了，页面就不会刷新。</p>
<ul>
<li>
<p><strong>❌ 错误写法：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> });

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateName</span> = (<span class="hljs-params"/>) =&gt; {
  user.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>; <span class="hljs-comment">// 修改了内容，但对象引用没变</span>
  <span class="hljs-title function_">setUser</span>(user);     <span class="hljs-comment">// React 认为前后是同一个对象，不触发重新渲染</span>
};
</code></pre>
</li>
<li>
<p><strong>✅ 正确写法：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">updateName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 创建一个新对象（复制旧属性 + 覆盖新属性）</span>
  <span class="hljs-title function_">setUser</span>({ ...user, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> }); 
};
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">4. 列表渲染必须有唯一的 <code>key</code>（且尽量不要用 index）</h3>
<p><code>key</code> 是 React 识别 DOM 节点的身份证。如果使用数组索引（index）作为 key，当列表顺序发生变化（插入、删除、排序）时，React 会复用错误的 DOM 节点，导致状态错乱。</p>
<ul>
<li>
<p><strong>❌ 风险写法：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 如果列表顺序会变，千万别用 index</span>
{items.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>)}
</code></pre>
</li>
<li>
<p><strong>✅ 正确写法：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 使用数据中的唯一 ID</span>
{items.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>)}
</code></pre>
</li>
</ul>
<h3 data-id="heading-4">5. <code>useEffect</code> 的清理函数 (Cleanup Function)</h3>
<p>如果在 <code>useEffect</code> 中订阅了事件、设置了定时器或发起了请求，必须返回一个清理函数，否则会导致内存泄漏或逻辑错误（比如组件卸载了但定时器还在跑）。</p>
<ul>
<li>
<p><strong>✅ 标准模板：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1. 设置副作用</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);

  <span class="hljs-comment">// 2. 返回清理函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
  };
}, []);
</code></pre>
</li>
</ul>
<h3 data-id="heading-5">6. React Strict Mode 下的“重复执行”</h3>
<p>在开发环境（Development）中，为了帮你检查不纯的副作用，React 的 <code>&lt;StrictMode&gt;</code> 会故意将你的组件<strong>渲染两次</strong>，<code>useEffect</code> 也会执行两次。</p>
<ul>
<li><strong>现象</strong>：你看控制台日志，发现 API 请求发了两次，或者 <code>console.log</code> 打印了两次。</li>
<li><strong>注意</strong>：这<strong>不是 Bug</strong>，生产环境（Production）不会发生。不要为了解决这个问题去写奇怪的代码，而应该确保你的 Effect 是可以重复执行且无害的（做好清理工作）。</li>
</ul>
<h3 data-id="heading-6">总结建议</h3>
<p>您刚遇到的 <strong>“Hook 顺序与数量必须一致”</strong> 是 React 运行机制的物理限制（React 内部是靠数组索引来记录每个 Hook 的状态的，如果顺序乱了，状态就张冠李戴了）。</p>
<p>而上面提到的这 6 点，更多是<strong>逻辑和模式</strong>上的注意事项。掌握了这些，您写 React 就会非常有底气了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[超详细 Vue CLI 移动端预览插件实战：支持本地/TPGZ/NPM/Git 多场景使用（小白零基础入门）]]></title>    <link>https://juejin.cn/post/7589454621719380018</link>    <guid>https://juejin.cn/post/7589454621719380018</guid>    <pubDate>2025-12-30T09:11:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589454621719380018" data-draft-id="7589231401659138058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="超详细 Vue CLI 移动端预览插件实战：支持本地/TPGZ/NPM/Git 多场景使用（小白零基础入门）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T09:11:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雅痞_yuppie"/> <meta itemprop="url" content="https://juejin.cn/user/3466134893364247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            超详细 Vue CLI 移动端预览插件实战：支持本地/TPGZ/NPM/Git 多场景使用（小白零基础入门）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3466134893364247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雅痞_yuppie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:11:50.000Z" title="Tue Dec 30 2025 09:11:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>你是否还在为「移动端如何快速预览本地 Vue 开发项目」而烦恼？手动查找局域网 IP、输入端口号繁琐又容易出错？本文将围绕「<strong>实现移动端便捷预览本地服务项目</strong>」这一核心需求，手把手教你开发一款 Vue CLI 专属二维码插件。插件不仅能自动生成移动端可扫码的二维码，还完美支持本地调试、TGZ 压缩包、NPM 公开包、Git 仓库四种使用场景，同时附带解决插件开发中「二维码输出时机」的常见问题，代码可直接复制，小白也能轻松上手！</p>
<h2 data-id="heading-1">一、前言</h2>
<p>在 Vue 项目开发过程中，「移动端预览本地服务」是高频刚需：开发者需要在手机上验证页面适配、交互效果等，但传统方式需要手动查询电脑局域网 IP、记录项目端口，再在手机浏览器中输入地址，步骤繁琐且容易出错（如 IP 输入错误、端口冲突等）。</p>
<p>本文的核心目标是：开发一款 Vue CLI 插件，通过「自动生成可视化二维码」的方式，让手机扫码即可快速访问本地 Vue 服务，同时支持本地调试、TGZ 包、NPM 包、Git 包四种使用场景，满足个人开发、团队协作、全网复用等不同需求，同时解决开发过程中「二维码输出时机」的常见问题。</p>
<h2 data-id="heading-2">二、核心需求与插件优势</h2>
<h3 data-id="heading-3">1.  核心需求</h3>
<ul>
<li>核心功能：自动获取电脑局域网 IP + 项目端口，生成移动端可扫码的二维码，扫码即可访问本地 Vue 服务；</li>
<li>多场景使用：支持本地调试（未发布插件）、TGZ 压缩包（私有部署）、NPM 公开包（全网复用）、Git 仓库（团队协作）四种引入方式；</li>
<li>兼容性强：支持 Vue 2/Vue 3 项目，适配 Vue CLI 3+ 所有版本；</li>
<li>无需手动配置：插件自动开启局域网访问，无需用户修改 <code>vue.config.js</code>；</li>
<li>细节优化：解决二维码输出时机问题，确保使用体验流畅，避免日志混乱或输出过晚。</li>
</ul>
<h3 data-id="heading-4">2.  插件核心优势</h3>





























<table><thead><tr><th>优势点</th><th>具体说明</th></tr></thead><tbody><tr><td>便捷性</td><td>扫码访问，无需手动输入 IP + 端口，零出错</td></tr><tr><td>多场景兼容</td><td>支持本地/TPGZ/NPM/Git 四种使用方式</td></tr><tr><td>无侵入性</td><td>不修改项目原有代码，卸载后无残留</td></tr><tr><td>自动配置</td><td>自动开启 <code>host: 0.0.0.0</code>，支持局域网访问</td></tr><tr><td>细节优化</td><td>解决二维码输出时机问题，日志整洁美观</td></tr></tbody></table>
<h2 data-id="heading-5">三、第一步：插件开发（核心功能实现，支持移动端扫码预览）</h2>
<h3 data-id="heading-6">1.  插件目录规范（Vue CLI 要求，必须遵守）</h3>
<p>Vue CLI 插件必须以 <code>vue-cli-plugin-xxx</code> 命名，否则无法被项目自动识别，执行命令创建目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建插件目录并进入（小白直接复制终端执行）</span>
<span class="hljs-built_in">mkdir</span> vue-cli-plugin-vue-mobile-preview &amp;&amp; <span class="hljs-built_in">cd</span> vue-cli-plugin-vue-mobile-preview
</code></pre>
<h3 data-id="heading-7">2.  初始化 package.json（配置插件信息与依赖）</h3>
<p>在插件目录下执行 <code>npm init -y</code> 快速生成配置文件，再手动替换为以下内容（确保依赖与兼容性）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vue-cli-plugin-vue-mobile-preview"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Vue CLI 3+ 插件：自动生成二维码，支持移动端扫码预览本地Vue服务，兼容本地/TGZ/NPM/Git多场景"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"vue"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"vue-cli"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"mobile preview"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"qrcode"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"local service"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"TGZ"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"NPM"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"Git"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"qrcode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.5.3"</span> <span class="hljs-comment">// 核心依赖：用于生成终端可视化二维码</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@vue/cli-service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=3.0.0"</span> <span class="hljs-comment">// 兼容 Vue CLI 3+ 所有版本</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的姓名"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>关键说明：<code>dependencies</code> 中声明 <code>qrcode</code> 依赖，用户安装插件后无需手动安装；<code>peerDependencies</code> 确保插件与 Vue CLI 版本兼容。</li>
</ul>
<h3 data-id="heading-8">3.  编写核心 index.js（实现移动端扫码预览核心功能）</h3>
<p>这是插件的核心文件，实现「自动获取局域网 IP + 项目端口 + 生成二维码」的核心功能，同时解决「二维码输出时机」问题，代码含详细注释，小白可直接复制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 引入核心依赖</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">QRCode</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'qrcode'</span>);
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>); <span class="hljs-comment">// Node.js 原生模块，无需额外安装，用于获取局域网IP</span>

<span class="hljs-comment">/**
 * 核心功能1：自动获取本机局域网 IPv4 地址（移动端访问需要该 IP）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 有效局域网IP | 兜底本地回环地址（127.0.0.1）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getLocalLanIp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> networkInterfaces = os.<span class="hljs-title function_">networkInterfaces</span>();
  <span class="hljs-comment">// 遍历所有网卡接口，筛选符合条件的局域网 IP</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> ifaceName <span class="hljs-keyword">in</span> networkInterfaces) {
    <span class="hljs-keyword">const</span> ifaceList = networkInterfaces[ifaceName];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> iface <span class="hljs-keyword">of</span> ifaceList) {
      <span class="hljs-comment">// 过滤条件：IPv4 协议、非本地回环地址、非虚拟内网地址</span>
      <span class="hljs-keyword">if</span> (iface.<span class="hljs-property">family</span> === <span class="hljs-string">'IPv4'</span> &amp;&amp; !iface.<span class="hljs-property">internal</span> &amp;&amp; iface.<span class="hljs-property">address</span> !== <span class="hljs-string">'127.0.0.1'</span>) {
        <span class="hljs-keyword">return</span> iface.<span class="hljs-property">address</span>; <span class="hljs-comment">// 返回有效局域网 IP</span>
      }
    }
  }
  <span class="hljs-comment">// 兜底：未获取到局域网 IP 时，返回本地回环地址（仅本机可访问，移动端无法扫码）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'127.0.0.1'</span>;
}

<span class="hljs-comment">/**
 * 核心功能2：生成并打印移动端可扫码的二维码（核心逻辑）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} lanIp 局域网 IP
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} port 项目端口
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">printMobileQrcode</span>(<span class="hljs-params">lanIp, port</span>) {
  <span class="hljs-comment">// 构造移动端访问地址（核心：局域网 IP + 项目端口，手机扫码即可访问）</span>
  <span class="hljs-keyword">const</span> mobileAccessUrl = <span class="hljs-string">`http://<span class="hljs-subst">${lanIp}</span>:<span class="hljs-subst">${port}</span>`</span>;
  <span class="hljs-comment">// 构造本机访问地址（用于提示开发者）</span>
  <span class="hljs-keyword">const</span> localAccessUrl = <span class="hljs-string">`http://localhost:<span class="hljs-subst">${port}</span>`</span>;

  <span class="hljs-comment">// 打印醒目提示信息，区分日志层级</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n====================================================='</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🎉 [vue-cli-plugin-vue-mobile-preview] 移动端预览二维码已生成！'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🔧  本机访问地址：<span class="hljs-subst">${localAccessUrl}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🌐  移动端访问地址：<span class="hljs-subst">${mobileAccessUrl}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'📱  扫码提示：手机与电脑连接同一 WiFi，打开相机/微信扫一扫即可预览！\n'</span>);

  <span class="hljs-comment">// 生成终端可视化二维码</span>
  <span class="hljs-title class_">QRCode</span>.<span class="hljs-title function_">toString</span>(mobileAccessUrl, {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'terminal'</span>, <span class="hljs-comment">// 输出到终端</span>
    <span class="hljs-attr">margin</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 二维码边距（紧凑美观）</span>
    <span class="hljs-attr">small</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 显示大尺寸二维码，提高手机扫码成功率</span>
  }, <span class="hljs-function">(<span class="hljs-params">err, qrCodeStr</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(qrCodeStr); <span class="hljs-comment">// 打印二维码</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 异常捕获：二维码生成失败时，输出错误信息但不影响项目运行</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 二维码生成失败：'</span>, err.<span class="hljs-property">message</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'💡 替代方案：手动在手机浏览器输入地址 -&gt; '</span>, mobileAccessUrl);
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=====================================================\n'</span>);
  });
}

<span class="hljs-comment">/**
 * 辅助变量：标记是否已打印二维码（避免热更新时重复输出）
 */</span>
<span class="hljs-keyword">let</span> hasPrintQrcode = <span class="hljs-literal">false</span>;

<span class="hljs-comment">/**
 * Vue CLI 插件核心导出函数（入口逻辑）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} api Vue CLI 核心 API
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} options 项目的 vue.config.js 配置项
 */</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">api, options</span>) =&gt;</span> {
  api.<span class="hljs-title function_">chainWebpack</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">// 核心配置：强制设置 host: 0.0.0.0，允许局域网设备（手机）访问本地服务</span>
    <span class="hljs-comment">// 无需用户手动修改 vue.config.js，插件自动配置</span>
    config.<span class="hljs-property">devServer</span>.<span class="hljs-title function_">host</span>(<span class="hljs-string">'0.0.0.0'</span>);

    <span class="hljs-comment">// 解决二维码输出时机问题：使用 compiler.hooks.done 事件（项目完全就绪后输出，避免日志混乱）</span>
    <span class="hljs-comment">// 这是插件开发中的细节优化，不影响核心的移动端预览功能</span>
    config.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'mobile-preview-qrcode-plugin'</span>).<span class="hljs-title function_">use</span>(<span class="hljs-keyword">class</span> <span class="hljs-title class_">MobilePreviewPlugin</span> {
      <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
        <span class="hljs-comment">// compiler.hooks.done：Webpack 编译（首次构建/热更新）完成后触发</span>
        compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'MobilePreviewPlugin'</span>, <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 仅在首次构建完成后打印一次二维码，避免热更新时重复输出</span>
          <span class="hljs-keyword">if</span> (hasPrintQrcode) {
            <span class="hljs-keyword">return</span>;
          }

          <span class="hljs-comment">// 获取项目端口（优先使用用户自定义端口，默认 8080）</span>
          <span class="hljs-keyword">const</span> devServerConfig = options.<span class="hljs-property">devServer</span> || {};
          <span class="hljs-keyword">const</span> projectPort = devServerConfig.<span class="hljs-property">port</span> || <span class="hljs-number">8080</span>;
          <span class="hljs-comment">// 获取局域网 IP</span>
          <span class="hljs-keyword">const</span> localLanIp = <span class="hljs-title function_">getLocalLanIp</span>();
          <span class="hljs-comment">// 生成并打印移动端预览二维码</span>
          <span class="hljs-title function_">printMobileQrcode</span>(localLanIp, projectPort);

          <span class="hljs-comment">// 标记已打印二维码</span>
          hasPrintQrcode = <span class="hljs-literal">true</span>;
        });
      }
    });
  });
};
</code></pre>
<h3 data-id="heading-9">4.  插件最终目录结构（小白核对，确保无误）</h3>
<p>插件目录仅需 2 个核心文件，简洁易维护，结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">vue-cli-plugin-vue-mobile-preview/
├── index.js       <span class="hljs-comment"># 核心逻辑文件（实现移动端扫码预览+时机优化）</span>
└── package.json   <span class="hljs-comment"># 插件配置文件（依赖+兼容性配置）</span>
</code></pre>
<h2 data-id="heading-10">四、第二步：多场景使用教程（核心重点，覆盖所有使用场景）</h2>
<p>插件开发完成后，支持 4 种使用场景，满足不同开发需求（个人调试、团队协作、全网复用等），步骤详细，小白可按需选择。</p>
<h3 data-id="heading-11">场景1：本地调试（个人开发，未发布插件，快速验证功能）</h3>
<p>适用于插件开发完成后，个人在本地 Vue 项目中验证功能，无需发布到任何仓库。</p>
<h4 data-id="heading-12">前置准备</h4>
<ul>
<li>插件目录与目标 Vue 项目同级（方便关联），目录结构示例：</li>
</ul>
<pre><code class="hljs language-perl" lang="perl">├── vue-cli-plugin-vue-mobile-preview/  <span class="hljs-comment"># 插件目录</span>
└── <span class="hljs-keyword">my</span>-vue-project/                <span class="hljs-comment"># 目标 Vue 项目（需要移动端预览的项目）</span>
    ├── src/
    ├── package.json
    └── ... 其他项目文件
</code></pre>
<h4 data-id="heading-13">操作步骤</h4>
<ol>
<li>
<p>进入<strong>目标 Vue 项目根目录</strong>，执行以下命令关联本地插件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm 命令（兼容所有环境，推荐小白使用）</span>
npm install file:../vue-cli-plugin-vue-mobile-preview --save-dev

<span class="hljs-comment"># 若使用 pnpm，执行此命令</span>
<span class="hljs-comment"># pnpm add file:../vue-cli-plugin-vue-mobile-preview -D</span>

<span class="hljs-comment"># 若使用 yarn，执行此命令</span>
<span class="hljs-comment"># yarn add file:../vue-cli-plugin-vue-mobile-preview --dev</span>
</code></pre>
<ul>
<li>路径说明：<code>../vue-cli-plugin-vue-mobile-preview</code> 是插件的相对路径，若目录层级不同可调整（如 <code>../../xxx</code>）。</li>
</ul>
</li>
<li>
<p>验证插件安装成功：
查看目标项目的 <code>package.json</code> 文件，若 <code>devDependencies</code> 中出现以下配置，说明关联成功：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"vue-cli-plugin-vue-mobile-preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:../vue-cli-plugin-vue-mobile-preview"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p>启动项目，验证移动端预览功能：
在目标项目根目录执行启动命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Vue CLI 3+ 通用命令</span>
npm run serve

<span class="hljs-comment"># 兼容命令：npm run dev（部分项目配置别名）</span>
</code></pre>
</li>
<li>
<p>移动端扫码预览：</p>
<ul>
<li>终端最后会输出二维码（带醒目提示）；</li>
<li>确保手机与电脑连接<strong>同一 WiFi</strong>（同一局域网）；</li>
<li>打开手机相机/微信/支付宝「扫一扫」，扫描终端二维码，即可快速预览本地 Vue 项目。</li>
</ul>
</li>
<li>
<p>本地插件卸载（若无需使用）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm 命令</span>
npm uninstall vue-cli-plugin-vue-mobile-preview

<span class="hljs-comment"># pnpm/yarn 命令对应：pnpm remove / yarn remove</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-14">场景2：TGZ 压缩包使用（私有部署，团队内部复用，无需发布 NPM）</h3>
<p>适用于插件无需公开，仅在公司/团队内部复用，可上传到私有服务器或共享文件夹供团队成员使用。</p>
<h4 data-id="heading-15">操作步骤</h4>
<ol>
<li>
<p>插件打包为 TGZ 压缩包：
进入插件目录，执行以下命令打包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入插件目录</span>
<span class="hljs-built_in">cd</span> vue-cli-plugin-vue-mobile-preview

<span class="hljs-comment"># 打包生成 TGZ 压缩包（npm pack 是 npm 原生命令，无需额外安装工具）</span>
npm pack
</code></pre>
<ul>
<li>打包成功后，插件目录同级会生成 <code>vue-cli-plugin-vue-mobile-preview-1.0.0.tgz</code> 文件（文件名格式：插件名称+版本号）；</li>
<li>该压缩包包含插件所有核心文件，可直接用于安装。</li>
</ul>
</li>
<li>
<p>分发 TGZ 压缩包：
将生成的 TGZ 文件分发到团队成员（如上传到公司私有服务器、共享网盘、GitLab 私有仓库附件等），获取可访问的路径/地址（示例）：</p>
<ul>
<li>本地共享：<code>/Users/xxx/Shared/vue-cli-plugin-vue-mobile-preview-1.0.0.tgz</code></li>
<li>私有服务器：<code>https://xxx.company.com/plugins/vue-cli-plugin-vue-mobile-preview-1.0.0.tgz</code></li>
</ul>
</li>
<li>
<p>项目中安装 TGZ 插件：
进入目标 Vue 项目根目录，执行以下命令安装（根据 TGZ 地址类型选择）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：安装本地/共享文件夹中的 TGZ 包</span>
npm install file:/Users/xxx/Shared/vue-cli-plugin-vue-mobile-preview-1.0.0.tgz --save-dev

<span class="hljs-comment"># 方式2：安装私有服务器上的 TGZ 包（HTTPS 地址）</span>
npm install https://xxx.company.com/plugins/vue-cli-plugin-vue-mobile-preview-1.0.0.tgz --save-dev

<span class="hljs-comment"># pnpm/yarn 命令兼容，只需替换 npm install 为 pnpm add / yarn add</span>
</code></pre>
</li>
<li>
<p>验证移动端预览功能：
执行 <code>npm run serve</code> 启动项目，后续步骤同「本地调试」，手机扫码即可预览。</p>
</li>
</ol>
<h3 data-id="heading-16">场景3：NPM 公开包使用（全网复用，开源共享）</h3>
<p>适用于插件功能成熟，需要公开给全网开发者使用，发布到 npm 公开仓库。</p>
<h4 data-id="heading-17">操作步骤</h4>
<ol>
<li>
<p>前置准备：</p>
<ul>
<li>拥有 npm 账号（未注册可前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2F" target="_blank" title="https://www.npmjs.com/" ref="nofollow noopener noreferrer">npm 官网</a> 注册）；</li>
<li>切换到 npm 官方源（若配置了国内镜像源，小白执行以下命令）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm config <span class="hljs-built_in">set</span> registry https://registry.npmjs.org/
</code></pre>
</li>
<li>
<p>登录 npm 账号：
进入插件目录，执行登录命令，按提示输入用户名、密码、邮箱：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入插件目录</span>
<span class="hljs-built_in">cd</span> vue-cli-plugin-vue-mobile-preview

<span class="hljs-comment"># 登录 npm 账号</span>
npm login
</code></pre>
</li>
<li>
<p>发布插件到 npm 公开仓库：
在插件目录下执行发布命令，无需额外配置：</p>
<pre><code class="hljs language-bash" lang="bash">npm publish
</code></pre>
<ul>
<li>发布失败排查：若提示包名重复，修改 <code>package.json</code> 中的 <code>name</code> 字段；若提示版本重复，修改 <code>version</code> 字段（如从 1.0.0 改为 1.0.1）。</li>
</ul>
</li>
<li>
<p>项目中安装 NPM 插件：
在任意 Vue CLI 3+ 项目根目录，执行以下命令即可安装（全网开发者均可使用）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：npm 命令（推荐）</span>
npm install vue-cli-plugin-vue-mobile-preview --save-dev

<span class="hljs-comment"># 方式2：Vue CLI 专属快捷命令（自动识别插件，无需加 --save-dev）</span>
vue add vue-mobile-preview

<span class="hljs-comment"># pnpm/yarn 命令兼容</span>
<span class="hljs-comment"># pnpm add vue-cli-plugin-vue-mobile-preview -D</span>
<span class="hljs-comment"># yarn add vue-cli-plugin-vue-mobile-preview --dev</span>
</code></pre>
</li>
<li>
<p>验证移动端预览功能：
执行 <code>npm run serve</code> 启动项目，手机扫码即可预览本地 Vue 项目。</p>
</li>
</ol>
<h3 data-id="heading-18">场景4：Git 仓库使用（团队协作，无需发布 NPM，支持版本控制）</h3>
<p>适用于插件托管在 Git 仓库（GitHub/Gitee/GitLab），团队成员可直接通过 Git 地址安装，支持版本控制和代码同步。</p>
<h4 data-id="heading-19">操作步骤</h4>
<ol>
<li>
<p>插件目录初始化 Git 仓库：
进入插件目录，执行以下命令初始化并提交代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入插件目录</span>
<span class="hljs-built_in">cd</span> vue-cli-plugin-vue-mobile-preview

<span class="hljs-comment"># 初始化 Git 仓库</span>
git init

<span class="hljs-comment"># 添加所有文件</span>
git add .

<span class="hljs-comment"># 提交代码</span>
git commit -m <span class="hljs-string">"init: 完成移动端预览插件开发，支持扫码访问"</span>
</code></pre>
</li>
<li>
<p>推送插件到线上 Git 仓库：
在 GitHub/Gitee/GitLab 上创建一个新仓库，然后将本地插件代码推送上去（以 GitHub 为例）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 关联线上 Git 仓库（替换为你的仓库地址）</span>
git remote add origin https://github.com/你的用户名/vue-cli-plugin-vue-mobile-preview.git

<span class="hljs-comment"># 推送代码到 master/main 分支</span>
git push -u origin master
</code></pre>
</li>
<li>
<p>项目中通过 Git 地址安装插件：
进入目标 Vue 项目根目录，执行以下命令安装（支持 HTTPS/SSH 两种地址格式）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：HTTPS 地址（无需配置密钥，小白推荐使用，公开/私有仓库均可）</span>
npm install https://github.com/你的用户名/vue-cli-plugin-vue-mobile-preview.git --save-dev

<span class="hljs-comment"># 方式2：SSH 地址（需配置 Git 密钥，推荐团队私有仓库使用）</span>
npm install git+ssh://git@github.com/你的用户名/vue-cli-plugin-vue-mobile-preview.git --save-dev

<span class="hljs-comment"># 方式3：GitHub 专属简化格式（自动识别）</span>
npm install 你的用户名/vue-cli-plugin-vue-mobile-preview --save-dev

<span class="hljs-comment"># pnpm/yarn 命令兼容</span>
</code></pre>
</li>
<li>
<p>验证移动端预览功能：
执行 <code>npm run serve</code> 启动项目，手机扫码即可预览本地 Vue 项目，同时可通过 Git 仓库实现插件版本更新和团队同步。</p>
</li>
</ol>
<h2 data-id="heading-20">五、插件开发细节优化（解决二维码输出时机问题）</h2>
<p>这是插件开发过程中的常见问题，不影响核心的移动端预览功能，但可优化使用体验，小白可直接复用代码，无需深入理解。</p>
<h3 data-id="heading-21">1.  问题描述</h3>
<p>若使用 <code>devServer.after</code> 钩子输出二维码，会出现「二维码输出后还有 Webpack 编译日志」的问题，导致日志混乱；若提前输出，会被构建日志覆盖，影响扫码体验。</p>
<h3 data-id="heading-22">2.  解决方案</h3>
<p>使用 <code>compiler.hooks.done</code> 事件，在 Webpack 编译（首次构建）完成后输出二维码，同时添加 <code>hasPrintQrcode</code> 标记，避免热更新时重复输出，代码已集成在插件核心 <code>index.js</code> 中，无需额外修改。</p>
<h3 data-id="heading-23">3.  优化效果</h3>
<ul>
<li>二维码在项目完全就绪后输出，日志整洁美观，无多余信息干扰；</li>
<li>仅输出一次二维码，避免热更新时重复打印，提升使用体验。</li>
</ul>
<h2 data-id="heading-24">六、常见问题排查（小白避坑指南）</h2>
<h3 data-id="heading-25">1.  移动端扫码无法访问本地项目</h3>
<ul>
<li>排查1：手机与电脑是否连接<strong>同一 WiFi</strong>（同一局域网）；</li>
<li>排查2：电脑防火墙是否关闭（防火墙可能拦截手机的访问请求）；</li>
<li>排查3：项目端口是否被占用（更换端口后重新启动项目，如在 <code>vue.config.js</code> 中配置 <code>devServer.port: 8081</code>）；</li>
<li>排查4：插件是否自动配置 <code>host: 0.0.0.0</code>（本文插件已自动配置，无需手动修改）。</li>
</ul>
<h3 data-id="heading-26">2.  插件安装后无二维码输出</h3>
<ul>
<li>排查1：插件名称是否以 <code>vue-cli-plugin-</code> 开头（Vue CLI 仅自动识别该前缀）；</li>
<li>排查2：是否重启项目（插件安装后需重启项目才能生效）；</li>
<li>排查3：目标项目 <code>package.json</code> 中是否存在插件依赖（确认安装成功）；</li>
<li>排查4：是否安装 <code>qrcode</code> 依赖（插件已声明依赖，若缺失可手动执行 <code>npm install qrcode --save-dev</code>）。</li>
</ul>
<h3 data-id="heading-27">3.  二维码重复输出（热更新时）</h3>
<ul>
<li>排查：是否添加 <code>hasPrintQrcode</code> 标记（本文插件已添加，无需额外修改）。</li>
</ul>
<h3 data-id="heading-28">4.  TGZ/Git 插件安装失败</h3>
<ul>
<li>排查1：地址是否正确（TGZ 地址需指向 <code>.tgz</code> 文件，Git 地址需带 <code>.git</code> 后缀）；</li>
<li>排查2：网络是否通畅（私有服务器/Git 仓库是否可正常访问）；</li>
<li>排查3：包管理器版本是否兼容（建议使用 npm 8+ / pnpm 6+ / yarn 1+）。</li>
</ul>
<h2 data-id="heading-29">七、总结</h2>
<ol>
<li><strong>核心目标达成</strong>：本文围绕「移动端便捷预览本地 Vue 服务项目」这一核心需求，开发了一款 Vue CLI 插件，实现了「自动生成二维码 + 扫码快速访问」的核心功能，解决了手动输入 IP + 端口的繁琐问题；</li>
<li><strong>多场景全覆盖</strong>：详细讲解了插件的 4 种使用场景（本地调试、TGZ 压缩包、NPM 公开包、Git 仓库），满足个人开发、团队协作、全网复用等不同需求；</li>
<li><strong>小白友好</strong>：所有代码可直接复制，步骤详细无遗漏，无需复杂配置，同时提供常见问题排查指南，降低上手门槛；</li>
<li><strong>细节优化到位</strong>：附带解决插件开发中「二维码输出时机」的问题，优化使用体验，确保日志整洁、无重复输出；</li>
<li><strong>兼容性强</strong>：支持 Vue 2/Vue 3 项目，适配 Vue CLI 3+ 所有版本，无侵入性，卸载后无残留。</li>
</ol>
<p>通过本文，小白也能轻松开发并使用 Vue CLI 移动端预览插件，实现多场景下的移动端便捷预览，提升 Vue 项目开发效率！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当AI成为你的前端搭子：零门槛用Cursor开启高效开发新时代]]></title>    <link>https://juejin.cn/post/7589477775209873460</link>    <guid>https://juejin.cn/post/7589477775209873460</guid>    <pubDate>2025-12-30T09:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589477775209873460" data-draft-id="7589462007528046626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当AI成为你的前端搭子：零门槛用Cursor开启高效开发新时代"/> <meta itemprop="keywords" content="前端,Cursor"/> <meta itemprop="datePublished" content="2025-12-30T09:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_chiu"/> <meta itemprop="url" content="https://juejin.cn/user/1644525124592974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当AI成为你的前端搭子：零门槛用Cursor开启高效开发新时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525124592974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_chiu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:26:04.000Z" title="Tue Dec 30 2025 09:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从项目初始化到代码优化，一个AI助手如何彻底改变前端开发的工作流</p>
</blockquote>
<h2 data-id="heading-0">前言：为什么前端开发者需要Cursor？</h2>
<p>前端开发正经历一场静悄悄的革命。过去几年，我们见证了从jQuery到三大框架的变迁，从手动配置Webpack到Vite的零配置体验，而现在，AI编程助手正在重新定义我们编写代码的方式。</p>
<p>作为一名前端开发者，你是否也曾面临这些痛点：</p>
<ul>
<li>纠结于某个复杂组件的实现方案</li>
<li>花费大量时间调试诡异的样式兼容性问题</li>
<li>在重复的业务代码中消耗创造力</li>
<li>面对新技术栈的学习曲线感到焦虑</li>
</ul>
<p>Cursor的出现，就像是为每个前端开发者配备了一个24小时在线的资深搭档。但不同于普通的代码补全工具，Cursor基于GPT-4，能够理解上下文、分析整个项目结构，并给出智能的解决方案。</p>
<h2 data-id="heading-1">一、Cursor初体验：从安装到第一个智能组件</h2>
<h3 data-id="heading-2">1.1 安装与环境配置</h3>
<p>Cursor的安装过程简单到令人惊讶：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 访问官网下载对应版本</span>
https://www.cursor.so/

<span class="hljs-comment"># 或者通过Homebrew（macOS）</span>
brew install --cask cursor
</code></pre>
<p>安装完成后，你会看到一个与VS Code极其相似的界面——实际上，Cursor正是基于VS Code的开源版本开发，这意味着所有你熟悉的VS Code快捷键和扩展生态基本都能无缝迁移。</p>
<p><strong>重要设置</strong>：首次启动后，建议在设置中开启“自动应用建议”功能，这将大幅提升编码效率。</p>
<h3 data-id="heading-3">1.2 你的第一个AI辅助组件</h3>
<p>让我们从一个实际的前端场景开始：创建一个可复用的表单输入组件。</p>
<p>传统的开发流程：</p>
<ol>
<li>创建文件 <code>InputField.jsx</code></li>
<li>编写基础结构</li>
<li>逐步添加功能</li>
<li>调试和优化</li>
</ol>
<p>使用Cursor的流程发生了本质变化：</p>
<p><strong>步骤1：用自然语言描述需求</strong>
直接在编辑器中输入：</p>
<pre><code class="hljs language-markdown" lang="markdown">创建一个React表单输入组件，要求：
<span class="hljs-bullet">1.</span> 支持标签、占位符、错误状态
<span class="hljs-bullet">2.</span> 包含输入验证功能
<span class="hljs-bullet">3.</span> 有动画过渡效果
<span class="hljs-bullet">4.</span> 支持自定义样式
<span class="hljs-bullet">5.</span> 使用TypeScript
</code></pre>
<p><strong>步骤2：让Cursor生成代码</strong>
按下 <code>Cmd/Ctrl + K</code>，Cursor会分析你的需求并生成完整代码：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'./InputField.css'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">InputFieldProps</span> {
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  placeholder?: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">type</span>?: <span class="hljs-string">'text'</span> | <span class="hljs-string">'email'</span> | <span class="hljs-string">'password'</span> | <span class="hljs-string">'number'</span>;
  required?: <span class="hljs-built_in">boolean</span>;
  error?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span>, isValid: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  customClassName?: <span class="hljs-built_in">string</span>;
  validationRules?: {
    pattern?: <span class="hljs-title class_">RegExp</span>;
    minLength?: <span class="hljs-built_in">number</span>;
    maxLength?: <span class="hljs-built_in">number</span>;
    customValidator?: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span>;
  };
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">InputField</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">InputFieldProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  label,
  placeholder = <span class="hljs-string">''</span>,
  <span class="hljs-keyword">type</span> = <span class="hljs-string">'text'</span>,
  required = <span class="hljs-literal">false</span>,
  error: externalError,
  value,
  onChange,
  customClassName = <span class="hljs-string">''</span>,
  validationRules = {}
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> [internalError, setInternalError] = useState&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [isTouched, setIsTouched] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isAnimating, setIsAnimating] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> validateInput = (<span class="hljs-attr">inputValue</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (required &amp;&amp; !inputValue.<span class="hljs-title function_">trim</span>()) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'此字段为必填项'</span>;
    }

    <span class="hljs-keyword">if</span> (validationRules.<span class="hljs-property">pattern</span> &amp;&amp; !validationRules.<span class="hljs-property">pattern</span>.<span class="hljs-title function_">test</span>(inputValue)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'格式不正确'</span>;
    }

    <span class="hljs-keyword">if</span> (validationRules.<span class="hljs-property">minLength</span> &amp;&amp; inputValue.<span class="hljs-property">length</span> &lt; validationRules.<span class="hljs-property">minLength</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`长度不能少于<span class="hljs-subst">${validationRules.minLength}</span>个字符`</span>;
    }

    <span class="hljs-keyword">if</span> (validationRules.<span class="hljs-property">maxLength</span> &amp;&amp; inputValue.<span class="hljs-property">length</span> &gt; validationRules.<span class="hljs-property">maxLength</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`长度不能超过<span class="hljs-subst">${validationRules.maxLength}</span>个字符`</span>;
    }

    <span class="hljs-keyword">if</span> (validationRules.<span class="hljs-property">customValidator</span> &amp;&amp; !validationRules.<span class="hljs-title function_">customValidator</span>(inputValue)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'自定义验证失败'</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e: React.ChangeEvent&lt;HTMLInputElement&gt;</span>) =&gt; {
    <span class="hljs-keyword">const</span> newValue = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">const</span> errorMsg = <span class="hljs-title function_">validateInput</span>(newValue);
    <span class="hljs-title function_">setInternalError</span>(errorMsg);
    
    <span class="hljs-comment">// 触发动画</span>
    <span class="hljs-keyword">if</span> (errorMsg &amp;&amp; !isAnimating) {
      <span class="hljs-title function_">setIsAnimating</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setIsAnimating</span>(<span class="hljs-literal">false</span>), <span class="hljs-number">300</span>);
    }
    
    <span class="hljs-title function_">onChange</span>(newValue, !errorMsg);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBlur</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setIsTouched</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">if</span> (value) {
      <span class="hljs-keyword">const</span> errorMsg = <span class="hljs-title function_">validateInput</span>(value);
      <span class="hljs-title function_">setInternalError</span>(errorMsg);
    }
  };

  <span class="hljs-keyword">const</span> error = externalError || internalError;
  <span class="hljs-keyword">const</span> showError = isTouched &amp;&amp; error;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">input-field</span> ${<span class="hljs-attr">customClassName</span>} ${<span class="hljs-attr">showError</span> ? '<span class="hljs-attr">error</span>' <span class="hljs-attr">:</span> ''} ${<span class="hljs-attr">isAnimating</span> ? '<span class="hljs-attr">shake</span>' <span class="hljs-attr">:</span> ''}`}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"input-label"</span>&gt;</span>
        {label}
        {required &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"required-asterisk"</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">{type}</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span>
        <span class="hljs-attr">onBlur</span>=<span class="hljs-string">{handleBlur}</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{placeholder}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">input-element</span> ${<span class="hljs-attr">showError</span> ? '<span class="hljs-attr">input-error</span>' <span class="hljs-attr">:</span> ''}`}
        <span class="hljs-attr">aria-invalid</span>=<span class="hljs-string">{!!showError}</span>
        <span class="hljs-attr">aria-describedby</span>=<span class="hljs-string">{showError</span> ? `<span class="hljs-attr">error-</span>${<span class="hljs-attr">label</span>}` <span class="hljs-attr">:</span> <span class="hljs-attr">undefined</span>}
      /&gt;</span>
      {showError &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
          <span class="hljs-attr">id</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">error-</span>${<span class="hljs-attr">label</span>}`}
          <span class="hljs-attr">className</span>=<span class="hljs-string">"error-message animate-in"</span>
          <span class="hljs-attr">role</span>=<span class="hljs-string">"alert"</span>
        &gt;</span>
          {error}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">InputField</span>;
</code></pre>
<p><strong>步骤3：让Cursor生成配套样式</strong>
继续使用 <code>Cmd/Ctrl + K</code>：</p>
<pre><code class="hljs language-markdown" lang="markdown">为上面的组件生成合适的CSS样式，要求：
<span class="hljs-bullet">1.</span> 使用现代CSS设计
<span class="hljs-bullet">2.</span> 包含错误状态的视觉反馈
<span class="hljs-bullet">3.</span> 实现摇动动画效果
<span class="hljs-bullet">4.</span> 确保可访问性
</code></pre>
<p>Cursor会生成完整的CSS文件，甚至包括CSS变量和动画关键帧。</p>
<h3 data-id="heading-4">1.3 进阶功能：让Cursor重构和优化代码</h3>
<p>假设我们需要为组件添加防抖功能，可以这样操作：</p>
<p>选中需要修改的函数，按下 <code>Cmd/Ctrl + L</code> 打开聊天框：</p>
<pre><code class="hljs">为handleChange函数添加防抖功能，300ms延迟
</code></pre>
<p>Cursor会自动重构代码：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash-es'</span>;

<span class="hljs-comment">// 在组件内部</span>
<span class="hljs-keyword">const</span> debouncedChangeHandler = <span class="hljs-title function_">useMemo</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">newValue: <span class="hljs-built_in">string</span>, isValid: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> {
    <span class="hljs-title function_">onChange</span>(newValue, isValid);
  }, <span class="hljs-number">300</span>),
  [onChange]
);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e: React.ChangeEvent&lt;HTMLInputElement&gt;</span>) =&gt; {
  <span class="hljs-keyword">const</span> newValue = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
  <span class="hljs-keyword">const</span> errorMsg = <span class="hljs-title function_">validateInput</span>(newValue);
  <span class="hljs-title function_">setInternalError</span>(errorMsg);
  
  <span class="hljs-keyword">if</span> (errorMsg &amp;&amp; !isAnimating) {
    <span class="hljs-title function_">setIsAnimating</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setIsAnimating</span>(<span class="hljs-literal">false</span>), <span class="hljs-number">300</span>);
  }
  
  <span class="hljs-comment">// 使用防抖版本</span>
  <span class="hljs-title function_">debouncedChangeHandler</span>(newValue, !errorMsg);
};
</code></pre>
<h2 data-id="heading-5">二、Cursor的核心优势：前端开发的四大场景</h2>
<h3 data-id="heading-6">2.1 智能代码补全与上下文理解</h3>
<p>传统IDE的自动补全只能基于语法，而Cursor能基于整个项目上下文。例如，当你在Redux项目中输入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你输入：创建一个action creator来处理用户登录</span>
<span class="hljs-comment">// Cursor会自动生成：</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">loginUser</span> = (<span class="hljs-params">credentials</span>) =&gt; <span class="hljs-keyword">async</span> (dispatch) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_REQUEST'</span> });
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/auth/login'</span>, credentials);
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'token'</span>, response.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>);
    <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_SUCCESS'</span>, <span class="hljs-attr">payload</span>: response.<span class="hljs-property">data</span>.<span class="hljs-property">user</span> });
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_FAILURE'</span>, <span class="hljs-attr">payload</span>: error.<span class="hljs-property">message</span> });
    <span class="hljs-keyword">throw</span> error;
  }
};
</code></pre>
<h3 data-id="heading-7">2.2 零成本学习新技术栈</h3>
<p>想尝试Svelte但不想花时间学习所有细节？直接告诉Cursor：</p>
<pre><code class="hljs">用Svelte创建一个可拖拽的任务看板组件，支持本地存储
</code></pre>
<h3 data-id="heading-8">2.3 调试与问题解决</h3>
<p>遇到一个棘手的bug？直接把错误信息贴给Cursor：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">我在<span class="hljs-keyword">Next</span>.js项目中遇到这个错误：Hydration failed because the initial UI does <span class="hljs-keyword">not</span> match what was rendered <span class="hljs-keyword">on</span> the <span class="hljs-built_in">server</span>
这是相关组件代码：[粘贴代码]
如何修复？
</code></pre>
<p>Cursor不仅能解释问题原因，还能给出具体的修复方案。</p>
<h3 data-id="heading-9">2.4 文档和测试生成</h3>
<p>生成组件文档：</p>
<pre><code class="hljs">为InputField组件生成Markdown文档，包括props表格和使用示例
</code></pre>
<p>生成单元测试：</p>
<pre><code class="hljs">为InputField组件编写Jest测试用例，覆盖所有验证规则
</code></pre>
<h2 data-id="heading-10">三、实战演练：用Cursor快速搭建项目骨架</h2>
<p>让我们看看如何用30分钟搭建一个现代React应用骨架：</p>
<ol>
<li><strong>项目初始化</strong></li>
</ol>
<pre><code class="hljs">使用Vite + React + TypeScript创建新项目，配置好ESLint、Prettier、Tailwind CSS和React Router
</code></pre>
<ol start="2">
<li><strong>布局组件生成</strong></li>
</ol>
<pre><code class="hljs">创建一个响应式布局组件，包含导航栏、侧边栏和主内容区域
导航栏在移动端显示汉堡菜单
</code></pre>
<ol start="3">
<li><strong>页面组件批量创建</strong></li>
</ol>
<pre><code class="hljs language-diff" lang="diff">创建以下页面组件：
<span class="hljs-deletion">- 首页：展示仪表盘</span>
<span class="hljs-deletion">- 用户列表：带搜索和分页</span>
<span class="hljs-deletion">- 设置页面：选项卡布局</span>
<span class="hljs-deletion">- 404页面</span>
</code></pre>
<ol start="4">
<li><strong>状态管理配置</strong></li>
</ol>
<pre><code class="hljs">配置Zustand作为状态管理，创建用户和主题的store
</code></pre>
<ol start="5">
<li><strong>API层封装</strong></li>
</ol>
<pre><code class="hljs">创建统一的API请求工具，包含拦截器、错误处理和Loading状态管理
</code></pre>
<h2 data-id="heading-11">四、Cursor使用技巧：提升效率的秘籍</h2>
<h3 data-id="heading-12">4.1 精准提问的艺术</h3>
<p>低效提问：</p>
<pre><code class="hljs">如何做一个按钮？
</code></pre>
<p>高效提问：</p>
<pre><code class="hljs language-markdown" lang="markdown">创建一个React按钮组件，要求：
<span class="hljs-bullet">1.</span> 支持primary、secondary、danger三种类型
<span class="hljs-bullet">2.</span> 有loading状态和禁用状态
<span class="hljs-bullet">3.</span> 支持图标和文本组合
<span class="hljs-bullet">4.</span> 使用CSS-in-JS方案
<span class="hljs-bullet">5.</span> 导出TypeScript类型定义
</code></pre>
<h3 data-id="heading-13">4.2 利用项目上下文</h3>
<p>Cursor可以分析整个项目结构。在提问前，确保：</p>
<ol>
<li>已经打开了相关文件</li>
<li>提到了重要的依赖项</li>
<li>说明了项目约束条件</li>
</ol>
<h3 data-id="heading-14">4.3 链式调用</h3>
<p>复杂任务可以分解：</p>
<pre><code class="hljs">第一步：创建一个用户模型接口
第二步：基于这个接口创建CRUD API函数
第三步：创建对应的React Hook封装
第四步：生成使用示例
</code></pre>
<h2 data-id="heading-15">五、潜在陷阱与最佳实践</h2>
<h3 data-id="heading-16">5.1 需要谨慎对待的场景</h3>
<ol>
<li><strong>安全性</strong>：永远不要让Cursor生成涉及敏感逻辑的代码（如认证、支付）</li>
<li><strong>性能关键代码</strong>：算法优化等需要人工审查</li>
<li><strong>业务复杂逻辑</strong>：AI可能不理解业务上下文</li>
</ol>
<h3 data-id="heading-17">5.2 推荐的开发流程</h3>
<pre><code class="hljs language-css" lang="css">需求分析 → 人工设计核心架构 → <span class="hljs-attribute">Cursor</span>辅助实现细节 → 人工代码审查 → 测试验证
</code></pre>
<h3 data-id="heading-18">5.3 版本控制策略</h3>
<p>建议：将所有Cursor生成的代码视为"初稿"，经过审查修改后再提交。可以使用特殊的提交前缀：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "cursor: 生成基础组件框架"
git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "feat: 优化Cursor生成的表单组件"
</code></pre>
<h2 data-id="heading-19">结语：AI时代的前端开发者定位</h2>
<p>Cursor不是要取代前端开发者，而是成为我们的"超能力扩展"。它让我们：</p>
<ol>
<li><strong>专注架构设计</strong>：从琐碎代码中解放出来</li>
<li><strong>加速学习曲线</strong>：快速掌握新技术</li>
<li><strong>提升代码质量</strong>：获得即时的最佳实践建议</li>
<li><strong>激发创造力</strong>：尝试更多创新方案</li>
</ol>
<p><strong>记住</strong>：最强大的开发者不是会写所有代码的人，而是知道如何让AI写出更好代码的人。</p>
<hr/>
<p><strong>预告</strong>：在下一篇中，我们将深入探讨如何用Cursor重构大型前端项目，包括：</p>
<ul>
<li>遗留代码的智能分析与重构</li>
<li>技术栈迁移的自动化策略</li>
<li>性能优化的AI辅助方案</li>
<li>团队协作中Cursor的最佳实践</li>
</ul>
<p>如果你对某个特定场景感兴趣，欢迎在评论区留言。让我们共同探索AI时代前端开发的新范式！</p>
<p><strong>思考题</strong>：在你的当前项目中，哪个重复性最高的任务最适合让Cursor来协助完成？试着用它解决一个小问题，并在评论区分享你的体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[防抖与节流：前端性能优化的“双子星”，让你的网页丝滑如德芙！]]></title>    <link>https://juejin.cn/post/7589462007528292386</link>    <guid>https://juejin.cn/post/7589462007528292386</guid>    <pubDate>2025-12-30T09:47:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589462007528292386" data-draft-id="7589466356779515956" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="防抖与节流：前端性能优化的“双子星”，让你的网页丝滑如德芙！"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-30T09:47:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yira"/> <meta itemprop="url" content="https://juejin.cn/user/262123324974122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            防抖与节流：前端性能优化的“双子星”，让你的网页丝滑如德芙！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/262123324974122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yira
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:47:30.000Z" title="Tue Dec 30 2025 09:47:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">防抖与节流：前端性能优化的“双子星”，让你的网页丝滑如德芙！</h2>
<p>在现代 Web 开发中，用户交互越来越丰富，事件触发也越来越频繁。无论是搜索框的实时建议、页面滚动加载，还是窗口尺寸调整，这些看似简单的操作背后，都可能隐藏着<strong>性能陷阱</strong>。如果不加以控制，高频事件会像洪水一样冲垮你的应用——导致卡顿、内存泄漏，甚至服务器崩溃。</p>
<p>幸运的是，前端工程师早已找到了两大利器：<strong>防抖（Debounce）</strong> 与 <strong>节流（Throttle）</strong> 。它们如同性能优化领域的“双子星”，一个专注“等你停手”，一个坚持“按节奏来”。今天，我们就深入剖析这两位高手的原理、区别与实战用法，助你写出更高效、更流畅的代码！</p>
<hr/>
<h3 data-id="heading-1">一、问题根源：为什么我们需要防抖和节流？</h3>
<p>想象一下你在百度搜索框输入“React教程”：</p>
<ul>
<li>每按下一个键（R → e → a → c → t …），浏览器都会触发一次 <code>keyup</code> 事件；</li>
<li>如果每次事件都立即发送 AJAX 请求，那么短短 6 个字就会发出 <strong>6 次网络请求</strong>；</li>
<li>而实际上，你只关心最终的关键词 “React教程”。</li>
</ul>
<p>这就是典型的 <strong>“高频事件 + 复杂任务”</strong> 组合：</p>
<ul>
<li><strong>事件太密集</strong>：<code>keyup</code>、<code>scroll</code>、<code>resize</code> 等事件每秒可触发数十次；</li>
<li><strong>任务太复杂</strong>：AJAX 请求、DOM 操作、复杂计算等消耗大量资源。</li>
</ul>
<p>若不加限制，后果严重：</p>
<ul>
<li>浪费带宽和服务器资源；</li>
<li>页面卡顿，用户体验差；</li>
<li>可能因请求顺序错乱导致 UI 显示错误（竞态条件）。</li>
</ul>
<p>于是，<strong>防抖</strong> 和 <strong>节流</strong> 应运而生。</p>
<hr/>
<h3 data-id="heading-2">二、防抖（Debounce）：只执行最后一次</h3>
<h4 data-id="heading-3">✅ 核心思想</h4>
<blockquote>
<p><strong>“别急，等用户彻底停手再说！”</strong></p>
</blockquote>
<p>防抖的逻辑非常简单：<strong>在连续触发事件的过程中，不执行任务；只有当事件停止触发超过指定时间后，才执行一次。</strong></p>
<h4 data-id="heading-4">🏠 生活类比：电梯关门</h4>
<ul>
<li>电梯门打开后，等待 5 秒再关闭；</li>
<li>如果第 3 秒有人进来，就<strong>重新计时 5 秒</strong>；</li>
<li>只有连续 5 秒没人进入，门才真正关闭。</li>
</ul>
<h4 data-id="heading-5">💻 代码实现（闭包 + 定时器）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer; <span class="hljs-comment">// 闭包变量，保存定时器 ID</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timer); <span class="hljs-comment">// 清除上一个定时器</span>
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args); <span class="hljs-comment">// 执行原函数</span>
    }, delay);
  };
}
</code></pre>
<h5 data-id="heading-6">关键点解析：</h5>
<ul>
<li><code>timer</code> 是<strong>自由变量</strong>，被内部函数通过闭包“记住”；</li>
<li>每次调用返回的函数，都会先 <code>clearTimeout</code>，再 <code>setTimeout</code>；</li>
<li>结果：<strong>只有最后一次触发后的 <code>delay</code> 毫秒内无新触发，才会执行</strong>。</li>
</ul>
<h4 data-id="heading-7">🌟 典型应用场景</h4>





















<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>搜索建议</strong></td><td>用户打字时，等他停手再发请求，避免无效搜索</td></tr><tr><td><strong>表单校验</strong></td><td>输入邮箱/密码后，延迟验证，减少干扰</td></tr><tr><td><strong>窗口 resize 保存布局</strong></td><td>用户调整完窗口大小再保存，而非过程中反复保存</td></tr></tbody></table>
<blockquote>
<p>✅ 一句话总结：<strong>防抖适用于“有明确结束点”的操作，关注最终状态。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-8">三、节流（Throttle）：固定间隔执行</h3>
<h4 data-id="heading-9">✅ 核心思想</h4>
<blockquote>
<p><strong>“别慌，按我的节奏来！”</strong></p>
</blockquote>
<p>节流的逻辑是：<strong>无论事件触发多频繁，我保证每隔 X 毫秒最多执行一次任务。</strong></p>
<h4 data-id="heading-10">🏠 生活类比：FPS 游戏射速</h4>
<ul>
<li>即使你一直按住鼠标左键，枪也只会按照设定的射速（如每秒 10 发）射击；</li>
<li>多余的点击会被忽略。</li>
</ul>
<h4 data-id="heading-11">💻 代码实现（时间戳版）</h4>
<pre><code class="hljs language-ini" lang="ini">function throttle(fn, delay) {
  let <span class="hljs-attr">last</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 上次执行时间</span>
  return function (...args) {
    const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
    if (now - last &gt;= delay) {
      fn.apply(this, args)<span class="hljs-comment">;</span>
      <span class="hljs-attr">last</span> = now<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>但你提供的代码更智能——它结合了<strong>尾部补偿</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">function throttle(fn, delay) {
  let last, deferTimer<span class="hljs-comment">;</span>
  return function () {
    let <span class="hljs-attr">that</span> = this<span class="hljs-comment">;</span>
    let <span class="hljs-attr">_args</span> = arguments<span class="hljs-comment">;</span>
    let <span class="hljs-attr">now</span> = +new Date()<span class="hljs-comment">;</span>

    if (last &amp;&amp; now &lt; last + delay) {
      // 还在冷却期：清除旧定时器，安排新尾部任务
      clearTimeout(deferTimer)<span class="hljs-comment">;</span>
      <span class="hljs-attr">deferTimer</span> = setTimeout(() =&gt; {
        <span class="hljs-attr">last</span> = now<span class="hljs-comment">;</span>
        fn.apply(that, _args)<span class="hljs-comment">;</span>
      }, delay)<span class="hljs-comment">;</span>
    } else {
      // 冷却期结束：立即执行
      <span class="hljs-attr">last</span> = now<span class="hljs-comment">;</span>
      fn.apply(that, _args)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h5 data-id="heading-12">工作流程：</h5>
<ol>
<li>第一次调用 → 立即执行；</li>
<li>高频调用期间 → 忽略中间操作，但<strong>记录最后一次</strong>；</li>
<li>停止触发后 → 在 <code>delay</code> 毫秒后执行最后一次。</li>
</ol>
<blockquote>
<p>⚠️ 注意：这种实现确保了<strong>尾部操作不丢失</strong>，适合需要“收尾”的场景。</p>
</blockquote>
<h4 data-id="heading-13">🌟 典型应用场景</h4>

























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>页面滚动（scroll）</strong></td><td>每 200ms 记录一次滚动位置，避免卡顿</td></tr><tr><td><strong>鼠标移动（mousemove）</strong></td><td>控制动画或绘图频率</td></tr><tr><td><strong>按钮防连点</strong></td><td>提交订单后 1 秒内禁止再次点击</td></tr><tr><td><strong>无限滚动加载</strong></td><td>用户滚动到底部时，定期检查是否需加载新数据</td></tr></tbody></table>
<blockquote>
<p>✅ 一句话总结：<strong>节流适用于“持续高频”的操作，关注过程节奏。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-14">四、防抖 vs 节流：关键区别一目了然</h3>








































<table><thead><tr><th>对比项</th><th>防抖（Debounce）</th><th>节流（Throttle）</th></tr></thead><tbody><tr><td><strong>执行时机</strong></td><td>停止触发后延迟执行</td><td>固定间隔执行</td></tr><tr><td><strong>执行次数</strong></td><td>N 次触发 → 1 次执行</td><td>N 次触发 → ≈ N/delay 次执行</td></tr><tr><td><strong>是否保留尾部</strong></td><td>是（天然保留）</td><td>基础版否，增强版可保留</td></tr><tr><td><strong>核心机制</strong></td><td><code>clearTimeout + setTimeout</code></td><td>时间戳判断 或 <code>setTimeout</code> 控制</td></tr><tr><td><strong>适用事件</strong></td><td><code>input</code>, <code>keyup</code></td><td><code>scroll</code>, <code>resize</code>, <code>mousemove</code></td></tr><tr><td><strong>用户感知</strong></td><td>“打完字才响应”</td><td>“滚动时定期响应”</td></tr></tbody></table>
<blockquote>
<p>🔥 记住这个口诀：<br/>
<strong>“防抖等停手，节流控节奏。”</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-15">五、闭包：防抖与节流的“幕后英雄”</h3>
<p>你可能注意到，无论是 <code>debounce</code> 还是 <code>throttle</code>，都用到了 <strong>闭包</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer; <span class="hljs-comment">// ← 这个变量被内部函数“记住”</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(timer); <span class="hljs-comment">// ← 能访问外部的 timer</span>
    <span class="hljs-comment">// ...</span>
  };
}
</code></pre>
<h4 data-id="heading-16">为什么必须用闭包？</h4>
<ul>
<li><code>timer</code>、<code>last</code> 等状态需要在<strong>多次函数调用之间保持</strong>；</li>
<li>普通局部变量在函数执行完就销毁；</li>
<li>而闭包让内部函数<strong>持续持有对外部变量的引用</strong>，形成“私有记忆”。</li>
</ul>
<blockquote>
<p>💡 闭包 = 函数 + 其词法环境。它是实现状态管理的基石。</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">六、实战建议：如何选择？</h3>





























<table><thead><tr><th>你的需求</th><th>推荐方案</th></tr></thead><tbody><tr><td>用户输入搜索词</td><td>✅ 防抖（500ms）</td></tr><tr><td>监听窗口 resize</td><td>✅ 节流（200ms）</td></tr><tr><td>滚动加载更多</td><td>✅ 节流（300ms）</td></tr><tr><td>表单自动保存草稿</td><td>✅ 防抖（1000ms）</td></tr><tr><td>鼠标拖拽元素</td><td>✅ 节流（16ms ≈ 60fps）</td></tr></tbody></table>
<blockquote>
<p>📌 小技巧：</p>
<ul>
<li>防抖延迟通常 <strong>300~500ms</strong>（平衡响应与性能）；</li>
<li>节流间隔通常 <strong>100~300ms</strong>（根据场景调整）。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-18">七、结语：优雅地控制频率，是专业前端的标志</h3>
<p>防抖与节流，看似只是几行代码，却体现了<strong>对用户体验和系统性能的深刻理解</strong>。它们不是炫技，而是工程实践中不可或缺的“安全阀”。</p>
<p>下次当你面对高频事件时，不妨问问自己：</p>
<ul>
<li>我需要的是<strong>最终结果</strong>，还是<strong>过程采样</strong>？</li>
<li>用户是否希望<strong>立刻响应</strong>，还是可以<strong>稍等片刻</strong>？</li>
</ul>
<p>答案将指引你选择防抖或节流。掌握这“双子星”，你的代码将不再“颤抖”，而是如丝般顺滑——这才是真正的前端艺术！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3 KeepAlive 核心原理和渲染更新流程]]></title>    <link>https://juejin.cn/post/7589445154534408244</link>    <guid>https://juejin.cn/post/7589445154534408244</guid>    <pubDate>2025-12-30T09:45:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589445154534408244" data-draft-id="7589475497000861711" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3 KeepAlive 核心原理和渲染更新流程"/> <meta itemprop="keywords" content="前端,Vue.js,面试"/> <meta itemprop="datePublished" content="2025-12-30T09:45:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="淋着141"/> <meta itemprop="url" content="https://juejin.cn/user/457013611467416"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3 KeepAlive 核心原理和渲染更新流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/457013611467416/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    淋着141
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:45:43.000Z" title="Tue Dec 30 2025 09:45:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue3 KeepAlive 核心原理和渲染更新流程</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fguide%2Fbuilt-ins%2Fkeep-alive" target="_blank" title="https://cn.vuejs.org/guide/built-ins/keep-alive" ref="nofollow noopener noreferrer">KeepAlive</a> 是 Vue 3 的内置组件，用于缓存动态组件，避免重复创建和销毁组件实例。
当组件被切换时，KeepAlive 会将组件实例存储在内存中，而不是完全销毁它，从而保留组件状态并提升性能。</p>
<h3 data-id="heading-1">1. 挂载</h3>
<p>将子组件vnode进行缓存，并且设置<code>vnode.shapeFlag |= ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE</code>,供运行时在卸载时特殊处理</p>
<h3 data-id="heading-2">2. 停用 <code>deactivate</code></h3>
<p>当组件需要隐藏时, 根据<code>COMPONENT_SHOULD_KEEP_ALIVE 和 renderer</code>的逻辑</p>
<ol>
<li>将组件移动到 <code>storageContainer</code>（一个不可见的 DOM 容器）</li>
<li>触发组件的 <code>deactivated</code> 生命周期钩子</li>
<li>组件实例和状态得以保留</li>
</ol>
<h3 data-id="heading-3">3. 激活 <code>activate</code></h3>
<p>当组件再次激活时, 根据<code>COMPONENT_KEPT_ALIVE 和 renderer</code>的逻辑</p>
<ol>
<li><code>新的 vnode.el 使用 cachedVNode.el</code></li>
<li><code>新的 vnode.component 使用 cachedVNode.component</code>，这个是已经挂载的 组件了，里面的subTree都是有el的</li>
<li>将 vnode 移回目标容器</li>
<li>执行 patch 更新（处理 props 变化）</li>
<li>触发组件的 <code>activated</code> 生命周期钩子</li>
</ol>
<h3 data-id="heading-4">4. 相关源码（只保留关于KeepAlive相关的核心逻辑）</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title class_">KeepAliveImpl</span>: <span class="hljs-title class_">ComponentOptions</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">`KeepAlive`</span>,
  <span class="hljs-attr">__isKeepAlive</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">_, { slots }: SetupContext</span>) {
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>()!
    <span class="hljs-keyword">const</span> sharedContext = instance.<span class="hljs-property">ctx</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">KeepAliveContext</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">cache</span>: <span class="hljs-title class_">Cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-keyword">const</span> <span class="hljs-attr">keys</span>: <span class="hljs-title class_">Keys</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()

    <span class="hljs-keyword">const</span> {
      <span class="hljs-attr">renderer</span>: {
        <span class="hljs-attr">p</span>: patch,
        <span class="hljs-attr">m</span>: move,
        <span class="hljs-attr">um</span>: _unmount,
        <span class="hljs-attr">o</span>: { createElement },
      },
    } = sharedContext
    <span class="hljs-keyword">const</span> storageContainer = <span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)

    <span class="hljs-comment">// vnode 缓存的子组件, 结合runtime patch</span>
    sharedContext.<span class="hljs-property">activate</span> = <span class="hljs-function">(<span class="hljs-params">
      vnode,
      container,
      anchor,
      <span class="hljs-keyword">namespace</span>,
      optimized
    </span>) =&gt;</span> {
      <span class="hljs-comment">// instance 是子组件实例</span>
      <span class="hljs-keyword">const</span> instance = vnode.<span class="hljs-property">component</span>!
      <span class="hljs-comment">// 移回来</span>
      <span class="hljs-title function_">move</span>(vnode, container, anchor, <span class="hljs-title class_">MoveType</span>.<span class="hljs-property">ENTER</span>, parentSuspense)
      <span class="hljs-comment">// in case props have changed</span>
      <span class="hljs-title function_">patch</span>(instance.<span class="hljs-property">vnode</span>, vnode, container, anchor, instance,...)
      <span class="hljs-title function_">queuePostRenderEffect</span>(<span class="hljs-function">() =&gt;</span> {
        instance.<span class="hljs-property">isDeactivated</span> = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">a</span>) {
          <span class="hljs-title function_">invokeArrayFns</span>(instance.<span class="hljs-property">a</span>)
        }
      }, parentSuspense)
    }

    <span class="hljs-comment">// vnode 缓存的子组件，里面的缓存的组件除了这两个钩子，其他都是常规流程</span>
    sharedContext.<span class="hljs-property">deactivate</span> = <span class="hljs-function">(<span class="hljs-params">vnode: VNode</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> instance = vnode.<span class="hljs-property">component</span>!
      <span class="hljs-comment">// 移到缓存容器</span>
      <span class="hljs-title function_">move</span>(vnode, storageContainer, <span class="hljs-literal">null</span>, <span class="hljs-title class_">MoveType</span>.<span class="hljs-property">LEAVE</span>, parentSuspense)
      <span class="hljs-title function_">queuePostRenderEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">da</span>) {
          <span class="hljs-title function_">invokeArrayFns</span>(instance.<span class="hljs-property">da</span>)
        }
      }, parentSuspense)
    }

    <span class="hljs-comment">// 当缓存失效，就需要真正的卸载</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">unmount</span>(<span class="hljs-params">vnode: VNode</span>) {
      <span class="hljs-comment">// reset the shapeFlag so it can be properly unmounted</span>
      <span class="hljs-title function_">resetShapeFlag</span>(vnode)
      <span class="hljs-title function_">_unmount</span>(vnode, instance, parentSuspense, <span class="hljs-literal">true</span>)
    }

    <span class="hljs-keyword">let</span> <span class="hljs-attr">pendingCacheKey</span>: <span class="hljs-title class_">CacheKey</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">cacheSubtree</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// fix #1621, the pendingCacheKey could be 0</span>
      <span class="hljs-keyword">if</span> (pendingCacheKey != <span class="hljs-literal">null</span>) {
        cache.<span class="hljs-title function_">set</span>(pendingCacheKey, <span class="hljs-title function_">getInnerChild</span>(instance.<span class="hljs-property">subTree</span>))
      }
    }
    <span class="hljs-title function_">onMounted</span>(cacheSubtree)
    <span class="hljs-title function_">onUpdated</span>(cacheSubtree)

    <span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> {
      cache.<span class="hljs-title function_">forEach</span>(unmount)
    })

    <span class="hljs-comment">// 渲染函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      pendingCacheKey = <span class="hljs-literal">null</span>

      <span class="hljs-keyword">const</span> children = slots.<span class="hljs-title function_">default</span>()
      <span class="hljs-keyword">const</span> rawVNode = children[<span class="hljs-number">0</span>]
      <span class="hljs-keyword">const</span> vnode = children[<span class="hljs-number">0</span>]
      <span class="hljs-comment">// 这里的vnode 就是指 缓存的组件</span>
      <span class="hljs-comment">// warn(`KeepAlive should contain exactly one component child.`)</span>

      <span class="hljs-keyword">const</span> comp = vnode.<span class="hljs-property">type</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">ConcreteComponent</span>

      <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">getComponentName</span>(comp)

      <span class="hljs-keyword">const</span> { include, exclude, max } = props

      <span class="hljs-keyword">if</span> (
        (include &amp;&amp; (!name || !<span class="hljs-title function_">matches</span>(include, name))) ||
        (exclude &amp;&amp; name &amp;&amp; <span class="hljs-title function_">matches</span>(exclude, name))
      ) {
        <span class="hljs-comment">// #11717 // 我写的pr!!!!</span>
        vnode.<span class="hljs-property">shapeFlag</span> &amp;= ~<span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">COMPONENT_SHOULD_KEEP_ALIVE</span>
        <span class="hljs-keyword">return</span> rawVNode
      }

      <span class="hljs-keyword">const</span> key = vnode.<span class="hljs-property">key</span> == <span class="hljs-literal">null</span> ? comp : vnode.<span class="hljs-property">key</span>
      <span class="hljs-keyword">const</span> cachedVNode = cache.<span class="hljs-title function_">get</span>(key)

      pendingCacheKey = key

      <span class="hljs-keyword">if</span> (cachedVNode) {
        <span class="hljs-comment">// 使用缓存的el，缓存的component tree，所以就不用走mount</span>
        <span class="hljs-comment">// copy over mounted state</span>
        vnode.<span class="hljs-property">el</span> = cachedVNode.<span class="hljs-property">el</span>
        vnode.<span class="hljs-property">component</span> = cachedVNode.<span class="hljs-property">component</span>
        <span class="hljs-comment">// 结合runtime patch 流程 当激活时就不走mount</span>
        vnode.<span class="hljs-property">shapeFlag</span> |= <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">COMPONENT_KEPT_ALIVE</span>
      } <span class="hljs-keyword">else</span> {
        keys.<span class="hljs-title function_">add</span>(key)
      }
      <span class="hljs-comment">// avoid vnode being unmounted</span>
      <span class="hljs-comment">// 结合runtime patch 流程 当卸载时就不走unmount</span>
      vnode.<span class="hljs-property">shapeFlag</span> |= <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">COMPONENT_SHOULD_KEEP_ALIVE</span>

      <span class="hljs-keyword">return</span> vnode
    }
  },
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// renderer 中关于 KeepAlive的逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">baseCreateRenderer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">processComponent</span> = (<span class="hljs-params">
    n1: VNode | <span class="hljs-literal">null</span>,
    n2: VNode,
    container: RendererElement,
    anchor: RendererNode | <span class="hljs-literal">null</span>,
    parentComponent: ComponentInternalInstance | <span class="hljs-literal">null</span>
  </span>) =&gt; {
    <span class="hljs-comment">// parentComponent 就是 keepalive</span>
    <span class="hljs-keyword">if</span> (n1 == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (n2.<span class="hljs-property">shapeFlag</span> &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">COMPONENT_KEPT_ALIVE</span>) {
        ;(parentComponent!.<span class="hljs-property">ctx</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">KeepAliveContext</span>).<span class="hljs-title function_">activate</span>(
          n2,
          container,
          anchor,
          <span class="hljs-keyword">namespace</span>,
          optimized
        )
      } else {
        <span class="hljs-comment">// 正常mount mountComponent</span>
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 正常更新 updateComponent</span>
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-attr">mountComponent</span>: <span class="hljs-title class_">MountComponentFn</span> = <span class="hljs-function">(<span class="hljs-params">initialVNode</span>) =&gt;</span> {
    <span class="hljs-comment">// initialVNode 是keepalive的vnode时，把对应的render传入进去，这逻辑其实不重要，只是为了封装复用</span>
    <span class="hljs-comment">// inject renderer internals for keepAlive</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isKeepAlive</span>(initialVNode)) {
      ;(instance.<span class="hljs-property">ctx</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">KeepAliveContext</span>).<span class="hljs-property">renderer</span> = internals
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-attr">unmount</span>: <span class="hljs-title class_">UnmountFn</span> = <span class="hljs-function">(<span class="hljs-params">vnode, parentComponent</span>) =&gt;</span> {
    <span class="hljs-comment">// parentComponent 就是 keepalive</span>
    <span class="hljs-keyword">const</span> { shapeFlag } = vnode
    <span class="hljs-keyword">if</span> (shapeFlag &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">COMPONENT_SHOULD_KEEP_ALIVE</span>) {
      ;(parentComponent!.<span class="hljs-property">ctx</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">KeepAliveContext</span>).<span class="hljs-title function_">deactivate</span>(vnode)
      <span class="hljs-keyword">return</span>
    }
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手封装Iframe父子单向双向通讯功能]]></title>    <link>https://juejin.cn/post/7589466356779597876</link>    <guid>https://juejin.cn/post/7589466356779597876</guid>    <pubDate>2025-12-30T10:01:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589466356779597876" data-draft-id="7589462007528407074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手封装Iframe父子单向双向通讯功能"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-30T10:01:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="red润"/> <meta itemprop="url" content="https://juejin.cn/user/372051848729127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手封装Iframe父子单向双向通讯功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/372051848729127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    red润
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T10:01:52.000Z" title="Tue Dec 30 2025 10:01:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手封装Iframe父子单向双向通讯功能</h2>
<h3 data-id="heading-1">导言</h3>
<blockquote>
<p>最近在研究<strong>多系统</strong>集成到一个<strong>主系统</strong>中，也就是所谓“微前端”，在研究了用微前端框架 <strong>micro-app</strong>和<strong>qiankun</strong>来搭建测试项目，发现似乎有一点麻烦。</p>
<p>因为我的项目不需要复杂的路由跳转，只有简单的数据通讯，似乎用<strong>Iframe</strong>更加符合我当前的业务场景。</p>
</blockquote>
<h3 data-id="heading-2">业务场景分析</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5305370300f4c6694889c65e831aa8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVk5ram:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767693712&amp;x-signature=WQCqwP8JuaqfnRHxZvwx4z1bewY%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>如上图，我将业务场景使用最小demo展示出来</p>
<p>我们使用vue3+hook封装工具函数</p>
</blockquote>
<h4 data-id="heading-3">目前实现的功能</h4>
<blockquote>
<p>我需要父子页面能够<strong>单向</strong>和<strong>双向</strong>的互相通讯</p>
<p>下面是实现的代码片段功能</p>
</blockquote>
<h5 data-id="heading-4">单向数据传输</h5>
<ol start="0">
<li>
<p>父级向子级主动发送数据，子级接收父级发来的数据。</p>
<ul>
<li>
<pre><code class="hljs language-php" lang="php">  <span class="hljs-comment">// 父级向子级主动发送数据</span>
  <span class="hljs-title function_ invoke__">send</span>(<span class="hljs-string">'parent_message'</span>, {
     <span class="hljs-attr"> action</span>: <span class="hljs-string">'update'</span>,
     <span class="hljs-attr"> value</span>: <span class="hljs-string">'Hello from parent'</span>
  });
</code></pre>
</li>
<li>
<pre><code class="hljs language-ini" lang="ini">  // 子级接收父级发来的数据
  on('parent_message', <span class="hljs-attr">data</span> =&gt; {
      <span class="hljs-attr">parentData.value</span> = data<span class="hljs-comment">;</span>
      console.log('收到父应用消息', data)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  // 收到父应用消息 {action: 'update', value: 'Hello from parent'}
</code></pre>
</li>
</ul>
</li>
<li>
<p>子级向父级主送发送数据，父级接收子级发来的数据。</p>
<ul>
<li>
<pre><code class="hljs language-php" lang="php">  <span class="hljs-comment">// 子级向父级主送发送数据</span>
  <span class="hljs-title function_ invoke__">send</span>(<span class="hljs-string">'child_message'</span>, {
     <span class="hljs-attr"> message</span>: <span class="hljs-string">'Hello from child'</span>,
     <span class="hljs-attr"> time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_ invoke__">toISOString</span>()
  });
</code></pre>
  
<pre><code class="hljs language-ini" lang="ini">  // 父级接收子级发来的数据。
  on('child_message', <span class="hljs-attr">data</span> =&gt; {
    <span class="hljs-attr">receivedData.value</span> = data<span class="hljs-comment">;</span>
    console.log('收到子应用消息', data)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  // 收到子应用消息 {message: 'Hello from child', time: '2025-12-30T08:23:38.850Z'}
</code></pre>
</li>
</ul>
</li>
</ol>
<h5 data-id="heading-5">双向数据传输</h5>
<ol start="0">
<li>
<p>父级向子级发起数据获取请求并等待，子级收到请求并响应</p>
<ul>
<li>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 父级向子级发起数据获取请求并等待</span>
  <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendWithResponse</span>(<span class="hljs-string">'get_data'</span>, {
          <span class="hljs-attr">query</span>: <span class="hljs-string">'some data'</span><span class="hljs-comment">// 发给子级的数据</span>
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到子级响应数据'</span>, response);
  } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败'</span>, error);
  }
  <span class="hljs-comment">// 收到子级响应数据 {result: 'data from child', query: 'some data', _responseType: 'get_data_response_1767082999194'}</span>
</code></pre>
</li>
<li>
<pre><code class="hljs language-kotlin" lang="kotlin">  <span class="hljs-comment">// 子级收到请求并响应</span>
  handleRequest(<span class="hljs-string">'get_data'</span>, async <span class="hljs-keyword">data</span> =&gt; {
      <span class="hljs-comment">// 处理数据</span>
      <span class="hljs-keyword">return</span> {
          result: <span class="hljs-string">'data from child'</span>,
          ...<span class="hljs-keyword">data</span>
      };
  });
</code></pre>
</li>
</ul>
</li>
<li>
<p>子级向父级发起数据获取请求并等待，父级收到请求并响应</p>
<ul>
<li>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 子级向父级发起数据获取请求并等待</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendWithResponse</span>(<span class="hljs-string">'get_data'</span>, {
        <span class="hljs-attr">query</span>: <span class="hljs-string">'some data'</span>
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到响应数据'</span>, response);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败'</span>, error);
    }
    收到响应数据 {<span class="hljs-attr">result</span>: <span class="hljs-string">'data from parent'</span>, <span class="hljs-attr">query</span>: <span class="hljs-string">'some data'</span>, <span class="hljs-attr">_responseType</span>: <span class="hljs-string">'get_data_response_1767083018851'</span>}
</code></pre>
</li>
<li>
<pre><code class="hljs language-kotlin" lang="kotlin">  <span class="hljs-comment">// 父级收到请求并响应</span>
    handleRequest(<span class="hljs-string">'get_data'</span>, async <span class="hljs-keyword">data</span> =&gt; {
      <span class="hljs-comment">// 处理数据</span>
      <span class="hljs-keyword">return</span> {
        result: <span class="hljs-string">'data from parent'</span>,
        ...<span class="hljs-keyword">data</span>
      };
    });
</code></pre>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">Iframe通讯原理解析</h3>
<h4 data-id="heading-7">判断是否在iframe嵌套中</h4>
<blockquote>
<p>这是最简单且常用的方法。</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// window.self 表示当前窗口对象，而 window.top 表示最顶层窗口对象。</span>
<span class="hljs-comment">// 如果两者不相等，则说明当前页面被嵌套在 iframe 中。</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">self</span> !== <span class="hljs-variable language_">window</span>.<span class="hljs-property">top</span>) {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"当前页面被嵌套在 iframe 中"</span>);
} <span class="hljs-keyword">else</span> {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"当前页面未被嵌套"</span>);
}
</code></pre>
<h4 data-id="heading-8">核心发送消息逻辑</h4>
<blockquote>
<p>常使用<strong>postMessage</strong>来进行消息发送</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">otherWindow.postMessage(message, targetOrigin, <span class="hljs-section">[transfer]</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>
<p>otherWindow</p>
<ul>
<li>其他窗口的一个引用，比如 iframe 的 contentWindow 属性。</li>
</ul>
</li>
<li>
<p>message</p>
<ul>
<li>将要发送到其他 window 的数据。可以是字符串或者对象类型。</li>
</ul>
</li>
<li>
<p>targetOrigin</p>
<ul>
<li>通过窗口的 origin 属性来指定哪些窗口能<strong>接收到消息事件</strong>，其值可以是字符串"*"（表示无限制）或者一个 URI。</li>
</ul>
</li>
<li>
<p>transfer（一般不传）</p>
<ul>
<li>是一串和 message 同时传递的 <code>Transferable</code> 对象。这些对象的所有权将被转移给消息的接收方，而发送一方将不再保有所有权。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">核心接收消息逻辑</h4>
<blockquote>
<p>父子元素通过 监听 message事件来获取接收到的数据。我们将根据这个函数来封装自己的工具函数</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-comment">// 通过origin对消息进行过滤，避免遭到XSS攻击</span>
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">origin</span> === <span class="hljs-string">'http://xxxx.com'</span>) {
        <span class="hljs-comment">// 判断来源是否和要通讯的地址来源一致</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">data</span>)  <span class="hljs-comment">// 子页面发送的消息, hello, parent!</span>
    }
}, <span class="hljs-literal">false</span>);
</code></pre>
<h3 data-id="heading-10">项目搭建</h3>
<pre><code class="hljs language-bash" lang="bash">src/
├── utils/
│   ├── iframe-comm.js        <span class="hljs-comment"># 父应用通信类</span>
│   └── iframe-comm-child.js  <span class="hljs-comment"># 子应用通信类</span>
├── composables/
│   └── useIframeComm.js      <span class="hljs-comment"># Vue3 组合式函数</span>
├── App.vue                   <span class="hljs-comment"># 父应用主组件</span>
└── main.js
</code></pre>
<h4 data-id="heading-11">使用<strong>vite</strong>创建两个<strong>vue3</strong>项目</h4>
<pre><code class="hljs language-lua" lang="lua">pnpm <span class="hljs-built_in">create</span> vite
</code></pre>
<blockquote>
<p>项目名分别是<strong>Parent</strong>和<strong>Child</strong>,分别代表父级应用和子级应用，除了<strong>App.vue</strong>不一样其他代码都是相同的</p>
<p><img src="" alt="image-20251230164134789" loading="lazy"/></p>
</blockquote>
<h3 data-id="heading-12">源码分析</h3>
<blockquote>
<p>核心逻辑分析</p>
<p>我们首先实现两个工具函数，<strong>iframe-comm.js</strong>和<strong>iframe-comm-child.js</strong>,分别作为父级和子级的工具函数，他们的逻辑大致一样，核心逻辑是：</p>
<ul>
<li>
<p>constructor</p>
<ul>
<li>初始化配置信息，包括连接目标地址，是父级还是子级，事件对象处理合集等</li>
</ul>
</li>
<li>
<p>initMessageListener</p>
<ul>
<li>初始化message事件消息监听</li>
</ul>
</li>
<li>
<p>connect</p>
<ul>
<li>传入iframe元素，为全局对象设置iframe</li>
</ul>
</li>
<li>
<p>send</p>
<ul>
<li>通过postMessage发送消息</li>
</ul>
</li>
<li>
<p>on</p>
<ul>
<li>监听消息，通过new Map(事件类别,[事件回调])，可以实现对多个不同事件监听多个回调函数，后续监听顺序触发回调函数，获取接收到的消息。</li>
</ul>
</li>
<li>
<p>off</p>
<ul>
<li>取消监听消息</li>
</ul>
</li>
<li>
<p>sendWithResponse</p>
<ul>
<li>发送消息并等待响应，发生消息之前，设置一个回调函数，当消息发送成功后，回调函数会被触发，触发后回调函数清楚。</li>
</ul>
</li>
<li>
<p>handleRequest</p>
<ul>
<li>配合sendWithResponse使用，主要监听sendWithResponse事件类别所发来的数据，处理完成并返回结果数据，返回的结果会触发sendWithResponse中设置的回调函数</li>
</ul>
</li>
<li>
<p>destroy</p>
<ul>
<li>销毁实例</li>
</ul>
</li>
</ul>
<p>然后是hook函数<strong>useIframeComm.js</strong>，这个函数主要是封装了上面两个工具方法，方便vue3项目集成使用</p>
<p>如果是react框架可以自行封装hook函数，原生<strong>JS</strong>项目的话，可以直接使用上面的工具函数</p>
<p>然后就是App.vue的实现了,可以直接参照源码</p>
</blockquote>
<h6 data-id="heading-13">src/utils工具函数</h6>
<ul>
<li>
<p>iframe-comm-child.js 供子级使用的工具函数</p>
<ul>
<li>
<pre><code class="hljs language-kotlin" lang="kotlin">  <span class="hljs-comment">// iframe-comm-child.js</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">IframeCommChild</span> {
    <span class="hljs-keyword">constructor</span>(options = {}) {
      <span class="hljs-keyword">this</span>.parentOrigin = options.parentOrigin || window.location.origin;
      <span class="hljs-keyword">this</span>.handlers = new Map();
      <span class="hljs-keyword">this</span>.isParent = <span class="hljs-literal">false</span>;
  ​
      <span class="hljs-comment">// 初始化消息监听</span>
      <span class="hljs-keyword">this</span>.initMessageListener();
    }
  ​
    <span class="hljs-comment">/**
     * 向父应用发送消息
     * <span class="hljs-doctag">@param</span> {string} type - 消息类型
     * <span class="hljs-doctag">@param</span> {any} data - 消息数据
     */</span>
    send(type, <span class="hljs-keyword">data</span>) {
      <span class="hljs-keyword">const</span> message = {
        type,
        <span class="hljs-keyword">data</span>,
        source: <span class="hljs-string">'child'</span>,
        timestamp: Date.now()
      };
  ​
      <span class="hljs-keyword">try</span> {
        window.parent.postMessage(message, <span class="hljs-keyword">this</span>.parentOrigin);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">catch</span> (error) {
        console.error(<span class="hljs-string">'发送消息到父应用失败:'</span>, error);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
  ​
    <span class="hljs-comment">/**
     * 监听消息
     * <span class="hljs-doctag">@param</span> {string} type - 消息类型
     * <span class="hljs-doctag">@param</span> {Function} handler - 处理函数
     */</span>
    on(type, handler) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.handlers.has(type)) {
        <span class="hljs-keyword">this</span>.handlers.<span class="hljs-keyword">set</span>(type, []);
      }
      <span class="hljs-keyword">this</span>.handlers.<span class="hljs-keyword">get</span>(type).push(handler);
    }
  ​
    <span class="hljs-comment">/**
     * 取消监听消息
     * <span class="hljs-doctag">@param</span> {string} type - 消息类型
     * <span class="hljs-doctag">@param</span> {Function} handler - 处理函数
     */</span>
    off(type, handler) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.handlers.has(type)) <span class="hljs-keyword">return</span>;
  ​
      <span class="hljs-keyword">if</span> (handler) {
        <span class="hljs-keyword">const</span> handlers = <span class="hljs-keyword">this</span>.handlers.<span class="hljs-keyword">get</span>(type);
        <span class="hljs-keyword">const</span> index = handlers.indexOf(handler);
        <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
          handlers.splice(index, <span class="hljs-number">1</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.handlers.delete(type);
      }
    }
  ​
    <span class="hljs-comment">/**
     * 自动响应请求
     * <span class="hljs-doctag">@param</span> {string} requestType - 请求类型
     * <span class="hljs-doctag">@param</span> {Function} handler - 处理函数，返回响应数据
     */</span>
    handleRequest(requestType, handler) {
      <span class="hljs-keyword">this</span>.on(requestType, async (<span class="hljs-keyword">data</span>, event) =&gt; {
        <span class="hljs-keyword">const</span> responseType = <span class="hljs-keyword">data</span>?._responseType;
        <span class="hljs-keyword">if</span> (responseType) {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> responseData = await handler(<span class="hljs-keyword">data</span>, event);
            <span class="hljs-keyword">this</span>.send(responseType, {
              success: <span class="hljs-literal">true</span>,
              <span class="hljs-keyword">data</span>: responseData
            });
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-keyword">this</span>.send(responseType, {
              success: <span class="hljs-literal">false</span>,
              error: error.message
            });
          }
        }
      });
    }
  ​
    <span class="hljs-comment">/**
     * 发送消息并等待响应
     * <span class="hljs-doctag">@param</span> {string} type - 消息类型
     * <span class="hljs-doctag">@param</span> {any} data - 消息数据
     * <span class="hljs-doctag">@param</span> {number} timeout - 超时时间(毫秒)
     * <span class="hljs-doctag">@returns</span> {Promise}
     */</span>
    sendWithResponse(type, <span class="hljs-keyword">data</span>, timeout = <span class="hljs-number">5000</span>) {
      <span class="hljs-keyword">return</span> new Promise((resolve, reject) =&gt; {
        <span class="hljs-keyword">const</span> responseType = `${type}_response_${Date.now()}`;
        let timeoutId;
  ​
        <span class="hljs-keyword">const</span> responseHandler = (response) =&gt; {
          clearTimeout(timeoutId);
          <span class="hljs-keyword">this</span>.off(responseType, responseHandler);
          resolve(response.<span class="hljs-keyword">data</span>);
        };
  ​
        <span class="hljs-keyword">this</span>.on(responseType, responseHandler);
  ​
        <span class="hljs-comment">// 发送请求</span>
        <span class="hljs-keyword">const</span> success = <span class="hljs-keyword">this</span>.send(type, {
          ...<span class="hljs-keyword">data</span>,
          _responseType: responseType
        });
  ​
        <span class="hljs-keyword">if</span> (!success) {
          <span class="hljs-keyword">this</span>.off(responseType, responseHandler);
          reject(new Error(<span class="hljs-string">'发送消息失败'</span>));
          <span class="hljs-keyword">return</span>;
        }
  ​
        <span class="hljs-comment">// 设置超时</span>
        timeoutId = setTimeout(() =&gt; {
          <span class="hljs-keyword">this</span>.off(responseType, responseHandler);
          reject(new Error(<span class="hljs-string">'等待响应超时'</span>));
        }, timeout);
      });
    }
  ​
    <span class="hljs-comment">/**
     * 初始化消息监听器
     */</span>
    initMessageListener() {
      window.addEventListener(<span class="hljs-string">'message'</span>, (event) =&gt; {
        <span class="hljs-comment">// 安全检查</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parentOrigin !== <span class="hljs-string">'*'</span> &amp;&amp; event.origin !== <span class="hljs-keyword">this</span>.parentOrigin) {
          <span class="hljs-keyword">return</span>;
        }
  ​
        <span class="hljs-keyword">const</span> { type, <span class="hljs-keyword">data</span>, source } = event.<span class="hljs-keyword">data</span>;
  ​
        <span class="hljs-comment">// 只处理来自父应用的消息</span>
        <span class="hljs-keyword">if</span> (source !== <span class="hljs-string">'parent'</span>) <span class="hljs-keyword">return</span>;
  ​
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.handlers.has(type)) {
          <span class="hljs-keyword">this</span>.handlers.<span class="hljs-keyword">get</span>(type).forEach(handler =&gt; {
            <span class="hljs-keyword">try</span> {
              handler(<span class="hljs-keyword">data</span>, event);
            } <span class="hljs-keyword">catch</span> (error) {
              console.error(`处理消息 ${type} 时出错:`, error);
            }
          });
        }
      });
    }
  ​
    <span class="hljs-comment">/**
     * 销毁实例
     */</span>
    destroy() {
      window.removeEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>.messageHandler);
      <span class="hljs-keyword">this</span>.handlers.clear();
    }
  }
  ​
  export default IframeCommChild;
</code></pre>
</li>
</ul>
</li>
<li>
<p>iframe-comm.js 供父级使用的工具函数</p>
<ul>
<li>
<pre><code class="hljs language-kotlin" lang="kotlin">  <span class="hljs-comment">// iframe-comm.js</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">IframeComm</span> {
    <span class="hljs-keyword">constructor</span>(options = {}) {
      <span class="hljs-keyword">this</span>.origin = options.origin || <span class="hljs-string">'*'</span>;
      <span class="hljs-keyword">this</span>.targetOrigin = options.targetOrigin || window.location.origin;
      <span class="hljs-keyword">this</span>.handlers = new Map();
      <span class="hljs-keyword">this</span>.iframe = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.isParent = <span class="hljs-literal">true</span>;
  ​
      <span class="hljs-comment">// 初始化消息监听</span>
      <span class="hljs-keyword">this</span>.initMessageListener();
    }
  ​
    <span class="hljs-comment">/**
     * 连接到指定iframe
     * <span class="hljs-doctag">@param</span> {HTMLIFrameElement|string} iframe - iframe元素或选择器
     */</span>
    connect(iframe) {
      <span class="hljs-keyword">if</span> (typeof iframe === <span class="hljs-string">'string'</span>) {
        <span class="hljs-keyword">this</span>.iframe = document.querySelector(iframe);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.iframe = iframe;
      }
  ​
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.iframe || !<span class="hljs-keyword">this</span>.iframe.contentWindow) {
        console.error(<span class="hljs-string">'无效的iframe元素'</span>);
        <span class="hljs-keyword">return</span>;
      }
  ​
      <span class="hljs-keyword">this</span>.isParent = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
  ​
    <span class="hljs-comment">/**
     * 向子应用发送消息
     * <span class="hljs-doctag">@param</span> {string} type - 消息类型
     * <span class="hljs-doctag">@param</span> {any} data - 消息数据
     * <span class="hljs-doctag">@param</span> {string} targetOrigin - 目标origin
     */</span>
    send(type, <span class="hljs-keyword">data</span>, targetOrigin = <span class="hljs-keyword">this</span>.targetOrigin) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.iframe?.contentWindow) {
        console.error(<span class="hljs-string">'未连接到iframe或iframe未加载完成'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
  ​
      <span class="hljs-keyword">const</span> message = {
        type,
        <span class="hljs-keyword">data</span>,
        source: <span class="hljs-string">'parent'</span>,
        timestamp: Date.now()
      };
  ​
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.iframe.contentWindow.postMessage(message, targetOrigin);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">catch</span> (error) {
        console.error(<span class="hljs-string">'发送消息失败:'</span>, error);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
  ​
    <span class="hljs-comment">/**
     * 监听消息
     * <span class="hljs-doctag">@param</span> {string} type - 消息类型
     * <span class="hljs-doctag">@param</span> {Function} handler - 处理函数
     */</span>
    on(type, handler) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.handlers.has(type)) {
        <span class="hljs-keyword">this</span>.handlers.<span class="hljs-keyword">set</span>(type, []);
      }
      <span class="hljs-keyword">this</span>.handlers.<span class="hljs-keyword">get</span>(type).push(handler);
    }
  ​
    <span class="hljs-comment">/**
     * 取消监听消息
     * <span class="hljs-doctag">@param</span> {string} type - 消息类型
     * <span class="hljs-doctag">@param</span> {Function} handler - 处理函数
     */</span>
    off(type, handler) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.handlers.has(type)) <span class="hljs-keyword">return</span>;
  ​
      <span class="hljs-keyword">if</span> (handler) {
        <span class="hljs-keyword">const</span> handlers = <span class="hljs-keyword">this</span>.handlers.<span class="hljs-keyword">get</span>(type);
        <span class="hljs-keyword">const</span> index = handlers.indexOf(handler);
        <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
          handlers.splice(index, <span class="hljs-number">1</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.handlers.delete(type);
      }
    }
  ​
    <span class="hljs-comment">/**
     * 发送消息并等待响应
     * <span class="hljs-doctag">@param</span> {string} type - 消息类型
     * <span class="hljs-doctag">@param</span> {any} data - 消息数据
     * <span class="hljs-doctag">@param</span> {number} timeout - 超时时间(毫秒)
     * <span class="hljs-doctag">@returns</span> {Promise}
     */</span>
    sendWithResponse(type, <span class="hljs-keyword">data</span>, timeout = <span class="hljs-number">5000</span>) {
      <span class="hljs-keyword">return</span> new Promise((resolve, reject) =&gt; {
        <span class="hljs-keyword">const</span> responseType = `${type}_response_${Date.now()}`;
        let timeoutId;
  ​
        <span class="hljs-keyword">const</span> responseHandler = (response) =&gt; {
          clearTimeout(timeoutId);
          <span class="hljs-keyword">this</span>.off(responseType, responseHandler);
          resolve(response.<span class="hljs-keyword">data</span>);
        };
  ​
        <span class="hljs-keyword">this</span>.on(responseType, responseHandler);
  ​
        <span class="hljs-comment">// 发送请求</span>
        <span class="hljs-keyword">const</span> success = <span class="hljs-keyword">this</span>.send(type, {
          ...<span class="hljs-keyword">data</span>,
          _responseType: responseType
        });
  ​
        <span class="hljs-keyword">if</span> (!success) {
          <span class="hljs-keyword">this</span>.off(responseType, responseHandler);
          reject(new Error(<span class="hljs-string">'发送消息失败'</span>));
          <span class="hljs-keyword">return</span>;
        }
  ​
        <span class="hljs-comment">// 设置超时</span>
        timeoutId = setTimeout(() =&gt; {
          <span class="hljs-keyword">this</span>.off(responseType, responseHandler);
          reject(new Error(<span class="hljs-string">'等待响应超时'</span>));
        }, timeout);
      });
    }
  ​
    <span class="hljs-comment">/**
     * 初始化消息监听器
     */</span>
    initMessageListener() {
      window.addEventListener(<span class="hljs-string">'message'</span>, (event) =&gt; {
        <span class="hljs-comment">// 安全检查</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.targetOrigin !== <span class="hljs-string">'*'</span> &amp;&amp; event.origin !== <span class="hljs-keyword">this</span>.targetOrigin) {
          <span class="hljs-keyword">return</span>;
        }
  ​
        <span class="hljs-keyword">const</span> { type, <span class="hljs-keyword">data</span>, source } = event.<span class="hljs-keyword">data</span>;
  ​
        <span class="hljs-comment">// 只处理来自子应用的消息</span>
        <span class="hljs-keyword">if</span> (source !== <span class="hljs-string">'child'</span>) <span class="hljs-keyword">return</span>;
  ​
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.handlers.has(type)) {
          <span class="hljs-keyword">this</span>.handlers.<span class="hljs-keyword">get</span>(type).forEach(handler =&gt; {
            <span class="hljs-keyword">try</span> {
              handler(<span class="hljs-keyword">data</span>, event);
            } <span class="hljs-keyword">catch</span> (error) {
              console.error(`处理消息 ${type} 时出错:`, error);
            }
          });
        }
      });
    }
  ​
    <span class="hljs-comment">/**
     * 销毁实例
     */</span>
    destroy() {
      window.removeEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>.messageHandler);
      <span class="hljs-keyword">this</span>.handlers.clear();
      <span class="hljs-keyword">this</span>.iframe = <span class="hljs-literal">null</span>;
    }
  }
  ​
  export default IframeComm;
</code></pre>
</li>
</ul>
</li>
</ul>
<h6 data-id="heading-14">src/composables 钩子函数</h6>
<ul>
<li>
<blockquote>
<p>这里面是核心hook函数</p>
</blockquote>
</li>
</ul>

<ul>
<li>
<p>useIframeComm.js</p>
<ul>
<li>
<pre><code class="hljs language-ini" lang="ini">  // useIframeComm.js
  import { ref, onUnmounted } from 'vue'<span class="hljs-comment">;</span>
  import IframeComm from '../utils/iframe-comm.js'<span class="hljs-comment">;</span>
  import IframeCommChild from '../utils/iframe-comm-child.js'<span class="hljs-comment">;</span>
  ​
  /**
   * Vue3组合式函数 - 父应用
   */
  export function useIframeComm(<span class="hljs-attr">options</span> = {}) {
    const <span class="hljs-attr">comm</span> = ref(null)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">isConnected</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">lastMessage</span> = ref(null)<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">connect</span> = (iframe) =&gt; {
      if (comm.value) {
        comm.value.destroy()<span class="hljs-comment">;</span>
      }
  ​
      <span class="hljs-attr">comm.value</span> = new IframeComm(options)<span class="hljs-comment">;</span>
      comm.value.connect(iframe)<span class="hljs-comment">;</span>
      <span class="hljs-attr">isConnected.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  ​
      // 监听所有消息
      comm.value.on('*', (data, event) =&gt; {
        <span class="hljs-attr">lastMessage.value</span> = { data, timestamp: Date.now() }<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">send</span> = (type, data) =&gt; {
      if (!comm.value) {
        console.error('未连接到iframe')<span class="hljs-comment">;</span>
        return false<span class="hljs-comment">;</span>
      }
      return comm.value.send(type, data)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">on</span> = (type, handler) =&gt; {
      if (comm.value) {
        comm.value.on(type, handler)<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">off</span> = (type, handler) =&gt; {
      if (comm.value) {
        comm.value.off(type, handler)<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">sendWithResponse</span> = async (type, data, timeout) =&gt; {
      try {
        if (!comm.value) {
          throw new Error('未连接到iframe')<span class="hljs-comment">;</span>
        }
        return await comm.value.sendWithResponse(type, data, timeout)<span class="hljs-comment">;</span>
      } catch (error) {
        console.error(error)<span class="hljs-comment">;</span>
  ​
      }
    }<span class="hljs-comment">;</span>
    const <span class="hljs-attr">handleRequest</span> = (requestType, handler) =&gt; {
      if (comm.value) {
        comm.value.handleRequest(requestType, handler)<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
  ​
    onUnmounted(() =&gt; {
      if (comm.value) {
        comm.value.destroy()<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  ​
    return {
      comm,
      isConnected,
      lastMessage,
      connect,
      send,
      on,
      off,
      sendWithResponse,
      handleRequest
    }<span class="hljs-comment">;</span>
  }
  ​
  /**
   * Vue3组合式函数 - 子应用
   */
  export function useIframeCommChild(<span class="hljs-attr">options</span> = {}) {
    const <span class="hljs-attr">comm</span> = ref(null)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">isReady</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">lastMessage</span> = ref(null)<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">init</span> = () =&gt; {
      if (comm.value) {
        comm.value.destroy()<span class="hljs-comment">;</span>
      }
  ​
      <span class="hljs-attr">comm.value</span> = new IframeCommChild(options)<span class="hljs-comment">;</span>
      <span class="hljs-attr">isReady.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  ​
      // 监听所有消息
      comm.value.on('*', (data, event) =&gt; {
        <span class="hljs-attr">lastMessage.value</span> = { data, timestamp: Date.now() }<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">send</span> = (type, data) =&gt; {
      if (!comm.value) {
        console.error('子应用通信未初始化')<span class="hljs-comment">;</span>
        return false<span class="hljs-comment">;</span>
      }
      return comm.value.send(type, data)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">on</span> = (type, handler) =&gt; {
      if (comm.value) {
        comm.value.on(type, handler)<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">off</span> = (type, handler) =&gt; {
      if (comm.value) {
        comm.value.off(type, handler)<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">sendWithResponse</span> = async (type, data, timeout) =&gt; {
      try {
        if (!comm.value) {
          throw new Error('子应用通信未初始化')<span class="hljs-comment">;</span>
        }
        return await comm.value.sendWithResponse(type, data, timeout)<span class="hljs-comment">;</span>
      } catch (error) {
        console.error(error)<span class="hljs-comment">;</span>
  ​
      }
    }<span class="hljs-comment">;</span>
  ​
    const <span class="hljs-attr">handleRequest</span> = (requestType, handler) =&gt; {
      if (comm.value) {
        comm.value.handleRequest(requestType, handler)<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
  ​
    onUnmounted(() =&gt; {
      if (comm.value) {
        comm.value.destroy()<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  ​
    return {
      comm,
      isReady,
      lastMessage,
      init,
      send,
      on,
      off,
      sendWithResponse,
      handleRequest
    }<span class="hljs-comment">;</span>
  }
</code></pre>
</li>
</ul>
</li>
</ul>
<h6 data-id="heading-15">src/App.vue 主代码</h6>
<ul>
<li>
<p>这是父级的App.vue</p>
<ul>
<li>
<blockquote>
<p>父级的端口是5173，所以他要连接到5174</p>
</blockquote>
</li>
<li>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
  <span class="hljs-keyword">import</span> { useIframeComm } <span class="hljs-keyword">from</span> <span class="hljs-string">'./composables/useIframeComm'</span>;
  <span class="hljs-keyword">const</span> iframeRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> receivedData = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-comment">// 初始化通讯</span>
  <span class="hljs-keyword">const</span> { connect, send, on, sendWithResponse, handleRequest, lastMessage } = <span class="hljs-title function_">useIframeComm</span>({
    <span class="hljs-attr">targetOrigin</span>: <span class="hljs-string">'http://localhost:5174'</span>
  });
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onIframeLoad</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">connect</span>(iframeRef.<span class="hljs-property">value</span>);
    <span class="hljs-comment">// 监听子应用</span>
    <span class="hljs-title function_">on</span>(<span class="hljs-string">'child_message'</span>, <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      receivedData.<span class="hljs-property">value</span> = data;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到子应用消息'</span>, data);
    });
    <span class="hljs-title function_">on</span>(<span class="hljs-string">'child_response'</span>, <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到子应用响应'</span>, data);
    });
    <span class="hljs-comment">// 处理请求并自自动响应</span>
    <span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'get_data'</span>, <span class="hljs-keyword">async</span> data =&gt; {
      <span class="hljs-comment">// 处理数据</span>
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">result</span>: <span class="hljs-string">'data from parent'</span>,
        ...data
      };
    });
  };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">send</span>(<span class="hljs-string">'parent_message'</span>, {
      <span class="hljs-attr">action</span>: <span class="hljs-string">'update'</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-string">'Hello from parent'</span>
    });
    <span class="hljs-comment">// 发送并等待响应</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendWithResponse</span>(<span class="hljs-string">'get_data'</span>, {
        <span class="hljs-attr">query</span>: <span class="hljs-string">'some data'</span>
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到子级响应数据'</span>, response);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败'</span>, error);
    }
  };
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  ​
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>父应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"iframeRef"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://localhost:5174"</span> @<span class="hljs-attr">load</span>=<span class="hljs-string">"onIframeLoad"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display: flex; flex-direction: row"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"flex: 2; border: 1px solid black; height: 100px"</span>&gt;</span>接收到的子级消息：{{ receivedData }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"flex: 1"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendMessage"</span>&gt;</span>发送消息到子应用<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  ​
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.parent</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">background-color</span>: white;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-selector-tag">iframe</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
    }
    <span class="hljs-selector-tag">h1</span> {
      <span class="hljs-attribute">text-align</span>: center;
    }
  }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  ​
</code></pre>
</li>
</ul>
</li>
<li>
<p>这是子级的App.vue</p>
<ul>
<li>
<blockquote>
<p>子级的端口是5174，所以他要连接到5173</p>
</blockquote>
</li>
<li>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { onMounted, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
  <span class="hljs-keyword">import</span> { useIframeCommChild } <span class="hljs-keyword">from</span> <span class="hljs-string">'./composables/useIframeComm'</span>;
  <span class="hljs-keyword">const</span> parentData = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> { init, send, on, handleRequest, sendWithResponse } = <span class="hljs-title function_">useIframeCommChild</span>({
    <span class="hljs-attr">parentOrigin</span>: <span class="hljs-string">'http://localhost:5173'</span>
  });
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">init</span>();
    <span class="hljs-title function_">on</span>(<span class="hljs-string">'parent_message'</span>, <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      parentData.<span class="hljs-property">value</span> = data;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到父应用消息'</span>, data);
    });
    <span class="hljs-comment">// 处理请求并自自动响应</span>
    <span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'get_data'</span>, <span class="hljs-keyword">async</span> data =&gt; {
      <span class="hljs-comment">// 处理数据</span>
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">result</span>: <span class="hljs-string">'data from child'</span>,
        ...data
      };
    });
  });
  <span class="hljs-comment">// 发送消息到父级</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendToParent</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">send</span>(<span class="hljs-string">'child_message'</span>, {
      <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello from child'</span>,
      <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
    });
    <span class="hljs-comment">// // 发送响应信息</span>
    <span class="hljs-comment">// send('child_response', { status: 'success' });</span>
    <span class="hljs-comment">// 发送并等待响应</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendWithResponse</span>(<span class="hljs-string">'get_data'</span>, {
        <span class="hljs-attr">query</span>: <span class="hljs-string">'some data'</span>
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到响应数据'</span>, response);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败'</span>, error);
    }
  };
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  ​
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>子应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display: flex; flex-direction: row"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"flex: 2; border: 1px solid black; height: 100px"</span>&gt;</span>接收到的父级消息：{{ parentData }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendToParent"</span>&gt;</span>发送到父应用<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  ​
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.child</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> dashed black;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-selector-tag">h1</span> {
      <span class="hljs-attribute">text-align</span>: center;
    }
  }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  ​
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">结尾</h3>
<p>这个封装方案提供了一个完整、可靠的 Iframe 通信解决方案，适用于各种微前端集成场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[同步的 defer，异步的陷阱：Swift 并发中加载动画关不掉的调试实录]]></title>    <link>https://juejin.cn/post/7589454621718970418</link>    <guid>https://juejin.cn/post/7589454621718970418</guid>    <pubDate>2025-12-30T08:12:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589454621718970418" data-draft-id="7589250237069049866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="同步的 defer，异步的陷阱：Swift 并发中加载动画关不掉的调试实录"/> <meta itemprop="keywords" content="Swift,性能优化"/> <meta itemprop="datePublished" content="2025-12-30T08:12:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JQShan"/> <meta itemprop="url" content="https://juejin.cn/user/1636535083759005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            同步的 defer，异步的陷阱：Swift 并发中加载动画关不掉的调试实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1636535083759005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JQShan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:12:09.000Z" title="Tue Dec 30 2025 08:12:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Swift 并发编程中，<code>defer</code>语句与<code>Task</code>的组合常常暗藏认知偏差，很容易写出 “看似合理、实际失效” 的代码。本文将通过一次真实的调试经历，拆解 “为什么<code>defer</code>中的代码看似合理却没有执行” 的核心原因，并梳理对应的最佳实践与避坑指南。</p>
<h2 data-id="heading-0">场景重现：挥之不去的支付加载动画</h2>
<p>在支付页面的开发中，我们需要实现一个基础功能：支付流程执行完毕后，自动关闭加载动画。最初的代码实现如下，逻辑看似无懈可击，但实际运行中，加载动画偶尔会 “幽灵般” 无法关闭。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">processPayment</span>() {
    <span class="hljs-type">Task</span> {
        showLoading <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        
        <span class="hljs-keyword">defer</span> {
            <span class="hljs-comment">// 主观预期：此处代码会可靠执行，关闭加载动画</span>
            <span class="hljs-type">Task</span> { <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span>
                showLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
            }
        }
        
        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> paymentService.pay()
        handleResult(result)
    }
}
</code></pre>
<h2 data-id="heading-1">核心知识点拆解：问题的本质</h2>
<h3 data-id="heading-2">知识点 1：<code>defer</code>的执行边界 —— 仅保证同步代码可靠执行</h3>
<p><code>defer</code>语句的核心特性是<strong>在当前作用域退出时必然执行</strong>，无论作用域是正常返回、抛出错误还是被取消。但这一 “必然执行” 的保证，仅针对<code>defer</code>块内的同步代码。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">example</span>() {
    <span class="hljs-keyword">defer</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 我一定会执行（同步代码）"</span>)
        
        <span class="hljs-type">Task</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 我可能不会执行（异步任务）"</span>)
        }
    }
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 正常业务代码"</span>)
}
</code></pre>
<p>上述代码中，<code>print("1. 我一定会执行")</code>会百分百触发，但内部创建的异步<code>Task</code>可能还未被系统调度，当前作用域就已完全销毁，导致异步任务无法执行。</p>
<h3 data-id="heading-3">知识点 2：Swift <code>Task</code>的取消特性 —— 协作式而非强制式</h3>
<p>Swift 的<code>Task</code>取消遵循 “协作式” 原则，而非强制终止任务运行。这一特性决定了<code>defer</code>本身的执行稳定性，但无法保障<code>defer</code>内新创建异步任务的执行。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Task</span> {
    <span class="hljs-keyword">defer</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"即使任务被取消，我也会执行"</span>)
    }
    
    <span class="hljs-comment">// 此处会自动检查任务取消状态</span>
    <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> someAsyncWork()
    
    <span class="hljs-comment">// 若任务被取消，上面的await会抛出CancellationError</span>
    <span class="hljs-comment">// 但defer块仍会不受影响地执行</span>
}
</code></pre>
<p>关键痛点：<code>defer</code>块本身会可靠执行，但其中新创建的异步任务，可能因调度延迟、上下文销毁等问题，无法正常执行后续逻辑。</p>
<h3 data-id="heading-4">知识点 3：页面销毁时的 “时间差”—— 状态失效的隐形杀手</h3>
<p>当支付流程完成后执行页面销毁操作时，时序上的错位会直接导致加载动画关闭逻辑失效，这也是问题复现的核心场景。</p>
<h4 data-id="heading-5">问题时序线</h4>
<ol>
<li><code>await paymentService.pay()</code>执行完成，<code>dismissPage()</code>被调用，页面开始销毁流程</li>
<li>SwiftUI 框架开始销毁当前 View 实例，释放相关资源</li>
<li>View 中的<code>@State</code>（<code>showLoading</code>）等状态变量被清理失效</li>
<li>外层<code>Task</code>作用域退出，<code>defer</code>块执行，创建新的异步<code>Task</code></li>
<li>新<code>Task</code>尚未被系统调度，View 已完全销毁</li>
<li>即便后续新<code>Task</code>被调度执行，<code>showLoading = false</code>对已销毁的 View 无任何效果，动画无法关闭</li>
</ol>
<h2 data-id="heading-6">正确解决方案：抛弃 “嵌套异步”，直接主线程同步执行</h2>
<p>解决该问题的核心思路是：<strong>避免在<code>defer</code>中创建新异步任务，直接通过<code>await MainActor.run</code>在主线程同步执行 UI 更新操作</strong>，消除调度延迟与上下文失效的风险。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">processPayment</span>() {
    <span class="hljs-type">Task</span> {
        <span class="hljs-comment">// 主线程开启加载动画</span>
        <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
            showLoading <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        }
        
        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> paymentService.pay()
        
        <span class="hljs-comment">// ✅ 最优解：主线程同步执行，确保逻辑可靠触发</span>
        <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
            showLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
            handleResult(result)
        }
    }
}
</code></pre>
<h3 data-id="heading-7">该方案的优势</h3>
<ol>
<li><code>await MainActor.run</code>会阻塞当前<code>Task</code>，等待主线程上的 UI 操作执行完成后再继续，无调度延迟</li>
<li>不创建新的异步<code>Task</code>，直接复用外层<code>Task</code>上下文，避免上下文销毁导致的逻辑失效</li>
<li>即使外层<code>Task</code>被取消，<code>await</code>之前的代码已执行完毕，<code>await</code>内的逻辑也会优先完成核心清理工作</li>
</ol>
<h2 data-id="heading-8">延伸知识点：Swift Task 生命周期深度解析</h2>
<h3 data-id="heading-9">1. Task 的三种核心创建方式</h3>

























<table><thead><tr><th>创建方式</th><th>特性</th><th>适用场景</th></tr></thead><tbody><tr><td>结构化并发（推荐）<code>Task { /* 代码 */ }</code></td><td>继承当前上下文（Actor、优先级、取消状态等）</td><td>大部分业务场景，依赖当前上下文的异步操作</td></tr><tr><td>非结构化并发<code>Task.detached { /* 代码 */ }</code></td><td>拥有独立执行上下文，不继承当前环境</td><td>无需依赖当前上下文的独立异步任务</td></tr><tr><td>指定 Actor 执行<code>Task { @MainActor in /* 代码 */ }</code></td><td>绑定指定 Actor（如主线程）执行，自动处理线程切换</td><td>直接更新 UI 或操作 Actor 内状态的场景</td></tr></tbody></table>
<h3 data-id="heading-10">2. Task 的取消检查点</h3>
<p><code>Task</code>仅在特定时机自动检查取消状态，非检查点内的长时间同步代码会无视取消指令，导致任务 “无法终止”。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Task</span> {
    <span class="hljs-comment">// ✅ 自动检查取消状态的时机</span>
    <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> someAsyncOperation() <span class="hljs-comment">// 异步等待时自动检查</span>
    <span class="hljs-keyword">try</span> <span class="hljs-type">Task</span>.checkCancellation()   <span class="hljs-comment">// 手动主动检查取消状态</span>
    <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.yield()             <span class="hljs-comment">// 让出执行权时自动检查</span>
    
    <span class="hljs-comment">// ❌ 不检查取消状态的场景</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">1000000</span> {
        <span class="hljs-comment">// 长时间同步循环，不会响应取消指令</span>
        heavySyncWork(i)
    }
}
</code></pre>
<h3 data-id="heading-11">3. 多任务管理：TaskGroup 的使用</h3>
<p>当需要并行执行多个异步任务并统一管理时，<code>TaskGroup</code>是最优选择，可实现批量任务添加、结果汇总、批量取消等功能。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">await</span> withTaskGroup(of: <span class="hljs-type">Result</span>.<span class="hljs-keyword">self</span>) { group <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// 批量添加任务</span>
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items {
        group.addTask {
            <span class="hljs-keyword">await</span> processItem(item)
        }
    }
    
    <span class="hljs-comment">// 按需批量取消所有任务（如某个任务失败时）</span>
    <span class="hljs-comment">// group.cancelAll()</span>
    
    <span class="hljs-comment">// 遍历获取所有任务结果</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> result <span class="hljs-keyword">in</span> group {
        handleTaskResult(result)
    }
}
</code></pre>
<h2 data-id="heading-12">最佳实践总结</h2>
<h3 data-id="heading-13">✅ 推荐做法</h3>
<ol>
<li>UI 更新优先使用<code>await MainActor.run</code>，同步执行确保逻辑可靠</li>
<li>坚决避免在<code>defer</code>块中创建新的异步<code>Task</code>，规避调度与上下文风险</li>
<li>优先采用结构化并发（默认<code>Task</code>）管理任务生命周期，简化上下文继承</li>
<li>在长时间异步流程中，主动添加取消检查点（<code>try Task.checkCancellation()</code>）</li>
<li>多任务并行场景，使用<code>TaskGroup</code>实现统一管理与批量控制</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 标准优雅的代码示例</span>
<span class="hljs-type">Task</span> {
    <span class="hljs-comment">// 第一步：主线程更新UI（开启加载/更新状态）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
        updateUI()
    }
    
    <span class="hljs-comment">// 第二步：执行核心异步业务逻辑</span>
    <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> processData()
    
    <span class="hljs-comment">// 第三步：主线程同步更新结果/关闭加载</span>
    <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
        showResult(result)
    }
}
</code></pre>
<h3 data-id="heading-14">❌ 避免做法</h3>
<ol>
<li>在<code>defer</code>中创建异步<code>Task</code>执行清理或 UI 更新操作</li>
<li>主观假设异步任务会被 “立即调度执行”</li>
<li>忽略<code>Task</code>的取消状态，导致长时间任务无法终止</li>
<li>滥用<code>Task.detached</code>（非结构化并发），增加上下文管理成本</li>
<li>直接在非主线程<code>Task</code>中修改<code>@State</code>等 UI 相关状态</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 需坚决规避的不良代码</span>
<span class="hljs-keyword">defer</span> {
    <span class="hljs-type">Task</span> { <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span>
        cleanup()  <span class="hljs-comment">// 可能因调度延迟或上下文销毁而无法执行</span>
    }
}
</code></pre>
<h2 data-id="heading-15">实用调试技巧</h2>
<h3 data-id="heading-16">1. 日志追踪：明确代码执行时序</h3>
<p>通过添加有序日志，可快速定位<code>defer</code>与<code>Task</code>的执行顺序，排查是否存在异步任务未执行的问题。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Task</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 外层Task开始执行"</span>)
    <span class="hljs-keyword">defer</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. defer块开始执行"</span>)
    }
    
    <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. MainActor.run内UI操作执行"</span>)
    }
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 外层Task即将结束"</span>)
}
</code></pre>
<h3 data-id="heading-17">2. 主动检查：确认 Task 取消状态</h3>
<p>在关键业务节点主动检查任务取消状态，可提前终止无效逻辑，避免资源浪费。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Task</span> {
    <span class="hljs-comment">// 关键节点检查取消状态</span>
    <span class="hljs-keyword">if</span> <span class="hljs-type">Task</span>.isCancelled {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"任务已被取消，终止后续操作"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// 继续执行核心业务逻辑</span>
    <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> processBusiness()
}
</code></pre>
<h3 data-id="heading-18">3. 优先级控制：确保关键任务优先执行</h3>
<p>通过指定<code>Task</code>优先级，可让核心业务（如支付结果处理、加载动画关闭）优先被系统调度，减少执行延迟。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 高优先级：用户主动触发的核心操作</span>
<span class="hljs-type">Task</span>(priority: .userInitiated) {
    <span class="hljs-keyword">await</span> processPayment()
}

<span class="hljs-comment">// 低优先级：后台无关紧要的辅助操作</span>
<span class="hljs-type">Task</span>(priority: .utility) {
    <span class="hljs-keyword">await</span> syncLocalData()
}
</code></pre>
<h2 data-id="heading-19">结语：让 Swift 并发代码更可靠</h2>
<p>Swift 并发编程的核心难点，在于理解同步操作与异步操作的执行边界，以及<code>Task</code>的生命周期管理。<code>defer</code>语句的 “同步可靠性” 与<code>Task</code>的 “异步调度性” 形成的反差，是导致加载动画无法关闭的根本原因。</p>
<p>在实际开发中，只要遵循 “避免<code>defer</code>内嵌套异步任务”“优先使用<code>await MainActor.run</code>更新 UI”“采用结构化并发管理任务” 的原则，就能有效避开这类隐形陷阱，让代码从 “应该会工作” 变成 “必然会工作”，构建更稳定、更可靠的并发逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 多线程通关指南：从 GCD 回调地狱到 Task/Actor 躺赢]]></title>    <link>https://juejin.cn/post/7589454621719117874</link>    <guid>https://juejin.cn/post/7589454621719117874</guid>    <pubDate>2025-12-30T08:32:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589454621719117874" data-draft-id="7589509638339756058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 多线程通关指南：从 GCD 回调地狱到 Task/Actor 躺赢"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-12-30T08:32:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JQShan"/> <meta itemprop="url" content="https://juejin.cn/user/1636535083759005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 多线程通关指南：从 GCD 回调地狱到 Task/Actor 躺赢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1636535083759005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JQShan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T08:32:13.000Z" title="Tue Dec 30 2025 08:32:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>各位 iOS 开发者宝子们，谁还没被多线程折磨过？想当年用 GCD 的时候，回调嵌套像套娃，线程安全像走钢丝，查个数据错乱的 Bug 能熬到半夜发际线后移。直到 Swift 5.5 甩出了「并发框架」这个王炸，Task 和 Actor 闪亮登场，才让我们摆脱了 “多线程 PUA”。</p>
<p>今天这篇博客，咱们就用 “唠嗑式” 风格，把 Task、Actor 的原理、用法、最佳实践和避坑指南讲得明明白白，保证你看得懂、用得上，还能顺便笑出声。</p>
<h2 data-id="heading-0">一、前言：那些年我们踩过的 GCD 坑</h2>
<p>在聊新东西之前，先扎心回顾一下 GCD 的 “罪行”：</p>
<ol>
<li><strong>回调地狱</strong>：请求接口→解析数据→更新 UI，三层嵌套下去，代码像俄罗斯套娃，后期维护看一眼就脑壳疼；</li>
<li><strong>线程安全玄学</strong>：多个线程同时修改一个变量，时而正常时而崩溃，数据错乱的 Bug 查半天，最后发现是忘了加<code>dispatch_barrier</code>；</li>
<li><strong>生命周期失控</strong>：手动创建的队列和任务，一不小心就忘记取消，导致内存泄漏或无效操作；</li>
<li><strong>主线程判断麻烦</strong>：更新 UI 前还要写<code>if Thread.isMainThread</code>，稍不注意就闪退。</li>
</ol>
<p>直到 Swift 并发框架上线，Task（异步任务包工头）和 Actor（线程安全管理员）强强联手，才让多线程开发从 “渡劫” 变成 “躺赢”。接下来，咱们逐个拆解这两个核心玩家。</p>
<h2 data-id="heading-1">二、核心玩家 1：Task —— 异步任务的 “包工头”</h2>
<h3 data-id="heading-2">1. 什么是 Task？通俗点说就是 “干活的包工头”</h3>
<p>你可以把 Task 理解为一个包工头，你给它分配活（异步代码），它会帮你安排工人（线程）去干，还能告诉你啥时候干完（通过<code>await</code>等待结果）。</p>
<p>它的核心作用是<strong>封装异步操作</strong>，摆脱 GCD 的闭包嵌套，让异步代码像同步代码一样线性书写 —— 这也是 Swift 并发的核心优势：<strong>异步代码同步化</strong>。</p>
<h3 data-id="heading-3">2. Task 的核心原理：结构化 vs 非结构化（家族企业 vs 野生放养）</h3>
<p>Task 有两种核心形态，这是理解它的关键，咱们用比喻讲清楚：</p>
<h4 data-id="heading-4">（1）结构化并发（默认 Task）：家族企业，父子绑定</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 结构化Task：父任务（包工头老板）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">parentTask</span>() <span class="hljs-keyword">async</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"老板：我要安排个小工干活"</span>)
    <span class="hljs-comment">// 子任务（小工）：继承父任务的上下文（优先级、取消状态等）</span>
    <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"小工：开始干活"</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(<span class="hljs-number">1_000_000_000</span>) <span class="hljs-comment">// 干活1秒</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"活干完了"</span>
    }.value
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"老板：小工汇报结果：(result)"</span>)
}
</code></pre>
<p><strong>核心特性（家族企业规则）</strong> ：</p>
<ul>
<li>父任务会等子任务干完才继续执行（老板等小工汇报）；</li>
<li>子任务继承父任务的 “家底”：优先级、Actor 上下文、取消状态等；</li>
<li>父任务被取消，子任务会跟着被取消（老板跑路，小工也停工）；</li>
<li>编译器会自动管理任务生命周期，不用手动操心内存泄漏。</li>
</ul>
<p>这是 Swift 官方<strong>强烈推荐</strong>的用法，也是最安全、最省心的方式。</p>
<h4 data-id="heading-5">（2）非结构化并发（Task.detached）：野生放养，自生自灭</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 非结构化Task：野生包工头，和你没关系</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">wildTask</span>() {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"我：安排个野生包工头干活"</span>)
    <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span>.detached {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"野生包工头：自己干自己的"</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(<span class="hljs-number">1_000_000_000</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"野生活干完了"</span>
    }
    
    <span class="hljs-comment">// 想拿结果得主动等</span>
    <span class="hljs-type">Task</span> {
        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> task.value
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"我：野生包工头汇报结果：(result)"</span>)
    }
}
</code></pre>
<p><strong>核心特性（野生规则）</strong> ：</p>
<ul>
<li>不继承任何上下文（优先级、Actor 等都是默认值）；</li>
<li>和创建它的线程 / 任务 “断绝关系”，父不管子，子不认父；</li>
<li>生命周期完全由你手动管理，忘记取消就可能导致内存泄漏；</li>
<li>仅适用于 “不需要依赖当前上下文，完全独立的任务”（比如后台同步日志）。</li>
</ul>
<h3 data-id="heading-6">3. Task 的 3 种常用创建方式（代码示例 + 场景）</h3>

























<table><thead><tr><th>创建方式</th><th>代码示例</th><th>适用场景</th></tr></thead><tbody><tr><td>结构化 Task（默认）</td><td><code>Task { await doSomething() }</code></td><td>大部分业务场景（接口请求、数据处理等），依赖当前上下文</td></tr><tr><td>非结构化 Task</td><td><code>Task.detached { await doSomething() }</code></td><td>独立后台任务（日志同步、缓存清理等），不依赖当前上下文</td></tr><tr><td>指定 Actor Task</td><td><code>Task { @MainActor in updateUI() }</code></td><td>直接切换到指定 Actor（如 MainActor 更新 UI）</td></tr></tbody></table>
<h3 data-id="heading-7">4. Task 的小知识点（必知必会）</h3>
<ul>
<li><strong>优先级</strong>：可以给 Task 指定优先级，系统会优先调度高优先级任务（比如支付＞后台同步）：</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 高优先级：用户主动操作</span>
<span class="hljs-type">Task</span>(priority: .userInitiated) {
    <span class="hljs-keyword">await</span> processPayment()
}
<span class="hljs-comment">// 低优先级：后台辅助操作</span>
<span class="hljs-type">Task</span>(priority: .utility) {
    <span class="hljs-keyword">await</span> syncLocalCache()
}
</code></pre>
<ul>
<li><strong>取消</strong>：Task 的取消是 “协作式” 的（不是强制枪毙，是提醒任务自己停工）：</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
    <span class="hljs-comment">// 干活前先检查是否被取消</span>
    <span class="hljs-keyword">if</span> <span class="hljs-type">Task</span>.isCancelled {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">await</span> doSomething()
    <span class="hljs-comment">// 干活中途也可以检查</span>
    <span class="hljs-keyword">try</span> <span class="hljs-type">Task</span>.checkCancellation()
    <span class="hljs-keyword">await</span> doSomethingElse()
}
<span class="hljs-comment">// 手动取消任务</span>
task.cancel()
</code></pre>
<ul>
<li><strong>等待结果</strong>：用<code>await task.value</code>可以获取 Task 的执行结果，结构化 Task 也可以直接内联等待。</li>
</ul>
<h2 data-id="heading-8">三、核心玩家 2：Actor —— 线程安全的 “卫生间管理员”</h2>
<h3 data-id="heading-9">1. 线程安全的痛点：多个人抢卫生间的噩梦</h3>
<p>先想一个场景：你和同事们共用一个卫生间（共享变量），如果没有管理员，大家同时挤进去，场面会极度混乱（数据错乱、崩溃）。</p>
<p>在多线程中，这个 “卫生间” 就是共享变量（比如<code>var userList: [User]</code>），“抢卫生间” 就是多个线程同时读写这个变量，这也是 GCD 中最头疼的问题。</p>
<h3 data-id="heading-10">2. 什么是 Actor？通俗点说就是 “卫生间管理员”</h3>
<p>Actor 的核心作用是<strong>保证线程安全</strong>，它就像一个严格的卫生间管理员，遵守一个铁律：<strong>一次只允许一个线程（人）进入 Actor 的 “私人空间”（内部属性和方法）</strong> 。</p>
<p>这样一来，就从根本上杜绝了 “多线程同时读写共享变量” 的问题，不用再手动加锁、加屏障，编译器会帮你搞定一切。</p>
<h3 data-id="heading-11">3. Actor 的核心原理：隔离域 + 消息传递</h3>
<p>Actor 的底层原理其实很简单，就两个关键点，咱们用大白话解释：</p>
<h4 data-id="heading-12">（1）隔离域（私人空间）</h4>
<p>每个 Actor 都有自己的 “隔离域”，相当于卫生间的围墙，外部线程无法直接访问 Actor 内部的属性和方法，只能通过管理员（Actor）传递消息。</p>
<p>比如你不能直接写<code>actor.userList = []</code>，编译器会直接报错 —— 这就像你不能直接踹开卫生间门，只能跟管理员说 “我要进去”。</p>
<h4 data-id="heading-13">（2）消息传递（排队叫号）</h4>
<p>外部线程想要操作 Actor 的内部资源，需要给 Actor 发送 “消息”（调用 Actor 的方法），Actor 会把这些消息排成一个队列，然后串行处理（一个接一个，不插队）。</p>
<p>这就像你跟管理员说 “我要进去”，管理员会把你排到队尾，等前面的人出来，再让你进去，完美保证了安全。</p>
<h3 data-id="heading-14">4. Actor 的使用方法（代码示例 + 场景）</h3>
<h4 data-id="heading-15">（1）自定义 Actor：创建你的 “卫生间管理员”</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 定义一个Actor：用户列表管理员</span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">UserManager</span> {
    <span class="hljs-comment">// 内部共享变量（卫生间）：外部无法直接访问</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> userList: [<span class="hljs-type">String</span>] <span class="hljs-operator">=</span> []
    
    <span class="hljs-comment">// 提供方法（叫号服务）：外部可以通过await调用</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">addUser</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">name</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-comment">// 这里的代码串行执行，绝对线程安全</span>
        userList.append(name)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"添加用户：(name)，当前列表：(userList)"</span>)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getUserList</span>() -&gt; [<span class="hljs-type">String</span>] {
        <span class="hljs-keyword">return</span> userList
    }
}

<span class="hljs-comment">// 使用Actor</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">useUserManager</span>() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 创建Actor实例</span>
    <span class="hljs-keyword">let</span> manager <span class="hljs-operator">=</span> <span class="hljs-type">UserManager</span>()
    
    <span class="hljs-comment">// 调用Actor方法：必须加await（等管理员叫号）</span>
    <span class="hljs-keyword">await</span> manager.addUser(<span class="hljs-string">"张三"</span>)
    <span class="hljs-keyword">await</span> manager.addUser(<span class="hljs-string">"李四"</span>)
    
    <span class="hljs-comment">// 获取用户列表</span>
    <span class="hljs-keyword">let</span> list <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> manager.getUserList()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"最终用户列表：(list)"</span>)
}
</code></pre>
<p><strong>关键注意点</strong>：调用 Actor 的任何方法都必须加<code>await</code>，因为 Actor 处理消息需要时间，这是一个异步操作。</p>
<h4 data-id="heading-16">（2）MainActor：专属主线程的 “UI 管理员”</h4>
<p>除了自定义 Actor，Swift 还提供了一个特殊的 Actor——<code>MainActor</code>，它专门绑定主线程，是更新 UI 的 “专属通道”。</p>
<p>我们知道，UI 操作必须在主线程执行，以前用 GCD 要写<code>dispatch_async(dispatch_get_main_queue())</code>，现在用<code>MainActor</code>更简单：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 方式1：修饰函数，整个函数在主线程执行</span>
<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">updateUserName</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">name</span>: <span class="hljs-type">String</span>) {
    <span class="hljs-comment">// 这里的代码一定在主线程执行，放心更新UI</span>
    <span class="hljs-keyword">self</span>.userNameLabel.text <span class="hljs-operator">=</span> name
}

<span class="hljs-comment">// 方式2：修饰属性，属性的读写都在主线程</span>
<span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">var</span> userAvatar: <span class="hljs-type">UIImage</span>?

<span class="hljs-comment">// 方式3：在Task中指定MainActor</span>
<span class="hljs-type">Task</span> { <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">self</span>.userNameLabel.text <span class="hljs-operator">=</span> <span class="hljs-string">"张三"</span>
}

<span class="hljs-comment">// 方式4：await MainActor.run 局部切换主线程</span>
<span class="hljs-type">Task</span> {
    <span class="hljs-comment">// 后台执行耗时操作</span>
    <span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> fetchUser()
    <span class="hljs-comment">// 切换到主线程更新UI</span>
    <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
        <span class="hljs-keyword">self</span>.userNameLabel.text <span class="hljs-operator">=</span> user.name
    }
}
</code></pre>
<p><strong>MainActor 是 UI 更新的首选</strong>，不用再手动判断主线程，编译器会帮你保证 UI 操作在主线程执行，杜绝闪退。</p>
<h3 data-id="heading-17">5. Actor 的小知识点（必知必会）</h3>
<ul>
<li><strong>Actor 重入</strong>：Actor 允许 “嵌套调用”，比如 Actor 的方法 A 调用了方法 B，这是允许的，且仍然串行执行；</li>
<li><strong>Actor 间通信</strong>：多个 Actor 之间调用方法，同样需要加<code>await</code>，编译器会自动处理消息传递；</li>
<li><strong>不可变属性</strong>：Actor 的不可变属性（<code>let</code>）可以直接访问（不用<code>await</code>），因为不可变属性不会有线程安全问题。</li>
</ul>
<h2 data-id="heading-18">四、黄金搭档：Task + Actor 实战演练</h2>
<p>光说不练假把式，咱们结合实际业务场景，看看 Task 和 Actor 怎么配合使用：</p>
<h3 data-id="heading-19">场景：接口请求 + 数据解析 + UI 更新（线程安全版）</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 1. 定义数据存储Actor（保证线程安全）</span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">DataStore</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> userData: <span class="hljs-type">UserModel</span>?
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">saveUser</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">user</span>: <span class="hljs-type">UserModel</span>) {
        userData <span class="hljs-operator">=</span> user
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getUser</span>() -&gt; <span class="hljs-type">UserModel</span>? {
        <span class="hljs-keyword">return</span> userData
    }
}

<span class="hljs-comment">// 2. 接口请求函数（后台执行）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchUserFromAPI</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UserModel</span> {
    <span class="hljs-comment">// 模拟接口请求（后台线程）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(<span class="hljs-number">1_000_000_000</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-type">UserModel</span>(name: <span class="hljs-string">"李四"</span>, age: <span class="hljs-number">25</span>)
}

<span class="hljs-comment">// 3. 核心业务逻辑（Task + Actor + MainActor）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">loadUserData</span>() {
    <span class="hljs-comment">// 结构化Task：管理异步流程</span>
    <span class="hljs-type">Task</span> {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-comment">// 步骤1：主线程显示加载动画</span>
            <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
                <span class="hljs-keyword">self</span>.loadingView.isHidden <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
            }
            
            <span class="hljs-comment">// 步骤2：后台请求接口（非主线程，不卡顿UI）</span>
            <span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> fetchUserFromAPI()
            
            <span class="hljs-comment">// 步骤3：线程安全存储数据</span>
            <span class="hljs-keyword">let</span> dataStore <span class="hljs-operator">=</span> <span class="hljs-type">DataStore</span>()
            <span class="hljs-keyword">await</span> dataStore.saveUser(user)
            
            <span class="hljs-comment">// 步骤4：主线程更新UI + 隐藏加载动画</span>
            <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
                <span class="hljs-keyword">self</span>.userNameLabel.text <span class="hljs-operator">=</span> user.name
                <span class="hljs-keyword">self</span>.ageLabel.text <span class="hljs-operator">=</span> <span class="hljs-string">"(user.age)"</span>
                <span class="hljs-keyword">self</span>.loadingView.isHidden <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            }
            
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-comment">// 异常处理：主线程隐藏加载动画 + 提示错误</span>
            <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
                <span class="hljs-keyword">self</span>.loadingView.isHidden <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
                <span class="hljs-keyword">self</span>.toastLabel.text <span class="hljs-operator">=</span> <span class="hljs-string">"请求失败：(error.localizedDescription)"</span>
            }
        }
    }
}
</code></pre>
<p>这个示例完美结合了 Task（异步流程管理）、Actor（数据存储线程安全）、MainActor（UI 更新），没有回调嵌套，线程安全有保障，UI 不卡顿，这就是 Swift 并发的正确打开方式！</p>
<h2 data-id="heading-20">五、最佳实践：少踩坑，多摸鱼</h2>
<p>掌握了原理和用法，接下来的最佳实践能让你在实际开发中事半功倍，少走弯路：</p>
<h3 data-id="heading-21">1. 优先使用结构化 Task，拒绝放养式 Task.detached</h3>
<p>结构化 Task 的生命周期由编译器管理，安全省心，90% 的场景都用它。只有在需要完全独立的后台任务（如日志同步）时，才考虑 Task.detached，且一定要手动管理取消。</p>
<h3 data-id="heading-22">2. UI 更新认准 MainActor，别在后台瞎折腾</h3>
<p>无论用<code>@MainActor</code>修饰函数、还是<code>await MainActor.run</code>，都要保证 UI 操作在主线程执行，这是杜绝 UI 闪退和卡顿的关键。</p>
<h3 data-id="heading-23">3. Actor 里只放线程不安全的状态，别啥都往里塞</h3>
<p>Actor 的方法是串行执行的，如果把非共享的、不需要线程安全的逻辑也放进 Actor，会降低执行效率。Actor 只负责管理 “共享可变状态”（如用户列表、缓存数据）。</p>
<h3 data-id="heading-24">4. 用 TaskGroup 管理多任务，批量控制更省心</h3>
<p>如果需要并行执行多个任务（如批量请求接口），用<code>TaskGroup</code>比手动创建多个 Task 更方便，支持批量添加、批量取消、批量获取结果：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">await</span> withTaskGroup(of: <span class="hljs-type">UserModel</span>.<span class="hljs-keyword">self</span>) { group <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// 批量添加任务</span>
    <span class="hljs-keyword">for</span> userId <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>] {
        group.addTask {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> fetchUserById(userId)
        }
    }
    
    <span class="hljs-comment">// 批量获取结果</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> user <span class="hljs-keyword">in</span> group {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取到用户：(user.name)"</span>)
    }
}
</code></pre>
<h3 data-id="heading-25">5. defer 里别乱创 Task，小心 “幽灵任务”</h3>
<p>这是咱们之前踩过的坑：<code>defer</code>块里创建的异步 Task，可能因为上下文销毁而无法执行（比如页面关闭后，Task 还没被调度），导致加载动画关不掉、资源清理不彻底。</p>
<h3 data-id="heading-26">6. 关键节点检查 Task 取消状态，避免无效操作</h3>
<p>如果用户中途退出页面，对应的 Task 应该被取消，在耗时操作前后检查<code>Task.isCancelled</code>或<code>try Task.checkCancellation()</code>，可以及时终止无效操作，节省资源。</p>
<h2 data-id="heading-27">六、避坑指南：那些让你头秃的坑</h2>
<p>即使掌握了最佳实践，也难免踩坑，这些坑你一定要警惕：</p>
<h3 data-id="heading-28">1. 坑 1：Actor 重入 —— 看似串行，实则可能嵌套执行</h3>
<p>Actor 允许方法嵌套调用，比如：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">MyActor</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">methodA</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"A开始"</span>)
        <span class="hljs-keyword">await</span> methodB()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"A结束"</span>)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">methodB</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"B执行"</span>)
    }
}
</code></pre>
<p>调用<code>await myActor.methodA()</code>时，会输出 “A 开始→B 执行→A 结束”，这是正常的，且仍然线程安全，不用过度担心。</p>
<h3 data-id="heading-29">2. 坑 2：Task 取消是 “协作式”，不是 “强制枪毙”</h3>
<p>Task 不会被强制终止，只有在 “取消检查点” 才会响应取消：</p>
<ul>
<li>✅ 取消检查点：<code>await</code>异步操作、<code>try Task.checkCancellation()</code>、<code>await Task.yield()</code></li>
<li>❌ 非检查点：长时间同步循环（如<code>for i in 0..&lt;1000000</code>），不会响应取消</li>
</ul>
<p>如果有长时间同步代码，要手动插入取消检查：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Task</span> {
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">1000000</span> {
        <span class="hljs-comment">// 手动检查取消状态</span>
        <span class="hljs-keyword">if</span> <span class="hljs-type">Task</span>.isCancelled {
            <span class="hljs-keyword">return</span>
        }
        heavySyncWork(i)
    }
}
</code></pre>
<h3 data-id="heading-30">3. 坑 3：在 MainActor 函数里执行耗时操作，导致 UI 卡顿</h3>
<p><code>@MainActor</code>修饰的函数会在主线程执行，如果在里面执行耗时操作（如大数据解析、复杂加密），会阻塞主线程，导致 UI 卡顿：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 错误做法：主线程执行耗时解析</span>
<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">parseLargeData</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">data</span>: <span class="hljs-type">Data</span>) {
    <span class="hljs-keyword">let</span> model <span class="hljs-operator">=</span> <span class="hljs-keyword">try!</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">LargeModel</span>.<span class="hljs-keyword">self</span>, from: data)
    <span class="hljs-keyword">self</span>.model <span class="hljs-operator">=</span> model
}

<span class="hljs-comment">// ✅ 正确做法：后台解析，主线程更新UI</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">loadLargeData</span>() {
    <span class="hljs-type">Task</span> {
        <span class="hljs-comment">// 后台解析</span>
        <span class="hljs-keyword">let</span> model <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.detached {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">try!</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">LargeModel</span>.<span class="hljs-keyword">self</span>, from: data)
        }.value
        
        <span class="hljs-comment">// 主线程更新UI</span>
        <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
            <span class="hljs-keyword">self</span>.model <span class="hljs-operator">=</span> model
        }
    }
}
</code></pre>
<h3 data-id="heading-31">4. 坑 4：直接访问 Actor 的属性，编译器会报错</h3>
<p>Actor 的属性是隔离的，外部无法直接访问，必须通过方法获取：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 错误做法：直接访问Actor属性</span>
<span class="hljs-keyword">let</span> manager <span class="hljs-operator">=</span> <span class="hljs-type">UserManager</span>()
<span class="hljs-built_in">print</span>(manager.userList) <span class="hljs-comment">// 编译器报错</span>

<span class="hljs-comment">// ✅ 正确做法：通过Actor方法获取</span>
<span class="hljs-keyword">let</span> list <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> manager.getUserList()
<span class="hljs-built_in">print</span>(list)
</code></pre>
<h3 data-id="heading-32">5. 坑 5：非结构化 Task 忘记取消，导致内存泄漏</h3>
<p>Task.detached 创建的任务如果持有了<code>self</code>，且忘记取消，会导致<code>self</code>无法释放，内存泄漏：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 错误做法：忘记取消Task</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">badTask</span>() {
    <span class="hljs-type">Task</span>.detached { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
        <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> {
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">self</span>.syncLog()
            <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(<span class="hljs-number">10_000_000_000</span>)
        }
    }
}

<span class="hljs-comment">// ✅ 正确做法：手动持有Task，在合适时机取消</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyVC</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> syncTask: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt;?
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        syncTask <span class="hljs-operator">=</span> <span class="hljs-type">Task</span>.detached { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            <span class="hljs-keyword">while</span> <span class="hljs-operator">!</span><span class="hljs-type">Task</span>.isCancelled {
                <span class="hljs-keyword">await</span> <span class="hljs-keyword">self</span>.syncLog()
                <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(<span class="hljs-number">10_000_000_000</span>)
            }
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewWillDisappear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewWillDisappear(animated)
        <span class="hljs-comment">// 页面消失时取消任务</span>
        syncTask<span class="hljs-operator">?</span>.cancel()
    }
}
</code></pre>
<h2 data-id="heading-33">七、总结：Swift 多线程的正确打开方式</h2>
<ol>
<li><strong>告别 GCD 回调地狱</strong>：用 Task 把异步代码写成同步风格，线性书写，易读易维护；</li>
<li><strong>告别线程安全玄学</strong>：用 Actor（尤其是 MainActor）保证线程安全，不用手动加锁；</li>
<li><strong>优先结构化并发</strong>：90% 的场景用默认 Task，少用 Task.detached，避免生命周期失控；</li>
<li><strong>UI 更新认准 MainActor</strong>：无论是<code>@MainActor</code>还是<code>await MainActor.run</code>，保证 UI 在主线程执行；</li>
<li><strong>关键节点检查取消</strong>：在耗时操作前后检查 Task 取消状态，避免无效操作；</li>
<li><strong>用 TaskGroup 管理多任务</strong>：批量添加、批量取消，效率更高。</li>
</ol>
<p>Swift 的 Task 和 Actor 不是银弹，但它们确实让多线程开发变得更简单、更安全。从 GCD 过渡到 Swift 并发框架，可能需要一点时间，但一旦掌握，你会发现打开了新世界的大门 —— 原来多线程开发也可以这么轻松！</p>
<p>最后，送大家一句话：<strong>多线程不可怕，只要用好 Task 和 Actor，你也能躺赢！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 低延迟流媒体播放器实战：基于 FFmpeg 6.1.1 的 RTSP/RTMP 解决方案]]></title>    <link>https://juejin.cn/post/7589275237038243875</link>    <guid>https://juejin.cn/post/7589275237038243875</guid>    <pubDate>2025-12-30T07:33:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589275237038243875" data-draft-id="7589509638339330074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 低延迟流媒体播放器实战：基于 FFmpeg 6.1.1 的 RTSP/RTMP 解决方案"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-30T07:33:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="屏息"/> <meta itemprop="url" content="https://juejin.cn/user/861643816574349"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 低延迟流媒体播放器实战：基于 FFmpeg 6.1.1 的 RTSP/RTMP 解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/861643816574349/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    屏息
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:33:36.000Z" title="Tue Dec 30 2025 07:33:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做 Android 流媒体开发的同学应该都懂，原生<code>MediaPlayer</code>简直是 “痛点集合体”—— 延迟高到没法忍、协议支持捉襟见肘，第三方播放器要么体积臃肿，要么定制化能力差，想做个低延迟、支持多路播放还能自定义处理帧数据的功能，总得踩一堆坑。</p>
<p>最近基于 FFmpeg 6.1.1 封装了一款轻量级流媒体播放器<code>FFmpegStreamPlayer</code>，解决了项目中遇到的低延迟、多流并发、YUV 帧自定义处理等核心问题，今天跟大家聊聊这款播放器的核心价值、适用场景，以及为什么它能适配大部分安卓流媒体开发需求。</p>
<p>应用截图：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f21e59efe914e86b435cc43ab04d217~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGP5oGv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684895&amp;x-signature=uLaNEC1e4s6DVwYXKy14xNW3Zsk%3D" alt="MuMu-20251011-153144-611.png" width="30%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0df56d75f1824ba791efdb46973c5c9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGP5oGv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684895&amp;x-signature=ym8t4g181nRJUz%2FHOimdAICbse4%3D" alt="MuMu-20251011-155352-156.png" width="30%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcd8d8ea8fe242ce959ebe3003490930~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGP5oGv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684895&amp;x-signature=jymlRem9xQItZrb5BWdTDutBLkA%3D" alt="MuMu-20251218-104858-750.png" width="30%" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/194ed87b0b934d9c9a061000d57db468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGP5oGv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767684895&amp;x-signature=DvOQRfhsyXh8W5LeVouzrwq0B5k%3D" alt="MuMu-20251219-141657-940.png" width="30%" loading="lazy"/>
<h2 data-id="heading-0">为什么需要这款播放器？</h2>
<p>先说说我们日常开发中遇到的真实痛点：</p>
<ol>
<li><strong>原生播放器完全不够用</strong>：原生<code>MediaPlayer</code>的延迟能到 300-800ms，做安防监控、实时直播这类对延迟敏感的场景，用户体验直接拉胯；而且对 RTSP、HTTP-FLV 这类协议的适配性极差，经常出现播放卡顿、断流的情况。</li>
<li><strong>第三方播放器的 “隐形门槛”</strong> ：市面上不少播放器要么只支持单一协议（比如只做 RTMP），要么硬件解码适配差，部分机型直接闪退；还有的不开源，想自定义处理 YUV 帧、加个 AI 分析功能都无从下手。</li>
<li><strong>项目的核心诉求没被满足</strong>：我们做安防项目时，需要同时播放 16 路监控流、实时录制、获取 YUV 帧做人脸检测，还要适配 16kb 的特殊屏幕 —— 这些需求，现成的播放器要么做不到，要么需要大量二次开发。</li>
</ol>
<p>基于这些痛点，才封装了这款<code>FFmpegStreamPlayer</code>，核心就是 “解决实际问题”，而不是做一个 “能用但不好用” 的玩具。</p>
<h2 data-id="heading-1">这款播放器的核心使用场景</h2>
<h3 data-id="heading-2">1. 安防监控场景</h3>
<p>这是最核心的场景：支持 RTSP 协议（安防摄像头主流协议），最高 16 路流同时播放（具体路数看设备性能），硬件解码延迟 80-120ms，能实时看到监控画面；还支持边播边录，录制的视频质量无损，满足取证、回放的需求。</p>
<h3 data-id="heading-3">2. 直播互动场景</h3>
<p>不管是 RTMP 还是 HTTP-FLV 协议的直播，都能做到超低延迟播放 —— 硬件解码 100ms 级的延迟，比原生播放器快 3 倍以上，适合直播带货、在线教育这类需要实时互动的场景。</p>
<h3 data-id="heading-4">3. 智能分析 / 自定义处理场景</h3>
<p>软件解码模式下能获取 YUV 原始帧，支持三种处理模式：</p>
<ul>
<li>只读分析（比如人脸检测、行为分析），不影响正常播放；</li>
<li>处理后渲染（比如加美颜、滤镜）；</li>
<li>完全接管渲染（自己用 OpenGL 画）。做 AI 推理、自定义渲染的同学，不用再自己封装 FFmpeg 的解码逻辑，直接用现成的接口就行。</li>
</ul>
<h3 data-id="heading-5">4. 车载 / 工控设备场景</h3>
<p>专门做了 16kb 页面适配，能兼容车载、工控这类特殊屏幕；而且完善的生命周期适配逻辑，能处理应用前后台切换、Surface 销毁 / 创建的情况，避免设备长时间运行出现崩溃、内存泄漏。</p>
<h3 data-id="heading-6">5. 通用流媒体播放场景</h3>
<p>支持 RTSP/RTMP/HLS/HTTP-FLV/RTP/UDP/TCP 等几乎所有主流协议，一套代码就能适配不同的播放需求，不用为不同协议集成不同的播放器。</p>
<h2 data-id="heading-7">使用这款播放器的核心好处</h2>
<h3 data-id="heading-8">1. 极致低延迟，体验拉满</h3>
<p>硬件解码延迟 80-120ms，软件解码 120-200ms，亲测比原生<code>MediaPlayer</code>快 3-5 倍；而且用了零拷贝渲染（直接内存映射），减少内存拷贝的开销，播放更流畅。</p>
<h3 data-id="heading-9">2. 灵活的解码 &amp; 定制化能力</h3>
<ul>
<li>硬件 / 软件解码可选：硬件解码追求低延迟，软件解码支持 YUV 帧自定义处理；</li>
<li>YUV 帧零拷贝处理：直接拿到<code>DirectByteBuffer</code>，不用拷贝数据，性能损耗几乎可以忽略；</li>
<li>自定义渲染：完全接管渲染逻辑，想怎么画就怎么画，适配各种个性化需求。</li>
</ul>
<h3 data-id="heading-10">3. 多流并发 + 协议全覆盖</h3>
<p>最多 16 路流同时播放，满足多路监控、矩阵屏等场景；RTSP/RTMP/HLS 等主流协议全覆盖，不用再为不同协议做兼容开发。</p>
<h3 data-id="heading-11">4. 稳定的生命周期适配</h3>
<p>专门处理了<code>Surface</code>的创建 / 销毁、应用前后台切换、流的销毁等逻辑，只要按文档做好生命周期适配，几乎不会出现崩溃、黑屏、音视频不同步的问题。</p>
<h3 data-id="heading-12">5. 轻量化集成</h3>
<p>基于 aar 封装，只包含 arm64-v8a/armeabi-v7a/x86_64 三种主流架构，体积可控；集成方式也简单，几行代码就能引入，不用配置复杂的 NDK 环境。</p>
<h2 data-id="heading-13">快速上手（核心代码示例）</h2>
<h3 data-id="heading-14">1. 引入库 + 添加权限</h3>
<p>kotlin</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">dependencies</span> {
    <span class="hljs-selector-tag">implementation</span>(<span class="hljs-built_in">fileTree</span>(<span class="hljs-built_in">mapOf</span>(<span class="hljs-string">"dir"</span> to <span class="hljs-string">"libs"</span>, <span class="hljs-string">"include"</span> to <span class="hljs-built_in">listOf</span>(<span class="hljs-string">"*.aar"</span>))))
}
</code></pre>
<p>xml</p>
<pre><code class="hljs language-ini" lang="ini">&lt;uses-permission android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.INTERNET"</span> /&gt;
&lt;uses-permission android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;
</code></pre>
<h3 data-id="heading-15">2. 基本播放逻辑</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建流（硬件解码）</span>
int streamId = FFmpegRTSPLibrary<span class="hljs-selector-class">.createStream</span>("rtsp://your-server/stream");
<span class="hljs-comment">// 绑定Surface</span>
FFmpegRTSPLibrary<span class="hljs-selector-class">.setSurface</span>(streamId, surfaceView.getHolder()<span class="hljs-selector-class">.getSurface</span>());
<span class="hljs-comment">// 异步播放</span>
FFmpegRTSPLibrary<span class="hljs-selector-class">.startPlayAsync</span>(streamId, callback);

<span class="hljs-comment">// 停止+销毁</span>
FFmpegRTSPLibrary<span class="hljs-selector-class">.stopPlayAsync</span>(streamId, callback);
FFmpegRTSPLibrary<span class="hljs-selector-class">.destroyStream</span>(streamId);
</code></pre>
<h3 data-id="heading-16">3. YUV 帧处理（AI 分析场景）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 注册YUV处理器（只读分析模式）</span>
<span class="hljs-title class_">FFmpegRTSPLibrary</span>.<span class="hljs-title function_">registerYUVProcessor</span>(streamId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IYUVFrameProcessor</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">YUVProcessMode</span> <span class="hljs-title function_">getProcessMode</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">YUVProcessMode</span>.<span class="hljs-property">OBSERVE_ONLY</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">YUVProcessResult</span> <span class="hljs-title function_">onProcessFrame</span>(<span class="hljs-params">YUVFrameInfo frame</span>) {
        <span class="hljs-comment">// 拿到YUV原始数据做AI推理（比如人脸检测）</span>
        <span class="hljs-comment">// frame.yBuffer/uBuffer/vBuffer是零拷贝DirectByteBuffer</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">YUVProcessResult</span>.<span class="hljs-title function_">passthrough</span>();
    }
});
</code></pre>
<h3 data-id="heading-17">4. 必做的生命周期适配</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">surfaceDestroyed</span>(<span class="hljs-params">SurfaceHolder holder</span>) {
    <span class="hljs-keyword">if</span> (currentStreamId &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-title class_">FFmpegRTSPLibrary</span>.<span class="hljs-title function_">onSurfaceDestroyed</span>(currentStreamId);
    }
}

<span class="hljs-meta">@Override</span> 
<span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">onDestroy</span>();
    <span class="hljs-title class_">FFmpegRTSPLibrary</span>.<span class="hljs-title function_">destroyAllAsync</span>();
}
</code></pre>
<h2 data-id="heading-18">注意事项</h2>
<ol>
<li>YUV 回调在解码线程执行，耗时操作（比如 AI 推理）一定要异步处理，避免阻塞解码；</li>
<li>YUV 的 Buffer 仅在回调期间有效，不要缓存复用，否则会出现数据错乱；</li>
<li>多流播放时要根据设备性能调整路数，中低端机型建议适当减少并发路数；</li>
</ol>
<h2 data-id="heading-19">最后</h2>
<p>这款播放器是从实际项目中沉淀出来的，没有花里胡哨的功能，核心就是解决 “低延迟、多协议、可定制” 这三个核心痛点。目前项目长期维护，有定制化需求（比如裁剪特定架构、新增功能）可以联系作者，也可以加 QQ 群 647718711 交流问题。</p>
<p>项目地址<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanwz0611%2Fandroid-ffmpeg-stream-player" target="_blank" title="https://github.com/anwz0611/android-ffmpeg-stream-player" ref="nofollow noopener noreferrer">：https://github.com/anwz0611/android-ffmpeg-stream-player</a></p>
<p>如果你的项目也有安卓流媒体播放的需求，尤其是低延迟、多流并发、自定义帧处理的场景，这款播放器应该能帮你少走不少弯路</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源AgentScope多智能体框架解析系列（十）第10章：中断机制]]></title>    <link>https://juejin.cn/post/7589275237038309411</link>    <guid>https://juejin.cn/post/7589275237038309411</guid>    <pubDate>2025-12-30T07:44:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589275237038309411" data-draft-id="7589275237038276643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源AgentScope多智能体框架解析系列（十）第10章：中断机制"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-30T07:44:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源AgentScope多智能体框架解析系列（十）第10章：中断机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:44:44.000Z" title="Tue Dec 30 2025 07:44:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">本章导读</h2>
<p>本章介绍AgentScope的<strong>中断机制</strong>，这是实现<strong>人机协同</strong>和<strong>优雅控制</strong>的关键特性。</p>
<p>中断允许你在<strong>任意时刻暂停Agent执行</strong>，同时<strong>完整保留上下文和状态</strong>，为用户提供对长时间运行任务的实时控制能力。</p>
<p><strong>本章概览</strong>：</p>
<ul>
<li>What（是什么）：理解中断的三种场景和工作原理</li>
<li>Why（为什么）：明确什么时候需要使用中断机制</li>
<li>How（怎样做）：完整的实现示例和生产可用案例</li>
</ul>
<hr/>
<h2 data-id="heading-1">10.1 中断机制设计理念（What - 是什么）</h2>
<h3 data-id="heading-2">什么是中断？</h3>
<p><strong>中断</strong>是一个异步操作，允许你<strong>在不丢失上下文的情况下暂停Agent的执行</strong>。</p>
<p>关键特性：</p>
<ul>
<li>✓ <strong>无损暂停</strong>：保留所有中间状态和上下文</li>
<li>✓ <strong>实时控制</strong>：随时可以暂停、恢复、取消</li>
<li>✓ <strong>人机协同</strong>：用户可以在关键点干预Agent决策</li>
<li>✓ <strong>优雅降级</strong>：遇到问题可以安全地中止</li>
</ul>
<h3 data-id="heading-3">中断的三个核心场景</h3>
<h4 data-id="heading-4">场景1：安全中断（Safe Pause）</h4>
<pre><code class="hljs">场景描述：长时间任务执行中，用户需要补充信息或修正条件

执行流程：
用户初始请求 → Agent推理（5秒）
↓
用户：「暂停，我需要补充数据」
↓
Agent立即停止，保留完整上下文（内存、消息历史）
↓
用户提供新数据 → Agent基于新数据继续推理
</code></pre>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Agent执行中间被暂停</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"SafePauseAgent"</span>)
    .model(model)
    .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
    .build();

<span class="hljs-comment">// 启动异步执行</span>
Flux&lt;HookEvent&gt; execution = agent.stream(
    Msg.builder().textContent(<span class="hljs-string">"请分析这些销售数据并给出建议"</span>).build()
);

<span class="hljs-comment">// 将执行流转为可订阅的流</span>
<span class="hljs-type">Disposable</span> <span class="hljs-variable">subscription</span> <span class="hljs-operator">=</span> execution.subscribe(
    event -&gt; handleEvent(event),
    error -&gt; System.err.println(<span class="hljs-string">"Error: "</span> + error),
    () -&gt; System.out.println(<span class="hljs-string">"Completed"</span>)
);

<span class="hljs-comment">// 5秒后，用户要求暂停</span>
Thread.sleep(<span class="hljs-number">5000</span>);
agent.interrupt(<span class="hljs-string">"用户要求补充数据，暂停推理"</span>).block();

<span class="hljs-comment">// 此时Agent已暂停，内存和状态都保留</span>
<span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> agent.getMemory();
List&lt;Msg&gt; history = memory.getHistory();
System.out.println(<span class="hljs-string">"当前推理步数："</span> + history.size());

<span class="hljs-comment">// 用户补充新数据</span>
agent.observe(Msg.builder()
    .role(MsgRole.USER)
    .textContent(<span class="hljs-string">"这是补充的季度数据..."</span>)
    .build()).block();

<span class="hljs-comment">// Agent基于新数据继续</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> agent.call(
    Msg.builder().textContent(<span class="hljs-string">"继续分析"</span>).build()
).block();
</code></pre>
<h4 data-id="heading-5">场景2：优雅取消（Graceful Cancellation）</h4>
<pre><code class="hljs">场景描述：用户主动取消正在进行的任务

执行流程：
Agent执行工具调用（API请求）
↓
用户：「取消这个请求」
↓
Agent停止工具执行，回滚状态
↓
用户选择其他解决方案或重新开始
</code></pre>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Agent执行可能很耗时的工具调用</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"CancellableAgent"</span>)
    .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>()
        .registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SlowToolService</span>()))
    .build();

<span class="hljs-comment">// 异步执行</span>
Future&lt;Msg&gt; future = CompletableFuture.supplyAsync(() -&gt; {
    Flux&lt;HookEvent&gt; execution = agent.stream(
        Msg.builder().textContent(<span class="hljs-string">"请从数据库查询大量历史数据"</span>).build()
    );
    
    <span class="hljs-comment">// 订阅并执行</span>
    List&lt;Msg&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    execution.subscribe(
        event -&gt; {
            <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> PostActingEvent) {
                <span class="hljs-type">PostActingEvent</span> <span class="hljs-variable">acting</span> <span class="hljs-operator">=</span> (PostActingEvent) event;
                results.add(acting.getActingMessage());
            }
        }
    );
    
    <span class="hljs-keyword">return</span> results.isEmpty() ? <span class="hljs-literal">null</span> : results.get(<span class="hljs-number">0</span>);
});

<span class="hljs-comment">// 用户在看到进度后决定取消</span>
Thread.sleep(<span class="hljs-number">3000</span>);

<span class="hljs-comment">// 发送取消中断</span>
agent.interrupt(<span class="hljs-string">"用户取消请求"</span>).block();

<span class="hljs-comment">// 清理资源</span>
<span class="hljs-keyword">if</span> (!future.isDone()) {
    future.cancel(<span class="hljs-literal">true</span>);
}

System.out.println(<span class="hljs-string">"请求已安全取消，资源已释放"</span>);
</code></pre>
<h4 data-id="heading-6">场景3：人机协同（Human-in-the-Loop）</h4>
<pre><code class="hljs">场景描述：Agent在执行关键决策前，需要用户确认

执行流程：
Agent推理出一个解决方案
↓
Agent请求用户确认（中断）
↓
用户检查并修改方案
↓
Agent基于修改后的方案继续执行
</code></pre>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 支持人机协同的Agent</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"InteractiveAgent"</span>)
    .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>()
        .registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentService</span>())  <span class="hljs-comment">// 支付等关键操作</span>
        .registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApprovalHook</span>()))    <span class="hljs-comment">// 审批Hook</span>
    .build();

<span class="hljs-comment">// 添加人机协同Hook</span>
List&lt;Hook&gt; hooks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
hooks.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanInTheLoopHook</span>((decision) -&gt; {
    <span class="hljs-comment">// 在关键点暂停，等待用户确认</span>
    System.out.println(<span class="hljs-string">"⚠ 需要确认的决策："</span> + decision);
    System.out.println(<span class="hljs-string">"请输入：[1]批准  [2]修改  [3]拒绝"</span>);
    
    <span class="hljs-comment">// 这里会阻塞，等待用户输入</span>
    <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);
    <span class="hljs-type">String</span> <span class="hljs-variable">userInput</span> <span class="hljs-operator">=</span> scanner.nextLine();
    
    <span class="hljs-keyword">return</span> userInput;  <span class="hljs-comment">// 返回用户的选择</span>
}));

agent.withHooks(hooks);

<span class="hljs-comment">// 执行任务</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(
    Msg.builder().textContent(<span class="hljs-string">"请处理这个订单请求：转账1000元给供应商"</span>).build()
).block();
</code></pre>
<hr/>
<h2 data-id="heading-7">10.2 中断工作原理（Why - 为什么需要）</h2>
<h3 data-id="heading-8">为什么需要中断机制？</h3>
<h4 data-id="heading-9">1. <strong>控制长时间运行的任务</strong></h4>
<pre><code class="hljs language-diff" lang="diff">问题：Agent执行可能持续数分钟或数小时，用户无法实时控制
解决：中断允许用户在任意时刻暂停、调整或取消

场景：
<span class="hljs-deletion">- 数据分析Agent：用户发现分析方向错误，需要中止重新开始</span>
<span class="hljs-deletion">- 内容创作Agent：用户在某个中间步骤不满意，需要修改前置信息</span>
<span class="hljs-deletion">- 报表生成Agent：临时发现数据有误，需要停止并修正源数据</span>
</code></pre>
<h4 data-id="heading-10">2. <strong>实现人机协同</strong></h4>
<pre><code class="hljs language-diff" lang="diff">问题：完全自动化的Agent可能做出用户不认可的决策
解决：通过中断和Hook，用户可以在关键点介入

场景：
<span class="hljs-deletion">- 金融交易：大额转账需要用户确认</span>
<span class="hljs-deletion">- 内容审核：敏感内容需要人工审核</span>
<span class="hljs-deletion">- 高风险操作：删除、关闭等操作需要二次确认</span>
</code></pre>
<h4 data-id="heading-11">3. <strong>支持异常恢复</strong></h4>
<pre><code class="hljs language-diff" lang="diff">问题：遇到异常时，整个任务失败，无法继续
解决：通过中断和状态保存，可以恢复并重试

场景：
<span class="hljs-deletion">- 网络中断：服务临时不可用，暂停并稍后恢复</span>
<span class="hljs-deletion">- 配额限制：API调用达到限制，暂停等待配额恢复</span>
<span class="hljs-deletion">- 权限问题：临时权限不足，等待权限升级后继续</span>
</code></pre>
<h3 data-id="heading-12">中断的工作原理</h3>
<pre><code class="hljs language-scss" lang="scss">中断执行模型（响应式管道）：

用户请求中断
    ↓
agent<span class="hljs-selector-class">.interrupt</span>(reason)<span class="hljs-selector-class">.block</span>()
    ↓
当前操作完成（不强制中断进行中的操作）
    ↓
保存完整状态（内存、消息历史、Hook链）
    ↓
Agent进入暂停状态
    ↓
用户可以：
  ├─ 观察状态
  ├─ 修改上下文（Memory、消息）
  ├─ 调用<span class="hljs-built_in">observe</span>()注入新信息
  └─ 调用<span class="hljs-built_in">call</span>()恢复执行
</code></pre>
<hr/>
<h2 data-id="heading-13">10.3 中断的实现方式（How - 怎样做）</h2>
<h3 data-id="heading-14">基础中断实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterruptionDemo</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建支持中断的Agent</span>
        <span class="hljs-type">Model</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeModel.builder()
            .modelName(<span class="hljs-string">"qwen-turbo"</span>)
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .build();
        
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"InterruptibleAgent"</span>)
            .model(model)
            .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
            .build();
        
        <span class="hljs-comment">// 2. 在后台执行任务</span>
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
        
        Flux&lt;HookEvent&gt; execution = agent.stream(
            Msg.builder()
                .role(MsgRole.USER)
                .textContent(<span class="hljs-string">"请帮我分析过去一个月的销售数据并生成报告"</span>)
                .build()
        );
        
        <span class="hljs-comment">// 3. 订阅执行结果</span>
        List&lt;HookEvent&gt; events = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        Future&lt;?&gt; future = executor.submit(() -&gt; {
            execution.subscribe(
                event -&gt; {
                    events.add(event);
                    System.out.println(<span class="hljs-string">"Event: "</span> + event.getClass().getSimpleName());
                },
                error -&gt; System.err.println(<span class="hljs-string">"Error: "</span> + error.getMessage()),
                () -&gt; System.out.println(<span class="hljs-string">"Execution completed"</span>)
            );
        });
        
        <span class="hljs-comment">// 4. 执行3秒后，触发中断</span>
        Thread.sleep(<span class="hljs-number">3000</span>);
        System.out.println(<span class="hljs-string">"\n&gt;&gt;&gt; 用户请求暂停 &lt;&lt;&lt;"</span>);
        agent.interrupt(<span class="hljs-string">"用户要求暂停，需要补充数据"</span>).block();
        
        <span class="hljs-comment">// 5. 检查中断后的状态</span>
        <span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> agent.getMemory();
        System.out.println(<span class="hljs-string">"\n中断后的状态："</span>);
        System.out.println(<span class="hljs-string">"- 记忆中的消息数："</span> + memory.getHistory().size());
        System.out.println(<span class="hljs-string">"- 最后一条消息："</span> + 
            memory.getHistory().get(memory.getHistory().size() - <span class="hljs-number">1</span>).getTextContent());
        
        <span class="hljs-comment">// 6. 用户补充新信息</span>
        System.out.println(<span class="hljs-string">"\n&gt;&gt;&gt; 用户补充新数据 &lt;&lt;&lt;"</span>);
        agent.observe(Msg.builder()
            .role(MsgRole.USER)
            .textContent(<span class="hljs-string">"新增信息：请重点关注南方地区的销售，这个月有促销活动"</span>)
            .build()).block();
        
        <span class="hljs-comment">// 7. 恢复执行</span>
        System.out.println(<span class="hljs-string">"\n&gt;&gt;&gt; 继续执行 &lt;&lt;&lt;"</span>);
        <span class="hljs-type">Msg</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> agent.call(
            Msg.builder()
                .role(MsgRole.USER)
                .textContent(<span class="hljs-string">"基于上面的补充信息，继续完成报告"</span>)
                .build()
        ).block();
        
        System.out.println(<span class="hljs-string">"\n最终结果：\n"</span> + result.getTextContent());
        
        executor.shutdown();
    }
}
</code></pre>
<h3 data-id="heading-15">使用Hook实现精细化控制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedInterruptionWithHooks</span> {
    
    <span class="hljs-comment">/**
     * 自定义Hook：在每个推理步骤后检查是否应该中断
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckpointHook</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hook</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">shouldInterrupt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String interruptReason;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CheckpointHook</span><span class="hljs-params">(String reason)</span> {
            <span class="hljs-built_in">this</span>.interruptReason = reason;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">triggerInterrupt</span><span class="hljs-params">()</span> {
            shouldInterrupt.set(<span class="hljs-literal">true</span>);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
            <span class="hljs-comment">// 在Post事件时检查是否需要中断</span>
            <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> PostReasoningEvent post) {
                <span class="hljs-keyword">if</span> (shouldInterrupt.get()) {
                    <span class="hljs-comment">// 记录中断点</span>
                    System.out.println(<span class="hljs-string">"🛑 中断点触发："</span> + interruptReason);
                    System.out.println(<span class="hljs-string">"  推理次数："</span> + post.getReasoningCount());
                    System.out.println(<span class="hljs-string">"  当前消息数："</span> + post.getInputMessages().size());
                    
                    <span class="hljs-comment">// 返回事件，由外部处理中断</span>
                    <span class="hljs-keyword">return</span> Mono.just(event)
                        .doOnNext(e -&gt; {
                            <span class="hljs-comment">// 这里可以触发中断信号</span>
                            System.out.println(<span class="hljs-string">"  已保存检查点"</span>);
                        });
                }
            }
            <span class="hljs-keyword">return</span> Mono.just(event);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPriority</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">50</span>;  <span class="hljs-comment">// 较高优先级，最后执行</span>
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Model</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeModel.builder()
            .modelName(<span class="hljs-string">"qwen-turbo"</span>)
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .build();
        
        <span class="hljs-comment">// 创建检查点Hook</span>
        <span class="hljs-type">CheckpointHook</span> <span class="hljs-variable">checkpoint</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CheckpointHook</span>(<span class="hljs-string">"用户主动中断"</span>);
        
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"CheckpointAgent"</span>)
            .model(model)
            .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
            .hooks(List.of(checkpoint))
            .build();
        
        <span class="hljs-comment">// 在后台执行</span>
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
        Future&lt;?&gt; future = executor.submit(() -&gt; {
            Flux&lt;HookEvent&gt; execution = agent.stream(
                Msg.builder()
                    .textContent(<span class="hljs-string">"请执行一个长时间的分析任务"</span>)
                    .build()
            );
            
            execution.subscribe(
                event -&gt; System.out.println(<span class="hljs-string">"收到事件："</span> + event.getClass().getSimpleName()),
                error -&gt; System.err.println(<span class="hljs-string">"错误："</span> + error),
                () -&gt; System.out.println(<span class="hljs-string">"任务完成"</span>)
            );
        });
        
        <span class="hljs-comment">// 2秒后触发中断</span>
        Thread.sleep(<span class="hljs-number">2000</span>);
        checkpoint.triggerInterrupt();
        
        <span class="hljs-comment">// 等待执行完成</span>
        Thread.sleep(<span class="hljs-number">2000</span>);
        
        <span class="hljs-comment">// 检查状态</span>
        System.out.println(<span class="hljs-string">"\n最终状态检查："</span>);
        System.out.println(<span class="hljs-string">"Memory中的消息数："</span> + agent.getMemory().getHistory().size());
        
        executor.shutdown();
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-16">10.4 生产场景：智能客服中的中断管理</h2>
<h3 data-id="heading-17">场景描述</h3>
<pre><code class="hljs language-markdown" lang="markdown">一个客服Agent处理客户问题：
<span class="hljs-bullet">1.</span> 用户提出问题
<span class="hljs-bullet">2.</span> Agent分析并提出解决方案
<span class="hljs-bullet">3.</span> 如果涉及高风险操作（如退款），需要人工确认
<span class="hljs-bullet">4.</span> 人工客服审批后，Agent继续执行
<span class="hljs-bullet">5.</span> 如果被拒，Agent提出替代方案
</code></pre>
<h3 data-id="heading-18">实现代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceInterruptionSystem</span> {
    
    <span class="hljs-comment">/**
     * 人机协同Hook：在需要人工审批的操作前暂停
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApprovalHook</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hook</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ApprovalQueue&gt; approvalQueues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
            <span class="hljs-keyword">if</span> (!(event <span class="hljs-keyword">instanceof</span> PreActingEvent pre)) {
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
            
            <span class="hljs-comment">// 检查即将执行的工具是否需要审批</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">toolName</span> <span class="hljs-operator">=</span> extractToolName(pre.getToolCallMessage());
            
            <span class="hljs-keyword">if</span> (needsApproval(toolName)) {
                <span class="hljs-keyword">return</span> approveToolCall(pre.getToolCallMessage())
                    .flatMap(approved -&gt; {
                        <span class="hljs-keyword">if</span> (approved) {
                            System.out.println(<span class="hljs-string">"✓ 人工已批准，继续执行："</span> + toolName);
                            <span class="hljs-keyword">return</span> Mono.just(event);
                        } <span class="hljs-keyword">else</span> {
                            System.out.println(<span class="hljs-string">"✗ 人工拒绝，中止执行："</span> + toolName);
                            <span class="hljs-comment">// 修改事件，跳过这个工具调用</span>
                            pre.markAsCancelled();
                            <span class="hljs-keyword">return</span> Mono.just(event);
                        }
                    });
            }
            
            <span class="hljs-keyword">return</span> Mono.just(event);
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">needsApproval</span><span class="hljs-params">(String toolName)</span> {
            <span class="hljs-comment">// 高风险操作列表</span>
            <span class="hljs-keyword">return</span> toolName.equals(<span class="hljs-string">"processRefund"</span>) ||
                   toolName.equals(<span class="hljs-string">"updateOrder"</span>) ||
                   toolName.equals(<span class="hljs-string">"deleteAccount"</span>);
        }
        
        <span class="hljs-keyword">private</span> Mono&lt;Boolean&gt; <span class="hljs-title function_">approveToolCall</span><span class="hljs-params">(Msg toolCall)</span> {
            <span class="hljs-comment">// 提交到审批队列，等待人工审批</span>
            System.out.println(<span class="hljs-string">"\n⏸️  等待人工审批："</span>);
            System.out.println(<span class="hljs-string">"  工具调用："</span> + toolCall.getTextContent());
            System.out.println(<span class="hljs-string">"  请人工审批..."</span>);
            
            <span class="hljs-comment">// 实际应用中，这里会将请求发送到审批系统</span>
            <span class="hljs-comment">// 这里简化为同步等待</span>
            <span class="hljs-keyword">return</span> Mono.fromCallable(() -&gt; {
                <span class="hljs-comment">// 模拟人工审批耗时</span>
                Thread.sleep(<span class="hljs-number">2000</span>);
                System.out.println(<span class="hljs-string">"  ✓ 人工审批完成：已批准"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }).subscribeOn(Schedulers.boundedElastic());
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPriority</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;  <span class="hljs-comment">// 最高优先级，最早检查</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 客服Agent主类
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceAgent</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReActAgent agent;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ApprovalHook approvalHook;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomerServiceAgent</span><span class="hljs-params">(Model model)</span> {
            <span class="hljs-built_in">this</span>.approvalHook = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApprovalHook</span>();
            
            <span class="hljs-built_in">this</span>.agent = ReActAgent.builder()
                .name(<span class="hljs-string">"CustomerServiceAgent"</span>)
                .model(model)
                .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
                .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>()
                    .registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerServiceTools</span>()))
                .hooks(List.of(approvalHook))
                .systemPrompt(getSystemPrompt())
                .build();
        }
        
        <span class="hljs-keyword">public</span> Msg <span class="hljs-title function_">handleCustomerRequest</span><span class="hljs-params">(String customerMessage)</span> <span class="hljs-keyword">throws</span> Exception {
            System.out.println(<span class="hljs-string">"\n=== 处理客户请求 ==="</span>);
            System.out.println(<span class="hljs-string">"客户："</span> + customerMessage);
            
            <span class="hljs-comment">// 异步执行Agent</span>
            <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
            
            Future&lt;Msg&gt; result = executor.submit(() -&gt; {
                Flux&lt;HookEvent&gt; execution = agent.stream(
                    Msg.builder()
                        .role(MsgRole.USER)
                        .textContent(customerMessage)
                        .build()
                );
                
                <span class="hljs-comment">// 执行并收集结果</span>
                List&lt;Msg&gt; responses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
                execution.subscribe(
                    event -&gt; {
                        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> PostActingEvent) {
                            responses.add(((PostActingEvent) event).getActingMessage());
                        }
                    }
                );
                
                <span class="hljs-keyword">return</span> responses.isEmpty() ? <span class="hljs-literal">null</span> : responses.get(<span class="hljs-number">0</span>);
            });
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> result.get(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
                System.out.println(<span class="hljs-string">"客服助手："</span> + response.getTextContent());
                <span class="hljs-keyword">return</span> response;
            } <span class="hljs-keyword">finally</span> {
                executor.shutdown();
            }
        }
        
        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getSystemPrompt</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"""
                你是一个专业的客服助手。
                
                职责：
                1. 认真倾听客户的问题
                2. 分析问题并提出解决方案
                3. 对于退款、订单修改等关键操作，主动调用相应工具
                4. 对于工具执行失败，提出替代方案
                
                态度：
                - 礼貌、耐心、专业
                - 优先满足客户需求
                - 当无法处理时，清晰地说明原因
                """</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 客服工具集
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceTools</span> {
        
        <span class="hljs-meta">@Tool(description = "查询订单信息")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderId)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"订单 "</span> + orderId + <span class="hljs-string">" 的信息：状态=已发货，金额=¥299.99"</span>;
        }
        
        <span class="hljs-meta">@Tool(description = "处理退款，需要人工审批")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">processRefund</span><span class="hljs-params">(String orderId, String reason)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"退款已处理，退款金额已返回到原账户"</span>;
        }
        
        <span class="hljs-meta">@Tool(description = "更新订单备注")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(String orderId, String note)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"订单备注已更新"</span>;
        }
        
        <span class="hljs-meta">@Tool(description = "提供替代方案")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">suggestAlternative</span><span class="hljs-params">(String productId)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"推荐替代产品：ID="</span> + productId + <span class="hljs-string">"-alt，价格¥199.99，评分4.8/5"</span>;
        }
    }
    
    <span class="hljs-comment">// 测试</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Model</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeModel.builder()
            .modelName(<span class="hljs-string">"qwen-turbo"</span>)
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .build();
        
        <span class="hljs-type">CustomerServiceAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerServiceAgent</span>(model);
        
        <span class="hljs-comment">// 场景1：普通查询（无需中断）</span>
        agent.handleCustomerRequest(<span class="hljs-string">"请查询我的订单 ORD-2024-001 的状态"</span>);
        
        <span class="hljs-comment">// 场景2：退款请求（需要人工审批中断）</span>
        agent.handleCustomerRequest(<span class="hljs-string">"我想要退货，订单 ORD-2024-002，因为商品不符合预期"</span>);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-19">10.5 最佳实践与常见问题</h2>
<h3 data-id="heading-20">✅ 最佳实践</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 精确的中断点设计
<span class="hljs-bullet">   -</span> 在推理循环之间检查中断信号
<span class="hljs-bullet">   -</span> 不要在工具执行中途中断（可能导致不一致状态）
<span class="hljs-bullet">   -</span> 清晰定义可中断和不可中断的阶段

<span class="hljs-bullet">2.</span> 完整的状态保存
<span class="hljs-bullet">   -</span> 中断时保存Memory、消息历史、Hook状态
<span class="hljs-bullet">   -</span> 提供恢复接口，确保状态完整性
<span class="hljs-bullet">   -</span> 支持检查点恢复

<span class="hljs-bullet">3.</span> 用户体验
<span class="hljs-bullet">   -</span> 提供明确的中断确认
<span class="hljs-bullet">   -</span> 显示中断点的上下文信息
<span class="hljs-bullet">   -</span> 支持继续/修改/取消多种选择

<span class="hljs-bullet">4.</span> 生产环保
<span class="hljs-bullet">   -</span> 加入超时机制，防止无限等待
<span class="hljs-bullet">   -</span> 记录所有中断事件用于审计
<span class="hljs-bullet">   -</span> 监控中断频率，识别问题模式
</code></pre>
<h3 data-id="heading-21">❓ 常见问题</h3>
<h4 data-id="heading-22">Q1：中断时工具调用进行中怎么办？</h4>
<p>A：AgentScope会等待当前工具调用完成，然后再暂停。这确保了状态的一致性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 如果需要强制中断正在执行的工具，使用Future.cancel()</span>
Future&lt;?&gt; toolFuture = executor.submit(() -&gt; slowTool.call());
Thread.sleep(<span class="hljs-number">2000</span>);
toolFuture.cancel(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 强制取消</span>
</code></pre>
<h4 data-id="heading-23">Q2：中断后状态如何恢复？</h4>
<p>A：通过Memory恢复。AgentScope自动保存所有消息历史和内部状态。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 中断后的恢复</span>
agent.interrupt(<span class="hljs-string">"user pause"</span>).block();

<span class="hljs-comment">// 检查Memory中的历史</span>
List&lt;Msg&gt; history = agent.getMemory().getHistory();

<span class="hljs-comment">// 恢复到中断点</span>
agent.observe(newMsg).block();
<span class="hljs-type">Msg</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> agent.call(continuationMsg).block();
</code></pre>
<h4 data-id="heading-24">Q3：能否在Hook中实现条件中断？</h4>
<p>A：可以。通过在Hook中返回修改后的事件，可以实现条件判断和选择性中断。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
    <span class="hljs-keyword">if</span> (shouldInterrupt(event)) {
        <span class="hljs-keyword">return</span> Mono.just(event)
            .doOnNext(e -&gt; {
                <span class="hljs-comment">// 触发外部中断信号</span>
                system.sendInterruptSignal();
            });
    }
    <span class="hljs-keyword">return</span> Mono.just(event);
}
</code></pre>
<hr/>
<h2 data-id="heading-25">10.6 与其他特性的协同</h2>
<h3 data-id="heading-26">中断 + Hook系统</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Hook可以在中断前执行清理操作</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CleanupHook</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hook</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> PostReasoningEvent) {
            <span class="hljs-comment">// 在推理完成时进行清理</span>
            <span class="hljs-keyword">return</span> Mono.just(event)
                .doOnNext(e -&gt; cleanupResources());
        }
        <span class="hljs-keyword">return</span> Mono.just(event);
    }
}
</code></pre>
<h3 data-id="heading-27">中断 + 记忆系统</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 中断时记忆系统自动保存</span>
agent.interrupt(<span class="hljs-string">"pause"</span>).block();

<span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> agent.getMemory();
<span class="hljs-comment">// 可以查询历史消息</span>
List&lt;Msg&gt; history = memory.getHistory();
<span class="hljs-comment">// 可以获取压缩的记忆</span>
<span class="hljs-type">String</span> <span class="hljs-variable">compressed</span> <span class="hljs-operator">=</span> memory.getCompressedMemory();
</code></pre>
<h3 data-id="heading-28">中断 + Session持久化</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 中断后保存会话</span>
session.saveSessionState(userId, Map.of(
    <span class="hljs-string">"memory"</span>, agent.getMemory(),
    <span class="hljs-string">"interrupt_reason"</span>, <span class="hljs-string">"user request"</span>
));

<span class="hljs-comment">// 后续恢复</span>
session.loadSessionState(userId, modules);
</code></pre>
<hr/>
<h2 data-id="heading-29">本章总结</h2>
<p>本章介绍了AgentScope的<strong>中断机制</strong>，这是实现<strong>实时控制</strong>和<strong>人机协同</strong>的核心特性：</p>
<h3 data-id="heading-30">核心要点</h3>
<ul>
<li><strong>What</strong>：中断允许在任意时刻暂停Agent，同时保留完整状态</li>
<li><strong>Why</strong>：支持人机协同、控制长时间任务、实现异常恢复</li>
<li><strong>How</strong>：使用interrupt()方法和Hook实现精细化控制</li>
</ul>
<h3 data-id="heading-31">关键特性</h3>
<ul>
<li>✓ 无损暂停：保留所有上下文</li>
<li>✓ 灵活控制：暂停、恢复、取消、修改</li>
<li>✓ 人机协同：在关键点进行人工干预</li>
<li>✓ 与其他特性协同：Hook、Memory、Session的无缝配合</li>
</ul>
<h3 data-id="heading-32">使用场景</h3>
<ul>
<li>长时间任务的用户控制</li>
<li>高风险操作的人工审批</li>
<li>异常恢复和状态管理</li>
<li>交互式任务的逐步完成</li>
</ul>
<hr/>
<h2 data-id="heading-33">下一章预告</h2>
<p><strong>第11章：PlanNotebook 任务管理</strong></p>
<p>当Agent需要处理<strong>复杂的多步骤任务</strong>时，单一的推理循环可能不够。第11章将介绍<strong>PlanNotebook</strong>系统，它允许Agent：</p>
<ul>
<li>自主创建和管理分阶段的计划</li>
<li>跨越多个推理循环执行复杂任务</li>
<li>在执行过程中动态调整计划</li>
<li>与中断机制协同实现人工干预</li>
</ul>
<p>敬请期待！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源AgentScope多智能体框架解析系列（十二）第12章：RAG（检索增强生成）]]></title>    <link>https://juejin.cn/post/7589445154533490740</link>    <guid>https://juejin.cn/post/7589445154533490740</guid>    <pubDate>2025-12-30T07:49:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589445154533490740" data-draft-id="7589386219450007567" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源AgentScope多智能体框架解析系列（十二）第12章：RAG（检索增强生成）"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-30T07:49:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源AgentScope多智能体框架解析系列（十二）第12章：RAG（检索增强生成）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T07:49:06.000Z" title="Tue Dec 30 2025 07:49:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">本章导读</h2>
<p>本章介绍AgentScope的<strong>RAG（Retrieval Augmented Generation，检索增强生成）<strong>系统，这是让Agent能够</strong>基于最新知识库回答问题</strong>的关键技术。</p>
<p>RAG通过<strong>检索外部知识库中的相关信息</strong>，为LLM提供上下文，从而<strong>显著提升回答的准确性和时效性</strong>。</p>
<p><strong>本章概览</strong>：</p>
<ul>
<li>What（是什么）：理解RAG的工作原理和架构</li>
<li>Why（为什么）：明确什么时候需要使用RAG</li>
<li>How（怎样做）：完整的实现示例和生产可用案例</li>
</ul>
<hr/>
<h2 data-id="heading-1">12.1 RAG设计理念</h2>
<h3 data-id="heading-2">什么是RAG？</h3>
<p>**RAG（检索增强生成）**是一种混合式的处理流程：</p>
<pre><code class="hljs language-css" lang="css">用户问题
  ↓
<span class="hljs-selector-attr">[检索阶段]</span> 在知识库中搜索相关文档
  ↓
<span class="hljs-selector-attr">[增强阶段]</span> 将检索到的文档作为上下文
  ↓
<span class="hljs-selector-attr">[生成阶段]</span> LLM基于上下文回答问题
  ↓
准确、可追溯的答案
</code></pre>
<h3 data-id="heading-3">RAG的核心优势</h3>



































<table><thead><tr><th>特性</th><th>传统LLM</th><th>RAG增强</th></tr></thead><tbody><tr><td><strong>知识时效性</strong></td><td>依赖训练数据（可能过时）</td><td>基于最新知识库 ✓</td></tr><tr><td><strong>可追溯性</strong></td><td>黑盒回答</td><td>可引用具体来源 ✓</td></tr><tr><td><strong>领域专业性</strong></td><td>通用知识</td><td>垂直领域专业知识 ✓</td></tr><tr><td><strong>成本</strong></td><td>需要大模型</td><td>可用小模型 ✓</td></tr><tr><td><strong>隐私</strong></td><td>数据上传到厂商</td><td>私有知识库 ✓</td></tr></tbody></table>
<h3 data-id="heading-4">RAG的三个核心阶段</h3>
<h4 data-id="heading-5">1. 检索（Retrieval）</h4>
<pre><code class="hljs language-css" lang="css">目标：从知识库中找到与用户问题最相关的文档

方法：
├─ 关键词匹配（BM25）：快速但精度低
├─ 语义相似度（向量）：精度高，需要Embedding
└─ 混合方法：结合两者优点

过程：
用户问题 → 向量化 → 在向量库中搜索
  ↓
返回<span class="hljs-attribute">top</span>-k相关文档
</code></pre>
<h4 data-id="heading-6">2. 增强（Augmentation）</h4>
<pre><code class="hljs language-sql" lang="sql">目标：将检索到的文档融入到LLM的输入中

方式：
├─ 追加到<span class="hljs-keyword">System</span> Prompt
├─ 插入到上下文中
└─ 作为工具输入

结果：
LLM获得了额外的上下文信息，能做出更好的回答
</code></pre>
<h4 data-id="heading-7">3. 生成（Generation）</h4>
<pre><code class="hljs language-arduino" lang="arduino">目标：基于增强后的输入，生成准确的答案

特点：
├─ 可以引用具体来源
├─ 回答更专业和准确
└─ 避免<span class="hljs-string">"幻觉"</span>（生成虚假信息）
</code></pre>
<hr/>
<h2 data-id="heading-8">12.2 RAG的工作原理</h2>
<h3 data-id="heading-9">为什么需要RAG？</h3>
<h4 data-id="heading-10">1. <strong>LLM知识的局限性</strong></h4>
<pre><code class="hljs language-vbnet" lang="vbnet">问题：LLM的训练数据有截止日期，无法回答最新的问题

示例：
<span class="hljs-symbol">Q:</span> <span class="hljs-string">"2024年最新的AI法规是什么？"</span>
<span class="hljs-symbol">A:</span> 模型训练于<span class="hljs-number">2023</span>年<span class="hljs-number">10</span>月，无法回答

解决：RAG可以从最新的知识库中检索相关信息
</code></pre>
<h4 data-id="heading-11">2. <strong>领域专业性要求</strong></h4>
<pre><code class="hljs language-vbnet" lang="vbnet">问题：通用LLM可能缺乏特定领域的专业知识

示例：
<span class="hljs-symbol">Q:</span> <span class="hljs-string">"我们公司的产假政策是什么？"</span>
<span class="hljs-symbol">A:</span> 通用LLM只能给出通用政策，不知道公司具体规定

解决：将公司文件添加到知识库，RAG可以直接回答
</code></pre>
<h4 data-id="heading-12">3. <strong>成本和隐私</strong></h4>
<pre><code class="hljs language-diff" lang="diff">问题：大模型贵，私有信息不能上传

示例：
<span class="hljs-deletion">- 用更小的模型也能获得准确的专业回答</span>
<span class="hljs-deletion">- 私有知识保留在内部，不上传到云端</span>

解决：结合RAG和小模型（如qwen-turbo），低成本高效率
</code></pre>
<h3 data-id="heading-13">RAG的核心价值</h3>
<pre><code class="hljs language-markdown" lang="markdown">┌──────────────────────────────┐
│    知识库 + 小模型           │
│ = 大模型的效果 + 低成本      │
└──────────────────────────────┘
<span class="hljs-code">                ↓
┌──────────────────────────────┐
│   专业、准确、可追溯         │
│   的智能问答系统             │
└──────────────────────────────┘
</span></code></pre>
<hr/>
<h2 data-id="heading-14">12.3 RAG的实现方式</h2>
<h3 data-id="heading-15">基础RAG实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicRAGDemo</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Model</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeModel.builder()
            .modelName(<span class="hljs-string">"qwen-turbo"</span>)
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .build();
        
        <span class="hljs-comment">// 1. 创建知识库</span>
        System.out.println(<span class="hljs-string">"=== 初始化知识库 ===\n"</span>);
        
        <span class="hljs-type">Knowledge</span> <span class="hljs-variable">knowledge</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleEmbeddingKnowledge</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashScopeEmbeddingService</span>(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryVectorStore</span>()
        );
        
        <span class="hljs-comment">// 2. 添加公司知识文档</span>
        System.out.println(<span class="hljs-string">"=== 添加知识文档 ===\n"</span>);
        
        List&lt;Document&gt; documents = List.of(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(
                <span class="hljs-string">"产假政策"</span>,
                <span class="hljs-string">"女性员工享受158天产假，其中："</span> +
                <span class="hljs-string">"- 产前30天\n"</span> +
                <span class="hljs-string">"- 产后128天\n"</span> +
                <span class="hljs-string">"符合条件的可申请延长30天"</span>
            ),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(
                <span class="hljs-string">"年假政策"</span>,
                <span class="hljs-string">"年假计算：\n"</span> +
                <span class="hljs-string">"- 入职1-10年：10天\n"</span> +
                <span class="hljs-string">"- 入职10-20年：15天\n"</span> +
                <span class="hljs-string">"- 入职20年以上：20天\n"</span> +
                <span class="hljs-string">"年假可以跨年结转，最多3年"</span>
            ),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(
                <span class="hljs-string">"远程工作政策"</span>,
                <span class="hljs-string">"申请条件：\n"</span> +
                <span class="hljs-string">"- 入职满6个月\n"</span> +
                <span class="hljs-string">"- 性能评级不低于B\n"</span> +
                <span class="hljs-string">"频率：每周最多3天\n"</span> +
                <span class="hljs-string">"需要主管批准"</span>
            ),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(
                <span class="hljs-string">"技术栈"</span>,
                <span class="hljs-string">"后端：Java 17 + Spring Boot 3.0 + Spring Cloud\n"</span> +
                <span class="hljs-string">"数据库：MySQL + Redis + Elasticsearch\n"</span> +
                <span class="hljs-string">"部署：Kubernetes + Docker\n"</span> +
                <span class="hljs-string">"监控：Prometheus + Grafana"</span>
            )
        );
        
        knowledge.addDocuments(documents).block();
        System.out.println(<span class="hljs-string">"已添加 "</span> + documents.size() + <span class="hljs-string">" 个文档\n"</span>);
        
        <span class="hljs-comment">// 3. 创建支持RAG的Agent</span>
        System.out.println(<span class="hljs-string">"=== 创建支持RAG的Agent ===\n"</span>);
        
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"CompanyInfoAgent"</span>)
            .model(model)
            .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
            .systemPrompt(<span class="hljs-string">"你是公司员工的HR助手，回答关于公司政策和技术的问题。"</span> +
                         <span class="hljs-string">"如果使用了知识库中的信息，请明确引用来源。"</span>)
            .hooks(List.of(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">RAGHook</span>(knowledge)
            ))
            .build();
        
        <span class="hljs-comment">// 4. 提问</span>
        System.out.println(<span class="hljs-string">"=== 提问环节 ===\n"</span>);
        
        String[] questions = {
            <span class="hljs-string">"我刚入职，想了解公司的年假政策"</span>,
            <span class="hljs-string">"能否告诉我们公司使用的技术栈？"</span>,
            <span class="hljs-string">"我需要申请产假，能享受多久？"</span>
        };
        
        <span class="hljs-keyword">for</span> (String question : questions) {
            System.out.println(<span class="hljs-string">"Q: "</span> + question);
            
            <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(Msg.builder()
                .role(MsgRole.USER)
                .textContent(question)
                .build()).block();
            
            System.out.println(<span class="hljs-string">"A: "</span> + response.getTextContent() + <span class="hljs-string">"\n"</span>);
        }
    }
    
    <span class="hljs-comment">/**
     * 简单的RAG Hook实现
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGHook</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hook</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Knowledge knowledge;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">RAGHook</span><span class="hljs-params">(Knowledge knowledge)</span> {
            <span class="hljs-built_in">this</span>.knowledge = knowledge;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
            <span class="hljs-keyword">if</span> (!(event <span class="hljs-keyword">instanceof</span> PreReasoningEvent pre)) {
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
            
            <span class="hljs-comment">// 从用户问题中提取查询</span>
            List&lt;Msg&gt; messages = pre.getInputMessages();
            <span class="hljs-keyword">if</span> (messages.isEmpty()) {
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
            
            <span class="hljs-type">String</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> messages.get(messages.size() - <span class="hljs-number">1</span>).getTextContent();
            
            <span class="hljs-comment">// 检索相关文档</span>
            <span class="hljs-keyword">return</span> knowledge.retrieve(query, RetrieveConfig.builder()
                .limit(<span class="hljs-number">3</span>)
                .scoreThreshold(<span class="hljs-number">0.5</span>)
                .build())
            .flatMapMany(documents -&gt; {
                <span class="hljs-comment">// 将检索结果作为System消息插入</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">ragContext</span> <span class="hljs-operator">=</span> <span class="hljs-string">"相关知识库信息：\n"</span>;
                <span class="hljs-keyword">for</span> (Document doc : documents) {
                    ragContext += <span class="hljs-string">"\n【"</span> + doc.getTitle() + <span class="hljs-string">"】\n"</span> +
                                 doc.getContent() + <span class="hljs-string">"\n"</span>;
                }
                
                <span class="hljs-type">Msg</span> <span class="hljs-variable">ragMsg</span> <span class="hljs-operator">=</span> Msg.builder()
                    .role(MsgRole.SYSTEM)
                    .textContent(ragContext)
                    .build();
                
                List&lt;Msg&gt; enhanced = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
                enhanced.add(ragMsg);
                enhanced.addAll(messages);
                
                pre.setInputMessages(enhanced);
                
                <span class="hljs-keyword">return</span> Mono.just(event);
            })
            .thenReturn(event);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPriority</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-16">使用工具方式的RAG</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolBasedRAGDemo</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Model</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeModel.builder()
            .modelName(<span class="hljs-string">"qwen-turbo"</span>)
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .build();
        
        <span class="hljs-comment">// 创建知识库</span>
        <span class="hljs-type">Knowledge</span> <span class="hljs-variable">knowledge</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleEmbeddingKnowledge</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashScopeEmbeddingService</span>(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryVectorStore</span>()
        );
        
        knowledge.addDocuments(getSampleDocuments()).block();
        
        <span class="hljs-comment">// 创建Agent，通过工具而不是Hook使用RAG</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"ToolBasedRAGAgent"</span>)
            .model(model)
            .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>()
                .registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RAGTools</span>(knowledge)))
            .systemPrompt(<span class="hljs-string">"""
                你是一个信息助手。
                当需要查询信息时，使用searchKnowledgeBase工具。
                """</span>)
            .build();
        
        <span class="hljs-comment">// 提问时，Agent会主动调用RAG工具</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(Msg.builder()
            .textContent(<span class="hljs-string">"请告诉我产假的具体规定"</span>)
            .build()).block();
        
        System.out.println(response.getTextContent());
    }
    
    <span class="hljs-comment">/**
     * 提供RAG功能的工具集
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGTools</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Knowledge knowledge;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">RAGTools</span><span class="hljs-params">(Knowledge knowledge)</span> {
            <span class="hljs-built_in">this</span>.knowledge = knowledge;
        }
        
        <span class="hljs-meta">@Tool(description = "在知识库中搜索相关信息")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">searchKnowledgeBase</span><span class="hljs-params">(String query)</span> {
            List&lt;Document&gt; results = knowledge.retrieve(query, 
                RetrieveConfig.builder()
                    .limit(<span class="hljs-number">5</span>)
                    .scoreThreshold(<span class="hljs-number">0.5</span>)
                    .build())
            .block();
            
            <span class="hljs-keyword">if</span> (results.isEmpty()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"知识库中未找到相关信息"</span>;
            }
            
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"搜索结果：\n"</span>);
            <span class="hljs-keyword">for</span> (Document doc : results) {
                sb.append(<span class="hljs-string">"【"</span>).append(doc.getTitle()).append(<span class="hljs-string">"】\n"</span>);
                sb.append(doc.getContent()).append(<span class="hljs-string">"\n\n"</span>);
            }
            <span class="hljs-keyword">return</span> sb.toString();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Document&gt; <span class="hljs-title function_">getSampleDocuments</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> List.of(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"产假政策"</span>, <span class="hljs-string">"女性员工享受158天产假..."</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"年假政策"</span>, <span class="hljs-string">"年假计算：入职1-10年：10天..."</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"远程工作政策"</span>, <span class="hljs-string">"申请条件：入职满6个月..."</span>)
        );
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">12.4 生产场景：企业知识库QA系统</h2>
<h3 data-id="heading-18">场景描述</h3>
<pre><code class="hljs language-markdown" lang="markdown">一个完整的企业知识库系统：
<span class="hljs-bullet">1.</span> 用户提出各种问题（HR、IT、产品等）
<span class="hljs-bullet">2.</span> 系统自动检索相关知识库文档
<span class="hljs-bullet">3.</span> 基于检索结果给出准确的回答
<span class="hljs-bullet">4.</span> 追踪未能回答的问题，不断完善知识库
</code></pre>
<h3 data-id="heading-19">实现代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnterpriseKnowledgeQASystem</span> {
    
    <span class="hljs-comment">/**
     * 知识库管理系统
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KnowledgebaseManager</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Knowledge knowledge;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReActAgent qaAgent;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Integer&gt; unansweredQuestions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">KnowledgebaseManager</span><span class="hljs-params">(Model model)</span> {
            <span class="hljs-built_in">this</span>.knowledge = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleEmbeddingKnowledge</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashScopeEmbeddingService</span>(),
                createPersistentVectorStore()
            );
            
            <span class="hljs-built_in">this</span>.qaAgent = ReActAgent.builder()
                .name(<span class="hljs-string">"EnterpriseQAAgent"</span>)
                .model(model)
                .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
                .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>()
                    .registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">KBTools</span>(knowledge)))
                .hooks(List.of(
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">RAGHook</span>(knowledge),
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">FeedbackHook</span>(unansweredQuestions)
                ))
                .systemPrompt(getSystemPrompt())
                .build();
            
            <span class="hljs-comment">// 初始化知识库</span>
            initializeKnowledgebase();
        }
        
        <span class="hljs-comment">/**
         * 回答用户问题
         */</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">answerQuestion</span><span class="hljs-params">(String question)</span> {
            System.out.println(<span class="hljs-string">"\n用户问题："</span> + question);
            
            <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> qaAgent.call(Msg.builder()
                .role(MsgRole.USER)
                .textContent(question)
                .build()).block();
            
            <span class="hljs-type">String</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> response.getTextContent();
            System.out.println(<span class="hljs-string">"系统回答："</span> + answer);
            
            <span class="hljs-keyword">return</span> answer;
        }
        
        <span class="hljs-comment">/**
         * 用户反馈
         */</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">provideFeedback</span><span class="hljs-params">(String question, String feedback)</span> {
            System.out.println(<span class="hljs-string">"\n用户反馈："</span> + feedback);
            
            <span class="hljs-comment">// 记录反馈，用于持续改进</span>
            <span class="hljs-keyword">if</span> (feedback.contains(<span class="hljs-string">"不准确"</span>) || feedback.contains(<span class="hljs-string">"不符合"</span>)) {
                System.out.println(<span class="hljs-string">"⚠️ 记录为不准确回答，需要改进知识库"</span>);
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"✓ 感谢反馈，用于改进系统"</span>);
            }
        }
        
        <span class="hljs-comment">/**
         * 添加新文档到知识库
         */</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addKnowledgeDocuments</span><span class="hljs-params">(List&lt;Document&gt; documents)</span> {
            knowledge.addDocuments(documents).block();
            System.out.println(<span class="hljs-string">"已添加 "</span> + documents.size() + <span class="hljs-string">" 个新文档"</span>);
        }
        
        <span class="hljs-comment">/**
         * 获取未能回答的问题统计
         */</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showUnansweredStatistics</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 未能回答的问题统计 ==="</span>);
            unansweredQuestions.entrySet().stream()
                .sorted((a, b) -&gt; b.getValue().compareTo(a.getValue()))
                .forEach(entry -&gt; 
                    System.out.println(<span class="hljs-string">"「"</span> + entry.getKey() + <span class="hljs-string">"」："</span> + 
                        entry.getValue() + <span class="hljs-string">"次"</span>));
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeKnowledgebase</span><span class="hljs-params">()</span> {
            List&lt;Document&gt; docs = List.of(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"入职流程"</span>, <span class="hljs-string">"新员工入职流程：..."</span>),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"办公系统"</span>, <span class="hljs-string">"公司使用：OA系统、钉钉、企业邮箱..."</span>),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"差旅费规定"</span>, <span class="hljs-string">"国内出差：...，国际出差：..."</span>),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"采购流程"</span>, <span class="hljs-string">"小于5000元：部门批准即可..."</span>),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"绩效评估"</span>, <span class="hljs-string">"年度评估周期：...，晋升标准：..."</span>)
            );
            addKnowledgeDocuments(docs);
        }
        
        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getSystemPrompt</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"""
                你是企业知识库的AI助手，帮助员工了解公司政策和流程。
                
                原则：
                1. 优先使用知识库信息回答问题
                2. 如果知识库中没有相关信息，明确说明
                3. 对于敏感问题（如薪资、个人隐私），建议联系HR
                4. 回答时明确引用知识库来源
                5. 鼓励用户反馈，帮助我们改进
                
                如果无法回答，请说："抱歉，我在知识库中没有找到相关信息，
                请联系相应部门或HR。"
                """</span>;
        }
        
        <span class="hljs-keyword">private</span> VectorStore <span class="hljs-title function_">createPersistentVectorStore</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 在生产中应该使用如Milvus、Weaviate等向量数据库</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryVectorStore</span>();
        }
    }
    
    <span class="hljs-comment">/**
     * 知识库工具集
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KBTools</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Knowledge knowledge;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">KBTools</span><span class="hljs-params">(Knowledge knowledge)</span> {
            <span class="hljs-built_in">this</span>.knowledge = knowledge;
        }
        
        <span class="hljs-meta">@Tool(description = "在知识库中搜索")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">search</span><span class="hljs-params">(String keyword)</span> {
            List&lt;Document&gt; results = knowledge.retrieve(keyword,
                RetrieveConfig.builder()
                    .limit(<span class="hljs-number">5</span>)
                    .scoreThreshold(<span class="hljs-number">0.5</span>)
                    .build())
            .block();
            
            <span class="hljs-keyword">return</span> formatResults(results);
        }
        
        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatResults</span><span class="hljs-params">(List&lt;Document&gt; documents)</span> {
            <span class="hljs-keyword">if</span> (documents.isEmpty()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"未找到相关文档"</span>;
            }
            
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
            <span class="hljs-keyword">for</span> (Document doc : documents) {
                sb.append(<span class="hljs-string">"【"</span>).append(doc.getTitle()).append(<span class="hljs-string">"】\n"</span>)
                  .append(doc.getContent()).append(<span class="hljs-string">"\n\n"</span>);
            }
            <span class="hljs-keyword">return</span> sb.toString();
        }
    }
    
    <span class="hljs-comment">/**
     * 反馈Hook：记录无法回答的问题
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeedbackHook</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hook</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Integer&gt; unansweredQuestions;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">FeedbackHook</span><span class="hljs-params">(Map&lt;String, Integer&gt; unansweredQuestions)</span> {
            <span class="hljs-built_in">this</span>.unansweredQuestions = unansweredQuestions;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
            <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> PostReasoningEvent post) {
                <span class="hljs-comment">// 检查回答质量</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> post.getReasoningResult();
                
                <span class="hljs-keyword">if</span> (response.contains(<span class="hljs-string">"无法"</span>) || response.contains(<span class="hljs-string">"不清楚"</span>)) {
                    <span class="hljs-comment">// 记录无法回答的问题</span>
                    <span class="hljs-type">String</span> <span class="hljs-variable">question</span> <span class="hljs-operator">=</span> extractQuestion(post.getInputMessages());
                    unansweredQuestions.put(question,
                        unansweredQuestions.getOrDefault(question, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>);
                }
            }
            <span class="hljs-keyword">return</span> Mono.just(event);
        }
        
        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">extractQuestion</span><span class="hljs-params">(List&lt;Msg&gt; messages)</span> {
            <span class="hljs-keyword">if</span> (!messages.isEmpty()) {
                <span class="hljs-keyword">return</span> messages.get(messages.size() - <span class="hljs-number">1</span>).getTextContent();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Unknown"</span>;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPriority</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * RAG Hook
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGHook</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Hook</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Knowledge knowledge;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">RAGHook</span><span class="hljs-params">(Knowledge knowledge)</span> {
            <span class="hljs-built_in">this</span>.knowledge = knowledge;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
            <span class="hljs-keyword">if</span> (!(event <span class="hljs-keyword">instanceof</span> PreReasoningEvent pre)) {
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
            
            <span class="hljs-comment">// 检索相关文档</span>
            List&lt;Msg&gt; messages = pre.getInputMessages();
            <span class="hljs-type">String</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> messages.isEmpty() ? <span class="hljs-string">""</span> : 
                messages.get(messages.size() - <span class="hljs-number">1</span>).getTextContent();
            
            <span class="hljs-keyword">if</span> (query.isEmpty()) {
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
            
            <span class="hljs-keyword">return</span> knowledge.retrieve(query, RetrieveConfig.builder()
                .limit(<span class="hljs-number">3</span>)
                .scoreThreshold(<span class="hljs-number">0.5</span>)
                .build())
            .flatMapMany(documents -&gt; {
                <span class="hljs-type">String</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> buildRAGContext(documents);
                
                <span class="hljs-type">Msg</span> <span class="hljs-variable">ragMsg</span> <span class="hljs-operator">=</span> Msg.builder()
                    .role(MsgRole.SYSTEM)
                    .textContent(context)
                    .build();
                
                List&lt;Msg&gt; enhanced = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
                enhanced.add(ragMsg);
                enhanced.addAll(messages);
                
                pre.setInputMessages(enhanced);
                
                <span class="hljs-keyword">return</span> Mono.just(event);
            })
            .thenReturn(event);
        }
        
        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildRAGContext</span><span class="hljs-params">(List&lt;Document&gt; documents)</span> {
            <span class="hljs-keyword">if</span> (documents.isEmpty()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
            }
            
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"【来自知识库的相关信息】\n"</span>);
            <span class="hljs-keyword">for</span> (Document doc : documents) {
                sb.append(<span class="hljs-string">"\n"</span>).append(doc.getTitle()).append(<span class="hljs-string">"：\n"</span>)
                  .append(doc.getContent()).append(<span class="hljs-string">"\n"</span>);
            }
            <span class="hljs-keyword">return</span> sb.toString();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPriority</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 测试主程序
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Model</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeModel.builder()
            .modelName(<span class="hljs-string">"qwen-turbo"</span>)
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .build();
        
        <span class="hljs-type">KnowledgebaseManager</span> <span class="hljs-variable">kb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KnowledgebaseManager</span>(model);
        
        <span class="hljs-comment">// 回答一系列问题</span>
        String[] questions = {
            <span class="hljs-string">"新员工入职有哪些流程？"</span>,
            <span class="hljs-string">"我要出国出差，有什么规定吗？"</span>,
            <span class="hljs-string">"怎样申请采购？"</span>,
            <span class="hljs-string">"无敌问题？"</span>  <span class="hljs-comment">// 故意问一个无法回答的问题</span>
        };
        
        <span class="hljs-keyword">for</span> (String question : questions) {
            kb.answerQuestion(question);
            kb.provideFeedback(question, <span class="hljs-string">"✓ 很有帮助"</span>);
        }
        
        <span class="hljs-comment">// 显示统计信息</span>
        kb.showUnansweredStatistics();
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-20">12.5 支持的知识库后端</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 内存向量库（开发用）</span>
<span class="hljs-type">Knowledge</span> <span class="hljs-variable">kb1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleEmbeddingKnowledge</span>(
    embeddingService,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryVectorStore</span>()
);

<span class="hljs-comment">// 2. 阿里云百炼</span>
<span class="hljs-type">Knowledge</span> <span class="hljs-variable">kb2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BailianKnowledge</span>(
    apiKey,
    workspaceId,
    datasetId
);

<span class="hljs-comment">// 3. Dify</span>
<span class="hljs-type">Knowledge</span> <span class="hljs-variable">kb3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DifyKnowledge</span>(
    baseUrl,
    apiKey
);

<span class="hljs-comment">// 4. RAGFlow</span>
<span class="hljs-type">Knowledge</span> <span class="hljs-variable">kb4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RAGFlowKnowledge</span>(
    baseUrl,
    apiKey
);

<span class="hljs-comment">// 5. 自建向量库（Milvus、Weaviate等）</span>
<span class="hljs-type">Knowledge</span> <span class="hljs-variable">kb5</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomVectorKnowledge</span>(
    customVectorStore,
    customEmbeddingService
);
</code></pre>
<hr/>
<h2 data-id="heading-21">本章总结</h2>
<p>本章介绍了<strong>RAG（检索增强生成）<strong>系统，这是让Agent</strong>基于最新知识库回答问题</strong>的核心技术：</p>
<h3 data-id="heading-22">核心要点</h3>
<ul>
<li>RAG是检索+生成的混合模式</li>
<li>支持最新知识、领域专业性、成本优化</li>
<li>通过Hook或工具集成RAG功能</li>
</ul>
<h3 data-id="heading-23">使用场景</h3>
<ul>
<li>企业知识库QA系统</li>
<li>文档基础的客服</li>
<li>持续学习和知识积累</li>
<li>私有信息的安全处理</li>
</ul>
<hr/>
<h2 data-id="heading-24">下一章预告</h2>
<p><strong>第13章：结构化输出（Structured Output）</strong></p>
<p>当Agent需要<strong>返回机器可解析的数据</strong>而不是自由文本时，结构化输出就变得至关重要。第13章将介绍如何确保LLM返回类型安全的、结构化的数据。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npm/yarn/pnpm 原理与选型指南]]></title>    <link>https://juejin.cn/post/7589475923696975891</link>    <guid>https://juejin.cn/post/7589475923696975891</guid>    <pubDate>2025-12-30T09:27:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589475923696975891" data-draft-id="7589475923696959507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npm/yarn/pnpm 原理与选型指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-30T09:27:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npm/yarn/pnpm 原理与选型指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T09:27:45.000Z" title="Tue Dec 30 2025 09:27:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">npm/yarn/pnpm 深度对比：包管理工具的底层原理与选型</h2>
<blockquote>
<p>从 node_modules 的黑洞说起，剖析 npm、yarn、pnpm 的依赖解析算法、安装策略、锁文件机制，搞懂为什么 pnpm 能省 50% 磁盘空间。</p>
</blockquote>
<h3 data-id="heading-1">一、包管理器演进史</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2010</span> <span class="hljs-string">────────────────────────────────────────────────►</span> <span class="hljs-number">2025</span>
  <span class="hljs-string">│</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">2010:</span> <span class="hljs-string">npm</span> <span class="hljs-string">诞生（随</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">一起发布）</span>
  <span class="hljs-string">│</span>         <span class="hljs-string">└─</span> <span class="hljs-string">嵌套依赖，node_modules</span> <span class="hljs-string">黑洞的开始</span>
  <span class="hljs-string">│</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">2016:</span> <span class="hljs-string">yarn</span> <span class="hljs-string">发布（Facebook）</span>
  <span class="hljs-string">│</span>         <span class="hljs-string">└─</span> <span class="hljs-string">扁平化</span> <span class="hljs-string">+</span> <span class="hljs-string">lockfile，解决依赖地狱</span>
  <span class="hljs-string">│</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">2017:</span> <span class="hljs-string">npm</span> <span class="hljs-number">5.0</span>
  <span class="hljs-string">│</span>         <span class="hljs-string">└─</span> <span class="hljs-string">引入</span> <span class="hljs-string">package-lock.json，追赶</span> <span class="hljs-string">yarn</span>
  <span class="hljs-string">│</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">2017:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">发布</span>
  <span class="hljs-string">│</span>         <span class="hljs-string">└─</span> <span class="hljs-string">硬链接</span> <span class="hljs-string">+</span> <span class="hljs-string">符号链接，革命性架构</span>
  <span class="hljs-string">│</span>
  <span class="hljs-string">├─</span> <span class="hljs-attr">2020:</span> <span class="hljs-string">yarn</span> <span class="hljs-number">2</span> <span class="hljs-string">(Berry)</span>
  <span class="hljs-string">│</span>         <span class="hljs-string">└─</span> <span class="hljs-string">Plug'n'Play，零</span> <span class="hljs-string">node_modules</span>
  <span class="hljs-string">│</span>
  <span class="hljs-string">└─</span> <span class="hljs-attr">2024:</span> <span class="hljs-string">npm/yarn/pnpm</span> <span class="hljs-string">三足鼎立</span>
            <span class="hljs-string">└─</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">市场份额快速增长</span>
</code></pre>
<h3 data-id="heading-2">二、node_modules 结构演进</h3>
<h4 data-id="heading-3">2.1 npm v2：嵌套地狱</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">node_modules/
├── <span class="hljs-symbol">A@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/
│   └── node_modules/
│       └── <span class="hljs-symbol">B@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/
│           └── node_modules/
│               └── <span class="hljs-symbol">C@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/
├── <span class="hljs-symbol">D@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/
│   └── node_modules/
│       └── <span class="hljs-symbol">B@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/        ← 重复！
│           └── node_modules/
│               └── <span class="hljs-symbol">C@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/  ← 重复！
└── <span class="hljs-symbol">E@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/
    └── node_modules/
        └── <span class="hljs-symbol">B@</span><span class="hljs-number">2.0</span><span class="hljs-number">.0</span>/        ← 不同版本
            └── node_modules/
                └── <span class="hljs-symbol">C@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/  ← 又重复！
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>🔴 路径过长（Windows 260 字符限制）</li>
<li>🔴 大量重复依赖，磁盘爆炸</li>
<li>🔴 安装速度慢</li>
</ul>
<h4 data-id="heading-4">2.2 npm v3+ / yarn：扁平化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">node_modules/
├── <span class="hljs-symbol">A@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/
├── <span class="hljs-symbol">B@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/          ← 提升到顶层
├── <span class="hljs-symbol">C@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/          ← 提升到顶层
├── <span class="hljs-symbol">D@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/
├── <span class="hljs-symbol">E@</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/
│   └── node_modules/
│       └── <span class="hljs-symbol">B@</span><span class="hljs-number">2.0</span><span class="hljs-number">.0</span>/  ← 版本冲突，保留嵌套
└── ...
</code></pre>
<p><strong>解决了</strong>：路径过长、部分重复</p>
<p><strong>新问题</strong>：</p>
<ul>
<li>🔴 <strong>幽灵依赖</strong>：可以 require 未声明的包</li>
<li>🔴 <strong>依赖分身</strong>：同一个包可能有多个副本</li>
<li>🔴 <strong>不确定性</strong>：安装顺序影响结构</li>
</ul>
<h4 data-id="heading-5">2.3 pnpm：内容寻址 + 符号链接</h4>
<pre><code class="hljs language-less" lang="less">~/<span class="hljs-selector-class">.pnpm-store</span>/                    ← 全局存储（硬链接源）
└── <span class="hljs-selector-tag">v3</span>/
    └── <span class="hljs-selector-tag">files</span>/
        ├── <span class="hljs-number">00</span>/
        │   └── <span class="hljs-selector-tag">abc123</span>...         ← 按内容哈希存储
        ├── <span class="hljs-number">01</span>/
        └── ...

<span class="hljs-selector-tag">node_modules</span>/
├── <span class="hljs-selector-class">.pnpm</span>/                        ← 真实依赖（硬链接）
│   ├── <span class="hljs-selector-tag">A</span>@<span class="hljs-number">1.0</span><span class="hljs-selector-class">.0</span>/
│   │   └── <span class="hljs-selector-tag">node_modules</span>/
│   │       ├── <span class="hljs-selector-tag">A</span> → &lt;<span class="hljs-selector-tag">store</span>&gt;/<span class="hljs-selector-tag">A</span>     ← 硬链接到 <span class="hljs-selector-tag">store</span>
│   │       └── <span class="hljs-selector-tag">B</span> → ../../<span class="hljs-selector-tag">B</span>@<span class="hljs-number">1.0</span><span class="hljs-selector-class">.0</span>/<span class="hljs-selector-tag">node_modules</span>/<span class="hljs-selector-tag">B</span>  ← 符号链接
│   ├── <span class="hljs-selector-tag">B</span>@<span class="hljs-number">1.0</span><span class="hljs-selector-class">.0</span>/
│   │   └── <span class="hljs-selector-tag">node_modules</span>/
│   │       └── <span class="hljs-selector-tag">B</span> → &lt;<span class="hljs-selector-tag">store</span>&gt;/<span class="hljs-selector-tag">B</span>
│   └── <span class="hljs-selector-tag">B</span>@<span class="hljs-number">2.0</span><span class="hljs-selector-class">.0</span>/
│       └── <span class="hljs-selector-tag">node_modules</span>/
│           └── <span class="hljs-selector-tag">B</span> → &lt;<span class="hljs-selector-tag">store</span>&gt;/<span class="hljs-selector-tag">B</span>
├── <span class="hljs-selector-tag">A</span> → <span class="hljs-selector-class">.pnpm</span>/<span class="hljs-selector-tag">A</span>@<span class="hljs-number">1.0</span><span class="hljs-selector-class">.0</span>/<span class="hljs-selector-tag">node_modules</span>/<span class="hljs-selector-tag">A</span>    ← 符号链接
├── <span class="hljs-selector-tag">D</span> → <span class="hljs-selector-class">.pnpm</span>/<span class="hljs-selector-tag">D</span>@<span class="hljs-number">1.0</span><span class="hljs-selector-class">.0</span>/<span class="hljs-selector-tag">node_modules</span>/<span class="hljs-selector-tag">D</span>
└── <span class="hljs-selector-tag">E</span> → <span class="hljs-selector-class">.pnpm</span>/<span class="hljs-selector-tag">E</span>@<span class="hljs-number">1.0</span><span class="hljs-selector-class">.0</span>/<span class="hljs-selector-tag">node_modules</span>/<span class="hljs-selector-tag">E</span>
</code></pre>
<p><strong>核心原理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────────┐
│                    pnpm 的三层结构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   项目 node_modules/          只有直接依赖的符号链接             │
│            │                                                     │
│            ▼                                                     │
│   .<span class="hljs-property">pnpm</span>/ 虚拟存储             所有依赖的扁平结构（符号链接）     │
│            │                                                     │
│            ▼                                                     │
│   ~<span class="hljs-regexp">/.pnpm-store/</span>              全局存储（硬链接，真实文件）       │
│                                                                  │
│   💡 同一个包版本，全局只存一份                                  │
│   💡 不同项目通过硬链接共享                                      │
│   💡 项目只能访问声明的依赖（解决幽灵依赖）                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-6">三、幽灵依赖问题详解</h3>
<h4 data-id="heading-7">3.1 什么是幽灵依赖？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// package.json 只声明了 express</span>
{
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"express"</span>: <span class="hljs-string">"^4.18.0"</span>
  }
}

<span class="hljs-comment">// 但你可以这样写（npm/yarn 扁平化后）</span>
<span class="hljs-keyword">const</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>);  <span class="hljs-comment">// 😱 未声明，但能用！</span>
<span class="hljs-keyword">const</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'qs'</span>);        <span class="hljs-comment">// 😱 express 的依赖</span>

<span class="hljs-comment">// 问题：</span>
<span class="hljs-comment">// 1. express 升级后可能不再依赖 debug → 你的代码挂了</span>
<span class="hljs-comment">// 2. 换台机器安装顺序不同 → 可能找不到</span>
<span class="hljs-comment">// 3. 代码审查看不出真实依赖</span>
</code></pre>
<h4 data-id="heading-8">3.2 pnpm 如何解决？</h4>
<pre><code class="hljs language-bash" lang="bash">node_modules/
├── express → .pnpm/express@4.18.0/...  ← 只有 express
└── .pnpm/
    └── express@4.18.0/
        └── node_modules/
            ├── express/
            ├── debug/      ← debug 在这里，外面访问不到
            └── qs/
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pnpm 项目中</span>
<span class="hljs-keyword">const</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>);  
<span class="hljs-comment">// ❌ Error: Cannot find module 'debug'</span>

<span class="hljs-comment">// 必须显式声明</span>
<span class="hljs-comment">// package.json: "debug": "^4.0.0"</span>
<span class="hljs-comment">// 然后才能用</span>
</code></pre>
<h3 data-id="heading-9">四、依赖解析算法</h3>
<h4 data-id="heading-10">4.1 npm/yarn 的依赖提升</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 依赖关系</span>
A@<span class="hljs-number">1.0</span> → B@<span class="hljs-number">1.0</span>
C@<span class="hljs-number">1.0</span> → B@<span class="hljs-number">2.0</span>

<span class="hljs-comment">// npm/yarn 解析结果（取决于安装顺序）</span>
<span class="hljs-comment">// 情况1：先安装 A</span>
node_modules/
├── A@<span class="hljs-number">1.0</span>/
├── B@<span class="hljs-number">1.0</span>/          ← B@<span class="hljs-number">1.0</span> 被提升
└── C@<span class="hljs-number">1.0</span>/
    └── node_modules/
        └── B@<span class="hljs-number">2.0</span>/  ← B@<span class="hljs-number">2.0</span> 嵌套

<span class="hljs-comment">// 情况2：先安装 C</span>
node_modules/
├── A@<span class="hljs-number">1.0</span>/
│   └── node_modules/
│       └── B@<span class="hljs-number">1.0</span>/  ← B@<span class="hljs-number">1.0</span> 嵌套
├── B@<span class="hljs-number">2.0</span>/          ← B@<span class="hljs-number">2.0</span> 被提升
└── C@<span class="hljs-number">1.0</span>/
</code></pre>
<p><strong>这就是为什么需要 lockfile！</strong></p>
<h4 data-id="heading-11">4.2 pnpm 的确定性解析</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pnpm 不做提升，结构永远确定</span>
node_modules/
├── A → .<span class="hljs-property">pnpm</span>/A@<span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/node_modules/A
├── C → .<span class="hljs-property">pnpm</span>/C@<span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/node_modules/C
└── .<span class="hljs-property">pnpm</span>/
    ├── A@<span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/node_modules/
    │   ├── A/
    │   └── B → ../../B@<span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/node_modules/B
    ├── B@<span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/node_modules/B/
    ├── B@<span class="hljs-number">2.0</span><span class="hljs-number">.0</span>/node_modules/B/
    └── C@<span class="hljs-number">1.0</span><span class="hljs-number">.0</span>/node_modules/
        ├── C/
        └── B → ../../B@<span class="hljs-number">2.0</span><span class="hljs-number">.0</span>/node_modules/B

<span class="hljs-comment">// 💡 每个包都能找到正确版本的依赖</span>
<span class="hljs-comment">// 💡 不受安装顺序影响</span>
</code></pre>
<h3 data-id="heading-12">五、Lockfile 机制对比</h3>
<h4 data-id="heading-13">5.1 三种 lockfile 格式</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ==================== package-lock.json (npm) ====================</span>
{
  <span class="hljs-attr">"name":</span> <span class="hljs-string">"my-app"</span>,
  <span class="hljs-attr">"lockfileVersion":</span> <span class="hljs-number">3</span>,
  <span class="hljs-attr">"packages":</span> {
    <span class="hljs-attr">"node_modules/lodash":</span> {
      <span class="hljs-attr">"version":</span> <span class="hljs-string">"4.17.21"</span>,
      <span class="hljs-attr">"resolved":</span> <span class="hljs-string">"https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz"</span>,
      <span class="hljs-attr">"integrity":</span> <span class="hljs-string">"sha512-v2kDE..."</span>
    }
  }
}

<span class="hljs-comment"># ==================== yarn.lock (yarn) ====================</span>
<span class="hljs-string">lodash@^4.17.0:</span>
  <span class="hljs-string">version</span> <span class="hljs-string">"4.17.21"</span>
  <span class="hljs-string">resolved</span> <span class="hljs-string">"https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz"</span>
  <span class="hljs-string">integrity</span> <span class="hljs-string">sha512-v2kDE...</span>

<span class="hljs-comment"># ==================== pnpm-lock.yaml (pnpm) ====================</span>
<span class="hljs-attr">lockfileVersion:</span> <span class="hljs-string">'9.0'</span>
<span class="hljs-attr">packages:</span>
  <span class="hljs-string">lodash@4.17.21:</span>
    <span class="hljs-attr">resolution:</span> {<span class="hljs-attr">integrity:</span> <span class="hljs-string">sha512-v2kDE...</span>}
    <span class="hljs-attr">engines:</span> {<span class="hljs-attr">node:</span> <span class="hljs-string">'&gt;=0.10.0'</span>}
</code></pre>
<h4 data-id="heading-14">5.2 Lockfile 作用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">┌─────────────────────────────────────────────────────────────────┐
│                    Lockfile 解决的问题                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   <span class="hljs-keyword">package</span>.json: <span class="hljs-string">"lodash"</span>: <span class="hljs-string">"^4.17.0"</span>                             │
│                                                                  │
│   没有 lockfile：                                                │
│   • 今天安装：<span class="hljs-symbol">lodash@</span><span class="hljs-number">4.17</span><span class="hljs-number">.20</span>                                    │
│   • 明天安装：<span class="hljs-symbol">lodash@</span><span class="hljs-number">4.17</span><span class="hljs-number">.21</span>（新版本发布了）                    │
│   • 😱 不同时间/机器安装结果不同                                │
│                                                                  │
│   有 lockfile：                                                  │
│   • 锁定 <span class="hljs-symbol">lodash@</span><span class="hljs-number">4.17</span><span class="hljs-number">.20</span>                                         │
│   • 任何时间/机器安装结果相同                                   │
│   • ✅ 可复现的构建                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-15">5.3 Lockfile 对比</h4>









































<table><thead><tr><th>特性</th><th>package-lock.json</th><th>yarn.lock</th><th>pnpm-lock.yaml</th></tr></thead><tbody><tr><td>格式</td><td>JSON</td><td>自定义</td><td>YAML</td></tr><tr><td>可读性</td><td>差（嵌套深）</td><td>好</td><td>好</td></tr><tr><td>合并冲突</td><td>难解决</td><td>较易</td><td>较易</td></tr><tr><td>包含信息</td><td>完整树结构</td><td>扁平列表</td><td>扁平 + 依赖关系</td></tr><tr><td>文件大小</td><td>大</td><td>中</td><td>小</td></tr></tbody></table>
<h3 data-id="heading-16">六、性能对比实测</h3>
<h4 data-id="heading-17">6.1 安装速度</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                    <span class="hljs-string">安装速度对比（中型项目，约</span> <span class="hljs-number">500</span> <span class="hljs-string">依赖）</span>          <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">首次安装（无缓存）</span>                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">npm:</span>     <span class="hljs-string">████████████████████████████████</span>  <span class="hljs-string">65s</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">yarn:</span>    <span class="hljs-string">██████████████████████████</span>        <span class="hljs-string">52s</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">pnpm:</span>    <span class="hljs-string">████████████████████</span>              <span class="hljs-string">40s</span>  <span class="hljs-string">←</span> <span class="hljs-string">🔥</span> <span class="hljs-string">最快</span>     <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">重复安装（有缓存）</span>                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">npm:</span>     <span class="hljs-string">████████████████████</span>              <span class="hljs-string">38s</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">yarn:</span>    <span class="hljs-string">██████████████</span>                    <span class="hljs-string">28s</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">pnpm:</span>    <span class="hljs-string">████████</span>                          <span class="hljs-string">15s</span>  <span class="hljs-string">←</span> <span class="hljs-string">🔥</span> <span class="hljs-string">快</span> <span class="hljs-number">2.</span><span class="hljs-string">5x</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">CI</span> <span class="hljs-string">环境（有</span> <span class="hljs-string">lockfile，无</span> <span class="hljs-string">node_modules）</span>                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">npm ci:</span>  <span class="hljs-string">████████████████████████</span>          <span class="hljs-string">48s</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">yarn:</span>    <span class="hljs-string">██████████████████</span>                <span class="hljs-string">35s</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">pnpm:</span>    <span class="hljs-string">████████████</span>                      <span class="hljs-string">22s</span>  <span class="hljs-string">←</span> <span class="hljs-string">🔥</span> <span class="hljs-string">快</span> <span class="hljs-string">2x</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                  <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h4 data-id="heading-18">6.2 磁盘占用</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                    <span class="hljs-string">磁盘占用对比</span>                                  <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">单项目</span> <span class="hljs-string">node_modules</span>                                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">npm:</span>     <span class="hljs-string">████████████████████████████████</span>  <span class="hljs-string">850MB</span>              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">yarn:</span>    <span class="hljs-string">████████████████████████████████</span>  <span class="hljs-string">850MB</span>              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">pnpm:</span>    <span class="hljs-string">████████████████████████████████</span>  <span class="hljs-string">850MB（首次）</span>      <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-number">10</span> <span class="hljs-string">个相似项目（共享依赖</span> <span class="hljs-number">80</span><span class="hljs-string">%）</span>                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">npm:</span>     <span class="hljs-string">████████████████████████████████</span>  <span class="hljs-number">8.</span><span class="hljs-string">5GB</span>              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">yarn:</span>    <span class="hljs-string">████████████████████████████████</span>  <span class="hljs-number">8.</span><span class="hljs-string">5GB</span>              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">pnpm:</span>    <span class="hljs-string">████████████</span>                      <span class="hljs-number">2.</span><span class="hljs-string">1GB</span>  <span class="hljs-string">←</span> <span class="hljs-string">🔥</span> <span class="hljs-string">省</span> <span class="hljs-number">75</span><span class="hljs-string">%</span> <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">💡</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">通过硬链接共享，相同文件只存一份</span>                      <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                  <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h4 data-id="heading-19">6.3 性能对比表</h4>















































<table><thead><tr><th>指标</th><th>npm</th><th>yarn</th><th>pnpm</th></tr></thead><tbody><tr><td>首次安装</td><td>慢</td><td>中</td><td>快</td></tr><tr><td>重复安装</td><td>中</td><td>快</td><td>最快</td></tr><tr><td>磁盘占用</td><td>高</td><td>高</td><td>低（共享）</td></tr><tr><td>内存占用</td><td>中</td><td>高</td><td>低</td></tr><tr><td>并行下载</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>离线模式</td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table>
<h3 data-id="heading-20">七、Monorepo 支持对比</h3>
<h4 data-id="heading-21">7.1 Workspace 配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ==================== npm (v7+) ====================</span>
<span class="hljs-comment"># package.json</span>
{
  <span class="hljs-attr">"workspaces":</span> [<span class="hljs-string">"packages/*"</span>]
}

<span class="hljs-comment"># ==================== yarn ====================</span>
<span class="hljs-comment"># package.json</span>
{
  <span class="hljs-attr">"workspaces":</span> [<span class="hljs-string">"packages/*"</span>]
}

<span class="hljs-comment"># ==================== pnpm ====================</span>
<span class="hljs-comment"># pnpm-workspace.yaml</span>
<span class="hljs-attr">packages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">'packages/*'</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">'apps/*'</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">'!**/test/**'</span>  <span class="hljs-comment"># 排除</span>
</code></pre>
<h4 data-id="heading-22">7.2 Monorepo 命令对比</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在所有包中执行命令</span>
npm <span class="hljs-built_in">exec</span> --workspaces -- npm run build
yarn workspaces run build
pnpm -r run build                    <span class="hljs-comment"># 🔥 最简洁</span>

<span class="hljs-comment"># 在指定包中执行</span>
npm <span class="hljs-built_in">exec</span> --workspace=@my/pkg -- npm run build
yarn workspace @my/pkg run build
pnpm --filter @my/pkg run build      <span class="hljs-comment"># 🔥 filter 更强大</span>

<span class="hljs-comment"># 添加依赖到指定包</span>
npm install lodash --workspace=@my/pkg
yarn workspace @my/pkg add lodash
pnpm add lodash --filter @my/pkg

<span class="hljs-comment"># pnpm filter 高级用法</span>
pnpm --filter <span class="hljs-string">"@my/*"</span> run build           <span class="hljs-comment"># 匹配模式</span>
pnpm --filter <span class="hljs-string">"...@my/app"</span> run build      <span class="hljs-comment"># 包含依赖</span>
pnpm --filter <span class="hljs-string">"@my/app..."</span> run build      <span class="hljs-comment"># 包含被依赖</span>
pnpm --filter <span class="hljs-string">"...[origin/main]"</span> run build <span class="hljs-comment"># Git 变更的包</span>
</code></pre>
<h4 data-id="heading-23">7.3 Monorepo 对比表</h4>















































<table><thead><tr><th>特性</th><th>npm</th><th>yarn</th><th>pnpm</th></tr></thead><tbody><tr><td>Workspace 支持</td><td>v7+</td><td>v1+</td><td>✅</td></tr><tr><td>依赖提升</td><td>默认提升</td><td>默认提升</td><td>不提升（严格）</td></tr><tr><td>Filter 语法</td><td>基础</td><td>基础</td><td>强大</td></tr><tr><td>并行执行</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>拓扑排序</td><td>❌</td><td>❌</td><td>✅</td></tr><tr><td>变更检测</td><td>❌</td><td>❌</td><td>✅ (--filter)</td></tr></tbody></table>
<h3 data-id="heading-24">八、特殊场景处理</h3>
<h4 data-id="heading-25">8.1 Peer Dependencies</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 包 A 声明</span>
{
  <span class="hljs-string">"peerDependencies"</span>: {
    <span class="hljs-string">"react"</span>: <span class="hljs-string">"^17.0.0 || ^18.0.0"</span>
  }
}

<span class="hljs-comment">// npm 7+：自动安装 peer deps（可能导致冲突）</span>
<span class="hljs-comment">// yarn：警告但不自动安装</span>
<span class="hljs-comment">// pnpm：严格模式，必须显式安装</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># pnpm 处理 peer deps 警告</span>
pnpm install --strict-peer-dependencies=<span class="hljs-literal">false</span>

<span class="hljs-comment"># 或在 .npmrc 配置</span>
strict-peer-dependencies=<span class="hljs-literal">false</span>
auto-install-peers=<span class="hljs-literal">true</span>
</code></pre>
<h4 data-id="heading-26">8.2 可选依赖失败</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// package.json</span>
{
  <span class="hljs-string">"optionalDependencies"</span>: {
    <span class="hljs-string">"fsevents"</span>: <span class="hljs-string">"^2.3.0"</span>  <span class="hljs-comment">// macOS only</span>
  }
}

<span class="hljs-comment">// npm/yarn：失败时静默跳过</span>
<span class="hljs-comment">// pnpm：同样静默跳过，但日志更清晰</span>
</code></pre>
<h4 data-id="heading-27">8.3 私有仓库配置</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .npmrc（三者通用）</span>

<span class="hljs-comment"># 指定 registry</span>
<span class="hljs-attr">registry</span>=https://registry.npmmirror.com

<span class="hljs-comment"># 私有包使用私有仓库</span>
@mycompany:<span class="hljs-attr">registry</span>=https://npm.mycompany.com

<span class="hljs-comment"># 认证</span>
//npm.mycompany.com/:<span class="hljs-attr">_authToken</span>=<span class="hljs-variable">${NPM_TOKEN}</span>
</code></pre>
<h3 data-id="heading-28">九、安全性对比</h3>
<h4 data-id="heading-29">9.1 安全审计</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm</span>
npm audit
npm audit fix
npm audit fix --force  <span class="hljs-comment"># 强制升级（可能破坏性）</span>

<span class="hljs-comment"># yarn</span>
yarn audit
yarn audit --json

<span class="hljs-comment"># pnpm</span>
pnpm audit
pnpm audit --fix
</code></pre>
<h4 data-id="heading-30">9.2 安全特性对比</h4>









































<table><thead><tr><th>特性</th><th>npm</th><th>yarn</th><th>pnpm</th></tr></thead><tbody><tr><td>安全审计</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>自动修复</td><td>✅</td><td>❌</td><td>✅</td></tr><tr><td>幽灵依赖防护</td><td>❌</td><td>❌</td><td>✅</td></tr><tr><td>完整性校验</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>签名验证</td><td>✅ (v8.6+)</td><td>❌</td><td>❌</td></tr></tbody></table>
<h4 data-id="heading-31">9.3 pnpm 的安全优势</h4>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────────────┐
│                    pnpm 安全优势                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   1. 防止幽灵依赖攻击                                            │
│      • 恶意包无法被意外引入                                     │
│      • 只能访问显式声明的依赖                                   │
│                                                                  │
│   2. 内容寻址存储                                                │
│      • 文件按哈希存储                                           │
│      • 篡改会导致哈希不匹配                                     │
│                                                                  │
│   3. 严格的依赖解析                                              │
│      • 不会意外使用错误版本                                     │
│      • 依赖关系更清晰                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-32">十、迁移指南</h3>
<h4 data-id="heading-33">10.1 从 npm 迁移到 pnpm</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装 pnpm</span>
npm install -g pnpm

<span class="hljs-comment"># 2. 删除 node_modules 和 lockfile</span>
<span class="hljs-built_in">rm</span> -rf node_modules package-lock.json

<span class="hljs-comment"># 3. 导入（自动生成 pnpm-lock.yaml）</span>
pnpm import  <span class="hljs-comment"># 可以从 package-lock.json 导入</span>

<span class="hljs-comment"># 4. 安装</span>
pnpm install

<span class="hljs-comment"># 5. 更新 CI 脚本</span>
<span class="hljs-comment"># npm ci → pnpm install --frozen-lockfile</span>
<span class="hljs-comment"># npm install → pnpm install</span>
<span class="hljs-comment"># npm run → pnpm run</span>
</code></pre>
<h4 data-id="heading-34">10.2 从 yarn 迁移到 pnpm</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 删除 yarn 相关文件</span>
<span class="hljs-built_in">rm</span> -rf node_modules yarn.lock .yarnrc.yml

<span class="hljs-comment"># 2. 导入</span>
pnpm import  <span class="hljs-comment"># 可以从 yarn.lock 导入</span>

<span class="hljs-comment"># 3. 安装</span>
pnpm install

<span class="hljs-comment"># 4. 处理可能的幽灵依赖问题</span>
<span class="hljs-comment"># pnpm 会报错，按提示添加缺失的依赖</span>
pnpm add &lt;missing-package&gt;
</code></pre>
<h4 data-id="heading-35">10.3 常见迁移问题</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 问题1：幽灵依赖报错</span>
<span class="hljs-comment"># Error: Cannot find module 'xxx'</span>
<span class="hljs-comment"># 解决：显式添加依赖</span>
pnpm add xxx

<span class="hljs-comment"># 问题2：peer deps 警告</span>
<span class="hljs-comment"># 解决：配置 .npmrc</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"auto-install-peers=true"</span> &gt;&gt; .npmrc

<span class="hljs-comment"># 问题3：某些包不兼容符号链接</span>
<span class="hljs-comment"># 解决：配置 shamefully-hoist</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"shamefully-hoist=true"</span> &gt;&gt; .npmrc  <span class="hljs-comment"># 不推荐，最后手段</span>

<span class="hljs-comment"># 问题4：postinstall 脚本路径问题</span>
<span class="hljs-comment"># 解决：使用相对路径或 pnpm 的 hooks</span>
</code></pre>
<h3 data-id="heading-36">十一、最佳实践</h3>
<h4 data-id="heading-37">11.1 项目配置建议</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .npmrc（推荐配置）</span>

<span class="hljs-comment"># 使用国内镜像</span>
<span class="hljs-attr">registry</span>=https://registry.npmmirror.com

<span class="hljs-comment"># 自动安装 peer deps</span>
<span class="hljs-attr">auto-install-peers</span>=<span class="hljs-literal">true</span>

<span class="hljs-comment"># 严格模式（推荐）</span>
<span class="hljs-attr">strict-peer-dependencies</span>=<span class="hljs-literal">false</span>

<span class="hljs-comment"># 提升特定包（兼容性问题时使用）</span>
public-hoist-pattern<span class="hljs-section">[]</span>=*eslint*
public-hoist-pattern<span class="hljs-section">[]</span>=*prettier*
</code></pre>
<h4 data-id="heading-38">11.2 CI/CD 配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># GitHub Actions 示例</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">pnpm</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">pnpm/action-setup@v2</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">version:</span> <span class="hljs-number">8</span>

<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">node-version:</span> <span class="hljs-string">'20'</span>
    <span class="hljs-attr">cache:</span> <span class="hljs-string">'pnpm'</span>  <span class="hljs-comment"># 🔥 缓存 pnpm store</span>

<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">install</span> <span class="hljs-string">--frozen-lockfile</span>  <span class="hljs-comment"># 🔥 CI 必须用 frozen</span>

<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span>
</code></pre>
<h4 data-id="heading-39">11.3 团队协作规范</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm@8.15.0"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 🔥 锁定包管理器版本</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pnpm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=8"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx only-allow pnpm"</span>  <span class="hljs-comment">// 🔥 强制使用 pnpm</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-40">十二、选型建议</h3>
<h4 data-id="heading-41">12.1 决策树</h4>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────┐
│                    包管理器选型决策                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   你的场景是？                                                   │
│        │                                                         │
│        ├─ 新项目 ──────────────────────► pnpm（推荐）           │
│        │                                                         │
│        ├─ 老项目迁移成本高 ────────────► 保持现状               │
│        │                                                         │
│        ├─ Monorepo ────────────────────► pnpm（<span class="hljs-attribute">filter</span> 强大）    │
│        │                                                         │
│        ├─ 磁盘空间紧张 ────────────────► pnpm（省 <span class="hljs-number">50%</span>+）        │
│        │                                                         │
│        ├─ CI 速度敏感 ─────────────────► pnpm（快 <span class="hljs-number">2</span>x）          │
│        │                                                         │
│        └─ 团队不想学新工具 ────────────► npm（零学习成本）      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-42">12.2 场景推荐</h4>








































<table><thead><tr><th>场景</th><th>推荐</th><th>原因</th></tr></thead><tbody><tr><td>新项目</td><td>pnpm</td><td>性能好、安全、现代</td></tr><tr><td>Monorepo</td><td>pnpm</td><td>filter 语法强大</td></tr><tr><td>老项目维护</td><td>保持现状</td><td>迁移有成本</td></tr><tr><td>开源项目</td><td>npm/pnpm</td><td>npm 兼容性最好</td></tr><tr><td>企业项目</td><td>pnpm</td><td>磁盘省、速度快</td></tr><tr><td>学习/教程</td><td>npm</td><td>文档最多</td></tr></tbody></table>
<h4 data-id="heading-43">12.3 总结对比</h4>





















































<table><thead><tr><th>维度</th><th>npm</th><th>yarn</th><th>pnpm</th></tr></thead><tbody><tr><td>安装速度</td><td>⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>磁盘占用</td><td>⭐⭐</td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>安全性</td><td>⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>Monorepo</td><td>⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>兼容性</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td>学习成本</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td>社区生态</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<h4 data-id="heading-44">最终建议</h4>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────┐
│                    2025 年推荐                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   🥇 pnpm：新项目首选                                           │
│      • 性能最好，磁盘最省                                       │
│      • 解决幽灵依赖，更安全                                     │
│      • Monorepo 支持最强                                        │
│      • Vue、Vite 等主流项目都在用                               │
│                                                                  │
│   🥈 npm：兼容性优先                                            │
│      • Node.js 自带，零配置                                     │
│      • 文档最全，问题最好搜                                     │
│      • 开源项目贡献者友好                                       │
│                                                                  │
│   🥉 yarn：特定场景                                             │
│      • 已有 yarn 的老项目                                       │
│      • 需要 Plug<span class="hljs-string">'n'</span>Play 的场景                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，欢迎点赞收藏！有问题评论区见 🎉</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【LangChain学习笔记】输出解析器]]></title>    <link>https://juejin.cn/post/7588844115318685748</link>    <guid>https://juejin.cn/post/7588844115318685748</guid>    <pubDate>2025-12-29T07:17:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588844115318685748" data-draft-id="7589063105731035151" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【LangChain学习笔记】输出解析器"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T07:17:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【LangChain学习笔记】输出解析器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T07:17:30.000Z" title="Mon Dec 29 2025 07:17:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    45
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">核心定义</h2>
<p>输出解析器是 LangChain 核心组件之一，核心作用有三：</p>
<ol>
<li>为大模型提供标准化格式化提示词，引导模型按指定格式输出；</li>
<li>校验大模型输出是否符合预期格式要求；</li>
<li>解析大模型输出内容，转换为可用格式（字符串/结构化对象等）；</li>
</ol>
<h2 data-id="heading-1">常用输出解析器及使用</h2>
<h3 data-id="heading-2">StrOutputParser（字符串解析器）</h3>
<h4 data-id="heading-3">核心作用</h4>
<p>用于清理大模型输出内容，去除输出前后的换行符（<code>\n</code>），仅保留纯文本核心输出，返回标准字符串格式。</p>
<h4 data-id="heading-4">完整使用示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser

<span class="hljs-comment"># 大模型初始化</span>
llm = ChatOpenAI(
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    api_key=<span class="hljs-string">"[你的API Key]"</span>
)

<span class="hljs-comment"># 定义提示模板</span>
prompt_template = PromptTemplate.from_template(<span class="hljs-string">"你是一个专业的数学助手，{question}"</span>)

<span class="hljs-comment"># 初始化字符串解析器</span>
str_output_parser = StrOutputParser()

<span class="hljs-comment"># 构建链式调用</span>
chain = prompt_template | llm | str_output_parser

<span class="hljs-comment"># 执行调用</span>
response = chain.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"question"</span>: <span class="hljs-string">"计算10和20的和"</span>})

<span class="hljs-comment"># 打印解析后结果</span>
<span class="hljs-built_in">print</span>(response)
</code></pre>
<blockquote>
<p><strong>提示</strong>：<code>StrOutputParser </code> 不存在 <code>get_format_instructions</code> 方法，无需配置格式化指令。</p>
</blockquote>
<h3 data-id="heading-5">PydanticOutputParser（结构化对象解析器）</h3>
<h4 data-id="heading-6">核心作用</h4>
<p>将大模型输出解析为符合 Pydantic 模型定义的结构化对象，便于后续数据提取与校验，返回值为 Pydantic 模型实例对象。</p>
<h4 data-id="heading-7">关键方法</h4>
<p><code>get_format_instructions()</code>：获取 Pydantic 模型对应的格式化指令，用于传递给提示模板，引导大模型按格式输出。</p>
<h4 data-id="heading-8">完整使用示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> PydanticOutputParser
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-comment"># 大模型初始化</span>
llm = ChatOpenAI(
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    api_key=<span class="hljs-string">"[你的API Key]"</span>
)

<span class="hljs-comment"># 定义Pydantic数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SumArgs</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    num1: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"第一个数"</span>)
    num2: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"第二个数"</span>)
    <span class="hljs-built_in">sum</span>: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"两个数的和"</span>)

<span class="hljs-comment"># 初始化Pydantic输出解析器</span>
pydantic_output_parser = PydanticOutputParser(pydantic_object=SumArgs)

<span class="hljs-comment"># 定义提示模板</span>
prompt_template = PromptTemplate.from_template(
    <span class="hljs-string">"""
    你是一个专业的数学助手
    问题内容：{question}
    输出格式：{format_instructions}
    """</span>
)

<span class="hljs-comment"># 预填充格式化指令</span>
prompt_template = prompt_template.partial(
    format_instructions=pydantic_output_parser.get_format_instructions()
)

<span class="hljs-comment"># 构建链式调用</span>
chain = prompt_template | llm | pydantic_output_parser

<span class="hljs-comment"># 执行调用</span>
response = chain.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"question"</span>: <span class="hljs-string">"计算10和20的和"</span>})

<span class="hljs-comment"># 打印解析后结果（Pydantic实例对象）</span>
<span class="hljs-built_in">print</span>(response)
</code></pre>
<h3 data-id="heading-9">3. JsonOutputParser（JSON格式解析器）</h3>
<h4 data-id="heading-10">核心作用</h4>
<p>将大模型输出解析为标准 JSON 格式，使用方式与 <code>PydanticOutputParser</code> 类似，核心区别在于解析后的输出格式为 JSON 字符串/对象。</p>
<h4 data-id="heading-11">关键方法</h4>
<p><code>get_format_instructions()</code>：获取 JSON 格式的标准化指令，返回字符串类型，用于引导大模型输出合规 JSON 内容。</p>
<h5 data-id="heading-12">完整使用示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> JsonOutputParser
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-comment"># 定义Pydantic数据模型（约束JSON字段）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SumArgs</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    num1: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"第一个数"</span>)
    num2: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"第二个数"</span>)
    <span class="hljs-built_in">sum</span>: <span class="hljs-built_in">int</span> = Field(description=<span class="hljs-string">"两个数的和"</span>)

<span class="hljs-comment"># 初始化JSON输出解析器</span>
json_output_parser = JsonOutputParser(pydantic_object=SumArgs)

<span class="hljs-comment"># 定义提示模板</span>
prompt_template = PromptTemplate.from_template(
    <span class="hljs-string">"""
    你是一个专业的数学助手
    问题内容：{question}
    输出格式：{format_instructions}
    """</span>
)

<span class="hljs-comment"># 预填充格式化指令</span>
prompt_template = prompt_template.partial(
    format_instructions=json_output_parser.get_format_instructions()
)

<span class="hljs-comment"># 构建链式调用</span>
chain = prompt_template | llm | json_output_parser

<span class="hljs-comment"># 执行调用</span>
response = chain.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"question"</span>: <span class="hljs-string">"计算10和20的和"</span>})

<span class="hljs-comment"># 打印解析后结果</span>
<span class="hljs-built_in">print</span>(response)
</code></pre>
<h2 data-id="heading-13">核心关键要点</h2>
<ol>
<li>
<p><strong>通用流程</strong>：所有输出解析器的核心使用流程一致：定义提示模板 → 初始化解析器 → 预填充格式化指令 → 构建链式调用 → 执行并解析结果；</p>
</li>
<li>
<p><strong>格式化指令</strong>：<code>get_format_instructions()</code> 是核心方法，用于引导大模型按预期格式输出，缺失会导致解析失败；</p>
</li>
<li>
<p><strong>返回类型差异</strong>：</p>
<ul>
<li><code>StrOutputParser</code>：返回纯字符串；</li>
<li><code>PydanticOutputParser</code>：返回 Pydantic 实例对象；</li>
<li><code>JsonOutputParser</code>：返回标准 JSON 格式；</li>
</ul>
</li>
<li>
<p><strong>错误处理</strong>：若大模型输出不符合解析器要求，会直接抛出解析错误，需优化提示模板或模型参数。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent 记忆系统技术深度：从上下文工程到长期记忆组件集成！]]></title>    <link>https://juejin.cn/post/7589126217249833001</link>    <guid>https://juejin.cn/post/7589126217249833001</guid>    <pubDate>2025-12-29T09:21:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126217249833001" data-draft-id="7589126217249456169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent 记忆系统技术深度：从上下文工程到长期记忆组件集成！"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-29T09:21:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent 记忆系统技术深度：从上下文工程到长期记忆组件集成！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T09:21:07.000Z" title="Mon Dec 29 2025 09:21:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：柳遵飞（翼严）</p>
<h2 data-id="heading-0">前言</h2>
<p>随着 AI Agent 应用的快速发展，智能体需要处理越来越复杂的任务和更长的对话历史。然而，LLM 的上下文窗口限制、不断增长的 token 成本，以及如何让 AI“记住”用户偏好和历史交互，都成为了构建实用 AI Agent 系统面临的核心挑战。记忆系统（Memory System）正是为了解决这些问题而诞生的关键技术。</p>
<p>记忆系统使 AI Agent 能够像人类一样，在单次对话中保持上下文连贯性（短期记忆），同时能够跨会话记住用户偏好、历史交互和领域知识（长期记忆）。这不仅提升了用户体验的连续性和个性化程度，也为构建更智能、更实用的 AI 应用奠定了基础。</p>
<h2 data-id="heading-1">Memory 基础概念</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9b9252177814144b867871c1e45a423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=VyLjca2%2BXFFttr7KpUIXWbggdWY%3D" alt="image_1766567507046.png" loading="lazy"/></p>
<h3 data-id="heading-2">1.1 记忆的定义与分类</h3>
<p>对于 AI Agent 而言，记忆至关重要，因为它使它们能够记住之前的互动、从反馈中学习，并适应用户的偏好。</p>
<p>对“记忆”的定义有两个层面：</p>
<ul>
<li><strong>会话级记忆：</strong> 用户和智能体 Agent 在一个会话中的多轮交互（user-query &amp; response）</li>
<li><strong>跨会话记忆：</strong> 从用户和智能体 Agent 的多个会话中抽取的通用信息，可以跨会话辅助 Agent 推理</li>
</ul>
<h3 data-id="heading-3">1.2 各 Agent 框架的定义差异</h3>
<p>各个 Agent 框架对记忆的概念命名各有不同，但共同的是都遵循上一节中介绍的两个不同层面的划分：会话级和跨会话级。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3844bf82fd444909f707b0419ef8ccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=DMqCHXEloIQ%2B%2BsnVmq8nBCNcq1U%3D" alt="图片" loading="lazy"/></p>
<p><strong>框架说明：</strong></p>
<ul>
<li><strong>Google ADK：</strong> Session 表示单次持续交互；Memory 是长期知识库，可包含来自多次对话的信息</li>
<li><strong>LangChain：</strong> Short-term memory 用于单线程或对话中记住之前的交互；Long-term memory 不属于基础核心组件，而是高阶的“个人知识库”外挂</li>
<li><strong>AgentScope：</strong> 虽然官方文档强调需求驱动，但 API 层面仍然是两个组件（memory 和 long_term_memory），功能层面有明确区分</li>
</ul>
<p>习惯上，可以将会话级别的历史消息称为<strong>短期记忆</strong>，把可以跨会话共享的信息称为<strong>长期记忆</strong>，但本质上两者并不是通过简单的时间维度进行的划分，从实践层面上以是否跨 Session 会话来进行区分。长期记忆的信息从短期记忆中抽取提炼而来，根据短期记忆中的信息实时地更新迭代，而其信息又会参与到短期记忆中辅助模型进行个性化推理。</p>
<h2 data-id="heading-4">Agent 框架集成记忆系统的架构</h2>
<p>各 Agent 框架在集成记忆系统时，虽然实现细节不同，但都遵循相似的架构模式。理解这些通用模式有助于更好地设计和实现记忆系统。</p>
<h3 data-id="heading-5">2.1 Agent 框架集成记忆的通用模式</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/447f848e7d644d85bb307fa067e2e2e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=QW5%2B2TuZBEVHmAvVTr6h7wKAgPs%3D" alt="image_1766569316557.png" loading="lazy"/></p>
<p>各 Agent 框架集成记忆系统通常遵循以下通用模式：</p>
<p><strong>1. Step1：推理前加载</strong> - 根据当前 user-query 从长期记忆中加载相关信息</p>
<p><strong>2. Step2：上下文注入</strong> - 从长期记忆中检索的信息加入当前短期记忆中辅助模型推理</p>
<p><strong>3. Step3：记忆更新</strong> - 短期记忆在推理完成后加入到长期记忆中</p>
<p><strong>4. Step4：信息处理</strong> - 长期记忆模块中结合 LLM+向量化模型进行信息提取和检索</p>
<h3 data-id="heading-6">2.2 短期记忆（Session 会话）</h3>
<p>短期记忆存储会话中产生的各类消息，包括用户输入、模型回复、工具调用及其结果等。这些消息直接参与模型推理，实时更新，并受模型的 maxToken 限制。当消息累积导致上下文窗口超出限制时，需要通过上下文工程策略（压缩、卸载、摘要等）进行处理，这也是上下文工程主要处理的部分。</p>
<p><strong>核心特点：</strong></p>
<ul>
<li>存储会话中的所有交互消息（用户输入、模型回复、工具调用等）</li>
<li>直接参与模型推理，作为 LLM 的输入上下文</li>
<li>实时更新，每次交互都会新增消息</li>
<li>受模型 maxToken 限制，需要上下文工程策略进行优化</li>
</ul>
<p>关于短期记忆的上下文工程策略（压缩、卸载、摘要等），将在下一章节中详细介绍。</p>
<h3 data-id="heading-7">2.3 长期记忆（跨会话）</h3>
<p>长期记忆与短期记忆形成双向交互：一方面，长期记忆从短期记忆中提取“事实”、“偏好”、“经验”等有效信息进行存储（Record）；另一方面，长期记忆中的信息会被检索并注入到短期记忆中，辅助模型进行个性化推理（Retrieve）。</p>
<p><strong>与短期记忆的交互：</strong></p>
<ul>
<li><strong>Record（写入）：</strong> 从短期记忆的会话消息中提取有效信息，通过LLM进行语义理解和抽取，存储到长期记忆中</li>
<li><strong>Retrieve（检索）：</strong> 根据当前用户查询，从长期记忆中检索相关信息，注入到短期记忆中作为上下文，辅助模型推理</li>
</ul>
<p><strong>实践中的实现方式：</strong></p>
<p>在 Agent 开发实践中，长期记忆通常是一个独立的第三方组件，因为其内部有相对比较复杂的流程（信息提取、向量化、存储、检索等）。常见的长期记忆组件包括 Mem0、Zep、Memos、ReMe 等，这些组件提供了完整的 Record 和 Retrieve 能力，Agent 框架通过 API 集成这些组件。</p>
<p><strong>信息组织维度：</strong></p>
<p>不同长期记忆产品在信息组织维度上有所差异：一些产品主要关注个人信息（个人记忆），而一些产品除了支持个人记忆外，还支持工具记忆、任务记忆等更丰富的维度。</p>
<ol>
<li>
<p><strong>用户维度（个人记忆）：</strong> 面向用户维度组织的实时更新的个人知识库</p>
<ul>
<li>用户画像分析报告</li>
<li>个性化推荐系统，千人千面</li>
<li>处理具体任务时加载至短期记忆中</li>
</ul>
</li>
<li>
<p><strong>业务领域维度：</strong> 沉淀的经验（包括领域经验和工具使用经验）</p>
<ul>
<li>可沉淀至领域知识库</li>
<li>可通过强化学习微调沉淀至模型</li>
</ul>
</li>
</ol>
<h2 data-id="heading-8">短期记忆的上下文工程策略</h2>
<p>短期记忆直接参与 Agent 和 LLM 的交互，随着对话历史增长，上下文窗口会面临 token 限制和成本压力。上下文工程策略旨在通过智能化的压缩、卸载和摘要技术，在保持信息完整性的同时，有效控制上下文大小。</p>
<p><strong>备注：</strong> 需要说明的是，各方对上下文工程的概念和理解存在些许差异。<strong>狭义的上下文工程</strong>特指对短期记忆（会话历史）中各种压缩、摘要、卸载等处理机制，主要解决上下文窗口限制和 token 成本问题；<strong>广义的上下文工程</strong>则包括更广泛的上下文优化策略，如非运行态的模型选择、Prompt 优化工程、知识库构建、工具集构建等，这些都是在模型推理前对上下文进行优化的手段，且这些因素都对模型推理结果有重要影响。本章节主要讨论狭义的上下文工程，即针对短期记忆的运行时处理策略。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24e5d661c30a4aa1b54d4994cab1befd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=LQl99B9L13t11r8RU5SIs1hQn3c%3D" alt="image_1766570688185.png" loading="lazy"/></p>
<h3 data-id="heading-9">3.1 核心策略</h3>
<p>针对短期记忆的上下文处理，主要有以下几种策略：</p>
<h4 data-id="heading-10">上下文缩减（Context Reduction）</h4>
<p>上下文缩减通过减少上下文中的信息量来降低 token 消耗，主要有两种方法：</p>
<p><strong>1. 保留预览内容：</strong> 对于大块内容，只保留前 N 个字符或关键片段作为预览，原始完整内容被移除</p>
<p><strong>2. 总结摘要：</strong> 使用 LLM 对整段内容进行总结摘要，保留关键信息，丢弃细节</p>
<p>这两种方法都会导致信息丢失，但能有效减少 token 消耗。</p>
<h4 data-id="heading-11">上下文卸载（Context Offloading）</h4>
<p>上下文卸载主要解决被缩减的内容是否可恢复的问题。当内容被缩减后，原始完整内容被卸载到外部存储（如文件系统、数据库等），消息中只保留最小必要的引用（如文件路径、UUID 等）。当需要完整内容时，可以通过引用重新加载。</p>
<p><strong>优势</strong>：上下文更干净，占用更小，信息不丢，随取随用。适用于网页搜索结果、超长工具输出、临时计划等占 token 较多的内容。</p>
<h4 data-id="heading-12">上下文隔离（Context Isolation）</h4>
<p>通过多智能体架构，将上下文拆分到不同的子智能体中（类似单体拆分称多个微服务）。主智能体编写任务指令，发送给子智能体，子智能体的整个上下文仅由该指令组成。子智能体完成任务后返回结果，主智能体不关心子智能体如何执行，只需要结果。</p>
<p><strong>适用场景</strong>：任务有清晰简短的指令，只有最终输出才重要，如代码库中搜索特定片段。</p>
<p><strong>优势</strong>：上下文小、开销低、简单直接。</p>
<p><strong>策略选择原则：</strong></p>
<p>以上三种策略（上下文缩减、上下文卸载、上下文隔离）需要根据数据的分类进行综合处理，主要考虑因素包括：</p>
<ul>
<li><strong>时间远近：</strong> 近期消息通常更重要，需要优先保留；历史消息可以优先进行缩减或卸载</li>
<li><strong>数据类型：</strong> 不同类型的消息（用户输入、模型回复、工具调用结果等）重要性不同，需要采用不同的处理策略</li>
<li><strong>信息可恢复性：</strong> 对于需要完整信息的内容，应优先使用卸载策略；对于可以接受信息丢失的内容，可以使用缩减策略</li>
</ul>
<h3 data-id="heading-13">3.2 各框架的实现方式</h3>
<p>各框架一般内置上下文处理策略，通过参数化配置的方式指定具体策略。</p>
<p><strong>Google ADK</strong></p>
<p>构建 Agent 时通过 <code>events_compaction_config</code> 设置上下文处理策略，和 Session 本身的数据存储独立。</p>
<pre><code class="hljs language-ini" lang="ini">from google.adk.apps.app import App, EventsCompactionConfig
<span class="hljs-attr">app</span> = App(
    <span class="hljs-attr">name</span>=<span class="hljs-string">'my-agent'</span>,
    <span class="hljs-attr">root_agent</span>=root_agent,
    <span class="hljs-attr">events_compaction_config</span>=EventsCompactionConfig(
        <span class="hljs-attr">compaction_interval</span>=<span class="hljs-number">3</span>,  <span class="hljs-comment"># 每3次新调用触发压缩</span>
        <span class="hljs-attr">overlap_size</span>=<span class="hljs-number">1</span>          <span class="hljs-comment"># 包含前一个窗口的最后一次调用</span>
    ),
)
</code></pre>
<p><strong>LangChain</strong></p>
<p>构建 Agent 时通过 middleware 机制中的 <code>SummarizationMiddleware</code> 设置上下文处理参数，与短期记忆本身的数据存储独立。</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.agents import create_agent
from langchain.agents.middleware import SummarizationMiddleware
<span class="hljs-attr">agent</span> = create_agent(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"gpt-4o"</span>,
    <span class="hljs-attr">tools</span>=[...],
    <span class="hljs-attr">middleware</span>=[
        SummarizationMiddleware(
            model=<span class="hljs-string">"gpt-4o-mini"</span>,
            max_tokens_before_summary=<span class="hljs-number">4000</span>,  <span class="hljs-comment"># 4000 tokens时触发摘要</span>
            messages_to_keep=<span class="hljs-number">20</span>,  <span class="hljs-comment"># 摘要后保留最后20条消息</span>
        ),
    ],
)
</code></pre>
<p><strong>AgentScope</strong></p>
<p>AgentScope 通过 <strong>AutoContextMemory</strong> 提供智能化的上下文工程解决方案。AutoContextMemory 实现了 <code>Memory</code> 接口，当对话历史超过配置阈值时，自动应用 6 种渐进式压缩策略（从轻量级到重量级）来减少上下文大小，同时保留重要信息。</p>
<p><strong>集成方式：</strong></p>
<ul>
<li>直接作为 <code>Memory</code> 接口实现，通过 <code>memory</code> 参数集成到 Agent 中</li>
<li>与框架深度集成，无需额外的 middleware 或独立配置</li>
</ul>
<p><strong>与 ADK 和 LangChain 的差异：</strong></p>
<ul>
<li><strong>更精细化的压缩策略：</strong> 提供 6 种渐进式压缩策略（压缩历史工具调用、卸载大型消息、摘要对话轮次等），相比 ADK 的简单压缩和 LangChain 的摘要 middleware，策略更加细化和可控</li>
<li><strong>集成方式：</strong> 直接实现 Memory 接口，与 Agent 构建流程无缝集成，而 ADK 和 LangChain 需要独立的配置对象或 middleware 机制</li>
<li><strong>完整可追溯性：</strong> 提供工作内存、原始内存、卸载上下文和压缩事件四层存储架构，支持完整历史追溯，而其他框架通常只提供压缩后的结果</li>
</ul>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-scss" lang="scss">AutoContextMemory memory = new <span class="hljs-built_in">AutoContextMemory</span>(
    AutoContextConfig.builder()
        <span class="hljs-selector-class">.msgThreshold</span>(<span class="hljs-number">100</span>)
        <span class="hljs-selector-class">.maxToken</span>(<span class="hljs-number">128</span> * <span class="hljs-number">1024</span>)
        <span class="hljs-selector-class">.tokenRatio</span>(<span class="hljs-number">0.75</span>)
        <span class="hljs-selector-class">.build</span>(),
    model
);
ReActAgent agent = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("Assistant")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.memory</span>(memory)
    <span class="hljs-selector-class">.build</span>();
</code></pre>
<p><strong>详细文档：</strong> 关于 AutoContextMemory 的 6 种压缩策略、存储架构和高级配置，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzIzOTU0NTQ0MA%3D%3D%26mid%3D2247556750%26idx%3D1%26sn%3D65b82a8da8595494dd6e1adbe605e649%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzIzOTU0NTQ0MA==&amp;mid=2247556750&amp;idx=1&amp;sn=65b82a8da8595494dd6e1adbe605e649&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AutoContextMemory 详细文档</a>。</p>
<h2 data-id="heading-14">长期记忆技术架构及 Agent 框架集成</h2>
<p>与短期记忆不同，长期记忆需要跨会话持久化存储，并支持高效的检索和更新。这需要一套完整的技术架构，包括信息提取、向量化存储、语义检索等核心组件。</p>
<h3 data-id="heading-15">4.1 核心组件</h3>
<p>长期记忆涉及 record &amp; retrieve 两个核心流程，需要以下核心组件：</p>
<p><strong>1. LLM 大模型：</strong> 提取短期记忆中的有效信息（记忆的语义理解、抽取、决策和生成）</p>
<p><strong>2. Embedder 向量化：</strong> 将文本转换为语义向量，支持相似性计算</p>
<p><strong>3. VectorStore 向量数据库：</strong> 持久化存储记忆向量和元数据，支持高效语义检索</p>
<p><strong>4. GraphStore 图数据库：</strong> 存储实体-关系知识图谱，支持复杂关系推理</p>
<p><strong>5. Reranker（重排序器）：</strong> 对初步检索结果按语义相关性重新排序</p>
<p><strong>6. SQLite：</strong> 记录所有记忆操作的审计日志，支持版本回溯</p>
<h3 data-id="heading-16">4.2 Record &amp; Retrieve 流程</h3>
<p>Record（记录）</p>
<pre><code class="hljs">LLM 事实提取 → 信息向量化 → 向量存储 →（复杂关系存储）→ SQLite 操作日志
</code></pre>
<p>Retrieve（检索）</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">User</span> query 向量化 → 向量数据库语义检索 → 图数据库关系补充 →（Reranker<span class="hljs-operator">-</span>LLM）→ 结果返回
</code></pre>
<h3 data-id="heading-17">4.3 长期记忆与 RAG 的区别</h3>
<p>像 Mem0 这类面向 AI Agent 的个性化长期记忆系统，与 RAG（Retrieval-Augmented Generation）在技术架构上有诸多相似之处，但功能层面和场景上有明显区别：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50c50041f1bf4d5f9072d7d0aaf36d30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=D9%2BuaCSddMuXVnZQsT4PO0DVcUY%3D" alt="图片" loading="lazy"/></p>
<p><strong>技术层面的相似点：</strong></p>
<ol>
<li>
<p>向量化存储：都将文本内容通过 Embedding 模型转为向量，存入向量数据库</p>
</li>
<li>
<p>相似性检索：在用户提问时，将当前 query 向量化，在向量库中检索 top-k 最相关的条目</p>
</li>
<li>
<p>注入上下文生成：将检索到的内容注入到模型交互上下文中，辅助 LLM 生成最终回答</p>
</li>
</ol>
<h3 data-id="heading-18">4.4 关键问题与挑战</h3>
<p>长期记忆系统在实际应用中面临诸多挑战，这些挑战直接影响系统的可用性和用户体验。</p>
<p><strong>1. 准确性</strong></p>
<p>记忆的准确性包含两个层面：</p>
<ul>
<li>有效的记忆管理：需要具备智能的巩固、更新和遗忘机制，这主要依赖于记忆系统中负责信息提取的模型能力和算法设计</li>
<li>记忆相关性的检索准确度：主要依赖于向量化检索&amp;重排的核心能力</li>
</ul>
<p><strong>核心挑战：</strong></p>
<ul>
<li>记忆的建模：需要完善强大的用户画像模型</li>
<li>记忆的管理：基于用户画像建模算法，提取有效信息，设计记忆更新机制</li>
<li>向量化相关性检索能力：提升检索准确率和相关性</li>
</ul>
<p><strong>2. 安全和隐私</strong></p>
<p>记忆系统记住了大量用户隐私信息，如何防止数据中毒等恶意攻击，并保障用户隐私，是必须解决的问题。</p>
<p><strong>核心挑战：</strong></p>
<ul>
<li>数据加密与访问控制</li>
<li>防止恶意数据注入</li>
<li>透明的数据管理机制</li>
<li>用户对自身数据的掌控权</li>
</ul>
<p><strong>3. 多模态记忆支持</strong></p>
<p>文本记忆、视觉、语音仍被孤立处理，如何构建统一的“多模态记忆空间”仍是未解难题。</p>
<p><strong>核心挑战：</strong></p>
<ul>
<li>跨模态关联与检索</li>
<li>统一的多模态记忆表示</li>
<li>毫秒级响应能力</li>
</ul>
<h3 data-id="heading-19">4.5 Agent 框架集成</h3>
<p>在 AgentScope 中，可以通过集成第三方长期记忆组件来实现长期记忆功能。常见的集成方式包括：</p>
<h4 data-id="heading-20">4.5.1 集成 Mem0</h4>
<p>Mem0 是一个开源的长期记忆框架，几乎成为事实标准。在 AgentScope 中集成 Mem0 的示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 初始化Mem0长期记忆</span>
Mem0LongTermMemory mem0Memory = new <span class="hljs-built_in">Mem0LongTermMemory</span>(
    Mem0Config.builder()
        <span class="hljs-selector-class">.apiKey</span>("your-mem0-api-key")
        <span class="hljs-selector-class">.build</span>()
);
<span class="hljs-comment">// 创建Agent并集成长期记忆</span>
ReActAgent agent = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("Assistant")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.memory</span>(memory)  <span class="hljs-comment">// 短期记忆</span>
    <span class="hljs-selector-class">.longTermMemory</span>(mem0Memory)  <span class="hljs-comment">// 长期记忆</span>
    <span class="hljs-selector-class">.build</span>();
</code></pre>
<h4 data-id="heading-21">4.5.2 集成 ReMe</h4>
<p>ReMe 是 AgentScope 官方提供的长期记忆实现，与框架深度集成：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 初始化ReMe长期记忆</span>
ReMeLongTermMemory remeMemory = ReMeLongTermMemory<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.userId</span>("user123")  <span class="hljs-comment">// 用户ID，用于记忆隔离</span>
    <span class="hljs-selector-class">.apiBaseUrl</span>("http://localhost:<span class="hljs-number">8002</span>")  <span class="hljs-comment">// ReMe服务地址</span>
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 创建Agent并集成长期记忆</span>
ReActAgent agent = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("Assistant")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.memory</span>(memory)  <span class="hljs-comment">// 短期记忆</span>
    <span class="hljs-selector-class">.longTermMemory</span>(remeMemory)  <span class="hljs-comment">// 长期记忆</span>
    <span class="hljs-selector-class">.longTermMemoryMode</span>(LongTermMemoryMode.BOTH)  <span class="hljs-comment">// 记忆模式</span>
    <span class="hljs-selector-class">.build</span>();
</code></pre>
<h2 data-id="heading-22">行业趋势与产品对比</h2>
<h3 data-id="heading-23">5.1 AI 记忆系统发展趋势</h3>
<p>AI 记忆系统的核心目标是让 AI 能像人类一样持续学习、形成长期记忆，从而变得更智能、更个性化。当前行业呈现出从研究原型向生产级系统演进、从单一技术向综合解决方案发展的趋势。</p>
<h4 data-id="heading-24">5.1.1 当前发展的核心脉络</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05da7e83795847dd9b366cc99f23ba03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=w0VavWRlmzW6QzoQnOGwzLTYwh8%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-25">5.1.2 技术发展趋势</h4>
<p><strong>记忆即服务（Memory-as-a-Service, MaaS）</strong></p>
<p>AI Agent 是大模型、记忆、任务规划以及工具使用的集合体，记忆管理将是 Agent 智能体的核心基础功能之一。类似“数据库”之于传统软件，记忆系统将成为 AI 应用的基础设施，提供标准化的记忆服务接口、可扩展的存储和检索能力。</p>
<p><strong>精细化记忆管理</strong></p>
<p>借鉴人脑记忆机制，构建分层动态的记忆架构，对记忆进行全生命周期管理。技术路径包括：LLM 驱动记忆提取 + 向量化存储 + 图数据库补充；向量化检索（海马体）+ LLM 提纯（大脑皮层）结合；通过强化学习提升记忆管理表现。</p>
<p><strong>多模态记忆系统</strong></p>
<p>多模态大模型的兴起推动记忆系统向多模态、跨模态方向发展，要求存储具备跨模态关联与毫秒级响应能力。</p>
<p><strong>参数化记忆（Model 层集成记忆）</strong></p>
<p>在 Transformer 架构中引入可学习的记忆单元 Memory Adapter，实现模型层面原生支持用户维度的记忆。优点是响应速度快，但面临“灾难性遗忘”和更新成本高的挑战。</p>
<h4 data-id="heading-26">5.1.3 当前主要的技术路径</h4>
<p><strong>1. 外部记忆增强（当前主流）：</strong> 使用向量数据库等外部存储来记忆历史信息，并在需要时通过检索相关信息注入当前对话。这种方式灵活高效，检索的准确性是关键。</p>
<p><strong>2. 参数化记忆（深度内化）：</strong> 直接将知识编码进模型的参数中。这可以通过模型微调、知识编辑等技术实现，优点是响应速度快，但面临“灾难性遗忘”和更新成本高的挑战。</p>
<h3 data-id="heading-27">5.2 相关开源产品对比</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3b42e7e65944c2aa15be84b24f1e9aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604866&amp;x-signature=Hq1NtS1kIYSzQ0IvlvZXb8yAWyI%3D" alt="图片" loading="lazy"/></p>
<p>关于各产品的具体数据指标对比，评测方式各有侧重，因此评测结果不尽相同，从实际情况看，各方均以 mem0 为评测基准，从各类技术指标评测结果以及开源社区的活跃度（star，issues 等）方面，mem0 仍然是占据长期记忆产品的领头地位。</p>
<h2 data-id="heading-28">结语</h2>
<p>记忆系统作为 AI Agent 的核心基础设施，其发展直接影响着智能体的能力和用户体验。现在各框架内置的压缩、卸载、摘要等策略，已经能解决 80-90% 的通用场景问题，但对于特定行业或场景，比如医疗、法律、金融等领域，基于通用的上下文处理策略基础之上进行针对性的处理和更精细的压缩 prompt 设计，仍然有较大的优化空间。而长期记忆作为可独立演进的组件，未来会更加贴近人脑的记忆演化模式，包括记忆的巩固、强化、遗忘等全生命周期管理，同时长期记忆应该以云服务模式提供通用的记忆服务，共同助力 Agent 迈向更高阶的智能。</p>
<p><strong>相关阅读：</strong></p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580979%26idx%3D1%26sn%3Db55ba91471d7bda26b70d7ef32b9144a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580979&amp;idx=1&amp;sn=b55ba91471d7bda26b70d7ef32b9144a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentScope Java 答疑时间：开发者近期最关心的 12 个问题</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580755%26idx%3D1%26sn%3D870d3de4e1a8e36796532cd18d8ab6e7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580755&amp;idx=1&amp;sn=870d3de4e1a8e36796532cd18d8ab6e7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentScope x RocketMQ：打造企业级高可靠 A2A 智能体通信基座</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580582%26idx%3D2%26sn%3De3e66277ddaedc5f7caa9cd1ae12cd5d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580582&amp;idx=2&amp;sn=e3e66277ddaedc5f7caa9cd1ae12cd5d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentScope Java v1.0 发布，让 Java 开发者轻松构建企业级 Agentic 应用</a>》</p>
<p><strong>参考文档：</strong></p>
<p>[1] FlowLLM Context Engineering</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFlowLLM-AI%2Fflowllm%2Ftree%2Fmain%2Fdocs%2Fzh%2Freading" target="_blank" title="https://github.com/FlowLLM-AI/flowllm/tree/main/docs/zh/reading" ref="nofollow noopener noreferrer">github.com/FlowLLM-AI/…</a></p>
<p>[2] Google ADK Memory</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgoogle.github.io%2Fadk-docs%2Fsessions%2Fmemory%2F" target="_blank" title="https://google.github.io/adk-docs/sessions/memory/" ref="nofollow noopener noreferrer">google.github.io/adk-docs/se…</a></p>
<p>[3] LangChain Memory</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Flong-term-memory" target="_blank" title="https://docs.langchain.com/oss/python/langchain/long-term-memory" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></p>
<p>[4] AgentScope Memory</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2Fzh_CN%2Ftutorial%2Ftask_memory.html" target="_blank" title="https://doc.agentscope.io/zh_CN/tutorial/task_memory.html" ref="nofollow noopener noreferrer">doc.agentscope.io/zh_CN/tutor…</a></p>
<p>[5] O-MEM</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.13593" target="_blank" title="https://arxiv.org/abs/2511.13593" ref="nofollow noopener noreferrer">arxiv.org/abs/2511.13…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十八章(静态导出SSG)]]></title>    <link>https://juejin.cn/post/7589052659435470894</link>    <guid>https://juejin.cn/post/7589052659435470894</guid>    <pubDate>2025-12-29T08:58:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589052659435470894" data-draft-id="7589093895326171145" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十八章(静态导出SSG)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-29T08:58:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十八章(静态导出SSG)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T08:58:36.000Z" title="Mon Dec 29 2025 08:58:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">静态导出SSG</h2>
<p>Next.js 支持静态站点生成（SSG，Static Site Generation），可以在构建时预先生成所有页面的静态 HTML 文件。这种方式特别适合内容相对固定的站点，如<strong>官网</strong>、<strong>博客</strong>、<strong>文档</strong>等，能够提供最佳的性能和 SEO 表现。</p>
<h4 data-id="heading-1">配置静态导出</h4>
<p>需要在<code>next.config.js</code>文件中配置<code>output</code>为<code>export</code>，表示导出静态站点。<code>distDir</code>表示导出目录，默认为<code>out</code>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">"export"</span>, <span class="hljs-comment">// 导出静态站点</span>
  <span class="hljs-attr">distDir</span>: <span class="hljs-string">"dist"</span>, <span class="hljs-comment">// 导出目录</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p>接着我们执行<code>npm run build</code>命令，构建静态站点。</p>
<p>构建完成之后，我们安装<code>http-server</code>来启动静态站点。</p>
<pre><code class="hljs language-bash" lang="bash">npm install http-server -g <span class="hljs-comment">#安装http-server</span>
<span class="hljs-built_in">cd</span> dist <span class="hljs-comment">#进入导出目录</span>
http-server -p 3000 <span class="hljs-comment">#启动静态站点</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b703b5726b84a37881b7c4754200f00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=D%2Bd4FxfMN12Y%2Fl%2FxoEC3hMRbPtE%3D" alt="11.gif" loading="lazy"/></p>
<p>启动完成之后发现点击<code>a</code>标签无法进行跳转，是因为打完包之后的页面叫<code>about.html</code>,而我们的跳转链接是<code>/about</code>，所以需要修改配置项。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8950c8f911f4dca8674bc8137f17885~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=HqCk7GEmWCJBnna0gyZfIipRMnU%3D" alt="build.png" loading="lazy"/></p>
<h4 data-id="heading-2">修改配置项</h4>
<p>需要在<code>next.config.js</code>文件中配置<code>trailingSlash</code>为<code>true</code>，表示添加尾部斜杠，生成<code>/about/index.html</code>而不是<code>/about.html</code>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">"export"</span>, <span class="hljs-comment">// 导出静态站点</span>
  <span class="hljs-attr">distDir</span>: <span class="hljs-string">"dist"</span>, <span class="hljs-comment">// 导出目录</span>
  <span class="hljs-attr">trailingSlash</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 添加尾部斜杠，生成 /about/index.html 而不是 /about.html</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/289cb3708804421b919d81bdee068f24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=ypCUPWf8v4tp5SHLmX%2FdjIep16E%3D" alt="trailingSlash.png" loading="lazy"/></p>
<p>此时重新点击<code>a</code>标签就可以进行跳转了。</p>
<h4 data-id="heading-3">动态路由处理</h4>
<p>新建目录: <code>src/app/posts/[id]/page.tsx</code></p>
<p>如果要使用动态路由，则需要使用<code>generateStaticParams</code>函数来生成有多少个动态路由，这个函数需要返回一个数组，数组中包含所有动态路由的参数，例如<code>{ id: '1' }</code>表示对应id为1的详情页。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateStaticParams</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//支持调用接口请求详情id列表 const res = await fetch('https://api.example.com/posts')</span>
    <span class="hljs-keyword">return</span> [
        { <span class="hljs-attr">id</span>: <span class="hljs-string">'1'</span> }, <span class="hljs-comment">//返回对应的详情id</span>
        { <span class="hljs-attr">id</span>: <span class="hljs-string">'2'</span> },
    ]
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Post</span>(<span class="hljs-params">{ params }: { params: <span class="hljs-built_in">Promise</span>&lt;{ id: <span class="hljs-built_in">string</span> }&gt; }</span>) {
    <span class="hljs-keyword">const</span> { id } = <span class="hljs-keyword">await</span> params
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Post {id}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h4 data-id="heading-4">图片优化</h4>
<p>如果使用<code>Image</code>组件优化图片，在开发模式会进行报错</p>
<div class="custom-block warning">
  <div class="custom-block-title">⚠️ 警告</div>
  <p>
    <code>get-img-props.ts 442 Uncaught Error</code>: Image Optimization using the default loader is not compatible with <code>{ output: 'export' }</code>.
  </p>
  <p>可能的解决方案：</p>
  <ul>
    <li>移除 <code>{ output: 'export' }</code> 并运行 "next start" 以启用包含图片优化 API 的服务器模式。</li>
    <li>在 <code>next.config.js</code> 中配置 <code>{ images: { unoptimized: true } }</code> 来禁用图片优化 API。</li>
    <li>使用自定义loader实现</li>
  </ul>
  <p>了解更多：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fmessages%2Fexport-image-api" target="_blank" title="https://nextjs.org/docs/messages/export-image-api" ref="nofollow noopener noreferrer">nextjs.org/docs/messag…</a></p>
</div>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">'@/public/1.png'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">About</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>  <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{test}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"logo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{250</span> * <span class="hljs-attr">3</span>} <span class="hljs-attr">height</span>=<span class="hljs-string">{131</span> * <span class="hljs-attr">3</span>} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>我们使用自定义<code>loader</code>来实现图片优化,要求我们通过一个图床托管图片。<a href="https://link.juejin.cn?target=https%3A%2F%2Fimgchr.com%2F" target="_blank" title="https://imgchr.com/" ref="nofollow noopener noreferrer">路过图床</a> 是一个免费的图床，我们可以使用它来托管图片。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b5602ac674646ee8203caae01041319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=X%2Fro3qp3jTDaoIWzgHnYuW1TJ%2FM%3D" alt="luguo.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5ce1f7ac5324f959c99e017af382244~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=ZKgkNO1TPJR3tqA5I%2FfqtZwOZ9k%3D" alt="url.png" loading="lazy"/></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">"export"</span>, <span class="hljs-comment">// 导出静态站点</span>
  <span class="hljs-attr">distDir</span>: <span class="hljs-string">"dist"</span>, <span class="hljs-comment">// 导出目录</span>
  <span class="hljs-attr">trailingSlash</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 添加尾部斜杠，生成 /about/index.html 而不是 /about.html</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">loader</span>: <span class="hljs-string">'custom'</span>, <span class="hljs-comment">// 自定义loader</span>
    <span class="hljs-attr">loaderFile</span>: <span class="hljs-string">'./image-loader.ts'</span>, <span class="hljs-comment">// 自定义loader文件</span>
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p>根目录：<code>/image-loader.ts</code></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">imageLoader</span>(<span class="hljs-params">{ src, width, quality }: { src: <span class="hljs-built_in">string</span>, width: <span class="hljs-built_in">number</span>, quality: <span class="hljs-built_in">number</span> }</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`https://s41.ax1x.com<span class="hljs-subst">${src}</span>`</span>
}
</code></pre>
<p>src/app/about/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">About</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'/2025/12/29/pZYbW7t.jpg'</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"logo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">{250</span> * <span class="hljs-attr">3</span>} <span class="hljs-attr">height</span>=<span class="hljs-string">{131</span> * <span class="hljs-attr">3</span>} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00fdd5d93b1b45d79ef3825c05b5a01d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767603516&amp;x-signature=isQ2iPfESEHqXjmhFJBkMpIRx64%3D" alt="img.png" loading="lazy"/></p>
<h4 data-id="heading-5">注意事项</h4>
<p>以下功能在SSG中不支持，请勿使用：</p>
<ul>
<li>Dynamic Routes with dynamicParams: true</li>
<li>动态路由没有使用generateStaticParams()</li>
<li>路由处理器依赖于Request</li>
<li>Cookies</li>
<li>Rewrites重写</li>
<li>Redirects重定向</li>
<li>Headers头</li>
<li>Proxy代理</li>
<li>Incremental Static Regeneration增量静态再生</li>
<li>Image Optimization with the default loader默认加载器的图像优化</li>
<li>Draft Mode草稿模式</li>
<li>Server Actions服务器操作</li>
<li>Intercepting Routes拦截路由</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Luckysheet 远程搜索下拉 控件开发 : 揭秘二开全流程]]></title>    <link>https://juejin.cn/post/7589126920286289930</link>    <guid>https://juejin.cn/post/7589126920286289930</guid>    <pubDate>2025-12-29T12:47:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589126920286289930" data-draft-id="7589093895327023113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Luckysheet  远程搜索下拉 控件开发 : 揭秘二开全流程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T12:47:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="朴shu"/> <meta itemprop="url" content="https://juejin.cn/user/3866303125264135"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Luckysheet  远程搜索下拉 控件开发 : 揭秘二开全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3866303125264135/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    朴shu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T12:47:46.000Z" title="Mon Dec 29 2025 12:47:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>远程搜索下拉控件是非常常见的控件，应用在表单填写场景下，也是非常合适的，本例将带领大家实现以下效果，并真实了解并熟悉 luckysheet 的二开流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa9e707052b4260aa2b992a2395a52d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py0c2h1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617266&amp;x-signature=Cjkf12XL8qDoAEnlzDnp11Lkez8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">拓展单元格属性</h2>
<p>在官网上，有一个常见问题，既然已知批注是直接加到单元格属性上，那么，我们拓展属性，是不是可以参考批注的实现方案？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22fd9b12c2c6470fb53fbfb6a0b8ffcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py0c2h1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617266&amp;x-signature=1YQxfHygfcHNaEUdhyY4ILqUvJE%3D" alt="在这里插入图片描述" loading="lazy"/>
我们设定以下是远程搜索下拉的单元格拓展属性：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 扩展后的单元格对象</span>
<span class="hljs-keyword">const</span> cell = {
    <span class="hljs-attr">v</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 原始值</span>
    <span class="hljs-attr">m</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 显示值</span>
    <span class="hljs-attr">ct</span>: { <span class="hljs-attr">fa</span>: <span class="hljs-string">"General"</span>, <span class="hljs-attr">t</span>: <span class="hljs-string">"s"</span> },
    <span class="hljs-comment">// ... other properties</span>

    <span class="hljs-comment">// 新增远程搜索下拉配置</span>
    <span class="hljs-attr">remoteSelect</span>: {
        <span class="hljs-comment">// 是否启用远程搜索，[必传]</span>
        <span class="hljs-attr">enable</span>: <span class="hljs-built_in">boolean</span>,

        <span class="hljs-comment">// 用户输入时的回调函数，用于获取远程数据</span>
        <span class="hljs-title function_">onInput</span>(value): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt; {
            <span class="hljs-comment">// 这个函数需要返回一个Promise对象，resolve一个数组，数组的元素为下拉选项对象</span>
        }

        <span class="hljs-comment">// 用户选定某个选项后的回调函数</span>
        <span class="hljs-title function_">onSelect</span>(item): <span class="hljs-built_in">void</span> {
            <span class="hljs-comment">// item 为用户选定的选项对象，值是onInput函数返回的数组中的某个元素</span>
        }

        <span class="hljs-comment">// 是否需要设定当前输入单元格的值 [可选]</span>
        <span class="hljs-title function_">setValue</span>(item): <span class="hljs-built_in">string</span>{
           <span class="hljs-comment">// item 为用户选定的选项对象，需要返回一个字符串，用于设定单元格的值</span>
        },

        <span class="hljs-comment">// 自定义类名  [可选]</span>
        <span class="hljs-attr">popperClass</span>: <span class="hljs-built_in">string</span>,
    },
};
</code></pre>
<h2 data-id="heading-2">何时触发？</h2>
<p>在这个场景中，我们需要<code>在用户输入值时，进行远程数据获取，渲染列表</code>，因此，需要在用户进行编辑时，进行处理：</p>
<ol>
<li>一个方案，是在初始化 inputHTML 时，将相关事件处理：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/755689351f904e30a11d579d9ff5a471~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py0c2h1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767617266&amp;x-signature=%2FKJ62ts%2BnUnkohBygCBG2drzPuQ%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ol>
<pre><code class="hljs language-js" lang="js"> $(<span class="hljs-string">"body"</span>).<span class="hljs-title function_">append</span>(inputHTML)
 <span class="hljs-comment">// 进行相关事件绑定: [伪代码]</span>
 $input.<span class="hljs-title function_">on</span>(<span class="hljs-string">'input'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
 	<span class="hljs-comment">// 这里是未知具体单元格信息的，需要通过外部传递</span>
 	<span class="hljs-keyword">const</span> remoteSelectOptions = <span class="hljs-title class_">Store</span>.<span class="hljs-property">flowdata</span>[r][c]
 	<span class="hljs-comment">// 执行后续操作</span>
 })
</code></pre>
<ol start="2">
<li>另一个方案，是用户双击时，唤起输入框后，进行判断：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// handler.js</span>
$(<span class="hljs-string">"#luckysheet-cell-main, #luckysheetTableContent"</span>).<span class="hljs-title function_">dblclick</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
	<span class="hljs-comment">// 这个函数是内置的哈，因此，可以直接获取到 r c</span>
	<span class="hljs-comment">// 判断当前单元格是否需要初始化远程搜索控件</span>
	<span class="hljs-title class_">RemoteSelect</span>.<span class="hljs-title function_">checkCellNeedRemoteSelect</span>(row_index, col_index)
})
</code></pre>
<p>两种方案我都试过了，<code>实现略有不同</code>，但都可以实现，还是借助原生的 dblclick 好处理些。</p>
<h2 data-id="heading-3">校验远程搜索下拉</h2>
<p>既然每一个单元格双击，都会触发这个校验，那么何时才需要初始化这个下拉框呢？</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 判断当前单元格是否需要显示下拉框</span>
<span class="hljs-attr">checkCellNeedRemoteSelect</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">r, c</span>) {
    <span class="hljs-comment">// 通过 r c 获取单元格信息</span>
    <span class="hljs-keyword">let</span> cell = <span class="hljs-title class_">Store</span>.<span class="hljs-property">flowdata</span>[r][c];

    <span class="hljs-comment">// 如果 cell 没有配置 remoteSelect 或者 remoteSelect.enable 为 false 则返回</span>
    <span class="hljs-keyword">if</span> (!cell || !cell.<span class="hljs-property">remoteSelect</span> || !cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">enable</span>) {
        <span class="hljs-keyword">return</span>;
    }
}
</code></pre>
<p>检验完成后，如果需要初始化校验，别忘了， 我们底层还要监听输入框事件哈：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不然，开始监听 input 输入事件</span>
$(<span class="hljs-string">"#luckysheet-input-box .luckysheet-cell-input"</span>).<span class="hljs-title function_">off</span>(<span class="hljs-string">"input"</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">"input"</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">let</span> value = $(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">text</span>().<span class="hljs-title function_">trim</span>(); <span class="hljs-comment">// 获取用户输入的值</span>
      
        <span class="hljs-keyword">if</span> (cell.<span class="hljs-property">remoteSelect</span> &amp;&amp; cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">onInput</span> &amp;&amp; <span class="hljs-keyword">typeof</span> cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">onInput</span> == <span class="hljs-string">"function"</span>) {
            <span class="hljs-comment">// 调用外部接口</span>
            cell.<span class="hljs-property">remoteSelect</span>
                .<span class="hljs-title function_">onInput</span>(value)
                .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">dataList</span>) {
                    $this.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
                    $this.<span class="hljs-title function_">showRemoteSelect</span>(dataList);
                })
                .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
                    $this.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
                    $this.<span class="hljs-title function_">hideRemoteSelect</span>();
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请求接口错误"</span>, error);
                    tooltip.<span class="hljs-title function_">info</span>(<span class="hljs-string">'&lt;i class="fa fa-exclamation-triangle"&gt;&lt;/i&gt;'</span>, <span class="hljs-string">"接口请求失败"</span>);
                });
        }
    });
</code></pre>
<h2 data-id="heading-4">初始化下拉框</h2>
<p>远程搜索的核心，就是下拉选项，当远程接口初始化完成后，执行如下：</p>
<pre><code class="hljs language-js" lang="js">dataList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
	<span class="hljs-keyword">const</span> $item = $(<span class="hljs-string">`&lt;div class="<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.selectItemClass}</span>"&gt;`</span>)
		.<span class="hljs-title function_">text</span>(item)
		.<span class="hljs-title function_">click</span>(<span class="hljs-function">() =&gt;</span> {
			<span class="hljs-comment">// 触发选择回调</span>
			<span class="hljs-keyword">if</span> (cell.<span class="hljs-property">remoteSelect</span> &amp;&amp; cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">onSelect</span> &amp;&amp; <span class="hljs-keyword">typeof</span> cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-property">onSelect</span> === <span class="hljs-string">"function"</span>) {
    		cell.<span class="hljs-property">remoteSelect</span>.<span class="hljs-title function_">onSelect</span>(item);
			}
		})
</code></pre>
<p>这里就一个难点要处理，如何将下拉框定位到输入框的位置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 这里采用巧方案，直接取输入框的位置</span>
<span class="hljs-keyword">const</span> $input = $(<span class="hljs-string">"#luckysheet-input-box"</span>);
<span class="hljs-keyword">const</span> left = <span class="hljs-built_in">parseInt</span>($input.<span class="hljs-title function_">css</span>(<span class="hljs-string">"left"</span>)) || <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> top = <span class="hljs-built_in">parseInt</span>($input.<span class="hljs-title function_">css</span>(<span class="hljs-string">"top"</span>)) || <span class="hljs-number">0</span>;

<span class="hljs-comment">// 获取当前单元格的高度 行高</span>
<span class="hljs-keyword">const</span> [_row_pre, rowHeight] = <span class="hljs-title function_">rowLocation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">r</span>);

<span class="hljs-comment">// 设置下拉框位置和宽度</span>
$selectBox.<span class="hljs-title function_">css</span>({
    <span class="hljs-attr">top</span>: <span class="hljs-string">`<span class="hljs-subst">${top + rowHeight + <span class="hljs-number">4</span>}</span>px`</span>, <span class="hljs-comment">// 在单元格下方显示</span>
    <span class="hljs-attr">left</span>: <span class="hljs-string">`<span class="hljs-subst">${left}</span>px`</span>,
});
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>虽然代码看起来不复杂，但是了解luckysheet 的源码、实现思路，以及单元格拓展实现方案是非常重要的。</p>
<p>通过本次实现，我们初步了解了luckysheet的二次开发流程，在不破坏原有功能的基础上添加新特性。远程搜索下拉控件的实现展示了如何在现有表格组件基础上，通过合理的架构设计和代码组织，添加复杂交互功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[避坑指南！别再被N8N循环节点“调戏”了！为什么你的Done分支执行了多次？]]></title>    <link>https://juejin.cn/post/7589074117644238883</link>    <guid>https://juejin.cn/post/7589074117644238883</guid>    <pubDate>2025-12-29T09:21:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589074117644238883" data-draft-id="7588996730773192704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 避坑指南！别再被N8N循环节点“调戏”了！为什么你的Done分支执行了多次？"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-29T09:21:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java中文社群"/> <meta itemprop="url" content="https://juejin.cn/user/61228381386487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             避坑指南！别再被N8N循环节点“调戏”了！为什么你的Done分支执行了多次？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61228381386487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java中文社群
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T09:21:09.000Z" title="Mon Dec 29 2025 09:21:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家在使用 n8n 的循环节点（Loop Over Items）时，有没有遇到过这种让人抓狂的情况：</p>
<p>明明官方文档说 <code>loop</code> 分支是循环执行，而 <code>done</code> 分支是在循环结束后只执行一次。结果你自己一上手：好家伙，<code>loop</code> 跑了 3 次，<code>done</code> 后面接的节点居然也跟着跑了 3 次！🤯 如下图所示：</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394b49df0671490eb6ef8e297a3c1b76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=HUcvPBGw8EaWlxuD4ePn1tP10JI%3D" alt="" loading="lazy"/></p>
<p><strong>难道是官方文档在忽悠人？还是咱用的版本不对？</strong></p>
<p>今天，磊哥就带大家扒一扒 n8n 基础节点里最难理解的——循环节点。全网没人能讲清的背后的逻辑，咱一次性说明白！</p>
<hr/>
<h2 data-id="heading-0">🎥 视频教程演示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1odBCB7E6p%2F" target="_blank" title="https://www.bilibili.com/video/BV1odBCB7E6p/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1od…</a></p>
<hr/>
<h2 data-id="heading-1">🔍 1. 现场还原：消失的“一次执行”</h2>
<p>咱们先看一个简单的案例。</p>
<p>在工作流里，我用代码节点（Code Node）输出了三项内容：张三、李四、王五。</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1cbf06433c546299fc165f627c42b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=GM2lJf4iXWsGHVBtx5JOgV%2Fx3jo%3D" alt="" loading="lazy"/></p>
<p>按逻辑，接下来的循环节点应该是这样的：</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a41fe085f1d4ef49da0bdd4d093278a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=yCdpvLtmcXZ9Bs79L95Wfzi8h7o%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>loop 分支</strong>：负责循环这三项，去执行具体的任务（比如写入文件）。</li>
<li><strong>done 分支</strong>：等这三项都处理完了，<strong>出来吱一声（执行一次）</strong>，收个尾。</li>
</ol>
<p>但在实际执行中，你会发现 <code>loop</code> 下面显示 “3 items”，<strong>而 <strong><code>**done**</code></strong> 下面也显示了 “3 items”</strong>。</p>
<p>如果你在 <code>done</code> 后面接个发邮件或者写文件的节点，它会整整运行 3 次！</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45c05518443a449eb7413ddb0299c1c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=i%2FBr78ZCPfAKmXK1uWyvORRwCXA%3D" alt="" loading="lazy"/></p>
<p>这到底是为什么？🤔</p>
<hr/>
<h2 data-id="heading-2">💡 2. 核心真相：是“结果”跑了多次，而不是“事件”跑了多次</h2>
<p>这里大家一定要记住一句话：在 n8n 里，后续节点执行几次，取决于前一个节点输出了多少个 Item（项目）。</p>
<p>这就是很多人理解不了循环节点的根本原因。</p>
<ul>
<li><strong>官方没骗你</strong>：<code>done</code> 分支确实只被触发了一次。</li>
<li><strong>真相是</strong>：<code>done</code> 事件在执行时，它会把之前 <code>loop</code> 循环完成的所有结果（那 3 条数据）封装在一起吐出来。</li>
</ul>
<p><strong>因为 <strong><code>done</code></strong> 分支输出了 3 个项目</strong>，n8n 的默认逻辑就是：“既然你有 3 条数据，<strong>那后面的节点我就并行的帮你跑 3 次吧！</strong>”</p>
<p>所以，<strong>你看到的“执行多次”，其实是 n8n 强大的并发特性导致的“假象”</strong>。</p>
<hr/>
<h2 data-id="heading-3">🛠️ 3. 终极绝招：如何让 Done 只乖乖执行一次？</h2>
<p>既然知道了原因，解决起来就非常简单了。</p>
<p>如果你希望循环结束后，后续节点不管前面有多少项数据，都只运行一次，你只需要：</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f077f997a32461eb4452659667c6b50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=iy5KdcSVp7WNaqfphOIaBthyzlA%3D" alt="" loading="lazy"/></p>
<ol>
<li>打开 <code>done</code> 分支后的那个节点设置。</li>
<li>点击 Settings 选项卡。</li>
<li>找到 Execute Once 选项，把它打开！✅</li>
</ol>
<p>开启这个开关后，无论前面传过来 3 条还是 3000 条数据，这个节点都只会执行一次。这才是符合我们预期的“循环结束”动作，最终执行效果如下：</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4bf74e4162d456b938d55428a054ad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604868&amp;x-signature=mFoQSq1s%2F4YV7TW3%2FE2N6qtbbss%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">最后总结 📝</h2>
<p>理解了 “Item 驱动执行” 这个逻辑，你才算真正踏入了 n8n 高级玩家的大门。</p>
<ul>
<li><strong>loop</strong>：过程分支，循环几次跑几次。</li>
<li><strong>done</strong>：结束分支，只触发一次，但会携带所有结果。</li>
<li><strong>Execute Once</strong>：拦截多余执行的“定海神针”。</li>
</ul>
<p>如果你觉得这篇干货有帮到你，记得点赞、在看！</p>
<p>我是磊哥，每天分享一个 n8n 实战干货，咱们下期见！👋</p>
<blockquote>
<p>本文已收录到我的技术小站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacn.site" target="_blank" title="https://www.javacn.site" ref="nofollow noopener noreferrer">www.javacn.site</a>，网站包含的内容有：<strong>LangChain/N8N/SpringAI/SpringAIAlibaba/LangChain4j/Dify/Coze/AI实战项目/AI常见面试题</strong>等技术分享，欢迎各位大佬光临指导~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南]]></title>    <link>https://juejin.cn/post/7588365276191883302</link>    <guid>https://juejin.cn/post/7588365276191883302</guid>    <pubDate>2025-12-29T01:52:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588365276191883302" data-draft-id="7588461466598441011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-12-29T01:52:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:52:18.000Z" title="Mon Dec 29 2025 01:52:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 差异</h2>
<h3 data-id="heading-1">flatMap</h3>
<ul>
<li><strong>行为</strong>：转换每个输入值到 Flow，并<strong>按顺序收集所有生成的 Flow</strong></li>
<li><strong>特点</strong>：新的输入不会取消之前正在进行的转换</li>
<li><strong>使用场景</strong>：需要处理所有事件，且事件间有依赖关系或需保持顺序</li>
</ul>
<h3 data-id="heading-2">flatMapLatest</h3>
<ul>
<li><strong>行为</strong>：当有新输入时，<strong>立即取消</strong>前一个转换的 Flow</li>
<li><strong>特点</strong>：只处理最新的输入，忽略中间结果</li>
<li><strong>使用场景</strong>：只需最新结果，可安全取消旧操作</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 对比示例</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateDifference</span><span class="hljs-params">()</span></span> {
    runBlocking {
        <span class="hljs-keyword">val</span> flow = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).onEach { delay(<span class="hljs-number">100</span>) }
        
        <span class="hljs-comment">// flatMap：处理所有值</span>
        flow.flatMap { value -&gt;
            flow {
                emit(<span class="hljs-string">"Processing <span class="hljs-variable">$value</span>"</span>)
                delay(<span class="hljs-number">200</span>) <span class="hljs-comment">// 模拟耗时操作</span>
                emit(<span class="hljs-string">"Completed <span class="hljs-variable">$value</span>"</span>)
            }
        }.collect { println(<span class="hljs-string">"flatMap: <span class="hljs-variable">$it</span>"</span>) }
        <span class="hljs-comment">// 输出所有 1,2,3 的处理结果</span>
        
        <span class="hljs-comment">// flatMapLatest：只处理最新的</span>
        flow.flatMapLatest { value -&gt;
            flow {
                emit(<span class="hljs-string">"Latest: <span class="hljs-variable">$value</span>"</span>)
                delay(<span class="hljs-number">200</span>)
                emit(<span class="hljs-string">"Done: <span class="hljs-variable">$value</span>"</span>) <span class="hljs-comment">// 可能被取消</span>
            }
        }.collect { println(<span class="hljs-string">"flatMapLatest: <span class="hljs-variable">$it</span>"</span>) }
        <span class="hljs-comment">// 只输出 3 的最新结果</span>
    }
}
</code></pre>
<h2 data-id="heading-3">2. 实战场景分析</h2>
<h3 data-id="heading-4">场景一：搜索自动补全</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> searchQuery = MutableStateFlow(<span class="hljs-string">""</span>)
    
    <span class="hljs-comment">// 使用 flatMapLatest：用户连续输入时取消之前的请求</span>
    <span class="hljs-keyword">val</span> searchResults = searchQuery
        .debounce(<span class="hljs-number">300</span>) <span class="hljs-comment">// 防抖</span>
        .filter { it.length &gt;= <span class="hljs-number">2</span> }
        .flatMapLatest { query -&gt;
            flow {
                emit(SearchState.Loading)
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> results = api.searchAutocomplete(query)
                    emit(SearchState.Success(results))
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    emit(SearchState.Error(e))
                }
            }
        }
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(), SearchState.Idle)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onQueryChanged</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        searchQuery.value = query
    }
}

<span class="hljs-comment">// 错误使用 flatMap 的情况：所有请求都会完成，可能导致结果显示错乱</span>
<span class="hljs-keyword">val</span> wrongResults = searchQuery
    .flatMap { query -&gt; <span class="hljs-comment">// 错误！应该用 flatMapLatest</span>
        api.searchAutocompleteFlow(query)
    }
</code></pre>
<h3 data-id="heading-5">场景二：位置更新</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocationTracker</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> locationUpdates = locationProvider.getUpdates()
    
    <span class="hljs-comment">// 使用 flatMap：每个位置都要上传，顺序重要</span>
    <span class="hljs-keyword">val</span> uploadStatus = locationUpdates
        .filter { it.accuracy &lt; <span class="hljs-number">50</span> } <span class="hljs-comment">// 只处理高精度位置</span>
        .conflate() <span class="hljs-comment">// 合并位置更新，避免过快</span>
        .flatMap { location -&gt;
            flow {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> response = uploadToServer(location)
                    emit(UploadResult.Success(location.id, response))
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    emit(UploadResult.Failure(location.id, e))
                }
            }
        }
        .<span class="hljs-keyword">catch</span> { e -&gt; emit(UploadResult.NetworkError(e)) }
    
    <span class="hljs-comment">// 使用 flatMapLatest：只关心最新位置的周边搜索</span>
    <span class="hljs-keyword">val</span> nearbyPlaces = locationUpdates
        .flatMapLatest { location -&gt;
            placesApi.getNearbyPlaces(location.lat, location.lng)
        }
}
</code></pre>
<h3 data-id="heading-6">场景三：文件上传队列</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUploadManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> uploadQueue = MutableSharedFlow&lt;FileData&gt;()
    
    <span class="hljs-comment">// 使用 flatMap + buffer：并发上传但限制并发数</span>
    <span class="hljs-keyword">val</span> uploadProgress = uploadQueue
        .flatMapMerge(concurrency = <span class="hljs-number">3</span>) { file -&gt; <span class="hljs-comment">// 限制3个并发</span>
            uploadFileFlow(file)
        }
        .shareIn(ioScope, SharingStarted.Lazily)
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">uploadFileFlow</span><span class="hljs-params">(file: <span class="hljs-type">FileData</span>)</span></span>: Flow&lt;UploadStatus&gt; = flow {
        emit(UploadStatus.Progress(file.id, <span class="hljs-number">0</span>))
        
        <span class="hljs-keyword">val</span> chunks = splitIntoChunks(file)
        chunks.forEachIndexed { index, chunk -&gt;
            api.uploadChunk(file.id, chunk)
            <span class="hljs-keyword">val</span> progress = ((index + <span class="hljs-number">1</span>) / chunks.size.toFloat() * <span class="hljs-number">100</span>).toInt()
            emit(UploadStatus.Progress(file.id, progress))
        }
        
        emit(UploadStatus.Completed(file.id))
    }
    
    <span class="hljs-comment">// 使用 flatMapLatest：用户取消上传时立即停止</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">uploadWithCancel</span><span class="hljs-params">()</span></span>: Flow&lt;UploadStatus&gt; {
        <span class="hljs-keyword">val</span> cancelSignal = MutableStateFlow(<span class="hljs-literal">false</span>)
        
        <span class="hljs-keyword">return</span> uploadQueue
            .flatMapLatest { file -&gt;
                <span class="hljs-keyword">if</span> (cancelSignal.value) {
                    emptyFlow()
                } <span class="hljs-keyword">else</span> {
                    uploadFileFlow(file)
                }
            }
    }
}
</code></pre>
<h2 data-id="heading-7">3. 常见陷阱与解决方案</h2>
<h3 data-id="heading-8">陷阱一：资源泄漏</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：flatMapLatest 取消时资源未清理</span>
flow.flatMapLatest { id -&gt;
    flow {
        <span class="hljs-keyword">val</span> connection = openDatabaseConnection() <span class="hljs-comment">// 可能泄漏！</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = connection.query(id)
            emit(<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">finally</span> {
            connection.close() <span class="hljs-comment">// 必须清理</span>
        }
    }
}

<span class="hljs-comment">// 正确：使用 cancellable 操作或清理资源</span>
flow.flatMapLatest { id -&gt;
    callbackFlow {
        <span class="hljs-keyword">val</span> connection = openDatabaseConnection()
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = connection.query(id)
            send(<span class="hljs-keyword">data</span>)
            awaitClose()
        } <span class="hljs-keyword">finally</span> {
            connection.close()
        }
    }
}
</code></pre>
<h3 data-id="heading-9">陷阱二：状态不一致</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：状态更新可能被取消，导致不一致</span>
<span class="hljs-keyword">var</span> currentState = State.IDLE

flow.flatMapLatest {
    currentState = State.LOADING <span class="hljs-comment">// 可能执行但后续被取消</span>
    apiCallFlow(it).onCompletion {
        currentState = State.IDLE <span class="hljs-comment">// 可能不会执行</span>
    }
}

<span class="hljs-comment">// 正确：使用状态流</span>
<span class="hljs-keyword">val</span> state = MutableStateFlow(State.IDLE)

flow.flatMapLatest {
    state.value = State.LOADING
    apiCallFlow(it)
        .<span class="hljs-keyword">catch</span> { e -&gt; 
            state.value = State.ERROR(e)
            emptyFlow() 
        }
        .onCompletion { 
            <span class="hljs-keyword">if</span> (it == <span class="hljs-literal">null</span>) state.value = State.IDLE 
        }
}
</code></pre>
<h3 data-id="heading-10">陷阱三：背压处理不当</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：没有处理背压，可能内存溢出</span>
highFrequencyFlow
    .flatMapLatest { <span class="hljs-comment">// 仍然可能快速发射</span>
        heavyOperationFlow(it)
    }

<span class="hljs-comment">// 正确：添加背压策略</span>
highFrequencyFlow
    .conflate() <span class="hljs-comment">// 合并中间值</span>
    .flatMapLatest {
        heavyOperationFlow(it)
    }

<span class="hljs-comment">// 或限制并发</span>
highFrequencyFlow
    .flatMapMerge(concurrency = <span class="hljs-number">1</span>) { <span class="hljs-comment">// 限制为顺序执行</span>
        heavyOperationFlow(it)
    }
</code></pre>
<h3 data-id="heading-11">陷阱四：异常处理缺失</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：异常会使整个流终止</span>
flow.flatMapLatest {
    flow { 
        <span class="hljs-keyword">if</span> (it.isEmpty()) <span class="hljs-keyword">throw</span> IllegalArgumentException()
        emit(process(it))
    }
}

<span class="hljs-comment">// 正确：妥善处理异常</span>
flow.flatMapLatest {
    flow {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (it.isEmpty()) <span class="hljs-keyword">throw</span> IllegalArgumentException()
            emit(Result.Success(process(it)))
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            emit(Result.Failure(e))
        }
    }
}
</code></pre>
<h2 data-id="heading-12">4. 性能优化技巧</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 合并操作减少开销</span>
searchQuery
    .debounce(<span class="hljs-number">300</span>)
    .distinctUntilChanged() <span class="hljs-comment">// 避免重复查询</span>
    .flatMapLatest { query -&gt;
        api.search(query)
            .retry(<span class="hljs-number">2</span>) <span class="hljs-comment">// 重试机制</span>
            .timeout(<span class="hljs-number">5000</span>) <span class="hljs-comment">// 超时</span>
    }

<span class="hljs-comment">// 2. 使用 shareIn 避免重复订阅</span>
<span class="hljs-keyword">val</span> sharedFlow = sourceFlow
    .flatMapLatest { expensiveOperation(it) }
    .shareIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
        replay = <span class="hljs-number">1</span>
    )

<span class="hljs-comment">// 3. 适当使用 buffer</span>
flow
    .buffer(Channel.UNLIMITED) <span class="hljs-comment">// 根据场景选择</span>
    .flatMapLatest { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h2 data-id="heading-13">5. 选择指南</h2>



































<table><thead><tr><th>场景特征</th><th>推荐操作符</th><th>理由</th></tr></thead><tbody><tr><td>需处理所有输入，顺序重要</td><td><code>flatMapConcat</code></td><td>保持顺序，无并发</td></tr><tr><td>需处理所有输入，顺序不重要</td><td><code>flatMapMerge</code></td><td>并发处理，提高效率</td></tr><tr><td>只需最新结果，可取消旧操作</td><td><code>flatMapLatest</code></td><td>避免无效计算</td></tr><tr><td>有限并发控制</td><td><code>flatMapMerge</code> with concurrency</td><td>控制资源使用</td></tr><tr><td>冷流转换</td><td><code>transform</code></td><td>更轻量级的转换</td></tr></tbody></table>
<h2 data-id="heading-14">总结</h2>
<ol>
<li><strong>flatMapLatest 适合响应式 UI 交互</strong>（搜索、点击防抖），可避免陈旧数据</li>
<li><strong>flatMapMerge 适合并行任务处理</strong>（批量上传、并发请求），提高吞吐量</li>
<li><strong>flatMapConcat 适合顺序敏感操作</strong>（文件分片上传、数据库事务）</li>
<li><strong>始终考虑资源清理</strong>，特别是在可取消的操作中</li>
<li><strong>合理处理背压</strong>，根据场景选择 buffer、conflate 等策略</li>
<li><strong>统一异常处理</strong>，避免流意外终止</li>
</ol>
<p>正确选择 flatMap 变体可以显著提升应用性能和用户体验，特别是在处理异步数据流时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当AI不再是“玩具”，我们是如何用Trace、Antigravity和Cursor“躺平”？]]></title>    <link>https://juejin.cn/post/7588934987510267931</link>    <guid>https://juejin.cn/post/7588934987510267931</guid>    <pubDate>2025-12-29T09:01:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588934987510267931" data-draft-id="7589093895326187529" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当AI不再是“玩具”，我们是如何用Trace、Antigravity和Cursor“躺平”？"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-29T09:01:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知识浅谈"/> <meta itemprop="url" content="https://juejin.cn/user/607378030207176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当AI不再是“玩具”，我们是如何用Trace、Antigravity和Cursor“躺平”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607378030207176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知识浅谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T09:01:04.000Z" title="Mon Dec 29 2025 09:01:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">从“哇塞”到“真香”的质变</h3>
<p>回想两年前，2023年那会，我们刚接触ChatGPT和Copilot的时候，每天都在惊呼：“卧槽，这玩意儿能写快排！”那时候的AI像个刚毕业的天才实习生，聪明但经常胡说八道。</p>
<p>一转眼到了2025年底。现在的感觉变了。AI不再是那个需要你哄着写Prompt的实习生，它更像是一个不知疲倦的<strong>Tech Lead</strong>。</p>
<p>今年是我彻底放弃“手写每一行代码”执念的一年。不是我懒，而是工具太强了。如果你现在还在用纯Vim或者没有任何插件的VS Code硬刚业务逻辑，说实话，你正在这辆飞速行驶的技术列车上表演“徒手扒火车”。</p>
<p>今天这篇长文，不讲虚头巴脑的概念，咱就聊聊这一年陪我熬夜、帮我背锅、让我早点下班的那些神级工具：<strong>Cursor, Antigravity, Kiro, Trace</strong> 等等。</p>
<hr/>
<h3 data-id="heading-1">Cursor：它已经不是编辑器了，它是我的外包团队</h3>
<p>如果说2024年的Cursor还是VS Code的魔改版，那2025年的Cursor简直就是<strong>IDE界的“钢铁侠战衣”</strong>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbf24466d8d24b1f99a9bba2c5a02d51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604059&amp;x-signature=dkyLfJ4BjCmj1E8CtNEHVa7swP0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-2">1. Composer 模式的完全体</h4>
<p>以前我们用AI，是一问一答：“帮我写个函数”。
现在的Cursor Composer（撰写者模式）是：“帮我把这个User模块重构一下，数据库字段加一个<code>last_login</code>，顺便把前端的Profile页面也改了，API文档也更新一下。”</p>
<p>它不再是盯着光标处的那一行代码，它有了<strong>全局视野</strong>。今年我在做那个SaaS项目时，最爽的一次体验是，我直接丢给它一张数据库ER图的截图，然后说：“按这个结构生成后端CRUD接口，用FastAPI。”</p>
<p>两分钟后，Model、Schema、Router全出来了。我只需要像个甲方一样指指点点：“这儿没做鉴权，那儿少个分页。”</p>
<h4 data-id="heading-3">2. Shadow Workspace（影子工作区）</h4>
<p>这是Cursor今年最大的杀手锏。以前改代码怕改挂了，得切个分支。现在Cursor在你打字的时候，已经在后台的“影子空间”里预运行了你的代码。</p>
<p>当你还在犹豫变量名起什么的时候，它已经在右下角提示你：“老兄，你这样写待会儿跑不通的，因为第50行的那个依赖包版本不兼容。” 这种<strong>预知未来</strong>的能力，真的救了我无数次生产环境的P0级事故。</p>
<hr/>
<h3 data-id="heading-4">Antigravity：Python开发者的上帝视角</h3>
<p>如果你是Python开发者，今年没用过 <strong>Antigravity</strong>，那你真的错过了太多。它的名字取自那个经典的XKCD漫画（Python能让你飞起来），但2025年的这个工具，是真的让你<strong>无视重力</strong>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b13c4b0eb6d846918b22a8e517c58e6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604059&amp;x-signature=TKKADtZtpoovPe4cVqDfZfhX2bg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-5">1. 也是IDE，但是是3D的？</h4>
<p>Antigravity 不再是冷冰冰的代码行。它引入了“可视化堆栈”的概念。以前调试代码，我们是打断点，一步步Next。在Antigravity里，代码的执行流被画成了一张动态的图。</p>
<p>你可以清晰地看到数据流怎么从API进来，经过了哪些中间件，在哪里被堵塞了。</p>
<h4 data-id="heading-6">2. 依赖地狱的终结者</h4>
<p>Python的包管理一直是噩梦。<code>pip</code>、<code>poetry</code>、<code>conda</code> 混在一起能要把人逼疯。Antigravity 内置了一个AI环境管家。</p>
<p>我有一次接手一个祖传的Django项目，依赖乱得像盘丝洞。我直接把项目拖进 Antigravity，点了一下“Fix Environment”。它自动扫描了所有import，分析了版本冲突，然后给我生成了一个完美的虚拟环境。它甚至悄悄把几个有安全漏洞的包给升级并适配了。</p>
<blockquote>
<p><strong>心得：</strong> Antigravity 让我感觉自己不是在写代码，而是在像修理钟表一样，精准地调整每一个齿轮的咬合。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">Kiro：终结了“查文档”时代的命令行</h3>
<p>记得以前要在终端里搞点复杂的运维操作，比如“查找所有大于100M的文件并按修改时间排序后删除”，我得去Google一下 <code>find</code> 命令的参数，或者去翻 <code>man</code> 手册。</p>
<p><strong>Kiro</strong> 的出现，把Terminal变成了聊天窗口。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b13be09024d4be8b36babedf34529a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604059&amp;x-signature=T8TF8dL1Xs14PZVKE%2BzHrUDRUA8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-8">1. 自然语言转Shell</h4>
<p>现在我的终端日常是这样的：</p>
<blockquote>
<p>我：<code>kiro 帮我把当前目录下所有的png图片压缩50%然后移动到 dist 文件夹</code>
Kiro: <code>Running: find . -name "*.png" -exec convert {} -quality 50% dist/{} \;</code> （自动执行）</p>
</blockquote>
<p>它不是简单的翻译，它懂上下文。如果你连续操作，它记得你上一步进了哪个目录，记得你刚才部署的是哪个服务。</p>
<h4 data-id="heading-9">2. 报错自动修</h4>
<p>最神的是，当命令报错时，Kiro不会只给你扔一堆红色的Error Log。它会直接分析报错原因：
“报错是因为端口8080被占用了，占用者是PID 1234 (Java)。你要杀掉它吗？”
我只需要回一个 <code>y</code>。</p>
<p>这种丝滑感，让我这个老运维都感动得想哭。Kiro 让 CLI（命令行界面）变成了 CUI（对话式界面）。</p>
<hr/>
<h3 data-id="heading-10">Trace：那个不用你写测试用例的QA</h3>
<p><strong>Trace</strong> 是今年测试领域的黑马。它的理念非常激进：<strong>“人是不应该写单元测试的”</strong>。</p>
<p>听起来很狂对吧？但它做到了。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af079fdd6ab43cf9ad3fcddb10f75f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6K-G5rWF6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767604059&amp;x-signature=Ekzn94%2Fbw8KD0PIr2P0tk%2F%2F%2FFlw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-11">1. 逆向生成测试</h4>
<p>Trace 挂在你的后台，它会观察你平时的手动测试行为，也会分析你的业务逻辑代码。当你写完一个 <code>OrderService</code> 类，保存的那一瞬间，Trace 已经在后台生成了覆盖率100%的测试用例。</p>
<p>它不仅仅是生成 <code>assert 1==1</code> 这种废话，它会生成边界条件测试。比如你写了个除法，它自动生成除以0的Case；你写了个金额计算，它自动生成负数输入的Case。</p>
<h4 data-id="heading-12">2. 生产环境录制回放</h4>
<p>Trace 最强的功能是<strong>Traffic Replay</strong>。它能对生产环境的流量进行脱敏录制，然后在我本地开发环境里回放。</p>
<p>这意味着，我本地调试的不是假数据，而是真实用户产生的数据（当然是脱敏的）。这解决了困扰程序员几十年的千古难题：“<strong>在我本地明明是好的啊！</strong>”</p>
<hr/>
<h3 data-id="heading-13">2025年的编程范式：我们还是程序员吗？</h3>
<p>聊完工具，我想聊聊心态。</p>
<p>今年我也听到很多声音，说程序员要失业了。但我这一年用下来，感觉恰恰相反。<strong>我们没有失业，但我们转行了。</strong></p>
<p>我们从“搬砖工”（Bricklayer）变成了“建筑师”（Architect）。</p>
<h4 data-id="heading-14">1. 这种感觉叫“心流的延续”</h4>
<p>以前写代码，很容易被打断：查语法、修标点、配环境。
现在有了 Cursor + Antigravity + Kiro，这些琐事都被AI接管了。我可以把所有的脑力都集中在<strong>业务逻辑</strong>和<strong>系统设计</strong>上。</p>
<p>以前做一个功能要3天，其中2.5天在写Boilerplate（样板代码）。现在做一个功能只要半天，剩下2.5天我可以去优化性能、去思考用户体验、甚至去陪女朋友（划掉，去学习新框架）。</p>
<h4 data-id="heading-15">2. 审美变得比手速更重要</h4>
<p>当AI能帮你生成一切的时候，<strong>品味</strong>就成了核心竞争力。</p>
<ul>
<li>你知道这段生成的代码虽然能跑，但结构很烂吗？</li>
<li>你知道这个UI虽然画出来了，但交互反人类吗？</li>
<li>你知道这个架构虽然流行，但不适合现在的业务规模吗？</li>
</ul>
<p>工具越强，越需要一个有经验的人去按住AI的手说：“停，这里不能这么写，会由于并发问题导致死锁。”</p>
<p>这就是2025年资深程序员的价值——<strong>鉴赏力与把控力</strong>。</p>
<hr/>
<h3 data-id="heading-16">结语</h3>
<p>2025年，是编程技术彻底爆发的一年。编程不再是Ctrl+C、Ctrl+V😂，它变成了一种更亲民、更高效的创造方式。</p>
<p>如果你问我，现在还要不要学编程？
我的回答是：<strong>要学。但不要学怎么写语法，要学怎么构建逻辑，怎么拆解问题，怎么指挥AI军团为你作战。</strong></p>
<p>如果你还没有试过 Cursor 的 Composer，没在 Antigravity 里飞过，没跟 Kiro 聊过天，哪怕只是为了好玩，也可以尝试一下。</p>
<p>毕竟，<strong>偷懒，才是人类科技进步的第一生产力。</strong></p>
<hr/>
<p><em>(最后插一句，这篇文章的大纲是 Cursor 帮我理的，配图建议是 Gemini 提的，但我保证，这段感慨是我自己一个个字敲出来的。)</em></p>
<hr/>
<p><strong>希望这篇年度总结能给你带来一些共鸣。明年见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回溯算法总结]]></title>    <link>https://juejin.cn/post/7588461466598031411</link>    <guid>https://juejin.cn/post/7588461466598031411</guid>    <pubDate>2025-12-29T00:20:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588461466598031411" data-draft-id="7588146449005953060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 回溯算法总结"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-29T00:20:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             回溯算法总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:20:47.000Z" title="Mon Dec 29 2025 00:20:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>其实回溯算法和我们常说的 DFS 算法非常类似，本质上就是一种暴力穷举算法。回溯算法和 DFS 算法的细微差别是：回溯算法是在遍历「树枝」，DFS 算法是在遍历「节点」</p>
<p><strong>抽象地说，解决一个回溯问题，实际上就是遍历一棵决策树的过程，树的每个叶子节点存放着一个合法答案。你把整棵树遍历一遍，把叶子节点上的答案都收集起来，就能得到所有的合法答案</strong>。</p>
<p>站在回溯树的一个节点上，你只需要思考 3 个问题：</p>
<p>1、路径：也就是已经做出的选择。</p>
<p>2、选择列表：也就是你当前可以做的选择。</p>
<p>3、结束条件：也就是到达决策树底层，无法再做选择的条件。</p>
<p>代码方面，回溯算法的框架：</p>
<pre><code class="hljs language-java" lang="java">result = []
def <span class="hljs-title function_">backtrack</span><span class="hljs-params">(路径, 选择列表)</span>:
    <span class="hljs-keyword">if</span> 满足结束条件:
        result.add(路径)
        <span class="hljs-keyword">return</span>
    
    <span class="hljs-keyword">for</span> 选择 in 选择列表:
        做选择
        backtrack(路径, 选择列表)
        撤销选择
</code></pre>
<p>for循环就是遍历集合区间，可以理解一个节点有多少个孩子，这个for循环就执行多少次。</p>
<p>backtracking这里自己调用自己，实现递归。</p>
<p><strong>其核心就是 for 循环里面的递归，在递归调用之前「做选择」，在递归调用之后「撤销选择」</strong></p>
<h2 data-id="heading-1">回溯算法解决组合问题</h2>
<p>这里的组合问题 元素无重不可复选</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    List&lt;List&lt;Integer&gt;&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// 记录回溯算法的递归路径</span>
    LinkedList&lt;Integer&gt; track = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();

    <span class="hljs-comment">// 主函数</span>
    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">combine</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">int</span> k)</span> {
        backtrack(<span class="hljs-number">1</span>, n, k);
        <span class="hljs-keyword">return</span> res;
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtrack</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> n, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-comment">// base case</span>
        <span class="hljs-keyword">if</span> (k == track.size()) {
            <span class="hljs-comment">// 遍历到了第 k 层，收集当前节点的值</span>
            res.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;(track));
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 回溯算法标准框架</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt;= n; i++) {
            <span class="hljs-comment">// 选择</span>
            track.addLast(i);
            <span class="hljs-comment">// 通过 start 参数控制树枝的遍历，避免产生重复的子集</span>
            backtrack(i + <span class="hljs-number">1</span>, n, k);
            <span class="hljs-comment">// 撤销选择</span>
            track.removeLast();
        }
    }
}
</code></pre>
<h2 data-id="heading-2">回溯算法解决排列问题</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    List&lt;List&lt;Integer&gt;&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// 记录回溯算法的递归路径</span>
    LinkedList&lt;Integer&gt; track = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// track 中的元素会被标记为 true</span>
    <span class="hljs-type">boolean</span>[] used;

    <span class="hljs-comment">/* 主函数，输入一组不重复的数字，返回它们的全排列 */</span>
    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">permute</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> {
        used = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[nums.length];
        backtrack(nums);
        <span class="hljs-keyword">return</span> res;
    }

    <span class="hljs-comment">// 回溯算法核心函数</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtrack</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> {
        <span class="hljs-comment">// base case，到达叶子节点</span>
        <span class="hljs-keyword">if</span> (track.size() == nums.length) {
            <span class="hljs-comment">// 收集叶子节点上的值</span>
            res.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>(track));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 回溯算法标准框架</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; nums.length; i++) {
            <span class="hljs-comment">// 已经存在 track 中的元素，不能重复选择</span>
            <span class="hljs-keyword">if</span> (used[i]) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-comment">// 做选择</span>
            used[i] = <span class="hljs-literal">true</span>;
            track.addLast(nums[i]);
            <span class="hljs-comment">// 进入下一层回溯树</span>
            backtrack(nums);
            <span class="hljs-comment">// 取消选择</span>
            track.removeLast();
            used[i] = <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h2 data-id="heading-3">总结</h2>
<p>回溯算法就是个多叉树的遍历问题，关键就是在前序遍历和后序遍历的位置做一些操作，算法框架如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrack</span>(<span class="hljs-params">...</span>):
    <span class="hljs-keyword">for</span> 选择 <span class="hljs-keyword">in</span> 选择列表:
        做选择
        backtrack(...)
        撤销选择
</code></pre>
<p><strong>写 <code>backtrack</code> 函数时，需要维护走过的「路径」和当前可以做的「选择列表」，当触发「结束条件」时，将「路径」记入结果集</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hello AgentScope Java]]></title>    <link>https://juejin.cn/post/7588570963294535723</link>    <guid>https://juejin.cn/post/7588570963294535723</guid>    <pubDate>2025-12-29T05:29:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588570963294535723" data-draft-id="7588445332773158966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hello AgentScope Java"/> <meta itemprop="keywords" content="云原生,Agent"/> <meta itemprop="datePublished" content="2025-12-29T05:29:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hello AgentScope Java
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T05:29:22.000Z" title="Mon Dec 29 2025 05:29:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：远云</p>
<p>随着 LLM 应用的飞速发展，越来越多的 Agent 应用开始走近每个人。围绕着 Agent 应用的核心，目前业界有零代码、低代码和高代码三条主流的技术路线。AgentScope 作为 Python 社区中受到广泛应用的高代码框架，在 Java 生态下的需求也越来越大。</p>
<p>今天，我们很高兴地宣布 <strong>AgentScope Java v0.2 版本</strong>正式发布了，具备了所有核心的 ReActAgent 的能力。</p>
<h2 data-id="heading-0">第一性原则：透明度</h2>
<p>AgentScope 的首要设计目标是<strong>对开发者透明</strong>。</p>
<p>当下，许多 Agent 框架将底层的调度进行了深度的封装，这固然会给用户带来一些概念上的简化，但是也带来了遇到问题时排查的复杂度。AgentScope 不同：</p>
<ul>
<li><strong>Prompt Engineering：</strong> 用户可以自己修改所有提示词相关的内容。</li>
<li><strong>API 调用：</strong> 每一次 API 调用都能够被定位。</li>
<li><strong>Agent 构建：</strong> 所有 Agent 的配置都来自用户确定性的配置。</li>
<li><strong>决策过程：</strong> Agent 的推理、执行过程都可以通过 Hook 对外暴露。</li>
</ul>
<h2 data-id="heading-1">三分钟构建一个智能体</h2>
<p>以下是一个简单的智能体示例：</p>
<h3 data-id="heading-2">Maven 依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.agentscope<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>agentscope-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">ReActAgent</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">HelloAgentScope</span> {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-comment">// 创建 ReActAgent</span>
        <span class="hljs-selector-tag">ReActAgent</span> <span class="hljs-selector-tag">agent</span> = <span class="hljs-selector-tag">ReActAgent</span><span class="hljs-selector-class">.builder</span>()
            <span class="hljs-selector-class">.name</span>(<span class="hljs-string">"Assistant"</span>)
            <span class="hljs-selector-class">.model</span>(DashScopeChatModel.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">apiKey</span>(System.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
                .<span class="hljs-built_in">modelName</span>(<span class="hljs-string">"qwen3-max"</span>)
                .<span class="hljs-built_in">build</span>())
            <span class="hljs-selector-class">.build</span>();
        <span class="hljs-comment">// 调用智能体</span>
        <span class="hljs-selector-tag">Msg</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">agent</span><span class="hljs-selector-class">.call</span>(
            Msg.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">role</span>(MsgRole.USER)
                .<span class="hljs-built_in">content</span>(TextBlock.<span class="hljs-built_in">builder</span>()
                        .<span class="hljs-built_in">text</span>(<span class="hljs-string">"你好，请介绍一下自己"</span>)
                        .<span class="hljs-built_in">build</span>())
                .<span class="hljs-built_in">build</span>()
        )<span class="hljs-selector-class">.block</span>();
        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(response.<span class="hljs-built_in">getTextContent</span>());
    }
}
</code></pre>
<p>至此，一个 Agent 就构建完成了。在这个示例中，<code>ReActAgent</code> 是 AgentScope 的核心，我们后面几乎所有的功能都是基于它的。</p>
<h2 data-id="heading-4">架构概览</h2>
<p>和 Python 版本类似，AgentScope Java 采用分层架构：</p>
<h3 data-id="heading-5">基础组件层（Foundational Components）</h3>
<p><strong>Message</strong>：统一的消息抽象对象，通过一套数据结构支持文本、图像、音频、视频。</p>
<p><strong>Model API</strong>：支持 DashScope、OpenAI 等主流模型提供商。通过 Formatter 机制屏蔽不同模型提供商的格式差异。</p>
<p><strong>Tool</strong>：允许用户定义工具给 LLM 使用，支持同步/异步、流式/非流式等 API 风格。</p>
<h3 data-id="heading-6">智能体基础设施层（Agent-level Infrastructure）</h3>
<p><strong>ReAct 范式</strong>：核心 Agentic 实现，通过推理（Reasoning）再行动（Acting）的迭代循环。</p>
<p><strong>Agent Hooks</strong>：运行于 ReActAgent 内部，允许用户对 Agent 执行的过程进行监测、修改。</p>
<p><strong>状态管理</strong>：会话持久化组件，支持用户对话状态的保存和恢复。</p>
<h3 data-id="heading-7">多智能体协作层（Multi-Agent Cooperation）</h3>
<p><strong>MsgHub</strong>：支持多个 Agent 之间共享消息，实现多 Agent 沟通协作的工具。</p>
<p><strong>Pipeline</strong>：组合多个 Agent 按照特定（顺序、并行等）策略执行的工具。</p>
<h3 data-id="heading-8">部署层（Deployment）</h3>
<p><strong>AgentScope Runtime</strong>：解决分布式部署与安全隔离问题的企业级运行时基础设施，提供工具运行沙箱、A2A 协议、远程部署等能力。</p>
<p><strong>AgentScope Studio</strong>：提供开发阶段到运行阶段的可视化调试、观测能力，为开发者从 0 到 1 的开发提速。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8363e331ea4525984b08cbabfea77e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767590961&amp;x-signature=N%2BTJvd%2BCs9XkR25K8NqZX4l2TFI%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">Reasoning and Acting</h2>
<p>ReAct（Reasoning and Acting）是 AgentScope 最核心的实现范式。其设计思路很简单：将思考和执行分离，通过迭代循环解决问题。</p>
<h3 data-id="heading-10">工作原理</h3>
<p><strong>Reasoning（推理）阶段</strong>：Agent 会基于当前的上下文分析，决定下一步行动：</p>
<ul>
<li>理解用户意图</li>
<li>评估已有信息（上下文）</li>
<li>确定需要调用的工具及参数</li>
</ul>
<p><strong>Acting（行动）阶段</strong>：执行 Reasoning 阶段所需的获取数据行为。</p>
<ul>
<li>并行执行工具调用</li>
<li>收集执行结果</li>
<li>将结果计入记忆</li>
</ul>
<p><strong>迭代控制</strong>：ReActAgent 会不断执行 Reasoning 和 Acting 的迭代，如果模型在最大迭代轮内完成迭代则会正常结束，如果未完成则会触发 summary 的能力，进行会话总结。</p>
<h3 data-id="heading-11">为 ReActAgent 添加工具</h3>
<p>为了让 ReActAgent 真正可以实现 Acting，需要为 ReActAgent 添加对应的工具。</p>
<p>这里以一个 Weather Assistant 为例子：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 定义工具类</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">WeatherTools</span> {
    <span class="hljs-variable">@Tool</span>(description = <span class="hljs-string">"获取指定城市的天气信息"</span>)
    public String <span class="hljs-built_in">getWeather</span>(
        <span class="hljs-variable">@ToolParam</span>(name = <span class="hljs-string">"city"</span>, description = <span class="hljs-string">"城市名称"</span>) String city) {
        <span class="hljs-comment">// 实际应用中调用天气 API</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.format</span>(<span class="hljs-string">"%s：晴天，气温 25 ℃"</span>, city);
    }
}
<span class="hljs-comment">// 注册工具</span>
<span class="hljs-selector-tag">Toolkit</span> <span class="hljs-selector-tag">toolkit</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Toolkit</span>();
<span class="hljs-selector-tag">toolkit</span><span class="hljs-selector-class">.registerTool</span>(new <span class="hljs-built_in">WeatherTools</span>());
<span class="hljs-comment">// 构建带工具的 ReActAgent</span>
<span class="hljs-selector-tag">ReActAgent</span> <span class="hljs-selector-tag">agent</span> = <span class="hljs-selector-tag">ReActAgent</span><span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>(<span class="hljs-string">"WeatherAssistant"</span>)
    <span class="hljs-selector-class">.sysPrompt</span>(<span class="hljs-string">"你是一个天气助手，可以查询城市天气信息。"</span>)
    <span class="hljs-selector-class">.model</span>(DashScopeChatModel.<span class="hljs-built_in">builder</span>()
        .<span class="hljs-built_in">apiKey</span>(System.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
        .<span class="hljs-built_in">modelName</span>(<span class="hljs-string">"qwen3-max"</span>)
        .<span class="hljs-built_in">build</span>())
    <span class="hljs-selector-class">.toolkit</span>(toolkit)
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 调用智能体</span>
<span class="hljs-selector-tag">Msg</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">agent</span><span class="hljs-selector-class">.call</span>(
    Msg.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">role</span>(MsgRole.USER)
                .<span class="hljs-built_in">content</span>(TextBlock.<span class="hljs-built_in">builder</span>()
                        .<span class="hljs-built_in">text</span>(<span class="hljs-string">"北京今天天气如何？"</span>)
                        .<span class="hljs-built_in">build</span>())
                .<span class="hljs-built_in">build</span>()
)<span class="hljs-selector-class">.block</span>();
</code></pre>
<p>执行流程：</p>
<pre><code class="hljs language-scss" lang="scss">用户问题：北京今天天气如何？
    ↓
<span class="hljs-selector-attr">[推理]</span> 需要查天气，决定调用 <span class="hljs-built_in">getWeather</span>("北京")
    ↓
<span class="hljs-selector-attr">[行动]</span> 执行工具 → "北京：晴天，气温 <span class="hljs-number">25</span>℃"
    ↓
<span class="hljs-selector-attr">[推理]</span> 已获取信息，生成回答
    ↓
回答：根据查询结果，北京今天晴天，气温 <span class="hljs-number">25</span>℃
</code></pre>
<h2 data-id="heading-12">ReActAgent 核心特性</h2>
<p>除了基础的 Reasoning 和 Acting 能力，AgentScope 的 ReActAgent 还具备多个特性。</p>
<h3 data-id="heading-13">1. 多模态消息支持</h3>
<p>ReActAgent 可以处理多模态输入，不限于纯文本：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 创建支持视觉的 ReActAgent（使用视觉模型）</span>
<span class="hljs-selector-tag">ReActAgent</span> <span class="hljs-selector-tag">visionAgent</span> = <span class="hljs-selector-tag">ReActAgent</span><span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>(<span class="hljs-string">"VisionAssistant"</span>)
    <span class="hljs-selector-class">.model</span>(DashScopeChatModel.<span class="hljs-built_in">builder</span>()
        .<span class="hljs-built_in">apiKey</span>(System.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
        .<span class="hljs-built_in">modelName</span>(<span class="hljs-string">"qwen3-vl-plus"</span>)  <span class="hljs-comment">// 视觉模型</span>
        .<span class="hljs-built_in">build</span>())
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 发送包含图片的消息</span>
<span class="hljs-selector-tag">Msg</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">visionAgent</span><span class="hljs-selector-class">.call</span>(
    Msg.<span class="hljs-built_in">builder</span>()
        .<span class="hljs-built_in">role</span>(MsgRole.USER)
        .<span class="hljs-built_in">content</span>(List.<span class="hljs-built_in">of</span>(
            TextBlock.<span class="hljs-built_in">builder</span>().<span class="hljs-built_in">text</span>(<span class="hljs-string">"请分析这张图片的内容"</span>).<span class="hljs-built_in">build</span>(),
            ImageBlock.<span class="hljs-built_in">builder</span>().<span class="hljs-built_in">source</span>(URLSource.<span class="hljs-built_in">builder</span>().url(<span class="hljs-string">"https://example.com/image.jpg"</span>).<span class="hljs-built_in">build</span>()).<span class="hljs-built_in">build</span>()
        ))
        .<span class="hljs-built_in">build</span>()
)<span class="hljs-selector-class">.block</span>();
</code></pre>
<p>支持的多模态内容类型：TextBlock、ImageBlock、AudioBlock、VideoBlock。</p>
<h3 data-id="heading-14">2. 钩子机制</h3>
<p>为 ReActAgent 添加钩子，监控和扩展其行为。这里以前文中用到的 WeatherAssistant 为例子添加钩子，实时看到智能体的思考和执行过程：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">// 定义调试钩子，显示完整的 ReAct 执行过程
Hook debugHook = <span class="hljs-built_in">new</span> Hook() {
    @Override
    <span class="hljs-keyword">public</span> &lt;T extends HookEvent&gt; Mono&lt;T&gt; onEvent(T <span class="hljs-keyword">event</span>) {
        <span class="hljs-keyword">try</span> {
            switch (<span class="hljs-keyword">event</span>) {
                <span class="hljs-keyword">case</span> PreReasoningEvent e -&gt; {
                    System.out.println(<span class="hljs-string">"\n[推理] 智能体开始思考..."</span>);
                }
                <span class="hljs-keyword">case</span> PostReasoningEvent e -&gt; {
                    System.out.println(<span class="hljs-string">"[推理] 推理结果："</span> + <span class="hljs-built_in">new</span> ObjectMapper().writeValueAsString(e.getReasoningMessage()));
                }
                <span class="hljs-keyword">case</span> PostActingEvent e -&gt; {
                    System.out.println(<span class="hljs-string">"[行动] 执行工具 → "</span> + <span class="hljs-built_in">new</span> ObjectMapper().writeValueAsString(e.getToolResult()));
                }
                <span class="hljs-keyword">case</span> PostCallEvent e -&gt; {
                    System.out.println(<span class="hljs-string">"[推理] 已获取信息，生成回答"</span>);
                    System.out.println(<span class="hljs-string">"回答："</span> + e.getFinalMessage().getTextContent());
                }
                <span class="hljs-keyword">default</span> -&gt; {}
            } ;
        } <span class="hljs-keyword">catch</span> (JsonProcessingException e) {
            ...
        }
        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-keyword">event</span>);
    }
};
// 将钩子添加到 WeatherAssistant
ReActAgent weatherAgent = ReActAgent.builder()
    .name(<span class="hljs-string">"WeatherAssistant"</span>)
    .sysPrompt(<span class="hljs-string">"你是一个天气助手，可以查询城市天气信息。"</span>)
    .model(DashScopeChatModel.builder()
           .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
           .modelName(<span class="hljs-string">"qwen3-max"</span>)
           .build())
    .toolkit(toolkit) // 前文中定义的 Toolkit
    .hook(debugHook)  // 添加调试钩子
    .build();
// 查询天气
Msg response = weatherAgent.<span class="hljs-keyword">call</span>(
    Msg.builder()
    .role(MsgRole.USER)
    .content(TextBlock.builder()
             .<span class="hljs-keyword">text</span>(<span class="hljs-string">"北京今天天气如何？"</span>)
             .build())
    .build()
).block();
// 输出示例：
// [推理] 智能体开始思考...
// [推理] 推理结果：{<span class="hljs-string">"id"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"WeatherAssistant"</span>,<span class="hljs-string">"role"</span>:<span class="hljs-string">"ASSISTANT"</span>,<span class="hljs-string">"content"</span>:[{<span class="hljs-string">"type"</span>:<span class="hljs-string">"tool_use"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-string">"call_xxx"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"getWeather"</span>,<span class="hljs-string">"input"</span>:{<span class="hljs-string">"city"</span>:<span class="hljs-string">"北京"</span>},<span class="hljs-string">"content"</span>:null}],<span class="hljs-string">"metadata"</span>:null,<span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"xxx"</span>}
// [行动] 执行工具 → {<span class="hljs-string">"type"</span>:<span class="hljs-string">"tool_result"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-string">"call_xxx"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"getWeather"</span>,<span class="hljs-string">"output"</span>:[{<span class="hljs-string">"type"</span>:<span class="hljs-string">"text"</span>,<span class="hljs-string">"text"</span>:<span class="hljs-string">"\"</span>北京：晴天，气温 <span class="hljs-number">25</span> ℃\<span class="hljs-string">""</span>}],<span class="hljs-string">"metadata"</span>:{}}
// [推理] 智能体开始思考...
// [推理] 推理结果：{<span class="hljs-string">"id"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"WeatherAssistant"</span>,<span class="hljs-string">"role"</span>:<span class="hljs-string">"ASSISTANT"</span>,<span class="hljs-string">"content"</span>:[{<span class="hljs-string">"type"</span>:<span class="hljs-string">"text"</span>,<span class="hljs-string">"text"</span>:<span class="hljs-string">"北京今天天气晴朗，气温为25℃。建议外出时注意防晒，祝您拥有愉快的一天！"</span>}],<span class="hljs-string">"metadata"</span>:null,<span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"xxx"</span>}
// [推理] 已获取信息，生成回答
// 回答：北京今天天气晴朗，气温为<span class="hljs-number">25</span>℃。建议外出时注意防晒，祝您拥有愉快的一天！
</code></pre>
<h3 data-id="heading-15">3. 会话持久化</h3>
<p>保存和恢复 ReActAgent 的状态：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建 ReActAgent</span>
ReActAgent agent = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("PersistentAgent")
    <span class="hljs-selector-class">.model</span>(DashScopeChatModel.builder()
        <span class="hljs-selector-class">.apiKey</span>(System.getenv("DASHSCOPE_API_KEY"))
        <span class="hljs-selector-class">.modelName</span>("qwen3-max")
        <span class="hljs-selector-class">.build</span>())
    <span class="hljs-selector-class">.memory</span>(new InMemoryMemory())
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 保存会话</span>
SessionManager<span class="hljs-selector-class">.forSessionId</span>("session-<span class="hljs-number">001</span>")
    <span class="hljs-selector-class">.withJsonSession</span>(Path.of("./sessions"))
    <span class="hljs-selector-class">.addComponent</span>(agent)
    <span class="hljs-selector-class">.saveSession</span>();
<span class="hljs-comment">// 下次启动时恢复</span>
SessionManager<span class="hljs-selector-class">.forSessionId</span>("session-<span class="hljs-number">001</span>")
    <span class="hljs-selector-class">.withJsonSession</span>(Path.of("./sessions"))
    <span class="hljs-selector-class">.addComponent</span>(agent)
    <span class="hljs-selector-class">.loadIfExists</span>();
<span class="hljs-comment">// agent 现在恢复到了之前的状态，可以继续对话</span>
</code></pre>
<h3 data-id="heading-16">4. 结构化输出</h3>
<p>让 ReActAgent 返回类型安全的结构化数据：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 定义输出结构</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherReport</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> city;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> temperature;
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> condition;
    <span class="hljs-keyword">public</span> List&lt;<span class="hljs-type">String</span>&gt; suggestions;
}
<span class="hljs-comment">// ReActAgent 调用时指定输出类型</span>
Msg response = agent.<span class="hljs-built_in">call</span>(
    Msg.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">role</span>(MsgRole.USER)
                .<span class="hljs-built_in">content</span>(TextBlock.<span class="hljs-built_in">builder</span>()
                        .<span class="hljs-built_in">text</span>(<span class="hljs-string">"分析北京的天气并给出建议"</span>)
                        .<span class="hljs-built_in">build</span>())
                .<span class="hljs-built_in">build</span>(),
    WeatherReport.<span class="hljs-keyword">class</span>  <span class="hljs-comment">// 指定结构化输出类型</span>
).<span class="hljs-built_in">block</span>();
<span class="hljs-comment">// 提取结构化数据</span>
WeatherReport report = response.<span class="hljs-built_in">getStructuredData</span>(WeatherReport.<span class="hljs-keyword">class</span>);
System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"城市: "</span> + report.city);
System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"温度: "</span> + report.temperature);
</code></pre>
<p>避免了文本解析的不确定性，编译期就能发现类型错误。</p>
<h3 data-id="heading-17">5. 多智能体协作</h3>
<p>多个 ReActAgent 可以通过 Pipeline 协作：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建模型配置</span>
DashScopeChatModel model = DashScopeChatModel<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.apiKey</span>(System.getenv("DASHSCOPE_API_KEY"))
    <span class="hljs-selector-class">.modelName</span>("qwen3-max")
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 创建多个 ReActAgent</span>
ReActAgent dataCollector = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("DataCollector")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.build</span>();
ReActAgent dataAnalyzer = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("DataAnalyzer")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.build</span>();
ReActAgent reportGenerator = ReActAgent<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.name</span>("ReportGenerator")
    <span class="hljs-selector-class">.model</span>(model)
    <span class="hljs-selector-class">.build</span>();
<span class="hljs-comment">// 顺序执行：智能体依次处理</span>
Msg result = Pipelines<span class="hljs-selector-class">.sequential</span>(
    List.of(dataCollector, dataAnalyzer, reportGenerator),
    inputMsg
)<span class="hljs-selector-class">.block</span>();
<span class="hljs-comment">// 并行执行：多个智能体同时处理</span>
List&lt;Msg&gt; results = Pipelines<span class="hljs-selector-class">.fanout</span>(
    List.of(dataCollector, dataAnalyzer, reportGenerator), 
    inputMsg
)<span class="hljs-selector-class">.block</span>();
</code></pre>
<h2 data-id="heading-18">Roadmap</h2>
<p>AgentScope Java 自 2025 年 9 月开源以来，当前 v0.2 版本已具备 ReActAgent 核心能力。</p>
<p>我们计划于 11 月底发布 v1.0 版本，届时将新增 RAG、Plan、Tracing、Evaluation 及 Studio 等全套功能，标志着框架正式生产可用；Runtime v1.0 也将同步上线，提供涵盖安全沙箱、A2A Agent 在内的企业级落地方案。随后在 12 月，我们将进一步推出基于 ReMe 的上下文管理与基于 Trinity-RFT 的强化学习最佳实践。</p>
<p>在技术演进层面，我们正持续探索更高效、智能的上下文工程与多 Agent 协同范式，致力于支撑更强大的 AI 应用构建。此外，针对 Agent 流量呈现的“二八定律”特征（头部 20% 的 Agent 承载了 80% 的流量），我们在架构上全力推进 Serverless 化，通过实现毫秒级冷启动与混合部署，帮助开发者在应对高并发的同时，显著降低部署成本并提升效率。</p>
<h2 data-id="heading-19">未完待续</h2>
<p>本文作为 AgentScope Java 系列推文的首篇，受篇幅限制只能抛砖引玉，在接下来还会有更多的干货：</p>
<ol>
<li>AgentScope Runtime：帮助开发者实现 Agent 应用从 1 到 100，提供工具运行沙箱、A2A 协议、远程部署等强大能力。</li>
<li>Agent 开发范式讨论：Workflow or Agentic？AgentScope 基于狼人杀游戏的 Agent 实践分享。</li>
<li>Meta Tool：面对日益膨胀的 Tool Definition，AgentScope 的解决方案。</li>
<li>Plan：使 Agent 能够自主拆解复杂任务并系统性地执行。</li>
</ol>
<p>如果你觉得 AgentScope Java 不错，欢迎给我们的项目 Star~<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-java" target="_blank" title="https://github.com/agentscope-ai/agentscope-java" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>