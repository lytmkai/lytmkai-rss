<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Chrome devtools二次开发准备:获取源码和编译]]></title>    <link>https://juejin.cn/post/7571678674144870410</link>    <guid>https://juejin.cn/post/7571678674144870410</guid>    <pubDate>2025-11-12T12:48:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144870410" data-draft-id="7571704212850245683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chrome devtools二次开发准备:获取源码和编译"/> <meta itemprop="keywords" content="前端,Google"/> <meta itemprop="datePublished" content="2025-11-12T12:48:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sTone87375"/> <meta itemprop="url" content="https://juejin.cn/user/2946346894764584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chrome devtools二次开发准备:获取源码和编译
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2946346894764584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sTone87375
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:48:47.000Z" title="Wed Nov 12 2025 12:48:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Ubuntu 上获取并编译 Google Chrome DevTools Frontend 源码，有两种主流方式：</p>
<ol>
<li>直接下载官方已经打好包的 npm 包（最快，免编译）</li>
<li>用 Google 的 depot_tools 完整拉取 Chromium 源码并自行编译（最完整，可二次开发）</li>
</ol>
<p>下面分别给出步骤，你可以按需求二选一。</p>
<hr/>
<p>一、只想“拿到就用”——用 npm 包（免编译）
官方已经把每天构建好的前端文件发布到 npm，装完就能跑。</p>
<ol>
<li>
<p>安装</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 装包（版本号每天更新，可去 npm 查最新）</span>
npm i -g chrome-devtools-frontend@latest
<span class="hljs-comment"># 进入包目录</span>
<span class="hljs-built_in">cd</span> $(npm root -g)/chrome-devtools-frontend
</code></pre>
</li>
<li>
<p>起静态服务验证</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 任意静态服务器均可</span>
npx http-server . -p 8081
</code></pre>
<p>浏览器访问</p>
<pre><code class="hljs language-bash" lang="bash">http://localhost:8081/front_end/devtools_app.html?ws=localhost:9229
</code></pre>
<p>只要 9229 端口有符合 CDP 的 WebSocket 服务，就能正常调试 。</p>
</li>
</ol>
<hr/>
<p>二、需要“源码级二次开发”——完整拉取并编译
适合想改面板、加功能、追最新主干代码的同学。</p>
<ol start="0">
<li>
<p>系统依赖（Ubuntu 22.04 示例）</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt update
sudo apt install git python3 python3-venv pkg-config \
     build-essential ninja-build nodejs npm curl
</code></pre>
</li>
<li>
<p>准备 depot_tools（Google 的构建工具链）</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH=$PATH:'</span><span class="hljs-string">"<span class="hljs-subst">$(pwd)</span>/depot_tools"</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">source</span> ~/.bashrc
</code></pre>
</li>
<li>
<p>拉取 DevTools Frontend 源码（约 1-2 GB）</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> devtools &amp;&amp; <span class="hljs-built_in">cd</span> devtools
fetch devtools-frontend     <span class="hljs-comment"># 这条命令来自 depot_tools</span>
<span class="hljs-built_in">cd</span> devtools-frontend
</code></pre>
</li>
<li>
<p>同步依赖并生成构建文件</p>
<pre><code class="hljs language-bash" lang="bash">gclient <span class="hljs-built_in">sync</span>                <span class="hljs-comment"># 第一次会下载 Node、Java 运行时等，需科学上网</span>
gn gen out/Default          <span class="hljs-comment"># 生成 Ninja 构建文件</span>
</code></pre>
</li>
<li>
<p>编译（Ubuntu 上约 5-10 分钟，视 CPU 而定）</p>
<pre><code class="hljs language-bash" lang="bash">autoninja -C out/Default    <span class="hljs-comment"># 等价于 ninja -C out/Default，但自动并行</span>
</code></pre>
<p>产物在</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">out</span><span class="hljs-operator">/</span><span class="hljs-keyword">Default</span><span class="hljs-operator">/</span>gen<span class="hljs-operator">/</span>front_end<span class="hljs-operator">/</span>
</code></pre>
<p>即为可运行的 DevTools 前端 。</p>
</li>
<li>
<p>本地预览</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> out/Default/gen/front_end
npx http-server . -p 8081
</code></pre>
<p>浏览器打开</p>
<pre><code class="hljs language-bash" lang="bash">http://localhost:8081/devtools_app.html?ws=localhost:9229
</code></pre>
</li>
<li>
<p>让本地 Chrome 默认使用你编译的版本<br/>
关闭所有 Chrome 后启动</p>
<pre><code class="hljs language-bash" lang="bash">google-chrome --custom-devtools-frontend=file://$(<span class="hljs-built_in">pwd</span>)/out/Default/gen/front_end
</code></pre>
<p>以后按 F12 就会直接加载你改过的面板 。</p>
</li>
</ol>
<hr/>
<p>三、常见问题速查</p>
<ul>
<li>
<p>网络超时：<br/>
<code>fetch</code> / <code>gclient</code> 阶段需要访问 Google 服务器，Ubuntu 下可给终端走代理</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890
</code></pre>
</li>
<li>
<p>编译报错缺 header：<br/>
一般把 <code>build-essential</code> 和 <code>pkg-config</code> 补齐即可；若仍缺 <code>java/javac</code>，可再装 <code>openjdk-11-jdk</code>。</p>
</li>
<li>
<p>只想定时拉最新官方构建，而不自己编：<br/>
关注 GitHub 仓库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faryasaatvik%2Fchrome-devtools-frontend-build" target="_blank" title="https://github.com/aryasaatvik/chrome-devtools-frontend-build" ref="nofollow noopener noreferrer">aryasaatvik/chrome-devtools-frontend-build</a> 的 releases，每周自动更新已编好的包，下载即用 。</p>
</li>
</ul>
<hr/>
<p>一句话总结</p>
<ul>
<li>“快速体验” → <code>npm i -g chrome-devtools-frontend</code> 即可；</li>
<li>“深度定制” → Ubuntu 装好 depot_tools → <code>fetch devtools-frontend</code> → <code>gn gen</code> → <code>autoninja</code>，完事后 <code>out/Default/gen/front_end</code> 就是你的专属调试器前端。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在为HTML转PDF发愁？再介绍两款工具，为你保驾护航！]]></title>    <link>https://juejin.cn/post/7571751304625569838</link>    <guid>https://juejin.cn/post/7571751304625569838</guid>    <pubDate>2025-11-13T02:12:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571751304625569838" data-draft-id="7571758212473749555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在为HTML转PDF发愁？再介绍两款工具，为你保驾护航！"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-11-13T02:12:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在为HTML转PDF发愁？再介绍两款工具，为你保驾护航！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:12:55.000Z" title="Thu Nov 13 2025 02:12:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42b0f46eac5946f38b0d0e83e709783b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=XGfEVYv7IQa%2FVvf9k20KoVYhHjw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>在之前专门写了一篇文章《<code>SpringBoot</code>集成：5分钟实现<code>HTML</code>转<code>PDF</code>功能》，介绍三款<code>Html</code>转<code>PDF</code>的工具。这不，又发现了两款类似的工具，整理一下分享给大家。</p>
<h2 data-id="heading-1">02 itext-pdfhtml-java</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/024171cf2f7344d68ee3351459f33583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=GBk7ynYUKAr20K5UleVzP3Z9T7Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2.1 简介</h3>
<p><code>iText pdfHTML</code>是<code>iText7</code>套件的一个附加组件，专门用于将<code>HTML</code>和<code>CSS</code>内容转换为<code>PDF</code>文档。它基于<code>iText</code>核心<code>PDF</code>生成引擎，提供了高质量的<code>HTML</code>到<code>PDF</code>转换功能。性能表现非常优异。</p>
<p>主要特性：</p>
<ul>
<li><strong>完整的<code>HTML5</code>和<code>CSS3</code>支持</strong>：能够处理现代网页布局和样式</li>
<li><strong>字体嵌入</strong>：自动处理Web字体和系统字体</li>
<li><strong>响应式设计</strong>：支持媒体查询和响应式布局</li>
<li><strong>高保真转换</strong>：保持HTML内容的视觉保真度</li>
<li><strong>Java原生</strong>：专为Java生态系统设计</li>
</ul>
<p><code>GitHub</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fitext%2Fitext-pdfhtml-java" target="_blank" title="https://github.com/itext/itext-pdfhtml-java" ref="nofollow noopener noreferrer">github.com/itext/itext…</a></p>
<p>官方地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitextpdf.com%2Fproducts%2Fconvert-html-css-to-pdf-pdfhtml" target="_blank" title="https://itextpdf.com/products/convert-html-css-to-pdf-pdfhtml" ref="nofollow noopener noreferrer">itextpdf.com/products/co…</a></p>
<h3 data-id="heading-3">2.2 案例</h3>
<p>使用起来也非常简单，下面官方的案例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca4a7ca81d0d437d9377dd672981f93a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=n%2BufL%2FAX17Q1IJJb4bV64o6Je6A%3D" alt="" loading="lazy"/></p>
<p><strong>Maven依赖</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itextpdf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>html2pdf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>实践代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("index6")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index6</span><span class="hljs-params">(Model model, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
        Map&lt;String, Object&gt; item = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        item.put(<span class="hljs-string">"image1"</span>, <span class="hljs-string">"http://example.com/2eb97.jpg"</span>);
        item.put(<span class="hljs-string">"image2"</span>, <span class="hljs-string">"http://example.com/2f9c3.jpg"</span>);
        item.put(<span class="hljs-string">"vehicleName"</span>, <span class="hljs-string">"路虎Defender［卫士］（进口）2023款Defender130 48V［卫士 130 48V] 3.0T手自－体P400 HSE"</span>);
        item.put(<span class="hljs-string">"brandName"</span>, <span class="hljs-string">"路虎"</span>);
        item.put(<span class="hljs-string">"seriesName"</span>, <span class="hljs-string">"Defender［卫士］"</span>);
        item.put(<span class="hljs-string">"modelYear"</span>, <span class="hljs-string">"2023款"</span>);
        item.put(<span class="hljs-string">"licenseYear"</span>, SDF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
        item.put(<span class="hljs-string">"displayMileage"</span>, DF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"9657"</span>)));
        item.put(<span class="hljs-string">"dealDate"</span>, SDF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
        item.put(<span class="hljs-string">"dealPrice"</span>, DF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"702400"</span>)));

        item.put(<span class="hljs-string">"licenseCode"</span>, <span class="hljs-string">"沪A952714"</span>);

        list.add(item);
    }
    model.addAttribute(<span class="hljs-string">"list"</span>, list);
    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    map.put(<span class="hljs-string">"list"</span>, list);

    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>(Locale.getDefault(), map);
    <span class="hljs-type">String</span> <span class="hljs-variable">htmlContent</span> <span class="hljs-operator">=</span> templateEngine.process(<span class="hljs-string">"index"</span>, context);
    System.out.println(htmlContent);

    <span class="hljs-comment">// ---------------------------------------------------</span>
    <span class="hljs-comment">/*itext-html2pdf*/</span>
    <span class="hljs-type">ConverterProperties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConverterProperties</span>();

    <span class="hljs-type">FontProvider</span> <span class="hljs-variable">fontProvider</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FontProvider</span>();
    fontProvider.addSystemFonts();
<span class="hljs-comment">//        fontProvider.addFont("C:\\Windows\\Fonts\\simhei.ttf");</span>
    <span class="hljs-comment">// 添加系统字体</span>
    properties.setFontProvider(fontProvider);

    HtmlConverter.convertToPdf(htmlContent, response.getOutputStream(), properties);
}
</code></pre>
<p>同样默认是不支持中文的，需要通过<code>FontProvider</code>添加指定的字体。<code>fontProvider.addSystemFonts();</code>直接添加系统字体，也可以通过<code>addFont()</code>添加自定义字体。页面必须声明字体，否则会出现乱码。</p>
<h2 data-id="heading-4">03 x-easypdf</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f789e0271ef646d08c9ff65b1d160004~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=MzcOsM2iWen1FdY%2FiDzfn9hrK68%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.1 简介</h3>
<p><code>x-easypdf</code>是一个<code>java</code>语言简化处理<code>pdf</code>的框架，包含<code>fop</code>模块与<code>pdfbox</code>模块，<code>fop</code>模块以创建功能为主，基于<code>xsl-fo</code>模板生成<code>pdf</code>文档，以数据源的方式进行模板渲染；<code>pdfbox</code>模块以编辑功能为主，对标准的<code>pdfbox</code>进行扩展，添加了成吨的功能。</p>
<p><code>Html</code>转<code>Pdf</code>是<code>pdfbox</code>模块下的一个转化器的功能，是基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplaywright.dev%2Fjava%2Fdocs%2Fintro" target="_blank" title="https://playwright.dev/java/docs/intro" ref="nofollow noopener noreferrer">playwright</a> 实现的。而<code>playwright</code>的依赖需要手动引入。<code>Playwright</code>是一个跨语言的浏览器自动化库，由<code>Microsoft</code>开发。虽然主要用于端到端测试，但其强大的<code>PDF</code>生成功能也使其成为<code>HTML</code>转<code>PDF</code>的优秀工具。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d45b8a6e1b4e38b12f17cd8b94a417~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=auTpCKZiPq%2B8JF%2BTr%2B%2BXDxLnfnE%3D" alt="" loading="lazy"/></p>
<p><code>Gitee</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdromara%2Fx-easypdf" target="_blank" title="https://gitee.com/dromara/x-easypdf" ref="nofollow noopener noreferrer">gitee.com/dromara/x-e…</a></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx-easypdf.cn%2F" target="_blank" title="https://x-easypdf.cn/" ref="nofollow noopener noreferrer">x-easypdf.cn/</a></p>
<h3 data-id="heading-6">3.2 案例</h3>
<p><code>x-easypdf</code>是对<code>playwrigh</code>的功能做了一层包装，使用起来更方便。</p>
<p><strong>Maven依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.dromara<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>x-easypdf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.microsoft.playwright<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>playwright<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.53.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>实践代码01</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("index10")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index10</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// 获取html转换器</span>
    <span class="hljs-type">HtmlConvertor</span> <span class="hljs-variable">convertor</span> <span class="hljs-operator">=</span> PdfHandler.getDocumentConvertor().getHtmlConvertor();
    <span class="hljs-type">Document</span> <span class="hljs-variable">pdf</span> <span class="hljs-operator">=</span> convertor.toPdf(<span class="hljs-string">"http://127.0.0.1:8080/page/index"</span>);
    pdf.save(response.getOutputStream());
}
</code></pre>
<p><strong>注意事项</strong></p>
<p><code>playwrigh</code>是基于浏览器引擎的，首次调用会下载默认的浏览器，下载完成之后，后续的使用就流畅了。而且默认支持中文，因为使用浏览器引擎，所以对于<code>Html</code>和<code>Css</code>支持较好。但是消耗资源较高。</p>
<p>但是这里<code>convertor.toPdf()</code>目前支持传入地址和文件。不支持直接<code>html</code>内容直接转化的。但是<code>playwrigh</code>本身是支持的。</p>
<p>小编已经给<code>x-easypdf</code>作者提了<code>issues</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdromara%2Fx-easypdf%2Fissues%2FID59TK" target="_blank" title="https://gitee.com/dromara/x-easypdf/issues/ID59TK" ref="nofollow noopener noreferrer">gitee.com/dromara/x-e…</a></p>
<p>**注意：**截止发稿，官方已经在<code>3.5.0</code>版本支持了<code>html</code>内容转<code>Pdf</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d21ec3c6eb54a7daec64c339549b078~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=7kcF1hIUJPoWys6g%2FV4yWOgDTtA%3D" alt="" loading="lazy"/></p>
<p><strong>实战代码02</strong></p>
<p>使用模板引擎的方式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90c01f3689904b9ab9a5bb5301649a2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763604775&amp;x-signature=2pIfLVnU7TbdmZd1c3Q33%2BohlO4%3D" alt="" loading="lazy"/></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx-easypdf.cn%2Fguide%2Fpdfbox%2Fadvance%2Ftemplater%2F%25E6%25A8%25A1%25E6%259D%25BF%25E5%25BC%2595%25E6%2593%258E.html%23thymeleaf" target="_blank" title="https://x-easypdf.cn/guide/pdfbox/advance/templater/%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E.html#thymeleaf" ref="nofollow noopener noreferrer">x-easypdf.cn/guide/pdfbo…</a></p>
<p>依然是建立在<code>playwrigh</code>基础之上。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("index12")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index12</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
        Map&lt;String, Object&gt; item = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        item.put(<span class="hljs-string">"image1"</span>, <span class="hljs-string">"http://example.com/2eb97.jpg"</span>);
        item.put(<span class="hljs-string">"image2"</span>, <span class="hljs-string">"http://example.com/2f9c3.jpg"</span>);
        item.put(<span class="hljs-string">"vehicleName"</span>, <span class="hljs-string">"路虎Defender［卫士］（进口）2023款Defender130 48V［卫士 130 48V] 3.0T手自－体P400 HSE"</span>);
        item.put(<span class="hljs-string">"brandName"</span>, <span class="hljs-string">"路虎"</span>);
        item.put(<span class="hljs-string">"seriesName"</span>, <span class="hljs-string">"Defender［卫士］"</span>);
        item.put(<span class="hljs-string">"modelYear"</span>, <span class="hljs-string">"2023款"</span>);
        item.put(<span class="hljs-string">"licenseYear"</span>, SDF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
        item.put(<span class="hljs-string">"displayMileage"</span>, DF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"9657"</span>)));
        item.put(<span class="hljs-string">"dealDate"</span>, SDF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
        item.put(<span class="hljs-string">"dealPrice"</span>, DF.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"702400"</span>)));

        item.put(<span class="hljs-string">"licenseCode"</span>, <span class="hljs-string">"沪A952714"</span>);

        list.add(item);
    }
    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    map.put(<span class="hljs-string">"list"</span>, list);

    <span class="hljs-type">ThymeleafTemplater</span> <span class="hljs-variable">templater</span> <span class="hljs-operator">=</span> PdfHandler.getDocumentTemplater().getThymeleafTemplater();
    templater.setTemplatePath(<span class="hljs-string">"templates"</span>);
    templater.setTemplateName(<span class="hljs-string">"index.html"</span>);
    templater.setTemplateData(map);

    <span class="hljs-comment">// 获取 html 内容</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> templater.getHtmlContent();
    System.out.println(content);

    <span class="hljs-comment">// 转换文档</span>
    <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> templater.transform();
    document.save(response.getOutputStream());
}
</code></pre>
<p>这里需要说明的是：由于<code>x-easypdf</code>自行解析了<code>Thymeleaf</code>模版，所以无法使用<code>spring-boot-starter-thymeleaf</code>的配置。<code>templatePath</code>和<code>templateName</code>都需要写完整。<code>templatePath</code>指<code>classpath</code>下的路径。</p>
<p>模板引擎可能会出现<code>nested exception is java.lang.NoClassDefFoundError: ognl/PropertyAccessor</code>的错误，需要引入<code>ognl</code>，且版本不能超过<code>3.2</code>。从 <code>3.2</code> 开始，会报<code>java.lang.NoClassDefFoundError: ognl/DefaultMemberAccess</code>。有效版本：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ognl<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ognl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>边距可以通过打印样式控制：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@page</span> {
    size: A4;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<h3 data-id="heading-7">3.3 <code>playwrigh</code>原生写法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("index11")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index11</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-keyword">try</span> (<span class="hljs-type">Playwright</span> <span class="hljs-variable">playwright</span> <span class="hljs-operator">=</span> Playwright.create();
         <span class="hljs-type">Browser</span> <span class="hljs-variable">browser</span> <span class="hljs-operator">=</span> playwright.chromium().launch()) {
        <span class="hljs-type">BrowserContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> browser.newContext();
        <span class="hljs-type">Page</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> context.newPage();

        <span class="hljs-comment">// 从HTML内容生成PDF</span>
        page.setContent(<span class="hljs-string">"&lt;h1&gt;Hello, Playwright!&lt;/h1&gt;"</span>);
        <span class="hljs-type">byte</span>[] pdf = page.pdf();

        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(pdf);
        IOUtils.copy(bais, response.getOutputStream());
    }
}
</code></pre>
<h2 data-id="heading-8">04 小结</h2>
<p><code>iText pdfHTML</code>内存占用低，转换速度快，适合服务器端批量处理。而<code>Playwright</code>需要更多资源，但渲染质量极高，适合对视觉保真度要求高的场景，所以<code>x-easypdf</code>也是一样的。如果只是针对<code>Html</code>转<code>Pdf</code>的服务端转化的场景<code>iText pdfHTML</code>的优势更明显一下，关键它快！</p>
<p>也有粉丝朋友留言说<code>jasperreports</code>也很好用，小编也试了一下。<code>jasperreports</code>需要加载特定的模板，也许是因为不是很熟悉，用起来感觉有点别扭。这里就不推荐了，有兴趣的可以去试试！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Valdi——一个提供原生性能的跨平台 UI 框架]]></title>    <link>https://juejin.cn/post/7571646669201899562</link>    <guid>https://juejin.cn/post/7571646669201899562</guid>    <pubDate>2025-11-12T12:09:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571646669201899562" data-draft-id="7571678388953923603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Valdi——一个提供原生性能的跨平台 UI 框架"/> <meta itemprop="keywords" content="UI Kit"/> <meta itemprop="datePublished" content="2025-11-12T12:09:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="这儿有一堆花"/> <meta itemprop="url" content="https://juejin.cn/user/3076912575965819"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Valdi——一个提供原生性能的跨平台 UI 框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3076912575965819/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    这儿有一堆花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:09:09.000Z" title="Wed Nov 12 2025 12:09:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffd2aef487764ddea9991cb145d12823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-Z5YS_5pyJ5LiA5aCG6Iqx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763554149&amp;x-signature=hy5qLlMfngLqhsBcuqNTafg%2BSN8%3D" alt="近距离代码屏幕" loading="lazy"/></p>
<p>从一个日报起头：移动端团队被要求在两周里把活动页同时上线 iOS、Android 和 macOS。时间紧，交互细，动画还不能掉帧。传统解法要么写三套原生界面，要么走“Web 容器”取巧，结果要么开发效率吃紧，要么性能打折。此时，一个名字近乎低调的框架闯进视野——<strong>Valdi</strong>。它把界面的声明式写法留在 TypeScript，把渲染权交给平台原生视图，试图把“效率与性能只能二选一”的旧逻辑翻过来。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<h2 data-id="heading-0">它到底是什么</h2>
<p>官方给出的定义非常直接：使用 <strong>声明式 TypeScript/TSX</strong> 写 UI，<strong>编译为 iOS、Android、macOS 的原生视图</strong>，<strong>不依赖 WebView，也没有传统 JS bridge</strong>。因此，列表滚动、复杂手势、系统级动画都沿用原生表现，避免“跨平台层”成为性能瓶颈。该框架在 Snap 的生产环境已经长期服役（内部使用达数年），如今以 <strong>MIT</strong> 许可证开源，当前对外标注为 <strong>Beta</strong>（主要是文档与工具链仍在对开源生态打磨）。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<p><strong>Valdi GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a></p>
<h2 data-id="heading-1">写法长什么样</h2>
<p>在 Valdi 里，界面被写成 TSX 组件。下面的示例展示了“声明—渲染—属性”这一套直觉式流程（语义与官方示例一致，但做了适度裁剪与注释）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// HelloWorld.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'valdi_core/src/Component'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">onRender</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> message = <span class="hljs-string">'Hello Valdi'</span>;
    <span class="hljs-comment">// 这里的 &lt;view&gt;、&lt;label&gt; 会被编译成平台原生视图（非 WebView）</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">backgroundColor</span>=<span class="hljs-string">"#FFFC00"</span> <span class="hljs-attr">padding</span>=<span class="hljs-string">{24}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"black"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>;
  }
}
</code></pre>
<p>这种写法的关键不在“看起来像 React”，而在“<strong>最终落地的是原生控件</strong>”。渲染层的工作交给平台本身，框架则在编译期与运行期开启一系列性能手段（视图池复用、按可视区域增量渲染、组件级别的独立重渲），尽量不把重负留在跨层通信上。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<p><strong>Valdi 文档与入门</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2Fb.3-VN0%2FP%2F3Np%2FvObOmBVmJvZ%2FDA0%2F2HMoD%2FQDw%2FNjDJAH3%2FL%2FTyYzwpNXD%2FA_0rM-Dtgj" target="_blank" title="https://jovial-fortune.com/b.3-VN0/P/3Np/vObOmBVmJvZ/DA0/2HMoD/QDw/NjDJAH3/L/TyYzwpNXD/A_0rM-Dtgj" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a>**</p>
<h2 data-id="heading-2">为什么在意“原生性能”</h2>
<p>跨平台 UI 的历史里，性能问题往往来自两处：
其一是 <strong>渲染容器</strong>——WebView 或自绘引擎在“贴近系统”上天生吃亏；其二是 <strong>桥接成本</strong>——当状态频繁变动、动画密集、列表超长时，跨语言/跨进程通信会变成隐形税。Valdi 的路径是**“把 UI 编译成原生控件”**，并围绕这个落点做优化：</p>
<ul>
<li>全局 <strong>视图池</strong> 回收与复用，降低视图创建/销毁成本；</li>
<li><strong>独立组件重渲</strong>，避免祖先节点无谓更新；</li>
<li><strong>可视区域感知</strong> 布局与渲染，天生适配长列表与分页；</li>
<li>布局引擎以 <strong>C++</strong> 实现并运行在主线程，减少跨层编组。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</li>
</ul>
<p>这些点不是花拳绣腿，而是移动端耗时热点的“直线突击”。在信息流、商城、消息类应用中尤其明显：首屏更快出现，滚动更稳，滑动手感更接近系统原生控件。</p>
<h2 data-id="heading-3">工程化与开发体验</h2>
<p>效率层面，Valdi 不只是在语法上“像 React”。它辅以 <strong>即时热重载</strong>（毫秒级见效）、<strong>VS Code 调试与性能剖析</strong>、与 <strong>Bazel</strong> 的集成以保障构建复用与可重复。需要原生接口时，可通过 <strong>多语言模块（Polyglot Modules）</strong> 生成 <strong>TypeScript ↔ Kotlin/Swift/ObjC</strong> 的类型安全绑定，既能复用既有原生库，又能把性能关键路径留在原生侧实现。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<p><strong>Bazel</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">bazel.build/</a></p>
<h2 data-id="heading-4">迁移与落地的“故事线”</h2>
<p>一个常见落地顺序是这样的：
先把一个<strong>独立页面</strong>或<strong>新功能入口</strong>用 Valdi 重写，内嵌到 UIKit/Android View 的树里做 A/B；性能验证后，再逐步扩大接入面。此时，原生与 Valdi 的<strong>双向嵌入</strong>能力（“在原生里放 Valdi 视图”与“在 Valdi 里嵌原生控件”）就像安全带，既不破坏既有工程，又给新栈足够的发挥空间。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<p>在数据通路上，团队可以把网络层、图片加载、埋点等继续留在原生模块里，通过类型安全的绑定暴露给 TypeScript。较重的计算（如协议编解码、复杂 diff、媒体管线）可以走 C++ 或平台原生语言；Valdi 提供的 <strong>worker 线程</strong> 能让 JS 侧在不阻塞 UI 的情况下完成部分并行任务。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<h2 data-id="heading-5">与“别的跨平台”的差异</h2>
<ul>
<li>与 <strong>WebView 系</strong>（Hybrid/H5）不同：渲染不是网页，UI 不是 DOM；因此滚动、手势、导航条这类系统元素更贴近平台期望。</li>
<li>与 <strong>桥接式 JS Runtime</strong>（重度依赖桥的方案）不同：Valdi 通过编译期把“声明式树”降解为原生视图，并尽量在渲染与布局阶段减少跨层通信频率。</li>
<li>与 <strong>纯自绘引擎</strong> 不同：Valdi 倾向“调系统控件”，从而继承各平台在无障碍、输入法、可达性、手势冲突处理等方面的成熟经验。以上差异点均来自其官方的渲染路线与性能要点描述。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</li>
</ul>
<p><strong>Hacker News 讨论帖</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2Fb.3-VN0%2FP%2F3Np%2FvObOmBVmJvZ%2FDA0%2F2HMoD%2FQDw%2FNjDJAH3%2FL%2FTyYzwpNXD%2FA_0rM-Dtgj" target="_blank" title="https://jovial-fortune.com/b.3-VN0/P/3Np/vObOmBVmJvZ/DA0/2HMoD/QDw/NjDJAH3/L/TyYzwpNXD/A_0rM-Dtgj" ref="nofollow noopener noreferrer">news.ycombinator.com/item?id=458…</a>**</p>
<h2 data-id="heading-6">一个更完整的页面例子</h2>
<p>下面构造一个稍微“像样”的列表页面：顶部标题、主题切换、可复用的 Cell，以及一个在可视区域内才渲染的长列表。逻辑演示为主：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Feed.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, state } <span class="hljs-keyword">from</span> <span class="hljs-string">'valdi_core/src/Component'</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Item</span> = { <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">subtitle</span>: <span class="hljs-built_in">string</span> };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">FeedCell</span>(<span class="hljs-params">props: { item: Item }</span>) {
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">padding</span>=<span class="hljs-string">{16}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{props.item.title}</span> <span class="hljs-attr">fontSize</span>=<span class="hljs-string">{17}</span> <span class="hljs-attr">weight</span>=<span class="hljs-string">"semibold"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{props.item.subtitle}</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#666"</span> <span class="hljs-attr">marginTop</span>=<span class="hljs-string">{6}</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Feed</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-meta">@state</span> <span class="hljs-keyword">private</span> dark = <span class="hljs-literal">false</span>;
  <span class="hljs-meta">@state</span> <span class="hljs-keyword">private</span> <span class="hljs-attr">items</span>: <span class="hljs-title class_">Item</span>[] = [];

  <span class="hljs-title function_">onMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 模拟异步请求</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">2000</span> }).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
      <span class="hljs-attr">id</span>: <span class="hljs-title class_">String</span>(i),
      <span class="hljs-attr">title</span>: <span class="hljs-string">`Card <span class="hljs-subst">${i}</span>`</span>,
      <span class="hljs-attr">subtitle</span>: <span class="hljs-string">`Valdi compiles to native views`</span>,
    }));
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">toggleTheme</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dark</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">dark</span>;
  }

  <span class="hljs-title function_">onRender</span>(<span class="hljs-params"/>) {
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">backgroundColor</span>=<span class="hljs-string">{this.dark</span> ? '#<span class="hljs-attr">111</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">fff</span>'}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">padding</span>=<span class="hljs-string">{16}</span> <span class="hljs-attr">direction</span>=<span class="hljs-string">"row"</span> <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span> <span class="hljs-attr">justify</span>=<span class="hljs-string">"space-between"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Explore"</span> <span class="hljs-attr">fontSize</span>=<span class="hljs-string">{20}</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onTap</span>=<span class="hljs-string">{()</span> =&gt;</span> this.toggleTheme()}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{this.dark</span> ? '<span class="hljs-attr">Light</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">Dark</span>'} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

      {/* 列表仅对可视区域进行增量渲染，长列表默认可流畅滚动 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">list</span>
        <span class="hljs-attr">data</span>=<span class="hljs-string">{this.items}</span>
        <span class="hljs-attr">keyFor</span>=<span class="hljs-string">{(it:</span> <span class="hljs-attr">Item</span>) =&gt;</span> it.id}
        renderItem={(it: Item) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">FeedCell</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{it}</span> /&gt;</span>}
        estimatedItemHeight={72}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>;
  }
}
</code></pre>
<p>这个例子对应了 Valdi 的三件“拿手活”：<strong>视图池复用</strong>（大量 Cell 循环利用）、<strong>组件级独立重渲</strong>（切换暗黑只让受影响区域更新）、以及<strong>按可视窗口渲染</strong>（大列表默认丝滑）。这些都在其 README 的性能段落中明确列出。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<h2 data-id="heading-7">风险与边界</h2>
<p>任何跨平台方案都不是“银弹”。Valdi 当前仍处 <strong>Beta</strong> 对外阶段，开源生态的文档、第三方组件、最佳实践沉淀需要时间；同时，团队需要具备原生与 TypeScript 并行的工程能力（特别是当接入平台能力、排查系统层问题时）。不过，从路线选择看，它将“性能优先”的矛盾点拉回到原生栈里，减少了“解释层/桥接层”把控体验的变量。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<hr/>
<p><strong>Valdi GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a>**
<strong>Valdi 入门与示例</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a>**
<strong>Bazel（构建工具）</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjovial-fortune.com%2FK42TvQ" target="_blank" title="https://jovial-fortune.com/K42TvQ" ref="nofollow noopener noreferrer">bazel.build/</a>**</p>
<hr/>
<h3 data-id="heading-8">小结</h3>
<p>Valdi 的价值主张并不花哨：<strong>用 TypeScript 写声明式 UI，把渲染交还给原生</strong>。这一取舍，使其在“多端一致与原生体验”之间取得少见的平衡。对于正在寻找“性能不妥协、又能快速迭代”的团队，这是值得严肃评估的一条技术路径。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
<blockquote>
<p>参考依据：框架定位、编译为原生视图、性能特性（视图池、布局引擎、可视区域渲染）、工程化能力（热重载、VS Code 调试、Bazel、多语言绑定）、开源许可与 Beta 状态等，均摘自 Valdi 官方 GitHub 仓库与开源发布信息。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" title="https://github.com/Snapchat/Valdi" target="_blank" ref="nofollow noopener noreferrer">GitHub</a>)</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-37、数字在升序数组中出现的次数]]></title>    <link>https://juejin.cn/post/7571781196297420809</link>    <guid>https://juejin.cn/post/7571781196297420809</guid>    <pubDate>2025-11-13T02:27:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571781196297420809" data-draft-id="7569910533508923411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-37、数字在升序数组中出现的次数"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-13T02:27:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-37、数字在升序数组中出现的次数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:27:28.000Z" title="Thu Nov 13 2025 02:27:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题目描述</h2>
<p>统计⼀个数字在升序数组中出现的次数。</p>
<p>示例1
输⼊：[1,2,3,3,3,3,4,5],3
返回值：4</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">线性遍历</h3>
<p>顺序遍历数组，遇到目标值就计数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">GetNumberOfK</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; array.length; i++) {
            <span class="hljs-keyword">if</span> (array[i] == k) {
                count++;
            }
            <span class="hljs-comment">// 由于数组有序，如果当前元素已大于k，可提前结束</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (array[i] &gt; k) {
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> count;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>​：O(n)，最坏情况下需要遍历整个数组</li>
<li>​<strong>空间复杂度</strong>​：O(1)，只使用常数级别额外空间</li>
</ul>
<h3 data-id="heading-3">二分查找+左右扫描法</h3>
<p>先使用二分查找定位到目标值，然后向两边扩展统计。</p>
<p>由于数组是有序的，可以明显看到是二分法。</p>
<p>第1步是找出数值为 k 的数的索引：
假设数组为 nums[] ，⼀开始的左边索引为 left = 0 ，右边界索引为 right = nums.length-1</p>
<ol>
<li>将数组分成两部分，中间的数为 nums[mid] 。第1部分为 [left,mid] ,第2部分为[mid+1,right]。</li>
<li>如果 nums[mid]&gt;k ,则说明 k 只可能存在前半部分中，对前半部分执⾏操作1。</li>
<li>如果 nums[mid]&lt;k ,则说明 k 只可能存在后半部分中，对后半部分执⾏操作1。</li>
<li>如果 nums[mid]=k ,直接返回当前索引 mid 。</li>
<li>如果 left &gt; right ,说明 k 不存在，则返回 -1 。</li>
</ol>
<p>找到索引之后，往两边扩展，同时统计k的个数，直到元素不等于 k 的时候停⽌。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b060f0fde494c77a3c1f34b60fcc121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763605647&amp;x-signature=aICGJGvTeAoApVvJr%2F3QY0dIq2w%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">GetNumberOfK</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = array.length - <span class="hljs-number">1</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 二分查找</span>
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (array[mid] &lt; k) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (array[mid] &gt; k) {
                right = mid - <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 找到目标值，向左右扩展统计</span>
                count = <span class="hljs-number">1</span>;
                <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> mid;
                
                <span class="hljs-comment">// 向左统计</span>
                <span class="hljs-keyword">while</span> (--temp &gt;= left &amp;&amp; array[temp] == k) {
                    count++;
                }
                
                <span class="hljs-comment">// 向右统计</span>
                temp = mid;
                <span class="hljs-keyword">while</span> (++temp &lt;= right &amp;&amp; array[temp] == k) {
                    count++;
                }
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> count;
    }
}
</code></pre>
<ul>
<li>​<strong>时间复杂度</strong>​：O(log n + k)，其中k是目标值出现次数。当目标值出现次数较少时效率接近O(log n)，但最坏情况（全部是目标值）退化为O(n)</li>
<li>​<strong>空间复杂度</strong>​：O(1)</li>
</ul>
<h3 data-id="heading-4">双二分查找法（推荐）</h3>
<p>分别使用二分查找找到目标值的起始和结束位置，计算区间长度，这是最优解法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">GetNumberOfK</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 找到第一个k的位置</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">firstIndex</span> <span class="hljs-operator">=</span> findFirstPosition(array, k);
        <span class="hljs-comment">// 找到最后一个k的位置</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">lastIndex</span> <span class="hljs-operator">=</span> findLastPosition(array, k);
        
        <span class="hljs-keyword">if</span> (firstIndex == -<span class="hljs-number">1</span> || lastIndex == -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 目标值不存在</span>
        }
        
        <span class="hljs-keyword">return</span> lastIndex - firstIndex + <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-comment">/**
     * 查找目标值的第一个出现位置
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findFirstPosition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = array.length - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (array[mid] &lt; k) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (array[mid] &gt; k) {
                right = mid - <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 关键：检查是否为第一个出现位置</span>
                <span class="hljs-keyword">if</span> (mid == <span class="hljs-number">0</span> || array[mid - <span class="hljs-number">1</span>] != k) {
                    <span class="hljs-keyword">return</span> mid;
                } <span class="hljs-keyword">else</span> {
                    right = mid - <span class="hljs-number">1</span>; <span class="hljs-comment">// 继续在左半部分查找</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到</span>
    }
    
    <span class="hljs-comment">/**
     * 查找目标值的最后一个出现位置
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findLastPosition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = array.length - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (array[mid] &lt; k) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (array[mid] &gt; k) {
                right = mid - <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 关键：检查是否为最后一个出现位置</span>
                <span class="hljs-keyword">if</span> (mid == array.length - <span class="hljs-number">1</span> || array[mid + <span class="hljs-number">1</span>] != k) {
                    <span class="hljs-keyword">return</span> mid;
                } <span class="hljs-keyword">else</span> {
                    left = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 继续在右半部分查找</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到</span>
    }
}
</code></pre>
<ul>
<li>​<strong>时间复杂度</strong>​：O(log n)，执行两次二分查找</li>
<li>​<strong>空间复杂度</strong>​：O(1)，只使用常数空间</li>
</ul>
<h3 data-id="heading-5">k±0.5边界查找法</h3>
<p>一种巧妙的解法，通过查找目标值边界的插入位置来计算出现次数。</p>
<p>由于数组元素都是整数，k-0.5和k+0.5正好是目标值范围的边界，它们的插入位置差值就是目标值出现次数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">GetNumberOfK</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 查找k+0.5的插入位置（第一个大于k的位置）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">upperBound</span> <span class="hljs-operator">=</span> findInsertPosition(array, k + <span class="hljs-number">0.5</span>);
        <span class="hljs-comment">// 查找k-0.5的插入位置（第一个大于等于k的位置）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">lowerBound</span> <span class="hljs-operator">=</span> findInsertPosition(array, k - <span class="hljs-number">0.5</span>);
        
        <span class="hljs-keyword">return</span> upperBound - lowerBound;
    }
    
    <span class="hljs-comment">/**
     * 在有序数组中查找目标值的插入位置
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findInsertPosition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">double</span> target)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = array.length - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (array[mid] &lt; target) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                right = mid - <span class="hljs-number">1</span>;
            }
        }
        <span class="hljs-keyword">return</span> left; <span class="hljs-comment">// 返回插入位置</span>
    }
}
</code></pre>
<ul>
<li>​<strong>时间复杂度</strong>​：O(log n)，两次二分查找</li>
<li>​<strong>空间复杂度</strong>​：O(1)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java + Spring 到 Python + FastAPI （一）]]></title>    <link>https://juejin.cn/post/7571743311519924233</link>    <guid>https://juejin.cn/post/7571743311519924233</guid>    <pubDate>2025-11-13T01:49:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571743311519924233" data-draft-id="7571621555513360438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java + Spring 到 Python + FastAPI （一）"/> <meta itemprop="keywords" content="Java,Python,Spring"/> <meta itemprop="datePublished" content="2025-11-13T01:49:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java + Spring 到 Python + FastAPI （一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:49:27.000Z" title="Thu Nov 13 2025 01:49:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Java 程序员越来越被唾弃，我看 BOSS 直聘上有的公司在要求里面明文写不要 Java 程序员，感觉自己受到了侮辱，一怒之下怒了一下，既然如此别怪我心狠手辣用 Python + FastAPI 把之前 Java + Spring 的项目重写一遍。</p>
</blockquote>
<p>此文涉及 MySQL、Kafka、Redis 组件和用户、资金、订单模块，整体从 Java 迁移到 Python 所需的知识点。</p>
<h2 data-id="heading-0">语言思维转换</h2>
<p>Java 的语法很臃肿，如果会 Java 再看其他语言简直降维打击，学起来没什么难度，顶多是底层的一些设计、架构不一样。</p>
<p>Python 是动态语言，比如</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 传统 Python</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b

add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)       <span class="hljs-comment"># 结果是 3</span>
add(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>)   <span class="hljs-comment"># 结果是 "ab"</span>
</code></pre>
<p>没有类型校验，没有运行前编译，看起来非常不安全。于是有了 <strong>Pydantic</strong>。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_with_hints</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> a + b
</code></pre>
<p>括号里面是参数，-&gt; int 是返回值，用了 Type Hints，相当于一种提示，让 Pydantic 读取到后进行校验和转换。</p>
<p>列举一个接口的例子，比如 Java</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 1. DTO 类 (POJO)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDTO</span> {
    
    <span class="hljs-comment">// 2. Validation (javax.validation)</span>
    <span class="hljs-meta">@NotNull</span>
    <span class="hljs-meta">@Size(min = 3, max = 50)</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@Min(18)</span>
    <span class="hljs-keyword">private</span> Integer age;
    
    <span class="hljs-comment">// Getters and Setters... (由 Jackson 用于序列化)</span>
}

<span class="hljs-comment">// 3. Controller (Jackson + Validation)</span>
<span class="hljs-meta">@PostMapping("/users")</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; createUser(<span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> CreateUserDTO userDTO) {
    <span class="hljs-comment">// 到了这里，userDTO 已经被 Jackson 解析，并被 Validation 校验过了</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>而 Python + FastAPI + Pydantic 是</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span> <span class="hljs-comment"># 对应 Java 的 Optional 或 null</span>

<span class="hljs-comment"># 1. Pydantic 模型 (这一个东西 = Java 的 DTO + Validation + Jackson 注解)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDTO</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-comment"># 对应 @NotNull 和 @Size</span>
    username: <span class="hljs-built_in">str</span> = Field(..., min_length=<span class="hljs-number">3</span>, max_length=<span class="hljs-number">50</span>) 
    
    <span class="hljs-comment"># 对应 @Min(18) 和 可选 (Integer 而非 int)</span>
    age: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(<span class="hljs-literal">None</span>, ge=<span class="hljs-number">18</span>) <span class="hljs-comment"># ge = Greater than or Equal</span>
    
    <span class="hljs-comment"># 注意：</span>
    <span class="hljs-comment"># 1. ... (三个点) 表示这个字段是必填的</span>
    <span class="hljs-comment"># 2. Field(None, ...) 表示这个字段是可选的 (默认值为 None)</span>


<span class="hljs-comment"># 2. FastAPI 路由</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/users"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">user_dto: CreateUserDTO</span>):
    <span class="hljs-comment"># 到了这里，Pydantic 已经自动完成了：</span>
    <span class="hljs-comment"># 1. 读取 JSON 请求体 (像 Jackson)</span>
    <span class="hljs-comment"># 2. 按照类型提示 (str, int) 校验和转换数据</span>
    <span class="hljs-comment"># 3. 运行校验规则 (min_length, ge) (像 javax.validation)</span>
    <span class="hljs-comment"># 4. 如果校验失败，自动返回一个 422 错误的 JSON 响应</span>
    
    <span class="hljs-comment"># 你可以直接使用这个对象</span>
    <span class="hljs-comment"># user_dto.username </span>
    
    <span class="hljs-keyword">return</span> user_dto
</code></pre>
<p>Python 里面的 <strong>Optional</strong> 和 Java 里面是同一个意思，写法不一样，Python 里面把八大基本类型的包装类也用 Optional 表示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09813d413aa4300af942eafd2e30064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603367&amp;x-signature=Avor%2BvoN0Zvf4%2B%2FRe4EW%2F35%2FhNQ%3D" alt="image.png" loading="lazy"/></p>
<p>Python 里没有 Lombok，直接.属性就行。</p>
<h2 data-id="heading-1">并发模型</h2>
<p>这是 Java 和 Python 最大的不同，Java 是多线程，在 Spring Web 中一个请求就是一个线程（非 WebFlux），Tomcat 里面配置最大线程数就这个作用。线程内是阻塞的，比如查数据库线程就停那了，等待数据完成了继续执行。</p>
<p>Python 用的 asyncio 单线程事件循环。查数据库的时候，线程去执行别的，直到数据拿到了再接着执行。（具体流程后面详细分解）</p>
<p>比如这个接口逻辑</p>
<ul>
<li>
<p>查用户</p>
</li>
<li>
<p>查商品</p>
</li>
<li>
<p>写订单</p>
</li>
<li>
<p>写订单详情</p>
</li>
</ul>
<p>Java 是</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 线程 1</span>
<span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(...)</span> {
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepo.findById(...);      <span class="hljs-comment">// (线程 1 阻塞，等待 5ms)</span>
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productRepo.findById(...); <span class="hljs-comment">// (线程 1 阻塞，等待 5ms)</span>
    
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(...);
    orderRepo.save(order);                   <span class="hljs-comment">// (线程 1 阻塞，等待 10ms)</span>
    
    <span class="hljs-type">OrderDetail</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetail</span>(...);
    detailRepo.save(detail);                 <span class="hljs-comment">// (线程 1 阻塞，等待 10ms)</span>
    
    <span class="hljs-keyword">return</span> order; <span class="hljs-comment">// 总耗时：5+5+10+10 = 30ms (线程 1 被独占 30ms)</span>
}
</code></pre>
<p>Python 是</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 单个事件循环线程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_order</span>(<span class="hljs-params">...</span>):
    <span class="hljs-comment"># 'await'：我把控制权交回事件循环</span>
    user = <span class="hljs-keyword">await</span> user_repo.get_by_id(...)      <span class="hljs-comment"># (I/O 开始，任务暂停)</span>
    
    <span class="hljs-comment"># ... 某个未来的时刻，事件循环恢复了我的执行 ...</span>
    
    product = <span class="hljs-keyword">await</span> product_repo.get_by_id(...) <span class="hljs-comment"># (I/O 开始，任务再次暂停)</span>
    
    <span class="hljs-comment"># ... 再次恢复 ...</span>
    
    order = Order(...)
    <span class="hljs-keyword">await</span> order_repo.save(order)              <span class="hljs-comment"># (I/O 开始，任务再次暂停)</span>
    
    <span class="hljs-comment"># ... 再次恢复 ...</span>
    
    detail = OrderDetail(...)
    <span class="hljs-keyword">await</span> detail_repo.save(detail)            <span class="hljs-comment"># (I/O 开始，任务再次暂停)</span>
    
    <span class="hljs-comment"># ... 再次恢复 ...</span>
    
    <span class="hljs-keyword">return</span> order <span class="hljs-comment"># 总耗时：还是 30ms (I/O 总时间)</span>
</code></pre>
<p>这导致的第一重大变化是 ThreadLocal 没了，之前用户登录的 token 可以用 AOP 一路带到线程里，在 Python 里面用 FastAPI 的 Depends 解决，后面想说。</p>
<p>第二个是 async 必须全程到底，一个方法用了，所有上下游调用都用，外部的 MySQL、Kafka 这种组件也要用 async 的版本。</p>
<h3 data-id="heading-2">那为什么 Python 是单线程的？</h3>
<p>主要是 Python 的 RAM 内存管理用的 GLC（Global Interpreter Lock），不像 Java 有复杂的 GC 垃圾回收机制，GLC 在用到对象的<strong>引用计数</strong> + 1，没用到 -1，为 0 则清理，为了防止多线程 RAM 内存出问题，有了 GLC。</p>
<p>asyncio 就是用单线程多进程（协程）的方式，提高并发。</p>
<h3 data-id="heading-3">进程、线程、协程有什么区别？</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a689179bade9434cae7cd1f6252b9abe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603367&amp;x-signature=0raHfLx%2BwpAwgQE2B%2BCEQFa756A%3D" alt="image.png" loading="lazy"/></p>
<p>打开 Win 的任务管理器，最外层的 Micosoft Edge 就一个进程，括号里的 18 就是 18 的线程，协程一种特殊的线程，可以很快速的在不同任务之间切换，asyncio 里面这么叫。</p>
<h3 data-id="heading-4">Python + asyncio 这么搞效率岂不是很低？多核处理器怎么办？</h3>
<p>其实 CPU 的速度是远超 IO 的，老早之前单核 CPU 就有时间切片模拟成多核，服务器大都是 IO 密集型，卡在查 MySQL、Kafka、Redis 等，这样其实更高效。</p>
<p>每个线程的启动都要消耗几 M 的 RAM，线程上下文切换也比较耗资源，进程之间效率高得多。</p>
<p>线上真实的多核处理器服务器，会用进程管理器 <strong>Gunicorn</strong> 根据服务器核心数启动多个 Python 进程，由 Gunicorn 将请求分发。</p>
<h3 data-id="heading-5">asyncio 的原理</h3>
<p>asyncio 底层有两个组件，<strong>Ready Queue</strong> 和 <strong>Waiting Map</strong>。Ready Queue 是可以立即执行的队列，Waiting Map 是异步等待唤醒的任务。</p>
<p>以为一个请求流程为例</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_order</span>(<span class="hljs-params">...</span>):
    <span class="hljs-comment"># 你的代码从这里开始执行</span>
    user_data = <span class="hljs-keyword">await</span> request.json()  <span class="hljs-comment"># 假设这是第一个 await (I/O)</span>
    ...
</code></pre>
<p>这些代码都先当做任务放到 Ready Queue，直到遇到第一个 await 则暂停，把任务移动到 Waiting Map，然后从 Ready Queue 取下一个任务执行。直到所有的 Ready Queue 都执行完成。</p>
<p>一个是 Queue 一个是 Map，Queue 存的是任务，Map 中存的是任务 + 回调，这样数据回调的时候知道去执行哪个任务。</p>
<p>await 交给操作系统系统 OS 处理，在日常开发中比如付款场景等支付宝回调，在这里类似。</p>
<p>await 告诉操作系统帮我查下 MySQL，有结果了通知我。但不同的操作系统通知方式不一样，Mac UNIX 的 kqueue、Linux 的 epoll 属于<strong>Reactor 的就绪通知</strong>，Win 的 IOPC 属于<strong>Proactor 的回调</strong>。</p>
<p>他俩区别是系统 OS 层的，涉及网卡、数据流那些，Proactor 帮忙把数据流复制了一份，Reactor 则自己去 read() write()，代码层面没有区别，asyncio 已经帮忙封装好了，根据操作系统自动调用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第二节 Node.js 项目实践 - 使用 nvm 安装 Node.js]]></title>    <link>https://juejin.cn/post/7571695634942492699</link>    <guid>https://juejin.cn/post/7571695634942492699</guid>    <pubDate>2025-11-12T16:38:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571695634942492699" data-draft-id="7571662618056081434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第二节 Node.js 项目实践 - 使用 nvm 安装 Node.js"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T16:38:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="undefined在掘金39041"/> <meta itemprop="url" content="https://juejin.cn/user/1081575171951485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第二节 Node.js 项目实践 - 使用 nvm 安装 Node.js
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575171951485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    undefined在掘金39041
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T16:38:17.000Z" title="Wed Nov 12 2025 16:38:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>课程的第 2 回：使用 nvm 安装 Node.js，在这节课里，我们将探讨：</p>
<ul>
<li>为何要用 nvm？</li>
<li>Windows 和 macOS 安装 nvm 的方式</li>
<li>使用 nvm 安装 Node.js</li>
<li>如何切换 Node.js 的版本</li>
<li>配置 npm 中国镜像</li>
</ul>
<p>开发<code>Node.js</code>，首先就必须要安装<code>Node.js</code>自身。如果你已经安装好了<code>Node.js</code>了，可以略过本节课程，直接开始学习开发。</p>
<h2 data-id="heading-0"><em>1. 为何要用 nvm ？</em></h2>
<p>安装<code>Node.js</code>，最简单办法，就是直接在<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2F" target="_blank" title="https://nodejs.org/en/" ref="nofollow noopener noreferrer">官网</a>下载了安装。但这种方法，却不是最好的办法。因为如果需要更新<code>Node.js</code>的版本，那就需要把之前的卸载了，再去下载安装其他版本，这样就非常的麻烦了。</p>
<p>这里推荐大家使用<code>nvm</code>来安装，可以使用它来安装多个不同版本的<code>Node.js</code>，并且根据需要随意的切换所需版本。</p>
<h2 data-id="heading-1"><em>2. Windows 安装 nvm-windows</em></h2>
<p>Windows 与 macOS 的安装方法有些不同。Windows 的同学，请在这里下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoreybutler%2Fnvm-windows%2F" target="_blank" title="https://github.com/coreybutler/nvm-windows/" ref="nofollow noopener noreferrer">github.com/coreybutler…</a>了，直接安装就好 ，然后点击右侧的 <code>Releases</code>，这里就是下载的地方了。接着，找到最新版本，选择<code>nvm-setup.exe</code>下载。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17ad2cbedddc4a7288f531a2ceda55db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdW5kZWZpbmVk5Zyo5o6Y6YeRMzkwNDE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570297&amp;x-signature=LaPTXUuFwGo3xZ5yXvWPW%2FJys0M%3D" alt="image.png" loading="lazy"/></p>
<p>下好后，就大家直接安装上，然后将自己电脑的<code>PowerShell</code>或者终端打开，运行<code>nvm</code>，只要出来东西了，就是安装好了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0ea5d8ea8114fe7a40b98113ccca2d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdW5kZWZpbmVk5Zyo5o6Y6YeRMzkwNDE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570297&amp;x-signature=bIIQWo8lbRVVDkS52b%2F3s5dfsrQ%3D" alt="image.png" loading="lazy"/></p>
<p>注意：Windows 有可能碰到错误提示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b97f58e81fa485d868993283da138c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdW5kZWZpbmVk5Zyo5o6Y6YeRMzkwNDE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763570297&amp;x-signature=O%2F%2F8Yra%2FxNZvvK5ngmJ464j%2BtpU%3D" alt="image.png" loading="lazy"/></p>
<p>如果碰到这个错误，需要用<code>管理员身份</code>打开<code>PowerShell</code>，然后运行：</p>
<p>Set-ExecutionPolicy RemoteSigned</p>
<pre><code class="hljs language-js" lang="js"/></pre>
<p>再按<code>a</code>即可。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring事务在微服务架构中的实践与挑战]]></title>    <link>https://juejin.cn/post/7571749988080173065</link>    <guid>https://juejin.cn/post/7571749988080173065</guid>    <pubDate>2025-11-12T19:30:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571749988080173065" data-draft-id="7570984257665957934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring事务在微服务架构中的实践与挑战"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-12T19:30:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大头an"/> <meta itemprop="url" content="https://juejin.cn/user/618374030438861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring事务在微服务架构中的实践与挑战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/618374030438861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大头an
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T19:30:18.000Z" title="Wed Nov 12 2025 19:30:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>在微服务架构中，传统的单体数据库事务不再适用。每个微服务拥有独立的数据存储，如何保证跨服务的数据一致性？如何设计可靠的事务方案？本文将深入探讨微服务架构下的事务挑战，并介绍多种分布式事务解决方案。</p>
</blockquote>
<h2 data-id="heading-1">微服务事务的挑战</h2>
<h3 data-id="heading-2">1. 传统ACID事务的局限性</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 单体应用中的事务 - 在微服务中无法实现</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonolithicOrderService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 所有操作在同一个数据库事务中</span>
        orderRepository.save(order);           <span class="hljs-comment">// 订单库</span>
        inventoryService.deductStock(order);   <span class="hljs-comment">// 库存库  </span>
        accountService.deductBalance(order);   <span class="hljs-comment">// 账户库</span>
        notificationService.sendEmail(order);  <span class="hljs-comment">// 通知服务</span>
        <span class="hljs-comment">// 要么全部成功，要么全部回滚</span>
    }
}
</code></pre>
<p><strong>微服务中的问题</strong>：</p>
<ul>
<li>每个服务有独立的数据库</li>
<li>无法使用传统的数据库事务</li>
<li>网络调用可能失败</li>
<li>服务可能不可用</li>
</ul>
<h3 data-id="heading-3">2. CAP定理的影响</h3>
<p>在分布式系统中，只能同时满足以下两个：</p>
<ul>
<li><strong>一致性 (Consistency)</strong>：所有节点看到相同的数据</li>
<li><strong>可用性 (Availability)</strong>：每个请求都能获得响应</li>
<li><strong>分区容错性 (Partition Tolerance)</strong>：系统在网络分区时仍能工作</li>
</ul>
<p>微服务架构通常选择<strong>AP + 最终一致性</strong>。</p>
<h2 data-id="heading-4">分布式事务模式</h2>
<h3 data-id="heading-5">1. 两阶段提交 (2PC)</h3>
<p><strong>模式描述</strong>：协调者协调多个参与者，分准备和提交两个阶段。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 2PC 协调者实现示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TwoPhaseCommitCoordinator</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryService inventoryService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountService accountService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderDistributed</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> generateTransactionId();
        List&lt;Participant&gt; participants = Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Participant</span>(<span class="hljs-string">"order"</span>, () -&gt; orderService.prepareCreate(order, transactionId)),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Participant</span>(<span class="hljs-string">"inventory"</span>, () -&gt; inventoryService.prepareDeduct(order, transactionId)),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Participant</span>(<span class="hljs-string">"account"</span>, () -&gt; accountService.prepareDeduct(order, transactionId))
        );
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 阶段一：准备阶段</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">allPrepared</span> <span class="hljs-operator">=</span> preparePhase(participants, transactionId);
            
            <span class="hljs-keyword">if</span> (allPrepared) {
                <span class="hljs-comment">// 阶段二：提交阶段</span>
                commitPhase(participants, transactionId);
                log.info(<span class="hljs-string">"分布式事务提交成功: {}"</span>, transactionId);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 阶段二：回滚阶段</span>
                rollbackPhase(participants, transactionId);
                log.warn(<span class="hljs-string">"分布式事务回滚: {}"</span>, transactionId);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            rollbackPhase(participants, transactionId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistributedTransactionException</span>(<span class="hljs-string">"分布式事务执行失败"</span>, e);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preparePhase</span><span class="hljs-params">(List&lt;Participant&gt; participants, String transactionId)</span> {
        <span class="hljs-keyword">for</span> (Participant participant : participants) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">prepared</span> <span class="hljs-operator">=</span> participant.prepare();
                <span class="hljs-keyword">if</span> (!prepared) {
                    log.warn(<span class="hljs-string">"参与者准备失败: {}, 事务: {}"</span>, participant.getName(), transactionId);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"参与者准备异常: {}, 事务: {}"</span>, participant.getName(), transactionId, e);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commitPhase</span><span class="hljs-params">(List&lt;Participant&gt; participants, String transactionId)</span> {
        <span class="hljs-keyword">for</span> (Participant participant : participants) {
            <span class="hljs-keyword">try</span> {
                participant.commit();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 提交阶段失败需要人工干预</span>
                log.error(<span class="hljs-string">"参与者提交失败: {}, 事务: {}"</span>, participant.getName(), transactionId, e);
                <span class="hljs-comment">// 记录异常，需要补偿</span>
                recordCompensationTask(participant.getName(), transactionId, <span class="hljs-string">"COMMIT"</span>);
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollbackPhase</span><span class="hljs-params">(List&lt;Participant&gt; participants, String transactionId)</span> {
        <span class="hljs-keyword">for</span> (Participant participant : participants) {
            <span class="hljs-keyword">try</span> {
                participant.rollback();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"参与者回滚失败: {}, 事务: {}"</span>, participant.getName(), transactionId, e);
                <span class="hljs-comment">// 记录异常，需要补偿</span>
                recordCompensationTask(participant.getName(), transactionId, <span class="hljs-string">"ROLLBACK"</span>);
            }
        }
    }
}

<span class="hljs-comment">// 参与者接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Participant</span> {
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span>;
}
</code></pre>
<h3 data-id="heading-6">2. Saga模式</h3>
<p><strong>模式描述</strong>：将分布式事务拆分为一系列本地事务，每个事务都有对应的补偿操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Saga 协调者实现</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SagaCoordinator</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SagaStepExecutor stepExecutor;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SagaStateRepository stateRepository;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeOrderSaga</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sagaId</span> <span class="hljs-operator">=</span> generateSagaId();
        <span class="hljs-type">SagaState</span> <span class="hljs-variable">sagaState</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaState</span>(sagaId, order);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 定义Saga步骤</span>
            List&lt;SagaStep&gt; steps = Arrays.asList(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaStep</span>(<span class="hljs-string">"create_order"</span>, 
                    () -&gt; stepExecutor.createOrder(order, sagaId),
                    () -&gt; stepExecutor.compensateOrder(order, sagaId)),
                    
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaStep</span>(<span class="hljs-string">"deduct_inventory"</span>,
                    () -&gt; stepExecutor.deductInventory(order, sagaId), 
                    () -&gt; stepExecutor.compensateInventory(order, sagaId)),
                    
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaStep</span>(<span class="hljs-string">"deduct_balance"</span>,
                    () -&gt; stepExecutor.deductBalance(order, sagaId),
                    () -&gt; stepExecutor.compensateBalance(order, sagaId)),
                    
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaStep</span>(<span class="hljs-string">"send_notification"</span>,
                    () -&gt; stepExecutor.sendNotification(order, sagaId),
                    <span class="hljs-literal">null</span>) <span class="hljs-comment">// 最后一步不需要补偿</span>
            );
            
            <span class="hljs-comment">// 执行Saga</span>
            executeSagaSteps(steps, sagaState);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Saga执行失败: {}"</span>, sagaId, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SagaException</span>(<span class="hljs-string">"订单创建失败"</span>, e);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeSagaSteps</span><span class="hljs-params">(List&lt;SagaStep&gt; steps, SagaState sagaState)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; steps.size(); i++) {
            <span class="hljs-type">SagaStep</span> <span class="hljs-variable">step</span> <span class="hljs-operator">=</span> steps.get(i);
            sagaState.setCurrentStep(step.getName());
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行正向操作</span>
                step.execute();
                sagaState.recordSuccess(step.getName());
                
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"Saga步骤执行失败: {}, 步骤: {}"</span>, sagaState.getSagaId(), step.getName(), e);
                sagaState.recordFailure(step.getName(), e.getMessage());
                
                <span class="hljs-comment">// 执行补偿操作</span>
                compensatePreviousSteps(steps, i, sagaState);
                <span class="hljs-keyword">break</span>;
            }
        }
        
        <span class="hljs-comment">// 保存Saga状态</span>
        stateRepository.save(sagaState);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compensatePreviousSteps</span><span class="hljs-params">(List&lt;SagaStep&gt; steps, <span class="hljs-type">int</span> failedIndex, SagaState sagaState)</span> {
        <span class="hljs-comment">// 从失败步骤的前一步开始反向补偿</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> failedIndex - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-type">SagaStep</span> <span class="hljs-variable">step</span> <span class="hljs-operator">=</span> steps.get(i);
            <span class="hljs-keyword">if</span> (step.getCompensate() != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    step.compensate();
                    sagaState.recordCompensation(step.getName());
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.error(<span class="hljs-string">"Saga补偿操作失败: {}, 步骤: {}"</span>, sagaState.getSagaId(), step.getName(), e);
                    sagaState.recordCompensationFailure(step.getName(), e.getMessage());
                    <span class="hljs-comment">// 补偿失败需要人工干预</span>
                }
            }
        }
    }
}

<span class="hljs-comment">// Saga步骤定义</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SagaStep</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Runnable execute;
    <span class="hljs-keyword">private</span> Runnable compensate;
}
</code></pre>
<h3 data-id="heading-7">3. TCC模式 (Try-Confirm-Cancel)</h3>
<p><strong>模式描述</strong>：每个服务提供Try、Confirm、Cancel三个接口。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TCC 订单服务实现</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TccOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TccTransactionRepository tccRepository;
    
    <span class="hljs-comment">// Try阶段：预留资源</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryCreateOrder</span><span class="hljs-params">(Order order, String transactionId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 检查业务约束</span>
            validateOrder(order);
            
            <span class="hljs-comment">// 创建预订单状态</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">pendingOrder</span> <span class="hljs-operator">=</span> order.toPending(transactionId);
            orderRepository.save(pendingOrder);
            
            <span class="hljs-comment">// 记录TCC状态</span>
            <span class="hljs-type">TccTransaction</span> <span class="hljs-variable">tcc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TccTransaction</span>(transactionId, <span class="hljs-string">"order"</span>, <span class="hljs-string">"CREATE"</span>);
            tccRepository.save(tcc);
            
            log.info(<span class="hljs-string">"订单Try阶段成功: {}"</span>, transactionId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"订单Try阶段失败: {}"</span>, transactionId, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">// Confirm阶段：确认操作</span>
    <span class="hljs-meta">@Transactional</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirmCreateOrder</span><span class="hljs-params">(String transactionId)</span> {
        <span class="hljs-type">TccTransaction</span> <span class="hljs-variable">tcc</span> <span class="hljs-operator">=</span> tccRepository.findByTransactionIdAndService(transactionId, <span class="hljs-string">"order"</span>);
        <span class="hljs-keyword">if</span> (tcc == <span class="hljs-literal">null</span> || !<span class="hljs-string">"CREATE"</span>.equals(tcc.getAction())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TccException</span>(<span class="hljs-string">"无效的TCC事务: "</span> + transactionId);
        }
        
        <span class="hljs-comment">// 更新订单状态为确认</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">pendingOrder</span> <span class="hljs-operator">=</span> orderRepository.findByTransactionId(transactionId);
        <span class="hljs-keyword">if</span> (pendingOrder != <span class="hljs-literal">null</span>) {
            pendingOrder.confirm();
            orderRepository.save(pendingOrder);
            
            <span class="hljs-comment">// 删除TCC记录</span>
            tccRepository.delete(tcc);
        }
        
        log.info(<span class="hljs-string">"订单Confirm阶段成功: {}"</span>, transactionId);
    }
    
    <span class="hljs-comment">// Cancel阶段：取消操作</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelCreateOrder</span><span class="hljs-params">(String transactionId)</span> {
        <span class="hljs-type">TccTransaction</span> <span class="hljs-variable">tcc</span> <span class="hljs-operator">=</span> tccRepository.findByTransactionIdAndService(transactionId, <span class="hljs-string">"order"</span>);
        <span class="hljs-keyword">if</span> (tcc == <span class="hljs-literal">null</span> || !<span class="hljs-string">"CREATE"</span>.equals(tcc.getAction())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TccException</span>(<span class="hljs-string">"无效的TCC事务: "</span> + transactionId);
        }
        
        <span class="hljs-comment">// 删除预订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">pendingOrder</span> <span class="hljs-operator">=</span> orderRepository.findByTransactionId(transactionId);
        <span class="hljs-keyword">if</span> (pendingOrder != <span class="hljs-literal">null</span>) {
            orderRepository.delete(pendingOrder);
            
            <span class="hljs-comment">// 删除TCC记录</span>
            tccRepository.delete(tcc);
        }
        
        log.info(<span class="hljs-string">"订单Cancel阶段成功: {}"</span>, transactionId);
    }
}
</code></pre>
<h2 data-id="heading-8">Spring Cloud分布式事务实践</h2>
<h3 data-id="heading-9">1. 使用Seata框架</h3>
<p><strong>Seata配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">seata:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">application-id:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_tx_group</span>
  <span class="hljs-attr">service:</span>
    <span class="hljs-attr">vgroup-mapping:</span>
      <span class="hljs-attr">my_tx_group:</span> <span class="hljs-string">default</span>
    <span class="hljs-attr">disable-global-transaction:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
</code></pre>
<p><strong>全局事务使用</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 订单服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeataOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryFeignClient inventoryFeignClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountFeignClient accountFeignClient;
    
    <span class="hljs-comment">// 开启全局事务</span>
    <span class="hljs-meta">@GlobalTransactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderWithSeata</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 1. 创建本地订单</span>
        orderMapper.insert(order);
        log.info(<span class="hljs-string">"本地订单创建成功"</span>);
        
        <span class="hljs-comment">// 2. 调用库存服务（远程服务）</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">inventoryResult</span> <span class="hljs-operator">=</span> inventoryFeignClient.deductStock(order.getItems());
        <span class="hljs-keyword">if</span> (!Boolean.TRUE.equals(inventoryResult)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存扣减失败"</span>);
        }
        log.info(<span class="hljs-string">"库存扣减成功"</span>);
        
        <span class="hljs-comment">// 3. 调用账户服务（远程服务）</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">accountResult</span> <span class="hljs-operator">=</span> accountFeignClient.deductBalance(order.getUserId(), order.getAmount());
        <span class="hljs-keyword">if</span> (!Boolean.TRUE.equals(accountResult)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"余额扣减失败"</span>);
        }
        log.info(<span class="hljs-string">"余额扣减成功"</span>);
        
        <span class="hljs-comment">// 4. 更新订单状态</span>
        order.complete();
        orderMapper.updateStatus(order);
        log.info(<span class="hljs-string">"订单状态更新完成"</span>);
    }
}

<span class="hljs-comment">// Feign客户端配置</span>
<span class="hljs-meta">@FeignClient(name = "inventory-service", path = "/api/inventory")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InventoryFeignClient</span> {
    
    <span class="hljs-meta">@PostMapping("/deduct")</span>
    Boolean <span class="hljs-title function_">deductStock</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;OrderItem&gt; items)</span>;
}

<span class="hljs-meta">@FeignClient(name = "account-service", path = "/api/account")</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountFeignClient</span> {
    
    <span class="hljs-meta">@PostMapping("/deduct")</span>
    Boolean <span class="hljs-title function_">deductBalance</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Long userId, <span class="hljs-meta">@RequestParam</span> BigDecimal amount)</span>;
}
</code></pre>
<h3 data-id="heading-10">2. 事务消息模式</h3>
<p><strong>基于RocketMQ的事务消息</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionMessageService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-comment">// 发送事务消息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderWithTransactionMessage</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 执行本地事务</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">savedOrder</span> <span class="hljs-operator">=</span> orderService.createOrderLocal(order);
        
        <span class="hljs-comment">// 发送事务消息</span>
        <span class="hljs-type">TransactionSendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> rocketMQTemplate.sendMessageInTransaction(
            <span class="hljs-string">"order-topic"</span>, 
            MessageBuilder.withPayload(order).build(),
            savedOrder.getId() <span class="hljs-comment">// 业务参数</span>
        );
        
        log.info(<span class="hljs-string">"事务消息发送结果: {}"</span>, result.getSendStatus());
    }
    
    <span class="hljs-comment">// 本地事务执行器</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeLocalTransaction</span><span class="hljs-params">(String transactionId, Long orderId)</span> {
        <span class="hljs-comment">// 查询订单状态</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.findById(orderId);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span> &amp;&amp; order.isPending()) {
            <span class="hljs-comment">// 更新订单为处理中</span>
            order.processing();
            orderService.updateOrder(order);
            log.info(<span class="hljs-string">"本地事务执行成功: {}"</span>, transactionId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单状态异常: "</span> + orderId);
        }
    }
    
    <span class="hljs-comment">// 事务回查</span>
    <span class="hljs-keyword">public</span> LocalTransactionState <span class="hljs-title function_">checkLocalTransaction</span><span class="hljs-params">(Message message)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> message.getTransactionId();
        <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> Long.valueOf(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody()));
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.findById(orderId);
            <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;
            }
            
            <span class="hljs-keyword">if</span> (order.isCompleted() || order.isProcessing()) {
                <span class="hljs-keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (order.isFailed()) {
                <span class="hljs-keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> LocalTransactionState.UNKNOW;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"事务回查异常: {}"</span>, transactionId, e);
            <span class="hljs-keyword">return</span> LocalTransactionState.UNKNOW;
        }
    }
}
</code></pre>
<h2 data-id="heading-11">事件驱动架构与最终一致性</h2>
<h3 data-id="heading-12">1. 基于事件的Saga实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 事件发布服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DomainEventPublisher</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> EventStoreRepository eventStoreRepository;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishWithTransaction</span><span class="hljs-params">(DomainEvent event)</span> {
        <span class="hljs-comment">// 存储事件（与业务操作在同一个事务中）</span>
        eventStoreRepository.save(event.toEventStore());
        
        <span class="hljs-comment">// 发布事件</span>
        eventPublisher.publishEvent(event);
        
        log.info(<span class="hljs-string">"领域事件发布: {}"</span>, event.getEventType());
    }
}

<span class="hljs-comment">// 订单创建事件</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreatedEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DomainEvent</span> {
    <span class="hljs-keyword">private</span> Long orderId;
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderCreatedEvent</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"ORDER_CREATED"</span>, order.getId().toString());
        <span class="hljs-built_in">this</span>.orderId = order.getId();
        <span class="hljs-built_in">this</span>.userId = order.getUserId();
        <span class="hljs-built_in">this</span>.amount = order.getAmount();
        <span class="hljs-built_in">this</span>.items = order.getItems();
    }
}

<span class="hljs-comment">// 事件处理器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreatedEventHandler</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryService inventoryService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountService accountService;
    
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreated</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        log.info(<span class="hljs-string">"处理订单创建事件: {}"</span>, event.getOrderId());
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 扣减库存</span>
            inventoryService.deductStock(event.getItems());
            log.info(<span class="hljs-string">"库存扣减成功: {}"</span>, event.getOrderId());
            
            <span class="hljs-comment">// 扣减余额</span>
            accountService.deductBalance(event.getUserId(), event.getAmount());
            log.info(<span class="hljs-string">"余额扣减成功: {}"</span>, event.getOrderId());
            
            <span class="hljs-comment">// 发布订单完成事件</span>
            eventPublisher.publish(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCompletedEvent</span>(event.getOrderId()));
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"订单处理失败: {}"</span>, event.getOrderId(), e);
            
            <span class="hljs-comment">// 发布订单失败事件</span>
            eventPublisher.publish(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderFailedEvent</span>(event.getOrderId(), e.getMessage()));
        }
    }
}
</code></pre>
<h3 data-id="heading-13">2. 事件溯源模式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 事件存储</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "event_store")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventStore</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String eventId;
    <span class="hljs-keyword">private</span> String aggregateId;
    <span class="hljs-keyword">private</span> String eventType;
    <span class="hljs-keyword">private</span> String eventData;
    <span class="hljs-keyword">private</span> LocalDateTime timestamp;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> version;
}

<span class="hljs-comment">// 聚合根基类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AggregateRoot</span> {
    <span class="hljs-keyword">protected</span> String id;
    <span class="hljs-keyword">protected</span> List&lt;DomainEvent&gt; changes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DomainEvent event)</span> {
        changes.add(event);
        handle(event);
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(DomainEvent event)</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">markChangesAsCommitted</span><span class="hljs-params">()</span> {
        changes.clear();
    }
    
    <span class="hljs-keyword">public</span> List&lt;DomainEvent&gt; <span class="hljs-title function_">getUncommittedChanges</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(changes);
    }
}

<span class="hljs-comment">// 订单聚合根</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderAggregate</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AggregateRoot</span> {
    <span class="hljs-keyword">private</span> OrderStatus status;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> Long userId;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderAggregate</span><span class="hljs-params">(String orderId, Long userId, BigDecimal amount)</span> {
        <span class="hljs-built_in">this</span>.id = orderId;
        <span class="hljs-built_in">this</span>.userId = userId;
        <span class="hljs-built_in">this</span>.amount = amount;
        <span class="hljs-built_in">this</span>.status = OrderStatus.CREATED;
        
        apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>(orderId, userId, amount));
    }
    
    <span class="hljs-comment">// 重建聚合根</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderAggregate</span><span class="hljs-params">(String orderId, List&lt;DomainEvent&gt; events)</span> {
        <span class="hljs-built_in">this</span>.id = orderId;
        <span class="hljs-keyword">for</span> (DomainEvent event : events) {
            handle(event);
            <span class="hljs-built_in">this</span>.version++;
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.status != OrderStatus.CREATED) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"订单状态异常"</span>);
        }
        <span class="hljs-built_in">this</span>.status = OrderStatus.COMPLETED;
        apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCompletedEvent</span>(<span class="hljs-built_in">this</span>.id));
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fail</span><span class="hljs-params">(String reason)</span> {
        <span class="hljs-built_in">this</span>.status = OrderStatus.FAILED;
        apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderFailedEvent</span>(<span class="hljs-built_in">this</span>.id, reason));
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(DomainEvent event)</span> {
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> OrderCreatedEvent) {
            handleOrderCreated((OrderCreatedEvent) event);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> OrderCompletedEvent) {
            handleOrderCompleted((OrderCompletedEvent) event);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> OrderFailedEvent) {
            handleOrderFailed((OrderFailedEvent) event);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreated</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        <span class="hljs-built_in">this</span>.userId = event.getUserId();
        <span class="hljs-built_in">this</span>.amount = event.getAmount();
        <span class="hljs-built_in">this</span>.status = OrderStatus.CREATED;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCompleted</span><span class="hljs-params">(OrderCompletedEvent event)</span> {
        <span class="hljs-built_in">this</span>.status = OrderStatus.COMPLETED;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderFailed</span><span class="hljs-params">(OrderFailedEvent event)</span> {
        <span class="hljs-built_in">this</span>.status = OrderStatus.FAILED;
    }
}
</code></pre>
<h2 data-id="heading-14">微服务事务监控</h2>
<h3 data-id="heading-15">1. 分布式链路追踪</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 事务链路追踪</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedTransactionTracingAspect</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Tracer tracer;
    
    <span class="hljs-meta">@Around("@annotation(globalTransactional)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">traceGlobalTransaction</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, 
                                       GlobalTransactional globalTransactional)</span> <span class="hljs-keyword">throws</span> Throwable {
        
        <span class="hljs-type">Span</span> <span class="hljs-variable">transactionSpan</span> <span class="hljs-operator">=</span> tracer.nextSpan().name(<span class="hljs-string">"global-transaction"</span>).start();
        
        <span class="hljs-keyword">try</span> (Tracer.<span class="hljs-type">SpanInScope</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> tracer.withSpanInScope(transactionSpan)) {
            <span class="hljs-comment">// 添加事务标签</span>
            transactionSpan.tag(<span class="hljs-string">"transaction.type"</span>, <span class="hljs-string">"global"</span>);
            transactionSpan.tag(<span class="hljs-string">"transaction.timeout"</span>, 
                String.valueOf(globalTransactional.timeoutMills()));
            
            <span class="hljs-comment">// 记录事务开始</span>
            log.info(<span class="hljs-string">"全局事务开始: {}"</span>, transactionSpan.context().traceId());
            
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();
            
            <span class="hljs-comment">// 记录事务成功</span>
            transactionSpan.finish();
            log.info(<span class="hljs-string">"全局事务完成: {}"</span>, transactionSpan.context().traceId());
            
            <span class="hljs-keyword">return</span> result;
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 记录事务失败</span>
            transactionSpan.error(e);
            transactionSpan.finish();
            log.error(<span class="hljs-string">"全局事务失败: {}"</span>, transactionSpan.context().traceId(), e);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}

<span class="hljs-comment">// 在Feign调用中传播追踪上下文</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignTracingConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Feign.Builder <span class="hljs-title function_">feignBuilder</span><span class="hljs-params">(Tracer tracer)</span> {
        <span class="hljs-keyword">return</span> Feign.builder()
            .client(<span class="hljs-keyword">new</span> <span class="hljs-title class_">feign</span>.Client.Default(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>))
            .requestInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ForwardedHeaderInterceptor</span>(tracer));
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardedHeaderInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestInterceptor</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Tracer tracer;
        
        ForwardedHeaderInterceptor(Tracer tracer) {
            <span class="hljs-built_in">this</span>.tracer = tracer;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(RequestTemplate template)</span> {
            <span class="hljs-type">Span</span> <span class="hljs-variable">currentSpan</span> <span class="hljs-operator">=</span> tracer.currentSpan();
            <span class="hljs-keyword">if</span> (currentSpan != <span class="hljs-literal">null</span>) {
                template.header(<span class="hljs-string">"X-B3-TraceId"</span>, currentSpan.context().traceIdString());
                template.header(<span class="hljs-string">"X-B3-SpanId"</span>, currentSpan.context().spanIdString());
                template.header(<span class="hljs-string">"X-B3-ParentSpanId"</span>, 
                    currentSpan.context().parentIdString());
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-16">2. 事务健康检查</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionHealthIndicator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HealthIndicator</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TransactionMetrics transactionMetrics;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DataSource dataSource;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Health <span class="hljs-title function_">health</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 检查数据库连接</span>
            checkDatabaseConnection();
            
            <span class="hljs-comment">// 检查事务指标</span>
            Map&lt;String, Object&gt; details = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            details.put(<span class="hljs-string">"activeTransactions"</span>, transactionMetrics.getActiveTransactionCount());
            details.put(<span class="hljs-string">"rollbackRate"</span>, transactionMetrics.getRollbackRate());
            details.put(<span class="hljs-string">"averageDuration"</span>, transactionMetrics.getAverageDuration());
            
            <span class="hljs-comment">// 判断健康状态</span>
            <span class="hljs-keyword">if</span> (transactionMetrics.getRollbackRate() &gt; <span class="hljs-number">0.1</span>) {
                <span class="hljs-keyword">return</span> Health.down()
                    .withDetails(details)
                    .withException(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"事务回滚率过高"</span>))
                    .build();
            }
            
            <span class="hljs-keyword">if</span> (transactionMetrics.getAverageDuration() &gt; <span class="hljs-number">5000</span>) {
                <span class="hljs-keyword">return</span> Health.down()
                    .withDetails(details)
                    .withException(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"事务执行时间过长"</span>))
                    .build();
            }
            
            <span class="hljs-keyword">return</span> Health.up().withDetails(details).build();
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> Health.down(e).build();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDatabaseConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> dataSource.getConnection()) {
            <span class="hljs-keyword">if</span> (!conn.isValid(<span class="hljs-number">5</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"数据库连接无效"</span>);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-17">最佳实践与模式选择</h2>
<h3 data-id="heading-18">1. 模式选择指南</h3>



































<table><thead><tr><th>场景</th><th>推荐模式</th><th>理由</th></tr></thead><tbody><tr><td>强一致性要求高</td><td>TCC模式</td><td>保证强一致性，性能较好</td></tr><tr><td>业务流程复杂</td><td>Saga模式</td><td>灵活，支持长业务流程</td></tr><tr><td>简单业务场景</td><td>事务消息</td><td>实现简单，最终一致性</td></tr><tr><td>已有Spring Cloud生态</td><td>Seata</td><td>集成简单，功能完善</td></tr><tr><td>事件驱动架构</td><td>事件溯源</td><td>天然匹配，审计友好</td></tr></tbody></table>
<h3 data-id="heading-19">2. 降级和容错策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircuitBreakerTransactionService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> InventoryService inventoryService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountService accountService;
    
    <span class="hljs-comment">// 使用断路器保护远程调用</span>
    <span class="hljs-meta">@CircuitBreaker(name = "inventoryService", fallbackMethod = "fallbackDeductInventory")</span>
    <span class="hljs-meta">@Retry(name = "inventoryService")</span>
    <span class="hljs-meta">@TimeLimiter(name = "inventoryService")</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title function_">deductInventoryWithProtection</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; 
            inventoryService.deductStock(order.getItems()));
    }
    
    <span class="hljs-comment">// 降级策略</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title function_">fallbackDeductInventory</span><span class="hljs-params">(Order order, Exception e)</span> {
        log.warn(<span class="hljs-string">"库存服务降级，订单进入待处理状态: {}"</span>, order.getId());
        
        <span class="hljs-comment">// 将订单标记为待处理，后续补偿</span>
        order.markAsPending();
        orderService.updateOrder(order);
        
        <span class="hljs-comment">// 发布待处理事件</span>
        eventPublisher.publish(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderPendingEvent</span>(order.getId()));
        
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-literal">true</span>);
    }
    
    <span class="hljs-comment">// 异步补偿任务</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-meta">@Scheduled(fixedDelay = 30000)</span> <span class="hljs-comment">// 每30秒执行一次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compensatePendingOrders</span><span class="hljs-params">()</span> {
        List&lt;Order&gt; pendingOrders = orderService.findPendingOrders();
        
        <span class="hljs-keyword">for</span> (Order order : pendingOrders) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 重试库存扣减</span>
                <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> inventoryService.deductStock(order.getItems());
                <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(result)) {
                    order.complete();
                    orderService.updateOrder(order);
                    log.info(<span class="hljs-string">"补偿处理成功: {}"</span>, order.getId());
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"补偿处理失败: {}"</span>, order.getId(), e);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-20">总结</h2>
<p>微服务架构下的事务管理是一个复杂但重要的话题：</p>
<h3 data-id="heading-21">核心要点：</h3>
<ol>
<li><strong>放弃强一致性</strong>，拥抱最终一致性</li>
<li><strong>选择合适的模式</strong>基于业务需求</li>
<li><strong>设计补偿机制</strong>处理失败场景</li>
<li><strong>实施全面监控</strong>确保系统可靠性</li>
</ol>
<h3 data-id="heading-22">技术选择：</h3>
<ul>
<li><strong>简单场景</strong>：事务消息、本地消息表</li>
<li><strong>复杂业务</strong>：Saga模式、TCC模式</li>
<li><strong>Spring Cloud生态</strong>：Seata框架</li>
<li><strong>事件驱动</strong>：事件溯源、CQRS</li>
</ul>
<h3 data-id="heading-23">成功关键：</h3>
<ol>
<li><strong>业务分析</strong>：理解业务真正的一致性需求</li>
<li><strong>渐进式实施</strong>：从简单模式开始，逐步复杂化</li>
<li><strong>监控告警</strong>：建立完善的监控体系</li>
<li><strong>团队协作</strong>：跨团队的事务协议设计</li>
</ol>
<p>记住，在微服务架构中，没有银弹解决方案。最重要的是根据具体业务场景选择最适合的事务策略。</p>
<hr/>
<p><strong>下期预告</strong>：《Spring 6 &amp; Spring Boot 3新特性：事务管理的革新》</p>
<p>如果觉得本文对你有帮助，请点赞、收藏、关注！欢迎在评论区分享你在微服务事务方面的实战经验和挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET 10 性能突破：持续优化才是质变关键]]></title>    <link>https://juejin.cn/post/7571751304624799790</link>    <guid>https://juejin.cn/post/7571751304624799790</guid>    <pubDate>2025-11-13T00:41:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571751304624799790" data-draft-id="7571678763781701666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET 10 性能突破：持续优化才是质变关键"/> <meta itemprop="keywords" content="后端,.NET,C#"/> <meta itemprop="datePublished" content="2025-11-13T00:41:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小码编匠"/> <meta itemprop="url" content="https://juejin.cn/user/1308876155395739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET 10 性能突破：持续优化才是质变关键
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1308876155395739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小码编匠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:41:19.000Z" title="Thu Nov 13 2025 00:41:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2025年11月12日，微软在.NET Conf 2025上正式发布了.NET 10。作为新一代长期支持（LTS）版本，它将获得长达三年的官方安全与服务支持，直至2028年11月10日。</p>
<p>官方称其为"迄今为止最高效、最现代、最安全、最智能、性能最高的 .NET 版本"。这并非营销话术——从底层运行时到高层语言特性，.NET 10通过数百项细微而精准的优化，在万亿次代码执行中累积出显著的性能飞跃。</p>
<p>软件性能的提升，往往不来自某个惊天动地的突破，而源于对细节的持续打磨。就像十九世纪的"冰王"弗雷德里克，靠改良绝缘材料、优化切割与物流，让冰块跨越半个地球抵达印度。</p>
<p>.NET 10的进化逻辑亦是如此：没有单一革命，只有系统性的微优化。这些优化看似微小——每次节省几纳秒、几十字节——却在高频调用场景下产生复合效应，最终带来质的飞跃。</p>
<h3 data-id="heading-1">一、LINQ 的语义级优化</h3>
<p>传统 LINQ 是机械执行操作链，而 .NET 10 让它"理解意图"。</p>
<p>例如，当开发写 OrderBy(...).Contains(...) 时，运行时会意识到"排序后再查找"实属多余，直接跳过排序步骤，直奔源数据搜索。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// dotnet run -c Release -f net9.0 --filter "*" --runtimes net9.0 net10.0</span>
<span class="hljs-keyword">using</span> BenchmarkDotNet.Attributes;
<span class="hljs-keyword">using</span> BenchmarkDotNet.Running;
BenchmarkSwitcher.FromAssembly(<span class="hljs-keyword">typeof</span>(Tests).Assembly).Run(args);
[<span class="hljs-meta">MemoryDiagnoser(displayGenColumns: false)</span>]
[<span class="hljs-meta">HideColumns(<span class="hljs-string">"Job"</span>, <span class="hljs-string">"Error"</span>, <span class="hljs-string">"StdDev"</span>, <span class="hljs-string">"Median"</span>, <span class="hljs-string">"RatioSD"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Tests</span>
{
    <span class="hljs-keyword">private</span> IEnumerable&lt;<span class="hljs-built_in">int</span>&gt; _source = Enumerable.Range(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>).ToArray();
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">AppendContains</span>()</span> =&gt; _source.Append(<span class="hljs-number">100</span>).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">ConcatContains</span>()</span> =&gt; _source.Concat(_source).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">DefaultIfEmptyContains</span>()</span> =&gt; _source.DefaultIfEmpty(<span class="hljs-number">42</span>).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">DistinctContains</span>()</span> =&gt; _source.Distinct().Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">OrderByContains</span>()</span> =&gt; _source.OrderBy(x =&gt; x).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">ReverseContains</span>()</span> =&gt; _source.Reverse().Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">UnionContains</span>()</span> =&gt; _source.Union(_source).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">SelectManyContains</span>()</span> =&gt; _source.SelectMany(x =&gt; _source).Contains(<span class="hljs-number">999</span>);
    [<span class="hljs-meta">Benchmark</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">WhereSelectContains</span>()</span> =&gt; _source.Where(x =&gt; <span class="hljs-literal">true</span>).Select(x =&gt; x).Contains(<span class="hljs-number">999</span>);
}
</code></pre>
<p>结果令人震撼：DistinctContains 耗时从 16,967 ns 降至 47 ns，内存从 58KB 降至 64 字节；OrderByContains 从 12,884 ns 降至 50 ns。这种优化本质是算法复杂度的降维——从 O(N log N) 回归 O(N)。</p>













































<table><thead><tr><th>Method</th><th>Runtime</th><th>Mean</th><th>Ratio</th><th>Allocated</th><th>Alloc Ratio</th></tr></thead><tbody><tr><td>DistinctContains</td><td>.NET 9.0</td><td>16,967.31 ns</td><td>1.000</td><td>58656 B</td><td>1.000</td></tr><tr><td>DistinctContains</td><td>.NET 10.0</td><td>46.72 ns</td><td>0.003</td><td>64 B</td><td>0.001</td></tr><tr><td>OrderByContains</td><td>.NET 9.0</td><td>12,884.28 ns</td><td>1.000</td><td>12280 B</td><td>1.000</td></tr><tr><td>OrderByContains</td><td>.NET 10.0</td><td>50.14 ns</td><td>0.004</td><td>88 B</td><td>0.007</td></tr></tbody></table>
<h4 data-id="heading-2">二、委托与局部函数的零分配优化</h4>
<p>闭包和委托曾是性能"黑洞"。.NET 10 的 JIT 编译器通过逃逸分析，发现委托未被外部引用时，直接内联调用，避免对象分配。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// dotnet run -c Release -f net9.0 --filter "*" --runtimes net9.0 net10.0</span>
<span class="hljs-keyword">using</span> BenchmarkDotNet.Attributes;
<span class="hljs-keyword">using</span> BenchmarkDotNet.Running;
[<span class="hljs-meta">DisassemblyDiagnoser</span>]
[<span class="hljs-meta">MemoryDiagnoser(displayGenColumns: false)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Tests</span>
{
    [<span class="hljs-meta">Benchmark</span>]
    [<span class="hljs-meta">Arguments(42)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Sum</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> y</span>)</span>
    {
        Func&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>&gt; addY = x =&gt; x + y;
        <span class="hljs-keyword">return</span> DoubleResult(addY, y);
    }
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> <span class="hljs-title">DoubleResult</span>(<span class="hljs-params">Func&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">int</span>&gt; func, <span class="hljs-built_in">int</span> arg</span>)</span>
    {
        <span class="hljs-built_in">int</span> result = func(arg);
        <span class="hljs-keyword">return</span> result + result;
    }
}
</code></pre>
<p>执行时间从 19.53 ns 降至 6.68 ns，内存从 88 B 降至 24 B。类似地，局部函数中的数组也被优化为栈分配，彻底消除堆分配。</p>
<h3 data-id="heading-3">三、去虚拟化与类型细化</h3>
<p>过去，数组通过接口（如 IList&lt; T&gt;）访问时无法去虚拟化，导致 for 循环比 foreach 更慢。.NET 10 修复了这一反直觉现象。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-keyword">private</span> ReadOnlyCollection&lt;<span class="hljs-built_in">int</span>&gt; _list = <span class="hljs-keyword">new</span>(Enumerable.Range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>).ToArray());
[<span class="hljs-meta">Benchmark</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">SumForLoop</span>()</span>
{
    <span class="hljs-built_in">int</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; _list.Count; i++)
    {
        sum += _list[i]; <span class="hljs-comment">// .NET 9: 1000 次虚拟调用</span>
    }
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>优化后，SumForLoop 性能提升 68%，LINQ 查询也因此受益。SkipTakeSum 从 3.525 μs 降至 1.773 μs。</p>
<p>同时，JIT 能识别 IEnumerable&lt; int&gt; 实际是 int[]，从而生成具体类型代码：</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> IEnumerable&lt;<span class="hljs-built_in">int</span>&gt; s_values = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };
[<span class="hljs-meta">Benchmark</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Sum</span>()</span>
{
    <span class="hljs-built_in">int</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> s_values) sum += <span class="hljs-keyword">value</span>;
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>执行时间从 16.34 ns 降至 2.06 ns，内存分配归零。</p>
<h4 data-id="heading-4">四、线程池调度</h4>
<p>"同步包装异步"常导致线程池死锁。.NET 10 在线程即将阻塞时，主动将本地队列任务移交全局队列，避免关键任务被无限延迟。</p>
<pre><code class="hljs language-cs" lang="cs"><span class="hljs-comment">// 模拟高负载下的线程池僵局</span>
ThreadPool.SetMaxThreads(numThreads, <span class="hljs-number">1</span>);
<span class="hljs-comment">// ... 提交阻塞任务与干扰任务</span>
</code></pre>
<p>在 .NET 9 中超时 20 秒的任务，.NET 10 仅需 4 毫秒完成。</p>
<h3 data-id="heading-5">五、硬件级大数运算与容器遍历优化</h3>
<p>UInt128 除法利用 CPU 的 DivRem 指令，性能提升近 50 倍：</p>























<table><thead><tr><th>Method</th><th>Runtime</th><th>Mean</th><th>Ratio</th></tr></thead><tbody><tr><td>Divide</td><td>.NET 9.0</td><td>27.3112 ns</td><td>1.00</td></tr><tr><td>Divide</td><td>.NET 10.0</td><td>0.5522 ns</td><td>0.02</td></tr></tbody></table>
<p>Stack、Queue、ConcurrentDictionary 的枚举器也全面重构。以 Stack 为例，MoveNext 的分支从 5 个减至 1 个，SumDirect 性能提升 81%，代码体积缩小 83%。</p>
<h3 data-id="heading-6">总结</h3>
<p>.NET 10 的性能进步，不是靠炫技，而是源于对"不做无用功"的极致追求。它让编译器从"代码执行者"变为"意图理解者"，让运行时从"被动响应"转向"主动预测”。这种系统性思维，不仅提升了数字指标，更重塑了高性能开发的默认体验——开发无需手动优化，即可享受接近底层的效率。</p>
<p>对于广大 .NET 开发而言，升级到 .NET 10 不仅意味着更长的支持周期，更是一次"免费”的性能红利。</p>
<h3 data-id="heading-7">关键词</h3>
<p>.NET 10、性能优化、LINQ、去虚拟化、JIT、线程池、委托内联、栈分配、UInt128、容器遍历</p>
<h3 data-id="heading-8">最后</h3>
<p>如果你觉得这篇文章对你有帮助，不妨点个赞支持一下！你的支持是我继续分享知识的动力。如果有任何疑问或需要进一步的帮助，欢迎随时留言。</p>
<p>也可以加入微信公众号 <strong>[DotNet技术匠]</strong> 社区，与其他热爱技术的同行一起交流心得，共同成长！</p>
<p><strong>优秀是一种习惯，欢迎大家留言学习！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android系统中HAL层开发实例]]></title>    <link>https://juejin.cn/post/7571749988080893961</link>    <guid>https://juejin.cn/post/7571749988080893961</guid>    <pubDate>2025-11-13T01:22:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571749988080893961" data-draft-id="7571725550710341659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android系统中HAL层开发实例"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T01:22:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户345947411361"/> <meta itemprop="url" content="https://juejin.cn/user/1118620649271515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android系统中HAL层开发实例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1118620649271515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户345947411361
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:22:57.000Z" title="Thu Nov 13 2025 01:22:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef6165e899c4227a5ae2116bcb69a87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzQ1OTQ3NDExMzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763601777&amp;x-signature=XT4spgNBTFCRpATMgWTwJo%2FgnVQ%3D" alt="t01bf1f34d94fd74c63.jpg" loading="lazy"/></p>
<p><strong>Android系统中HAL层开发实例---youkeit.xyz/4706/</strong></p>
<h2 data-id="heading-0">从底层重构体验：Android Framework 引领移动开发技术迭代</h2>
<h3 data-id="heading-1">一、Android Framework 架构演进</h3>
<p>Android Framework 作为连接应用层与Linux内核的桥梁，其架构设计直接影响着移动开发的体验与效率。让我们从核心组件开始剖析：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 典型的Android Framework分层架构</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AndroidFramework</span> {
    <span class="hljs-comment">// 应用层组件</span>
    <span class="hljs-keyword">private</span> ApplicationLayer applicationLayer;
    
    <span class="hljs-comment">// Java API框架层</span>
    <span class="hljs-keyword">private</span> FrameworkLayer frameworkLayer;
    
    <span class="hljs-comment">// 本地库和Android运行时</span>
    <span class="hljs-keyword">private</span> NativeLayer nativeLayer;
    
    <span class="hljs-comment">// Linux内核层</span>
    <span class="hljs-keyword">private</span> KernelLayer kernelLayer;
    
    <span class="hljs-comment">// 关键系统服务</span>
    <span class="hljs-keyword">private</span> SystemServiceManager serviceManager;
}
</code></pre>
<h4 data-id="heading-2">1.1 组件化演进</h4>
<p>从Android 5.0引入的ART运行时替代Dalvik，到Android 10推出的Project Mainline模块化更新机制，Framework的核心变化体现在：</p>
<ol>
<li><strong>模块解耦</strong>：将系统组件拆分为独立模块（如WiFi、蓝牙等）</li>
<li><strong>动态更新</strong>：通过Google Play商店更新核心组件</li>
<li><strong>接口稳定</strong>：加强API兼容性保证</li>
</ol>
<h3 data-id="heading-3">二、关键技术创新点</h3>
<h4 data-id="heading-4">2.1 响应式架构改进</h4>
<p>Android Framework逐步引入响应式编程范式，典型如LiveData组件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocationViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _location = MutableLiveData&lt;Location&gt;()
    <span class="hljs-keyword">val</span> location: LiveData&lt;Location&gt; = _location
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateLocation</span><span class="hljs-params">(newLocation: <span class="hljs-type">Location</span>)</span></span> {
        _location.value = newLocation
    }
}

<span class="hljs-comment">// Activity中的观察者</span>
viewModel.location.observe(<span class="hljs-keyword">this</span>) { location -&gt;
    updateUI(location)
}
</code></pre>
<h4 data-id="heading-5">2.2 性能优化底层机制</h4>
<p>Android 12引入的PerformanceClass API为开发者提供了设备性能分级标准：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查设备性能等级</span>
<span class="hljs-keyword">if</span> (BuildCompat.isAtLeastS() &amp;&amp; 
    PerformanceClassManager.getPerformanceClass() &gt;= 
    PerformanceClassManager.PERFORMANCE_CLASS_HIGH) {
    <span class="hljs-comment">// 启用高级功能</span>
    enableAdvancedFeatures();
}
</code></pre>
<h3 data-id="heading-6">三、Framework 深度定制实践</h3>
<h4 data-id="heading-7">3.1 自定义系统服务</h4>
<p>通过AIDL创建跨进程系统服务示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义AIDL接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ICustomService</span> {
    <span class="hljs-type">int</span> <span class="hljs-title function_">getSystemStatus</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setConfiguration</span><span class="hljs-params">(in Bundle config)</span>;
}

<span class="hljs-comment">// 服务端实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ICustomService</span>.Stub {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSystemStatus</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> SystemProperties.getInt(<span class="hljs-string">"custom.status"</span>, <span class="hljs-number">0</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setConfiguration</span><span class="hljs-params">(Bundle config)</span> {
        <span class="hljs-comment">// 处理配置更新</span>
    }
}

<span class="hljs-comment">// 注册服务</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSystemService</span><span class="hljs-params">()</span> {
    ServiceManager.addService(<span class="hljs-string">"custom_service"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomServiceImpl</span>());
}
</code></pre>
<h4 data-id="heading-8">3.2 资源覆盖机制</h4>
<p>利用Runtime Resource Overlay (RRO)实现资源动态替换：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- overlay/values/strings.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"app_name"</span>&gt;</span>New App Name<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>

<span class="hljs-comment">&lt;!-- overlay/AndroidManifest.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">package</span>=<span class="hljs-string">"com.example.overlay"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">overlay</span> <span class="hljs-attr">android:targetPackage</span>=<span class="hljs-string">"com.example.app"</span>
             <span class="hljs-attr">android:priority</span>=<span class="hljs-string">"1"</span>
             <span class="hljs-attr">android:isStatic</span>=<span class="hljs-string">"false"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">四、未来技术方向</h3>
<h4 data-id="heading-10">4.1 模块化架构深入</h4>
<p>Android 13进一步强化了模块化设计：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 动态模块加载示例</span>
<span class="hljs-type">val</span> <span class="hljs-variable">moduleManager</span> <span class="hljs-operator">=</span> ModuleManager.getInstance(context)
moduleManager.installModule(<span class="hljs-string">"dynamic_feature"</span>, 
    InstallCallback { status -&gt;
        <span class="hljs-keyword">if</span> (status == InstallStatus.SUCCESS) {
            <span class="hljs-comment">// 模块加载成功</span>
        }
    })
</code></pre>
<h4 data-id="heading-11">4.2 机器学习集成</h4>
<p>ML Kit与Framework深度整合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用设备端模型进行处理</span>
<span class="hljs-keyword">val</span> recognizer = TextRecognizer.Builder(context)
    .setDeviceMode(MLContext.DEVICE_ONLY)
    .build()

recognizer.process(InputImage.fromBitmap(bitmap))
    .addOnSuccessListener { result -&gt;
        <span class="hljs-comment">// 处理识别结果</span>
    }
</code></pre>
<h3 data-id="heading-12">五、最佳实践建议</h3>
<ol>
<li><strong>兼容性处理</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R) {
    <span class="hljs-comment">// 使用新API</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 回退方案</span>
}
</code></pre>
<ol start="2">
<li><strong>性能监控</strong>：</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startTrace</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>)</span></span> {
        Trace.beginSection(tag)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endTrace</span><span class="hljs-params">()</span></span> {
        Trace.endSection()
    }
}
</code></pre>
<ol start="3">
<li><strong>资源优化</strong>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 使用vector drawable替代位图 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">vector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:width</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:height</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:viewportWidth</span>=<span class="hljs-string">"24"</span>
    <span class="hljs-attr">android:viewportHeight</span>=<span class="hljs-string">"24"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">android:fillColor</span>=<span class="hljs-string">"#FF0000"</span>
          <span class="hljs-attr">android:pathData</span>=<span class="hljs-string">"M12,2L4,12l8,10l8-10z"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">vector</span>&gt;</span>
</code></pre>
<h3 data-id="heading-13">结语</h3>
<p>Android Framework的持续演进为移动开发带来了前所未有的灵活性和性能潜力。开发者应当：</p>
<ol>
<li>深入理解Framework底层机制</li>
<li>及时适配新特性</li>
<li>合理利用模块化设计</li>
<li>关注性能与能效平衡</li>
</ol>
<p>通过掌握这些核心技术点，开发者能够在快速变化的技术浪潮中保持竞争力，构建出体验卓越的移动应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀TRAE SOLO 实战赛 | 智启Coding 码力全开]]></title>    <link>https://juejin.cn/post/7571751304625815598</link>    <guid>https://juejin.cn/post/7571751304625815598</guid>    <pubDate>2025-11-13T02:42:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571751304625815598" data-draft-id="7571126773809479690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀TRAE SOLO 实战赛 | 智启Coding 码力全开"/> <meta itemprop="keywords" content="Trae,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-11-13T02:42:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀TRAE SOLO 实战赛 | 智启Coding 码力全开
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:42:50.000Z" title="Thu Nov 13 2025 02:42:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4de4d0f1dfd46da82bd9051f76951d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=7y2hGHXBerfjHKaUhSxnDTGXYk4%3D" alt="image.png" loading="lazy"/></p>
<p>🔥<strong>TRAE SOLO 正式版</strong>重磅上线，Vibe Coding的实战舞台已就位！</p>
<p>无论你是用TRAE破解难题的先锋探索者，还是借它激发灵感的创意玩家，这里都是你展示思考、分享成长的舞台。</p>
<p>你的每一次踩坑经验，都可能成为他人的避坑指南；你的每一个实战技巧，都值得被千万开发者看见！</p>
<p>投稿分享你的<strong>TRAE SOLO</strong>实战秘籍，用代码说话，用干货圈粉，解锁超高曝光流量与丰厚奖品，在SOLO赛道上C位出圈！</p>
<h2 data-id="heading-0">💪活动人群</h2>
<h5 data-id="heading-1"><em><strong>创作等级 Lv4-Lv8用户 (非掘友等级）</strong></em></h5>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/187a397168d44a8a8e73590b62f84862~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1512&amp;h=714&amp;s=46590&amp;e=webp&amp;b=fdfbfb" alt="截屏2022-11-10 10.32.44.png" loading="lazy"/></p>
<h2 data-id="heading-2">⏰活动时间</h2>
<p>2025年11月13日-2025年12月16日</p>
<h2 data-id="heading-3">📒活动玩法</h2>
<h3 data-id="heading-4">🚀创作方向</h3>
<p>本次活动面向AI全链路开发者，以<strong>TRAE SOLO 正式版</strong>为核心开发工具，打通AI应用落地全流程，结合SOLO coder、DiffView等功能聚焦以下3个创作方向，形式包括但不限于实践分享、避坑指南、工具实测对比。</p>
<blockquote>
<ul>
<li><strong>TRAE SOLO驱动AI架构设计与技术选型</strong></li>
</ul>
<p>从0到1搭建AI应用时，如何借助TRAE SOLO做架构决策。如：基于TRAE SOLO的SOLO coder生成开发文档；利用MCP协议适配大模型服务的架构设计等。</p>
<ul>
<li><strong>TRAE SOLO赋能大模型工程化实践</strong></li>
</ul>
<p>在大模型集成、微调、部署等关键环节中，TRAE SOLO的实战应用，如：基于TRAE SOLO选择适配模型；通过内置部署模块实现模型服务一键上线；TRAE SOLO生成代码的兼容性问题修复（使用DiffView工具）；大模型API密钥配置的安全踩坑等。</p>
<ul>
<li><strong>TRAE SOLO支撑AI应用的可观测性与风险管控</strong></li>
</ul>
<p>AI应用开发与上线后，如何基于TRAE SOLO构建质量保障体系。如：利用TRAE SOLO的任务进度追踪功能监控开发全流程、借助自动生成的测试脚本验证AI功能稳定性等。</p>
</blockquote>
<h3 data-id="heading-5">⛵️流量加持</h3>
<blockquote>
<p><em><strong>实战先锋</strong></em></p>
<p>11月13日-11月26日发布的文章：</p>
<p>被官方推荐的文章，将根据文章质量评分，每周排名前<strong>10</strong>的文章均可获得<strong>5000</strong>流量曝光奖励；</p>
<p>周期节点分别为11月13日-11月19日，11月20日-11月26日。</p>
<p><em><strong>优秀投稿榜</strong></em></p>
<p>11月13日-12月2日发布的文章：</p>
<p>被官方推荐的文章，将结合文章质量、互动和浏览数据综合评分，排名前<strong>5</strong>的文章可获得<strong>20000</strong>流量曝光奖励。</p>
<p><em><strong>实战冲刺</strong></em></p>
<p>12月11日-12月15日发布的文章：</p>
<p>被官方推荐的文章，可额外获得<strong>2000</strong>流量曝光奖励，不限名额。</p>
<p><em>注：获得“实战先锋”“实战冲刺”奖励的文章，届时会通过系统消息或群消息通知获奖的创作者；</em></p>
<p><em>荣登“优秀投稿榜”的文章，预计会在12月4日通过“掘金酱”账号进行公示。</em></p>
</blockquote>
<h3 data-id="heading-6">🪐SOLO双赛道</h3>
<blockquote>
<p><em><strong>优秀文章奖</strong></em></p>
<p>活动期间发布的文章，且被官方推荐：</p>
<p>将根据单篇文章质量、互动数据、浏览数据综合评分，前<strong>20</strong>名获奖；同一用户多篇上榜，取最高名次，不重复获同一奖项。</p>
<p><em><strong>Coding达人奖</strong></em></p>
<p>活动期间同一用户发文数≥<strong>2</strong>篇：</p>
<p>单篇文章满足“<em><strong>官方推荐 且 互动数据＞40 且 浏览量＞1000</strong></em>”，即可参与排名。按文章质量、互动浏览数据、发文数量等<strong>综合评分排名</strong>，前<strong>10</strong>名获奖。</p>
<p><em>注：一篇文章可同时参与双赛道，叠加获奖</em></p>
</blockquote>
<h6 data-id="heading-7"><em>❗自动推荐文章也会有人工审核，不符合要求会取消推荐，如最终文章为未推荐状态，则无法获得相关活动奖励。</em></h6>
<h6 data-id="heading-8"><em>❗社区严厉打击刷量、刷赞、互赞行为，一经发现直接取消获奖资格，也请不要在掘金的群里刷屏互赞！通过互赞达到获奖文章条件的不计入、自己点的赞藏不计入</em>！</h6>
<h4 data-id="heading-9">Trae创作内容参考</h4>
<h5 data-id="heading-10">以<strong>TRAE SOLO</strong>实践、技术展示为主</h5>
<ol>
<li><a href="https://juejin.cn/post/7566965016281989170" target="_blank" title="https://juejin.cn/post/7566965016281989170">用 TRAE 开发审批系统：一套可复制的 AI 辅助开发工作流</a></li>
<li><a href="https://juejin.cn/post/7569139641233473574" target="_blank" title="https://juejin.cn/post/7569139641233473574">基于 TRAE + Spec-kit 实现树莓派智能小车控制系统</a></li>
<li><a href="https://juejin.cn/post/7569515660931203123" target="_blank" title="https://juejin.cn/post/7569515660931203123">AI 代理驱动开发实战：用 TRAE 构建经典吃豆人游戏</a></li>
</ol>
<h3 data-id="heading-11">👩🏻评委评审参考</h3>
<ul>
<li>内容质量：文章内容是否丰富、有深度，是否能够清晰地表达观点。</li>
<li>技术水平：文章中所介绍的技术是否先进、实用，是否能够解决实际问题。</li>
<li>创新性：文章是否具有创新性，是否能够提出新的思路或方法。</li>
<li>可读性：文章是否易于阅读，语言是否流畅。</li>
</ul>
<blockquote>
<p>最终评分结果为评审团打分，参考文章互动数据</p>
</blockquote>
<h2 data-id="heading-12">⁉️如何参与</h2>
<p>发布文章时选择带话题 <strong><a href="https://juejin.cn/theme/detail/7571274218302619694?contentType=0" target="_blank" title="https://juejin.cn/theme/detail/7571274218302619694?contentType=0">#TRAE SOLO#</a></strong> 和标签<a href="https://juejin.cn/tag/Trae" target="_blank" title="https://juejin.cn/tag/Trae">Trae</a>就可以被统计到哦💁🏻</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc025ba645bc4c32ac1e10d616fe7d35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=0mi04wxqVTgwkgKRGDYgEuqR%2FDY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-13">🎁活动奖励</h2>
<p>参加活动的优质文章也会获得额外流量曝光~</p>





























































<table><thead><tr><th>奖项名称</th><th>奖项设置</th><th>获奖人数</th><th>奖品名称</th><th>奖品图</th><th>站内荣誉认证</th></tr></thead><tbody><tr><td>优秀文章奖</td><td>TOP1</td><td>1名</td><td>西部数据（WD）1TB 移动硬盘</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b92f91a562af427a9534f2321878dc98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=F1%2FQVN22ga0qG8MDNcK1x%2Bu1z7s%3D" alt="" loading="lazy"/></td><td>【AI技术专家】 掘金官方实体证书</td></tr><tr><td/><td>TOP2</td><td>1名</td><td>SKG K3腰部按摩仪</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0f58e0a521d4501a3e4709db9649b7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=jxQBmNYHn4suO%2Bl2%2FluDLdBfMsM%3D" alt="" loading="lazy"/></td><td>【AI技术专家】 掘金官方实体证书</td></tr><tr><td/><td>TOP3</td><td>1名</td><td>罗技无线蓝牙机械键盘</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7412780a3b9040e8b33e32f578632244~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=ngbs9tvoQXpd%2F8rj%2B16oVlO5vKM%3D" alt="" loading="lazy"/></td><td>【AI技术专家】 掘金官方实体证书</td></tr><tr><td/><td>TOP4-10</td><td>7名</td><td>漫步者头戴式蓝牙耳机</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1444cc68a49a45fead825f4991a331c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=sDZY28sTrymlJN5qHO%2F%2BQYs5zT8%3D" alt="" loading="lazy"/></td><td>【AI技术先锋】 掘金官方电子证书</td></tr><tr><td/><td>TOP11-20</td><td>10名</td><td>TRAE大礼包</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0264dcff44a64834975e3ae6754c9af9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=1DRaK5mLzSw%2FyUZqwT07QjTE1o8%3D" alt="91cd5cfd8b6eb071e1e5896ec77ea0d2.jpg" loading="lazy"/></td><td>【AI技术新星】 掘金官方电子证书</td></tr><tr><td>Coding达人奖</td><td>TOP1-10</td><td>10名</td><td>GUFIUS古菲斯围炉煮茶套装</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0133953a7c0749739490f63dd2ed1fa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=SxcHZm6jKIrZD4CyayWb0p0zNfE%3D" alt="" loading="lazy"/></td><td>【Coding达人】 掘金官方电子证书</td></tr></tbody></table>
<h2 data-id="heading-14">🗒️内容要求</h2>
<ul>
<li><strong>必须为原创技术文章</strong>，内容符合<a href="https://juejin.cn/book/6844733795329900551/section/6844733795380232199" target="_blank" title="https://juejin.cn/book/6844733795329900551/section/6844733795380232199">掘金社区的内容标准和规范</a>；</li>
<li><strong>字数不得少于 800 字</strong>，不得有广告/洗稿/凑字数/AI撰写等行为，如果发现有此类行为 ，直接取消所有获奖资格（备注：文章中50%及以上内容与网络内容相同，即视为洗稿）；</li>
<li><strong>文章要求首发在掘金</strong>，已在其他平台发布过的文章不计入活动，博客搬家/旧文新发等超过<strong>10篇</strong>直接取消所有获奖资格；</li>
<li><strong>学习笔记/知识点汇总类不能瓜分奖金</strong>，可以是知识点讲解/理解，即所有文章都需要有个人见解、思考、总结，单纯的搬运官网、书中知识点不计入；</li>
<li>刷赞、刷量等有作弊行为的文章，直接取消比赛资格，不能参与评选；</li>
<li>文章需包含背景/问题，核心思路，实操步骤/论证过程，总结反思等，不能只贴代码，如代码量超<strong>60%</strong> 则不计入；</li>
<li>AI代写文章、AI聊天记录等不计入活动（AI检测超过<strong>70%</strong> 取消文章获奖资格）；</li>
<li>工具汇总、软件测评类文章不可参加活动；</li>
<li>参赛文章必须注明参考来源。</li>
</ul>
<h6 data-id="heading-15"><em>活动期间，若发布文章内容与活动主题</em> <em>TRAE</em> <em>无相关性，则取消该用户对应文章获奖资格。</em></h6>
<h2 data-id="heading-16">☎️ 加群交流</h2>
<p>参加活动的掘友一定要入群哦，重要消息不错过，大家互相鼓励，有问题也可以在群内咨询哦～</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6ccf1e26f6f47878f366260e7d4dc67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763606570&amp;x-signature=B559L3y9LMDcB3R0kOVImKsVJpQ%3D" alt="image.png" loading="lazy"/></p>
<p>注意：活动开启，以及发奖进程都会第一时间群内通知，一定要进群呀，避免错过消息</p>
<h2 data-id="heading-17">👀 活动Q&amp;A</h2>
<p><strong>Q1：如何算是成功参与了活动？</strong></p>
<p>活动期间，在掘金平台发布TRAE SOLO相关原创技术文章，选择带话题  <strong><a href="https://juejin.cn/theme/detail/7571274218302619694?contentType=0" target="_blank" title="https://juejin.cn/theme/detail/7571274218302619694?contentType=0">#TRAE SOLO#</a></strong>  和标签<a href="https://juejin.cn/tag/Trae" target="_blank" title="https://juejin.cn/tag/Trae">Trae</a>，即可成功参与活动。注意话题≠标签！</p>
<p><strong>Q2：一篇文章可以参加多个活动吗</strong></p>
<p>可以，优秀文章奖和Coding达人奖2个赛道皆可参与。</p>
<p><strong>Q3：文章被推荐后一定能获得奖励吗</strong></p>
<p>不一定，lv4-lv8用户文章为自动推荐，但也相应的出现了一些利用权益钻空的用户，因此活动结束后会对文章进行人工审核，如果最终不符合优质文章标准也会取消该篇文章领取奖励的资格，若活动期间单用户出现的水文较多，会直接取消自动推荐的等级权益哦！。</p>
<p><strong>Q4：“流量加持”环节多久能获得流量奖励</strong></p>
<p>实战先锋、优秀投稿榜、实战冲刺预计分别会在公示后3天内进行流量投放，届时会通过系统消息或群消息通知获奖的创作者。</p>
<p><strong>Q5：“SOLO双赛道”什么时候开奖呢？如何知晓自己的奖项以及如何领取奖品？</strong></p>
<p>12月16日活动截止后，我们将对文章进行评选、公示，约10-15个工作日后会通过“掘金酱”账号进行名单公示，也会通过系统消息通知获奖的创作者领取奖励，预计填写问卷后的30个工作日内完成奖励发放。</p>
<p><strong>Q6：首发的定义是什么？</strong></p>
<p>未在其他网站发布过的文章，且第一次发布是在掘金。如文章非首发则无法获得奖励。</p>
<ul>
<li>最终解释权归<strong>稀土掘金技术社区</strong>官方所有</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java Duration 完全指南：高精度时间间隔处理的利器]]></title>    <link>https://juejin.cn/post/7571758212473913395</link>    <guid>https://juejin.cn/post/7571758212473913395</guid>    <pubDate>2025-11-13T02:23:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571758212473913395" data-draft-id="7571743311520202761" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java Duration 完全指南：高精度时间间隔处理的利器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T02:23:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Main12138"/> <meta itemprop="url" content="https://juejin.cn/user/124660844331034"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java Duration 完全指南：高精度时间间隔处理的利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/124660844331034/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Main12138
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:23:27.000Z" title="Thu Nov 13 2025 02:23:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>在 Java 8 引入的新时间 API 中，<code>java.time.Duration</code> 类是处理 <strong>时间间隔</strong> 的核心工具。它专门用于测量基于时间的时间量（小时、分钟、秒、纳秒），提供了高精度的计算能力和丰富的操作方法。</p>
<h2 data-id="heading-1">核心特性</h2>
<h3 data-id="heading-2">✅ Duration 的独特优势</h3>
<ul>
<li><strong>纳秒级精度</strong>：最高支持纳秒级别的时间精度</li>
<li><strong>不可变线程安全</strong>：所有实例都是不可变的，线程安全</li>
<li><strong>流畅API设计</strong>：提供链式调用的流畅接口</li>
<li><strong>单位转换便捷</strong>：支持各种时间单位间的轻松转换</li>
<li><strong>ISO-8601标准兼容</strong>：支持标准时间间隔格式</li>
</ul>
<h2 data-id="heading-3">创建 Duration 实例</h2>
<h3 data-id="heading-4">1. 静态工厂方法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基本单位创建</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofSeconds</span> <span class="hljs-operator">=</span> Duration.ofSeconds(<span class="hljs-number">30</span>);      <span class="hljs-comment">// 30秒</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofMinutes</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">15</span>);       <span class="hljs-comment">// 15分钟  </span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofHours</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">2</span>);           <span class="hljs-comment">// 2小时</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofMillis</span> <span class="hljs-operator">=</span> Duration.ofMillis(<span class="hljs-number">500</span>);       <span class="hljs-comment">// 500毫秒</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">ofNanos</span> <span class="hljs-operator">=</span> Duration.ofNanos(<span class="hljs-number">1000000</span>);     <span class="hljs-comment">// 1毫秒(100万纳秒)</span>

<span class="hljs-comment">// 组合创建</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">complex</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">1</span>)
                          .plusMinutes(<span class="hljs-number">30</span>)
                          .plusSeconds(<span class="hljs-number">45</span>);       <span class="hljs-comment">// 1小时30分45秒</span>
</code></pre>
<h3 data-id="heading-5">2. 时间点差值计算</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基于 Instant（时间戳）</span>
<span class="hljs-type">Instant</span> <span class="hljs-variable">startInstant</span> <span class="hljs-operator">=</span> Instant.now();
Thread.sleep(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 模拟操作</span>
<span class="hljs-type">Instant</span> <span class="hljs-variable">endInstant</span> <span class="hljs-operator">=</span> Instant.now();
<span class="hljs-type">Duration</span> <span class="hljs-variable">elapsed</span> <span class="hljs-operator">=</span> Duration.between(startInstant, endInstant);

<span class="hljs-comment">// 基于 LocalDateTime（无时区）</span>
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">meetingStart</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">10</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>);
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">meetingEnd</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2023</span>, <span class="hljs-number">10</span>, <span class="hljs-number">1</span>, <span class="hljs-number">11</span>, <span class="hljs-number">30</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">meetingDuration</span> <span class="hljs-operator">=</span> Duration.between(meetingStart, meetingEnd);

<span class="hljs-comment">// 基于 LocalTime（仅时间）</span>
<span class="hljs-type">LocalTime</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">9</span>, <span class="hljs-number">0</span>);
<span class="hljs-type">LocalTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> LocalTime.of(<span class="hljs-number">17</span>, <span class="hljs-number">30</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">workDuration</span> <span class="hljs-operator">=</span> Duration.between(startTime, endTime);
</code></pre>
<h3 data-id="heading-6">3. 字符串解析（ISO-8601标准）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ISO-8601 格式解析</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">pt20s</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT20S"</span>);        <span class="hljs-comment">// 20秒</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">pt15m</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT15M"</span>);        <span class="hljs-comment">// 15分钟</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">pt10h</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT10H"</span>);        <span class="hljs-comment">// 10小时</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">p2d</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"P2D"</span>);            <span class="hljs-comment">// 2天</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">pt1h30m</span> <span class="hljs-operator">=</span> Duration.parse(<span class="hljs-string">"PT1H30M"</span>);    <span class="hljs-comment">// 1小时30分钟</span>
</code></pre>
<h2 data-id="heading-7">核心操作指南</h2>
<h3 data-id="heading-8">🔢 时间值获取与转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">2</span>).plusMinutes(<span class="hljs-number">30</span>); <span class="hljs-comment">// 2小时30分钟</span>

<span class="hljs-comment">// 转换为不同单位</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalHours</span> <span class="hljs-operator">=</span> duration.toHours();        <span class="hljs-comment">// 2小时</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalMinutes</span> <span class="hljs-operator">=</span> duration.toMinutes();    <span class="hljs-comment">// 150分钟</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalSeconds</span> <span class="hljs-operator">=</span> duration.toSeconds();    <span class="hljs-comment">// 9000秒</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalMillis</span> <span class="hljs-operator">=</span> duration.toMillis();      <span class="hljs-comment">// 9,000,000毫秒</span>

<span class="hljs-comment">// 获取各部分（不转换单位）</span>
<span class="hljs-type">long</span> <span class="hljs-variable">hoursPart</span> <span class="hljs-operator">=</span> duration.toHoursPart();     <span class="hljs-comment">// 2小时</span>
<span class="hljs-type">long</span> <span class="hljs-variable">minutesPart</span> <span class="hljs-operator">=</span> duration.toMinutesPart(); <span class="hljs-comment">// 30分钟</span>
<span class="hljs-type">long</span> <span class="hljs-variable">secondsPart</span> <span class="hljs-operator">=</span> duration.toSecondsPart(); <span class="hljs-comment">// 0秒</span>
</code></pre>
<h3 data-id="heading-9">➕ 数学运算操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Duration</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 加法运算</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">afterAdd</span> <span class="hljs-operator">=</span> base.plusHours(<span class="hljs-number">2</span>)        <span class="hljs-comment">// 加2小时</span>
                       .plusMinutes(<span class="hljs-number">30</span>)      <span class="hljs-comment">// 加30分钟</span>
                       .plus(Duration.ofSeconds(<span class="hljs-number">10</span>)); <span class="hljs-comment">// 加10秒</span>

<span class="hljs-comment">// 减法运算  </span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">afterSubtract</span> <span class="hljs-operator">=</span> base.minusMinutes(<span class="hljs-number">15</span>)
                            .minus(Duration.ofSeconds(<span class="hljs-number">30</span>));

<span class="hljs-comment">// 乘除运算</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">doubled</span> <span class="hljs-operator">=</span> base.multipliedBy(<span class="hljs-number">2</span>);     <span class="hljs-comment">// 乘以2</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">halved</span> <span class="hljs-operator">=</span> base.dividedBy(<span class="hljs-number">2</span>);         <span class="hljs-comment">// 除以2</span>

<span class="hljs-comment">// 取绝对值</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">negative</span> <span class="hljs-operator">=</span> Duration.ofHours(-<span class="hljs-number">1</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">absolute</span> <span class="hljs-operator">=</span> negative.abs();          <span class="hljs-comment">// 1小时</span>
</code></pre>
<h3 data-id="heading-10">⚖️ 比较与判断</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Duration</span> <span class="hljs-variable">shortTask</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">5</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">longTask</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 比较操作</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isShorter</span> <span class="hljs-operator">=</span> shortTask.compareTo(longTask) &lt; <span class="hljs-number">0</span>; <span class="hljs-comment">// true</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isZero</span> <span class="hljs-operator">=</span> shortTask.isZero();                   <span class="hljs-comment">// false</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isNegative</span> <span class="hljs-operator">=</span> shortTask.isNegative();           <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 相等判断</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">equal</span> <span class="hljs-operator">=</span> shortTask.equals(Duration.ofMinutes(<span class="hljs-number">5</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-11">实战应用场景</h2>
<h3 data-id="heading-12">🎯 场景1：性能监控与执行时间测量</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">measureExecution</span><span class="hljs-params">(String taskName, 
                                       Supplier&lt;T&gt; task)</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> Instant.now();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> task.get();
            <span class="hljs-type">Instant</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> Instant.now();
            <span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(start, end);
            
            System.out.printf(<span class="hljs-string">"任务 '%s' 执行时间: %d 毫秒%n"</span>, 
                            taskName, duration.toMillis());
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-type">Instant</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> Instant.now();
            <span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(start, end);
            System.err.printf(<span class="hljs-string">"任务 '%s' 失败，已执行: %d 毫秒%n"</span>, 
                            taskName, duration.toMillis());
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> measureExecution(<span class="hljs-string">"数据查询"</span>, () -&gt; {
            <span class="hljs-comment">// 模拟耗时操作</span>
            <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1500</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}
            <span class="hljs-keyword">return</span> <span class="hljs-string">"查询结果"</span>;
        });
    }
}
</code></pre>
<h3 data-id="heading-13">🎯 场景2：超时控制与限流管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Duration timeout;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Duration retryInterval;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TimeoutManager</span><span class="hljs-params">(Duration timeout, Duration retryInterval)</span> {
        <span class="hljs-built_in">this</span>.timeout = timeout;
        <span class="hljs-built_in">this</span>.retryInterval = retryInterval;
    }
    
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">executeWithTimeout</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> <span class="hljs-keyword">throws</span> TimeoutException {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">deadline</span> <span class="hljs-operator">=</span> Instant.now().plus(timeout);
        
        <span class="hljs-keyword">while</span> (Instant.now().isBefore(deadline)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> task.call();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-type">Duration</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> Duration.between(Instant.now(), deadline);
                <span class="hljs-keyword">if</span> (remaining.toMillis() &lt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"操作超时"</span>);
                }
                
                <span class="hljs-comment">// 等待后重试</span>
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(Math.min(retryInterval.toMillis(), 
                                        remaining.toMillis()));
                } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"操作被中断"</span>, ie);
                }
            }
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"操作超时"</span>);
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">TimeoutManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutManager</span>(
    Duration.ofSeconds(<span class="hljs-number">30</span>),    <span class="hljs-comment">// 30秒超时</span>
    Duration.ofSeconds(<span class="hljs-number">2</span>)      <span class="hljs-comment">// 2秒重试间隔</span>
);
</code></pre>
<h3 data-id="heading-14">🎯 场景3：缓存过期策略实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimedCache</span>&lt;K, V&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;K, CacheEntry&lt;V&gt;&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Duration defaultTtl;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TimedCache</span><span class="hljs-params">(Duration defaultTtl)</span> {
        <span class="hljs-built_in">this</span>.defaultTtl = defaultTtl;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        put(key, value, defaultTtl);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value, Duration ttl)</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">expiryTime</span> <span class="hljs-operator">=</span> Instant.now().plus(ttl);
        cache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheEntry</span>&lt;&gt;(value, expiryTime));
    }
    
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> {
        CacheEntry&lt;V&gt; entry = cache.get(key);
        <span class="hljs-keyword">if</span> (entry == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">if</span> (Instant.now().isAfter(entry.getExpiryTime())) {
            cache.remove(key);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> entry.getValue();
    }
    
    <span class="hljs-comment">// 清理过期条目</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanup</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> Instant.now();
        cache.entrySet().removeIf(entry -&gt; 
            now.isAfter(entry.getValue().getExpiryTime()));
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span>&lt;V&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> V value;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Instant expiryTime;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheEntry</span><span class="hljs-params">(V value, Instant expiryTime)</span> {
            <span class="hljs-built_in">this</span>.value = value;
            <span class="hljs-built_in">this</span>.expiryTime = expiryTime;
        }
        
        <span class="hljs-comment">// getters...</span>
    }
}
</code></pre>
<h3 data-id="heading-15">🎯 场景4：任务调度与延迟执行</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskScheduler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> 
        Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);
    
    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable task,
                                                   Duration initialDelay,
                                                   Duration delay) {
        <span class="hljs-keyword">return</span> scheduler.scheduleWithFixedDelay(
            task,
            initialDelay.toMillis(), 
            delay.toMillis(),
            TimeUnit.MILLISECONDS
        );
    }
    
    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable task,
                                                Duration initialDelay, 
                                                Duration period) {
        <span class="hljs-keyword">return</span> scheduler.scheduleAtFixedRate(
            task,
            initialDelay.toMillis(),
            period.toMillis(), 
            TimeUnit.MILLISECONDS
        );
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startMonitoring</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 5秒后开始，每30秒执行一次</span>
        scheduleAtFixedRate(
            <span class="hljs-built_in">this</span>::healthCheck,
            Duration.ofSeconds(<span class="hljs-number">5</span>),
            Duration.ofSeconds(<span class="hljs-number">30</span>)
        );
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">healthCheck</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"执行健康检查: "</span> + Instant.now());
    }
}
</code></pre>
<h3 data-id="heading-16">🎯 场景5：速率限制器实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Duration refillInterval;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> maxTokens;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> tokens;
    <span class="hljs-keyword">private</span> Instant lastRefill;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RateLimiter</span><span class="hljs-params">(Duration refillInterval, <span class="hljs-type">int</span> maxTokens)</span> {
        <span class="hljs-built_in">this</span>.refillInterval = refillInterval;
        <span class="hljs-built_in">this</span>.maxTokens = maxTokens;
        <span class="hljs-built_in">this</span>.tokens = maxTokens;
        <span class="hljs-built_in">this</span>.lastRefill = Instant.now();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        refillTokens();
        <span class="hljs-keyword">if</span> (tokens &gt; <span class="hljs-number">0</span>) {
            tokens--;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span> {
        refillTokens();
        <span class="hljs-keyword">if</span> (tokens &gt;= <span class="hljs-keyword">permits</span>) {
            tokens -= <span class="hljs-keyword">permits</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refillTokens</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> Instant.now();
        <span class="hljs-type">Duration</span> <span class="hljs-variable">timeSinceLastRefill</span> <span class="hljs-operator">=</span> Duration.between(lastRefill, now);
        
        <span class="hljs-type">long</span> <span class="hljs-variable">refillCount</span> <span class="hljs-operator">=</span> timeSinceLastRefill.dividedBy(refillInterval);
        <span class="hljs-keyword">if</span> (refillCount &gt; <span class="hljs-number">0</span>) {
            tokens = Math.min(maxTokens, tokens + (<span class="hljs-type">int</span>)refillCount);
            lastRefill = lastRefill.plus(refillInterval.multipliedBy(refillCount));
        }
    }
    
    <span class="hljs-keyword">public</span> Duration <span class="hljs-title function_">getTimeUntilNextRefill</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Instant</span> <span class="hljs-variable">nextRefill</span> <span class="hljs-operator">=</span> lastRefill.plus(refillInterval);
        <span class="hljs-keyword">return</span> Duration.between(Instant.now(), nextRefill);
    }
}

<span class="hljs-comment">// 使用示例：限制每秒最多10个请求</span>
<span class="hljs-type">RateLimiter</span> <span class="hljs-variable">limiter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimiter</span>(Duration.ofSeconds(<span class="hljs-number">1</span>), <span class="hljs-number">10</span>);
<span class="hljs-keyword">if</span> (limiter.tryAcquire()) {
    <span class="hljs-comment">// 处理请求</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-type">Duration</span> <span class="hljs-variable">waitTime</span> <span class="hljs-operator">=</span> limiter.getTimeUntilNextRefill();
    System.out.println(<span class="hljs-string">"需要等待: "</span> + waitTime.toMillis() + <span class="hljs-string">"毫秒"</span>);
}
</code></pre>
<h2 data-id="heading-17">最佳实践与注意事项</h2>
<h3 data-id="heading-18">✅ 最佳实践</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 使用有意义的变量名</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">requestTimeout</span> <span class="hljs-operator">=</span> Duration.ofSeconds(<span class="hljs-number">30</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">cacheTtl</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">10</span>);
<span class="hljs-type">Duration</span> <span class="hljs-variable">sessionDuration</span> <span class="hljs-operator">=</span> Duration.ofHours(<span class="hljs-number">2</span>);

<span class="hljs-comment">// 2. 优先使用工厂方法而不是构造函数</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">good</span> <span class="hljs-operator">=</span> Duration.ofMinutes(<span class="hljs-number">5</span>);      <span class="hljs-comment">// ✅ 推荐</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">bad</span> <span class="hljs-operator">=</span> Duration.ofSeconds(<span class="hljs-number">300</span>);      <span class="hljs-comment">// ❌ 可读性差</span>

<span class="hljs-comment">// 3. 合理处理大数值</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">largeDuration</span> <span class="hljs-operator">=</span> Duration.ofDays(<span class="hljs-number">365</span>); <span class="hljs-comment">// 1年</span>
<span class="hljs-keyword">if</span> (largeDuration.toDays() &gt; <span class="hljs-number">100</span>) {
    <span class="hljs-comment">// 处理大时间间隔</span>
}

<span class="hljs-comment">// 4. 使用合适的精度</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">highPrecision</span> <span class="hljs-operator">=</span> Duration.ofNanos(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 需要高精度时</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">normalPrecision</span> <span class="hljs-operator">=</span> Duration.ofMillis(<span class="hljs-number">100</span>); <span class="hljs-comment">// 一般情况</span>
</code></pre>
<h3 data-id="heading-19">⚠️ 注意事项</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 避免在日期计算中使用 Duration（使用 Period）</span>
<span class="hljs-type">LocalDate</span> <span class="hljs-variable">today</span> <span class="hljs-operator">=</span> LocalDate.now();
<span class="hljs-type">LocalDate</span> <span class="hljs-variable">nextMonth</span> <span class="hljs-operator">=</span> today.plus(Period.ofMonths(<span class="hljs-number">1</span>)); <span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-type">LocalDate</span> <span class="hljs-variable">wrong</span> <span class="hljs-operator">=</span> today.plus(Duration.ofDays(<span class="hljs-number">30</span>));    <span class="hljs-comment">// ❌ 可能不准确</span>

<span class="hljs-comment">// 2. 注意时区问题</span>
<span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zonedStart</span> <span class="hljs-operator">=</span> ZonedDateTime.now();
<span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">zonedEnd</span> <span class="hljs-operator">=</span> zonedStart.plus(Duration.ofHours(<span class="hljs-number">2</span>));
<span class="hljs-type">Duration</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> Duration.between(zonedStart, zonedEnd); <span class="hljs-comment">// ✅ 正确处理时区</span>

<span class="hljs-comment">// 3. 大数值计算可能溢出</span>
<span class="hljs-type">Duration</span> <span class="hljs-variable">veryLarge</span> <span class="hljs-operator">=</span> Duration.ofDays(Integer.MAX_VALUE);
<span class="hljs-type">long</span> <span class="hljs-variable">days</span> <span class="hljs-operator">=</span> veryLarge.toDays(); <span class="hljs-comment">// 可能溢出，需要检查</span>
</code></pre>
<h2 data-id="heading-20">总结</h2>
<p><strong>Duration 是以下场景的理想选择：</strong></p>
<ul>
<li>✅ <strong>高精度时间测量</strong>（性能监控、执行时间统计）</li>
<li>✅ <strong>超时控制和限流</strong>（网络请求、资源管理）</li>
<li>✅ <strong>缓存和会话管理</strong>（TTL设置、过期策略）</li>
<li>✅ <strong>任务调度</strong>（延迟执行、定期任务）</li>
<li>✅ <strong>速率限制</strong>（API限流、流量控制）</li>
</ul>
<p><strong>关键优势：</strong></p>
<ul>
<li>纳秒级精度满足高性能需求</li>
<li>不可变设计保证线程安全</li>
<li>流畅API提升开发体验</li>
<li>丰富的时间单位转换支持</li>
</ul>
<p>掌握 Duration 的使用，能够让你在时间敏感的应用场景中游刃有余，构建出更加健壮和高效的系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 定位彻底搞懂：五种 position 的真实差异与最佳实践]]></title>    <link>https://juejin.cn/post/7571648135585955883</link>    <guid>https://juejin.cn/post/7571648135585955883</guid>    <pubDate>2025-11-12T15:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135585955883" data-draft-id="7571678388954447891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 定位彻底搞懂：五种 position 的真实差异与最佳实践"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-12T15:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ouma_syu"/> <meta itemprop="url" content="https://juejin.cn/user/2728363512824729"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 定位彻底搞懂：五种 position 的真实差异与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2728363512824729/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ouma_syu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:59:52.000Z" title="Wed Nov 12 2025 15:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">彻底读懂 CSS 定位：文档流、relative、absolute、fixed、sticky 全面解析</h2>
<p>在前端布局体系中，<code>position</code> 是最核心也最容易产生误解的属性。它决定了元素是否参与文档流、参考基准的选择方式、滚动表现以及层叠关系等关键特性。</p>
<p>本文将以统一的逻辑体系，将 <code>position</code> 拆解成最易理解的一套认知结构。读完后，你将能够真正做到：<strong>定位用得准，布局不踩坑。</strong></p>
<hr/>
<h2 data-id="heading-1">一、什么是文档流？为什么所有定位都围绕它展开？</h2>
<p>在浏览器默认布局规则下，元素都会按照“文档流（normal flow）”来排列：</p>
<ul>
<li><strong>块级元素</strong>：从上到下排列</li>
<li><strong>行内元素</strong>：从左到右排列</li>
</ul>
<p>只要元素仍在文档流中，它就会<strong>占据空间</strong>并参与后续元素的排布。</p>
<p>而一旦元素“脱离文档流”，则意味着：</p>
<ul>
<li>不再占据原来的空间</li>
<li>不影响其他元素位置</li>
<li>可在页面中自由摆放</li>
</ul>
<p>理解是否“脱流”，是掌握所有定位方式的关键。</p>
<hr/>
<h2 data-id="heading-2">二、五种定位方式逐个拆解</h2>
<h3 data-id="heading-3">1. position: static（默认定位）</h3>
<ul>
<li>元素按文档流正常排列</li>
<li>不支持 <code>top/left</code> 等偏移属性</li>
<li>常用于<strong>重置定位</strong></li>
</ul>
<p>一句话总结：最普通的布局方式。</p>
<hr/>
<h3 data-id="heading-4">2. position: relative（相对定位）</h3>
<p><strong>特性：</strong></p>
<ul>
<li>不脱离文档流（仍占据原来的位置）</li>
<li>偏移参照自身的“原本位置”</li>
<li>常用于为 absolute 元素建立“定位上下文”</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; }
<span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; }
</code></pre>
<p>relative 本质上是对元素进行“微调”，或用于创建新的定位参考点。</p>
<hr/>
<h3 data-id="heading-5">3. position: absolute（绝对定位）</h3>
<p><strong>特性：</strong></p>
<ul>
<li>脱离文档流</li>
<li>不再占据空间</li>
<li>参照“最近的非 static 的父元素”</li>
<li>若无定位父元素，则参照 <code>body/html</code></li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; }
<span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; }
</code></pre>
<p><code>.child</code> 会以 <code>.parent</code> 为基准定位。</p>
<p>经典居中：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p>比 margin auto 更稳定，是前端面试必背方案。</p>
<hr/>
<h3 data-id="heading-6">4. position: fixed（固定定位）</h3>
<p><strong>特性：</strong></p>
<ul>
<li>脱离文档流</li>
<li>以浏览器视口（viewport）为基准</li>
<li>页面滚动时位置保持不变</li>
</ul>
<p>常见使用场景：</p>
<ul>
<li>悬浮图标</li>
<li>固定导航栏</li>
<li>返回顶部按钮</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-7">5. position: sticky（粘性定位）</h3>
<p>sticky 是 relative 与 fixed 的结合体：</p>
<ul>
<li>未触发阈值 → 像 relative（不脱流）</li>
<li>触发阈值 → 像 fixed（吸附在屏幕）</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<p>常用于吸顶导航、文档标题区等。</p>
<p>注意 sticky 生效条件：</p>
<ul>
<li>必须指定 top/right/bottom/left</li>
<li>父元素不能是 <code>overflow: hidden/auto</code>（否则可能失效）</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、示例代码中的关键知识点总结</h2>
<h3 data-id="heading-9">相对 + 绝对定位：最常用的布局模式</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; }
<span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; }
</code></pre>
<p>relative 创建定位上下文，absolute 精准定位。</p>
<hr/>
<h3 data-id="heading-10">最稳健的居中方案</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p>不会受元素尺寸影响，是居中布局的最佳实践。</p>
<hr/>
<h3 data-id="heading-11">fixed：真正的“固定在屏幕”</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-12">sticky：滚动到某一点自动吸顶</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-13">重置定位：position: static</h3>
<p>当父元素从 absolute → static 时，absolute 子元素会重新寻找新的定位参考点。</p>
<p>示例：</p>
<pre><code class="hljs language-ini" lang="ini">setTimeout(() =&gt; {
  <span class="hljs-attr">oParent.style.position</span> = <span class="hljs-string">'static'</span><span class="hljs-comment">;</span>
}, 5000)<span class="hljs-comment">;</span>
</code></pre>
<p>5 秒后，absolute 子元素将以 body 为基准重新定位。</p>
<hr/>
<h2 data-id="heading-14">四、总结</h2>









































<table><thead><tr><th>属性</th><th>是否脱离文档流</th><th>偏移参考点</th><th>常用场景</th></tr></thead><tbody><tr><td>static</td><td>不脱离</td><td>文档流</td><td>默认、重置定位</td></tr><tr><td>relative</td><td>不脱离</td><td>元素自身原位置</td><td>微调、创建定位上下文</td></tr><tr><td>absolute</td><td>脱离</td><td>最近的非 static 父元素</td><td>弹窗、浮层、卡片定位</td></tr><tr><td>fixed</td><td>脱离</td><td>视口 viewport</td><td>悬浮 UI、固定导航</td></tr><tr><td>sticky</td><td>阈值前不脱离 阈值后脱离</td><td>自身 + 视口</td><td>吸顶、目录导航</td></tr></tbody></table>
<p>CSS 定位并不复杂，真正的核心只有三个：</p>
<ol>
<li>是否脱离文档流</li>
<li>参考谁进行定位</li>
<li>滚动时如何表现</li>
</ol>
<p>掌握这三点，你就能在布局中做到真正的“心中有数”，面对任何复杂布局也能游刃有余。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析JavaScript数组：从内存原理到高效遍历实践]]></title>    <link>https://juejin.cn/post/7571637614202306587</link>    <guid>https://juejin.cn/post/7571637614202306587</guid>    <pubDate>2025-11-12T07:21:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571637614202306587" data-draft-id="7571427088071557146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析JavaScript数组：从内存原理到高效遍历实践"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T07:21:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云ing"/> <meta itemprop="url" content="https://juejin.cn/user/2974655942502250"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析JavaScript数组：从内存原理到高效遍历实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2974655942502250/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云ing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:21:30.000Z" title="Wed Nov 12 2025 07:21:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入解析 JavaScript 数组：从内存原理到高效遍历实践</h2>
<p>在前端开发中，数组是最基础、最常用的数据结构之一。它语法简洁、开箱即用，既能存储简单的数据列表，也能支撑复杂的业务逻辑。然而，很多开发者对数组的理解停留在 <code>push</code>、<code>map</code>、<code>forEach</code> 等 API 的使用层面，对其底层机制缺乏系统认知。</p>
<p>本文将从内存模型、创建方式、遍历性能到结构选型，带你深入理解 JavaScript 数组的本质，帮助你在实际开发中做出更合理的技术决策。</p>
<hr/>
<h3 data-id="heading-1">一、数组的内存模型：栈与堆如何协作？</h3>
<p>JavaScript 中的变量存储分为<strong>栈内存</strong>和<strong>堆内存</strong>。当我们创建一个数组时，这两者会协同工作：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>变量 <code>arr</code> 本身（即引用地址）存储在<strong>栈内存</strong>中；</li>
<li>数组的实际数据 <code>[1, 2, 3, ..., 6]</code> 存储在<strong>堆内存</strong>中，并占用<strong>连续的内存空间</strong>。</li>
</ul>
<p>这种设计使得通过下标访问元素（如 <code>arr[2]</code>）的时间复杂度为 <strong>O(1)</strong> ，效率极高。</p>
<p>即使是通过构造函数创建空数组：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(); <span class="hljs-comment">// 或 []</span>
</code></pre>
<p>栈中依然保存引用，堆中则分配一块初始空间（可能为空），后续写入数据时再逐步填充。</p>
<p>若需要初始化一个固定长度且值统一的数组，推荐使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// [0, 0, 0, 0, 0, 0]</span>
</code></pre>
<p>这种方式一次性分配连续内存并完成初始化，避免了逐个赋值的开销。</p>
<hr/>
<h3 data-id="heading-2">二、创建数组：固定长度 vs 动态扩容</h3>
<p>数组的创建方式看似简单，实则涉及内存规划的权衡。</p>
<ul>
<li><strong>已知元素内容</strong>：直接使用字面量 <code>const arr = [1, 2, 3]</code> 最高效，内存精准匹配。</li>
<li><strong>仅知长度</strong>：可用 <code>new Array(n).fill(defaultValue)</code> 预分配空间。</li>
</ul>
<p>但要注意：</p>
<ul>
<li>若预估长度<strong>过大</strong>，会造成内存浪费；</li>
<li>若预估长度<strong>过小</strong>，后续插入超出范围的元素时，JavaScript 引擎会触发<strong>动态扩容</strong>。</li>
</ul>
<p>扩容过程类似“搬家”：申请更大的连续内存块 → 复制旧数据 → 释放原空间。这一过程时间复杂度为 O(n)，频繁扩容会影响性能。</p>
<blockquote>
<p>💡 小结：数组适合<strong>读多写少、长度相对稳定</strong>的场景；若需频繁增删，链表等离散结构可能更合适。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、遍历数组：性能与可读性的平衡</h3>
<p>JavaScript 提供了多种遍历方式，它们在性能、灵活性和可读性上各有侧重。</p>
<h4 data-id="heading-4">1. 传统 for 循环：性能最优</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = new Array(<span class="hljs-number">6</span>).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">len</span> = arr.length<span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {</span>
  console.log(arr<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<ul>
<li>直接通过索引访问，无函数调用开销；</li>
<li>缓存 <code>length</code> 可避免重复读取属性（现代引擎虽已优化，但仍属良好习惯）；</li>
<li><strong>适合大数据量或性能敏感场景</strong>。</li>
</ul>
<h4 data-id="heading-5">2. forEach：简洁但无法中断</h4>
<pre><code class="hljs language-javascript" lang="javascript">arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item, index);
});
</code></pre>
<ul>
<li>优点：语义清晰，无需管理索引；</li>
<li>缺点：<strong>不支持 <code>break</code> 或 <code>continue</code></strong>，且每次迭代都有函数调用开销；</li>
<li><strong>适用于纯遍历、无需中断的场景</strong>。</li>
</ul>
<h4 data-id="heading-6">3. map：用于数据转换</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">newArr</span> = arr.map(item =&gt; item + <span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>返回一个新数组，<strong>不修改原数组</strong>；</li>
<li>适合“遍历 + 加工”的需求；</li>
<li>注意：不要用 <code>map</code> 仅做遍历（会产生无用的新数组，浪费内存）。</li>
</ul>
<h4 data-id="heading-7">4. for...of：ES6 的优雅之选</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> item of arr) {
  console.<span class="hljs-built_in">log</span>(item);
}
</code></pre>
<ul>
<li>直接获取元素值，语法简洁；</li>
<li>支持 <code>break</code>/<code>continue</code>；</li>
<li>性能接近 <code>for</code> 循环，远优于 <code>forEach</code>；</li>
<li><strong>日常开发推荐使用</strong>。</li>
</ul>
<h4 data-id="heading-8">5. for...in：慎用于数组！</h4>
<p><code>for...in</code> 的设计初衷是<strong>遍历对象的可枚举属性</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">obj</span> = { name: <span class="hljs-string">"小明"</span>, age: <span class="hljs-number">18</span> }<span class="hljs-comment">;</span>
for (let key in obj) {
  console.log(key, obj<span class="hljs-section">[key]</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<p>虽然数组在 JavaScript 中也是对象（索引即属性名），但使用 <code>for...in</code> 遍历数组存在风险：</p>
<ul>
<li>可能遍历到原型链上的属性（若未正确设置）；</li>
<li>属性名是字符串（如 <code>"0"</code>），非数字；</li>
<li>遍历顺序不保证（尽管通常按索引顺序）。</li>
</ul>
<p>✅ <strong>建议</strong>：数组遍历请优先使用 <code>for</code>、<code>for...of</code> 或函数式方法，<strong>避免使用 <code>for...in</code></strong>。</p>
<hr/>
<h3 data-id="heading-9">四、数组 vs 其他数据结构：如何选择？</h3>
<p>数组是线性结构的代表，但在不同场景下，其他数据结构可能更合适：</p>






























<table><thead><tr><th>数据结构</th><th>特点</th><th>优势场景</th></tr></thead><tbody><tr><td><strong>栈</strong></td><td>先进后出（FILO）</td><td>函数调用、撤销操作、括号匹配</td></tr><tr><td><strong>队列</strong></td><td>先进先出（FIFO）</td><td>任务调度、BFS、消息缓冲</td></tr><tr><td><strong>链表</strong></td><td>节点离散，指针连接</td><td>频繁插入/删除（如购物车、播放列表）</td></tr><tr><td><strong>树</strong></td><td>层级结构（如二叉树）</td><td>分类数据、DOM 结构、搜索索引</td></tr></tbody></table>
<p>数组的核心优势在于<strong>随机访问快</strong>，适合以读取为主、长度稳定的场景；而链表在动态增删上更高效，树结构则擅长处理层级关系。</p>
<hr/>
<h3 data-id="heading-10">五、经典陷阱：循环中的异步与作用域</h3>
<p>最后来看一个常见面试题，涉及遍历与异步的结合：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 var</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>); <span class="hljs-comment">// 输出 10 个 10</span>
}

<span class="hljs-comment">// 使用 let</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>); <span class="hljs-comment">// 输出 0 到 9</span>
}
</code></pre>
<ul>
<li><code>var</code> 没有块级作用域，所有回调共享同一个 <code>i</code>，循环结束后 <code>i === 10</code>；</li>
<li><code>let</code> 在每次循环中创建独立的词法环境，每个回调捕获的是当前迭代的 <code>i</code> 值。</li>
</ul>
<p>这个例子提醒我们：<strong>理解作用域机制，是写出正确异步代码的前提</strong>。</p>
<hr/>
<h3 data-id="heading-11">总结</h3>
<p>JavaScript 数组虽简单，却融合了内存管理、性能优化与语言特性等多维度知识：</p>
<ul>
<li>合理初始化数组，可减少内存浪费；</li>
<li>根据场景选择遍历方式，兼顾性能与可维护性；</li>
<li>在动态性强或层级复杂的数据场景中，灵活选用链表、栈、树等结构；</li>
<li>避免常见陷阱（如 <code>for...in</code> 遍历数组、<code>var</code> 循环闭包问题）。</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS定位全解析：从静态到粘性，掌握元素布局的核心技巧]]></title>    <link>https://juejin.cn/post/7571725550709489691</link>    <guid>https://juejin.cn/post/7571725550709489691</guid>    <pubDate>2025-11-12T16:12:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571725550709489691" data-draft-id="7571729682678235186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS定位全解析：从静态到粘性，掌握元素布局的核心技巧"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-12T16:12:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户1203911294726"/> <meta itemprop="url" content="https://juejin.cn/user/2517262684662348"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS定位全解析：从静态到粘性，掌握元素布局的核心技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517262684662348/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户1203911294726
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T16:12:37.000Z" title="Wed Nov 12 2025 16:12:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS定位全解析：从静态到粘性，掌握元素布局的核心技巧</h2>
<p>在网页开发中，CSS定位是控制元素布局的核心技术之一。不同的定位方式可以让元素在页面上以各种方式排列和交互。本文将深入解析CSS中的各种定位方式，帮助前端开发者彻底掌握这一重要概念。</p>
<h3 data-id="heading-1">1. 文档流与定位基础</h3>
<p>在深入探讨各种定位方式之前，我们需要理解什么是文档流。文档流是HTML元素默认的布局方式：块级元素垂直排列，行内元素水平排列，遵循从上到下、从左到右的自然顺序。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>文档流示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; }
        <span class="hljs-selector-class">.block</span> { 
            <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; 
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>; 
            <span class="hljs-attribute">background-color</span>: pink; 
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"block"</span>&gt;</span>块级元素1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"block"</span>&gt;</span>块级元素2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>行内元素1<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>行内元素2<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. 相对定位(Relative Positioning)</h3>
<p>相对定位是相对于元素在文档流中的原始位置进行定位。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Relative 相对定位<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">top</span>:<span class="hljs-number">100px</span>;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: skyblue;
            <span class="hljs-attribute">position</span>: absolute;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: red;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc22712c9aa6498ba546e480ab34aff4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTIwMzkxMTI5NDcyNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763568756&amp;x-signature=oW0N4FvtN8Dbao6hZJcuE%2B%2FNXkE%3D" alt="0556b5234eebe36f871722d791372291.png" loading="lazy"/></p>
<p><strong>特点分析：</strong></p>
<ul>
<li>不会脱离文档流，原始位置继续被占用</li>
<li>后面的元素依然以标准流方式对待它</li>
<li>通过top、bottom、left、right属性进行微调</li>
<li>常用于微调元素位置或作为绝对定位元素的参考容器</li>
</ul>
<h3 data-id="heading-3">3. 绝对定位(Absolute Positioning)</h3>
<p>绝对定位元素会脱离文档流，不再占用原始空间。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>绝对定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-tag">body</span>{
            <span class="hljs-attribute">background-color</span>: azure;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">550px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
            <span class="hljs-attribute">position</span>: relative;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: skyblue;
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: green;
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>,-<span class="hljs-number">50%</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>123<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>hello,world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>456<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>关键特性：</strong></p>
<ul>
<li>脱离文档流，不占用空间</li>
<li>相对于最近的非static定位祖先元素定位</li>
<li>如果没有符合条件的祖先元素，则相对于初始包含块(通常是body)</li>
<li>常用于创建浮动元素、对话框、下拉菜单等</li>
</ul>
<p><strong>居中技巧：</strong> 使用绝对定位实现元素居中是一种常见技巧：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.center</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cf73c1eafc04caab8efba55206ff207~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTIwMzkxMTI5NDcyNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763568756&amp;x-signature=S1avdQayzyNhPuQuw8n17p7ucKU%3D" alt="fc7f5c6151ddce40d040ec16eedab012.png" loading="lazy"/></p>
<h3 data-id="heading-4">4. 固定定位(Fixed Positioning)</h3>
<p>固定定位元素相对于浏览器窗口进行定位，不随页面滚动而移动。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>固定定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-tag">body</span>{
            <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: green;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: blue;
            <span class="hljs-attribute">position</span>: fixed;
            <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>固定定位元素<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>应用场景：</strong></p>
<ul>
<li>固定导航栏</li>
<li>回到顶部按钮</li>
<li>侧边广告栏</li>
<li>模态对话框</li>
</ul>
<h3 data-id="heading-5">5. 粘性定位(Sticky Positioning)</h3>
<p>粘性定位是相对定位和固定定位的混合体，在跨越特定阈值前为相对定位，之后为固定定位。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>粘性定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: blue;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: green;
            <span class="hljs-attribute">position</span>: sticky;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
        }
        <span class="hljs-selector-tag">body</span>{
            <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>hello,world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>使用要点：</strong></p>
<ul>
<li>必须指定top、bottom、left或right至少一个阈值</li>
<li>在父容器内滚动时生效</li>
<li>兼容性较好，但需要测试目标浏览器支持情况</li>
<li>常用于表格标题固定、导航栏滚动固定等场景</li>
</ul>
<h3 data-id="heading-6">6. 静态定位(Static Positioning)</h3>
<p>静态定位是元素的默认定位方式，元素遵循正常的文档流。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>静态定位示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        *{
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-class">.parent</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">background-color</span>: pink;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">position</span>: absolute;
        }
        <span class="hljs-selector-class">.child</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">background-color</span>: blue;
        }
        <span class="hljs-selector-class">.box</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: green;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>hello,world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> oParent = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.parent'</span>);
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
            oParent.<span class="hljs-property">style</span>.<span class="hljs-property">position</span>=<span class="hljs-string">'static'</span>;
        },<span class="hljs-number">5000</span>)
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>重要特性：</strong></p>
<ul>
<li>默认定位方式，元素处于正常文档流中</li>
<li>忽略top、bottom、left、right和z-index属性</li>
<li>常用于取消元素的定位属性</li>
</ul>
<h3 data-id="heading-7">7. 定位实战技巧与注意事项</h3>
<h4 data-id="heading-8">7.1 z-index与层叠上下文</h4>
<p>定位元素会创建新的层叠上下文，z-index属性控制垂直方向上的堆叠顺序：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.element</span> {
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>; <span class="hljs-comment">/* 数值越大，显示在越上层 */</span>
}
</code></pre>
<h4 data-id="heading-9">7.2 定位与响应式设计</h4>
<p>在使用定位时需要考虑响应式设计：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
    <span class="hljs-selector-class">.fixed-element</span> {
        <span class="hljs-attribute">position</span>: relative;
        <span class="hljs-attribute">right</span>: auto;
        <span class="hljs-attribute">bottom</span>: auto;
    }
}
</code></pre>
<h4 data-id="heading-10">7.3 性能考虑</h4>
<ul>
<li>•过多使用固定定位和绝对定位可能影响页面性能</li>
<li>•变换动画时考虑使用transform而不是定位属性</li>
<li>•避免在滚动事件中频繁修改定位属性</li>
</ul>
<h3 data-id="heading-11">8. 总结</h3>
<p>CSS定位是前端开发中的核心技能，不同的定位方式适用于不同的场景：</p>
<ul>
<li>•<strong>静态定位</strong>：默认布局方式，适用于大多数常规布局</li>
<li>•<strong>相对定位</strong>：微调元素位置，保持文档流结构</li>
<li>•<strong>绝对定位</strong>：创建浮动元素，精确定位</li>
<li>•<strong>固定定位</strong>：相对于视口固定，适合导航和广告</li>
<li>•<strong>粘性定位</strong>：滚动时切换定位方式，增强用户体验</li>
</ul>
<p>掌握这些定位方式并理解它们的适用场景，将帮助你创建出更加精美和功能丰富的网页布局。在实际开发中，根据具体需求选择合适的定位方式，并注意兼容性和性能问题，才能打造出优秀的用户体验。 希望本文能帮助你深入理解CSS定位，如果有任何疑问或想法，欢迎在评论区交流讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最新Eslint9+prettier+Husky暂存区配置（基于Vue)]]></title>    <link>https://juejin.cn/post/7571662618056146970</link>    <guid>https://juejin.cn/post/7571662618056146970</guid>    <pubDate>2025-11-12T17:23:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618056146970" data-draft-id="7571678674145755146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最新Eslint9+prettier+Husky暂存区配置（基于Vue)"/> <meta itemprop="keywords" content="代码规范"/> <meta itemprop="datePublished" content="2025-11-12T17:23:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JaneHe"/> <meta itemprop="url" content="https://juejin.cn/user/3280598429350967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最新Eslint9+prettier+Husky暂存区配置（基于Vue)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598429350967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JaneHe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T17:23:41.000Z" title="Wed Nov 12 2025 17:23:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言：Eslint是一种代码质量检查工具，确保代码符合相应规范，prettier是一个代码格式化工具，总而言之，Eslint查错，prettier改错。Husky是一个Git Hooks工具，在把代码提交给仓库时自动触发前两个工具，确保每次提交给仓库的代码都符合项目标准。</h3>
<p>接下来我们就基于创建Vue项目时配置这三个工具。</p>
<h3 data-id="heading-1">1.首先创建一个Vue3项目</h3>
<p>1.1 下载pnpm 包管理器</p>
<pre><code class="hljs">npm install -g pnpm
</code></pre>
<p>1.2 创建Vue3项目，直接贴图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/448d27f54589480c97fe8334fb589381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=BHNoXPQWJXjWk%2BF%2FjzoKYYR45Xw%3D" alt="f58a3239-258b-4bef-a925-78895e00b4b1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b512f3eee0f94629854ef77bfc6aee90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=sk9K58Uol%2F1KmFoU4mF0A5gahqo%3D" alt="378516b1-a0ad-481d-b006-547889d3165e.png" loading="lazy"/></p>
<h3 data-id="heading-2">2.正式配置Eslint9+prettier+Husky</h3>
<p>2.1 配置设置文件</p>
<p>找到设置文件<code>settings.json</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5786acdb746a4ba28fbd7a4f0e137bcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=kJ4yUzT9K163ByXNwSqOmpzNiFQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ae2408296c344bdbeaefbe3a2623bf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=4BGOWjaQGeTIjZPBeaSRhIVLeJ8%3D" alt="image.png" loading="lazy"/></p>
<p>配置环境：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c362122d314fe3897d43903d9743ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=5m7hWJ%2BKa2xtvYALP3RMg92crFY%3D" alt="image.png" loading="lazy"/>
下载包：</p>
<pre><code class="hljs language-css" lang="css">pnpm <span class="hljs-selector-tag">i</span> -D eslint-plugin-vue eslint-plugin-prettier
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino">pnpm i -D prettier eslint-config-prettier
</code></pre>

<pre><code class="hljs language-bash" lang="bash">pnpm i -D @eslint/js @eslint/eslintrc
</code></pre>
<p>然后在<code>eslint.config.js</code>中导入包，代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> eslintConfigPrettier <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/eslint-config-prettier'</span> <span class="hljs-comment">//添加这一行代码</span>
<span class="hljs-keyword">import</span> eslintPluginPrettier <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>
</code></pre>
<p>如图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/354a8953d53043269439374e3d62a27b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=sXbecIMniS9hmA9VzVv%2BrTwSWZM%3D" alt="7605296d-40e0-421f-bb79-31bd28220add.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98fa36d3bcb64ac18eacd2a0e542961d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=4y6kVkldR1jE0OrI%2BzrRCaIKC1M%3D" alt="image.png" loading="lazy"/>
接着在defineConfig里面添加rules和刚刚下好的包配置，代码如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">   eslintConfigPrettier, <span class="hljs-comment">//添加这一行代码</span>
  eslintPluginPrettier, <span class="hljs-comment">// 解决 prettier 和 eslint 的冲突，比如 eslint 里面是 开启 双引号，prettier 里面开启单引号</span>
  {
    rules: {
      <span class="hljs-string">'prettier/prettier'</span>: [
        <span class="hljs-string">'warn'</span>,
        {
          singleQuote: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 单引号</span>
          semi: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 无分号</span>
          printWidth: <span class="hljs-number">100</span>, <span class="hljs-comment">// 每行宽度至多80字符</span>
          trailingComma: <span class="hljs-string">'none'</span>, <span class="hljs-comment">// 不加对象|数组最后逗号</span>
          endOfLine: <span class="hljs-string">'auto'</span> <span class="hljs-comment">// 换行符号不限制（win mac 不一致）</span>
        }
      ],
      <span class="hljs-string">'vue/multi-word-component-names'</span>: [
        <span class="hljs-string">'warn'</span>,
        {
          ignores: [<span class="hljs-string">'index'</span>] <span class="hljs-comment">// vue组件名称多单词组成（忽略index.vue）</span>
        }
      ],
      <span class="hljs-string">'vue/no-setup-props-destructure'</span>: [<span class="hljs-string">'off'</span>], <span class="hljs-comment">// 关闭 props 解构的校验</span>
      <span class="hljs-comment">// 💡 添加未定义变量错误提示，create-vue@3.6.3 关闭，这里加上是为了支持下一个章节演示。</span>
      <span class="hljs-string">'no-undef'</span>: <span class="hljs-string">'error'</span>
    }
  },
</code></pre>
<p>如图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1abe9be2f8204907a8985672f8a1bfb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=Wka2evK3tAcJDhJ3uvWmsXL0iGI%3D" alt="image.png" loading="lazy"/></p>
<p>然后配置Husky,先在终端里初始化仓库</p>
<pre><code class="hljs language-csharp" lang="csharp">git <span class="hljs-keyword">init</span>
</code></pre>
<p>初始化Husky 工具配置</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm dlx husky-<span class="hljs-keyword">init</span> &amp;&amp; pnpm install
</code></pre>
<p>lint-staged 配置</p>
<pre><code class="hljs language-css" lang="css">pnpm <span class="hljs-selector-tag">i</span> -D lint-staged
</code></pre>
<p>配置 <code>package.json</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f80cadc4893400a8ec0fe5893f71553~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=C8j4D6m65YMjNxnMHlreS2Npki8%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a14864a3569749589ce119313adfc1f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=kLDRkKcdUA3uobfH4lttBJKrcFg%3D" alt="07c48257-e1c7-43bd-8db9-96832d995116.png" loading="lazy"/></p>
<p>修改 <code>.husky/pre-commit</code> 文件</p>
<pre><code class="hljs">pnpm lint-staged
</code></pre>
<p>如图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c37669cac9a42e4becffef499ed473d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFuZUhl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763575172&amp;x-signature=TWuFzKf%2Fo0ymSf%2Fbos%2FkJesMioE%3D" alt="image.png" loading="lazy"/></p>
<p>综上，你就配置完了最新的eslint9+prettier+Husky！！
补：这里只开启了eslint插件，关闭了perttier插件</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 也要支持 if 了 ！！！CSS if() 函数来了！]]></title>    <link>https://juejin.cn/post/7571758212472897587</link>    <guid>https://juejin.cn/post/7571758212472897587</guid>    <pubDate>2025-11-12T23:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571758212472897587" data-draft-id="7571758212472881203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 也要支持 if 了 ！！！CSS if() 函数来了！"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-12T23:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 也要支持 if 了 ！！！CSS if() 函数来了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:58:11.000Z" title="Wed Nov 12 2025 23:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS 也要支持 if 了 ！！！CSS if() 函数来了！</h2>
<p>CSS <code>if()</code> 函数允许在纯 CSS 中基于条件为属性赋值，无需 JavaScript 或预处理器。该函数已在 Chrome 137 发布。</p>
<p>过去常用的做法包括通过 JavaScript 切换类名、使用预处理器 mixin 或编写大量媒体查询。<code>if()</code> 将条件逻辑引入 CSS，使写法更直接、性能稳定。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-11%2Fcss-if-function-has-arrived" target="_blank" title="https://catchadmin.com/post/2025-11/css-if-function-has-arrived" ref="nofollow noopener noreferrer">原文 CSS 也要支持 if 了 ！！！CSS if() 函数来了！</a></p>
<h3 data-id="heading-1">工作原理</h3>
<pre><code class="hljs language-css" lang="css">property: <span class="hljs-built_in">if</span>(condition-<span class="hljs-number">1</span>: value-<span class="hljs-number">1</span>; condition-<span class="hljs-number">2</span>: value-<span class="hljs-number">2</span>; condition-<span class="hljs-number">3</span>: value-<span class="hljs-number">3</span>; else: default-value);
</code></pre>
<p>函数按顺序检查条件并应用第一个匹配的值；若没有条件匹配，则使用 <code>else</code> 的值。这一语义与常见编程语言一致，但实现于纯 CSS。</p>
<h3 data-id="heading-2">if() 的三种能力</h3>
<h4 data-id="heading-3">样式查询（Style queries）</h4>
<p>使用 <code>style()</code> 可响应 CSS 自定义属性：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-attr">--status</span>: <span class="hljs-built_in">attr</span>(data-status <span class="hljs-built_in">type</span>(&lt;custom-ident&gt;));

  <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--status: pending): royalblue; style(<span class="hljs-attr">--status</span>: complete): seagreen; style(<span class="hljs-attr">--status</span>: error): crimson; else: gray);
}
</code></pre>
<p>一个 <code>data-status</code> 属性即可驱动对应样式，无需额外工具类。</p>
<h4 data-id="heading-4">媒体查询（Media queries）</h4>
<p>使用 <code>media()</code> 可以在属性内联定义响应式值，无需嵌套媒体查询块：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">h1</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">media</span>(width &gt;= <span class="hljs-number">1200px</span>): <span class="hljs-number">3rem</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">768px</span>): <span class="hljs-number">2.5rem</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">480px</span>): <span class="hljs-number">2rem</span>; else: <span class="hljs-number">1.75rem</span>);
}
</code></pre>
<h4 data-id="heading-5">特性检测（Feature detection）</h4>
<p>使用 <code>supports()</code> 可在属性中直接进行特性检测，并提供明确回退：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.element</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">supports</span>(color: <span class="hljs-built_in">lch</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>)): <span class="hljs-built_in">lch</span>(<span class="hljs-number">50%</span> <span class="hljs-number">100</span> <span class="hljs-number">150</span>) ; supports(<span class="hljs-attribute">color</span>: <span class="hljs-built_in">lab</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>)): <span class="hljs-built_in">lab</span>(<span class="hljs-number">50</span> <span class="hljs-number">100</span> -<span class="hljs-number">50</span>) ; else: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">200</span>, <span class="hljs-number">100</span>, <span class="hljs-number">50</span>));
}
</code></pre>
<h3 data-id="heading-6">真实用例</h3>
<h4 data-id="heading-7">暗色模式示例</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attr">--theme</span>: <span class="hljs-string">'dark'</span>; <span class="hljs-comment">/* 通过 JavaScript 或用户偏好切换 */</span>

  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--theme: <span class="hljs-string">'dark'</span>): <span class="hljs-number">#1a1a1a</span>; else: white);

  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--theme: <span class="hljs-string">'dark'</span>): <span class="hljs-number">#e4e4e4</span>; else: <span class="hljs-number">#333</span>);
}
</code></pre>
<h4 data-id="heading-8">设计系统状态组件</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.alert</span> {
  <span class="hljs-attr">--type</span>: <span class="hljs-built_in">attr</span>(data-type <span class="hljs-built_in">type</span>(&lt;custom-ident&gt;));

  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--type: success): <span class="hljs-number">#d4edda</span>; style(<span class="hljs-attr">--type</span>: warning): <span class="hljs-number">#fff3cd</span>; style(<span class="hljs-attr">--type</span>: danger): <span class="hljs-number">#f8d7da</span>; style(<span class="hljs-attr">--type</span>: info): <span class="hljs-number">#d1ecf1</span>; else: <span class="hljs-number">#f8f9fa</span>);

  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--type: success): <span class="hljs-number">#28a745</span>; style(<span class="hljs-attr">--type</span>: warning): <span class="hljs-number">#ffc107</span>; style(<span class="hljs-attr">--type</span>: danger): <span class="hljs-number">#dc3545</span>; style(<span class="hljs-attr">--type</span>: info): <span class="hljs-number">#17a2b8</span>; else: <span class="hljs-number">#6c757d</span>);
}
</code></pre>
<h4 data-id="heading-9">容器尺寸示例（简化媒体查询）</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">media</span>(width &gt;= <span class="hljs-number">1400px</span>): <span class="hljs-number">1320px</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">1200px</span>): <span class="hljs-number">1140px</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">992px</span>): <span class="hljs-number">960px</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">768px</span>): <span class="hljs-number">720px</span>; media(<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">576px</span>): <span class="hljs-number">540px</span>; else: <span class="hljs-number">100%</span>);

  <span class="hljs-attribute">padding-inline</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">media</span>(width &gt;= <span class="hljs-number">768px</span>): <span class="hljs-number">2rem</span>; else: <span class="hljs-number">1rem</span>);
}
</code></pre>
<h4 data-id="heading-10">与现代 CSS 特性结合</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.element</span> {
  <span class="hljs-comment">/* 搭配新的 light-dark() 函数 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--high-contrast: true): black; else: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#333</span>, <span class="hljs-number">#e4e4e4</span>));

  <span class="hljs-comment">/* 搭配 CSS 自定义函数（@function） */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--spacing: loose): <span class="hljs-built_in">--spacing-function</span>(<span class="hljs-number">2</span>) ; style(<span class="hljs-attr">--spacing</span>: tight): <span class="hljs-built_in">--spacing-function</span>(<span class="hljs-number">0.5</span>) ; else: <span class="hljs-built_in">--spacing-function</span>(<span class="hljs-number">1</span>));
}
</code></pre>
<h3 data-id="heading-11">浏览器支持</h3>
<p>支持情况（截至 2025 年 8 月）：</p>
<ul>
<li>✅ Chrome/Edge：自 137 版起</li>
<li>✅ Chrome Android：自 139 版起</li>
<li>❌ Firefox：开发中</li>
<li>❌ Safari：在规划中</li>
<li>❌ Opera：尚未支持</li>
</ul>
<p>在尚未完全支持的环境中，可采用如下写法：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.button</span> {
  <span class="hljs-comment">/* 所有浏览器的回退 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span> <span class="hljs-number">2rem</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>;

  <span class="hljs-comment">/* 现代浏览器会自动覆盖 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--size: small): <span class="hljs-number">0.5rem</span> <span class="hljs-number">1rem</span>; style(<span class="hljs-attr">--size</span>: large): <span class="hljs-number">1.5rem</span> <span class="hljs-number">3rem</span>; else: <span class="hljs-number">1rem</span> <span class="hljs-number">2rem</span>);

  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--variant: primary): <span class="hljs-number">#007bff</span>; style(<span class="hljs-attr">--variant</span>: success): <span class="hljs-number">#28a745</span>; style(<span class="hljs-attr">--variant</span>: danger): <span class="hljs-number">#dc3545</span>; else: <span class="hljs-number">#6c757d</span>);
}
</code></pre>
<h3 data-id="heading-12">未来展望</h3>
<p>CSS 工作组已经在推进扩展能力：</p>
<ul>
<li>范围查询：<code>if(style(--value &gt; 100): ...)</code></li>
<li>逻辑运算符：<code>if(style(--a: true) and style(--b: false): ...)</code></li>
<li>容器查询集成：更强的上下文感知</li>
</ul>
<p>在使用前建议评估目标浏览器版本，并准备相应回退方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于魔改Nightingale源码浅谈go语言包模块管理]]></title>    <link>https://juejin.cn/post/7571672422690078772</link>    <guid>https://juejin.cn/post/7571672422690078772</guid>    <pubDate>2025-11-13T01:54:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571672422690078772" data-draft-id="7571672422690062388" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于魔改Nightingale源码浅谈go语言包模块管理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T01:54:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shark_chili"/> <meta itemprop="url" content="https://juejin.cn/user/2858385964801672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于魔改Nightingale源码浅谈go语言包模块管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385964801672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shark_chili
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:54:52.000Z" title="Thu Nov 13 2025 01:54:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在文章开头</h2>
<p>对于<code>java</code>开发而言，每一个项目完成之后都会打成一个<code>jar</code>包即中间层代码，所以可借由依赖包管理工具<code>maven</code>完成导入，而go语言没有中间字节码这样的一个过程，所以引入第三方依赖的方式都是通过源码，随着人们对于方案的不断探索，对于go语言的方式管理也别有了如下两种主流方案：</p>
<ol>
<li>go get引入</li>
<li>go vendor本地缓存</li>
</ol>
<p>而本文将结合笔者近期针对性的魔改Nightingale底层的es客户端的经历来演示一下go语言中包管理，希望对你有帮助。</p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-1">详解go modules的使用</h2>
<h3 data-id="heading-2">项目初始化</h3>
<p>我们通过<code>goland</code>创建一个名为<code>awesomeProject</code>项目，默认情况下<code>goland</code>为默认为我们生成一个<code>go.mod</code>文件，其内容标明：</p>
<ol>
<li>项目名称即awesomeProject</li>
<li><code>golang</code>的版本号1.23</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">module</span> awesomeProject


go <span class="hljs-number">1.23</span>
</code></pre>
<p>此时，笔者项目的目录结构如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93cecb5e8376431dbccb386c1ca1405c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=UdMLV%2FA%2FaxnqZnpxUG5E5LYPKF4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">基于go get演示导入elastic</h3>
<p>因为<code>Nightingale</code>这个监控工具底层的es客户端不兼容es9，所以经过笔者调试发现其底层query表达式不正确，遂打算引入这个已被废弃的客户端调试一探究竟，按照go语言主流的包管理办法，通用管理步骤为：</p>
<ol>
<li>项目上传到git</li>
<li>针对该项目打好tag标签</li>
<li>通过go get指令获取指定tag的依赖包</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d4a2494e0b0453d9710b1f6612f97e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=7tetrfnus2Jt1cVYUXnzjSgUbT8%3D" alt="" loading="lazy"/></p>
<p>例如笔者想引入<code>https://github.com/olivere/elastic</code>这个第三方es客户端管理包，通过查看其go.mod对应模块名为：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">module</span> github.com/olivere/elastic/v7
</code></pre>
<p>查看其依赖包对应最新版本为<code>7.0.32</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ecedaa259284f81b3f21e2ed47af9ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=35bEhb8KGn1XgMx2NKhsIIPCw4I%3D" alt="" loading="lazy"/></p>
<p>对应的我们就可以忽略前两步骤，直接在本地项目中呼出终端执行<code>go get 模块名@版本号</code>对应笔者的请求就是：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">go <span class="hljs-keyword">get</span> github.com/olivere/elastic/<span class="hljs-symbol">v7@</span>v7<span class="hljs-number">.0</span><span class="hljs-number">.32</span>
</code></pre>
<p>随后我们就可以愉快的使用这个模块包了： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82efa1cf68e3431680ced41c474cf04d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=x5T3nFmzJoO%2FH%2B%2FNFACK6t0oqX0%3D" alt="" loading="lazy"/></p>
<p>此时我们就可以正常的引用和管理这个模块了，相比于java，因为go语言模块的引入都是引入源代码，所以我们完全可以直接通过<code>IDE</code>修改源码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b137502748ae4865815c7734864c89cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=Dt682SF4XfTvEPIa%2Bbzs9TjNHU4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">基于go vendor本地化三方依赖库</h3>
<p>当然上述方案仅仅支持允许联网的情况，对于封网开发的读者可以通过go mod vendor将这个依赖直接缓存到本地进行调测开发：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74d17b4fea374355be017cc37eec6fe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=koH8byac%2Fhxoy4OWx46Vin%2Fcxms%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">基于魔改Nightingale底层es客户端源码演示go语言三方包管理</h2>
<h3 data-id="heading-6">魔改三方包通用步骤</h3>
<p>有了上述的基本概念，我们就来演示一个如果魔改已放弃维护的开源项目的通用套路，大体流程也很上述go get差不多，即基于github维度进行版本管理以及go get引入，只不过要修改第三方项目的源码，我们需要首先将项目fork到我们的仓库，以笔者本地修改的elastic为例，对应的执行步骤为：</p>
<ol>
<li>将停止维护的elastic客户端fork到个人仓库</li>
<li>clone本地</li>
<li>修改代码，并打tag(如果为了省事也可以用最新版，无需指明tag，笔者后文会介绍)提交到个人仓库</li>
<li>其他项目通过go get引入源项目地址并通过replace指向我们的项目</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62c9f60de097469481acd8be9614ef41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=1y7SkmaPmVVdYyey5Z%2FlawxP%2Bzk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">案例说明</h3>
<p>基于这个实践结合笔者近期接触到的一个这里日志告警工具Nightingale，笔者在接入es9数据源时发现，查询时返回了es服务端语法错误：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa8c6e6709af4d539c740da0c3f346e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=mflcizhuOnkU%2FVgUa%2FXBhyN%2BAK8%3D" alt="" loading="lazy"/></p>
<p>经过笔者的调测Nightingale底层的es客户端发现，其底层elastic生成的范围查询时间采用了from、to语法，最新版的es9并不支持这种格式，需改为gte和lte：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd93ad08fe74d6ebd5e185efb13ebce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=K1fKCYCn4M88nYbcrXTvrHotKQ4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">魔改适配步骤详解</h3>
<p>所以为了做到es9数据源适配，笔者就需要按照上述步骤的说法：</p>
<ol>
<li>fork已经不再维护的elastic</li>
<li>修改范围子查询源码</li>
<li>提交个人仓库</li>
<li>Nightingale源码使用replace将es客户端改为自己魔改后的版本</li>
</ol>
<p>针对fork和魔改操作笔者就不多做演示，这里笔者直接给出修改后的代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f074b1a83a564daa9052ae7c8ac76974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=LVXJNBrpdXRdIH6DqhPtv8AB4iA%3D" alt="" loading="lazy"/></p>
<p>当然笔者这里为了省事直接通过<code>go get module name@branch</code>获取最新版本，以笔者为例对应的指令为<code>go get github.com/shark-ctrl/elastic/v7@release-branch.v7</code>：</p>
<p>最终输出结果如下：</p>
<pre><code class="hljs language-bash" lang="bash">go: downloading github.com/shark-ctrl/elastic/v7 v7.0.0-20251112171420-808d8bfca650
go: added github.com/shark-ctrl/elastic/v7 v7.0.0-20251112171420-808d8bfca650
</code></pre>
<p>后续使用使用到魔改的项目直接采用replace修改引用的指向：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb36c1a461f64cd3921de899edb1a1df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=6D0XW%2BFqykx%2BpX1PVLifPWY18Cc%3D" alt="" loading="lazy"/></p>
<p>可以看到对应的es客户端就用到了笔者的魔改后的版本：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e8935a99029406eba3c0581b1f09f96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=dfzT8g9e4MSzhxNaWEhfxZSTmLA%3D" alt="" loading="lazy"/></p>
<p>对应的es9的数据源查询也是可以了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a58c8456c9b541a8862946b8acb3ccbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=ZFgu%2F04kXBmNZ3oJoxWQpvMKEcU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">小结</h2>
<p>相比于java源码的改造，go语言的特性使得采用go get指令和replace魔改开源工具更加从容且直观，本文这次针对Nightingale的数据源适配本质就是利用了go get对于三方工具的统一维护结合fork修改和Go mod replace完成底层数据源的适配。</p>
<p>需要补充说明一件事，就在笔者完成这个数据源适配且准备在项目组调测时，Nightingale的作者似乎也在近期完成了这个适配，所以本次的魔改工作就当是对于读者一次学习的普及吧： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0ca0c98a31443578856699c835d8135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603692&amp;x-signature=6ZdtWmnDhkNvhFJgAw1ST8k4dMM%3D" alt="" loading="lazy"/></p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-10">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Fgo-elasticsearch%2Ftree%2Fmain" target="_blank" title="https://github.com/elastic/go-elasticsearch/tree/main" ref="nofollow noopener noreferrer">github.com/elastic/go-…</a> go mod 和 go vendor 使用与区别:<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F374044583" target="_blank" title="https://zhuanlan.zhihu.com/p/374044583" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/374044583</a> Gomodvendor使用教程与依赖管理技巧:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.17golang.com%2Farticle%2F245274.html" target="_blank" title="https://www.17golang.com/article/245274.html" ref="nofollow noopener noreferrer">www.17golang.com/article/245…</a></p>
<p>深入理解 Go Modules 的 go.mod 与 go.sum :<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2020911" target="_blank" title="https://cloud.tencent.com/developer/article/2020911" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a></p>
<p>使用go module导入本地包:<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F109828249" target="_blank" title="https://zhuanlan.zhihu.com/p/109828249" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/109828249</a></p>
<p>Golang实战：从零开始构建并发布自己的Go语言库到GitHub及Go Module管理:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oryoy.com%2Fnews%2Fgolang-shi-zhan-cong-ling-kai-shi-gou-jian-bing-fa-bu-zi-ji-de-go-yu-yan-ku-dao-github-ji-go-module.html" target="_blank" title="https://www.oryoy.com/news/golang-shi-zhan-cong-ling-kai-shi-gou-jian-bing-fa-bu-zi-ji-de-go-yu-yan-ku-dao-github-ji-go-module.html" ref="nofollow noopener noreferrer">www.oryoy.com/news/golang…</a></p>
<p>Go mod replace 使用:<a href="https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000040179648" target="_blank" title="https://segmentfault.com/a/1190000040179648" ref="nofollow noopener noreferrer">segmentfault.com/a/119000004…</a></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用户中心微服务设计指南：从功能到非功能的全维度落地]]></title>    <link>https://juejin.cn/post/7571729676344262719</link>    <guid>https://juejin.cn/post/7571729676344262719</guid>    <pubDate>2025-11-13T02:55:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571729676344262719" data-draft-id="7571729676344246335" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用户中心微服务设计指南：从功能到非功能的全维度落地"/> <meta itemprop="keywords" content="后端,微服务"/> <meta itemprop="datePublished" content="2025-11-13T02:55:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用户中心微服务设计指南：从功能到非功能的全维度落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:55:39.000Z" title="Thu Nov 13 2025 02:55:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用户中心微服务设计指南：从功能到非功能的全维度落地</h2>
<p>在微服务架构中，用户中心是 “地基级” 服务 —— 所有业务模块（订单、支付、内容）都依赖其提供的用户认证、权限校验、信息查询能力。但很多团队设计时容易陷入 “只做用户 CRUD” 的误区，忽略权限控制、审计日志、高可用等非功能性需求，导致后期业务扩张时重构成本极高。</p>
<p>本文将从 “业务价值→架构设计→功能实现→非功能保障” 四个层面，完整讲解用户中心微服务的设计思路，尤其聚焦权限、审计、安全等关键非功能点，提供可直接落地的方案。</p>
<h3 data-id="heading-1">一、先明确：用户中心微服务的核心定位与边界</h3>
<p>设计前必须划清 “职责范围”，避免服务膨胀为 “万能工具”。用户中心的核心定位是 “<strong>统一的用户身份与权限管理入口</strong>”，具体边界如下：</p>





























<table><thead><tr><th>核心职责（必做）</th><th>非核心职责（不做 / 外包）</th></tr></thead><tbody><tr><td>1. 用户基础信息管理（注册、登录、资料 CRUD）</td><td>1. 具体业务数据存储（如用户订单、积分）</td></tr><tr><td>2. 认证授权（令牌生成、权限校验）</td><td>2. 业务逻辑处理（如用户等级计算）</td></tr><tr><td>3. 权限控制（角色、功能 / 数据权限管理）</td><td>3. 第三方业务集成（如用户营销活动）</td></tr><tr><td>4. 审计日志（用户操作、权限变更记录）</td><td>4. 大规模数据分析（如用户行为画像）</td></tr><tr><td>5. 第三方登录集成（微信、QQ、OAuth2）</td><td/></tr></tbody></table>
<p><strong>举例</strong>：用户积分属于业务数据，应存放在 “积分服务”，用户中心只需提供 “用户 ID” 作为关联标识，无需存储积分数值 —— 这是 “单一职责” 原则的核心体现。</p>
<h3 data-id="heading-2">二、架构设计：模块划分与技术选型</h3>
<p>基于核心职责，将用户中心拆分为 “松耦合模块”，每个模块独立部署、迭代，同时选择适配高并发、高安全的技术栈。</p>
<h4 data-id="heading-3">1. 核心模块划分（分层架构）</h4>
<p>采用 “接入层→业务层→数据层” 三层架构，每层拆分为细分模块：</p>
<pre><code class="hljs language-bash" lang="bash">用户中心微服务
├─ 接入层（API Gateway）
│  ├─ 接口鉴权模块（统一验证令牌、防刷）
│  ├─ 接口版本控制（如/v1/user/info）
│  └─ 流量控制模块（限流、熔断、降级）
├─ 业务层（核心功能）
│  ├─ 用户管理模块（注册、登录、资料CRUD、密码重置）
│  ├─ 认证授权模块（JWT/OAuth2令牌、会话管理）
│  ├─ 权限控制模块（角色管理、功能权限、数据权限）
│  ├─ 审计日志模块（操作记录、日志查询、告警）
│  └─ 第三方集成模块（微信/QQ登录、短信/邮箱验证）
└─ 数据层（存储）
   ├─ 关系型数据库（MySQL：用户、角色、权限表）
   ├─ 缓存（Redis：会话、权限缓存、登录验证码）
   ├─ 日志存储（Elasticsearch：审计日志，支持全文检索）
   └─ 消息队列（Kafka：用户数据变更事件，同步到其他服务）
</code></pre>
<h4 data-id="heading-4">2. 技术栈选型（适配非功能性需求）</h4>
<p>技术选型需优先满足 “安全、高可用、可扩展”，具体如下：</p>


















































<table><thead><tr><th>技术类别</th><th>推荐选型</th><th>选型理由</th></tr></thead><tbody><tr><td>开发语言</td><td>Java（Spring Cloud/Spring Boot）</td><td>生态完善，安全组件丰富（Spring Security），适合企业级权限控制</td></tr><tr><td>关系型数据库</td><td>MySQL（主从架构 + 分库分表）</td><td>支持事务，适合存储用户、角色等强一致性数据；用户量大时用 ShardingSphere 分表</td></tr><tr><td>缓存</td><td>Redis Cluster</td><td>高性能，支持分布式锁（用于并发登录控制），适合存储会话和权限缓存</td></tr><tr><td>认证协议</td><td>JWT + OAuth2.0（授权码模式）</td><td>JWT 无状态便于扩展，OAuth2.0 支持第三方授权（如微信登录）</td></tr><tr><td>权限框架</td><td>Spring Security + Spring Cloud Security</td><td>与 Spring 生态无缝集成，支持 RBAC 权限模型，可自定义权限校验逻辑</td></tr><tr><td>日志存储</td><td>Elasticsearch + Kibana</td><td>支持海量日志存储和全文检索，便于审计日志的多维度查询（如按用户 ID、操作类型）</td></tr><tr><td>消息队列</td><td>Kafka</td><td>高吞吐，确保用户数据变更事件（如用户注册、权限修改）可靠同步到其他服务</td></tr><tr><td>API 网关</td><td>Spring Cloud Gateway</td><td>轻量、高性能，支持动态路由、限流、鉴权，统一接入入口</td></tr></tbody></table>
<h3 data-id="heading-5">三、核心功能设计：从 “能用” 到 “好用”</h3>
<h4 data-id="heading-6">1. 用户管理模块（基础功能）</h4>
<p>核心是 “安全的用户生命周期管理”，重点解决注册登录的安全性与便捷性：</p>
<h5 data-id="heading-7">（1）用户注册流程（防恶意注册）</h5>
<pre><code class="hljs">用户提交手机号/邮箱 → 发送验证码（Redis缓存，5分钟过期） → 验证验证码 → 密码加密存储 → 生成用户ID → 发送“用户注册事件”到Kafka
</code></pre>
<ul>
<li><strong>密码加密</strong>：用 BCrypt 算法（自动加盐，不可逆），避免明文 / MD5 存储（Spring Security 默认支持 BCrypt）；</li>
</ul>

<ul>
<li><strong>防恶意注册</strong>：同一 IP / 设备 1 小时内最多发送 5 次验证码（Redis 记录次数），验证码绑定设备 ID。</li>
</ul>
<h5 data-id="heading-8">（2）用户登录流程（支持多端登录）</h5>
<pre><code class="hljs">用户提交账号密码 → 校验账号密码 → 生成JWT令牌（包含用户ID、角色、过期时间） → Redis存储会话（用户ID→设备列表，支持踢下线） → 返回令牌
</code></pre>
<ul>
<li><strong>JWT 令牌结构</strong>：</li>
</ul>
<p>Header（算法）+ Payload（用户 ID:123, 角色:admin, exp:1688888888）+ Signature（密钥签名，防止篡改）；</p>
<ul>
<li><strong>多端登录控制</strong>：Redis 存储user:session:{userID}为 Hash 结构，key = 设备 ID，value=JWT 令牌，支持 “单端登录”（新登录踢掉旧登录）或 “多端登录”（最多 3 台设备）。</li>
</ul>
<h4 data-id="heading-9">2. 认证授权模块（核心非功能）</h4>
<p>解决 “谁能访问什么资源” 的问题，基于 OAuth2.0 + JWT 实现：</p>
<h5 data-id="heading-10">（1）认证流程（统一鉴权）</h5>
<p>所有业务服务的请求需经过 API 网关，鉴权流程如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 客户端携带JWT令牌请求API网关；
<span class="hljs-bullet">2.</span> 网关验证令牌签名与过期时间（无需查库，JWT无状态）；
<span class="hljs-bullet">3.</span> 令牌有效则解析用户信息（用户ID、角色），转发到对应微服务；
<span class="hljs-bullet">4.</span> 令牌无效/过期则返回401未授权。
</code></pre>
<ul>
<li><strong>令牌刷新</strong>：JWT 设置短期过期（如 2 小时），同时生成 “刷新令牌”（过期时间 7 天，存储在 Redis），令牌过期时用刷新令牌重新获取 JWT，避免频繁登录。</li>
</ul>
<h5 data-id="heading-11">（2）第三方登录集成（如微信登录）</h5>
<p>基于 OAuth2.0 授权码模式，流程如下：</p>
<pre><code class="hljs">用户点击微信登录 → 跳转微信授权页 → 用户授权后获取授权码 → 用授权码换微信OpenID → 查用户中心是否绑定OpenID（已绑定则直接登录，未绑定则引导绑定手机号） → 生成JWT令牌
</code></pre>
<h4 data-id="heading-12">3. 权限控制模块（重点非功能）</h4>
<p>权限控制是用户中心的 “灵魂”，需同时支持 “功能权限”（能不能操作某个按钮）和 “数据权限”（能不能看某类数据），推荐采用<strong>RBAC（基于角色的访问控制）模型</strong>。</p>
<h5 data-id="heading-13">（1）RBAC 模型设计（表结构）</h5>
<p>核心表结构如下，通过关联实现 “用户 - 角色 - 权限” 的灵活映射：</p>



































<table><thead><tr><th>表名</th><th>核心字段</th><th>作用</th></tr></thead><tbody><tr><td>sys_user</td><td>user_id, username, password（BCrypt 加密）, status（启用 / 禁用）</td><td>存储用户基础信息</td></tr><tr><td>sys_role</td><td>role_id, role_name, role_code（如 admin、user）, description</td><td>存储角色（如管理员、普通用户、运营）</td></tr><tr><td>sys_permission</td><td>perm_id, perm_name, perm_type（menu/button/api）, perm_url, perm_method</td><td>存储权限（如 “用户删除” 按钮、“/api/user/delete” 接口）</td></tr><tr><td>sys_user_role</td><td>id, user_id, role_id</td><td>用户与角色的多对多关联</td></tr><tr><td>sys_role_permission</td><td>id, role_id, perm_id</td><td>角色与权限的多对多关联</td></tr></tbody></table>
<h5 data-id="heading-14">（2）功能权限校验（接口级控制）</h5>
<ul>
<li><strong>权限缓存</strong>：用户登录时，从数据库查询 “用户→角色→权限”，将权限列表（如/api/user/delete、/api/role/list）缓存到 Redis，Key=user:perm:{userID}，过期时间与 JWT 一致；</li>
</ul>

<ul>
<li><strong>接口校验</strong>：在需要权限的接口上添加注解（如@PreAuthorize("hasPermission('/api/user/delete', 'api')")），Spring Security 会自动从 Redis 获取用户权限并校验，无权限则返回 403。</li>
</ul>
<h5 data-id="heading-15">（3）数据权限控制（数据级隔离）</h5>
<p>解决 “同角色不同用户看不同数据” 的问题（如运营 A 只能看北京地区用户，运营 B 只能看上海地区）：</p>
<ul>
<li><strong>设计思路</strong>：在用户表 / 角色表中添加 “数据权限范围” 字段（如data_scope: beijing），查询数据时动态拼接条件（where region = #{dataScope}）；</li>
</ul>

<ul>
<li><strong>实现方式</strong>：用 MyBatis 插件拦截 SQL，根据当前用户的data_scope自动添加数据权限条件，无需在每个 SQL 中手动写条件。</li>
</ul>
<h4 data-id="heading-16">4. 审计日志模块（关键非功能）</h4>
<p>审计日志是 “安全追溯” 的核心，需记录 “谁在什么时间做了什么操作，结果如何”，满足合规要求（如金融行业的审计需求）。</p>
<h5 data-id="heading-17">（1）日志内容设计（必含字段）</h5>
<p>每条审计日志需包含以下字段，确保可追溯：</p>






































































<table><thead><tr><th>字段名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>log_id</td><td>字符串</td><td>唯一 ID（UUID）</td></tr><tr><td>user_id</td><td>字符串</td><td>操作人 ID（匿名操作填 “anonymous”）</td></tr><tr><td>user_name</td><td>字符串</td><td>操作人姓名（便于人工排查）</td></tr><tr><td>operation_type</td><td>枚举</td><td>操作类型（如 USER_CREATE、PERMISSION_UPDATE、LOGIN_SUCCESS、LOGIN_FAILED）</td></tr><tr><td>resource_type</td><td>枚举</td><td>操作资源（如 USER、ROLE、PERMISSION、LOGIN）</td></tr><tr><td>resource_id</td><td>字符串</td><td>操作资源 ID（如用户 ID、角色 ID）</td></tr><tr><td>operation_detail</td><td>字符串</td><td>操作详情（JSON 格式，如{"old_password":"<em><strong>","new_password":"</strong></em>"}，敏感信息脱敏）</td></tr><tr><td>client_ip</td><td>字符串</td><td>操作 IP 地址（便于定位恶意操作）</td></tr><tr><td>client_device</td><td>字符串</td><td>操作设备（如 “Chrome/Windows 10”，解析 User-Agent）</td></tr><tr><td>operation_time</td><td>时间戳</td><td>操作时间（毫秒级）</td></tr><tr><td>result</td><td>枚举</td><td>操作结果（SUCCESS/FAIL）</td></tr><tr><td>fail_reason</td><td>字符串</td><td>失败原因（如 “密码错误”“权限不足”，失败时必填）</td></tr></tbody></table>
<h5 data-id="heading-18">（2）日志记录流程（异步无感知）</h5>
<p>通过 “AOP 切面” 自动记录日志，不侵入业务代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-number">1.</span> 定义日志注解（如<span class="hljs-meta">@AuditLog(operationType = <span class="hljs-string">"USER_UPDATE"</span>, resourceType = <span class="hljs-string">"USER"</span>)</span>）；
<span class="hljs-number">2.</span> 在需要记录日志的接口方法上添加注解；
<span class="hljs-number">3.</span> 编写AOP切面，拦截带有<span class="hljs-meta">@AuditLog</span>的方法，自动采集日志字段（如从JWT获取user_id，从请求获取IP）；
<span class="hljs-number">4.</span> 异步将日志发送到Kafka，由消费者写入Elasticsearch；
<span class="hljs-number">5.</span> 提供日志查询接口（支持按user_id、operation_type、时间范围查询），前端用Kibana或自定义页面展示。
</code></pre>
<ul>
<li><strong>敏感信息脱敏</strong>：切面中对密码、手机号等敏感信息进行脱敏（如手机号显示为 “138****5678”），避免日志泄露隐私。</li>
</ul>
<h3 data-id="heading-19">四、非功能性需求落地：从 “能用” 到 “可靠”</h3>
<p>用户中心的非功能性需求直接决定服务的 “稳定性与安全性”，需重点设计：</p>
<h4 data-id="heading-20">1. 安全性（防攻击、防泄露）</h4>
<h5 data-id="heading-21">（1）数据安全</h5>
<ul>
<li><strong>传输安全</strong>：所有接口强制使用 HTTPS，防止数据被抓包窃取；</li>
</ul>

<ul>
<li><strong>存储安全</strong>：密码用 BCrypt 加密，敏感信息（如手机号、邮箱）用 AES 加密存储，密钥存在配置中心（如 Nacos）；</li>
</ul>

<ul>
<li><strong>脱敏展示</strong>：接口返回用户信息时，对敏感字段脱敏（如{"phone":"138<strong><strong>5678","email":"123</strong></strong>@qq.com"}）。</li>
</ul>
<h5 data-id="heading-22">（2）接口安全</h5>
<ul>
<li><strong>防 SQL 注入</strong>：用 MyBatis 参数绑定（#{}），避免拼接 SQL；</li>
</ul>

<ul>
<li><strong>防 XSS 攻击</strong>：API 网关层用过滤器过滤请求参数中的脚本标签（如
</li></ul>

<ul>
<li><strong>防 CSRF 攻击</strong>：前后端分离场景下，用 JWT 令牌的iss（签发者）字段校验来源，或在前端存储 CSRF 令牌；</li>
</ul>

<ul>
<li><strong>接口防刷</strong>：API 网关层对高频接口（如登录、验证码发送）限流，同一 IP / 用户 ID 每分钟最多请求 10 次（Redis 记录请求次数）。</li>
</ul>
<h5 data-id="heading-23">（3）权限安全</h5>
<ul>
<li><strong>最小权限原则</strong>：默认用户只分配 “必要权限”（如普通用户无角色管理权限）；</li>
</ul>

<ul>
<li><strong>权限变更审计</strong>：角色、权限的新增 / 修改 / 删除必须记录审计日志，支持追溯；</li>
</ul>

<ul>
<li><strong>会话安全</strong>：用户注销时删除 Redis 中的会话和 JWT 黑名单（Redis 存储已注销的 JWT，有效期与 JWT 过期时间一致），防止令牌复用。</li>
</ul>
<h4 data-id="heading-24">2. 高可用性（避免单点故障）</h4>
<h5 data-id="heading-25">（1）服务高可用</h5>
<ul>
<li><strong>集群部署</strong>：用户中心服务部署多个实例（至少 3 个），注册到 Nacos/Eureka，API 网关自动负载均衡；</li>
</ul>

<ul>
<li><strong>熔断降级</strong>：用 Sentinel 对依赖的服务（如短信服务、第三方登录接口）熔断，避免依赖故障导致用户中心不可用（如短信服务挂了，临时允许验证码跳过）；</li>
</ul>

<ul>
<li><strong>容灾备份</strong>：MySQL 采用主从架构，主库故障时自动切换到从库；Redis 用 Cluster 架构，至少 3 主 3 从，避免缓存单点故障。</li>
</ul>
<h5 data-id="heading-26">（2）数据高可用</h5>
<ul>
<li><strong>数据库备份</strong>：MySQL 每日全量备份 + 增量备份（binlog），确保数据可恢复；</li>
</ul>

<ul>
<li><strong>缓存穿透防护</strong>：对不存在的用户 ID 请求（如/api/user/info?userID=99999），缓存空结果（10 分钟过期），避免穿透到数据库；</li>
</ul>

<ul>
<li><strong>缓存雪崩防护</strong>：Redis 缓存设置随机过期时间（如 JWT 缓存 2 小时 ±5 分钟），避免同一时间大量缓存失效导致数据库压力骤增。</li>
</ul>
<h4 data-id="heading-27">3. 可扩展性（适配业务增长）</h4>
<h5 data-id="heading-28">（1）水平扩展</h5>
<ul>
<li><strong>无状态设计</strong>：用户中心服务不存储本地会话（会话存在 Redis），新增实例即可扩展性能；</li>
</ul>

<ul>
<li><strong>分库分表</strong>：用户量超千万时，用 ShardingSphere 按user_id哈希分表（如分 16 张表），避免单表数据量过大导致查询缓慢。</li>
</ul>
<h5 data-id="heading-29">（2）功能扩展</h5>
<ul>
<li><strong>多租户支持</strong>：在用户表、角色表中添加tenant_id字段，隔离不同租户的用户数据，适配 SaaS 平台场景；</li>
</ul>

<ul>
<li><strong>自定义权限扩展</strong>：支持业务方通过 “权限注册接口” 添加自定义权限（如订单服务的 “订单查看权限”），用户中心统一管理；</li>
</ul>

<ul>
<li><strong>第三方登录扩展</strong>：设计 “第三方登录适配器”，新增登录渠道（如 Apple 登录、Google 登录）时，只需实现适配器接口，无需修改核心逻辑。</li>
</ul>
<h4 data-id="heading-30">4. 性能优化（低延迟、高吞吐）</h4>
<ul>
<li><strong>缓存优化</strong>：用户基础信息、角色权限列表缓存到 Redis，查询接口从缓存获取，缓存命中率达 95% 以上；</li>
</ul>

<ul>
<li><strong>异步处理</strong>：非实时操作（如发送注册成功短信、同步用户数据到其他服务）用 Kafka 异步处理，减少接口响应时间；</li>
</ul>

<ul>
<li><strong>SQL 优化</strong>：用户、角色、权限表添加索引（如user_id、role_id、perm_url），避免全表扫描；复杂权限查询用 “预计算 + 缓存”，减少关联查询。</li>
</ul>
<h3 data-id="heading-31">五、实践落地建议：避坑与最佳实践</h3>
<ol>
<li><strong>先做 MVP 版本</strong>：初期优先实现 “用户注册登录 + 基础 RBAC 权限 + 简单审计日志”，避免过度设计；</li>
</ol>

<ol start="2">
<li><strong>接口规范统一</strong>：采用 RESTful 风格，接口路径、参数命名、返回格式统一（如返回{"code":200,"msg":"success","data":{}}），方便其他服务集成；</li>
</ol>

<ol start="3">
<li><strong>监控告警到位</strong>：部署 Prometheus+Grafana 监控服务 CPU、内存、接口响应时间，设置告警阈值（如接口响应时间 &gt; 500ms 告警）；对异常登录（如异地登录、连续失败 5 次）发送短信告警给用户；</li>
</ol>

<ol start="4">
<li><strong>灰度发布</strong>：新增功能（如第三方登录）采用灰度发布，先对 10% 用户开放，验证无问题后全量上线；</li>
</ol>

<ol start="5">
<li><strong>文档完善</strong>：编写 API 文档（用 Swagger/knife4j）和运维文档，说明部署步骤、扩容方案、故障处理流程，方便团队协作。</li>
</ol>
<h3 data-id="heading-32">总结</h3>
<p>用户中心微服务的设计核心是 “<strong>以用户为中心，以安全为底线，以扩展为目标</strong>”：</p>
<ul>
<li>功能上，需覆盖 “用户生命周期管理 + 认证授权 + 权限控制 + 审计日志”，满足业务与合规需求；</li>
</ul>

<ul>
<li>非功能上，需重点保障 “安全性、高可用性、可扩展性”，避免成为微服务架构的瓶颈；</li>
</ul>

<ul>
<li>落地时，需循序渐进，先实现核心功能，再逐步优化非功能点，同时注重文档与监控，降低维护成本。</li>
</ul>
<p>最终，一个优秀的用户中心不仅能支撑当前业务，还能随业务增长灵活扩展，成为微服务架构中稳定可靠的 “地基”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【vue3】这些不常用的API，却很实用]]></title>    <link>https://juejin.cn/post/7571726099689373715</link>    <guid>https://juejin.cn/post/7571726099689373715</guid>    <pubDate>2025-11-13T02:32:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571726099689373715" data-draft-id="7571731181197787172" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【vue3】这些不常用的API，却很实用"/> <meta itemprop="keywords" content="前端,Vue.js,面试"/> <meta itemprop="datePublished" content="2025-11-13T02:32:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="珑墨"/> <meta itemprop="url" content="https://juejin.cn/user/3069492194710797"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【vue3】这些不常用的API，却很实用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3069492194710797/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    珑墨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:32:17.000Z" title="Thu Nov 13 2025 02:32:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#2c3e50;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;font-weight:600;margin-top:35px;margin-bottom:8px;padding-bottom:5px}.markdown-body h1 :before,.markdown-body h2 :before,.markdown-body h3 :before,.markdown-body h4 :before,.markdown-body h5 :before,.markdown-body h6 :before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:8px;margin-top:50px;font-size:24px;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #eaecef;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;font-weight:400;background-color:rgba(27,31,35,.05);color:#476582;margin:0;font-size:.85em;border-radius:3px;font-size:.87em;padding:.165em .5em}.markdown-body code,.markdown-body pre{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.6;padding:20px 24px;background-color:#282c34;border-radius:6px}.markdown-body pre&gt;code{font-size:14px;padding:0;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff}.markdown-body a{text-decoration:none;color:#3eaf7c;font-weight:500}.markdown-body a:active,.markdown-body a:hover{color:#42b983;border-bottom:1px solid #42b983}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;margin:16px 0;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;background:#3eaf7c;color:#000;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f6f8fa}.markdown-body td,.markdown-body th{border:1px solid #dfe2e5;padding:10px 16px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{font-size:14px;padding:6px 23px;margin:22px 0;border-left:6px solid #42b983;background-color:#f3f5f7;font-weight:400}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body p,.markdown-body ul{line-height:1.7}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="base16/tomorrow-night">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在重构一个老移动端项目，用Vue3重写的过程中，发现了一些平时不太注意的API，但用起来真的很香。今天分享几个我觉得特别实用的，希望能帮到正在学习Vue3的jym。</p>
<h2 data-id="heading-0">1. shallowRef 和 shallowReactive - ‘大数据’性能提升</h2>
<p>先说个场景：你有一个很大的对象，里面嵌套了很多层数据，但你只需要最外层的变化触发更新。这时候用 <code>ref</code> 或 <code>reactive</code> 就会把所有嵌套都变成响应式的，性能开销很大。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, shallowRef, reactive, shallowReactive, triggerRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 普通 ref - 深度响应式</span>
<span class="hljs-keyword">const</span> deepData = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">profile</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
      <span class="hljs-attr">address</span>: {
        <span class="hljs-attr">city</span>: <span class="hljs-string">'北京'</span>,
        <span class="hljs-comment">// ... 还有很多层</span>
      }
    }
  }
})

<span class="hljs-comment">// shallowRef - 浅层响应式，只监听第一层</span>
<span class="hljs-keyword">const</span> shallowData = <span class="hljs-title function_">shallowRef</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">profile</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>
    }
  }
})

<span class="hljs-comment">// 只有直接替换整个对象才会触发更新</span>
shallowData.<span class="hljs-property">value</span> = { <span class="hljs-attr">user</span>: { <span class="hljs-attr">profile</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'王五'</span> } } } <span class="hljs-comment">// ✅ 会触发更新</span>

<span class="hljs-comment">// 修改内部属性不会触发更新</span>
shallowData.<span class="hljs-property">value</span>.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'赵六'</span> <span class="hljs-comment">// ❌ 不会触发更新</span>

<span class="hljs-comment">// 但可以用 triggerRef 手动触发更新</span>
shallowData.<span class="hljs-property">value</span>.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'赵六'</span>
<span class="hljs-title function_">triggerRef</span>(shallowData) <span class="hljs-comment">// ✅ 手动触发更新，视图会刷新</span>

<span class="hljs-comment">// shallowReactive - 浅层响应式的 reactive 版本</span>
<span class="hljs-keyword">const</span> shallowState = <span class="hljs-title function_">shallowReactive</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>
  }
})

shallowState.<span class="hljs-property">user</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> } <span class="hljs-comment">// ✅ 会触发更新</span>
shallowState.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'王五'</span> <span class="hljs-comment">// ❌ 不会触发更新</span>
</code></pre>
<p>我在处理表格数据的时候经常用这个，特别是那种几千行的数据，用 <code>shallowRef</code> 能明显感觉到性能提升。<code>shallowReactive</code> 和 <code>shallowRef</code> 的区别在于，前者直接返回响应式对象，后者返回的是包装后的 ref。</p>
<p><strong><code>triggerRef</code> 的使用场景</strong>：当你使用 <code>shallowRef</code> 时，如果确实需要修改嵌套属性并触发更新，但又不想替换整个对象（可能很耗性能），就可以先修改属性，然后调用 <code>triggerRef</code> 手动触发更新。这样既享受了浅层响应式的性能优势，又能在需要时精确控制更新时机。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实际应用：批量修改后统一触发更新</span>
<span class="hljs-keyword">const</span> tableData = <span class="hljs-title function_">shallowRef</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span> },
  <span class="hljs-comment">// ... 几千条数据</span>
])

<span class="hljs-comment">// 批量修改多个嵌套属性</span>
tableData.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  item.<span class="hljs-property">status</span> = <span class="hljs-string">'inactive'</span> <span class="hljs-comment">// 修改嵌套属性</span>
  item.<span class="hljs-property">updatedAt</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() <span class="hljs-comment">// 继续修改</span>
})

<span class="hljs-comment">// 所有修改完成后，统一触发一次更新（性能更好）</span>
<span class="hljs-title function_">triggerRef</span>(tableData) <span class="hljs-comment">// ✅ 只触发一次更新，而不是每条数据都触发</span>
</code></pre>
<h2 data-id="heading-1">2. markRaw - 让某些数据"免疫"响应式</h2>
<p>有些数据你明确知道不需要响应式，比如第三方库的实例、DOM元素、或者一些配置对象。用 <code>markRaw</code> 标记后，Vue就不会把它变成响应式的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive, markRaw } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-comment">// 这个第三方库实例不需要响应式</span>
  <span class="hljs-attr">chart</span>: <span class="hljs-title function_">markRaw</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChartLibrary</span>()),
  
  <span class="hljs-comment">// 这个配置对象也不需要</span>
  <span class="hljs-attr">config</span>: <span class="hljs-title function_">markRaw</span>({
    <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'https://api.example.com'</span>,
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>
  }),
  
  <span class="hljs-comment">// 这个需要响应式</span>
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
})

<span class="hljs-comment">// 即使把 chart 放到 reactive 里，它也不会变成响应式</span>
<span class="hljs-comment">// 这样既避免了不必要的性能开销，也防止了某些库因为响应式代理而出错</span>
</code></pre>
<p>我之前用 ECharts 的时候就遇到过这个问题，图表实例被响应式代理后各种报错，用 <code>markRaw</code> 一包就解决了。</p>
<h2 data-id="heading-2">3. toRaw - 获取原始对象</h2>
<p>有时候你需要拿到响应式对象的原始值，比如传给第三方库、或者做深拷贝。<code>toRaw</code> 就是干这个的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive, toRaw } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue3'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'3.0'</span>
})

<span class="hljs-comment">// 获取原始对象，不再是 Proxy</span>
<span class="hljs-keyword">const</span> rawState = <span class="hljs-title function_">toRaw</span>(state)

<span class="hljs-comment">// 传给需要普通对象的函数</span>
someThirdPartyLibrary.<span class="hljs-title function_">process</span>(rawState)

<span class="hljs-comment">// 或者做深拷贝</span>
<span class="hljs-keyword">const</span> copy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title function_">toRaw</span>(state)))
</code></pre>
<p>注意，<code>toRaw</code> 只能拿到一层，如果对象里还有嵌套的响应式对象，那些还是 Proxy。需要递归处理的话，可以配合 <code>markRaw</code> 使用。</p>
<h2 data-id="heading-3">4. customRef - 自定义响应式引用</h2>
<p>这个API特别适合做防抖、节流，或者需要自定义 get/set 逻辑的场景。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { customRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 防抖的 ref</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useDebouncedRef</span>(<span class="hljs-params">value, delay = <span class="hljs-number">200</span></span>) {
  <span class="hljs-keyword">let</span> timeout
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">customRef</span>(<span class="hljs-function">(<span class="hljs-params">track, trigger</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">track</span>() <span class="hljs-comment">// 追踪依赖</span>
        <span class="hljs-keyword">return</span> value
      },
      <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
        <span class="hljs-built_in">clearTimeout</span>(timeout)
        timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          value = newValue
          <span class="hljs-title function_">trigger</span>() <span class="hljs-comment">// 触发更新</span>
        }, delay)
      }
    }
  })
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> searchText = <span class="hljs-title function_">useDebouncedRef</span>(<span class="hljs-string">''</span>)

<span class="hljs-comment">// 用户输入时不会立即更新，等停止输入 200ms 后才更新</span>
</code></pre>
<p>我在搜索框里经常用这个，避免用户每输入一个字符就发一次请求。</p>
<h2 data-id="heading-4">5. readonly - 创建只读的响应式对象</h2>
<p>有时候你想让某些数据是响应式的（能追踪变化），但不允许修改。<code>readonly</code> 就派上用场了。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive, readonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> original = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue3'</span>
})

<span class="hljs-comment">// 创建只读版本</span>
<span class="hljs-keyword">const</span> readOnlyData = <span class="hljs-title function_">readonly</span>(original)

<span class="hljs-comment">// 可以读取</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(readOnlyData.<span class="hljs-property">count</span>) <span class="hljs-comment">// 0</span>

<span class="hljs-comment">// 不能修改（开发环境会警告）</span>
readOnlyData.<span class="hljs-property">count</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// ⚠️ 警告：Set operation on key "count" failed</span>

<span class="hljs-comment">// 但修改原始对象，只读版本也会更新</span>
original.<span class="hljs-property">count</span> = <span class="hljs-number">1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(readOnlyData.<span class="hljs-property">count</span>) <span class="hljs-comment">// 1 ✅</span>
</code></pre>
<p>这个在组件间传递 props 的时候很有用，特别是你想确保子组件不会意外修改父组件的数据。</p>
<h2 data-id="heading-5">6. getCurrentInstance - 获取当前组件实例</h2>
<p>这个API在组合式API里获取组件实例特别方便，虽然官方文档说主要给库开发者用，但实际开发中偶尔也会用到。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { getCurrentInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>()
    
    <span class="hljs-comment">// 获取组件的 props</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(instance.<span class="hljs-property">props</span>)
    
    <span class="hljs-comment">// 获取组件的 attrs</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(instance.<span class="hljs-property">attrs</span>)
    
    <span class="hljs-comment">// 获取组件的 emit</span>
    instance.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'custom-event'</span>)
    
    <span class="hljs-comment">// 访问全局属性</span>
    <span class="hljs-keyword">const</span> $router = instance.<span class="hljs-property">appContext</span>.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$router</span>
    
    <span class="hljs-keyword">return</span> {}
  }
}
</code></pre>
<p>不过要注意，<code>getCurrentInstance</code> 只能在 <code>setup</code> 或生命周期钩子里调用，而且不能缓存到异步回调里用。</p>
<h2 data-id="heading-6">7. defineAsyncComponent - 异步组件加载</h2>
<p>这个其实不算特别冷门，但很多人可能没深入用过。除了基本的懒加载，它还有很多高级用法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineAsyncComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 基础用法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComponent</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HeavyComponent.vue'</span>))

<span class="hljs-comment">// 带加载状态和错误处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComponentWithStates</span> = <span class="hljs-title function_">defineAsyncComponent</span>({
  <span class="hljs-attr">loader</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HeavyComponent.vue'</span>),
  <span class="hljs-attr">loadingComponent</span>: <span class="hljs-title class_">LoadingSpinner</span>, <span class="hljs-comment">// 加载时显示的组件</span>
  <span class="hljs-attr">errorComponent</span>: <span class="hljs-title class_">ErrorComponent</span>,   <span class="hljs-comment">// 错误时显示的组件</span>
  <span class="hljs-attr">delay</span>: <span class="hljs-number">200</span>,                       <span class="hljs-comment">// 延迟显示 loading，避免闪烁</span>
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span>,                    <span class="hljs-comment">// 超时时间</span>
  <span class="hljs-title function_">onError</span>(<span class="hljs-params">error, retry, fail, attempts</span>) {
    <span class="hljs-comment">// 错误处理逻辑</span>
    <span class="hljs-keyword">if</span> (attempts &lt;= <span class="hljs-number">3</span>) {
      <span class="hljs-title function_">retry</span>() <span class="hljs-comment">// 重试</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">fail</span>()  <span class="hljs-comment">// 放弃</span>
    }
  }
})
</code></pre>
<p>我在做路由懒加载和按需加载大组件的时候，这个API帮了不少忙。</p>
<h2 data-id="heading-7">8. watchEffect 的立即执行和清理</h2>
<p><code>watchEffect</code> 大家都知道，但它的立即执行特性和清理函数可能很多人没充分利用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { watchEffect, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">const</span> stop = <span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onInvalidate</span>) =&gt;</span> {
  <span class="hljs-comment">// 这个函数会立即执行一次</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count:'</span>, count.<span class="hljs-property">value</span>)
  
  <span class="hljs-comment">// 清理函数：在下次执行前或停止监听时调用</span>
  <span class="hljs-title function_">onInvalidate</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清理之前的副作用'</span>)
    <span class="hljs-comment">// 比如取消请求、清除定时器等</span>
  })
})

<span class="hljs-comment">// 手动停止监听</span>
<span class="hljs-title function_">stop</span>()
</code></pre>
<p>这个特性在处理副作用的时候特别有用，比如监听数据变化自动发送请求，可以在清理函数里取消之前的请求，避免竞态条件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { watchEffect, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> userId = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">let</span> abortController = <span class="hljs-literal">null</span>

<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onInvalidate</span>) =&gt;</span> {
  <span class="hljs-comment">// 取消之前的请求</span>
  <span class="hljs-keyword">if</span> (abortController) {
    abortController.<span class="hljs-title function_">abort</span>()
  }
  
  <span class="hljs-comment">// 创建新的请求</span>
  abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
  
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${userId.value}</span>`</span>, {
    <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>
  })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-comment">// 处理数据</span>
    })
  
  <span class="hljs-comment">// 清理函数：在下次执行前或组件卸载时调用</span>
  <span class="hljs-title function_">onInvalidate</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (abortController) {
      abortController.<span class="hljs-title function_">abort</span>()
    }
  })
})
</code></pre>
<p>这样就能避免快速切换用户ID时，旧的请求覆盖新请求结果的问题。</p>
<h2 data-id="heading-8">9. unref、isRef、isReactive - 类型检查工具</h2>
<p>这些工具函数在处理可能是响应式也可能不是的数据时特别有用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, reactive, unref, isRef, isReactive, isReadonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// unref - 如果是 ref 就返回 .value，否则返回原值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useValue</span>(<span class="hljs-params">maybeRef</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">unref</span>(maybeRef) <span class="hljs-comment">// 不用判断是不是 ref，直接 unref 就行</span>
}

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">10</span>)
<span class="hljs-keyword">const</span> name = <span class="hljs-string">'Vue3'</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">useValue</span>(count))  <span class="hljs-comment">// 10</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">useValue</span>(name))   <span class="hljs-comment">// 'Vue3'</span>

<span class="hljs-comment">// isRef - 判断是否是 ref</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRef</span>(count)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一个 ref'</span>)
}

<span class="hljs-comment">// isReactive - 判断是否是 reactive 对象</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isReactive</span>(state)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一个 reactive 对象'</span>)
}

<span class="hljs-comment">// isReadonly - 判断是否是 readonly 对象</span>
<span class="hljs-keyword">const</span> readonlyState = <span class="hljs-title function_">readonly</span>(state)
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isReadonly</span>(readonlyState)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一个 readonly 对象'</span>)
}
</code></pre>
<p>在写工具函数或者组合式函数的时候，这些检查函数能让你写出更健壮的代码。</p>
<h2 data-id="heading-9">10. effectScope 和 onScopeDispose - 批量管理副作用</h2>
<p><code>effectScope</code> 是 Vue3.2 新增的，可以批量管理一组响应式效果（computed、watch、watchEffect等），统一停止或清理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { effectScope, ref, watchEffect, computed, onScopeDispose } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> y = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  
  <span class="hljs-comment">// 创建一个作用域</span>
  <span class="hljs-keyword">const</span> scope = <span class="hljs-title function_">effectScope</span>()
  
  scope.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在这个作用域内的所有响应式效果都会被统一管理</span>
    <span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params">e</span>) =&gt; {
        x.<span class="hljs-property">value</span> = e.<span class="hljs-property">clientX</span>
        y.<span class="hljs-property">value</span> = e.<span class="hljs-property">clientY</span>
      }
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, handler)
      
      <span class="hljs-comment">// 清理函数</span>
      <span class="hljs-title function_">onScopeDispose</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, handler)
      })
    })
    
    <span class="hljs-comment">// 也可以有多个 watchEffect、computed 等</span>
    <span class="hljs-keyword">const</span> distance = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(x.<span class="hljs-property">value</span> ** <span class="hljs-number">2</span> + y.<span class="hljs-property">value</span> ** <span class="hljs-number">2</span>)
    })
  })
  
  <span class="hljs-comment">// 返回停止函数</span>
  <span class="hljs-keyword">return</span> {
    x,
    y,
    <span class="hljs-attr">stop</span>: <span class="hljs-function">() =&gt;</span> scope.<span class="hljs-title function_">stop</span>() <span class="hljs-comment">// 一次性停止所有效果</span>
  }
}
</code></pre>
<p>这个在写组合式函数的时候特别有用，可以确保所有副作用都能被正确清理，避免内存泄漏。</p>
<h2 data-id="heading-10">11. provide/inject 的响应式传递</h2>
<p><code>provide/inject</code> 大家都知道，但很多人不知道它可以传递响应式数据，而且子组件可以直接修改。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">import</span> { provide, ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> })
    
    <span class="hljs-comment">// 提供响应式数据</span>
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'count'</span>, count)
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'user'</span>, user)
    
    <span class="hljs-comment">// 也可以提供修改函数</span>
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'increment'</span>, <span class="hljs-function">() =&gt;</span> {
      count.<span class="hljs-property">value</span>++
    })
    
    <span class="hljs-keyword">return</span> { count, user }
  }
}

<span class="hljs-comment">// 子组件（可以是任意深度的子组件）</span>
<span class="hljs-keyword">import</span> { inject, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 注入响应式数据，可以设置默认值</span>
    <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'count'</span>, <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)) <span class="hljs-comment">// 如果父组件没有提供，使用默认值</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">name</span>: <span class="hljs-string">'默认用户'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">0</span> })) <span class="hljs-comment">// 也可以使用工厂函数</span>
    <span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'increment'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'increment 方法未提供'</span>)
    })
    
    <span class="hljs-comment">// 可以直接修改（如果父组件提供的是响应式数据）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
      count.<span class="hljs-property">value</span>++ <span class="hljs-comment">// ✅ 父组件的 count 也会更新</span>
      user.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span> <span class="hljs-comment">// ✅ 父组件的 user 也会更新</span>
      <span class="hljs-comment">// 或者调用父组件提供的方法</span>
      <span class="hljs-title function_">increment</span>()
    }
    
    <span class="hljs-keyword">return</span> { count, user, handleClick }
  }
}
</code></pre>
<p>这个在跨层级组件通信的时候特别方便，比 props 一层层传要优雅得多。</p>
<h2 data-id="heading-11">12. v-memo - 性能优化的指令</h2>
<p><code>v-memo</code> 是 Vue3.2 新增的指令，可以缓存模板的一部分，只有在依赖项变化时才重新渲染。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 只有 item.id 或 selected 变化时才重新渲染这个 div --&gt;
  &lt;div v-for="item in list" :key="item.id" v-memo="[item.id, selected]"&gt;
    &lt;p&gt;{{ item.name }}&lt;/p&gt;
    &lt;p&gt;{{ item.description }}&lt;/p&gt;
    &lt;!-- 复杂的内容 --&gt;
    &lt;ExpensiveComponent :data="item.data" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

const list = ref([
  { id: 1, name: 'Item 1', description: '...', data: {...} },
  { id: 2, name: 'Item 2', description: '...', data: {...} },
  // ...
])

const selected = ref(null)
&lt;/script&gt;
</code></pre>
<p>这个在处理长列表的时候特别有用，可以大幅提升性能。不过要注意，<code>v-memo</code> 必须和 <code>v-for</code> 一起使用。</p>
<h2 data-id="heading-12">13. Suspense - 异步组件的加载状态</h2>
<p><code>Suspense</code> 可以优雅地处理异步组件的加载状态，不需要在每个组件里单独处理。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Suspense&gt;
    &lt;template #default&gt;
      &lt;AsyncComponent /&gt;
    &lt;/template&gt;
    &lt;template #fallback&gt;
      &lt;div class="loading"&gt;加载中...&lt;/div&gt;
    &lt;/template&gt;
  &lt;/Suspense&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { defineAsyncComponent } from 'vue'

const AsyncComponent = defineAsyncComponent(() =&gt; 
  import('./HeavyComponent.vue')
)
&lt;/script&gt;
</code></pre>
<p>如果异步组件内部有异步操作（比如 <code>setup</code> 里用了 <code>await</code>），<code>Suspense</code> 也会等待：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- AsyncComponent.vue --&gt;
&lt;script setup&gt;
// 这个组件内部有异步操作
const data = await fetchData() // Suspense 会等待这个完成
&lt;/script&gt;
</code></pre>
<p>这个在处理异步数据加载的时候特别优雅，比手动管理 loading 状态要方便。</p>
<h2 data-id="heading-13">14. 模板引用的高级用法</h2>
<p>模板引用（ref）除了获取 DOM 元素，还有很多高级用法。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 在 v-for 中获取多个元素 --&gt;
  &lt;div v-for="item in list" :ref="el =&gt; setItemRef(el, item.id)"&gt;
    {{ item.name }}
  &lt;/div&gt;
  
  &lt;!-- 获取子组件实例 --&gt;
  &lt;ChildComponent ref="childRef" /&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted } from 'vue'

const list = ref([
  { id: 1, name: 'Item 1' },
  { id: 2, name: 'Item 2' },
])

// 存储多个元素引用
const itemRefs = ref({})

const setItemRef = (el, id) =&gt; {
  if (el) {
    itemRefs.value[id] = el
  }
}

// 子组件引用
const childRef = ref(null)

onMounted(() =&gt; {
  // 访问子组件的方法或属性
  console.log(childRef.value.someMethod())
  console.log(childRef.value.someProperty)
  
  // 访问所有列表项的 DOM
  console.log(itemRefs.value)
})
&lt;/script&gt;
</code></pre>
<p>还可以配合 <code>defineExpose</code> 暴露子组件的特定内容：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ChildComponent.vue --&gt;
&lt;script setup&gt;
import { ref } from 'vue'

const count = ref(0)
const privateData = ref('private') // 这个不会被暴露

const increment = () =&gt; {
  count.value++
}

// 只暴露 count 和 increment
defineExpose({
  count,
  increment
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-14">15. computed 的 getter/setter 形式</h2>
<p><code>computed</code> 除了只读形式，还可以有 getter 和 setter，实现双向绑定。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> firstName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'张'</span>)
<span class="hljs-keyword">const</span> lastName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'三'</span>)

<span class="hljs-comment">// 可读写的 computed</span>
<span class="hljs-keyword">const</span> fullName = <span class="hljs-title function_">computed</span>({
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${firstName.value}</span><span class="hljs-subst">${lastName.value}</span>`</span>
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
    <span class="hljs-comment">// 当设置 fullName 时，自动拆分到 firstName 和 lastName</span>
    <span class="hljs-keyword">const</span> parts = newValue.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>)
    <span class="hljs-keyword">if</span> (parts.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">2</span>) {
      firstName.<span class="hljs-property">value</span> = parts[<span class="hljs-number">0</span>]
      lastName.<span class="hljs-property">value</span> = parts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    }
  }
})

<span class="hljs-comment">// 使用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fullName.<span class="hljs-property">value</span>) <span class="hljs-comment">// '张三'</span>
fullName.<span class="hljs-property">value</span> = <span class="hljs-string">'李四'</span> <span class="hljs-comment">// 自动更新 firstName 和 lastName</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(firstName.<span class="hljs-property">value</span>) <span class="hljs-comment">// '李'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lastName.<span class="hljs-property">value</span>) <span class="hljs-comment">// '四'</span>
</code></pre>
<p>这个在处理表单数据转换的时候特别有用。</p>
<h2 data-id="heading-15">16. watch 的深度监听和立即执行</h2>
<p><code>watch</code> 的选项参数有很多实用的配置。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { watch, ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>
  }
})

<span class="hljs-comment">// 深度监听对象</span>
<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">user</span>,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'user 变化了'</span>, newVal, oldVal)
  },
  { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> } <span class="hljs-comment">// 深度监听嵌套属性</span>
)

<span class="hljs-comment">// 或者直接监听整个对象</span>
<span class="hljs-title function_">watch</span>(
  state,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-comment">// 注意：newVal 和 oldVal 是同一个对象（因为 reactive）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'state 变化了'</span>)
  },
  { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> }
)

<span class="hljs-comment">// 立即执行一次</span>
<span class="hljs-title function_">watch</span>(
  count,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count:'</span>, newVal)
  },
  { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> } <span class="hljs-comment">// 立即执行一次回调</span>
)

<span class="hljs-comment">// 监听多个源</span>
<span class="hljs-title function_">watch</span>(
  [count, <span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>],
  <span class="hljs-function">(<span class="hljs-params">[newCount, newName], [oldCount, oldName]</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count 或 name 变化了'</span>)
  }
)

<span class="hljs-comment">// 手动实现只监听一次的效果</span>
<span class="hljs-keyword">let</span> stopWatcher = <span class="hljs-literal">null</span>
stopWatcher = <span class="hljs-title function_">watch</span>(
  count,
  <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'只执行一次'</span>)
    <span class="hljs-comment">// 执行后立即停止监听</span>
    <span class="hljs-keyword">if</span> (stopWatcher) {
      <span class="hljs-title function_">stopWatcher</span>()
      stopWatcher = <span class="hljs-literal">null</span>
    }
  }
)
</code></pre>
<h2 data-id="heading-16">17. nextTick 的多种用法</h2>
<p><code>nextTick</code> 大家都知道，但它的使用场景可能很多人没完全掌握。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { nextTick, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)

<span class="hljs-comment">// 等待 DOM 更新后执行</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
  count.<span class="hljs-property">value</span>++
  message.<span class="hljs-property">value</span> = <span class="hljs-string">'Count 已更新'</span>
  
  <span class="hljs-comment">// 此时 DOM 可能还没更新</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.count'</span>).<span class="hljs-property">textContent</span>) <span class="hljs-comment">// 可能是旧值</span>
  
  <span class="hljs-comment">// 等待 DOM 更新</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.count'</span>).<span class="hljs-property">textContent</span>) <span class="hljs-comment">// 新值</span>
  
  <span class="hljs-comment">// 或者用回调形式</span>
  <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM 已更新'</span>)
  })
}

<span class="hljs-comment">// 在组件挂载后操作 DOM</span>
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 即使组件已挂载，某些 DOM 操作可能还需要等待</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
  <span class="hljs-comment">// 现在可以安全地操作 DOM 了</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.some-element'</span>).<span class="hljs-title function_">focus</span>()
})
</code></pre>
<h2 data-id="heading-17">18. 响应式 API 的转换工具</h2>
<p>Vue3 提供了一些转换工具，可以在不同响应式类型之间转换。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, reactive, toRef, toRefs, isRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue3'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'3.0'</span>,
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
})

<span class="hljs-comment">// toRef - 将 reactive 对象的某个属性转为 ref</span>
<span class="hljs-keyword">const</span> nameRef = <span class="hljs-title function_">toRef</span>(state, <span class="hljs-string">'name'</span>)
nameRef.<span class="hljs-property">value</span> = <span class="hljs-string">'Vue 3'</span> <span class="hljs-comment">// 会同步更新 state.name</span>

<span class="hljs-comment">// toRefs - 将 reactive 对象的所有属性转为 ref</span>
<span class="hljs-keyword">const</span> { name, version, count } = <span class="hljs-title function_">toRefs</span>(state)
<span class="hljs-comment">// 现在 name、version、count 都是 ref，可以在模板中直接使用</span>

<span class="hljs-comment">// 在组合式函数中返回响应式数据时特别有用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">step</span>: <span class="hljs-number">1</span>
  })
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    state.<span class="hljs-property">count</span> += state.<span class="hljs-property">step</span>
  }
  
  <span class="hljs-comment">// 返回 toRefs，让使用者可以解构而不失去响应式</span>
  <span class="hljs-keyword">return</span> {
    ...<span class="hljs-title function_">toRefs</span>(state),
    increment
  }
}

<span class="hljs-comment">// 使用时可以解构</span>
<span class="hljs-keyword">const</span> { count, step, increment } = <span class="hljs-title function_">useCounter</span>()
<span class="hljs-comment">// count 和 step 仍然是响应式的</span>
</code></pre>
<h2 data-id="heading-18">19. 自定义指令的高级用法</h2>
<p>自定义指令除了基本的 <code>mounted</code> 和 <code>updated</code>，还有很多生命周期钩子。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自定义指令直接定义对象即可，不需要特殊导入</span>
<span class="hljs-keyword">const</span> vMyDirective = {
  <span class="hljs-comment">// 元素插入 DOM 前调用</span>
  <span class="hljs-title function_">created</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'created'</span>)
  },
  
  <span class="hljs-comment">// 元素插入 DOM 后调用</span>
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding, vnode, prevVnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'mounted'</span>, binding.<span class="hljs-property">value</span>)
    <span class="hljs-comment">// binding.value - 指令的值</span>
    <span class="hljs-comment">// binding.oldValue - 之前的值（仅在 update 和 componentUpdated 中可用）</span>
    <span class="hljs-comment">// binding.arg - 指令参数，如 v-my-directive:foo 中的 'foo'</span>
    <span class="hljs-comment">// binding.modifiers - 修饰符对象，如 v-my-directive.foo.bar 中的 { foo: true, bar: true }</span>
  },
  
  <span class="hljs-comment">// 在包含组件的 VNode 更新前调用</span>
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params">el, binding, vnode, prevVnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'beforeUpdate'</span>)
  },
  
  <span class="hljs-comment">// 在包含组件的 VNode 及其子 VNode 更新后调用</span>
  <span class="hljs-title function_">updated</span>(<span class="hljs-params">el, binding, vnode, prevVnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'updated'</span>)
  },
  
  <span class="hljs-comment">// 在卸载前调用</span>
  <span class="hljs-title function_">beforeUnmount</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'beforeUnmount'</span>)
  },
  
  <span class="hljs-comment">// 卸载后调用</span>
  <span class="hljs-title function_">unmounted</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'unmounted'</span>)
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-comment">// &lt;div v-my-directive:arg.modifier="value"&gt;&lt;/div&gt;</span>
</code></pre>
<p>实际应用：实现一个点击外部关闭的指令</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> vClickOutside = {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) {
    el.<span class="hljs-property">_clickOutside</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!(el === event.<span class="hljs-property">target</span> || el.<span class="hljs-title function_">contains</span>(event.<span class="hljs-property">target</span>))) {
        binding.<span class="hljs-title function_">value</span>() <span class="hljs-comment">// 调用传入的函数</span>
      }
    }
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, el.<span class="hljs-property">_clickOutside</span>)
  },
  <span class="hljs-title function_">unmounted</span>(<span class="hljs-params">el</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, el.<span class="hljs-property">_clickOutside</span>)
  }
}
</code></pre>
<h2 data-id="heading-19">20. 组合式 API 的类型推断技巧</h2>
<p>在 TypeScript 中使用组合式 API 时，有一些类型推断的技巧。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ref, computed, <span class="hljs-title class_">Ref</span>, <span class="hljs-title class_">ComputedRef</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 明确指定 ref 的类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">count</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-comment">// 或者让 TypeScript 自动推断</span>
<span class="hljs-keyword">const</span> count = ref&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)

<span class="hljs-comment">// computed 的类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">doubleCount</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-built_in">number</span>&gt; = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)

<span class="hljs-comment">// 在组合式函数中返回类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>++
  }
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">count</span>: count <span class="hljs-keyword">as</span> <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-built_in">number</span>&gt;, <span class="hljs-comment">// 或者用 readonly</span>
    increment
  }
}

<span class="hljs-comment">// 使用泛型</span>
<span class="hljs-keyword">function</span> useAsyncData&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>) {
  <span class="hljs-keyword">const</span> data = ref&lt;T | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> error = ref&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url)
      data.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    } <span class="hljs-keyword">catch</span> (e) {
      error.<span class="hljs-property">value</span> = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  }
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">data</span>: <span class="hljs-title function_">readonly</span>(data),
    <span class="hljs-attr">loading</span>: <span class="hljs-title function_">readonly</span>(loading),
    <span class="hljs-attr">error</span>: <span class="hljs-title function_">readonly</span>(error),
    fetchData
  }
}
</code></pre>
<h2 data-id="heading-20">21. 性能优化的组合拳</h2>
<p>把这些 API 组合起来，可以实现更强大的性能优化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { shallowRef, markRaw, computed, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 场景：处理大量数据列表</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useLargeList</span>(<span class="hljs-params">initialData</span>) {
  <span class="hljs-comment">// 用 shallowRef 避免深度响应式</span>
  <span class="hljs-keyword">const</span> items = <span class="hljs-title function_">shallowRef</span>(initialData.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
    ...item,
    <span class="hljs-comment">// 某些不需要响应式的数据用 markRaw</span>
    <span class="hljs-attr">metadata</span>: <span class="hljs-title function_">markRaw</span>(item.<span class="hljs-property">metadata</span>)
  })))
  
  <span class="hljs-comment">// 用 computed 缓存计算结果</span>
  <span class="hljs-keyword">const</span> filteredItems = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> items.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">visible</span>)
  })
  
  <span class="hljs-comment">// 用 watchEffect 处理副作用，自动清理</span>
  <span class="hljs-keyword">const</span> stop = <span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onInvalidate</span>) =&gt;</span> {
    <span class="hljs-comment">// 处理过滤后的数据</span>
    <span class="hljs-title function_">processItems</span>(filteredItems.<span class="hljs-property">value</span>)
    
    <span class="hljs-title function_">onInvalidate</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 清理工作</span>
      <span class="hljs-title function_">cleanup</span>()
    })
  })
  
  <span class="hljs-keyword">return</span> {
    items,
    filteredItems,
    stop
  }
}
</code></pre>
<h2 data-id="heading-21">22. 实际项目中的最佳实践</h2>
<p>结合我自己的项目经验，分享几个实用的模式：</p>
<h3 data-id="heading-22">模式1：响应式数据的初始化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, reactive, onMounted, readonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useUserData</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>)
      user.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    } <span class="hljs-keyword">catch</span> (e) {
      error.<span class="hljs-property">value</span> = e
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  }
  
  <span class="hljs-comment">// 组件挂载时自动获取</span>
  <span class="hljs-title function_">onMounted</span>(fetchUser)
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">user</span>: <span class="hljs-title function_">readonly</span>(user),
    <span class="hljs-attr">loading</span>: <span class="hljs-title function_">readonly</span>(loading),
    <span class="hljs-attr">error</span>: <span class="hljs-title function_">readonly</span>(error),
    <span class="hljs-attr">refetch</span>: fetchUser
  }
}
</code></pre>
<h3 data-id="heading-23">模式2：表单验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, computed, reactive, readonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useFormValidation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> form = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">confirmPassword</span>: <span class="hljs-string">''</span>
  })
  
  <span class="hljs-keyword">const</span> errors = <span class="hljs-title function_">reactive</span>({})
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validateEmail</span> = (<span class="hljs-params">email</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(email)
  }
  
  <span class="hljs-comment">// 用 computed 实时验证</span>
  <span class="hljs-keyword">const</span> isValid = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    errors.<span class="hljs-property">email</span> = form.<span class="hljs-property">email</span> &amp;&amp; !<span class="hljs-title function_">validateEmail</span>(form.<span class="hljs-property">email</span>) 
      ? <span class="hljs-string">'邮箱格式不正确'</span> 
      : <span class="hljs-string">''</span>
    
    errors.<span class="hljs-property">password</span> = form.<span class="hljs-property">password</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">6</span> 
      ? <span class="hljs-string">'密码至少6位'</span> 
      : <span class="hljs-string">''</span>
    
    errors.<span class="hljs-property">confirmPassword</span> = form.<span class="hljs-property">password</span> !== form.<span class="hljs-property">confirmPassword</span> 
      ? <span class="hljs-string">'两次密码不一致'</span> 
      : <span class="hljs-string">''</span>
    
    <span class="hljs-keyword">return</span> !<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(errors).<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> err)
  })
  
  <span class="hljs-keyword">return</span> {
    form,
    <span class="hljs-attr">errors</span>: <span class="hljs-title function_">readonly</span>(errors),
    isValid
  }
}
</code></pre>
<h3 data-id="heading-24">模式3：防抖和节流的组合使用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { customRef, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 防抖 ref - 基于 customRef 实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useDebounceRef</span>(<span class="hljs-params">value, delay = <span class="hljs-number">300</span></span>) {
  <span class="hljs-keyword">let</span> timeout
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">customRef</span>(<span class="hljs-function">(<span class="hljs-params">track, trigger</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">track</span>()
        <span class="hljs-keyword">return</span> value
      },
      <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
        <span class="hljs-built_in">clearTimeout</span>(timeout)
        timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          value = newValue
          <span class="hljs-title function_">trigger</span>()
        }, delay)
      }
    }
  })
}

<span class="hljs-comment">// 节流函数 - 配合 watch 使用（这是纯 JS 函数，不是 Vue3 API，但经常和 Vue3 一起用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useThrottleFn</span>(<span class="hljs-params">fn, delay = <span class="hljs-number">300</span></span>) {
  <span class="hljs-keyword">let</span> lastTime = <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    <span class="hljs-keyword">if</span> (now - lastTime &gt;= delay) {
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
      lastTime = now
    }
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> searchText = <span class="hljs-title function_">useDebounceRef</span>(<span class="hljs-string">''</span>)

<span class="hljs-title function_">watch</span>(searchText, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
  <span class="hljs-comment">// 搜索逻辑，只在用户停止输入 300ms 后执行</span>
  <span class="hljs-title function_">performSearch</span>(newVal)
})

<span class="hljs-keyword">const</span> handleScroll = <span class="hljs-title function_">useThrottleFn</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 滚动处理，每 300ms 最多执行一次</span>
  <span class="hljs-title function_">updateScrollPosition</span>()
}, <span class="hljs-number">100</span>)
</code></pre>
<h2 data-id="heading-25">版本要求说明</h2>
<p>部分 API 需要特定版本的 Vue3：</p>
<ul>
<li><strong>Vue 3.2+</strong>：<code>effectScope</code>、<code>onScopeDispose</code>、<code>v-memo</code></li>
<li><strong>Vue 3.0+</strong>：其他大部分 API</li>
</ul>
<p>建议使用 Vue 3.2 或更高版本，以获得完整的 API 支持。</p>
<h2 data-id="heading-26">常见陷阱和注意事项</h2>
<ol>
<li>
<p><strong>shallowRef/shallowReactive 的陷阱</strong>：修改嵌套属性不会触发更新，如果需要更新，要替换整个对象。</p>
</li>
<li>
<p><strong>toRaw 的局限性</strong>：只能获取一层的原始对象，嵌套的响应式对象仍然是 Proxy。</p>
</li>
<li>
<p><strong>getCurrentInstance 的使用限制</strong>：只能在 <code>setup</code> 或生命周期钩子中调用，不能缓存到异步回调中使用。</p>
</li>
<li>
<p><strong>inject 的默认值</strong>：如果父组件没有提供值，<code>inject</code> 会返回 <code>undefined</code>，建议总是提供默认值。</p>
</li>
<li>
<p><strong>watchEffect 的依赖追踪</strong>：会自动追踪所有在函数内访问的响应式数据，注意不要访问不需要追踪的数据。</p>
</li>
<li>
<p><strong>computed 的副作用</strong>：不要在 <code>computed</code> 中执行副作用操作（如修改 DOM、发送请求等），应该使用 <code>watch</code> 或 <code>watchEffect</code>。</p>
</li>
</ol>
<h2 data-id="heading-27">总结下</h2>
<p>有些API你可能不常用，但在特定场景下真的能解决实际问题。性能优化、边界情况处理、自定义逻辑，这些场景下它们都能派上用场。</p>
<p>不过也要注意，不要过度使用。比如 <code>shallowRef</code> 虽然性能好，但如果你确实需要深度响应式，就不要为了性能而牺牲功能。工具是死的，场景是活的，根据实际需求选择最合适的方案才是王道。。。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用C++实现一个简易的线程池]]></title>    <link>https://juejin.cn/post/7571781196297568265</link>    <guid>https://juejin.cn/post/7571781196297568265</guid>    <pubDate>2025-11-13T02:58:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571781196297568265" data-draft-id="7571829822339907635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用C++实现一个简易的线程池"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T02:58:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QZQ54188"/> <meta itemprop="url" content="https://juejin.cn/user/666776045362473"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用C++实现一个简易的线程池
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/666776045362473/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QZQ54188
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T02:58:41.000Z" title="Thu Nov 13 2025 02:58:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代软件开发中，多线程编程已经成为提升程序性能的常见手段。无论是处理大量 I/O 请求的服务器，还是进行 CPU 密集型计算的应用，多线程都能显著提高吞吐量和响应速度。然而，直接频繁创建和销毁线程开销巨大，也容易导致资源浪费和管理复杂度的增加。</p>
<p>为了解决这个问题，线程池应运而生。它的核心思想是：提前创建固定数量的工作线程，并将任务提交到一个任务队列中，由线程池中的线程循环取任务执行。这样，不仅减少了线程创建和销毁的开销，也能方便地控制系统的并发度。</p>
<p>这篇博客记录了逐步实现一个简易版线程池的过程。</p>
<p>首先线程池的思想是创建预先创建一定数量的工作线程，它们循环等待任务队列中的任务并执行，从而避免频繁创建和销毁线程，实现资源复用，提高资源利用率和程序性能。所以我们首先需要一个<code>vector&lt;thread&gt;</code>的数组，还有一个任务队列。同时，由于线程池可能会被多个线程同时访问：工作线程需要取出任务队列中的任务，其他使用线程池的线程可能同时提交任务，所以还需要加一把互斥锁。上述还提到了其他线程会往线程池中提交任务，使得线程池中的工作线程可以取出任务队列中的任务并且执行，所以还需要一个公开的提交任务函数。基本架构如下：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span>{
<span class="hljs-keyword">public</span>:
  <span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span>);

  <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
  <span class="hljs-keyword">auto</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; <span class="hljs-type">void</span></span>;
  
  ~<span class="hljs-built_in">ThreadPool</span>();

<span class="hljs-keyword">private</span>:
  std::vector&lt;std::thread&gt; workers_;
  std::queue&lt;std::function&lt;<span class="hljs-type">void</span>()&gt;&gt; tasks_;
  std::mutex mutex_;
};
</code></pre>
<p>这里解释一下任务队列为什么使用<code>std::queue&lt;std::function&lt;void()&gt;&gt; tasks_</code>，首先我们肯定需要一个统一的形式封装任务队列，这样就可以统一封装到stl容器中。而且我们期望工作线程执行时是可以直接拿来调用的，工作线程是线程池内部实现，不应该依赖于用户传入任务的参数这层外部抽象，所以参数列表为空。参数列表为空之后用户传入带有参数的函数还是可以执行的，注意我们的<code>enqueue</code>函数中接受了用户提供的任务函数和参数，在这个函数中会将二者进行<code>std::bind</code>，这样就把参数填入可调用对象了，所以工作线程取出任务时可以直接调用。至于用户需要返回值怎么办，这里先埋一个伏笔，先统一使用<code>void</code>表示无返回值，便于封装。</p>
<p>接下来我们实现构造函数：</p>
<pre><code class="hljs language-C++" lang="C++">ThreadPool::<span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span> nums){
    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; nums; i++){
        workers_.<span class="hljs-built_in">emplace_back</span>([<span class="hljs-keyword">this</span>]{
            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){
                std::function&lt;<span class="hljs-built_in">void</span>()&gt; task;
                {
                    std::unique_lock&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(<span class="hljs-keyword">this</span>-&gt;mutex_);
                    <span class="hljs-keyword">this</span>-&gt;condition.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>]{!<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">empty</span>(); });
                    task = std::<span class="hljs-built_in">move</span>(<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">front</span>());
                    <span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">pop</span>();
                }
                <span class="hljs-built_in">task</span>();
            }
        });
    }
}
</code></pre>
<p>构造函数的目的就是向<code>std::vector&lt;std::thread&gt; workers_</code>中填充工作线程，工作线程的逻辑如下：首先尝试获取锁，获取锁之后查看任务队列是否为空，如果不为空的话就取出元素执行，如果为空的话就释放锁进行下一轮循环。</p>
<p>下面我们从细节上具体说明，获取锁之后使用条件变量进行等待，<code>wait(lock, [this]{!this-&gt;tasks_.empty(); })</code>，这样当任务队列不为空时就可以不阻塞往下执行，如果为空的话，就会释放锁，并且将该线程添加到对应条件变量的阻塞队列中，之后如果<code>enqueue</code>时填充了任务就可以发<code>signal</code>唤醒阻塞于这个条件变量的一个线程。如果获取锁之后发现任务队列中有任务可以执行，那么就取出任务队列中的第一个任务执行，因为要保证调用顺序。</p>
<p>注意在<code>emplace_back</code>函数中直接调用了线程的构造函数，先在vector 尾部直接原地构造一个线程对象。构造线程对象时会立即创建一个新线程，在这个线程里执行传入的 lambda。所以在执行条件变量的wait时就已经有实际创建的线程对象了。</p>
<p>我们在构造函数中新使用了<code>condition</code>这个条件变量，所以应该在<code>ThreadPool</code>类的私有成员中添加对应变量。上述构造函数构造的线程函数是一个死循环，因此会一直等待，获取任务队列中的任务然后执行。我们还要给线程函数加上停止逻辑，不然主线程调用join的时候就会一直阻塞，因为此时线程函数中还没有返回逻辑，所以需要给线程函数添加返回的分支。</p>
<p>线程函数返回的时任务队列应该为空，因为从逻辑上讲我要把用户给我的任务全部完成，所以任务队列为空是检测是否可以返回的条件。如果只检测这个条件也是不可以的，因为可能线程池中其他线程已经把任务队列中的所有任务取出来执行完，此时任务队列也为空，但是用户还可能<code>enqueue</code>任务进去，所以此时线程池不应该关闭。此时我们需要一个标志位，在ThreadPool的析构函数中将这个标志位设置为<code>true</code>，此时用户也不需要使用线程池了，因为调用析构函数时肯定已经退出用户代码作用域了，所以应该使用这个标志位和任务队列是否为空检测。下面给出完善后代码：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span>{
    <span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ThreadPool</span>(<span class="hljs-type">size_t</span>){
        stoped_ = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; nums; i++){
            workers_.<span class="hljs-built_in">emplace_back</span>([<span class="hljs-keyword">this</span>]{
                <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){
                    std::function&lt;<span class="hljs-built_in">void</span>()&gt; task;
                    {
                        std::unique_lock&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(<span class="hljs-keyword">this</span>-&gt;mutex_);
                        <span class="hljs-keyword">this</span>-&gt;condition.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>]{!<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">empty</span>(); });
                        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;stopd_ &amp;&amp; <span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">empty</span>()){
                            <span class="hljs-keyword">return</span>;
                        }
                        task = std::<span class="hljs-built_in">move</span>(<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">front</span>());
                        <span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">pop</span>();
                    }
                    <span class="hljs-built_in">task</span>();
                }
            });
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
        <span class="hljs-keyword">auto</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; <span class="hljs-type">void</span></span>;

    ~<span class="hljs-built_in">ThreadPool</span>();

    <span class="hljs-keyword">private</span>:
    std::vector&lt;std::thread&gt; workers_;
    std::queue&lt;std::function&lt;<span class="hljs-type">void</span>()&gt;&gt; tasks_;
    std::condition_variable condition;
    std::mutex mutex_;
    <span class="hljs-type">bool</span> stoped_;
};

</code></pre>
<p>接下来是析构函数，析构函数应该是否线程池相关资源，循环调用join回收所有线程。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">inline</span> ThreadPool::~<span class="hljs-built_in">ThreadPool</span>()
{
  {
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    stoped_ = <span class="hljs-literal">true</span>;
  }
  condition.<span class="hljs-built_in">notify_all</span>();
  <span class="hljs-keyword">for</span>(std::thread &amp;worker: workers_)
    worker.<span class="hljs-built_in">join</span>();
}
</code></pre>
<p>这里我们将<code>stoped_</code>设置为<code>true</code>之后会唤醒所有在该条件变量上阻塞的工作线程，但是条件变量的唤醒只有一个线程可以重新获取锁，这个获取锁的线程就可以继续执行线程函数的逻辑，判断队列是不是为空，为空的话就可以直接return了，因为此时任务队列不会再有任务进来，但是也只有这个线程会return，其他的线程没有获取到锁，继续阻塞在条件变量的阻塞队列上。因此我们要修改条件变量的wait条件，目标是调用析构之后所有的线程都可以感知到并且被唤醒，尽管一次只有一个线程可以获取锁。</p>
<p>将条件变量的wait逻辑修改为如下就好了：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">this</span>-&gt;condition.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>]{<span class="hljs-keyword">this</span>-&gt;stoped_ || !<span class="hljs-keyword">this</span>-&gt;tasks_.<span class="hljs-built_in">empty</span>(); });
</code></pre>
<p>最后我们来实现<code>enqueue</code>函数，这个函数的作用是添加新任务到任务队列，下面给出初版实现：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
    <span class="hljs-keyword">auto</span> <span class="hljs-title">ThreadPool::enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; <span class="hljs-type">void</span></span>{
    <span class="hljs-keyword">auto</span> task = std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);

    {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
        <span class="hljs-keyword">if</span>(stoped_){
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"enqueue on stopped ThreadPool"</span>);
        }

        tasks_.<span class="hljs-built_in">emplace</span>([task](){<span class="hljs-built_in">task</span>()});
    }
    condition.<span class="hljs-built_in">notify_one</span>();
}
</code></pre>
<p>这段代码就是将用户传入的可调用对象和参数绑定，这样工作线程取出来之后就可以直接调用，不需要再传参。再将这个任务放入任务队列，通知一个工作线程可以取出任务执行。</p>
<p>上述代码其实很粗糙，我们来逐步优化。</p>
<pre><code class="hljs language-C++" lang="C++">tasks_.<span class="hljs-built_in">emplace</span>([task](){<span class="hljs-built_in">task</span>()});
</code></pre>
<p>这段将任务放入任务队列的代码，调用了拷贝构造函数，如果对象很大的话会影响性能，比如说一个可调用对象内部封装了大量变量，和上下文信息。所以我们应该使用移动或者指针的方式，这里不可以使用移动，因为参数<code>F</code>是通过引用传入的，移动意味着放弃所有权，假如用户声明了一个<code>F</code>，传参之后在后续用户代码想调用这个<code>F</code>时就会发生报错，因为此时<code>F</code>已经被移动了，用户代码失去了所有权。这里只可以使用指针来做，而且应该使用共享指针，这样可以确保用户代码拥有所有权。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
<span class="hljs-keyword">auto</span> <span class="hljs-title">ThreadPool::enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; <span class="hljs-type">void</span></span>{
  <span class="hljs-keyword">using</span> TaskType = <span class="hljs-keyword">decltype</span>(std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...));
  <span class="hljs-keyword">auto</span> taskPtr = std::<span class="hljs-built_in">make_shared</span>&lt;TaskType&gt;(
    std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...)
  );

  {
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    <span class="hljs-keyword">if</span>(stoped_){
      <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"enqueue on stopped ThreadPool"</span>);
    }

    tasks_.<span class="hljs-built_in">emplace</span>([taskPtr]() {
      (*taskPtr)();
    });
  }
  condition.<span class="hljs-built_in">notify_one</span>();
}
</code></pre>
<p>注意我们使用智能指针时需要知道对象具体的类型，但是<code>std::bind</code>是一个函数模板，它会返回一个可调用对象，这里返回的可调用对象是一个未命名类型的对象，你不能写出它的确切类型名字（它不是 <code>std::function</code>），但它可以像函数一样调用。也就是说返回一个具有<code>operator()</code>的匿名类型。</p>
<p>因为这个匿名类型我们没法直接写出来，所以需要让编译器帮我们推导。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">decltype</span>(std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...))
</code></pre>
<p>上述<code>enqueue</code>函数还有一个问题，就是它没有返回值，用户无法获得任务结果，也无法知道任务是否执行完成。因此我们需要一种机制，当用户调用<code>enqueue</code>函数时可以拿到一个句柄，当任务被工作线程执行完成后，用户检测这个句柄就会发现任务已经执行完成，然后获取返回值。这个机制其实就是<code>future</code>和<code>promise</code>，下面我们来继续完善：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">class</span> F, <span class="hljs-keyword">class</span> ...Args&gt;
<span class="hljs-keyword">auto</span> <span class="hljs-title">ThreadPool::enqueue</span><span class="hljs-params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; std::future&lt;std::<span class="hljs-type">invoke_result_t</span>&lt;F, Args...&gt;&gt;</span>{
  <span class="hljs-keyword">using</span> return_type = <span class="hljs-keyword">typename</span> std::<span class="hljs-type">invoke_result_t</span>&lt;F, Args...&gt;;

  <span class="hljs-keyword">auto</span> taskPtr = std::make_shared&lt;std::packaged_task&lt;<span class="hljs-built_in">return_type</span>()&gt;&gt;(
    std::<span class="hljs-built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...)
  );

  std::future&lt;return_type&gt; res = taskPtr-&gt;<span class="hljs-built_in">get_future</span>();
  {
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    <span class="hljs-keyword">if</span>(stoped_){
      <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"enqueue on stopped ThreadPool"</span>);
    }

    tasks_.<span class="hljs-built_in">emplace</span>([taskPtr]() {
      (*taskPtr)();
    });
  }
  condition.<span class="hljs-built_in">notify_one</span>();
  <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p>其中<code>using return_type = std::invoke_result_t&lt;F, Args...&gt;;</code>是推导调用 <code>f(args...)</code> 的返回类型，<code>std::packaged_task&lt;return_type()&gt;</code>用于把一个可调用对象封装成一个可以产生 <code>std::future</code> 的任务。其中<code>return_type()</code>表示一个无参数，返回类型为 <code>return_type</code>的任务，正好对应<code>std::bind</code>后的类型。</p>
<p>之后我们就可以调用<code>taskPtr-&gt;get_future()</code>：取得与该 <code>packaged_task</code> 关联的 <code>std::future</code>，将这个<code>future</code>返回出去之后，调用者可以通过<code>res.get()</code>获取返回值，类似下面的调用：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">auto</span> future = pool.<span class="hljs-built_in">enqueue</span>([](<span class="hljs-type">int</span> x){ <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span>; }, <span class="hljs-number">21</span>);
<span class="hljs-type">int</span> result = future.<span class="hljs-built_in">get</span>(); <span class="hljs-comment">// result == 42</span>
</code></pre>
<p>至此，我们的简易线程池就完成了，完整代码可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fprogschj%2FThreadPool%2Fblob%2Fmaster%2FThreadPool.h" target="_blank" title="https://github.com/progschj/ThreadPool/blob/master/ThreadPool.h" ref="nofollow noopener noreferrer">这个仓库</a>，下面给出用户使用线程池的示例代码：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    
    <span class="hljs-function">ThreadPool <span class="hljs-title">pool</span><span class="hljs-params">(<span class="hljs-number">4</span>)</span></span>;
    std::vector&lt; std::future&lt;<span class="hljs-type">int</span>&gt; &gt; results;

    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; ++i) {
        results.<span class="hljs-built_in">emplace_back</span>(
            pool.<span class="hljs-built_in">enqueue</span>([i] {
                std::cout &lt;&lt; <span class="hljs-string">"hello "</span> &lt;&lt; i &lt;&lt; std::endl;
                std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
                std::cout &lt;&lt; <span class="hljs-string">"world "</span> &lt;&lt; i &lt;&lt; std::endl;
                <span class="hljs-keyword">return</span> i*i;
            })
        );
    }

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> &amp;&amp; result: results)
        std::cout &lt;&lt; result.<span class="hljs-built_in">get</span>() &lt;&lt; <span class="hljs-string">' '</span>;
    std::cout &lt;&lt; std::endl;
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RuoYi 登录性能：异步处理登录日志的实践与代码解析]]></title>    <link>https://juejin.cn/post/7571655979256627240</link>    <guid>https://juejin.cn/post/7571655979256627240</guid>    <pubDate>2025-11-12T15:23:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655979256627240" data-draft-id="7571672422689587252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RuoYi 登录性能：异步处理登录日志的实践与代码解析"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2025-11-12T15:23:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RuoYi 登录性能：异步处理登录日志的实践与代码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:23:30.000Z" title="Wed Nov 12 2025 15:23:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">优化 RuoYi 登录性能：异步处理登录日志的实践与代码解析</h2>
<p>在现代Web应用中，用户体验和系统性能是至关重要的指标。RuoYi（若依）框架作为一款优秀的后台管理系统，其性能优化同样是开发者关注的焦点。在登录认证这样的高频操作中，即使是看似简单的日志记录，也可能成为潜在的性能瓶颈。本文将深入探讨在 RuoYi 框架中，如何通过<strong>异步处理</strong>登录日志来显著提升系统响应速度和吞吐量，并提供详细的代码解析。</p>
<h3 data-id="heading-1">一、为什么登录日志需要异步处理？</h3>
<p>当用户尝试登录系统时，除了验证用户名密码、生成Token等核心业务逻辑外，通常还需要记录用户的登录信息，例如登录时间、IP地址、登录状态（成功/失败）等。这些信息往往需要持久化到数据库中。</p>
<p>如果这些日志记录操作是<strong>同步</strong>进行的，即在登录认证流程中等待数据库写入完成后才返回结果，那么：</p>
<ol>
<li><strong>增加响应时间：</strong> 数据库I/O操作相对耗时，会直接增加用户等待登录响应的时间。</li>
<li><strong>降低并发能力：</strong> 在高并发场景下，同步的数据库操作会阻塞主线程，限制系统处理更多并发登录请求的能力。</li>
<li><strong>资源竞争：</strong> 多个登录请求同时写入数据库时，可能引发数据库锁竞争，进一步恶化性能。</li>
</ol>
<p>因此，将登录日志的写入操作从核心登录流程中剥离出来，进行<strong>异步处理</strong>，成为优化登录性能的关键策略。这意味着登录认证通过后，系统可以立即响应用户，而日志记录则在后台默默进行，互不干扰。</p>
<h3 data-id="heading-2">二、RuoYi 框架中异步处理登录日志的实现思路</h3>
<p>在 RuoYi 框架中，我们通常会利用 Spring Boot 提供的特性，结合事件驱动机制和线程池来实现登录日志的异步记录。核心思路如下：</p>
<ol>
<li><strong>事件发布：</strong> 在登录认证成功或失败后，发布一个自定义的登录事件（<code>LoginEvent</code>），包含所有需要记录的登录信息。</li>
<li><strong>异步监听：</strong> 创建一个事件监听器，并使用 Spring 的 <code>@Async</code> 注解将其标记为异步方法。当 <code>LoginEvent</code> 被发布时，这个监听器会在独立的线程中执行。</li>
<li><strong>日志持久化：</strong> 在异步监听器中，调用 <code>SysLogininforService</code> 将登录信息保存到数据库。</li>
</ol>
<h3 data-id="heading-3">三、代码实现与解析</h3>
<p>接下来，我们将通过具体的代码示例来逐步构建异步登录日志功能。</p>
<h4 data-id="heading-4">1. 开启 Spring 异步支持</h4>
<p>首先，确保你的 Spring Boot 应用开启了异步执行功能。这通常通过在启动类上添加 <code>@EnableAsync</code> 注解实现。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RuoYiApplication.java</span>
<span class="hljs-keyword">package</span> com.ruoyi;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.EnableAsync; <span class="hljs-comment">// 引入异步支持</span>

<span class="hljs-comment">/**
 * 启动程序
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@SpringBootApplication(exclude = { DataSourceAutoConfiguration.class })</span>
<span class="hljs-meta">@EnableAsync</span> <span class="hljs-comment">// 开启异步方法执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuoYiApplication</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>
    {
        <span class="hljs-comment">// System.setProperty("spring.devtools.restart.enabled", "false");</span>
        SpringApplication.run(RuoYiApplication.class, args);
        System.out.println(<span class="hljs-string">"(♥◠‿◠)ﾉﾞ  若依启动成功   ლ(´ڡ`ლ)ﾞ  \n"</span> +
                <span class="hljs-string">" .-------.         .--.  .--.\n"</span> +
                <span class="hljs-string">" |  _ _   \\ .-.     |  |  |  |\n"</span> +
                <span class="hljs-string">" | ( ' )  | `-'     |  .--.  |\n"</span> +
                <span class="hljs-string">" |(_ o _) /         |  |  |  |\n"</span> +
                <span class="hljs-string">" | (_,_).' __        |  |  |  |\n"</span> +
                <span class="hljs-string">" |  |\\ \\  |  |   ___ |  |  |  |\n"</span> +
                <span class="hljs-string">" |  | \\ `'   / / \\  \\          /\n"</span> +
                <span class="hljs-string">" |  |  \\    /   \\  \\        /\n"</span> +
                <span class="hljs-string">" '--'   `--'     '--'--.--'\n"</span> +
                <span class="hljs-string">"                                      "</span>);
    }
}
</code></pre>
<h4 data-id="heading-5">2. 定义异步线程池（可选，但推荐）</h4>
<p>为了更好地控制异步任务的执行，我们可以自定义一个线程池供 <code>@Async</code> 注解使用。这样可以避免使用 Spring 默认的 <code>SimpleAsyncTaskExecutor</code>，提高线程资源管理效率。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AsyncConfig.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.config;

<span class="hljs-keyword">import</span> java.util.concurrent.Executor;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.AsyncConfigurer;
<span class="hljs-keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

<span class="hljs-comment">/**
 * 异步任务配置
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span>
{
    <span class="hljs-comment">// 定义一个日志专用的线程池</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOG_TASK_EXECUTOR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"logTaskExecutor"</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Bean(name = LOG_TASK_EXECUTOR)</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span>
    {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">5</span>); <span class="hljs-comment">// 核心线程数</span>
        executor.setMaxPoolSize(<span class="hljs-number">10</span>); <span class="hljs-comment">// 最大线程数</span>
        executor.setQueueCapacity(<span class="hljs-number">200</span>); <span class="hljs-comment">// 队列容量</span>
        executor.setKeepAliveSeconds(<span class="hljs-number">60</span>); <span class="hljs-comment">// 线程空闲时间</span>
        executor.setThreadNamePrefix(<span class="hljs-string">"ruoyi-log-async-"</span>); <span class="hljs-comment">// 线程名称前缀</span>
        <span class="hljs-comment">// 拒绝策略：当队列满且线程数达到最大时，由调用者线程执行任务</span>
        executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<h4 data-id="heading-6">3. 定义登录事件</h4>
<p>创建一个自定义的 <code>LoginEvent</code>，它继承自 Spring 的 <code>ApplicationEvent</code>，用于封装登录相关的信息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LoginEvent.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.event;

<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysLogininfor;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationEvent;

<span class="hljs-comment">/**
 * 登录事件
 * 用于在登录成功或失败时，发布事件进行异步日志记录
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SysLogininfor logininfor;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LoginEvent</span><span class="hljs-params">(Object source, SysLogininfor logininfor)</span>
    {
        <span class="hljs-built_in">super</span>(source);
        <span class="hljs-built_in">this</span>.logininfor = logininfor;
    }

    <span class="hljs-keyword">public</span> SysLogininfor <span class="hljs-title function_">getLogininfor</span><span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> logininfor;
    }
}
</code></pre>
<h4 data-id="heading-7">4. 创建异步事件监听器</h4>
<p>编写一个 Spring 组件作为事件监听器。使用 <code>@EventListener</code> 注解监听 <code>LoginEvent</code>，并通过 <code>@Async</code> 注解指定它在后台线程中执行，同时可以指定使用我们之前定义的线程池。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LoginEventListener.java</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.listener;

<span class="hljs-keyword">import</span> com.ruoyi.framework.config.AsyncConfig;
<span class="hljs-keyword">import</span> com.ruoyi.framework.event.LoginEvent;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysLogininforService;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.event.EventListener;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 登录事件监听器
 * 负责异步记录登录日志到数据库
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginEventListener</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(LoginEventListener.class);

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysLogininforService logininforService;

    <span class="hljs-comment">/**
     * 监听 LoginEvent，并在异步线程中处理登录日志
     * 指定使用 logTaskExecutor 线程池
     *
     * <span class="hljs-doctag">@param</span> event 登录事件
     */</span>
    <span class="hljs-meta">@Async(AsyncConfig.LOG_TASK_EXECUTOR)</span>
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLoginEvent</span><span class="hljs-params">(LoginEvent event)</span>
    {
        log.debug(<span class="hljs-string">"异步线程[{}] 开始处理登录日志..."</span>, Thread.currentThread().getName());
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 获取登录信息对象</span>
            <span class="hljs-type">SysLogininfor</span> <span class="hljs-variable">logininfor</span> <span class="hljs-operator">=</span> event.getLogininfor();
            <span class="hljs-comment">// 调用服务层方法，将登录日志保存到数据库</span>
            logininforService.insertLogininfor(logininfor);
            log.info(<span class="hljs-string">"用户[{}] 登录日志记录成功。状态: {}"</span>, logininfor.getUserName(), logininfor.getStatus());
        }
        <span class="hljs-keyword">catch</span> (Exception e)
        {
            log.error(<span class="hljs-string">"异步记录登录日志失败：{}"</span>, e.getMessage(), e);
            <span class="hljs-comment">// 可以在这里添加告警通知机制</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-8">5. 在登录服务中发布事件</h4>
<p>最后，在 RuoYi 的登录服务（例如 <code>SysLoginService</code>）中，当用户登录成功或失败后，构建 <code>SysLogininfor</code> 对象，并通过 <code>ApplicationEventPublisher</code> 发布 <code>LoginEvent</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SysLoginService.java (简化版，仅展示事件发布逻辑)</span>
<span class="hljs-keyword">package</span> com.ruoyi.framework.web.service;

<span class="hljs-keyword">import</span> com.ruoyi.common.constant.Constants;
<span class="hljs-keyword">import</span> com.ruoyi.common.exception.user.CaptchaException;
<span class="hljs-keyword">import</span> com.ruoyi.common.exception.user.UserPasswordNotMatchException;
<span class="hljs-keyword">import</span> com.ruoyi.common.utils.DateUtils;
<span class="hljs-keyword">import</span> com.ruoyi.common.utils.ServletUtils;
<span class="hljs-keyword">import</span> com.ruoyi.framework.event.LoginEvent; <span class="hljs-comment">// 引入 LoginEvent</span>
<span class="hljs-keyword">import</span> com.ruoyi.framework.manager.AsyncManager;
<span class="hljs-keyword">import</span> com.ruoyi.framework.manager.factory.AsyncFactory;
<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysLogininfor;
<span class="hljs-keyword">import</span> com.ruoyi.system.domain.SysUser;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysConfigService;
<span class="hljs-keyword">import</span> com.ruoyi.system.service.ISysUserService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationEventPublisher; <span class="hljs-comment">// 引入事件发布器</span>
<span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.BadCredentialsException;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
<span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 登录校验方法
 *
 * <span class="hljs-doctag">@author</span> ruoyi
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysLoginService</span>
{
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TokenService tokenService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysUserService userService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ISysConfigService configService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher; <span class="hljs-comment">// 注入事件发布器</span>

    <span class="hljs-comment">/**
     * 登录验证
     *
     * <span class="hljs-doctag">@param</span> username 用户名
     * <span class="hljs-doctag">@param</span> password 密码
     * <span class="hljs-doctag">@param</span> code     验证码
     * <span class="hljs-doctag">@param</span> uuid     唯一标识
     * <span class="hljs-doctag">@return</span> 结果
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, String code, String uuid)</span>
    {
        <span class="hljs-comment">// ... (省略验证码、账户锁定等其他登录逻辑) ...</span>

        <span class="hljs-type">SysLogininfor</span> <span class="hljs-variable">logininfor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SysLogininfor</span>();
        logininfor.setUserName(username);
        logininfor.setIpaddr(ServletUtils.getIpAddr(ServletUtils.getRequest()));
        logininfor.setLoginLocation(AsyncFactory.getRealAddressByIP(logininfor.getIpaddr()));
        logininfor.setBrowser(ServletUtils.getBrowser());
        logininfor.setOs(ServletUtils.getOs());
        logininfor.setLoginTime(DateUtils.getNowDate());

        Authentication authentication;
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span>
            authentication = authenticationManager
                    .authenticate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password));

            <span class="hljs-comment">// 认证成功</span>
            logininfor.setStatus(Constants.SUCCESS);
            logininfor.setMsg(<span class="hljs-string">"登录成功"</span>);
            <span class="hljs-comment">// 发布登录成功事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginEvent</span>(<span class="hljs-built_in">this</span>, logininfor));
        }
        <span class="hljs-keyword">catch</span> (Exception e)
        {
            logininfor.setStatus(Constants.FAIL);
            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> BadCredentialsException || e <span class="hljs-keyword">instanceof</span> UserPasswordNotMatchException)
            {
                logininfor.setMsg(<span class="hljs-string">"用户不存在/密码错误"</span>);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> CaptchaException)
            {
                logininfor.setMsg(<span class="hljs-string">"验证码错误"</span>);
            }
            <span class="hljs-keyword">else</span>
            {
                logininfor.setMsg(e.getMessage());
            }
            <span class="hljs-comment">// 发布登录失败事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginEvent</span>(<span class="hljs-built_in">this</span>, logininfor));
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e.getMessage()); <span class="hljs-comment">// 抛出异常给上层处理</span>
        }
        <span class="hljs-comment">// ... (省略后续生成Token等逻辑) ...</span>
        <span class="hljs-keyword">return</span> token;
    }
}
</code></pre>
<p><strong>代码说明：</strong></p>
<ul>
<li><code>ApplicationEventPublisher</code> 是 Spring 提供的事件发布接口，通过 <code>eventPublisher.publishEvent()</code> 方法可以发布任何继承自 <code>ApplicationEvent</code> 的事件。</li>
<li><code>LoginEvent</code> 包含了所有需要在日志中记录的信息。</li>
<li>当 <code>login</code> 方法中认证成功或失败后，我们立即发布 <code>LoginEvent</code>，而无需等待数据库操作完成。</li>
<li><code>LoginEventListener</code> 上的 <code>@Async</code> 和 <code>@EventListener</code> 会确保 <code>handleLoginEvent</code> 方法在 <code>logTaskExecutor</code> 线程池中异步执行，从而不阻塞主登录流程。</li>
</ul>
<h3 data-id="heading-9">四、测试与效果</h3>
<p>通过上述改造，当用户发起登录请求时：</p>
<ol>
<li>主线程快速完成用户认证和Token生成等核心操作。</li>
<li><code>SysLoginService</code> 发布 <code>LoginEvent</code> 后，立即返回登录结果给前端。</li>
<li>一个独立的线程（来自 <code>logTaskExecutor</code> 线程池）接收到 <code>LoginEvent</code>，并在后台异步执行 <code>logininforService.insertLogininfor()</code> 方法，将登录日志保存到数据库。</li>
</ol>
<p>这种模式下，登录接口的响应速度将主要取决于认证逻辑和Token生成，而不再受数据库I/O的拖累。特别是在数据库压力较大或网络延迟较高的情况下，异步处理的优势将更加明显。</p>
<h3 data-id="heading-10">五、总结</h3>
<p>异步处理登录日志是优化 RuoYi 框架性能的一种有效手段。通过利用 Spring 的 <code>@EnableAsync</code>、自定义线程池、事件发布与监听机制，我们可以轻松地将日志记录这一非核心业务逻辑从主流程中解耦出来，使其在后台异步执行。这不仅提升了用户登录体验，也增强了系统的并发处理能力和整体稳定性。</p>
<p><strong>关键点回顾：</strong></p>
<ul>
<li><strong>问题根源：</strong> 同步数据库I/O是登录性能瓶颈。</li>
<li><strong>解决方案：</strong> 事件驱动 + <code>@Async</code> 异步处理。</li>
<li><strong>代码核心：</strong> <code>LoginEvent</code>、<code>@EnableAsync</code>、自定义 <code>Executor</code>、<code>@Async @EventListener</code>、<code>ApplicationEventPublisher</code>。</li>
</ul>
<p>希望本文能帮助你在 RuoYi 框架的开发中更好地实践异步编程，构建出更高效、更健壮的应用。</p>
<hr/>
<p>`</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 通道引用与 close 操作]]></title>    <link>https://juejin.cn/post/7571678674145705994</link>    <guid>https://juejin.cn/post/7571678674145705994</guid>    <pubDate>2025-11-12T15:44:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674145705994" data-draft-id="7571662618056015898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 通道引用与 close 操作"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T15:44:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 通道引用与 close 操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:44:16.000Z" title="Wed Nov 12 2025 15:44:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Go 开发中，通道（chan）的使用频率极高，但它的引用特性和 close 操作的作用范围，往往是新手容易踩坑的点。比如 “通道赋值后关闭原变量，新变量会受影响吗？”“会不会导致内存泄露？”“后续发送数据会不会 panic？”—— 这篇文章就用通俗的语言 + 结论 + 代码验证，把这些问题讲透。</p>
<h2 data-id="heading-0">一、核心结论（先给答案，不绕弯）</h2>
<ol>
<li><code>destChan</code> 不是指针，是「通道引用」：Go 中通道是引用类型（类似 slice、map），变量存储的是指向底层数据结构的引用，而非结构本身。</li>
<li>关闭 <code>source.TaskChan</code> 后，<code>destChan</code> 会受影响，但不是 “被关闭”：close 操作作用于底层通道，所有引用这个通道的变量（包括 <code>destChan</code>）都会感知到 “通道已关闭”。</li>
<li>不会因 <code>destChan</code> 导致内存泄露：只要所有引用（<code>source.TaskChan</code> 和 <code>destChan</code>）都不再被使用，底层通道会被 GC 回收；真正需要警惕的是 “关闭通道后的发送 panic”。</li>
</ol>
<h2 data-id="heading-1">二、逐点拆解：把原理讲明白</h2>
<h3 data-id="heading-2">1. 通道是 “引用类型”，不是指针但行为类似</h3>
<p>Go 中的引用类型（chan/slice/map/func/interface）有个共性：变量存储的是「指向底层对象的地址」，赋值操作只会复制这个地址，不会复制底层对象。</p>
<p>举个实际场景的例子：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 假设 source 是一个自定义结构体，TaskChan 是已初始化的 chan string</span>
<span class="hljs-keyword">type</span> Resource <span class="hljs-keyword">struct</span> {
    TaskChan <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span> <span class="hljs-comment">// 通道字段</span>
}

<span class="hljs-keyword">var</span> source = Resource{
    TaskChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">5</span>), <span class="hljs-comment">// 初始化带缓冲通道</span>
}

<span class="hljs-comment">// 赋值操作：将 source.TaskChan 赋值给 destChan</span>
destChan := source.TaskChan
</code></pre>
<p>执行后，<code>destChan</code> 和 <code>source.TaskChan</code> 持有同一个底层通道的引用 —— 就像两个遥控器控制同一个电视，操作任何一个，影响的都是同一个 “底层设备”。</p>
<p>这里要注意：<code>destChan</code> 不是 <code>*chan string</code>（通道指针），而是 <code>chan string</code>（通道引用类型），语法上不需要解引用（<code>*</code>）就能直接使用，比指针更简洁。</p>
<h3 data-id="heading-3">2. close 操作作用于 “底层通道”，所有引用都会感知</h3>
<p>当我们执行 <code>close(source.TaskChan)</code> 时，要明确一个关键：<strong>关闭的是底层的通道对象，不是 <code>source.TaskChan</code> 这个变量本身</strong>。</p>
<p>因为 <code>destChan</code> 和 <code>source.TaskChan</code> 指向同一个底层通道，所以 <code>destChan</code> 会变成 “指向已关闭通道的引用”—— 此时会有两个核心影响：</p>
<ul>
<li>往 <code>destChan</code> 发送数据：直接 panic（错误信息：<code>send on closed channel</code>）；</li>
<li>从 <code>destChan</code> 接收数据：会立即返回通道元素的零值 + <code>ok=false</code>（表示通道已关闭且无数据）。</li>
</ul>
<p>可以用一个通俗的比喻理解：两个指针指向同一个文件，关闭文件后，两个指针都无法再写入文件，但指针变量本身还存在（不是 nil），只是失去了有效操作的能力。</p>
<h3 data-id="heading-4">3. 内存泄露风险：几乎不存在，无需过度担心</h3>
<p>内存泄露的核心是 “底层对象被无用的引用持有，无法被 GC 回收”，但在这个场景中，完全不需要担心：</p>
<ul>
<li><code>destChan</code> 通常是局部变量（比如在函数或回调中定义），函数执行完毕后，变量会被销毁，引用自然释放；</li>
<li><code>source.TaskChan</code> 是结构体字段，当 <code>source</code> 结构体被销毁（比如任务执行结束后），这个引用也会消失；</li>
<li>只要所有引用都释放，无论底层通道是否关闭，都会被 GC 回收，不会造成内存泄露。</li>
</ul>
<p>唯一可能的泄露场景：如果 <code>source</code> 是全局变量（长期存在），且通道被关闭后，<code>source.TaskChan</code> 仍被持有，但这是 <code>source</code> 的生命周期管理问题，和 <code>destChan</code> 无关。</p>
<h2 data-id="heading-5">三、代码验证：直观感受引用与 close 的影响</h2>
<p>光说不练假把式，用一段简单的代码验证上面的结论，跑起来就能直观看到效果：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 初始化一个通道（底层通道对象在堆上分配）</span>
    sourceChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">1</span>)
    fmt.Printf(<span class="hljs-string">"sourceChan 变量本身地址（栈上）：%p\n"</span>, &amp;sourceChan)
    fmt.Printf(<span class="hljs-string">"sourceChan 引用的底层通道地址（堆上）：%p\n"</span>, sourceChan)

    <span class="hljs-comment">// 2. 赋值给 destChan：复制引用</span>
    destChan := sourceChan
    fmt.Printf(<span class="hljs-string">"destChan 变量本身地址（栈上）：%p\n"</span>, &amp;destChan)
    fmt.Printf(<span class="hljs-string">"destChan 引用的底层通道地址（堆上）：%p\n"</span>, destChan)

    <span class="hljs-comment">// 3. 关闭 sourceChan（实际关闭的是底层通道）</span>
    <span class="hljs-built_in">close</span>(sourceChan)

    <span class="hljs-comment">// 4. destChan 感知到底层通道已关闭</span>
    data, ok := &lt;-destChan
    fmt.Printf(<span class="hljs-string">"从 destChan 接收数据：data=%q, ok=%v（ok=false 表示通道已关闭）\n"</span>, data, ok)

    <span class="hljs-comment">// 5. 往 destChan 发送数据会直接 panic（注释掉可避免运行报错）</span>
    <span class="hljs-comment">// destChan &lt;- "test" // 执行后报错：panic: send on closed channel</span>
}
</code></pre>
<h3 data-id="heading-6">运行结果：</h3>
<pre><code class="hljs language-plaintext" lang="plaintext">sourceChan 变量本身地址（栈上）：0xc0000a6020
sourceChan 引用的底层通道地址（堆上）：0xc0000b4000
destChan 变量本身地址（栈上）：0xc0000a6040
destChan 引用的底层通道地址（堆上）：0xc0000b4000
从 destChan 接收数据：data="", ok=false（ok=false 表示通道已关闭）
</code></pre>
<h3 data-id="heading-7">结论验证：</h3>
<ul>
<li><code>sourceChan</code> 和 <code>destChan</code> 是不同的变量（栈地址不同），但引用同一个底层通道（堆地址相同）；</li>
<li>关闭 <code>sourceChan</code> 后，<code>destChan</code> 能直接感知到通道关闭；</li>
<li>关闭后的通道发送数据会 panic，这是核心风险点。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[初见 Dart：这门新语言如何让你的 App「动」起来？]]></title>    <link>https://juejin.cn/post/7571641339688845312</link>    <guid>https://juejin.cn/post/7571641339688845312</guid>    <pubDate>2025-11-12T11:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571641339688845312" data-draft-id="7571636682695278632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="初见 Dart：这门新语言如何让你的 App「动」起来？"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-11-12T11:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="全栈派森"/> <meta itemprop="url" content="https://juejin.cn/user/430664289093176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            初见 Dart：这门新语言如何让你的 App「动」起来？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664289093176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    全栈派森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:03:51.000Z" title="Wed Nov 12 2025 11:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好,我是<code>Petter Guo</code> <br/></p>
<p>一位热爱<code>探索</code>的<code>全栈工程师</code>。在这里，我将分享<code>个人</code>的<code>Technical essentials</code>，带你玩转<code>前端</code>、<code>后端</code>到 <code>DevOps</code> 的硬核技术，解锁<code>AI</code>，助你打通技术任督二脉，成为真正的<code>全能玩家</code>!！<br/></p>
<p>如果对你有帮助, 请<code>点赞</code>+ <code>收藏</code> +<code>关注</code>鼓励下, 学习公众号为 <code>全栈派森</code>。 <br/></p>
<p>时间过的好快, 本人接触业务比较复杂, 最近一直在搞跨平台相关的技术, 比如很火的两大框架 Flutter &amp; ReactNative, 本期你将有如下收获:</p>
<ol>
<li>🍰 Flutter底层架构</li>
<li>🍦 Flutter核心组件</li>
<li>⛽️ Dart常用语法</li>
<li>🙋 Flutter vs RN</li>
</ol>
<h3 data-id="heading-0">Flutter底层架构</h3>
<ol>
<li>
<p>顶层：框架层 (The Framework)</p>
<p>这一层完全由 <strong>Dart 语言</strong> 编写，是我们作为开发者直接打交道的部分。</p>
</li>
</ol>
<ul>
<li><strong>Dart Platform:</strong> 包含 Dart 语言、核心库和 Dart VM（虚拟机）。</li>
<li><strong>Widgets (组件)：</strong> Flutter 的核心概念。所有的 UI 都是由 Widget 组成的，它描述了 UI 的一部分应该如何渲染和交互。</li>
<li><strong>基础 Widgets：</strong> 如 <code>Text</code>, <code>Image</code>, <code>Row</code>, <code>Column</code> 等。</li>
<li><strong>渲染 Widgets：</strong>
<ul>
<li><strong>Material Design:</strong> 实现 Google 的 Material 设计规范（如 <code>Scaffold</code>, <code>AppBar</code>）。</li>
<li><strong>Cupertino:</strong> 实现 Apple 的 iOS 设计规范。</li>
</ul>
</li>
<li><strong>Rendering (渲染):</strong> 提供了抽象的渲染模型，包括 <code>RenderObject</code>、布局、绘制等。</li>
<li><strong>Animation, Gestures &amp; Painting:</strong> 处理动画、手势识别和底层绘图逻辑。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> Flutter 框架只提供 <strong>抽象的 UI 组件</strong> 和 <strong>一套渲染规范</strong>。</p>
</blockquote>
<ol start="2">
<li>
<p>中间层：引擎层 (The Engine)</p>
<p>这一层主要由 <strong>C++</strong> 编写，它负责执行 Dart 运行时环境，并将上层的 Dart 代码渲染到萤幕上。</p>
</li>
</ol>
<ul>
<li><strong>Skia 引擎 (Skia Graphics Engine):</strong> 这是 Flutter 最关键的部分。 Skia 是一个高性能的 2D 渲染引擎，也是 Chrome 和 Android 采用的图形库。 <strong>Flutter 依靠 Skia 在移动设备上绘制每一个像素</strong>。</li>
<li><strong>优势：</strong> 这使得 Flutter <strong>完全绕过了</strong> 原生 OEM（原始设备制造商）的 UI 组件。应用程式只需一个「画布」，所有的按钮、文本、动画都由 Skia 直接绘制。</li>
<li><strong>Dart Runtime：</strong> Dart 虚拟机（VM）和 AOT/JIT 编译器，负责运行 Dart 代码。</li>
<li><strong>Text Layout:</strong> 处理文本布局和字体渲染。</li>
<li><strong>Platform Channels (平台通道):</strong> 实现 Dart 代码与原生平台（如 iOS 的 Swift/Objective-C 或 Android 的 Java/Kotlin）之间的通信。这是 Flutter 访问原生 API（如 GPS、蓝牙）的唯一途径。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> 引擎层是 <strong>底层执行者</strong>，负责将 Dart 的指令翻译成像素并绘制出来。</p>
</blockquote>
<ol start="3">
<li>
<p>底层：嵌入层 (The Embedder)</p>
<p>这是与 <strong>特定操作系统（OS）</strong> 交互的层级。</p>
</li>
</ol>
<ul>
<li><strong>平台特定的程式码：</strong> 这部分是 Dart 运行时和底层 OS 之间粘合剂。</li>
<li><strong>Android:</strong> 使用 Java/Kotlin，将 Flutter 引擎作为 <code>Activity</code> 嵌入。</li>
<li><strong>iOS:</strong> 使用 Swift/Objective-C，将 Flutter 引擎作为 <code>ViewController</code> 嵌入。</li>
<li><strong>访问原生 API：</strong> 嵌入层提供了底层的系统服务、生命周期事件、输入事件（触摸、滑鼠）等。</li>
</ul>
<blockquote>
<p><strong>核心思想：</strong> 嵌入层是 <strong>宿主</strong>，负责提供一个原生环境来运行和承载 Flutter 引擎。</p>
</blockquote>
<h3 data-id="heading-1">Flutter优势</h3>
<p>这种分层架构带来了以下独特的优势：</p>
<ol>
<li><strong>高性能 (High Performance):</strong> 由于 Dart 代码可以 <strong>AOT (Ahead-of-Time)</strong> 编译成高效的 ARM 机器码，再加上直接使用 Skia 引擎渲染，性能可以<strong>媲美原生应用</strong>。</li>
<li><strong>UI 一致性 (UI Consistency):</strong> 由于不依赖原生系统的 UI，Flutter 应用在​​任何版本或型号的设备上都能保持<strong>像素级的一致性</strong>。</li>
<li><strong>消除 Bridge 瓶颈 (No Bridge):</strong> Flutter 不使用 React Native 那样的 JSON 异步 Bridge，所有的 UI 逻辑都在 Dart VM 中运行，避免了序列化和跨线程通信的开销。</li>
</ol>
<h3 data-id="heading-2">Flutter核心组件</h3>
<h4 data-id="heading-3">1. 📂 布局与结构 Widgets (Layout &amp; Structure)</h4>















































<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">关键属性</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>Scaffold</strong></td><td align="left">脚手架。提供应用程式的基本结构，如抽屉、底部导航栏、浮动按钮等。</td><td align="left"><code>appBar</code>, <code>body</code>, <code>drawer</code>, <code>bottomNavigationBar</code></td><td align="left">每个页面/屏幕的顶层 Widget。</td></tr><tr><td align="left"><strong>Container</strong></td><td align="left">容器。最基础的布局/装饰 Widget，用于添加边距、填充、颜色、装饰等。</td><td align="left"><code>child</code>, <code>padding</code>, <code>margin</code>, <code>color</code>, <code>decoration</code></td><td align="left">给子 Widget 设置背景色和边距。</td></tr><tr><td align="left"><strong>Row / Column</strong></td><td align="left">行/列。在水平 (<code>Row</code>) 或垂直 (<code>Column</code>) 方向上排列多个子 Widget。</td><td align="left"><code>children</code> (Widget 列表), <code>mainAxisAlignment</code>, <code>crossAxisAlignment</code></td><td align="left">实现线性布局。</td></tr><tr><td align="left"><strong>Center</strong></td><td align="left">居中。将其子 Widget 居中放置。</td><td align="left"><code>child</code></td><td align="left">将单个元素放在萤幕中央。</td></tr><tr><td align="left"><strong>Padding</strong></td><td align="left">填充。在其子 Widget 周围添加内部间距（填充）。</td><td align="left"><code>padding</code> (通常使用 <code>EdgeInsets.all</code> 等)</td><td align="left">调整 Widget 内部空间。</td></tr><tr><td align="left"><strong>SizedBox</strong></td><td align="left">尺寸。用于控制子 Widget 的大小或简单地创建空白间距。</td><td align="left"><code>width</code>, <code>height</code>, <code>child</code></td><td align="left">创建两个 Widget 之间的固定间隔。</td></tr></tbody></table>
<h4 data-id="heading-4">2. 🧱 基础内容与交互 Widgets (Content &amp; Interaction)</h4>















































<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">关键属性</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>Text</strong></td><td align="left">文本。用于显示静态文本。</td><td align="left"><code>data</code> (文本内容), <code>style</code> (TextStyle), <code>textAlign</code></td><td align="left">显示标题、描述、正文。</td></tr><tr><td align="left"><strong>Image</strong></td><td align="left">图片。用于显示图片，支持本地资源、文件或网路图片。</td><td align="left"><code>image</code> (Asset/NetworkImage), <code>fit</code>, <code>width</code>, <code>height</code></td><td align="left">显示应用 Logo、用户头像、网路图片。</td></tr><tr><td align="left"><strong>Icon</strong></td><td align="left">图标。用于显示 Material 或 Cupertino 图标。</td><td align="left"><code>icon</code> (Icons.xxx), <code>color</code>, <code>size</code></td><td align="left">菜单图标、操作按钮图标。</td></tr><tr><td align="left"><strong>ElevatedButton</strong></td><td align="left">按钮。带有阴影效果的凸起按钮。</td><td align="left"><code>onPressed</code> (点击回调), <code>child</code></td><td align="left">提交表单、执行操作。</td></tr><tr><td align="left"><strong>TextField</strong></td><td align="left">文本输入框。用于接收用户输入。</td><td align="left"><code>controller</code>, <code>decoration</code> (InputDecoration), <code>onChanged</code>, <code>keyboardType</code></td><td align="left">用户名/密码输入、搜寻框。</td></tr><tr><td align="left"><strong>ListView</strong></td><td align="left">列表。用于垂直滚动的长列表，<strong>只渲染可见部分</strong>（性能优化）。</td><td align="left"><code>children</code> 或 <code>itemBuilder</code> (Factory 模式)</td><td align="left">显示新闻列表、聊天记录。</td></tr></tbody></table>
<h4 data-id="heading-5">3. 🔄 状态管理与动态 Widgets (State Management)</h4>























<table><thead><tr><th align="left">Widget</th><th align="left">作用</th><th align="left">区别</th><th align="left">示例场景</th></tr></thead><tbody><tr><td align="left"><strong>StatelessWidget</strong></td><td align="left">无状态 Widget。一旦创建，它的属性（数据）就不会改变。</td><td align="left">数据是固定的 (<code>final</code>)，没有内部状态。</td><td align="left">显示静态文本、Logo、静态图标。</td></tr><tr><td align="left"><strong>StatefulWidget</strong></td><td align="left">有状态 Widget。其内部数据可以在 Widget 生命周期内发生变化。</td><td align="left">包含一个 <code>State</code> 对象，通过调用 <strong><code>setState()</code></strong> 来触发 UI 重新绘制。</td><td align="left">带有计数器的按钮、复选框、动态列表。</td></tr></tbody></table>
<h3 data-id="heading-6">✍️ Dart 常用语法特性</h3>
<p>Flutter 使用 Dart 语言，它是一种面向对象、类基的语言，同时支持 AOT（编译成机器码）和 JIT（即时编译，用于热重载）。</p>
<h4 data-id="heading-7">1. 类型与变量</h4>
<ul>
<li><strong>类型推断：</strong> 大多数时候可以使用 <code>var</code>，Dart 会自动推断类型。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">var</span> name = <span class="hljs-string">'Alice'</span>; <span class="hljs-comment">// String</span>
<span class="hljs-keyword">var</span> year = <span class="hljs-number">1977</span>;   <span class="hljs-comment">// int</span>
</code></pre>
<ul>
<li><strong>明确类型：</strong> 也可以明确声明。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">String</span> name = <span class="hljs-string">'Bob'</span>;
<span class="hljs-built_in">int</span> age = <span class="hljs-number">30</span>;
</code></pre>
<ul>
<li><strong>不变性 (Immutability)：</strong></li>
<li><code>final</code>: 运行时常量，只能赋值一次。</li>
<li><code>const</code>: 编译时常量，在编译时就确定值。</li>
</ul>

<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> uid = getUserId(); <span class="hljs-comment">// 运行时确定</span>
<span class="hljs-keyword">const</span> PI = <span class="hljs-number">3.14159</span>;             <span class="hljs-comment">// 编译时确定</span>
</code></pre>
<ul>
<li><strong>可空类型 (Null Safety)：</strong> 这是 Dart 2.12+ 的重要特性。</li>
<li><code>String?</code>: 变量可以是 <code>String</code> 类型，也可以是 <code>null</code>。</li>
<li><code>String</code>: 变量<strong>不能</strong>是 <code>null</code>。</li>
<li><code>!</code> (断言): 告诉编译器「我相信它不是 null」。</li>
</ul>
<h4 data-id="heading-8">2. 函数与箭头语法</h4>
<ul>
<li><strong>普通函数：</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">int</span> add(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<ul>
<li><strong>箭头函数：</strong> 适用于只有单个表达式的函数。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">int</span> multiply(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) =&gt; a * b;
</code></pre>
<h4 data-id="heading-9">3. 构造函数 (Constructors)</h4>
<p>Dart 提供了强大的构造函数语法，常在 Flutter Widget 中使用：</p>
<ul>
<li><strong>简化赋值：</strong> 直接在构造函数中为实例变量赋值。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  Person(<span class="hljs-keyword">this</span>.name); <span class="hljs-comment">// 简洁地将参数赋值给 name</span>
}
</code></pre>
<ul>
<li><strong>命名构造函数：</strong> 创建多个、有特定用途的构造函数。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">Person.fromJson(<span class="hljs-built_in">Map</span> data) {
<span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li><strong>工厂构造函数 (Factory):</strong> 用于复杂的对象创建逻辑（如单例模式或返回子类型）。</li>
</ul>
<h4 data-id="heading-10">4. 异步编程 (Asynchrony)</h4>
<p>Dart 使用 <code>Future</code> 和 <code>async/await</code> 处理异步操作（如网路请求）。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 声明函数是异步的</span>
Future&lt;<span class="hljs-built_in">String</span>&gt; fetchData() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 使用 await 等待结果，代码看起来像同步一样</span>
  <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> httpClient.<span class="hljs-keyword">get</span>(<span class="hljs-string">'...'</span>);
  <span class="hljs-keyword">return</span> response.body;
}
</code></pre>
<h3 data-id="heading-11">Flutter vs RN</h3>
<h3 data-id="heading-12">1. ⚛️ React Native (JS + Bridge + 原生元件)</h3>
<ul>
<li><strong>技术栈：</strong> JavaScript / TypeScript + React。</li>
<li><strong>工作原理：</strong> React Native 依赖于一个 <strong>Bridge（桥接器）</strong>，将 JavaScript 逻辑转换为原生操作。它使用 <strong>原生 UI 元件</strong>（如 Android 的 <code>TextView</code>，iOS 的 <code>UILabel</code>）进行渲染。</li>
<li><strong>优势：</strong> 能够提供完全的原生体验，因为它使用的就是平台自带的 UI 元素。可以充分利用现有的原生代码和生态。</li>
<li><strong>瓶颈：</strong> Bridge 的 <strong>JSON 序列化与异步传输</strong> 带来性能开销，尤其在高频度交互或动画时，容易造成卡顿。</li>
</ul>
<h3 data-id="heading-13">2. 🐦 Flutter (Dart + Skia 引擎 + 自绘元件)</h3>
<ul>
<li><strong>技术栈：</strong> Dart 语言。</li>
<li><strong>工作原理：</strong> Flutter 跳过了原生 UI 元件和 Bridge。它自带一个高效的 <strong>Skia 图形渲染引擎</strong>。应用程式启动时，Flutter 创建一个 Canvas（画布），然后在上面用 Dart 代码直接绘制 <strong>自定义的 Widget</strong>。</li>
<li><strong>优势：</strong> <strong>接近原生的性能</strong>，因为它被编译成 ARM 机器码。 UI 表现力强，因为它不依赖原生系统的 UI，实现了 <strong>像素级的控制</strong>。</li>
<li><strong>瓶颈：</strong> 文件体积较大，且没有使用平台原生的 UI 元素，在某些极度依赖原生系统风格的应用上可能显得突兀。</li>
</ul>
<hr/>
<h2 data-id="heading-14">二、选择决策矩阵：五个关键维度</h2>









































<table><thead><tr><th align="left">决策维度</th><th align="left">Flutter (Dart)</th><th align="left">React Native (JS/TS)</th><th align="left">选择建议</th></tr></thead><tbody><tr><td align="left"><strong>1. 团队现有技能</strong></td><td align="left">需要学习 <strong>Dart 语言</strong> 和 Flutter 框架的思维模式。</td><td align="left">技能门槛低，可以重用 <strong>React/Web 前端</strong> 团队的大部分经验。</td><td align="left"><strong>前端背景强</strong>：选 RN；<strong>无历史包袱或有原生背景</strong>：选 Flutter。</td></tr><tr><td align="left"><strong>2. 性能与 UI 复杂度</strong></td><td align="left">性能优异，因其编译为原生机器码，且自绘引擎消除了 Bridge 瓶颈。</td><td align="left">性能良好，但在复杂动画和高频交互上可能因 Bridge 而略输 Flutter。</td><td align="left"><strong>对性能要求极高、复杂动画</strong>：选 Flutter；<strong>标准业务应用</strong>：RN 足够。</td></tr><tr><td align="left"><strong>3. 生态系统与第三方库</strong></td><td align="left"><strong>较新</strong>，社群成长快，但第三方库的数量和成熟度不如 RN。</td><td align="left"><strong>极其庞大和成熟</strong>，大量库可供选择。与原生生态桥接成熟。</td><td align="left"><strong>依赖大量现有轮子</strong>：选 RN；<strong>愿意自建或 Bridge 原生代码</strong>：选 Flutter。</td></tr><tr><td align="left"><strong>4. 开发效率与热重载</strong></td><td align="left">优秀的 <strong>Hot Reload</strong>，但在 <strong>Native Code</strong> 变更时需重新编译。</td><td align="left">拥有 <strong>Fast Refresh</strong>，JS 代码更新极快。原生代码变更也需重新编译。</td><td align="left"><strong>基本持平</strong>；RN 在 JS 迭代上更胜一筹。</td></tr><tr><td align="left"><strong>5. 多平台支持</strong></td><td align="left"><strong>广泛：</strong> iOS, Android, Web, Desktop (Windows, macOS, Linux)。</td><td align="left"><strong>主流：</strong> iOS, Android；Web 需额外使用 React Native for Web。</td><td align="left"><strong>未来可能扩展到桌面端</strong>：选 Flutter；<strong>专注于移动端</strong>：RN 足够。</td></tr></tbody></table>
<p>滑到这里定然有所收获 ⛽️⛽️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从定时器到 Promise：一次 JS 异步编程的进阶之旅]]></title>    <link>https://juejin.cn/post/7571637614203633691</link>    <guid>https://juejin.cn/post/7571637614203633691</guid>    <pubDate>2025-11-12T11:08:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571637614203633691" data-draft-id="7571644531608469550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从定时器到 Promise：一次 JS 异步编程的进阶之旅"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-12T11:08:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="T___T"/> <meta itemprop="url" content="https://juejin.cn/user/1599155645973066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从定时器到 Promise：一次 JS 异步编程的进阶之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1599155645973066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    T___T
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:08:16.000Z" title="Wed Nov 12 2025 11:08:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 JavaScript 的过程中，我们经常会听到“<strong>JS 是单线程语言</strong>”、“<strong>异步操作</strong>”、“<strong>Promise 控制流程</strong>”等概念。它们听起来高深，但其实都是理解 JavaScript 运行机制的关键。本文将从最基础的同步与异步入手，逐步讲清楚 <strong>为什么需要异步</strong>、<strong>异步是如何执行的</strong>、以及 <strong>Promise 是如何让异步代码更优雅地运行的</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、JS 是单线程语言</h2>
<p>JavaScript 是一种<strong>单线程</strong>语言，也就是说，它在同一时刻只能执行一段代码。<br/>
举个简单的例子：</p>
<pre><code class="hljs language-arduino" lang="arduino">console.<span class="hljs-built_in">log</span>(<span class="hljs-number">1</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-number">2</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>);
</code></pre>
<p>运行结果非常直观：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span><span class="hljs-number">3</span>
</code></pre>
<p>JavaScript 会<strong>从上到下、逐行执行</strong>，这就是 <strong>同步执行</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、为什么需要异步？</h2>
<p>问题在于：当代码中出现“耗时操作”时，例如：</p>
<ul>
<li>读取文件（I/O 操作）</li>
<li>发送网络请求（fetch / ajax）</li>
<li>定时器（setTimeout）</li>
</ul>
<p>如果这些操作是同步的，那么 JS 会<strong>卡死等待结果</strong>，导致页面无法响应用户点击、滚动等操作。</p>
<p>于是，JavaScript 设计了“<strong>异步机制</strong>”：<br/>
耗时的任务不阻塞主线程，而是交给浏览器或 Node.js 的底层去处理，等任务完成后再通知 JS 主线程执行回调函数。</p>
<hr/>
<h2 data-id="heading-2">三、setTimeout：最经典的异步例子</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
}, <span class="hljs-number">1000</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>执行结果为：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span>
</code></pre>
<p>解释：</p>
<ol>
<li><code>console.log(1)</code> 立即执行。</li>
<li><code>setTimeout</code> 被识别为一个“异步任务”，交给 <strong>浏览器的定时器线程</strong> 去计时。</li>
<li>JS 主线程继续往下执行 <code>console.log(3)</code>。</li>
<li>当计时结束后，回调函数被放入 <strong>事件队列（Event Queue）</strong> 。</li>
<li>主线程空闲时通过 <strong>事件循环（Event Loop）</strong> 取出该回调并执行，于是打印 <code>2</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-3">四、事件循环（Event Loop）简要说明</h2>
<p>事件循环是浏览器或 Node.js 实现异步的核心机制。</p>
<ul>
<li>JS 主线程执行同步代码；</li>
<li>异步任务交给浏览器处理；</li>
<li>当异步任务完成后，其回调函数被放入“任务队列”；</li>
<li>一旦主线程空闲，事件循环会取出这些任务并执行。</li>
</ul>
<p>简单来说：</p>
<blockquote>
<p>同步 → 先执行<br/>
异步 → 等主线程空闲再执行</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">五、Promise：让异步更优雅</h2>
<p>在早期，异步常常通过**回调函数（callback）**实现，但当多个异步操作需要依次执行时，就会出现“<strong>回调地狱</strong>”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务1'</span>);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务2'</span>);
  }, <span class="hljs-number">1000</span>);
}, <span class="hljs-number">1000</span>);
</code></pre>
<p>可读性差、难以维护。<br/>
为了解决这个问题，ES6 引入了 <strong>Promise</strong>。</p>
<hr/>
<h2 data-id="heading-5">六、Promise 的基本使用</h2>
<p>看下面的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">resolve</span>();
  }, <span class="hljs-number">3000</span>);
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span><span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">4</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span>
</code></pre>
<p>分析执行顺序：</p>
<ol>
<li><code>console.log(1)</code>：同步执行。</li>
<li><code>new Promise(...)</code>：立即执行里面的函数（称为 <strong>executor</strong>），但其中的 <code>setTimeout</code> 是异步操作。</li>
<li><code>console.log(4)</code>：继续执行同步任务。</li>
<li>3 秒后，<code>setTimeout</code> 的回调执行，打印 <code>2</code>，同时调用 <code>resolve()</code>。</li>
<li><code>resolve()</code> 触发 <code>then</code> 方法中的回调，打印 <code>3</code>。</li>
</ol>
<p>可以看到，Promise 让异步代码的执行顺序更清晰，结构也更优雅。</p>
<hr/>
<h2 data-id="heading-6">七、结合 Node.js 的异步 I/O 示例</h2>
<p>在 Node.js 中，文件读取就是典型的异步操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 同步执行</span>
  fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./b.txt'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-title function_">reject</span>(err);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-title function_">resolve</span>(data.<span class="hljs-title function_">toString</span>());
  });
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data, <span class="hljs-string">'//////'</span>);
}).<span class="hljs-title function_">catch</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err, <span class="hljs-string">'读取文件失败'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
</code></pre>
<p>执行顺序：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-number">1</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">2</span> <span class="hljs-punctuation">-&gt;</span> &lt;文件内容&gt; <span class="hljs-comment">///////</span>
</code></pre>
<p>解释：</p>
<ul>
<li><code>fs.readFile</code> 是 Node 的异步 I/O 操作；</li>
<li>读取文件的任务被交给系统底层；</li>
<li>主线程不会等待；</li>
<li>当读取完成后，通过事件循环回到主线程执行 <code>.then()</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-7">八、fetch 与异步请求</h2>
<p>浏览器端的 <code>fetch</code> 也是基于 Promise 的异步操作。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>));
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>🧠<code>fetch()</code> 返回的是一个 Promise 对象。我们可以使用 <code>.then()</code> 来获取返回的数据：</p>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    document.getElementById('member').<span class="hljs-attr">innerHTML</span> =
      data.map(<span class="hljs-attr">item</span> =&gt; `&lt;li&gt;<span class="hljs-variable">${item.login}</span>&lt;/li&gt;`).join(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">九、总结</h2>






























<table><thead><tr><th>概念</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><strong>同步代码</strong></td><td>从上到下顺序执行</td><td><code>console.log()</code></td></tr><tr><td><strong>异步代码</strong></td><td>延后执行，不阻塞主线程</td><td><code>setTimeout</code>、<code>fetch</code>、<code>fs.readFile</code></td></tr><tr><td><strong>事件循环</strong></td><td>调度同步和异步任务</td><td>异步任务完成后放入任务队列等待执行</td></tr><tr><td><strong>Promise</strong></td><td>用于优雅地处理异步</td><td><code>.then()</code>、<code>.catch()</code></td></tr></tbody></table>
<blockquote>
<p>🧩<strong>一句话总结：</strong><br/>
JavaScript 虽然是单线程的，但通过事件循环和 Promise 等机制，实现了强大的异步能力，让我们能够同时处理多个任务，而不影响页面或程序的流畅运行。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉]]></title>    <link>https://juejin.cn/post/7571678763782258722</link>    <guid>https://juejin.cn/post/7571678763782258722</guid>    <pubDate>2025-11-13T01:53:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678763782258722" data-draft-id="7571702660933173263" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-13T01:53:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让Qwen-VL的检测能力像YOLO一样强，VLM-FO1如何打通大模型的视觉任督二脉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T01:53:33.000Z" title="Thu Nov 13 2025 01:53:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今多模态大模型（VLMs）飞速发展的时代，一个令人尴尬的问题依然存在：<strong>为什么这些能看懂图像、生成描述的模型，却难以精确地定位图像中的物体？</strong></p>
<p>答案在于一个根本性矛盾：让一个为语言生成而设计的模型，去输出精确的浮点数坐标，就像让一位诗人去做微积分——虽然都是处理“符号”，但思维方式截然不同。</p>
<h2 data-id="heading-0"><strong>坐标生成的困境</strong></h2>
<p>现有的多模态大模型在生成边界框时面临两大挑战：</p>
<ul>
<li><strong>格式敏感性：</strong> 一个坐标值的轻微偏差就可能导致整个检测框无效</li>
<li><strong>多实例处理困难：</strong> 长序列的坐标生成容易超出模型的注意力范围</li>
</ul>
<p>结果就是，即使在COCO这样的标准检测数据集上，顶尖的开源VLM模型召回率也不到40%，远低于专用检测器50-60%的水平。</p>
<h2 data-id="heading-1"><strong>VLM-FO1的突破</strong></h2>
<p>浙江大学与Om AI Research团队提出的VLM-FO1框架带来了全新的思路：与其让大模型艰难地生成坐标，不如让它直接理解区域内容。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65ae036ea023406eb4b2efbe03c5d8ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=27TiYCFvcdynPSN933hXx7aapo8%3D" alt="screenshot_2025-11-12_11-28-02.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>核心创新</strong></h2>
<ul>
<li><strong>即插即用的模块化设计</strong></li>
</ul>
<p>VLM-FO1不需要重新训练整个大模型，而是作为一个增强模块接入现有的预训练VLM。这意味着开发者可以快速为已有模型赋予检测能力，而不用担心破坏其原有的语言理解能力。</p>
<ul>
<li><strong>双视觉编码器架构</strong></li>
</ul>
<p>团队设计了混合细粒度区域编码器（HFRE），包含两个并行的视觉编码器：</p>
<p>主编码器：沿用原VLM的视觉编码器，提供丰富的语义信息</p>
<p>辅助编码器：采用高分辨率处理的DaViT模型，捕捉细节特征</p>
<p>两者特征融合后，形成了既懂“是什么”又知“在哪里”的区域表示。</p>
<ul>
<li><strong>两阶段训练策略</strong></li>
</ul>
<p>阶段一：只训练新添加的模块，学习将区域特征映射到语言空间</p>
<p>阶段二：开放更多参数进行指令微调，全面提升感知能力</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f29f5f7c52314202818c6e8ef262b915~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=8laX5C0uUAZBfQc9tQ4xcTEnmX4%3D" alt="screenshot_2025-11-12_11-26-41.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>性能表现：小模型的大能量</strong></h2>
<p>在多项基准测试中，VLM-FO1展现出了令人印象深刻的性能：</p>
<ul>
<li><strong>目标定位能力显著提升</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0997010f19be4c958dfcc4b4b2a36dcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=mBuDkUfK1u6Oj%2F0aIrf4cOQsgzw%3D" alt="screenshot_2025-11-12_11-30-08.png" loading="lazy"/></p>
<p>在COCO目标检测任务上，仅3B参数的VLM-FO1达到了44.4 mAP，比同类VLM方法提升超过20个点，甚至超越了部分专用检测器。</p>
<p>特别是在包含困难负样本的OVDEval数据集上，VLM-FO1的43.7 mAP显著高于Grounding DINO等专业模型，证明其能有效利用大模型的世界知识进行推理。</p>
<ul>
<li><strong>区域理解全面领先</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50be8eb2999e4d318cf8ea69b84dd313~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=RZYbOIt2J2quS%2BDN5V4vqoVHnAI%3D" alt="screenshot_2025-11-12_11-31-20.png" loading="lazy"/></p>
<p>区域分类：在LVIS数据集上达到92.4% 的语义相似度</p>
<p>区域OCR：在COCO文本上以59.0% 的准确率大幅领先</p>
<p>指代表达理解：在Ferret Bench上以80.1分刷新纪录</p>
<ul>
<li><strong>复杂推理表现出色</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc1649f46b14145a29f56dbd1f8efc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=vwMBkM7B%2B%2FIu3TQeXXpn7NP%2FJxE%3D" alt="screenshot_2025-11-12_11-31-32.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c2036b4bab6426082c5cd70c8868d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=72kVjOhWj1kX0DHe74SkcyC%2Bw1E%3D" alt="screenshot_2025-11-12_11-31-40.png" loading="lazy"/></p>
<p>在需要结合语言理解和视觉定位的指代表达理解任务中，VLM-FO1在多个数据集上保持领先。在对象计数任务中，其“先检测再计数”的策略在PixMo-Count上达到86.0% 的准确率，超越了众多参数量大得多的模型。</p>
<ul>
<li><strong>不影响原有能力：真正的“增强”而非“替换”</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/745f4d395f604c44a0afcd8665daa367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=Krm64cVsMnA1fSbUDepKaWDHMoA%3D" alt="screenshot_2025-11-12_11-31-47.png" loading="lazy"/></p>
<p>最令人惊喜的是，VLM-FO1在增强细粒度感知的同时，完全保留了基础模型的通用视觉理解能力。在OpenCompass综合评测中，VLM-FO1-3B与原始Qwen2.5-VL-3B的表现基本持平，证明其没有出现灾难性遗忘。</p>
<h2 data-id="heading-4"><strong>实际应用展示</strong></h2>
<p>论文中展示了丰富的可视化结果，包括：</p>
<ul>
<li><strong>目标检测：</strong> 准确框出人物、笔记本电脑等物体</li>
<li><strong>指代表达理解：</strong> 根据语言描述定位特定对象</li>
<li><strong>对象计数：</strong> 复杂场景下的数量统计</li>
<li><strong>区域描述：</strong> 针对特定区域生成详细描述</li>
<li><strong>视觉推理：</strong> 结合逻辑推理的区域分析</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7958de31e7224590b487a59c5ccb4174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=BMbPgrxAUVFiu8CZ4rJjQzw%2Ft3g%3D" alt="screenshot_2025-11-12_11-32-23.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b513f6bf304cef9469f683fd994040~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=YcWxza3Hl%2FQW5LZXTYefyIzGihY%3D" alt="screenshot_2025-11-12_11-32-31.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eea2e74b6134450ad3459935266ab92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=24LQ%2FOYh7TnJm2R8Y4YrIW201KM%3D" alt="screenshot_2025-11-12_11-32-38.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc638ac3f22464ab67da8f192d2919d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=bqUrMwtDF9bjnZA3HOPB1DhyS2M%3D" alt="screenshot_2025-11-12_11-33-46.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/743a48113571463fb706f6a43aa633b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763603613&amp;x-signature=od4RRrG%2F38ufKpyLRp3PxJI1gHI%3D" alt="screenshot_2025-11-12_11-52-58.png" loading="lazy"/></p>
<p>特别是在复杂推理任务中，模型能够展示出清晰的思维链条，如通过排除法找到“没有打领带的人”，逐步推理定位“盛放黑色甜甜圈的盘子”。</p>
<h2 data-id="heading-5"><strong>技术启示</strong></h2>
<p>VLM-FO1的成功为多模态大模型的发展提供了重要启示：</p>
<ul>
<li><strong>扬长避短</strong></li>
</ul>
<p>不强求大模型完成所有任务，而是将其核心的语言理解和推理能力与专门的视觉处理模块相结合。</p>
<ul>
<li><strong>模块化设计</strong></li>
</ul>
<p>通过即插即用的方式增强模型能力，避免每次升级都要推倒重来。</p>
<ul>
<li><strong>训练策略创新</strong></li>
</ul>
<p>分阶段、有针对性的训练策略能够在引入新能力的同时保护已有知识。</p>
<h2 data-id="heading-6"><strong>结语</strong></h2>
<p>VLM-FO1架起了一座桥梁，连接了大模型的高层推理能力与细粒度视觉感知需求。这种“理解内容而非生成坐标”的范式转变，不仅解决了当前VLM在定位任务上的瓶颈，更为构建真正理解视觉世界的多模态模型指明了方向。</p>
<p>随着这种技术的成熟，我们离能够真正“看懂”图像、在像素世界中自由“对话”的AI助手又近了一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析]]></title>    <link>https://juejin.cn/post/7571650164843773986</link>    <guid>https://juejin.cn/post/7571650164843773986</guid>    <pubDate>2025-11-12T11:11:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843773986" data-draft-id="7571559178743365667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T11:11:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叁木Meow"/> <meta itemprop="url" content="https://juejin.cn/user/231371762837604"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue scoped CSS 与 Element Plus Drawer 样式失效问题深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/231371762837604/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叁木Meow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:11:01.000Z" title="Wed Nov 12 2025 11:11:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题概述</h2>
<p>在使用 Vue 3 + Element Plus 开发组件库时，我们遇到了一个棘手的样式问题：当将 <code>el-drawer</code> 组件抽离到子组件中，并且 <code>el-drawer</code> 直接作为子组件 <code>template</code> 的根元素时，<code>scoped</code> 样式无法正确应用到 drawer 上。然而，当在 <code>el-drawer</code> 外层包装一个 <code>div</code> 容器后，样式又能够正常工作。</p>
<p>这个问题不仅影响了我们的组件抽离工作，也暴露了对 Vue scoped CSS 和 Element Plus 组件内部机制理解的不足。</p>
<h2 data-id="heading-1">问题现象</h2>
<h3 data-id="heading-2">场景一：样式失效的实现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- problematic-drawer.vue --&gt;
&lt;template&gt;
  &lt;!-- el-drawer 直接作为 template 根元素 --&gt;
  &lt;el-drawer
    :model-value="drawerVisible"
    direction="btt"
    size="300px"
    title="子组件抽屉 - 样式失效"
    @update:model-value="$emit('update:drawerVisible', $event)"
  &gt;
    &lt;div class="drawer-content"&gt;
      这个抽屉的样式无法生效！
    &lt;/div&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* 这些样式不会生效 */
:deep(.el-drawer) {
  border-top-left-radius: 20px !important;
  border-top-right-radius: 20px !important;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
}

:deep(.el-drawer__header) {
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3) !important;
}

:deep(.el-drawer__body) {
  color: white !important;
  font-size: 16px !important;
}
&lt;/style&gt;
</code></pre>
<p><img src="https://img.sanmu7.com/sanmu/20251112/article-content/d16b48fe-9f7d-4dcd-b82f-b7f46fd656d2.png" alt="1762929206541.png" loading="lazy"/></p>
<h3 data-id="heading-3">场景二：样式正常的实现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- fixed-drawer.vue --&gt;
&lt;template&gt;
  &lt;!-- el-drawer 被 div 包装 --&gt;
  &lt;div class="drawer-container"&gt;
    &lt;el-drawer
      :model-value="drawerVisible"
      direction="btt"
      size="300px"
      title="修复后的子组件抽屉 - 样式正常"
      @update:model-value="$emit('update:drawerVisible', $event)"
    &gt;
      &lt;div class="drawer-content"&gt;
        现在样式可以正常工作了！
      &lt;/div&gt;
    &lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* 这些样式现在可以正常工作 */
.drawer-container :deep(.el-drawer) {
  border-top-left-radius: 20px !important;
  border-top-right-radius: 20px !important;
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

.drawer-container :deep(.el-drawer__header) {
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3) !important;
}

.drawer-container :deep(.el-drawer__body) {
  color: white !important;
  font-size: 16px !important;
}
&lt;/style&gt;
</code></pre>
<p><img src="https://img.sanmu7.com/sanmu/20251112/article-content/1a162eb3-ad7b-4ffb-8c6b-df5874d1bad3.png" alt="1762929256553.png" loading="lazy"/></p>
<h2 data-id="heading-4">技术原理解析</h2>
<h3 data-id="heading-5">Vue scoped CSS 的工作机制</h3>
<p>Vue 的 scoped CSS 通过以下两个步骤实现样式隔离：</p>
<ol>
<li><strong>属性注入</strong>：Vue 编译器会给组件模板中的每个元素添加唯一的 <code>data-v-*</code> 属性</li>
<li><strong>选择器重写</strong>：将 CSS 选择器重写为包含对应 <code>data-v-*</code> 属性的选择器</li>
</ol>
<p>例如，对于下面的模板和样式：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="container"&gt;Hello&lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.container { color: red; }
&lt;/style&gt;
</code></pre>
<p>Vue 编译后会变成：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span> <span class="hljs-attr">data-v-xxxxxxx</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span><span class="hljs-selector-attr">[data-v-xxxxxxx]</span> { <span class="hljs-attribute">color</span>: red; }
</code></pre>
<h3 data-id="heading-6">Element Plus Drawer 的内部机制</h3>
<p>Element Plus 的 <code>el-drawer</code> 组件内部结构较为复杂，它会：</p>
<ol>
<li>创建多个内部 DOM 元素（如 <code>.el-drawer__header</code>、<code>.el-drawer__body</code> 等）</li>
<li>这些内部元素是由组件动态生成的，不会继承父组件的 <code>data-v-*</code> 属性</li>
</ol>
<h3 data-id="heading-7">问题根源分析</h3>
<h4 data-id="heading-8">场景一的问题</h4>
<p>当 <code>el-drawer</code> 直接作为子组件的根元素时：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer&gt;...&lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style scoped&gt;
:deep(.el-drawer) { /* 样式 */ }
&lt;/style&gt;
</code></pre>
<p>编译后的结果：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-drawer</span> <span class="hljs-attr">data-v-xxxxxxx</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">el-drawer</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-xxxxxxx]</span> <span class="hljs-selector-class">.el-drawer</span> { <span class="hljs-comment">/* 样式 */</span> }
</code></pre>
<p><strong>问题在于</strong>：虽然 <code>el-drawer</code> 元素本身有 <code>data-v-xxxxxxx</code> 属性，但 Element Plus 在其内部创建的 <code>.el-drawer__header</code>、<code>.el-drawer__body</code> 等元素<strong>没有这个属性</strong>，导致选择器 <code>[data-v-xxxxxxx] .el-drawer__header</code> 无法匹配到目标元素。</p>
<h4 data-id="heading-9">场景二的解决方案</h4>
<p>当使用 <code>div</code> 包装 <code>el-drawer</code> 时：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="drawer-container"&gt;
    &lt;el-drawer&gt;...&lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.drawer-container :deep(.el-drawer) { /* 样式 */ }
&lt;/style&gt;
</code></pre>
<p>编译后的结果：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"drawer-container"</span> <span class="hljs-attr">data-v-yyyyyyy</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-drawer</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">el-drawer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-yyyyyyy]</span> <span class="hljs-selector-class">.drawer-container</span> <span class="hljs-selector-class">.el-drawer</span> { <span class="hljs-comment">/* 样式 */</span> }
</code></pre>
<p><strong>为什么能成功</strong>：</p>
<ol>
<li><strong>正确的属性承载</strong>：外层 <code>div</code> 容器获得了 <code>data-v-yyyyyyy</code> 属性</li>
<li><strong>更高的 CSS 特异性</strong>：选择器 <code>[data-v-yyyyyyy] .drawer-container .el-drawer</code> 具有更高的特异性</li>
<li><strong>样式继承和覆盖</strong>：更高特异性的选择器能够成功覆盖 Element Plus 的默认样式</li>
</ol>
<h2 data-id="heading-10">解决方案</h2>
<h3 data-id="heading-11">方案一：容器包装法（推荐）</h3>
<p>这是最简单有效的解决方案：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="drawer-wrapper"&gt;
    &lt;el-drawer
      v-model="visible"
      title="抽屉标题"
    &gt;
      &lt;!-- 抽屉内容 --&gt;
    &lt;/el-drawer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.drawer-wrapper :deep(.el-drawer) {
  /* 自定义样式 */
  border-radius: 8px;
}

.drawer-wrapper :deep(.el-drawer__header) {
  background: #f0f0f0;
}

.drawer-wrapper :deep(.el-drawer__body) {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-12">方案二：全局样式法</h3>
<p>如果组件需要在多个地方复用，可以考虑使用全局样式：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer
    v-model="visible"
    class="custom-drawer"
    title="抽屉标题"
  &gt;
    &lt;!-- 抽屉内容 --&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style&gt;
/* 注意：这里没有 scoped */
.custom-drawer {
  border-radius: 8px;
}

.custom-drawer .el-drawer__header {
  background: #f0f0f0;
}

.custom-drawer .el-drawer__body {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-13">方案三：CSS Modules 方案</h3>
<p>使用 CSS Modules 可以避免样式冲突：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-drawer
    v-model="visible"
    :class="$style.customDrawer"
    title="抽屉标题"
  &gt;
    &lt;!-- 抽屉内容 --&gt;
  &lt;/el-drawer&gt;
&lt;/template&gt;

&lt;style module&gt;
.customDrawer {
  border-radius: 8px;
}

.customDrawer :global(.el-drawer__header) {
  background: #f0f0f0;
}

.customDrawer :global(.el-drawer__body) {
  padding: 20px;
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-14">最佳实践建议</h2>
<h3 data-id="heading-15">1. 组件结构设计原则</h3>
<ul>
<li><strong>避免直接暴露第三方组件</strong>：尽量用容器元素包装第三方组件</li>
<li><strong>保持组件层级清晰</strong>：每个组件都应该有明确的根容器</li>
<li><strong>考虑样式复用性</strong>：设计时考虑样式是否需要在多个地方复用</li>
</ul>
<h3 data-id="heading-16">2. scoped CSS 使用技巧</h3>
<ul>
<li><strong>合理使用 <code>:deep()</code></strong>：只在必要时使用深度选择器</li>
<li><strong>选择器特异性平衡</strong>：避免过度依赖 <code>!important</code></li>
<li><strong>样式隔离优先</strong>：优先使用 scoped 样式，必要时才使用全局样式</li>
</ul>
<h3 data-id="heading-17">3. 第三方组件集成策略</h3>
<ul>
<li><strong>了解组件内部机制</strong>：使用前了解第三方组件的 DOM 结构</li>
<li><strong>建立组件包装层</strong>：为第三方组件创建包装组件</li>
<li><strong>文档化样式定制</strong>：记录样式定制的最佳实践</li>
</ul>
<h3 data-id="heading-18">4. 开发调试技巧</h3>
<ul>
<li><strong>使用浏览器开发者工具</strong>：检查实际的 DOM 结构和 CSS 选择器</li>
<li><strong>关注编译后的代码</strong>：了解 Vue 编译器如何处理 scoped CSS</li>
<li><strong>建立样式测试</strong>：为关键样式建立测试用例</li>
</ul>
<h2 data-id="heading-19">总结</h2>
<p>Vue scoped CSS 与 Element Plus Drawer 的样式问题，本质上是由 Vue 的样式隔离机制与第三方组件的内部实现之间的冲突造成的。通过添加容器元素，我们为 scoped CSS 提供了正确的属性承载上下文，从而解决了样式匹配问题。</p>
<p>这个问题的解决过程告诉我们：</p>
<ol>
<li><strong>理解底层机制很重要</strong>：深入了解 Vue 和第三方组件的工作原理</li>
<li><strong>简单的解决方案往往有效</strong>：添加容器元素是最简单有效的解决方案</li>
<li><strong>设计时需要考虑扩展性</strong>：良好的组件设计可以避免后续的样式问题</li>
<li><strong>文档化经验很重要</strong>：将遇到的问题和解决方案记录下来，避免重复踩坑</li>
</ol>
<p>希望这篇文章能够帮助开发者更好地理解 Vue scoped CSS 的工作机制，并在实际开发中避免类似的样式问题。</p>
<h2 data-id="heading-20">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fapi%2Fsfc-css-features.html%23scoped-css" target="_blank" title="https://vuejs.org/api/sfc-css-features.html#scoped-css" ref="nofollow noopener noreferrer">Vue 3 官方文档 - Scoped CSS</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2F" target="_blank" title="https://element-plus.org/" ref="nofollow noopener noreferrer">Element Plus 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FSpecificity" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Specificity" ref="nofollow noopener noreferrer">CSS 特异性计算规则</a></li>
</ul>
<hr/>
<p><em>本文基于实际项目中的问题总结而成，如有不当之处，欢迎指正和讨论。</em></p>
<p>文章最后，给大家介绍一下个人博客网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsanmu7.com%2F" target="_blank" title="https://sanmu7.com/" ref="nofollow noopener noreferrer">叁木の小屋</a>。欢迎各位捧场。笔芯❤。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 数组：从内存布局到遍历策略的深度解析]]></title>    <link>https://juejin.cn/post/7571648135585169451</link>    <guid>https://juejin.cn/post/7571648135585169451</guid>    <pubDate>2025-11-12T11:59:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571648135585169451" data-draft-id="7571648135585136683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 数组：从内存布局到遍历策略的深度解析"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T11:59:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 数组：从内存布局到遍历策略的深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:59:16.000Z" title="Wed Nov 12 2025 11:59:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：数组为何“开箱即用”？</h2>
<p>在 JavaScript 开发中，数组（Array）是最常用、最直观的数据结构。我们几乎每天都在写 <code>const arr = [1, 2, 3]</code>，却很少思考：这个看似简单的结构背后，究竟隐藏着怎样的内存机制与性能权衡？为什么说数组是“开箱即用”的数据结构？它与链表相比有何优劣？不同的遍历方式又如何影响程序效率？</p>
<p>本文将从<strong>内存分配、动态扩容、遍历方法</strong>三个维度，深入剖析 JavaScript 数组的本质，并结合实际代码，揭示高效使用数组的最佳实践。</p>
<hr/>
<h2 data-id="heading-1">一、数组的内存模型：栈与堆的协作</h2>
<h3 data-id="heading-2">1.1 引用类型 vs 值类型</h3>
<p>在 JavaScript 中，数组属于<strong>引用类型</strong>。当我们声明：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>
</code></pre>
<p>实际上发生了两件事：</p>
<ul>
<li><strong>栈内存</strong>中存储变量 <code>arr</code>，其值是一个<strong>指向堆内存的引用地址</strong></li>
<li><strong>堆内存</strong>中分配一块连续空间，存放 <code>[1, 2, 3]</code> 的实际数据</li>
</ul>
<p>这种设计使得多个变量可以共享同一数组（通过引用），也解释了为何修改一个引用会影响所有指向它的变量。</p>
<h3 data-id="heading-3">1.2 数组的创建方式与初始化</h3>
<p>JS 提供多种创建数组的方式，但效果截然不同：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];               <span class="hljs-comment">// 字面量：元素和长度均确定</span>
<span class="hljs-keyword">const</span> arr2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>);            <span class="hljs-comment">// 长度为3，但内容为 empty（稀疏数组）</span>
<span class="hljs-keyword">const</span> arr3 = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">3</span>)).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 长度为3，每个元素初始化为0</span>
</code></pre>
<p>特别注意：<code>new Array(3)</code> 创建的是一个<strong>稀疏数组（sparse array）</strong> ，其内部并未真正分配三个值为 <code>undefined</code> 的槽位，而是仅记录长度。这在某些遍历方法（如 <code>forEach</code>）中会导致跳过这些“空洞”。</p>
<p>而 <code>fill(0)</code> 则确保每个位置都被显式赋值，避免意外行为。</p>
<hr/>
<h2 data-id="heading-4">二、动态扩容：便利背后的代价</h2>
<h3 data-id="heading-5">2.1 连续内存的优势与局限</h3>
<p>数组的核心优势在于<strong>连续内存布局</strong>，这使得通过索引访问元素的时间复杂度为 <strong>O(1)</strong> ——无论数组多大，<code>arr[1000]</code> 都能瞬间定位。</p>
<p>然而，连续性也带来了挑战：<strong>当数组容量不足时，必须扩容</strong>。</p>
<p>JavaScript 引擎（如 V8）采用以下策略：</p>
<ol>
<li>申请一块更大的连续内存（通常按倍数增长，如 1.5 倍）</li>
<li>将原数组所有元素<strong>逐个复制</strong>到新内存</li>
<li>释放旧内存</li>
</ol>
<p>这个过程称为“<strong>搬家</strong>”，虽然对开发者透明，但<strong>开销较大</strong>——尤其在频繁 push 大量元素时。</p>
<h3 data-id="heading-6">2.2 数组 vs 链表：动态性的权衡</h3>
<p>笔记中提到：“考虑动态性时，数组比链表差”。这是因为在链表中：</p>
<ul>
<li>插入/删除只需修改指针，无需移动数据</li>
<li>内存可离散分布，无扩容压力</li>
</ul>
<p>但链表也有致命缺点：</p>
<ul>
<li>访问任意元素需从头遍历，时间复杂度 O(n)</li>
<li>每个节点需额外存储指针，内存开销更大</li>
</ul>
<p>因此，在<strong>数据量较小、读多写少</strong>的场景下，数组凭借其缓存友好性和快速随机访问，仍是更优选择。</p>
<blockquote>
<p>正如笔记所言：“少数数据的情况下，数组是更加优秀的。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">三、遍历策略：性能与可读性的平衡</h2>
<p>JavaScript 提供多种数组遍历方式，各有适用场景：</p>
<h3 data-id="heading-8">3.1 计数循环（for）</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">len</span> = arr.length<span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {</span>
    console.log(arr<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>性能最佳：无函数调用开销，CPU 友好</li>
<li>支持 <code>break</code> 和 <code>continue</code></li>
</ul>
<p><strong>注意</strong>：应缓存 <code>arr.length</code>，避免每次循环都访问对象属性（虽现代引擎已优化，但仍是良好习惯）。</p>
<h3 data-id="heading-9">3.2 for...of</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>可读性强：直接获取元素值，无需索引</li>
<li>支持 <code>break</code>/<code>continue</code></li>
<li>兼容所有可迭代对象（包括字符串、Set 等）</li>
</ul>
<p><strong>适用场景</strong>：只需元素值，不关心索引时。</p>
<h3 data-id="heading-10">3.3 forEach</h3>
<pre><code class="hljs language-javascript" lang="javascript">arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item, index);
});
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>语义清晰：明确表达“对每个元素执行操作”</li>
<li>自动处理稀疏数组（跳过 empty slots）</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>无法使用 <code>break</code> 或 <code>continue</code></strong>（会报错）</li>
<li>函数调用带来额外开销（入栈/出栈）</li>
<li>性能低于 for 循环</li>
</ul>
<blockquote>
<p>因此，<strong>性能敏感场景应避免 forEach</strong>。</p>
</blockquote>
<h3 data-id="heading-11">3.4 for...in 的陷阱</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> arr) {
    console.log(<span class="hljs-keyword">key</span>, arr[<span class="hljs-keyword">key</span>]);
}
</code></pre>
<p>虽然数组是对象，<code>for...in</code> 能遍历其索引，但存在严重问题：</p>
<ul>
<li>遍历的是<strong>所有可枚举属性</strong>，包括原型链上的（若未正确设置）</li>
<li>索引以<strong>字符串形式</strong>返回（"0", "1"）</li>
<li>不保证顺序（尽管现代引擎通常按索引顺序）</li>
</ul>
<p><strong>强烈建议</strong>：遍历数组时不要使用 <code>for...in</code>。</p>
<hr/>
<h2 data-id="heading-12">四、实战建议：如何高效使用数组？</h2>
<h3 data-id="heading-13">4.1 初始化时预估容量</h3>
<p>若已知数组大致大小，可预先分配：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = new Array(expectedSize).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>减少后续扩容次数。</p>
<h3 data-id="heading-14">4.2 选择合适的遍历方式</h3>

























<table><thead><tr><th>需求</th><th>推荐方法</th></tr></thead><tbody><tr><td>最高性能</td><td><code>for (let i=0; i&lt;len; i++)</code></td></tr><tr><td>只需元素值</td><td><code>for...of</code></td></tr><tr><td>函数式风格</td><td><code>map</code>, <code>filter</code>（但注意性能）</td></tr><tr><td>避免</td><td><code>forEach</code>（需中断时）、<code>for...in</code></td></tr></tbody></table>
<h3 data-id="heading-15">4.3 理解 map 与 forEach 的区别</h3>
<ul>
<li><code>forEach</code>：仅遍历，无返回值</li>
<li><code>map</code>：遍历并<strong>返回新数组</strong>，用于数据转换</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> doubled = arr.<span class="hljs-built_in">map</span>(x =&gt; x * <span class="hljs-number">2</span>); <span class="hljs-comment">// [2,4,6,...]</span>
</code></pre>
<p>不要为了遍历而滥用 <code>map</code>——若不需要新数组，用 <code>forEach</code> 或 <code>for...of</code> 更合适。</p>
<hr/>
<h2 data-id="heading-16">结语：理解底层，方能驾驭上层</h2>
<p>JavaScript 数组的“简单”是精心设计的结果。它在连续内存、动态扩容、丰富 API 之间取得了精妙平衡，成为开发者最信赖的工具之一。</p>
<blockquote>
<p>“开箱即用”不等于“无需思考”。<br/>
对数据结构的敬畏，是写出高效、可靠代码的第一步。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 定位系统全解析：从文档流到 sticky 的实战指南]]></title>    <link>https://juejin.cn/post/7571693273728040996</link>    <guid>https://juejin.cn/post/7571693273728040996</guid>    <pubDate>2025-11-12T12:23:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571693273728040996" data-draft-id="7571657746346131510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 定位系统全解析：从文档流到 sticky 的实战指南"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-12T12:23:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 定位系统全解析：从文档流到 sticky 的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:23:59.000Z" title="Wed Nov 12 2025 12:23:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：布局的基石——理解“文档流”</h2>
<p>在前端开发中，页面元素如何排列？为何有的元素会“漂浮”起来，而有的始终按顺序堆叠？这一切的答案，都藏在一个核心概念中——<strong>文档流（Document Flow）</strong> 。</p>
<p>文档流是 HTML 元素在页面中的默认布局方式：块级元素垂直排列，行内元素水平排列，整体遵循“从上到下、从左到右”的自然顺序。每个元素默认采用 <strong><code>position: static</code></strong>（静态定位），乖乖待在自己的位置上，既不影响别人，也不被别人影响。</p>
<p>然而，一旦我们引入 CSS 定位（<code>position</code>），元素就可能<strong>离开或部分脱离文档流</strong>，从而实现复杂布局。本文将结合代码实例，深入剖析 <code>relative</code>、<code>absolute</code>、<code>fixed</code>、<code>sticky</code> 四种定位方式的本质区别、使用场景与常见陷阱。</p>
<hr/>
<h2 data-id="heading-1">一、relative：相对定位，不离不弃</h2>
<h3 data-id="heading-2">1.1 行为特征</h3>
<p><code>position: relative</code> 是最温和的定位方式。它让元素<strong>相对于自身原始位置进行偏移</strong>，但关键在于：<strong>它仍然占据文档流中的原始空间</strong>。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 1.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span> <span class="hljs-comment">&lt;!-- pink, 500x500 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- skyblue --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- green --&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<p>效果：</p>
<ul>
<li><code>.parent</code> 视觉上向右下移动了 100px</li>
<li>但 <code>.box</code>（绿色方块）依然紧贴在 <code>.parent</code> <strong>原始位置的下方</strong>，仿佛 <code>.parent</code> 没动过</li>
</ul>
<p>这说明：<strong>relative 不脱离文档流</strong>，后续元素仍按标准流对待它。</p>
<h3 data-id="heading-3">1.2 实战价值</h3>
<ul>
<li>作为 <code>absolute</code> 子元素的<strong>定位上下文容器</strong></li>
<li>微调元素位置而不破坏整体布局</li>
<li>配合 <code>z-index</code> 控制层叠顺序</li>
</ul>
<blockquote>
<p>笔记提醒：“用 <code>static</code> 可取消元素的定位属性”——这在动态切换布局时非常有用（如 1.html 中 5 秒后恢复 static）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、absolute：绝对定位，彻底脱离</h2>
<h3 data-id="heading-5">2.1 脱离文档流</h3>
<p><code>position: absolute</code> 会让元素<strong>完全脱离文档流</strong>。这意味着：</p>
<ul>
<li>原始位置不再被占据</li>
<li>后续元素会“无视”它，直接填补其空缺</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 2.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-comment">&lt;!-- absolute --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>123<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>456<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><code>.child</code> 使用 <code>absolute</code> 后，<code>&lt;div&gt;123&lt;/div&gt;</code> 和 <code>&lt;div&gt;456&lt;/div&gt;</code> 的排布不受其影响。</p>
<h3 data-id="heading-6">2.2 定位参考点：寻找“最近的定位祖先”</h3>
<p>绝对定位的元素不会凭空定位，它需要一个<strong>参考坐标系</strong>。规则如下：</p>
<ol>
<li>向上查找父元素，寻找第一个 <code>position</code> <strong>不为 <code>static</code></strong> 的祖先</li>
<li>若找到，则以该祖先的<strong>边框盒（border box）</strong> 为参考</li>
<li>若未找到，则以 <code>&lt;body&gt;</code> 为参考</li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">position</span>: relative; } <span class="hljs-comment">/* 成为 .child 的定位上下文 */</span>
<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 相对于 .parent 内部偏移 */</span>
}
</code></pre>
<p>若 <code>.parent</code> 没有设置 <code>position: relative</code>，<code>.child</code> 将相对于整个页面定位。</p>
<h3 data-id="heading-7">2.3 经典应用：居中技巧</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p>这是实现<strong>绝对居中</strong>的黄金组合：先移到中心点，再用 <code>transform</code> 反向偏移自身一半尺寸。</p>
<hr/>
<h2 data-id="heading-8">三、fixed：固定定位，锁定视口</h2>
<h3 data-id="heading-9">3.1 以浏览器窗口为基准</h3>
<p><code>position: fixed</code> 是 <code>absolute</code> 的“特殊版本”——它的参考点永远是<strong>浏览器视口（viewport）</strong> ，而非任何父元素。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 3.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: fixed; right: 100px; bottom: 100px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>无论页面如何滚动，该元素始终固定在距离右下角 100px 的位置。</p>
<h3 data-id="heading-10">3.2 完全脱离文档流</h3>
<p>和 <code>absolute</code> 一样，<code>fixed</code> 元素：</p>
<ul>
<li>不占据原始空间</li>
<li>后续元素会忽略它</li>
<li>可能覆盖其他内容（需注意 <code>z-index</code>）</li>
</ul>
<blockquote>
<p>注意：在移动端，某些浏览器对 <code>fixed</code> 支持不佳（尤其在软键盘弹出时），需谨慎使用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">四、sticky：智能粘连，动静结合</h2>
<h3 data-id="heading-12">4.1 hybrid 定位：relative + fixed</h3>
<p><code>position: sticky</code> 是 CSS 最具智慧的定位方式。它表现为：</p>
<ul>
<li><strong>默认行为像 <code>relative</code></strong>：在文档流中正常占位</li>
<li><strong>当滚动到阈值时，行为像 <code>fixed</code></strong>：固定在视口某处</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 4.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: sticky; top: 100px;"</span>&gt;</span>hello world<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>效果：</p>
<ul>
<li>页面未滚动时，<code>.box</code> 在正常位置</li>
<li>当其<strong>顶部距离视口顶部 ≤ 100px</strong> 时，自动变为 <code>fixed</code>，吸附在 <code>top: 100px</code> 处</li>
<li>向上滚动回原位置时，又恢复为 <code>relative</code></li>
</ul>
<h3 data-id="heading-13">4.2 必须指定阈值</h3>
<p><code>sticky</code> 必须配合 <code>top</code>/<code>bottom</code>/<code>left</code>/<code>right</code> 使用，否则无效。最常见的是 <code>top</code>（用于表头、导航栏固定）。</p>
<h3 data-id="heading-14">4.3 父容器限制</h3>
<p><code>sticky</code> 元素的“固定范围”受其<strong>最近的具有 overflow 非 visible 的祖先</strong>限制。若父容器高度不足，可能无法 sticky 到预期位置。</p>
<hr/>
<h2 data-id="heading-15">五、对比总结：何时使用哪种定位？</h2>









































<table><thead><tr><th>定位类型</th><th>是否脱离文档流</th><th>参考点</th><th>典型用途</th></tr></thead><tbody><tr><td><code>static</code></td><td>否</td><td>—</td><td>默认状态，取消定位</td></tr><tr><td><code>relative</code></td><td>否</td><td>自身原始位置</td><td>微调位置，作为 absolute 容器</td></tr><tr><td><code>absolute</code></td><td>是</td><td>最近的非 static 祖先</td><td>弹窗、tooltip、脱离流的装饰元素</td></tr><tr><td><code>fixed</code></td><td>是</td><td>浏览器视口</td><td>导航栏、返回顶部按钮</td></tr><tr><td><code>sticky</code></td><td><strong>部分</strong></td><td>视口（滚动时）</td><td>表头固定、侧边目录</td></tr></tbody></table>
<blockquote>
<p>特别注意：<code>display: none</code> 与定位无关——它直接<strong>移除元素</strong>，不占空间；而 <code>opacity: 0</code> 仅隐藏视觉，仍占空间（如 2.html 所示）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">六、避坑指南：常见误区</h2>
<ol>
<li><strong>误以为 relative 会腾出空间</strong><br/>
→ 错！它只是“视觉偏移”，原始位置仍被占据。</li>
<li><strong>absolute 元素找不到定位祖先</strong><br/>
→ 结果会相对于 body 定位，导致布局错乱。务必检查父容器是否设置了 <code>position: relative/absolute/fixed</code>。</li>
<li><strong>sticky 不生效</strong><br/>
→ 检查是否设置了 <code>top</code> 等阈值；检查父容器是否有 <code>overflow: hidden</code> 限制。</li>
<li><strong>滥用 fixed 导致移动端体验差</strong><br/>
→ 在 iOS Safari 等环境中，fixed 元素可能在输入框聚焦时错位。</li>
</ol>
<hr/>
<h2 data-id="heading-17">结语：定位是布局的灵魂</h2>
<p>CSS 定位系统看似简单，实则蕴含精妙的设计哲学。<code>relative</code> 的克制、<code>absolute</code> 的自由、<code>fixed</code> 的坚定、<code>sticky</code> 的智能，共同构成了现代 Web 布局的强大工具集。</p>
<p>掌握它们的关键，在于理解<strong>文档流</strong>这一底层逻辑。只有明白元素“原本在哪里”，才能精准控制它“应该去哪里”。</p>
<blockquote>
<p>正如笔记开篇所问：“离开文档流？”——答案不是简单的“是”或“否”，而是：<strong>根据需求，恰到好处地脱离或保留</strong>。这才是前端布局的艺术所在。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebSocket指南：从原理到生产环境实战]]></title>    <link>https://juejin.cn/post/7571650164843986978</link>    <guid>https://juejin.cn/post/7571650164843986978</guid>    <pubDate>2025-11-12T13:07:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843986978" data-draft-id="7571655312799072282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebSocket指南：从原理到生产环境实战"/> <meta itemprop="keywords" content="前端,WebSocket"/> <meta itemprop="datePublished" content="2025-11-12T13:07:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZKshun"/> <meta itemprop="url" content="https://juejin.cn/user/4106030135654128"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebSocket指南：从原理到生产环境实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4106030135654128/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZKshun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T13:07:16.000Z" title="Wed Nov 12 2025 13:07:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">一、为什么选 WebSocket ？</h2>
<p>WebSocket是一个在单个TCP连接上实现全双工通信的网络协议，专为web应用设计，由HTML5规范引入前端开发。</p>
<ul>
<li><strong>全双工</strong>：客户端和服务端可以<strong>同时</strong>独立发送和接收数据，不需要像HTTP/HTTPS协议那样只能单次请求-响应</li>
<li><strong>持久连接</strong>：一旦连接建立之后就会保持连接状态，除非有一端取消连接，避免了HTTP的频繁握手开销，适用于实时聊天、需实时获取数据状态等场景</li>
<li><strong>基于HTTP升级</strong>：连接通过HTTP/HTTPS的**"Upgrade"机制**建立（即websocket握手），初始使用ws://或wss://协议</li>
</ul>
<p><strong>适用场景</strong>：实时聊天、在线协作、多人游戏、直播弹幕等需要低延迟、高频率使用的场景</p>
<blockquote>
<p><strong>通信模式对比</strong></p>
<ul>
<li>单工：数据只能单向传输，如服务端推送（SSE）、
</li><li>半双工：数据可以双向传输、但不能同时进行，如常规的REST API、Fetch/XMLHttpRequest</li>
<li>全双工：数据可以双向同时传输，如WebSocket、WebRTC</li>
</ul>
</blockquote>
<p>本文以小编在一个在线代码评测系统使用websocket来实时获取用户代码的评测信息功能，来介绍小编对于websocket的理解！</p>
<h2 data-id="heading-1">二、WebSocket握手与协议升级</h2>
<p><strong>"Upgrade"机制</strong>是一种协议协商方式，允许客户端和服务器在已有HTTP连接的基础上，将通信协议从HTTP切换为另一种协议WebSocket。这一过程又被称为<strong>协议升级</strong>，所以发送websocket请求也可以理解为一次协议升级的过程，具体过程包括：</p>
<ol>
<li>客户端发起websocket请求，该请求的类型会显示为websocket请求，请求头通常包含几个upgrade的关键字段，如下图所示为ws连接的请求头：</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0464b53ea0cb4d728c04e3c884353bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=mxYsfU97IqOlRj7AVK6ccQdQiDY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51e6774c52f465faf19ff95dea37c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=74EoqYOx%2B3ajfsqjM9WQ7%2BvLfcY%3D" alt="image.png" loading="lazy"/>
2. 如果服务器支持websocket协议并同意升级，他就会返回一个<strong>101 Switching Protocols</strong> 状态码，并且包含特定的响应头：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f82f7372a611418dbd3a00feabf1b228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=HO7BH205btco4qWJAdOyohDqYEw%3D" alt="image.png" loading="lazy"/>
3. 一旦客户端收到<strong>101响应，TCP连接就会从HTTP模式切换到WebSocket模式</strong>，就会发生以下变化：</p>
<ul>
<li>后续所有的数据都以<code>WebSocket帧（frame，如下图）</code>格式传输（不再是原来的HTTP提交）</li>
<li>双方可以随时主动发送消息（全双工）</li>
<li>连接保持打开，直到一方发送<code>关闭帧</code>或连接中断。在小编对接的过程中，由于后端同学并没有在沙箱判题结束之后发送关闭帧主动关闭连接通道，所以小编采用的是判断最后一帧信息的状态来主动关闭连接。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c57e33429a194c1daa938a17a859dedf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=ZLZsqdbkiODvwJgVRl038k4U6b0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>简言之：WebSocket 不是全新连接，而是"借用"HTTP连接完成一次安全握手后，将通道"改造"为实时通信管道。</p>
</blockquote>
<h2 data-id="heading-2">三、快速上手-基础语法</h2>
<h3 data-id="heading-3">1、创建 WebSocket 连接</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://localhost:8080'</span>); <span class="hljs-comment">// 传入后端给你的ws连接地址</span>
</code></pre>
<h3 data-id="heading-4">2、Websocket 的四个事件</h3>
<ul>
<li><code>onopen</code>：连接建立时触发</li>
<li><code>onmessage</code>：收到服务器消息触发</li>
<li><code>onerror</code>：连接发生错误时触发</li>
<li><code>onclose</code>：连接关闭时触发</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接建立'</span>);
  <span class="hljs-comment">// socket.send('Hello Server!'); 一般在连接建立成功之后就可以给服务端发消息了</span>
};

socket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息:'</span>, event.<span class="hljs-property">data</span>);
  <span class="hljs-comment">// event.data 是服务器发送的数据</span>
};

socket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, error);
};

socket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接关闭'</span>, event);
};
</code></pre>
<h3 data-id="heading-5">3、发送消息</h3>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello Server!'</span>);
</code></pre>
<h3 data-id="heading-6">4、关闭连接</h3>
<pre><code class="hljs language-javascript" lang="javascript">socket.<span class="hljs-title function_">close</span>();
</code></pre>
<h3 data-id="heading-7">5、四种状态</h3>
<p>websocket有四种只读的状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// WebSocket 的四种状态常量</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CONNECTING</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 连接中</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 连接已打开，可以通信</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CLOSING</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// 连接正在关闭中</span>
<span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CLOSED</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// 连接已关闭或无法打开</span>

<span class="hljs-comment">// 实例的readyState属性为当前的状态，使用当前状态和四个状态常量对比即可的得到不同的判断条件</span>
<span class="hljs-comment">// 如</span>
<span class="hljs-keyword">if</span>(socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>){
  <span class="hljs-comment">// 检测连接正常时触发</span>
}
</code></pre>
<h2 data-id="heading-8">四、具体实战例子</h2>
<blockquote>
<p>以下示例为小编自己的项目在通过WebSocket实时获取沙箱判题状态时的实现👇</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee1fcda4843492cae0c0bcbc37a85fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWktzaHVu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763557837&amp;x-signature=oSmjj4L%2FM1Jbag4o0mj6lNYlk6s%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">用户提交代码
↓
创建提交记录 (HTTP POST)
↓
建立 WebSocket 连接
↓
接收实时消息 → 更新状态 → UI 刷新
↓
收到 final_result → 自动关闭连接
↓
显示最终结果
</code></pre>
<h3 data-id="heading-9">1、用户点击提交按钮</h3>
<p>用户点击提交之后，首先调用提交代码接口，此时服务端就会启动一个<code>沙箱服务</code>，将用户编写的代码作为沙箱的程序代码，并自动运行测试用例至沙箱内，然后响应本次提交的ID至客户端，<strong>客户端立即基于提交ID建立与服务端的WebSocket连接，实时获取沙箱程序的运行状态展示到页面中！</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 调用提交代码接口（传递题目id、代码、语言）</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">problemId: <span class="hljs-built_in">number</span>, code: <span class="hljs-built_in">string</span>, language: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 发送 HTTP 请求创建提交记录</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/submit'</span>, {
    <span class="hljs-attr">problem_id</span>: problemId,
    code,
    language
  })
  <span class="hljs-keyword">const</span> submit = response.<span class="hljs-property">data</span>

  <span class="hljs-comment">// 2. 自动建立 WebSocket 连接监听结果（传递响应的提交id）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupWebSocketConnection</span>(submit.<span class="hljs-property">id</span>)
}
</code></pre>
<h3 data-id="heading-10">2、Websocket连接管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 声明一个建立连接类，在类内部再声明一个connect连接方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SubmitWebSocket</span> {
  <span class="hljs-comment">// 建立连接方法</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">connect</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/ws/submit/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.submitId}</span>?token=<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.token}</span>`</span>
    <span class="hljs-comment">// 1. 实例化一个websocket</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(url)

    <span class="hljs-comment">// 2. 设置消息监听器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> message = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">WebSocketMessage</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onMessage</span>?.(message) <span class="hljs-comment">// 触发回调函数</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-11">3、实时消息处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 store 中处理 WebSocket 消息</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">setupWebSocketConnection</span>(<span class="hljs-params">submitId: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> websocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SubmitWebSocket</span>(submitId, <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span>)

  websocket.<span class="hljs-property">onMessage</span> = <span class="hljs-function">(<span class="hljs-params">message: WebSocketMessage</span>) =&gt;</span> {
    <span class="hljs-comment">// 根据消息类型更新状态</span>
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'status_update'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubmit</span>!.<span class="hljs-property">status</span> = message.<span class="hljs-property">data</span>.<span class="hljs-property">status</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'test_case_result'</span>:
        <span class="hljs-comment">// 更新测试用例结果</span>
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'final_result'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubmit</span>!.<span class="hljs-property">result</span> = message.<span class="hljs-property">data</span>
        websocket.<span class="hljs-title function_">close</span>() <span class="hljs-comment">// 收到最终结果后关闭连接</span>
        <span class="hljs-keyword">break</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-12">五、生产环境避坑（重点）</h2>
<p>小编在完成这个功能之后，发现<strong>开发环境正常</strong>，但是<strong>生产环境会报错无法升级HTTP-&gt;WebSocket</strong>，经过一个老师的提醒，发现如果使用nginx来部署前端应用，我们还要<strong>完成nginx的相关配置</strong>才能使用WebSocket功能，具体配置如下：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
  listen 80;
  server_name http://your-domain.com;

  location /ws/ {
    proxy_pass http://localhost:8080; # 你的 WebSocket 服务器地址

    # WebSocket 必需的三行配置
    proxy_http_version 1.1; # 必需：HTTP 1.1 支持协议升级
    proxy_set_header Upgrade $http_upgrade; # 必需：处理升级头
    proxy_set_header Connection "upgrade"; # 必需：设置连接类型
    proxy_read_timeout 3600s; # 重要：长连接超时

    # 可选的基础头信息
    proxy_set_header Host $host;
  }

  # 其它配置...
}
</code></pre>
<p><strong>那么为什么开发环境正常，生产环境却需要进行websocket的相关配置呢？</strong></p>
<ul>
<li><strong>开发环境</strong></li>
</ul>

<pre><code class="hljs language-scss" lang="scss">前端 (http://localhost:<span class="hljs-number">3000</span>)
↓ 直接连接
后端 WebSocket (后端ws接口地址)
</code></pre>
<p>开发环境下前端直连后端服务，不经过Nginx的反向代理，所以可以直接升级为WebSocket连接</p>
<ul>
<li><strong>生产环境（需要Nginx代理）</strong></li>
</ul>

<pre><code class="hljs language-less" lang="less">用户浏览器 → <span class="hljs-selector-tag">Nginx</span> (<span class="hljs-attribute">https</span>:<span class="hljs-comment">//your-domain.com) → 多个后端服务器</span>
</code></pre>
<p>WebSocket 使用 HTTP 协议升级机制，在生产环境下前端调用接口服务需要经过 Nginx代理，所以Nginx需要正确处理这个升级过程</p>
<blockquote>
<p>以上是小编通过自己在websocket功能的实现过程中总结出来的一些东西，如果有误请各位大佬指出，感激不尽！</p>
</blockquote>
<h2 data-id="heading-13">六、状态管理和重连机制</h2>
<p>websocket的连接有时候会意外断开（网络问题、服务器故障等等），为了保证用户体验，对于意外断开的连接一般情况下会有重连机制进行处理</p>
<h3 data-id="heading-14">1. 简单实现</h3>
<p>声明一个标志变量<code>isManualClose</code>表示是否为正常关闭连接，在用户主动关闭连接事件中设置其值为true，其余情况下皆为false，<strong>在连接关闭事件中据此值来决定是否重连</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> isManualClose = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 默认不是手动关闭</span>

ws.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isManualClose) {
    <span class="hljs-comment">// 只有意外断开才重连</span>
    <span class="hljs-title function_">startReconnect</span>();
  }
};

<span class="hljs-comment">// 用户主动断开连接</span>
disconnectButton.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
  isManualClose = <span class="hljs-literal">true</span>; <span class="hljs-comment">// ⭐ 标记为手动关闭</span>
  ws.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 现在 onclose 不会触发重连</span>
};

<span class="hljs-comment">// 用户跳转到其他页面，主动关闭WebSocket</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  isManualClose = <span class="hljs-literal">true</span>;
  ws.<span class="hljs-title function_">close</span>();
});
</code></pre>
<blockquote>
<p><code>isManualClose</code>的值可以有很多标识和判断来决定，小编觉得具体的可以与后端的同学一起来制定约束</p>
</blockquote>
<h3 data-id="heading-15">2. 指数退避+有限尝试</h3>
<p>利用指数退避算法来计算重连的间隔，并设置最大间隔来防止客户端无限重连（浪费带宽）。根据业务场景，如需要的话还可以设置最大重连次数，当达到最大重连次数时，停止重连逻辑（有限尝试），思路与指数退避是类似的！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 关键参数</span>
<span class="hljs-keyword">let</span> reconnectInterval = <span class="hljs-number">1000</span>; <span class="hljs-comment">// 初始间隔：1秒</span>
<span class="hljs-keyword">let</span> maxReconnectInterval = <span class="hljs-number">30000</span>; <span class="hljs-comment">// 最大间隔：30秒</span>
<span class="hljs-keyword">let</span> reconnectDecay = <span class="hljs-number">1.5</span>; <span class="hljs-comment">// 增长倍数：1.5倍</span>
<span class="hljs-keyword">let</span> reconnectAttempts = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重连次数</span>
<span class="hljs-keyword">let</span> maxAttempts = <span class="hljs-number">50</span>; <span class="hljs-comment">// 最大尝试次数</span>

<span class="hljs-comment">// 每次重连时计算新间隔</span>
reconnectInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(reconnectInterval * reconnectDecay, maxReconnectInterval);

<span class="hljs-comment">// 第1次重连: 1秒后</span>
<span class="hljs-comment">// 第2次重连: 1.5秒后 (1000 × 1.5)</span>
<span class="hljs-comment">// 第3次重连: 2.25秒后 (1500 × 1.5)</span>
<span class="hljs-comment">// 第4次重连: 3.375秒后 (2250 × 1.5)</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// 直到达到最大30秒间隔</span>
<span class="hljs-comment">// 当间隔达到30秒时，重连频率很低，相当于软限制</span>

<span class="hljs-comment">// 判断是否需要重连</span>
<span class="hljs-title function_">shouldReconnect</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isManualClose</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxAttempts</span>;
}

<span class="hljs-comment">// 计算下一次重连间隔</span>
<span class="hljs-title function_">calculateNextInterval</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 基础指数退避计算</span>
  reconnectInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(reconnectInterval * reconnectDecay, maxReconnectInterval);
  <span class="hljs-keyword">return</span> reconnectInterval
}

<span class="hljs-comment">// 启动重连</span>
<span class="hljs-title function_">startReconnect</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">shouldReconnect</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'不满足重连条件，停止重连'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 避免重复启动（每次重连先清理上一次的定时器）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span>);
  }
  <span class="hljs-comment">// 更新重连状态</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span>++;<span class="hljs-variable language_">this</span>.<span class="hljs-property">isReconnecting</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 计算下一次重连间隔（指数退避）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInterval</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateNextInterval</span>();

  <span class="hljs-comment">// 设置重连定时器</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeReconnect</span>(); <span class="hljs-comment">// 需要重新建立ws连接</span>
  },<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectInterval</span>);
}

socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldReconnect</span>()) {
    <span class="hljs-comment">// 只有意外断开才重连</span>
    <span class="hljs-title function_">startReconnect</span>();
  }
};

socket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// 连接成功时重置所有重连参数</span>
  reconnectInterval = <span class="hljs-number">1000</span>;
  reconnectAttempts = <span class="hljs-number">0</span>;
};
</code></pre>
<h2 data-id="heading-16">七、心跳机制</h2>
<p>websocket的心跳机制作用于检测连接是否真实存活（避免假连接，适用于生产环境），并在连接断开时及时发现。为什么需要心跳？</p>
<ul>
<li>WebSocket 基于 TCP，但 <code>TCP Keep-Alive</code> 默认关闭或周期极长</li>
<li>中间设备（如我们使用的Nginx代理）一般会设置<strong>空闲超时</strong></li>
<li>若应用层长时间无数据传输，<strong>连接会被静默断开，而客户端毫无感知</strong></li>
</ul>
<p>以下为基于<strong>Ping-Pong模型</strong>实现的心跳机制简易版：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> heartbeatInterval; <span class="hljs-comment">// 心跳定时器</span>
<span class="hljs-keyword">let</span> heartbeatIntervalTime = <span class="hljs-number">30000</span>; <span class="hljs-comment">// 心跳间隔时间（毫秒），默认30秒</span>
<span class="hljs-comment">// 注意：心跳间隔 &lt; min(防火墙超时, 服务端超时, 客户端容忍延迟) / 2 ，否则无效</span>
<span class="hljs-keyword">let</span> heartbeatTimeout; <span class="hljs-comment">// 心跳超时定时器</span>
<span class="hljs-keyword">let</span> heartbeatTimeoutTime = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 心跳超时时间（毫秒），默认5秒</span>

socket.<span class="hljs-property">onopen</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其余代码...</span>
  <span class="hljs-comment">// 在连接成功之后启动心跳机制</span>
  <span class="hljs-title function_">startHeartbeat</span>();
}

<span class="hljs-comment">// 收到服务器消息时触发判断</span>
socket.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 处理心跳响应</span>
  <span class="hljs-keyword">if</span>(event.<span class="hljs-property">data</span> === <span class="hljs-string">'pong'</span>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到心跳响应！'</span>);
    <span class="hljs-keyword">if</span>(heartbeatTimeout){
      <span class="hljs-built_in">clearTimeout</span>(heartbeatTimeout);
    }
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-comment">// 其它代码...</span>
}

<span class="hljs-comment">// 连接关闭时触发</span>
socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其它代码...</span>
  <span class="hljs-comment">// 停止心跳机制</span>
  <span class="hljs-title function_">stopHeartbeat</span>();
  <span class="hljs-comment">// 判断是否需要重连...</span>
}

<span class="hljs-comment">// 发生错误时触发</span>
socket.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// other...</span>
  <span class="hljs-comment">// 停止心跳机制</span>
  <span class="hljs-title function_">stopHeartbeat</span>();
}

<span class="hljs-comment">// 启动心跳机制</span>
<span class="hljs-title function_">startHeartbeat</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 清除之前的心跳定时器</span>
  <span class="hljs-keyword">if</span> (heartbeatInterval) {
    <span class="hljs-built_in">clearInterval</span>(heartbeatInterval);
  }
  <span class="hljs-comment">// 设置心跳定时器，定期发送心跳消息</span>
  heartbeatInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      socket.<span class="hljs-title function_">send</span>(<span class="hljs-string">'ping'</span>);
      <span class="hljs-comment">// 设置心跳超时定时器（目的是检测是否收到pong）</span>
      heartbeatTimeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'心跳超时，连接可能已断开'</span>);
        <span class="hljs-title function_">addMessage</span>(<span class="hljs-string">'心跳超时，连接可能已断开'</span>, <span class="hljs-string">'received'</span>);
        <span class="hljs-comment">// 主动关闭连接以触发重连机制</span>
        <span class="hljs-keyword">if</span> (socket) {
          socket.<span class="hljs-title function_">close</span>();
        }
      }, heartbeatTimeoutTime);
    }
  }, heartbeatIntervalTime);
}

<span class="hljs-comment">// 停止心跳机制</span>
<span class="hljs-title function_">stopHeartbeat</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (heartbeatInterval) {
    <span class="hljs-built_in">clearInterval</span>(heartbeatInterval);
    heartbeatInterval = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (heartbeatTimeout) {
    <span class="hljs-built_in">clearTimeout</span>(heartbeatTimeout);
    heartbeatTimeout = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h2 data-id="heading-17">八、消息队列与流量控制</h2>
<p>如果你使用的websocket涉及到大量、密集的消息需要同段事件发送，为了防止网络拥塞，可以通过消息队列来进行缓冲，将待发送的消息推入消息队列缓冲，以此保证消息数据在网络拥塞/连接断开的时候不会丢失。</p>
<p>消息队列的工作流程大致为：</p>
<pre><code class="hljs">应用层发送消息
↓
检查连接状态
↓
连接可用 → 立即发送
连接不可用 → 加入队列
↓
监听连接恢复事件
↓
连接恢复 → 按顺序发送队列中消息
↓
发送成功 → 从队列移除
发送失败 → 标记重试或丢弃
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> messageQueue = []; <span class="hljs-comment">// 消息队列</span>
<span class="hljs-keyword">let</span> isSending = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 是否正在发送消息</span>
<span class="hljs-keyword">let</span> sendRateLimit = <span class="hljs-number">10</span>; <span class="hljs-comment">// 每秒最大发送消息数</span>
<span class="hljs-keyword">let</span> sendInterval = <span class="hljs-number">1000</span> / sendRateLimit; <span class="hljs-comment">// 发送间隔（毫秒）</span>
<span class="hljs-keyword">let</span> sendTimer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 发送定时器</span>

socket.<span class="hljs-property">onopen</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其余代码...</span>
  <span class="hljs-comment">// 开始处理消息队列</span>
  <span class="hljs-title function_">processMessageQueue</span>();
}

<span class="hljs-comment">// 连接关闭时触发</span>
socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 其它代码...</span>
  <span class="hljs-comment">// 停止消息推送</span>
  <span class="hljs-title function_">stopMessageSending</span>();
  <span class="hljs-comment">// 判断是否需要重连...</span>
}

<span class="hljs-comment">// 发生错误时触发</span>
socket.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// other...</span>
  <span class="hljs-comment">// 停止消息推送</span>
  <span class="hljs-title function_">stopMessageSending</span>();
}

<span class="hljs-comment">// 将消息添加到队列</span>
<span class="hljs-title function_">enqueueMessage</span>(<span class="hljs-params">message, priority = <span class="hljs-number">0</span></span>) {
  <span class="hljs-comment">// 创建消息对象</span>
  <span class="hljs-keyword">const</span> messageObj = {
    <span class="hljs-attr">content</span>: message,
    <span class="hljs-attr">priority</span>: priority, <span class="hljs-comment">// 优先级，数值越大优先级越高</span>
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() <span class="hljs-comment">// 时间戳</span>
  };

  <span class="hljs-comment">//if (priority &gt; 0) {</span>
  <span class="hljs-comment">// //根据优先级插入消息队列</span>
  <span class="hljs-comment">//} else {</span>
  <span class="hljs-comment">// // 普通消息添加到队列末尾</span>
  <span class="hljs-comment">//}</span>

  messageQueue.<span class="hljs-title function_">push</span>(messageObj);
}

<span class="hljs-comment">// 处理消息队列</span>
<span class="hljs-title function_">processMessageQueue</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (sendTimer) {
    <span class="hljs-built_in">clearInterval</span>(sendTimer);
  }
  <span class="hljs-comment">// 定时处理消息队列</span>
  sendTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (messageQueue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      <span class="hljs-comment">// 取出队列中的第一条消息</span>
      <span class="hljs-keyword">const</span> messageObj = messageQueue.<span class="hljs-title function_">shift</span>();
      socket.<span class="hljs-title function_">send</span>(messageObj.<span class="hljs-property">content</span>);
    }
  }, sendInterval);
}

<span class="hljs-comment">// 停止消息发送</span>
<span class="hljs-title function_">stopMessageSending</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (sendTimer) {
    <span class="hljs-built_in">clearInterval</span>(sendTimer);
    sendTimer = <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-comment">// 设置发送速率（每秒消息数）</span>
<span class="hljs-title function_">setSendRate</span>(<span class="hljs-params">rate</span>) {
  <span class="hljs-keyword">if</span> (rate &gt; <span class="hljs-number">0</span> &amp;&amp; rate &lt;= <span class="hljs-number">100</span>) {
    sendRateLimit = rate;
    sendInterval = <span class="hljs-number">1000</span> / sendRateLimit;

    <span class="hljs-comment">// 重新启动消息处理定时器</span>
    <span class="hljs-keyword">if</span> (socket &amp;&amp; socket.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      <span class="hljs-title function_">processMessageQueue</span>();
    }
  }
}
</code></pre>
<blockquote>
<p>本文到此结束，文中的理解和总结难免有不足之处，如有纰漏或错误，请大家直接指出，小编虚心求教！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当递归引爆调用栈：你的前端应用还能优雅降落吗？]]></title>    <link>https://juejin.cn/post/7571678388954021907</link>    <guid>https://juejin.cn/post/7571678388954021907</guid>    <pubDate>2025-11-12T13:18:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678388954021907" data-draft-id="7571646669202030634" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当递归引爆调用栈：你的前端应用还能优雅降落吗？"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-12T13:18:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当递归引爆调用栈：你的前端应用还能优雅降落吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T13:18:43.000Z" title="Wed Nov 12 2025 13:18:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>“今天我们聊聊前端性能中一个隐蔽而关键的角落——递归优化。不过在深入之前，我想先分享一个视角。”</p>
<p>“在我们团队看来，前端代码不仅是实现业务逻辑的工具，更是<strong>用户设备资源的管家</strong>。一个在后端看似无害的深度递归，传递到用户浏览器中，就可能成为耗尽内存、导致页面卡顿甚至崩溃的元凶。”</p>
<p>“因此，当我考察一个候选人对性能优化的理解时，我核心关注的不是他记住了多少API，而是他是否具备一种 <strong>‘执行上下文感知’</strong> 的视角。他是否明白，我们的工作目标，不仅是实现功能，更是要<strong>在有限的内存和计算资源中，构建出最优雅、最高效的执行路径</strong>。”</p>
<p>“这意味着，你需要去理解代码在引擎中的执行过程——调用栈如何增长、内存如何分配、垃圾回收如何工作——并为潜在的资源瓶颈设计<strong>更优的算法和数据结构</strong>。”</p>
<p>“所以，今天的问题不仅仅是关于‘尾递归’这个具体概念，我更想听到的是，你如何<strong>从引擎层面</strong>思考、分析和优化一段看似简单的递归代码。让我们就从这里开始聊起吧。”</p>
<p>当我问起这个问题时，我不仅仅是想听几个名词。我想考察的是：</p>
<ol>
<li><strong>深度</strong>：你对递归的理解是否停留在“函数调用自身”的层面？</li>
<li><strong>原理</strong>：你是否理解调用栈的工作原理和内存管理机制？</li>
<li><strong>实践</strong>：你是否有过实际的性能问题排查经验，或者至少思考过优化方案？</li>
<li><strong>标准认知</strong>：你是否了解语言特性在理论标准和现实实现之间的差距？</li>
</ol>
<p>下面，我们就从“尾递归优化”这个点切入，系统地聊一聊。</p>
<h2 data-id="heading-1">一、核心理念：递归的性能瓶颈不在计算，而在内存</h2>
<p>首先要明确，递归问题的性能瓶颈往往不是计算复杂度，而是<strong>空间复杂度</strong>——具体来说，是调用栈的深度限制。</p>
<ul>
<li><strong>普通递归</strong>：每次递归调用都会在调用栈中创建一个新的栈帧，保存当前函数的执行上下文。</li>
<li><strong>尾递归</strong>：通过特定的代码结构，让引擎有机会复用栈帧，将空间复杂度从O(n)降为O(1)。</li>
</ul>
<p>所以，递归优化的核心是围绕着“如何减少调用栈的深度消耗”来展开的。</p>
<h2 data-id="heading-2">二、普通递归 vs 尾递归：从栈溢出到无限可能</h2>
<p><strong>1. 面试官想听到什么？</strong>
他希望你不仅知道尾递归的概念，更能从调用栈的角度解释清楚为什么尾递归可以优化，以及这种优化带来的实际价值。如果你能提到具体的空间复杂度变化，说明你对性能分析有扎实的基础。</p>
<p><strong>2. 普通递归的困境</strong>
让我们用经典的阶乘函数举例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 普通递归 - 清晰的思维模型，但存在性能隐患</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> n * <span class="hljs-title function_">factorial</span>(n - <span class="hljs-number">1</span>); <span class="hljs-comment">// 问题所在！</span>
  }
}

<span class="hljs-title function_">factorial</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 120</span>
</code></pre>
<p><strong>执行过程分析：</strong></p>
<ul>
<li><code>factorial(5)</code> 等待 <code>factorial(4)</code> 的结果来计算 <code>5 * ...</code></li>
<li><code>factorial(4)</code> 等待 <code>factorial(3)</code> 的结果来计算 <code>4 * ...</code></li>
<li>以此类推...</li>
<li>每个函数都在等待，但它们的执行上下文都被压在调用栈中</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">调用栈增长过程：
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">1</span>) |  &lt;- 栈顶
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">2</span>) |
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">3</span>) |
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">4</span>) |
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">5</span>) |  &lt;- 栈底
</code></pre>
<p>当n足够大时（比如100000），调用栈深度超出引擎限制，就会发生<strong>栈溢出</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">factorial</span>(<span class="hljs-number">100000</span>); <span class="hljs-comment">// RangeError: Maximum call stack size exceeded</span>
</code></pre>
<p><strong>3. 尾递归的解决方案</strong>
将函数改写成尾递归形式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 尾递归版本 - 性能优化，但需要思维转换</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n, total = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> total;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">factorial</span>(n - <span class="hljs-number">1</span>, n * total); <span class="hljs-comment">// 关键变化！</span>
  }
}

<span class="hljs-title function_">factorial</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 120</span>
</code></pre>
<p><strong>执行过程分析：</strong></p>
<ul>
<li><code>factorial(5, 1)</code> 直接返回 <code>factorial(4, 5)</code></li>
<li><code>factorial(4, 5)</code> 直接返回 <code>factorial(3, 20)</code></li>
<li>以此类推...</li>
<li>每个函数在返回时都<strong>不再需要当前的执行上下文</strong></li>
</ul>
<pre><code class="hljs language-scss" lang="scss">调用栈保持平坦：
| <span class="hljs-built_in">factorial</span>(<span class="hljs-number">5</span>, <span class="hljs-number">1</span>) | -&gt; | <span class="hljs-built_in">factorial</span>(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>) | -&gt; | <span class="hljs-built_in">factorial</span>(<span class="hljs-number">3</span>, <span class="hljs-number">20</span>) | -&gt; ...
</code></pre>
<p><strong>4. 如何回答（展现你的原理理解）</strong>
“普通递归和尾递归的核心区别在于调用栈的管理方式。普通递归每次调用都会保留当前函数的栈帧，导致空间复杂度为O(n)，容易栈溢出。而尾递归通过确保函数的最后一步只是递归调用自身，让引擎有机会复用当前栈帧，将空间复杂度降为O(1)。这就像多人接力赛跑——普通递归是每个人都站在原地等待结果，而尾递归是直接把手里的接力棒传给下一个人，自己就可以离开了。”</p>
<h2 data-id="heading-3">三、尾调用优化：理论的美好与现实的骨感</h2>
<p><strong>1. 面试官想听到什么？</strong>
候选人需要了解ES6标准中规定了尾调用优化，但也要清楚知道这个特性在主流浏览器中的实现现状。这考察的是你对Web标准演进和工程实践落差的认知。</p>
<p><strong>2. 理论上的完美方案</strong>
根据ES6标准，尾调用优化应该这样工作：</p>
<ul>
<li>当函数B在函数A的尾部被调用时，引擎可以重用函数A的栈帧</li>
<li>调用栈深度保持不变，避免栈溢出</li>
<li>内存使用保持恒定，不受递归深度影响</li>
</ul>
<p><strong>3. 现实中的实现困境</strong>
然而，现实是骨感的：</p>
<ul>
<li><strong>Chrome (V8)</strong>：默认未启用，需要特殊flag</li>
<li><strong>Firefox</strong>：曾经实现，但在某些版本中又移除了</li>
<li><strong>Safari</strong>：是目前对TCO支持最好的，但也不是默认开启</li>
<li><strong>Node.js</strong>：需要<code>--harmony_tailcalls</code>flag，且该flag已被标记为过时</li>
</ul>
<p><strong>4. 如何回答（展现你的工程实践认知）</strong>
“虽然尾递归在理论上是解决递归性能问题的银弹，但在当前的工程实践中，我们需要保持谨慎。ES6标准确实规定了尾调用优化，但主流浏览器引擎出于调试体验和性能权衡的考虑，大多没有默认启用这个特性。这意味着，即使我们写了符合规范的尾递归代码，在生产环境中也可能无法享受到优化好处。”</p>
<h2 data-id="heading-4">四、超越尾递归：构建完整的递归优化方案</h2>
<p>一个优秀的候选人，还能聊到更多实际解决方案。我会把这些视为"惊喜"。</p>
<p><strong>1. 迭代方案：最可靠的替代</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 迭代版本 - 生产环境的首选</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">let</span> result = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">2</span>; i &lt;= n; i++) {
    result *= i;
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>2. Trampoline模式：手动管理调用栈</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通过循环+函数包装来模拟尾递归优化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">trampoline</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">let</span> result = <span class="hljs-title function_">fn</span>(...args);
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>) {
      result = <span class="hljs-title function_">result</span>();
    }
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-keyword">const</span> factorial = <span class="hljs-title function_">trampoline</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">n, total = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> total;
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">factorial</span>(n - <span class="hljs-number">1</span>, n * total);
});
</code></pre>
<p><strong>3. 算法层面优化</strong></p>
<ul>
<li><strong>记忆化</strong>：缓存已计算结果，避免重复计算</li>
<li><strong>问题分解</strong>：将大问题拆分为可并行处理的子问题</li>
<li><strong>早期终止</strong>：在满足条件时提前返回，减少递归深度</li>
</ul>
<h2 data-id="heading-5">面试官总结：我心目中的理想回答</h2>
<p>一个让我眼前一亮的回答，应该是这样的：</p>
<p>"对于递归优化，我认为需要从理论原理和工程实践两个层面来考虑：</p>
<p>从<strong>原理层面</strong>，我理解尾递归通过改变递归调用的位置，让函数在返回时不再依赖当前的执行上下文，从而为引擎提供了复用栈帧的可能性。这种优化能将空间复杂度从O(n)降为O(1)，从根本上解决栈溢出问题。</p>
<p>从<strong>实践层面</strong>，我知道虽然ES6标准规定了尾调用优化，但由于调试体验和实现复杂度的考虑，主流浏览器引擎大多没有默认启用。因此在生产环境中，我更倾向于使用迭代方案来替代深度递归，或者在必要时使用Trampoline这样的技术来手动模拟尾递归优化。</p>
<p>总之，理解尾递归不仅是为了应对面试问题，更是为了培养一种'执行上下文感知'的编程思维——在实现功能的同时，始终关注代码在引擎中的实际执行过程。"</p>
<p><strong>思考题：</strong> 在你的项目中，是否遇到过因为递归导致的性能问题？你是如何发现并解决的？欢迎在评论区分享你的实战经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 实战教学：用 Trae 协作开发 Chrome 扩展 “Hulk”]]></title>    <link>https://juejin.cn/post/7571725550709178395</link>    <guid>https://juejin.cn/post/7571725550709178395</guid>    <pubDate>2025-11-12T14:22:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571725550709178395" data-draft-id="7571695634942197787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 实战教学：用 Trae 协作开发 Chrome 扩展 “Hulk”"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-12T14:22:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 实战教学：用 Trae 协作开发 Chrome 扩展 “Hulk”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:22:47.000Z" title="Wed Nov 12 2025 14:22:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是 Vibe Coding？</h2>
<p>Vibe Coding 是一种以“氛围”和“上下文”为核心的新型编程协作范式。它强调：</p>
<ul>
<li><strong>人与 AI 编程助手（如 Trae）的深度协作</strong></li>
<li><strong>文档 &gt; 代码</strong>：清晰的需求、设计稿、接口说明是生成高质量代码的前提</li>
<li><strong>开发者角色转变</strong>：从写每一行代码，变为提供上下文、监督逻辑、把控质量</li>
</ul>
<p>在 Vibe Coding 模式下，我们不再执着于“手敲代码”，而是专注于：</p>
<ul>
<li>写好需求文档</li>
<li>绘制线框图或设计稿</li>
<li>规划项目结构</li>
<li>定义交互流程</li>
</ul>
<p>AI（如 Trae）则负责将这些“vibe”转化为可运行的代码。</p>
<hr/>
<h2 data-id="heading-1">二、实战目标：开发 Chrome 扩展 “Hulk”</h2>
<p>我们将使用 Vibe Coding 的方式，与 Trae 合作开发一个名为 <strong>Hulk</strong> 的 Chrome 扩展程序。</p>
<h3 data-id="heading-2">功能需求（需求文档）</h3>
<ul>
<li>
<p>用户点击扩展图标，弹出 popup 窗口</p>
</li>
<li>
<p>窗口中显示：</p>
<ul>
<li>标题：“改变背景颜色”</li>
<li>提示文字：“点击下方按钮将当前页面背景色改为绿色”</li>
<li>一个按钮：“改变颜色”</li>
</ul>
</li>
<li>
<p>点击按钮后，<strong>当前网页的背景色变为绿色</strong></p>
</li>
</ul>
<h3 data-id="heading-3">设计参考（UX 设计稿）</h3>
<blockquote>
<p>假设你已提供 <code>ux.jpg</code>，其中展示了 popup 的布局：简洁卡片式 UI，居中文字 + 按钮。</p>
</blockquote>
<h3 data-id="heading-4">技术约束</h3>
<ul>
<li>使用 <code>icons/</code> 文件夹中的图标作为扩展图标</li>
<li>使用标准 Chrome Extension Manifest V3 架构</li>
<li>不依赖外部库（纯 HTML/CSS/JS）</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、为 Trae 提供完整上下文（Vibe 准备）</h2>
<p>为了让 Trae 高效生成代码，我们需要提供以下“vibe”材料：</p>

























<table><thead><tr><th>类型</th><th>内容</th></tr></thead><tbody><tr><td><strong>需求文档</strong></td><td>如上所述的功能描述</td></tr><tr><td><strong>设计稿</strong></td><td><code>ux.jpg</code>（视觉参考）</td></tr><tr><td><strong>目录结构规划</strong></td><td>明确文件组织</td></tr><tr><td><strong>技术栈说明</strong></td><td>Manifest V3、popup、content script</td></tr></tbody></table>
<h3 data-id="heading-6">规划项目目录结构</h3>
<pre><code class="hljs language-bash" lang="bash">hulk-extension/
├── manifest.json          <span class="hljs-comment"># 扩展配置</span>
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── popup/
│   ├── index.html         <span class="hljs-comment"># 弹窗页面</span>
│   ├── style.css          <span class="hljs-comment"># 弹窗样式</span>
│   └── script.js          <span class="hljs-comment"># 弹窗逻辑</span>
└── content.js             <span class="hljs-comment"># 注入页面，修改背景色</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">四、Trae 生成的代码（基于上述上下文）</h2>
<blockquote>
<p>下面是 Trae 在接收到完整上下文后，应能自动生成的代码。</p>
</blockquote>
<h3 data-id="heading-8">1. <code>manifest.json</code></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hulk"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"一键将网页背景变为绿色！"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/icon16.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"48"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/icon48.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"128"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icons/icon128.png"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"default_popup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"popup/index.html"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"default_title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hulk - Change Background to Green"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content_scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"content.js"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">2. <code>popup/index.html</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>改变背景颜色<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>点击下方按钮将当前页面背景色改为绿色<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"changeColor"</span>&gt;</span>改变颜色<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">3. <code>popup/style.css</code></h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">250px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, sans-serif;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
}

<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">text-align</span>: center;
}

<span class="hljs-selector-tag">button</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4CAF50</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#45a049</span>;
}
</code></pre>
<h3 data-id="heading-11">4. <code>popup/script.js</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'changeColor'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 向当前标签页发送消息</span>
  chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">query</span>({ <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">currentWindow</span>: <span class="hljs-literal">true</span> }, <span class="hljs-function">(<span class="hljs-params">tabs</span>) =&gt;</span> {
    chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">sendMessage</span>(tabs[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>, { <span class="hljs-attr">action</span>: <span class="hljs-string">'changeBackgroundColor'</span> });
  });
});
</code></pre>
<h3 data-id="heading-12">5. <code>content.js</code></h3>
<pre><code class="hljs language-ini" lang="ini">// 监听来自 popup 的消息
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =&gt; {
  if (<span class="hljs-attr">request.action</span> === <span class="hljs-string">'changeBackgroundColor'</span>) {
    <span class="hljs-attr">document.body.style.backgroundColor</span> = <span class="hljs-string">'green'</span><span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">五、Vibe Coding 的协作要点总结</h2>
<h3 data-id="heading-14">✅ 成功的关键：提供清晰上下文</h3>
<ul>
<li>如果只说“做个改背景色的插件”，Trae 可能遗漏 popup 结构或权限配置。</li>
<li>但当我们提供<strong>交互步骤 + 目录结构 + 设计意图</strong>，生成的代码几乎可直接运行。</li>
</ul>
<h3 data-id="heading-15">✅ 开发者的新角色</h3>
<ul>
<li>
<p><strong>不是写代码的人，而是“vibe 架构师”</strong></p>
</li>
<li>
<p>负责：</p>
<ul>
<li>定义用户旅程（Step1 → Step2）</li>
<li>绘制线框图（哪怕手绘拍照）</li>
<li>编写结构化需求（避免模糊描述）</li>
<li>审查 AI 生成的逻辑是否符合预期</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">✅ 耐心打磨“vibe”</h3>
<p>第一次生成可能不完美？没关系！</p>
<ul>
<li>补充说明：“按钮要居中”、“不要修改字体颜色”</li>
<li>Trae 会基于反馈迭代优化</li>
</ul>
<p>这正是 Vibe Coding 的精髓：<strong>通过持续对话，让 AI 理解你的“感觉”</strong> 。</p>
<hr/>
<h2 data-id="heading-17">六、如何测试 Hulk 扩展？</h2>
<ol>
<li>打开 Chrome → <code>chrome://extensions/</code></li>
<li>开启「开发者模式」</li>
<li>点击「加载已解压的扩展程序」，选择 <code>hulk-extension</code> 文件夹</li>
<li>访问任意网页，点击 Hulk 图标</li>
<li>点击“改变颜色”按钮 → 背景变绿！</li>
</ol>
<hr/>
<h2 data-id="heading-18">七、延伸思考：Vibe Coding 的未来</h2>
<ul>
<li><strong>复杂产品也能这样开发吗？</strong><br/>
当然！只要拆解清楚模块（登录、数据展示、设置页），每个模块都可用同样方式协作。</li>
<li><strong>是否还需要学编程？</strong><br/>
需要，但重点变了：从语法细节 → 系统设计 + 上下文表达能力。</li>
<li><strong>文档即产品</strong><br/>
在 Vibe Coding 中，一份好的 PRD（产品需求文档）可能比 1000 行代码更有价值。</li>
</ul>
<hr/>
<h2 data-id="heading-19">结语</h2>
<p>通过这次 Hulk 扩展的开发，我们体验了 <strong>Vibe Coding 的核心理念</strong>：</p>
<blockquote>
<p><strong>用清晰的文档和设计，引导 AI 生成可靠代码；人类专注创造与监督，而非重复劳动。</strong></p>
</blockquote>
<p>现在，轮到你了——<br/>
拿起你的设计稿，写下你的需求，和 Trae 一起，Vibe 出下一个产品吧！</p>
<hr/>
<blockquote>
<p>🌱 <strong>提示</strong>：本文本身就是一个“vibe 文档”——如果你把这篇文章喂给 Trae，并说“请按此文实现 Hulk 扩展”，它就能生成全部代码。这就是 Vibe Coding 的力量。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ajax 数据请求学习笔记]]></title>    <link>https://juejin.cn/post/7571704212850917427</link>    <guid>https://juejin.cn/post/7571704212850917427</guid>    <pubDate>2025-11-12T14:57:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571704212850917427" data-draft-id="7571704212850901043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ajax 数据请求学习笔记"/> <meta itemprop="keywords" content="前端,JavaScript,代码规范"/> <meta itemprop="datePublished" content="2025-11-12T14:57:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UIUV"/> <meta itemprop="url" content="https://juejin.cn/user/1036168457093483"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ajax 数据请求学习笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1036168457093483/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UIUV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:57:27.000Z" title="Wed Nov 12 2025 14:57:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是 Ajax？</h2>
<p>Ajax（Asynchronous JavaScript and XML）是一种在不重新加载整个页面的前提下，通过 JavaScript 异步向服务器请求数据并更新部分网页内容的技术。尽管名字中包含 XML，但在现代 Web 开发中，Ajax 更常用于请求和处理 <strong>JSON</strong> 格式的数据。</p>
<p>Ajax 的核心价值在于：<strong>实现页面的局部刷新，提升用户体验与性能</strong>。用户无需等待整页重载，即可获取最新数据并动态渲染到界面上。</p>
<hr/>
<h2 data-id="heading-1">二、Ajax 的基本工作流程</h2>
<p>使用原生 JavaScript 实现 Ajax 请求，主要依赖 <code>XMLHttpRequest</code>（简称 XHR）对象。其标准流程如下：</p>
<ol>
<li><strong>实例化</strong>：创建 <code>XMLHttpRequest</code> 对象；</li>
<li><strong>配置请求</strong>：调用 <code>.open(method, url, async)</code> 方法；</li>
<li><strong>发送请求</strong>：调用 <code>.send()</code> 方法；</li>
<li><strong>监听状态变化</strong>：通过 <code>onreadystatechange</code> 事件处理响应；</li>
<li><strong>解析与渲染</strong>：当请求完成且成功时，解析响应数据并更新 DOM。</li>
</ol>
<h3 data-id="heading-2">1. 实例化 XMLHttpRequest</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
</code></pre>
<p>此时 <code>xhr.readyState</code> 为 <code>0</code>，表示“请求未初始化”。</p>
<h3 data-id="heading-3">2. 打开请求（open）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">xhr.<span class="hljs-keyword">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>参数说明：</p>
<ul>
<li><code>method</code>：HTTP 方法，如 <code>'GET'</code>、<code>'POST'</code>；</li>
<li><code>url</code>：目标接口地址；</li>
<li><code>async</code>：是否异步（<code>true</code> 为异步，<code>false</code> 为同步，默认为 <code>true</code>）。</li>
</ul>
<p>调用 <code>open()</code> 后，<code>readyState</code> 变为 <code>1</code>（请求已建立）。</p>
<blockquote>
<p>⚠️ 注意：<strong>同步请求会阻塞主线程</strong>，导致页面卡顿，现代开发中应避免使用。</p>
</blockquote>
<h3 data-id="heading-4">3. 发送请求（send）</h3>
<pre><code class="hljs language-ini" lang="ini">xhr.send()<span class="hljs-comment">;</span>
</code></pre>
<p>调用后，<code>readyState</code> 进入 <code>2</code>（请求已发送），随后进入 <code>3</code>（服务器处理中），最终到达 <code>4</code>（请求完成）。</p>
<h3 data-id="heading-5">4. 监听状态变化（onreadystatechange）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">xhr.onreadystatechange</span> = function() {
    if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {
        const <span class="hljs-attr">data</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;</span>
        // 渲染数据
    }
}<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>readyState</code>：表示请求的当前状态（0~4）；</li>
<li><code>status</code>：HTTP 状态码，<code>200</code> 表示成功；</li>
<li><code>responseText</code>：服务器返回的原始字符串。</li>
</ul>
<p>只有当 <code>readyState === 4</code> 且 <code>status === 200</code> 时，才表示请求成功完成，可以安全处理数据。</p>
<hr/>
<h2 data-id="heading-6">三、readyState 状态详解</h2>



































<table><thead><tr><th>状态值</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>未初始化</td><td>尚未调用 <code>open()</code></td></tr><tr><td>1</td><td>已建立</td><td>已调用 <code>open()</code></td></tr><tr><td>2</td><td>已发送</td><td>已调用 <code>send()</code></td></tr><tr><td>3</td><td>正在处理中</td><td>服务器正在返回部分数据</td></tr><tr><td>4</td><td>已完成</td><td>整个请求过程完成，可读取响应</td></tr></tbody></table>
<p>理解这些状态有助于调试网络请求问题，例如判断请求是否卡在发送阶段或服务器无响应。</p>
<hr/>
<h2 data-id="heading-7">四、同步 vs 异步请求</h2>
<p>在示例代码中，若将 <code>open()</code> 的第三个参数设为 <code>false</code>（同步）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">xhr.<span class="hljs-keyword">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">false</span>);
</code></pre>
<p>则 <code>send()</code> 会<strong>阻塞 JavaScript 主线程</strong>，直到服务器返回结果。这意味着：</p>
<ul>
<li>页面无法交互；</li>
<li>后续代码必须等请求完成才能执行；</li>
<li>用户体验极差。</li>
</ul>
<p>因此，<strong>强烈推荐始终使用异步请求（<code>async = true</code>）</strong> ，并通过事件回调处理结果。</p>
<hr/>
<h2 data-id="heading-8">五、实战：渲染 GitHub 组织成员列表</h2>
<p>以下是一个完整的异步 Ajax 示例，用于获取 Lemoncode 组织成员并动态渲染到页面：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;ul <span class="hljs-attr">id</span>=<span class="hljs-string">"members"</span>&gt;&lt;/ul&gt;
&lt;script&gt;
    const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
    xhr.open('GET', 'https://api.github.com/orgs/lemoncode/members', true)<span class="hljs-comment">;</span>
    
    <span class="hljs-attr">xhr.onreadystatechange</span> = function() {
        if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span>) {
            if (<span class="hljs-attr">xhr.status</span> === <span class="hljs-number">200</span>) {
                const <span class="hljs-attr">members</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;</span>
                const <span class="hljs-attr">listHTML</span> = members.map(user =&gt; `&lt;li&gt;<span class="hljs-variable">${user.login}</span>&lt;/li&gt;`).join(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
                document.getElementById('members').<span class="hljs-attr">innerHTML</span> = listHTML<span class="hljs-comment">;</span>
            } else {
                console.error('请求失败，状态码：', xhr.status)<span class="hljs-comment">;</span>
            }
        }
    }<span class="hljs-comment">;</span>
    
    xhr.send()<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<p>该代码实现了：</p>
<ul>
<li>异步请求 GitHub API；</li>
<li>成功后解析 JSON 数据；</li>
<li>使用 <code>map()</code> 和 <code>join()</code> 生成 HTML 字符串；</li>
<li>通过 <code>innerHTML</code> 更新 DOM。</li>
</ul>
<hr/>
<h2 data-id="heading-9">六、Ajax 的局限性与现代替代方案</h2>
<p>尽管 <code>XMLHttpRequest</code> 是 Ajax 的经典实现，但它存在以下问题：</p>
<ul>
<li>语法冗长；</li>
<li>错误处理复杂；</li>
<li>不支持 Promise，难以链式调用。</li>
</ul>
<p>因此，现代开发更倾向于使用：</p>
<ul>
<li><strong><code>fetch()</code> API</strong>：基于 Promise，语法简洁；</li>
<li><strong>Axios</strong>：功能强大的第三方库，支持拦截器、自动转换 JSON 等。</li>
</ul>
<p>例如，使用 <code>fetch</code> 实现相同功能：</p>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
    .then(<span class="hljs-attr">response</span> =&gt; response.json())
    .then(<span class="hljs-attr">members</span> =&gt; {
        const <span class="hljs-attr">html</span> = members.map(u =&gt; `&lt;li&gt;<span class="hljs-variable">${u.login}</span>&lt;/li&gt;`).join(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
        document.getElementById('members').<span class="hljs-attr">innerHTML</span> = html<span class="hljs-comment">;</span>
    })
    .catch(<span class="hljs-attr">err</span> =&gt; console.error(<span class="hljs-string">'请求出错:'</span>, err))<span class="hljs-comment">;</span>
</code></pre>
<p>代码更清晰，且天然支持异步/await。</p>
<hr/>
<h2 data-id="heading-10">七、总结</h2>
<p>Ajax 是前端与后端通信的基石技术。掌握 <code>XMLHttpRequest</code> 的工作原理，有助于深入理解浏览器网络请求机制。虽然现代开发多用 <code>fetch</code> 或 Axios，但 Ajax 的核心思想——<strong>异步、局部更新、事件驱动</strong>——依然贯穿于所有数据交互场景。</p>
<p>通过本次学习，我认识到：</p>
<ul>
<li>异步是 Web 性能的关键；</li>
<li>状态管理（readyState）是调试请求的重要依据；</li>
<li>文档化请求流程（方法、URL、参数、响应格式）能极大提升协作效率；</li>
<li>在 Vibe Coding 时代，清晰描述“我要什么数据、如何展示”，比手写 XHR 更重要。</li>
</ul>
<p>未来，我将在项目中结合 <code>fetch</code> 与错误边界处理，构建更健壮的数据请求层，同时继续夯实底层原理，做到“知其然，更知其所以然”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20251112-问题排查与复盘]]></title>    <link>https://juejin.cn/post/7571695634942345243</link>    <guid>https://juejin.cn/post/7571695634942345243</guid>    <pubDate>2025-11-12T15:11:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571695634942345243" data-draft-id="7571678674145493002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20251112-问题排查与复盘"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T15:11:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张可爱"/> <meta itemprop="url" content="https://juejin.cn/user/2608489519384504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20251112-问题排查与复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2608489519384504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张可爱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:11:35.000Z" title="Wed Nov 12 2025 15:11:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0"><strong>1. 图片无法显示：</strong></h4>
<h5 data-id="heading-1"><strong>问题描述：</strong></h5>
<p>在使用 <code>&lt;img&gt;</code> 标签绑定图片时，图片没有正确显示，尽管路径和格式看起来正确。</p>
<h5 data-id="heading-2"><strong>解决方案：</strong></h5>
<ul>
<li>
<p><strong>未正确注册 <code>data</code> 中的路径变量</strong>：图片路径没有注册为响应式数据，导致无法渲染。</p>
</li>
<li>
<p><strong>解决步骤</strong>：</p>
<ol>
<li>
<p>在 <code>data()</code> 中注册图片路径：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> userTotal <span class="hljs-keyword">from</span> <span class="hljs-string">"@/assets/bg/userTotal.webp"</span>; <span class="hljs-comment">// 确保导入路径正确</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userTotal</span>: userTotal <span class="hljs-comment">// 注册路径</span>
    };
  },
}
</code></pre>
</li>
<li>
<p>在模板中绑定图片：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;img :<span class="hljs-attr">src</span>=<span class="hljs-string">"userTotal"</span> alt=<span class="hljs-string">"用户总数"</span> class=<span class="hljs-string">"user-total-img"</span> /&gt;
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>注意</strong>：检查构建工具配置（如 Vite 或 Webpack），确保图片路径别名（<code>@/assets</code>）能正确解析。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-3"><strong>2. Vue 的警告：</strong></h4>
<h5 data-id="heading-4"><strong>问题描述：</strong></h5>
<p>在 Vue 项目中，控制台出现了警告信息：</p>
<pre><code class="hljs language-markdown" lang="markdown">[<span class="hljs-symbol">Vue warn</span>]: <span class="hljs-link">Extraneous non-props event listeners (goPublish) were passed to &lt;Deploy&gt; but could not be automatically inherited because component renders text nodes.</span>
</code></pre>
<h5 data-id="heading-5"><strong>解决方案：</strong></h5>
<ul>
<li>
<p><strong>警告原因</strong>：Vue 提示你传递了未声明的事件 <code>goPublish</code>。该事件没有被正确处理。</p>
</li>
<li>
<p><strong>解决步骤</strong>：</p>
<ol>
<li>
<p>确保组件 <code>Deploy</code> 中正确定义了 <code>goPublish</code> 事件：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  props: [<span class="hljs-string">'goPublish'</span>], <span class="hljs-comment">// 确保事件传递和监听</span>
}
</code></pre>
</li>
<li>
<p>使用 <code>$emit()</code> 来触发父组件的事件：</p>
<pre><code class="hljs language-bash" lang="bash">&lt;button @click=<span class="hljs-string">"<span class="hljs-variable">$emit</span>('goPublish')"</span>&gt;发布&lt;/button&gt;
</code></pre>
</li>
</ol>
</li>
</ul>
<hr/>
<h4 data-id="heading-6"><strong>3. ReferenceError: require is not defined：</strong></h4>
<h5 data-id="heading-7"><strong>问题描述：</strong></h5>
<p>在执行某些 Node.js 或 Vue 代码时，出现错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">ReferenceError</span>: <span class="hljs-built_in">require</span> is not defined
</code></pre>
<h5 data-id="heading-8"><strong>解决方案：</strong></h5>
<ul>
<li>
<p><strong>错误原因</strong>：该错误通常是由于在浏览器环境中使用了 Node.js 中的 <code>require</code> 方法，浏览器不支持 <code>require</code>。</p>
</li>
<li>
<p><strong>解决步骤</strong>：</p>
<ol>
<li>
<p>使用 <code>import</code> 代替 <code>require</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> userTotal <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/bg/userTotal.webp'</span>; <span class="hljs-comment">// 适应 ES 模块导入</span>
</code></pre>
</li>
<li>
<p>检查构建工具配置，确保模块转换正确。</p>
</li>
</ol>
<p><strong>注意</strong>：如果你在浏览器环境中运行代码，请确保没有直接使用 Node.js 的特性（如 <code>require</code>、<code>module.exports</code> 等）。所有模块应使用 <code>import/export</code> 语法。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-9"><strong>4. 滚动条样式问题：</strong></h4>
<h5 data-id="heading-10"><strong>问题描述：</strong></h5>
<p>在应用中，滚动条样式不符合预期，可能需要隐藏或者自定义滚动条样式。</p>
<h5 data-id="heading-11"><strong>解决方案：</strong></h5>
<ul>
<li>
<p><strong>隐藏滚动条</strong>：使用 CSS 可以隐藏滚动条，或者设置其样式。</p>
</li>
<li>
<p><strong>解决步骤</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.base-div</span> {
  <span class="hljs-attribute">overflow-y</span>: scroll;
  <span class="hljs-attribute">scrollbar-width</span>: none; <span class="hljs-comment">/* Firefox */</span>
  -ms-<span class="hljs-attribute">overflow</span>-style: none; <span class="hljs-comment">/* IE/Edge */</span>
}

<span class="hljs-selector-class">.base-div</span>::-webkit-scrollbar {
  <span class="hljs-attribute">display</span>: none; <span class="hljs-comment">/* Chrome, Safari */</span>
}
</code></pre>
</li>
<li>
<p><strong>设置滚动条样式</strong>：若想定制滚动条样式，可以使用 <code>::-webkit-scrollbar</code> 系列的 CSS 伪元素：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.base-div</span>::-webkit-scrollbar {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span>;
}
<span class="hljs-selector-class">.base-div</span>::-webkit-scrollbar-thumb {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
}
</code></pre>
</li>
</ul>
<hr/>
<h4 data-id="heading-12"><strong>5. 图表显示问题（ECharts）</strong> ：</h4>
<h5 data-id="heading-13"><strong>问题描述：</strong></h5>
<p>在使用 ECharts 渲染图表时，图表的数据显示不正确或者未显示。</p>
<h5 data-id="heading-14"><strong>解决方案</strong>：</h5>
<ul>
<li>
<p><strong>解决步骤</strong>：</p>
<ol>
<li>确保图表的 <code>option</code> 配置正确，并传递给 <code>&lt;scEcharts /&gt;</code> 组件。</li>
<li>检查 ECharts 配置是否完整，特别是 <code>xAxis</code> 和 <code>yAxis</code> 的配置。</li>
<li>确保数据来源无误，可以通过 <code>console.log()</code> 打印数据，查看其是否已正确返回。</li>
</ol>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">this<span class="hljs-selector-class">.userOption</span> = {
  title: {
    text: <span class="hljs-string">"用户总数"</span>,
  },
  xAxis: {
    type: <span class="hljs-string">"category"</span>,
    data: [<span class="hljs-string">"2021-01"</span>, <span class="hljs-string">"2021-02"</span>, <span class="hljs-string">"2021-03"</span>],  // 示例数据
  },
  series: [
    {
      data: [<span class="hljs-number">5</span>, <span class="hljs-number">20</span>, <span class="hljs-number">36</span>],
      type: <span class="hljs-string">"line"</span>,
    },
  ],
};
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-15"><strong>总结</strong></h3>
<p>今天解决了以下几个问题：</p>
<ol>
<li><strong>图片无法显示</strong>：通过注册数据并确保路径正确来解决。</li>
<li><strong>Vue 警告</strong>：解决了未声明事件的警告，使用 <code>emit</code> 触发自定义事件。</li>
<li><strong>require 错误</strong>：更改为 <code>import</code> 语法，以适应浏览器环境。</li>
<li><strong>滚动条样式</strong>：使用 CSS 自定义滚动条样式或隐藏滚动条。</li>
<li><strong>ECharts 配置问题</strong>：确保图表的 <code>option</code> 配置正确并传递到组件中。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Ajax：异步 JavaScript 与 XML 的现代应用]]></title>    <link>https://juejin.cn/post/7571704212850950195</link>    <guid>https://juejin.cn/post/7571704212850950195</guid>    <pubDate>2025-11-12T15:11:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571704212850950195" data-draft-id="7571678674145558538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 深入理解 Ajax：异步 JavaScript 与 XML 的现代应用"/> <meta itemprop="keywords" content="Ajax"/> <meta itemprop="datePublished" content="2025-11-12T15:11:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_一两风"/> <meta itemprop="url" content="https://juejin.cn/user/2250014422739596"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             深入理解 Ajax：异步 JavaScript 与 XML 的现代应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250014422739596/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _一两风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:11:46.000Z" title="Wed Nov 12 2025 15:11:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解 Ajax：异步 JavaScript 与 XML 的现代应用</h2>
<h3 data-id="heading-1">什么是 Ajax？</h3>
<p>Ajax（Asynchronous JavaScript and XML）是一种在不重新加载整个页面的前提下，通过异步请求与服务器交换数据并局部更新页面的技术。它让 Web 应用能够实现更流畅的用户体验，是现代 Web 开发的基础技术之一。</p>
<h4 data-id="heading-2">Ajax 的核心特点</h4>
<ol>
<li><strong>异步通信</strong>：可以在后台与服务器交换数据，不会阻塞用户界面</li>
<li><strong>局部更新</strong>：只更新页面中需要改变的部分，而不是整个页面</li>
<li><strong>动态交互</strong>：JavaScript 可以主动发起 HTTP 请求，实现界面的动态更新</li>
</ol>
<h3 data-id="heading-3">XMLHttpRequest：Ajax 的核心 API</h3>
<p><code>XMLHttpRequest</code>（简称 XHR）是浏览器提供的原生 API，用于在客户端和服务器之间传输数据。虽然名字中包含 "XML"，但实际上它可以处理任何格式的数据，包括 JSON、HTML、文本等。</p>
<h4 data-id="heading-4">基本使用步骤</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建 XMLHttpRequest 实例</span>
<span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

<span class="hljs-comment">// 2. 打开一个请求（指定方法、URL、是否异步）</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 3. 发送请求</span>
xhr.<span class="hljs-title function_">send</span>();

<span class="hljs-comment">// 4. 监听状态变化</span>
xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        <span class="hljs-comment">// 处理数据</span>
    }
}
</code></pre>
<h3 data-id="heading-5">深入理解 readyState</h3>
<p><code>readyState</code> 是 XMLHttpRequest 对象的一个重要属性，它表示请求的当前状态。理解这些状态对于正确处理 Ajax 请求至关重要。</p>
<h4 data-id="heading-6">readyState 的五个状态</h4>



































<table><thead><tr><th>状态值</th><th>状态名称</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>UNSENT</td><td>未初始化。已创建 XMLHttpRequest 对象，但尚未调用 <code>open()</code> 方法</td></tr><tr><td>1</td><td>OPENED</td><td>已打开。已调用 <code>open()</code> 方法，但尚未调用 <code>send()</code> 方法</td></tr><tr><td>2</td><td>HEADERS_RECEIVED</td><td>已接收响应头。已调用 <code>send()</code> 方法，且响应头和响应状态已经可用</td></tr><tr><td>3</td><td>LOADING</td><td>正在接收响应数据。正在接收响应体，<code>responseText</code> 中已经包含部分数据</td></tr><tr><td>4</td><td>DONE</td><td>完成。响应数据接收完成，整个请求过程已经结束</td></tr></tbody></table>
<h4 data-id="heading-7">状态变化流程</h4>
<pre><code class="hljs language-scss" lang="scss">创建对象 (<span class="hljs-number">0</span>) 
  ↓
调用 <span class="hljs-built_in">open</span>() (<span class="hljs-number">1</span>)
  ↓
调用 <span class="hljs-built_in">send</span>() (<span class="hljs-number">2</span>)
  ↓
接收响应头 (<span class="hljs-number">2</span>)
  ↓
接收响应数据 (<span class="hljs-number">3</span>)
  ↓
接收完成 (<span class="hljs-number">4</span>)
</code></pre>
<h4 data-id="heading-8">实际应用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 0 - 未初始化</span>

xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 1 - 已打开</span>

xhr.<span class="hljs-title function_">send</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 1 - 注意：同步情况下可能还是 1</span>

xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 2, 3, 4 - 状态会依次变化</span>
    
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 请求成功完成</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
    }
}
</code></pre>
<h3 data-id="heading-9">HTTP 状态码</h3>
<p>除了 <code>readyState</code>，我们还需要关注 HTTP 状态码（<code>xhr.status</code>），它表示服务器响应的状态。</p>
<h4 data-id="heading-10">常见状态码</h4>
<ul>
<li><strong>200 OK</strong>：请求成功，服务器返回了请求的数据</li>
<li><strong>404 Not Found</strong>：请求的资源未找到</li>
<li><strong>500 Internal Server Error</strong>：服务器内部错误</li>
<li><strong>403 Forbidden</strong>：服务器理解请求，但拒绝执行</li>
<li><strong>401 Unauthorized</strong>：需要身份验证</li>
</ul>
<h4 data-id="heading-11">完整的错误处理</h4>
<pre><code class="hljs language-javascript" lang="javascript">xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) {
        <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
            <span class="hljs-comment">// 成功处理</span>
            <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members-list'</span>).<span class="hljs-property">innerHTML</span> = 
                data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 错误处理</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败，状态码：'</span>, xhr.<span class="hljs-property">status</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-12">同步 vs 异步请求</h3>
<p><code>xhr.open()</code> 方法的第三个参数决定了请求是同步还是异步：</p>
<ul>
<li><strong><code>true</code>（异步）</strong>：请求在后台执行，不会阻塞 JavaScript 代码的执行</li>
<li><strong><code>false</code>（同步）</strong>：请求会阻塞代码执行，直到响应完成（不推荐使用）</li>
</ul>
<h4 data-id="heading-13">异步请求的优势</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 异步请求（推荐）</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">true</span>);
xhr.<span class="hljs-title function_">send</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码会立即执行'</span>); <span class="hljs-comment">// 不会等待请求完成</span>

<span class="hljs-comment">// 同步请求（不推荐）</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">false</span>);
xhr.<span class="hljs-title function_">send</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码会等待请求完成'</span>); <span class="hljs-comment">// 会阻塞执行</span>
</code></pre>
<p><strong>注意</strong>：同步请求会阻塞浏览器，导致用户体验差，现代 Web 开发中应该避免使用。</p>
<h3 data-id="heading-14">实际应用：获取 GitHub 组织成员</h3>
<p>让我们看一个完整的例子，从 GitHub API 获取组织成员列表：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

<span class="hljs-comment">// 打开 GET 请求</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 发送请求</span>
xhr.<span class="hljs-title function_">send</span>();

<span class="hljs-comment">// 监听状态变化</span>
xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 确保请求完成且成功</span>
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 解析 JSON 数据</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        
        <span class="hljs-comment">// 更新 DOM</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members-list'</span>).<span class="hljs-property">innerHTML</span> = 
            data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
    }
}
</code></pre>
<h3 data-id="heading-15">POST 请求示例</h3>
<p>除了 GET 请求，Ajax 也支持 POST、PUT、DELETE 等方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'https://api.example.com/users'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 设置请求头</span>
xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json'</span>);

xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">201</span>) {
        <span class="hljs-keyword">const</span> response = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'创建成功：'</span>, response);
    }
}

<span class="hljs-comment">// 发送 JSON 数据</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'John Doe'</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>
});
xhr.<span class="hljs-title function_">send</span>(data);
</code></pre>
<h3 data-id="heading-16">现代替代方案：Fetch API</h3>
<p>虽然 XMLHttpRequest 仍然被广泛支持，但现代浏览器提供了更优雅的 <code>fetch</code> API：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 fetch API（更现代的方式）</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members-list'</span>).<span class="hljs-property">innerHTML</span> = 
            data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error);
    });

<span class="hljs-comment">// 使用 async/await（更简洁）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchMembers</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>);
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members-list'</span>).<span class="hljs-property">innerHTML</span> = 
            data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error);
    }
}
</code></pre>
<h3 data-id="heading-17">Ajax 的最佳实践</h3>
<ol>
<li><strong>始终使用异步请求</strong>：避免阻塞用户界面</li>
<li><strong>完善的错误处理</strong>：检查 <code>readyState</code> 和 <code>status</code></li>
<li><strong>设置超时</strong>：使用 <code>xhr.timeout</code> 避免长时间等待</li>
<li><strong>处理跨域问题</strong>：了解 CORS 机制</li>
<li><strong>使用现代 API</strong>：优先考虑 <code>fetch</code> API 或 <code>axios</code> 等库</li>
</ol>
<h4 data-id="heading-18">设置超时示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">true</span>);
xhr.<span class="hljs-property">timeout</span> = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 5 秒超时</span>

xhr.<span class="hljs-property">ontimeout</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求超时'</span>);
}

xhr.<span class="hljs-title function_">send</span>();
</code></pre>
<h3 data-id="heading-19">总结</h3>
<p>Ajax 技术彻底改变了 Web 应用的交互方式，让网页能够实现动态、流畅的用户体验。虽然现在有了 <code>fetch</code> API 等更现代的选择，但理解 XMLHttpRequest 的工作原理仍然很重要，因为：</p>
<ol>
<li><strong>兼容性</strong>：许多旧项目仍在使用 XMLHttpRequest</li>
<li><strong>理解原理</strong>：有助于理解现代 API 的设计思路</li>
<li><strong>面试准备</strong>：前端面试中经常涉及这些基础知识</li>
</ol>
<p>掌握 Ajax 的核心概念，包括 <code>readyState</code> 的状态变化、HTTP 状态码的处理，以及异步编程的思想，是成为一名优秀前端开发者的基础。</p>
<hr/>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FXMLHttpRequest" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" ref="nofollow noopener noreferrer">MDN: XMLHttpRequest</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FFetch_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API" ref="nofollow noopener noreferrer">MDN: Fetch API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Fen%2Frest" target="_blank" title="https://docs.github.com/en/rest" ref="nofollow noopener noreferrer">GitHub API 文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写useInterval：告别闭包陷阱，玩转React定时器！]]></title>    <link>https://juejin.cn/post/7571729682678186034</link>    <guid>https://juejin.cn/post/7571729682678186034</guid>    <pubDate>2025-11-12T15:18:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571729682678186034" data-draft-id="7571395183945236489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写useInterval：告别闭包陷阱，玩转React定时器！"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-12T15:18:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FogLetter"/> <meta itemprop="url" content="https://juejin.cn/user/933907109778611"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写useInterval：告别闭包陷阱，玩转React定时器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933907109778611/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FogLetter
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:18:11.000Z" title="Wed Nov 12 2025 15:18:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：被定时器折磨的日常</h2>
<p>大家好，我是前端手艺人FogLetter！不知道大家在React项目中有没有遇到过这样的场景：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 这里总是拿到旧的count值！</span>
      <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); 
    }, <span class="hljs-number">1000</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
  }, []);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>运行这段代码，你会发现计数器永远显示1，然后就停滞不前了。这就是React中经典的<strong>闭包陷阱</strong>问题！</p>
<p>今天，我们就来深入剖析这个问题，并手写一个完美的<code>useInterval</code> Hook，让它成为你工具箱中的利器！</p>
<h3 data-id="heading-1">第一章：为什么会有闭包陷阱？</h3>
<h4 data-id="heading-2">1.1 JavaScript闭包的本质</h4>
<p>在JavaScript中，函数可以"记住"并访问其创建时的词法作用域中的变量，即使函数在其他地方执行。这就是闭包。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    count++;
    <span class="hljs-keyword">return</span> count;
  };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter</span>()); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter</span>()); <span class="hljs-comment">// 2</span>
<span class="hljs-comment">// count变量被"记住"了</span>
</code></pre>
<h4 data-id="heading-3">1.2 React函数组件的执行机制</h4>
<p>React函数组件在每次渲染时都会重新执行，每次执行都会创建新的作用域和新的变量：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> value = count * <span class="hljs-number">2</span>; <span class="hljs-comment">// 每次渲染都会重新计算</span>
  
  <span class="hljs-comment">// 这个函数在每次渲染时都是新的！</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 闭包捕获了当前渲染时的count值</span>
  };
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<h4 data-id="heading-4">1.3 问题的根源</h4>
<p>当我们把定时器放在<code>useEffect</code>中且依赖数组为空时：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// 这里的count是初次渲染时的值：0</span>
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, []); <span class="hljs-comment">// 依赖为空，effect只执行一次</span>
</code></pre>
<p>定时器回调函数<strong>闭包捕获</strong>了初次渲染时的<code>count</code>值（0），所以每次执行都是<code>setCount(0 + 1)</code>，计数器永远显示1。</p>
<h3 data-id="heading-5">第二章：常规解决方案及其缺陷</h3>
<h4 data-id="heading-6">2.1 方案一：添加依赖项</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, [count]); <span class="hljs-comment">// 添加count依赖</span>
</code></pre>
<p><strong>问题</strong>：每次count变化都会重新创建定时器，性能差且可能造成定时器执行间隔不稳定。</p>
<h4 data-id="heading-7">2.2 方案二：使用函数式更新</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>); <span class="hljs-comment">// 使用函数式更新</span>
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, []);
</code></pre>
<p><strong>这个方案其实可以工作</strong>，但它有局限性：只能解决状态更新问题，如果回调函数中需要访问其他props或状态，还是会遇到闭包问题。</p>
<h4 data-id="heading-8">2.3 方案三：使用useReducer</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">return</span> state + <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, <span class="hljs-number">0</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">dispatch</span>();
    }, <span class="hljs-number">1000</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
  }, []);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>问题</strong>：代码复杂度增加，对于简单场景显得太重。</p>
<h3 data-id="heading-9">第三章：手写完美的useInterval Hook</h3>
<h4 data-id="heading-10">3.1 核心思路：useRef + 依赖分离</h4>
<p>让我们来看看如何实现一个既优雅又强大的<code>useInterval</code>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">callback, delay</span>) {
  <span class="hljs-comment">// 使用useRef保存回调函数</span>
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
  
  <span class="hljs-comment">// 单独监听callback变化，只更新引用</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);
  
  <span class="hljs-comment">// 单独管理定时器，依赖delay</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// delay为null时暂停</span>
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      savedCallback.<span class="hljs-property">current</span>?.();
    };
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, [delay]);
}
</code></pre>
<h4 data-id="heading-11">3.2 设计亮点解析</h4>
<h5 data-id="heading-12">3.2.1 使用useRef打破闭包限制</h5>
<p><code>useRef</code>返回一个可变的ref对象，其<code>.current</code>属性被初始化为传入的参数。这个对象在组件的整个生命周期内持续存在，不会因为重新渲染而改变。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
<span class="hljs-comment">// savedCallback.current 永远指向最新的回调函数</span>
</code></pre>
<h5 data-id="heading-13">3.2.2 依赖分离策略</h5>
<p>我们将逻辑拆分为两个独立的<code>useEffect</code>：</p>
<ul>
<li><strong>第一个useEffect</strong>：只负责更新回调函数的引用</li>
<li><strong>第二个useEffect</strong>：只负责管理定时器的生命周期</li>
</ul>
<p>这样做的妙处在于：</p>
<ul>
<li>回调函数更新时不会重启定时器</li>
<li>delay变化时自动调整定时器间隔</li>
<li>delay为null时自动暂停</li>
</ul>
<h5 data-id="heading-14">3.2.3 灵活的暂停机制</h5>
<p>通过判断<code>delay === null</code>来实现暂停，这种设计比维护一个<code>isRunning</code>状态更加直观：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useInterval</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>),
  running ? <span class="hljs-number">1000</span> : <span class="hljs-literal">null</span> <span class="hljs-comment">// 简洁明了！</span>
);
</code></pre>
<h4 data-id="heading-15">3.3 完整实现与类型定义</h4>
<p>对于TypeScript用户，我们可以添加完整的类型定义：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span>, delay: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span></span>) {
  <span class="hljs-keyword">const</span> savedCallback = useRef&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;();
  
  <span class="hljs-comment">// 记住最新的回调</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);
  
  <span class="hljs-comment">// 设置定时器</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      savedCallback.<span class="hljs-property">current</span>?.();
    };
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, [delay]);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useInterval;
</code></pre>
<h3 data-id="heading-16">第四章：实战应用场景</h3>
<h4 data-id="heading-17">4.1 基础计数器</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> useInterval <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useInterval'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [running, setRunning] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-title function_">useInterval</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>),
    running ? <span class="hljs-number">1000</span> : <span class="hljs-literal">null</span>
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setRunning(!running)}&gt;
        {running ? 'Pause' : 'Start'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(0)}&gt;Reset<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-18">4.2 倒计时组件</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Countdown</span>(<span class="hljs-params">{ initialSeconds = <span class="hljs-number">60</span> }</span>) {
  <span class="hljs-keyword">const</span> [seconds, setSeconds] = <span class="hljs-title function_">useState</span>(initialSeconds);
  <span class="hljs-keyword">const</span> [isRunning, setIsRunning] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useInterval</span>(
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (seconds &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">setSeconds</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev - <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">setIsRunning</span>(<span class="hljs-literal">false</span>);
      }
    },
    isRunning ? <span class="hljs-number">1000</span> : <span class="hljs-literal">null</span>
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>剩余时间: {seconds}秒<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsRunning(!isRunning)}&gt;
        {isRunning ? '暂停' : '开始'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
        setSeconds(initialSeconds);
        setIsRunning(false);
      }}&gt;重置<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-19">4.3 轮播图组件</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Carousel</span>(<span class="hljs-params">{ images }</span>) {
  <span class="hljs-keyword">const</span> [currentIndex, setCurrentIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [autoPlay, setAutoPlay] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-title function_">useInterval</span>(
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCurrentIndex</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (prev + <span class="hljs-number">1</span>) % images.<span class="hljs-property">length</span>);
    },
    autoPlay ? <span class="hljs-number">3000</span> : <span class="hljs-literal">null</span>
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
      <span class="hljs-attr">className</span>=<span class="hljs-string">"carousel"</span>
      <span class="hljs-attr">onMouseEnter</span>=<span class="hljs-string">{()</span> =&gt;</span> setAutoPlay(false)}
      onMouseLeave={() =&gt; setAutoPlay(true)}
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{images[currentIndex]}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"轮播图"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"indicators"</span>&gt;</span>
        {images.map((_, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{index</span> === <span class="hljs-string">currentIndex</span> ? '<span class="hljs-attr">active</span>' <span class="hljs-attr">:</span> ''}
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCurrentIndex(index)}
          /&gt;
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-20">第五章：进阶技巧与最佳实践</h3>
<h4 data-id="heading-21">5.1 支持立即执行</h4>
<p>有时候我们需要定时器立即执行一次，然后再按间隔执行：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useInterval</span>(<span class="hljs-params">callback, delay, immediate = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
  <span class="hljs-keyword">const</span> hasExecuted = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
    hasExecuted.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 重置执行状态</span>
  }, [callback]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (immediate &amp;&amp; !hasExecuted.<span class="hljs-property">current</span>) {
      savedCallback.<span class="hljs-property">current</span>?.();
      hasExecuted.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      savedCallback.<span class="hljs-property">current</span>?.();
      hasExecuted.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
    };

    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, [delay, immediate]);
}
</code></pre>
<h4 data-id="heading-22">5.2 精确控制执行次数</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useIntervalWithLimit</span>(<span class="hljs-params">callback, delay, limit = <span class="hljs-literal">Infinity</span></span>) {
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
  <span class="hljs-keyword">const</span> executionCount = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (executionCount.<span class="hljs-property">current</span> &lt; limit) {
        savedCallback.<span class="hljs-property">current</span>?.();
        executionCount.<span class="hljs-property">current</span> += <span class="hljs-number">1</span>;
      }
    };

    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearInterval</span>(id);
      executionCount.<span class="hljs-property">current</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重置计数</span>
    };
  }, [delay, limit]);
}
</code></pre>
<h4 data-id="heading-23">5.3 性能优化建议</h4>
<ol>
<li>
<p><strong>避免在回调函数中创建新对象</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ 不推荐：每次都会创建新对象</span>
<span class="hljs-title function_">useInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> newData = { count, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() };
  <span class="hljs-title function_">setData</span>(newData);
}, <span class="hljs-number">1000</span>);

<span class="hljs-comment">// ✅ 推荐：使用函数式更新</span>
<span class="hljs-title function_">useInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
    ...prev,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
  }));
}, <span class="hljs-number">1000</span>);
</code></pre>
</li>
<li>
<p><strong>合理设置delay</strong></p>
<ul>
<li>对于频繁更新的场景，考虑使用<code>requestAnimationFrame</code></li>
<li>对于精度要求不高的场景，可以适当增大间隔</li>
</ul>
</li>
</ol>
<h3 data-id="heading-24">第六章：扩展思考</h3>
<h4 data-id="heading-25">6.1 与其他Hook的对比</h4>





























<table><thead><tr><th>Hook</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><code>useInterval</code></td><td>周期性任务</td><td>简单直观，功能完善</td><td>需要手动实现</td></tr><tr><td><code>setTimeout</code>递归</td><td>需要动态调整间隔的任务</td><td>灵活性高</td><td>可能造成调用栈问题</td></tr><tr><td><code>requestAnimationFrame</code></td><td>动画、高频更新</td><td>性能好，与屏幕刷新同步</td><td>不适合长时间间隔任务</td></tr></tbody></table>
<h4 data-id="heading-26">6.2 实现useTimeout</h4>
<p>基于同样的思路，我们可以实现<code>useTimeout</code>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useTimeout</span>(<span class="hljs-params">callback, delay</span>) {
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">tick</span> = (<span class="hljs-params"/>) =&gt; {
      savedCallback.<span class="hljs-property">current</span>?.();
    };
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setTimeout</span>(tick, delay);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(id);
  }, [delay]);
}
</code></pre>
<h3 data-id="heading-27">总结</h3>
<p>通过手写<code>useInterval</code> Hook，我们不仅解决了一个具体的业务问题，更重要的是深入理解了React Hooks的工作原理和闭包机制。</p>
<p><strong>关键要点回顾：</strong></p>
<ol>
<li><strong>useRef是打破闭包限制的利器</strong> - 它提供在组件生命周期内持久化的可变值</li>
<li><strong>依赖分离是优化性能的关键</strong> - 不同的effect负责不同的职责</li>
<li><strong>null是暂停定时器的优雅方案</strong> - 比维护布尔状态更直观</li>
<li><strong>清理函数必不可少</strong> - 防止内存泄漏</li>
</ol>
<p>这个自定义Hook体现了React Hooks设计的精髓：<strong>逻辑复用、关注点分离、声明式编程</strong>。掌握了这些原理，你就能写出更加优雅和健壮的React代码。</p>
<p>希望这篇笔记对你有帮助！如果你有更好的实现方案或者有趣的应用场景，欢迎在评论区分享讨论～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 学习笔记：组件通信（Props / 自定义事件）与插槽（Slot）全解析]]></title>    <link>https://juejin.cn/post/7571678388954382355</link>    <guid>https://juejin.cn/post/7571678388954382355</guid>    <pubDate>2025-11-12T15:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678388954382355" data-draft-id="7571648135585841195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Vue 学习笔记：组件通信（Props / 自定义事件）与插槽（Slot）全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T15:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户9242625700731"/> <meta itemprop="url" content="https://juejin.cn/user/2054336951356680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Vue 学习笔记：组件通信（Props / 自定义事件）与插槽（Slot）全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2054336951356680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户9242625700731
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:17:20.000Z" title="Wed Nov 12 2025 15:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为 Vue 初学者，<strong>组件通信</strong>和<strong>插槽</strong>是实现组件复用、解耦的核心技能。这篇笔记会把这两个知识点拆解成 “一看就懂” 的形式，既是自己的学习总结，也希望能帮到同样入门的同学～</p>
<h2 data-id="heading-0">一、组件通信：父子组件的数据传递</h2>
<p>Vue 中组件是独立的，想要实现 “组件之间传数据”，核心有两种场景：<strong>父传子（Props）</strong>  和 <strong>子传父（自定义事件）</strong> 。</p>
<h3 data-id="heading-1">1. 父传子：Props 传递数据（单向数据流）</h3>
<p>父组件通过<code>props</code>把数据传递给子组件，子组件只能 “读取” 不能 “直接修改”（Vue 的单向数据流规则）。</p>
<p><strong>示例：父组件<code>ComponentA</code>向子组件<code>ComponentB</code>传值</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentA.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>ComponentA<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 第一步：在子组件标签上绑定要传递的数据 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"title"</span> <span class="hljs-attr">:age</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">:names</span>=<span class="hljs-string">"names"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ComponentB</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./ComponentB.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ComponentB</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"父组件传递的标题"</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>,
      <span class="hljs-attr">names</span>: [<span class="hljs-string">"iwen"</span>, <span class="hljs-string">"ime"</span>]
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentB.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ age }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item,index) of names"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>{{ item }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 第二步：子组件通过props选项声明接收的数据</span>
  <span class="hljs-attr">props</span>: [<span class="hljs-string">"title"</span>, <span class="hljs-string">"age"</span>, <span class="hljs-string">"names"</span>]
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>进阶：Props 的类型、默认值、必填校验</strong>实际开发中，我们可以给<code>props</code>加 “类型限制、默认值、必填校验”，让组件更健壮。</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentB.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    <span class="hljs-comment">// 限制title的类型可以是字符串、数字、数组、对象</span>
    <span class="hljs-attr">title</span>: {
      <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Number</span>, <span class="hljs-title class_">Array</span>, <span class="hljs-title class_">Object</span>],
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 表示title是必填项</span>
    },
    <span class="hljs-comment">// 限制age的类型是数字，默认值为0</span>
    <span class="hljs-attr">age</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
    },
    <span class="hljs-comment">// 数组/对象的默认值必须用工厂函数返回</span>
    <span class="hljs-attr">names</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,
      <span class="hljs-title function_">default</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [<span class="hljs-string">"默认名称"</span>]
      }
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. 子传父：自定义事件（$emit）传递数据</h3>
<p>子组件通过<code>this.$emit("事件名", 数据)</code>触发自定义事件，父组件通过<code>@事件名</code>监听并接收数据。</p>
<p><strong>示例：子组件<code>Child</code>向父组件<code>ComponentEvent</code>传值</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Child.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Child<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"clickEventHandle"</span>&gt;</span>传递数据给父组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">msg</span>: <span class="hljs-string">"子组件的私有数据~"</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">clickEventHandle</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 触发自定义事件，并传递数据msg</span>
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">"someEvent"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">msg</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentEvent.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>组件事件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 监听子组件的someEvent事件，触发getHandle方法 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> @<span class="hljs-attr">someEvent</span>=<span class="hljs-string">"getHandle"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>父组件接收的子组件数据：{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">Child</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">message</span>: <span class="hljs-string">""</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">getHandle</span>(<span class="hljs-params">data</span>) {
      <span class="hljs-comment">// 接收子组件传递的数据，并赋值给message</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = data
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">二、插槽（Slot）：让组件更灵活的 “内容插槽”</h2>
<p>插槽的作用是<strong>让父组件可以向子组件 “注入” 自定义内容</strong>，实现组件的灵活复用。Vue 的插槽分为三种：<strong>默认插槽、具名插槽、作用域插槽</strong>。</p>
<h3 data-id="heading-4">1. 默认插槽：最简单的 “内容注入”</h3>
<p>子组件用<code>&lt;slot&gt;&lt;/slot&gt;</code>预留一个 “内容坑位”，父组件在子组件标签内写的内容会自动填入这个坑位。</p>
<p><strong>示例：父组件<code>App</code>向子组件<code>SlotsTow</code>注入内容</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SlotsTow.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Slots续集<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 预留默认插槽的坑位 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">SlotsTow</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 父组件在这里写的内容，会被注入到子组件的slot中 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我是父组件注入的内容<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>插槽让组件变得更灵活！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">SlotsTow</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SlotsTow</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/SlotsTow.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">SlotsTow</span> }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>默认内容：</strong>  如果父组件没注入内容，子组件可以给插槽设置 “默认内容”。</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SlotsTow.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Slots续集<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 没内容时显示“默认内容” --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span>父组件没传内容，我是默认显示的文字~<span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">2. 具名插槽：多个 “命名坑位” 的精准注入</h3>
<p>当子组件需要<strong>多个插槽坑位</strong>时，用<code>name</code>给每个插槽命名，父组件用<code>v-slot:名称</code>（或<code>#名称</code>）指定内容注入到哪个坑位。</p>
<p><strong>示例：子组件<code>SlotsAttr</code>有<code>header</code>和<code>main</code>两个具名插槽</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SlotsAttr.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>具名插槽示例<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 命名为header的插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 命名为main的插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"main"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">SlotsAttr</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 用v-slot:header指定内容注入到header插槽 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot:header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>这是头部插槽的内容<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 用#main指定内容注入到main插槽（#是v-slot的简写） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是主体插槽的内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">SlotsAttr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SlotsAttr</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/SlotsAttr.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">SlotsAttr</span> }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">3. 作用域插槽：子组件向父组件 “反向传值” 的插槽</h3>
<p>子组件在插槽中绑定数据（<code>slotProps</code>），父组件可以 “接收并使用” 这些数据，实现 <strong>“子传父式的插槽内容定制”</strong>。</p>
<p><strong>示例：子组件<code>SlotsAttr</code>向父组件传递<code>msg</code>和<code>demo</code>数据</strong></p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SlotsAttr.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>作用域插槽示例<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 插槽中绑定数据（msg和demo） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"header"</span> <span class="hljs-attr">:msg</span>=<span class="hljs-string">"slotMsg"</span> <span class="hljs-attr">:demo</span>=<span class="hljs-string">"slotDemo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"main"</span> <span class="hljs-attr">:msg</span>=<span class="hljs-string">"slotMsg"</span> <span class="hljs-attr">:demo</span>=<span class="hljs-string">"slotDemo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">slotMsg</span>: <span class="hljs-string">"子组件传递的消息"</span>,
      <span class="hljs-attr">slotDemo</span>: <span class="hljs-string">"子组件传递的演示数据"</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">SlotsAttr</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 接收子组件传递的slotProps，并使用其中的msg和demo --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>头部插槽：{{ slotProps.msg }} - {{ slotProps.demo }}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">main</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>主体插槽：{{ slotProps.msg }} - {{ slotProps.demo }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">SlotsAttr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SlotsAttr</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/SlotsAttr.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">SlotsAttr</span> }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>渲染作用域：</strong>  插槽内容是在<strong>父组件的作用域</strong>中定义的，所以可以直接访问父组件的数据；而插槽的<code>slotProps</code>是子组件传递的，父组件通过<code>v-slot</code>接收后才能使用。</p>
<h2 data-id="heading-7">三、总结：组件通信与插槽核心要点</h2>



































<table><thead><tr><th>知识点</th><th>核心作用</th><th>关键规则 / 技巧</th></tr></thead><tbody><tr><td>Props（父传子）</td><td>父组件向子组件传递数据</td><td>子组件只能读不能直接改；支持类型、默认值、必填校验；数组 / 对象默认值需用工厂函数</td></tr><tr><td>自定义事件（子传父）</td><td>子组件向父组件传递数据 / 事件</td><td>子组件用<code>this.$emit("事件名", 数据)</code>触发；父组件用<code>@事件名</code>监听</td></tr><tr><td>默认插槽</td><td>父组件向子组件注入单个自定义内容</td><td>子组件用<code>&lt;slot&gt;&lt;/slot&gt;</code>预留坑位；父组件在子组件标签内写内容即可注入</td></tr><tr><td>具名插槽</td><td>父组件向子组件注入多个命名的自定义内容</td><td>子组件用<code>name</code>给插槽命名；父组件用<code>v-slot:名称</code>（或<code>#名称</code>）指定注入位置</td></tr><tr><td>作用域插槽</td><td>子组件向父组件传递数据，父组件定制插槽内容</td><td>子组件在插槽中绑定数据（<code>slotProps</code>）；父组件用<code>v-slot="slotProps"</code>接收并使用</td></tr></tbody></table>
<p>掌握这些知识点后，Vue 组件的复用性和灵活性会大幅提升～ 后续再深入学习 Vuex、Pinia 等状态管理工具，就能应对更复杂的组件通信场景了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite：下一代前端构建工具深度解析与实践指南]]></title>    <link>https://juejin.cn/post/7571662618055999514</link>    <guid>https://juejin.cn/post/7571662618055999514</guid>    <pubDate>2025-11-12T15:25:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618055999514" data-draft-id="7571678674145640458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite：下一代前端构建工具深度解析与实践指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T15:25:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晴天丨"/> <meta itemprop="url" content="https://juejin.cn/user/2101921963057256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite：下一代前端构建工具深度解析与实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921963057256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晴天丨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:25:42.000Z" title="Wed Nov 12 2025 15:25:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在前端开发领域，构建工具的发展从未停止。从早期的 Grunt、Gulp 到 Webpack，再到现在的 Vite，每一次变革都带来了开发体验的质的飞跃。Vite 凭借其极速的启动时间和热更新能力，正在迅速成为现代前端开发的首选工具。本文将深入解析 Vite 的核心原理、使用技巧和最佳实践。</p>
<h2 data-id="heading-1">什么是 Vite？</h2>
<p>Vite（法语意为"快速"）是由 Vue.js 作者尤雨溪开发的下一代前端构建工具。它主要由两部分组成：</p>
<ul>
<li><strong>开发服务器</strong>：基于原生 ES 模块，提供丰富的内置功能</li>
<li><strong>构建命令</strong>：使用 Rollup 打包代码，输出高度优化的静态资源</li>
</ul>
<h2 data-id="heading-2">为什么选择 Vite？</h2>
<h3 data-id="heading-3">传统构建工具的痛点</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 在 Webpack 中，启动大型项目可能需要几十秒甚至几分钟</span>
<span class="hljs-comment">// 每次修改代码，热更新也需要几秒钟</span>

<span class="hljs-comment">// 这是因为 Webpack 需要：</span>
<span class="hljs-number">1.</span> 构建完整的依赖图
<span class="hljs-number">2.</span> 打包所有模块
<span class="hljs-number">3.</span> 启动开发服务器
</code></pre>
<h3 data-id="heading-4">Vite 的优势</h3>
<p>bash</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 使用 Vite 启动项目</span>
npm create vite@latest <span class="hljs-keyword">my</span>-project
cd <span class="hljs-keyword">my</span>-project
npm install
npm run dev

<span class="hljs-comment"># ⚡ 通常在几毫秒内完成启动！</span>
</code></pre>
<h2 data-id="heading-5">核心原理解析</h2>
<h3 data-id="heading-6">基于 ES Modules 的开发服务器</h3>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 传统方式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/dist/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Vite 方式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Vite 利用浏览器原生支持 ES 模块的特性，只在浏览器请求时按需编译和提供源码。</p>
<h3 data-id="heading-7">依赖预构建</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Vite 会对第三方依赖进行预构建</span>
<span class="hljs-comment">// 将 CommonJS/UMD 转换为 ESM</span>
<span class="hljs-comment">// 合并多个小文件，减少请求数量</span>

<span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  optimizeDeps: {
    include: [<span class="hljs-string">'lodash-es'</span>, <span class="hljs-string">'axios'</span>]
  }
}
</code></pre>
<h2 data-id="heading-8">项目创建与配置</h2>
<h3 data-id="heading-9">快速创建项目</h3>
<p>bash</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 使用 npm</span>
npm create vite@latest

<span class="hljs-comment"># 使用 yarn</span>
yarn create vite

<span class="hljs-comment"># 使用 pnpm</span>
pnpm create vite

<span class="hljs-comment"># 指定模板</span>
npm create vite@latest <span class="hljs-keyword">my</span>-react-app -- --template react-ts
</code></pre>
<h3 data-id="heading-10">配置文件详解</h3>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite.config.js</span>
import { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
import vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
import path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  // 插件配置
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_ invoke__">vue</span>()],
  
  // 开发服务器配置
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, // 自动打开浏览器
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>
      }
    }
  },
  
  // 构建配置
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>,
    <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">manualChunks</span>: {
          <span class="hljs-attr">vendor</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>],
          <span class="hljs-attr">utils</span>: [<span class="hljs-string">'lodash-es'</span>, <span class="hljs-string">'axios'</span>]
        }
      }
    }
  },
  
  // 路径别名
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_ invoke__">resolve</span>(__dirname, <span class="hljs-string">'./src'</span>),
      <span class="hljs-string">'~'</span>: path.<span class="hljs-title function_ invoke__">resolve</span>(__dirname, <span class="hljs-string">'./src/components'</span>)
    }
  },
  
  // CSS 配置
  <span class="hljs-attr">css</span>: {
    <span class="hljs-attr">preprocessorOptions</span>: {
      <span class="hljs-attr">scss</span>: {
        <span class="hljs-attr">additionalData</span>: `@import <span class="hljs-string">"@/styles/variables.scss"</span>;`
      }
    }
  }
})
</code></pre>
<h2 data-id="heading-11">核心功能特性</h2>
<h3 data-id="heading-12">1. 极速热更新（HMR）</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite 提供了完整的 HMR API</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>) {
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./module.js'</span>, <span class="hljs-function">(<span class="hljs-params">newModule</span>) =&gt;</span> {
    <span class="hljs-comment">// 模块更新时的回调</span>
    newModule.<span class="hljs-title function_">update</span>()
  })
  
  <span class="hljs-comment">// 自定义事件</span>
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'custom-event'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'自定义事件:'</span>, data)
  })
}
</code></pre>
<h3 data-id="heading-13">2. 环境变量处理</h3>
<p>javascript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// .env</span>
<span class="hljs-variable constant_">VITE_API_URL</span>=<span class="hljs-attr">https</span>:<span class="hljs-comment">//api.example.com</span>
<span class="hljs-variable constant_">VITE_APP_TITLE</span>=<span class="hljs-title class_">My</span> <span class="hljs-title class_">App</span>

<span class="hljs-comment">// .env.development</span>
<span class="hljs-variable constant_">VITE_API_URL</span>=<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3000</span>

<span class="hljs-comment">// 在代码中使用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_API_URL</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_APP_TITLE</span>)

<span class="hljs-comment">// 类型提示 (env.d.ts)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportMetaEnv</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">VITE_API_URL</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">VITE_APP_TITLE</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
<h3 data-id="heading-14">3. 静态资源处理</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 直接引入图片</span>
<span class="hljs-keyword">import</span> logoUrl <span class="hljs-keyword">from</span> <span class="hljs-string">'./logo.png'</span>
<span class="hljs-keyword">const</span> img = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'img'</span>)
img.<span class="hljs-property">src</span> = logoUrl

<span class="hljs-comment">// URL 查询参数用于资源版本控制</span>
<span class="hljs-keyword">import</span> logoUrl <span class="hljs-keyword">from</span> <span class="hljs-string">'./logo.png?t=123456'</span>

<span class="hljs-comment">// 将小资源转换为 base64</span>
<span class="hljs-keyword">import</span> inlineSvg <span class="hljs-keyword">from</span> <span class="hljs-string">'./icon.svg?raw'</span>

<span class="hljs-comment">// 获取资源路径</span>
<span class="hljs-keyword">const</span> imagePath = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./image.png'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>).<span class="hljs-property">href</span>
</code></pre>
<h3 data-id="heading-15">4. CSS 和预处理器</h3>
<p>scss</p>
<pre><code class="hljs language-css" lang="css">// 支持所有主流预处理器
<span class="hljs-comment">/* style.scss */</span>
<span class="hljs-keyword">@import</span> <span class="hljs-string">'@/styles/variables'</span>;

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background</span>: $primary-color;
  
  // CSS Modules
  &amp;:<span class="hljs-built_in">global</span>(.disabled) {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>;
  }
}
</code></pre>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Component.module.scss'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">{styles.button}</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  }
}
</code></pre>
<h3 data-id="heading-16">5. TypeScript 集成</h3>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"useDefineForClassFields"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"DOM"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM.Iterable"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowJs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"forceConsistentCasingInFileNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"isolatedModules"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.d.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.tsx"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"references"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./tsconfig.node.json"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-17">插件生态系统</h2>
<h3 data-id="heading-18">常用插件推荐</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> vueJsx <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue-jsx'</span>
<span class="hljs-keyword">import</span> legacy <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-legacy'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VitePWA</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-pwa'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">vueJsx</span>(),
    <span class="hljs-title function_">legacy</span>({
      <span class="hljs-attr">targets</span>: [<span class="hljs-string">'defaults'</span>, <span class="hljs-string">'not IE 11'</span>]
    }),
    <span class="hljs-title class_">VitePWA</span>({
      <span class="hljs-attr">registerType</span>: <span class="hljs-string">'autoUpdate'</span>,
      <span class="hljs-attr">workbox</span>: {
        <span class="hljs-attr">globPatterns</span>: [<span class="hljs-string">'**/*.{js,css,html,ico,png,svg}'</span>]
      }
    })
  ]
})
</code></pre>
<h3 data-id="heading-19">自定义插件开发</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// my-plugin.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'my-plugin'</span>,
    
    <span class="hljs-comment">// 转换 index.html</span>
    <span class="hljs-title function_">transformIndexHtml</span>(<span class="hljs-params">html</span>) {
      <span class="hljs-keyword">return</span> html.<span class="hljs-title function_">replace</span>(
        <span class="hljs-string">'&lt;title&gt;'</span>,
        <span class="hljs-string">'&lt;title&gt;My Custom Title | '</span>
      )
    },
    
    <span class="hljs-comment">// 配置服务器</span>
    <span class="hljs-title function_">configureServer</span>(<span class="hljs-params">server</span>) {
      server.<span class="hljs-property">middlewares</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Request:'</span>, req.<span class="hljs-property">url</span>)
        <span class="hljs-title function_">next</span>()
      })
    },
    
    <span class="hljs-comment">// 转换代码</span>
    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.custom'</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`export default <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(code)}</span>`</span>
      }
    }
  }
}
</code></pre>
<h2 data-id="heading-20">性能优化实践</h2>
<h3 data-id="heading-21">1. 依赖优化</h3>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite.config.js</span>
export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">include</span>: [
      <span class="hljs-string">'vue'</span>,
      <span class="hljs-string">'vue-router'</span>,
      <span class="hljs-string">'pinia'</span>,
      <span class="hljs-string">'axios'</span>,
      <span class="hljs-string">'lodash-es'</span>
    ],
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'@vue/composition-api'</span>]
  }
})
</code></pre>
<h3 data-id="heading-22">2. 代码分割</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 动态导入实现代码分割</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HeavyComponent</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span>
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HeavyComponent.vue'</span>)
)

<span class="hljs-comment">// 使用注释指定 chunk 名称</span>
<span class="hljs-keyword">const</span> utils = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(
  <span class="hljs-comment">/* webpackChunkName: "utils" */</span> <span class="hljs-string">'./utils.js'</span>
)
</code></pre>
<h3 data-id="heading-23">3. 构建分析</h3>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 安装 rollup-plugin-visualizer</span>
import { visualizer } <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-visualizer'</span>

export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_ invoke__">visualizer</span>({
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'dist/stats.html'</span>,
      <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>
    })
  ]
})
</code></pre>
<h2 data-id="heading-24">高级用法</h2>
<h3 data-id="heading-25">1. 多页面应用</h3>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
export default defineConfig({
  build: {
    rollupOptions: {
      <span class="hljs-selector-tag">input</span>: {
        <span class="hljs-selector-tag">main</span>: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'index.html'</span>),
        admin: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'admin.html'</span>),
        about: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'about.html'</span>)
      }
    }
  }
})
</code></pre>
<h3 data-id="heading-26">2. 库模式开发</h3>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
export default defineConfig({
  build: {
    lib: {
      entry: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'lib/main.js'</span>),
      name: <span class="hljs-string">'MyLib'</span>,
      fileName: (format) =&gt; `my-lib.${format}<span class="hljs-selector-class">.js</span>`
    },
    rollupOptions: {
      external: [<span class="hljs-string">'vue'</span>],
      output: {
        globals: {
          vue: <span class="hljs-string">'Vue'</span>
        }
      }
    }
  }
})
</code></pre>
<h3 data-id="heading-27">3. SSR 支持</h3>
<p>javascript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite.config.js</span>
export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">ssr</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">input</span>: <span class="hljs-string">'src/entry-server.js'</span>,
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">dir</span>: <span class="hljs-string">'dist/server'</span>
      }
    }
  }
})
</code></pre>
<h2 data-id="heading-28">常见问题与解决方案</h2>
<h3 data-id="heading-29">1. 路径别名不生效</h3>
<p>javascript</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 确保在 tsconfig.json 和 vite.config.js 中都配置了</span>
<span class="hljs-comment">// vite.config.js</span>
resolve: {
  <span class="hljs-keyword">alias</span>: {
    <span class="hljs-string">'@'</span>: path.resolve(__dirname, <span class="hljs-string">'./src'</span>)
  }
}

<span class="hljs-comment">// tsconfig.json</span>
{
  <span class="hljs-string">"compilerOptions"</span>: {
    <span class="hljs-string">"paths"</span>: {
      <span class="hljs-string">"@/*"</span>: [<span class="hljs-string">"./src/*"</span>]
    }
  }
}
</code></pre>
<h3 data-id="heading-30">2. 热更新失效</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检查是否为原生 ES 模块</span>
<span class="hljs-comment">// 确保没有使用 CommonJS 语法</span>
<span class="hljs-keyword">import</span> { method } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span> <span class="hljs-comment">// ✅</span>
<span class="hljs-keyword">const</span> { method } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./module.js'</span>) <span class="hljs-comment">// ❌</span>
</code></pre>
<h3 data-id="heading-31">3. 生产环境资源路径问题</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-function"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title">defineConfig</span><span class="hljs-params">({
  base: <span class="hljs-string">'./'</span>, <span class="hljs-comment">// 相对路径</span>
  <span class="hljs-comment">// 或者</span>
  base: <span class="hljs-string">'/my-project/'</span> <span class="hljs-comment">// 部署到子路径</span>
})</span>
</span></code></pre>
<h2 data-id="heading-32">与其他工具对比</h2>









































<table><thead><tr><th>特性</th><th>Vite</th><th>Webpack</th><th>Snowpack</th></tr></thead><tbody><tr><td>启动时间</td><td>⚡ 极快</td><td>🐢 较慢</td><td>⚡ 快</td></tr><tr><td>热更新</td><td>⚡ 极快</td><td>🐢 较慢</td><td>⚡ 快</td></tr><tr><td>配置复杂度</td><td>简单</td><td>复杂</td><td>简单</td></tr><tr><td>生态成熟度</td><td>良好</td><td>优秀</td><td>一般</td></tr><tr><td>生产构建</td><td>Rollup</td><td>Webpack</td><td>esbuild</td></tr></tbody></table>
<h2 data-id="heading-33">实战示例：完整的 Vite + Vue3 项目</h2>
<p>javascript</p>
<pre><code class="hljs language-css" lang="css">// vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
import { defineConfig } <span class="hljs-selector-tag">from</span> 'vite'
import vue <span class="hljs-selector-tag">from</span> '<span class="hljs-keyword">@vitejs</span>/plugin-vue'
import { createSvgIconsPlugin } <span class="hljs-selector-tag">from</span> 'vite-plugin-svg-icons'
import path <span class="hljs-selector-tag">from</span> 'path'

export default defineConfig({
  plugins: [
    <span class="hljs-built_in">vue</span>(),
    <span class="hljs-built_in">createSvgIconsPlugin</span>({
      iconDirs: [path.<span class="hljs-built_in">resolve</span>(process.<span class="hljs-built_in">cwd</span>(), <span class="hljs-string">'src/icons'</span>)],
      symbolId: <span class="hljs-string">'icon-[dir]-[name]'</span>
    })
  ],
  server: {
    proxy: {
      '/api': {
        target: <span class="hljs-string">'http://localhost:3000'</span>,
        changeOrigin: true,
        rewrite: (path) =&gt; path.<span class="hljs-built_in">replace</span>(/^/api/, <span class="hljs-string">''</span>)
      }
    }
  },
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `
          @import <span class="hljs-string">"@/styles/variables.scss"</span>;
          <span class="hljs-keyword">@import</span> <span class="hljs-string">"@/styles/mixins.scss"</span>;
        `
      }
    }
  }
})
</code></pre>
<h2 data-id="heading-34">结语</h2>
<p>Vite 代表了前端构建工具的未来方向，它的出现极大地提升了开发体验。通过本文的介绍，相信你已经对 Vite 有了全面的了解。无论是新项目启动还是现有项目迁移，Vite 都是一个值得尝试的优秀选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙相对布局RelativeContainer详解]]></title>    <link>https://juejin.cn/post/7571641339688960000</link>    <guid>https://juejin.cn/post/7571641339688960000</guid>    <pubDate>2025-11-12T11:49:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571641339688960000" data-draft-id="7571650164843790370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙相对布局RelativeContainer详解"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-12T11:49:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="金鸿客"/> <meta itemprop="url" content="https://juejin.cn/user/4072230193213886"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙相对布局RelativeContainer详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4072230193213886/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    金鸿客
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:49:13.000Z" title="Wed Nov 12 2025 11:49:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在应用的开发过程中，经常需要设计复杂界面，此时涉及到多个相同或不同组件之间的嵌套。如果布局组件嵌套深度过深，或者嵌套组件数过多，会带来额外的开销。如果在布局的方式上进行优化，就可以有效的提升性能，减少时间开销。 RelativeContainer是一种采用相对布局的容器，支持容器内部的子元素设置相对位置关系，适用于处理界面复杂的场景，对多个子元素进行对齐和排列。子元素可以指定兄弟元素或父容器作为锚点，基于锚点进行相对位置布局。在使用锚点时，需注意子元素的相对位置关系，以避免出现错位或遮挡的情况。相对布局示意图如下
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50eec7d60ed4d91bebc36c1f3fb4f3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=3xQT4gbjpLiXYANeubRmf3lp9l4%3D" alt="img004_1.png" loading="lazy"/></p>
<h2 data-id="heading-0">基本概念</h2>
<ul>
<li>参考边界：设置当前组件的哪个边界对齐到锚点。</li>
<li>锚点：通过锚点设置当前元素基于哪个元素确定位置。</li>
<li>对齐方式：通过对齐方式，设置当前元素是基于锚点的上中下对齐，还是基于锚点的左中右对齐。</li>
<li>链：将一系列组件以首尾相连的方式对齐，可以形成一条链。通过设置链的模式，可以指定链上元素的排列方式。</li>
<li>辅助线：辅助线是在容器内虚拟出的额外水平或垂直锚点，便于统一对齐至某个偏移位置。</li>
<li>屏障：屏障是指容器内一组指定组件在特定方向上的共同最远边界，例如，一组组件下方的屏障，是指这些组件底部边缘中最底部的那个边界。</li>
</ul>
<h2 data-id="heading-1">设置依赖关系</h2>
<h3 data-id="heading-2">设置参考边界</h3>
<p>设置当前组件的哪个边界对齐到锚点。容器内子组件的参考边界区分水平方向和垂直方向。</p>
<ul>
<li>在水平方向上，可以按照起始（left）、居中（middle）或尾端（right）的组件边界与锚点对齐。当设置三个边界时，仅起始（left）和居中（middle）的边界设置生效。</li>
<li>在垂直方向上，可以设置组件边界与锚点对齐，具体包括顶部（top）、居中（center）和底部（bottom）。当设置三个边界时，仅顶部（top）和居中（center）生效。</li>
</ul>
<h3 data-id="heading-3">设置锚点</h3>
<p>锚点设置涉及子元素相对于其父元素或兄弟元素的位置依赖关系。具体而言，子元素可以将其位置锚定到相对布局容器（RelativeContainer）、辅助线（guideline）、屏障（barrier）或其他子元素上。 为了准确定义锚点，RelativeContainer的子元素必须拥有唯一的组件标识（id），用于指定锚点信息。父元素RelativeContainer的标识默认为“<strong>container</strong>”，其他子元素的组件标识（id）则通过id属性设置。</p>
<blockquote>
<p>说明</p>
<ul>
<li>未设置组件标识（id）的组件虽可显示，但无法被其他组件引用为锚点。相对布局容器会为其拼接组件标识，但组件标识（id）的规律无法被应用感知。辅助线（guideline）与屏障（barrier）的组件标识（id）需确保唯一，避免与任何组件冲突。若有重复，遵循组件 &gt; guideline &gt; barrier 的优先级。</li>
<li>组件间设置锚点时应避免形成依赖循环（组件之间设置链除外），依赖循环将导致子组件缺乏定位基准，最终无法绘制。</li>
</ul>
</blockquote>
<h3 data-id="heading-4">设置相对于锚点的对齐位置</h3>
<p>设置了锚点之后，可以通过alignRules属性的align设置相对于锚点的对齐位置。</p>
<ul>
<li>在水平方向上，对齐位置可以设置为HorizontalAlign.Start、HorizontalAlign.Center、HorizontalAlign.End。</li>
<li>在垂直方向上，对齐位置可以设置为VerticalAlign.Top、VerticalAlign.Center、VerticalAlign.Bottom。</li>
</ul>
<h3 data-id="heading-5">子组件位置偏移</h3>
<p>子组件经过相对位置对齐后，可能尚未达到目标位置。开发者可根据需要设置额外偏移（offset）。当使用offset调整位置的组件作为锚点时，对齐位置为设置offset之前的位置。从API Version 11开始，新增了Bias对象，建议API Version 11及以后的版本使用bias来设置额外偏移。示例如下</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
<span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">RelativeContainer</span>() {
      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row1'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> }
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row1"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row2'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
        <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: -<span class="hljs-number">40</span>,
        <span class="hljs-attr">y</span>: -<span class="hljs-number">20</span>
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row2"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row3'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> }
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">y</span>: -<span class="hljs-number">20</span>
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row3"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row4'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#2ca9e0'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">y</span>: -<span class="hljs-number">30</span>
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row4"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row5'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#30c9f7'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">20</span>
      })
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row5"</span>)

      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row6'</span>)
      }
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ff33ffb5'</span>)
      .<span class="hljs-title function_">alignRules</span>({
        <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
        <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
        <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
      })
      .<span class="hljs-title function_">offset</span>({
        <span class="hljs-attr">x</span>: -<span class="hljs-number">15</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">10</span>
      })
      .<span class="hljs-title function_">backgroundImagePosition</span>(<span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Bottom</span>)
      .<span class="hljs-title function_">backgroundImageSize</span>(<span class="hljs-title class_">ImageSize</span>.<span class="hljs-property">Cover</span>)
      .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row6"</span>)
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">50</span> })
    .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#6699FF"</span> })
  }
  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
}
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17bb1edb06aa4f1284fe5b0296ef1835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=ePfEsv6UmyHTyDL62yzp745fHKw%3D" alt="img004_2.png" loading="lazy"/></p>
<h2 data-id="heading-6">组件尺寸</h2>
<p>当同时存在前端页面设置的子组件尺寸和相对布局规则时，子组件的绘制尺寸依据约束规则确定。从API Version 11开始，此规则有所变化，子组件自身设置的尺寸优先级高于相对布局规则中的对齐锚点尺寸。因此，若要使子组件与锚点严格对齐，应仅使用alignRules，避免使用尺寸设置。</p>
<blockquote>
<p>说明</p>
<ul>
<li>根据约束条件和子组件自身的size属性无法确定子组件的大小，此时，不绘制该子组件。</li>
<li>在同一方向上设置两个或更多锚点时，若这些锚点的位置顺序有误，该子组件将被视为大小为0而不予绘制。</li>
</ul>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Row</span>() {
      <span class="hljs-title class_">RelativeContainer</span>() {
        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row1'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row1"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row2'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> },
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row2"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row3'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row3"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row4'</span>)
        }.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#2ca9e0'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row4"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row5'</span>)
        }.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#30c9f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row5"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row6'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ff33ffb5'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> },
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row6"</span>)
        .<span class="hljs-title function_">backgroundImagePosition</span>(<span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Bottom</span>)
        .<span class="hljs-title function_">backgroundImageSize</span>(<span class="hljs-title class_">ImageSize</span>.<span class="hljs-property">Cover</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">50</span> })
      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#6699FF"</span> })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e13895426c6749398d9f9d6839b2a671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=JiAFOMB7hMqXFS8gteX%2BvZo8ezM%3D" alt="img004_3.png" loading="lazy"/></p>
<h2 data-id="heading-7">多个组件形成链</h2>
<p>链的形成依赖于组件之间的关联关系。以组件A和组件B构成的最简水平链为例，其依赖关系为：锚点1 &lt;-- 组件A &lt;---&gt; 组件B --&gt; 锚点2，即A具有left锚点，B具有right锚点，同时A的right锚点与B的HorizontalAlign.Start对齐，B的left锚点与A的HorizontalAlign.End对齐。</p>
<blockquote>
<ul>
<li>链的方向和格式在链头组件的chainMode接口中声明；链内元素的bias属性全部失效，链头元素的bias属性作为整个链的bias生效。链头是指在满足成链规则时链的第一个组件（在水平方向上，从左边开始，镜像语言中从右边开始；在垂直方向上，从上边开始）。</li>
<li>如果链内所有元素的size超出链的锚点约束，超出部分将被均匀分配到链的两侧。在PACKED链中，可以通过Bias设置超出部分的分布。</li>
</ul>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Row</span>() {
      <span class="hljs-title class_">RelativeContainer</span>() {
        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row1'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row1"</span>)
        .<span class="hljs-title function_">chainMode</span>(<span class="hljs-title class_">Axis</span>.<span class="hljs-property">Horizontal</span>, <span class="hljs-title class_">ChainStyle</span>.<span class="hljs-property">SPREAD</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row2'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row3"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row2"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row3'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row3"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row4'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row5"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">center</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Center</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row4"</span>)
        .<span class="hljs-title function_">chainMode</span>(<span class="hljs-title class_">Axis</span>.<span class="hljs-property">Horizontal</span>, <span class="hljs-title class_">ChainStyle</span>.<span class="hljs-property">SPREAD_INSIDE</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row5'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row6"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row5"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row6'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row5"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row4"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row6"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row7'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row8"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">bottom</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row7"</span>)
        .<span class="hljs-title function_">chainMode</span>(<span class="hljs-title class_">Axis</span>.<span class="hljs-property">Horizontal</span>, <span class="hljs-title class_">ChainStyle</span>.<span class="hljs-property">PACKED</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row8'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row7"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row9"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row7"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row8"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row9'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row8"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">right</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"__container__"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row7"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row9"</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">50</span> })
      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#6699FF"</span> })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aea366bad8af420d810a9f968215d634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=JqX8lwJgYJM2pP4lNOxLq7YXit4%3D" alt="img004_4.png" loading="lazy"/></p>
<h2 data-id="heading-8">使用辅助线辅助定位子组件</h2>
<p>辅助线（guideLine）是在容器内虚拟出的额外水平或垂直锚点，便于统一对齐到特定偏移位置，从而避免为每个组件单独编写重复的偏移设置。 辅助线分为垂直（Vertical）和水平（Horizontal）两种：垂直辅助线通过start和end属性指定其距离容器左侧和右侧的距离；水平辅助线通过start和end属性指定其距离容器顶部和底部的距离。</p>
<ul>
<li>如果同时设置了start和end，当两者规则冲突时，仅start属性生效。</li>
<li>若容器在某个方向的尺寸被声明为"auto"，则该方向上的guideLine位置只能使用start属性声明（不允许使用百分比）。</li>
</ul>
<h2 data-id="heading-9">多个组件的屏障</h2>
<p>屏障（barrier）是容器内一组指定组件在指定方向上的公共最远边界。例如，一组组件下方的屏障是它们底部最靠下的位置，可以理解为坐标取min/max。使用屏障可以实现组件不与一组参考组件中的任何一个重叠等效果。 屏障可以有上下左右四个方向。垂直方向（TOP，BOTTOM）的屏障仅能作为组件的水平方向锚点，用作垂直方向锚点时值为0；水平方向（LEFT，RIGHT）的屏障仅能作为组件的垂直方向锚点，用作水平方向锚点时值为0。</p>
<p>如下代码定义了两个屏障，分别是参考组件row1和row2各自右侧边界与底部边界。使用这两个屏障作为row3和row4的锚点，可以方便地避免组件间出现不必要的重叠。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Row</span>() {
      <span class="hljs-title class_">RelativeContainer</span>() {
        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row1'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#a3cf62'</span>)
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row1"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row2'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#00ae9d'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">middle</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row2"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row3'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0a59f7'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"barrier1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">End</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Top</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row3"</span>)

        <span class="hljs-title class_">Row</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'row4'</span>)
        }
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">50</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#2ca9e0'</span>)
        .<span class="hljs-title function_">alignRules</span>({
          <span class="hljs-attr">left</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"row1"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span> },
          <span class="hljs-attr">top</span>: { <span class="hljs-attr">anchor</span>: <span class="hljs-string">"barrier2"</span>, <span class="hljs-attr">align</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-property">Bottom</span> }
        })
        .<span class="hljs-title function_">id</span>(<span class="hljs-string">"row4"</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">50</span> })
      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#6699FF"</span> })
      .<span class="hljs-title function_">barrier</span>([{ <span class="hljs-attr">id</span>: <span class="hljs-string">"barrier1"</span>, <span class="hljs-attr">direction</span>: <span class="hljs-title class_">BarrierDirection</span>.<span class="hljs-property">RIGHT</span>, <span class="hljs-attr">referencedId</span>: [<span class="hljs-string">"row1"</span>, <span class="hljs-string">"row2"</span>] },
        { <span class="hljs-attr">id</span>: <span class="hljs-string">"barrier2"</span>, <span class="hljs-attr">direction</span>: <span class="hljs-title class_">BarrierDirection</span>.<span class="hljs-property">BOTTOM</span>, <span class="hljs-attr">referencedId</span>: [<span class="hljs-string">"row1"</span>, <span class="hljs-string">"row2"</span>] }])
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a85202361c1472f9a002d6deac98c76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6bi_5a6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763552953&amp;x-signature=GB0S9iSTjc9eU%2BW7Y6Qtrgf7fxk%3D" alt="img004_5.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Android】给App添加启动画面——SplashScreen]]></title>    <link>https://juejin.cn/post/7571693273728434212</link>    <guid>https://juejin.cn/post/7571693273728434212</guid>    <pubDate>2025-11-12T15:08:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571693273728434212" data-draft-id="7571657746346704950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Android】给App添加启动画面——SplashScreen"/> <meta itemprop="keywords" content="Java,Android"/> <meta itemprop="datePublished" content="2025-11-12T15:08:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="泥嚎泥嚎"/> <meta itemprop="url" content="https://juejin.cn/user/1197828179492985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Android】给App添加启动画面——SplashScreen
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197828179492985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    泥嚎泥嚎
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T15:08:05.000Z" title="Wed Nov 12 2025 15:08:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Android】给App添加启动画面——SplashScreen</h2>
<h3 data-id="heading-1">引言</h3>
<p>当我们点击应用图标时，经常会看到一瞬间的白屏或黑屏，然后才进入应用界面。这种现象并不是 bug，在 Android 12 之前，这是系统在创建进程到 Activity 完成第一帧绘制之间临时绘制的一个默认窗口，这个窗口的背景就是我们在主题中设置的<code>windowBackground</code>，默认是白色或黑色。</p>
<p>从 Android 12开始，在所有应用的<strong>冷启动</strong>和<strong>温启动</strong>期间，系统会应用 Android 系统的默认启动画面。SplashScreen 在 Android 12 上是强制的，即使什么都不做，应用在 Android 12 上也会自动拥有 SplashScreen 界面。默认情况下，App 的 Launcher 图标会作为 SplashScreen 界面的中央图标，<code>windowBackground</code>属性指定的颜色会作为 SplashScreen 界面的背景颜色，不过这些都可以修改。</p>
<h3 data-id="heading-2">应用启动方式</h3>
<p>应用有三种启动状态：冷启动、温启动和热启动。</p>
<h4 data-id="heading-3">冷启动</h4>
<p>冷启动是指应用进程完全不存在，系统需要从零开始创建整个应用环境。</p>
<p><strong>典型场景</strong>：</p>
<ul>
<li>第一次打开应用</li>
<li>系统杀掉了后台进程（比如内存不足）</li>
<li>用户强制关闭了应用</li>
</ul>
<p>冷启动应用将经历两个阶段：</p>
<p><strong>第一阶段</strong></p>
<blockquote>
<ol>
<li>
<p><strong>加载并启动应用</strong></p>
<ul>
<li>当用户点击应用图标（或某个 Intent 启动入口）时，
系统（ActivityManagerService）会开始加载应用。</li>
<li>系统根据应用的 <code>AndroidManifest.xml</code> 查找入口 Activity。</li>
<li>系统准备启动该应用对应的进程环境。</li>
</ul>
</li>
<li>
<p><strong>显示空白启动窗口</strong></p>
<ul>
<li>
<p>在启动 Activity 之前，为了防止用户看到黑屏或空白延迟，系统会立即显示一个“starting window”（启动窗口）。</p>
</li>
<li>
<p>这个窗口的外观取决于你的应用主题的 <code>windowBackground</code> 属性。</p>
</li>
<li>
<p>如果没有定义，它通常是默认的纯白色背景（这就是经常看到“白屏”的原因）。</p>
</li>
<li>
<p>从 Android 12 开始，这个阶段由系统 SplashScreen 机制接管：会显示应用图标和背景，而不是纯白。</p>
</li>
</ul>
</li>
<li>
<p><strong>创建应用进程</strong></p>
<ul>
<li>从这一刻起，责任开始从“系统”转移到“应用自身”。</li>
</ul>
</li>
</ol>
</blockquote>
<p><strong>第二阶段</strong></p>
<p>系统一旦创建了应用进程，应用进程就要负责做以下的任务</p>
<blockquote>
<ol>
<li>创建 Application 对象</li>
<li>启动主线程</li>
<li>创建主 Activity</li>
<li>填充视图</li>
<li>布局计算</li>
<li>执行初次绘制</li>
</ol>
</blockquote>
<h4 data-id="heading-4">温启动</h4>
<p>应用进程存在，但 Activity 栈被完全清理，需要重新创建主 Activity。温启动会执行冷启动中的部分操作，但比冷启动轻一些，比热启动重一些。</p>
<h4 data-id="heading-5">热启动</h4>
<p>应用进程已经在后台运行，用户重新打开应用。</p>
<h3 data-id="heading-6">启动画面的元素</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/293f94759ee84f1798c5c410e403e6be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOl5ZqO5rOl5ZqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564885&amp;x-signature=5LnGCAtABazj%2BUNwsL99thHc%2F7o%3D" alt="" loading="lazy"/></p>
<p>图上四个区域分别是：</p>
<ol>
<li><strong>中央显示的图标</strong>：必须是矢量可绘制对象。可以指定一个静态图标或动画图标，动画持续时间理论上没有限制，但官方建议不要超过 1 秒，启动画面的目的只是“平滑过渡”，而不是做长时间动画。如果没有显示指定图标，默认使用应用启动器图标。</li>
<li><strong>图标背景</strong>：可选项，用于在标与启动页背景颜色之间增加视觉对比度。如果你的图标颜色太浅或太透明，比如白色图标配白底，就可以使用图标背景。如果图标本身是 Adaptive Icon（自适应图标），系统会自动判断是否显示它的背景层。</li>
<li><strong>遮罩区域</strong>：启动画面中央的图标（前景层）会被按自适应图标规范进行裁剪（mask）。裁剪比例和自适应图标一样图标前景的边界约占总直径的 2/3（即留 1/3 的安全边距）。图标设计时不要画满整个圆，否则会被裁切。这样做的目的是保持视觉一致性，不同 App 的启动图标在 SplashScreen 中尺寸一致，不会显得不协调。</li>
<li><strong>窗口背景</strong>：启动画面的背景是一个<strong>纯色</strong>。不支持渐变或图片填充。如果没有明确指定颜色，系统会使用主题中设置的<code>windowBackground</code>作为默认背景颜色。</li>
</ol>
<h3 data-id="heading-7">SplashScreen API 基本使用</h3>
<h4 data-id="heading-8">环境配置</h4>
<p>首先添加依赖：</p>
<pre><code class="hljs language-java" lang="java">dependencies {
    implementation <span class="hljs-string">'androidx.core:core-splashscreen:1.0.1'</span>
}
</code></pre>
<h4 data-id="heading-9">第一步：创建 SplashScreen 主题</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Theme.App.Starting"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.SplashScreen"</span>&gt;</span><span class="xml">
    <span class="hljs-comment">&lt;!-- 设置背景颜色 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenBackground"</span>&gt;</span>@color/splash_background<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置中心图标 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenAnimatedIcon"</span>&gt;</span>@drawable/ic_launcher_foreground<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置图标动画时长（毫秒） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenAnimationDuration"</span>&gt;</span>1000<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置图标背景（可选） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenIconBackground"</span>&gt;</span>@color/splash_icon_background<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置底部品牌图（不推荐常用） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenBrandingImage"</span>&gt;</span>@drawable/...<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置图标显示策略（Android 13+ 可控制是否强制显示图标） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenBehavior"</span>&gt;</span>icon_preferred<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 设置SplashScreen结束后使用的主题 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"postSplashScreenTheme"</span>&gt;</span>@style/Theme.App<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>这里定义了一个主题，应继承自 <code>Theme.SplashScreen</code>。</p>
<p>下面详细看一下它的属性：</p>
<ol>
<li>
<p><code>android:windowSplashScreenBackground</code></p>
<p>启动画面背景颜色（<strong>必须是单一不透明颜色</strong>）。当系统决定使用 SplashScreen 时，会把该颜色填充为背景。如果未设置该属性，系统会回退去使用 <code>android:windowBackground</code>（但仅当它是纯色时才会被用到）。</p>
</li>
<li>
<p><code>android:windowSplashScreenAnimatedIcon</code></p>
<p>指定启动页中间显示的图标，可以是静态矢量或 <code>AnimatedVectorDrawable</code>（推荐使用矢量）。如果未指定，系统会尝试使用应用的 launcher icon（前提：图标为可识别的 adaptive/vector）。官方建议动画时长 <strong>不要超过 1000 ms</strong>。</p>
</li>
<li>
<p><code>android:windowSplashScreenAnimationDuration</code></p>
<p>表示图标动画的时长（毫秒）。</p>
<p><strong>注意</strong>：这个属性<strong>不控制 SplashScreen 在屏幕上保持的总时长</strong>，它只是便于你在自定义退出动画时读取该时长（通过 API 获取 <code>SplashScreenView.getIconAnimationDuration()</code>），以便做同步动画。它不能让 Splash 显示更久。想延长停留时间应使用 <code>SplashScreen.setKeepOnScreenCondition(...)</code> 或 <code>OnPreDrawListener</code>。</p>
</li>
<li>
<p><code>android:windowSplashScreenIconBackgroundColor</code></p>
<p>图标后面的圆背景色（增强图标与背景的对比）。当图标颜色与窗口背景对比不足时很有用。如果使用的是 adaptive icon（自适应图标），系统会根据对比度决定是否显示背景，也可以明确提供一个颜色。</p>
</li>
<li>
<p><code>android:windowSplashScreenBrandingImage</code></p>
<p>在启动页底部显示一个品牌图片（logo、slogan 等）。官方不推荐频繁使用，因会增加视觉噪音并可能导致布局兼容问题。如果使用，保持图片简单、轻量，避免在不同屏幕比例下被截断。</p>
</li>
<li>
<p><code>android:windowSplashScreenBehavior</code>（Android 13+）</p>
<p>指定是否始终显示图标或遵循系统/Activity 提示的显示策略。</p>
<p>默认行为：如果启动 Activity 指定了 <code>SPLASH_SCREEN_STYLE_ICON</code> 风格，显示图标；否则遵循系统默认行为（系统可能在某些场景下不显示空白图标）。</p>
<p><code>icon_preferred</code>：<strong>优先显示图标</strong>，即便系统默认不会显示空白图标时也强制显示动画图标，避免出现空白启动页。</p>
<p>如果不想出现空白（没有图标）的启动页，且总是希望看到 app 图标，可以把 <code>windowSplashScreenBehavior</code> 设置为 <code>icon_preferred</code>。</p>
</li>
<li>
<p><code>postSplashScreenTheme</code></p>
<p>系统启动完 SplashScreen 后自动切换到的正式主题。</p>
</li>
</ol>
<h4 data-id="heading-10">第二步：在 Manifest 中应用主题</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span>
        <span class="hljs-attr">android:allowBackup</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">android:dataExtractionRules</span>=<span class="hljs-string">"@xml/data_extraction_rules"</span>
        <span class="hljs-attr">android:fullBackupContent</span>=<span class="hljs-string">"@xml/backup_rules"</span>
        <span class="hljs-attr">android:icon</span>=<span class="hljs-string">"@mipmap/ic_launcher"</span>
        <span class="hljs-attr">android:label</span>=<span class="hljs-string">"@string/app_name"</span>
        <span class="hljs-attr">android:roundIcon</span>=<span class="hljs-string">"@mipmap/ic_launcher_round"</span>
        <span class="hljs-attr">android:supportsRtl</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@style/Theme.APP"</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">activity</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MainActivity"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"true"</span>
            <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@style/Theme.APP.starting"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.action.MAIN"</span> /&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.category.LAUNCHER"</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">第三步：在MainActivity中安装SplashScreen</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        SplashScreen.installSplashScreen(<span class="hljs-built_in">this</span>);
	    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
	    setContentView(R.layout.activity_main);
	    ...
	}
    
}
</code></pre>
<h4 data-id="heading-12">installSplashScreen 源码</h4>
<p><strong>静态入口方法</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JvmStatic</span>
<span class="hljs-meta">@NotNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SplashScreen <span class="hljs-title function_">installSplashScreen</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Activity $<span class="hljs-built_in">this</span>$installSplashScreen)</span> {
    <span class="hljs-keyword">return</span> Companion.installSplashScreen($<span class="hljs-built_in">this</span>$installSplashScreen);
}
</code></pre>
<blockquote>
<p>这里是一个简单的委托，实际工作交给Companion对象。</p>
</blockquote>
<p><strong>Companion 对象实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JvmStatic</span>
<span class="hljs-meta">@NotNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> SplashScreen <span class="hljs-title function_">installSplashScreen</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Activity $<span class="hljs-built_in">this</span>$installSplashScreen)</span> {
    Intrinsics.checkNotNullParameter($<span class="hljs-built_in">this</span>$installSplashScreen, <span class="hljs-string">"&lt;this&gt;"</span>);
    <span class="hljs-type">SplashScreen</span> <span class="hljs-variable">splashScreen</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SplashScreen</span>($<span class="hljs-built_in">this</span>$installSplashScreen, (DefaultConstructorMarker)<span class="hljs-literal">null</span>);
    splashScreen.install();
    <span class="hljs-keyword">return</span> splashScreen;
}
</code></pre>
<blockquote>
<p>这里创建了实际的实现对象。</p>
</blockquote>
<p><strong>install() 方法核心逻辑</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">install</span><span class="hljs-params">()</span> {
    <span class="hljs-type">TypedValue</span> <span class="hljs-variable">typedValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypedValue</span>();
    Resources.<span class="hljs-type">Theme</span> <span class="hljs-variable">currentTheme</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.activity.getTheme();
    <span class="hljs-comment">// 解析背景属性</span>
    <span class="hljs-keyword">if</span> (currentTheme.resolveAttribute(attr.windowSplashScreenBackground, typedValue, <span class="hljs-literal">true</span>)) {
        <span class="hljs-built_in">this</span>.backgroundResId = typedValue.resourceId;
        <span class="hljs-built_in">this</span>.backgroundColor = typedValue.data;
    }
     <span class="hljs-comment">// 解析动画图标属性</span>
    <span class="hljs-keyword">if</span> (currentTheme.resolveAttribute(attr.windowSplashScreenAnimatedIcon, typedValue, <span class="hljs-literal">true</span>)) {
        <span class="hljs-built_in">this</span>.icon = currentTheme.getDrawable(typedValue.resourceId);
    }
    <span class="hljs-comment">// 解析图标尺寸属性</span>
    <span class="hljs-keyword">if</span> (currentTheme.resolveAttribute(attr.splashScreenIconSize, typedValue, <span class="hljs-literal">true</span>)) {
        <span class="hljs-built_in">this</span>.hasBackground = typedValue.resourceId == dimen.splashscreen_icon_size_with_background;
    }

    Intrinsics.checkNotNullExpressionValue(currentTheme, <span class="hljs-string">"currentTheme"</span>);
    <span class="hljs-comment">// 设置SplashScreen后的主题</span>
    <span class="hljs-built_in">this</span>.setPostSplashScreenTheme(currentTheme, typedValue);
}
</code></pre>
<p><strong>设置后置主题（关键）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPostSplashScreenTheme</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Resources.Theme currentTheme, <span class="hljs-meta">@NotNull</span> TypedValue typedValue)</span> {
    Intrinsics.checkNotNullParameter(currentTheme, <span class="hljs-string">"currentTheme"</span>);
    Intrinsics.checkNotNullParameter(typedValue, <span class="hljs-string">"typedValue"</span>);
    <span class="hljs-keyword">if</span> (currentTheme.resolveAttribute(attr.postSplashScreenTheme, typedValue, <span class="hljs-literal">true</span>)) {
        <span class="hljs-built_in">this</span>.finalThemeId = typedValue.resourceId;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.finalThemeId != <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">this</span>.activity.setTheme(<span class="hljs-built_in">this</span>.finalThemeId);
        }
    }

}
</code></pre>
<blockquote>
<ul>
<li>查找<code>postSplashScreenTheme</code>属性</li>
<li>如果找到且不为0，调用<code>activity.setTheme(this.finalThemeId)</code></li>
<li>这是 SplashScreen 消失后应用使用的主题</li>
</ul>
</blockquote>
<p><strong>注意</strong>：<code>installSplashScreen()</code>方法最好在<code>super.onCreate()</code>之前调用，必须保证在<code>setContentView()</code>之前调用。</p>
<h4 data-id="heading-13">让启动画面在屏幕中显示更长时间</h4>
<h5 data-id="heading-14">1. 使用 setKeepOnScreenCondition</h5>
<pre><code class="hljs language-java" lang="java">splashScreen.setKeepOnScreenCondition(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanSupplier</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getAsBoolean</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> keepSplashOnScreen;
    }
});
</code></pre>
<blockquote>
<ul>
<li>当传入的条件返回 <code>true</code>时，启动画面会<strong>保持显示</strong></li>
<li>当条件返回 <code>false</code>时，启动画面会<strong>自动消失</strong></li>
</ul>
</blockquote>
<h5 data-id="heading-15">2. 使用 ViewTreeObserver.OnPreDrawListener</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> findViewById(android.R.id.content);
content.getViewTreeObserver().addOnPreDrawListener(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewTreeObserver</span>.OnPreDrawListener() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onPreDraw</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (mViewModel.isReady()) {
                <span class="hljs-comment">// 数据就绪，允许绘制并移除监听器</span>
                content.getViewTreeObserver().removeOnPreDrawListener(<span class="hljs-built_in">this</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;   
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 数据未就绪，取消本次绘制</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  
            }
        }
    });
</code></pre>
<blockquote>
<ul>
<li><strong>OnPreDrawListener</strong> 在View即将绘制前被调用</li>
<li>返回 <code>false</code> 会<strong>取消当前绘制周期</strong></li>
<li>返回 <code>true</code> 允许绘制正常进行</li>
<li>系统会在下一个绘制周期再次尝试，直到返回 <code>true</code></li>
</ul>
</blockquote>
<h4 data-id="heading-16">自定义用于关闭启画面的动画</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取当前SplashScreen并设置退出动画监听器</span>
getSplashScreen().setOnExitAnimationListener(splashScreenView -&gt; {
    <span class="hljs-comment">// 自定义动画</span>
    <span class="hljs-comment">// ...</span>

    <span class="hljs-comment">// 添加动画监听器，处理动画结束后的逻辑</span>
    slideUp.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorListenerAdapter</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationEnd</span><span class="hljs-params">(Animator animation)</span> {
            <span class="hljs-comment">// 动画完成后必须移除SplashScreen视图，释放资源</span>
            splashScreenView.remove();
        }
    });

    <span class="hljs-comment">// 启动动画</span>
    slideUp.start();
});
</code></pre>
<h4 data-id="heading-17">示例</h4>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6520de7d42c34651bd97c72a33cce670~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOl5ZqO5rOl5ZqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763564885&amp;x-signature=zpRxWBBz%2FOLqaO5xWAblwrb6%2FzU%3D" alt="ezgif-7ee68cf45c0fc8b3.gif" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Theme.App.Starting"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.SplashScreen"</span>&gt;</span><span class="xml">
    <span class="hljs-comment">&lt;!-- 设置背景颜色 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenBackground"</span>&gt;</span>#2A94C7<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 设置中心图标 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"windowSplashScreenAnimatedIcon"</span>&gt;</span>@drawable/ic_launcher_foreground<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 设置图标背景 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenIconBackgroundColor"</span>&gt;</span>#1DC3B3<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 设置SplashScreen结束后使用的主题 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"postSplashScreenTheme"</span>&gt;</span>@style/Theme.SplashScreenTest<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">keepSplashOnScreen</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-type">SplashScreen</span> <span class="hljs-variable">splashScreen</span> <span class="hljs-operator">=</span> SplashScreen.installSplashScreen(<span class="hljs-built_in">this</span>);

        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        EdgeToEdge.enable(<span class="hljs-built_in">this</span>);

        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -&gt; {
            <span class="hljs-type">Insets</span> <span class="hljs-variable">systemBars</span> <span class="hljs-operator">=</span> insets.getInsets(WindowInsetsCompat.Type.systemBars());
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);
            <span class="hljs-keyword">return</span> insets;
        });
        <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> findViewById(android.R.id.content);
        splashScreen.setKeepOnScreenCondition(() -&gt; keepSplashOnScreen);
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>().postDelayed(() -&gt; {
            keepSplashOnScreen = <span class="hljs-literal">false</span>;
        }, <span class="hljs-number">1000</span>);

        splashScreen.setOnExitAnimationListener(splashScreenView -&gt; {
            <span class="hljs-type">View</span> <span class="hljs-variable">iconView</span> <span class="hljs-operator">=</span> splashScreenView.getIconView();

            <span class="hljs-type">DisplayMetrics</span> <span class="hljs-variable">displayMetrics</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DisplayMetrics</span>();
            getWindowManager().getDefaultDisplay().getMetrics(displayMetrics);

            <span class="hljs-type">int</span> <span class="hljs-variable">translationDistance</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (-iconView.getRootView().getHeight() * <span class="hljs-number">0.3f</span>);

            <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">floatUp</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(
                    iconView,
                    View.TRANSLATION_Y,
                    <span class="hljs-number">0f</span>,
                    translationDistance
            );
            floatUp.setDuration(<span class="hljs-number">600</span>);
            floatUp.setInterpolator(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DecelerateInterpolator</span>());

            <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">scaleDown</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(iconView, View.SCALE_X, <span class="hljs-number">1f</span>, <span class="hljs-number">0.5f</span>);
            <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">scaleUp</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(iconView, View.SCALE_Y, <span class="hljs-number">1f</span>, <span class="hljs-number">0.5f</span>);
            <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">fadeOut</span> <span class="hljs-operator">=</span> ObjectAnimator.ofFloat(iconView, View.ALPHA, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>);

            <span class="hljs-type">AnimatorSet</span> <span class="hljs-variable">phase2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorSet</span>();
            phase2.playTogether(scaleDown, scaleUp, fadeOut);
            phase2.setDuration(<span class="hljs-number">400</span>);

            <span class="hljs-type">AnimatorSet</span> <span class="hljs-variable">fullAnimation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorSet</span>();
            fullAnimation.playSequentially(floatUp, phase2);

            fullAnimation.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimatorListenerAdapter</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimationEnd</span><span class="hljs-params">(Animator animation)</span> {
                    splashScreenView.remove();
                }
            });

            fullAnimation.start();
        });

    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vLLM主要模块Scheduler详解]]></title>    <link>https://juejin.cn/post/7571662618054819866</link>    <guid>https://juejin.cn/post/7571662618054819866</guid>    <pubDate>2025-11-12T11:12:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571662618054819866" data-draft-id="7571644531608600622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vLLM主要模块Scheduler详解"/> <meta itemprop="keywords" content="源码阅读,算法"/> <meta itemprop="datePublished" content="2025-11-12T11:12:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="萌新彭彭"/> <meta itemprop="url" content="https://juejin.cn/user/2098322219205928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vLLM主要模块Scheduler详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2098322219205928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    萌新彭彭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T11:12:38.000Z" title="Wed Nov 12 2025 11:12:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vLLM主要模块Scheduler详解</h2>
<p>在 vLLM 中有许多的模块，而在这篇文章中，我们主要来介绍 vLLM 中如调度管理prompt的。<br/>
本文章是按照vLLM版本：<strong>v0.11.0</strong></p>
<h3 data-id="heading-1">官方代码入口</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 以下是官方调用代码</span>
<span class="hljs-keyword">from</span> vllm <span class="hljs-keyword">import</span> LLM, SamplingParams
prompts = [
    <span class="hljs-string">"Hello, my name is"</span>,
    <span class="hljs-string">"The president of the United States is"</span>,
    <span class="hljs-string">"The capital of France is"</span>,
    <span class="hljs-string">"The future of AI is"</span>,
]
sampling_params = SamplingParams(temperature=<span class="hljs-number">0.8</span>, top_p=<span class="hljs-number">0.95</span>)
llm = LLM(model=<span class="hljs-string">"facebook/opt-125m"</span>)
outputs = llm.generate(prompts, sampling_params)
</code></pre>
<p>我们从这里为入口了解vLLM是如何调用<strong>scheduler</strong>的。</p>
<pre><code class="hljs language-bash" lang="bash">scheduler是vLLM最重要模块之一，它负责对prompts，KV cache的调度和管理
</code></pre>
<h4 data-id="heading-2">vllm/entrypoints/llm.py</h4>
<p>我们从源码得知<strong>llm.generate</strong>是调用的，vllm/entrypoints/llm.py的<strong>generate</strong>方法，</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLM</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">gennerate</span>(<span class="hljs-params">...</span>) -&gt; <span class="hljs-built_in">list</span>[RequestOutput]:

        ... <span class="hljs-comment"># 省略其他代码</span>

        self._validate_and_add_requests(
            prompts=prompts,
            params=sampling_params,
            use_tqdm=use_tqdm,
            lora_request=lora_request,
            priority=priority,
        )

        outputs = self._run_engine(use_tqdm=use_tqdm)
        <span class="hljs-keyword">return</span> self.engine_class.validate_outputs(outputs, RequestOutput)
</code></pre>
<h4 data-id="heading-3">vllm/v1/engine/llm_engine.py</h4>
<p>再按照<strong>self._validate_and_add_requests</strong>，可以最终看到，vllm/v1/engine/llm_engine.py的<strong>add_request</strong>,我们要关注request的流向。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMEngine</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_request</span>(<span class="hljs-params">...</span>) -&gt; <span class="hljs-literal">None</span>:
        ... <span class="hljs-comment"># 省略其他代码</span>
        
        n = params.n <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(params, SamplingParams) <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span>:
            <span class="hljs-comment"># Make a new RequestState and queue.</span>
            self.output_processor.add_request(request, prompt_text, <span class="hljs-literal">None</span>, <span class="hljs-number">0</span>)
            <span class="hljs-comment"># Add the request to EngineCore.</span>
            self.engine_core.add_request(request)
            <span class="hljs-keyword">return</span>
        ...
</code></pre>
<h4 data-id="heading-4">vllm/v1/engine/core.py</h4>
<p>我们需要查看到<strong>self.engine_core.add_request(request)</strong>，<br/>
最终调用了vllm/v1/engine/core.py中<strong>EngineCore中的add_request方法并在其中调用了self.scheduler.add_request(request)</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># vllm/v1/core/sched/scheduler.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Scheduler</span>(<span class="hljs-title class_ inherited__">SchedulerInterFace</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_request</span>(<span class="hljs-params">self, request: Request</span>) -&gt; <span class="hljs-literal">None</span>:
        self.waiting.add_request(request) <span class="hljs-comment"># 重要代码</span>
        self.requests[request.request_id] = request
        <span class="hljs-keyword">if</span> self.log_stats:
            request.record_event(EngineCoreEventType.QUEUED)
</code></pre>
<p>当获得prompt后，执行这些prompt是<strong>self._run_engine</strong>，最终会调用到vllm/v1/engine/core.py的step()</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EngineCore</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">...</span>):
        ...

        <span class="hljs-keyword">with</span> record_function_or_nullcontext(<span class="hljs-string">"core step: schedule"</span>):
            scheduler_output = self.scheduler.schedule() <span class="hljs-comment"># 重要代码</span>
        ...

</code></pre>
<p>最终选择哪个prompt，执行仍然是调用到<strong>self.scheduler.schedule()</strong></p>
<h4 data-id="heading-5">总结</h4>
<p>从以上的代码可以知道以下重要知识点：</p>
<ol>
<li>上层llm.generate是最终调用到底层的<strong>scheduler</strong>中。</li>
<li>上层的prompt会被包装成request，在V1中<strong>首先存入到waiting中。</strong>
<ul>
<li>waiting是<strong>scheduler</strong>中重要的队列，会根据Policy是FCFS还是PRIORITY，来决定是双端队列还是普通队列</li>
<li>waiting是来存储准备要做推理的prompt，prefill阶段都是来自于此</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">Scheduler.schedule()重要代码详解</h3>
<h4 data-id="heading-7">重要变量概念</h4>
<p>在解释这个算法前，需要了解几个变量，<code>num_token_with_spec, num_computed_tokens, token_budget</code>,<br/>
整个算法都是围绕这些变量变化做的,并且这个算法都是将prompts进行token化，对prompts进行管理.</p>
<pre><code class="hljs language-python" lang="python">num_token_with_spec:<span class="hljs-built_in">len</span>(prompt_token_ids) + <span class="hljs-built_in">len</span>(output_token_ids) + <span class="hljs-built_in">len</span>(spec_token_ids)
token_budget=max_num_batched_tokens,单次迭代处理的最大token数量
num_computed_tokens:被计算过的 KV cache的token数
</code></pre>
<h4 data-id="heading-8">算法整体思路</h4>
<p>首先说说schedule的意图和整体思路：先后看running和waiting中所有request，为他们分配合理的显存blocks,后续会说如何分配block。</p>
<h4 data-id="heading-9">running的调度</h4>
<p>接下来我们来看看源码中是如何处理request的。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">schedule</span>():
    ...
    <span class="hljs-comment"># 首先执行running</span>
    req_index = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> req_index &lt; <span class="hljs-built_in">len</span>(self.running) <span class="hljs-keyword">and</span> token_budget &gt; <span class="hljs-number">0</span>:
        request = self.running[req_index]
        <span class="hljs-comment"># 获取所需新token数</span>
        num_new_tokens = (
            request.num_tokens_with_spec
            + request.num_output_placeholders
            - request.num_computed_tokens
        )
        ...
        <span class="hljs-keyword">with</span> record_function_or_nullcontext(<span class="hljs-string">"schedule: allocate_slots"</span>):
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                <span class="hljs-comment"># 分配显存</span>
                new_blocks = self.kv_cache_manager.allocate_slots(
                    request,
                    num_new_tokens,
                    num_lookahead_tokens=self.num_lookahead_tokens,
                )
                <span class="hljs-comment"># 如果分配成功，退出此循环</span>
                <span class="hljs-keyword">if</span> new_blocks <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                    <span class="hljs-comment"># The request can be scheduled.</span>
                    <span class="hljs-keyword">break</span>

                <span class="hljs-comment"># 分配不成功，按照策略选择一个request，放入waiting队列中</span>
                <span class="hljs-keyword">if</span> self.policy == SchedulingPolicy.PRIORITY:
                    preempted_req = <span class="hljs-built_in">max</span>(
                        self.running,
                        key=<span class="hljs-keyword">lambda</span> r: (r.priority, r.arrival_time),
                    )
                    self.running.remove(preempted_req)
                    <span class="hljs-keyword">if</span> preempted_req <span class="hljs-keyword">in</span> scheduled_running_reqs:
                        scheduled_running_reqs.remove(preempted_req)
                        token_budget += num_scheduled_tokens[
                            preempted_req.request_id
                        ]
                        req_to_new_blocks.pop(preempted_req.request_id)
                        num_scheduled_tokens.pop(preempted_req.request_id)
                        req_index -= <span class="hljs-number">1</span>
                <span class="hljs-keyword">else</span>:
                    preempted_req = self.running.pop()

                self.kv_cache_manager.free(preempted_req)
                self.encoder_cache_manager.free(preempted_req)
                preempted_req.status = RequestStatus.PREEMPTED
                preempted_req.num_computed_tokens = <span class="hljs-number">0</span>
                preempted_req.num_preemptions += <span class="hljs-number">1</span>
                <span class="hljs-comment"># 存入waiting和被抢占队列中</span>
                self.waiting.prepend_request(preempted_req)
                preempted_reqs.append(preempted_req)
        ...
        token_budget -= num_new_tokens
        req_index += <span class="hljs-number">1</span>
    ...
</code></pre>
<h5 data-id="heading-10">算法总结</h5>
<p>running队列中从第一个request开始，目的是为它分配显存block，<br/>
如果blocks不满足条件，从按照一定的策略（FCFS或PRIORITY），从running总挑选一个request，通过释放它的显存，再将被挑出来的request放入waiting队列第一个位置，同时也存放到preempted_reqs中，从而满足一开始的request显存要求，直到满足分配完所有running队列并且token_budget&gt;0</p>
<h4 data-id="heading-11">waiting的调度</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 接着是waiting</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> preempted_reqs:
    <span class="hljs-keyword">while</span> self.waiting <span class="hljs-keyword">and</span> token_budget &gt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.running) == self.max_num_running_reqs:
            <span class="hljs-keyword">break</span>
        <span class="hljs-comment"># 取出第一个但不移除的request</span>
        request = self.waiting.peek_request()
        ...
        <span class="hljs-comment"># 如果new_blocks为空提前结束对waiting的处理</span>
        <span class="hljs-keyword">if</span> new_blocks <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># The request cannot be scheduled.</span>
            <span class="hljs-keyword">break</span>
        ...
        request = self.waiting.pop_request()
        <span class="hljs-comment"># 存入running中</span>
        self.running.append(request)
        ...

</code></pre>
<h5 data-id="heading-12">算法总结</h5>
<p>在新抢占队列preempted_reqs为空时，waiting和token_budget都有满足条件时，取出第一个但不移除的request，为其分配显存block。<br/>
这里request有两类，一是在prefill阶段的token，二是在decode阶段，所以也可看出并没有明显区分这两个阶段，由于running不满足显存条件从而被抢占后被存入waiting中的token，如果当前request分配当显存不够时，就会提前结束对waiting的处理，<br/>
反之则会继续，将当前request从waiting转移到running中。</p>
<h4 data-id="heading-13">num_new_tokens的含义</h4>
<p>以上算法中，对于到底需要分配多少block，有一个共同的公式。</p>
<pre><code class="hljs language-python" lang="python">num_new_tokens = (
    request.num_tokens_with_spec
    + request.num_output_placeholders
    - request.num_computed_tokens
)
request.num_tokens_with_spec:<span class="hljs-built_in">len</span>(prompt_token_ids) + <span class="hljs-built_in">len</span>(output_token_ids) + <span class="hljs-built_in">len</span>(spec_token_ids)

prompt_token_ids:当前prompt转成token数。
output_token_ids:已经生成的回答token数。从prefill开始产生第一个token开始计算，直到decode结束，所以的动态增加的，output_token_ids.append(token_ids)
spec_token_ids:这个与推测解码相关。

request.num_output_placeholders:为输出预先分配的占位符。
request.num_computed_tokens:计算过的（被分配过显存了）token数。

</code></pre>
<p>num_new_tokens代表是需要被分配显存block数。</p>
<p>以上内容基本就是vLLM的调度策略。接下来会对kv cache manager进行学习。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从擦除到恢复：JSON 库是如何“还原” Java 泛型信息的]]></title>    <link>https://juejin.cn/post/7571646669202571306</link>    <guid>https://juejin.cn/post/7571646669202571306</guid>    <pubDate>2025-11-13T00:04:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571646669202571306" data-draft-id="7571391088947822630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从擦除到恢复：JSON 库是如何“还原” Java 泛型信息的"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T00:04:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从擦除到恢复：JSON 库是如何“还原” Java 泛型信息的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:04:27.000Z" title="Thu Nov 13 2025 00:04:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题重现：泛型擦除的困扰</h2>
<p>在实际开发中，我们经常遇到这样的场景：收到一串用户列表的JSON数据，需要反序列化为<code>List&lt;UserDTO&gt;</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"email"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhangsan@example.com"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"李四"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"email"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lisi@example.com"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>如果直接这样写代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
List&lt;UserDTO&gt; userList = objectMapper.readValue(jsonStr, List.class);

System.out.println(userList.get(<span class="hljs-number">0</span>).getName()); <span class="hljs-comment">// 运行时报错！</span>
</code></pre>
<p>运行时会抛出：<code>java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to UserDTO</code></p>
<p>根本原因在于Java的泛型擦除机制。</p>
<h3 data-id="heading-1">泛型擦除机制解析</h3>
<p>Java的泛型是编译期特性，运行时泛型信息会被擦除：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 编译期</span>
List&lt;UserDTO&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

<span class="hljs-comment">// 运行时（JVM看到的样子）</span>
<span class="hljs-type">List</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();  <span class="hljs-comment">// 泛型信息消失了</span>
</code></pre>
<p>由于运行时无法获取<code>List&lt;UserDTO&gt;</code>的类型信息，JSON库只能将其解析为<code>List&lt;Map&gt;</code>。</p>
<h2 data-id="heading-2">主流JSON库的解决方案</h2>
<h4 data-id="heading-3">Jackson：TypeReference方案</h4>
<p>Jackson通过<code>TypeReference</code>保留泛型信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
List&lt;UserDTO&gt; userList = objectMapper.readValue(jsonStr,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {});
</code></pre>
<p><strong>原理分析</strong>：
TypeReference利用匿名内部类的特性，在运行时通过反射获取父类的泛型参数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeReference</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Type _type;

    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TypeReference</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Type</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> getClass().getGenericSuperclass();
        _type = ((ParameterizedType) superClass).getActualTypeArguments()[<span class="hljs-number">0</span>];
    }
}
</code></pre>
<h4 data-id="heading-4">Gson：TypeToken方案</h4>
<p>Gson提供了类似的<code>TypeToken</code>机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();
<span class="hljs-type">Type</span> <span class="hljs-variable">userListType</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeToken</span>&lt;List&lt;UserDTO&gt;&gt;(){}.getType();
List&lt;UserDTO&gt; userList = gson.fromJson(jsonStr, userListType);
</code></pre>
<h4 data-id="heading-5">Fastjson2：TypeReference方案</h4>
<p>Fastjson2作为阿里开源的高性能JSON库，同样支持泛型处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Fastjson2的TypeReference使用</span>
<span class="hljs-type">String</span> <span class="hljs-variable">jsonStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"[{\"id\":1,\"name\":\"张三\"},{\"id\":2,\"name\":\"李四\"}]"</span>;
List&lt;UserDTO&gt; userList = JSON.parseObject(jsonStr,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {});
</code></pre>
<h2 data-id="heading-6">复杂场景处理</h2>
<h4 data-id="heading-7">嵌套泛型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JSON: {"code": 200, "data": [{"id": 1, "name": "张三"}]}</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> T data;
}

<span class="hljs-comment">// Jackson</span>
ApiResponse&lt;List&lt;UserDTO&gt;&gt; response = objectMapper.readValue(
    jsonStr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;ApiResponse&lt;List&lt;UserDTO&gt;&gt;&gt;() {});

<span class="hljs-comment">// Fastjson2</span>
ApiResponse&lt;List&lt;UserDTO&gt;&gt; response = JSON.parseObject(
    jsonStr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;ApiResponse&lt;List&lt;UserDTO&gt;&gt;&gt;() {});
</code></pre>
<h4 data-id="heading-8">Map类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JSON: {"1": {"name": "张三"}, "2": {"name": "李四"}}</span>

<span class="hljs-comment">// Jackson</span>
Map&lt;String, UserDTO&gt; userMap = objectMapper.readValue(
    jsonStr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, UserDTO&gt;&gt;() {});

<span class="hljs-comment">// Fastjson2</span>
Map&lt;String, UserDTO&gt; userMap = JSON.parseObject(
    jsonStr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, UserDTO&gt;&gt;() {});
</code></pre>
<h4 data-id="heading-9">在Spring框架中的应用</h4>
<h5 data-id="heading-10">Feign客户端</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FeignClient(name = "user-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> {
    <span class="hljs-meta">@GetMapping("/api/users")</span>
    ResponseEntity&lt;List&lt;UserDTO&gt;&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">()</span>;
}
</code></pre>
<h5 data-id="heading-11">WebClient</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring WebFlux的WebClient</span>
List&lt;UserDTO&gt; users = webClient.get()
    .uri(<span class="hljs-string">"/api/users"</span>)
    .retrieve()
    .bodyToMono(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterizedTypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {})
    .block();
</code></pre>
<h2 data-id="heading-12">工程实践建议</h2>
<h4 data-id="heading-13">1. 预定义常用类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeReferences</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TypeReference&lt;List&lt;UserDTO&gt;&gt; USER_LIST =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {};

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TypeReference&lt;Map&lt;String, UserDTO&gt;&gt; USER_MAP =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, UserDTO&gt;&gt;() {};

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TypeReference&lt;ApiResponse&lt;List&lt;UserDTO&gt;&gt;&gt; API_USER_LIST =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;ApiResponse&lt;List&lt;UserDTO&gt;&gt;&gt;() {};
}
</code></pre>
<h4 data-id="heading-14">2. 性能优化策略</h4>
<p>在高并发场景下，考虑缓存TypeReference实例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeReferenceCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, TypeReference&lt;?&gt;&gt; CACHE =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; TypeReference&lt;T&gt; <span class="hljs-title function_">get</span><span class="hljs-params">(String key,
            Supplier&lt;TypeReference&lt;T&gt;&gt; supplier)</span> {
        <span class="hljs-keyword">return</span> (TypeReference&lt;T&gt;) CACHE.computeIfAbsent(key, k -&gt; supplier.get());
    }
}
</code></pre>
<h2 data-id="heading-15">常见误区</h2>
<h4 data-id="heading-16">误区1：数组类型误用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：数组类型不需要TypeReference</span>
UserDTO[] users = objectMapper.readValue(jsonStr, UserDTO[].class);

<span class="hljs-comment">// ✅ 正确：数组类型直接传class即可</span>
</code></pre>
<h4 data-id="heading-17">误区2：库混淆</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Jackson的TypeReference</span>
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.type.TypeReference;

<span class="hljs-comment">// Spring的ParameterizedTypeReference</span>
<span class="hljs-keyword">import</span> org.springframework.core.ParameterizedTypeReference;

<span class="hljs-comment">// Fastjson2的TypeReference</span>
<span class="hljs-keyword">import</span> com.alibaba.fastjson2.TypeReference;
</code></pre>
<h4 data-id="heading-18">误区3：异常处理不当</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：不处理异常</span>
<span class="hljs-keyword">try</span> {
    List&lt;UserDTO&gt; users = objectMapper.readValue(jsonStr,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;UserDTO&gt;&gt;() {});
} <span class="hljs-keyword">catch</span> (IOException e) {
    <span class="hljs-comment">// 应该记录日志并采取相应措施</span>
    log.error(<span class="hljs-string">"JSON反序列化失败"</span>, e);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"数据格式错误"</span>);
}
</code></pre>
<h2 data-id="heading-19">技术选型建议</h2>





























<table><thead><tr><th>JSON库</th><th>性能</th><th>特性</th><th>适用场景</th></tr></thead><tbody><tr><td>Jackson</td><td>中等</td><td>功能全面，生态成熟</td><td>Spring全家桶，企业级应用</td></tr><tr><td>Gson</td><td>较低</td><td>API简洁，Android友好</td><td>移动端，轻量级应用</td></tr><tr><td>Fastjson2</td><td>高</td><td>性能优异，功能丰富</td><td>高并发，性能敏感场景</td></tr></tbody></table>
<p><strong>选择建议</strong>：</p>
<ul>
<li>Spring项目：优先Jackson，生态兼容性好</li>
<li>性能要求高：选择Fastjson2</li>
<li>Android开发：考虑Gson</li>
</ul>
<h2 data-id="heading-20">总结</h2>
<p>泛型擦除是Java语言的特性，但通过各JSON库提供的TypeReference/TypeToken机制，我们可以优雅地解决这个问题。掌握不同JSON库的泛型处理方法，能够让我们在实际项目中根据需求做出最合适的技术选型。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[接口开发，咱得整得“优雅”点]]></title>    <link>https://juejin.cn/post/7571749988080435209</link>    <guid>https://juejin.cn/post/7571749988080435209</guid>    <pubDate>2025-11-13T00:02:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571749988080435209" data-draft-id="7571644531609042990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="接口开发，咱得整得“优雅”点"/> <meta itemprop="keywords" content="Java,API,代码规范"/> <meta itemprop="datePublished" content="2025-11-13T00:02:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员晓凡"/> <meta itemprop="url" content="https://juejin.cn/user/1829211147871415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            接口开发，咱得整得“优雅”点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1829211147871415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员晓凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:02:33.000Z" title="Thu Nov 13 2025 00:02:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是晓凡。</p>
<h3 data-id="heading-0">一、为什么要“优雅”？</h3>
<p>产品一句话：  “凡哥，接口明天上线，支持 10w 并发，数据脱敏，不能丢单，不能重复，还要安全。”<br/>
优雅不是装，是为了让自己少加班、少背锅、少掉发。<br/>
今天晓凡就把压箱底的东西掏出来，手把手带你撸一套能扛生产的模板。</p>
<p>为方便阅读，晓凡以Java代码为例给出“核心代码 + 使用姿势”，全部亲测可直接使用。</p>
<h3 data-id="heading-1">二、项目骨架（Spring Boot 3.x）</h3>
<pre><code class="hljs language-arduino" lang="arduino">demo-api
├── src/main/java/com/example/demo
│   ├── config          <span class="hljs-comment">// 配置：限流、加解密、日志等</span>
│   ├── annotation      <span class="hljs-comment">// 自定义注解（幂等、日志、脱敏）</span>
│   ├── aspect          <span class="hljs-comment">// 切面统一干活</span>
│   ├── interceptor     <span class="hljs-comment">// 拦截器（签名、白名单）</span>
│   ├── common          <span class="hljs-comment">// 统一返回、异常、常量</span>
│   ├── controller      <span class="hljs-comment">// 对外暴露</span>
│   ├── service
│   └── DemoApplication.java
└── pom.xml
</code></pre>
<h3 data-id="heading-2">三、 签名（防篡改）</h3>
<blockquote>
<p>对外提供的接口要做签名认证，认证不通过的请求不允许访问接口、提供服务</p>
</blockquote>
<p><strong>思路</strong><br/>
“时间戳 + 随机串 + 业务参数”排好序，最后 <code>APP_SECRET</code> 拼后面，SHA256 一下。<br/>
前后端、第三方都统一，拒绝撕逼。</p>
<p><strong>工具类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignUtil</span> {
    <span class="hljs-comment">/**
     * 生成签名
     * <span class="hljs-doctag">@param</span> map  除 sign 外的所有参数
     * <span class="hljs-doctag">@param</span> secret 分配给你的私钥
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sign</span><span class="hljs-params">(Map&lt;String, String&gt; map, String secret)</span> {
        <span class="hljs-comment">// 1. 参数名升序排列</span>
        Map&lt;String, String&gt; tree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>&lt;&gt;(map);
        <span class="hljs-comment">// 2. 拼成 k=v&amp;k=v</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">join</span> <span class="hljs-operator">=</span> tree.entrySet().stream()
                .map(e -&gt; e.getKey() + <span class="hljs-string">"="</span> + e.getValue())
                .collect(Collectors.joining(<span class="hljs-string">"&amp;"</span>));
        <span class="hljs-comment">// 3. 最后拼密钥</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">raw</span> <span class="hljs-operator">=</span> join + <span class="hljs-string">"&amp;key="</span> + secret;
        <span class="hljs-comment">// 4. SHA256</span>
        <span class="hljs-keyword">return</span> DigestUtils.sha256Hex(raw).toUpperCase();
    }

    <span class="hljs-comment">/** 验签：直接比对即可 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verify</span><span class="hljs-params">(Map&lt;String, String&gt; map, String secret, String requestSign)</span> {
        <span class="hljs-keyword">return</span> sign(map, secret).equals(requestSign);
    }
}
</code></pre>
<p><strong>拦截器统一验签</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Value("${sign.secret}")</span>
    <span class="hljs-keyword">private</span> String secret;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 只拦截接口</span>
        <span class="hljs-keyword">if</span> (!(handler <span class="hljs-keyword">instanceof</span> HandlerMethod)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

        Map&lt;String, String&gt; params = Maps.newHashMap();
        request.getParameterMap().forEach((k, v) -&gt; params.put(k, v[<span class="hljs-number">0</span>]));

        <span class="hljs-type">String</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> params.remove(<span class="hljs-string">"sign"</span>);   <span class="hljs-comment">// 签名不参与计算</span>
        <span class="hljs-keyword">if</span> (!SignUtil.verify(params, secret, sign)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"签名错误"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-3">四、 加密（防泄露）</h3>
<blockquote>
<p>敏感数据在网络传输过程中都应该加密处理</p>
</blockquote>
<p><strong>思路</strong><br/>
<code>AES </code>对称加密，密钥放配置中心，支持一键开关。<br/>
只对敏感字段加密，别一上来全包加密，排查日志想打人。</p>
<p><strong>AES 工具</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AesUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ALG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"AES/CBC/PKCS5Padding"</span>;
    <span class="hljs-comment">// 16 位</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"1234567890abcdef"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IV</span>  <span class="hljs-operator">=</span> <span class="hljs-string">"abcdef1234567890"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String src)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(ALG);
            <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">keySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(KEY.getBytes(), <span class="hljs-string">"AES"</span>);
            <span class="hljs-type">IvParameterSpec</span> <span class="hljs-variable">ivSpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IvParameterSpec</span>(IV.getBytes());
            cipher.init(Cipher.ENCRYPT_MODE, keySpec, ivSpec);
            <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(cipher.doFinal(src.getBytes()));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"加密失败"</span>, e);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">decrypt</span><span class="hljs-params">(String src)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(ALG);
            <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">keySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(KEY.getBytes(), <span class="hljs-string">"AES"</span>);
            <span class="hljs-type">IvParameterSpec</span> <span class="hljs-variable">ivSpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IvParameterSpec</span>(IV.getBytes());
            cipher.init(Cipher.DECRYPT_MODE, keySpec, ivSpec);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(cipher.doFinal(Base64.getDecoder().decode(src)));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"解密失败"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-4">五、 IP 白名单</h3>
<blockquote>
<p>限制请求的IP，增加IP白名单，一般在网关层处理</p>
</blockquote>
<p><strong>配置</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">white:</span>
  <span class="hljs-attr">ips:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">,10.0.0.0/8,192.168.0.0/16</span>
</code></pre>
<p><strong>拦截器</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WhiteListInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Value("#{'${white.ips}'.split(',')}")</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; allowList;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> IpUtil.getIp(request);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">ok</span> <span class="hljs-operator">=</span> allowList.stream()
                .anyMatch(rule -&gt; IpUtil.match(ip, rule));
        <span class="hljs-keyword">if</span> (!ok) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"IP 不允许访问"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-5">六、 限流（Sentinel 注解版）</h3>
<blockquote>
<p>尤其对外提供的接口，无法保障调用频率，应该做限流处理，保障接口服务正常的提供服务</p>
</blockquote>
<p><strong>依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>配置</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">demo-api</span>
<span class="hljs-attr">sentinel:</span>
  <span class="hljs-attr">transport:</span>
    <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span>
</code></pre>
<p><strong>使用姿势</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/order/{id}")</span>
<span class="hljs-meta">@SentinelResource(value = "getOrder",
        blockHandler = "getOrderBlock")</span>
<span class="hljs-keyword">public</span> Result&lt;OrderVO&gt; <span class="hljs-title function_">getOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    <span class="hljs-keyword">return</span> Result.success(orderService.get(id));
}

<span class="hljs-comment">// 限流兜底</span>
<span class="hljs-keyword">public</span> Result&lt;OrderVO&gt; <span class="hljs-title function_">getOrderBlock</span><span class="hljs-params">(Long id, BlockException e)</span> {
    <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"访问太频繁，稍后再试"</span>);
}
</code></pre>
<h3 data-id="heading-6">七、 参数校验（JSR303 + 分组）</h3>
<blockquote>
<p>即使前端做了非空，规范性校验，服务端参数校验任然是必不可少的</p>
</blockquote>
<p><strong>DTO</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreateDTO</span> {
    <span class="hljs-meta">@NotNull(message = "用户 ID 不能为空")</span>
    <span class="hljs-keyword">private</span> Long userId;

    <span class="hljs-meta">@NotEmpty(message = "商品列表不能为空")</span>
    <span class="hljs-meta">@Size(max = 20, message = "一次最多买 20 件")</span>
    <span class="hljs-keyword">private</span> List&lt;Item&gt; items;

    <span class="hljs-meta">@Valid</span>
    <span class="hljs-meta">@NotNull</span>
    <span class="hljs-keyword">private</span> PayInfo payInfo;

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayInfo</span> {
        <span class="hljs-meta">@Min(value = 1, message = "金额必须大于 0")</span>
        <span class="hljs-keyword">private</span> Integer amount;
    }
}
</code></pre>
<p><strong>分组接口</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Create</span> {}
</code></pre>
<p><strong>Controller</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/order")</span>
<span class="hljs-keyword">public</span> Result&lt;Long&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Validated(Create.class)</span> OrderCreateDTO dto)</span> {
    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderService.create(dto);
    <span class="hljs-keyword">return</span> Result.success(orderId);
}
</code></pre>
<h3 data-id="heading-7">八、 统一返回值</h3>
<blockquote>
<p>提供统一的返回结果，不应该返回值五花八门</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> String msg;
    <span class="hljs-keyword">private</span> T data;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">200</span>, <span class="hljs-string">"success"</span>, data);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(String msg)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">500</span>, msg, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/** 返回 200 但提示业务失败 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">bizFail</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String msg)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(code, msg, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">九、 统一异常处理</h3>
<blockquote>
<p>系统报错信息需要提供友好的提示，避免暴露出SQL异常的信息给调用方和客户端。</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);

    <span class="hljs-comment">/** 业务异常 */</span>
    <span class="hljs-meta">@ExceptionHandler(BizException.class)</span>
    <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(BizException e)</span> {
        log.warn(<span class="hljs-string">"业务异常：{}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> Result.bizFail(e.getCode(), e.getMessage());
    }

    <span class="hljs-comment">/** 参数校验失败 */</span>
    <span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>
    <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handleValid</span><span class="hljs-params">(MethodArgumentNotValidException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> e.getBindingResult()
                .getFieldErrors()
                .stream()
                .map(DefaultMessageSourceResolvable::getDefaultMessage)
                .collect(Collectors.joining(<span class="hljs-string">","</span>));
        <span class="hljs-keyword">return</span> Result.fail(msg);
    }

    <span class="hljs-comment">/** 兜底 */</span>
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handleAll</span><span class="hljs-params">(Exception e)</span> {
        log.error(<span class="hljs-string">"系统异常"</span>, e);
        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"服务器开小差"</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">十、 请求日志（切面 + 注解）</h3>
<blockquote>
<p>记录请求的入参日志和返回日志，出问题时方便快速定位。也给运维人员提供了方便</p>
</blockquote>
<p><strong>注解</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ApiLog {}
</code></pre>
<p><strong>切面</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">"api.log"</span>);

    <span class="hljs-meta">@Around("@annotation(apiLog)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint p, ApiLog apiLog)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span>
                (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> attr.getRequest();

        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> req.getRequestURI();
        <span class="hljs-type">String</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> JSON.toJSONString(p.getArgs());

        Object result;
        <span class="hljs-keyword">try</span> {
            result = p.proceed();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"【{}】params={} error={}"</span>, uri, params, e.getMessage());
            <span class="hljs-keyword">throw</span> e;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
            log.info(<span class="hljs-string">"【{}】params={} cost={}ms"</span>, uri, params, cost);
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p><strong>用法</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ApiLog</span>
<span class="hljs-meta">@PostMapping("/order")</span>
<span class="hljs-keyword">public</span> Result&lt;Long&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(...)</span> {}
</code></pre>
<h3 data-id="heading-10">十一、幂等设计（Token &amp; 分布式锁双保险）</h3>
<blockquote>
<p>对于一些涉及到数据一致性的接口一定要做好幂等设计，以防数据出现重复问题</p>
</blockquote>
<p><strong>思路</strong></p>
<ol>
<li>下单前先申请一个幂等 Token（存在 Redis，5 分钟失效）。</li>
<li>下单时带着 Token，后端用 Lua 脚本“判断存在并删除”，原子性保证只能用一次。</li>
<li>对并发极高场景，再补一层分布式锁（Redisson）。</li>
</ol>
<p><strong>代码</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentService</span> {
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redis;

    <span class="hljs-comment">/** 申请 Token */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createToken</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.fastUUID().toString();
        redis.opsForValue().set(<span class="hljs-string">"token:"</span> + token, <span class="hljs-string">"1"</span>,
                Duration.ofMinutes(<span class="hljs-number">5</span>));
        <span class="hljs-keyword">return</span> token;
    }

    <span class="hljs-comment">/** 验证并删除 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"token:"</span> + token;
        <span class="hljs-comment">// 原子删除成功才算用过</span>
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(redis.delete(key));
    }
}
</code></pre>
<p><strong>Controller</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/token")</span>
<span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">getToken</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> Result.success(idempotentService.createToken());
}

<span class="hljs-meta">@PostMapping("/order")</span>
<span class="hljs-meta">@ApiLog</span>
<span class="hljs-keyword">public</span> Result&lt;Long&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> OrderCreateDTO dto,
                           <span class="hljs-meta">@RequestHeader("Idempotent-Token")</span> String token)</span> {
    <span class="hljs-keyword">if</span> (!idempotentService.checkToken(token)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"请勿重复提交"</span>);
    }
    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderService.create(dto);
    <span class="hljs-keyword">return</span> Result.success(orderId);
}
</code></pre>
<h3 data-id="heading-11">十二、限制记录条数（分页 + SQL 保护）</h3>
<blockquote>
<p>对于批量数据接口，一定要限制返回的记录条数，不让会造成恶意攻击导致服务器宕机。</p>
</blockquote>
<p><strong>MyBatis-Plus 分页插件</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">interceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        i.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));
        <span class="hljs-keyword">return</span> i;
    }
}
</code></pre>
<p><strong>Service</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Page&lt;OrderVO&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(OrderListDTO dto)</span> {
    <span class="hljs-comment">// 前端不传默认 10 条，最多 200</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> Math.min(dto.getPageSize(), <span class="hljs-number">200</span>);
    Page&lt;Order&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(dto.getPageNo(), size);
    LambdaQueryWrapper&lt;Order&gt; w = Wrappers.lambdaQuery();
    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(dto.getUserName())) {
        w.like(Order::getUserName, dto.getUserName());
    }
    Page&lt;Order&gt; po = orderMapper.selectPage(page, w);
    <span class="hljs-keyword">return</span> po.convert(o -&gt; BeanUtil.copyProperties(o, OrderVO.class));
}
</code></pre>
<h3 data-id="heading-12">十三、 压测（JMeter + 自带脚本）</h3>
<blockquote>
<p>上线前，务必要对API接口进行压力测试，知道各个接口的qps情况。以便我们能够更好的预估，需要部署多少服务节点，对于API接口的稳定性至关重要。</p>
</blockquote>
<ol>
<li>
<p>起服务：<br/>
<code>java -jar -Xms1g -Xmx1g demo-api.jar</code></p>
</li>
<li>
<p>JMeter 线程组：<br/>
500 线程、Ramp-up 10s、循环 20。</p>
</li>
<li>
<p>观测：</p>
<ul>
<li>Sentinel 控制台看 QPS、RT</li>
<li><code>top -H</code> 看 CPU</li>
<li><code>arthas</code> 火焰图找慢方法</li>
</ul>
</li>
<li>
<p>调优：</p>
<ul>
<li>限流阈值 = 压测 80% 最高水位</li>
<li>发现慢 SQL 加索引</li>
<li>热点数据加本地缓存（Caffeine）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">十四、异步处理</h3>
<blockquote>
<p>如果同步处理业务，耗时会非常长。这种情况下，为了提升API接口性能，我们可以改为异步处理</p>
</blockquote>
<p>下单成功后，发 MQ 异步发短信/扣库存，接口 RT 直接降一半。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Async("asyncExecutor")</span>   <span class="hljs-comment">// 自定义线程池</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendSmsAsync</span><span class="hljs-params">(Long userId, String content)</span> {
    smsService.send(userId, content);
}
</code></pre>
<h3 data-id="heading-14">十五、数据脱敏</h3>
<blockquote>
<p>业务中对与用户的敏感数据，如密码等需要进行脱敏处理</p>
</blockquote>
<p>返回前统一用 Jackson 序列化过滤器，字段加注解就行，代码零侵入。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JsonSerialize(using = SensitiveSerializer.class)</span>
<span class="hljs-meta">@Target(ElementType.FIELD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Sensitive {
    SensitiveType <span class="hljs-title function_">type</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SensitiveType</span> {
    PHONE, ID_CARD, BANK_CARD
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SensitiveSerializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JsonSerializer</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(String value, JsonGenerator g, SerializerProvider p)</span>
            <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (StrUtil.isBlank(value)) {
            g.writeString(value);
            <span class="hljs-keyword">return</span>;
        }
        g.writeString(DesensitizeUtil.desPhone(value));
    }
}
</code></pre>
<h3 data-id="heading-15">十六、完整的接口文档（Knife4j）</h3>
<blockquote>
<p>提供在线接口文档，既方便开发调试接口，也方便运维人员排查错误</p>
</blockquote>
<p><strong>依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-openapi3-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>配置</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">knife4j:</span>
  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">setting:</span>
    <span class="hljs-attr">language:</span> <span class="hljs-string">zh_cn</span>
</code></pre>
<p><strong>启动后访问</strong><br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fdoc.html" target="_blank" title="http://localhost:8080/doc.html" ref="nofollow noopener noreferrer">http://localhost:8080/doc.html</a><br/>
支持在线调试、导出 PDF、Word。</p>
<h3 data-id="heading-16">十七、小结</h3>
<p>接口开发就像炒菜：</p>
<ul>
<li>签名、加密是“食材保鲜”</li>
<li>限流、幂等是“火候掌控”</li>
<li>日志、文档是“摆盘拍照”</li>
</ul>
<p>每道工序做到位，才能端到桌上“色香味”俱全。<br/>
上面 13 段核心代码，直接粘过去就能跑，跑通后再按业务微调，基本能扛 90% 的生产场景。<br/>
祝你在领导问起接口怎么样了？的时候，可以淡淡来一句：<br/>
“接口已经准备好了，压测报告发群里了。”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 6 实战：从“定时器轮询”到 AsyncSequence 的优雅实时推送]]></title>    <link>https://juejin.cn/post/7571751304624701486</link>    <guid>https://juejin.cn/post/7571751304624701486</guid>    <pubDate>2025-11-13T00:05:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571751304624701486" data-draft-id="7559481579463000106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 6 实战：从“定时器轮询”到 AsyncSequence 的优雅实时推送"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-13T00:05:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 6 实战：从“定时器轮询”到 AsyncSequence 的优雅实时推送
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:05:07.000Z" title="Thu Nov 13 2025 00:05:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 iOS 开发中，「实时刷新」需求随处可见：</p>
<ul>
<li>天气卡片 3 秒更新一次</li>
<li>座位状态由绿变红</li>
<li>股价、比分、配送进度……</li>
</ul>
<p>过去我们习惯用 <code>Timer.scheduledTimer</code> 写一个“死循环”，或者把 Combine 的 <code>Timer.publish</code> 拼成管道。</p>
<p>Swift 6 以后，官方把 AsyncSequence 推到 C 位，让我们用“流”的思维解决轮询。</p>
<h2 data-id="heading-1">核心概念速览</h2>



































<table><thead><tr><th>概念</th><th>一句话说明</th><th>本文对应示例</th></tr></thead><tbody><tr><td>AsyncSequence</td><td>一个可以 <code>for await</code> 遍历的异步序列，天生支持结构化并发与自动取消</td><td><code>AsyncStream&lt;WeatherCondition&gt;</code></td></tr><tr><td>AsyncStream</td><td>官方提供的 AsyncSequence 实现，适合“自己写生产端”的场景</td><td><code>pollingStream(api:)</code></td></tr><tr><td>Task.sleep</td><td>非阻塞的异步“睡眠”，不会卡住线程</td><td><code>try? await Task.sleep(for: .seconds(3))</code></td></tr><tr><td>Task.isCancelled</td><td>结构化并发中的“取消标记”，用 while 判断即可优雅退出</td><td><code>while !Task.isCancelled</code></td></tr><tr><td>MainActor.run</td><td>把闭包安全切回主线程，避免 UI 崩溃</td><td><code>await MainActor.run { … }</code></td></tr></tbody></table>
<h2 data-id="heading-2">三种实现逐行拆解</h2>
<h3 data-id="heading-3">基础API</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">WeatherCondition</span>: <span class="hljs-title class_">String</span>, <span class="hljs-title class_">CaseIterable</span> {
    <span class="hljs-keyword">case</span> clear, stormy
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">WeatherResponse</span> {
    <span class="hljs-keyword">let</span> condition: <span class="hljs-type">WeatherCondition</span>
}

<span class="hljs-keyword">actor</span> <span class="hljs-title class_">MockWeatherAPI</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchWeather</span>() <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">WeatherResponse</span> {
        <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(<span class="hljs-number">1</span>))
        <span class="hljs-keyword">return</span> <span class="hljs-type">WeatherResponse</span>(condition: <span class="hljs-type">WeatherCondition</span>.allCases.randomElement()<span class="hljs-operator">!</span>)
    }
}
</code></pre>
<h3 data-id="heading-4">定时器派：Timer.scheduledTimer</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 传统写法，功能可用，但坑最多</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> weather: <span class="hljs-type">WeatherCondition</span> <span class="hljs-operator">=</span> .clear
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> timer: <span class="hljs-type">Timer</span>?
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">api</span>: <span class="hljs-type">MockWeatherAPI</span>) {
        <span class="hljs-comment">// 每 3 秒在主线程回调一次</span>
        timer <span class="hljs-operator">=</span> <span class="hljs-type">Timer</span>.scheduledTimer(withTimeInterval: <span class="hljs-number">3.0</span>, repeats: <span class="hljs-literal">true</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// 必须在异步上下文调用 async 方法，所以包一层 Task</span>
            <span class="hljs-type">Task</span> {
                <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> api.fetchWeather()
                <span class="hljs-comment">// 回到主线程改 UI</span>
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run { <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.weather <span class="hljs-operator">=</span> response.condition }
            }
        }
    }
    
    <span class="hljs-keyword">deinit</span> {
        timer<span class="hljs-operator">?</span>.invalidate()   <span class="hljs-comment">// 忘了写就会内存泄漏</span>
    }
}
</code></pre>
<p>缺点小结</p>
<ol>
<li>忘记 <code>invalidate()</code> 直接泄漏</li>
<li>后台模式下容易“卡”计时器</li>
<li>单元测试必须真跑 3 秒，CI 极慢</li>
</ol>
<h3 data-id="heading-5">Combine 派：Timer.publish + Future</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CombineViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> weather: <span class="hljs-type">WeatherCondition</span> <span class="hljs-operator">=</span> .clear
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cancellables <span class="hljs-operator">=</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">AnyCancellable</span>&gt;()
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">api</span>: <span class="hljs-type">MockWeatherAPI</span>) {
        <span class="hljs-comment">// 1. 主线程每 3 秒发一个日期</span>
        <span class="hljs-type">Timer</span>.publish(every: <span class="hljs-number">3</span>, on: .main, in: .common)
            .autoconnect()
            <span class="hljs-comment">// 2. 把日期换成异步请求</span>
            .flatMap { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
                <span class="hljs-type">Future</span> { promise <span class="hljs-keyword">in</span>
                    <span class="hljs-type">Task</span> {
                        <span class="hljs-keyword">let</span> response <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> api.fetchWeather()
                        promise(.success(response.condition))
                    }
                }
            }
            .receive(on: <span class="hljs-type">RunLoop</span>.main)   <span class="hljs-comment">// 3. 回到主线程</span>
            .assign(to: <span class="hljs-operator">&amp;</span><span class="hljs-variable">$weather</span>)        <span class="hljs-comment">// 4. 直接绑到属性</span>
    }
}
</code></pre>
<p>缺点小结</p>
<ul>
<li>异步/await 与 Combine 混写，心智负担高</li>
<li><code>Future</code> 只能完成一次，不能“持续”发值，需要 <code>flatMap</code> 不断新建</li>
<li>测试仍需跑真时间或使用 <code>TestScheduler</code></li>
</ul>
<h3 data-id="heading-6">AsyncSequence 派：AsyncStream 一统江湖</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> weather: <span class="hljs-type">WeatherCondition</span> <span class="hljs-operator">=</span> .clear
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> task: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt;?
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">api</span>: <span class="hljs-type">MockWeatherAPI</span>) {
        <span class="hljs-comment">// 结构化并发：启动一个子任务</span>
        task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
            <span class="hljs-comment">// 直接 for await 遍历自定义流</span>
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> update <span class="hljs-keyword">in</span> <span class="hljs-keyword">Self</span>.pollingStream(api: api) {
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run { <span class="hljs-keyword">self</span>.weather <span class="hljs-operator">=</span> update }
            }
        }
    }
    
    <span class="hljs-keyword">deinit</span> {
        task<span class="hljs-operator">?</span>.cancel()   <span class="hljs-comment">// 取消即停流，无需手动 invalidate</span>
    }
    
    <span class="hljs-comment">// MARK: - 核心工厂方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">pollingStream</span>(<span class="hljs-params">api</span>: <span class="hljs-type">MockWeatherAPI</span>) -&gt; <span class="hljs-type">AsyncStream</span>&lt;<span class="hljs-type">WeatherCondition</span>&gt; {
        <span class="hljs-type">AsyncStream</span> { continuation <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// 真正生产端跑在子任务</span>
            <span class="hljs-type">Task</span> {
                <span class="hljs-comment">// 如果外部调用者取消 Task，这里会优雅退出</span>
                <span class="hljs-keyword">while</span> <span class="hljs-operator">!</span><span class="hljs-type">Task</span>.isCancelled {
                    <span class="hljs-keyword">let</span> update <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> api.fetchWeather()
                    continuation.yield(update.condition)          <span class="hljs-comment">// 向下游发一个值</span>
                    <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(<span class="hljs-number">3</span>))       <span class="hljs-comment">// 等 3 秒再采</span>
                }
                continuation.finish()                             <span class="hljs-comment">// 告知“我发完了”</span>
            }
        }
    }
}
</code></pre>
<p>优点小结</p>
<p>✅ 取消即停：Task 取消后 <code>while</code> 自动结束</p>
<p>✅ 测试友好：用 <code>AsyncStream.makeAsyncIterator()</code> 可以同步拿值，无需真睡 3 秒</p>
<p>✅ 可组装：后续加 <code>timeout</code>、<code>debounce</code>、<code>buffer</code> 都只要包一层序列</p>
<h3 data-id="heading-7">视图层：SeatAvailabilityView</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SeatAvailabilityView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> condition: <span class="hljs-type">WeatherCondition</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Circle</span>()
            .fill(condition <span class="hljs-operator">==</span> .clear <span class="hljs-operator">?</span> .green : .red)
            .frame(width: <span class="hljs-number">100</span>, height: <span class="hljs-number">100</span>)
            .overlay(<span class="hljs-type">Text</span>(condition.rawValue.capitalized))
    }
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> vm <span class="hljs-operator">=</span> <span class="hljs-type">StreamViewModel</span>(api: <span class="hljs-type">MockWeatherAPI</span>())
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">SeatAvailabilityView</span>(condition: vm.weather)
            .task {          <span class="hljs-comment">// 视图消失时自动取消内部的 Task</span>
                <span class="hljs-comment">// 如果这里还启动额外工作，可一并取消</span>
            }
    }
}
</code></pre>
<h4 data-id="heading-8">取消的 3 个姿势</h4>

























<table><thead><tr><th>场景</th><th>实现方式</th><th>代码片段</th></tr></thead><tbody><tr><td>视图消失</td><td><code>.task</code>修饰符</td><td><code>.task { … }</code>自动在 disappear 时 cancel</td></tr><tr><td>手动取消</td><td><code>deinit</code>调 <code>task?.cancel()</code></td><td>见 StreamViewModel</td></tr><tr><td>超时取消</td><td><code>AsyncThrowingStream</code>+ <code>withTimeout</code></td><td>见下方扩展</td></tr></tbody></table>
<h4 data-id="heading-9">单元测试：Swift Testing 示例</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Testing
<span class="hljs-keyword">@testable</span> <span class="hljs-keyword">import</span> YourModule

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">WeatherPollingTests</span> {
    <span class="hljs-comment">// 验证流能正常 emit 值</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">streamEmitsValues</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
        <span class="hljs-keyword">let</span> api <span class="hljs-operator">=</span> <span class="hljs-type">MockWeatherAPI</span>()
        <span class="hljs-keyword">let</span> stream <span class="hljs-operator">=</span> <span class="hljs-type">StreamViewModel</span>.pollingStream(api: api)
        <span class="hljs-keyword">var</span> iterator <span class="hljs-operator">=</span> stream.makeAsyncIterator()
        <span class="hljs-keyword">let</span> first <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> iterator.next()
        #expect(first <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span>)
    }
    
    <span class="hljs-comment">// 验证外部取消后，循环会退出</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">streamCancellation</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
        <span class="hljs-keyword">let</span> api <span class="hljs-operator">=</span> <span class="hljs-type">MockWeatherAPI</span>()
        <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> <span class="hljs-type">StreamViewModel</span>.pollingStream(api: api) { }
        }
        task.cancel()
        #expect(task.isCancelled)
    }
}
</code></pre>
<p>测试提速技巧</p>
<ul>
<li>把 <code>Task.sleep</code> 抽象成 <code>Clock.sleep</code>，测试注入 <code>ImmediateClock</code> 即可 0 秒跑完</li>
<li>用 <code>AsyncStream.makeAsyncIterator()</code> 可以一条一条拿值，断言更细</li>
</ul>
<h2 data-id="heading-10">扩展场景</h2>
<h3 data-id="heading-11">带超时的轮询</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">AsyncStream</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">withTimeout</span>&lt;<span class="hljs-type">C</span>: <span class="hljs-type">Clock</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">duration</span>: <span class="hljs-type">C</span>.<span class="hljs-type">Instant</span>.<span class="hljs-type">Duration</span>, <span class="hljs-params">clock</span>: <span class="hljs-type">C</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-keyword">Self</span> {
        <span class="hljs-comment">// 用 withThrowingTaskGroup 同时跑“生产值”和“倒计时”</span>
        <span class="hljs-comment">// 哪边先到就取消另一边</span>
    }
}
</code></pre>
<h3 data-id="heading-12">假 WebSocket 一键替换</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MockWebSocket</span>: <span class="hljs-title class_">AsyncSequence</span> {
    <span class="hljs-keyword">typealias</span> <span class="hljs-type">Element</span> <span class="hljs-operator">=</span> <span class="hljs-type">WeatherCondition</span>
    
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AsyncIterator</span>: <span class="hljs-title class_">AsyncIteratorProtocol</span> {
        <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">WeatherCondition</span>? {
            <span class="hljs-comment">// 2 秒随机一个值，模拟帧</span>
            <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(<span class="hljs-number">2</span>))
            <span class="hljs-keyword">return</span> <span class="hljs-type">WeatherCondition</span>.allCases.randomElement()
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeAsyncIterator</span>() -&gt; <span class="hljs-type">AsyncIterator</span> { <span class="hljs-type">AsyncIterator</span>() }
}
</code></pre>
<p>把 <code>for await update in MockWebSocket()</code> 直接塞进 ViewModel，</p>
<p>将来换真 WebSocket 只要改一行，UI 层零改动。</p>
<h2 data-id="heading-13">总结与选型建议</h2>
<ol>
<li>新代码直接上 <code>AsyncStream</code>
<ul>
<li>取消简单、测试快、与 Swift Concurrency 原生一致</li>
</ul>
</li>
<li>老代码如果已用 Combine
<ul>
<li>可继续用 <code>Timer.publish</code>，但建议包一层 <code>AsyncPublisher</code> 逐步迁移</li>
</ul>
</li>
<li>纯定时器场景
<ul>
<li>只要最小依赖，也可以 <code>AsyncSequence</code> 一把梭，别再写 <code>Timer</code> 了</li>
</ul>
</li>
</ol>
<h2 data-id="heading-14">学习资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40wesleymatlock%2Fasyncsequence-for-real-time-apis-from-legacy-polling-to-swift-6-elegance-c2b8139c21e0" target="_blank" title="https://medium.com/@wesleymatlock/asyncsequence-for-real-time-apis-from-legacy-polling-to-swift-6-elegance-c2b8139c21e0" ref="nofollow noopener noreferrer">medium.com/@wesleymatl…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 性能优化实战：我从 V8 源码中学到的 7 个关键技巧]]></title>    <link>https://juejin.cn/post/7571650164844429346</link>    <guid>https://juejin.cn/post/7571650164844429346</guid>    <pubDate>2025-11-13T00:16:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164844429346" data-draft-id="7571702660932845583" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 性能优化实战：我从 V8 源码中学到的 7 个关键技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T00:16:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 性能优化实战：我从 V8 源码中学到的 7 个关键技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:16:52.000Z" title="Thu Nov 13 2025 00:16:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 性能优化实战：我从 V8 源码中学到的 7 个关键技巧</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在现代 Web 开发中，JavaScript 的性能优化是一个永恒的话题。随着应用复杂度的提升，即使是微小的性能改进也能带来显著的体验提升。作为 JavaScript 开发者，我们常常依赖于引擎的“魔法”来优化代码，但真正理解底层原理的人却不多。V8 引擎（Chrome 和 Node.js 的核心）是当今最先进的 JavaScript 引擎之一，通过深入研究其源码和工作机制，我们可以挖掘出许多实用的性能优化技巧。</p>
<p>本文将分享我从 V8 源码中学到的 <strong>7 个关键性能优化技巧</strong>，并结合实际场景和代码示例说明如何应用这些技术。无论你是前端开发者、Node.js 工程师还是对底层原理感兴趣的极客，这些知识都将帮助你写出更高效的 JavaScript 代码。</p>
<hr/>
<h3 data-id="heading-2">1. <strong>隐藏类与属性访问优化</strong></h3>
<h4 data-id="heading-3">V8 的隐藏类机制</h4>
<p>V8 使用“隐藏类”（Hidden Class）来优化对象属性的访问。每次对象的结构（如属性增减或顺序变化）发生变化时，V8 会创建一个新的隐藏类。频繁改变对象结构会导致隐藏类的“多态性”，从而拖慢属性访问速度。</p>
<h4 data-id="heading-4">实战技巧：</h4>
<ul>
<li><strong>避免动态添加属性</strong>：尽量在构造函数中一次性初始化所有属性。</li>
<li><strong>保持属性顺序一致</strong>：相同结构的对象应按相同顺序定义属性。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Dynamic property addition</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Point</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>();
p1.<span class="hljs-property">x</span> = <span class="hljs-number">10</span>;
p1.<span class="hljs-property">y</span> = <span class="hljs-number">20</span>;

<span class="hljs-comment">// ✅ Good: Predefined properties</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Point</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = x;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> = y;
}
<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
</code></pre>
<hr/>
<h3 data-id="heading-5">2. <strong>内联缓存（Inline Cache）与函数单态性</strong></h3>
<h4 data-id="heading-6">V8的函数调用优化</h4>
<p>V8通过内联缓存（IC）加速函数调用。如果一个函数始终以相同类型的参数被调用（单态），V8会生成高度优化的机器码；但如果参数类型多变（多态），性能会下降。</p>
<h4 data-id="heading-7">实战技巧：</h4>
<ul>
<li><strong>保持函数参数类型稳定</strong>：避免同一函数处理多种类型参数。</li>
<li><strong>避免多态性较高的工具函数</strong>：例如通用的<code>format</code>函数可能因参数类型多变而降低性能。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Polymorphic function</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// May handle numbers, strings, etc.</span>
}

<span class="hljs-comment">// ✅ Good: Monomorphic function</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addNumbers</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// Always expects numbers</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. <strong>数组操作的陷阱与优化</strong></h3>
<h4 data-id="heading-9">V8的数组元素类型跟踪</h4>
<p>V8会根据数组元素的类型（如全为整数或双精度浮点数）选择最优的存储方式（“packed”或“holey”）。打破这种一致性会导致性能下降。</p>
<h4 data-id="heading-10">实战技巧：</h4>
<ul>
<li><strong>避免混合类型数组</strong>：例如<code>[1, 'foo', {}]</code>会迫使V8使用更慢的通用表示。</li>
<li><strong>预分配数组大小</strong>：对于已知长度的数组，直接初始化长度比动态扩展更快。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Mixed-type array and dynamic growth</span>
<span class="hljs-keyword">const</span> arr = [];
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">1</span>);
arr.<span class="hljs-title function_">push</span>(<span class="hljs-string">'text'</span>);

<span class="hljs-comment">// ✅ Good: Homogeneous array with pre-allocation</span>
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">100</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =<span class="hljs-number">0</span>; i &lt;<span class="hljs-number">100</span>; i++) arr[i] = i;
</code></pre>
<hr/>
<h3 data-id="heading-11">4. <strong>逃逸分析与对象分配优化</strong></h3>
<h4 data-id="heading-12">V8的逃逸分析（Escape Analysis）</h4>
<p>V8会分析对象的生命周期是否“逃逸”出当前作用域。未逃逸的对象可以被栈分配或完全优化掉。</p>
<h4 data-id="heading-13">实战技巧：</h4>
<ul>
<li><strong>避免不必要的全局/闭包引用</strong>：将对象限制在局部作用域内。</li>
<li><strong>优先使用基本类型而非包装对象</strong>：例如用<code>'hello'</code>而非<code>new String('hello')</code>。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Object escapes via closure</span>
<span class="hljs-keyword">let</span> leakedObj;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createObj</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> obj = { <span class="hljs-comment">/* ... */</span> };
    leakedObj = obj; <span class="hljs-comment">// Escape!</span>
}

<span class="hljs-comment">// ✅ Good: Object stays local</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> localObj = { <span class="hljs-comment">/* ... */</span> };
    <span class="hljs-comment">// Use localObj here only...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-14">5. <strong>优化的数据结构选择</strong></h3>
<h4 data-id="heading-15">V8的特殊数据结构支持</h4>
<p>某些数据结构在V8中有特殊优化路径，例如：</p>
<ul>
<li><code>Map/Set</code>比普通对象更适合键值对操作；</li>
<li><code>TypedArray</code>对数值计算更高效；</li>
<li><code>ArrayBuffer/SharedArrayBuffer</code>适用于二进制数据共享。</li>
</ul>
<h4 data-id="heading-16">Example:</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Using object for frequent key updates</span>
<span class="hljs-keyword">const</span> cache = {};
cache[key] = value;

<span class="hljs-comment">// ✅ Good: Map is optimized for dynamic keys </span>
<span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
cache.<span class="hljs-title function_">set</span>(key, value);
</code></pre>
<hr/>
<h3 data-id="heading-17">6. <strong>异步代码与微观任务调度</strong></h3>
<h4 data-id="heading-18">V8的事件循环集成</h4>
<p>Promise回调作为微任务会被优先执行。过度嵌套或不必要的Promise会影响调度效率。</p>
<h4 data-id="heading-19">Tips:</h4>
<ul>
<li><strong>避免冗余的Promise包装</strong>:  同步操作无需封装为Promise。</li>
<li><strong>优先使用async/await而非深层then链</strong>:  减少微观任务层级.</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad Unnecessary Promise chain  </span>
<span class="hljs-title function_">fetch</span>(url)
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(data)) <span class="hljs-comment">// Redundant!</span>

<span class="hljs-comment">// ✅ Clean async/await  </span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadData</span>(<span class="hljs-params"/>) {
 <span class="hljs-keyword">const</span> res= <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);
 <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>(); 
}
</code></pre>
<hr/>
<h3 data-id="heading-20">7 .<strong>热函数的JIT友好写法</strong></h3>
<h4 data-id="heading-21">TurboFan如何编译JS</h4>
<p>V  ８ ’s optimizing compiler (TurboFan)会对高频执行(“hot”)的函数进行深度优化 。</p>
<h4 data-id="heading-22">Key Rules :</h4>
<ul>
<li>减少 try-catch in hot paths （破坏编译器信心 ）</li>
<li>减少 arguments usage （阻止参数数量推断 ）</li>
<li>使用显式循环而非函數式编程风格 （如 reduce ）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Non-JIT-friendly hot loop  </span>
<span class="hljs-keyword">let</span> sum= arr.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a,b</span>)=&gt;</span>a+b ,<span class="hljs-number">0</span>);

<span class="hljs-comment">// ✅ Optimizable version  </span>
<span class="hljs-keyword">let</span> sum=<span class="hljs-number">0</span> ;
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;arr.<span class="hljs-property">length</span>;i++) sum+=arr[i];
</code></pre>
<hr/>
<h3 data-id="heading-23">Conclusion</h3>
<p>Performance optimization is not about random tweaks—it requires understanding the underlying engine’s behavior . By studying how V８ works at the source code level , we can make informed decisions that align with its optimization strategies . The seven techniques covered here—from hidden class awareness to JIT-friendly coding patterns—are actionable takeaways you can apply immediately .</p>
<p>Remember : profile before optimizing! Tools like Chrome DevTools’ Performance tab and Node.js’ --prof flag are essential companions on this journey . Happy optimizing!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS preview 预览文件 Kit 的入门讲解]]></title>    <link>https://juejin.cn/post/7571650164844462114</link>    <guid>https://juejin.cn/post/7571650164844462114</guid>    <pubDate>2025-11-13T00:27:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164844462114" data-draft-id="7571650164844445730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS preview 预览文件 Kit 的入门讲解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T00:27:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS preview 预览文件 Kit 的入门讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:27:59.000Z" title="Thu Nov 13 2025 00:27:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<p>本文以实际工程为例，快速上手 HarmonyOS <strong>元服务</strong> 的文件预览能力（PreviewKit），并配套一个后端用于提供示例文件。示例工程路径：</p>
<ul>
<li>客户端（HarmonyOS 端）：<code>client</code></li>
<li>后端（Node.js）：<code>server</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/483497220a0e4dab90956bf83e31c2b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763598479&amp;x-signature=8Glr9vfT23NNTaxvWoJD0GcGCQo%3D" alt="image-20251112090708795" loading="lazy"/></p>
<p>image-20251112090708795</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/509d3edb0c894064a95fa57bc8455e7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763598479&amp;x-signature=Pr%2BoGCJw90X%2BbVE60gOJf03Bmtk%3D" alt="image-20251112091151694" loading="lazy"/></p>
<p>image-20251112091151694</p>
<p>上图是将 1个pdf文件和3个图片一起预览，那么就只会现实第1个预览窗口。</p>
<p><strong>下图是移除pdf文件，将3个同类型的图片放在一起预览</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf61a49902b74a4eb3a63d5ddebce9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763598479&amp;x-signature=dgmkow8C39Y8pshx%2Bc8aBXfvA6s%3D" alt="image-20251112091518239" loading="lazy"/></p>
<p>image-20251112091518239</p>
<hr/>
<p><strong>为了方便演示功能，需要先将一些可以预览的文件下载到元服务的沙箱内，是基于这个原因我们才需要引入后端来模拟这个下载的环境，所以元服务内需要先实现下载文件，存储到沙箱，然后再使用预览API filePreview.openPreview预览沙箱内的文件。</strong></p>
<h3 data-id="heading-1">1. 工程结构与目标</h3>
<ul>
<li><code>client/entry/src/main/ets/pages/Index.ets</code>：演示并发下载 4 个文件（<code>1.pdf</code>、<code>1.png</code>、<code>2.png</code>、<code>3.png</code>）并一次性预览。</li>
<li><code>server/index.js</code> 与 <code>server/public/</code>：提供静态文件下载接口 <code>/file/:filename</code>。</li>
</ul>
<p>目标：</p>
<ul>
<li>点击“下载”按钮，并发下载上述 4 个文件到应用沙箱目录。</li>
<li>下载成功后点击“预览”，一次性打开最多 4 个文件的预览窗口。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. PreviewKit 的核心：filePreview.openPreview</h3>
<p>HarmonyOS 提供了预览能力包 <code>@kit.PreviewKit</code>。在 ETS 代码中引入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { filePreview } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PreviewKit'</span>;
<span class="hljs-keyword">import</span> { fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;
</code></pre>
<p>核心调用是：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 先准备多个文件的预览信息</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">prewList</span>: filePreview.<span class="hljs-property">PreviewInfo</span>[] = []
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
  <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastDownloadedList</span>[i];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">fileInfo</span>: filePreview.<span class="hljs-property">PreviewInfo</span> = {
    <span class="hljs-attr">title</span>: item.<span class="hljs-property">name</span>,                                  <span class="hljs-comment">// 预览标题</span>
    <span class="hljs-attr">uri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(item.<span class="hljs-property">path</span>),            <span class="hljs-comment">// 将沙箱路径转成 Uri</span>
    <span class="hljs-attr">mimeType</span>: item.<span class="hljs-property">mime</span> || <span class="hljs-string">'application/octet-stream'</span>, <span class="hljs-comment">// MIME 类型</span>
  };
  prewList.<span class="hljs-title function_">push</span>(fileInfo)
}

<span class="hljs-comment">// 一次性打开多个预览窗口</span>
filePreview.<span class="hljs-title function_">openPreview</span>(uiContext, prewList)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 打开成功</span>
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
    <span class="hljs-comment">// 打开失败处理</span>
  });
</code></pre>
<p>说明：</p>
<ul>
<li><code>PreviewInfo</code> 至少需要 <code>title</code>、<code>uri</code>、<code>mimeType</code>。</li>
<li><code>uri</code> 使用 <code>fileUri.getUriFromPath(沙箱文件路径)</code> 构造。</li>
<li>支持一次性传入一个 <code>PreviewInfo[]</code>，实现多文件预览。</li>
</ul>
<blockquote>
<p>图片占位：请补充一次性预览 4 个文件的窗口布局截图，标注窗口标题与 MIME 类型展示位置。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">3. 并发下载与状态反馈（客户端）</h3>
<p>示例使用 <code>Promise.allSettled</code> 并发下载 4 个后端文件，并按项展示“成功/失败”状态：</p>
<pre><code class="hljs language-ini" lang="ini">// 计划 + 状态
@Local private plannedFiles: DownloadPlan<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
@Local private itemStatuses: string<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
@Local private isDownloading: <span class="hljs-attr">boolean</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
@Local private statusMessage: <span class="hljs-attr">string</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>

// 初始化计划（aboutToAppear）
<span class="hljs-attr">this.plannedFiles</span> = [
  new DownloadPlan(<span class="hljs-string">'1.pdf'</span>, `<span class="hljs-variable">${this.serverBase}</span>/<span class="hljs-number">1</span>.pdf`),
  new DownloadPlan(<span class="hljs-string">'1.png'</span>, `<span class="hljs-variable">${this.serverBase}</span>/<span class="hljs-number">1</span>.png`),
  new DownloadPlan(<span class="hljs-string">'2.png'</span>, `<span class="hljs-variable">${this.serverBase}</span>/<span class="hljs-number">2</span>.png`),
  new DownloadPlan(<span class="hljs-string">'3.png'</span>, `<span class="hljs-variable">${this.serverBase}</span>/<span class="hljs-number">3</span>.png`)
]<span class="hljs-comment">;</span>
<span class="hljs-attr">this.itemStatuses</span> = [<span class="hljs-string">'未下载'</span>,<span class="hljs-string">'未下载'</span>,<span class="hljs-string">'未下载'</span>,<span class="hljs-string">'未下载'</span>]<span class="hljs-comment">;</span>

// 点击“下载”
<span class="hljs-attr">this.isDownloading</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
<span class="hljs-attr">this.statusMessage</span> = <span class="hljs-string">'下载中...'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">this.itemStatuses</span> = new Array(this.plannedFiles.length).fill(<span class="hljs-string">'下载中...'</span>)<span class="hljs-comment">;</span>

const promises: Promise&lt;DownloadInfo&gt;<span class="hljs-section">[]</span> = this.plannedFiles.map(<span class="hljs-attr">p</span> =&gt; this.downloadFile(p.url))<span class="hljs-comment">;</span>
const <span class="hljs-attr">settled</span> = await Promise.allSettled(promises)<span class="hljs-comment">;</span>

// 汇总结果并一次性触发 UI 刷新
const successes: DownloadInfo<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
const nextStatuses: string<span class="hljs-section">[]</span> = new Array(this.plannedFiles.length).fill('未下载')<span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; settled.length; i++) {</span>
  const <span class="hljs-attr">name</span> = this.plannedFiles[i].name<span class="hljs-comment">;</span>
  const <span class="hljs-attr">r</span> = settled[i]<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">r.status</span> === <span class="hljs-string">'fulfilled'</span>) {
    successes.push(r.value)<span class="hljs-comment">;</span>
    nextStatuses<span class="hljs-section">[i]</span> = `✓ 下载成功：${name}`<span class="hljs-comment">;</span>
  } else {
    nextStatuses<span class="hljs-section">[i]</span> = `✗ 下载失败：${name}（${this.errorToString(r.reason as Object)}）`<span class="hljs-comment">;</span>
  }
}
<span class="hljs-attr">this.itemStatuses</span> = nextStatuses<span class="hljs-comment">; // 重新赋值以触发 UI 刷新</span>
<span class="hljs-attr">this.lastDownloadedList</span> = successes<span class="hljs-comment">;</span>
<span class="hljs-attr">this.isDownloading</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
</code></pre>
<p>UI 渲染建议：</p>
<ul>
<li>使用 <code>ForEach(this.plannedFiles, ...)</code> 动态渲染状态行，避免硬编码索引。</li>
<li>将与 UI 绑定的字段用 <code>@Local</code> 或 <code>@State</code> 修饰，并“重新赋值数组”以触发刷新（不要在原数组上就地修改元素）。</li>
</ul>
<blockquote>
<p>图片占位：请补充“下载中→成功/失败”逐项状态变化的截图，便于读者理解响应式刷新。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">4. HTTP 下载的细节与 ArkTS 限制规避</h3>
<ul>
<li>MIME 与扩展名：示例通过扩展名推断 MIME，若扩展名缺失则从响应头的 <code>Content-Type</code> 推断。</li>
<li>ArkTS 限制：不建议直接 <code>data.header['Content-Type']</code> 索引；示例使用序列化 + 正则方式提取避免 ArkTS 索引限制。</li>
</ul>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 通过序列化响应头并用正则提取 Content-Type</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">tryGetContentTypeHeader</span>(<span class="hljs-attr">headerObj</span>: <span class="hljs-title class_">Object</span> | <span class="hljs-literal">null</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (!headerObj) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(headerObj);
    <span class="hljs-keyword">if</span> (!json) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> match = json.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/"content-type"\s*:\s*"([^"]+)"/i</span>);
    <span class="hljs-keyword">return</span> match &amp;&amp; match.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> ? match[<span class="hljs-number">1</span>] : <span class="hljs-string">''</span>;
  } <span class="hljs-keyword">catch</span> (_) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }
}
</code></pre>
<p>保存文件：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">filePath</span> = `<span class="hljs-variable">${this.filesDir}</span>/<span class="hljs-variable">${fileName}</span>`<span class="hljs-comment">;</span>
if (fileIo.accessSync(filePath)) {
  fileIo.unlinkSync(filePath)<span class="hljs-comment">;</span>
}
const <span class="hljs-attr">file</span> = fileIo.openSync(filePath, fileIo.OpenMode.CREATE | fileIo.OpenMode.WRITE_ONLY)<span class="hljs-comment">;</span>
const <span class="hljs-attr">bytesWritten</span> = fileIo.writeSync(file.fd, fileBuffer)<span class="hljs-comment">;</span>
fileIo.closeSync(file)<span class="hljs-comment">;</span>
</code></pre>
<p>权限：</p>
<ul>
<li>客户端需要在 <code>entry/src/main/module.json5</code> 声明 <code>ohos.permission.INTERNET</code> 才能进行网络请求。</li>
</ul>
<hr/>
<h3 data-id="heading-5">5. 后端：简单的静态文件下载接口</h3>
<p>示例后端路径：<code>d:\code\atoStudy\server</code>，目录 <code>public/</code> 放置 4 个演示文件。</p>
<p>核心路由：<code>GET /file/:filename</code></p>
<p>后端的简单目录结构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/210e1a1877be4e7d948065c20a241e8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763598479&amp;x-signature=HCXQ0zRM6%2FTsE8T4irga3k6Uva0%3D" alt="image-20251112092243514" loading="lazy"/></p>
<p>image-20251112092243514</p>
<pre><code class="hljs language-ini" lang="ini">// index.js（简版示例）
const <span class="hljs-attr">express</span> = require(<span class="hljs-string">'express'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">path</span> = require(<span class="hljs-string">'path'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">app</span> = express()<span class="hljs-comment">;</span>

app.get('/file/:filename', (req, res) =&gt; {
  const <span class="hljs-attr">filename</span> = req.params.filename<span class="hljs-comment">;</span>
  const <span class="hljs-attr">filePath</span> = path.join(__dirname, <span class="hljs-string">'public'</span>, filename)<span class="hljs-comment">;</span>
  res.sendFile(filePath)<span class="hljs-comment">; // 或根据需要设置 Content-Type</span>
})<span class="hljs-comment">;</span>

app.listen(3000, () =&gt; {
  console.log('Server listening on http://localhost:3000')<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>客户端请求地址示例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> serverBase: <span class="hljs-built_in">string</span> = <span class="hljs-string">"http://192.168.5.2:3000/file"</span>;
<span class="hljs-comment">// 组合完整 URL 示例：`${this.serverBase}/1.pdf`</span>
</code></pre>
<blockquote>
<p>注意：请按真实局域网 IP 替换 <code>192.168.5.2</code>，并保证手机/模拟器与后端在同一网络。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">6. 快速运行与验证</h3>
<p>后端：</p>
<ul>
<li>安装依赖并启动：<code>npm install &amp;&amp; node index.js</code></li>
<li>确认 <code>public/</code> 下存在 <code>1.pdf</code>、<code>1.png</code>、<code>2.png</code>、<code>3.png</code></li>
</ul>
<p>客户端：</p>
<ul>
<li>在 <code>module.json5</code> 中确保已声明 <code>ohos.permission.INTERNET</code></li>
<li>构建并安装到设备/模拟器</li>
<li>点击“下载”，观察逐项状态变化</li>
<li>下载成功后点击“预览”，验证多窗口预览是否正常</li>
</ul>
<blockquote>
<p>图片占位：请补充上述过程的关键截图（如“权限声明处”、“下载成功状态”、“多窗口预览”）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">7. 常见问题与排查</h3>
<ul>
<li>权限错误（如 code=201 / “Permission denied”）：检查 <code>ohos.permission.INTERNET</code> 是否声明；确认真机/模拟器的网络可达性。</li>
<li>404 或下载失败：确认后端路由 <code>/file/:filename</code> 存在且文件确实在 <code>public/</code> 目录内；检查客户端 <code>serverBase</code> 地址是否正确。</li>
<li>MIME 与扩展名错配：优先使用后端返回的 <code>Content-Type</code>；如果缺失，则按扩展名推断。</li>
<li>UI 不刷新：在 ArkUI 中对数组进行“重新赋值”来触发刷新，避免原地修改元素（例如使用 <code>this.itemStatuses = [...nextStatuses]</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-8">8. 小结</h3>
<p><code>filePreview.openPreview</code> 是 HarmonyOS 文件预览能力的核心，支持一次性打开多文件预览。结合简单的后端静态文件服务与并发下载、响应式状态刷新，能够快速搭建一个“下载即预览”的演示工程。本文的示例工程完整覆盖了从后端文件提供、客户端下载与保存、到预览窗口打开的关键路径，适合作为入门教程与二次扩展的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Swift 访问控制全解析】一篇就够：从 open 到 private，让接口与实现各就其位]]></title>    <link>https://juejin.cn/post/7571729682678808626</link>    <guid>https://juejin.cn/post/7571729682678808626</guid>    <pubDate>2025-11-13T00:47:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571729682678808626" data-draft-id="7554344985492209673" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Swift 访问控制全解析】一篇就够：从 open 到 private，让接口与实现各就其位"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-13T00:47:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Swift 访问控制全解析】一篇就够：从 open 到 private，让接口与实现各就其位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:47:39.000Z" title="Thu Nov 13 2025 00:47:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么需要“访问控制”</h2>
<ol>
<li>隐藏实现细节，只暴露必要接口</li>
<li>防止外部误用，减少后续兼容压力</li>
<li>支持模块化开发（App、Framework、Swift Package 多目标混合）</li>
</ol>
<p>一句话：接口公开，实现隐藏；该见的见，不该见的永远看不见。</p>
<h2 data-id="heading-1">Swift 的三层作用域与六级权限</h2>















































<table><thead><tr><th>级别</th><th>可见范围</th><th>可继承/重写</th><th>典型用途</th></tr></thead><tbody><tr><td>open</td><td>模块外可见，可子类化、可 override</td><td>✅</td><td>框架的“设计出口”</td></tr><tr><td>public</td><td>模块外可见，不可子类化/override</td><td>❌</td><td>稳定 API</td></tr><tr><td>package</td><td>同一 package 内所有模块</td><td>✅/❌</td><td>Swift Package 跨模块协作</td></tr><tr><td>internal</td><td>默认级，仅当前模块</td><td>✅</td><td>模块内部实现</td></tr><tr><td>fileprivate</td><td>仅当前源文件</td><td>✅</td><td>同一文件内多个类型/扩展共享</td></tr><tr><td>private</td><td>仅当前声明 + 同一文件内扩展</td><td>✅</td><td>最小化封装单元</td></tr></tbody></table>
<h2 data-id="heading-2">默认策略速记</h2>
<ul>
<li>不手写访问修饰符 → internal</li>
<li>类型的默认成员 → 跟随类型（类型 public → 成员 internal）</li>
<li>嵌套类型在 public 类型里 → internal（需要公开再写 public）</li>
</ul>
<h2 data-id="heading-3">代码实战：六级权限一次看个够</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 文件：FrameworkA.swift  (属于 FrameworkA 模块)</span>

<span class="hljs-comment">// 1. open：允许外部模块子类化</span>
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenClass</span> {
    <span class="hljs-keyword">open</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">overrideMe</span>() {}          <span class="hljs-comment">// 外部可 override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">notOverrideOutside</span>() {} <span class="hljs-comment">// 外部只能调，不能 override</span>
}

<span class="hljs-comment">// 2. public：稳定接口，不可继承</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PublicAPI</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">init</span>() {}
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">var</span> innerCounter <span class="hljs-operator">=</span> <span class="hljs-number">0</span>      <span class="hljs-comment">// 模块外不可见</span>
}

<span class="hljs-comment">// 3. package：同一 Package 内共享</span>
package <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">PackageService</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() -&gt; <span class="hljs-type">String</span>
}

<span class="hljs-comment">// 4. internal：不暴露给外部</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerHelper</span> {
    <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">InnerHelper</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() {}
}

<span class="hljs-comment">// 5. fileprivate：同一文件内复用</span>
<span class="hljs-keyword">fileprivate</span> <span class="hljs-keyword">extension</span> <span class="hljs-title class_">String</span> {
    <span class="hljs-keyword">var</span> trimmed: <span class="hljs-type">String</span> { trimmingCharacters(in: .whitespaces) }
}

<span class="hljs-comment">// 6. private：隐藏到“声明内部”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Trimmer</span> {
    <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>   <span class="hljs-comment">// 只读公开，写私有</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">trim</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">s</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">String</span>) {
        s <span class="hljs-operator">=</span> s.trimmed                 <span class="hljs-comment">// 同一文件，可访问 fileprivate</span>
        count <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
    }
}
</code></pre>
<h2 data-id="heading-4">继承与重写中的“升权”</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 同一模块内</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
    <span class="hljs-keyword">fileprivate</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">hidden</span>() {}
}

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>: <span class="hljs-title class_">A</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">internal</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">hidden</span>() {} <span class="hljs-comment">// 合法：在同一文件，升级访问权</span>
}
</code></pre>
<p>规则回顾：</p>
<ol>
<li>子类访问级别 ≤ 父类</li>
<li>重写可提高访问权，但不能降低</li>
<li>跨模块只能继承/重写 <code>open</code> 成员</li>
</ol>
<h2 data-id="heading-5">协议、扩展、泛型、别名的细节</h2>
<ol>
<li>协议</li>
</ol>
<ul>
<li>协议权限 ≥ 其所有要求</li>
<li>继承的协议不能比父协议更开放</li>
<li>conformance 权限 = min(类型权限, 协议权限)</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">PublicProtocol</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">foo</span>()
}
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InternalImpl</span>: <span class="hljs-title class_">PublicProtocol</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">foo</span>() {}   <span class="hljs-comment">// 自动 internal，满足要求</span>
}
</code></pre>
<ol start="2">
<li>扩展</li>
</ol>
<ul>
<li>扩展可写访问修饰符，为内部成员统一设置默认级</li>
<li>用于协议 conformance 的扩展不能写访问修饰符，由协议本身决定</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">Trimmer</span>: <span class="hljs-title class_">CustomStringConvertible</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> description: <span class="hljs-type">String</span> { <span class="hljs-string">"trimmed <span class="hljs-subst">\(count)</span> times"</span> }
}
</code></pre>
<ol start="3">
<li>泛型</li>
</ol>
<ul>
<li>泛型实体权限 = min(自身权限, 所有约束类型权限)</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">CacheKey</span> {}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">T</span>: <span class="hljs-title class_">CacheKey</span>&gt; {} <span class="hljs-comment">// 实际权限 internal</span>
</code></pre>
<ol start="4">
<li>类型别名</li>
</ol>
<ul>
<li>别名权限 ≤ 原类型权限</li>
<li>利用别名可在模块外“隐藏”真实类型</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">typealias</span> <span class="hljs-type">Token</span> <span class="hljs-operator">=</span> <span class="hljs-type">String</span>   <span class="hljs-comment">// OK</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">typealias</span> <span class="hljs-type">SecretDict</span> <span class="hljs-operator">=</span> [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>] <span class="hljs-comment">// 仅当前文件可用</span>
</code></pre>
<h2 data-id="heading-6">Package 级访问：多模块仓库的“朋友圈”</h2>
<p>场景：一个 Swift Package 包含 Network、UI、Core 三个模块，希望 Core 的接口仅被 Network/UI 使用，而不暴露给最终 App。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Core 模块</span>
package <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">DataLoader</span> {
    package <span class="hljs-keyword">func</span> <span class="hljs-title function_">load</span>() -&gt; <span class="hljs-type">Data</span>
}
</code></pre>
<p>在 Package 外（App）<code>import Core</code> 后，无法看见 <code>DataLoader</code>，真正做到“仓库内共享，仓库外隔离”。</p>
<h2 data-id="heading-7">常见踩坑与调试技巧</h2>

























<table><thead><tr><th>错误提示</th><th>原因</th><th>解决</th></tr></thead><tbody><tr><td>Cannot assign to property: ‘count’ is a get-only property</td><td>用了 <code>private(set)</code> 却在外部赋值</td><td>移除 setter 限制或提供内部 API</td></tr><tr><td>Class cannot be declared public because its superclass is internal</td><td>子类比父类“显眼”</td><td>提升父类或降低子类</td></tr><tr><td>Function cannot be declared internal because its parameter uses a private type</td><td>函数权限 &gt; 参数权限</td><td>提升类型权限或降低函数权限</td></tr></tbody></table>
<h2 data-id="heading-8">总结与工程实践建议</h2>
<ol>
<li>
<p>写框架先画“可见性矩阵”：哪些类需要被继承？哪些 API 未来必须冻结？</p>
<ul>
<li>需要被继承 → <code>open</code></li>
<li>仅调用 → <code>public</code></li>
<li>仓库内复用 → <code>package</code></li>
<li>模块内复用 → <code>internal</code></li>
<li>文件内工具 → <code>fileprivate</code></li>
<li>纯内部辅助 → <code>private</code></li>
</ul>
</li>
<li>
<p>先写 <code>internal</code>，真正需要暴露时再升级，避免“过度公开”</p>
</li>
<li>
<p>对<code>private(set)</code>“只读公开”模式上瘾，可大幅减少后续 Breaking Change。</p>
</li>
<li>
<p>用 <code>@testable</code> 而非“为了测试把 private 改成 public”。</p>
</li>
<li>
<p>大型 Package 采用“Core → Service → UI”三级依赖，配合 <code>package</code> 访问级，保证依赖方向无环，又隐藏核心实现。</p>
</li>
</ol>
<h2 data-id="heading-9">扩展场景：访问控制 + SwiftUI + 插件化架构</h2>
<p>SwiftUI 的 <code>public</code> 初始化器经常需要接收“仅内部使用的配置对象”。此时可用类型擦除 + 协议权限组合：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 对外只能拿到协议</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">protocol</span> <span class="hljs-title class_">ConfigProtocol</span> {}

<span class="hljs-comment">// 实际配置在模块内</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RealConfig</span>: <span class="hljs-title class_">ConfigProtocol</span> {
    <span class="hljs-keyword">var</span> apiKey: <span class="hljs-type">String</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">init</span>(<span class="hljs-params">config</span>: <span class="hljs-type">ConfigProtocol</span>) { <span class="hljs-operator">...</span> }
}
</code></pre>
<p>App 只能持有 <code>ConfigProtocol</code>，无法直接访问 <code>apiKey</code>，实现“接口公开，配置隐藏”。</p>
<h2 data-id="heading-10">一句话背下来</h2>
<p>“高”不能依赖“低”，默认 internal 先写着；需要再升级，绝不一步到位全 public</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践]]></title>    <link>https://juejin.cn/post/7571743311519252489</link>    <guid>https://juejin.cn/post/7571743311519252489</guid>    <pubDate>2025-11-13T00:48:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571743311519252489" data-draft-id="7571655312798711834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-13T00:48:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T00:48:32.000Z" title="Thu Nov 13 2025 00:48:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/974c07f8ccf246b891b51d00be2ffa69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=oZZIPnD09IezVjZ6ak46ufFuJa4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">一. 引言：</h2>
<p>我们正处在一个由 AI Agent 驱动的范式转换前夜。它们不再只是简单的文本生成器，而是能够理解复杂指令、自主规划多步任务，并调用各类 API 与数字世界交互的“数字工作者”；在为大型语言模型增加“执行臂膀”后，Agent 正在成为企业应用中的“能力放大器”。</p>
<p>过去，当我们监控传统微服务或 Web 应用时，“Metrics → Logs → Traces” 的可观测模型已足够应对。但在 Agent 场景，它只能告诉我们“发生了什么”，却无法解释“为什么会这样”——也无法指明“下一步该怎么办”。一旦将关键业务流程托付给 Agent，黑盒效应便迅速显现：</p>
<ul>
<li>决策的“原因”：为何 Agent 选择在此时发起特定调用？它基于怎样的上下文与推理？</li>
<li>行为的“链条”：在这次调用之前，Agent 是否已经与用户或其他工具反复交互？这一步是解决方案的关键，还是误入歧途的昂贵尝试？</li>
<li>结果的“质量”：返回的内容是否真正提升了任务完成度，还是引入了新的偏差或错误？</li>
</ul>
<p>在下文中，我们将结合 Amazon Bedrock、Amazon Bedrock AgentCore、Amazon CloudWatch 等原生能力，构建一套从行为洞察到质量评估、从成本监控到闭环优化的多维度可观测框架。</p>
<h2 data-id="heading-1">二. Agent 可观测性详解</h2>
<p>Agentic AI可观测性是一个多维度的概念，它不仅包括传统应用监控中的指标，还需要特别关注AI特有的行为特征。在Agent系统中，我们需要监控从用户输入到最终输出的整个处理流程，包括模型调用、推理过程、工具使用等各个环节。这种全方位的监控能力使我们能够及时发现问题、优化性能、提升用户体验。对于Agent系统，这里主要需要关注指标、追踪两方面。</p>
<h3 data-id="heading-2">重要指标</h3>
<h4 data-id="heading-3">响应时间指标：时间相关的指标是评估Agent性能的重要维度。其中最关键的是以下几个指标：</h4>
<ul>
<li>总体请求处理时间（TotalTime）： 这个指标衡量了从接收用户请求到生成最终响应的完整时间。例如，当用户询问”巴黎的天气如何？”时，系统可能需要500ms来理解问题，300ms调用天气API，再用200ms生成回答，总计1000ms。监控这个指标可以帮助我们发现性能瓶颈，优化响应速度。</li>
<li>首个token生成时间（TTFT）： 这是衡量系统响应速度的关键指标。它记录从请求开始到生成第一个响应token的时间。比如，如果系统在接收到问题后能在200ms内开始生成回答，这表明系统的初始响应速度较快。这个指标对于提供流式响应的系统特别重要。</li>
<li>模型延迟（ModelLatency）： 专门衡量模型推理所需的时间。通过监控这个指标，我们可以评估不同模型的性能表现，为特定场景选择最适合的模型。</li>
</ul>
<h4 data-id="heading-4"><strong>Token</strong>使用指标：Token使用情况直接关系到系统的运营成本和效率</h4>
<ul>
<li>输入Token数量（InputTokenCount）： 记录发送给模型的token数量。例如，一个包含系统提示词、上下文历史和用户问题的请求可能使用了1000个token。这个指标帮助我们优化提示词设计和上下文管理策略。</li>
<li>输出Token数量（OutputTokenCount）： 统计模型生成的token数量。比如，一个详细的天气报告响应可能产生200个token。监控这个指标有助于控制响应的简洁度和成本。</li>
</ul>
<h4 data-id="heading-5">工具使用指标：Agent系统中的工具调用情况也需要密切监控：</h4>
<ul>
<li>调用频率（InvocationCount）： 记录每个工具被调用的次数。例如，在一个客服Agent中，可能发现知识库查询工具的使用频率是订单查询工具的三倍，这样的信息可以指导我们优化工具的设计和缓存策略。</li>
<li>工具执行时间： 监控每个工具的执行耗时。比如，如果发现天气API的平均响应时间超过800ms，可能需要考虑更换更合适的模型或实施缓存机制。</li>
</ul>
<h4 data-id="heading-6"><strong>Agent</strong>追踪：完整的执行链路视图</h4>
<p>在传统的可观测性三支柱中，追踪（Tracing）对于Agent系统具有独特且至关重要的价值。与指标和日志相比，追踪能够提供Agent决策过程的完整上下文链路，这对于理解和优化AI系统的行为模式至关重要。传统指标虽然能够反映系统的健康状况和性能特征，但无法解释Agent在特定情境下做出某个决策的原因。日志虽然提供了详细的事件记录，但往往缺乏跨服务的关联性，难以构建完整的执行图谱。而追踪数据通过span的层次化结构，能够精确记录Agent从接收用户输入、理解意图、规划执行路径、调用工具、生成响应的完整决策链条。这种端到端的可见性使开发者能够快速定位性能瓶颈、识别错误根因，并深入理解Agent的推理逻辑。</p>
<p>根据Amazon X-Ray和OpenTelemetry的最佳实践，Agent场景下的追踪数据不仅记录了”发生了什么”，更重要的是揭示了”为什么这样发生”以及”各个组件之间如何相互作用”。具体而言，Agent追踪系统需要关注以下几个核心维度：</p>
<ul>
<li><strong>Agent</strong>执行追踪：提供完整的执行链路视图，包括系统级追踪和推理周期追踪。系统级追踪记录每个请求的完整生命周期，从用户输入、系统提示词到最终响应的全过程，形成完整的执行图谱帮助理解Agent的决策过程。推理周期追踪则深入到每个推理步骤的细节，详细记录当前思考步骤的内容、工具调用的决策过程以及中间结果的处理方式，这些信息对于调试复杂的推理链特别有价值。</li>
<li>错误和异常追踪：系统中的错误和异常需要特别关注，主要包括客户端错误和服务器错误两类。客户端错误记录由客户端引起的问题，如参数错误、认证失败等，这些信息帮助改进API设计和文档。服务器错误则追踪服务器端的异常情况，如模型调用失败、资源不足等，这类信息对于提升系统可靠性至关重要。</li>
</ul>
<p>而这些内容均可通过Opentelemerty 协议记录并传输到后端以供分析。在OpenTelemetry的追踪体系中，每个操作都有对应的span ID和trace ID，这两个标识符构成了分布式追踪的核心骨架。Trace ID代表Agent执行循环中的一次完整会话，从用户发起请求到Agent返回最终结果的整个生命周期都会共享同一个trace ID。而span ID则代表这个执行循环中的每个具体操作，如模型调用、工具执行、上下文检索等，每个span ID都是唯一的，并通过父子关系构建起完整的执行树状结构。在Agent场景中，一个trace包含了从用户输入到最终响应生成的所有中间步骤，每个步骤都通过span来表示。Agent traces通常包含模型调用span和工具调用span，这些span会根据其追踪的步骤类型，被丰富的上下文信息所充实。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28283cfd823d48b9b702f176d1697a1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=SGAx5MnYpW3dxWPW4UxClxWNsSw%3D" alt="图1.webp" loading="lazy"/></p>
<p align="center">图1. Agent完整执行链路</p>
<p>除了标准属性外，OpenTelemetry还提供了baggage机制来传递自定义的跨服务元数据。Baggage是一种分布式上下文传播机制，允许开发者在整个请求链路中传递业务相关的键值对信息。例如，可以通过baggage传递用户类型、实验标识、会话主题等业务属性，这些信息会自动附加到所有相关的span中，为后续的离线评估、性能分析和A/B测试提供宝贵的上下文。通过合理使用baggage机制，开发者可以实现更精细化的Agent行为分析和优化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20bad2053eba427c804c86682df24355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=xeFrntbemsjKoObRkVDV6c5H5l4%3D" alt="图2.webp" loading="lazy"/></p>
<p align="center">图2. OpenTelemetry span机制</p>
<p>许多Agent框架已自带Opentelemetry支持，但仍需要将Opentelemetry SDK嵌入应用中。对于采用Python开发的Agent，可使用自动注入方式，利用 opentelemetry-instrument  命令将SDK自动嵌入到应用中。这一命令会自动化配置流程，从参数或环境变量中生成Opentelemetry配置，并自动将SDK附加至Agent的内部，亚马逊云科技调用，或其他的外部调用中。这样，Agent的所有操作都会被Opentelemetry记录并传输到后端。</p>
<p>下面是一段跟踪数据的样本：</p>
<pre><code class="hljs language-swift" lang="swift">{
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"chat"</span>,
    <span class="hljs-string">"context"</span>: {
        <span class="hljs-string">"trace_id"</span>: <span class="hljs-string">"0x68888fcdba6326c1fc004fe9396ad6a8"</span>,
        <span class="hljs-string">"span_id"</span>: <span class="hljs-string">"0x4f4c5c4caf92a36d"</span>,
        <span class="hljs-string">"trace_state"</span>: <span class="hljs-string">"[]"</span>
    },
    <span class="hljs-string">"kind"</span>: <span class="hljs-string">"SpanKind.CLIENT"</span>,
    <span class="hljs-string">"parent_id"</span>: <span class="hljs-string">"0xbc776902450f8294"</span>,
    <span class="hljs-string">"start_time"</span>: <span class="hljs-string">"2025-07-29T09:09:33.427326Z"</span>,
    <span class="hljs-string">"end_time"</span>: <span class="hljs-string">"2025-07-29T09:09:34.932205Z"</span>,
    <span class="hljs-string">"status"</span>: {
        <span class="hljs-string">"status_code"</span>: <span class="hljs-string">"OK"</span>
    },
    <span class="hljs-string">"attributes"</span>: {
        <span class="hljs-string">"session.id"</span>: <span class="hljs-string">"session-1234"</span>,
        <span class="hljs-string">"gen_ai.event.start_time"</span>: <span class="hljs-string">"2025-07-29T09:09:33.427342+00:00"</span>,
        <span class="hljs-string">"gen_ai.system"</span>: <span class="hljs-string">"strands-agents"</span>,
        <span class="hljs-string">"gen_ai.operation.name"</span>: <span class="hljs-string">"chat"</span>,
        <span class="hljs-string">"gen_ai.request.model"</span>: <span class="hljs-string">"us.anthropic.claude-3-5-haiku-20241022-v1:0"</span>,
        <span class="hljs-string">"gen_ai.event.end_time"</span>: <span class="hljs-string">"2025-07-29T09:09:34.932173+00:00"</span>,
        <span class="hljs-string">"gen_ai.usage.prompt_tokens"</span>: <span class="hljs-number">443</span>,
        <span class="hljs-string">"gen_ai.usage.input_tokens"</span>: <span class="hljs-number">443</span>,
        <span class="hljs-string">"gen_ai.usage.completion_tokens"</span>: <span class="hljs-number">76</span>,
        <span class="hljs-string">"gen_ai.usage.output_tokens"</span>: <span class="hljs-number">76</span>,
        <span class="hljs-string">"gen_ai.usage.total_tokens"</span>: <span class="hljs-number">519</span>
    },
    <span class="hljs-string">"events"</span>: [
        {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"gen_ai.user.message"</span>,
            <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"2025-07-29T09:09:33.427368Z"</span>,
            <span class="hljs-string">"attributes"</span>: {
                <span class="hljs-string">"content"</span>: <span class="hljs-string">"[{<span class="hljs-subst">\"</span>text<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>Research and recommend suitable travel destinations for someone looking for China traditional culture experience in Beijing city. <span class="hljs-subst">\\</span>nUse web search to find current information about venues, <span class="hljs-subst">\\</span>nevents, and attractions.<span class="hljs-subst">\"</span>}]"</span>
            }
        },
        {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"gen_ai.choice"</span>,
            <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"2025-07-29T09:09:34.932167Z"</span>,
            <span class="hljs-string">"attributes"</span>: {
                <span class="hljs-string">"finish_reason"</span>: <span class="hljs-string">"tool_use"</span>,
                <span class="hljs-string">"message"</span>: <span class="hljs-string">"[{<span class="hljs-subst">\"</span>text<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>I'll search for the best traditional cultural experiences in Beijing.<span class="hljs-subst">\"</span>}, {<span class="hljs-subst">\"</span>toolUse<span class="hljs-subst">\"</span>: {<span class="hljs-subst">\"</span>toolUseId<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>tooluse_JSt-cJ9fRU28RmhdJ1XENA<span class="hljs-subst">\"</span>, <span class="hljs-subst">\"</span>name<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>web_search<span class="hljs-subst">\"</span>, <span class="hljs-subst">\"</span>input<span class="hljs-subst">\"</span>: {<span class="hljs-subst">\"</span>query<span class="hljs-subst">\"</span>: <span class="hljs-subst">\"</span>Top traditional cultural attractions and experiences in Beijing 2024<span class="hljs-subst">\"</span>}}}]"</span>
            }
        }
    ],
    <span class="hljs-string">"links"</span>: [],
    <span class="hljs-string">"resource"</span>: {
        <span class="hljs-string">"attributes"</span>: {
            <span class="hljs-string">"telemetry.sdk.language"</span>: <span class="hljs-string">"python"</span>,
            <span class="hljs-string">"telemetry.sdk.name"</span>: <span class="hljs-string">"opentelemetry"</span>,
            <span class="hljs-string">"telemetry.sdk.version"</span>: <span class="hljs-string">"1.33.1"</span>,
            <span class="hljs-string">"service.name"</span>: <span class="hljs-string">"agentic-travel-strands"</span>,
            <span class="hljs-string">"telemetry.auto.version"</span>: <span class="hljs-string">"0.10.0-aws"</span>,
            <span class="hljs-string">"aws.local.service"</span>: <span class="hljs-string">"agentic-travel-strands"</span>,
            <span class="hljs-string">"aws.service.type"</span>: <span class="hljs-string">"gen_ai_agent"</span>
        },
        <span class="hljs-string">"schema_url"</span>: <span class="hljs-string">""</span>
</code></pre>
<p>从这个示例中可以看到，Strands Agent框架已经内置了对OpenTelemetry的深度集成支持。根据Strands官方文档，该框架遵循OpenTelemetry GenAI语义约定，会自动将Agent的内部决策过程以标准化的事件（event）形式发送至追踪后端。这种自动化的遥测数据收集机制大大简化了Agent应用的可观测性实现，开发者无需手动编写复杂的追踪代码，即可获得生产级别的监控能力。</p>
<p>Strands Agent的OpenTelemetry集成特别针对GenAI工作负载进行了优化，能够自动捕获Agent执行过程中的关键信息，包括用户消息、系统提示词、模型推理结果、工具调用参数和返回值等。每个操作都会被封装为符合OpenTelemetry语义约定的span，并通过 Baggage 机制，自动添加相应的属性标签。</p>
<p>从上面的示例中可以看到，常用的元数据包括session.id（会话标识符）、gen_ai.system（AI系统标识，如strands-agents）、gen_ai.operation.name（操作名称，如chat）、gen_ai.request.model（请求的模型名称）以及各种token使用统计信息。这些元数据对于后续的数据分析和问题诊断至关重要。这些标准化的属性遵循OpenTelemetry GenAI语义约定，确保了不同Agent框架和监控平台之间的互操作性。</p>
<p>默认情况下，Agent应用产生的遥测数据会通过OTLP（OpenTelemetry Protocol）协议直接发送到CloudWatch的OTLP端点，这种直连方式简化了部署架构，减少了额外的基础设施维护成本。然而，在生产环境中，为了实现更灵活的数据处理和路由策略，通常会在数据源和目标系统之间部署OpenTelemetry Collector作为中间处理层。</p>
<p>OpenTelemetry Collector是一个功能强大的独立服务组件，专门用于接收、处理和导出遥测数据到多个目标系统。其架构采用了管道化设计，包含三个核心组件：Receivers（接收器）负责从各种数据源收集遥测数据，Processors（处理器）对数据执行转换、过滤、采样、属性增删等操作，Exporters（导出器）将处理后的数据发送到指定的后端系统。</p>
<p>在Agent可观测性场景中，Collector的处理器组件尤其有价值。例如，可以使用attributes处理器为特定的Agent span添加环境标签或业务标识，使用sampling处理器对高频操作进行智能采样以控制数据量，使用filter处理器过滤掉敏感信息或无关数据，使用batch处理器优化网络传输效率。这种流水线式的数据处理能力使企业能够根据具体需求定制化Agent遥测数据的收集和分发策略，实现成本效益的最优平衡。</p>
<h2 data-id="heading-7">三. 实践方式：开源生态以及亚马逊云科技托管方案</h2>
<p>在理解了Agent可观测性的核心概念和关键指标后，我们需要将这些理论转化为实际的技术实现。亚马逊云科技生态系统为Agent可观测性提供了完整的托管解决方案，同时开源社区也贡献了丰富的第三方工具。接下来，我们将详细探讨如何在不同的技术栈和部署环境中实现Agent的全方位监控。</p>
<h3 data-id="heading-8">3.1 Amazon Cloudwatch GenAI Observability</h3>
<p>Amazon Cloudwatch GenAI Observability 专门用于监控生成式AI工作负载，包括Amazon Bedrock AgentCore Runtime。它提供：</p>
<p>1、端到端提示词跟踪(End-to-end prompt tracing) – 跟踪 AI Agent 的所有行为（包含大模型推理和工具调用）</p>
<p>2、预配置仪表板 – 提供两个内置仪表板：</p>
<ol>
<li>Model Invocations – 详细的模型使用、token消耗和成本指标</li>
<li>Amazon Bedrock AgentCore agents – 代理的性能和决策指标</li>
</ol>
<p>3、关键指标监控：</p>
<ol>
<li>总调用次数和平均调用次数</li>
<li>Token使用情况（总数、每查询平均数、输入、输出）</li>
<li>延迟（平均值、P90、P99）</li>
<li>错误率和限流事件</li>
<li>按应用程序、用户角色或特定用户的成本归因</li>
</ol>
<p>GenAI Observability的核心是Cloudwatch Transation Search，GenAI Observability利用Cloudwatch Transation Search收集并转换的结构化日志进行AI工作负载的深度分析。</p>
<p>亚马逊云科技在现有X-ray跟踪服务的基础上，推出了CloudWatch Transaction Search。Transaction Search最核心的创新在于其双重存储策略，这一设计巧妙地平衡了成本效益与数据完整性。当用户启用Transaction Search时，所有发送到X-Ray的spans都会被自动转换为语义约定格式（semantic convention format），并以结构化日志的形式存储在CloudWatch Logs的专用日志组aws/spans中。这个转换过程完全透明，spans会自动采用W3C trace ID标准，确保与OpenTelemetry生态系统的完整兼容性。每个span都包含完整的追踪信息：开始时间、结束时间、持续时间，以及丰富的元数据，包括业务属性如客户ID、订单ID等。这些数据全部可以进行搜索和分析，完全消除了传统采样带来的”盲区”问题。</p>
<p>Transaction Search提供的搜索能力远超传统X-Ray的范畴。通过可视化编辑器，用户可以基于任意span属性进行搜索，包括服务名称、span持续时间、状态码，以及自定义的业务属性。系统支持多种查询格式，List格式专注于单个span的详细分析，特别适合故障排查。当出现问题时，工程师可以直接使用对应的业务ID快速定位相关的trace，然后深入分析具体的执行路径。Group analysis格式提供聚合分析能力，可以按照可用区、状态码或客户ID等维度进行分组统计，快速识别影响面最大的问题。对于熟悉SQL的用户，Transaction Search还支持CloudWatch Logs Insights查询语言，提供更灵活的数据分析能力。</p>
<h4 data-id="heading-9">a. 在 Bedrock AgentCore Runtime 上集成Cloudwatch GenAI Observability</h4>
<p>Bedrock AgentCore Observability 在 Cloudwatch GenAI Observability 的基础上，为 Bedrock AgentCore Runtime上运行的 Agent 提供更便捷的可观测性体验。在基础设施层面，AgentCore Runtime会自动创建和配置所需的CloudWatch日志组（如<code>/aws/bedrock-AgentCore/runtimes/&lt;agent_id&gt;-&lt;endpoint_name&gt;/runtime-logs</code>），自动处理IAM权限，并预配置好OTEL环境变量，应用只需添加Opentemeletry SDK即可使用，无需配置任何参数或环境变量。</p>
<p>AgentCore为不同资源类型提供差异化的默认观测能力：</p>
<p>Agent资源的指标可以在GenAI Observability页面直接查看，AgentCore自动提供针对Agent运行时的丰富指标，如Invocations（API请求总数）、Session Count（Agent会话总数）、细分的错误类型统计（InvocationError.Validation、InvocationError.Internal等），以及跨所有资源的聚合指标。</p>
<p>而Memory、Gateway、Tools资源的指标、spans和logs会自动路由到相应的CloudWatch组件中。特别是Memory资源，AgentCore提供了独特的深度可观测性，包括Creation Count（内存事件创建数量）、Memory特定的延迟指标，以及专门的工作流日志（提取日志和整合日志）。</p>
<p>我们提供基于 Jupyter Notebook 的快速使用指导，帮助您快速在 Amazon Bedrock AgentCore Runtime 上部署一个AI Agent，并从Bedrock AgentCore Observability 上观测Agent 的运行状况。您可以从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fawslabs%2Famazon-bedrock-agentcore-samples%2Ftree%2Fmain%2F01-tutorials%2F06-AgentCore-observability%2F01-Agentcore-runtime-hosted" target="_blank" title="https://github.com/awslabs/amazon-bedrock-agentcore-samples/tree/main/01-tutorials/06-AgentCore-observability/01-Agentcore-runtime-hosted" ref="nofollow noopener noreferrer">此处</a> 获取此快速使用指导。</p>
<h4 data-id="heading-10">b. 在其他计算服务上集成Amazon Cloudwatch GenAI Observability</h4>
<p>对于选择在自建运行环境（如EC2、EKS、Lambda等）部署Agent，但仍希望使用CloudWatch GenAI Observability能力的组织，可以通过标准的OpenTelemetry集成来实现。您可以在软件包管理器中安装ADOT SDK依赖，将SDK注入到Agent代码中，配置详细的OTEL环境变量后，即可将可观测性数据上送至Cloudwatch。CloudWatch GenAI Observability的体验与AgentCore一致，您同样可以基于Trace和Span进行查询，但无法使用Bedrock AgentCore Observability 的指标面板，需要您自行创建。</p>
<p>我们提供基于 Jupyter Notebook 的快速使用指导，帮助您在本地运行基于 Strands 框架的 AI Agent，并从Cloudwatch GenAI Observability 上观测Agent 的运行状况。您可以从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fawslabs%2Famazon-bedrock-agentcore-samples%2Ftree%2Fmain%2F01-tutorials%2F06-AgentCore-observability%2F01-Agentcore-runtime-hosted" target="_blank" title="https://github.com/awslabs/amazon-bedrock-agentcore-samples/tree/main/01-tutorials/06-AgentCore-observability/01-Agentcore-runtime-hosted" ref="nofollow noopener noreferrer">此处</a> 获取此快速使用指导。</p>
<h3 data-id="heading-11">3.2 MLFlow、Langfuse等第三方组件</h3>
<p>除了Cloudwatch GenAI Observability，许多开源第三方工具，例如Langfuse、MLFlow 也作为观测数据的分析平台。可以提供包括：数据可视化和分析界面，执行边缘案例分析，评估准确性和成本的权衡，分析用户交互模式，提供性能优化建议。</p>
<p>以Amazon SageMaker 托管的 <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fmachine-learning%2Faccelerating-generative-ai-development-with-fully-managed-mlflow-3-0-on-amazon-sagemaker-ai%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/machine-learning/accelerating-generative-ai-development-with-fully-managed-mlflow-3-0-on-amazon-sagemaker-ai/" ref="nofollow noopener noreferrer">MLFlow 3.0</a> 进行 Agent 开发中的 Tracing 为例，通过全托管 MLflow 3.0 的追踪能力，开发者可以记录请求每个中间步骤关联的输入、输出和元数据，从而准确定位错误根源和意外行为的来源。以下示例代码展示了使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstrandsagents.com%2Flatest%2F" target="_blank" title="https://strandsagents.com/latest/" ref="nofollow noopener noreferrer">Strands Agents</a> 来构建一个基本的 Agent 工作流及使用MLFlow来对其中间环节进行追踪。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@mlflow</span>.<span class="hljs-built_in">trace</span>(name= <span class="hljs-string">"strands-bedrock"</span>, attributes={<span class="hljs-string">"k"</span>: <span class="hljs-string">"v"</span>}, span_type=SpanType.LLM)
def <span class="hljs-built_in">get_model</span>():...

<span class="hljs-variable">@mlflow</span>.<span class="hljs-built_in">trace</span>(name= <span class="hljs-string">"strands-agent"</span>, attributes={<span class="hljs-string">"k"</span>: <span class="hljs-string">"v"</span>}, span_type=SpanType.AGENT)
def <span class="hljs-built_in">create_agent</span>(model):...

<span class="hljs-variable">@mlflow</span>.<span class="hljs-built_in">trace</span>(name= <span class="hljs-string">"strands-chain"</span>, attributes={<span class="hljs-string">"k"</span>: <span class="hljs-string">"v"</span>}, span_type=SpanType.CHAIN)
def <span class="hljs-built_in">run_agent</span>():
    model = <span class="hljs-built_in">get_model</span>()
    agent = <span class="hljs-built_in">create_agent</span>(model)
    return <span class="hljs-built_in">agent</span>(<span class="hljs-string">"Hi, where can I eat in San Francisco?"</span>)


with mlflow.<span class="hljs-built_in">start_run</span>(run_name=<span class="hljs-string">"StrandsAgentRun"</span>):
    results = <span class="hljs-built_in">run_agent</span>()
</code></pre>
<p>这些能力通过捕获工作负载服务、节点和工具执行的详细信息，为您的 AI 工作负载提供可观测性。可以在MLFlow Tracking Server 前端的 Trace 选项卡中，查看这些完整记录的执行信息。见如下示例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b51ab0e027547928564a26b08ae7667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=VPlx%2BLmfWFUZfI5G6E3sOcDl%2BjE%3D" alt="图3.png" loading="lazy"/></p>
<p align="center">图3. MLFlow trace页面</p>
<p>同时，对于使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fbedrock%2Fagentcore%2F" target="_blank" title="https://aws.amazon.com/cn/bedrock/agentcore/" ref="nofollow noopener noreferrer">Bedrock AgentCore</a> 执行环境的Agents工作流来说，可以直接利用其集成至CloudWatch中的 GenAI Observability能力，直接获取整个Agent调用链的轨迹信息。见以下基于 AgentCore 进行 Strands Agents 搭建的调试示例。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a73681984544ba5bac8afcd89ad0849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=2rS53NEdOGMZX0pb6eH5yAqZ764%3D" alt="图4.png" loading="lazy"/></p>
<p align="center">图4. CloudWatch GenAI Observability页面</p>
<p>除了MLFlow之外，也可使用其他可观测性平台，例如Langfuse是一个专为LLM应用设计的开源可观测性平台，提供了完整的追踪、评估和分析能力。它支持多种LLM框架的集成，能够自动捕获Agent的执行轨迹、token使用情况和成本信息，并通过直观的Web界面展示这些数据，帮助开发者快速识别性能瓶颈和优化机会。</p>
<h2 data-id="heading-12">四. 利用可观测性组件运维 Agent</h2>
<p>此部分将以基于 Strands Agent 构建的电商售后智能客服为例，展示如何在应用开发和生产迭代的过程中遇到的多个场景使用可观测性组件进行运维。</p>
<p>示例环境可根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcatalog.us-east-1.prod.workshops.aws%2Fworkshops%2F93a2eb2c-7f00-463a-92f1-ab0e6e81f48b%2Fzh-CN" target="_blank" title="https://catalog.us-east-1.prod.workshops.aws/workshops/93a2eb2c-7f00-463a-92f1-ab0e6e81f48b/zh-CN" ref="nofollow noopener noreferrer">workshop</a> 进行创建，创建资源包括一个含有订单数据表格并通过 api gateway 对外暴露的电商系统，和一个通过网页交互的电商售后智能客服应用，智能客服 Agent 应用通过添加多个 MCP servers，其中包括调用电商系统的 API Gateway 接口的工具，来实现对电商系统中的订单进行查询并按照售后流程定义规则进行处理的功能。以下为智能客服的页面截图，支持添加丰富的 MCP servers, 选择不同的 LLM 模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e0ca1f124d4f2f9a92f6076e37b75c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=xAzPU7jBWvjDMWOuDIkD47Dxtjs%3D" alt="图5.png" loading="lazy"/></p>
<p align="center">图5.  Agent应用客户端界面</p>
<p>以上应用在开发阶段会在前端页面显示所有的模型和工具调用信息，在实际生产环境中基于数据安全应该在前端隐去。此时则可以将 Agent 的追踪数据打入到 Langfuse 平台进行监控，来保证重要指标的收集和功能异常的分析。</p>
<ol>
<li>模拟新模型发布，针对不同的 LLM 模型进行效果和成本对比测试</li>
</ol>
<p>使用两个不同的 user 对相同的问题进行测试，在 Langfuse 中观察到不同的 Latency, Token 和 Cost , 可以观察到 Claude 3.7 和 Nova Lite 分析过程和对工具的调用次数上一致，Claude 3.7 在成本上更有优势，而 Nova Lite 则在成本上更有优势。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2162c1e1c81c448b96e7715c9a89a501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=F64Y0Pe7aERI%2FEN%2BVuBITs0FQkk%3D" alt="图6.webp" loading="lazy"/></p>
<p align="center">图6. 使用Langfuse对模型分析对比</p>
<ol start="2">
<li>模拟模型混用、网关智能路由的场景</li>
</ol>
<p>假设基于测试结果，团队希望使用 Nova Lite 为主要模型，Claude 3.7 为备用模型 ，对话过程中交替切换 LLM 来进行充分测试，发现出现错误。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a11241ce6763454fa99ee6f16d879234~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=CrDO4rHdVe19DovBpxUpR0RfBzA%3D" alt="图7.webp" loading="lazy"/></p>
<p align="center">图7. Agent客户端错误示例</p>
<p>从 Langfuse 页面可以快速定位到历史对话采用 Claude 3.7 模型和当前切换的 Nova Lite 模型的信息格式不一致导致调用出错。基于此类的追踪分析，可以针对性的快速解决开发迭代和生产中遇到的问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98ff6c8a19074ec4b00dda733680e549~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=Z%2FJcrir7ZDifFnIj38EptyOxpWU%3D" alt="图8.png" loading="lazy"/></p>
<p align="center">图8. 使用Langfuse分析错误日志</p>
<ol start="3">
<li>模拟新功能上线，分析功能调用全流程</li>
</ol>
<p>售后客服扩展功能为不同卖家提供数据查询功能，应用后端通过 Mysql MCP server 接入电商系统数据库。以数据查询“查询今年销售额最高的3个客户”为例，虽然两种模型都可以完成查询，通过调用流程可以看到 Claude 3.7 对数据查询语句的生成思考更严谨，更适合用在数据分析的场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f279e31f60064320933db1599612c1d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=kqk92sAo4Yx41lHcJDI6pfDC148%3D" alt="图9.png" loading="lazy"/></p>
<p align="center">图9.  使用Langfuse分析调用全流程</p>
<h2 data-id="heading-13">五. 结语</h2>
<p>随着 AI Agent 在企业应用中扮演越来越重要的角色，建立完善的可观测性体系已成为确保其可靠运行的关键基础设施。本文探讨了 Agent 可观测性的核心要素、实现方式和最佳实践，为开发团队提供了一个实用的参考框架，详细介绍了亚马逊云科技生态系统为 Agent 可观测性提供的完整解决方案。通过 CloudWatch GenAI Observability 和 Bedrock AgentCore Observability，团队可以快速获得对 Agent 系统的全面洞察，无需复杂的基础设施搭建。这些服务与 OpenTelemetry 的深度集成，不仅确保了与开源生态的互操作性，更为后续的分析和优化提供了坚实基础。</p>
<p>我们建议您从访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.aws.amazon.com%2Fbedrock" target="_blank" title="https://console.aws.amazon.com/bedrock" ref="nofollow noopener noreferrer">Amazon Bedrock</a> 控制台开始，体验 CloudWatch GenAI Observability 的监控能力，并参考本文提供的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fawslabs%2Famazon-bedrock-agentcore-samples%2Ftree%2Fmain%2F01-tutorials%2F06-AgentCore-observability" target="_blank" title="https://github.com/awslabs/amazon-bedrock-agentcore-samples/tree/main/01-tutorials/06-AgentCore-observability" ref="nofollow noopener noreferrer">Agent Observability 示例代码</a>将 Agent 应用接入这些服务。在 Amazon Sample 仓库中还有<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faws-samples%2Fsample-agentic-platform" target="_blank" title="https://github.com/aws-samples/sample-agentic-platform" ref="nofollow noopener noreferrer">更多资源</a>供您参考。</p>
<p>随着AI Agent在企业应用中的广泛部署，可观测性已经从”锦上添花”的辅助工具转变为”不可或缺”的核心能力。传统的监控方式虽然能够告诉我们系统的运行状态，但面对Agent的复杂决策链条和多步推理过程，我们需要更深层次的洞察能力。</p>
<p>通过本文介绍的多维度可观测性框架，我们不仅能够监控Agent的性能指标和资源消耗，更重要的是能够理解Agent的”思考过程”——从意图理解到工具调用，从推理链条到最终输出的完整决策轨迹。亚马逊云科技提供的CloudWatch GenAI Observability和Bedrock AgentCore等托管服务，结合开源生态中的MLFlow、Langfuse等工具，为企业构建Agent可观测性提供了完整的技术栈支持。无论是选择全托管的便捷方案，还是基于开源工具的灵活定制，企业都能找到适合自身需求的实施路径。</p>
<p>在AI Agent成为企业数字化转型重要推动力的今天，建立完善的可观测性体系不仅是技术需要，更是业务成功的关键保障。只有真正”看见”和”理解”Agent的行为，我们才能充分释放其潜力，让AI真正成为企业的智能助手和效率倍增器。</p>
<p><strong>本篇作者</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/022e3d1c2df74dc08f75e3fcdb676ce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763600074&amp;x-signature=tmM3VmOSugf9bVaUOpipETRU%2B0E%3D" alt="作者.webp" loading="lazy"/>
关于<strong>Agentic AI</strong>基础设施的更多实践经验参考，欢迎点击：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentive-ai-infrastructure-practice-series-1" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentive-ai-infrastructure-practice-series-1" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（一）：Agent应用开发与落地实践思考</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-sandbox-practice%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-sandbox-practice/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（二）：专用沙盒环境的必要性与实践方案</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-deep-practice-experience-thinking-series-three-best-practices-for-agent-memory-module" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-deep-practice-experience-thinking-series-three-best-practices-for-agent-memory-module" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（三）：Agent记忆模块的最佳实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-experience-series-four-mcp-server-from-local" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-experience-series-four-mcp-server-from-local" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（四）：MCP服务器从本地到云端的部署演进</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-series-5%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-series-5/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（五）：Agent应用系统中的身份认证与授权管理</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagent-quality-evaluation%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agent-quality-evaluation/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（六）：Agent质量评估</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-series-7%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-series-7/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fprivacy-and-security-of-agent-applications" target="_blank" title="https://aws.amazon.com/cn/blogs/china/privacy-and-security-of-agent-applications" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（八）：Agent应用的隐私和安全</a></p>
<p>*前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（120）Redis的常见错误如何处理？]]></title>    <link>https://juejin.cn/post/7571672422689636404</link>    <guid>https://juejin.cn/post/7571672422689636404</guid>    <pubDate>2025-11-12T23:12:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571672422689636404" data-draft-id="7571655979256774696" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（120）Redis的常见错误如何处理？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T23:12:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（120）Redis的常见错误如何处理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:12:42.000Z" title="Wed Nov 12 2025 23:12:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 作为一个高性能的内存数据库和缓存系统，在使用过程中难免会遇到各种错误和异常。以下是一些常见的 Redis 错误及其处理方法，结合代码示例进行详细讲解。</p>
<h3 data-id="heading-0">1. 连接错误</h3>
<h4 data-id="heading-1">问题描述</h4>
<p>当无法连接到 Redis 服务器时，可能会出现连接错误。这通常是由于 Redis 服务器未启动、网络问题或连接配置错误引起的。</p>
<h4 data-id="heading-2">解决方法</h4>
<ul>
<li>确保 Redis 服务器已启动并监听正确的端口。</li>
<li>检查网络连接。</li>
<li>确认客户端配置正确。</li>
</ul>
<h4 data-id="heading-3">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisConnectionException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConnectionExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            jedis.ping();
            System.out.println(<span class="hljs-string">"Connected to Redis"</span>);
        } <span class="hljs-keyword">catch</span> (JedisConnectionException e) {
            System.err.println(<span class="hljs-string">"Cannot connect to Redis: "</span> + e.getMessage());
            <span class="hljs-comment">// 尝试重新连接或其他处理逻辑</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2. 认证错误</h3>
<h4 data-id="heading-5">问题描述</h4>
<p>如果 Redis 服务器配置了密码保护，客户端在未提供正确密码的情况下尝试进行操作，会出现认证错误。</p>
<h4 data-id="heading-6">解决方法</h4>
<ul>
<li>确认客户端提供的密码正确。</li>
<li>检查 Redis 服务器的 <code>requirepass</code> 配置项。</li>
</ul>
<h4 data-id="heading-7">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAuthExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            jedis.auth(<span class="hljs-string">"your_password_here"</span>);
            jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key"</span>);
            System.out.println(<span class="hljs-string">"key: "</span> + value);
        } <span class="hljs-keyword">catch</span> (JedisDataException e) {
            <span class="hljs-keyword">if</span> (e.getMessage().contains(<span class="hljs-string">"NOAUTH"</span>)) {
                System.err.println(<span class="hljs-string">"Authentication failed: "</span> + e.getMessage());
            } <span class="hljs-keyword">else</span> {
                System.err.println(<span class="hljs-string">"Data error: "</span> + e.getMessage());
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-8">3. 内存不足错误</h3>
<h4 data-id="heading-9">问题描述</h4>
<p>当 Redis 达到配置的最大内存限制时，可能会出现内存不足错误。这通常是由于内存占用过多、缓存策略不当或数据量过大引起的。</p>
<h4 data-id="heading-10">解决方法</h4>
<ul>
<li>配置合理的 <code>maxmemory</code> 和缓存淘汰策略。</li>
<li>清理不必要的数据。</li>
<li>考虑水平扩展 Redis 集群。</li>
</ul>
<h4 data-id="heading-11">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisMemoryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 设置最大内存为 100MB</span>
            jedis.configSet(<span class="hljs-string">"maxmemory"</span>, <span class="hljs-string">"100mb"</span>);
            jedis.configSet(<span class="hljs-string">"maxmemory-policy"</span>, <span class="hljs-string">"allkeys-lru"</span>);

            <span class="hljs-comment">// 填充数据以模拟内存不足</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
                jedis.set(<span class="hljs-string">"key"</span> + i, <span class="hljs-string">"value"</span> + i);
            }
        } <span class="hljs-keyword">catch</span> (JedisDataException e) {
            <span class="hljs-keyword">if</span> (e.getMessage().contains(<span class="hljs-string">"OOM"</span>)) {
                System.err.println(<span class="hljs-string">"Out of memory: "</span> + e.getMessage());
            } <span class="hljs-keyword">else</span> {
                System.err.println(<span class="hljs-string">"Data error: "</span> + e.getMessage());
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-12">4. 命令错误</h3>
<h4 data-id="heading-13">问题描述</h4>
<p>当客户端发送了无效或语法错误的命令时，Redis 会返回命令错误。</p>
<h4 data-id="heading-14">解决方法</h4>
<ul>
<li>确认命令的语法和参数正确。</li>
<li>检查命令是否被重命名或禁用。</li>
</ul>
<h4 data-id="heading-15">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCommandExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 尝试执行无效命令</span>
            jedis.sendCommand(() -&gt; <span class="hljs-string">"INVALIDCOMMAND"</span>);
        } <span class="hljs-keyword">catch</span> (JedisDataException e) {
            System.err.println(<span class="hljs-string">"Command error: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-16">5. 阻塞操作错误</h3>
<h4 data-id="heading-17">问题描述</h4>
<p>一些 Redis 操作（如 <code>BLPOP</code>、<code>BRPOP</code> 等）可能会导致阻塞，从而引起客户端超时或其他问题。</p>
<h4 data-id="heading-18">解决方法</h4>
<ul>
<li>确认使用阻塞操作的场景合理。</li>
<li>设置合理的超时时间。</li>
<li>考虑使用非阻塞操作替代。</li>
</ul>
<h4 data-id="heading-19">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisConnectionException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisBlockingExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            jedis.lpush(<span class="hljs-string">"mylist"</span>, <span class="hljs-string">"item1"</span>);
            jedis.lpush(<span class="hljs-string">"mylist"</span>, <span class="hljs-string">"item2"</span>);

            <span class="hljs-comment">// 尝试阻塞获取元素，超时为 5 秒</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.blpop(<span class="hljs-number">5</span>, <span class="hljs-string">"mylist"</span>).get(<span class="hljs-number">1</span>);
            System.out.println(<span class="hljs-string">"Popped item: "</span> + result);
        } <span class="hljs-keyword">catch</span> (JedisConnectionException e) {
            System.err.println(<span class="hljs-string">"Blocking operation failed: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-20">6. 持久化错误</h3>
<h4 data-id="heading-21">问题描述</h4>
<p>Redis 提供 RDB 和 AOF 两种持久化机制，可能会出现持久化失败或数据恢复错误。</p>
<h4 data-id="heading-22">解决方法</h4>
<ul>
<li>检查持久化配置是否正确。</li>
<li>确认磁盘空间充足。</li>
<li>定期备份数据并验证恢复流程。</li>
</ul>
<h4 data-id="heading-23">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.exceptions.JedisDataException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisPersistenceExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发 RDB 持久化</span>
            jedis.save();
            System.out.println(<span class="hljs-string">"RDB persistence triggered."</span>);

            <span class="hljs-comment">// 手动触发 AOF 持久化</span>
            jedis.bgrewriteaof();
            System.out.println(<span class="hljs-string">"AOF persistence triggered."</span>);
        } <span class="hljs-keyword">catch</span> (JedisDataException e) {
            System.err.println(<span class="hljs-string">"Persistence error: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-24">总结</h3>
<p>通过上述示例代码，可以帮助你更好地理解和处理 Redis 的常见错误。合理地配置和使用 Redis，可以有效地提高系统的稳定性和性能。此外，监控和日志记录也是确保 Redis 正常运行的重要手段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（121）Redis的数据恢复如何进行？]]></title>    <link>https://juejin.cn/post/7571655979256791080</link>    <guid>https://juejin.cn/post/7571655979256791080</guid>    <pubDate>2025-11-12T23:13:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655979256791080" data-draft-id="7571650164844412962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（121）Redis的数据恢复如何进行？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T23:13:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（121）Redis的数据恢复如何进行？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T23:13:22.000Z" title="Wed Nov 12 2025 23:13:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 提供了多种数据持久化机制，包括 RDB 和 AOF，以便在服务器重启或故障时恢复数据。以下是 Redis 数据恢复的详细介绍及代码示例。</p>
<h3 data-id="heading-0">1. 使用 RDB 文件恢复数据</h3>
<p>RDB（Redis DataBase）是 Redis 快照持久化机制，它会在指定的时间间隔内生成数据库的二进制快照文件（即 <code>.rdb</code> 文件）。当 Redis 服务器重启时，可以通过加载 RDB 文件恢复数据。</p>
<h4 data-id="heading-1">配置 RDB</h4>
<p>在 <code>redis.conf</code> 文件中配置 RDB 相关选项：</p>
<pre><code class="hljs language-conf" lang="conf"># 配置在 900 秒（15 分钟）内如果至少有 1 次写操作，则进行一次快照
save 900 1
# 配置在 300 秒（5 分钟）内如果至少有 10 次写操作，则进行一次快照
save 300 10
# 配置在 60 秒（1 分钟）内如果至少有 10000 次写操作，则进行一次快照
save 60 10000

# RDB 文件的存储路径
dir /var/lib/redis

# RDB 文件名称
dbfilename dump.rdb
</code></pre>
<h4 data-id="heading-2">恢复 RDB 数据</h4>
<p>当 Redis 服务器重启时，它会自动加载 <code>dump.rdb</code> 文件恢复数据。以下是一个简单的代码示例，展示如何手动触发 RDB 快照并恢复数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisRDBExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发 RDB 快照</span>
            jedis.save();
            System.out.println(<span class="hljs-string">"RDB snapshot created."</span>);

            <span class="hljs-comment">// 模拟重启：停止和重新启动 Redis 服务器</span>
            <span class="hljs-comment">// 将自动加载 dump.rdb 文件恢复数据</span>
            <span class="hljs-comment">// 这里假设 Redis 服务恢复后，客户端重新连接</span>

            <span class="hljs-comment">// 验证数据是否恢复</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"your_key"</span>);
            System.out.println(<span class="hljs-string">"Recovered value: "</span> + value);
        }
    }
}
</code></pre>
<h3 data-id="heading-3">2. 使用 AOF 文件恢复数据</h3>
<p>AOF（Append-Only File）是 Redis 另一种持久化机制，它会记录每一个写操作，并以追加的方式写入日志文件。相比于 RDB，AOF 提供了更高的数据恢复精度。</p>
<h4 data-id="heading-4">配置 AOF</h4>
<p>在 <code>redis.conf</code> 文件中配置 AOF 相关选项：</p>
<pre><code class="hljs language-conf" lang="conf"># 启用 AOF 持久化
appendonly yes

# AOF 文件名称
appendfilename "appendonly.aof"

# AOF 刷新策略，默认为 everysec
# appendfsync always  - 每次写操作都会触发 fsync，最安全但性能最低
# appendfsync everysec  - 每秒执行一次 fsync，平衡安全和性能
# appendfsync no  - 由操作系统决定何时写入磁盘，性能最高但最不安全
appendfsync everysec

# AOF 重写配置，防止 AOF 文件过大
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
</code></pre>
<h4 data-id="heading-5">恢复 AOF 数据</h4>
<p>Redis 服务器重启时，会自动加载 <code>appendonly.aof</code> 文件恢复数据。以下是一个简单的代码示例，展示如何手动触发 AOF 重写并恢复数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAOFExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发 AOF 重写</span>
            jedis.bgrewriteaof();
            System.out.println(<span class="hljs-string">"AOF rewrite triggered."</span>);

            <span class="hljs-comment">// 模拟重启：停止和重新启动 Redis 服务器</span>
            <span class="hljs-comment">// 将自动加载 appendonly.aof 文件恢复数据</span>
            <span class="hljs-comment">// 这里假设 Redis 服务恢复后，客户端重新连接</span>

            <span class="hljs-comment">// 验证数据是否恢复</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"your_key"</span>);
            System.out.println(<span class="hljs-string">"Recovered value: "</span> + value);
        }
    }
}
</code></pre>
<h3 data-id="heading-6">3. RDB 和 AOF 结合使用</h3>
<p>Redis 允许同时启用 RDB 和 AOF 持久化，以便在系统重启时选择最适合的数据恢复方式。通常，Redis 会优先使用 AOF 文件恢复数据，因为 AOF 提供了更高的数据恢复精度。</p>
<h4 data-id="heading-7">配置 RDB 和 AOF</h4>
<p>在 <code>redis.conf</code> 文件中同时配置 RDB 和 AOF 相关选项：</p>
<pre><code class="hljs language-conf" lang="conf"># RDB 配置
save 900 1
save 300 10
save 60 10000
dir /var/lib/redis
dbfilename dump.rdb

# AOF 配置
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
</code></pre>
<h3 data-id="heading-8">4. 数据备份与恢复</h3>
<p>除了 RDB 和 AOF 持久化，定期备份数据是确保数据安全的另一种有效方法。可以通过复制 RDB 和 AOF 文件进行备份和恢复。</p>
<h4 data-id="heading-9">数据备份</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 复制 RDB 文件进行备份</span>
<span class="hljs-built_in">cp</span> /var/lib/redis/dump.rdb /backup/dump.rdb

<span class="hljs-comment"># 复制 AOF 文件进行备份</span>
<span class="hljs-built_in">cp</span> /var/lib/redis/appendonly.aof /backup/appendonly.aof
</code></pre>
<h4 data-id="heading-10">数据恢复</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 停止 Redis 服务</span>
sudo systemctl stop redis

<span class="hljs-comment"># 恢复 RDB 文件</span>
<span class="hljs-built_in">cp</span> /backup/dump.rdb /var/lib/redis/dump.rdb

<span class="hljs-comment"># 恢复 AOF 文件</span>
<span class="hljs-built_in">cp</span> /backup/appendonly.aof /var/lib/redis/appendonly.aof

<span class="hljs-comment"># 启动 Redis 服务</span>
sudo systemctl start redis
</code></pre>
<h3 data-id="heading-11">5. 使用 Redis Cluster 恢复数据</h3>
<p>在 Redis Cluster 中，数据分布在多个节点上。恢复集群中的数据需要分别恢复每个节点的数据。以下是一个简单的示例：</p>
<h4 data-id="heading-12">配置 Redis Cluster 持久化</h4>
<p>在每个节点的 <code>redis.conf</code> 文件中配置 RDB 和 AOF：</p>
<pre><code class="hljs language-conf" lang="conf"># RDB 配置
save 900 1
save 300 10
save 60 10000
dir /var/lib/redis
dbfilename dump.rdb

# AOF 配置
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
</code></pre>
<h4 data-id="heading-13">恢复 Redis Cluster 数据</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 停止 Redis Cluster 节点</span>
sudo systemctl stop redis-node1
sudo systemctl stop redis-node2
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 恢复 RDB 和 AOF 文件</span>
<span class="hljs-built_in">cp</span> /backup/dump-node1.rdb /var/lib/redis-node1/dump.rdb
<span class="hljs-built_in">cp</span> /backup/appendonly-node1.aof /var/lib/redis-node1/appendonly.aof
<span class="hljs-built_in">cp</span> /backup/dump-node2.rdb /var/lib/redis-node2/dump.rdb
<span class="hljs-built_in">cp</span> /backup/appendonly-node2.aof /var/lib/redis-node2/appendonly.aof
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 启动 Redis Cluster 节点</span>
sudo systemctl start redis-node1
sudo systemctl start redis-node2
<span class="hljs-comment"># ...</span>
</code></pre>
<h3 data-id="heading-14">总结</h3>
<p>Redis 提供了多种数据持久化和恢复机制，包括 RDB、AOF 以及定期备份和恢复。通过合理配置和管理这些机制，可以确保 Redis 数据的高可用性和可靠性。上述代码示例展示了如何手动触发持久化操作、配置持久化选项以及执行数据备份和恢复操作。结合具体的业务需求，可以进一步优化和定制 Redis 的数据恢复策略。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>