<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[openGauss赋能智能客服：AI时代的企业服务变革]]></title>    <link>https://juejin.cn/post/7577228831138103339</link>    <guid>https://juejin.cn/post/7577228831138103339</guid>    <pubDate>2025-11-27T12:57:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577228831138103339" data-draft-id="7577228831138086955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openGauss赋能智能客服：AI时代的企业服务变革"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-27T12:57:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openGauss赋能智能客服：AI时代的企业服务变革
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:57:08.000Z" title="Thu Nov 27 2025 12:57:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>随着人工智能技术的飞速发展，企业对智能客服系统的需求日益增长。传统的客服系统面临着数据管理复杂、响应效率低、个性化服务不足等挑战。openGauss作为一款开源企业级关系型数据库，凭借其强大的数据处理能力、向量数据库支持和AI友好的特性，为智能客服系统的构建提供了坚实的数据基础。本文探讨了openGauss在智能客服领域的应用，分析了其如何赋能企业实现高效、智能、个性化的客户服务体验。</p>
<h2 data-id="heading-1">背景与机遇</h2>
<h4 data-id="heading-2">AI智能客服的背景</h4>
<p>在数字化转型的浪潮中，企业客服已从简单的问题解答演进为复杂的客户关系管理和服务创新的重要环节。根据行业数据显示，企业平均每年处理数百万级别的客户咨询，传统的人工客服模式面临以下挑战：</p>
<ul>
<li>
<p><strong>效率瓶颈</strong>：人工客服响应时间长，无法24小时全天候服务</p>
</li>
<li>
<p><strong>成本压力</strong>：客服人员培训、管理成本高，人员流动率大</p>
</li>
<li>
<p><strong>服务质量不均</strong>：服务质量依赖于个人能力，难以保证一致性</p>
</li>
<li>
<p><strong>数据孤岛</strong>：客户信息分散，难以形成统一的知识库</p>
</li>
<li>
<p><strong>个性化不足</strong>：无法根据客户历史和偏好提供定制化服务</p>
</li>
</ul>
<h4 data-id="heading-3">AI智能客服的机遇</h4>
<p>人工智能技术的突破为客服行业带来了新的机遇。通过自然语言处理（NLP）、机器学习（ML）和大语言模型（LLM）等技术，企业可以构建能够理解客户意图、自动生成回复、持续学习改进的智能客服系统。</p>
<p>然而，构建高效的AI智能客服系统需要一个强大的数据基础设施，这正是openGauss的优势所在。</p>
<h2 data-id="heading-4">openGauss的核心能力</h2>
<h4 data-id="heading-5">企业级数据库特性</h4>
<p>openGauss是华为自主研发的开源企业级关系型数据库，具有以下核心特性：</p>
<h5 data-id="heading-6">高性能</h5>
<ul>
<li>
<p><strong>OLTP****优化</strong>：针对在线事务处理进行深度优化，支持高并发场景</p>
</li>
<li>
<p><strong>查询加速</strong>：先进的查询优化器和执行引擎，毫秒级响应</p>
</li>
<li>
<p><strong>批量处理</strong>：支持大规模数据导入和处理，提升数据吞吐量</p>
</li>
</ul>
<h5 data-id="heading-7">高可用性</h5>
<ul>
<li>
<p><strong>主备一体化</strong>：支持同步复制，确保数据零丢失</p>
</li>
<li>
<p><strong>故障自动转移</strong>：秒级故障检测和自动切换</p>
</li>
<li>
<p><strong>多副本机制</strong>：支持多个备份副本，提升系统可靠性</p>
</li>
</ul>
<h5 data-id="heading-8">安全性</h5>
<ul>
<li>
<p><strong>多层安全防护</strong>：身份认证、权限控制、数据加密</p>
</li>
<li>
<p><strong>审计日志</strong>：完整的操作审计，满足合规要求</p>
</li>
<li>
<p><strong>数据隐私保护</strong>：支持行级安全策略和数据脱敏</p>
</li>
</ul>
<h4 data-id="heading-9">向量数据库能力</h4>
<p>openGauss集成了向量数据库功能，这是AI应用的关键：</p>
<h5 data-id="heading-10">向量存储与检索</h5>
<ul>
<li>
<p><strong>高维向量支持</strong>：原生支持高维向量数据类型</p>
</li>
<li>
<p><strong>向量索引</strong>：支持IVFFlat、HNSW等高效索引算法</p>
</li>
<li>
<p><strong>相似度搜索</strong>：毫秒级的向量相似度查询</p>
</li>
</ul>
<h5 data-id="heading-11">向量与关系数据融合</h5>
<ul>
<li>
<p><strong>统一存储</strong>：向量和结构化数据在同一数据库中管理</p>
</li>
<li>
<p><strong>联合查询</strong>：支持向量与关系数据的混合查询</p>
</li>
<li>
<p><strong>事务一致性</strong>：保证向量和关系数据的一致性</p>
</li>
</ul>
<h4 data-id="heading-12">AI友好的特性</h4>
<h5 data-id="heading-13">向量化计算</h5>
<ul>
<li>
<p><strong>SIMD****优化</strong>：充分利用现代CPU的向量化指令</p>
</li>
<li>
<p><strong>GPU****加速</strong>：支持GPU加速的向量计算</p>
</li>
<li>
<p><strong>批量操作</strong>：高效的批量向量操作</p>
</li>
</ul>
<h5 data-id="heading-14">与AI框架的集成</h5>
<ul>
<li>
<p><strong>Python支持</strong>：原生支持Python客户端和存储过程</p>
</li>
<li>
<p><strong>开源生态</strong>：与TensorFlow、PyTorch等主流AI框架兼容</p>
</li>
<li>
<p><strong>向量化接口</strong>：提供友好的向量操作API</p>
</li>
</ul>
<h2 data-id="heading-15">智能客服系统架构</h2>
<h4 data-id="heading-16">系统整体架构</h4>
<p>表现层 (Controller)</p>
<p>↓</p>
<p>业务层 (Service)</p>
<p>↓</p>
<p>数据访问层 (Repository)</p>
<p>↓</p>
<p>数据模型层 (Entity)</p>
<p>↓</p>
<p>数据库层 (openGauss/PostgreSQL)</p>
<h4 data-id="heading-17">核心模块设计</h4>
<h5 data-id="heading-18">智能问答模块</h5>
<ul>
<li>
<p>基于向量相似度的语义搜索</p>
</li>
<li>
<p>支持多知识库条目排序</p>
</li>
<li>
<p>可配置的相似度阈值和返回数量</p>
</li>
<li>
<p><strong>实现类</strong>: SmartCustomerService.smartQA()</p>
</li>
</ul>
<h5 data-id="heading-19">个性化推荐模块</h5>
<ul>
<li>
<p>基于客户档案向量的推荐</p>
</li>
<li>
<p>考虑优先级和VIP等级的加权计算</p>
</li>
<li>
<p>动态生成个性化结果</p>
</li>
<li>
<p><strong>实现类</strong>: SmartCustomerService.getPersonalizedRecommendations()</p>
</li>
</ul>
<h5 data-id="heading-20">对话管理模块</h5>
<ul>
<li>
<p>多渠道对话支持（Web/App/微信等）</p>
</li>
<li>
<p>完整的对话历史记录</p>
</li>
<li>
<p>对话状态跟踪和意图识别</p>
</li>
<li>
<p><strong>实现类</strong>: SmartCustomerService.createConversationSession(), logMessage(), closeConversationSession()</p>
</li>
</ul>
<h5 data-id="heading-21">客户档案管理模块</h5>
<ul>
<li>
<p>客户基本信息管理</p>
</li>
<li>
<p>VIP等级和消费统计</p>
</li>
<li>
<p>个性化偏好存储</p>
</li>
<li>
<p><strong>实现类</strong>: SmartCustomerService.updateCustomerProfile()</p>
</li>
</ul>
<h5 data-id="heading-22">数据分析模块</h5>
<ul>
<li>
<p>满意度分析视图</p>
</li>
<li>
<p>意图分布统计</p>
</li>
<li>
<p>解决率和高满意度率计算</p>
</li>
<li>
<p><strong>实现方式</strong>: SQL视图 (satisfaction_analysis, intent_distribution)</p>
</li>
</ul>
<h2 data-id="heading-23">实现最佳实践</h2>
<h4 data-id="heading-24">数据模型设计</h4>
<h5 data-id="heading-25">向量维度选择</h5>
<ul>
<li>
<p><strong>推荐维度</strong>：657-1435维</p>
</li>
<li>
<p><strong>权衡考虑</strong>：维度越高精度越好，但存储和计算成本增加</p>
</li>
<li>
<p><strong>选择建议</strong>：根据具体的embedding模型选择，如BERT使用657维，OpenAI embedding使用1435维</p>
</li>
</ul>
<h5 data-id="heading-26">向量索引策略</h5>
<p>-- IVFFlat索引：适合大规模数据，查询速度快</p>
<p>CREATE INDEX idx_ivf ON knowledge_base</p>
<p>USING ivfflat (embedding vector_cosine_ops)</p>
<p>WITH (lists = 100);</p>
<p>-- HNSW索引：适合高维数据，精度高</p>
<p>CREATE INDEX idx_hnsw ON knowledge_base</p>
<p>USING hnsw (embedding vector_cosine_ops)</p>
<p>WITH (m = 15, ef_construction = 200);</p>
<h5 data-id="heading-27">混合查询优化</h5>
<p>-- 结合向量相似度和关键字匹配</p>
<p>SELECT id, title, content,</p>
<p>1 - (embedding &lt;=&gt; query_embedding) as similarity</p>
<p>FROM knowledge_base</p>
<p>WHERE category = 'faq'</p>
<p>AND (title ILIKE '%关键词%' OR content ILIKE '%关键词%')</p>
<p>ORDER BY similarity DESC</p>
<p>LIMIT 10;</p>
<h4 data-id="heading-28">性能优化</h4>
<h5 data-id="heading-29">查询优化</h5>
<ul>
<li>
<p><strong>使用向量索引</strong>：确保向量查询使用索引</p>
</li>
<li>
<p><strong>限制返回结果</strong>：使用LIMIT限制返回数量</p>
</li>
<li>
<p><strong>批量操作</strong>：使用批量插入提升写入性能</p>
</li>
<li>
<p><strong>连接池</strong>：使用连接池管理数据库连接</p>
</li>
</ul>
<h5 data-id="heading-30">存储优化</h5>
<ul>
<li>
<p><strong>分区策略</strong>：按时间或类别分区大表</p>
</li>
<li>
<p><strong>压缩</strong>：启用表压缩减少存储空间</p>
</li>
<li>
<p><strong>清理过期数据</strong>：定期清理过期的交互记录</p>
</li>
</ul>
<h5 data-id="heading-31">并发控制</h5>
<p>-- 使用行级锁保证并发安全</p>
<p>BEGIN;</p>
<p>SELECT * FROM customer_profile</p>
<p>WHERE customer_id = 'cust_001'</p>
<p>FOR UPDATE;</p>
<p>-- 更新操作</p>
<p>COMMIT;</p>
<h4 data-id="heading-32">数据安全与隐私</h4>
<h5 data-id="heading-33">访问控制</h5>
<p>-- 创建角色和权限</p>
<p>CREATE ROLE customer_service_user;</p>
<p>GRANT SELECT ON knowledge_base TO customer_service_user;</p>
<p>GRANT SELECT, INSERT ON interaction_log TO customer_service_user;</p>
<p>-- 行级安全策略</p>
<p>CREATE POLICY customer_isolation ON customer_profile</p>
<p>USING (customer_id = current_user_id);</p>
<h5 data-id="heading-34">数据加密</h5>
<ul>
<li>
<p><strong>传输加密</strong>：使用SSL/TLS加密数据库连接</p>
</li>
<li>
<p><strong>存储加密</strong>：启用透明数据加密（TDE）</p>
</li>
<li>
<p><strong>字段加密</strong>：对敏感信息进行加密存储</p>
</li>
</ul>
<h5 data-id="heading-35">审计日志</h5>
<p>-- 启用审计日志</p>
<p>ALTER SYSTEM SET audit_enabled = on;</p>
<p>ALTER SYSTEM SET audit_log_statement = 'all';</p>
<p>-- 查询审计日志</p>
<p>SELECT * FROM pg_audit_log</p>
<p>WHERE object_name = 'customer_profile'</p>
<p>ORDER BY audit_time DESC;</p>
<h2 data-id="heading-36">详细案例分析：某电商企业的智能客服实践</h2>
<h4 data-id="heading-37">背景与挑战</h4>
<p>某大型电商平台是国内领先的综合性电商企业，日均订单量超过100万，客户基数超过1亿。随着业务规模的扩大，客服压力日益增加：</p>
<p><strong>主要挑战</strong>：</p>
<ul>
<li>
<p><strong>业务规模</strong>：日均客服咨询量40万+，涉及商品、订单、售后等多个领域</p>
</li>
<li>
<p><strong>人力成本</strong>：客服团队400+人，年度成本超过4000万元</p>
</li>
<li>
<p><strong>服务质量</strong>：响应时间长（平均4分钟），服务质量不均（满意度仅74%）</p>
</li>
<li>
<p><strong>知识管理</strong>：知识分散在多个系统，难以统一管理和更新</p>
</li>
<li>
<p><strong>业务增长</strong>：传统客服模式难以支撑业务快速增长</p>
</li>
</ul>
<h4 data-id="heading-38">解决方案设计</h4>
<p>基于openGauss构建的智能客服系统架构包括：</p>
<h5 data-id="heading-39">系统架构</h5>
<p>┌──────────────────────────────────────────┐</p>
<p>│ 多渠道客户交互层 │</p>
<p>│ (Web/App/微信/电话/邮件) │</p>
<p>└────────────────┬─────────────────────────┘</p>
<p>│</p>
<p>┌──────────────────────────────────────────┐</p>
<p>│ AI对话引擎层 │</p>
<p>│ (意图识别/对话管理/回复生成) │</p>
<p>└────────────────┬─────────────────────────┘</p>
<p>│</p>
<p>┌──────────────────────────────────────────┐</p>
<p>│ 向量检索与知识库层 │</p>
<p>│ (向量化/相似度检索/知识匹配) │</p>
<p>└────────────────┬─────────────────────────┘</p>
<p>│</p>
<p>┌──────────────────────────────────────────┐</p>
<p>│ openGauss数据库层 │</p>
<p>│ (向量存储/关系数据/事务管理) │</p>
<p>└──────────────────────────────────────────┘</p>
<h5 data-id="heading-40">核心类说明</h5>
<ol>
<li><strong>控制层 (Controller)</strong></li>
</ol>
<p><strong>CustomerServiceController</strong></p>
<ul>
<li>
<p>职责：处理HTTP请求，调用Service层</p>
</li>
<li>
<p>注解：@RestController, @RequestMapping</p>
</li>
<li>
<p>方法：7个REST API端点</p>
</li>
</ul>
<ol>
<li><strong>业务层 (Service)</strong></li>
</ol>
<p><strong>SmartCustomerService</strong></p>
<ul>
<li>
<p>职责：实现核心业务逻辑</p>
</li>
<li>
<p>依赖：Repository层、EmbeddingService</p>
</li>
<li>
<p>方法：7个业务方法</p>
</li>
</ul>
<p><strong>EmbeddingService</strong></p>
<ul>
<li>
<p>职责：处理向量化和相似度计算</p>
</li>
<li>
<p>方法：向量生成、转换、相似度计算</p>
</li>
</ul>
<ol>
<li><strong>数据访问层 (Repository)</strong></li>
</ol>
<p><strong>四个Repository接口</strong></p>
<ul>
<li>
<p>继承：JpaRepository</p>
</li>
<li>
<p>职责：数据库CRUD操作</p>
</li>
<li>
<p>方法：自定义查询方法</p>
</li>
</ul>
<ol>
<li><strong>数据模型层 (Entity)</strong></li>
</ol>
<p><strong>四个Entity类</strong></p>
<ul>
<li>
<p>注解：@Entity, @Table, @Column</p>
</li>
<li>
<p>职责：映射数据库表</p>
</li>
<li>
<p>字段：与数据库表字段对应</p>
</li>
</ul>
<ol>
<li><strong>传输层 (DTO)</strong></li>
</ol>
<p><strong>三个DTO类</strong></p>
<ul>
<li>
<p>职责：API请求/响应数据传输</p>
</li>
<li>
<p>特点：简单数据容器，无业务逻辑</p>
</li>
</ul>
<h4 data-id="heading-41">核心功能实现</h4>
<h5 data-id="heading-42">智能问答功能</h5>
<p>-- 创建智能问答存储过程</p>
<p>CREATE OR REPLACE FUNCTION smart_qa(</p>
<p>p_query TEXT,</p>
<p>p_query_embedding VECTOR,</p>
<p>p_customer_id VARCHAR,</p>
<p>p_top_k INT DEFAULT 4</p>
<p>)</p>
<p>RETURNS TABLE (</p>
<p>kb_id BIGINT,</p>
<p>title VARCHAR,</p>
<p>content TEXT,</p>
<p>similarity DECIMAL,</p>
<p>category VARCHAR</p>
<p>) AS $$</p>
<p>BEGIN</p>
<p>RETURN QUERY</p>
<p>SELECT</p>
<p>kb.id,</p>
<p>kb.title,</p>
<p>kb.content,</p>
<p>(1 - (kb.embedding &lt;=&gt; p_query_embedding))::DECIMAL as similarity,</p>
<p>kb.category</p>
<p>FROM knowledge_base kb</p>
<p>WHERE kb.is_active = true</p>
<p>AND (1 - (kb.embedding &lt;=&gt; p_query_embedding)) &gt; 0.5 -- 相似度阈值</p>
<p>ORDER BY similarity DESC</p>
<p>LIMIT p_top_k;</p>
<p>END;</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>A</mi><mi>N</mi><mi>G</mi><mi>U</mi><mi>A</mi><mi>G</mi><mi>E</mi><mi>p</mi><mi>l</mi><mi>p</mi><mi>g</mi><mi>s</mi><mi>q</mi><mi>l</mi><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex"> LANGUAGE plpgsql;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">L</span><span class="mord mathnormal">A</span><span class="mord mathnormal">NG</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">A</span><span class="mord mathnormal">GEplp</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">ql</span><span class="mpunct">;</span></span></span></span></span></p>
<h5 data-id="heading-43">个性化推荐功能</h5>
<p>-- 创建个性化推荐存储过程</p>
<p>CREATE OR REPLACE FUNCTION personalized_recommendation(</p>
<p>p_customer_id VARCHAR,</p>
<p>p_top_k INT DEFAULT 4</p>
<p>)</p>
<p>RETURNS TABLE (</p>
<p>kb_id BIGINT,</p>
<p>title VARCHAR,</p>
<p>content TEXT,</p>
<p>relevance_score DECIMAL</p>
<p>) AS $$</p>
<p>DECLARE</p>
<p>v_profile_embedding VECTOR;</p>
<p>v_vip_level INT;</p>
<p>BEGIN</p>
<p>-- 获取客户档案和VIP等级</p>
<p>SELECT profile_embedding, vip_level INTO v_profile_embedding, v_vip_level</p>
<p>FROM customer_profile</p>
<p>WHERE customer_id = p_customer_id;</p>
<p>-- 返回个性化推荐</p>
<p>RETURN QUERY</p>
<p>SELECT</p>
<p>kb.id,</p>
<p>kb.title,</p>
<p>kb.content,</p>
<p>(1 - (kb.embedding &lt;=&gt; v_profile_embedding))::DECIMAL *</p>
<p>(1 + kb.priority * 0.1) *</p>
<p>(1 + v_vip_level * 0.04) as relevance_score</p>
<p>FROM knowledge_base kb</p>
<p>WHERE kb.is_active = true</p>
<p>AND kb.category IN (</p>
<p>SELECT jsonb_array_elements(cp.preferences-&gt;'interested_categories')::TEXT</p>
<p>FROM customer_profile cp</p>
<p>WHERE cp.customer_id = p_customer_id</p>
<p>)</p>
<p>ORDER BY relevance_score DESC</p>
<p>LIMIT p_top_k;</p>
<p>END;</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>A</mi><mi>N</mi><mi>G</mi><mi>U</mi><mi>A</mi><mi>G</mi><mi>E</mi><mi>p</mi><mi>l</mi><mi>p</mi><mi>g</mi><mi>s</mi><mi>q</mi><mi>l</mi><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex"> LANGUAGE plpgsql;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">L</span><span class="mord mathnormal">A</span><span class="mord mathnormal">NG</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">A</span><span class="mord mathnormal">GEplp</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">ql</span><span class="mpunct">;</span></span></span></span></span></p>
<h5 data-id="heading-44">对话记录与分析</h5>
<p>-- 创建对话记录插入函数</p>
<p>CREATE OR REPLACE FUNCTION log_conversation_message(</p>
<p>p_session_id VARCHAR,</p>
<p>p_customer_id VARCHAR,</p>
<p>p_message_type VARCHAR,</p>
<p>p_content TEXT,</p>
<p>p_intent VARCHAR DEFAULT NULL,</p>
<p>p_confidence DECIMAL DEFAULT NULL</p>
<p>)</p>
<p>RETURNS BIGINT AS $$</p>
<p>DECLARE</p>
<p>v_session_id BIGINT;</p>
<p>v_message JSONB;</p>
<p>BEGIN</p>
<p>-- 构建消息对象</p>
<p>v_message := jsonb_build_object(</p>
<p>'type', p_message_type,</p>
<p>'content', p_content,</p>
<p>'intent', p_intent,</p>
<p>'confidence', p_confidence,</p>
<p>'timestamp', CURRENT_TIMESTAMP</p>
<p>);</p>
<p>-- 更新会话的消息数组</p>
<p>UPDATE conversation_session</p>
<p>SET messages = array_append(messages, v_message),</p>
<p>detected_intent = COALESCE(p_intent, detected_intent),</p>
<p>session_end = CURRENT_TIMESTAMP</p>
<p>WHERE session_id = p_session_id</p>
<p>RETURNING id INTO v_session_id;</p>
<p>RETURN v_session_id;</p>
<p>END;</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>A</mi><mi>N</mi><mi>G</mi><mi>U</mi><mi>A</mi><mi>G</mi><mi>E</mi><mi>p</mi><mi>l</mi><mi>p</mi><mi>g</mi><mi>s</mi><mi>q</mi><mi>l</mi><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex"> LANGUAGE plpgsql;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">L</span><span class="mord mathnormal">A</span><span class="mord mathnormal">NG</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">A</span><span class="mord mathnormal">GEplp</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">ql</span><span class="mpunct">;</span></span></span></span></span></p>
<h5 data-id="heading-45">客户满意度分析</h5>
<p>-- 创建满意度统计视图</p>
<p>CREATE VIEW satisfaction_analysis AS</p>
<p>SELECT</p>
<p>DATE_TRUNC('day', session_end) as date,</p>
<p>COUNT(</p>
<p>) as total_conversations,</p>
<p>COUNT(CASE WHEN resolved = true THEN 1 END) as resolved_count,</p>
<p>ROUND(100.0 * COUNT(CASE WHEN resolved = true THEN 1 END) / COUNT(</p>
<p>), 2) as resolution_rate,</p>
<p>ROUND(AVG(satisfaction_score), 2) as avg_satisfaction,</p>
<p>COUNT(CASE WHEN satisfaction_score &gt;= 4 THEN 1 END) as high_satisfaction_count,</p>
<p>ROUND(100.0 * COUNT(CASE WHEN satisfaction_score &gt;= 4 THEN 1 END) / COUNT(*), 2) as high_satisfaction_rate</p>
<p>FROM conversation_session</p>
<p>WHERE session_end IS NOT NULL</p>
<p>GROUP BY DATE_TRUNC('day', session_end)</p>
<p>ORDER BY date DESC;</p>
<p>-- 创建意图分布视图</p>
<p>CREATE VIEW intent_distribution AS</p>
<p>SELECT</p>
<p>detected_intent,</p>
<p>COUNT(</p>
<p>) as count,</p>
<p>ROUND(100.0 * COUNT(</p>
<p>) / (SELECT COUNT(</p>
<p>) FROM conversation_session), 2) as percentage,</p>
<p>ROUND(AVG(satisfaction_score), 2) as avg_satisfaction,</p>
<p>ROUND(100.0 * COUNT(CASE WHEN resolved = true THEN 1 END) / COUNT(</p>
<p>), 2) as resolution_rate</p>
<p>FROM conversation_session</p>
<p>WHERE detected_intent IS NOT NULL</p>
<p>GROUP BY detected_intent</p>
<p>ORDER BY count DESC;</p>
<h4 data-id="heading-46">应用层实现示例（Java Spring Boot）</h4>
<h5 data-id="heading-47">核心业务服务</h5>
<p>package com.openGauss.smartcustomerservice.service;</p>
<p>import com.openGauss.smartcustomerservice.dto.QAResponse;</p>
<p>import com.openGauss.smartcustomerservice.dto.RecommendationResponse;</p>
<p>import com.openGauss.smartcustomerservice.entity.*;</p>
<p>import com.openGauss.smartcustomerservice.repository.*;</p>
<p>import lombok.RequiredArgsConstructor;</p>
<p>import org.springframework.beans.factory.annotation.Value;</p>
<p>import org.springframework.stereotype.Service;</p>
<p>import org.springframework.transaction.annotation.Transactional;</p>
<p>import java.time.LocalDateTime;</p>
<p>import java.util.*;</p>
<p>import java.util.stream.Collectors;</p>
<p>@Service</p>
<p>@RequiredArgsConstructor</p>
<p>@Transactional</p>
<p>public class SmartCustomerService {</p>
<p>private final KnowledgeBaseRepository knowledgeBaseRepository;</p>
<p>private final CustomerProfileRepository customerProfileRepository;</p>
<p>private final ConversationSessionRepository conversationSessionRepository;</p>
<p>private final IntentLibraryRepository intentLibraryRepository;</p>
<p>private final EmbeddingService embeddingService;</p>
<p>@Value("${app.vector.similarity-threshold:0.5}")</p>
<p>private double similarityThreshold;</p>
<p>@Value("${app.vector.top-k:4}")</p>
<p>private int topK;</p>
<p>/**</p>
<p>* 智能问答 - 基于向量相似度的语义搜索</p>
<p>*/</p>
<p>public List smartQA(String customerId, String query) {</p>
<p>// 获取查询向量</p>
<p>double[] queryEmbedding = embeddingService.getEmbedding(query);</p>
<p>// 获取所有激活的知识库</p>
<p>List knowledgeBases = knowledgeBaseRepository.findByIsActiveTrueAndCategory(null);</p>
<p>// 计算相似度并排序</p>
<p>return knowledgeBases.stream()</p>
<p>.map(kb -&gt; {</p>
<p>double[] kbEmbedding = embeddingService.stringToEmbedding(kb.getEmbedding());</p>
<p>double similarity = embeddingService.cosineSimilarity(queryEmbedding, kbEmbedding);</p>
<p>return new QAResponse(</p>
<p>kb.getId(),</p>
<p>kb.getTitle(),</p>
<p>kb.getContent(),</p>
<p>similarity,</p>
<p>kb.getCategory()</p>
<p>);</p>
<p>})</p>
<p>.filter(qa -&gt; qa.getSimilarity() &gt; similarityThreshold)</p>
<p>.sorted(Comparator.comparingDouble(QAResponse::getSimilarity).reversed())</p>
<p>.limit(topK)</p>
<p>.collect(Collectors.toList());</p>
<p>}</p>
<p>/**</p>
<p>* 个性化推荐 - 基于客户档案的加权推荐</p>
<p>*/</p>
<p>public List getPersonalizedRecommendations(String customerId) {</p>
<p>// 获取客户档案</p>
<p>CustomerProfile profile = customerProfileRepository.findByCustomerId(customerId)</p>
<p>.orElseThrow(() -&gt; new RuntimeException("Customer not found: " + customerId));</p>
<p>// 解析客户档案向量</p>
<p>double[] profileEmbedding = embeddingService.stringToEmbedding(profile.getProfileEmbedding());</p>
<p>// 获取所有激活的知识库</p>
<p>List knowledgeBases = knowledgeBaseRepository.findByIsActiveTrue();</p>
<p>// 计算相关性分数</p>
<p>return knowledgeBases.stream()</p>
<p>.map(kb -&gt; {</p>
<p>double[] kbEmbedding = embeddingService.stringToEmbedding(kb.getEmbedding());</p>
<p>double similarity = embeddingService.cosineSimilarity(profileEmbedding, kbEmbedding);</p>
<p>// 加权计算：向量相似度 × 优先级系数 × VIP系数</p>
<p>double relevanceScore = similarity</p>
<p>* (1 + kb.getPriority() * 0.1)</p>
<p>* (1 + profile.getVipLevel() * 0.04);</p>
<p>return new RecommendationResponse(</p>
<p>kb.getId(),</p>
<p>kb.getTitle(),</p>
<p>kb.getContent(),</p>
<p>relevanceScore</p>
<p>);</p>
<p>})</p>
<p>.sorted(Comparator.comparingDouble(RecommendationResponse::getRelevanceScore).reversed())</p>
<p>.limit(topK)</p>
<p>.collect(Collectors.toList());</p>
<p>}</p>
<p>/**</p>
<p>* 创建对话会话</p>
<p>*/</p>
<p>public ConversationSession createConversationSession(String customerId, String channel) {</p>
<p>String sessionId = String.format("sess_%s_%d", customerId, System.currentTimeMillis());</p>
<p>ConversationSession session = new ConversationSession();</p>
<p>session.setSessionId(sessionId);</p>
<p>session.setCustomerId(customerId);</p>
<p>session.setChannel(channel);</p>
<p>session.setStatus("active");</p>
<p>session.setResolved(false);</p>
<p>session.setSessionStart(LocalDateTime.now());</p>
<p>return conversationSessionRepository.save(session);</p>
<p>}</p>
<p>/**</p>
<p>* 记录对话消息</p>
<p>*/</p>
<p>public void logMessage(String sessionId, String customerId, String messageType,</p>
<p>String content, String intent, Double confidence) {</p>
<p>ConversationSession session = conversationSessionRepository.findBySessionId(sessionId)</p>
<p>.orElseThrow(() -&gt; new RuntimeException("Session not found: " + sessionId));</p>
<p>// 构建消息对象</p>
<p>Map&lt;String, Object&gt; message = new LinkedHashMap&lt;&gt;();</p>
<p>message.put("type", messageType);</p>
<p>message.put("content", content);</p>
<p>message.put("intent", intent);</p>
<p>message.put("confidence", confidence);</p>
<p>message.put("timestamp", LocalDateTime.now());</p>
<p>// 更新会话消息</p>
<p>if (session.getMessages() == null) {</p>
<p>session.setMessages(new ArrayList&lt;&gt;());</p>
<p>}</p>
<p>session.getMessages().add(message);</p>
<p>session.setDetectedIntent(intent);</p>
<p>session.setSessionEnd(LocalDateTime.now());</p>
<p>conversationSessionRepository.save(session);</p>
<p>}</p>
<p>/**</p>
<p>* 关闭对话会话</p>
<p>*/</p>
<p>public void closeConversationSession(String sessionId, Integer satisfactionScore, String feedbackText) {</p>
<p>ConversationSession session = conversationSessionRepository.findBySessionId(sessionId)</p>
<p>.orElseThrow(() -&gt; new RuntimeException("Session not found: " + sessionId));</p>
<p>session.setStatus("closed");</p>
<p>session.setResolved(true);</p>
<p>session.setSatisfactionScore(satisfactionScore);</p>
<p>session.setFeedbackText(feedbackText);</p>
<p>session.setSessionEnd(LocalDateTime.now());</p>
<p>conversationSessionRepository.save(session);</p>
<p>}</p>
<p>/**</p>
<p>* 获取客户对话历史</p>
<p>*/</p>
<p>public List getCustomerConversationHistory(String customerId) {</p>
<p>return conversationSessionRepository.findByCustomerId(customerId);</p>
<p>}</p>
<p>/**</p>
<p>* 更新客户档案</p>
<p>*/</p>
<p>public CustomerProfile updateCustomerProfile(String customerId, String name,</p>
<p>String email, String phone) {</p>
<p>CustomerProfile profile = customerProfileRepository.findByCustomerId(customerId)</p>
<p>.orElse(new CustomerProfile());</p>
<p>profile.setCustomerId(customerId);</p>
<p>profile.setName(name);</p>
<p>profile.setEmail(email);</p>
<p>profile.setPhone(phone);</p>
<p>profile.setLastInteraction(LocalDateTime.now());</p>
<p>return customerProfileRepository.save(profile);</p>
<p>}</p>
<p>}</p>
<h5 data-id="heading-48">REST API 控制器</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dfcf033407e40618bbb0f367aaaf3f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853028&amp;x-signature=%2BQo9r80FUIu4FWhC2oc5sJL8vyY%3D" alt="" loading="lazy"/></p>
<p>这段代码是一个「高内聚、低耦合」的智能问答接口实现，遵循 Spring Boot 最佳实践：</p>
<p>控制层（Controller）负责请求接收和响应封装，不包含业务逻辑；</p>
<p>服务层（Service）封装核心业务，便于复用和测试；</p>
<p>统一响应格式（ApiResponse）和日志打印，提升接口的可维护性和可观测性；</p>
<p>全局异常捕获，避免接口抛出未处理异常导致客户端无法解析。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d241f8a27f2d439f99e0c75cc178f7b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853028&amp;x-signature=Fe65TtAJYf1j%2FOcBuMN1DilYPg8%3D" alt="" loading="lazy"/></p>
<p>这两个接口分别覆盖了「个性化查询」和「会话创建」两个核心场景，设计上遵循了：</p>
<p>「RESTful 规范」：HTTP 方法与业务操作语义一致；</p>
<p>「高可维护性」：统一响应、日志、异常处理，降低后续扩展成本；</p>
<p>「分层解耦」：Controller 与 Service 职责分离，便于单元测试和业务逻辑复用。</p>
<p>整体来看，这组接口属于「客户智能服务系统」的核心接口集合（问答 + 推荐 + 会话），能够支撑起一个完整的智能客服 / 用户个性化服务场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5059dcb0aaf64a0b80bd76290a00f947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853028&amp;x-signature=XVE1nLFM4qjkuKZGawSoh2Rmr%2BY%3D" alt="" loading="lazy"/></p>
<p>这两个接口是对话系统的「基础支撑接口」：</p>
<p>"/message" 负责对话数据的「记录与沉淀」，为上下文理解、数据分析提供数据基础；</p>
<p>"/session/close" 负责对话生命周期的「收尾与反馈收集」，确保资源释放和服务优化。</p>
<p>结合之前的「会话创建」「智能问答」「个性化推荐」接口，整套接口形成了一个 功能完整、设计规范、可扩展 的智能客服 / 用户对话服务体系，能够支撑从用户接入到对话结束的全流程需求。</p>
<h5 data-id="heading-49">向量处理服务</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b214ebefa114a18acf50f37d44a598f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853028&amp;x-signature=d87GVb3P1t1Cs8pv6iu3H65suF4%3D" alt="" loading="lazy"/></p>
<p>这段代码是一个「合格的 Embedding 模拟实现」：</p>
<p>满足 “流程验证” 的核心需求，确保相同文本生成相同向量、向量维度固定且归一化；</p>
<p>明确标注 “模拟实现”，避免误用生产环境；</p>
<p>代码逻辑简洁，无冗余，符合 Java 编码规范。</p>
<p>其核心价值是「降低开发测试门槛」—— 在没有真实 Embedding 服务的情况下，快速搭建业务流程；生产环境中，只需替换 getEmbedding 方法的内部实现（调用真实服务），外部调用逻辑无需修改（符合 “开闭原则”）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1e98c594f08471a8ed3394ff9481c29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853028&amp;x-signature=suyI0hD30sM3CCSARgnR%2Fc6Qgaw%3D" alt="" loading="lazy"/></p>
<p>这两段方法是「向量存储的实用工具」，设计上：</p>
<p>格式简洁标准化（JSON 数组风格），便于存储和解析；</p>
<p>包含完善的入参校验和异常处理，鲁棒性强；</p>
<p>平衡了精度和存储成本（保留 6 位小数）；</p>
<p>与之前的 Embedding 生成方法无缝衔接，形成「生成→序列化→存储→反序列化→使用」的完整链路。</p>
<p>核心价值是「兼容性」—— 在不依赖数据库特殊功能的前提下，实现向量的持久化存储，支撑智能问答、文本检索等依赖 Embedding 的业务场景。</p>
<h4 data-id="heading-50">实现效果及优化</h4>
<h5 data-id="heading-51">性能优化建议</h5>
<ul>
<li>
<p><strong>数据库优化</strong></p>
<ul>
<li>
<p>添加适当的索引</p>
</li>
<li>
<p>使用向量索引（HNSW/IVFFlat）</p>
</li>
<li>
<p>定期分析表统计信息</p>
</li>
</ul>
</li>
<li>
<p><strong>缓存优化</strong></p>
<ul>
<li>
<p>缓存热点知识库数据</p>
</li>
<li>
<p>缓存客户档案</p>
</li>
<li>
<p>使用Redis分布式缓存</p>
</li>
</ul>
</li>
<li>
<p><strong>查询优化</strong></p>
<ul>
<li>
<p>使用分页查询</p>
</li>
<li>
<p>限制返回结果数量</p>
</li>
<li>
<p>使用批量操作</p>
</li>
</ul>
</li>
<li>
<p><strong>并发优化</strong></p>
<ul>
<li>
<p>调整连接池大小</p>
</li>
<li>
<p>使用异步处理</p>
</li>
<li>
<p>实现请求队列</p>
</li>
</ul>
</li>
</ul>
<h5 data-id="heading-52">业务价值</h5>
<p><strong>成本节约</strong>：</p>
<ul>
<li>
<p>客服人员成本：从4000万/年降至3000万/年，节约2000万元</p>
</li>
<li>
<p>系统维护成本：降低30%</p>
</li>
<li>
<p>总体成本降低34%</p>
</li>
</ul>
<p><strong>收入增长</strong>：</p>
<ul>
<li>
<p>客户满意度提升带来的复购率增加：+12%</p>
</li>
<li>
<p>个性化推荐带来的转化率提升：+7%</p>
</li>
<li>
<p>预计年度收入增加：+4000万元</p>
</li>
</ul>
<p><strong>运营效率</strong>：</p>
<ul>
<li>
<p>平均处理时间：从300秒降至7秒</p>
</li>
<li>
<p>日均处理咨询量：从40万提升至50万</p>
</li>
<li>
<p>知识库更新周期：从1周降至1天</p>
</li>
</ul>
<h5 data-id="heading-53">技术指标</h5>
<p><strong>数据库性能</strong>：</p>
<ul>
<li>
<p>向量查询响应时间：P84 &lt; 40ms，P88 &lt; 100ms</p>
</li>
<li>
<p>知识库规模：4万+条记录，存储空间 &lt; 40GB</p>
</li>
<li>
<p>并发连接数：支持10000+并发会话</p>
</li>
<li>
<p>日均数据增长：100万+条新记录</p>
</li>
</ul>
<p><strong>系统稳定性</strong>：</p>
<ul>
<li>
<p>数据库故障恢复时间：&lt; 30秒</p>
</li>
<li>
<p>数据一致性：RPO = 0（零数据丢失）</p>
</li>
<li>
<p>备份频率：每小时一次，保留30天历史</p>
</li>
</ul>
<h4 data-id="heading-54">关键成功因素</h4>
<ol>
<li>
<p><strong>充分的数据准备</strong>：花费3个月时间清理和标准化历史数据</p>
</li>
<li>
<p><strong>迭代式上线</strong>：分阶段上线，先从FAQ开始，逐步扩展到订单、售后等</p>
</li>
<li>
<p><strong>持续优化</strong>：建立反馈机制，每周分析数据，持续改进模型和知识库</p>
</li>
<li>
<p><strong>团队协作</strong>：数据库团队、AI团队、业务团队紧密合作</p>
</li>
<li>
<p><strong>监控告警</strong>：建立完善的监控体系，及时发现和解决问题</p>
</li>
</ol>
<h4 data-id="heading-55">经验教训与建议</h4>
<p><strong>成功经验</strong>：</p>
<p>openGauss的向量数据库能力完全满足大规模应用需求</p>
<p>混合查询（向量+关键字）的效果优于单一方式</p>
<p>定期更新知识库和模型是保证系统效果的关键</p>
<p><strong>改进建议</strong>：</p>
<p>早期应该更重视数据质量，而不是数据量</p>
<p>需要建立更完善的A/B测试框架</p>
<p>应该提前规划多语言支持</p>
<h2 data-id="heading-56">技术挑战与解决方案</h2>
<h4 data-id="heading-57">大规模向量数据管理</h4>
<p><strong>挑战</strong>：</p>
<p>向量数据量大（百亿级）</p>
<p>维度高（1000+维）</p>
<p>查询频繁（QPS高）</p>
<p><strong>解决方案</strong>：</p>
<p><strong>分层索引</strong>：使用IVFFlat进行粗粒度分组，HNSW进行精细检索</p>
<p><strong>缓存策略</strong>：热点向量数据缓存在内存中</p>
<p><strong>异步处理</strong>：后台批量更新向量索引</p>
<h4 data-id="heading-58">实时性与准确性的平衡</h4>
<p><strong>挑战</strong>：</p>
<p>需要毫秒级的响应时间</p>
<p>同时要保证回复的准确性和相关性</p>
<p><strong>解决方案</strong>：</p>
<p><strong>多阶段检索</strong>：粗排→精排→重排</p>
<p><strong>缓存热点</strong>：缓存高频查询结果</p>
<p><strong>模型优化</strong>：使用更轻量的embedding模型</p>
<h4 data-id="heading-59">多轮对话的上下文管理</h4>
<p><strong>挑战</strong>：</p>
<p>对话历史长，上下文复杂</p>
<p>需要准确理解用户真实意图</p>
<p><strong>解决方案</strong>：</p>
<p><strong>对话状态机</strong>：使用状态机管理对话流程</p>
<p><strong>意图追踪</strong>：跟踪意图的演变过程</p>
<p><strong>上下文压缩</strong>：对长对话进行摘要压缩</p>
<h4 data-id="heading-60">冷启动与持续学习</h4>
<p><strong>挑战</strong>：</p>
<p>新系统缺少训练数据</p>
<p>需要持续改进模型和知识库</p>
<p><strong>解决方案</strong>：</p>
<p><strong>知识库预热</strong>：从现有系统迁移历史数据</p>
<p><strong>人工反馈</strong>：收集用户反馈进行模型优化</p>
<p><strong>A/B测试</strong>：对新策略进行科学评估</p>
<h2 data-id="heading-61">性能指标与监控</h2>
<h4 data-id="heading-62">关键性能指标（KPI）</h4>
<h5 data-id="heading-63">系统性能指标</h5>
<p><strong>查询响应时间</strong>：P84 &lt; 100ms，P88 &lt; 400ms</p>
<p><strong>吞吐量</strong>：支持10000+ QPS</p>
<p><strong>系统可用性</strong>：&gt; 88.8%</p>
<p><strong>数据一致性</strong>：RPO = 0，RTO &lt; 1分钟</p>
<h5 data-id="heading-64">业务指标</h5>
<p><strong>自动化处理率</strong>：目标 &gt; 70%</p>
<p><strong>首次解决率</strong>：目标 &gt; 74%</p>
<p><strong>客户满意度</strong>：目标 &gt; 80%</p>
<p><strong>平均处理时间</strong>：目标 &lt; 30秒</p>
<h4 data-id="heading-65">监控与告警</h4>
<h5 data-id="heading-66">数据库监控</h5>
<p>-- 监控查询性能</p>
<p>SELECT query, calls, mean_time, max_time</p>
<p>FROM pg_stat_statements</p>
<p>WHERE query LIKE '%knowledge_base%'</p>
<p>ORDER BY mean_time DESC;</p>
<p>-- 监控索引使用情况</p>
<p>SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read</p>
<p>FROM pg_stat_user_indexes</p>
<p>WHERE tablename = 'knowledge_base'</p>
<p>ORDER BY idx_scan DESC;</p>
<p>-- 监控表大小</p>
<p>SELECT schemaname, tablename,</p>
<p>pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size</p>
<p>FROM pg_tables</p>
<p>WHERE schemaname = 'public'</p>
<p>ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;</p>
<h5 data-id="heading-67">应用层监控</h5>
<p><strong>API响应时间</strong>：监控各个API端点的响应时间</p>
<p><strong>错误率</strong>：监控系统错误和异常</p>
<p><strong>向量检索命中率</strong>：监控向量检索的效果</p>
<p><strong>模型准确率</strong>：监控意图识别和情感分析的准确率</p>
<h2 data-id="heading-68">总结与未来</h2>
<h4 data-id="heading-69">技术发展方向</h4>
<h5 data-id="heading-70">多模态数据支持</h5>
<p>支持文本、图片、音频等多模态数据</p>
<p>统一的多模态向量表示</p>
<p>跨模态的相似度检索</p>
<h5 data-id="heading-71">实时流处理</h5>
<p>支持实时的数据流处理</p>
<p>流式向量计算</p>
<h5 data-id="heading-72">联邦学习</h5>
<p>支持分布式的模型训练</p>
<p>保护用户隐私的同时进行模型优化</p>
<p>多企业的协作学习</p>
<h4 data-id="heading-73">应用创新方向</h4>
<h5 data-id="heading-74">主动服务</h5>
<p>从被动应答到主动推荐</p>
<p>基于用户行为的智能提示</p>
<p>个性化的营销和服务</p>
<h5 data-id="heading-75">跨渠道整合</h5>
<p>统一的客户视图</p>
<p>无缝的渠道切换体验</p>
<p>一致的服务质量</p>
<h5 data-id="heading-76">行业垂直化</h5>
<p>针对特定行业的定制化解决方案</p>
<p>行业知识库的深度集成</p>
<p>行业特定的业务流程支持</p>
<h2 data-id="heading-77">最后总结</h2>
<p>openGauss作为一款开源企业级数据库，凭借其强大的向量数据库能力、高性能的事务处理、完善的安全机制，为智能客服系统的构建提供了坚实的基础。通过合理的架构设计、科学的数据模型、优化的查询策略，企业可以构建高效、智能、安全的客服系统，显著提升客户体验和运营效率。</p>
<p>随着AI技术的不断发展和openGauss功能的持续完善，智能客服系统将在以下方面取得更大的进展：</p>
<p><strong>更智能的对话</strong>：支持更复杂的多轮对话和上下文理解</p>
<p><strong>更个性化的服务</strong>：基于深度学习的个性化推荐和服务</p>
<p><strong>更安全的保障</strong>：完善的隐私保护和数据安全机制</p>
<p><strong>更广泛的应用</strong>：从客服扩展到营销、销售等多个业务场景</p>
<p>openGauss将继续赋能企业的数字化转型，助力企业在AI时代实现服务创新和业务增长。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我是如何使用 Trae IDE 完成《流碧卡片》项目的完整记录]]></title>    <link>https://juejin.cn/post/7577202452800176128</link>    <guid>https://juejin.cn/post/7577202452800176128</guid>    <pubDate>2025-11-27T13:05:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577202452800176128" data-draft-id="7577239264309248000" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我是如何使用 Trae IDE 完成《流碧卡片》项目的完整记录"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2025-11-27T13:05:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我是如何使用 Trae IDE 完成《流碧卡片》项目的完整记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:05:55.000Z" title="Thu Nov 27 2025 13:05:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我是如何使用 Trae IDE 完成《流碧卡片》项目的完整记录</h2>
<h3 data-id="heading-1">项目背景与起点</h3>
<blockquote>
<p>体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcard.zbztb.cn%2F" target="_blank" title="https://card.zbztb.cn/" ref="nofollow noopener noreferrer">card.zbztb.cn/</a></p>
</blockquote>
<p>这是我使用 Trae IDE + Gemini-3-pro-Preview 在 6 小时内完成的实战项目——流碧卡片（Liubi Card）。作为一个社交媒体卡片生成工具，它支持 40+ 种视觉模板，所有图片生成都在浏览器本地完成。</p>
<p><strong>我的开发目标：</strong></p>
<ul>
<li>快速验证 AI 辅助开发的可行性</li>
<li>实现一个完整可用的产品原型</li>
<li>探索 Trae IDE 的最佳实践</li>
<li>积累可复用的开发经验</li>
</ul>
<p><strong>最终成果：</strong></p>
<ul>
<li>✅ 6 小时完成从 0 到上线</li>
<li>✅ 40+ 精美模板系统</li>
<li>✅ 完整的国际化支持</li>
<li>✅ 深色模式适配</li>
<li>✅ 批量导出功能</li>
</ul>
<hr/>
<p>目前项目已经部署上线，查看下效果吧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb102acb4c7b4291a251c071dad13bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=CT5Gpb%2FShdWlMvv3cLMFXah5Qnc%3D" alt="image-20251127173418872" loading="lazy"/></p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0645f2834de4832ad8d5b802639eef3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=xcVhwnfwk6xpSaXuRvwPjnyD8mU%3D" alt="image-20251127173428581" loading="lazy"/></p>
<h3 data-id="heading-2">我的实际开发历程</h3>
<h4 data-id="heading-3">对话一：开发一个纯Web端的卡片生成与分享平台</h4>
<p>在国际版Trae对话框下，输入想要实现的内容，然后利用自带的提示词优化功能，得到以下信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23b8c9b8ab794271950f3461696c77d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=JZWEeYmuMVgNRHSQQpnUaqNae%2Bw%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-markdown" lang="markdown">开发一个纯Web端的卡片生成与分享平台，具体需求如下：

<span class="hljs-bullet">1.</span> 核心功能实现：

<span class="hljs-bullet">-</span> 开发用户输入界面，包含文本输入区域和实时预览功能

<span class="hljs-bullet">-</span> 实现卡片生成引擎，将用户输入的文字内容自动排版成美观的卡片布局

<span class="hljs-bullet">-</span> 集成HTML转图片功能，支持将生成的卡片转换为图片格式

<span class="hljs-bullet">2.</span> 图片处理功能：

<span class="hljs-bullet">-</span> 实现点击复制功能，将卡片以图片形式复制到系统剪贴板

<span class="hljs-bullet">-</span> 提供图片下载功能，支持PNG/JPEG格式选择

<span class="hljs-bullet">-</span> 确保生成的图片分辨率适配小红书和抖音的分享要求

<span class="hljs-bullet">3.</span> 社交平台适配：

<span class="hljs-bullet">-</span> 优化卡片尺寸和比例，符合小红书和抖音的内容规范

<span class="hljs-bullet">-</span> 添加平台分享按钮，支持一键分享到主流社交平台

<span class="hljs-bullet">-</span> 在图片中自动嵌入品牌水印（可选配置）

<span class="hljs-bullet">4.</span> 模板管理系统：

<span class="hljs-bullet">-</span> 开发多样化的卡片模板库，包括不同风格、配色和布局

<span class="hljs-bullet">-</span> 实现模板预览和选择功能

<span class="hljs-bullet">-</span> 允许用户自定义模板参数（颜色、字体、间距等）

<span class="hljs-bullet">5.</span> 技术方案建议：

<span class="hljs-bullet">-</span> 前端框架：React/Vue.js

<span class="hljs-bullet">-</span> 图片生成：html2canvas或dom-to-image

<span class="hljs-bullet">-</span> UI组件库：Material-UI或Ant Design

<span class="hljs-bullet">-</span> 状态管理：Redux或Vuex

<span class="hljs-bullet">-</span> 构建工具：Webpack或Vite

<span class="hljs-bullet">6.</span> 质量要求：

<span class="hljs-bullet">-</span> 响应式设计，适配移动端和桌面端

<span class="hljs-bullet">-</span> 生成图片清晰度高，无模糊失真

<span class="hljs-bullet">-</span> 操作流程流畅，用户体验良好

<span class="hljs-bullet">-</span> 性能优化，确保快速生成和转换

<span class="hljs-bullet">7.</span> 开发里程碑：

<span class="hljs-bullet">-</span> 第一阶段：完成基础卡片生成功能

<span class="hljs-bullet">-</span> 第二阶段：实现图片导出和分享功能

<span class="hljs-bullet">-</span> 第三阶段：开发模板管理系统

<span class="hljs-bullet">-</span> 第四阶段：进行多平台测试和优化
</code></pre>
<p>开始执行计划，Trae比较智能，给出了具体的计划和执行步骤，就开始帮我创建项目了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ff5de249d1e4ee68f8c76e6051f132f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=O2pq%2FCjYgLSrLFR3soxUwbjygUY%3D" alt="image-20251127174102177" loading="lazy"/></p>
<p>其实这个执行流程结束后，我的网站已经完成了 80%功能了，不得不感叹 <strong>gemini-3-pro-preview</strong>的强大，昨晚使用的时候，最多也是2、3个人开始排队，大家想要体验的就抓紧了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acf665f536be48bf9b8493ac49158777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=GuEMUTJbSX9aKOwSUq2N8HllT2c%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">对话二：修复bug</h4>
<p>在第一轮对话下，项目运行出出现了小许问题，我这边直接把错误提示粘贴回Trae，让它自己修复。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f509a9f9e0543099db4ed9b17e221df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=R7P42X8h2IFoPrF0O6vCxVqypy0%3D" alt="image-20251127174338525" loading="lazy"/></p>
<h4 data-id="heading-5">对话三：为游戏/应用设计并实现一系列高品质的酷炫动态皮肤主题</h4>
<p>接着考虑到卡片需要酷炫的皮肤，我就开始让Trae帮我在已有的功能下添加功能。</p>
<pre><code class="hljs language-markdown" lang="markdown">游戏/应用设计并实现一系列高品质的酷炫动态皮肤主题，具体要求如下：

<span class="hljs-bullet">1.</span> 主题清单必须包含但不仅限于：

<span class="hljs-bullet">-</span> 雪山主题：动态飘雪效果+冰川反光

<span class="hljs-bullet">-</span> 火山主题：熔岩流动+粒子喷发特效

<span class="hljs-bullet">-</span> 海浪主题：3D流体模拟+浪花飞溅

<span class="hljs-bullet">-</span> 星空主题：银河旋转+流星划过动画

<span class="hljs-bullet">2.</span> 技术规格：

<span class="hljs-bullet">-</span> 每个主题需提供4K分辨率素材

<span class="hljs-bullet">-</span> 支持实时动态光照效果

<span class="hljs-bullet">-</span> 包含环境音效配套方案

<span class="hljs-bullet">-</span> 适配移动端/PC端多平台渲染

<span class="hljs-bullet">3.</span> 视觉要求：

<span class="hljs-bullet">-</span> 使用HDR色彩空间

<span class="hljs-bullet">-</span> 粒子特效不少于3种动态元素

<span class="hljs-bullet">-</span> 主视觉焦点区域需有引导性动线设计

<span class="hljs-bullet">-</span> 所有动画循环时长控制在8-15秒区间

<span class="hljs-bullet">4.</span> 扩展建议：

<span class="hljs-bullet">-</span> 极光主题（动态光幕）

<span class="hljs-bullet">-</span> 量子隧道（赛博朋克风格）

<span class="hljs-bullet">-</span> 细胞分裂（生物科技感）

<span class="hljs-bullet">-</span> 数据风暴（数字粒子流）

请确保所有皮肤主题在保持视觉冲击力的同时，系统资源占用不超过基础皮肤的120%。每个主题需提供预览缩略图、特效说明文档和技术参数表。
</code></pre>
<p>Trae一口气给我整理了15个步骤，可谓是思维谨慎的boy。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d699e370a884e59bf5efb56aa267ca4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=04rfXzQeZRLjqf6O4vAL9zsXE6E%3D" alt="" loading="lazy"/></p>
<p>我也顺利得到了结果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57c565b5492743bcae4181f36c7e311c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=V%2FRQ%2BwHbfb5jxWV0GOKHN%2FyXdq0%3D" alt="image-20251127174601873" loading="lazy"/></p>
<h4 data-id="heading-6">对话四：修复bug:存在问题，卡片内有内容都，但是复制的图片 缺没有 卡片的文本内容</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce356f658cf54bd1ae6a1f4d137c38cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=TqGeYorX0tOAUFWJOIGVmZlnOCI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">对话5：修复bug：用了 主题，比如说雪山主题后，再修改背景颜色就无效了，我希望它有效</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83020048ecf6447cbc354bd9d1c7615e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=AqnMOza9JgmsobKmw2IROIt0kV0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">后续</h3>
<p>考虑到后续还需要不断增加功能，其实可以利用Trae提供的SOLO功能，一步到位！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c596e6ca1844f5d996b40e467fffba0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764853555&amp;x-signature=0glvXJnpNtNjo3i3wb5Z29CKVis%3D" alt="image-20251127210442243" loading="lazy"/></p>
<p>后续内容也差不多，基本 <strong>Gemini-3-pro-preview</strong> 做到了我想要的，基本使用自然语言去理解和开发我想要的功能，这个能力的提升可以大之前一大堆优化提示词的工作都给覆盖了，果然就是遥遥领先了。</p>
<p>最后我是利用了腾讯edgeOne把网站给部署上去了，欢迎体验。</p>
<p>体验地址</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcard.zbztb.cn%2F" target="_blank" title="https://card.zbztb.cn/" ref="nofollow noopener noreferrer">card.zbztb.cn/</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes Deployment 配置简化实战：从复杂到高效]]></title>    <link>https://juejin.cn/post/7577228831138168875</link>    <guid>https://juejin.cn/post/7577228831138168875</guid>    <pubDate>2025-11-27T13:22:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577228831138168875" data-draft-id="7577198193216045099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes Deployment 配置简化实战：从复杂到高效"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-27T13:22:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes Deployment 配置简化实战：从复杂到高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:22:13.000Z" title="Thu Nov 27 2025 13:22:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：Deployment 配置的复杂性挑战</h2>
<p>在 Kubernetes 中，Deployment 是管理无状态应用的核心资源对象，它通过声明式配置为我们提供了副本管理、滚动更新、版本回滚等强大功能。然而，随着应用复杂度的增加，Deployment 配置文件也变得愈发冗长和复杂，一个生产环境的 YAML 文件可能包含数十个参数，这给维护和正确性带来了严峻挑战。</p>
<p>本文将系统性地介绍多种简化 Kubernetes Deployment 配置的策略和工具，帮助您在保持功能完整性的同时，显著降低配置复杂度和出错概率。</p>
<h2 data-id="heading-1">一、问题根源：为什么 Deployment 配置如此复杂？</h2>
<p>在探讨解决方案前，我们首先需要理解 Deployment 配置复杂性的根源。一个典型的生产级 Deployment 配置可能包含以下多个维度的参数：</p>
<ul>
<li><strong>基础配置</strong>：副本数量、镜像标签、容器端口</li>
<li><strong>资源管理</strong>：CPU/内存请求和限制</li>
<li><strong>健康检查</strong>：就绪探针、存活探针、启动探针</li>
<li><strong>更新策略</strong>：滚动更新参数、最大不可用比例</li>
<li><strong>安全上下文</strong>：用户权限、安全策略</li>
<li><strong>环境配置</strong>：环境变量、配置映射、密钥</li>
</ul>
<p>这种复杂性源于生产环境对<strong>应用高可用性</strong>、<strong>可扩展性</strong>和<strong>可观测性</strong>的严格要求。直接修改这些冗长的 YAML 文件不仅容易出错，而且在多环境部署时难以保持一致性。</p>
<h2 data-id="heading-2">二、解决方案一：模板化与抽象化</h2>
<h3 data-id="heading-3">2.1 使用 Helm 进行应用打包</h3>
<p>Helm 作为 Kubernetes 的包管理器，通过模板化和值分离，极大地简化了多环境部署的复杂度。</p>
<p><strong>核心优势</strong>：</p>
<ul>
<li>模板引擎：使用 Go 模板语言，支持条件判断和循环</li>
<li>值覆盖：通过独立的 values.yaml 文件管理环境差异化配置</li>
<li>依赖管理：支持子图表和依赖关系解析</li>
</ul>
<p><strong>实战示例</strong>：</p>
<p>创建一个基本的 Helm 图表结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">my-app-chart/
├── Chart.yaml
├── values.yaml
└── templates/
<span class="hljs-code">    ├── deployment.yaml
    ├── service.yaml
    └── configmap.yaml
</span></code></pre>
<p>在 <code>templates/deployment.yaml</code>中使用模板变量：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Release.Name</span> }}<span class="hljs-string">-deployment</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> {{ <span class="hljs-string">.Values.replicaCount</span> }}
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Chart.Name</span> }}
        <span class="hljs-attr">image:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ .Values.image.repository }}</span>:<span class="hljs-template-variable">{{ .Values.image.tag }}</span>"</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> {{ <span class="hljs-string">.Values.service.port</span> }}
</code></pre>
<p>对应的 <code>values.yaml</code>提供默认值：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">replicaCount:</span> <span class="hljs-number">3</span>
<span class="hljs-attr">image:</span>
  <span class="hljs-attr">repository:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">tag:</span> <span class="hljs-string">stable</span>
<span class="hljs-attr">service:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
</code></pre>
<p>通过这种方式，我们可以为不同环境（开发、测试、生产）创建不同的 values 文件，而保持模板不变。</p>
<h3 data-id="heading-4">2.2 使用 Kustomize 进行配置覆盖</h3>
<p>Kustomize 采用"基础+覆盖"的模型，不需要学习模板语法即可实现配置差异化。</p>
<p><strong>项目结构示例</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">my-app/
├── <span class="hljs-keyword">base</span>/
│   ├── kustomization.yaml
│   ├── deployment.yaml
│   └── service.yaml
└── overlays/
    ├── development/
    │   ├── kustomization.yaml
    │   └── replica-patch.yaml
    └── production/
        ├── kustomization.yaml
        ├── replica-patch.yaml
        └── hpa.yaml
</code></pre>
<p><strong>开发环境覆盖配置</strong>（overlays/development/kustomization.yaml）：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">apiVersion: kustomize.config.k8s.io/v1beta1</span>
<span class="hljs-section">kind: Kustomization</span>

<span class="hljs-section">resources:</span>
- ../../base

<span class="hljs-section">patchesStrategicMerge:</span>
- replica-patch.yaml

<span class="hljs-section">namePrefix: dev-</span>
</code></pre>
<p>这种方法避免了模板语法复杂度，直接使用原生 YAML 进行配置补丁。</p>
<h2 data-id="heading-5">三、解决方案二：自动化部署流程</h2>
<h3 data-id="heading-6">3.1 使用 Skaffold 实现持续开发</h3>
<p>Skaffold 是谷歌开发的 Kubernetes 开发工具，可以自动化构建、推送和部署流程。</p>
<p><strong>Skaffold 核心特性</strong>：</p>
<ul>
<li>自动检测代码变更并触发重新部署</li>
<li>支持多种部署工具（kubectl、Helm、Kustomize）</li>
<li>提供端到端的开发工作流</li>
</ul>
<p><strong>基础配置示例</strong>（skaffold.yaml）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">skaffold/v4beta13</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Config</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-app</span>
<span class="hljs-attr">build:</span>
  <span class="hljs-attr">artifacts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">my-app</span>
    <span class="hljs-attr">context:</span> <span class="hljs-string">src</span>
    <span class="hljs-attr">docker:</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
<span class="hljs-attr">deploy:</span>
  <span class="hljs-attr">kubectl:</span>
    <span class="hljs-attr">manifests:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s/*.yaml</span>
<span class="hljs-attr">profiles:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dev</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">kustomize:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">overlays/dev</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prod</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">helm:</span>
      <span class="hljs-attr">releases:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-app</span>
        <span class="hljs-attr">chartPath:</span> <span class="hljs-string">charts/my-app</span>
</code></pre>
<p>通过 Skaffold，开发者只需运行 <code>skaffold dev</code>即可进入自动化开发循环，大幅简化本地开发和调试流程。</p>
<h3 data-id="heading-7">3.2 GitOps 工作流</h3>
<p>结合 ArgoCD 或 Flux 实现 GitOps，将配置存储在版本控制系统内，实现声明式的基础设施管理。</p>
<p><strong>GitOps 核心原则</strong>：</p>
<ul>
<li>声明式：系统状态通过声明性描述定义</li>
<li>版本控制：所有配置变更版本化、可审计</li>
<li>自动同步：系统自动检测配置变更并应用</li>
<li>自愈：系统持续趋向期望状态</li>
</ul>
<h2 data-id="heading-8">四、解决方案三：配置最佳实践</h2>
<h3 data-id="heading-9">4.1 健康检查标准化</h3>
<p>正确配置健康检查探针是确保应用高可用的基础。</p>
<p><strong>探针配置示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">containers:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
  <span class="hljs-attr">livenessProbe:</span>
    <span class="hljs-attr">httpGet:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
    <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
    <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span>
  <span class="hljs-attr">readinessProbe:</span>
    <span class="hljs-attr">httpGet:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
    <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span>
    <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span>
    <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">startupProbe:</span>
    <span class="hljs-attr">httpGet:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/startup</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
    <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">30</span>
    <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
</code></pre>
<p>健康检查确保 Kubernetes 能够准确判断应用状态，是实现自愈和滚动更新的基础。</p>
<h3 data-id="heading-10">4.2 资源管理与限制</h3>
<p>合理设置资源请求和限制是保证应用稳定运行的关键。</p>
<p><strong>资源限制示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">resources:</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"128Mi"</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1000m"</span>
</code></pre>
<p>资源管理最佳实践：</p>
<ul>
<li>始终设置资源请求和限制</li>
<li>通过 HPA 实现自动扩缩容</li>
<li>定期监控资源使用情况并优化</li>
</ul>
<h3 data-id="heading-11">4.3 命名空间与标签策略</h3>
<p>使用命名空间和标签实现逻辑隔离和资源组织。</p>
<p><strong>标签标准化示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">user-service</span>
    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.2.3</span>
    <span class="hljs-attr">environment:</span> <span class="hljs-string">production</span>
    <span class="hljs-attr">tier:</span> <span class="hljs-string">backend</span>
</code></pre>
<p>统一的标签策略便于资源查询、监控和自动化管理。</p>
<h2 data-id="heading-12">五、渐进式配置策略</h2>
<h3 data-id="heading-13">5.1 从简单开始，逐步完善</h3>
<p>不要试图一次性创建完美的 Deployment 配置，而应采用渐进式方法：</p>
<ol>
<li><strong>基础阶段</strong>：仅包含必要字段（镜像、副本数、端口）</li>
<li><strong>增强阶段</strong>：添加健康检查、资源限制</li>
<li><strong>优化阶段</strong>：配置高级策略（网络、安全、存储）</li>
</ol>
<p><strong>基础配置示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">my-app:latest</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
</code></pre>
<h3 data-id="heading-14">5.2 配置验证与自动化测试</h3>
<p>将配置验证集成到 CI/CD 流水线中，确保变更安全可靠。</p>
<p><strong>验证步骤</strong>：</p>
<ol>
<li>语法验证：<code>kubectl apply --dry-run=client -f deployment.yaml</code></li>
<li>策略检查：使用 OPA/Conftest 验证安全策略</li>
<li>集成测试：在测试环境验证配置正确性</li>
</ol>
<h2 data-id="heading-15">六、工具链整合</h2>
<p>以下表格对比了不同简化方案的特点和适用场景：</p>



































<table><thead><tr><th>工具/方法</th><th>核心优势</th><th>适用场景</th><th>学习曲线</th></tr></thead><tbody><tr><td>Helm</td><td>强大的模板化、版本管理、依赖解决</td><td>复杂应用、多环境部署、应用分发</td><td>中等</td></tr><tr><td>Kustomize</td><td>无模板、纯 YAML、Kubernetes 原生</td><td>环境差异化、配置补丁、简单应用</td><td>平缓</td></tr><tr><td>Skaffold</td><td>自动化开发流程、快速反馈</td><td>本地开发、持续集成、微服务架构</td><td>中等</td></tr><tr><td>GitOps</td><td>声明式、版本控制、自愈能力</td><td>生产环境、团队协作、合规要求</td><td>陡峭</td></tr></tbody></table>
<h2 data-id="heading-16">七、实战案例：电商应用配置简化</h2>
<p>假设我们有一个电商应用，需要管理前端、后端和数据库多个组件。</p>
<p><strong>原始复杂配置</strong>（部分）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 原始冗长且重复的配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">ecommerce-frontend</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">frontend:1.2.3</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_HOST</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"db.example.com"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">API_ENDPOINT</span>  
          <span class="hljs-attr">value:</span> <span class="hljs-string">"https://api.example.com"</span>
        <span class="hljs-comment"># ... 更多环境变量</span>
</code></pre>
<p><strong>简化后配置</strong>（使用 Kustomize + Helm）：</p>
<ol>
<li><strong>基础配置</strong>（base/deployment.yaml）：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Release.Name</span> }}<span class="hljs-string">-frontend</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> {{ <span class="hljs-string">.Values.replicaCount</span> }}
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ .Values.image.repository }}</span>:<span class="hljs-template-variable">{{ .Values.image.tag }}</span>"</span>
        <span class="hljs-attr">envFrom:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">configMapRef:</span>
            <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Release.Name</span> }}<span class="hljs-string">-environment</span>
</code></pre>
<ol>
<li><strong>环境特定值</strong>（values/production.yaml）：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">replicaCount:</span> <span class="hljs-number">5</span>
<span class="hljs-attr">image:</span>
  <span class="hljs-attr">repository:</span> <span class="hljs-string">frontend</span>
  <span class="hljs-attr">tag:</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span><span class="hljs-string">-prod</span>
</code></pre>
<ol>
<li><strong>配置映射生成</strong>：</li>
</ol>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">apiVersion:</span> v1
<span class="hljs-symbol">kind:</span> ConfigMap
<span class="hljs-symbol">metadata:</span>
  name: {{ .Release.Name }}-environment
<span class="hljs-symbol">data:</span>
  {{- range $<span class="hljs-keyword">key</span>, $value := .Values.environment }}
  {{ $<span class="hljs-keyword">key</span> }}: {{ $value | quote }}
  {{- <span class="hljs-keyword">end</span> }}
</code></pre>
<p>这种方法将配置分解为可管理的部分，大幅提升了可维护性。</p>
<h2 data-id="heading-17">八、总结</h2>
<p>Kubernetes Deployment 配置的复杂性是不可避免的，但通过合适的工具和方法，我们可以将这种复杂性有效管理起来。关键要点总结如下：</p>
<ol>
<li><strong>工具选择</strong>：根据团队规模和技术栈选择合适的工具组合（Helm + Kustomize + Skaffold）</li>
<li><strong>渐进采纳</strong>：从简单配置开始，逐步添加高级功能</li>
<li><strong>标准化</strong>：建立团队统一的配置规范和最佳实践</li>
<li><strong>自动化</strong>：将验证、测试和部署流程自动化</li>
<li><strong>文档化</strong>：为配置模板和值文件提供清晰的文档</li>
</ol>
<p>通过实施这些策略，您不仅能够降低 Kubernetes Deployment 的配置复杂度，还能提升部署效率和应用可靠性，真正发挥 Kubernetes 作为容器编排平台的强大能力。</p>
<blockquote>
<p>本文介绍的方法和工具可以单独或组合使用，建议团队根据具体需求和技能水平选择最适合的简化路径，逐步建立高效可靠的 Kubernetes 应用交付流程。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang: sqlc 和 goose 最佳实践]]></title>    <link>https://juejin.cn/post/7577031454586945563</link>    <guid>https://juejin.cn/post/7577031454586945563</guid>    <pubDate>2025-11-27T13:47:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577031454586945563" data-draft-id="7577222731790336026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang: sqlc 和 goose 最佳实践"/> <meta itemprop="keywords" content="后端,Go,全栈"/> <meta itemprop="datePublished" content="2025-11-27T13:47:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="工程师_Yan"/> <meta itemprop="url" content="https://juejin.cn/user/4266553197470408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang: sqlc 和 goose 最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4266553197470408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    工程师_Yan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:47:49.000Z" title="Thu Nov 27 2025 13:47:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">sqlc 和 goose 最佳实践</h2>
<p>最近有使用 Golang 来写一些小的项目，需要使用到数据库，之前有使用过 GORM 这种 ORM 框架，开发起来非常方便，但是发现项目的代码多了之后管理起来不是非常方便，所以学习了一下 goose 和 sqlc 这两个工具，这篇文章就是总结一下两个工具如何搭配使用。</p>
<h3 data-id="heading-1">goose 数据库版本迁移工具</h3>
<h4 data-id="heading-2">安装</h4>
<p>goose 是 Go 语言写的一个数据库迁移工具，能够以版本控制的方式帮我们管理数据库当中的表。</p>
<p>在使用 goose 之前需要使用下面的命令进行安装。</p>
<pre><code class="hljs language-zsh" lang="zsh">go install github.com/pressly/goose/v3/cmd/goose@latest
</code></pre>
<p>出现如下命令说明成功安装了 <code>goose</code> 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82b4a401523d4f56918ac863ce28b6de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bel56iL5biIX1lhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856068&amp;x-signature=arI%2FE8hr9EtRaeeojVz4V5WcIgA%3D" alt="1764076458777-vXrPwV" loading="lazy"/></p>
<h4 data-id="heading-3">使用</h4>
<h4 data-id="heading-4">1. 配置环境变量</h4>
<p>在使用 goose 的时候默认会读取环境变量当中的 <code>GOOSE_DRIVER</code> 、 <code>GOOSE_DBSTRING</code> 、<code>GOOSE_MIGRATION_DIR</code> 三个环境变量。</p>
<ul>
<li><code>GOOSE_DRIVER</code> : goose 在执行数据库迁移的时候使用的数据库驱动类型</li>
<li><code>GOOSE_DBSTRING</code> : goose 在执行数据库迁移的时候使用的数据库链接 URL</li>
<li><code>GOOSE_MIGRATION_DIR</code>：goose 读取的迁移文件目录</li>
</ul>
<p>当然，goose 不止有上面三个环境变量的配置，更多的可以查看官方介绍文档。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpressly.github.io%2Fgoose%2Fdocumentation%2Fenvironment-variables%2F" target="_blank" title="https://pressly.github.io/goose/documentation/environment-variables/" ref="nofollow noopener noreferrer">pressly.github.io/goose/docum…</a></p>
<p>也可以像下面这样，创建一个 .env 文件，然后写入相关的内容，在使用 goose 的时候会默认载入 .env 当中的环境变量配置。</p>
<pre><code class="hljs language-env" lang="env">GOOSE_DRIVER=postgres  
GOOSE_DBSTRING=postgres://postgres:123456@localhost:5432/goose_test  
GOOSE_MIGRATION_DIR=./sql/schema
</code></pre>
<h4 data-id="heading-5">2. 创建 schema</h4>
<p>执行下面的命令来创建一个迁移的 sql 文件</p>
<pre><code class="hljs language-zsh" lang="zsh">goose create create_user_table sql
</code></pre>
<p>如下图所示，可以看到在项目的 sql/schema 目录当中创建一个 sql 文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c27eb6bc7184d308a7445ce336f5626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bel56iL5biIX1lhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856068&amp;x-signature=W4lRv5sEXfQHGLwlOW734FQOm8s%3D" alt="1764077003108-awDsnf" loading="lazy"/></p>
<p>在 sql 文件当中写入如下的内容。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- +goose Up  </span>
<span class="hljs-comment">-- +goose StatementBegin  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> account  
(  
    id       SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,  
    name     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  
    email    <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  
    password <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>  
);  
<span class="hljs-comment">-- +goose StatementEnd  </span>
  
<span class="hljs-comment">-- +goose Down  </span>
<span class="hljs-comment">-- +goose StatementBegin  </span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> account;  
<span class="hljs-comment">-- +goose StatementEnd</span>
</code></pre>
<p>文件当中的 <code>-- +goose Up  </code> 下面的部分是在执行 <code>goose up</code> 让数据库的版本 +1 的时候生效；<code>-- +goose Down </code> 下面的部分对应的上面部分的反向操作。上面的 sql <code>goose up</code> 的部分就是在数据库当中创建一张 account 表，而 <code>goose down</code> 的部分就是把数据当中的 <code>account</code> 表删掉。</p>
<h4 data-id="heading-6">3. 执行迁移</h4>
<p>有了数据库迁移文件之后就可以开始执行数据库迁移了。常用的命令有下面两个：</p>
<ul>
<li><code>goose up</code> : 这个命令能够把当前数据库的版本升级到最新版本，也就是你最新创建的那个数据库迁移文件的版本。</li>
<li><code>goose down</code>：这个命令会将当前的数据库版本进行降低，每次执行都降低一个版本。</li>
</ul>
<p>更多的详细命令可以直接使用 <code>goose</code> 命令来查看详情。</p>
<p>下图使用一次 <code>goose up</code> 把最新的两次 sql 迁移文件都应用到数据当中，随后使用两次 <code>goose down</code> 把数据库的版本恢复到最开始版本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ca04ffca174fd9b030285fda3f2ebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bel56iL5biIX1lhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856068&amp;x-signature=bx2xQTTYxdSC2xzHw8nA3nzt9Rg%3D" alt="1764078258242-hx3bEw" loading="lazy"/></p>
<p><code>20251125133155_create_post_table.sql</code> 的内容如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- +goose Up  </span>
<span class="hljs-comment">-- +goose StatementBegin  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> post  
(  
    id       SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,  
    title    text <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  
    body     text  
);  
<span class="hljs-comment">-- +goose StatementEnd  </span>
  
<span class="hljs-comment">-- +goose Down  </span>
<span class="hljs-comment">-- +goose StatementBegin  </span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> post;  
<span class="hljs-comment">-- +goose StatementEnd</span>
</code></pre>
<h3 data-id="heading-7">sqlc</h3>
<p><strong>sqlc</strong> 是一个为 Go 语言设计的 SQL 编译器，它能够从 SQL 查询生成完全类型安全的惯用 Go 代码。它不是一个 ORM，而是一个代码生成工具，专门解决数据库交互中的类型安全问题。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.sqlc.dev%2Fen%2Fstable%2Foverview%2Finstall.html" target="_blank" title="https://docs.sqlc.dev/en/stable/overview/install.html" ref="nofollow noopener noreferrer">docs.sqlc.dev/en/stable/o…</a></p>
<h4 data-id="heading-8">安装</h4>
<p>sqlc 本质是一个可执行程序，使用下面的命令来安装。</p>
<pre><code class="hljs language-zsh" lang="zsh">go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
</code></pre>
<h4 data-id="heading-9">配置</h4>
<p>安装好了之后，就能够直接在命令行使用 <code>sqlc</code> 的命令。在项目当中使用我们需要先在项目的根目录下创建一个 <code>sqlc.yaml</code> 或者 <code>sqlc.yml</code>  的配置文件。<code>sqlc</code> 在生成代码的时候会自动读取配置文件当中的配置。</p>
<p>这里我使用的是 <code>postgresql</code> ， 也可以使用 <code>sqlc init</code> 来自动创建配置文件，我这里的配置文件如下所示。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"2"</span>  
<span class="hljs-attr">sql:</span>  
  <span class="hljs-bullet">-</span> <span class="hljs-attr">engine:</span> <span class="hljs-string">"postgresql"</span>  
    <span class="hljs-attr">queries:</span> <span class="hljs-string">"sql/queries"</span>  
    <span class="hljs-attr">schema:</span> <span class="hljs-string">"sql/schema"</span>  
    <span class="hljs-attr">gen:</span>  
      <span class="hljs-attr">go:</span>  
        <span class="hljs-attr">package:</span> <span class="hljs-string">"db"</span>  
        <span class="hljs-attr">out:</span> <span class="hljs-string">"db"</span>  
        <span class="hljs-attr">sql_package:</span> <span class="hljs-string">"pgx/v5"</span>
</code></pre>
<p>配置文件当中的 <code>queries</code> 配置了我需要使用的 SQL 语句所在的目录，schema 配置了数据库表结构，可以直接使用 <code>goose</code> 的 schema 。</p>
<p><code>gen</code> 相关的配置就是配置生成的代码的一些信息，<code>package</code> 指定生成代码的包名，<code>out</code> 指定生成代码的文件夹， <code>sql_package</code> 指定生成的代码文件使用的数据库包。</p>
<h4 data-id="heading-10">编写 SQL</h4>
<p>配置好了之后，就可以开始写自己的业务代码需要用到的 SQL 了，和配置文件指定的一样，把业务需要用到的 SQL 文件都写到 <code>sql/queries</code> 里面，创建一个 <code>user.sql</code>。</p>
<p>这里我直接给出一个增、删、改、查的示例。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- name: GetAccountById :one  </span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>  
<span class="hljs-keyword">FROM</span> account  
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> $<span class="hljs-number">1</span> LIMIT <span class="hljs-number">1</span>;  
  
<span class="hljs-comment">-- name: CreateUser :one  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> account (name, email, password)  
<span class="hljs-keyword">VALUES</span> ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>, $<span class="hljs-number">3</span>) RETURNING <span class="hljs-operator">*</span>;  
  
<span class="hljs-comment">-- name: UpdateUser :exec  </span>
<span class="hljs-keyword">UPDATE</span> account  
<span class="hljs-keyword">SET</span> name <span class="hljs-operator">=</span> $<span class="hljs-number">1</span>, email <span class="hljs-operator">=</span> $<span class="hljs-number">2</span>, password <span class="hljs-operator">=</span> $<span class="hljs-number">3</span>  
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> $<span class="hljs-number">4</span>;  
  
<span class="hljs-comment">-- name: DeleteUser :exec  </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> account  
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> $<span class="hljs-number">1</span>;
</code></pre>
<p>每个 SQL 开始之前的注释当中的 name 代表生成的代码当中的方法名，后面的 <code>:one</code> 代表返回一条记录，也可以是多条 <code>:many</code> ，也可以什么也不返回 <code>:exec</code> 。具体的使用可以参照详细的官方文档。</p>
<h4 data-id="heading-11">生成代码</h4>
<p>接着就是使用 <code>sqlc</code> 来帮我们生成和数据库交互的相关代码。</p>
<p>直接在项目的根目录下执行 <code>sqlc generate</code> 即可，如下图所示，成功的在项目下的 <code>db</code> 文件夹生成了一些代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a45da45e910342d49d4855def8eb05bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bel56iL5biIX1lhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856068&amp;x-signature=C4wx0bN6PhpLcQbDwJeMCuJv4wo%3D" alt="1764243393386-OBkcrT" loading="lazy"/></p>
<p>接下来就愉快的在自己的项目当中使用吧！这里我贴出这个调用上面的 <code>user.sql</code> 的调用示例。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main  
  
<span class="hljs-keyword">import</span> (  
    <span class="hljs-string">"context"</span>  
    <span class="hljs-string">"fmt"</span>  
    <span class="hljs-string">"github.com/dimplesY/goose_test/db"</span>    <span class="hljs-string">"github.com/jackc/pgx/v5"</span>)  
  
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {  
  
    conn, _ := pgx.Connect(context.Background(), <span class="hljs-string">"postgres://postgres:123456@localhost:5432/goose_test"</span>)  
    <span class="hljs-keyword">defer</span> conn.Close(context.Background())  
    queries := db.New(conn)  
  
    user, _ := queries.CreateUser(context.Background(), db.CreateUserParams{  
       Name:     <span class="hljs-string">"1"</span>,  
       Email:    <span class="hljs-string">"1"</span>,  
       Password: <span class="hljs-string">"1"</span>,  
    })  
  
    fmt.Println(user)  
  
    u1, _ := queries.GetAccountById(context.Background(), user.ID)  
    fmt.Println(u1)  
  
    _ = queries.UpdateUser(context.Background(), db.UpdateUserParams{  
       Name:     <span class="hljs-string">"2"</span>,  
       Email:    <span class="hljs-string">"2"</span>,  
       Password: <span class="hljs-string">"2"</span>,  
       ID:       user.ID,  
    })  
  
    u2, _ := queries.GetAccountById(context.Background(), user.ID)  
    fmt.Println(u2)  
  
    _ = queries.DeleteUser(context.Background(), user.ID)  
  
    u3, _ := queries.GetAccountById(context.Background(), user.ID)  
    fmt.Println(u3)  
  
}
</code></pre>
<p>运行结构如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3a42c3cf9d403388ec49374656cd87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bel56iL5biIX1lhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856068&amp;x-signature=PF3GLKt7VtBDx2iJdyj0IiQT7NQ%3D" alt="1764250203991-rpLyA8" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么说Kubernetes的API设计是其成功的关键因素之一？]]></title>    <link>https://juejin.cn/post/7577284409964036159</link>    <guid>https://juejin.cn/post/7577284409964036159</guid>    <pubDate>2025-11-27T13:50:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284409964036159" data-draft-id="7577220965438193718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么说Kubernetes的API设计是其成功的关键因素之一？"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-27T13:50:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么说Kubernetes的API设计是其成功的关键因素之一？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:50:46.000Z" title="Thu Nov 27 2025 13:50:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Kubernetes 的 API 设计确实被广泛认为是其成功的关键基石。这种成功并非偶然，而是源于一系列深思熟虑的设计哲学和原则，它们共同造就了一个既强大又灵活、既稳定且易于扩展的系统。</p>
<p>下面这个表格总结了几个最核心的设计原则及其带来的关键价值。</p>






























<table><thead><tr><th>设计原则</th><th>核心思想</th><th>带来的关键价值</th></tr></thead><tbody><tr><td><strong>声明式 API</strong>​</td><td>用户声明“期望状态”（What），而非发出具体命令（How）。</td><td>系统健壮性、操作稳定性和简化用户体验 。</td></tr><tr><td><strong>无隐藏内部 API</strong>​</td><td>所有组件（包括内部控制器）都通过同一个公共 API 与系统交互。</td><td>系统高度的<strong>可组合性</strong>和<strong>可扩展性</strong>​ 。</td></tr><tr><td><strong>API 对象可组合</strong>​</td><td>API 对象像乐高积木，遵循“高内聚，松耦合”的面向对象设计理念。</td><td>功能模块的<strong>可重用性</strong>和架构的清晰度 。</td></tr><tr><td><strong>清晰的层级与分组</strong>​</td><td>API 按功能分为不同组，并有明确的成熟度（Alpha, Beta, Stable）和版本管理。</td><td>系统演进的<strong>可持续性</strong>和升级的<strong>平滑性</strong>​ 。</td></tr></tbody></table>
<h3 data-id="heading-0">💡 深入理解核心原则</h3>
<ul>
<li><strong>声明式API驱动控制闭环</strong>：声明式设计是Kubernetes的灵魂。你只需向系统提交一个YAML或JSON文件，描述你期望的应用状态（例如“需要运行3个Nginx实例”）。Kubernetes的控制器会持续地观察当前状态，并将其与你的期望状态进行比对，然后自动执行必要的操作（如创建或删除Pod）来驱动系统向期望状态收敛。这种“水平触发”的机制使得系统在组件发生故障并恢复后，能够根据当前状态立即知道该做什么，而不会因为错过某个指令而混乱，从而极大地增强了系统的<strong>自我修复和容错能力</strong>​ 。</li>
<li><strong>统一的API平面实现高度可扩展</strong>：Kubernetes坚持“没有隐藏的内部API”原则。这意味着你通过<code>kubectl</code>使用的API，和Kubernetes内部的调度器、控制器管理器、kubelet等组件使用的API是<strong>完全相同的</strong>​ 。这种透明性带来了巨大的好处：如果你对默认的调度器不满意，你可以关闭它，并运行一个你自己编写的调度器，这个自定义调度器通过监听和更新Pod的<code>nodeName</code>字段来完成调度，整个过程与集群的其他部分无缝集成。这为<strong>自定义资源定义（CRD）</strong> ​ 和 <strong>Operator模式</strong>​ 的繁荣奠定了坚实基础，让用户能够像管理原生Kubernetes资源一样管理任何自定义的应用。</li>
<li><strong>面向意图的设计与可组合性</strong>：Kubernetes的高层API（如Deployment、Service）是面向用户的<strong>操作意图</strong>设计的，而不是面向具体的技术实现。例如，你关心的是“部署一个可扩展的应用”，而不是“先创建Pod，再创建ReplicaSet”。同时，这些API对象是互补和可组合的。一个Deployment可以管理一组Pod，而一个Service可以为这组Pod提供负载均衡和稳定的网络入口。这种设计使得复杂的分布式应用能够通过多个简单的、可重用的API对象组合而成，降低了复杂度 。</li>
</ul>
<h3 data-id="heading-1">🌱 支撑生态繁荣与平滑演进</h3>
<ul>
<li><strong>稳健的API生命周期管理</strong>：Kubernetes项目发展迅速，但从未因引入新功能而破坏现有用户的稳定性，这得益于其精细的API版本管理策略。API版本分为Alpha（实验性）、Beta（测试性）和Stable（稳定性）三个成熟度等级，并遵循严格的<strong>弃用政策</strong>​ 。这给生态中的开发者和用户吃了一颗“定心丸”，他们可以放心地基于Stable版本的API构建生产系统，因为知道即使在未来版本中，这些API也会在很长周期内保持兼容，并有清晰的迁移路径。</li>
<li><strong>强大的存储、网络等基础设施抽象</strong>：Kubernetes通过定义标准的接口（如容器存储接口CSI、容器网络接口CNI），将底层存储和网络实现的复杂性抽象掉。用户通过PersistentVolumeClaim（PVC）以与实现无关的方式申请存储，而无需关心后台是NFS、Ceph还是云硬盘。这完美体现了其“工作负载可移植性”的原则，使得应用部署描述可以跨不同的集群和环境（本地、多云）无缝迁移 。</li>
</ul>
<h3 data-id="heading-2">💎 总结</h3>
<p>总而言之，Kubernetes的API设计成功地将分布式系统管理的复杂性封装在一套<strong>声明式、可组合、可扩展且生命周期管理完善</strong>的接口之后。这套设计不仅使Kubernetes自身成为一个健壮且强大的平台，更重要的是，它催生了一个充满活力的生态系统，让开发者能够以一致的方式构建和运行应用，而无需过度关注底层基础设施的差异。这正是Kubernetes能够成为云原生时代事实标准的深层原因。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes声明式API相比传统命令式API在故障恢复场景下的具体优势有哪些？]]></title>    <link>https://juejin.cn/post/7577198193216176171</link>    <guid>https://juejin.cn/post/7577198193216176171</guid>    <pubDate>2025-11-27T13:51:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577198193216176171" data-draft-id="7577198193216159787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes声明式API相比传统命令式API在故障恢复场景下的具体优势有哪些？"/> <meta itemprop="keywords" content="Kubernetes,GitHub"/> <meta itemprop="datePublished" content="2025-11-27T13:51:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes声明式API相比传统命令式API在故障恢复场景下的具体优势有哪些？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:51:56.000Z" title="Thu Nov 27 2025 13:51:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Kubernetes 的声明式 API 在设计上确实为系统的故障恢复带来了显著优势。下面这个表格清晰地对比了声明式 API 和命令式 API 在故障恢复场景下的核心差异。</p>



































<table><thead><tr><th>特性维度</th><th>声明式 API (Kubernetes)</th><th>命令式 API (传统脚本)</th></tr></thead><tbody><tr><td><strong>核心逻辑</strong>​</td><td><strong>水平触发 (Level-Triggered)</strong> ：持续对比“期望状态”与“当前状态”，驱使其一致。</td><td><strong>边缘触发 (Edge-Triggered)</strong> ：执行一系列特定的指令。</td></tr><tr><td><strong>操作幂等性</strong>​</td><td><strong>天然幂等</strong>：无论执行多少次 <code>kubectl apply</code>，系统最终状态都一致。</td><td><strong>非常脆弱</strong>：重试脚本可能导致重复操作（如重复创建资源）或遗漏操作。</td></tr><tr><td><strong>状态感知</strong>​</td><td><strong>有状态</strong>：系统明确知道最终的目标是什么。</td><td><strong>无状态</strong>：脚本不知道操作的最终目标，只负责执行步骤。</td></tr><tr><td><strong>故障处理</strong>​</td><td><strong>自动化自我修复</strong>：控制器自动检测差异并修复，无需人工干预。</td><td><strong>手动干预</strong>：需要人工判断故障点，并执行修复脚本或命令。</td></tr><tr><td><strong>复杂度</strong>​</td><td><strong>简化</strong>：用户只需关心“做什么”，而非“怎么做”。</td><td><strong>高昂</strong>：需要编写处理各种异常情况的复杂脚本。</td></tr></tbody></table>
<h3 data-id="heading-0">💡 深入理解声明式API的故障恢复优势</h3>
<p>声明式API的优势，很大程度上源于其“水平触发”的控制循环（Control Loop）机制。系统中的各种控制器（如Deployment Controller）会持续<strong>观察（Observe）</strong> ​ 系统的当前状态，并将其与你通过YAML文件声明的<strong>期望状态（Desired State）</strong> ​ 进行<strong>比较（Compare）</strong> 。一旦发现不一致（例如，Pod副本数未达到要求），控制器就会<strong>执行（Act）</strong> ​ 必要的操作（如创建新的Pod），使当前状态向期望状态<strong>收敛（Reconcile）</strong> 。 这个过程是持续不断的，即使本次修复后再次发生故障，控制循环依然会生效。</p>
<p>这种设计带来了几个关键优势：</p>
<ul>
<li><strong>天然幂等性与安全的重试机制</strong>：声明式操作（如 <code>kubectl apply</code>）是<strong>幂等</strong>的。你可以安全地多次执行同一个命令，而不会破坏系统的稳定性。如果系统已经处于期望状态，操作将不会产生任何效果。这对于故障恢复至关重要，因为你可以放心地重新提交配置，而不必担心因重试导致重复创建资源等副作用。</li>
<li><strong>目标导向与系统自愈</strong>：你只需定义“运行3个Nginx实例”这个目标，而不需要编写“如果现在只有2个，就再启动1个”的逻辑。当某个Pod因底层节点故障而终止时，Deployment控制器会<strong>自动检测</strong>到当前状态（2个Pod）与期望状态（3个Pod）不匹配，并立即在新的健康节点上创建一个新的Pod。这个过程是<strong>自动的</strong>，无需运维人员手动介入。</li>
<li><strong>统一的状态存储与可见性</strong>：整个系统的期望状态和当前状态都持久化存储在<strong>etcd</strong>这个统一的中心化数据库中。 这意味着，即使Kubernetes的控制平面组件（如控制器管理器）发生重启，它们在恢复后也能立刻从etcd中获取到完整的状态信息，并继续执行协调工作，不会因错过故障事件而无法恢复。</li>
</ul>
<h3 data-id="heading-1">🛠️ 声明式API的实践运用</h3>
<p>在实际使用中，声明式API的威力通过一些核心命令和概念体现出来：</p>
<ul>
<li><strong>核心操作命令</strong>：<code>kubectl apply -f &lt;file.yaml&gt;</code>是声明式操作的代表。你应该将应用的所有配置（Deployment, Service等）用YAML文件描述出来，并纳入<strong>版本控制系统（如Git）</strong> ​ 进行管理。这带来了可追溯、可回滚和易于复现的部署流程，是<strong>GitOps</strong>实践的基础。</li>
<li><strong>故障模拟与恢复</strong>：你可以模拟一个故障（例如使用 <code>kubectl delete pod &lt;pod-name&gt;</code>手动删除一个Pod），然后在几分钟内使用 <code>kubectl get pods</code>命令观察，会发现Kubernetes自动创建了一个新的Pod来替换被删除的，从而维持了副本数量。要回滚一个有问题的部署，你可以简单地执行 <code>kubectl rollout undo deployment/&lt;deployment-name&gt;</code>，系统会自动将应用回退到上一个稳定版本。你也可以通过 <code>kubectl get deployment &lt;deployment-name&gt; -o yaml &gt; old-version.yaml</code>备份当前配置，然后使用 <code>kubectl apply -f old-version.yaml</code>来强制回滚到已知的旧配置。</li>
</ul>
<h3 data-id="heading-2">💎 总结</h3>
<p>总而言之，Kubernetes的声明式API将其故障恢复模式从一种被动的、依赖人工干预和复杂脚本的“边缘触发”方式，转变为一种主动的、<strong>自我修复</strong>的“水平触发”范式。它将运维人员从繁琐的具体操作指令中解放出来，使其能更关注于定义系统的宏观目标，从而极大地提升了分布式系统的**稳定性和可靠性*</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GitPulse：让代码的故事自己讲述]]></title>    <link>https://juejin.cn/post/7577202452800307200</link>    <guid>https://juejin.cn/post/7577202452800307200</guid>    <pubDate>2025-11-27T13:55:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577202452800307200" data-draft-id="7577229187896836131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GitPulse：让代码的故事自己讲述"/> <meta itemprop="keywords" content="IntelliJ IDEA,程序员,Git"/> <meta itemprop="datePublished" content="2025-11-27T13:55:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="舒一笑不秃头"/> <meta itemprop="url" content="https://juejin.cn/user/4257747754552599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GitPulse：让代码的故事自己讲述
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4257747754552599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    舒一笑不秃头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:55:30.000Z" title="Thu Nov 27 2025 13:55:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>你值得被看见，而不是被遗忘</strong></h2>
<p>周五下午，领导突然问你：“这周做了什么？”</p>
<p>你愣住了。明明一整周都在写代码、改 bug、调接口，可 Git 提交记录却只写着 <code>fix bug</code>、<code>update</code>、<code>调整</code>……这些碎片无法还原你的真实价值——那些深夜的思考、重构的决心、攻克难题的喜悦，全都沉没在时间的洪流里。</p>
<p>这不是你的问题，是工具的问题。</p>
<p><strong>我们写代码，不是为了留下一串乱码，而是为了讲述一个故事。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d89c7675ce0c475cb40810091f773c3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856530&amp;x-signature=AS%2B%2BnpQBrJsPrK7MqqeL%2F0YOsC8%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1"><strong>信息 ≠ 理解。而 GitPulse，让信息变成洞察</strong></h2>
<p>理查德·沃曼——TED 创始人、信息架构之父——曾说过一句深刻的话：</p>
<blockquote>
<p>“信息只有被理解，才能产生价值。否则，它只是噪音。”</p>
</blockquote>
<p>Git 提交记录就是典型的“信息噪音”：<br/>
数据很多，但没有结构；<br/>
历史很长，但看不见趋势；<br/>
记录很全，但读不懂意图。</p>
<p>GitPulse 的使命，就是把这堆噪音，变成你能听懂、能分享、能积累的<strong>成长叙事</strong>。</p>
<h3 data-id="heading-2"><strong>如何做到？三个关键词就够了：</strong></h3>
<h4 data-id="heading-3"><strong>1. 结构化：从混乱中提炼秩序</strong></h4>
<ul>
<li><strong>按时间维度</strong>：每日、每周、每月的开发节奏清晰可见</li>
<li><strong>按工作语义</strong>：自动识别“功能开发”“Bug 修复”“架构重构”</li>
<li><strong>按贡献价值</strong>：代码增删量、影响范围、协作模式一目了然</li>
</ul>
<p>就像一张精心设计的地图，GitPulse 只突出你真正需要的信息。</p>
<h4 data-id="heading-4"><strong>2. 可视化：让数据开口说话</strong></h4>
<ul>
<li>趋势图表：你是稳定输出者，还是冲刺型选手？</li>
<li>统计面板：个人、项目、团队，三重视角立体呈现</li>
<li>智能周报：不是流水账，而是有主题、有重点的<strong>价值总结</strong></li>
</ul>
<h4 data-id="heading-5"><strong>3. 语义化：读懂你代码背后的“为什么”</strong></h4>
<p>GitPulse 不只看 diff，更理解意图：<br/>
这是性能优化？还是新功能上线？<br/>
是技术债偿还？还是系统架构升级？</p>
<p>它把零散的提交，重组成一条条<strong>有逻辑、有温度的故事线</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bceb49a34214d4e8b0c746cec7f2dca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856530&amp;x-signature=6WxLPKestABzkTl9jRJE4fuSqBM%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6"><strong>价值先行：不是监控你，而是让你看见自己</strong></h2>
<p>哈里·马克思——传奇营销大师——有一条铁律：</p>
<blockquote>
<p>“先问你能为客户创造什么价值，再谈回报。”</p>
</blockquote>
<p>GitPulse 从不监控、不考核、不压榨。<br/>
它存在的唯一目的，是帮你<strong>看见自己的稀缺性</strong>。</p>
<blockquote>
<p>在这个 AI 高速普及的时代，最危险的不是不会用 AI，而是分不清什么是“标准化工作”——比如在文档指导下就能完成的任务。<br/>
真正让你不可替代的，是那些能带来“非线性回报”的事：设计系统、定义架构、解决模糊问题。</p>
</blockquote>
<p>GitPulse 帮你识别这些闪光点，并把它们沉淀下来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a973e90aff1461fbbf4b5f2413ec87b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856530&amp;x-signature=N5B0abKOYxSVklpoDe0By8NLFos%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7"><strong>为谁创造价值？</strong></h3>
<h4 data-id="heading-8">✅ <strong>给开发者：构建你的成长档案</strong></h4>
<ul>
<li>看见进步：代码量、问题解决数、技术深度的变化</li>
<li>发现模式：高效时段、擅长领域、成长瓶颈</li>
<li>积累资产：每周自动生成的周报，自动归档至 MongoDB，成为你<strong>十年后都能回看的职业日记</strong></li>
</ul>
<p>这不是打卡，这是<strong>有证据的成长</strong>。</p>
<h4 data-id="heading-9">✅ <strong>给团队：让协作透明，减少内耗</strong></h4>
<ul>
<li>谁在做什么？进展如何？避免重复劳动</li>
<li>贡献被看见，努力被认可，协作更流畅</li>
<li>不再“默默付出”，而是“彼此照亮”</li>
</ul>
<h4 data-id="heading-10">✅ <strong>给管理者：理解，而非控制</strong></h4>
<ul>
<li>谁最近压力大？哪些模块频繁改动？</li>
<li>团队节奏是否健康？协作是否存在瓶颈？<br/>
GitPulse 提供的是<strong>共情的视角</strong>，不是冰冷的 KPI。</li>
</ul>
<hr/>
<h2 data-id="heading-11"><strong>特别功能：AI 代码检测——拥抱未来，诚实记录</strong></h2>
<p>我们不回避 AI 编程。<br/>
相反，GitPulse 内置 <strong>AI 代码识别功能</strong>：</p>
<ul>
<li>自动标记 AI 生成代码</li>
<li>统计 AI 辅助占比</li>
<li>帮你反思：哪些工作可被 AI 替代？你的核心价值在哪里？</li>
</ul>
<p>这不是“抓你用 AI”，而是帮你<strong>和 AI 更聪明地协作</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94d67b4af82640d595f636d188b36c57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856530&amp;x-signature=ykWHne1A52OZLtgsIKOy440emW0%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-12"><strong>每周一封“价值名片”：让成长被看见</strong></h2>
<p>每周五，GitPulse 可自动发送<strong>结构化周报</strong>到你的邮箱（甚至可抄送领导）：</p>
<ul>
<li>有主题、有重点、有数据支撑</li>
<li>不是“我做了5个task”，而是“我完成了XX模块的架构升级，性能提升40%”</li>
<li>附带趋势分析，展示你的持续成长</li>
</ul>
<p>这封邮件，是你<strong>写给职场的自信宣言</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc0a87976bd04c7cb47b1ea01cd00fff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856530&amp;x-signature=O0dYAzLx9SqQhX2iqgJIcImDT9A%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-13"><strong>长期主义者的秘密武器：MongoDB 归档</strong></h2>
<p>所有周报自动归档至你的个人 MongoDB 知识库。</p>
<p>想象一下：</p>
<ul>
<li>一年后，你能清晰看到技术成长曲线</li>
<li>三年后，你能自信地说出“我从初级到架构师的路径”</li>
<li>十年后，你或许能写出一本《我的编程人生》</li>
</ul>
<p>这不是数据备份，这是<strong>你职业生涯的数字资产</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de0e4b59a65442ae9cf516761376b946~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764856530&amp;x-signature=vEQJyXhTvGjU3r65jkkK1pDtcpE%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-14"><strong>完全免费，只为价值而生</strong></h2>
<p>GitPulse <strong>没有广告，没有付费墙，完全免费</strong>。</p>
<p>为什么？<br/>
因为我相信：<strong>先给予价值，再谈回报</strong>。</p>
<p>如果你觉得它有用，你的回报可以是：</p>
<ul>
<li>分享给同行</li>
<li>提出建议</li>
<li>或只是说一句“谢谢”</li>
</ul>
<p>这就够了。</p>
<hr/>
<h2 data-id="heading-15"><strong>三步开启你的价值之旅</strong></h2>
<ol>
<li><strong>安装</strong>：在 JetBrains Marketplace 搜索 <strong>“GitPulse”</strong></li>
<li><strong>打开</strong>：IDE 右侧工具栏点击 <strong>“Git Statistics”</strong></li>
<li><strong>感受</strong>：看见你的第一份“有故事的周报”</li>
</ol>
<hr/>
<h2 data-id="heading-16"><strong>最后的话</strong></h2>
<p>我们不是代码机器，我们是<strong>创造者</strong>。<br/>
每一行代码背后，都有思考、挣扎、突破和喜悦。</p>
<p>GitPulse 的使命，就是让这些<strong>被忽视的价值</strong>，重新被看见：</p>
<ul>
<li>让你看见自己</li>
<li>让团队看见彼此</li>
<li>让世界看见开发者的真实分量</li>
</ul>
<p>它不是一个工具，而是一个<strong>懂你的伙伴</strong>。</p>
<hr/>
<blockquote>
<p><strong>GitPulse：不是监控你的工具，而是看见你的伙伴。</strong><br/>
<em>你的提交有脉搏。让它们说话吧。</em> 💻🎵</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在实际生产环境中，Kubernetes声明式API如何实现蓝绿部署、金丝雀发布等高级部署策略？]]></title>    <link>https://juejin.cn/post/7577284409964118079</link>    <guid>https://juejin.cn/post/7577284409964118079</guid>    <pubDate>2025-11-27T13:59:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284409964118079" data-draft-id="7577220965438242870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在实际生产环境中，Kubernetes声明式API如何实现蓝绿部署、金丝雀发布等高级部署策略？"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-27T13:59:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在实际生产环境中，Kubernetes声明式API如何实现蓝绿部署、金丝雀发布等高级部署策略？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:59:32.000Z" title="Thu Nov 27 2025 13:59:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kubernetes 的生产环境中，声明式 API 是实现蓝绿部署、金丝雀发布等高级部署策略的基石。它通过“定义最终状态”而非“执行具体步骤”的逻辑，让复杂且易错的发布过程变得自动化、可重复且高度可靠。</p>
<p>下面这个表格总结了声明式 API 如何核心支撑两种主流的部署策略。</p>




















<table><thead><tr><th><strong>部署策略</strong>​</th><th><strong>声明式 API 的核心作用机制</strong>​</th><th><strong>在生产环境中的关键优势</strong>​</th></tr></thead><tbody><tr><td><strong>蓝绿部署 (Blue-Green)</strong> ​</td><td>通过修改 <strong>Service</strong>​ 或 <strong>Ingress</strong>​ 资源中的<strong>标签选择器</strong>，一键将流量从“蓝色”（旧）版本全部切换到“绿色”（新）版本 。</td><td><strong>秒级回滚</strong>：若新版本出现问题，再次修改选择器即可立即切回旧版本，服务恢复时间极短，对用户影响最小 。</td></tr><tr><td><strong>金丝雀发布 (Canary Release)</strong> ​</td><td>在 <strong>Ingress</strong>​ 或 <strong>Service Mesh</strong>​ 的虚拟服务规则中，<strong>声明</strong>不同版本（如稳定版和金丝雀版）的<strong>流量权重比例</strong>或匹配规则 。</td><td><strong>风险可控</strong>：可将初始流量（如 5%）导至新版本，根据监控指标（成功率、延迟）逐步调整权重，实现平滑、可控的上线 。</td></tr></tbody></table>
<h3 data-id="heading-0">💡 声明式API如何支撑部署策略</h3>
<p>声明式 API 的魅力在于，你只需要告诉 Kubernetes <em>“你想要什么”</em> ，而不是 <em>“具体怎么做”</em> 。对于部署策略而言，这意味着：</p>
<ul>
<li><strong>对于蓝绿部署</strong>：你无需手动编写脚本去逐个调整负载均衡器的配置。你只需提交一个期望状态的变更，例如将 Service 的 <code>selector</code>从 <code>version: blue</code>改为 <code>version: green</code>。Kubernetes 系统内的控制器会持续观察此变化，并自动将流量路由到新的 Pod 集合。如果新版本有问题，你只需将配置改回去，系统会自动且无误地执行回滚操作 。这种<strong>水平触发</strong>的模式确保了系统始终向声明的期望状态收敛。</li>
<li><strong>对于金丝雀发布</strong>：你通过 YAML 文件声明“将 5% 的流量路由到具有 <code>version: canary</code>标签的 Pod”。像 Istio 或 Nginx Ingress Controller 这样的控制器会监听到这个变化，并精确地按此比例分发流量 。之后，你可以通过多次应用更新的 YAML 文件（例如将流量调整为 20%、50%），逐步扩大新版本的流量，整个过程无需任何手动干预，实现了<strong>渐进式交付</strong>​ 。</li>
</ul>
<h3 data-id="heading-1">🛠️ 生产环境中的关键实践与工具</h3>
<p>在实际操作中，结合以下实践和工具能最大化声明式 API 的优势：</p>
<ol>
<li><strong>使用 GitOps 进行版本控制与自动化</strong>：将声明部署策略的 YAML 文件（例如定义 Service、Ingress 的文件）存储在 Git 仓库中。任何变更都通过 Pull Request 进行，便于评审、审计和回滚。配合 Argo CD 或 Flux 等 GitOps 工具，当 Git 仓库中的声明文件发生变化时，工具会自动将变更同步到 Kubernetes 集群，实现<strong>持续且安全的交付</strong>​ 。</li>
<li><strong>利用高级工具实现更复杂的策略</strong>：虽然原生 Kubernetes 资源能实现基本策略，但使用如 <strong>Argo Rollouts</strong>​ 这样的专用控制器可以让你更强大、更直观地声明复杂策略。Argo Rollouts 提供了自定义资源 <code>Rollout</code>，允许你在 YAML 中直接声明蓝绿发布的自动切换条件或金丝雀发布的分析步骤，从而实现<strong>自动化、指标驱动的发布流程</strong>​ 。</li>
<li><strong>配置健康检查和资源限制</strong>：为确保流量切换后应用的稳定性，必须在 Pod 的声明中配置有效的 <code>readinessProbe</code>和 <code>livenessProbe</code>。同时，通过 <code>resources</code>字段为每个容器设置资源请求和限制，防止有问题的版本（如内存泄漏）影响集群节点，这是生产环境的<strong>必备安全措施</strong>。</li>
</ol>
<h3 data-id="heading-2">💎 总结</h3>
<p>总而言之，Kubernetes 的声明式 API 将高级部署策略从依赖人工操作和自定义脚本的复杂任务，转变为了通过定义 YAML 文件即可管理的标准、可靠流程。它不仅<strong>极大地简化了操作</strong>，还通过<strong>自动化</strong>和<strong>版本控制</strong>显著提升了生产环境应用发布的<strong>安全性</strong>与<strong>可靠性</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TinyEngine 低代码实时协作揭秘：原理 +实操，看完直接用！]]></title>    <link>https://juejin.cn/post/7577229187896573987</link>    <guid>https://juejin.cn/post/7577229187896573987</guid>    <pubDate>2025-11-27T12:04:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577229187896573987" data-draft-id="7577226553286524963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TinyEngine 低代码实时协作揭秘：原理 +实操，看完直接用！"/> <meta itemprop="keywords" content="前端,Vue.js,低代码"/> <meta itemprop="datePublished" content="2025-11-27T12:04:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenTiny社区"/> <meta itemprop="url" content="https://juejin.cn/user/3808325101432983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TinyEngine 低代码实时协作揭秘：原理 +实操，看完直接用！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808325101432983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenTiny社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:04:39.000Z" title="Thu Nov 27 2025 12:04:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由周天意同学原创。</p>
<p>一般的多人协作业务需求一般是针对文档，表格或者是制图之类的，场景比较简单，协同操作的对象为文字或者图片，对象比较单一。
乍一看低代码的多人协作看似无从下手，因为低代码不仅涉及到页面 canvas 中一些文字属性的同步，还涉及到<strong>组件拖拽，样式，绑定事件，高级属性，甚至是代码协同编辑</strong>的编辑与同步。那我们是如何在低代码这个场景下实现多人协同编辑的呢。</p>
<h2 data-id="heading-0">TinyEngine低代码引擎多人协同技术详解</h2>
<h3 data-id="heading-1">CRDT</h3>
<p>我们首先来介绍一下实现低代码编辑的协同编辑的底层逻辑 —— CRDT（Conflict-free Replicated Data Type，无冲突复制数据类型）是一种<strong>允许并发修改、自动合并且永不冲突的数据结构</strong>。
即使多个用户同时编辑同一份文档、表格或图形，系统也能在之后自动合并出一致的结果，<strong>不需要“锁”或“人工解决冲突”</strong>。</p>
<h4 data-id="heading-2">一个例子</h4>
<p>假设你有一个协作文本编辑器有两个用户：
A	插入“Hello ”
B	插入“World!”</p>
<p>在普通系统中，如果两个操作几乎同时发生，可能导致冲突（比如：谁的改动算数？）。但在 CRDT 模型下，每个操作都是可合并的：系统会基于操作的逻辑时间或唯一标识符自动确定合并顺序；最终所有节点都会收敛到相同的状态，比如 "Hello World!"。</p>
<h4 data-id="heading-3">CRDT 的两种主要类型</h4>
<ol>
<li>
<p>State-based（状态型 CRDT）
每个节点维护完整的状态副本，并定期将状态合并：
local_state = merge(local_state, remote_state)</p>
</li>
<li>
<p>Operation-based（操作型 CRDT）
每个节点只传播“操作”，比如“加1”“插入字符X”，
其他节点按相同逻辑执行该操作。</p>
</li>
</ol>
<p>在我们的项目中，我们采用的是 <strong>操作型 CRDT（Operation-based CRDT）库 Yjs</strong>。
在 Yjs 中，每个协同文档对应一个<strong>根对象 Y.Doc</strong>，它可以包含多种可协同的数据结构，例如 <strong>Y.Array、Y.Map、Y.Text</strong> 等。<strong>每个客户端都维护一份本地的 Y.Doc 副本</strong>，这些副本通过 Yjs 的同步机制保持一致。
当多个客户端通过 y-websocket provider 连接到同一个房间（room）时，它们会共享相同的文档数据。<strong>任何客户端对文档的修改（如插入、删除、更新）都会被编码为操作（operation）</strong>，并广播到其他客户端，从而实现实时的数据同步。</p>
<h3 data-id="heading-4">从数据结构到协同模型：tiny-engine 的页面 Schema 与 Yjs 的结合</h3>
<p>通过前面的讨论我们可以发现，无论是哪一种类型的 <strong>CRDT（Conflict-free Replicated Data Type）</strong>，其核心都离不开一个<strong>健全且完备的数据结构</strong>。
对于我们的 <strong>tiny-engine</strong> 来说，低代码页面本身也是由一套结构化的数据所描述的。
这套数据结构不仅要支持页面的层级关系（如区块、组件、插槽），还要能够表达页面的动态逻辑（如循环、条件、生命周期、数据源等）。</p>
<p>在 tiny-engine 中，页面的基础结构可以抽象为以下两个 TypeScript 接口：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 节点类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Node</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">componentName</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; &amp; { columns?: { slots?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; }[] }
  children?: <span class="hljs-title class_">Node</span>[]
  componentType?: <span class="hljs-string">'Block'</span> | <span class="hljs-string">'PageStart'</span> | <span class="hljs-string">'PageSection'</span>
  slot?: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  params?: <span class="hljs-built_in">string</span>[]
  loop?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  loopArgs?: <span class="hljs-built_in">string</span>[]
  condition?: <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
}
  
<span class="hljs-comment">// 根节点类型，即页面 Schema</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">RootNode</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">Node</span>, <span class="hljs-string">'id'</span>&gt; &amp; {
  id?: <span class="hljs-built_in">string</span>
  css?: <span class="hljs-built_in">string</span>
  fileName?: <span class="hljs-built_in">string</span>
  methods?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  state?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  lifeCycles?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  dataSource?: <span class="hljs-built_in">any</span>
  bridge?: <span class="hljs-built_in">any</span>
  inputs?: <span class="hljs-built_in">any</span>[]
  outputs?: <span class="hljs-built_in">any</span>[]
  schema?: <span class="hljs-built_in">any</span>
}
</code></pre>
<p>我们可以把它理解为：</p>
<ul>
<li><strong>Node</strong> 代表页面中的一个通用组件节点；</li>
<li><strong>RootNode</strong> 则是整个页面的根节点（Schema），在 Node 的基础上扩展了页面级的属性，如 <code>state</code>、<code>methods</code>、<code>lifeCycles</code> 等。</li>
</ul>
<h3 data-id="heading-5">从数据结构到协同对象</h3>
<p>在使用 <strong>CRDT（这里是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fyjs.dev%2F" target="_blank" title="https://yjs.dev/" ref="nofollow noopener noreferrer">Yjs</a>）</strong> 进行实时协作时，我们的“协作单元”就是上述的这类数据结构。换句话说，Yjs 需要在内部维护一份与 <code>RootNode</code> 对应的共享状态副本。</p>
<p>然而，Yjs 并不能直接理解复杂的 TypeScript 对象结构，我们需要将其<strong>转化为 Yjs 能够识别和同步的类型系统</strong>。
例如：</p>
<ul>
<li>普通对象 → <code>Y.Map</code></li>
<li>数组 → <code>Y.Array</code></li>
<li>字符串、数字、布尔值 → <code>Y.Text</code> / 基本类型</li>
<li>嵌套结构（如 children）则需要递归地转化为嵌套的 Y 类型。</li>
</ul>
<p>因此，我们的第一步工作是：</p>
<blockquote>
<p>根据已有的 <code>Node</code> 和 <code>RootNode</code> 数据结构，将其映射为等价的 Yjs 类型（如 Y.Map、Y.Array 等）。</p>
</blockquote>
<p>这一过程可以抽象为一个通用的 “schema → YDoc” 转换函数。项目中：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">UNDEFINED_PLACEHOLDER</span> = <span class="hljs-string">'__undefined__'</span>
  
<span class="hljs-comment">/**
 * 将普通对象/数组递归转换成 Yjs 对象
 * <span class="hljs-doctag">@param</span> target Y.Map 或 Y.Array
 * <span class="hljs-doctag">@param</span> obj 要转换的对象
 */</span>
<span class="hljs-comment">// toYjs 函数优化后的版本</span>
  
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">toYjs</span>(<span class="hljs-params">target: Y.<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">any</span>&gt; | Y.<span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">any</span>&gt;, obj: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj)) {
    <span class="hljs-keyword">if</span> (!(target <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Array</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Expected Y.Array as target for array input'</span>)
    }
    obj.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (item === <span class="hljs-literal">undefined</span>) {
        target.<span class="hljs-title function_">push</span>([<span class="hljs-variable constant_">UNDEFINED_PLACEHOLDER</span>])
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item === <span class="hljs-literal">null</span>) {
        target.<span class="hljs-title function_">push</span>([<span class="hljs-literal">null</span>])
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(item)) {
        <span class="hljs-keyword">const</span> childArr = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Array</span>()
        <span class="hljs-title function_">toYjs</span>(childArr, item)
        target.<span class="hljs-title function_">push</span>([childArr])
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> item === <span class="hljs-string">'object'</span> &amp;&amp; item !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 明确排除 null</span>
        <span class="hljs-keyword">const</span> childMap = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Map</span>()
        <span class="hljs-title function_">toYjs</span>(childMap, item)
        target.<span class="hljs-title function_">push</span>([childMap])
      } <span class="hljs-keyword">else</span> {
        target.<span class="hljs-title function_">push</span>([item])
      }
    })
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span> &amp;&amp; obj !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (!(target <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Map</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Expected Y.Map as target for object input'</span>)
    }
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, val]</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (val === <span class="hljs-literal">undefined</span>) {
        target.<span class="hljs-title function_">set</span>(key, <span class="hljs-variable constant_">UNDEFINED_PLACEHOLDER</span>)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val === <span class="hljs-literal">null</span>) {
        target.<span class="hljs-title function_">set</span>(key, <span class="hljs-literal">null</span>)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(val)) {
        <span class="hljs-keyword">const</span> yArr = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Array</span>()
        target.<span class="hljs-title function_">set</span>(key, yArr)
        <span class="hljs-title function_">toYjs</span>(yArr, val)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'object'</span> &amp;&amp; val !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 明确排除 null</span>
        <span class="hljs-keyword">const</span> yMap = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Map</span>()
        target.<span class="hljs-title function_">set</span>(key, yMap)
        <span class="hljs-title function_">toYjs</span>(yMap, val)
      } <span class="hljs-keyword">else</span> {
        target.<span class="hljs-title function_">set</span>(key, val)
      }
    })
  }
  <span class="hljs-comment">// 注意：如果 obj 不是对象或数组（如 string, number），函数将静默地不做任何事。这是符合预期的。</span>
}
  
<span class="hljs-comment">// 将 Yjs Map 转回普通对象（递归）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fromYjs</span>(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>): <span class="hljs-built_in">any</span> {
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Map</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-built_in">any</span> = {}
    value.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">v, k</span>) =&gt;</span> {
      obj[k] = <span class="hljs-title function_">fromYjs</span>(v)
    })
    <span class="hljs-keyword">return</span> obj
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Array</span>) {
    <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toArray</span>().<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-title function_">fromYjs</span>(item))
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Text</span>) {
    <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toString</span>()
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value === <span class="hljs-variable constant_">UNDEFINED_PLACEHOLDER</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span> <span class="hljs-comment">// 还原 undefined</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> value
  }
}
</code></pre>
<p>这样，当我们通过 Yjs 对这些 Y 类型进行修改（例如修改 props、插入/删除 children、更新 state），Yjs 就会自动维护 CRDT 冲突合并逻辑，并将变更同步到所有协作客户端。</p>
<h3 data-id="heading-6">监听机制实现 —— 从 Yjs 变更到多人协同视图更新</h3>
<p>前面的步骤成功让我们借助 <strong>Yjs</strong> 实现了数据层面的实时同步：
无论是哪位协作者修改了页面中的某个节点、属性或层级结构，这些变更都能被同步传播到所有客户端。</p>
<p>但是，仅仅让数据“同步”还不够。
在 <strong>tiny-engine</strong> 中，页面渲染与编辑的核心状态仍然依赖于本地的 <strong>Schema</strong>（即 <code>RootNode</code> 和 <code>Node</code> 的结构树）。
换句话说：</p>
<blockquote>
<p>Yjs 负责维护协作的共享状态，但页面的实际渲染与交互仍是基于本地内存中的 Schema。</p>
</blockquote>
<p>因此，我们必须建立一套监听机制，让 Yjs 的变更<strong>能够驱动 Schema 与视图的更新</strong>，形成如下的完整同步链路：</p>
<pre><code class="hljs">Yjs 数据变化 → 更新本地 Schema → 触发渲染引擎刷新视图
</code></pre>
<p>非常好 👍，你这里实际上引出了多人协同中最关键的一个设计点——<strong>“操作意图层”和“数据层”的解耦”</strong>。
你的思路已经非常正确：用事件总线处理结构性变更（如节点插入/删除），用 meta 元数据追踪属性变更。下面我帮你把这一节内容完整、系统地扩写成技术博客风格，同时保留你的原始语义与工程感。👇</p>
<h4 data-id="heading-7">实现思路：Yjs observe 机制</h4>
<p>Yjs 为我们提供了非常强大的变更监听机制：</p>
<ul>
<li><strong><code>observe</code></strong>：监听单个 <code>Y.Map</code> 或 <code>Y.Array</code> 的变更；</li>
<li><strong><code>observeDeep</code></strong>：递归监听整个文档中的所有嵌套结构（常用于复杂 Schema）。</li>
</ul>
<p>通过这些监听器，我们可以捕获到所有节点层面的增删改事件（包括 props、children 等），然后将这些变化<strong>同步回本地 Schema</strong>。</p>
<h4 data-id="heading-8">问题：结构性操作缺乏语义信息</h4>
<p>在理论上，<code>observe</code> 能告诉我们「有节点被插入」，但在实际业务逻辑中，这个信息远远不够。</p>
<p>以节点插入为例，tiny-engine 中的插入函数如下所示：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">insertAfter</span> = (<span class="hljs-params">{ parent, node, data }: InsertOptions</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">id</span>) {
    data.<span class="hljs-property">id</span> = utils.<span class="hljs-title function_">guid</span>()
  }
  
  <span class="hljs-title function_">useCanvas</span>().<span class="hljs-title function_">operateNode</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>,
    <span class="hljs-attr">parentId</span>: parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>,
    <span class="hljs-attr">newNodeData</span>: data,
    <span class="hljs-attr">position</span>: <span class="hljs-string">'after'</span>,
    <span class="hljs-attr">referTargetNodeId</span>: node.<span class="hljs-property">id</span>
  })
}
</code></pre>
<p>可以看到，<strong>插入一个节点</strong>不仅仅是向 children 数组中多 push 一个元素，而是依赖一系列上下文信息：</p>
<ul>
<li>插入到哪个父节点（<code>parentId</code>）；</li>
<li>相对哪个参考节点（<code>referTargetNodeId</code>）；</li>
<li>插入位置（<code>position</code>：before/after/append 等）；</li>
</ul>
<p>但是在 Yjs 的底层结构中，这些上下文信息在同步时都会<strong>丢失</strong>。
我们只会收到一条 “<code>children</code> 数组新增了一个元素” 的事件：</p>
<pre><code class="hljs language-ts" lang="ts">event.<span class="hljs-property">changes</span>.<span class="hljs-property">added</span> <span class="hljs-comment">// =&gt; [Y.Map({ id: 'new-node-id', ... })]</span>
</code></pre>
<p>这时我们无法推断出节点是“如何插入”的，也就无法还原编辑器层面的真实操作。
换句话说，<strong>Yjs 提供了数据变化的结果，但我们需要的是操作的意图</strong>。</p>
<h4 data-id="heading-9">解决方案：事件总线 + meta 元数据</h4>
<p>为了解决这一问题，我们在架构中引入了两个关键机制：</p>




















<table><thead><tr><th>机制</th><th>主要负责</th><th>作用范围</th></tr></thead><tbody><tr><td><strong>事件总线（Event Bus）</strong></td><td>传播节点级操作的语义，如新增、删除、移动等</td><td>结构性操作</td></tr><tr><td><strong>Meta 元数据（Metadata）</strong></td><td>描述节点属性、状态等细粒度变化</td><td>属性级操作</td></tr></tbody></table>
<h4 data-id="heading-10">1. 事件总线：同步操作意图</h4>
<p>事件总线的设计目标是让每一个“可复现的操作”都能以事件的形式传播到协作层中。</p>
<p>我们会在 Yjs 文档中专门创建一个 <strong><code>__app_events__</code></strong> 通道，用于通信：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 创建事件通道</span>
<span class="hljs-keyword">const</span> eventsMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">yDoc</span>.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">'__app_events__'</span>)
  
<span class="hljs-comment">// 开启事务保证原子性</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">yDoc</span>.<span class="hljs-title function_">transact</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在目标节点上设置软删除标志，防止幽灵事件</span>
  targetNode.<span class="hljs-title function_">set</span>(<span class="hljs-string">'_node_deleted'</span>, <span class="hljs-literal">true</span>)
  
  <span class="hljs-comment">// 获取事件总线</span>
  <span class="hljs-keyword">const</span> eventsMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">yDoc</span>.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">'__app_events__'</span>)
  
  <span class="hljs-comment">// 准备事件负载</span>
  <span class="hljs-keyword">const</span> eventPayload = {
    <span class="hljs-attr">op</span>: <span class="hljs-string">'delete'</span>,
    <span class="hljs-attr">deletedNodeId</span>: id,
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 可以在负载中包含被删除前的数据，便于远程客户端做一些高级处理（如 "恢复" 功能）</span>
    previousNodeData,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
  }
  
  <span class="hljs-comment">// 使用唯一 ID 发布事件</span>
  <span class="hljs-keyword">const</span> eventId = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substring(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>
  eventsMap.<span class="hljs-title function_">set</span>(eventId, eventPayload)
}, <span class="hljs-string">'local-delete-operation'</span>)
</code></pre>
<p><strong>监听器设计</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 设置一个专门的监听器来处理来自“事件总线”的自定义操作</span>
<span class="hljs-comment">// 处理无法被 initObserver 监听器很好处理的事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">setupEventListeners</span>(<span class="hljs-attr">docName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 解绑旧的监听器，防止重复</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">has</span>(docName)) {
    <span class="hljs-keyword">const</span> { map, cb } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">get</span>(docName)
    map.<span class="hljs-title function_">unobserve</span>(cb)
  }
  
  <span class="hljs-keyword">const</span> docManager = <span class="hljs-title class_">DocManager</span>.<span class="hljs-title function_">getInstance</span>()
  <span class="hljs-keyword">const</span> ydoc = docManager.<span class="hljs-title function_">getOrCreateDoc</span>(docName)
  <span class="hljs-keyword">const</span> eventsMap = ydoc.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">'__app_events__'</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">eventCallback</span> = (<span class="hljs-params">event: Y.YMapEvent&lt;<span class="hljs-built_in">any</span>&gt;, transaction: Y.Transaction</span>) =&gt; {
    <span class="hljs-keyword">if</span> (transaction.<span class="hljs-property">local</span>) <span class="hljs-keyword">return</span>
  
    event.<span class="hljs-property">changes</span>.<span class="hljs-property">keys</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">change, key</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (change.<span class="hljs-property">action</span> === <span class="hljs-string">'add'</span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">payload</span>: <span class="hljs-built_in">any</span> = eventsMap.<span class="hljs-title function_">get</span>(key)
  
        <span class="hljs-keyword">if</span> (payload &amp;&amp; payload.<span class="hljs-property">op</span> === <span class="hljs-string">'move'</span>) {
          <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">DiffPatch</span> = {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'array-swap'</span>,
            <span class="hljs-attr">parentId</span>: payload.<span class="hljs-property">parentId</span>,
            <span class="hljs-attr">schemaId</span>: payload.<span class="hljs-property">schemaId</span>,
            <span class="hljs-attr">swapId</span>: payload.<span class="hljs-property">swapId</span>
          }
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyPatches</span>(docName, [patch])
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (payload &amp;&amp; payload.<span class="hljs-property">op</span> === <span class="hljs-string">'insert'</span>) {
          <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">DiffPatch</span> = {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'array-insert'</span>,
            <span class="hljs-attr">parentId</span>: payload.<span class="hljs-property">parentId</span>,
            <span class="hljs-attr">newNodeData</span>: payload.<span class="hljs-property">newNodeData</span>,
            <span class="hljs-attr">position</span>: payload.<span class="hljs-property">position</span>,
            <span class="hljs-attr">referTargetNodeId</span>: payload.<span class="hljs-property">referTargetNodeId</span>
          }
  
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyPatches</span>(docName, [patch])
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (payload &amp;&amp; payload.<span class="hljs-property">op</span> === <span class="hljs-string">'delete'</span>) {
          <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">DiffPatch</span> = {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'array-delete'</span>,
            <span class="hljs-attr">deletedId</span>: payload.<span class="hljs-property">deletedNodeId</span>,
            <span class="hljs-attr">previousNodeData</span>: payload.<span class="hljs-property">previousNodeData</span>
          }
  
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyPatches</span>(docName, [patch])
        }
      }
  
      eventsMap.<span class="hljs-title function_">delete</span>(key)
    })
  }
  
  <span class="hljs-comment">// 绑定监听器</span>
  eventsMap.<span class="hljs-title function_">observe</span>(eventCallback)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">set</span>(docName, { <span class="hljs-attr">map</span>: eventsMap, <span class="hljs-attr">cb</span>: eventCallback })
}
</code></pre>
<p>这样，每当一个用户在本地执行节点插入或删除操作时：</p>
<p>a. 编辑器会向事件总线发送一条“操作意图”；
b. 该事件会被同步到 Yjs 的 <code>__app_events__</code>；
c. 所有协作者客户端的监听器收到事件后，调用 <code>operateNode</code> 重放操作；
d. 从而保持逻辑一致性与结构同步。</p>
<p>这种做法本质上是 <strong>“Yjs 同步结果 + EventBus 同步语义”</strong> 的结合。</p>
<h4 data-id="heading-11">2. Meta 元数据：追踪节点属性变化</h4>
<p>而对于节点属性（如 <code>props</code>、<code>style</code>、<code>loop</code>、<code>condition</code> 等）而言，我们并不需要同步操作意图，只需同步最终结果即可。
因此我们在每个节点的 Yjs 表示中增加一份 <strong>meta 元数据</strong>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> yNode = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Map</span>()
yNode.<span class="hljs-title function_">set</span>(<span class="hljs-string">'meta'</span>, <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Map</span>({
  <span class="hljs-attr">lastModifiedBy</span>: userId,
  <span class="hljs-attr">lastModifiedAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
  <span class="hljs-attr">changeType</span>: <span class="hljs-string">'props'</span>
}))
</code></pre>
<p>当属性发生修改时，我们更新对应的 meta 字段，这样协作者就能知道：</p>
<ul>
<li>是哪个用户修改的；</li>
<li>修改了什么部分；</li>
<li>修改时间等信息。</li>
</ul>
<p>并通过 <code>observeDeep</code> 自动捕获变化，实现属性级别的实时同步。</p>
<p>这种模式下，结构操作（增删节点）和属性操作（节点内部更新）各司其职，不会互相干扰。</p>
<h4 data-id="heading-12">架构小结</h4>
<p>通过事件总线与 meta 元数据的结合，我们实现了 Yjs 协同编辑的完整闭环：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户操作 → 发布事件（EventBus）
<span class="hljs-code">          ↓
     同步到 Yjs (__app_events__)
          ↓
     其他客户端接收 → 重放操作
          ↓
     Schema &amp; 视图更新
</span></code></pre>
<p>而对于属性更新的路径：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户编辑属性 → 更新节点 meta + props
<span class="hljs-code">          ↓
     Yjs observeDeep 监听到变化
          ↓
     同步到其他客户端 → 更新本地 Schema
          ↓
     触发视图重绘
</span></code></pre>
<p>这种分层架构既保持了 <strong>Yjs 的一致性特性</strong>，又补上了协同编辑中至关重要的 <strong>操作语义层</strong>，让多人实时协同真正具备“人理解的上下文逻辑”。</p>
<p>非常好，这一节正是整个 <strong>反向同步链路（Schema → Yjs）</strong> 的核心部分。下面是经过润色和扩展后的完整博客内容片段，可以直接用于技术文档或博客文章中👇</p>
<h3 data-id="heading-13">反向同步机制 —— 从 Schema 改动更新 Yjs</h3>
<p>在前面我们已经介绍了如何通过 Yjs 的变更来驱动本地 Schema 的更新，实现了**“远端 → 本地”** 的同步逻辑。
而这一节要讲的，则是反向过程：<strong>当本地用户操作导致 Schema 发生变化时，如何将这些变更同步到 Yjs 文档，从而广播给其他协作者。</strong></p>
<h4 data-id="heading-14">基本思路</h4>
<p>反向同步的核心理念是：</p>
<blockquote>
<p>当本地 Vue 响应式状态（Schema）发生变化时，我们通过 Vue Hook 捕获到变更，并将这些变更同步到 Yjs 的共享结构中。</p>
</blockquote>
<p>这一机制的关键在于对 <strong>操作意图（Operation Intent）</strong> 的捕获，而不是单纯地对数据差异做比对。
也就是说，我们并不是在检测“数据变了多少”，而是在监听“用户执行了什么操作”——比如插入节点、删除节点、修改属性等。</p>
<h4 data-id="heading-15">添加节点的示例</h4>
<p>以“添加节点”为例，当用户在编辑器中执行插入操作时，实际的 Schema 改动会通过以下函数完成：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">insertNode</span> = (<span class="hljs-params">
  node: { node: Node; parent: Node; data: Node },
  position: PositionType = POSITION.IN,
  select = <span class="hljs-literal">true</span>
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!node.<span class="hljs-property">parent</span>) {
    <span class="hljs-title function_">insertInner</span>({ <span class="hljs-attr">node</span>: <span class="hljs-title function_">useCanvas</span>().<span class="hljs-property">pageState</span>.<span class="hljs-property">pageSchema</span>!, <span class="hljs-attr">data</span>: node.<span class="hljs-property">data</span> }, position)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">switch</span> (position) {
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">LEFT</span>:
        <span class="hljs-title function_">insertBefore</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">BOTTOM</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">RIGHT</span>:
        <span class="hljs-title function_">insertAfter</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">IN</span>:
        <span class="hljs-title function_">insertInner</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">OUT</span>:
        <span class="hljs-title function_">insertContainer</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">REPLACE</span>:
        <span class="hljs-title function_">insertReplace</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-attr">default</span>:
        <span class="hljs-title function_">insertInner</span>(node)
        <span class="hljs-keyword">break</span>
    }
  }
  
  <span class="hljs-keyword">if</span> (select) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selectNode</span>(node.<span class="hljs-property">data</span>.<span class="hljs-property">id</span>))
  }
  
  <span class="hljs-title function_">getController</span>().<span class="hljs-title function_">addHistory</span>()
}
</code></pre>
<p>我们重点关注 <code>insertBefore</code> 函数的实现：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">insertBefore</span> = (<span class="hljs-params">{ parent, node, data }: InsertOptions</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">id</span>) {
    data.<span class="hljs-property">id</span> = utils.<span class="hljs-title function_">guid</span>()
  }
  
  <span class="hljs-comment">// 更新本地 Schema</span>
  <span class="hljs-title function_">useCanvas</span>().<span class="hljs-title function_">operateNode</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>,
    <span class="hljs-attr">parentId</span>: parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>,
    <span class="hljs-attr">newNodeData</span>: data,
    <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
    <span class="hljs-attr">referTargetNodeId</span>: node.<span class="hljs-property">id</span>
  })
  
  <span class="hljs-comment">// 多人协作同步</span>
  <span class="hljs-title function_">useRealtimeCollab</span>().<span class="hljs-title function_">insertSharedNode</span>({ node, parent, data }, <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>)
}
</code></pre>
<p>可以看到，当本地 Schema 执行节点插入后，接下来就通过
<code>useRealtimeCollab().insertSharedNode(...)</code>
来完成与 Yjs 的同步。</p>
<h4 data-id="heading-16">核心逻辑：<code>insertSharedNode</code></h4>
<p><code>insertSharedNode</code> 是整个反向同步机制的关键函数，它的主要职责是：</p>
<ol>
<li>
<p><strong>确定 Yjs 结构中目标位置</strong>
通过 <code>parent.id</code> 获取共享文档中对应的 <code>Y.Map</code> 或 <code>Y.Array</code>，找到应插入的目标节点。</p>
</li>
<li>
<p><strong>构造 Yjs 节点对象</strong>
将本地的 <code>Node</code> 数据结构序列化为对应的 Yjs 类型（<code>Y.Map</code>），并递归地将 <code>props</code>、<code>children</code> 等字段映射为 Yjs 可操作的数据结构。</p>
</li>
<li>
<p><strong>执行事务性插入</strong>
使用 <code>ydoc.transact()</code> 进行原子操作，保证一次插入在所有协作者中状态一致。</p>
</li>
</ol>
<p>下面是一个简化后的核心示例逻辑：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 拖拽行为产生的节点插入</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">insertNode</span>(<span class="hljs-params">{ node, parent, data }: InsertOptions, position: PositionType</span>) {
  <span class="hljs-keyword">let</span> insertPos
  <span class="hljs-keyword">let</span> insertPosFinal
  
  <span class="hljs-keyword">if</span> (!parent) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(<span class="hljs-title function_">useCanvas</span>().<span class="hljs-property">pageState</span>.<span class="hljs-property">pageSchema</span>!.<span class="hljs-property">id</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, data, position)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">switch</span> (position) {
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">LEFT</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, <span class="hljs-string">'before'</span>, node.<span class="hljs-property">id</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">BOTTOM</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">RIGHT</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, <span class="hljs-string">'after'</span>, node.<span class="hljs-property">id</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">IN</span>:
        insertPos = ([<span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>, <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">LEFT</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[]).<span class="hljs-title function_">includes</span>(position) ? <span class="hljs-string">'before'</span> : <span class="hljs-string">'after'</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(node.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, insertPos)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">OUT</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">OUT</span>, node.<span class="hljs-property">id</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">REPLACE</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, <span class="hljs-string">'replace'</span>, node.<span class="hljs-property">id</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-attr">default</span>:
        insertPosFinal = ([<span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>, <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">LEFT</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[]).<span class="hljs-title function_">includes</span>(position) ? <span class="hljs-string">'before'</span> : <span class="hljs-string">'after'</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(node.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, insertPosFinal)
        <span class="hljs-keyword">break</span>
    }
  }
}
  
<span class="hljs-comment">// insert 操作</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">parentId: <span class="hljs-built_in">string</span>, newNodeData: Node, position: <span class="hljs-built_in">string</span>, referTargetNodeId?: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">operationHandler</span>.<span class="hljs-title function_">insert</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>,
    parentId,
    newNodeData,
    position,
    referTargetNodeId
  })
}
</code></pre>
<p>其实就相当于重写了 <code>insertNode</code> 来实现 Yjs 的变动</p>
<h4 data-id="heading-17">Vue Hook 的作用</h4>
<p>在实际工程中，我们通常会将这类同步逻辑封装在一个组合式 Hook 中，比如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * useCollabSchema Composable
 * 职责:
 * 1. 整合 Y.Doc (持久化数据) 和 Y.Awareness (瞬时状态) 的同步。
 * 2. 提供对共享文档结构 (Schema) 的增删改 API。
 * 3. 提供对远程用户实时状态的响应式数据和更新 API。
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCollabSchema</span>(<span class="hljs-params">options: UseCollabSchemaOptions</span>) {
  <span class="hljs-keyword">const</span> { roomId, currentUser } = options
  <span class="hljs-keyword">const</span> { awareness, provider } = <span class="hljs-title function_">useYjs</span>(roomId, { <span class="hljs-attr">websocketUrl</span>: <span class="hljs-string">`ws://localhost:<span class="hljs-subst">${PORT}</span>`</span> })
  <span class="hljs-keyword">const</span> { remoteStates, updateLocalStateField } = useAwareness&lt;<span class="hljs-title class_">SchemaAwarenessState</span>&gt;(awareness, currentUser)
  
  <span class="hljs-comment">// 获取 NodeSchemaModel 实例</span>
  <span class="hljs-keyword">const</span> schemaManager = <span class="hljs-title class_">SchemaManager</span>.<span class="hljs-title function_">getInstance</span>()
  <span class="hljs-keyword">const</span> schemaModel = schemaManager.<span class="hljs-title function_">createSchema</span>(roomId, provider.<span class="hljs-property">value</span>!)
  
  <span class="hljs-comment">// 拖拽节点</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">insertSharedNode</span> = (<span class="hljs-params">
    node: { node: Node | RootNode; parent: Node | RootNode; data: Node },
    position: PositionType = POSITION.IN
  </span>) =&gt; {
    <span class="hljs-comment">// ...上面提到的核心逻辑</span>
  }
  
  <span class="hljs-comment">// ... 其他核心函数</span>
  
  <span class="hljs-comment">// 组件卸载时取消监听</span>
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    schemaManager.<span class="hljs-title function_">destroyObserver</span>(roomId)
    provider.<span class="hljs-property">value</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sync'</span>, <span class="hljs-function">() =&gt;</span> {})
    <span class="hljs-comment">// awareness.value?.destroy()</span>
  })
  
  <span class="hljs-keyword">return</span> {
    remoteStates,
    insertSharedNode,
    <span class="hljs-comment">// ... 其他核心函数</span>
  }
}
  
</code></pre>
<p>这样，任何时候 Schema 层执行了插入、删除、修改等操作，都可以直接通过 <code>useCollabSchema()</code> 来同步到共享文档。</p>
<h3 data-id="heading-18">总结</h3>
<p>在整个多人协同体系中，<strong>Yjs 与 Schema 的双向同步机制</strong>是 tiny-engine 协作的核心。</p>
<ul>
<li>
<p><strong>正向同步（Yjs → Schema）</strong>：
通过 <code>observe</code> 与 <code>observeDeep</code> 监听 Yjs 的数据变更，当远端协作者修改文档时，本地自动更新 Schema，从而触发界面刷新。</p>
</li>
<li>
<p><strong>反向同步（Schema → Yjs）</strong>：
通过 Vue Hook 捕获本地用户操作（如插入、删除、修改节点等），再调用封装的 <code>useRealtimeCollab()</code> 方法，将变更同步回 Yjs 文档。</p>
</li>
<li>
<p><strong>事件总线与 Meta 元数据</strong>：
用于解决单纯数据变更中无法还原操作意图的问题。事件总线负责节点级别的创建与删除同步，而 Meta 则用于监听属性与状态的更改。</p>
</li>
</ul>
<p>最终，我们构建出了一条完整的数据同步链路：</p>
<pre><code class="hljs">Yjs 改动 → Schema 更新 → 视图刷新
Schema 改动 → Yjs 更新 → 远端同步
</code></pre>
<p>这条链路确保了多人协同环境下的数据一致性与实时响应能力，让每一个编辑动作都能即时地被所有协作者感知与呈现。
它既保证了操作的语义化，也为后续的冲突解决与版本管理打下了坚实的基础。</p>
<h2 data-id="heading-19">实操上手：</h2>
<p>接下来，我们将引导您在本地环境中，仅需几条命令，就能启动一个功能完备的协同设计画布，并见证实时同步的“魔法”。</p>
<h3 data-id="heading-20">预备工作：你的开发环境</h3>
<p>在开始之前，请确保您的本地环境满足以下条件，这是保证顺利运行的基础：</p>
<ul>
<li><strong>Node.js</strong>: 版本需 <code>≥ 16</code>。我们推荐使用 <code>nvm</code> 或 <code>fnm</code> 等工具来管理 Node.js 版本，以避免环境冲突。
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查你的 Node.js 版本</span>
node -v 
</code></pre>
</li>
<li><strong>pnpm</strong>: <code>tiny-engine</code> 采用 pnpm 作为包管理器，以充分利用其在 monorepo（多包仓库）项目中的高效依赖管理能力。
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果尚未安装 pnpm，请运行以下命令</span>
npm install -g pnpm
</code></pre>
</li>
</ul>
<h3 data-id="heading-21">第一步：克隆 <code>tiny-engine</code> 源码</h3>
<p>首先，将 <code>tiny-engine</code> 的官方仓库克隆到您的本地。</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/opentiny/tiny-engine.git
<span class="hljs-built_in">cd</span> tiny-engine
</code></pre>
<p>进入项目目录后，您会发现这是一个结构清晰的 monorepo 项目，所有功能模块（如编辑器核心、物料面板、协作服务等）都作为独立的子包存在于 <code>packages/</code> 目录下。</p>
<h3 data-id="heading-22">2️⃣ 第二步：安装项目依赖</h3>
<p>在项目根目录下，执行 <code>pnpm install</code>。pnpm 会智能地解析并安装所有子包的依赖，并建立它们之间的符号链接（symlinks）。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm install
</code></pre>
<blockquote>
<p><strong>💡 为什么是 pnpm？</strong>
在 monorepo 架构中，pnpm 通过其独特的非扁平化 <code>node_modules</code> 结构和内容寻址存储，可以极大地节省磁盘空间，并避免“幻影依赖”问题，保证了开发环境的纯净与一致性。</p>
</blockquote>
<h3 data-id="heading-23">3️⃣ 第三步：启动开发服务，见证奇迹！</h3>
<p>一切准备就绪，现在只需运行 <code>dev</code> 命令，即可一键启动整个 <code>tiny-engine</code> 开发环境。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm dev
</code></pre>
<p>这个命令背后发生了什么？</p>
<ul>
<li>它会同时启动多个服务，包括：
<ul>
<li><strong>Vite 前端开发服务器</strong>: 负责构建和热更新您在浏览器中看到的编辑器界面。</li>
<li><strong>协作后端服务器 (y-websocket)</strong>: 一个轻量级的 WebSocket 服务器，负责接收、广播和持久化 Y.js 的协同数据。</li>
</ul>
</li>
<li>终端会输出编辑器前端的访问地址，通常默认为 <code>http://localhost:7007</code>（请以您终端的实际输出为准）。</li>
</ul>
<h3 data-id="heading-24">4️⃣ 第四步：开启你的“多人协作”剧本</h3>
<p>现在，是时候扮演不同的协作者了！</p>
<ol>
<li><strong>打开第一个窗口</strong>: 在您的浏览器（推荐 Chrome）中打开上一步获取的地址，例如 <code>http://localhost:7007</code>。您会看到 <code>tiny-engine</code> 的低代码设计器界面。这就是我们的<strong>用户A</strong>。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c46d1b252a42319099d33d96da2ea2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764849879&amp;x-signature=kqRqJGP82o1tNqidGhjKO%2FLSLLE%3D" alt="image-2.png" loading="lazy"/></p>
<ol start="2">
<li>
<p><strong>打开第二个窗口</strong>: <strong>打开一个新的浏览器隐身窗口</strong>，或者使用<strong>另一台连接到同一局域网的设备</strong>，再次访问相同的地址。这个窗口将扮演<strong>用户B</strong>。</p>
</li>
<li>
<p><strong>开始实时协同！</strong>: 将两个窗口并排摆放，现在开始您的表演：</p>
<ul>
<li><strong>在用户A的画布上拖入一个按钮组件</strong>。观察用户B的画布，几乎在拖拽完成的瞬间，同样的按钮就会“凭空出现”在相同的位置。</li>
<li><strong>在用户B的界面上，选中刚刚同步过来的按钮，修改它的“按钮内容”属性</strong>。观察用户A的界面，按钮的文本会实时地、逐字地发生变化。</li>
<li><strong>在用户A的大纲树面板中，拖拽一个组件来改变其层级结构</strong>。观察用户B的大纲树，节点会立即移动到新的位置。</li>
<li><strong>在任意一个窗口中，尝试同时操作</strong>。比如，用户A修改组件的颜色，用户B修改其边距。您会发现，由于 CRDT 的特性，所有的修改最终都会被正确合并，达到最终一致的状态，而不会产生冲突或覆盖。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-25">进阶探索与调试技巧</h3>
<p>如果您对背后的原理感到好奇，可以尝试以下操作来深入探索：</p>
<ul>
<li>
<p><strong>查看协同状态</strong>: 打开浏览器的开发者工具，进入 控制台，你会看到相应的协同状态数据</p>
</li>
<li>
<p><strong>网络“时光机”</strong>: 在开发者工具的 <code>Network</code> 标签页，筛选 <code>WS</code> (WebSocket) 连接。您可以看到客户端与 <code>y-websocket</code> 服务器之间流动的二进制消息。尝试断开网络再重连，观察 Y.js 是如何利用 CRDT 的能力，在重连后自动同步所有离线期间的变更的。</p>
</li>
<li>
<p><strong>扮演“上帝”</strong>: 在控制台中，您可以访问 Y.js 的 <code>doc</code> 和 <code>awareness</code> 实例，尝试手动修改数据或广播自定义状态，来更深入地理解数据驱动的协同模型。</p>
</li>
</ul>
<p>通过以上步骤，您已经成功在本地完整地体验了 <code>tiny-engine</code> 先进的多人协作能力。这不仅仅是一个功能演示，它背后融合了 <strong>CRDT (Y.js)、实时通信 (WebSocket)、元数据驱动和事件总线</strong> 等一系列现代前端工程化的最佳实践。</p>
<h2 data-id="heading-26">演示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48a2d5c95a0a4e93b44d525add444549~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764849879&amp;x-signature=SNzsGXjimOx6A4VPEBLMD4Bblwk%3D" alt="20251026152240_rec_.gif" loading="lazy"/></p>
<p>（本项目为开源之夏活动贡献，欢迎大家体验并使用）
源码可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine%2Ftree%2Fospp-2025%2Fmultiplayer-collaboration" target="_blank" title="https://github.com/opentiny/tiny-engine/tree/ospp-2025/multiplayer-collaboration" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></p>
<h2 data-id="heading-27">关于 OpenTiny</h2>
<p>欢迎加入 OpenTiny 开源社区。添加微信小助手：opentiny-official 一起参与交流前端技术～</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design%2F" target="_blank" title="https://opentiny.design/" ref="nofollow noopener noreferrer">OpenTiny 官网</a>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design" target="_blank" title="https://opentiny.design" ref="nofollow noopener noreferrer">opentiny.design</a></strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">OpenTiny 代码仓库</a>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">github.com/opentiny</a></strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">TinyVue 源码</a>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">TinyEngine 源码</a>： <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></strong><br/>
欢迎进入代码仓库 Star🌟TinyEngine、TinyVue、TinyNG、TinyCLI、TinyEditor~
如果你也想要共建，可以进入代码仓库，找到 good first issue 标签，一起参与开源贡献~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openGauss向量数据库：赋能智能制造的工业AI实践]]></title>    <link>https://juejin.cn/post/7577198193215946795</link>    <guid>https://juejin.cn/post/7577198193215946795</guid>    <pubDate>2025-11-27T12:55:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577198193215946795" data-draft-id="7577268271213559844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openGauss向量数据库：赋能智能制造的工业AI实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-27T12:55:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openGauss向量数据库：赋能智能制造的工业AI实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:55:01.000Z" title="Thu Nov 27 2025 12:55:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>随着工业4.0和人工智能技术的深入发展，智能制造对数据管理和智能决策的需求日益增长。传统关系型数据库在处理非结构化数据和实现高效的相似度搜索方面存在瓶颈。openGauss向量数据库通过集成向量存储和检索能力，为工业AI应用提供了强大的支撑。本文介绍了openGauss向量数据库的核心特性，通过一个智能质量检测系统的实际案例，展示了如何利用向量数据库实现工业缺陷识别和预测性维护，为智能制造企业提供了可行的解决方案。</p>
<p><strong>关键词</strong>：openGauss、向量数据库、智能制造、缺陷检测、机器学习</p>
<h2 data-id="heading-1">引言</h2>
<p>工业AI的现状与挑战</p>
<p>工业制造企业在数字化转型过程中面临多重挑战：</p>
<ul>
<li>
<p><strong>数据多样性</strong>：生产过程中产生的图像、传感器数据、文本日志等非结构化数据占比高达80%以上</p>
</li>
<li>
<p><strong>实时性要求</strong>：需要在毫秒级时间内完成缺陷检测和异常预警</p>
</li>
<li>
<p><strong>模型部署</strong>：如何高效地将深度学习模型集成到生产系统中</p>
</li>
<li>
<p><strong>可扩展性</strong>：随着产线数量增加，系统需要支持PB级数据的存储和查询</p>
</li>
</ul>
<h4 data-id="heading-2">向量数据库的优势</h4>
<p>向量数据库作为新兴的数据存储技术，具有以下优势：</p>
<ul>
<li>
<p><strong>高效的相似度搜索</strong>：支持L2距离、余弦相似度等多种距离度量</p>
</li>
<li>
<p><strong>与AI模型的天然结合</strong>：直接存储神经网络的嵌入向量</p>
</li>
<li>
<p><strong>实时性</strong>：毫秒级的查询响应时间</p>
</li>
<li>
<p><strong>可扩展性</strong>：支持分布式部署和大规模并发查询</p>
</li>
</ul>
<h4 data-id="heading-3">openGauss向量数据库的定位</h4>
<p>openGauss作为开源数据库，其向量数据库扩展提供了：</p>
<ul>
<li>
<p>原生的向量数据类型和索引结构</p>
</li>
<li>
<p>与PostgreSQL兼容的SQL接口</p>
</li>
<li>
<p>企业级的可靠性和安全性</p>
</li>
</ul>
<h2 data-id="heading-4">项目特点</h2>
<ol>
<li><strong>完整性</strong></li>
</ol>
<ul>
<li>
<p>从数据库设计到应用实现的完整链条</p>
</li>
<li>
<p>包含所有必要的配置和脚本</p>
</li>
<li>
<p>提供详细的文档和示例</p>
</li>
</ul>
<ol>
<li><strong>可运行性</strong></li>
</ol>
<ul>
<li>
<p>所有代码都是完整的、可编译的</p>
</li>
<li>
<p>包含完整的Maven配置</p>
</li>
<li>
<p>提供快速开始指南</p>
</li>
<li>
<p>支持开箱即用</p>
</li>
</ul>
<ol>
<li><strong>生产级质量</strong></li>
</ol>
<ul>
<li>
<p>完善的错误处理</p>
</li>
<li>
<p>详细的日志记录</p>
</li>
<li>
<p>连接池管理</p>
</li>
<li>
<p>事务处理</p>
</li>
</ul>
<ol>
<li><strong>文档完善</strong></li>
</ol>
<ul>
<li>
<p>6份详细的文档</p>
<ul>
<li>代码注释完整</li>
</ul>
</li>
<li>
<p>使用示例丰富</p>
</li>
<li>
<p>故障排查指南</p>
</li>
</ul>
<ol>
<li><strong>技术先进</strong></li>
</ol>
<ul>
<li>
<p>使用openGauss向量数据库</p>
</li>
<li>
<p>集成深度学习框架</p>
</li>
<li>
<p>实现向量相似度搜索</p>
</li>
<li>
<p>支持预测性维护</p>
</li>
</ul>
<h2 data-id="heading-5">案例：智能制造缺陷检测系统</h2>
<p>案例背景</p>
<p>某汽车零部件制造企业，年产量达100万件，产品质量直接影响整车安全。传统的人工检测方式存在以下问题：</p>
<ul>
<li>
<p>检测员工作强度大，易产生疲劳误判</p>
</li>
<li>
<p>检测标准难以统一，漏检率约为3-5%</p>
</li>
<li>
<p>无法进行预测性维护，设备故障突发性强</p>
</li>
</ul>
<p>该企业决定建立基于AI的智能质量检测系统，利用深度学习模型识别产品缺陷，并通过向量数据库存储和检索历史缺陷特征，实现快速的缺陷分类和根因分析。</p>
<h4 data-id="heading-6">项目结构</h4>
<p>manufacturing-ai-system/</p>
<p>├── pom.xml # Maven项目配置文件</p>
<p>├── src/</p>
<p>│ ├── main/</p>
<p>│ │ ├── java/</p>
<p>│ │ │ └── com/manufacturing/</p>
<p>│ │ │ ├── DefectFeatureExtractor.java # 特征提取模块</p>
<p>│ │ │ ├── DefectClassifier.java # 缺陷分类模块</p>
<p>│ │ │ ├── RootCauseAnalyzer.java # 根因分析模块</p>
<p>│ │ │ ├── model/</p>
<p>│ │ │ │ ├── DefectInfo.java # 缺陷信息数据类</p>
<p>│ │ │ │ ├── DefectStatistics.java # 缺陷统计数据类</p>
<p>│ │ │ │ ├── RootCauseResult.java # 根因分析结果类</p>
<p>│ │ │ │ └── MaintenanceResult.java # 维护预测结果类</p>
<p>│ │ │ ├── service/</p>
<p>│ │ │ │ ├── DatabaseService.java # 数据库连接管理</p>
<p>│ │ │ │ ├── FeatureExtractionService.java # 特征提取服务</p>
<p>│ │ │ │ └── AnalysisService.java # 分析服务</p>
<p>│ │ │ ├── util/</p>
<p>│ │ │ │ ├── VectorUtils.java # 向量工具类</p>
<p>│ │ │ │ ├── ImageProcessingUtils.java # 图像处理工具</p>
<p>│ │ │ │ └── DatabaseUtils.java # 数据库工具类</p>
<p>│ │ │ └── Application.java # 主应用程序</p>
<p>│ │ └── resources/</p>
<p>│ │ ├── application.properties # 应用配置文件</p>
<p>│ │ ├── db/</p>
<p>│ │ │ └── schema.sql # 数据库初始化脚本</p>
<p>│ │ └── models/</p>
<p>│ │ └── resnet50.zip # 预训练模型文件</p>
<p>│ └── test/</p>
<p>│ └── java/</p>
<p>│ └── com/manufacturing/</p>
<p>│ ├── DefectClassifierTest.java</p>
<p>│ ├── RootCauseAnalyzerTest.java</p>
<p>│ └── VectorUtilsTest.java</p>
<p>├── docs/</p>
<p>│ ├── API文档.md</p>
<p>│ ├── 部署指南.md</p>
<p>│ └── 使用示例.md</p>
<p>└── README.md</p>
<h4 data-id="heading-7">实现步骤</h4>
<p>数据库初始化</p>
<p>-- 创建缺陷特征表</p>
<p>CREATE TABLE defect_features (</p>
<p>defect_id BIGSERIAL PRIMARY KEY,</p>
<p>product_id VARCHAR(50) NOT NULL,</p>
<p>production_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</p>
<p>defect_type VARCHAR(50), -- 划伤、凹陷、变色等</p>
<p>severity DECIMAL(3,2), -- 缺陷严重程度 0-1</p>
<p>feature_vector VECTOR(2048), -- ResNet-50提取的特征向量</p>
<p>image_path VARCHAR(500),</p>
<p>production_line VARCHAR(20),</p>
<p>shift VARCHAR(10) -- 班次信息</p>
<p>);</p>
<p>-- 创建缺陷类型参考表</p>
<p>CREATE TABLE defect_types (</p>
<p>type_id SERIAL PRIMARY KEY,</p>
<p>type_name VARCHAR(100) UNIQUE,</p>
<p>description TEXT,</p>
<p>standard_vector VECTOR(2048), -- 标准缺陷特征向量</p>
<p>acceptable_threshold DECIMAL(3,2)</p>
<p>);</p>
<p>-- 创建向量索引以加速相似度搜索</p>
<p>CREATE INDEX idx_defect_feature_vector ON defect_features</p>
<p>USING ivfflat (feature_vector vector_cosine_ops)</p>
<p>WITH (lists = 100);</p>
<p>CREATE INDEX idx_defect_type_vector ON defect_types</p>
<p>USING hnsw (standard_vector vector_cosine_ops);</p>
<p>缺陷识别和存储</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c98d6f975b944dc8c33bc7f4e3f55d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852901&amp;x-signature=bO4Ba%2BXAceCBdk8wuHeM4yqWzv4%3D" alt="" loading="lazy"/></p>
<p>这段代码是「图像特征提取的标准化流程实现」，设计上解耦、灵活、可观测，核心价值是：</p>
<p>屏蔽底层图像处理的复杂性，向上层提供 “输入路径→输出特征向量” 的简洁接口；</p>
<p>支持配置化、可扩展，便于适配不同业务场景（检索、分类、匹配）和算法方案（传统算法、深度学习）。</p>
<p>其本质是图像业务的 “基础设施”—— 通过将图像数字化为特征向量，让计算机能够 “理解” 图像内容，为后续的智能决策提供数据支撑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/002553ad28d64ec2ad5c881258852110~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852901&amp;x-signature=oP%2FWuq0a7s4GlX1yCNeZPX5J0sU%3D" alt="" loading="lazy"/></p>
<p>这段代码是 工业缺陷管理系统的核心数据存储接口，设计上：</p>
<p>贴合工业场景需求，字段适配生产线、班次、缺陷类型等业务属性；</p>
<p>链路完整、容错性强，包含多节点校验、资源释放、异常处理；</p>
<p>兼容之前的特征提取、向量序列化方法，体现了代码复用和分层设计思想。</p>
<p>其核心价值是「将非结构化的缺陷图像转化为可存储、可检索、可分析的结构化数据」，为工业质量检测的智能化（如相似缺陷匹配、自动分类、工艺优化）提供数据基础。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13e74f2a80194b73b535fe903403b104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852901&amp;x-signature=C7PwqThPz5ZxsYvoE4p8PoaBh%2Fs%3D" alt="" loading="lazy"/></p>
<p>这段代码是 工业缺陷批量存储的高可用实现，核心优势：</p>
<p>性能优化：批量 SQL 执行减少数据库交互，适配高并发场景；</p>
<p>数据一致性：事务控制确保批量操作原子性；</p>
<p>容错性强：跳过无效数据、异常回滚、资源规范释放，避免流程中断；</p>
<p>业务适配：与单条存储逻辑兼容，支持分批、异步扩展。</p>
<p>其本质是「单条存储逻辑的批量升级」，在保持业务逻辑一致性的前提下，通过 JDBC 批量操作和事务控制，解决了高并发、大数据量场景下的缺陷存储效率和数据一致性问题，是工业质量检测系统中批量数据处理的核心接口。</p>
<h5 data-id="heading-8">缺陷分类和相似度搜索</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69d5c9ce4f45418f98211c04a3671c98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852901&amp;x-signature=wAK42ef85AE6AOc8jg%2B47%2B6pBaI%3D" alt="" loading="lazy"/></p>
<p>这段代码是 工业缺陷智能化分类的核心实现，设计上：</p>
<p>技术选型精准：利用 PostgreSQL + pgvector 实现数据库层面的高效相似度查询，兼顾性能和开发效率；</p>
<p>业务适配性强：返回 Top-K 相似结果 + 相似度分数，既支持自动分类，也支持人工确认，符合工业质检的实际流程；</p>
<p>复用性高：与之前的特征提取、向量序列化、数据存储逻辑完全兼容，形成 “提取→存储→分类” 的完整链路。</p>
<p>其核心价值是「将历史缺陷数据转化为分类能力」，通过无监督的相似度匹配实现新缺陷的自动分类，大幅降低人工标注成本，提升工业质检的智能化水平和效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e077e5e9425742f6b5710406942523cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852901&amp;x-signature=Nvqj9z1RrHGPwXjoAtrGsoJX5Xs%3D" alt="" loading="lazy"/></p>
<p>这段代码是 工业质量统计分析的核心接口，设计上：</p>
<p>性能高效：数据库层面完成聚合计算，避免应用层冗余处理；</p>
<p>业务贴合：分组粒度、统计指标精准匹配工业质量管控需求；</p>
<p>结果结构化：返回值便于报表展示和上层业务扩展。</p>
<p>其核心价值是「将分散的缺陷数据转化为可决策的质量洞察」—— 通过多维度统计，让生产管理者快速定位质量问题、评估优化效果，推动工业生产的精细化质量管控。</p>
<h5 data-id="heading-9">预测性维护和根因分析</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2136d18c5aa40449b42125c398268de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852901&amp;x-signature=yY6umzsAclAUb1ZltRBgPP2dhoU%3D" alt="" loading="lazy"/></p>
<p>这段代码是 工业缺陷根因分析的智能化实现，设计上：</p>
<p>技术选型贴合场景：用余弦相似度量化特征相似性，时序相邻计算贴合生产实际；</p>
<p>结果客观可落地：基于量化指标 + 配置阈值判断根因，提供针对性建议，避免 “纸上谈兵”；</p>
<p>链路兼容复用：与之前的特征提取、存储、分类逻辑无缝衔接，形成 “数据存储→分析决策” 的完整闭环。</p>
<p>其核心价值是「将非结构化的缺陷图像数据，转化为可指导生产优化的根因洞察」，帮助生产部门快速定位问题、减少无效排查，推动工业质量管控从 “被动检测” 向 “主动预防” 转型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa11b96bc710467f859194a02dafc8e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852901&amp;x-signature=NSp9sD6CXjlhyUVAdDsGo9Q%2FEFU%3D" alt="" loading="lazy"/></p>
<p>这段代码是 工业设备预防性维护的智能化实现，设计上：</p>
<p>数据驱动：基于时序缺陷数据计算增长速率，避免主观判断，预测结果客观可复现；</p>
<p>业务贴合：结果包含紧急度、具体建议、时间预估，直接适配工业运维流程；</p>
<p>链路兼容：复用之前的缺陷存储数据，无需额外建设数据链路，降低落地成本。</p>
<p>其核心价值是「将缺陷数据转化为设备维护决策」，通过提前预判设备故障，减少非计划停机时间，降低生产损失，推动工业运维从 “被动维修” 向 “主动预防” 转型，是智能制造场景中质量管控与设备管理的核心衔接接口。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/550f92cfc07243a1b15b624283c57d05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852901&amp;x-signature=KbInD4bkoR7ykMqgF0osEEHzWhc%3D" alt="" loading="lazy"/></p>
<p>这段代码是 工业质量趋势监控的轻量级实现，设计上：</p>
<p>简洁实用：直接返回格式化字符串，无需上层二次解析，快速适配可视化场景；</p>
<p>指标全面：兼顾缺陷数（频率）和严重程度（影响），全面反映质量趋势；</p>
<p>链路兼容：复用 defect_features 表数据，与之前的缺陷存储、统计逻辑无缝衔接。</p>
<p>其核心价值是「为质量监控提供直观、时序化的趋势数据」，帮助生产管理者快速掌握质量变化动态，为决策提供数据支撑。若需适配更复杂的可视化场景（如折线图、跨维度对比），可通过 “返回结构化数据 + 补充缺失日期” 进一步优化，提升扩展性和精准度。</p>
<h2 data-id="heading-10">性能指标</h2>
<p>该系统上线后取得的成果：</p>
<p><strong>指标</strong></p>
<p><strong>实施前</strong></p>
<p><strong>实施后</strong></p>
<p><strong>改进</strong></p>
<p>缺陷漏检率</p>
<p>3.5%</p>
<p>0.8%</p>
<p>↓77%</p>
<p>检测速度</p>
<p>15秒/件</p>
<p>0.5秒/件</p>
<p>↑30倍</p>
<p>人工成本</p>
<p>100万/年</p>
<p>30万/年</p>
<p>↓70%</p>
<p>设备故障预警时间</p>
<p>0小时</p>
<p>48小时</p>
<p>+48h</p>
<p>系统可用性</p>
<p>95%</p>
<p>99.5%</p>
<p>↑4.5%</p>
<h4 data-id="heading-11">技术亮点</h4>
<h4 data-id="heading-12">向量数据库的优势体现</h4>
<ol>
<li>
<p><strong>实时性</strong>：毫秒级的相似度搜索，满足生产线实时检测需求</p>
</li>
<li>
<p><strong>准确性</strong>：通过向量相似度而非规则匹配，提高了缺陷识别的准确率</p>
</li>
<li>
<p><strong>可扩展性</strong>：支持PB级数据存储，可应用于多条产线</p>
</li>
<li>
<p><strong>可解释性</strong>：通过相似度搜索找到历史案例，便于工程师分析和改进</p>
</li>
</ol>
<p>与openGauss的结合优势</p>
<ul>
<li>
<p><strong>兼容性</strong>：与PostgreSQL兼容，降低迁移成本</p>
</li>
<li>
<p><strong>安全性</strong>：支持行级安全策略和加密存储</p>
</li>
<li>
<p><strong>成本</strong>：开源免费，降低企业IT成本</p>
</li>
</ul>
<h2 data-id="heading-13">最佳实践</h2>
<h4 data-id="heading-14">数据质量管理</h4>
<p>-- 定期清理异常数据</p>
<p>DELETE FROM defect_features</p>
<p>WHERE severity &lt; 0 OR severity &gt; 1</p>
<p>OR feature_vector IS NULL;</p>
<p>-- 数据备份和恢复</p>
<p>BACKUP DATABASE manufacturing_db</p>
<p>TO '/backup/manufacturing_db_backup.sql';</p>
<h4 data-id="heading-15">性能优化</h4>
<ul>
<li>
<p><strong>索引优化</strong>：根据查询模式选择合适的索引算法（IVFFLAT vs HNSW）</p>
</li>
<li>
<p><strong>分区策略</strong>：按生产日期分区，提高查询效率</p>
</li>
<li>
<p><strong>缓存策略</strong>：缓存热点缺陷类型的标准向量</p>
</li>
</ul>
<h4 data-id="heading-16">监控和告警</h4>
<p>-- 创建监控视图</p>
<p>CREATE VIEW defect_alert_view AS</p>
<p>SELECT</p>
<p>production_line,</p>
<p>defect_type,</p>
<p>COUNT(*) as hourly_count,</p>
<p>AVG(severity) as avg_severity</p>
<p>FROM defect_features</p>
<p>WHERE production_date &gt;= CURRENT_TIMESTAMP - INTERVAL '1 hour'</p>
<p>GROUP BY production_line, defect_type</p>
<p>HAVING COUNT(*) &gt; 10 OR AVG(severity) &gt; 0.7;</p>
<h2 data-id="heading-17">写在最后</h2>
<p><strong>挑战</strong></p>
<p><strong>解决方案</strong></p>
<p>特征向量维度高</p>
<p>使用PCA或自编码器降维，从2048维降至512维</p>
<p>模型漂移</p>
<p>定期重新训练模型，使用在线学习技术</p>
<p>数据隐私</p>
<p>对敏感数据进行匿名化处理，使用差分隐私技术</p>
<p>系统延迟</p>
<p>使用GPU加速特征提取，优化索引参数</p>
<h4 data-id="heading-18">主要成果</h4>
<p>通过将openGauss向量数据库应用于智能制造缺陷检测系统，我们实现了：</p>
<ul>
<li>
<p>缺陷检测准确率提升至99.2%</p>
</li>
<li>
<p>系统响应时间从秒级降至毫秒级</p>
</li>
<li>
<p>预测性维护提前48小时预警设备故障</p>
</li>
<li>
<p>年度成本节省700万元</p>
</li>
</ul>
<p>未来方向</p>
<ol>
<li>
<p><strong>多模态融合</strong>：结合图像、传感器数据和文本日志的多模态向量</p>
</li>
<li>
<p><strong>边缘计算</strong>：在产线端部署轻量级模型，实现本地推理</p>
</li>
<li>
<p><strong>联邦学习</strong>：在多个工厂间共享模型而不暴露原始数据</p>
</li>
<li>
<p><strong>数字孪生</strong>：建立虚拟生产线，进行缺陷预测和工艺优化</p>
</li>
</ol>
<p>建议</p>
<p>对于计划采用向量数据库的制造企业，我们建议：</p>
<ol>
<li>
<p><strong>从小规模试点开始</strong>，选择一条产线进行POC验证</p>
</li>
<li>
<p><strong>建立完善的数据治理体系</strong>，确保数据质量</p>
</li>
<li>
<p><strong>投入人才培养</strong>，培训团队掌握AI和数据库技术</p>
</li>
<li>
<p><strong>制定长期规划</strong>，逐步扩展到全厂应用</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[把常用 Prompt 做成 Skill 之后，我和 Claude Code 的配合效率直接翻了 3 倍]]></title>    <link>https://juejin.cn/post/7577268271213183012</link>    <guid>https://juejin.cn/post/7577268271213183012</guid>    <pubDate>2025-11-27T11:35:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577268271213183012" data-draft-id="7577042546094899242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="把常用 Prompt 做成 Skill 之后，我和 Claude Code 的配合效率直接翻了 3 倍"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-27T11:35:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术探索家"/> <meta itemprop="url" content="https://juejin.cn/user/2735240657517816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            把常用 Prompt 做成 Skill 之后，我和 Claude Code 的配合效率直接翻了 3 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240657517816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术探索家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:35:38.000Z" title="Thu Nov 27 2025 11:35:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1bd2b15c6be4c5cb7900bef6c5b96c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5o6i57Si5a62:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764848866&amp;x-signature=2VLnxWzYBrKeCaV1BMXHDaf8%2Bic%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">一个真实故事</h2>
<p>去年10月，我手里有个React项目要重构，2000多行的上帝类，看着就头疼。每次让Claude Code帮我优化代码，我都要重复交代一遍：</p>
<ul>
<li>"记得用TypeScript严格模式"</li>
<li>"API调用要加错误处理"</li>
<li>"组件要符合单一职责原则"</li>
</ul>
<p>复制粘贴这些要求，少说也得两三分钟。更烦的是，聊了十几轮之后，Claude Code经常会"忘记"我最初的要求，又开始写出不符合规范的代码。</p>
<p>直到我在文档里翻到了Skill功能。</p>
<p>试了一周后，我把那些重复的要求全封装成了几个skill文件。现在只要一句<code>@skill react-refactor</code>，Claude Code立刻就知道该怎么做。那个2000行的类，原本估计要花三天时间重构，最后两个下午就搞定了。</p>
<h2 data-id="heading-1">Skill到底是什么</h2>
<p>说白了，Skill就是给Claude Code装技能包。</p>
<p>你在<code>.claude/skills/</code>目录下创建一个markdown文件，把常用的提示词、工作流程、代码规范写进去。需要的时候，一句<code>@skill 技能名</code>就能调用。就像游戏里给角色装备不同技能，需要输出的时候装输出技能，需要坦克的时候装防御技能。</p>
<p>来看个最简单的例子：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
title: "React代码审查专家"
<span class="hljs-section">description: "专门审查React代码的质量、性能和最佳实践"
---</span>

<span class="hljs-section"># React代码审查流程</span>

你是一位经验丰富的React代码审查专家。请按以下标准审查代码：

<span class="hljs-section">## 审查重点</span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**组件设计**</span>
<span class="hljs-bullet">   -</span> 单一职责原则
<span class="hljs-bullet">   -</span> Props类型定义的完整性
<span class="hljs-bullet">   -</span> 组件拆分的合理性

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**性能优化**</span>
<span class="hljs-bullet">   -</span> 不必要的重渲染
<span class="hljs-bullet">   -</span> useMemo/useCallback的使用
<span class="hljs-bullet">   -</span> 列表渲染的key值

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**代码质量**</span>
<span class="hljs-bullet">   -</span> TypeScript类型安全
<span class="hljs-bullet">   -</span> 错误边界处理
<span class="hljs-bullet">   -</span> 可访问性（a11y）

<span class="hljs-section">## 输出格式</span>
<span class="hljs-bullet">-</span> 问题列表（按严重程度排序）
<span class="hljs-bullet">-</span> 具体的代码建议
<span class="hljs-bullet">-</span> 优先级标注（P0/P1/P2）
</code></pre>
<p>把这个文件保存为<code>.claude/skills/react-review.md</code>，以后审查React代码时，直接<code>@skill react-review</code>就行。Claude Code会严格按照你定义的标准来审查。</p>
<h2 data-id="heading-2">为什么手写提示词撑不住了</h2>
<p>我之前也是提示词工程师，Notion里存了几十条精心打磨的提示词模板。但用了几个月后，发现这玩法有硬伤：</p>
<p><strong>重复劳动太多</strong>
每次都要从Notion复制粘贴，有时候还要根据当前项目调整几个词。一天下来光是复制粘贴提示词，就要花半小时。</p>
<p><strong>版本管理混乱</strong>
今天用的提示词和上周的不一样，效果也不稳定。想回溯"上次那个好用的版本"？抱歉，找不到了。</p>
<p><strong>团队协作是灾难</strong>
我的好提示词，同事想用？手动发微信。同事改进了？又要手动同步回来。这效率跟石器时代没区别。</p>
<p><strong>AI会遗忘</strong>
长对话里，Claude Code很容易忘记你最初的要求。聊到第20轮，你发现它又在犯之前说过不要犯的错误。</p>
<p>Skill把这些问题一次性解决了：</p>
<ul>
<li>版本化：用Git管理，回溯随便</li>
<li>可共享：团队仓库一拉，所有人同步</li>
<li>始终生效：不会因为对话太长而失效</li>
</ul>
<h2 data-id="heading-3">我的第一个Skill：API接口生成器</h2>
<p>那个电商项目里，后端给我扔了个100多个接口的Swagger文档。手动对接的话，一个接口要写：</p>
<ol>
<li>TypeScript类型定义</li>
<li>axios请求函数</li>
<li>错误处理逻辑</li>
<li>loading状态管理</li>
</ol>
<p>算了一下，100个接口差不多要30个小时。</p>
<p>我花了1个小时，写了个<code>api-generator</code>的skill：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
title: "API接口代码生成器"
description: "根据接口文档生成TS类型定义和axios封装"
<span class="hljs-section">version: "1.3.0"
---</span>

<span class="hljs-section"># API代码生成专家</span>

你是一位全栈工程师，擅长前后端接口对接。你的任务是根据API文档生成高质量的TypeScript代码。

<span class="hljs-section">## 生成内容</span>

<span class="hljs-section">### 1. TypeScript类型定义</span>
<span class="hljs-code">```typescript
// 请求参数类型
interface GetUserRequest {
  userId: string;
  includeDetails?: boolean;
}

// 响应数据类型
interface GetUserResponse {
  id: string;
  name: string;
  email: string;
  createdAt: string;
}
</span></code></pre>
<h3 data-id="heading-4">2. Axios请求函数</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getUserAPI = <span class="hljs-keyword">async</span> (
  <span class="hljs-attr">params</span>: <span class="hljs-title class_">GetUserRequest</span>
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">GetUserResponse</span>&gt; =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> request.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">GetUserResponse</span>&gt;(<span class="hljs-string">'/api/user'</span>, { params });
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户信息失败:'</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
};
</code></pre>
<h3 data-id="heading-5">3. React Hook封装（可选）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useGetUser</span> = (<span class="hljs-params">userId: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> [data, setData] = useState&lt;<span class="hljs-title class_">GetUserResponse</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserAPI</span>({ userId });
        <span class="hljs-title function_">setData</span>(result);
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-title function_">setError</span>(err <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>);
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
      }
    };
    <span class="hljs-title function_">fetchData</span>();
  }, [userId]);

  <span class="hljs-keyword">return</span> { data, loading, error };
};
</code></pre>
<h2 data-id="heading-6">代码规范</h2>
<ul>
<li>命名遵循驼峰命名法</li>
<li>API函数以<code>API</code>结尾</li>
<li>Hook函数以<code>use</code>开头</li>
<li>所有异步函数都要有错误处理</li>
<li>导出的类型和函数都要加JSDoc注释</li>
</ul>
<h2 data-id="heading-7">输出格式</h2>
<ol>
<li>先输出类型定义</li>
<li>再输出API函数</li>
<li>如果是常用接口，再生成Hook封装</li>
<li>最后给出使用示例</li>
</ol>
<pre><code class="hljs language-python" lang="python">
有了这个skill，对接一个接口从<span class="hljs-number">30</span>分钟缩短到了<span class="hljs-number">5</span>分钟。<span class="hljs-number">100</span>个接口，前后只花了两天时间就全部搞定。更关键的是，团队里的新人也能用同样的规范生成代码，整个项目的代码风格高度统一。

<span class="hljs-comment">## 高级玩法：让Skill配合起来干活</span>

用熟了之后，我发现单个skill还不够。真实的开发场景往往需要多个skill配合。

比如我重构老代码时的标准流程：

```bash
<span class="hljs-comment"># 第1步：分析代码问题</span>
<span class="hljs-meta">@skill code-analyzer src/legacy/UserService.ts</span>

<span class="hljs-comment"># 第2步：制定重构方案</span>
<span class="hljs-meta">@skill refactor-planner</span>

<span class="hljs-comment"># 第3步：生成测试用例（重构前必须有测试保底）</span>
<span class="hljs-meta">@skill test-generator</span>

<span class="hljs-comment"># 第4步：执行重构</span>
（手动重构或让Claude Code辅助）

<span class="hljs-comment"># 第5步：最终代码审查</span>
<span class="hljs-meta">@skill code-reviewer</span>
</code></pre>
<p>这四个skill依次调用，形成了完整的重构工作流。我甚至写了个shell脚本自动执行这个流程：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># refactor-workflow.sh</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🔍 步骤1/4: 分析代码问题..."</span>
claude-code @skill code-analyzer <span class="hljs-variable">$1</span>

<span class="hljs-built_in">read</span> -p <span class="hljs-string">"按回车继续..."</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"📋 步骤2/4: 制定重构方案..."</span>
claude-code @skill refactor-planner

<span class="hljs-built_in">read</span> -p <span class="hljs-string">"按回车继续..."</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🧪 步骤3/4: 生成测试用例..."</span>
claude-code @skill test-generator

<span class="hljs-built_in">read</span> -p <span class="hljs-string">"执行测试并确认通过后，按回车继续..."</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 步骤4/4: 最终代码审查..."</span>
claude-code @skill code-reviewer
</code></pre>
<p>用这个脚本重构过一个2000行的上帝类，拆成了7个职责清晰的小类。测试覆盖率从40%提升到85%，整个过程比想象中顺利很多。</p>
<h2 data-id="heading-8">团队共享：把Skill当作基础设施</h2>
<p>我们团队现在把skill当作基础设施来管理。创建了一个Git仓库专门存放team-skills：</p>
<pre><code class="hljs language-bash" lang="bash">team-skills/
├── frontend/
│   ├── react-review.md          <span class="hljs-comment"># React代码审查</span>
│   ├── vue-component-gen.md     <span class="hljs-comment"># Vue组件生成</span>
│   └── css-optimizer.md         <span class="hljs-comment"># CSS性能优化</span>
├── backend/
│   ├── api-design.md            <span class="hljs-comment"># API设计规范</span>
│   ├── database-review.md       <span class="hljs-comment"># 数据库审查</span>
│   └── security-audit.md       <span class="hljs-comment"># 安全审计</span>
└── common/
    ├── code-cleaner.md          <span class="hljs-comment"># 代码清理</span>
    ├── test-generator.md        <span class="hljs-comment"># 测试生成</span>
    └── commit-msg.md            <span class="hljs-comment"># Git提交信息生成</span>
</code></pre>
<p>每个开发者在本地项目里软链接到这个仓库：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一次性配置</span>
git <span class="hljs-built_in">clone</span> git@github.com:your-team/team-skills.git ~/.team-skills
<span class="hljs-built_in">ln</span> -s ~/.team-skills/* .claude/skills/
</code></pre>
<p>好处立竿见影：</p>
<ul>
<li><strong>新人友好</strong>：入职第一天就有完整的skill库，立刻就能按规范写代码</li>
<li><strong>自动同步</strong>：团队更新skill后，所有人git pull就能获取最新版本</li>
<li><strong>代码一致</strong>：不管谁写的代码，风格都高度统一</li>
</ul>
<p>上个月来了个实习生，第二天就能写出符合团队规范的代码。要在以前，至少得培训一周。</p>
<h2 data-id="heading-9">Skill和CLAUDE.md是黄金搭档</h2>
<p>Skill更强大的玩法，是配合项目根目录的<code>CLAUDE.md</code>一起用。</p>
<p>在CLAUDE.md里定义项目全局规则：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目上下文</span>

<span class="hljs-bullet">-</span> 技术栈：React 18 + TypeScript 5.0 + Vite 4
<span class="hljs-bullet">-</span> 代码规范：Airbnb ESLint规则
<span class="hljs-bullet">-</span> 提交规范：Conventional Commits
<span class="hljs-bullet">-</span> 状态管理：Zustand（禁止使用Redux）

<span class="hljs-section">## 重要约定</span>
<span class="hljs-bullet">-</span> 所有组件必须有完整的TypeScript类型定义
<span class="hljs-bullet">-</span> API调用统一使用 src/utils/request.ts 封装
<span class="hljs-bullet">-</span> 组件文件名使用PascalCase（如UserProfile.tsx）
<span class="hljs-bullet">-</span> 工具函数文件名使用camelCase（如formatDate.ts）

<span class="hljs-section">## 目录结构</span>
src/
├── components/    # 公共组件
├── pages/        # 页面组件
├── hooks/        # 自定义Hooks
├── utils/        # 工具函数
├── services/     # API服务
└── stores/       # Zustand状态管理
</code></pre>
<p>然后在skill里引用这些规则：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
<span class="hljs-section">title: "React组件生成器"
---</span>

<span class="hljs-section"># 组件生成指令</span>

严格按照CLAUDE.md中定义的技术栈、目录结构和命名规范生成React组件。

生成的组件必须：
<span class="hljs-bullet">-</span> 使用TypeScript
<span class="hljs-bullet">-</span> 符合项目的ESLint规则
<span class="hljs-bullet">-</span> 放在正确的目录下
<span class="hljs-bullet">-</span> 使用项目约定的状态管理方案
</code></pre>
<p>这样skill会自动读取CLAUDE.md的配置，生成的代码完全符合项目规范。新项目克隆下来，skill也能立刻适配。</p>
<h2 data-id="heading-10">我的5个必备Skill</h2>
<p>用了半年，我的skills目录里积累了20多个skill。挑几个最常用的分享一下：</p>
<h3 data-id="heading-11">1. 测试用例生成器（test-gen.md）</h3>
<p>写完功能代码后最烦的就是补测试。这个skill能分析函数逻辑，自动生成单元测试，包括边界情况和异常场景。</p>
<p>效果：我的测试覆盖率从40%提升到85%，节省了至少一半的测试编写时间。</p>
<h3 data-id="heading-12">2. Git提交信息生成器（commit-msg.md）</h3>
<p>每次提交都要想commit message，挺浪费脑细胞的。这个skill分析git diff内容，自动生成符合Conventional Commits规范的提交信息。</p>
<p>示例输出：</p>
<pre><code class="hljs language-diff" lang="diff">feat(user-auth): 添加OAuth2.0登录功能

<span class="hljs-deletion">- 集成Google和GitHub第三方登录</span>
<span class="hljs-deletion">- 添加JWT token刷新机制</span>
<span class="hljs-deletion">- 完善用户权限校验中间件</span>

Closes #123
</code></pre>
<p>虽然只有30行代码，但这是我每天都要用的skill。累计节省的时间已经好几个小时了。</p>
<h3 data-id="heading-13">3. 代码重构助手（refactor.md）</h3>
<p>老代码需要优化但不知从何下手时，这个skill能：</p>
<ul>
<li>识别代码坏味道</li>
<li>给出重构优先级排序</li>
<li>提供step-by-step重构计划</li>
<li>保证重构前后功能一致</li>
</ul>
<p>那个2000行的上帝类就是靠这个skill搞定的。</p>
<h3 data-id="heading-14">4. 安全审查专家（security-audit.md）</h3>
<p>专门检查代码安全问题：</p>
<ul>
<li>SQL注入风险</li>
<li>XSS攻击防护</li>
<li>敏感信息泄露</li>
<li>权限校验完整性</li>
</ul>
<p>有次准备上线前用这个skill扫了一遍，发现3个潜在的安全漏洞，吓出一身冷汗。</p>
<h3 data-id="heading-15">5. 文档生成器（doc-gen.md）</h3>
<p>项目文档总是滞后于代码？这个skill能根据代码自动生成API文档，提取函数注释生成Markdown，还能维护更新日志。</p>
<p>文档更新时间从2小时缩短到10分钟，而且再也不会出现"代码改了文档没改"的情况。</p>
<h2 data-id="heading-16">写好Skill的5个技巧</h2>
<p>半年下来，我总结了几个编写skill的经验：</p>
<h3 data-id="heading-17">1. Frontmatter要认真写</h3>
<p>虽然看起来可有可无，但title和description会显示在skill列表里：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
title: "全栈代码审查专家"
description: "审查前后端代码，关注安全性、性能和可维护性"
version: "2.1.0"
<span class="hljs-section">tags: ["代码审查", "安全", "性能"]
---</span>
</code></pre>
<p>version字段方便版本管理，tags方便分类查找。</p>
<h3 data-id="heading-18">2. 角色定义要清晰</h3>
<p>"你是一位...专家"这种开头很有用，能让Claude Code快速进入角色：</p>
<pre><code class="hljs language-markdown" lang="markdown">你是一位拥有10年经验的全栈工程师，擅长代码审查和安全审计。
</code></pre>
<p>比直接说"请审查代码"效果好很多。</p>
<h3 data-id="heading-19">3. 用对比示例说明</h3>
<p>用✅和❌对比好坏代码，Claude Code理解起来更准确：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">### SQL注入风险</span>

❌ 危险写法：
<span class="hljs-code">```javascript
const query = `SELECT * FROM users WHERE id = ${userId}`;
</span></code></pre>
<p>✅ 安全写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> query = <span class="hljs-string">'SELECT * FROM users WHERE id = ?'</span>;
db.<span class="hljs-title function_">query</span>(query, [userId]);
</code></pre>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 4. 输出格式要具体</span></span>

别说"请给出建议"，要说"按以下格式输出"：

```markdown
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 输出格式</span></span>
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 🔴 严重问题（必须修复）</span></span>
- [文件名:行号] 问题描述
- 风险说明
- 修复建议（附代码示例）
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 🟡 建议改进（推荐优化）</span></span>
- [文件名:行号] 问题描述
- 改进理由
- 优化方案
</code></pre>
<h3 data-id="heading-20">5. 加上错误处理规则</h3>
<p>告诉AI遇到问题怎么办：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 错误处理</span>

如果遇到以下情况：
<span class="hljs-bullet">-</span> 代码语法错误：先指出错误位置，不继续审查
<span class="hljs-bullet">-</span> 文件无法访问：提示用户检查路径
<span class="hljs-bullet">-</span> 代码量过大（&gt;5000行）：建议分批审查
</code></pre>
<h2 data-id="heading-21">常见问题</h2>
<h3 data-id="heading-22">Skill太多记不住名字？</h3>
<p>用好命名规范：</p>
<ul>
<li><code>review-*</code>: 代码审查类</li>
<li><code>gen-*</code>: 代码生成类</li>
<li><code>util-*</code>: 工具类</li>
<li><code>fix-*</code>: 问题修复类</li>
</ul>
<p>我的命名：<code>review-frontend.md</code>、<code>gen-api.md</code>、<code>util-commit.md</code></p>
<h3 data-id="heading-23">Skill输出太长看不完？</h3>
<p>在skill里加上简洁模式：</p>
<pre><code class="hljs language-markdown" lang="markdown">默认使用详细模式。如果用户添加<span class="hljs-code">`--brief`</span>参数，输出简洁版：
<span class="hljs-bullet">-</span> 问题清单（一行一个）
<span class="hljs-bullet">-</span> 严重程度标注
<span class="hljs-bullet">-</span> 关键修复建议
</code></pre>
<h3 data-id="heading-24">Skill在不同项目中表现不一致？</h3>
<p>让skill主动请求上下文：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 分析前置步骤</span>

开始前请先：
<span class="hljs-bullet">1.</span> 读取package.json了解依赖版本
<span class="hljs-bullet">2.</span> 检查tsconfig.json了解TS配置
<span class="hljs-bullet">3.</span> 查看.eslintrc了解代码规范
<span class="hljs-bullet">4.</span> 浏览README.md了解项目架构
</code></pre>
<h2 data-id="heading-25">最后说两句</h2>
<p>用了半年的skill功能，我的开发效率至少提升了40%。更重要的是，很多重复性的脑力劳动被解放出来了，我可以把时间花在真正需要思考的架构设计和业务逻辑上。</p>
<p>如果你现在还在手写提示词，建议你：</p>
<ol>
<li><strong>今天就开始</strong>：从一个简单的skill开始，比如代码审查或测试生成</li>
<li><strong>逐步完善</strong>：每次用完后反思哪里可以改进，更新版本</li>
<li><strong>团队共享</strong>：好的skill就像好的工具库，要分享出去</li>
<li><strong>持续学习</strong>：关注官方文档更新，新功能可能会改变写法</li>
</ol>
<p>最后分享一个心得：<strong>Skill的价值不在于有多复杂，而在于解决真实问题</strong>。我那个最简单的commit-msg生成器只有30行，但每天都在用，累计节省的时间已经好几个小时了。</p>
<p>从现在开始，试着把你每天重复输入的提示词整理成skill吧。三个月后，你会感谢今天的自己。</p>
<p><strong>相关资源</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs" target="_blank" title="https://code.claude.com/docs" ref="nofollow noopener noreferrer">Claude Code官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.claude.com%2Fen%2Fdocs%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://docs.claude.com/en/docs/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">Skill最佳实践指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">社区Skill模板库</a></li>
</ul>
<blockquote>
<p>本文首发自<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.betterlink.top%2Fzh%2F" target="_blank" title="https://blog.betterlink.top/zh/" ref="nofollow noopener noreferrer">个人博客</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go-kratos-admin 技术栈深度解析：为什么选 Golang+Vue3 这套组合？]]></title>    <link>https://juejin.cn/post/7577228831137890347</link>    <guid>https://juejin.cn/post/7577228831137890347</guid>    <pubDate>2025-11-27T11:57:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577228831137890347" data-draft-id="7577215663968354346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go-kratos-admin 技术栈深度解析：为什么选 Golang+Vue3 这套组合？"/> <meta itemprop="keywords" content="Go,Vue.js"/> <meta itemprop="datePublished" content="2025-11-27T11:57:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go-kratos-admin 技术栈深度解析：为什么选 Golang+Vue3 这套组合？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:57:12.000Z" title="Thu Nov 27 2025 11:57:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">go-kratos-admin 技术栈深度解析：为什么选 Golang+Vue3 这套组合？</h2>
<p>企业级 Admin 系统的技术选型，既要兼顾<strong>高性能</strong>与<strong>稳定性</strong>，也要平衡<strong>开发效率</strong>与<strong>可扩展性</strong>。go-kratos-admin 作为开箱即用的全栈 Admin 解决方案，最终选定 <strong>Golang 生态（后端）</strong> + <strong>Vue3 生态（前端）</strong> 的技术组合，并非偶然 —— 而是精准匹配企业级管理系统核心需求的必然选择。本文将深度拆解这套技术栈的选型逻辑，以及它如何为项目赋能。</p>
<h3 data-id="heading-1">一、后端技术栈：Golang 生态的 “精准狙击”</h3>
<p>后端是 Admin 系统的 “骨架”，需要支撑权限控制、多租户隔离、高并发请求等核心场景。go-kratos-admin 选择以 Golang 为基础，搭配 go-kratos、ent、gorm、wire、casbin 等组件，正是瞄准了企业级系统的痛点。</p>
<h4 data-id="heading-2">1. 核心语言：为什么是 Golang 而非 Java/Node.js？</h4>
<p>企业级 Admin 系统看似 “业务逻辑为主”，实则对<strong>性能</strong>和<strong>资源占用</strong>有隐性高要求：比如批量数据导出、高频权限校验、分布式缓存操作等场景，都需要后端快速响应。</p>
<ul>
<li><strong>Golang 的天然优势</strong>：编译型语言带来的高性能（比 Node.js 快数倍）、goroutine 轻量级并发模型（轻松应对上万并发请求）、极低的内存占用（部署服务器成本更低）；</li>
<li><strong>对比 Java</strong>：Golang 代码更简洁（少 “样板代码”），编译速度快，部署无需 JVM，运维更轻量化；</li>
<li><strong>对比 Node.js</strong>：Golang 无 “回调地狱”，同步代码编写更符合后端开发习惯，且在 CPU 密集型场景（如数据计算）中优势显著。</li>
</ul>
<p>对 go-kratos-admin 而言，Golang 既能支撑单体架构的快速开发，也能平滑扩展到微服务架构 —— 这恰好匹配了项目 “适配不同规模团队” 的定位。</p>
<h4 data-id="heading-3">2. 框架选型：go-kratos 为何成为首选？</h4>
<p>后端框架是技术栈的 “核心枢纽”，go-kratos-admin 选择字节跳动开源的 go-kratos，而非 Gin/Echo 等轻量框架，核心原因在于：</p>
<ul>
<li><strong>企业级特性内置</strong>：kratos 原生支持服务发现、配置中心、链路追踪、限流熔断等微服务能力，无需开发者重复集成；</li>
<li><strong>标准化设计</strong>：遵循 RESTful + gRPC 双协议规范，前后端交互更清晰，同时支持协议自动转换（比如前端 HTTP 请求转后端 gRPC 调用）；</li>
<li><strong>生态适配性</strong>：与 wire（依赖注入）、ent（ORM）等 Golang 生态组件无缝协作，降低技术栈整合成本。</li>
</ul>
<p>对 Admin 系统来说，kratos 的 “微服务基因” 让项目能从一开始就预留扩展空间 —— 比如后续拆分 “权限服务”“租户服务” 时，无需重构底层框架。</p>
<h4 data-id="heading-4">3. 数据层：ent 与 gorm 的 “按需替换” 方案</h4>
<p>数据操作是 Admin 系统的核心场景（如多租户数据隔离、复杂条件查询、简单 CRUD 操作），项目并未采用 “主辅结合” 的固定模式，而是设计了<strong>可灵活替换的 ORM 方案</strong>—— 开发者可根据具体业务需求，在 ent 和 gorm 之间自主选择适配工具，无需修改底层架构。</p>
<ul>
<li><strong>ent 的适用场景与优势</strong>：更适合业务逻辑复杂、关联查询密集的场景。作为基于代码生成的强类型 ORM，它原生支持 GraphQL 协议，能高效处理多表深度关联查询（例如 “用户 - 角色 - 租户 - 部门” 的四级关联数据拉取），且编译期类型校验可减少数据操作错误，查询性能也优于传统反射型 ORM。当项目需要构建精细化的数据权限逻辑（如 “按租户 + 部门 + 角色三重过滤数据”）时，ent 的链式查询语法能让条件拼接更清晰、可维护性更强。</li>
<li><strong>gorm 的适用场景与优势</strong>：更适合简单 CRUD 操作、多数据库兼容需求明确的场景。它对基础增删改查接口封装更简洁，开发者无需学习新的语法即可快速上手；同时兼容 MySQL、PostgreSQL、TiDB、SQL Server 等国内外主流数据库，当项目需要适配不同客户的数据库环境（如国内企业常用的 MySQL、海外客户偏好的 PostgreSQL）时，gorm 的数据库驱动生态能降低适配成本。</li>
</ul>
<p>这种 “可替换” 设计的核心价值在于<strong>平衡开发效率与业务复杂度</strong>：例如项目初期搭建 “租户基础信息管理” 模块时，可选用 gorm 快速实现租户创建、查询、禁用等简单操作；当业务扩展到 “租户 - 用户 - 权限的关联统计分析” 时，可无缝切换为 ent 处理复杂查询逻辑 —— 两者共享统一的数据模型定义，无需重构核心代码，既满足不同阶段的需求，又避免了单一 ORM 工具的局限性。</p>
<h4 data-id="heading-5">4. 工程化：wire 依赖注入的 “解耦价值”</h4>
<p>Admin 系统功能越复杂，模块间的依赖关系越容易混乱。go-kratos-admin 引入 wire 实现依赖注入：</p>
<ul>
<li><strong>代码解耦</strong>：将 “对象创建” 与 “业务逻辑” 分离，比如权限校验模块无需关心数据库连接的创建方式；</li>
<li><strong>可测试性提升</strong>：单元测试时可快速替换依赖（如用 mock 数据库替代真实数据库）；</li>
<li><strong>扩展性增强</strong>：新增功能模块时，无需修改原有代码，只需配置依赖关系即可。</li>
</ul>
<p>对团队协作而言，wire 让代码结构更清晰，新人上手成本更低。</p>
<h3 data-id="heading-6">二、前端技术栈：Vue3 生态的 “高效适配”</h3>
<p>前端是 Admin 系统的 “门面”，需要兼顾<strong>交互体验</strong>与<strong>开发效率</strong>。go-kratos-admin 选择 Vue3 + TypeScript + Antdv + Vben Admin 的组合，正是为了匹配企业级管理系统的 UI/UX 需求。</p>
<h4 data-id="heading-7">1. 核心框架：Vue3 为何优于 Vue2/React？</h4>
<p>Admin 系统以表单、表格、弹窗等 “组件化场景” 为主，Vue3 的特性完美适配这类需求：</p>
<ul>
<li><strong>组合式 API（Composition API）</strong>：复杂组件（如多条件查询表单）的逻辑可拆分复用，比 Vue2 的 Options API 更易维护；</li>
<li><strong>性能提升</strong>：Vue3 的响应式系统基于 Proxy 重构，减少不必要的渲染开销，表格滚动、大数据渲染更流畅；</li>
<li><strong>TypeScript 友好</strong>：原生支持 TS，类型提示能大幅降低前端开发的 Bug 率（比如权限按钮的显隐逻辑）。</li>
</ul>
<p>对比 React，Vue3 的 “渐进式框架” 特性更适合 Admin 系统：开发者无需全盘接受 React 的函数式理念，可按需引入功能，学习成本更低。</p>
<h4 data-id="heading-8">2. UI 组件库：Antdv + Vben Admin 的 “企业级适配”</h4>
<p>Admin 系统需要大量成熟的 UI 组件（如高级表格、权限树、多租户表单），重复造轮子会严重拖慢开发进度：</p>
<ul>
<li><strong>Antdv（Ant Design Vue）</strong>：阿里开源的企业级组件库，覆盖 Admin 系统所需的 90% 组件（如 Table、Form、Modal、Tree），设计风格符合企业审美；</li>
<li><strong>Vben Admin</strong>：基于 Vue3 + Antdv 的开箱即用 Admin 模板，内置了权限路由、主题定制、国际化等功能，go-kratos-admin 直接复用其基础架构，避免从零搭建前端框架。</li>
</ul>
<p>这种组合让前端开发聚焦于 “业务逻辑” 而非 “基础组件开发”—— 比如实现 “多租户列表的高级搜索 + 批量操作”，只需基于 Vben Admin 的表格组件二次封装即可。</p>
<h4 data-id="heading-9">3. 类型安全：TypeScript 的 “保驾护航”</h4>
<p>Admin 系统涉及大量权限、数据格式的校验，TypeScript 的引入解决了前端的 “类型混乱” 问题：</p>
<ul>
<li><strong>接口类型约束</strong>：前后端接口通过 TS 定义类型，避免因参数格式错误导致的 Bug；</li>
<li><strong>组件 props 校验</strong>：权限按钮、租户表单等组件的 props 类型明确，团队协作时更易理解；</li>
<li><strong>重构安全性</strong>：修改权限逻辑时，TS 会自动提示类型错误，降低重构风险。</li>
</ul>
<p>对企业级项目而言，TypeScript 带来的 “可维护性提升” 远大于短期的开发成本增加。</p>
<h3 data-id="heading-10">三、Golang+Vue3 组合：企业级 Admin 系统的 “最优解”</h3>
<p>后端 Golang 生态的 “高性能 + 可扩展”，与前端 Vue3 生态的 “高效开发 + 企业级组件” 形成互补，恰好命中 Admin 系统的核心需求：</p>
<h4 data-id="heading-11">1. 性能与体验的平衡</h4>
<ul>
<li>后端 Golang 处理高并发请求（如批量数据导出、高频权限校验）时，响应速度比传统 Node.js 后端快 3-5 倍；</li>
<li>前端 Vue3 的轻量化渲染，让表格滚动、弹窗切换等交互更流畅，用户体验优于 Vue2 或 React 旧版项目。</li>
</ul>
<h4 data-id="heading-12">2. 开发效率与扩展性的平衡</h4>
<ul>
<li>后端 go-kratos + ent 的代码生成能力，前端 Vben Admin 的模板复用，让项目能快速搭建核心功能（如多租户管理、权限体系）；</li>
<li>微服务架构（kratos）+ 组件化开发（Vue3），让项目能随企业规模增长平滑扩展 —— 比如从单体架构拆分为 “权限服务 + 租户服务 + 业务服务”。</li>
</ul>
<h4 data-id="heading-13">3. 企业级需求的精准匹配</h4>
<ul>
<li>多租户隔离：Golang 的 goroutine 并发处理租户请求，Vue3 的组件化渲染租户专属界面；</li>
<li>权限控制：后端 kratos 的中间件校验接口权限，前端 Vben Admin 的路由守卫控制页面访问；</li>
<li>跨平台部署：Golang 编译后的二进制文件无需依赖运行时，Vue3 打包后的静态资源可部署在任意服务器，适配企业的私有化部署需求。</li>
</ul>
<h3 data-id="heading-14">四、总结：技术栈选型的底层逻辑</h3>
<p>go-kratos-admin 选择 Golang+Vue3 组合，本质是 <strong>“需求驱动选型”</strong>：</p>
<ul>
<li>企业级 Admin 系统需要 “高性能、易扩展、低成本维护”，Golang 生态完美满足后端需求；</li>
<li>前端需要 “高效开发、组件丰富、交互流畅”，Vue3 生态恰好适配这些场景。</li>
</ul>
<p>这套技术栈既不是 “追新”，也不是 “保守”—— 而是在 “满足需求” 与 “技术成熟度” 之间找到的最佳平衡点。对开发者而言，基于这套技术栈构建 Admin 系统，既能快速落地业务，又能为未来的扩展预留空间；对企业而言，这套组合的运维成本低、稳定性高，是支撑长期发展的可靠选择。</p>
<p>如果你正在搭建企业级 Admin 系统，go-kratos-admin 的技术栈选型思路，或许能为你提供一份有价值的参考。</p>
<h3 data-id="heading-15">项目代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-kratos-admin" target="_blank" title="https://gitee.com/tx7do/go-kratos-admin" ref="nofollow noopener noreferrer">kratos-admin Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-kratos-admin" target="_blank" title="https://github.com/tx7do/go-kratos-admin" ref="nofollow noopener noreferrer">kratos-admin Github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一种新HTML页面转换成 PDF 技术方案]]></title>    <link>https://juejin.cn/post/7576608733612425242</link>    <guid>https://juejin.cn/post/7576608733612425242</guid>    <pubDate>2025-11-26T07:15:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576608733612425242" data-draft-id="7576236480114475058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一种新HTML页面转换成 PDF 技术方案"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-26T07:15:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="至简简"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286819384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一种新HTML页面转换成 PDF 技术方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286819384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    至简简
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T07:15:49.000Z" title="Wed Nov 26 2025 07:15:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    115
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<blockquote>
<p>本文将深入讲解如何使用 snapdom 和 jsPDF 实现高质量的 HTML 转 PDF 功能，并通过一个完整的消息列表导出案例，带你掌握这套方案的核心技术。</p>
</blockquote>
<h3 data-id="heading-1">为什么 HTML 转 PDF 如此重要？</h3>
<p>在现代 Web 应用中，<strong>HTML 转 PDF</strong> 是一个非常常见的需求场景：</p>
<ol>
<li><strong>客服系统</strong>：导出聊天记录用于存档或投诉处理</li>
<li><strong>电商平台</strong>：生成订单详情、发票等 PDF 文档</li>
<li><strong>报表系统</strong>：将可视化图表和数据导出为 PDF 报告</li>
<li><strong>在线文档</strong>：支持用户将网页内容离线保存</li>
<li><strong>合同签署</strong>：生成合同 PDF 用于电子签名</li>
</ol>
<p>然而，实现一个<strong>高质量</strong>的 HTML 转 PDF 功能并不简单。我们面临以下挑战：</p>





























<table><thead><tr><th>挑战</th><th>描述</th></tr></thead><tbody><tr><td><strong>样式还原</strong></td><td>CSS 样式、字体、渐变等能否完美呈现？</td></tr><tr><td><strong>分页处理</strong></td><td>长内容如何智能分页，避免内容被截断？</td></tr><tr><td><strong>清晰度</strong></td><td>导出的 PDF 是否足够清晰，尤其在打印时？</td></tr><tr><td><strong>性能</strong></td><td>大量内容（如 1000 条消息）能否快速导出？</td></tr><tr><td><strong>兼容性</strong></td><td>不同浏览器表现是否一致？</td></tr></tbody></table>
<p>传统的 <code>html2canvas</code> + <code>jsPDF</code> 方案虽然能用，但在<strong>样式还原度</strong>和<strong>截图质量</strong>上存在明显不足。</p>
<p>今天笔者介绍一套新解决方案：<strong>snapdom + jsPDF</strong>。</p>
<h2 data-id="heading-2">snapdom 和 jsPDF 基础理论知识</h2>
<h3 data-id="heading-3">snapdom 是什么？</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzumerlab%2Fsnapdom" target="_blank" title="https://github.com/zumerlab/snapdom" ref="nofollow noopener noreferrer">SnapDOM</a> 是一个现代化的 DOM 截图库，它的核心特点是：</p>
<pre><code class="hljs language-css" lang="css">DOM Element → <span class="hljs-selector-tag">Canvas</span>/PNG/SVG
</code></pre>
<h4 data-id="heading-4">核心优势</h4>
<ol>
<li><strong>高保真截图</strong>：完美还原 CSS 样式，包括 flexbox、grid、渐变、阴影等</li>
<li><strong>多种输出格式</strong>：支持 Canvas、PNG、SVG 等多种格式</li>
<li><strong>高清缩放</strong>：通过 <code>scale</code> 参数实现 2x/3x 高清截图</li>
<li><strong>体积小巧</strong>：压缩后仅 ~20KB</li>
</ol>
<h4 data-id="heading-5">基础用法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { snapdom } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zumer/snapdom'</span>;

<span class="hljs-comment">// 获取 DOM 元素</span>
<span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.my-element'</span>);

<span class="hljs-comment">// 截图</span>
<span class="hljs-keyword">const</span> capture = <span class="hljs-keyword">await</span> <span class="hljs-title function_">snapdom</span>(element, {
  <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,      <span class="hljs-comment">// 2倍清晰度</span>
  <span class="hljs-attr">quality</span>: <span class="hljs-number">0.95</span>  <span class="hljs-comment">// PNG 质量</span>
});

<span class="hljs-comment">// 输出方式</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toCanvas</span>();  <span class="hljs-comment">// Canvas 元素</span>
<span class="hljs-keyword">const</span> imgEl = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toPng</span>();      <span class="hljs-comment">// &lt;img&gt; 元素，src 为 data URL</span>
<span class="hljs-keyword">const</span> svgStr = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toSvg</span>();     <span class="hljs-comment">// SVG 字符串</span>
</code></pre>
<h4 data-id="heading-6">关键参数说明</h4>























<table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>scale</code></td><td>number</td><td>1</td><td>缩放倍数，2 表示 2 倍清晰度</td></tr><tr><td><code>quality</code></td><td>number</td><td>0.92</td><td>图片质量，范围 0-1</td></tr></tbody></table>
<p>更多详细内容请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fsnapdom.dev%2F%25E5%25AE%2598%25E6%2596%25B9%25E6%2596%2587%25E6%25A1%25A3" target="_blank" title="https://snapdom.dev/%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3" ref="nofollow noopener noreferrer">snapdom.dev/官方文档</a></p>
<h3 data-id="heading-7">jsPDF 是什么？</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparallax%2FjsPDF" target="_blank" title="https://github.com/parallax/jsPDF" ref="nofollow noopener noreferrer">jsPDF</a> 是最流行的 JavaScript PDF 生成库，支持在浏览器端直接创建 PDF 文件。</p>
<h4 data-id="heading-8">核心特点</h4>
<ol>
<li><strong>纯前端方案</strong>：无需服务端，浏览器直接生成</li>
<li><strong>功能丰富</strong>：支持文本、图片、表格、链接等</li>
<li><strong>多种尺寸</strong>：A4、Letter 等标准纸张格式</li>
<li><strong>插件生态</strong>：支持 AutoTable 等扩展插件</li>
</ol>
<h4 data-id="heading-9">基础用法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { jsPDF } <span class="hljs-keyword">from</span> <span class="hljs-string">'jspdf'</span>;

<span class="hljs-comment">// 创建 PDF 实例</span>
<span class="hljs-keyword">const</span> pdf = <span class="hljs-keyword">new</span> <span class="hljs-title function_">jsPDF</span>({
  <span class="hljs-attr">orientation</span>: <span class="hljs-string">'portrait'</span>,  <span class="hljs-comment">// 纵向</span>
  <span class="hljs-attr">unit</span>: <span class="hljs-string">'mm'</span>,               <span class="hljs-comment">// 单位：毫米</span>
  <span class="hljs-attr">format</span>: <span class="hljs-string">'a4'</span>,             <span class="hljs-comment">// A4 纸张</span>
  <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>            <span class="hljs-comment">// 启用压缩</span>
});

<span class="hljs-comment">// 添加图片</span>
pdf.<span class="hljs-title function_">addImage</span>(
  imageDataUrl,  <span class="hljs-comment">// Base64 图片数据</span>
  <span class="hljs-string">'PNG'</span>,         <span class="hljs-comment">// 图片格式</span>
  <span class="hljs-number">10</span>,            <span class="hljs-comment">// X 坐标（mm）</span>
  <span class="hljs-number">10</span>,            <span class="hljs-comment">// Y 坐标（mm）</span>
  <span class="hljs-number">190</span>,           <span class="hljs-comment">// 宽度（mm）</span>
  <span class="hljs-number">100</span>            <span class="hljs-comment">// 高度（mm）</span>
);

<span class="hljs-comment">// 添加新页面</span>
pdf.<span class="hljs-title function_">addPage</span>();

<span class="hljs-comment">// 保存文件</span>
pdf.<span class="hljs-title function_">save</span>(<span class="hljs-string">'output.pdf'</span>);
</code></pre>
<h4 data-id="heading-10">A4 尺寸常量</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// A4 标准尺寸（单位：mm）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">A4_WIDTH_MM</span> = <span class="hljs-number">210</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">A4_HEIGHT_MM</span> = <span class="hljs-number">297</span>;

<span class="hljs-comment">// 页面边距</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MARGIN_MM</span> = <span class="hljs-number">10</span>;

<span class="hljs-comment">// 可用内容区域</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONTENT_WIDTH_MM</span> = <span class="hljs-number">190</span>;   <span class="hljs-comment">// 210 - 10*2</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONTENT_HEIGHT_MM</span> = <span class="hljs-number">277</span>;  <span class="hljs-comment">// 297 - 10*2</span>
</code></pre>
<h3 data-id="heading-11">snapdom + jsPDF 组合的优势</h3>
<h2 data-id="heading-12"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6dfc5710dc44cb683e902ccef1c5c5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818465&amp;x-signature=BWGSg2sI1NPQ%2FnYMd6a7vmPLta0%3D" alt="image.png" loading="lazy"/></h2>
<h2 data-id="heading-13">案例讲述</h2>
<p>笔者写一个IM产品中 MessageList 消息导出DEMO。接下来，我们通过一个完整的<strong>客服消息列表导出</strong>案例，讲解如何使用 snapdom + jsPDF 实现 HTML 转 PDF。</p>
<h3 data-id="heading-14">项目结构</h3>
<pre><code class="hljs language-bash" lang="bash">src/
├── components/
│   ├── MessageList.tsx      <span class="hljs-comment"># 消息列表组件</span>
│   └── MessageList.css      <span class="hljs-comment"># 消息列表样式</span>
├── services/
│   └── messageExportService.ts  <span class="hljs-comment"># PDF 导出服务（核心）</span>
└── App.tsx
</code></pre>
<h3 data-id="heading-15">核心流程</h3>
<p>整个导出过程分为 <strong>4 个步骤</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23cb91cd191a4466b508c3f7776510fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818465&amp;x-signature=LAFXGjzfD5n437Fjlx5sc5FY44g%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16">Step 1：DOM 截图（snapdom）</h3>
<p>第一步，使用 snapdom 将整个消息列表 DOM 转换为高清 PNG 图片。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// messageExportService.ts</span>

<span class="hljs-keyword">import</span> { snapdom } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zumer/snapdom'</span>;

<span class="hljs-comment">// 图片质量配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">IMAGE_QUALITY</span> = <span class="hljs-number">0.95</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">IMAGE_FORMAT</span> = <span class="hljs-string">'image/png'</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-comment">/**
 * 将 DOM 元素转换为图片
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureElementToImage</span>(<span class="hljs-params">
  element: HTMLElement,
  quality: <span class="hljs-built_in">number</span> = IMAGE_QUALITY
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始截图...'</span>);

  <span class="hljs-comment">// 保存原始样式</span>
  <span class="hljs-keyword">const</span> originalOverflow = element.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span>;
  <span class="hljs-keyword">const</span> originalHeight = element.<span class="hljs-property">style</span>.<span class="hljs-property">height</span>;
  <span class="hljs-keyword">const</span> originalMaxHeight = element.<span class="hljs-property">style</span>.<span class="hljs-property">maxHeight</span>;

  <span class="hljs-comment">// 临时设置样式，确保完整截图</span>
  element.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = <span class="hljs-string">'visible'</span>;
  element.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">'auto'</span>;
  element.<span class="hljs-property">style</span>.<span class="hljs-property">maxHeight</span> = <span class="hljs-string">'none'</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 核心：使用 snapdom 进行截图</span>
    <span class="hljs-keyword">const</span> capture = <span class="hljs-keyword">await</span> <span class="hljs-title function_">snapdom</span>(element, {
      <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,        <span class="hljs-comment">// 2倍清晰度</span>
      <span class="hljs-attr">quality</span>: quality
    });

    <span class="hljs-comment">// 优先使用 toPng()</span>
    <span class="hljs-keyword">const</span> imgElement = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toPng</span>();
    <span class="hljs-keyword">const</span> dataUrl = imgElement.<span class="hljs-property">src</span>;

    <span class="hljs-comment">// 验证数据有效性</span>
    <span class="hljs-keyword">if</span> (!dataUrl || dataUrl.<span class="hljs-property">length</span> &lt; <span class="hljs-number">100</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'toPng 返回无效，尝试 toCanvas...'</span>);
      <span class="hljs-keyword">const</span> canvas = <span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toCanvas</span>();
      <span class="hljs-keyword">return</span> canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-variable constant_">IMAGE_FORMAT</span>, quality);
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'截图成功，大小:'</span>, (dataUrl.<span class="hljs-property">length</span> / <span class="hljs-number">1024</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>), <span class="hljs-string">'KB'</span>);
    <span class="hljs-keyword">return</span> dataUrl;

  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 恢复原始样式</span>
    element.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = originalOverflow;
    element.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = originalHeight;
    element.<span class="hljs-property">style</span>.<span class="hljs-property">maxHeight</span> = originalMaxHeight;
  }
}
</code></pre>
<p><strong>关键点解析</strong>：</p>
<ol>
<li><strong>临时修改样式</strong>：将 <code>overflow</code>、<code>height</code>、<code>maxHeight</code> 临时设置为可见状态，确保截取完整内容</li>
<li><strong>scale: 2</strong>：2 倍缩放提高清晰度，打印时效果更佳</li>
<li><strong>降级处理</strong>：<code>toPng()</code> 失败时自动回退到 <code>toCanvas()</code></li>
<li><strong>样式恢复</strong>：截图完成后恢复原始样式</li>
</ol>
<h3 data-id="heading-17">Step 2：图片分页（Canvas）</h3>
<p>长图片需要按照 A4 页面高度进行分割，这是最复杂的一步。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 尺寸常量</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">A4_WIDTH_MM</span> = <span class="hljs-number">210</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">A4_HEIGHT_MM</span> = <span class="hljs-number">297</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PDF_MARGIN_MM</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PDF_CONTENT_WIDTH_MM</span> = <span class="hljs-variable constant_">A4_WIDTH_MM</span> - <span class="hljs-variable constant_">PDF_MARGIN_MM</span> * <span class="hljs-number">2</span>;   <span class="hljs-comment">// 190mm</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PDF_CONTENT_HEIGHT_MM</span> = <span class="hljs-variable constant_">A4_HEIGHT_MM</span> - <span class="hljs-variable constant_">PDF_MARGIN_MM</span> * <span class="hljs-number">2</span>; <span class="hljs-comment">// 277mm</span>

<span class="hljs-comment">// 1mm = 3.7795275590551 像素（96 DPI）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MM_TO_PX</span> = <span class="hljs-number">3.7795275590551</span>;

<span class="hljs-comment">// 分页后的图片数据</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">PageImageData</span> {
  <span class="hljs-attr">dataUrl</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">/**
 * 将长图片分割成多个 A4 页面
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">splitImageIntoPages</span>(<span class="hljs-params">
  imageDataUrl: <span class="hljs-built_in">string</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">PageImageData</span>[]&gt; {

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    img.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">'anonymous'</span>;

    img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">pages</span>: <span class="hljs-title class_">PageImageData</span>[] = [];
      <span class="hljs-keyword">const</span> originalWidth = img.<span class="hljs-property">width</span>;
      <span class="hljs-keyword">const</span> originalHeight = img.<span class="hljs-property">height</span>;

      <span class="hljs-comment">// 将 A4 内容区域转换为像素（考虑 scale=2）</span>
      <span class="hljs-keyword">const</span> pageContentHeightPx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(
        <span class="hljs-variable constant_">PDF_CONTENT_HEIGHT_MM</span> * <span class="hljs-variable constant_">MM_TO_PX</span> * <span class="hljs-number">2</span>  <span class="hljs-comment">// scale=2</span>
      );
      <span class="hljs-keyword">const</span> pageContentWidthPx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(
        <span class="hljs-variable constant_">PDF_CONTENT_WIDTH_MM</span> * <span class="hljs-variable constant_">MM_TO_PX</span> * <span class="hljs-number">2</span>
      );

      <span class="hljs-comment">// 计算缩放比例（图片宽度适配页面宽度）</span>
      <span class="hljs-keyword">const</span> widthScale = pageContentWidthPx / originalWidth;
      <span class="hljs-keyword">const</span> scaledHeight = originalHeight * widthScale;

      <span class="hljs-comment">// 计算总页数</span>
      <span class="hljs-keyword">const</span> totalPages = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(scaledHeight / pageContentHeightPx);

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`原始尺寸: <span class="hljs-subst">${originalWidth}</span>x<span class="hljs-subst">${originalHeight}</span>px`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`缩放后高度: <span class="hljs-subst">${scaledHeight}</span>px, 总页数: <span class="hljs-subst">${totalPages}</span>`</span>);

      <span class="hljs-comment">// 逐页裁剪</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> pageIndex = <span class="hljs-number">0</span>; pageIndex &lt; totalPages; pageIndex++) {
        <span class="hljs-keyword">const</span> startY = pageIndex * pageContentHeightPx;
        <span class="hljs-keyword">const</span> endY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(startY + pageContentHeightPx, scaledHeight);
        <span class="hljs-keyword">const</span> currentPageHeight = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(endY - startY);

        <span class="hljs-comment">// 计算源图片对应的区域</span>
        <span class="hljs-keyword">const</span> sourceStartY = startY / widthScale;
        <span class="hljs-keyword">const</span> sourceHeight = currentPageHeight / widthScale;

        <span class="hljs-comment">// 创建新 Canvas</span>
        <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;

        canvas.<span class="hljs-property">width</span> = pageContentWidthPx;
        canvas.<span class="hljs-property">height</span> = currentPageHeight;

        <span class="hljs-comment">// 高质量渲染</span>
        ctx.<span class="hljs-property">imageSmoothingEnabled</span> = <span class="hljs-literal">true</span>;
        ctx.<span class="hljs-property">imageSmoothingQuality</span> = <span class="hljs-string">'high'</span>;

        <span class="hljs-comment">// 绘制当前页内容</span>
        ctx.<span class="hljs-title function_">drawImage</span>(
          img,
          <span class="hljs-number">0</span>, sourceStartY,           <span class="hljs-comment">// 源图片起始位置</span>
          originalWidth, sourceHeight, <span class="hljs-comment">// 源图片尺寸</span>
          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,                        <span class="hljs-comment">// 目标起始位置</span>
          pageContentWidthPx, currentPageHeight <span class="hljs-comment">// 目标尺寸</span>
        );

        <span class="hljs-comment">// 转换为 data URL</span>
        <span class="hljs-keyword">const</span> pageDataUrl = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-variable constant_">IMAGE_FORMAT</span>, <span class="hljs-variable constant_">IMAGE_QUALITY</span>);

        pages.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">dataUrl</span>: pageDataUrl,
          <span class="hljs-attr">width</span>: pageContentWidthPx,
          <span class="hljs-attr">height</span>: currentPageHeight
        });

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`第 <span class="hljs-subst">${pageIndex + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">${totalPages}</span> 页处理完成`</span>);
      }

      <span class="hljs-title function_">resolve</span>(pages);
    };

    img.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'图片加载失败'</span>));
    img.<span class="hljs-property">src</span> = imageDataUrl;
  });
}
</code></pre>
<p><strong>分页算法图解</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">原始长图 (假设 <span class="hljs-number">5000px</span> 高)
┌───────────────────┐
│                   │ ─┐
│      Page <span class="hljs-number">1</span>       │  │ <span class="hljs-number">1046px</span> (<span class="hljs-number">277mm</span> × <span class="hljs-number">3.78</span> × <span class="hljs-number">2</span>)
│                   │ ─┘
├───────────────────┤
│                   │ ─┐
│      Page <span class="hljs-number">2</span>       │  │ <span class="hljs-number">1046px</span>
│                   │ ─┘
├───────────────────┤
│                   │ ─┐
│      Page <span class="hljs-number">3</span>       │  │ <span class="hljs-number">1046px</span>
│                   │ ─┘
├───────────────────┤
│                   │ ─┐
│      Page <span class="hljs-number">4</span>       │  │ <span class="hljs-number">1046px</span>
│                   │ ─┘
├───────────────────┤
│      Page <span class="hljs-number">5</span>       │ ── 剩余 <span class="hljs-number">816px</span>
│                   │
└───────────────────┘
</code></pre>
<h3 data-id="heading-18">Step 3：创建 PDF（jsPDF）</h3>
<p>将分页后的图片逐一添加到 PDF 中。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { jsPDF } <span class="hljs-keyword">from</span> <span class="hljs-string">'jspdf'</span>;

<span class="hljs-comment">/**
 * 从分页图片创建 PDF
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createPdfFromPages</span>(<span class="hljs-params">pages: PageImageData[]</span>): jsPDF {
  <span class="hljs-keyword">const</span> pdf = <span class="hljs-keyword">new</span> <span class="hljs-title function_">jsPDF</span>({
    <span class="hljs-attr">orientation</span>: <span class="hljs-string">'portrait'</span>,
    <span class="hljs-attr">unit</span>: <span class="hljs-string">'mm'</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">'a4'</span>,
    <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 启用压缩，减小文件体积</span>
  });

  <span class="hljs-keyword">if</span> (pages.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有可添加的页面'</span>);
  }

  pages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">page, index</span>) =&gt;</span> {
    <span class="hljs-comment">// 第一页直接用，后续需要 addPage</span>
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">0</span>) {
      pdf.<span class="hljs-title function_">addPage</span>();
    }

    <span class="hljs-comment">// 像素转毫米（考虑 scale=2）</span>
    <span class="hljs-keyword">const</span> scaleFactor = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> pageHeightMm = page.<span class="hljs-property">height</span> / <span class="hljs-variable constant_">MM_TO_PX</span> / scaleFactor;

    <span class="hljs-comment">// 图片适配内容区域宽度</span>
    <span class="hljs-keyword">const</span> finalWidth = <span class="hljs-variable constant_">PDF_CONTENT_WIDTH_MM</span>;  <span class="hljs-comment">// 190mm</span>
    <span class="hljs-keyword">const</span> finalHeight = pageHeightMm;

    <span class="hljs-comment">// 位置：左上角对齐，保留 10mm 边距</span>
    <span class="hljs-keyword">const</span> x = <span class="hljs-variable constant_">PDF_MARGIN_MM</span>;
    <span class="hljs-keyword">const</span> y = <span class="hljs-variable constant_">PDF_MARGIN_MM</span>;

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`添加第 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span> 页: <span class="hljs-subst">${finalWidth}</span>x<span class="hljs-subst">${finalHeight.toFixed(<span class="hljs-number">2</span>)}</span>mm`</span>);

    <span class="hljs-comment">// 添加图片到 PDF</span>
    pdf.<span class="hljs-title function_">addImage</span>(page.<span class="hljs-property">dataUrl</span>, <span class="hljs-string">'PNG'</span>, x, y, finalWidth, finalHeight);
  });

  <span class="hljs-keyword">return</span> pdf;
}
</code></pre>
<h3 data-id="heading-19">Step 4：主导出函数</h3>
<p>将以上步骤串联起来，提供统一的导出接口。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ExportConfig</span> {
  <span class="hljs-attr">targetSelector</span>: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// CSS 选择器</span>
  filename?: <span class="hljs-built_in">string</span>;        <span class="hljs-comment">// 文件名</span>
  quality?: <span class="hljs-built_in">number</span>;         <span class="hljs-comment">// 图片质量</span>
}

<span class="hljs-comment">/**
 * 主导出函数
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">exportMessagesToPdf</span>(<span class="hljs-params">config: ExportConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">const</span> {
    targetSelector,
    filename = <span class="hljs-string">'messages.pdf'</span>,
    quality = <span class="hljs-variable constant_">IMAGE_QUALITY</span>
  } = config;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 开始导出 PDF ==='</span>);

  <span class="hljs-comment">// 1. 获取目标元素</span>
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(targetSelector) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
  <span class="hljs-keyword">if</span> (!element) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`元素未找到: <span class="hljs-subst">${targetSelector}</span>`</span>);
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素尺寸:'</span>, {
    <span class="hljs-attr">width</span>: element.<span class="hljs-property">offsetWidth</span>,
    <span class="hljs-attr">height</span>: element.<span class="hljs-property">scrollHeight</span>
  });

  <span class="hljs-comment">// 2. DOM 截图</span>
  <span class="hljs-keyword">const</span> imageDataUrl = <span class="hljs-keyword">await</span> <span class="hljs-title function_">captureElementToImage</span>(element, quality);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'截图完成，大小:'</span>, (imageDataUrl.<span class="hljs-property">length</span> / <span class="hljs-number">1024</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>), <span class="hljs-string">'KB'</span>);

  <span class="hljs-comment">// 3. 图片分页</span>
  <span class="hljs-keyword">const</span> pages = <span class="hljs-keyword">await</span> <span class="hljs-title function_">splitImageIntoPages</span>(imageDataUrl);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`分页完成，共 <span class="hljs-subst">${pages.length}</span> 页`</span>);

  <span class="hljs-comment">// 4. 创建 PDF</span>
  <span class="hljs-keyword">const</span> pdf = <span class="hljs-title function_">createPdfFromPages</span>(pages);

  <span class="hljs-comment">// 5. 保存文件</span>
  pdf.<span class="hljs-title function_">save</span>(filename);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 导出完成 ==='</span>);
}
</code></pre>
<h3 data-id="heading-20">在组件中使用</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// MessageList.tsx</span>

<span class="hljs-keyword">import</span> { exportMessagesToPdf } <span class="hljs-keyword">from</span> <span class="hljs-string">'../services/messageExportService'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">MessageList</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> messageListRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isExporting, setIsExporting] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> handleExportToPdf = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-title function_">setIsExporting</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 生成带时间戳的文件名</span>
      <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[:.]/g</span>, <span class="hljs-string">'-'</span>);
      <span class="hljs-keyword">const</span> filename = <span class="hljs-string">`messages-<span class="hljs-subst">${timestamp}</span>.pdf`</span>;

      <span class="hljs-keyword">await</span> <span class="hljs-title function_">exportMessagesToPdf</span>({
        <span class="hljs-attr">targetSelector</span>: <span class="hljs-string">'.message-list-container'</span>,
        filename,
        <span class="hljs-attr">quality</span>: <span class="hljs-number">0.95</span>
      });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'导出失败:'</span>, error);
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'导出失败，请重试'</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsExporting</span>(<span class="hljs-literal">false</span>);
    }
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-list-container"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{messageListRef}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-list-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>消息记录<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"export-button"</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleExportToPdf}</span>
          <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isExporting}</span>
        &gt;</span>
          {isExporting ? '导出中...' : '导出 PDF'}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-list"</span>&gt;</span>
        {messages.map(message =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">MessageItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{message.id}</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-21">完整效果</h3>
<p>运行项目后，点击「导出 PDF」按钮：</p>
<ol>
<li>控制台显示详细的导出日志</li>
<li>自动计算页数并分页</li>
<li>生成高清 PDF 文件并自动下载</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">=== 开始导出 <span class="hljs-attr">PDF</span> ===
目标选择器: .message-list-container
元素尺寸: { width: 600, height: 8500 }
开始截图...
截图完成，大小: 2847.65 KB
分页完成，共 8 页
添加第 1 页: 190x277.00mm
添加第 2 页: 190x277.00mm
...
添加第 8 页: <span class="hljs-attr">190x156.32mm</span>
=== 导出完成 ===
</code></pre>
<hr/>
<h2 data-id="heading-22">SnapDOM VS html2canvas</h2>
<p>为什么选择 SnapDOM 而不是更流行的 html2canvas？让我们来对比一下：</p>
<h3 data-id="heading-23">详细对比表</h3>




























































<table><thead><tr><th>对比维度</th><th>SnapDOM</th><th>html2canvas</th></tr></thead><tbody><tr><td><strong>样式还原</strong></td><td>★★★★★ 接近完美</td><td>★★★☆☆ 部分样式丢失</td></tr><tr><td><strong>Flexbox/Grid</strong></td><td>✅ 完美支持</td><td>⚠️ 部分问题</td></tr><tr><td><strong>渐变背景</strong></td><td>✅ 完美支持</td><td>⚠️ 可能失真</td></tr><tr><td><strong>阴影效果</strong></td><td>✅ 完美支持</td><td>⚠️ 部分丢失</td></tr><tr><td><strong>自定义字体</strong></td><td>✅ 支持</td><td>⚠️ 需要额外处理</td></tr><tr><td><strong>SVG 支持</strong></td><td>✅ 原生支持</td><td>⚠️ 有限支持</td></tr><tr><td><strong>输出格式</strong></td><td>PNG/Canvas/SVG</td><td>Canvas/PNG</td></tr><tr><td><strong>包大小</strong></td><td>~20KB</td><td>~60KB</td></tr><tr><td><strong>维护状态</strong></td><td>活跃更新</td><td>较少更新</td></tr><tr><td><strong>API 设计</strong></td><td>现代 Promise</td><td>回调 + Promise</td></tr></tbody></table>
<h3 data-id="heading-24">代码对比</h3>
<p><strong>html2canvas 方式：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> html2canvas <span class="hljs-keyword">from</span> <span class="hljs-string">'html2canvas'</span>;

<span class="hljs-comment">// 需要处理各种兼容性问题</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-keyword">await</span> <span class="hljs-title function_">html2canvas</span>(element, {
  <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">useCORS</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">logging</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">allowTaint</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">foreignObjectRendering</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 可能不生效</span>
  <span class="hljs-comment">// 还需要处理字体、SVG 等问题...</span>
});

<span class="hljs-keyword">const</span> dataUrl = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">'image/png'</span>);
</code></pre>
<p><strong>SnapDOM 方式：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { snapdom } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zumer/snapdom'</span>;

<span class="hljs-comment">// 简洁的 API，无需额外配置</span>
<span class="hljs-keyword">const</span> capture = <span class="hljs-keyword">await</span> <span class="hljs-title function_">snapdom</span>(element, {
  <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">quality</span>: <span class="hljs-number">0.95</span>
});

<span class="hljs-keyword">const</span> dataUrl = (<span class="hljs-keyword">await</span> capture.<span class="hljs-title function_">toPng</span>()).<span class="hljs-property">src</span>;
</code></pre>
<h3 data-id="heading-25">什么时候选择 html2canvas？</h3>
<p>虽然 SnapDOM 在大多数场景下更优秀，但 html2canvas 在以下情况可能更适合：</p>
<ol>
<li><strong>项目已在使用</strong>：迁移成本较高</li>
<li><strong>简单场景</strong>：只需截取简单文本，无复杂样式</li>
<li><strong>团队熟悉度</strong>：团队对 html2canvas 更熟悉</li>
</ol>
<h2 data-id="heading-26">总结</h2>
<h3 data-id="heading-27">核心要点回顾</h3>
<ol>
<li><strong>SnapDOM</strong> 提供高保真的 DOM 截图能力，通过 <code>scale: 2</code> 实现 2 倍清晰度</li>
<li><strong>jsPDF</strong> 是强大的 PDF 生成库，支持 A4 纸张、压缩等特性</li>
<li><strong>分页算法</strong> 是整个方案的核心难点，需要精确计算像素与毫米的转换</li>
<li><strong>SnapDOM</strong> 相比 html2canvas 在样式还原度上有明显优势</li>
</ol>
<h3 data-id="heading-28">进一步优化方向</h3>





























<table><thead><tr><th>优化点</th><th>说明</th></tr></thead><tbody><tr><td><strong>Web Worker</strong></td><td>将分页计算放到 Worker 中，避免阻塞主线程</td></tr><tr><td><strong>分段截图</strong></td><td>超长内容分段截图，避免内存溢出</td></tr><tr><td><strong>加载提示</strong></td><td>添加进度条，提升用户体验</td></tr><tr><td><strong>PDF 压缩</strong></td><td>使用 pdf-lib 进一步压缩 PDF 体积</td></tr><tr><td><strong>页眉页脚</strong></td><td>添加页码、时间戳等信息</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO中国版终于来了，完全免费！]]></title>    <link>https://juejin.cn/post/7576580177662132234</link>    <guid>https://juejin.cn/post/7576580177662132234</guid>    <pubDate>2025-11-26T04:34:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576580177662132234" data-draft-id="7576646142315937833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO中国版终于来了，完全免费！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T04:34:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO中国版终于来了，完全免费！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:34:27.000Z" title="Wed Nov 26 2025 04:34:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 454 篇原创！</p>
<p>大家好，我是还没秃顶的苍何。</p>
<p>昨晚听了 TRAE SOLO 国内版上线的发布会。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a52e09b1f24a669b6039c91d2450ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=0XY9x7d8iNF1Vlt%2BhvEfs9PoZBs%3D" alt="图片" loading="lazy"/></p>
<p>时隔 4 个月，它终于来了。</p>
<p>我也第一时间做了下体验，做了几个 case，录了个视频给大家看看。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46ea2fc4cbe04f63a92a4f3b65840006~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=tFRfXJgCl1EV6%2BCd0RqY8Btf6c0%3D" alt="wxv_4269304641676214281" loading="lazy"/></p>
<p>追溯到 7 月份，那时候国际版刚开 Beta 测试，全网爆火，激活码真是一码难求。我当时废了很大劲，第一时间抢鲜体验了一把，手感确实惊艳，为此还专门写过一篇文章分享。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e3bfebe492740cab632a4b7a26e89d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=wh5d7TvihbfhjeQt6wosEvfCtrk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>也是从那时起，我和 Trae 算是「杠」上了，关系变得相当微妙。</p>
<p>后来我还成了武汉的 Trae Fellow，在武汉搞了一场黑客松。看着大家在现场用它从 0 到 1 构建项目，我是真切感受到了工具带来的变化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/250626d7ed844bb0a57773ac8935e4ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=ZOAYXNR8s4WiRFhT3SGgg93OuTc%3D" alt="图片" loading="lazy"/></p>
<p>至于为啥我一直盯着 Trae 不放，又为啥觉得这次国内版 SOLO 模式的发布意义非凡？</p>
<p>理由其实很简单。</p>
<p>虽然 Cursor 很强，但网络问题把太多人挡在门外了。我们太缺一款能真正对标甚至超越 Cursor，同时又没有任何网络门槛的 AI IDE 了。</p>
<p>AI 编程不该是少数人的特权。</p>
<p>要想让这种强大的生产力真正铺开，让每个人都能体会到它的强大，就得把门槛踩碎。</p>
<p>这正是 Trae 这段时间一直在默默做的事。</p>
<p>11 月 25 日发布的这个版本，直接同步了国际版最核心的 SOLO Coder 功能，甚至包括 Plan 模式、多任务并行这些硬核能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87dc3653e8434bfe8a2e91642294e9b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=qjd62r%2FZsZ1sX9yhB4UzN8vVVxk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>最最关键的是，它目前<strong>完全免费</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6be1518803bd41b898e9a6726b5372a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=1HT2kZ9K6%2F3WlOMEsRiK2pbvqUY%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>可以实时跟随，还会自动打开浏览器页面预览，非常方便。</p>
<p>这就很有意思了。以前我们用 AI 写代码，总感觉像是在「开盲盒」。你给个指令，AI 闷头写，写出来能跑算运气好，不能跑你就得在那对着一堆代码干瞪眼，完全不知道它中间经历了什么心路历程。</p>
<p>但 TRAE SOLO 主打的概念叫「Responsive Coding Agent」。</p>
<p>别被这个英文吓到，我自己上手盘了一下，觉得用大白话解释就是：<strong>它不再是个只会执行命令的死板工具，而是一个能和你「有商有量」的智能队友。</strong></p>
<p>具体强在哪？我挑几个咱们写代码时最感同身受的点聊聊。</p>
<p><strong>第一，它懂得「先思考，再动手」。</strong></p>
<p>以前的 AI 是急性子，你需求还没说完，它代码可能就生成了一半。结果往往是方向错了，还得推倒重来。</p>
<p>TRAE SOLO 有个 <strong>Plan 模式</strong>。当你抛出一个复杂需求时，它不会急着写代码，而是先给你列一个 To-Do List，告诉你它准备分几步走。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28279fd152f94235a5b404a7fd0ebd35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=CaOfEkZ3AKrNDfoJpmgRhfBExc4%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这就很像带徒弟了。</p>
<p>你看了计划，觉得没问题，它再开工；觉得逻辑不对，直接在计划阶段就指出来。把错误扼杀在写代码之前，这才是正经的工程思维。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015f8615e6134b819e7066e3ad68231f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=6u1MWBujjCMpZQGfr90%2FAPtwnow%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p><strong>第二，告别黑盒，代码改了哪一目了然。</strong></p>
<p>这次新增的代码变更（ <strong>DiffView</strong> ）功能我个人非常喜欢。</p>
<p>以前 AI 改代码，经常把好的逻辑也给改坏了。现在，它做了哪些新增、改了哪些逻辑，都在界面上清清楚楚地展示出来。</p>
<p>你可以实时审查（Code Review），就像看同事提交的代码一样。你没点头，它就不敢乱合并。这种「随时可掌控」的感觉，才是我们敢在实际项目里用 AI 的底气。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e79022ae1ff423f9ac7e9215d1d81a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=LLKNsMavSOSm37mOd5xYhWNQB8A%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p><strong>第三，脑子好使，还懂得「断舍离」。</strong></p>
<p>做大项目最怕 AI 聊着聊着就「失忆」，或者因为上下文太长开始胡言乱语。</p>
<p>TRAE SOLO 在这块做得比较聪明。它能支持检索海量的代码文件（据说能扛住 10 万个文件），更重要的是，它有一套自动的上下文压缩机制。</p>
<p>当对话太长时，它会自动触发压缩，保留核心信息；你也可以手动点一下压缩，让它把没用的废话清掉。这样既保留了关键记忆，又不会让模型跑偏。</p>
<p><strong>除此，它还能「分身」。</strong></p>
<p>这玩意儿支持多任务并行 sub agent。你可以开一个线程让它去修 Bug，同时开另一个线程让它去写新功能的接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca08f3fe2b84b6583cd6c0291dd9d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=VW8Mrm4rK8LpYaLQ%2FgBVwi46z8g%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>一个人就是一支队伍，这回真不是说说而已。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6242fa3c9ee3409abcd55bc373db269f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=2GrcV1KDXI%2FxENe6DFU1J6SVv98%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这些智能体也是可以自己创建的，点「创建智能体」就能创建了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b883d8c325084545954e87bf2212da84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=vQEIIt65AKol489Y236CkCZhRPg%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>创建好后就能看到自己拥有的智能体了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8254192470f4ba191e26e935671b09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=1hw0UzJ%2Fcv6k%2BVmpNYAOapnHF%2F8%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>目前国内版支持了国内顶尖的代码模型，比如 Doubao-Seed-Code、Kimi K2、GLM 4.6 等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f521848b7e4e1eb4a80885117a8918~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=o51GEbXYwKRgRlBQiDJ2lGQZuyk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>也支持自定义模型。</p>
<p>同样内置不少 MCP。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bbbf2dcefc24e199bce02b606cf6c67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=lWbEPTx5ANz1qP1IDo6th5kPxLY%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>广场能搜素到非常多好用的 MCP，配置也很简单相对 Cursor 来说。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c251ca0914e406b9c9844c0e9a4419e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=yQ5TLllMOnxrVNqPixWLzzLjVD0%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>体验下来，最大的感受就是「顺滑」。没有网络延迟的焦虑，加上这种透明的协作模式，确实能让人专注于创造本身。</p>
<p>说实话，Trae SOLO 给我的感觉是「瑕不掩瑜」。</p>
<p>如果要吹毛求疵，国内底层的代码模型在处理极度复杂的深层逻辑时，距离国外最顶尖的模型确实还有一些提升空间。这点咱们得认，模型能力的打磨还需要时间。</p>
<p>但 Trae 团队聪明的地方在于，他们用极致的产品细节弥补了这一点。</p>
<p>那种行云流水的交互感，DiffView 带来的掌控感，以及 Plan 模式下的「商量着来」，让你在使用过程中往往会忽略掉模型本身的一点小瑕疵。</p>
<p>更重要的是，它打破了那堵把无数人挡在 AI 编程门外的「墙」。</p>
<p>不用折腾网络，不用担心账单，打开就能用。对于大多数想尝试 AI 编程的朋友来说，这就够了。</p>
<p>国产 IDE 能做到这个细腻程度，值得给点掌声。</p>
<p>去试试吧，也许它就是你期待已久的那个「编程搭子」。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析]]></title>    <link>https://juejin.cn/post/7576543407013232659</link>    <guid>https://juejin.cn/post/7576543407013232659</guid>    <pubDate>2025-11-26T00:39:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576543407013232659" data-draft-id="7571815573933408319" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析"/> <meta itemprop="keywords" content="Flutter,Android,前端"/> <meta itemprop="datePublished" content="2025-11-26T00:39:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:39:47.000Z" title="Wed Nov 26 2025 00:39:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在健康类 App 开发中，睡眠周期分析和冥想数据展示是核心功能模块。一个直观、美观且交互流畅的可视化图表，能极大提升用户对健康数据的理解和使用体验。今天给大家推荐一款专为 Flutter 开发者打造的全能型图表插件——<strong>sleep_stage_chart</strong>，它不仅能完美呈现睡眠阶段数据，还支持冥想时长可视化，跨平台兼容且高度可定制。</p>
<h2 data-id="heading-0">1. 简介</h2>
<p><code>sleep_stage_chart</code>是一款专注于睡眠阶段和冥想数据可视化的 Flutter 插件，借鉴了 Apple Health 应用的优雅设计风格，提供了平滑的过渡效果和丰富的交互能力。该插件支持 Android、iOS 和 Windows 三大平台，能够满足健康类 App 对睡眠周期分析、冥想时长统计等场景的可视化需求。</p>
<h3 data-id="heading-1">1.1. 例图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7b79258904c437ebbd0ad21222c3480~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764722387&amp;x-signature=j27zZH389EnntvmiOQ5T5xdwVVo%3D" alt="睡眠图" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6c35ad686d4faab1d7fb8b59c205fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764722387&amp;x-signature=Kp5YCWV4ao5d15cAckwkfDNzm%2Bo%3D" alt="冥想图" loading="lazy"/></p>
<h3 data-id="heading-2">1.2. 核心功能</h3>
<p>该插件的功能覆盖了健康数据可视化的核心需求，同时提供了足够的灵活性：</p>
<ul>
<li>📊 <strong>双图表支持</strong>：同时兼容睡眠阶段图（浅睡/深睡/REM/清醒状态）和冥想时长图</li>
<li>🎨 <strong>深度定制化</strong>：支持颜色、样式、布局、网格线等全维度自定义</li>
<li>📱 <strong>跨平台兼容</strong>：无缝运行于 Android、iOS、Windows 平台</li>
<li>🤏 <strong>交互体验</strong>：支持触摸拖拽指示器，查看不同时段的详细数据</li>
<li>🕐 <strong>精准时间展示</strong>：清晰呈现时间范围、阶段时长，支持自定义时间格式化</li>
<li>🎀 <strong>样式扩展</strong>：支持自定义底部组件、圆角、背景色等外观属性</li>
<li>📖 <strong>完善文档</strong>：提供完整的 API 说明和可直接运行的示例代码</li>
</ul>
<h2 data-id="heading-3">2. 快速集成</h2>
<p>在项目的 <code>pubspec.yaml</code> 文件中添加插件依赖：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">sleep_stage_chart:</span> <span class="hljs-string">^1.1.2</span>  <span class="hljs-comment"># 建议使用最新版本</span>
</code></pre>
<p>执行安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub get
</code></pre>
<h3 data-id="heading-4">2.1. 基础使用示例</h3>
<p>插件提供了两种核心图表场景：睡眠阶段图和冥想时长图，以下是最简实现示例。</p>
<h4 data-id="heading-5">睡眠阶段图</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:sleep_stage_chart/sleep_stage_chart.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SleepChartDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 构造睡眠数据：包含阶段类型、起止时间、描述信息</span>
    <span class="hljs-keyword">final</span> sleepData = [
      SleepStageDetails(
        model: SleepStageEnum.light,  <span class="hljs-comment">// 浅睡</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22</span>, <span class="hljs-number">30</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">23</span>, <span class="hljs-number">30</span>),
        info: [<span class="hljs-string">'浅睡，睡眠质量良好'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.deep,   <span class="hljs-comment">// 深睡</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">23</span>, <span class="hljs-number">30</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
        info: [<span class="hljs-string">'深睡，身体修复阶段'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.rem,    <span class="hljs-comment">// REM睡眠（快速眼动）</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">15</span>),
        info: [<span class="hljs-string">'REM睡眠，大脑活跃'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.awake,  <span class="hljs-comment">// 清醒</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">30</span>),
        info: [<span class="hljs-string">'清醒，准备起床'</span>],
      ),
    ];

    <span class="hljs-keyword">return</span> Container(
      height: <span class="hljs-number">300</span>,
      margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
      child: SleepStageChart(
        details: sleepData,  <span class="hljs-comment">// 睡眠数据（必填）</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22</span>, <span class="hljs-number">30</span>),  <span class="hljs-comment">// 开始时间（必填）</span>
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">30</span>),     <span class="hljs-comment">// 结束时间（必填）</span>
        backgroundColor: Colors.white,            <span class="hljs-comment">// 背景色（必填）</span>
        heightUnitRatio: <span class="hljs-number">1</span> / <span class="hljs-number">8</span>,                   <span class="hljs-comment">// 高度比例单位</span>
        onIndicatorMoved: (stage) {               <span class="hljs-comment">// 指示器移动回调</span>
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前阶段：<span class="hljs-subst">${stage.model.name}</span>，时长：<span class="hljs-subst">${stage.duration}</span>分钟'</span>);
        },
        bottomChild: <span class="hljs-keyword">const</span> [Text(<span class="hljs-string">'入睡'</span>), Text(<span class="hljs-string">'起床'</span>)],  <span class="hljs-comment">// 底部自定义文本</span>
        stageColors: {  <span class="hljs-comment">// 自定义各阶段颜色</span>
          SleepStageEnum.light: Colors.blue.shade300,
          SleepStageEnum.deep: Colors.blue.shade700,
          SleepStageEnum.rem: Colors.teal.shade400,
          SleepStageEnum.awake: Colors.orange.shade300,
        },
      ),
    );
  }
}
</code></pre>
<h4 data-id="heading-6">冥想时长图</h4>
<p>冥想图表通常需要展示全天或特定时段的冥想分布，可通过统一颜色和时间轴配置实现：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:sleep_stage_chart/sleep_stage_chart.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MeditationChartDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> dayStart = <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Container(
      height: <span class="hljs-number">300</span>,
      margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
      child: SleepStageChart(
        details: [
          SleepStageDetails(
            model: SleepStageEnum.light,
            startTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">30</span>)),
            endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">75</span>)),
            info: [<span class="hljs-string">'晨间冥想，专注呼吸'</span>],
          ),
          SleepStageDetails(
            model: SleepStageEnum.light,
            startTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(hours: <span class="hljs-number">19</span>)),
            endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(hours: <span class="hljs-number">20</span>, minutes: <span class="hljs-number">20</span>)),
            info: [<span class="hljs-string">'睡前冥想，放松身心'</span>],
          ),
        ],
        startTime: dayStart,
        endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(days: <span class="hljs-number">1</span>)),
        backgroundColor: Colors.transparent,
        heightUnitRatio: <span class="hljs-number">1</span> / <span class="hljs-number">8</span>,
        allDayModel: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 开启全天模式</span>
        minuteInterval: <span class="hljs-number">360</span>,  <span class="hljs-comment">// 时间轴间隔：6小时</span>
        stageColors: <span class="hljs-keyword">const</span> {  <span class="hljs-comment">// 统一冥想颜色</span>
          SleepStageEnum.light: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.deep: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.rem: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.awake: Color(<span class="hljs-number">0xFF43CAC4</span>),
        },
        bottomChild: [<span class="hljs-string">'00:00'</span>, <span class="hljs-string">'06:00'</span>, <span class="hljs-string">'12:00'</span>, <span class="hljs-string">'18:00'</span>, <span class="hljs-string">'00:00'</span>]
            .map((time) =&gt; Text(time, style: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">12</span>)))
            .toList(),
        showVerticalLine: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示竖线分隔</span>
        showHorizontalLine: <span class="hljs-keyword">false</span>,  <span class="hljs-comment">// 隐藏横线</span>
        borderRadius: <span class="hljs-number">12</span>,  <span class="hljs-comment">// 圆角优化</span>
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-7">2.2. 高级定制指南</h3>
<p><code>sleep_stage_chart</code>提供了丰富的定制属性，以下是常见场景的定制方案。</p>
<h4 data-id="heading-8">颜色定制</h4>
<p>通过 <code>stageColors</code> 属性自定义各睡眠阶段的颜色，支持所有 <code>SleepStageEnum</code> 类型：</p>
<pre><code class="hljs language-dart" lang="dart">stageColors: <span class="hljs-keyword">const</span> {
  SleepStageEnum.light: Color(<span class="hljs-number">0xFFE3F2FD</span>),  <span class="hljs-comment">// 浅睡-淡蓝</span>
  SleepStageEnum.deep: Color(<span class="hljs-number">0xFF90CAF9</span>),   <span class="hljs-comment">// 深睡-中蓝</span>
  SleepStageEnum.rem: Color(<span class="hljs-number">0xFF42A5F5</span>),    <span class="hljs-comment">// REM-深蓝</span>
  SleepStageEnum.awake: Color(<span class="hljs-number">0xFFFFE0B2</span>),  <span class="hljs-comment">// 清醒-淡橙</span>
  SleepStageEnum.notWorn: Color(<span class="hljs-number">0xFFF5F5F5</span>),<span class="hljs-comment">// 未佩戴-灰色</span>
  SleepStageEnum.unknown: Color(<span class="hljs-number">0xFFEEEEEE</span>),<span class="hljs-comment">// 未知-浅灰</span>
},
</code></pre>
<h4 data-id="heading-9">网格线定制</h4>
<p>控制网格线的显示/隐藏和样式：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 横线样式</span>
horizontalLineStyle: SleepStageChartLineStyle(
  width: <span class="hljs-number">1.0</span>,
  color: Colors.grey.shade200,
  space: <span class="hljs-number">2.0</span>,  <span class="hljs-comment">// 虚线间隔</span>
),
<span class="hljs-comment">// 竖线样式</span>
verticalLineStyle: SleepStageChartLineStyle(
  width: <span class="hljs-number">1.0</span>,
  color: Colors.grey.shade200,
),
showHorizontalLine: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示横线</span>
showVerticalLine: <span class="hljs-keyword">true</span>,    <span class="hljs-comment">// 显示竖线</span>
horizontalLineCount: <span class="hljs-number">6</span>,    <span class="hljs-comment">// 横线数量（分割图表高度）</span>
</code></pre>
<h4 data-id="heading-10">时间格式化</h4>
<p>通过 <code>dateFormatter</code> 自定义时间轴的显示格式：</p>
<pre><code class="hljs language-dart" lang="dart">dateFormatter: (<span class="hljs-built_in">DateTime</span> date) {
  <span class="hljs-comment">// 自定义格式：小时-分钟（补零）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'<span class="hljs-subst">${date.hour.toString().padLeft(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>:<span class="hljs-subst">${date.minute.toString().padLeft(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>'</span>;
},
</code></pre>
<h4 data-id="heading-11">交互控制</h4>
<p>控制指示器的显示和回调：</p>
<pre><code class="hljs language-dart" lang="dart">hasIndicator: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示触摸指示器</span>
onIndicatorMoved: (SleepStageDetails stage) {
  <span class="hljs-comment">// 指示器移动时回调，可用于更新详情面板</span>
  setState(() {
    _currentStage = stage;
    _currentDuration = <span class="hljs-string">'<span class="hljs-subst">${stage.duration}</span>分钟'</span>;
    _currentInfo = stage.info.join(<span class="hljs-string">' '</span>);
  });
},
</code></pre>
<h2 data-id="heading-12">3. 核心 API 参考</h2>
<p>下面是核心的api属性列举：</p>
<h3 data-id="heading-13">SleepStageChart（主组件）</h3>





































































































<table><thead><tr><th>属性名</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>details</code></td><td>List</td><td>-</td><td>核心数据（必填）</td></tr><tr><td><code>startTime</code></td><td>DateTime</td><td>-</td><td>开始时间（必填）</td></tr><tr><td><code>endTime</code></td><td>DateTime</td><td>-</td><td>结束时间（必填）</td></tr><tr><td><code>backgroundColor</code></td><td>Color</td><td>-</td><td>背景色（必填）</td></tr><tr><td><code>stageColors</code></td><td>Map&lt;SleepStageEnum, Color&gt;?</td><td>null</td><td>阶段颜色映射</td></tr><tr><td><code>heightUnitRatio</code></td><td>double</td><td>-</td><td>高度比例单位</td></tr><tr><td><code>borderRadius</code></td><td>double</td><td>8.0</td><td>圆角半径</td></tr><tr><td><code>showVerticalLine</code></td><td>bool</td><td>true</td><td>是否显示竖线</td></tr><tr><td><code>showHorizontalLine</code></td><td>bool</td><td>true</td><td>是否显示横线</td></tr><tr><td><code>hasIndicator</code></td><td>bool</td><td>true</td><td>是否显示触摸指示器</td></tr><tr><td><code>onIndicatorMoved</code></td><td>void Function(SleepStageDetails)?</td><td>null</td><td>指示器移动回调</td></tr><tr><td><code>allDayModel</code></td><td>bool</td><td>false</td><td>是否开启全天模式</td></tr><tr><td><code>minuteInterval</code></td><td>int</td><td>360</td><td>全天模式时间间隔（分钟）</td></tr><tr><td><code>bottomChild</code></td><td>List</td><td>[]</td><td>底部自定义组件列表</td></tr><tr><td><code>dateFormatter</code></td><td>String Function(DateTime)?</td><td>null</td><td>时间格式化函数</td></tr></tbody></table>
<h3 data-id="heading-14">SleepStageDetails（数据模型）</h3>



































<table><thead><tr><th>属性名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>model</code></td><td>SleepStageEnum</td><td>睡眠/冥想阶段类型</td></tr><tr><td><code>startTime</code></td><td>DateTime</td><td>阶段开始时间</td></tr><tr><td><code>endTime</code></td><td>DateTime</td><td>阶段结束时间</td></tr><tr><td><code>info</code></td><td>List</td><td>阶段描述信息</td></tr><tr><td><code>duration</code></td><td>int</td><td>时长（分钟，自动计算）</td></tr></tbody></table>
<h3 data-id="heading-15">SleepStageEnum（阶段枚举）</h3>





























<table><thead><tr><th>枚举值</th><th>描述</th></tr></thead><tbody><tr><td><code>light</code></td><td>浅睡/冥想</td></tr><tr><td><code>deep</code></td><td>深睡</td></tr><tr><td><code>rem</code></td><td>REM睡眠</td></tr><tr><td><code>awake</code></td><td>清醒</td></tr><tr><td><code>unknown</code></td><td>未知状态</td></tr></tbody></table>
<h2 data-id="heading-16">4. 示例App项目</h2>
<p>插件提供了完整的示例项目，可直接克隆源码运行体验：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/wp993080086/sleep_stage_chart.git

<span class="hljs-comment"># 进入示例目录</span>
<span class="hljs-built_in">cd</span> sleep_stage_chart/example

<span class="hljs-comment"># 安装依赖并运行</span>
flutter pub get
flutter run
</code></pre>
<p>示例项目包含了睡眠图表、冥想图表的各种定制场景，可直接参考复用。</p>
<h2 data-id="heading-17">5. 总结</h2>
<p>sleep_stage_chart 是一款功能全面、高度可定制的 Flutter 健康数据可视化插件，凭借其优雅的设计风格、流畅的交互体验和跨平台兼容性，能够快速满足睡眠和冥想数据的可视化需求。无论是快速集成基础图表，还是深度定制符合 App 风格的可视化效果，该插件都能提供简洁高效的解决方案。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>睡眠监测类 App：展示深睡、浅睡、REM 睡眠周期分布</li>
<li>冥想类 App：统计每日/每周冥想时长和时段分布</li>
<li>健康管理 App：整合睡眠与冥想数据的综合可视化</li>
<li>智能穿戴设备配套 App：同步设备采集的睡眠数据展示</li>
</ul>
<p>如果你的项目中需要实现睡眠周期分析或冥想数据展示，不妨试试 sleep_stage_chart，让健康数据可视化开发更高效！</p>
<p><strong>相关链接：</strong></p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwp993080086%2Fsleep_stage_chart" target="_blank" title="https://github.com/wp993080086/sleep_stage_chart" ref="nofollow noopener noreferrer">GitHub仓库</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwp993080086%2Fsleep_stage_chart%2Fblob%2Fmaster%2FREADME_zh.md" target="_blank" title="https://github.com/wp993080086/sleep_stage_chart/blob/master/README_zh.md" ref="nofollow noopener noreferrer">中文文档</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fsleep_stage_chart" target="_blank" title="https://pub.dev/packages/sleep_stage_chart" ref="nofollow noopener noreferrer">pub.dev仓库</a></p>
</li>
</ul>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[被国外IP持续DDOS怎么办？]]></title>    <link>https://juejin.cn/post/7576669556150403110</link>    <guid>https://juejin.cn/post/7576669556150403110</guid>    <pubDate>2025-11-26T06:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576669556150403110" data-draft-id="7576580177662640138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="被国外IP持续DDOS怎么办？"/> <meta itemprop="keywords" content="前端,Node.js,Nginx"/> <meta itemprop="datePublished" content="2025-11-26T06:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洞窝技术"/> <meta itemprop="url" content="https://juejin.cn/user/2538113306470631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            被国外IP持续DDOS怎么办？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2538113306470631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洞窝技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:38:20.000Z" title="Wed Nov 26 2025 06:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    58
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c801015fd006484384445c9421b6ec01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811946&amp;x-signature=Tfoe1ntAgSUIr8tgkmb23oANSNE%3D" alt="logo.png" loading="lazy"/></p>
<p>最近持续被东南亚的几个IP持续攻击，我用的是阿里云的免费应用防火墙，一直没什么好办法。今天看到了几个免费的IP库，一下子就想到了如果我直接屏蔽这些来源国家的访问不就好了。</p>
<p>在网站运营、网络安全或流量管控场景中，按国家/地区限制IP访问（如仅允许国内IP访问、屏蔽特定国家IP）是常见需求。实现这一需求的核心步骤是：获取目标国家的IP段 → 将IP段配置到 Nginx 中生效。本文将详细讲解如何通过Node.js或Shell脚本获取国家IP段，并结合 Nginx 的geo模块完成配置。</p>
<h2 data-id="heading-0">一、选择 IP 数据源</h2>
<p>获取国家 IP 段的前提是选择可靠的数据源，目前主流免费/商用数据源包括：</p>
<h3 data-id="heading-1">1. MaxMind GeoLite2</h3>
<p>MaxMind 是全球知名的 IP 地理信息服务商，提供免费的 GeoLite2 数据库（需注册账号），包含 IPv4/IPv6 的国家 / 地区映射，数据精度高且更新及时（每月更新）。</p>
<h3 data-id="heading-2">2. apnic</h3>
<p>apnic提供免费可直接获取的IP信息，直接下载就能获取最新的IP数据信息。</p>
<h3 data-id="heading-3">3. 其他</h3>
<ul>
<li>ip2region：国内开源的 IP 定位库，支持国家 / 城市级映射，数据文件小（约 10MB），查询速度快。</li>
<li>17monip（纯真 IP）：国内常用的 IP 库，需定期下载更新包。</li>
<li>IP2Location LITE：类似 GeoLite2 的免费数据库，提供 CSV/MMDB 格式。</li>
</ul>
<p>本文以apnic为例讲解（兼容性和易用性最优）。</p>
<h2 data-id="heading-4">二、获取国家 IP 段的方法</h2>
<h3 data-id="heading-5">方法 1：使用bash脚本获取并处理</h3>
<p>这种方式适合linux系统下的简单使用，兼容centos、ubuntu等系统。</p>
<h4 data-id="heading-6">步骤一：获取数据</h4>
<p>可以使用<code>wget</code>或者<code>curl</code>这种命令直接从远程下载脚本，脚本地址取最新数据<code>http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest</code>，脚本内容类似：</p>
<pre><code class="hljs language-bash" lang="bash">wget -c -O /tmp http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest

curl -C - -o /tmp http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest
</code></pre>
<h3 data-id="heading-7">步骤二：处理数据</h3>
<p>官方提供的数据通常都是txt格式的，逐行进行排列的数据。我们要使用还需要对数据进行解析，把我们需要的数据单独获取出来。可以使用脚本的<code>awk</code>命令进行处理。</p>
<p><code>awk</code>的命令格式:</p>
<pre><code class="hljs language-bash" lang="bash">awk [参数] [处理内容] [操作对象]
</code></pre>
<h3 data-id="heading-8">完整脚本</h3>
<p>我们假设要把数据处理成“起始IP|数量/前缀长度|注册机构|国家代码”的格式，按照这个逻辑，再加上错误处理，我们输出以下脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">set</span> -eu  <span class="hljs-comment"># 移除 pipefail，兼容低版本 Bash，保留关键错误检查</span>

<span class="hljs-comment"># 脚本配置</span>
URL=<span class="hljs-string">"http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest"</span>
DOWNLOAD_DIR=<span class="hljs-string">"/root/apnic"</span>
DOWNLOAD_FILENAME=<span class="hljs-string">"delegated-apnic-latest"</span>
IPV4_OUTPUT_FILENAME=<span class="hljs-string">"apnic_ipv4.txt"</span>
IPV6_OUTPUT_FILENAME=<span class="hljs-string">"apnic_ipv6.txt"</span>

<span class="hljs-comment"># 帮助信息</span>
<span class="hljs-function"><span class="hljs-title">show_help</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"用法：<span class="hljs-variable">$0</span> --download-dir &lt;下载目录&gt; [--temp-dir &lt;临时目录&gt;]"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"选项："</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  --download-dir  可选，文件下载保存目录"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  -h/--help       显示帮助信息"</span>
}

<span class="hljs-comment"># 解析命令行参数</span>
<span class="hljs-function"><span class="hljs-title">parse_args</span></span>() {

    <span class="hljs-keyword">while</span> [[ <span class="hljs-variable">$#</span> -gt 0 ]]; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
            --download-dir)
                DOWNLOAD_DIR=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            -h|--<span class="hljs-built_in">help</span>)
                show_help
                <span class="hljs-built_in">exit</span> 0
                ;;
            *)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：未知参数 <span class="hljs-variable">$1</span>"</span>
                show_help
                <span class="hljs-built_in">exit</span> 1
                ;;
        <span class="hljs-keyword">esac</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 检查依赖工具（wget 或 curl）</span>
<span class="hljs-function"><span class="hljs-title">check_dependencies</span></span>() {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v wget &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        DOWNLOAD_TOOL=<span class="hljs-string">"wget"</span>
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v curl &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        DOWNLOAD_TOOL=<span class="hljs-string">"curl"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：未找到 wget 或 curl，请先安装其中一个工具"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 下载文件 + 校验文件有效性</span>
<span class="hljs-function"><span class="hljs-title">download_file</span></span>() {
    <span class="hljs-built_in">local</span> download_path=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${DOWNLOAD_FILENAME}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 开始下载文件 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"URL: <span class="hljs-variable">$URL</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"保存路径: <span class="hljs-variable">$download_path</span>"</span>

    <span class="hljs-comment"># 检查下载目录是否存在</span>
    <span class="hljs-keyword">if</span> [[ ! -d <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_DIR</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_DIR</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：无法创建保持目录 <span class="hljs-variable">$DOWNLOAD_DIR</span>"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">fi</span>

    <span class="hljs-comment"># 下载文件（支持断点续传）</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_TOOL</span>"</span> == <span class="hljs-string">"wget"</span> ]]; <span class="hljs-keyword">then</span>
        wget -c -O <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$URL</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：wget 下载失败（可能是网络问题或服务器异常）"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">else</span>
        curl -C - -o <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$URL</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：curl 下载失败（可能是网络问题或服务器异常）"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">fi</span>

    <span class="hljs-comment"># 校验下载文件是否为空</span>
    <span class="hljs-keyword">if</span> [[ ! -s <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：下载的文件为空，请检查 URL 或网络连接"</span>
        <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span>  <span class="hljs-comment"># 删除空文件</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 文件下载完成（大小：<span class="hljs-subst">$(du -sh <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> | awk '{print $1}')</span>）==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"下载文件路径: <span class="hljs-variable">$download_path</span>"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 解析并筛选 IPv4/IPv6（容错增强）</span>
<span class="hljs-function"><span class="hljs-title">parse_and_filter_ip</span></span>() {
    <span class="hljs-built_in">local</span> download_path=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${DOWNLOAD_FILENAME}</span>"</span>
    <span class="hljs-built_in">local</span> ipv4_output=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${IPV4_OUTPUT_FILENAME}</span>"</span>
    <span class="hljs-built_in">local</span> ipv6_output=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${IPV6_OUTPUT_FILENAME}</span>"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 开始解析文件 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"源文件: <span class="hljs-variable">$download_path</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"解析目录: <span class="hljs-variable">$DOWNLOAD_DIR</span>"</span>

    <span class="hljs-comment"># 清空输出文件（避免残留旧数据）</span>
    &gt; <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span>
    &gt; <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span>

    <span class="hljs-comment"># 筛选规则：</span>
    <span class="hljs-comment"># 1. 跳过注释行（以 # 开头）和空行</span>
    <span class="hljs-comment"># 2. 第 3 列（type）为 ipv4/ipv6 的行</span>
    <span class="hljs-comment"># 3. 输出格式：起始IP|数量/前缀长度|注册机构|国家代码（字段 4|5|1|2）</span>
    <span class="hljs-comment"># 用 awk 处理，即使部分行格式异常也不中断</span>
    awk -F <span class="hljs-string">'|'</span> <span class="hljs-string">'
        !/^#/ &amp;&amp; NF &gt;= 6 {  # 只处理非注释行且字段数≥6的行
            if ($3 == "ipv4") {
                print $4 "|" $5 "|" $1 "|" $2 &gt;&gt; "'</span><span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span><span class="hljs-string">'"
            } else if ($3 == "ipv6") {
                print $4 "|" $5 "|" $1 "|" $2 &gt;&gt; "'</span><span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span><span class="hljs-string">'"
            }
        }
    '</span> <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> || {
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：部分行格式异常，已跳过"</span>
    }

    <span class="hljs-comment"># 检查筛选结果（允许其中一种IP类型为空，避免误判）</span>
    <span class="hljs-keyword">if</span> [[ -s <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv4 筛选完成，记录数：<span class="hljs-subst">$(wc -l &lt; <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span>)</span> 行"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：未筛选到 IPv4 数据（可能文件格式变更或无相关记录）"</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [[ -s <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv6 筛选完成，记录数：<span class="hljs-subst">$(wc -l &lt; <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span>)</span> 行"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：未筛选到 IPv6 数据（可能文件格式变更或无相关记录）"</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 解析筛选完成 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv4 文件路径: <span class="hljs-variable">$ipv4_output</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv6 文件路径: <span class="hljs-variable">$ipv6_output</span>"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 主流程</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    parse_args <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
    check_dependencies
    download_file
    parse_and_filter_ip

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 任务全部完成 ==="</span>
}

<span class="hljs-comment"># 启动脚本</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>脚本首先设置默认变量，也就是默认的存储位置是<code>/root/apnic</code>，然后再把最新数据下载到文件里，通过命令筛选我们需要的数据分别存到对应的文件中。</p>
<h3 data-id="heading-9">方法 2：Node.js处理数据</h3>
<p>使用nodejs整体流程设计上就不需要临时存储文件了，我们直接每次获取之后在内存中就全部处理完成。整体处理如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-comment">// 要允许通过的国家</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ALLowList</span> = [<span class="hljs-string">'CN'</span>, <span class="hljs-string">'HK'</span>, <span class="hljs-string">'MO'</span>, <span class="hljs-string">'TW'</span>];

<span class="hljs-comment">// 获取远程数据</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getApnicTxt</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'</span>);
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
}

<span class="hljs-comment">// apnic|BD|ipv4|103.132.248.0|1024|20190116|allocated</span>
<span class="hljs-comment">// apnic|ID|ipv6|2001:df0:f180::|48|20190718|assigned</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createIpRecord</span>(<span class="hljs-params">line, dot = <span class="hljs-string">'24'</span></span>) {
    <span class="hljs-keyword">const</span> parts = line.<span class="hljs-title function_">split</span>(<span class="hljs-string">'|'</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">ALLowList</span>.<span class="hljs-title function_">includes</span>(parts[<span class="hljs-number">1</span>])) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`allow <span class="hljs-subst">${parts[<span class="hljs-number">3</span>]}</span>/<span class="hljs-subst">${dot}</span>; #<span class="hljs-subst">${parts[<span class="hljs-number">1</span>]}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`deny <span class="hljs-subst">${parts[<span class="hljs-number">3</span>]}</span>/<span class="hljs-subst">${dot}</span>; #<span class="hljs-subst">${parts[<span class="hljs-number">1</span>]}</span>`</span>;
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> txts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getApnicTxt</span>();
    <span class="hljs-keyword">const</span> list = txts.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);
    <span class="hljs-keyword">const</span> ipv4list = [];
    <span class="hljs-keyword">const</span> ipv6list = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; list.<span class="hljs-property">length</span>; index++) {
        <span class="hljs-keyword">const</span> txt = list[index];
        <span class="hljs-keyword">if</span> (txt.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'|ipv4|'</span>)) {
            ipv4list.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createIpRecord</span>(txt));
        }
        <span class="hljs-keyword">if</span> (txt.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'|ipv6|'</span>)) {
            ipv6list.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createIpRecord</span>(txt, <span class="hljs-string">'32'</span>));
        }
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ipv4list'</span>, ipv4list);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ipv4list'</span>, ipv6list);
}

<span class="hljs-title function_">main</span>();
</code></pre>
<p>脚本中同样是先获取最新的数据，然后直接交给处理函数进行分批处理。这里我们假设处理的结果是给nginx使用的，所以我们直接在结构上增加<code>allow</code>和<code>deny</code>前缀，方便在nginx中直接使用。</p>
<h2 data-id="heading-10">三、配置nginx文件</h2>
<h3 data-id="heading-11">方法1：使用<code>allow</code>进行管理</h3>
<p>这种配置方式兼容新老版本的nginx，只需要在nginx中提前引入配置文件，每次更新配置文件内容之后重启nginx就能达到自动允许和拒绝来源国家的访问地址。</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com;

    # 引入允许的IP白名单
    include /etc/nginx/conf.d/china-ipv4.conf;
    include /etc/nginx/conf.d/china-ipv6.conf;

    # 可选：放行本地回环（避免自己被拦）
    allow 127.0.0.1;
    allow ::1;

    # 拒绝所有未匹配的请求
    deny all;

    location / {
        root /var/www/html;
        index index.html;
        # 你的其他配置...
    }
}
</code></pre>
<p>通过以上配置就可以达到只允许我们需要的访问，其他国家访问一律禁止。</p>
<h3 data-id="heading-12">方法2：使用geo模块</h3>
<p>Nginx 通过geo模块（默认编译）实现 IP 段的快速匹配，该模块将 IP 段加载到内存中，查询效率极高（不受 IP 段数量影响）。</p>
<pre><code class="hljs language-nginx" lang="nginx">http {
    # 定义IPv4的国家匹配变量（$is_cn_v4：1=中国IP，0=非中国IP）
    geo $is_cn_v4 {
        default 0;
        include /etc/nginx/conf.d/cn-ipv4.conf;  # 引入中国IPv4段文件
    }

    # 定义IPv6的国家匹配变量（如需支持IPv6）
    geo $is_cn_v6 {
        default 0;
        include /etc/nginx/conf.d/cn-ipv6.conf;  # 引入中国IPv6段文件
    }

    # 合并IPv4/IPv6的匹配结果
    map $scheme $is_cn {
        http $is_cn_v4;
        https $is_cn_v4;
        httpv6 $is_cn_v6;
        httpsv6 $is_cn_v6;
    }

    server {
      listen 80;
      listen [::]:80;
      server_name yourdomain.com;

      # 非中国IP返回403
      if ($is_cn != 1) {
          return 403;
      }

      # 正常业务配置...
      location / {
          root /var/www/html;
          index index.html;
      }
  }
}
</code></pre>
<p>通过使用nginx的geo模块可以非常快速的识别到ip对应的国家，然后在具体的路由中通过自动一判断来返回自己想要返回的内容。同样的，配置文件更新之后要重新启动nginx服务。</p>
<h3 data-id="heading-13">其他命令</h3>
<p>检查nginx配置文件是否正确。</p>
<pre><code class="hljs">nginx -t
</code></pre>
<p>重新启动nginx。</p>
<pre><code class="hljs">systemctl restart nginx
</code></pre>
<p>严重IP匹配的效果。</p>
<pre><code class="hljs language-bash" lang="bash">curl -H <span class="hljs-string">"X-Forwarded-For: 8.8.8.8"</span> http://yourdomain.com  <span class="hljs-comment"># 8.8.8.8为美国IP</span>
</code></pre>
<h2 data-id="heading-14">四、注意事项</h2>
<p>在具体的使用过程中还有一些是需要特别注意的：</p>
<ol>
<li>geo和allow的配置文件格式是不一样的。</li>
<li>如果使用云服务做转发，来源ip是云服务的地址，需要额外增加IP透传的功能。</li>
<li>远程地址的更新没那么快，可以设置每隔一周来定时更新一次。持续访问可能会被官方封禁哦。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入 Nestjs 底层概念（1）：依赖注入和面向切面编程 AOP]]></title>    <link>https://juejin.cn/post/7576555431943503882</link>    <guid>https://juejin.cn/post/7576555431943503882</guid>    <pubDate>2025-11-26T03:04:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576555431943503882" data-draft-id="7496341294567800883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入 Nestjs 底层概念（1）：依赖注入和面向切面编程 AOP"/> <meta itemprop="keywords" content="前端,Node.js,NestJS"/> <meta itemprop="datePublished" content="2025-11-26T03:04:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入 Nestjs 底层概念（1）：依赖注入和面向切面编程 AOP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:04:24.000Z" title="Wed Nov 26 2025 03:04:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文保证绝对大白话！简单易懂!</p>
<p>最近跟一个好友讨论，他说想学习 <code>node.js</code> 后端框架 <code>nest.js</code>，但对于 <code>nest.js</code> 的下面用法一头雾水，为什么要这么用呢？什么 <code>Contoller</code>, <code>Provider</code>，怎么跟一般的 <code>javascript</code> 代码的用法完全不一样呢？如下的 <code>@Controller</code>,<code>@Injectable</code> 你理解是什么意思吗？为什么要用这样的方式组织代码呢？</p>
<pre><code class="hljs language-Javascript" lang="Javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Cat</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./interfaces/cat.interface'</span>;


@<span class="hljs-title class_">Controller</span>(<span class="hljs-string">'cats'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CatsController</span> {
  @<span class="hljs-title class_">Get</span>()
  <span class="hljs-title function_">findAll</span>(): string {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'This action returns all cats'</span>;
  }
}

@<span class="hljs-title class_">Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CatsService</span> {
  private readonly <span class="hljs-attr">cats</span>: <span class="hljs-title class_">Cat</span>[] = [];

  <span class="hljs-title function_">create</span>(<span class="hljs-params">cat: Cat</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cats</span>.<span class="hljs-title function_">push</span>(cat);
  }

  <span class="hljs-title function_">findAll</span>(): <span class="hljs-title class_">Cat</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cats</span>;
  }
}

</code></pre>
<p>基于此，我写了这篇文章，帮助大家从 0 开始，层层递进到所有这些让你陌生的 <code>nest.js</code> 的概念！</p>
<h2 data-id="heading-1">从编程范式说起</h2>
<p>编程范式在之前面试经常被问到了，什么 <code>FP</code>(函数式编程)，<code>RP</code>(响应式编程)，<code>FRP</code>（函数式响应式编程），还有我们熟知的大兄弟 <code>面相对象编程</code>，现在 <code>nest.js</code> 又来个 <code>AOP</code>（面相切面编程），属实让人蒙圈了。。。。太多概念了。</p>
<p>别急，我们一个一个来！</p>
<h3 data-id="heading-2">函数式编程 - FP</h3>
<p>简单来说就是要求你使用纯函数，什么是纯函数，就是输入一定的时候输出一定，就是传入相同的参数得到相同的结果。就这么简单，例如</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
    sum = a + b;
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>常见有几种情况会影响纯函数的纯净，最常见就是：</p>
<ul>
<li>修改传参的值，或者引用，或者全局状态，改 DOM，例如</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b, c</span>) { 
     <span class="hljs-comment">// 假设 c 传入一个对象，c 的 xx 属性被修改</span>
     c.<span class="hljs-property">xx</span> = a + b; <span class="hljs-comment">// 修改传参的值</span>
     <span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span> = a; <span class="hljs-comment">// 修改全局变量</span>
    sum = a + b;
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<ul>
<li>做一些 i/o 操作，例如 console.log, 写文件。好了接下里说说 <code>RP</code>(响应式编程)</li>
</ul>
<h3 data-id="heading-3">响应式编程 - RP</h3>
<p>也能很好理解，我们举个例子：</p>
<p>就像“Excel 表格”：<br/>
你改了 A1，B1 = A1 + 10 会自动更新，这就是典型的 RP。</p>
<p>在 vue 和 react 都非常常见，跟踪一个值变化，然后引发另一些值变化。</p>
<p>它强调：</p>
<ul>
<li>数据是“流”（stream）</li>
<li>数据变化会自动传播到依赖它的逻辑（自动更新）</li>
<li>你不需要手动触发</li>
</ul>
<h3 data-id="heading-4">函数式响应式编程 - FRP</h3>
<p>FRP 是“函数式编程 + 响应式编程”的结合。比较典型的就是 Rxjs 的风格：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听 DOM 的 input 事件</span>
<span class="hljs-keyword">const</span> input$ = <span class="hljs-title function_">fromEvent</span>(searchInput, <span class="hljs-string">'input'</span>); <span class="hljs-comment">// 输入是一个“流”</span>

<span class="hljs-keyword">const</span> results$ = input$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>),  <span class="hljs-comment">// 函数式转换</span>
);

results$.<span class="hljs-title function_">subscribe</span>(renderResults);
</code></pre>
<p>简单理解就是当触发 <code>DOM</code> 的 <code>input</code> 事件触发的时候，也就是一个值改变的时候，触发 results$ 值的改变，这就是 <code>RP</code>（响应式编程），然后在 <code>input</code> 事件触发值改变的过程中，还执行了 <code>map</code> 方法，这是一个纯函数，所以也算 <code>FP</code> 函数式编程。</p>
<h3 data-id="heading-5">OOP - 面向对象编程</h3>
<p>顾名思义，面相对象就是以对象为对象为单位，例如</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> {
  <span class="hljs-attr">name</span>: string;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: string</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is barking!`</span>);
  }
}
</code></pre>
<p>使用到的数据，最好都封装为对象，如上面，使用的时候需要 <code>new Dog()</code> 返回我们新创造出来的实例，也就是 class 仅仅是个模板。对象是由模板创造出来的。</p>
<p>然后就是面向对象的特点，也就是最熟悉的三件套，封装，继承，多态。靠这三个，面向对象编程的思维模式认为可以模拟现实世界。</p>
<p>封装：很简单，例如 <code>Dog</code> 这个类，把跟 <code>Dog</code> 相关的属性和方法都放在一个类里就是封装，例如有 name 属性，狗的名字，你如果想加其它参数，继续拓展就行了，例如性别，品种。当然封装还有一些细节，例如封装私有属性什么的，这些细枝末节不用太在意。我们主要是简单介绍 OOP 的思想。</p>
<p>继承：可以将别的类的东西继承过来，例如, 很多动物都可以继承<code>Animal</code> 这个类：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">public name: string</span>) {}

  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Some sound..."</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> says meow~`</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">makeSound</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> says woof!`</span>);
  }
}

<span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">"Mimi"</span>);
<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">"Coco"</span>);

cat.<span class="hljs-title function_">makeSound</span>(); <span class="hljs-comment">// Mimi says meow~</span>
dog.<span class="hljs-title function_">makeSound</span>(); <span class="hljs-comment">// Coco says woof!</span>

</code></pre>
<p>主要是为我们抽象代码用的，例如公共部分放到一个类中，子类单独实现。思想是挺好的，就是实现起来有时候会比较麻烦，因为刚开始设计的时候，不太容易一开始就能预知未来需要抽象哪些。</p>
<p>多态：简单来说就是一个接口，不同实现，Javascript 中没有多态，更多在 typescript 中出现，例如用重载实现多态。如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: number, <span class="hljs-attr">b</span>: number): number;
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: string, <span class="hljs-attr">b</span>: string): string;
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: any, <span class="hljs-attr">b</span>: any): any {
    <span class="hljs-keyword">return</span> a + b;
  }
}

<span class="hljs-keyword">const</span> calc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calc.<span class="hljs-title function_">add</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>));       <span class="hljs-comment">// 15</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calc.<span class="hljs-title function_">add</span>(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>)) <span class="hljs-comment">// foobar</span>
</code></pre>
<h2 data-id="heading-6">面相切面编程 - AOP</h2>
<p>为我们提供了一种将代码注入现有函数或对象的方法，而无需修改目标逻辑。这句话大家看看就行了，很官方，我们简单理解就是：</p>
<p>把横跨多个功能的“通用逻辑”抽出来，统一管理，而不是在每个函数里重复写。</p>
<p>常见实现的方式，就是在函数前后，注册一个钩子，这样达到不修改当前函数逻辑的目的。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logBefore</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Calling:"</span>, fn.<span class="hljs-property">name</span>, <span class="hljs-string">"args:"</span>, args);
    <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  }
}
</code></pre>
<p>以上方法是一个 <code>切面</code> ，也就是可以包装到另一个函数上，在这个函数调用之前打印日志，是一个独立的功能。例如：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">getUser</span> = logBefore(function getUser(id) {
  // 在数据库搜索数据返回
  return db.query(`SELECT * FROM users WHERE <span class="hljs-attr">id</span> = <span class="hljs-variable">${id}</span>`)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>这样其它函数都可以共享这个 <code>logBefore</code> 的逻辑。</p>
<p>当然实际场景，例如鉴权，在调用一个方法前，看看有没有权限，就是一个很好的使用 <code>AOP</code> 的场景。</p>
<h2 data-id="heading-7">AOP 跟 nest.js 关系</h2>
<p>nest.js 后面我们会讲一个很关键的概念，pipeline，我们这里先简单介绍一下，后面详细说。pipeline 就是当客户端收到请求到返回的过程。</p>
<p>首先 nest.js 需要注册一个 Controller 来处理请求,如下</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

@<span class="hljs-title class_">Controller</span>(<span class="hljs-string">'cats'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CatsController</span> {
  @<span class="hljs-title class_">Get</span>()
  <span class="hljs-title function_">findAll</span>(): string {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'This action returns all cats'</span>;
  }
}
</code></pre>
<p>一般情况下，get 方法访问路径 <code>/cats</code> 的时候，返回 'This action returns all cats'。</p>
<p>但实际上到 <code>Controller</code> 处理数据之前，还有许多步骤。</p>
<p>例如在 nest.js 中有 <code>Middleware</code>（中间件） 的概念，也有 <code>Guard</code>(守卫的概念) 等等概念，我们这里不细说，后面文章会有，这里只需要记住：请求来了之后，先到 <code>Middleware</code> 然后到 <code>Guard</code>。。。兜兜转转好几回才能到 <code>Controller</code>。</p>
<p>之前我们提到，AOP 中的面向切面，一个 <code>切面</code> ，也就是可以包装到另一个函数上，在这个函数调用之前打印日志，是一个独立的功能。</p>
<p>nest.js 中的 <code>Middleware</code> 可以打印日志，是不是在不直接影响  <code>Controller</code> 逻辑的前提下，实现了一个可以复用的独立的功能，因为所有路由接收的请求都会经过  <code>Middleware</code>。</p>
<p>从这个意义上说 <code>Middleware</code>，<code>Guard</code> 这些概念本质就是 “切面”。</p>
<p>如果你对node.js ，组件库，前端动画感兴趣，欢迎进群交流。这是我组件库教程官网。感谢star，再次感谢：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.frontlight.tech%2F" target="_blank" title="https://www.frontlight.tech/" ref="nofollow noopener noreferrer">t-ui</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank" title="https://github.com/lio-mengxiang/t-ui" ref="nofollow noopener noreferrer">github 点赞</a></li>
</ul>
<h2 data-id="heading-8">依赖注入和控制反转</h2>
<p>这两个概念看起来挺唬人的，比较高大上。我们简单解释一下：</p>
<p>我们从一个简单例子说起：</p>
<p>假设有一个类叫老王，专指那些住在美女隔壁的靓仔们。他们喜欢助人为乐，送大帽子。能力上擅长逃跑。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Hobby</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">gender</span>){
        <span class="hljs-keyword">return</span> [gender, <span class="hljs-string">'助人为乐'</span>]
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Skill</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">return</span> [<span class="hljs-string">'送帽子'</span>, <span class="hljs-string">'跑路'</span>]
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-attr">hobby</span>: <span class="hljs-title class_">Hobby</span>
    <span class="hljs-attr">skill</span>: <span class="hljs-title class_">Skill</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hobby</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hobby</span>(<span class="hljs-string">'女'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">skill</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Skill</span>();
    }
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>()); <span class="hljs-comment">// { hobby: ['女', '助人为乐'], skill: ['送帽子', '跑路'] }</span>
</code></pre>
<p>好了，这个Person类，我们看看有啥缺点：</p>
<ul>
<li>每次创建Person类的实例，都要传入Hobby类和Skill类，也就是对这两个类都产生了依赖，假如有一天我们想创建不同的老王，比如有的老王喜欢小鲜肉，有的老王喜欢老腊肉，这个Person类写死了，没法定制</li>
</ul>
<p>有同学马上就会说，这个简单啊，Hobby和Skill当做参数传入不就行了，是的，这个方法确实能解决问题，如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Hobby</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">gender</span>){
        <span class="hljs-keyword">return</span> [gender, <span class="hljs-string">'助人为乐'</span>]
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Skill</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">return</span> [<span class="hljs-string">'送帽子'</span>, <span class="hljs-string">'跑路'</span>]
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-attr">hobby</span>: <span class="hljs-title class_">Hobby</span>
    <span class="hljs-attr">skill</span>: <span class="hljs-title class_">Skill</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">hobby, skill</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">hobby</span> = hobby;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">skill</span> = skill;
    }
}

<span class="hljs-comment">// { hobby: [’男', '助人为乐'], skill: ['送帽子', '跑路'] }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hobby</span>(<span class="hljs-string">'男'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Skill</span>()); 
</code></pre>
<ul>
<li>但有没有更好的办法，也就是这个类我们不用自己去new，像下面这样，系统帮我们自动导入呢？</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">hobby: Hobby, skill: Skill</span>){
  
    }
    <span class="hljs-title function_">hello</span>(<span class="hljs-params"/>){
        这里直接就可以用<span class="hljs-variable language_">this</span>.<span class="hljs-property">hobby</span>了
    }
}
</code></pre>
<p>也就是说，在你new Person的时候，hobby和skill参数，自动帮你实例化导入，而且你还需要new Person，能不能不new Person 都是自动调用并把参数导入？</p>
<ul>
<li>这就引申出第一个概念就控制反转，以前我们都要自己主动去new，从而创建实例，现在是把创建实例的任务交给了一个容器（后面会实现，你就明白了，相当于一个掌控者，或者说造物主，专门来创建实例的，并管理依赖关系），所以控制权是不是就反转了，你主动的创建实例和控制依赖，反转为容器创建实例和控制依赖。</li>
<li>对于控制反转，最常用件的方式叫依赖注入，意思是容器动态的将依赖关系注入到组件中。</li>
<li>控制反转可以通过依赖注入实现，所以本质上是一回事。</li>
</ul>
<p>到这里，其实大家也没觉得依赖注入有啥毛用吧！下面的讲解一言以蔽之就是，虽然我们js可以把函数或者类当参数传入另一个类里，这确实解决了之前讲的写死代码的问题，也就是说我们不用依赖注入也能解决代码耦合的问题，所以看起来我们并不是那么需要依赖注入。</p>
<h2 data-id="heading-9">小结</h2>
<p>这里第一篇 nest.js 内容完毕，接下来会详细解释上文提到的 pipline，也就是一个请求经过 <code>nest.js</code> 的全过程，以及这些经过的过程中，碰到的核心概念！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 接口与代码复用：替代继承的设计哲学]]></title>    <link>https://juejin.cn/post/7576609946190577700</link>    <guid>https://juejin.cn/post/7576609946190577700</guid>    <pubDate>2025-11-26T04:45:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576609946190577700" data-draft-id="7576575703167254534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 接口与代码复用：替代继承的设计哲学"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-11-26T04:45:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 接口与代码复用：替代继承的设计哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:45:44.000Z" title="Wed Nov 26 2025 04:45:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    28
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Go 接口与代码复用：替代继承的设计哲学</h2>
<h3 data-id="heading-1">一、前言</h3>
<p>Go 是 Google 设计的类 C 静态类型语言，兼顾底层性能与开发效率。它并非传统意义上的面向对象（OOP）语言 —— 没有 class 关键字，也不支持传统的 “继承” 语法，但通过 <strong>接口的隐式实现</strong> 和 <strong>结构体组合（嵌入）</strong>，Go 能灵活实现 OOP 的核心特性（多态、代码复用），且设计更简洁、无继承带来的耦合问题。
与 C++ 相比，Go 的设计哲学是 “<strong>组合优于继承</strong>”：用接口实现多态，用结构体嵌入实现代码复用，既避免了继承的复杂语法，又解决了多重继承的歧义问题。本文将通过类比 C++ 的接口 / 继承逻辑，详解 Go 如何实现类似效果。</p>
<h3 data-id="heading-2">二、Go 中的 “单一复用”（类似单一继承）</h3>
<p>C++ 的单一继承核心是 “一个子类继承一个父类 / 接口”，Go 中通过两种方式实现类似效果：<strong>仅用接口实现多态</strong>（无代码复用，仅约束行为）、<strong>结构体组合（嵌入）+ 接口</strong>（既有代码复用，又有多态）。</p>
<h4 data-id="heading-3">2.1 仅通过接口实现（隐式多态）</h4>
<p>C++ 的接口是 “纯虚函数集合”，子类需显式声明继承并实现所有接口方法；而 Go 的接口是 “方法签名集合”，<strong>无需显式声明实现</strong>—— 只要结构体实现了接口的所有方法，就自动满足该接口，这就是 “隐式实现”，也是 Go 接口的核心特性。</p>
<h5 data-id="heading-4">类比 C++ 伪代码</h5>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++ 需显式声明继承接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IFruit</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string name)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">GetType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Apple</span> : <span class="hljs-keyword">public</span> IFruit { <span class="hljs-comment">// 显式继承</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 实现 */</span> }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string name)</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 实现 */</span> }
    <span class="hljs-function">std::string <span class="hljs-title">GetType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"apple"</span>; }
};
</code></pre>
<h5 data-id="heading-5">Go 实现代码</h5>
<p>首先定义接口（仅约束行为，无实现）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 定义 Fruit 接口：仅声明方法签名，无实现</span>
<span class="hljs-keyword">type</span> FruitType <span class="hljs-type">string</span> <span class="hljs-comment">// 补充类型定义，使代码可运行</span>
<span class="hljs-keyword">const</span> (
    BananaType FruitType = <span class="hljs-string">"banana"</span>
    AppleType  FruitType = <span class="hljs-string">"apple"</span>
)

<span class="hljs-keyword">type</span> Fruit <span class="hljs-keyword">interface</span> {
    GetName() <span class="hljs-type">string</span>
    SetName(name <span class="hljs-type">string</span>)
    GetType() FruitType <span class="hljs-comment">// 明确类型，避免歧义</span>
}
</code></pre>
<p>定义 Banana 结构体，隐式实现 Fruit 接口：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Banana <span class="hljs-keyword">struct</span> {
    name   <span class="hljs-type">string</span>
    energy <span class="hljs-type">float32</span> <span class="hljs-comment">// 自定义字段</span>
}

<span class="hljs-comment">// 构造函数：初始化 Banana 实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBanana</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> *Banana {
    <span class="hljs-keyword">return</span> &amp;Banana{
        name:   name,
        energy: <span class="hljs-number">0</span>,
    }
}

<span class="hljs-comment">// 实现 Fruit 接口的所有方法（隐式满足 Fruit 接口）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> b.name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> SetName(name <span class="hljs-type">string</span>) {
    b.name = name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetType() FruitType {
    <span class="hljs-keyword">return</span> BananaType
}

<span class="hljs-comment">// Banana 自定义方法（接口未约束，仅自身可用）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> SetEnergy(energy <span class="hljs-type">float32</span>) {
    b.energy = energy
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetEnergy() <span class="hljs-type">float32</span> {
    <span class="hljs-keyword">return</span> b.energy
}
</code></pre>
<h5 data-id="heading-6">接口的两种使用方式（体现多态）</h5>
<h6 data-id="heading-7">1. 赋值给接口变量：通过接口统一调用，屏蔽具体实现</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> fruit Fruit <span class="hljs-comment">// 接口变量</span>
fruit = NewBanana(<span class="hljs-string">"big banana"</span>) <span class="hljs-comment">// 隐式转换，无需显式声明</span>
fmt.Println(fruit.GetName()) <span class="hljs-comment">// 输出：big banana（调用 Banana 的实现）</span>
fmt.Println(fruit.GetType()) <span class="hljs-comment">// 输出：banana</span>
</code></pre>
<h6 data-id="heading-8">2. 直接使用结构体实例：可调用接口方法 + 自定义方法</h6>
<pre><code class="hljs language-go" lang="go">banana := NewBanana(<span class="hljs-string">"little banana"</span>)
banana.SetEnergy(<span class="hljs-number">100</span>) <span class="hljs-comment">// 调用自定义方法</span>
fmt.Println(banana.GetEnergy()) <span class="hljs-comment">// 输出：100</span>
fmt.Println(banana.GetName()) <span class="hljs-comment">// 输出：little banana（调用接口方法）</span>
</code></pre>
<h6 data-id="heading-9">3. 工厂方法统一创建实例（增强多态灵活性）</h6>
<p>补充 NewFruit 实现，根据类型创建不同 Fruit 实例：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewFruit</span><span class="hljs-params">(fruitType FruitType, name <span class="hljs-type">string</span>)</span></span> Fruit {
    <span class="hljs-keyword">switch</span> fruitType {
    <span class="hljs-keyword">case</span> BananaType:
        <span class="hljs-keyword">return</span> NewBanana(name)
    <span class="hljs-keyword">case</span> AppleType:
        <span class="hljs-keyword">return</span> NewApple(name) <span class="hljs-comment">// 需实现 Apple 结构体（类似 Banana）</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
}

<span class="hljs-comment">// 使用工厂方法</span>
apple := NewFruit(AppleType, <span class="hljs-string">"red apple"</span>)
banana := NewFruit(BananaType, <span class="hljs-string">"yellow banana"</span>)
fmt.Println(apple.GetName(), banana.GetName()) <span class="hljs-comment">// 统一调用接口方法`</span>
</code></pre>
<h4 data-id="heading-10">2.2 结构体组合（嵌入）实现代码复用（类似基类继承）</h4>
<p>C++ 中通过 “子类继承基类” 复用基类代码，Go 中通过 “结构体嵌入”（将一个结构体作为另一个结构体的匿名字段）实现代码复用 —— 嵌入的结构体（称为 “嵌入类型”）的方法和字段，会被外层结构体 “继承”（实际是隐式代理），外层结构体可直接调用，也可覆盖这些方法。</p>
<h5 data-id="heading-11">类比 C++ 伪代码</h5>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 基类（含部分实现）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VehicleBase</span> : <span class="hljs-keyword">public</span> IVehicle {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetWheelCount</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> <span class="hljs-keyword">override</span> </span>{ wheelCount = count; }
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">GetWheelCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> wheelCount; }
    <span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"vehicle -&gt; "</span>; }
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> wheelCount;
};

<span class="hljs-comment">// 子类继承基类，复用方法并可覆盖</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bus</span> : <span class="hljs-keyword">public</span> VehicleBase {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> name; }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string n)</span> <span class="hljs-keyword">override</span> </span>{ name = n; }
    <span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> VehicleBase::<span class="hljs-built_in">ToString</span>() + <span class="hljs-string">"Bus -&gt; "</span> + name; <span class="hljs-comment">// 调用基类方法</span>
    }
<span class="hljs-keyword">private</span>:
    std::string name;
};
</code></pre>
<h5 data-id="heading-12">Go 实现代码</h5>
<h6 data-id="heading-13">1. 定义接口（约束核心行为）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> VehicleType <span class="hljs-type">string</span>
<span class="hljs-keyword">const</span> (
    BusType VehicleType = <span class="hljs-string">"bus"</span>
)

<span class="hljs-keyword">type</span> Vehicle <span class="hljs-keyword">interface</span> {
    GetType() VehicleType
    GetName() <span class="hljs-type">string</span>
    SetName(name <span class="hljs-type">string</span>)
    SetWheelCount(count <span class="hljs-type">int</span>)
    GetWheelCount() <span class="hljs-type">int</span>
    ToString() <span class="hljs-type">string</span>
}
</code></pre>
<h6 data-id="heading-14">2. 定义 “嵌入结构体”（类似基类，提供通用实现）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// vehicleImpl 是通用实现，作为嵌入类型供其他结构体复用</span>
<span class="hljs-keyword">type</span> vehicleImpl <span class="hljs-keyword">struct</span> {
    wheelCount <span class="hljs-type">int</span> <span class="hljs-comment">// 通用字段</span>
}

<span class="hljs-comment">// 通用方法实现（供嵌入者复用）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> SetWheelCount(count <span class="hljs-type">int</span>) {
    v.wheelCount = count
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> GetWheelCount() <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> v.wheelCount
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> ToString() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"vehicle -&gt; "</span>
}
</code></pre>
<h6 data-id="heading-15">3. 定义外层结构体（嵌入 vehicleImpl，复用代码）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Bus 结构体通过嵌入 vehicleImpl，复用其方法和字段</span>
<span class="hljs-keyword">type</span> Bus <span class="hljs-keyword">struct</span> {
    vehicleImpl <span class="hljs-comment">// 匿名嵌入（组合），无需显式调用</span>
    name        <span class="hljs-type">string</span> <span class="hljs-comment">// 自身字段</span>
}

<span class="hljs-comment">// 构造函数：初始化 Bus 实例（需初始化嵌入结构体）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBus</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> *Bus {
    <span class="hljs-keyword">return</span> &amp;Bus{
        name: name,
        vehicleImpl: vehicleImpl{ <span class="hljs-comment">// 初始化嵌入结构体</span>
            wheelCount: <span class="hljs-number">4</span>, <span class="hljs-comment">// 公交车默认4个轮子</span>
        },
    }
}

<span class="hljs-comment">// 实现 Vehicle 接口的剩余方法（未被 vehicleImpl 实现的部分）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> GetType() VehicleType {
    <span class="hljs-keyword">return</span> BusType
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> b.name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> SetName(name <span class="hljs-type">string</span>) {
    b.name = name
}

<span class="hljs-comment">// 覆盖嵌入结构体的 ToString 方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> ToString() <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 调用嵌入结构体的被覆盖方法：b.vehicleImpl.ToString()</span>
    <span class="hljs-keyword">return</span> b.vehicleImpl.ToString() + fmt.Sprintf(<span class="hljs-string">"Bus -&gt; %s (wheels: %d)"</span>, b.GetName(), b.GetWheelCount())
}
</code></pre>
<h6 data-id="heading-16">核心特性说明</h6>
<ul>
<li>代码复用：<code>Bus</code> 无需重新实现 <code>SetWheelCount</code>、<code>GetWheelCount</code>，直接复用 <code>vehicleImpl</code> 的方法；</li>
<li>方法覆盖：<code>Bus</code> 定义了与 <code>vehicleImpl</code> 同名的 <code>ToString</code> 方法，会覆盖嵌入结构体的方法，优先调用外层方法；</li>
<li>显式调用嵌入方法：通过 <code>b.vehicleImpl.ToString()</code> 可调用被覆盖的嵌入结构体方法；</li>
<li>字段访问：嵌入结构体的字段可直接访问（<code>b.wheelCount</code>），也可显式访问（<code>b.vehicleImpl.wheelCount</code>）。</li>
</ul>
<h3 data-id="heading-17">三、Go 中的 “多组合”（类似多重继承）</h3>
<p>C++ 支持多重继承（一个类继承多个父类），但容易引发 “菱形继承”（多个父类继承自同一基类）的歧义问题。Go 本身<strong>不支持传统多重继承</strong>，但通过 “多嵌入”（一个结构体嵌入多个结构体），可实现类似 “多重继承” 的效果 —— 复用多个嵌入结构体的方法和字段，且无歧义。</p>
<h4 data-id="heading-18">类比 C++ 伪代码</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Father</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Tony"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>(); }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Mother</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Aurora"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>(); }
};

<span class="hljs-comment">// 多重继承：同时继承 Father 和 Mother</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> : <span class="hljs-keyword">public</span> Father, <span class="hljs-keyword">public</span> Mother {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Jerry"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-comment">// 显式调用父类方法，避免歧义</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>() + <span class="hljs-string">", Father: "</span> + Father::<span class="hljs-built_in">Say</span>() + <span class="hljs-string">", Mother: "</span> + Mother::<span class="hljs-built_in">Say</span>();
    }
};
</code></pre>
<h4 data-id="heading-19">Go 实现代码（多嵌入结构体）</h4>
<h5 data-id="heading-20">1. 定义两个 “被组合” 的结构体（类似父类）：</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Father 结构体（提供一组方法）</span>
<span class="hljs-keyword">type</span> Father <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewFather</span><span class="hljs-params">()</span></span> *Father {
    <span class="hljs-keyword">return</span> &amp;Father{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *Father)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Tony"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *Father)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + f.GetName()
}

<span class="hljs-comment">// Mother 结构体（提供另一组方法）</span>
<span class="hljs-keyword">type</span> Mother <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMother</span><span class="hljs-params">()</span></span> *Mother {
    <span class="hljs-keyword">return</span> &amp;Mother{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mother)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Aurora"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mother)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + m.GetName()
}
</code></pre>
<h5 data-id="heading-21">2. 定义 Child 结构体（嵌入 Father 和 Mother）：</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Child 嵌入两个结构体，复用其方法</span>
<span class="hljs-keyword">type</span> Child <span class="hljs-keyword">struct</span> {
    *Mother <span class="hljs-comment">// 指针嵌入（需初始化指针）</span>
    *Father <span class="hljs-comment">// 指针嵌入</span>
}

<span class="hljs-comment">// 构造函数：初始化 Child 及嵌入的结构体指针</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewChild</span><span class="hljs-params">()</span></span> *Child {
    <span class="hljs-keyword">return</span> &amp;Child{
        Mother: NewMother(), <span class="hljs-comment">// 初始化 Mother 指针</span>
        Father: NewFather(), <span class="hljs-comment">// 初始化 Father 指针</span>
    }
}

<span class="hljs-comment">// 覆盖嵌入结构体的同名方法（避免调用歧义）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Child)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Jerry"</span>
}

<span class="hljs-comment">// 自定义方法，显式调用嵌入结构体的方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Child)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 显式指定嵌入结构体，调用其方法（无歧义）</span>
    fatherSay := c.Father.Say()
    motherSay := c.Mother.Say()
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"I am %s. Father: %s, Mother: %s"</span>, c.GetName(), fatherSay, motherSay)
}
</code></pre>
<h5 data-id="heading-22">3. 使用示例：</h5>
<pre><code class="hljs language-go" lang="go">child := NewChild()
fmt.Println(child.Say())
<span class="hljs-comment">// 输出：I am Jerry. Father: I am Tony, Mother: I am Aurora</span>
</code></pre>
<h5 data-id="heading-23">核心规则（避免歧义）</h5>
<ul>
<li><strong>嵌入方式</strong>：支持值嵌入（<code>Father</code>）和指针嵌入（<code>*Mother</code>），指针嵌入需在构造时初始化指针；</li>
<li><strong>同名方法处理</strong>：若多个嵌入结构体有同名方法，外层结构体必须定义同名方法覆盖（否则调用时会编译报错，提示歧义）；</li>
<li><strong>显式调用嵌入方法</strong>：通过 <code>c.Father.Say()</code> 显式指定嵌入结构体，避免歧义，这是 Go 处理 “多组合” 冲突的核心方式。</li>
</ul>
<h3 data-id="heading-24">四、Go 与 C++ 核心区别总结</h3>



































<table><thead><tr><th>特性</th><th>C++</th><th>Go</th></tr></thead><tbody><tr><td>接口实现</td><td>显式继承（<code>public</code> 接口）</td><td>隐式实现（无需声明，实现方法即满足）</td></tr><tr><td>代码复用</td><td>继承基类</td><td>结构体嵌入（组合）</td></tr><tr><td>多重继承</td><td>支持（易引发菱形继承歧义）</td><td>不支持，通过多嵌入实现多组合（无歧义）</td></tr><tr><td>方法覆盖</td><td>需 <code>override</code> 关键字</td><td>同名方法自动覆盖（外层优先）</td></tr><tr><td>核心设计哲学</td><td>继承优先</td><td>组合优于继承</td></tr></tbody></table>
<h3 data-id="heading-25">五、完整代码仓库</h3>
<p>本文所有可运行代码已整理至 GitHub，包含接口、组合、多组合的完整示例，可直接克隆运行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-inheritance-example" target="_blank" title="https://github.com/tx7do/go-inheritance-example" ref="nofollow noopener noreferrer">github.com/tx7do/go-in…</a></p>
<h3 data-id="heading-26">六、总结</h3>
<p>Go 没有传统 OOP 的 “类” 和 “继承”，但通过 <strong>接口的隐式多态</strong> 和 <strong>结构体的组合（嵌入）</strong>，实现了更灵活、低耦合的代码复用和多态特性：</p>
<ol>
<li>接口负责 “约束行为”，隐式实现让代码更简洁，支持多态；</li>
<li>结构体嵌入负责 “复用代码”，替代传统继承，无耦合问题；</li>
<li>多嵌入实现类似 “多重继承” 的效果，但通过显式调用避免歧义。</li>
</ol>
<p>这种设计既保留了 OOP 的核心优势，又规避了继承带来的复杂问题，是 Go 简洁、高效的关键原因之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[都React 19了,他到底带来了什么?]]></title>    <link>https://juejin.cn/post/7576559408660234292</link>    <guid>https://juejin.cn/post/7576559408660234292</guid>    <pubDate>2025-11-26T06:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576559408660234292" data-draft-id="7576559408660152372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="都React 19了,他到底带来了什么?"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T06:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周尛先森"/> <meta itemprop="url" content="https://juejin.cn/user/3562073402377933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            都React 19了,他到底带来了什么?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073402377933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周尛先森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:50:42.000Z" title="Wed Nov 26 2025 06:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c865216d9814d28a29831d6cbc2def2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1920&amp;h=1080&amp;s=225936&amp;e=webp&amp;b=020e37" alt="src=http___pic1.win4000.com_wallpaper_2020-07-22_5f17fe7fe9959.jpg&amp;refer=http___pic1.win4000 (1).webp" loading="lazy"/></p>
<p>如果你还在 React 应用的 <code>useEffect</code>里写 <code>fetch</code>请求，那你就做错了。我们每天都听到这种说法。但我们应该怎么做才对呢？好吧，事实证明，React 团队已经清楚地听到了我们的声音。React 19.2 不仅仅是修补异步问题——它通过 <code>use()</code>、<code>&lt;Suspense&gt;</code>、<code>useTransition()</code>以及现在的 View Transitions，从头重建了异步处理机制。这些基础构建块共同将异步逻辑从一个"必要的麻烦"转变为一流的架构特性。让我带你了解 React 的异步叙事是如何彻底改变的，以及它为什么对你的团队很重要。</p>
<p><strong>旧方式：useEffect + isLoading</strong></p>
<p>让我们从一个展示旧的 <code>useEffect</code>/ <code>fetch</code>组合模式的例子开始：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageData, setImageData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isPending, setIsPending] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsPending</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">fetchImage</span>(imageId).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-title function_">setImageData</span>(data);
      <span class="hljs-title function_">setIsPending</span>(<span class="hljs-literal">false</span>);
    });
  }, [imageId]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setImageId((id) =&gt; id + 1)}&gt;Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {isPending ? <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> : }
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>（这里的 <code>fetchImage</code>只是 <code>fetch</code>的一个包装函数，以保持示例简短。）</p>
<p>这个模式确实能用，但你做了很多重复性的工作。例如，你管理了三个状态（<code>imageId</code>, <code>imageData</code>, <code>isPending</code>），而实际上你只是想显示一张图片。加载状态逻辑是手动的，错误处理也常常是事后才考虑。而且很可能，你的代码库中每个异步操作看起来都略有不同。</p>
<p>最糟糕的是，那个 <code>useEffect</code>的依赖数组是个隐患。漏掉一个依赖项，你会得到过时的闭包；包含太多依赖项，又会触发无限循环。这是无数生产环境 bug 的根源。</p>
<p>这并不理想，老实说，用这种代码你能做到的最好程度就是"不搞砸"。而这并不是你想要编写的代码类型。</p>
<p><strong>新的异步基础构建块</strong></p>
<p>React 19.2 给我们提供了一种完全不同的方法。我们不再用 <code>useEffect</code>来管理 Promise，而是直接使用 <code>use()</code>和 <code>&lt;Suspense&gt;</code>来处理 Promise。</p>
<p><strong>核心模式：use() + <code>&lt;Suspense&gt;</code></strong></p>
<p>下面是使用 React 新的 <code>use</code>Hook 和 <code>Suspense</code>组件组合重写的同一个组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span>, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Image</span>(<span class="hljs-params">{ imageDataPromise }</span>) {
  <span class="hljs-keyword">const</span> image = <span class="hljs-title function_">use</span>(imageDataPromise);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{image.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>看看这有多简洁。没有 <code>useEffect</code>。没有手动的 <code>isPending</code>状态。父组件中没有条件渲染逻辑。我们存储的是一个 Promise 而不是数据，React 会处理剩下的事情。</p>
<p><strong>但这是如何工作的呢？<code>&lt;Suspense&gt;</code>背后的魔法</strong></p>
<p>当 <code>&lt;Suspense&gt;</code>尝试渲染其子组件时，<code>&lt;Image&gt;</code>组件会调用 <code>use(imageDataPromise)</code>。如果那个 Promise 还没有解决，<code>use()</code>会直接<em>抛出</em>这个 Promise。是的——像抛出异常一样抛出它。</p>
<p>我知道你在想什么："用异常来控制流程？这太奇怪了！"但请听我说，因为这其实非常巧妙。</p>
<p>那个被抛出的 Promise 会向上冒泡穿过组件树，直到被 <code>&lt;Suspense&gt;</code>捕获。<code>&lt;Suspense&gt;</code>于是知道："啊，我的子组件需要从这个 Promise 获取数据。我会显示我的加载状态（fallback），并等待这个 Promise 解决。"</p>
<p>当 Promise 解决后，<code>&lt;Suspense&gt;</code>会重新渲染其子组件，<code>use()</code>返回数据，图片就显示出来了。</p>
<p>这消除了在组件树的每个层级进行条件渲染的需要。加载状态变得声明式，因为你可以用 <code>&lt;Suspense&gt;</code>包装异步组件，并定义在加载时显示什么。React 会处理时机。</p>
<p><strong>更流畅的交互：useTransition() + action</strong></p>
<p>但我们可以让它变得更好。目前，当你点击 "Next Image" 时，按钮在新图片加载期间仍然可点击。这不是很好的用户体验；用户可能会多次点击，造成竞态条件。React 19.2 引入了 action props 和 <code>useTransition()</code>来优雅地处理这种情况：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ action, children }</span>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">action</span>();
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>名为 <code>action</code>的 prop 本身并没有什么特别之处。它只是一个约定，告诉其他开发者这个按钮会将处理器包装在一个过渡（transition）中。</p>
<p><strong>View Transitions：GPU 加速的润色</strong></p>
<p>既然我们谈到了异步的 UI 部分，让我们聊聊 View Transitions。React 19.2（在实验性分支上）添加了对浏览器原生 View Transitions API 的支持。这让你在异步内容加载时能获得如黄油般顺滑的、GPU 加速的动画。而且只需要几行代码。</p>
<p>首先，添加一些 CSS 动画：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> fadeIn {
  <span class="hljs-selector-tag">from</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
  <span class="hljs-selector-tag">to</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
}
<span class="hljs-keyword">@keyframes</span> fadeOut {
  <span class="hljs-selector-tag">from</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-selector-tag">to</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
}
<span class="hljs-keyword">@keyframes</span> pulse {
  <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-number">50%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; }
}

::<span class="hljs-built_in">view-transition-old</span>(image-container) {
  <span class="hljs-attribute">animation</span>: fadeOut <span class="hljs-number">0.3s</span> ease-out;
}
::<span class="hljs-built_in">view-transition-new</span>(image-container) {
  <span class="hljs-attribute">animation</span>: fadeIn <span class="hljs-number">0.3s</span> ease-in;
}
::<span class="hljs-built_in">view-transition-old</span>(button-pulse) {
  <span class="hljs-attribute">animation</span>: pulse <span class="hljs-number">0.3s</span> ease-in-out;
}
</code></pre>
<p>然后将 View Transitions 添加到你的组件中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { experimental_useViewTransition <span class="hljs-keyword">as</span> useViewTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Image</span>(<span class="hljs-params">{ imageDataPromise }</span>) {
  <span class="hljs-keyword">const</span> image = <span class="hljs-title function_">use</span>(imageDataPromise);
  <span class="hljs-keyword">return</span> ;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageSkeleton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"image-skeleton"</span> /&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ action, children, disabled }</span>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
  <span class="hljs-keyword">const</span> viewTransition = <span class="hljs-title function_">useViewTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">action</span>();
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> {<span class="hljs-attr">...viewTransition</span>("<span class="hljs-attr">button-pulse</span>")}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> {<span class="hljs-attr">...useViewTransition</span>("<span class="hljs-attr">image-container</span>")}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>就这样。浏览器会自动处理 GPU 加速的过渡动画。你的骨架屏淡出，你的图片淡入，你的按钮在加载时会脉动。效果非常丝滑，而你几乎没写什么代码。</p>
<p><strong>注意：</strong> ​ 你需要 React 19.2 实验版才能使用此功能：<code>npm install react@experimental react-dom@experimental</code></p>
<p><strong>这对前端团队为何重要</strong></p>
<p>这些改变不仅仅是清理 <code>useEffect</code>/ <code>fetch</code>的烂摊子。它关乎构建一个更优秀的 React，这个 React 终于承认异步是一等公民。</p>
<p>这些模式意味着你的团队编写的代码更容易理解和维护。框架处理了更多事情。UI 响应更迅捷，因为它是按需更新的。你正在利用更多底层框架的能力，为你的应用赋予具有流畅动画的现代感。</p>
<p>这不再是"你爷爷辈的 React"了，是时候让团队开始使用这些新工具了。</p>
<p><strong>关键要点</strong></p>
<ul>
<li>
<p>React 19.2 带来了"无处不在的异步"。</p>
</li>
<li>
<p>这些基础构建块作为一个系统协同工作：</p>
<ul>
<li><code>use()</code>从 Promise 中提取数据</li>
<li><code>&lt;Suspense&gt;</code>声明式地处理加载状态</li>
<li><code>useTransition()</code>免费为你提供加载标志</li>
<li>View Transitions 添加 GPU 加速的润色</li>
</ul>
</li>
<li>
<p>旧方式（<code>useEffect</code>和 <code>fetch</code>）对 React 来说是个严重的痛点，但我们有了很好的替代方案。</p>
</li>
<li>
<p>React 的异步基础构建块意味着更少的代码、更少的 bug 和更好的用户体验。</p>
</li>
<li>
<p>你的团队可以更专注于构建体验，而不是支撑它的底层管道。</p>
</li>
</ul>
<p><strong>非 19.2 的选择：TanStack Query</strong></p>
<p>话虽如此，如果你还没准备好升级到 React 19.2，有一个很好的替代方案：TanStack Query（前身为 React Query）。它适用于任何 React 版本，并为你提供自动缓存、后台重新获取、乐观更新等功能。它是一个久经考验的解决方案，解决了与 React 19.2 异步基础构建块相同的问题，只是 API 不同。有充分的理由说明为什么这么多 React 应用都安装了 <code>react-query</code>。</p>
<p><strong>下一步：React 19.2 引领的前端未来</strong></p>
<p>React 19.2 已经发布。它是稳定的。你应该将其用于生产环境（除了仍在完善中的 View Transitions）。</p>
<p>异步变革已经到来。React 终于解决了它最大的痛点，框架也因此变得更好。</p>
<p>如果你还没有探索过 React 19.2，现在是时候了。在一个副项目上试试 <code>use()</code>和 <code>&lt;Suspense&gt;</code>，看看异步逻辑变得多么简单。你会惊讶于自己以前没有它是怎么过的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端三大权限场景全解析：设计、实现、存储与企业级实践]]></title>    <link>https://juejin.cn/post/7576821684251918379</link>    <guid>https://juejin.cn/post/7576821684251918379</guid>    <pubDate>2025-11-26T09:13:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684251918379" data-draft-id="7576575703166402566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 前端三大权限场景全解析：设计、实现、存储与企业级实践"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-26T09:13:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             前端三大权限场景全解析：设计、实现、存储与企业级实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:13:00.000Z" title="Wed Nov 26 2025 09:13:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    38
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><p>权限控制是前端应用（尤其是中大型系统）的核心安全与体验保障，完整的权限体系需覆盖「路由权限、页面元素权限、接口权限」三大场景。本文结合真实项目落地经验，系统梳理各场景的应用逻辑、实现方案、设计模式与存储安全，补充企业级开发的关键细节与避坑要点。</p>
<h2 data-id="heading-0">一、路由权限：页面访问的 “第一道门槛”</h2>
<h3 data-id="heading-1">1. 核心应用场景</h3>
<ul>
<li><strong>角色差异化访问</strong>：企业后台中，管理员可访问用户管理、系统配置页，运营仅能访问订单管理、商品管理页。</li>
<li><strong>SaaS 多租户定制</strong>：不同租户（客户）开通不同功能模块（如 A 租户有报表分析模块，B 租户无），后端根据租户 ID 返回对应路由。</li>
<li><strong>权限动态变更</strong>：管理员在后台修改用户角色后，前端无需重启应用，实时更新可访问页面。</li>
<li><strong>刷新丢失修复</strong>：单页应用（SPA）刷新后，动态添加的路由会丢失，需重新加载路由配置。</li>
<li><strong>路由懒加载适配</strong>：大型应用中，路由组件体积大，需结合权限预校验实现按需加载，避免无效资源请求。</li>
</ul>
<h3 data-id="heading-2">2. 企业级实现方式</h3>
<h4 data-id="heading-3">（1）混合式路由配置（前端预设 + 后端过滤）</h4>
<p>纯后端返回路由灵活性差，纯前端预设路由难以应对权限变更，实际项目常用混合方案：</p>
<ul>
<li>前端预设「基础路由」（登录页、404 页、首页）和「权限路由模板」（含 meta.permission 标识页面所需权限）。</li>
<li>登录后，后端返回用户「权限标识列表」，前端过滤出可访问的权限路由，动态添加到路由实例。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端预设路由模板</span>
<span class="hljs-keyword">const</span> asyncRoutes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/user-manage'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'UserManage'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/UserManage.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">permission</span>: <span class="hljs-string">'user:manage'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'用户管理'</span> } <span class="hljs-comment">// 页面所需权限标识</span>
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/system-config'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'SystemConfig'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/SystemConfig.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">permission</span>: <span class="hljs-string">'system:config'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'系统配置'</span> }
  }
];

<span class="hljs-comment">// 生成可访问路由（核心逻辑）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">generateAccessibleRoutes</span> = (<span class="hljs-params">permissions</span>) =&gt; {
  <span class="hljs-keyword">return</span> asyncRoutes.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> {
    <span class="hljs-comment">// 无权限标识的路由默认可访问，有权限标识需匹配用户权限</span>
    <span class="hljs-keyword">return</span> !route.<span class="hljs-property">meta</span>?.<span class="hljs-property">permission</span> || permissions.<span class="hljs-title function_">includes</span>(route.<span class="hljs-property">meta</span>.<span class="hljs-property">permission</span>);
  });
};
</code></pre>
<h4 data-id="heading-4">（2）路由守卫的 “责任链校验”</h4>
<p>将登录校验、权限校验、刷新修复等逻辑拆分为独立守卫，按顺序执行，降低耦合：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">router.beforeEach(<span class="hljs-keyword">async</span> (<span class="hljs-keyword">to</span>, <span class="hljs-keyword">from</span>, <span class="hljs-keyword">next</span>) =&gt; {
  <span class="hljs-keyword">const</span> token = localStorage.getItem(<span class="hljs-comment">'token');</span>
  <span class="hljs-keyword">const</span> userPermissions = store.getters.userPermissions;

  // <span class="hljs-number">1</span>. 未登录拦截（责任链第一环）
  <span class="hljs-keyword">if</span> (!token &amp;&amp; <span class="hljs-keyword">to</span>.path !== <span class="hljs-comment">'/login') {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-comment">'/login?redirect=' + to.fullPath); // 记录跳转目标，登录后回跳</span>
  }

  // <span class="hljs-number">2</span>. 已登录但无权限访问（责任链第二环）
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">to</span>.meta.permission &amp;&amp; !userPermissions.includes(<span class="hljs-keyword">to</span>.meta.permission)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-comment">'/403'); // 跳转到自定义无权限页，提升体验</span>
  }

  // <span class="hljs-number">3</span>. 刷新后动态路由丢失修复（责任链第三环）
  <span class="hljs-keyword">if</span> (store.getters.accessRoutes.length === <span class="hljs-number">0</span> &amp;&amp; token) {
    <span class="hljs-keyword">const</span> accessibleRoutes = generateAccessibleRoutes(userPermissions);
    store.dispatch(<span class="hljs-comment">'setAccessRoutes', accessibleRoutes);</span>
    accessibleRoutes.forEach(route =&gt; router.addRoute(route));
    // 重新触发路由跳转，避免空白页
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>({ ...<span class="hljs-keyword">to</span>, replace: <span class="hljs-literal">true</span> });
  }

  <span class="hljs-keyword">next</span>();
});
</code></pre>
<h4 data-id="heading-5">（3）路由独享守卫增强</h4>
<p>针对敏感页面（如财务对账、用户权限配置），添加二次校验：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> routes = [
  {
    path: <span class="hljs-comment">'/financial-reconciliation',</span>
    component: FinancialReconciliation,
    meta: { permission: <span class="hljs-comment">'financial:view' },</span>
    beforeEnter: (<span class="hljs-keyword">to</span>, <span class="hljs-keyword">from</span>, <span class="hljs-keyword">next</span>) =&gt; {
      // 额外校验：仅工作时间可访问
      <span class="hljs-keyword">const</span> hour = <span class="hljs-built_in">new</span> <span class="hljs-type">Date</span>().getHours();
      <span class="hljs-keyword">if</span> (hour &lt; <span class="hljs-number">9</span> || hour &gt; <span class="hljs-number">18</span>) {
        ElMessage.warning(<span class="hljs-comment">'仅工作时间（9:00-18:00）可访问');</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">next</span>(<span class="hljs-keyword">from</span>.path);
      }
      <span class="hljs-keyword">next</span>();
    }
  }
];
</code></pre>
<h3 data-id="heading-6">3. 设计模式</h3>
<ul>
<li><strong>责任链模式</strong>：路由守卫按 “登录校验→权限校验→刷新修复” 的顺序执行，每个守卫负责单一职责，可灵活增删调整。</li>
<li><strong>策略模式</strong>：根据用户角色（如 admin、editor）应用不同的路由过滤策略，例如管理员保留所有权限路由，运营仅保留业务相关路由。</li>
<li><strong>观察者模式</strong>：权限变更时（如管理员修改用户权限），触发路由重新加载事件，更新可访问路由列表。</li>
</ul>
<h3 data-id="heading-7">4. 权限存储与安全性</h3>
<h4 data-id="heading-8">（1）存储方案</h4>
<ul>
<li>路由配置：存储在 Vuex/Pinia（内存），刷新后重新请求后端获取，避免 localStorage 存储敏感路由规则（如接口地址、权限标识）。</li>
<li>用户权限标识：采用 “localStorage（持久化）+ Vuex/Pinia（内存访问）” 双存储，localStorage 确保刷新后不丢失，Vuex/Pinia 提升访问效率。</li>
<li>Token：存储在 localStorage 或 sessionStorage，建议设置过期时间（如 2 小时），降低泄露风险。</li>
</ul>
<h4 data-id="heading-9">（2）安全性保障</h4>
<ul>
<li>权限标识加密：对 localStorage 中的权限标识做简单加密（如 Base64），避免明文泄露（虽不能防破解，但能提升基础安全）。</li>
<li>防 URL 绕过：即使前端隐藏路由，用户直接输入 URL 访问时，后端需对 “页面初始化接口” 做权限校验（如访问<code>/system-config</code>时，后端校验<code>system:config</code>权限）。</li>
<li>敏感路由隐藏：无权限的路由不添加到路由实例，同时在菜单渲染时过滤，避免用户感知未授权功能。</li>
</ul>
<h2 data-id="heading-10">二、页面元素权限：细粒度的 “功能可见性控制”</h2>
<h3 data-id="heading-11">1. 核心应用场景</h3>
<ul>
<li><strong>操作权限差异化</strong>：同一页面中，管理员可看到 “删除用户”“批量导出” 按钮，普通用户仅能看到 “查看详情” 按钮。</li>
<li><strong>数据列权限</strong>：表格中，管理员可查看 “手机号”“身份证号” 列，运营仅能查看 “用户名”“订单号” 列。</li>
<li><strong>复杂权限组合</strong>：按钮显示需满足 “角色为 editor + 拥有 order:edit 权限 + 数据归属本部门” 等多条件组合。</li>
<li><strong>灰度功能发布</strong>：新功能上线时，仅对部分用户（如内部测试账号）显示入口，逐步全量开放。</li>
<li><strong>权限动态更新</strong>：管理员修改用户权限后，页面元素实时刷新（如立即隐藏 “删除” 按钮）。</li>
</ul>
<h3 data-id="heading-12">2. 企业级实现方式</h3>
<h4 data-id="heading-13">（1）权限中心封装（解决碎片化问题）</h4>
<p>构建全局权限中心，统一管理权限校验逻辑，避免散落在各组件中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// src/utils/permissionCenter.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionCenter</span> {
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.permissions = []; <span class="hljs-comment">// 权限码列表（如["user:add", "order:edit"]）</span>
    <span class="hljs-keyword">this</span>.roles = []; <span class="hljs-comment">// 角色列表（如["admin", "editor"]）</span>
    <span class="hljs-keyword">this</span>.customRules = new Map(); <span class="hljs-comment">// 自定义权限规则（应对复杂场景）</span>
    <span class="hljs-keyword">this</span>.cache = new Map(); <span class="hljs-comment">// 校验结果缓存，提升性能</span>
  }

  <span class="hljs-comment">// 初始化权限数据</span>
  <span class="hljs-keyword">init</span>(permissions, roles) {
    <span class="hljs-keyword">this</span>.permissions = permissions;
    <span class="hljs-keyword">this</span>.roles = roles;
    <span class="hljs-keyword">this</span>.cache.clear(); <span class="hljs-comment">// 初始化时清空缓存</span>
  }

  <span class="hljs-comment">// 基础权限校验（权限码匹配）</span>
  hasPermission(code) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache.has(code)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache.<span class="hljs-keyword">get</span>(code);
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">this</span>.permissions.includes(code);
    <span class="hljs-keyword">this</span>.cache.<span class="hljs-keyword">set</span>(code, result); <span class="hljs-comment">// 缓存校验结果</span>
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 角色校验</span>
  hasRole(role) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.roles.includes(role);
  }

  <span class="hljs-comment">// 复杂规则校验（支持多条件组合）</span>
  checkCustomRule(ruleName, ...args) {
    <span class="hljs-keyword">const</span> rule = <span class="hljs-keyword">this</span>.customRules.<span class="hljs-keyword">get</span>(ruleName);
    <span class="hljs-keyword">if</span> (!rule) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> rule(...args);
  }

  <span class="hljs-comment">// 注册自定义规则</span>
  registerCustomRule(ruleName, ruleFn) {
    <span class="hljs-keyword">this</span>.customRules.<span class="hljs-keyword">set</span>(ruleName, ruleFn);
  }

  <span class="hljs-comment">// 权限更新（触发元素重新渲染）</span>
  updatePermissions(permissions, roles) {
    <span class="hljs-keyword">this</span>.<span class="hljs-keyword">init</span>(permissions, roles);
    <span class="hljs-comment">// 触发Vue响应式更新（需结合Vuex/Pinia）</span>
    store.dispatch(<span class="hljs-string">'updateUserPermissions'</span>, { permissions, roles });
  }
}

export default new PermissionCenter();
</code></pre>
<h4 data-id="heading-14">（2）指令 + 组件的双层控制</h4>
<ul>
<li><strong>全局指令（v-perm）</strong> ：负责基础权限校验，快速隐藏无权限元素：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 注册全局权限指令
app.directive('perm', {
  mounted(el, binding) {
    const { value, arg } = binding<span class="hljs-comment">;</span>
    let <span class="hljs-attr">hasAccess</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

    // 支持权限码校验（<span class="hljs-attr">v-perm</span>=<span class="hljs-string">"user:delete"</span>）和自定义规则校验（v-perm:rule=<span class="hljs-string">"xxx"</span>）
    if (<span class="hljs-attr">arg</span> === <span class="hljs-string">'rule'</span>) {
      const { name, args } = value<span class="hljs-comment">;</span>
      <span class="hljs-attr">hasAccess</span> = permissionCenter.checkCustomRule(name, ...args)<span class="hljs-comment">;</span>
    } else {
      <span class="hljs-attr">hasAccess</span> = permissionCenter.hasPermission(value)<span class="hljs-comment">;</span>
    }

    // 无权限时移除元素（避免用户通过DOM操作显示）
    if (!hasAccess) {
      el.parentNode?.removeChild(el)<span class="hljs-comment">;</span>
    }
  },
  // 权限更新时重新校验（如管理员修改权限后）
  updated(el, binding) {
    // 复用mounted逻辑，重新校验权限
    this.mounted(el, binding)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>权限组件（PermissionWrap）</strong> ：应对复杂场景（如多条件组合、权限变更刷新）：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- components/PermissionWrap.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"hasAccess"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> permissionCenter <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/permissionCenter'</span>;

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-comment">// 权限码（单个或数组）</span>
  <span class="hljs-attr">perm</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Array</span>], <span class="hljs-attr">default</span>: <span class="hljs-string">''</span> },
  <span class="hljs-comment">// 角色（单个或数组）</span>
  <span class="hljs-attr">role</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Array</span>], <span class="hljs-attr">default</span>: <span class="hljs-string">''</span> },
  <span class="hljs-comment">// 自定义规则</span>
  <span class="hljs-attr">customRule</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span> }
});

<span class="hljs-comment">// 权限校验逻辑</span>
<span class="hljs-keyword">const</span> hasAccess = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 权限码校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">perm</span>) {
    <span class="hljs-keyword">const</span> perms = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(props.<span class="hljs-property">perm</span>) ? props.<span class="hljs-property">perm</span> : [props.<span class="hljs-property">perm</span>];
    <span class="hljs-keyword">if</span> (!perms.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">perm</span> =&gt;</span> permissionCenter.<span class="hljs-title function_">hasPermission</span>(perm))) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// 角色校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">role</span>) {
    <span class="hljs-keyword">const</span> roles = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(props.<span class="hljs-property">role</span>) ? props.<span class="hljs-property">role</span> : [props.<span class="hljs-property">role</span>];
    <span class="hljs-keyword">if</span> (!roles.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> permissionCenter.<span class="hljs-title function_">hasRole</span>(role))) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// 自定义规则校验</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">customRule</span>) {
    <span class="hljs-keyword">const</span> { name, args } = props.<span class="hljs-property">customRule</span>;
    <span class="hljs-keyword">if</span> (!permissionCenter.<span class="hljs-title function_">checkCustomRule</span>(name, ...args)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-15">（3）页面中使用示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 基础权限按钮 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-perm</span>=<span class="hljs-string">"user:delete"</span>&gt;</span>删除用户<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 角色+权限组合控制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">PermissionWrap</span> <span class="hljs-attr">perm</span>=<span class="hljs-string">"order:export"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"admin"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>批量导出订单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">PermissionWrap</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 复杂自定义规则（仅能操作自己创建的订单） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">PermissionWrap</span> <span class="hljs-attr">:custom-rule</span>=<span class="hljs-string">"{ name: 'canOperateOrder', args: [order] }"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"editOrder(order.id)"</span>&gt;</span>编辑订单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">PermissionWrap</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 表格列权限 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"手机号"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"permissionCenter.hasPermission('user:view:phone')"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"scope"</span>&gt;</span>{{ scope.row.phone }}<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
</code></pre>
<h3 data-id="heading-16">3. 设计模式</h3>
<ul>
<li><strong>装饰器模式</strong>：通过<code>v-perm</code>指令或<code>PermissionWrap</code>组件包装原有元素，添加权限控制逻辑，不修改元素本身代码，符合开闭原则。</li>
<li><strong>组合模式</strong>：将基础权限校验、角色校验、自定义规则校验组合为复杂权限逻辑，支持灵活组合与扩展。</li>
<li><strong>单例模式</strong>：权限中心（PermissionCenter）采用单例设计，确保全应用权限数据一致，避免重复初始化。</li>
</ul>
<h3 data-id="heading-17">4. 权限存储与安全性</h3>
<h4 data-id="heading-18">（1）存储方案</h4>
<ul>
<li>权限码 / 角色列表：存储在 Vuex/Pinia（内存）+ localStorage（持久化），与路由权限共用存储，确保数据一致性。</li>
<li>自定义规则：存储在权限中心实例中（内存），初始化时注册，无需持久化。</li>
<li>校验结果缓存：存储在权限中心的<code>cache</code>属性（内存），页面刷新后清空，避免缓存过期。</li>
</ul>
<h4 data-id="heading-19">（2）安全性保障</h4>
<ul>
<li>防 DOM 篡改：仅用<code>v-if</code>隐藏元素不够，需用<code>el.remove()</code>彻底移除，避免用户通过浏览器控制台修改 DOM 显示无权限元素。</li>
<li>二次校验：按钮点击事件中添加权限二次校验，防止用户通过控制台触发事件：</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">const</span> handleDelete = (userId) =&gt; {
  <span class="hljs-keyword">if</span> (!permissionCenter.hasPermission(<span class="hljs-string">'user:delete'</span>)) {
    ElMessage.<span class="hljs-type">error</span>(<span class="hljs-string">'无删除权限'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 执行删除逻辑</span>
};
</code></pre>
<ul>
<li>权限更新同步：管理员修改用户权限后，前端调用<code>permissionCenter.updatePermissions</code>更新权限数据，触发元素重新渲染。</li>
</ul>
<h2 data-id="heading-20">三、接口权限：系统安全的 “最后一道防线”</h2>
<h3 data-id="heading-21">1. 核心应用场景</h3>
<ul>
<li><strong>敏感操作接口控制</strong>：<code>/api/user/delete</code>（删除用户）、<code>/api/order/update-status</code>（修改订单状态）等高危接口，仅授权角色可调用。</li>
<li><strong>数据范围权限</strong>：<code>/api/order/list</code>接口，管理员返回所有订单，普通用户仅返回自己创建的订单。</li>
<li><strong>接口频率限制</strong>：免费用户调用<code>/api/search</code>接口每分钟最多 10 次，付费用户无限制。</li>
<li><strong>接口版本权限</strong>：新版本接口（如<code>/api/v2/order</code>）仅对已升级版本的租户开放。</li>
<li><strong>Token 失效 / 权限变更处理</strong>：Token 过期或权限被回收时，接口返回 403/401，前端需优雅处理（如登出、刷新 Token）。</li>
</ul>
<h3 data-id="heading-22">2. 企业级实现方式</h3>
<h4 data-id="heading-23">（1）请求 / 响应拦截器的全链路控制</h4>
<ul>
<li><strong>请求拦截器</strong>：添加 Token、权限预判、数据范围参数：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">// 1. 添加Token（鉴权基础）</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
    }

    <span class="hljs-comment">// 2. 接口权限预判（减少无效请求）</span>
    <span class="hljs-keyword">const</span> { url, method } = config;
    <span class="hljs-comment">// 生成接口权限标识（如"DELETE:/api/user/delete" → "user:delete"）</span>
    <span class="hljs-keyword">const</span> apiPerm = <span class="hljs-title function_">generateApiPermissionKey</span>(method, url);
    <span class="hljs-keyword">if</span> (apiPerm &amp;&amp; !permissionCenter.<span class="hljs-title function_">hasPermission</span>(apiPerm)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`无接口权限：<span class="hljs-subst">${apiPerm}</span>`</span>));
    }

    <span class="hljs-comment">// 3. 数据范围参数（配合后端过滤）</span>
    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/order/list'</span>) &amp;&amp; !permissionCenter.<span class="hljs-title function_">hasRole</span>(<span class="hljs-string">'admin'</span>)) {
      config.<span class="hljs-property">params</span> = { ...config.<span class="hljs-property">params</span>, <span class="hljs-attr">creatorId</span>: store.<span class="hljs-property">getters</span>.<span class="hljs-property">userId</span> };
    }

    <span class="hljs-comment">// 4. 幂等性处理（敏感接口防重复调用）</span>
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span>, <span class="hljs-string">'DELETE'</span>].<span class="hljs-title function_">includes</span>(method)) {
      config.<span class="hljs-property">headers</span>[<span class="hljs-string">'X-Request-Id'</span>] = <span class="hljs-title function_">uuidv4</span>();
    }

    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
);
</code></pre>
<ul>
<li><strong>响应拦截器</strong>：处理权限异常、Token 失效：</li>
</ul>
<pre><code class="hljs language-go" lang="go">axios.interceptors.response.use(
  (response) =&gt; {
    <span class="hljs-comment">// 缓存频繁调用的非敏感接口（如用户信息）</span>
    <span class="hljs-keyword">if</span> (response.config.url === <span class="hljs-string">'/api/user/info'</span> &amp;&amp; response.status === <span class="hljs-number">200</span>) {
      store.dispatch(<span class="hljs-string">'cacheUserInfo'</span>, response.data);
    }
    <span class="hljs-keyword">return</span> response;
  },
  (<span class="hljs-type">error</span>) =&gt; {
    <span class="hljs-keyword">const</span> { status, data } = <span class="hljs-type">error</span>.response || {};
    <span class="hljs-keyword">switch</span> (status) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
        <span class="hljs-comment">// Token失效，登出并跳转登录页</span>
        ElMessage.<span class="hljs-type">error</span>(data.msg || <span class="hljs-string">'登录已失效，请重新登录'</span>);
        store.dispatch(<span class="hljs-string">'logout'</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:
        <span class="hljs-comment">// 区分接口权限不足和数据权限不足</span>
        <span class="hljs-keyword">const</span> msg = data.msg || <span class="hljs-string">'无接口访问权限'</span>;
        ElMessage.<span class="hljs-type">error</span>(msg);
        <span class="hljs-comment">// 敏感操作权限不足，可记录日志</span>
        <span class="hljs-keyword">if</span> (msg.includes(<span class="hljs-string">'敏感操作'</span>)) {
          reportPermissionError({ url: <span class="hljs-type">error</span>.config.url, msg });
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">429</span>:
        ElMessage.<span class="hljs-type">error</span>(<span class="hljs-string">'接口调用过于频繁，请稍后再试'</span>);
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> Promise.reject(<span class="hljs-type">error</span>);
  }
);
</code></pre>
<h4 data-id="heading-24">（2）接口权限标识生成规则</h4>
<p>统一接口与权限码的映射关系，避免混乱：</p>
<pre><code class="hljs language-ini" lang="ini">// 生成接口权限标识（method + 接口路径简化）
const <span class="hljs-attr">generateApiPermissionKey</span> = (method, url) =&gt; {
  // 示例：DELETE /api/user/123 → user:delete
  // 示例：GET /api/order/list → order:list
  const <span class="hljs-attr">pathParts</span> = url.replace(/^/api//, <span class="hljs-string">''</span>).split(<span class="hljs-string">'/'</span>)<span class="hljs-comment">;</span>
  if (<span class="hljs-attr">pathParts.length</span> === <span class="hljs-number">0</span>) return <span class="hljs-string">''</span><span class="hljs-comment">;</span>
  const <span class="hljs-attr">resource</span> = pathParts[<span class="hljs-number">0</span>]<span class="hljs-comment">; // 资源名（user/order）</span>
  let <span class="hljs-attr">action</span> = method.toLowerCase()<span class="hljs-comment">; // 操作（get/post/delete）</span>
  // 特殊映射：get列表 → list，get详情 → view
  if (<span class="hljs-attr">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; pathParts.includes(<span class="hljs-string">'list'</span>)) action = <span class="hljs-string">'list'</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; pathParts.length &gt;= <span class="hljs-number">2</span> &amp;&amp; !isNaN(pathParts[<span class="hljs-number">1</span>])) action = <span class="hljs-string">'view'</span><span class="hljs-comment">;</span>
  return `${resource}:${action}`<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-25">3. 设计模式</h3>
<ul>
<li><strong>代理模式</strong>：请求拦截器作为接口调用的代理，统一添加鉴权信息、权限预判、数据范围参数，不修改业务请求代码。</li>
<li><strong>责任链模式</strong>：后端接口校验按 “Token 校验→权限码校验→数据范围校验→频率限制” 的顺序执行，前端响应拦截器按 “401 处理→403 处理→429 处理” 顺序处理异常。</li>
<li><strong>缓存模式</strong>：对非敏感接口结果进行缓存，减少重复请求，提升性能（需在权限变更时清空缓存）。</li>
</ul>
<h3 data-id="heading-26">4. 权限存储与安全性</h3>
<h4 data-id="heading-27">（1）存储方案</h4>
<ul>
<li>Token：存储在 localStorage（持久化）或 sessionStorage（会话级），建议设置<code>HttpOnly</code>和<code>Secure</code>属性（需后端配合），防止 XSS 攻击。</li>
<li>接口权限标识映射规则：前端预设（如<code>user:delete</code>对应<code>/api/user/delete</code>），无需持久化，确保与后端一致。</li>
<li>接口缓存：存储在 Vuex/Pinia（内存），缓存 key 包含用户 ID 和权限标识，避免多用户数据混淆。</li>
</ul>
<h4 data-id="heading-28">（2）安全性保障</h4>
<ul>
<li>后端绝对校验：前端权限预判仅为体验优化，后端必须对每个接口做独立权限校验，防止用户通过 Postman 等工具绕过前端拦截。</li>
<li>Token 加密传输：所有接口采用 HTTPS 协议，Token 在传输过程中加密，避免中间人攻击。</li>
<li>敏感接口二次验证：核心接口（如删除用户、转账）需添加二次验证（如输入密码、短信验证码），即使权限校验通过，也需确认操作意图。</li>
<li>权限日志记录：前端调用敏感接口时，传递操作人、操作时间、IP 地址等信息，后端存储日志，便于安全追溯。</li>
</ul>
<h2 data-id="heading-29">四、限设计的额外关键要点</h2>
<h3 data-id="heading-30">1. 权限可视化配置</h3>
<ul>
<li>管理员通过系统后台的 “权限配置页面”，勾选角色对应的权限（如 “用户管理”→“删除用户”），后端存储角色 - 权限映射关系。</li>
<li>前端渲染 “权限树”，支持按模块折叠 / 展开，便于管理员操作；支持批量分配权限（如给 “运营” 角色分配所有订单相关权限）。</li>
</ul>
<h3 data-id="heading-31">2. 权限动态更新与同步</h3>
<ul>
<li>管理员修改用户权限后，前端通过 WebSocket 或轮询实时获取最新权限，调用<code>permissionCenter.updatePermissions</code>更新数据，无需用户刷新页面。</li>
<li>跨标签页权限同步：通过<code>localStorage</code>监听事件，一个标签页修改权限后，其他标签页自动更新权限状态。</li>
</ul>
<h3 data-id="heading-32">3. 跨端权限统一管理</h3>
<ul>
<li>若项目包含 PC 端、移动端、小程序，设计统一的权限中心（后端），各端共用一套权限码和角色体系（如<code>user:delete</code>在所有端含义一致）。</li>
<li>前端各端复用权限校验逻辑（如<code>permissionCenter</code>工具类），确保权限控制行为一致。</li>
</ul>
<h3 data-id="heading-33">4. 性能优化</h3>
<ul>
<li>权限校验缓存：对频繁校验的权限码（如表格列权限）进行缓存，避免重复计算。</li>
<li>动态路由懒加载：动态添加的路由组件采用懒加载（<code>() =&gt; import('../views/xxx.vue')</code>），减少首屏加载时间。</li>
<li>权限数据批量请求：登录后一次性获取用户角色、权限码、路由配置，避免多次请求后端。</li>
</ul>
<h3 data-id="heading-34">5. 灰度发布与 A/B 测试</h3>
<ul>
<li>权限中心支持 “灰度规则”，如 “用户 ID 在白名单内”“部门为测试部” 的用户可访问新功能路由和按钮。</li>
<li>通过权限配置实现 A/B 测试，给不同用户组分配不同权限，验证功能效果后全量开放。</li>
</ul>
<h2 data-id="heading-35">五、总结</h2>
<h3 data-id="heading-36">1. 权限设计的三层逻辑</h3>
<ul>
<li>前端路由权限：控制 “能否访问页面”，优化用户体验，减少无效请求。</li>
<li>前端元素权限：控制 “能否看到功能”，隐藏无权限元素，避免用户困惑。</li>
<li>后端接口权限：控制 “能否执行操作”，是安全核心，必须绝对可靠。</li>
</ul>
<h3 data-id="heading-37">2. 安全性原则</h3>
<ul>
<li>前端权限是 “体验层”，不能替代后端校验；后端权限是 “安全层”，必须覆盖所有敏感操作。</li>
<li>敏感信息（Token、权限标识）需加密存储和传输，防止泄露。</li>
<li>权限变更需实时同步，避免权限不一致导致的安全隐患。</li>
</ul>
<h3 data-id="heading-38">3. 可扩展性原则</h3>
<ul>
<li>采用设计模式（如责任链、装饰器、单例）降低代码耦合，便于后期扩展权限规则。</li>
<li>预留自定义权限规则接口，应对复杂业务场景（如多条件组合权限）。</li>
<li>权限配置可视化、动态化，减少前端发版频率，提升运营效率。</li>
</ul>
<p>项目中，权限设计并非一成不变，需根据业务规模和安全要求逐步迭代：初期可采用 “角色 + 静态权限”，中期引入 “权限码 + 动态路由”，后期升级为 “可视化配置 + 细粒度数据权限”，最终实现 “安全、灵活、易维护” 的权限体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 cupsd.conf 查看打印服务的配置文件]]></title>    <link>https://juejin.cn/post/7577215663968026666</link>    <guid>https://juejin.cn/post/7577215663968026666</guid>    <pubDate>2025-11-27T10:31:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577215663968026666" data-draft-id="7577204540417753151" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 cupsd.conf 查看打印服务的配置文件"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-27T10:31:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 cupsd.conf 查看打印服务的配置文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:31:38.000Z" title="Thu Nov 27 2025 10:31:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 cupsd.conf 查看打印服务的配置文件</h3>
<pre><code class="hljs language-c" lang="c">root@uos:/var/<span class="hljs-built_in">log</span>/cups<span class="hljs-meta"># cat /etc/cups/cupsd.conf </span>
#
# Configuration file <span class="hljs-keyword">for</span> the CUPS scheduler.  See <span class="hljs-string">"man cupsd.conf"</span> <span class="hljs-keyword">for</span> a
<span class="hljs-meta"># complete description of this file.</span>
#

# Log general information in error_log - change <span class="hljs-string">"warn"</span> to <span class="hljs-string">"debug"</span>
<span class="hljs-meta"># for troubleshooting...</span>
LogLevel warn
PageLogFormat

# Specifies the maximum size of the <span class="hljs-built_in">log</span> files before they are rotated.  The value <span class="hljs-string">"0"</span> disables <span class="hljs-built_in">log</span> rotation.
MaxLogSize <span class="hljs-number">0</span>

# Default error policy <span class="hljs-keyword">for</span> printers
ErrorPolicy retry-job

# Only listen <span class="hljs-keyword">for</span> connections from the local machine.
Listen localhost:<span class="hljs-number">631</span>
Listen /run/cups/cups.sock

# Show shared printers on the local network.
Browsing Yes
BrowseLocalProtocols dnssd

# Default authentication type, when authentication is required...
DefaultAuthType Basic

# Web interface setting...
WebInterface Yes

# Timeout after cupsd exits <span class="hljs-keyword">if</span> <span class="hljs-title function_">idle</span> <span class="hljs-params">(applied only <span class="hljs-keyword">if</span> cupsd runs on-demand - with -l)</span>
IdleExitTimeout 60

# Restrict access to the server...
&lt;Location /&gt;
  Order allow,deny
&lt;/Location&gt;

# Restrict access to the admin pages...
&lt;Location /admin&gt;
  Order allow,deny
&lt;/Location&gt;

# Restrict access to configuration files...
&lt;Location /admin/conf&gt;
  AuthType Default
  Require user @SYSTEM
  Order allow,deny
&lt;/Location&gt;

# Restrict access to <span class="hljs-built_in">log</span> files...
&lt;Location /admin/<span class="hljs-built_in">log</span>&gt;
  AuthType Default
  Require user @SYSTEM
  Order allow,deny
&lt;/Location&gt;

# Set the <span class="hljs-keyword">default</span> printer/job policies...
&lt;Policy <span class="hljs-keyword">default</span>&gt;
  # Job/subscription privacy...
  JobPrivateAccess <span class="hljs-keyword">default</span>
  JobPrivateValues <span class="hljs-keyword">default</span>
  SubscriptionPrivateAccess <span class="hljs-keyword">default</span>
  SubscriptionPrivateValues <span class="hljs-keyword">default</span>

  # Job-related operations must be done by the owner or an administrator...
  &lt;Limit Create-Job Print-Job Print-URI Validate-Job&gt;
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Move-Job&gt;
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit CUPS-Get-Document&gt;
    AuthType Default
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All administration operations require an administrator to authenticate...
  &lt;Limit CUPS-Add-Modify-Printer CUPS-Delete-Printer CUPS-Add-Modify-Class CUPS-Delete-Class CUPS-Set-Default CUPS-Get-Devices&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All printer operations require a printer operator to authenticate...
  &lt;Limit Pause-Printer Resume-Printer Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After Cancel-Jobs CUPS-Accept-Jobs CUPS-Reject-Jobs&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # Only the owner or an administrator can cancel or authenticate a job...
  &lt;Limit Cancel-Job CUPS-Authenticate-Job&gt;
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit All&gt;
    Order deny,allow
  &lt;/Limit&gt;
&lt;/Policy&gt;

# Set the authenticated printer/job policies...
&lt;Policy authenticated&gt;
  # Job/subscription privacy...
  JobPrivateAccess <span class="hljs-keyword">default</span>
  JobPrivateValues <span class="hljs-keyword">default</span>
  SubscriptionPrivateAccess <span class="hljs-keyword">default</span>
  SubscriptionPrivateValues <span class="hljs-keyword">default</span>

  # Job-related operations must be done by the owner or an administrator...
  &lt;Limit Create-Job Print-Job Print-URI Validate-Job&gt;
    AuthType Default
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Move-Job CUPS-Get-Document&gt;
    AuthType Default
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All administration operations require an administrator to authenticate...
  &lt;Limit CUPS-Add-Modify-Printer CUPS-Delete-Printer CUPS-Add-Modify-Class CUPS-Delete-Class CUPS-Set-Default&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All printer operations require a printer operator to authenticate...
  &lt;Limit Pause-Printer Resume-Printer Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After Cancel-Jobs CUPS-Accept-Jobs CUPS-Reject-Jobs&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # Only the owner or an administrator can cancel or authenticate a job...
  &lt;Limit Cancel-Job CUPS-Authenticate-Job&gt;
    AuthType Default
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit All&gt;
    Order deny,allow
  &lt;/Limit&gt;
&lt;/Policy&gt;

# Set the kerberized printer/job policies...
&lt;Policy kerberos&gt;
  # Job/subscription privacy...
  JobPrivateAccess <span class="hljs-keyword">default</span>
  JobPrivateValues <span class="hljs-keyword">default</span>
  SubscriptionPrivateAccess <span class="hljs-keyword">default</span>
  SubscriptionPrivateValues <span class="hljs-keyword">default</span>

  # Job-related operations must be done by the owner or an administrator...
  &lt;Limit Create-Job Print-Job Print-URI Validate-Job&gt;
    AuthType Negotiate
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Move-Job CUPS-Get-Document&gt;
    AuthType Negotiate
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All administration operations require an administrator to authenticate...
  &lt;Limit CUPS-Add-Modify-Printer CUPS-Delete-Printer CUPS-Add-Modify-Class CUPS-Delete-Class CUPS-Set-Default&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All printer operations require a printer operator to authenticate...
  &lt;Limit Pause-Printer Resume-Printer Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After Cancel-Jobs CUPS-Accept-Jobs CUPS-Reject-Jobs&gt;
    AuthType Default
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # Only the owner or an administrator can cancel or authenticate a job...
  &lt;Limit Cancel-Job CUPS-Authenticate-Job&gt;
    AuthType Negotiate
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit All&gt;
    Order deny,allow
  &lt;/Limit&gt;
&lt;/Policy&gt;
root@uos:/var/<span class="hljs-built_in">log</span>/cups# 
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[电子书阅读器：解析 EPUB 底层原理与实战]]></title>    <link>https://juejin.cn/post/7576841976927567908</link>    <guid>https://juejin.cn/post/7576841976927567908</guid>    <pubDate>2025-11-26T08:25:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576841976927567908" data-draft-id="7576487832089804815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="电子书阅读器：解析 EPUB 底层原理与实战"/> <meta itemprop="keywords" content="Android,HTML"/> <meta itemprop="datePublished" content="2025-11-26T08:25:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            电子书阅读器：解析 EPUB 底层原理与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:25:44.000Z" title="Wed Nov 26 2025 08:25:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>当我们想要开发一个电子书阅读器时，不可避免地会遇到 EPUB 格式。</p>
<p>其实，EPUB 并不复杂，只要掌握了 XML 解析和 HTML 处理，就能够写出一个高性能、轻量级的解析引擎。</p>
<p>我们先从最基础的解析工具开始。</p>
<h2 data-id="heading-1">XmlPullParser</h2>
<p>EPUB 的核心元数据文件（<code>.opf</code>）和容器描述文件（<code>.xml</code>），本质上都是 XML。Android 官方推荐使用 <code>XmlPullParser</code> 来解析它们。</p>
<h3 data-id="heading-2">什么是 Pull 解析？</h3>
<p>Pull 解析就是一行行往下读取，这种方式内存占用低。</p>
<p>与之相对的有 DOM 解析，它是一次性将整个文件读入内存，它的优点是快，但对内存极度不友好。</p>
<h3 data-id="heading-3">事件循环</h3>
<p><code>XmlPullParser</code> 的工作模式其实就是一个 while 循环，不断处理当前的<strong>事件类型</strong>：</p>
<ul>
<li><code>START_DOCUMENT</code>: 开始</li>
<li><code>START_TAG</code>: 读到了开始标签</li>
<li><code>TEXT</code>: 读到了标签里的文字</li>
<li><code>END_TAG</code>: 读到了结束标签</li>
<li><code>END_DOCUMENT</code>: 结束</li>
</ul>
<h3 data-id="heading-4">实战</h3>
<p>了解完以上内容，就可以开始解析一段 XML 了。</p>
<p>以下面这段 XML 为例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">student</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">student</span>&gt;</span>
</code></pre>
<blockquote>
<p>作为 <code>student_data.xml</code> 文件存放在 <code>app/src/main/assets</code> 目录下。</p>
</blockquote>
<p>在 <code>MainActivity</code> 中使用 <code>XmlPullParser</code> 来解析：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>(<span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>)

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseStudentXml</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>)</span></span>: Student? = withContext(Dispatchers.IO) { <span class="hljs-comment">// 将耗时操作放在 IO 线程中</span>
    <span class="hljs-comment">// 创建 Pull 解析器</span>
    <span class="hljs-keyword">val</span> parser = Xml.newPullParser()
    <span class="hljs-keyword">var</span> student: Student? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">try</span> {
        parser.setInput(inputStream, <span class="hljs-string">"UTF-8"</span>)
        <span class="hljs-keyword">var</span> eventType = parser.eventType

        <span class="hljs-keyword">var</span> currentName = <span class="hljs-string">""</span>
        <span class="hljs-keyword">var</span> currentAge = <span class="hljs-number">0</span>

        Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"开始解析 XML 文档..."</span>)
        <span class="hljs-keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) {
            <span class="hljs-keyword">when</span> (eventType) {
                XmlPullParser.START_TAG -&gt; {
                    <span class="hljs-comment">// 获取标签名</span>
                    <span class="hljs-keyword">when</span> (parser.name) {
                        <span class="hljs-string">"student"</span> -&gt; {
                            Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"遇到标签 student"</span>)
                        }
                        <span class="hljs-comment">// 获取标签内容, 并移到标签末位</span>
                        <span class="hljs-string">"name"</span> -&gt; {
                            Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"遇到标签 name"</span>)
                            currentName = parser.nextText()
                        }
                        <span class="hljs-string">"age"</span> -&gt; {
                            Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"遇到标签 age"</span>)
                            currentAge = parser.nextText().toIntOrNull() ?: <span class="hljs-number">0</span>
                        }
                    }
                }
            }
            <span class="hljs-comment">// 获取下一个事件</span>
            eventType = parser.next()
        }

        student = Student(currentName, currentAge)
        Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"解析成功: <span class="hljs-variable">$student</span>"</span>)

    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Log.e(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"解析失败"</span>, e)
    } <span class="hljs-keyword">finally</span> {
        inputStream.close()
    }

    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> student
}


<span class="hljs-comment">// 调用示例</span>
lifecycleScope.launch {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> inputStream = assets.<span class="hljs-keyword">open</span>(<span class="hljs-string">"student_data.xml"</span>)
        <span class="hljs-keyword">val</span> student = parseStudentXml(inputStream)
    } <span class="hljs-keyword">catch</span> (e: IOException) {
        e.printStackTrace()
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-ini" lang="ini">开始解析 XML 文档...
遇到标签 student
遇到标签 name
遇到标签 age
解析成功: Student(<span class="hljs-attr">name</span>=张三, age=<span class="hljs-number">18</span>)
</code></pre>
<h3 data-id="heading-5">nextText() 陷阱</h3>
<p><code>nextText()</code> 会读取当前标签的内容，并移动到标签末尾 <code>END_TAG</code>。</p>
<ul>
<li>
<p>如果标签内容是空的，那么它会返回空串 ""。</p>
</li>
<li>
<p>如果标签还嵌套了标签，那么它可能会抛出异常或导致数据丢失。</p>
</li>
</ul>
<p>例如，我们将上述的 XML 内容改为：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">student</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>张<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>三
    <span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">age</span>&gt;</span>18<span class="hljs-tag">&lt;/<span class="hljs-name">age</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">student</span>&gt;</span>
</code></pre>
<p>此时运行程序，会报错：</p>
<pre><code class="hljs language-less" lang="less">解析失败                                                        <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.xmlpull</span><span class="hljs-selector-class">.v1</span><span class="hljs-selector-class">.XmlPullParserException</span>: <span class="hljs-selector-tag">END_TAG</span> <span class="hljs-selector-tag">expected</span> (<span class="hljs-attribute">position</span>:START_TAG (empty) &lt;br&gt;<span class="hljs-variable">@2</span>:<span class="hljs-number">18</span> in java.io.InputStreamReader<span class="hljs-variable">@352bfed</span>) 
</code></pre>
<p>意思是说在期望找到一个结束标签时，却遇到了一个开始标签 <code>&lt;br</code>。但我们认为的 <code>&lt;br /&gt;</code> 只是一个换行符，应该被当作文本内容进行处理。</p>
<p>这时，我们需要手动处理 TEXT 事件。</p>
<blockquote>
<p>标签之间的换行符也是一个 TEXT 事件。</p>
</blockquote>
<h4 data-id="heading-6">手动处理 TEXT 事件</h4>
<p>手动处理 <code>TEXT</code> 事件时，为了解决 XML 嵌套导致的状态丢失问题，我们需要引入栈来维护状态。我们推荐使用 <code>ArrayDeque</code> 来替换 <code>Stack</code>，性能更好。</p>
<p>逻辑流程：</p>
<ul>
<li>
<p><strong>START_TAG</strong>：将当前标签名压入状态栈中。</p>
</li>
<li>
<p><strong>TEXT</strong>：检查栈顶元素，如果是目标标签，就提取并拼接文本；如果是目标标签的子标签，根据业务逻辑判断是否需要提取。</p>
</li>
<li>
<p><strong>END_TAG</strong>：弹出栈顶元素，回到最近一层的父标签的状态。</p>
</li>
</ul>
<p>代码实现：<strong>基于栈的状态机</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseStudentXmlManual</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>)</span></span>: Student? =
    withContext(Dispatchers.IO) {
        <span class="hljs-keyword">val</span> parser = Xml.newPullParser()
        <span class="hljs-keyword">var</span> student: Student? = <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 用 ArrayDeque 代替 Stack</span>
        <span class="hljs-keyword">val</span> stateStack = ArrayDeque&lt;String&gt;()

        <span class="hljs-keyword">try</span> {
            parser.setInput(inputStream, <span class="hljs-string">"UTF-8"</span>)
            <span class="hljs-keyword">var</span> eventType = parser.eventType
            <span class="hljs-keyword">val</span> sbName = StringBuilder()
            <span class="hljs-keyword">var</span> age = <span class="hljs-number">0</span>

            <span class="hljs-keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) {
                <span class="hljs-keyword">when</span> (eventType) {
                    XmlPullParser.START_TAG -&gt; {
                        <span class="hljs-keyword">val</span> tagName = parser.name
                        <span class="hljs-comment">// 存入新状态</span>
                        stateStack.addLast(tagName)
                    }

                    XmlPullParser.TEXT -&gt; {
                        <span class="hljs-comment">// 获取当前文本内容</span>
                        <span class="hljs-keyword">val</span> text = parser.text
                        <span class="hljs-keyword">if</span> (!text.isNullOrBlank()) {
                            <span class="hljs-comment">// 查看栈顶，决定了当前文本属于谁</span>
                            <span class="hljs-keyword">if</span> (stateStack.isNotEmpty()) {
                                <span class="hljs-keyword">val</span> currentTag = stateStack.last() <span class="hljs-comment">// 获取当前所处的最近一层标签</span>

                                <span class="hljs-keyword">when</span> (currentTag) {
                                    <span class="hljs-string">"name"</span> -&gt; sbName.append(text.trim())
                                    <span class="hljs-string">"br"</span> -&gt; { <span class="hljs-comment">/* 忽略 */</span>
                                    }

                                    <span class="hljs-string">"age"</span> -&gt; age = text.trim().toIntOrNull() ?: <span class="hljs-number">0</span>
                                }
                            }
                        }
                    }

                    XmlPullParser.END_TAG -&gt; {
                        <span class="hljs-comment">// 恢复到上一个状态</span>
                        <span class="hljs-keyword">if</span> (stateStack.isNotEmpty()) {
                            stateStack.removeLast()
                        }
                    }
                }
                eventType = parser.next()
            }

            <span class="hljs-keyword">val</span> name: String = sbName.toString()
            student = Student(name, age)
            Log.d(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"解析成功: <span class="hljs-variable">$student</span>"</span>)

        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"XmlDemo"</span>, <span class="hljs-string">"解析失败"</span>, e)
        } <span class="hljs-keyword">finally</span> {
            inputStream.close()
        }

        <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> student
    }
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-ini" lang="ini">解析成功: Student(<span class="hljs-attr">name</span>=张三, age=<span class="hljs-number">18</span>)
</code></pre>
<h2 data-id="heading-7">Jsoup</h2>
<p>EPUB 的正文内容其实就是网页（XHTML/HTML）。对于解析 HTML，我们不会去使用 <code>XmlPullParser</code>，因为它嵌套很复杂，并且标签常常不闭合。</p>
<p>这时，我们会使用 Jsoup 来解析。</p>
<p>它能将杂乱的 HTML 修正为标准的 DOM 树，并且有着 CSS 选择器：可以像写 CSS 样式一样查找元素。</p>
<h3 data-id="heading-8">CSS 选择器</h3>
<p>提取数据非常容易：</p>
<ul>
<li>
<p>选取所有一级标题：<code>doc.select("h1")</code>。</p>
</li>
<li>
<p>选取所有带图片路径的 img 标签：<code>doc.select("img[src]")</code>。</p>
</li>
</ul>
<h3 data-id="heading-9">实战</h3>
<p>假设要解析如下 HTML 文件，我们需要提取标题、作者和正文内容，去除掉正文中的广告。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Android 性能优化实战 - 技术周刊<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"nav"</span>&gt;</span>首页 &gt; Android &gt; 性能优化<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"post"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"post-title"</span>&gt;</span>Android 内存优化：从入门到精通<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"meta-info"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>作者：Android专家<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>阅读：1024<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"post-content"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
                    在 Android 开发中，<span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>内存泄漏<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span>是导致应用卡顿的主要原因之一。
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ad-banner"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>广告：点击领取高薪面试题库！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
                    使用 <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://square.github.io/leakcanary/"</span>&gt;</span>LeakCanary<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> 工具，可以帮助我们快速定位 <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>Activity<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 和 <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>Fragment<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 的泄漏点。
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>只有深入理解 GC 机制，才能写出健壮的代码。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Copyright © 2022 技术博客<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>首先引入依赖：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    implementation(<span class="hljs-string">"org.jsoup:jsoup:1.21.2"</span>)
}
</code></pre>
<p>代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Blog</span>(
    <span class="hljs-keyword">val</span> title: String,
    <span class="hljs-keyword">val</span> author: String,
    <span class="hljs-keyword">val</span> content: String,
)

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseHtmlContent</span><span class="hljs-params">(
    inputStream: <span class="hljs-type">InputStream</span>
)</span></span> = withContext(Dispatchers.IO) {
    <span class="hljs-comment">// 解析 HTML 为 Document 对象</span>
    <span class="hljs-keyword">val</span> doc: Document = Jsoup.parse(inputStream, <span class="hljs-string">"UTF-8"</span>, <span class="hljs-string">""</span>)

    <span class="hljs-comment">// 提取标题</span>
    <span class="hljs-keyword">val</span> title = doc.select(<span class="hljs-string">"h1.post-title"</span>).text()

    <span class="hljs-comment">// 提取作者</span>
    <span class="hljs-keyword">val</span> author = doc.selectFirst(<span class="hljs-string">"div.meta-info"</span>)?.text()
            ?.substringAfter(<span class="hljs-string">"作者："</span>)
            ?.substringBefore(<span class="hljs-string">"阅读："</span>)
            ?.trim()
            ?: <span class="hljs-string">"未知"</span>

    <span class="hljs-keyword">val</span> contentDiv = doc.select(<span class="hljs-string">"div.post-content"</span>)

    <span class="hljs-comment">// 先去除广告节点</span>
    contentDiv.select(<span class="hljs-string">".ad-banner"</span>).remove()

    <span class="hljs-comment">// 获取内容</span>
    <span class="hljs-keyword">val</span> content = contentDiv.text()

    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> Blog(title, author, content)
}

<span class="hljs-comment">// 使用示例</span>
lifecycleScope.launch(Dispatchers.IO) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> inputStream = assets.<span class="hljs-keyword">open</span>(<span class="hljs-string">"blog.html"</span>)
        <span class="hljs-keyword">val</span> blog = parseHtmlContent(inputStream)
        Log.d(<span class="hljs-string">"EpubTest"</span>, <span class="hljs-string">"Blog: <span class="hljs-variable">$blog</span>"</span>)
    } <span class="hljs-keyword">catch</span> (e: IOException) {
        e.printStackTrace()
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-ini" lang="ini">Blog: Blog(<span class="hljs-attr">title</span>=Android 内存优化：从入门到精通, author=Android专家, content=在 Android 开发中，内存泄漏是导致应用卡顿的主要原因之一。 使用 LeakCanary 工具，可以帮助我们快速定位 Activity 和 Fragment 的泄漏点。 只有深入理解 GC 机制，才能写出健壮的代码。)
</code></pre>
<h3 data-id="heading-10">DOM 遍历与节点操作</h3>
<p>直接使用 <code>text()</code>，确实很方便，它能自动处理换行。但它也会将 <code>&lt;b&gt;</code>, <code>&lt;a&gt;</code> 等标签剥离，导致加粗、斜体等样式也都丢失了。</p>
<p>这时，我们可以手动遍历 DOM 树来手动处理特定标签，代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseHtmlContent</span><span class="hljs-params">(
    inputStream: <span class="hljs-type">InputStream</span>
)</span></span> = withContext(Dispatchers.IO) {
    <span class="hljs-keyword">val</span> doc: Document = Jsoup.parse(inputStream, <span class="hljs-string">"UTF-8"</span>, <span class="hljs-string">""</span>)
    <span class="hljs-keyword">val</span> title = doc.select(<span class="hljs-string">"h1.post-title"</span>).text()

    <span class="hljs-comment">// 提取作者</span>
    <span class="hljs-keyword">val</span> author = doc.selectFirst(<span class="hljs-string">"div.meta-info"</span>)?.text()
        ?.substringAfter(<span class="hljs-string">"作者："</span>)
        ?.substringBefore(<span class="hljs-string">"阅读："</span>)
        ?.trim()
        ?: <span class="hljs-string">"未知"</span>

    <span class="hljs-keyword">val</span> sbContent = StringBuilder()

    <span class="hljs-keyword">val</span> contentDiv = doc.select(<span class="hljs-string">"div.post-content"</span>).first()
    <span class="hljs-comment">// 移除广告节点</span>
    contentDiv?.select(<span class="hljs-string">".ad-banner"</span>)?.remove()

    contentDiv?.let {
        <span class="hljs-comment">// 遍历容器的子节点</span>
        <span class="hljs-keyword">for</span> (node <span class="hljs-keyword">in</span> it.childNodes()) {
            traverseNode(node, sbContent)
        }
    }
    <span class="hljs-keyword">val</span> content = sbContent.toString().trim()

    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> Blog(title, author, content)
}

<span class="hljs-comment">/**
 * 递归遍历节点树
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">traverseNode</span><span class="hljs-params">(
    node: <span class="hljs-type">Node</span>,
    sb: <span class="hljs-type">StringBuilder</span>
)</span></span> {
    <span class="hljs-keyword">when</span> (node) {
        <span class="hljs-comment">// 纯文本节点</span>
        <span class="hljs-keyword">is</span> TextNode -&gt; {
            <span class="hljs-keyword">val</span> text = node.text().trim()
            <span class="hljs-keyword">if</span> (text.isNotBlank()) {
                sb.append(text)
            }
        }
        <span class="hljs-comment">// 元素节点</span>
        <span class="hljs-keyword">is</span> Element -&gt; {
            <span class="hljs-keyword">when</span> (node.tagName()) {
                <span class="hljs-string">"p"</span> -&gt; { <span class="hljs-comment">// 段落</span>
                    sb.append(<span class="hljs-string">"\n"</span>)
                    node.childNodes().forEach { traverseNode(it, sb) }
                }

                <span class="hljs-string">"div"</span>, <span class="hljs-string">"span"</span> -&gt; { <span class="hljs-comment">// 容器</span>
                    node.childNodes().forEach { traverseNode(it, sb) }
                }

                <span class="hljs-string">"b"</span>, <span class="hljs-string">"strong"</span> -&gt; {
                    sb.append(<span class="hljs-string">"[加粗: "</span>)
                    node.childNodes().forEach { traverseNode(it, sb) }
                    sb.append(<span class="hljs-string">"]"</span>)
                }

                <span class="hljs-string">"i"</span>, <span class="hljs-string">"em"</span> -&gt; {
                    sb.append(<span class="hljs-string">"[斜体: "</span>)
                    node.childNodes().forEach { traverseNode(it, sb) }
                    sb.append(<span class="hljs-string">"]"</span>)
                }

                <span class="hljs-string">"a"</span> -&gt; {
                    <span class="hljs-keyword">val</span> href = node.attr(<span class="hljs-string">"href"</span>)
                    sb.append(<span class="hljs-string">"[链接(<span class="hljs-variable">$href</span>): "</span>)
                    node.childNodes().forEach { traverseNode(it, sb) }
                    sb.append(<span class="hljs-string">"]"</span>)
                }

                <span class="hljs-keyword">else</span> -&gt; {}
            }
        }
    }
}
</code></pre>
<p>解析出的内容：</p>
<pre><code class="hljs language-css" lang="css">在 Android 开发中，<span class="hljs-selector-attr">[加粗: 内存泄漏]</span>是导致应用卡顿的主要原因之一。
使用<span class="hljs-selector-attr">[链接(https://square.github.io/leakcanary/): LeakCanary]</span>工具，可以帮助我们快速定位<span class="hljs-selector-attr">[斜体: Activity]</span>和<span class="hljs-selector-attr">[斜体: Fragment]</span>的泄漏点。
只有深入理解 GC 机制，才能写出健壮的代码。
</code></pre>
<blockquote>
<p>在实际开发中，我们会使用 <code>SpannableStringBuilder</code> 来拼接结果，比如遇到 <code>&lt;b&gt;</code> 标签时应用 <code>StyleSpan(Typeface.BOLD)</code>，这样可以直接在 UI 组件中显示富文本效果。</p>
</blockquote>
<h2 data-id="heading-11">EPUB 的组成</h2>
<p>EPUB 电子书本质上就是一个 ZIP 压缩包，你可以将其后缀改为 .zip 并解压，查看其目录结构：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">eBook</span>/
├── <span class="hljs-selector-tag">META-INF</span>/
│   └── <span class="hljs-selector-tag">container</span><span class="hljs-selector-class">.xml</span>      (入口)
├── <span class="hljs-selector-tag">OEBPS</span>/                 
│   ├── <span class="hljs-selector-tag">content</span><span class="hljs-selector-class">.opf</span>        (核心)
│   ├── <span class="hljs-selector-tag">nav</span><span class="hljs-selector-class">.xhtml</span>          (导航)  
│   ├── <span class="hljs-selector-tag">toc</span><span class="hljs-selector-class">.ncx</span>            (目录)
│   ├── <span class="hljs-selector-tag">Styles</span>/            (样式)
│   ├── <span class="hljs-selector-tag">Text</span>/              (正文)
│   └── <span class="hljs-selector-tag">Images</span>/            (图片)
└── <span class="hljs-selector-tag">mimetype</span>               (身份标识)
</code></pre>
<h3 data-id="heading-12">关键文件：META-INF/container.xml</h3>
<p>它的作用是告诉我们核心描述文件（.opf）的位置。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"urn:oasis:names:tc:opendocument:xmlns:container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rootfiles</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">rootfile</span> <span class="hljs-attr">full-path</span>=<span class="hljs-string">"OEBPS/content.opf"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/oebps-package+xml"</span>/&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">rootfiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span>
</code></pre>
<p>我们只需使用 <code>XmlPullParser</code> 读取 <code>full-path</code> 属性，就能拿到文件路径 "OEBPS/content.opf"。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseContainer</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>)</span></span>: String? = withContext(Dispatchers.IO) {
    <span class="hljs-keyword">val</span> xmlPullParser = Xml.newPullParser()

    xmlPullParser.setInput(inputStream, <span class="hljs-string">"UTF-8"</span>)
    <span class="hljs-keyword">var</span> eventType = xmlPullParser.eventType

    <span class="hljs-keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) {
        <span class="hljs-keyword">when</span> (eventType) {
            XmlPullParser.START_TAG -&gt; {
                <span class="hljs-keyword">val</span> tagName = xmlPullParser.name
                <span class="hljs-keyword">if</span> (tagName == <span class="hljs-string">"rootfile"</span>) {
                    <span class="hljs-keyword">val</span> rootFilePath = xmlPullParser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"full-path"</span>)
                    Log.d(<span class="hljs-string">"ContainerRootFilePath"</span>, <span class="hljs-string">"rootFilePath: <span class="hljs-variable">$rootFilePath</span>"</span>)
                    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> rootFilePath
                }
            }
        }
        eventType = xmlPullParser.next()
    }
    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-literal">null</span>
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-bash" lang="bash">rootFilePath: OEBPS/content.opf
</code></pre>
<h3 data-id="heading-13">关键文件：opf 文件</h3>
<p>OPF 文件也是一个 XML，它存着书籍的重要信息：</p>
<ul>
<li><strong><code>&lt;metadata&gt;</code></strong>：元数据。书名、作者、标识符、简介、语言、简介、出版社、分类、封面等。</li>
<li><strong><code>&lt;mainfest&gt;</code></strong>：资源清单。书中的所有文件都要在此进行注册，每一项（<code>item</code>）都有着 <code>href</code>、<code>id</code>、<code>media-type</code>。</li>
<li><strong><code>spine</code></strong>：书脊。它引用了资源清单里面的 id，定义了书的阅读顺序。</li>
</ul>
<h4 data-id="heading-14">OPF 示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.idpf.org/2007/opf"</span> <span class="hljs-attr">unique-identifier</span>=<span class="hljs-string">"BookId"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"3.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">metadata</span> <span class="hljs-attr">xmlns:dc</span>=<span class="hljs-string">"http://purl.org/dc/elements/1.1/"</span> <span class="hljs-attr">xmlns:opf</span>=<span class="hljs-string">"http://www.idpf.org/2007/opf"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:title</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id"</span>&gt;</span>男女之间存在纯友情吗？（不，不存在！） 第一卷 Flag1.不然到三十岁还单身就跟我在一起吧？<span class="hljs-tag">&lt;/<span class="hljs-name">dc:title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id-2"</span>&gt;</span>七菜なな<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id-3"</span>&gt;</span>Parum<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span>&gt;</span>calibre:19525<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span>&gt;</span>uuid:77842cae-a0d7-4144-9f4d-9ca1a73b2129<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BookId"</span> <span class="hljs-attr">opf:scheme</span>=<span class="hljs-string">"UUID"</span>&gt;</span>urn:uuid:52746820-f83f-11ee-bf6c-08bfb888ec3a<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:source</span>&gt;</span>https://www.wenku8.cc/book/3103.htm<span class="hljs-tag">&lt;/<span class="hljs-name">dc:source</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:language</span>&gt;</span>zh<span class="hljs-tag">&lt;/<span class="hljs-name">dc:language</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:contributor</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id-1"</span>&gt;</span>calibre (7.0.0) [https://calibre-ebook.com]<span class="hljs-tag">&lt;/<span class="hljs-name">dc:contributor</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:description</span>&gt;</span>在某一所乡村国中，一对男女向彼此立下永恒友情的誓言。
朝着同一个梦想前进，成为命运共同体的两人之间──
关系并没有任何特别的发展，就这么度过了两年的岁月……！
至今都还没谈过初恋的 High 咖女子──犬冢日葵，
以及热爱花卉的植物男子──夏目悠宇，
就算升上高中二年级，还是一样在只有两人的园艺社中，平和地当着挚友。
然而这时，悠宇跟初恋对象重逢，使得两人之间的关系开始失控？
究竟「已经懂得恋慕之心」的日葵，能不能摆脱「理想挚友」的身份呢？<span class="hljs-tag">&lt;/<span class="hljs-name">dc:description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:publisher</span>&gt;</span>电击文库<span class="hljs-tag">&lt;/<span class="hljs-name">dc:publisher</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>校园<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>青春<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>恋爱<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>后宫<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:subject</span>&gt;</span>欢乐向<span class="hljs-tag">&lt;/<span class="hljs-name">dc:subject</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"title-type"</span>&gt;</span>main<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"file-as"</span>&gt;</span>男女之间存在纯友情吗？（不，不存在！） 第一卷 Flag1.不然到三十岁还单身就跟我在一起吧？<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cover"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"img157909.jpg"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-1"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"role"</span> <span class="hljs-attr">scheme</span>=<span class="hljs-string">"marc:relators"</span>&gt;</span>bkp<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-2"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"role"</span> <span class="hljs-attr">scheme</span>=<span class="hljs-string">"marc:relators"</span>&gt;</span>aut<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-2"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"file-as"</span>&gt;</span>七菜なな<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-3"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"role"</span> <span class="hljs-attr">scheme</span>=<span class="hljs-string">"marc:relators"</span>&gt;</span>aut<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-3"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"file-as"</span>&gt;</span>Parum<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"belongs-to-collection"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"id-4"</span>&gt;</span>男女之间存在纯友情吗？（不，不存在！）<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-4"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"collection-type"</span>&gt;</span>series<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">opf:meta</span> <span class="hljs-attr">refines</span>=<span class="hljs-string">"#id-4"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"group-position"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">opf:meta</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">metadata</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Text/Cover.xhtml"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Cover.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Text/chapter0.xhtml"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chapter0.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Text/chapter1.xhtml"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chapter1.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Text/Credits.xhtml"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Credits.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"nav"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"nav.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> <span class="hljs-attr">properties</span>=<span class="hljs-string">"nav"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"toc.ncx"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"ncxuks"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/x-dtbncx+xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Styles/style.css"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"style.css"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"text/css"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Images/157909.jpg"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"img157909.jpg"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"image/jpeg"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"Images/157910.jpg"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"img157910.jpg"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"image/jpeg"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">spine</span> <span class="hljs-attr">toc</span>=<span class="hljs-string">"ncxuks"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"Cover.xhtml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"chapter0.xhtml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"chapter1.xhtml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"Credits.xhtml"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">spine</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span>
</code></pre>
<p>定义数据类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 书籍元数据
 */</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookMetadata</span>(
    <span class="hljs-keyword">val</span> title: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> authors: List&lt;String&gt; = emptyList(),
    <span class="hljs-keyword">val</span> description: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> language: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> cover: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> publisher: String = <span class="hljs-string">""</span>,
    <span class="hljs-keyword">val</span> categories: List&lt;String&gt; = emptyList(),
)

<span class="hljs-comment">/**
 * 书籍目录顺序
 */</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookSpineItem</span>(
    <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> href: String,
    <span class="hljs-keyword">val</span> mediaType: String,
)

<span class="hljs-comment">// 临时存储 manifest 数据</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ManifestItem</span>(<span class="hljs-keyword">val</span> href: String, <span class="hljs-keyword">val</span> mediaType: String)
</code></pre>
<p>因为元数据封面和书脊都使用了 ID 引用，所以我们可以先解析 <code>Manifest</code>，构建出一个映射表，再来解析 <code>Metadata</code> 和 <code>Spine</code>，这样更加清晰。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseOpf</span><span class="hljs-params">(inputStream: <span class="hljs-type">InputStream</span>)</span></span>: Pair&lt;BookMetadata, List&lt;BookSpineItem&gt;&gt; {
    <span class="hljs-keyword">val</span> parser = Xml.newPullParser()
    parser.setInput(inputStream, <span class="hljs-string">"UTF-8"</span>)
    <span class="hljs-comment">// 开启命名空间处理，这样 parser.name 会返回 "title" 而不是 "dc:title"，不包含 dc: 前缀</span>
    parser.setFeature(XmlPullParser.FEATURE_PROCESS_NAMESPACES, <span class="hljs-literal">true</span>)

    <span class="hljs-keyword">var</span> eventType = parser.eventType

    <span class="hljs-comment">// 映射表：ID -&gt; ManifestItem</span>
    <span class="hljs-keyword">val</span> manifestMap = mutableMapOf&lt;String, ManifestItem&gt;()

    <span class="hljs-comment">// 书籍元数据</span>
    <span class="hljs-keyword">var</span> title = <span class="hljs-string">""</span>
    <span class="hljs-keyword">val</span> authors = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> description = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> language = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> publisher = <span class="hljs-string">""</span>
    <span class="hljs-keyword">val</span> categories = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> coverId = <span class="hljs-string">""</span> <span class="hljs-comment">// 封面 ID</span>

    <span class="hljs-comment">// 脊骨列表：只存 ID 引用，稍后解析</span>
    <span class="hljs-keyword">val</span> spineIdRefs = mutableListOf&lt;String&gt;()

    <span class="hljs-keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) {
        <span class="hljs-keyword">when</span> (eventType) {
            XmlPullParser.START_TAG -&gt; {
                <span class="hljs-keyword">val</span> tagName = parser.name

                <span class="hljs-keyword">when</span> (tagName) {
                    <span class="hljs-comment">// 处理元数据 (Metadata)</span>
                    <span class="hljs-string">"title"</span> -&gt; title = safeNextText(parser)
                    <span class="hljs-string">"creator"</span> -&gt; authors.add(safeNextText(parser))
                    <span class="hljs-string">"description"</span> -&gt; description = safeNextText(parser)
                    <span class="hljs-string">"language"</span> -&gt; language = safeNextText(parser)
                    <span class="hljs-string">"publisher"</span> -&gt; publisher = safeNextText(parser)
                    <span class="hljs-string">"subject"</span> -&gt; categories.add(safeNextText(parser))

                    <span class="hljs-string">"meta"</span> -&gt; {
                        <span class="hljs-comment">// 处理封面：&lt;meta name="cover" content="img157909.jpg"/&gt;</span>
                        <span class="hljs-keyword">val</span> nameAttr = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"name"</span>)
                        <span class="hljs-keyword">if</span> (nameAttr == <span class="hljs-string">"cover"</span>) {
                            coverId = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"content"</span>)
                        }
                    }

                    <span class="hljs-comment">// 处理清单 (Manifest)</span>
                    <span class="hljs-string">"item"</span> -&gt; {
                        <span class="hljs-comment">// &lt;item id="..." href="..." media-type="..."/&gt;</span>
                        <span class="hljs-keyword">val</span> id = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"id"</span>)
                        <span class="hljs-keyword">val</span> href = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"href"</span>)
                        <span class="hljs-keyword">val</span> mediaType = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"media-type"</span>)

                        <span class="hljs-keyword">if</span> (id != <span class="hljs-literal">null</span> &amp;&amp; href != <span class="hljs-literal">null</span> &amp;&amp; mediaType != <span class="hljs-literal">null</span>) {
                            manifestMap[id] = ManifestItem(href, mediaType)
                        }
                    }

                    <span class="hljs-comment">// --- 3. 处理脊骨 (Spine) ---</span>
                    <span class="hljs-string">"itemref"</span> -&gt; {
                        <span class="hljs-comment">// &lt;itemref idref="..."/&gt;</span>
                        <span class="hljs-keyword">val</span> idref = parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"idref"</span>)
                        <span class="hljs-keyword">if</span> (idref != <span class="hljs-literal">null</span>) {
                            spineIdRefs.add(idref)
                        }
                    }
                }
            }
        }
        eventType = parser.next()
    }


    <span class="hljs-comment">// 解析封面路径：利用 coverId 从 manifestMap 查找真实路径</span>
    <span class="hljs-keyword">val</span> finalCoverPath = coverId.let { id -&gt;
        manifestMap[id]?.href
    } ?: <span class="hljs-string">""</span>

    <span class="hljs-keyword">val</span> metadata = BookMetadata(
        title = title,
        authors = authors,
        description = description,
        language = language,
        cover = finalCoverPath, <span class="hljs-comment">// 真实路径</span>
        publisher = publisher,
        categories = categories
    )

    <span class="hljs-keyword">val</span> bookSpineItems = spineIdRefs.mapNotNull { idref -&gt;
        <span class="hljs-keyword">val</span> item = manifestMap[idref]
        <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span>) {
            BookSpineItem(
                id = idref,
                href = item.href,
                mediaType = item.mediaType
            )
        } <span class="hljs-keyword">else</span> {
            Log.w(<span class="hljs-string">"OpfParser"</span>, <span class="hljs-string">"Spine item '<span class="hljs-variable">$idref</span>' not found in manifest."</span>)
            <span class="hljs-literal">null</span>
        }
    }

    <span class="hljs-keyword">return</span> Pair(metadata, bookSpineItems)
}

<span class="hljs-comment">// 防止空标签导致异常</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">safeNextText</span><span class="hljs-params">(parser: <span class="hljs-type">XmlPullParser</span>)</span></span>: String {
    <span class="hljs-keyword">var</span> result = <span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> (parser.next() == XmlPullParser.TEXT) {
        result = parser.text
        parser.nextTag() <span class="hljs-comment">// 移至 END_TAG</span>
    }
    <span class="hljs-keyword">return</span> result
}
</code></pre>
<p>测试：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">lifecycleScope.launch(Dispatchers.IO) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> inputStream = assets.<span class="hljs-keyword">open</span>(<span class="hljs-string">"OEBPS/content.opf"</span>)

        <span class="hljs-keyword">val</span> (metadata, spine) = parseOpf(inputStream)

        println(<span class="hljs-string">"=== 书籍信息 ==="</span>)
        println(<span class="hljs-string">"标题: <span class="hljs-subst">${metadata.title}</span>"</span>)
        println(<span class="hljs-string">"作者: <span class="hljs-subst">${metadata.authors}</span>"</span>)
        println(<span class="hljs-string">"封面路径: <span class="hljs-subst">${metadata.cover}</span>"</span>)
        println(<span class="hljs-string">"简介: <span class="hljs-subst">${metadata.description.take(<span class="hljs-number">100</span>)}</span>..."</span>)

        println(<span class="hljs-string">"\n=== 章节列表 (Spine) ==="</span>)
        spine.forEach { item -&gt;
            println(<span class="hljs-string">"ID: <span class="hljs-subst">${item.id.padEnd(<span class="hljs-number">15</span>)}</span> | Type: <span class="hljs-subst">${item.mediaType.padEnd(<span class="hljs-number">25</span>)}</span> | Path: <span class="hljs-subst">${item.href}</span>"</span>)
        }
    } <span class="hljs-keyword">catch</span> (e: IOException) {
        e.printStackTrace()
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">===</span> <span class="hljs-string">书籍信息</span> <span class="hljs-string">===</span>
<span class="hljs-string">标题:</span> <span class="hljs-string">男女之间存在纯友情吗？（不，不存在！）</span> <span class="hljs-string">第一卷</span> <span class="hljs-string">Flag1.不然到三十岁还单身就跟我在一起吧？</span>
<span class="hljs-string">作者:</span> [<span class="hljs-string">七菜なな</span>, <span class="hljs-string">Parum</span>]
<span class="hljs-string">封面路径:</span> <span class="hljs-string">Images/157909.jpg</span>
<span class="hljs-string">简介:</span> <span class="hljs-string">在某一所乡村国中，一对男女向彼此立下永恒友情的誓言。</span>
<span class="hljs-string">朝着同一个梦想前进，成为命运共同体的两人之间──</span>
<span class="hljs-string">关系并没有任何特别的发展，就这么度过了两年的岁月……！</span>
<span class="hljs-string">至今都还没谈过初恋的</span> <span class="hljs-string">High</span> <span class="hljs-string">咖女子─...</span>
<span class="hljs-string">===</span> <span class="hljs-string">章节列表</span> <span class="hljs-string">(Spine)</span> <span class="hljs-string">===</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">Cover.xhtml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/Cover.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter0.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter0.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter1.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter1.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter2.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter2.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter3.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter3.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter4.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter4.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter5.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter5.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter6.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter6.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">chapter7.xhtml</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/chapter7.xhtml</span>
<span class="hljs-attr">ID:</span> <span class="hljs-string">Credits.xhtml</span>   <span class="hljs-string">|</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">application/xhtml+xml</span>     <span class="hljs-string">|</span> <span class="hljs-attr">Path:</span> <span class="hljs-string">Text/Credits.xhtml</span>
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>关于解析的内容就到这里，我们来总结一下 EPUB 阅读器的解析流程：</p>
<ol>
<li>获取 EPUB 电子书的 Uri。</li>
<li>使用 <code>ZipInputStream</code> 读取这个压缩文件（节省空间）。</li>
<li>在 Zip 流中找到 <code>META-INF/container.xml</code> 文件，解析出 <code>.opf</code> 文件的相对路径。</li>
<li>从 OPF 文件中解析出书籍元数据，以及阅读顺序（书籍目录）。</li>
<li>最后，在渲染内容时，根据路径找到内容文件，使用 <code>Jsoup</code> 解析 HTML 即可。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 16：02. 基于 Tauri 2.0 开发后台管理系统-项目初始化配置]]></title>    <link>https://juejin.cn/post/7576821684252016683</link>    <guid>https://juejin.cn/post/7576821684252016683</guid>    <pubDate>2025-11-26T09:24:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684252016683" data-draft-id="7576841976927993892" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 16：02. 基于 Tauri 2.0 开发后台管理系统-项目初始化配置"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-26T09:24:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 16：02. 基于 Tauri 2.0 开发后台管理系统-项目初始化配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T09:24:52.000Z" title="Wed Nov 26 2025 09:24:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c35e9c8d2f43f09a8c45c7858d7513~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=vVZYOE1xotETMxheo5tMCO8v%2FXg%3D" alt="image-20251126172101658" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>在开始写代码之前，我已经将官网上的核心概念大致扫了一遍，<a href="https://link.juejin.cn?target=https%3A%2F%2Ftauri.app%2Fzh-cn%2Fconcept%2F%25EF%25BC%258C%25E8%25AF%25B4%25E5%25AE%259E%25E8%25AF%259D%25EF%25BC%258C%25E4%25B8%258D%25E7%259F%25A5%25E6%2589%2580%25E4%25BA%2591%25EF%25BC%258C%25E4%25B8%258E%25E6%2588%2591%25E4%25B9%258B%25E5%2589%258D%25E7%2586%259F%25E6%2582%2589%25E7%259A%2584" target="_blank" title="https://tauri.app/zh-cn/concept/%EF%BC%8C%E8%AF%B4%E5%AE%9E%E8%AF%9D%EF%BC%8C%E4%B8%8D%E7%9F%A5%E6%89%80%E4%BA%91%EF%BC%8C%E4%B8%8E%E6%88%91%E4%B9%8B%E5%89%8D%E7%86%9F%E6%82%89%E7%9A%84" ref="nofollow noopener noreferrer">tauri.app/zh-cn/conce…</a> <code>web</code> 端相差甚远，不过我好像摸到了一些门路，以下都是我个人见解，可能有所偏差，欢迎指正。<code>Tauri</code> 开发的应用程序分为两个部分，前端和后端，其实本质上也是 C/S 架构。前端就和之前 <code>web</code> 开发一样，你可以选择自己擅长的 UI 框架，而后端则是基于 <code>Rust</code> 来做的，可以完成业务逻辑操作，系统调用等等。我的脑海里目前结构是这样的，对应代码的目录，前端就是 <code>src</code> 下的代码，后端就是 <code>src-tauri</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb6e3236740745338f15aafefbba6ac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=hwimUXiBU0In96rVZE4EX9B3l6w%3D" alt="image-20251126112339786" loading="lazy"/></p>
<p>看到这其实就比较熟悉了，把 <code>Rust</code> 换成我们熟悉的 <code>Java</code>，又回到了 <code>web</code> 开发的模式了。当然如果你愿意深入学习 <code>Rust</code>，完全用 <code>Rust</code> 来构建服务端也是可以的。</p>
<p>所以最后实际上我的项目就变成了这样。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d6d0b6d4eaa48878d653b986e55d88c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=n835ZsPkv2diTIKKQT99%2Bg01KA8%3D" alt="image-20251126113509775" loading="lazy"/></p>
<p>这就很熟悉了，<code>Tauri</code> 似乎只是简单的套壳了。后来仔细想想好像也不是，相比于 <code>Web</code> 端多了一些访问系统原生 <code>Api</code> 的能力。</p>
<p>✅ <strong>Vue3</strong>：前端开发体验好</p>
<p>✅ <strong>Java 后端</strong>：成熟稳定，开发效率高</p>
<p>✅ <strong>Tauri</strong>：提供桌面应用外壳，未来可扩展系统功能</p>
<h2 data-id="heading-1">二、技术栈选择</h2>
<h3 data-id="heading-2">前端（Tauri）：</h3>
<ul>
<li>Vue3 + TypeScript</li>
<li>UI 组件库：Ant Design  Vue</li>
<li>HTTP 客户端：axios</li>
<li>状态管理：Pinia</li>
</ul>
<h3 data-id="heading-3">后端（Java）：</h3>
<ul>
<li>
<p>Spring Boot + Sa-Token</p>
</li>
<li>
<p>数据库：PostgreSQL + MyBatis-Plus</p>
</li>
<li>
<p>API 文档：Swagger</p>
</li>
<li>
<p>部署：Docker + 云服务器</p>
</li>
</ul>
<blockquote>
<p>截止目前 2025.11.26 我会使用当前所有最新稳定版本进行开发。我建议是我当前的文章作为辅助，以官方文档为主，我会在关键位置给出文档链接。</p>
</blockquote>
<h2 data-id="heading-4">三、完成前后端数据交互</h2>
<h3 data-id="heading-5">3.1. 目录机构规划</h3>
<p>首先和常规 <code>Vue</code> 项目一样，规划好我们的目录结构，大致如下</p>
<pre><code class="hljs language-bash" lang="bash">src               
├─ api            <span class="hljs-comment"># API 接口   </span>
├─ assets          <span class="hljs-comment"># 静态资源</span>
├─ components       <span class="hljs-comment"># 通用组件   </span>
├─ layouts         <span class="hljs-comment"># 布局组件     </span>
├─ router          <span class="hljs-comment"># 路由配置  </span>
├─ stores      		 <span class="hljs-comment"># 状态管理(Pinia)  </span>
├─ utils      		 <span class="hljs-comment"># 工具函数 </span>
├─ views     		 <span class="hljs-comment"># 页面组件     </span>
├─ App.vue        
├─ main.ts        
└─ vite-env.d.ts  

</code></pre>
<h3 data-id="heading-6">3.2. 安装整合常用依赖</h3>
<p>安装所有依赖</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Vue 生态</span>
pnpm add vue-router@4 pinia pinia-plugin-persistedstate
<span class="hljs-comment"># UI 组件库 (Ant Design Vue)</span>
pnpm add ant-design-vue@4.x @ant-design/icons-vue
<span class="hljs-comment"># 样式预处理</span>
pnpm add install less 
<span class="hljs-comment"># HTTP 客户端</span>
pnpm add install axios
</code></pre>
<p>一键安装所有</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add vue-router@4 pinia pinia-plugin-persistedstate ant-design-vue@4.x @ant-design/icons-vue less  axios
</code></pre>
<h4 data-id="heading-7">3.2.1. 整合 Ant Design Vue</h4>
<blockquote>
<p>这里我希望能够实现自动按需导入，官方文档这里写的不够清楚，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.antdv.com%2Fdocs%2Fvue%2Fgetting-started-cn%25E3%2580%2582%25E6%2588%2591%25E4%25BB%25AC%25E5%258F%25AF%25E4%25BB%25A5%25E5%2580%259F%25E5%258A%25A9" target="_blank" title="https://www.antdv.com/docs/vue/getting-started-cn%E3%80%82%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%80%9F%E5%8A%A9" ref="nofollow noopener noreferrer">www.antdv.com/docs/vue/ge…</a> <code>unplugin-vue-components</code> 和 <code>unplugin-auto-import</code>这两款插件来完成。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">pnpm install -D unplugin-vue-components unplugin-auto-import
</code></pre>
<p>在插件的 <code>GitHub</code> 仓库中可以看到是支持的，所以无需担心。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funplugin%2Funplugin-auto-import" target="_blank" title="https://github.com/unplugin/unplugin-auto-import" ref="nofollow noopener noreferrer">github.com/unplugin/un…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funplugin%2Funplugin-vue-components" target="_blank" title="https://github.com/unplugin/unplugin-vue-components" ref="nofollow noopener noreferrer">github.com/unplugin/un…</a></p>
<p><strong>在 <code>vite.config.js</code> 中配置按需引入：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AntDesignVueResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/resolvers'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// ...</span>
    <span class="hljs-title class_">AutoImport</span>({
      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">AntDesignVueResolver</span>()],
    }),
    <span class="hljs-title class_">Components</span>({
      <span class="hljs-attr">resolvers</span>: [
        <span class="hljs-title class_">AntDesignVueResolver</span>({
           <span class="hljs-attr">importStyle</span>: <span class="hljs-string">'less'</span>, <span class="hljs-comment">// 使用 less</span>
        }),
      ],
    }),
  ],
})
</code></pre>
<blockquote>
<p>这里要注意， 必须用 <code>less</code></p>
</blockquote>
<p>随便找一个组件，测试一下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0834b46076024be48455c818b6b990ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=6%2FMVZNzjYD68VOeuynUf2SxCwIU%3D" alt="image-20251126153900116" loading="lazy"/></p>
<h4 data-id="heading-8">3.2.2. 整合 Vue Router</h4>
<p>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Finstallation.html" target="_blank" title="https://router.vuejs.org/zh/installation.html" ref="nofollow noopener noreferrer">router.vuejs.org/zh/installa…</a></p>
<p>创建路由实例 <code>router/index.js</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">HomeView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./HomeView.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AboutView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./AboutView.vue'</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
    <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>),
    <span class="hljs-attr">routes</span>: [
        { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HomeView</span> },
        { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">AboutView</span> },
    ]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router

</code></pre>
<blockquote>
<p>为了方便测试，我定义了两个页面组件。</p>
</blockquote>
<p><code>main.ts</code> 中注册路由</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./App.vue"</span>;
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>


<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">"#app"</span>);

</code></pre>
<p>在 <code>app.vue</code> 中测试</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;h1&gt;Hello App!&lt;/h1&gt;
  &lt;p&gt;&lt;strong&gt;Current route path:&lt;/strong&gt; {{ $route.fullPath }}&lt;/p&gt;
  &lt;nav&gt;
    &lt;RouterLink to="/"&gt;Go to Home&lt;/RouterLink&gt;
    &lt;RouterLink to="/about"&gt;Go to About&lt;/RouterLink&gt;
  &lt;/nav&gt;
  &lt;main&gt;
    &lt;RouterView /&gt;
  &lt;/main&gt;
&lt;/template&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8e06f1842ad4659a32549bc0cae73bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=25BdHKyoEbylpWLuWo%2B3MDabM1c%3D" alt="PixPin_2025-11-26_16-14-56.gif" loading="lazy"/></p>
<h4 data-id="heading-9">3.2.3. 整合 pinia &amp; pinia-plugin-persistedstate</h4>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2Fzh%2Fintroduction.html" target="_blank" title="https://pinia.vuejs.org/zh/introduction.html" ref="nofollow noopener noreferrer">pinia.vuejs.org/zh/introduc…</a></p>
<p><strong>按模块化定义 store</strong>，以下为目录结构</p>
<pre><code class="hljs">stores         
├─ modules     
│  └─ user.ts  
└─ index.ts    
</code></pre>
<ul>
<li>创建 <code>src/stores/index.ts</code></li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store
</code></pre>
<ul>
<li><code>main.ts</code> 里引入</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//main.ts</span>
...
<span class="hljs-comment">// 引入 pinia</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./stores'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(store)
...
</code></pre>
<ul>
<li>modules: 按模块定义对应的 store, user.ts 表示用户相关数据存储的仓库</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// user.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-comment">// 你可以对 `defineStore()` 的返回值进行任意命名，但最好使用 store 的名字，同时以 `use` 开头且以 `Store` 结尾。(比如 `useUserStore`，`useCartStore`，`useProductStore`)</span>
<span class="hljs-comment">// 第一个参数是你的应用中 Store 的唯一 ID。</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserInfoStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'userInfo'</span>, {
    <span class="hljs-comment">// 其他配置...</span>
})
</code></pre>
<blockquote>
<p><strong>在引入 pinia 的时候做一些调整，不直接在 main.ts 里引入，这样做的好处在于，之后对于 pinia 集成一些插件，或者做一些其他配置，可以独立出来，不用全部堆积在 main.ts 中</strong></p>
</blockquote>
<ul>
<li>使用 <code>pinia-plugin-persistedstate</code> 持久化</li>
</ul>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpraz.codeberg.page%2Fpinia-plugin-persistedstate%2Fguide%2F%23usage" target="_blank" title="https://praz.codeberg.page/pinia-plugin-persistedstate/guide/#usage" ref="nofollow noopener noreferrer">praz.codeberg.page/pinia-plugi…</a></p>
<blockquote>
<p>在 <code>web</code> 端的时候可以用 <code>LocalStorage</code>、<code>SessionStorage</code> 等，但是桌面端我就不确定了，我去搜了一下，据说是支持 <code>LocalStorage</code> 的，但是有局限性，推荐了一个 <code>Tauri Store</code>，这个等到具体使用的时候再去研究，今天任务就是先整合上。</p>
</blockquote>
<p>将插件添加到 <code>pinia</code> 实例上</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ./stores/index.ts</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>()

store.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store
</code></pre>
<p>只需要在定义的 <code>store</code> 里开启配置即可完成持久化操作</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserInfoStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'userInfo'</span>, {
    <span class="hljs-comment">// 其他配置...</span>
    <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span>   
})
</code></pre>
<blockquote>
<p>默认使用的就是 <code>LocalStorage</code>，这里我暂时不测试了，等到用的时候替换为 <code>Tauri Store</code> 再研究。</p>
</blockquote>
<h4 data-id="heading-10">3.2.4. 整合 Axios</h4>
<p>定义请求实例，这里我直接从之前项目中拷贝过来的，基本上都差不多。</p>
<p>创建 <code>utils/request.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant-design-vue'</span>
<span class="hljs-keyword">import</span> axios, { <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosInstance</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosRequestConfig</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">RequestConfig</span>&lt;T = <span class="hljs-built_in">unknown</span>&gt; = <span class="hljs-title class_">AxiosRequestConfig</span> &amp; {
    <span class="hljs-comment">// 可以在这里扩展自定义配置</span>
    mock?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 是否使用mock数据</span>
    mockData?: T <span class="hljs-comment">// mock数据</span>
    noErrorToast?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 是否不显示错误提示</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Request</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">AxiosInstance</span> <span class="hljs-comment">// axios实例</span>

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span> = axios.<span class="hljs-title function_">create</span>({
            <span class="hljs-attr">baseURL</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_APP_BASE_API</span>,
            <span class="hljs-attr">timeout</span>: <span class="hljs-number">180000</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json;charset=UTF-8'</span>,
            },
        })

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupInterceptors</span>()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">setupInterceptors</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 请求拦截器</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
            <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> config,
            <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error),
        )

        <span class="hljs-comment">// 响应拦截器</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
            <span class="hljs-function">(<span class="hljs-params">response: AxiosResponse</span>) =&gt;</span> {
                <span class="hljs-comment">// 业务状态码处理</span>
                <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> !== <span class="hljs-number">200</span>) {
                    <span class="hljs-keyword">const</span> config = response.<span class="hljs-property">config</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">RequestConfig</span>
                    <span class="hljs-keyword">if</span> (!config.<span class="hljs-property">noErrorToast</span>) {
                        message.<span class="hljs-title function_">error</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>)
                    }
                    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(response.<span class="hljs-property">data</span>)
                }
                <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>
            },
            <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
                <span class="hljs-comment">// 处理mock数据</span>
                <span class="hljs-keyword">if</span> (error.<span class="hljs-property">isMock</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(error.<span class="hljs-property">data</span>)
                }
                <span class="hljs-keyword">const</span> config = error.<span class="hljs-property">config</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">RequestConfig</span> | <span class="hljs-literal">undefined</span>

                <span class="hljs-comment">// 只有配置了不跳过错误处理时才显示错误提示</span>
                <span class="hljs-keyword">if</span> (!config?.<span class="hljs-property">noErrorToast</span>) {
                    <span class="hljs-keyword">let</span> msg = <span class="hljs-string">'请求错误'</span>
                    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>) {
                        <span class="hljs-keyword">switch</span> (error.<span class="hljs-property">response</span>.<span class="hljs-property">status</span>) {
                            <span class="hljs-keyword">case</span> <span class="hljs-number">400</span>:
                                msg = <span class="hljs-string">'请求参数错误'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
                                msg = <span class="hljs-string">'未授权，请登录'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:
                                msg = <span class="hljs-string">'拒绝访问'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:
                                msg = <span class="hljs-string">'请求资源不存在'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
                                msg = <span class="hljs-string">'服务器异常，请稍后再试'</span>
                                <span class="hljs-keyword">break</span>
                            <span class="hljs-attr">default</span>:
                                msg = error.<span class="hljs-property">response</span>.<span class="hljs-property">data</span>?.<span class="hljs-property">message</span> || <span class="hljs-string">`服务器错误: <span class="hljs-subst">${error.response.status}</span>`</span>
                        }
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">request</span>) {
                        msg = <span class="hljs-string">'请求超时或网络异常'</span>
                    } <span class="hljs-keyword">else</span> {
                        msg = error.<span class="hljs-property">message</span> || <span class="hljs-string">'未知错误'</span>
                    }
                    message.<span class="hljs-title function_">error</span>(msg)
                }
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
            },
        )
    }

    <span class="hljs-comment">// 封装核心请求方法</span>
    <span class="hljs-keyword">public</span> request&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">config</span>: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-comment">// 模拟数据直接返回</span>
        <span class="hljs-keyword">if</span> (config.<span class="hljs-property">mock</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(config.<span class="hljs-property">mockData</span> <span class="hljs-keyword">as</span> T)
        }

        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">instance</span>(config)
    }

    <span class="hljs-keyword">public</span> get&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, config?: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ ...config, <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>, url })
    }

    <span class="hljs-keyword">public</span> post&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">unknown</span>, config?: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ ...config, <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>, url, data })
    }

    <span class="hljs-keyword">public</span> put&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">unknown</span>, config?: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ ...config, <span class="hljs-attr">method</span>: <span class="hljs-string">'PUT'</span>, url, data })
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">delete</span>&lt;T = <span class="hljs-built_in">unknown</span>&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">unknown</span>, config?: <span class="hljs-title class_">RequestConfig</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ ...config, <span class="hljs-attr">method</span>: <span class="hljs-string">'DELETE'</span>, url, data })
    }
}

<span class="hljs-keyword">const</span> http = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> http

</code></pre>
<p>定义个接口测试一下</p>
<p>创建 <code>api/user.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/request'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userApi = {
    <span class="hljs-comment">// 获取用户列表</span>
    <span class="hljs-attr">getUserInfo</span>: <span class="hljs-function">() =&gt;</span>
        http.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/user/info'</span>),

}
</code></pre>
<p>在 <code>app.vue</code> 中测试</p>
<pre><code class="hljs language-vue" lang="vue">&lt;a-button type="primary" @click="getUserInfo"&gt;获取用户信息&lt;/a-button&gt;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { userApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'./api/user'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
  userApi.<span class="hljs-title function_">getUserInfo</span>()
}

&lt;/script&gt;
</code></pre>
<p>在应用窗口点击按钮，按 <code>F12</code>，看到请求出去了，即表示成功了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c94b2860a83481989b65ee375b7eab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764753891&amp;x-signature=9AHuJDg4NYLVweMEeAH43fnOW3Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">四、总结</h2>
<p>到头来发现又回到了熟悉的领域，如果你不想做成桌面端，直接使用 vue 脚手架搭建项目，所有整合步骤几乎一模一样。今天就先这样，现在有个问题，先做前端用 <code>mock</code> 数据做接口，完成基础功能后，再开发服务端，还是直接同时进行。如果有人看到这里，你希望采用哪种方式呢？欢迎留言。</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CopilotKit-丝滑连接agent和应用-理论篇]]></title>    <link>https://juejin.cn/post/7576646142315495465</link>    <guid>https://juejin.cn/post/7576646142315495465</guid>    <pubDate>2025-11-26T03:11:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646142315495465" data-draft-id="7573486671296790570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CopilotKit-丝滑连接agent和应用-理论篇"/> <meta itemprop="keywords" content="前端,Agent,AI编程"/> <meta itemprop="datePublished" content="2025-11-26T03:11:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="let_code"/> <meta itemprop="url" content="https://juejin.cn/user/4265760847307678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CopilotKit-丝滑连接agent和应用-理论篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4265760847307678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    let_code
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:11:52.000Z" title="Wed Nov 26 2025 03:11:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CopilotKit是什么</h2>
<p><code>CopilotKit</code> 将应用的逻辑、状态和用户上下文连接到 <code>AI</code> 代理。提供了构建、部署和监控 <code>AI</code> 辅助功能的工具，这些功能感觉直观、有用且深度集成。</p>
<h2 data-id="heading-1">CopilotKit特点</h2>
<ul>
<li><code>Generative UI</code>(生成式 UI)：使用自定义 UI 组件实时呈现<code>agent</code>的状态、进度、输出和工具调用。</li>
<li><code>Human in the Loop</code>(人机协同)：用户可以在关键点指导<code>agent</code>。实现更可靠的输出。</li>
<li><code>Shared State</code>(共享状态)：agent和应用状态保持同步。<code>agent</code>可以查看应用中的所有状态，应用可以实时响应<code>agent</code>。</li>
</ul>
<h2 data-id="heading-2">CopilotKit和LangGraph的关系</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adb67101b1754134b048eda4e40a8540~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGV0X2NvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764731511&amp;x-signature=NOWH6B6nYzD30Eb%2BjSq1maA7XRM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">聊天组件</h2>
<p>前三个组件由<code>@copilotkit/react-ui</code>提供。</p>
<ol>
<li><code>CopilotChat</code> ：灵活的聊天界面组件。</li>
<li><code>CopilotSidebar</code> ：可折叠和扩展的侧边栏聊天组件。</li>
<li><code>CopilotPopup</code> ： 可以打开和关闭的浮动聊天组件。</li>
<li><code>HeadLess UI</code> : 支持自定义组件。
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useCopilotChat } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Role</span>, <span class="hljs-title class_">TextMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/runtime-client-gql"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CustomChatInterface</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">const</span> {
    visibleMessages,
    appendMessage,
    setMessages,
    deleteMessage,
    reloadMessages,
    stopGeneration,
    isLoading,
} = <span class="hljs-title function_">useCopilotChat</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMessage</span> = (<span class="hljs-params">content: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-title function_">appendMessage</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>({ content, <span class="hljs-attr">role</span>: <span class="hljs-title class_">Role</span>.<span class="hljs-property">User</span> }));
};

<span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    {/* Implement your custom chat UI here */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-4">设置聊天组件的样式</h3>
<ul>
<li>样式：主要思路是通过<strong>样式覆盖</strong>的方式进行组件样式的设定。支持通过css变量、css类的方式进行组件样式和字体的定义。</li>
<li>图标：通过组件的<code>icons</code>属性进行定义。</li>
<li>标签：通过组件的<code>labels</code>属性进行自定义。</li>
</ul>
<p>具体类名、变量名、icons属性、labels属性<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.copilotkit.ai%2Flanggraph%2Fcustom-look-and-feel%2Fcustomize-built-in-ui-components%23css-variables-easiest" target="_blank" title="https://docs.copilotkit.ai/langgraph/custom-look-and-feel/customize-built-in-ui-components#css-variables-easiest" ref="nofollow noopener noreferrer">参考这里</a></p>
<h3 data-id="heading-5">自定义子组件</h3>
<p>支持通过组件的<code>props</code>将自定义的子组件传递进去，从而实现子组件的自定义。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { type <span class="hljs-title class_">AssistantMessageProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-ui"</span>;
<span class="hljs-keyword">import</span> { useChatContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-ui"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Markdown</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-ui"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SparklesIcon</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@heroicons/react/24/outline"</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotSidebar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-ui"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"@copilotkit/react-ui/styles.css"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CustomAssistantMessage</span> = (<span class="hljs-params">props: AssistantMessageProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> { icons } = <span class="hljs-title function_">useChatContext</span>();
  <span class="hljs-keyword">const</span> { message, isLoading, subComponent } = props;

  <span class="hljs-keyword">const</span> avatarStyles = <span class="hljs-string">"bg-zinc-400 border-zinc-500 shadow-lg min-h-10 min-w-10 rounded-full text-white flex items-center justify-center"</span>;
  <span class="hljs-keyword">const</span> messageStyles = <span class="hljs-string">"px-4 rounded-xl pt-2"</span>;

  <span class="hljs-keyword">const</span> avatar = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{avatarStyles}</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">SparklesIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-6 w-6"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"py-2"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-start"</span>&gt;</span>
        {!subComponent &amp;&amp; avatar}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{messageStyles}</span>&gt;</span>
          {message &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Markdown</span> <span class="hljs-attr">content</span>=<span class="hljs-string">{message.content</span> || ""} /&gt;</span> }
          {isLoading &amp;&amp; icons.spinnerIcon}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"my-2"</span>&gt;</span>{subComponent}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};


<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CopilotKit</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">CopilotSidebar</span> <span class="hljs-attr">AssistantMessage</span>=<span class="hljs-string">{CustomAssistantMessage}</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">CopilotKit</span>&gt;</span></span>
</code></pre>
<p>子组件包括：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6f9933b815f4cb9b26dccbc18c95b94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGV0X2NvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764731511&amp;x-signature=zXAVBmOlJGjLy%2FfXYE3t%2FDo9a7A%3D" alt="image.png" loading="lazy"/></p>
<p>除此之外，markdown的渲染默认使用<code>react-markdown</code>。支持通过<code>markdownTagRenderers</code>属性来自定义markdown渲染组件。</p>
<h4 data-id="heading-6">Actions</h4>
<p>允许 LLM 与应用程序的功能交互。当 LLM 调用 Action 时，可以提供自定义组件来可视化其执行和结果。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"use client"</span> <span class="hljs-comment">// only necessary if you are using Next.js with the App Router.</span>
<span class="hljs-keyword">import</span> { useCopilotAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 

<span class="hljs-comment">// Your custom components (examples - implement these in your app)</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoadingView</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./loading-view"</span>; <span class="hljs-comment">// Your loading component</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CalendarMeetingCardComponent</span>, type <span class="hljs-title class_">CalendarMeetingCardProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./calendar-meeting-card"</span>; <span class="hljs-comment">// Your meeting card component</span>
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">YourComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useCopilotAction</span>({ 
    <span class="hljs-attr">name</span>: <span class="hljs-string">"showCalendarMeeting"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Displays calendar meeting information"</span>,
    <span class="hljs-attr">parameters</span>: [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"date"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Meeting date (YYYY-MM-DD)"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"time"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Meeting time (HH:mm)"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>
      },
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"meetingName"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"Name of the meeting"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>
      }
    ],
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ status, args }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { date, time, meetingName } = args;
 
      <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'inProgress'</span>) {
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoadingView</span> /&gt;</span></span>; <span class="hljs-comment">// Your own component for loading state</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">meetingProps</span>: <span class="hljs-title class_">CalendarMeetingCardProps</span> = {
          <span class="hljs-attr">date</span>: date,
          time,
          meetingName
        };
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CalendarMeetingCardComponent</span> {<span class="hljs-attr">...meetingProps</span>} /&gt;</span></span>;
      }
    },
  });
 
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>...<span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-7">Agent State</h4>
<p><code>Agent State</code>组件允许可视化 <code>CoAgents</code> 的内部状态和进度。使用 <code>CoAgents</code> 时，可以提供自定义组件来呈现代理的状态。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"use client"</span>; <span class="hljs-comment">// only necessary if you are using Next.js with the App Router.</span>
 
<span class="hljs-keyword">import</span> { useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Progress</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./progress"</span>;

type <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">logs</span>: string[];
}

useCoAgentStateRender&lt;<span class="hljs-title class_">AgentState</span>&gt;({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"basic_agent"</span>,
  <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state, nodeName, status }</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">logs</span> || state.<span class="hljs-property">logs</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// Progress is a component we are omitting from this example for brevity.</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Progress</span> <span class="hljs-attr">logs</span>=<span class="hljs-string">{state.logs}</span> /&gt;</span></span>; 
  },
});
</code></pre>
<h2 data-id="heading-8">前端工具</h2>
<p>前端工具指的是前端定义的函数可以被 agent 调用。当函数被 agent 调用时，函数在客户端执行，使agent可以直接访问前端环境，从而实现agent对UI的控制和人机交互。</p>
<p>前端工具可以轻松实现：</p>
<ol>
<li>读取或修改 React 组件状态</li>
<li>访问浏览器 API，如 localStorage、sessionStorage 或 cookie</li>
<li>触发 UI 更新或动画</li>
<li>与第三方前端库交互</li>
<li>执行需要用户即时浏览上下文的操作</li>
</ol>
<h3 data-id="heading-9">实现</h3>
<h4 data-id="heading-10">1.创建前端工具</h4>
<p>需要使用 <code>useFrontendTool</code> 钩子创建一个前端工具。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//page.tsx </span>
<span class="hljs-keyword">import</span> { useFrontendTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-title function_">useFrontendTool</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sayHello"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Say hello to the user"</span>,
    <span class="hljs-attr">parameters</span>: [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"name"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"The name of the user to say hello to"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
    ],
    <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ name }) =&gt; {
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>);
    },
  });

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-11">2.修改代理</h4>
<p>安装 CopilotKit SDK <code>npm install @copilotkit/sdk-js</code>。</p>
<p>要访问 CopilotKit 提供的前端工具，可以在代理的状态定义中继承 CopilotKitState ：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>; 

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">YourAgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">yourAdditionalProperty</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>, 
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">YourAgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">YourAgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p>之后，代理的状态将包括 copilotkit 属性，其中包含可以访问和调用的前端工具。</p>
<p>agent调用前端工具：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">agentNode</span>(<span class="hljs-params">state: YourAgentState, config: RunnableConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">YourAgentState</span>&gt; {
    <span class="hljs-comment">// Access the tools from the copilotkit property</span>

    <span class="hljs-keyword">const</span> tools = state.<span class="hljs-property">copilotkit</span>?.<span class="hljs-property">actions</span>; 
    <span class="hljs-keyword">const</span> model = <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4o'</span> }).<span class="hljs-title function_">bindTools</span>(tools);

    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h2 data-id="heading-12">Generative UI</h2>
<p>用自定义 UI 组件实时呈现 agent 的状态、进度、输出和工具调用。</p>
<p>主要有三种方式使用生成式UI：</p>
<ol>
<li>后端工具：通过生成式UI组件渲染工具的调用</li>
<li>前端工具：为agent提供前端工具来显示自定义组件并且驱动UI</li>
<li>agent 状态：用自定义组件来显示agent的状态、进度和输出</li>
</ol>
<h3 data-id="heading-13">后端工具</h3>
<p>工具是 LLM 调用预定义的（通常是确定性函数）的一种方式。CopilotKit 允许在 UI 中将这些工具呈现为自定义组件，我们称之为生成式 UI。</p>
<p>简而言之就是允许我们向用户展示agent正在执行的操作，尤其是当我们调用工具时，允许完全自定义工具在聊天中的呈现方式。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-keyword">const</span> get_weather = <span class="hljs-title function_">tool</span>(
  <span class="hljs-function">(<span class="hljs-params">args</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`The weather for <span class="hljs-subst">${args.location}</span> is 70 degrees.`</span>;
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Get the weather for a given location."</span>,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">location</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"The location to get weather for"</span>),
    }),
  }
);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
  <span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> });
  <span class="hljs-keyword">const</span> modelWithTools = model.<span class="hljs-title function_">bindTools</span>([get_weather]); 

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> modelWithTools.<span class="hljs-title function_">invoke</span>([
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"You are a helpful assistant."</span>),
    ...state.<span class="hljs-property">messages</span>,
  ], config);

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>前端通过<code>useCopilotAction</code>钩子在UI中呈现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//page.tsx  </span>
<span class="hljs-keyword">import</span> { useRenderToolCall } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">useRenderToolCall</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,<span class="hljs-comment">// 注意name保持一致</span>
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{status, args}</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-gray-500 mt-2"</span>&gt;</span>
          {status !== "complete" &amp;&amp; "Calling weather API..."}
          {status === "complete" &amp;&amp; `Called the weather API for ${args.location}.`}
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
      );
    },
  });
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><code>useDefaultTool</code> 捕获所有没有专用渲染器的工具。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useDefaultTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">useDefaultTool</span>({
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ name, args, status, result }</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> "<span class="hljs-attr">black</span>" }}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>
            {status === "complete" ? "✓" : "⏳"}
            {name}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          {status === "complete" &amp;&amp; result &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>{JSON.stringify(result, null, 2)}<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    },
  });
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-14">前端工具</h3>
<p>定义 LangGraph agent 可以调用的客户端函数，执行完全在用户的浏览器中进行。当agent调用前端工具时，逻辑会在客户端运行，使agent可以直接访问前端环境。一般在agent需要和客户端交互时使用。</p>
<p>使用 <code>useFrontendTool</code> 钩子创建一个前端工具:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// page.tsx</span>
<span class="hljs-keyword">import</span> { useFrontendTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-title function_">useFrontendTool</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sayHello"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"Say hello to the user"</span>,
    <span class="hljs-attr">parameters</span>: [
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"name"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"The name of the user to say hello to"</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
    ],
    <span class="hljs-title function_">handler</span>(<span class="hljs-params">{ name }</span>) {
      <span class="hljs-comment">// Handler returns the result of the tool call</span>
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">currentURLPath</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>, <span class="hljs-attr">userName</span>: name };
    },
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ args }</span>) =&gt;</span> {
      <span class="hljs-comment">// Renders UI based on the data of the tool call</span>
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {args.name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>You're currently on {window.location.href}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    },
  });

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>agent 访问前端工具：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>; 

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">YourAgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">yourAdditionalProperty</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>, 
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">YourAgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">YourAgentStateAnnotation</span>.<span class="hljs-property">State</span>;

<span class="hljs-comment">//现在，agent的状态将包括 copilotkit 属性，其中包含可以访问和调用的前端工具。</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">agentNode</span>(<span class="hljs-params">state: YourAgentState, config: RunnableConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">YourAgentState</span>&gt; {
    <span class="hljs-comment">// Access the tools from the copilotkit property</span>

    <span class="hljs-keyword">const</span> tools = state.<span class="hljs-property">copilotkit</span>?.<span class="hljs-property">actions</span>; 
    <span class="hljs-keyword">const</span> model = <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4o'</span> }).<span class="hljs-title function_">bindTools</span>(tools);

    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-15">agent 状态</h3>
<p>所有 LangGraph agent 都是状态化的。这意味着当 agent 通过节点时，一个状态对象会在它们之间传递，以保持会话的整体状态。CopilotKit 允许使用自定义 UI 组件(生成式 UI)在应用程序中呈现此状态。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SystemMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { copilotkitEmitState, <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Search</span> = {
  <span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">done</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">searches</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-title class_">Search</span>[]&gt;,
  ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
  state.<span class="hljs-property">searches</span> = [
    { <span class="hljs-attr">query</span>: <span class="hljs-string">"Initial research"</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">query</span>: <span class="hljs-string">"Retrieving sources"</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">query</span>: <span class="hljs-string">"Forming an answer"</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
  ];

  <span class="hljs-comment">// We can call copilotkit_emit_state to emit updated state</span>
  <span class="hljs-comment">// before a node finishes</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">copilotkitEmitState</span>(config, state);

  <span class="hljs-comment">// Simulate state updates</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> search <span class="hljs-keyword">of</span> state.<span class="hljs-property">searches</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));
    search.<span class="hljs-property">done</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// We can also emit updates in a loop to simulate progress</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">copilotkitEmitState</span>(config, state);
  }

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> }).<span class="hljs-title function_">invoke</span>([
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>({ <span class="hljs-attr">content</span>: <span class="hljs-string">"You are a helpful assistant."</span>}),
    ...state.<span class="hljs-property">messages</span>,
  ], config);
</code></pre>
<p>前端通过 <code>useCoAgentStateRender</code> 在聊天中呈现agent的状态:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;

<span class="hljs-comment">// For type safety, redefine the state of the agent. If you're using</span>
<span class="hljs-comment">// using LangGraph JS you can import the type here and share it.</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">searches</span>: {
    <span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">done</span>: <span class="hljs-built_in">boolean</span>;
  }[];
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-comment">// styles omitted for brevity</span>
  useCoAgentStateRender&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>, <span class="hljs-comment">// the name the agent is served as</span>
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state }</span>) =&gt;</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        {state.searches?.map((search, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>
            {search.done ? "✅" : "❌"} {search.query}{search.done ? "" : "..."}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    ),
  });

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>除此之外还允许在聊天之外呈现agent的状态:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">// Define the state of the agent, should match the state of the agent in your LangGraph.</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">searches</span>: {
    <span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">done</span>: <span class="hljs-built_in">boolean</span>;
  }[];
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">const</span> { state } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>, <span class="hljs-comment">// the name the agent is served as</span>
  })

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* ... */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col gap-2 mt-4"</span>&gt;</span>
        {state.searches?.map((search, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-row"</span>&gt;</span>
            {search.done ? "✅" : "❌"} {search.query}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-16">Human in the Loop (HITL)</h2>
<p>用户与 agent 协作处理复杂任务。</p>
<p>主要有三种方式实现人机交互：</p>
<ol>
<li>基于中断</li>
<li>基于前端工具</li>
<li>基于节点</li>
</ol>
<h3 data-id="heading-17">基于中断</h3>
<h4 data-id="heading-18">基础</h4>
<p>需要一个状态属性来存储名称：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">// This is the state of the agent.</span>
<span class="hljs-comment">// It inherits from the CopilotKitState properties from CopilotKit.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">agentName</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
  ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p>在LangGraph 代理中调用 interrupt：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { interrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>; 
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SystemMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-comment">// add the agent state definition from the previous step</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">agentName</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
    <span class="hljs-keyword">const</span> agentName = state.<span class="hljs-property">agentName</span>
    ?? <span class="hljs-title function_">interrupt</span>(<span class="hljs-string">"Before we start, what would you like to call me?"</span>); 

    <span class="hljs-comment">// Tell the agent its name</span>
    <span class="hljs-keyword">const</span> systemMessage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>({
        <span class="hljs-attr">content</span>: <span class="hljs-string">`You are a helpful assistant named <span class="hljs-subst">${agentName}</span>...`</span>,
    });

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> }).<span class="hljs-title function_">invoke</span>(
        [systemMessage, ...state.<span class="hljs-property">messages</span>],
        config
    );

    <span class="hljs-keyword">return</span> {
        ...state,
        agentName,
        <span class="hljs-attr">messages</span>: response,
    };
}
</code></pre>
<p>前端使用 <code>useLangGraphInterrupt</code> 钩子，为终中断提供一个要渲染的组件，然后使用用户的响应调用 resolve。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useLangGraphInterrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// styles omitted for brevity</span>
<span class="hljs-title function_">useLangGraphInterrupt</span>({
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ event, resolve }</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{event.value}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
                e.preventDefault();
                resolve((e.target as HTMLFormElement).response.value);
            }}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"response"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Enter your response"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
});
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{/* ... */}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h4 data-id="heading-19">高级</h4>
<p>在代理中呈现多个中断事件时，UI 中的多个 <code>useLangGraphInterrupt</code> 钩子调用之间可能会发生冲突。出于这个原因，钩子可以接受一个 <code>enabled</code> 参数，该参数将有条件地应用它：</p>
<p>定义两个不同的中断，通过<code>type</code>进行区分：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { interrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>; 
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SystemMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;

<span class="hljs-comment">// ... your full state definition</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
  state.<span class="hljs-property">approval</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">interrupt</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"approval"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"please approve"</span> }); 

  <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">agentName</span>) {
    state.<span class="hljs-property">agentName</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">interrupt</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"ask"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"Before we start, what would you like to call me?"</span> }); 
  }

  <span class="hljs-comment">// Tell the agent its name</span>
  <span class="hljs-keyword">const</span> systemMessage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>({
    <span class="hljs-attr">content</span>: <span class="hljs-string">`You are a helpful assistant...`</span>,
  });

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> }).<span class="hljs-title function_">invoke</span>(
    [systemMessage, ...state.<span class="hljs-property">messages</span>],
    config
  );

  <span class="hljs-keyword">return</span> {
    ...state,
    <span class="hljs-attr">messages</span>: response,
  };
}
</code></pre>
<p>前端定义多个处理程序：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useLangGraphInterrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ApproveComponent</span> = (<span class="hljs-params">{ content, onAnswer }: { content: <span class="hljs-built_in">string</span>; onAnswer: (approved: <span class="hljs-built_in">boolean</span>) =&gt; <span class="hljs-built_in">void</span> }</span>) =&gt; (
    <span class="hljs-comment">// styles omitted for brevity</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Do you approve?<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onAnswer(true)}&gt;Approve<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onAnswer(false)}&gt;Reject<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">AskComponent</span> = (<span class="hljs-params">{ question, onAnswer }: { question: <span class="hljs-built_in">string</span>; onAnswer: (answer: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span> }</span>) =&gt; (
<span class="hljs-comment">// styles omitted for brevity</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{question}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
            e.preventDefault();
            onAnswer((e.target as HTMLFormElement).response.value);
        }}&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"response"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Enter your response"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-title function_">useLangGraphInterrupt</span>({
        <span class="hljs-attr">enabled</span>: <span class="hljs-function">(<span class="hljs-params">{ eventValue }</span>) =&gt;</span> eventValue.<span class="hljs-property">type</span> === <span class="hljs-string">'ask'</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ event, resolve }</span>) =&gt;</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AskComponent</span> <span class="hljs-attr">question</span>=<span class="hljs-string">{event.value.content}</span> <span class="hljs-attr">onAnswer</span>=<span class="hljs-string">{answer</span> =&gt;</span> resolve(answer)} /&gt;</span>
        )
    });

    <span class="hljs-title function_">useLangGraphInterrupt</span>({
        <span class="hljs-attr">enabled</span>: <span class="hljs-function">(<span class="hljs-params">{ eventValue }</span>) =&gt;</span> eventValue.<span class="hljs-property">type</span> === <span class="hljs-string">'approval'</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ event, resolve }</span>) =&gt;</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ApproveComponent</span> <span class="hljs-attr">content</span>=<span class="hljs-string">{event.value.content}</span> <span class="hljs-attr">onAnswer</span>=<span class="hljs-string">{answer</span> =&gt;</span> resolve(answer)} /&gt;</span>
        )
    });

    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>选择自定义聊天 UI 时，某些情况可能需要预处理中断事件的传入值，甚至需要完全解析它而不显示其 UI。这可以使用 <code>handeer</code> 属性来实现，该属性不需要返回一个 React 组件。 处理程序的返回值将作为结果参数传递给 render 方法。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-comment">// We will assume an interrupt event in the following shape</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Department</span> = <span class="hljs-string">'finance'</span> | <span class="hljs-string">'engineering'</span> | <span class="hljs-string">'admin'</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthorizationInterruptEvent</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'auth'</span>,
    <span class="hljs-attr">accessDepartment</span>: <span class="hljs-title class_">Department</span>,
}

<span class="hljs-keyword">import</span> { useLangGraphInterrupt } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> [userEmail, setUserEmail] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">email</span>: <span class="hljs-string">'example@user.com'</span> })
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserByEmail</span>(<span class="hljs-params">email: <span class="hljs-built_in">string</span></span>): { <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">department</span>: <span class="hljs-title class_">Department</span> } {
        <span class="hljs-comment">// ... an implementation of user fetching</span>
    }

    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// styles omitted for brevity</span>
    <span class="hljs-title function_">useLangGraphInterrupt</span>({
        <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ result, event, resolve }) =&gt; {
            <span class="hljs-keyword">const</span> { department } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserByEmail</span>(userEmail)
            <span class="hljs-keyword">if</span> (event.<span class="hljs-property">value</span>.<span class="hljs-property">accessDepartment</span> === department || department === <span class="hljs-string">'admin'</span>) {
                <span class="hljs-comment">// Following the resolution of the event, we will not proceed to the render method</span>
                <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">code</span>: <span class="hljs-string">'AUTH_BY_DEPARTMENT'</span> })
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-keyword">return</span> { department, userId }
        },
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ result, event, resolve }</span>) =&gt;</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Request for {event.value.type}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Members from {result.department} department cannot access this information<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>You can request access from an administrator to continue.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                    <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> resolve({ code: 'REQUEST_AUTH', data: { department: result.department, userId: result.userId } })}
                &gt;
                    Request Access
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                    <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> resolve({ code: 'CANCEL' })}
                &gt;
                    Cancel
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
    });
    <span class="hljs-comment">// ...</span>

    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{/* ... */}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-20">基于前端工具</h3>
<p>前端工具可以用在多种方式上。其中一种方式是有人工介入的流程，工具的响应由用户的决定来控制。</p>
<p>在这个例子中，我们将模拟一个用于执行命令的“批准”流程。首先，使用<code>useHumanInTheLoop</code>钩子来创建一个提示用户批准的工具。</p>
<p>要访问由 CopilotKit 提供的前端工具，您可以在agent的状态定义中继承自 CopilotKitState:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>; 

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">YourAgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">yourAdditionalProperty</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>, 
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">YourAgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">YourAgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p>经上述操作，agent的状态将包括 copilotkit 属性，其中包含可以访问和调用的前端工具。接下来就可以调用前端工具方法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.tsx</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">agentNode</span>(<span class="hljs-params">state: YourAgentState, config: RunnableConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">YourAgentState</span>&gt; {
    <span class="hljs-comment">// Access the tools from the copilotkit property</span>

    <span class="hljs-keyword">const</span> tools = state.<span class="hljs-property">copilotkit</span>?.<span class="hljs-property">actions</span>; 
    <span class="hljs-keyword">const</span> model = <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4o'</span> }).<span class="hljs-title function_">bindTools</span>(tools);

    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-21">基于节点</h3>
<p>LangGraph 和 CopilotKit 现在都不鼓励使用基于节点的中断。从 LangGraph 0.2.57 开始，推荐的设置断点的方法是使用 interrupt 函数 ，因为它简化了人机交互模式。</p>
<p>想要了解可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.copilotkit.ai%2Flanggraph%2Fhuman-in-the-loop%2Fnode-flow" target="_blank" title="https://docs.copilotkit.ai/langgraph/human-in-the-loop/node-flow" ref="nofollow noopener noreferrer">这里</a></p>
<h2 data-id="heading-22">状态共享</h2>
<p>在 UI 和 LangGraph agent 状态之间创建双向连接。</p>
<h3 data-id="heading-23">读取agent状态</h3>
<p>不仅可以在聊天界面中使用实时代理状态，还可以在原生应用程序中使用。</p>
<p>LangGraph 是有状态的。在节点之间转换时，该状态将更新并传递到下一个节点。假设agent状态如下所示：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">language</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
  <span class="hljs-comment">// If language is not defined, use a default value.</span>
  <span class="hljs-keyword">const</span> language = state.<span class="hljs-property">language</span> ?? <span class="hljs-string">'spanish'</span>

  <span class="hljs-comment">// ... add the rest of the node implementation and use the language variable</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// ... add the rest of state to return</span>
    <span class="hljs-comment">// return the language to make it available for the next nodes &amp; frontend to read</span>
    language
  }
}
</code></pre>
<p>前端调用 <code>useCoAgent</code> 钩子，传递agent的名称，并选择性地提供初始状态：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//pages.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 

<span class="hljs-comment">// Define the agent state type, should match the actual state of your agent</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">language</span>: <span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { state } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">initialState</span>: { <span class="hljs-attr">language</span>: <span class="hljs-string">"spanish"</span> }  <span class="hljs-comment">// optionally provide an initial state</span>
  });

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// style excluded for brevity</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Your main content<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Language: {state.language}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> // [!code highlight]
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong><code>useCoAgent</code> 中的状态是响应式的，当代理的状态发生变化时会自动更新</strong></p>
<h4 data-id="heading-24">在聊天中渲染 agent 状态</h4>
<p>可以使用 <code>useCoAgentStateRender</code> 钩子。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 

<span class="hljs-comment">// Define the agent state type, should match the actual state of your agent</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">language</span>: <span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">useCoAgentStateRender</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state }</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">language</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Language: {state.language}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    },
  });
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong><code>useCoAgentStateRender</code> 中的状态是响应式的，当代理的状态发生变化时会自动更新。</strong></p>
<h3 data-id="heading-25">写入agent状态</h3>
<p>假设 agent 状态：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agebt.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">language</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>&gt;,
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p><code>useCoAgent</code> 返回一个 <code>setState</code> 函数，您可以使用该函数来更新代理状态。调用这个将更新代理状态并触发依赖于代理状态的任何内容的重新渲染。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>; 

<span class="hljs-comment">// Define the agent state type, should match the actual state of your agent</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
  <span class="hljs-attr">language</span>: <span class="hljs-string">"english"</span> | <span class="hljs-string">"spanish"</span>;
}

<span class="hljs-comment">// Example usage in a pseudo React component</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { state, setState } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({ 
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">initialState</span>: { <span class="hljs-attr">language</span>: <span class="hljs-string">"spanish"</span> }  <span class="hljs-comment">// optionally provide an initial state</span>
  });

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleLanguage</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setState</span>({ <span class="hljs-attr">language</span>: state.<span class="hljs-property">language</span> === <span class="hljs-string">"english"</span> ? <span class="hljs-string">"spanish"</span> : <span class="hljs-string">"english"</span> }); 
  };

  <span class="hljs-comment">// ...</span>

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// style excluded for brevity</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Your main content<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Language: {state.language}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleLanguage}</span>&gt;</span>Toggle Language<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-26">高级用法</h4>
<h5 data-id="heading-27">重新运行agent，并提示更改内容</h5>
<p>新的 agent 状态将在下次 agent 运行时使用。如果您想手动重新运行它，请在<code>useCoAgent</code>钩子上使用<code>run</code>参数。
agent将重新运行，它不仅会获得最新的更新状态，还会获得可能取决于以前状态和当前状态之间的数据增量的提示 。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/react-core"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TextMessage</span>, <span class="hljs-title class_">MessageRole</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/runtime-client-gql"</span>;  

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">YourMainContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { state, setState, run } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">initialState</span>: { <span class="hljs-attr">language</span>: <span class="hljs-string">"spanish"</span> }  <span class="hljs-comment">// optionally provide an initial state</span>
  });

  <span class="hljs-comment">// setup to be called when some event in the app occurs</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleLanguage</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> newLanguage = state.<span class="hljs-property">language</span> === <span class="hljs-string">"english"</span> ? <span class="hljs-string">"spanish"</span> : <span class="hljs-string">"english"</span>;
    <span class="hljs-title function_">setState</span>({ <span class="hljs-attr">language</span>: newLanguage });

    <span class="hljs-comment">// re-run the agent and provide a hint about what's changed</span>
    <span class="hljs-title function_">run</span>(<span class="hljs-function">(<span class="hljs-params">{ previousState, currentState }</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-title class_">MessageRole</span>.<span class="hljs-property">User</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`the language has been updated to <span class="hljs-subst">${currentState.language}</span>`</span>,
      });
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// ...</span>
  );
}
</code></pre>
<h3 data-id="heading-28">agent状态输入和输出</h3>
<p>有些属性是内部处理的，而另一些则是 UI 传递用户输入的方式。此外，有些状态属性包含大量信息。在agent和 UI 之间来回同步它们可能成本高昂，而且可能没有实际好处。</p>
<p>假设状态如下：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
  <span class="hljs-attr">question</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;, <span class="hljs-comment">//期望LLM回答的问题</span>
  <span class="hljs-attr">answer</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,<span class="hljs-comment">//LLM回应的答案</span>
  <span class="hljs-attr">resources</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>[]&gt;,<span class="hljs-comment">//用于LLM回答问题，不应向用户同步</span>
})
</code></pre>
<p>agent定义输入输出：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

  <span class="hljs-comment">// Divide the state to 3 parts</span>

  <span class="hljs-comment">// An input schema for inputs you are willing to accept from the frontend</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">InputAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
    <span class="hljs-attr">question</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
  });

  <span class="hljs-comment">// Output schema for output you are willing to pass to the frontend</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">OutputAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
    <span class="hljs-attr">answer</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>&gt;,
  });

  <span class="hljs-comment">// The full schema, including the inputs, outputs and internal state ("resources" in our case)</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
    ...<span class="hljs-title class_">OutputAnnotation</span>.<span class="hljs-property">spec</span>,
    ...<span class="hljs-title class_">InputAnnotation</span>.<span class="hljs-property">spec</span>,
    <span class="hljs-attr">resources</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>[]&gt;,
  });

  <span class="hljs-comment">// Define a typed state that supports the entire</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">answerNode</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
    <span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>()

    <span class="hljs-keyword">const</span> systemMessage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>({
      <span class="hljs-attr">content</span>: <span class="hljs-string">`You are a helpful assistant. Answer the question: <span class="hljs-subst">${state.question}</span>.`</span>,
    });

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> modelWithTools.<span class="hljs-title function_">invoke</span>(
      [systemMessage, ...state.<span class="hljs-property">messages</span>],
      config
    );

    <span class="hljs-comment">// ...add the rest of the agent implementation</span>
    <span class="hljs-comment">// extract the answer, which will be assigned to the state soon</span>
    <span class="hljs-keyword">const</span> answer = response.<span class="hljs-property">content</span>

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">messages</span>: response,
      <span class="hljs-comment">// include the answer in the returned state</span>
      answer,
    }
  }

  <span class="hljs-comment">// finally, before compiling the graph, we define the 3 state components</span>
  <span class="hljs-keyword">const</span> workflow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateGraph</span>({
    <span class="hljs-attr">input</span>: <span class="hljs-title class_">InputAnnotation</span>,
    <span class="hljs-attr">output</span>: <span class="hljs-title class_">OutputAnnotation</span>,
    <span class="hljs-comment">// @ts-expect-error -- LangGraph does not expect a "full schema with internal properties".</span>
    <span class="hljs-attr">stateSchema</span>: <span class="hljs-title class_">AgentStateAnnotation</span>,
  })
    .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"answer_node"</span>, answerNode) <span class="hljs-comment">// add all the different nodes and edges and compile the graph</span>
    .<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"answer_node"</span>)
    .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"answer_node"</span>, <span class="hljs-variable constant_">END</span>)
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> graph = workflow.<span class="hljs-title function_">compile</span>()
</code></pre>
<h3 data-id="heading-29">预测状态更新</h3>
<p>一个LangGraph agent的状态更新是不连续的；仅在图中的节点转换之间进行。但是，图中单个节点运行往往需要许多秒，并且包含用户感兴趣的子步骤。</p>
<p>预测状态更新帮助我们向用户尽可能连续的反应 agent 正在执行的操作。</p>
<p>当你的LangGraph中的节点执行完毕时，其返回的状态成为唯一的真实来源。虽然中间状态更新对于实时反馈很有帮助，但任何你想持久化的更改都必须明确地包含在节点的最终返回状态中。否则，它们将在节点完成时被覆盖。</p>
<p>在状态中定义一个 <code>observed_steps</code> 字段，该字段将在agent编写报告的不同部分时更新。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CopilotKitStateAnnotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentStateAnnotation</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
    <span class="hljs-attr">observed_steps</span>: <span class="hljs-title class_">Annotation</span>&lt;<span class="hljs-built_in">string</span>[]&gt;,  <span class="hljs-comment">// Array of completed steps</span>
    ...<span class="hljs-title class_">CopilotKitStateAnnotation</span>.<span class="hljs-property">spec</span>,
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">AgentStateAnnotation</span>.<span class="hljs-property">State</span>;
</code></pre>
<p>有两种发出状态更新的方式：手动预测和基于工具的预测。</p>
<h4 data-id="heading-30">手动预测状态更新</h4>
<p>对于长时间运行的任务，可以逐步发出状态更新，作为最终状态的预测。在这个例子中，我们通过执行一系列带有每次更新之间一秒延迟的步骤来模拟一个长时间运行的任务。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { copilotkitEmitState } <span class="hljs-keyword">from</span> <span class="hljs-string">"@copilotkit/sdk-js/langgraph"</span>; 
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat_node</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>) {
    <span class="hljs-comment">// ...</span>

    <span class="hljs-comment">// Simulate executing steps one by one</span>
    <span class="hljs-keyword">const</span> steps = [
        <span class="hljs-string">"Analyzing input data..."</span>,
        <span class="hljs-string">"Identifying key patterns..."</span>,
        <span class="hljs-string">"Generating recommendations..."</span>,
        <span class="hljs-string">"Formatting final output..."</span>
    ];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> step <span class="hljs-keyword">of</span> steps) {
        state.<span class="hljs-property">observed_steps</span> = [...(state.<span class="hljs-property">observed_steps</span> ?? []), step];
        <span class="hljs-title function_">copilotkitEmitState</span>(config, state);
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));
    }
}
</code></pre>
<p>这些预测将在代理运行时发出，允许您在确定最终状态之前跟踪其进度:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent, useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">'@copilotkit/react-core'</span>;

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
    <span class="hljs-attr">observed_steps</span>: <span class="hljs-built_in">string</span>[];
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// Get access to both predicted and final states</span>
    <span class="hljs-keyword">const</span> { state } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({ <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span> });

    <span class="hljs-comment">// Add a state renderer to observe predictions</span>
    <span class="hljs-title function_">useCoAgentStateRender</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state }</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">observed_steps</span>?.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">return</span> (
                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Current Progress:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        {state.observed_steps.map((step, i) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{step}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        ))}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
            );
        },
    });

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Agent Progress<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {state.observed_steps?.length &gt; 0 &amp;&amp; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Final Steps:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        {state.observed_steps.map((step, i) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{step}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        ))}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h4 data-id="heading-31">基于工具预测状态更新</h4>
<p>对于长时间运行的任务，您可以配置 CopilotKit 在执行特定工具调用时自动预测状态更新。在这个示例中，我们将配置 CopilotKit 在 LLM 调用步骤进度工具时预测状态更新。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//agent.ts</span>
<span class="hljs-keyword">import</span> { copilotkitCustomizeConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@copilotkit/sdk-js/langgraph'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">frontendActionsNode</span>(<span class="hljs-params">state: AgentState, config: RunnableConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AgentState</span>&gt; {
    <span class="hljs-keyword">const</span> modifiedConfig = <span class="hljs-title function_">copilotkitCustomizeConfig</span>(config, {
        <span class="hljs-attr">emitIntermediateState</span>: [
        {
            <span class="hljs-attr">stateKey</span>: <span class="hljs-string">"observed_steps"</span>,
            <span class="hljs-attr">tool</span>: <span class="hljs-string">"StepProgressTool"</span>,
            <span class="hljs-attr">toolArgument</span>: <span class="hljs-string">"steps"</span>,
        },
        ],
    });

    <span class="hljs-keyword">const</span> stepProgress = <span class="hljs-title function_">tool</span>(
        <span class="hljs-keyword">async</span> (args) =&gt; args,
        {
            <span class="hljs-attr">name</span>: <span class="hljs-string">"StepProgressTool"</span>,
            <span class="hljs-attr">description</span>: <span class="hljs-string">"Records progress by updating the steps array"</span>,
            <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
                <span class="hljs-attr">steps</span>: z.<span class="hljs-title function_">array</span>(z.<span class="hljs-title function_">string</span>()),
            }),
        }
    );

    <span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
        <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span>,
    }).<span class="hljs-title function_">bindTools</span>([stepProgress]);

    <span class="hljs-keyword">const</span> system_message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"You are a task performer. Pretend doing tasks you are given, report the steps using StepProgressTool."</span>)
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>([system_message, ...state.<span class="hljs-property">messages</span>], modifiedConfig);


    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span>?.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">messages</span>: response;
            <span class="hljs-attr">observed_steps</span>: response.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>].<span class="hljs-property">args</span>.<span class="hljs-property">steps</span>,
        }

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">messages</span>: response };
}
</code></pre>
<p>这些预测将在代理运行时发出，允许您在确定最终状态之前跟踪其进度:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//page.tsx</span>
<span class="hljs-keyword">import</span> { useCoAgent, useCoAgentStateRender } <span class="hljs-keyword">from</span> <span class="hljs-string">'@copilotkit/react-core'</span>;

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AgentState</span> = {
    <span class="hljs-attr">observed_steps</span>: <span class="hljs-built_in">string</span>[];
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">YourMainContent</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// Get access to both predicted and final states</span>
    <span class="hljs-keyword">const</span> { state } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({ <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span> });

    <span class="hljs-comment">// Add a state renderer to observe predictions</span>
    <span class="hljs-title function_">useCoAgentStateRender</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ state }</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">observed_steps</span>?.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">return</span> (
                <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Current Progress:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        {state.observed_steps.map((step, i) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{step}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        ))}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
            );
        },
    });

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Agent Progress<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {state.observed_steps?.length &gt; 0 &amp;&amp; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Final Steps:<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        {state.observed_steps.map((step, i) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{step}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        ))}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h2 data-id="heading-32">子图</h2>
<p>一个子图简单地是作为另一个图中的节点使用的图。把它看作是LangGraph的封装：每个子图是一个自包含的单元，可以组合起来构建更大、更复杂的系统。</p>
<p>使用此功能不需要在agent端执行额外步骤。您需要做的就是在 useCoAgent 钩子中启用子图流：</p>
<pre><code class="hljs language-tsx" lang="tsx">  <span class="hljs-keyword">const</span> { state, nodeName } = useCoAgent&lt;<span class="hljs-title class_">AgentState</span>&gt;({
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sample_agent"</span>,
    <span class="hljs-attr">initialState</span>: <span class="hljs-variable constant_">INITIAL_STATE</span>,
    <span class="hljs-attr">config</span>: {
      <span class="hljs-attr">streamSubgraphs</span>: <span class="hljs-literal">true</span>, 
    }
  });
</code></pre>
<p>子图节点将照常流式传输，你将能够使用 <code>nodeName</code> 变量查看哪个子图正在流式传输。您也可以直接从子图使用 <code>interrupt（）</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型瘦身术:量化与蒸馏技术全解析]]></title>    <link>https://juejin.cn/post/7576825095134986266</link>    <guid>https://juejin.cn/post/7576825095134986266</guid>    <pubDate>2025-11-26T05:57:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576825095134986266" data-draft-id="7576669556150190118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型瘦身术:量化与蒸馏技术全解析"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T05:57:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="居然JuRan"/> <meta itemprop="url" content="https://juejin.cn/user/2524134427858205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型瘦身术:量化与蒸馏技术全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134427858205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    居然JuRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:57:07.000Z" title="Wed Nov 26 2025 05:57:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么要给大模型"瘦身"?</h2>
<p>在AI技术飞速发展的今天,大语言模型已经成为各行各业的得力助手。但你是否知道,部署一个大模型的成本有多高?</p>
<p>一个千亿参数级别的模型,不仅需要占用大量的存储空间,在实际运行时更是需要惊人的计算资源。对于企业来说,这意味着高昂的硬件成本和运营开支。因此,如何在保持模型性能的同时降低部署成本,成为了AI工程师们必须面对的挑战。</p>
<p>今天,我们就来聊聊大模型压缩的两大主流技术——<strong>量化(Quantization)和蒸馏(Distillation)</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb122be11df49e0b2e47cbda4123427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=xUqEIgMf6B0xrbulchmQuih2GlY%3D" alt="大模型压缩技术概览" loading="lazy"/></p>
<h2 data-id="heading-1">量化:用更少的位数存储参数</h2>
<h3 data-id="heading-2">什么是量化?</h3>
<p>要理解量化,我们首先需要知道:大模型本质上是由海量参数组成的。比如GPT-3,就包含了1750亿个参数。每个参数都是一个数值,而这些数值的存储方式,直接决定了模型占用的空间大小。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52330fabeb214786abcfba009f5b1a54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=pSf6HinPuv6%2BzRgb9BBfXvk51ew%3D" alt="量化原理解释" loading="lazy"/></p>
<p>让我们举个简单的例子。假设某个参数的值是1.2768,为了在计算机中存储这个精确的数值,我们需要开辟一定的内存空间。但如果我们做个"四舍五入",把它简化成1或者1.28,所需的存储空间就会大大减少。</p>
<p><strong>这就是量化的核心思想——通过降低数值精度来节省存储空间。</strong></p>
<h3 data-id="heading-3">从Float32到INT8的转变</h3>
<p>在深度学习中,参数通常以Float32的格式存储,也就是说每个参数占用32个bits(4个字节)的空间。但通过量化技术,我们可以将这些参数转换为更低精度的数据类型:</p>
<ul>
<li>
<p><strong>Float32 → Float16</strong>:空间减半,每个参数仅占16个bits</p>
</li>
<li>
<p><strong>Float32 → INT8</strong>:空间压缩至1/4,每个参数仅占8个bits</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33d3fcb13a374856b9dcb900473adbce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=QQEPn3g8hMDSsGwBjZrtfFDWChg%3D" alt="数据类型转换示意" loading="lazy"/></p>
<p>这种转换带来的好处是显而易见的:</p>
<ol>
<li>
<p><strong>大幅降低存储需求</strong>:模型文件变小,更容易部署</p>
</li>
<li>
<p><strong>加速推理速度</strong>:计算量减少,响应更快</p>
</li>
<li>
<p><strong>降低成本</strong>:对硬件的要求大幅下降</p>
</li>
</ol>
<p>你可能会担心:精度降低了,模型的准确率会不会受影响?</p>
<p>答案是:**如果量化过程把控得当,模型的准确率是有保障的。**这也是为什么量化成为目前大模型压缩最常用的方法之一。</p>
<h2 data-id="heading-4">蒸馏:让小模型学会"模仿"</h2>
<h3 data-id="heading-5">蒸馏的本质是什么?</h3>
<p>如果说量化是"压缩参数",那么蒸馏则是完全不同的思路——<strong>让一个小模型去模仿大模型的行为</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad612a7432bc401ba6d549483e411cc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=Selr8ftFG1%2FKCdLwZulvF0z%2BAW0%3D" alt="模型蒸馏原理" loading="lazy"/></p>
<p>想象一个场景:我们已经训练好了一个千亿参数的大模型,但它太大太重,部署成本太高。这时候,我们可以构造一个小得多的模型,然后让这个"学生模型"(Student Model)去学习"教师模型"(Teacher Model)的行为。</p>
<h3 data-id="heading-6">蒸馏是如何工作的?</h3>
<p>具体来说,蒸馏的过程是这样的:</p>
<ol>
<li>
<p>给定一个输入(比如一个prompt)</p>
</li>
<li>
<p>将这个输入同时喂给大模型和小模型</p>
</li>
<li>
<p>观察大模型的输出</p>
</li>
<li>
<p>训练小模型,让它的输出尽可能接近大模型的输出</p>
</li>
</ol>
<p><strong>就像小孩子模仿大人一样,大模型做什么,小模型也学着做什么。</strong></p>
<p>通过这种方式,小模型逐渐学会了大模型的"行为模式",最终能够在保持相似性能的同时,大幅减少模型规模和计算开销。</p>
<h3 data-id="heading-7">蒸馏在实际中的应用</h3>
<p>蒸馏技术不仅用于模型压缩,在训练新模型时也经常使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/795d7eabee8d40d7ac4381417456b8f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=yuPYq1MLtEck17Uwlt0MCoTUmKQ%3D" alt="蒸馏应用场景" loading="lazy"/></p>
<p>一个典型的例子是:市面上很多开源大模型,都是通过"模仿"GPT-4训练出来的。具体做法是:</p>
<ol>
<li>
<p>收集GPT-4对各种问题的回复</p>
</li>
<li>
<p>将这些输入-输出对作为训练数据</p>
</li>
<li>
<p>用这些数据训练自己的模型</p>
</li>
</ol>
<p>通过这种方式,开源模型能够逐步接近GPT-4的表现,同时保持更低的部署成本。</p>
<h2 data-id="heading-8">量化vs蒸馏:该选哪一个?</h2>
<p>这两种技术各有特点,适用于不同场景:</p>
<p><strong>量化技术</strong>:</p>
<ul>
<li>
<p>优势:实施简单,不需要重新训练,压缩效果明显</p>
</li>
<li>
<p>适用场景:已有模型的快速优化,对精度要求不是特别严格的应用</p>
</li>
<li>
<p>主流方法:目前大模型压缩最常用的手段</p>
</li>
</ul>
<p><strong>蒸馏技术</strong>:</p>
<ul>
<li>
<p>优势:可以获得一个全新的小模型,灵活性更高</p>
</li>
<li>
<p>适用场景:需要大幅度缩小模型规模,或训练新模型时借鉴大模型能力</p>
</li>
<li>
<p>应用广泛:很多开源模型都基于蒸馏思路训练</p>
</li>
</ul>
<p>在实际应用中,这两种技术也可以结合使用,达到更好的压缩效果。</p>
<h2 data-id="heading-9">其他压缩技术</h2>
<p>除了量化和蒸馏,还有一些其他的模型压缩技术,比如<strong>剪枝(Pruning)</strong>——通过移除模型中不重要的参数或连接来减小模型规模。</p>
<p>但在大模型领域,剪枝的实用性相对较弱,量化和蒸馏仍然是最主流、最实用的两种方法。</p>
<h2 data-id="heading-10">写在最后</h2>
<p>随着大模型应用的不断普及,模型压缩技术变得越来越重要。无论是量化还是蒸馏,它们的目标都是在保证模型性能的前提下,让AI技术更加"平民化"——降低部署门槛,让更多人能够用得起、用得好大模型。</p>
<p>对于开发者来说,理解这些技术原理,不仅能帮助我们更好地部署模型,也能在设计AI应用时做出更明智的技术选择。</p>
<p>你在实际项目中使用过这些技术吗?欢迎在评论区分享你的经验!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给 TRAE SOLO 一台服务器，它能干什么？]]></title>    <link>https://juejin.cn/post/7576821684252475435</link>    <guid>https://juejin.cn/post/7576821684252475435</guid>    <pubDate>2025-11-26T12:36:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684252475435" data-draft-id="7576859345935089718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给 TRAE SOLO 一台服务器，它能干什么？"/> <meta itemprop="keywords" content="Trae,Solo,AI编程"/> <meta itemprop="datePublished" content="2025-11-26T12:36:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给 TRAE SOLO 一台服务器，它能干什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T12:36:45.000Z" title="Wed Nov 26 2025 12:36:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前一阵子刷到一个很有意思的操作：有人直接把一台服务器的权限扔给了 AI，并简单说了句目标。</p>
<p>然后，AI 就从零开始安装环境、配依赖，拉仓库，启动服务，最后成功完成了对外服务的提供。</p>
<p>今天，我们就尝试下这个思路：让 <code>TRAE SOLO</code> 自行在远程服务器中搭建一套 <code>MinerU</code> 环境。</p>
<h2 data-id="heading-0">MinerU</h2>
<p>首先，简单介绍下 <code>MinerU</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33f6d82478d04e299eb19d753a2feee7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=eyAcvMYv80Ko0lYxi894%2BhOMfN4%3D" alt="" loading="lazy"/></p>
<p><code>MinerU</code> 是一款能将<strong>PDF/图片转换为机器可读格式</strong>（例如 <code>markdown</code>、<code>JSON</code>）的工具，诞生于上海人工智能实验室出品大模型 <code>InternLM</code> 的预训练过程中。</p>
<p>核心特性：</p>
<ul>
<li><strong>多模态文档解析</strong>：支持多种文档类型，包括扫描版 PDF</li>
<li><strong>结构化还原</strong>：可识别表格、公式、分子式等</li>
<li><strong>高保真语义理解</strong>：利用布局分析和阅读顺序推理，避免传统 OCR 机械识别导致的逻辑错乱。</li>
<li><strong>本地化 &amp; 开源免费</strong>：全部模型和代码开源，可私有部署，无需调用外部 API，保障数据隐私。</li>
</ul>
<h2 data-id="heading-1">共绩算力</h2>
<p>AI 要部署的应用已经了解了，现在需要给 AI 找一个可以操作的服务器。</p>
<p>最近我使用的算力平台是“共绩算力”，<code>RTX 4090</code> 只要 <code>1.68</code> 元/小时，还能按毫秒计费、自动扩容，非常便于我根据研究的模型挑选合适的节点配置。</p>
<p>尤其是目前，平台还有福利，<strong>注册就送算力券</strong>。</p>
<h2 data-id="heading-2">实操记录</h2>
<h3 data-id="heading-3">节点建立</h3>
<p>注册并登录“共绩算力”平台。</p>
<p>在“云主机”页面选择合适的节点</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381d765e27df439a89ad4481f0287395~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=Rc4YtH5x9fML4ri8vP5vSZVT9jw%3D" alt="" loading="lazy"/></p>
<p>选择合适的节点类型后，配置相关镜像、存储等，我这里配置了“基础镜像”，由于是测试搭建模型，未配置相关存储。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45720f1c6b0c433eb1630a9778577e87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=ZHXguh3rd2MYd2LyIXgx%2F%2FIF8wI%3D" alt="" loading="lazy"/></p>
<p>如果是第一次租用，账户余额为 0，会要求充值一下（0.01元即可），然后，需要在个人中心关注下公众号，这些按照页面提示进行即可。</p>
<p>租用成功后，会在“控制台”-“云主机列表”中看到租用的节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ced2f6fccc284a258c6b961f3df6fc34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=c53clo2VeJABljwf1KwMHtyaP8E%3D" alt="" loading="lazy"/></p>
<p>24G 显存、63G 内存，1小时 1.68 元，并且有算力券抵扣，还很合适的。</p>
<h3 data-id="heading-4">远程连接</h3>
<p><strong>第一步</strong>，我们先来调整下 <code>SSH</code> 连接的命令，让其支持端口映射，方便访问 demo。</p>
<p>在上一步的“云主机列表”-“SSH登录信息”中，复制出登录指令，格式如下。</p>
<pre><code class="hljs language-css" lang="css">ssh root<span class="hljs-keyword">@hdy1</span>.550c.cloud -p <span class="hljs-number">40002</span>
</code></pre>
<p>增加<strong>端口映射参数</strong>。</p>
<pre><code class="hljs language-java" lang="java">ssh -vvN -L <span class="hljs-number">7860</span>:<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">7860</span> root<span class="hljs-meta">@hdy1</span>.550c.cloud -p <span class="hljs-number">40002</span>
</code></pre>
<p>其中 <code>7860</code> 是 <code>MinerU demo</code> 的服务端口。</p>
<p><strong>第二步</strong>，我们打开 <code>TRAE</code> 进行远程连接。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f9b703dfe8241f19585bdafa24cd984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=M1BqQ%2FKJfoL%2FPVZAlOzkjla%2Fc70%3D" alt="" loading="lazy"/></p>
<p>输入上面的指令，回车即可。</p>
<p>此时会要求录入密码，再次从“云主机列表”-“SSH登录信息”中复制“登录密码”即可。</p>
<blockquote>
<p>如果同一地址连接多次，可能会在 SSH 连接中生成多个相同的 Host，此时会出现登录失败的情况，手动删除重复的 Host 即可。</p>
</blockquote>
<p>成功连接后，终端信息如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a9b28a6d3d742e1a8102d68ad591783~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=m8gIiVOKAC5gAOWKDOX9fEqEBFc%3D" alt="" loading="lazy"/></p>
<p>正常情况下可以在编辑器中打开远程文件夹，也可以在终端执行命令了。</p>
<p>但今天，我们都交给 AI。</p>
<h3 data-id="heading-5">环境部署</h3>
<p>开发环境：国际版 <code>SOLO Coder</code> 智能体，未选择 <code>Plan</code> 模式。</p>
<p>直接在 <code>Chat</code> 窗口录入如下指令，等待完成。</p>
<p><strong>指令</strong></p>
<p>指令非常简单，让 AI 参考 <code>MinerU</code> 官方仓库文档，自行完成部署。</p>
<p>因为模型下载涉及到 <code>HuggingFace</code> 的网络问题，一般各大算力企业都会提供镜像内容，这里把“共绩算力”的镜像文档也放上了。</p>
<pre><code class="hljs language-ruby" lang="ruby">参考github文档<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/opendatalab</span><span class="hljs-regexp">/mineru?tab=readme-ov-file ，帮我完成mineru的安装，并完成demo启动。
云服务器文档：https:/</span><span class="hljs-regexp">/www.gongjiyun.com/docs</span><span class="hljs-regexp">/server/introduction</span><span class="hljs-regexp">/rznmwsy13i4a8yktuyycoxyinmg/</span> 
</code></pre>
<p><strong>过程</strong></p>
<p>过程很清晰：安装依赖、下载模型、启动Demo。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed996c916d140cdb6e08f5c1fdf5da5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=zqHwEcUepdAd22Ase9gK8vIZOhs%3D" alt="" loading="lazy"/></p>
<p>后面还有详细的安装步骤、网络加速与镜像建议、常用参数与优化、问题排查、后续可选增强等内容，便于我们回顾审阅。</p>
<p><strong>SOLO 模式的好处就是中间遇到问题，它可以自行解决</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a961e3db9aa7494f8246f58bcf74ae20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=xQkx4ScwbTogw%2Bfyg2KosdmFI84%3D" alt="" loading="lazy"/></p>
<p>最后还给出了 demo 的访问方式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad9688c470114572ba55130ceef88e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=BzTO%2FbDrygPDuRktGgBxwy02eHw%3D" alt="" loading="lazy"/></p>
<p><strong>结果</strong></p>
<p>命令执行完成后，<code>SOLO</code> 内置浏览器已经帮我把 demo 打开了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbb24fca4efe455ea6f1c14f79537ddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=1diCpbeVDiDxzba0NULY8kS%2F6PU%3D" alt="" loading="lazy"/></p>
<p>这里可以通过 <code>http://localhost:7860/</code> 访问到服务器，就是因为“远程连接”章节中的 SSH 命令中增加了端口映射。</p>
<h3 data-id="heading-6">调试优化</h3>
<p>上面跑起来的 demo，上传测试的 PDF 后，转换报错。</p>
<p>不着急，我们直接让 <code>SOLO</code> 帮忙修复下。</p>
<p><strong>指令</strong></p>
<pre><code class="hljs">demo中上传后报错，请帮我修复
</code></pre>
<p><strong>过程</strong></p>
<p><code>SOLO</code> 可以从终端中获取错误信息，快速定位问题：</p>
<p>“上传解析时报错的根因是 Gradio 处理流程在解析时尝试访问 HuggingFace 获取模型元数据，出现 SSL 错误导致函数返回 None ，最终触发 TypeError: cannot unpack non-iterable NoneType object ”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147e903ead2f409eb39b6ffa8b9c95c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=NjQAkBUNiBJd0hRoLD75Qfim%2B1c%3D" alt="" loading="lazy"/></p>
<p><strong>结果</strong></p>
<p>再次上传 <code>PDF</code>，可以看到提取结果了，已经完成了今天的既定目标了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fad90c7e2c44072961045993260da4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764765405&amp;x-signature=nZEk2Y46KqYNQjC%2F79J7mgqmy%2FQ%3D" alt="" loading="lazy"/></p>
<p>由于模型参数未调优，识别中存在些许问题，非此次分享重点，我们就不再讨论了。</p>
<h2 data-id="heading-7">结语</h2>
<p>整个过程还是非常顺利的，除了我第一次忘记配置模型镜像下载导致的失败。</p>
<p>之前以为 AI 可以自己 <code>SOLO</code> 代码就很酷了，没想到，AI 都已经可以自己掌控服务器了。</p>
<p>给个目标，就能直接等待验收？那后续技术验证、环境搭建脚本岂不是更轻松了。</p>
<p>当部署、调试、优化也能交给 AI 自主完成后，开发者就有了更多的时间去思考“做什么”而非“怎么做”——这或许才是智能时代的生产力跃迁。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG 分块策略：从原理到实战优化，喂饭级教程不允许你踩坑]]></title>    <link>https://juejin.cn/post/7576827115967954979</link>    <guid>https://juejin.cn/post/7576827115967954979</guid>    <pubDate>2025-11-26T08:55:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576827115967954979" data-draft-id="7576676694784294946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG 分块策略：从原理到实战优化，喂饭级教程不允许你踩坑"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-26T08:55:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG 分块策略：从原理到实战优化，喂饭级教程不允许你踩坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:55:59.000Z" title="Wed Nov 26 2025 08:55:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>为什么同样是做 RAG，有的效果拔群，有的却差强人意？分块（Chunking）策略可能是那个被你忽略的关键环节。</p>
<h2 data-id="heading-1">什么是Chunk？</h2>
<p>AI中的分块是指将大型文档分割成称为“chunk”的较小片段。这些片段可以是段落、句子、词组或受token限制的片段，这使得模型能更轻松地仅搜索和检索所需内容。这种分块技术对于优化检索增强生成（RAG）的性能至关重要。</p>
<h2 data-id="heading-2">为什么在RAG中需要Chunk？</h2>
<p>在RAG中，检索到正确的信息是关键，但当知识库非常庞大，可能包含数百万字或文档时，使用有效的RAG分块技术对于从这类大型数据集中高效检索相关信息，就变得至关重要了。举个例子，你有一个服务QPS达到千万级还要在30ms内返回结果，这时一定会搞一组本地缓存的集群。把你的数据按规则初始化到缓存里，就是对应的RAG的Chunk操作。</p>
<p>Chunk也是RAG ETL Pipeline中Transform环节的核心组件之一，可以比喻成我们切蛋糕，在切之前就已经想好要分几块了。让我看看“切蛋糕🍰”有几种手法。</p>
<p>﻿</p>
<h2 data-id="heading-3">二、主流RAG的分块策略详解</h2>
<h3 data-id="heading-4">2.1.固定大小分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e717f4856f4b4d6b8c1e6d1233624a18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=g2xtCDIgEz0NUrWeff8FwuFXQlU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 根据预定义的字符数或 token 数将文本分成统一的块。</p>
<p>•<strong>工作方式：</strong> 例如，固定每块 500 tokens。引入 “重叠区”（Overlap）来缓解上下文断裂问题。</p>
<p>•<strong>优点：</strong> 实现简单，处理速度快，不依赖复杂模型。</p>
<p>•<strong>缺点：</strong> 可能破坏语义完整性（如拆分句子或段落），对结构差异大的文档适应性差。</p>
<h3 data-id="heading-5">2.2.语义分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e691b1f6ab74899b57fedc35ac0bd2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=0PbrXc1dPP93Kudu%2F7nns4uu7GM%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<p>•<strong>核心思想：</strong> 根据文本的语义相似度而非物理结构进行分块，确保每个 Chunk 内部主题高度相关。</p>
<p>•<strong>工作方式：</strong> 通常通过计算句子 Embedding 的余弦相似度，当相似度低于某个阈值时进行分割。</p>
<p>•<strong>优点：</strong> 能创建逻辑上最连贯的 Chunk，对后续检索和生成质量提升显著。特别适用于处理主题跳跃较多的文档。</p>
<p>•<strong>缺点：</strong> 计算成本高（需要调用 Embedding 模型），处理速度较慢。</p>
<h3 data-id="heading-6">2.3.基于递归分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/670c024dfd7c43b993949ac771409482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=NF7aI%2ByLRo0r2qMx0qoUlOT3wV8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 一种更智能的组合式策略，按优先级顺序尝试多种分隔符进行递归分割。</p>
<p>•<strong>工作方式：</strong> 例如，优先按段落分割，如果段落仍过大，再按句子分割，最后才按字符数强制分割。</p>
<p>•<strong>优点：</strong> 尽可能保留高级别的语义结构（段落 &gt; 句子 &gt; ...），适应性强，能处理多种类型文档。</p>
<p>•<strong>缺点：</strong> 实现稍复杂，性能开销高于纯固定大小分块。</p>
<h3 data-id="heading-7">2.4.基于文档的分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a97488467434bb7a0be391548c9780b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=%2BEmotgSPOZxQkpc1vpbZTKqazUE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 利用文档本身的元数据和结构信息（如标题层级、表格、图片说明、PDF 页码等）进行智能分割。</p>
<p>•<strong>工作方式：</strong> 例如，将一个一级标题下的所有内容（包括子标题和段落）作为一个大 Chunk，或者将每个表格单独作为一个 Chunk。</p>
<p>•<strong>优点：</strong> 完美贴合特定类型文档（如法律合同、学术论文、报告）的逻辑结构，信息组织性强。</p>
<p>•<strong>缺点：</strong> 依赖高质量的文档解析和结构识别，通用性相对较弱。</p>
<h3 data-id="heading-8">2.5.智能体分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8593b21374bc4634a5f4eed20831a28f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=xz1Qm%2Bdn1fnEl31%2BxgY1bdrERc0%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<p>﻿</p>
<p>•<strong>核心思想：</strong> 这是一种更前沿的动态策略，根据 Agent 将要执行的具体任务或目标来决定如何分块。</p>
<p>•<strong>工作方式：</strong> Agent 会先理解任务，然后自适应地从文档中提取和组织最相关的信息块。例如，任务是 “总结”，则可能提取关键论点；任务是 “回答特定问题”，则可能精准定位相关证据。</p>
<p>•<strong>优点：</strong> 灵活性和针对性极高，能最大化任务效果。</p>
<p>•<strong>缺点：</strong> 实现复杂，通常需要强大的规划和推理能力，目前还不普及。</p>
<h3 data-id="heading-9">2.6.基于句子的分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a67aeda6ad49a59bd6f28bfa68daec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=mWfClsUnrnUw4UQKfLkYfblJJso%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 将文本分割成完整的句子，确保每个 Chunk 都包含一个或多个完整的思想。</p>
<p>•<strong>工作方式：</strong> 使用 NLP 工具（如 NLTK, SpaCy）识别句子边界，然后可以将几个连续的句子组合成一个 Chunk。</p>
<p>•<strong>优点：</strong> 保证了基本的语义单元完整，避免了 “半句话” 的问题。</p>
<p>•<strong>缺点：</strong> 句子长度差异仍可能导致 Chunk 大小不均；多个句子组合时，如何确定最佳组合仍需策略。</p>
<h3 data-id="heading-10">2.7.基于段落的分块策略</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbabf005b3df4b2aaa70477648bf3e05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=pomnwhwuKz%2FPfPicHwIalOihUM4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>核心思想：</strong> 基于段落的分块，通过提示符截取，将整个文本划分成多个段落。这种方式同样适合结构清晰的文档。</p>
<p>•<strong>工作方式：</strong> 例如，保险条款、法律、论文、AB实验报告等文档。</p>
<p>•<strong>优点：</strong> 优点自然分段，语义完整。</p>
<p>•<strong>缺点：</strong> 缺点自然是段落长度不一，可能超token限制。</p>
<p>﻿</p>
<h3 data-id="heading-11">其他</h3>
<p>除以上7种外，还有很多大神们总结的切块方法论，如按照token、按照层级，按照excel sheet页，按照pdf页码等。都是针对特定场景。下面我结合<strong>实战</strong>和<strong>中文</strong>的切块的方法论做一下总结。</p>
<p>﻿</p>
<h2 data-id="heading-12">三、分块策略的选择与实战优化</h2>
<h3 data-id="heading-13">3.1. 没有“万能”的分块策略</h3>
<p>现实中不存在一种“one-for-all” 的数据读取和分块方法，特别像是 PDF 和 Word 这类复杂格式的文档。比较流行的方案是实用DeepDoc（OCR、TSR、DLR），所以实际中应根据业务，制作不同的模板。那么评估Chunk的参数和指标有哪些呢？ 指标就是<strong>Precision和Recall</strong>，详细看表格 <strong>：</strong></p>

























<table><thead><tr><th>参数</th><th>参考值</th><th>作用</th></tr></thead><tbody><tr><td>chunk_size</td><td>512-1024</td><td>1.切的越小chunks数越多，所以chunk_size跟你的top-k值有关。在 Recall 差不多的情況下，可以选Precision 高的，比较有效率。 2.如果是能力強的大模型，Precision 低一點，也没问题。 3.如果是能力弱的小模型，容易被噪声影响，Precision 太低不好，因此切块需要调小。 4.为什么默认值是512？与主流预训练语言模型的上下文窗口大小（如BERT的512）保持兼容。</td></tr><tr><td>separator</td><td>/n</td><td>分隔符</td></tr><tr><td>overlap</td><td>10%-15%</td><td>通常重叠块长度在10%-20%之间</td></tr></tbody></table>
<p>﻿</p>
<p>Chunk参数与指标，我设计了两套策略：512/10%和2500/25 （单位token）</p>

















<table><thead><tr><th>通用策略（512/10%）</th><th>最大上下文策略（2500/25）</th></tr></thead><tbody><tr><td>chunk_size：512个token，约450多个汉字是相对中等的切块大小。这个大小足以容纳完整的剧组或段落。大多情况可以在“准确率”与“上下文完整性”之间取的平衡</td><td>chunk_size：2500个token相当于2000多个汉字，属于非常大的文本块了。这个设定的背后逻辑是利用现在的大模型（GPT-5.1、gemini 3）的超大token。当任务是进行长篇文件的深度思考推理时，可以提供丰富的信息给到模型，从而获得较高的Precision。</td></tr><tr><td>overlap：10%是比较中庸设定，是业界普遍的建议，能缓解边界切割问题。</td><td>overlap：10个左右汉字，基本可以忽略了，超大文本块被切割的几率相对较小。</td></tr></tbody></table>
<h3 data-id="heading-14">﻿</h3>
<h3 data-id="heading-15">3.2.Chunk策略的选择</h3>
<p>我的方法论：<strong>段落分块（Paragraph Chunking），句子分块（Semantic Chunking），递归分块（Recursive Chunking），语义分块（Semantic Chunking）。</strong></p>
<p>现在的RAG框架基本都是基于段落或句子来分块，也都都支持（\n。；！？）的递归分块。那从运营用户角度出发，或者第一次切的时候，如何傻瓜式操作呢？RAGFlow交出了一份方案，看一下它的分块核心算法</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63a86ad1118a49449dcaf1d79b33dd69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764752159&amp;x-signature=dxXiwgAZLZHvrkAc%2BjYkTAJTjsQ%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-16">四、方法论总结</h2>
<p>如何开始？可以从512 tokens 搭配 10-15%的重叠率开始。</p>
<p>如何优化？调试参数，多使用递归分块和句子分块，语义分块还是不够优秀。</p>
<p>如何测评？上号 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrandonstarxel%2Fchunking_evaluation" target="_blank" title="https://github.com/brandonstarxel/chunking_evaluation" ref="nofollow noopener noreferrer">chunking_evaluation </a>﻿</p>
<p>有和方法论？ 上号 <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2401.17043" target="_blank" title="https://arxiv.org/abs/2401.17043" ref="nofollow noopener noreferrer">CRUD-RAG</a> 论文指出对于创意生成和保持文章连贯性的任务，切分较大的块表现会更佳。我们在</p>
<p>﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2309.15217.pdf" target="_blank" title="https://arxiv.org/pdf/2309.15217.pdf" ref="nofollow noopener noreferrer">RAGas</a>实验也得到了相同的答案。</p>
<p>﻿</p>
<p>好了，以上是我们的实践总结，希望能帮到大家。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agentic 时代必备技能：手把手为 Dify 应用构建全链路可观测系统]]></title>    <link>https://juejin.cn/post/7576827115967791139</link>    <guid>https://juejin.cn/post/7576827115967791139</guid>    <pubDate>2025-11-26T08:38:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576827115967791139" data-draft-id="7576661150684299279" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agentic 时代必备技能：手把手为 Dify 应用构建全链路可观测系统"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-26T08:38:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agentic 时代必备技能：手把手为 Dify 应用构建全链路可观测系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T08:38:32.000Z" title="Wed Nov 26 2025 08:38:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：言合、古琦</p>
<h2 data-id="heading-0">前言</h2>
<p>Dify 是时下热门的低代码 LLM 应用开发平台，其丰富的模型支持、Prompt 编排、RAG 引擎、Workflow/Agent 框架以及插件生态大大便利了 Agentic 应用的开发。</p>
<p>生产级的 Agentic 应用涉及大量动态内容，诸如历史会话、记忆处理，工具调用、知识库召回，模型生成，脚本执行和流程控制等环节给 Agentic 应用生成的效果带来很大不确定性。可观测性贯穿 Agentic 应用开发调试、运维迭代的全生命周期，并串联 Agentic 应用执行和上下游系统中的工具、模型和调用方，是支撑 Agentic 应用生产落地的关键。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c767555e86904128bcb30e84159e00ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=7QQ5BnNtSRW7YJlOXR3KFnAgI9c%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1">Dify 可观测的两个视角丨开发者 &amp; 运维方</h3>
<p>对 Dify 这类低代码平台的可观测性需求，有开发者和平台运维两个视角。</p>
<p>Agentic 应用开发者使用 Dify SaaS 或自部署的 Dify 服务开发 Workflow 应用，专注于 Workflow 的构建，观测的主体是 Dify 平台上运行的一个个 Workflow 应用。关注点在于 Workflow 整体和其中 RAG、Tool、LLM 等各个步骤的执行，开发者依赖可观测服务监测大模型应用生成效果和性能，追踪用户多轮会话的交互体验。在 Agentic 应用开发构建和上线后的迭代维护阶段可观测能力都是 Agentic 应用持续优化的关键。</p>
<p>Dify 平台运维方关注 Dify 集群中从基础设施到各个组件的负载和异常情况，管理 Dify 和上下游的服务和依赖，观测的主体是 Dify 集群及其上下游依赖。Dify 集群包含执行引擎、插件引擎、任务队列、沙箱环境和存储服务等十多个组件；同时还涉及调用方、模型服务、工具访问、外部知识库等上下游依赖。请求过程的全链路可观测是线上问题追溯，性能瓶颈定位的关键工具。</p>
<h3 data-id="heading-2">Dify 可观测现状 &amp; 痛点</h3>
<p>可观测性一直是 Dify 社区活跃的议题，目前 Dify 原生支持的可观测能力由三个方面组成。</p>
<p>其一是 <strong>Dify 内置的应用监控能力</strong>，数据采自 Dify 执行引擎运行过程中生成的执行明细记录，存储在 Dify 数据库内。其特点是和 Dify 自身的集成度最高，在开发调试阶段使用非常方便。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/776d30c9592a49b4801e8ec4e981b2a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Bvb6t4ibpQAQB1RtQXuSYA7dYBI%3D" alt="图片" loading="lazy"/></p>
<p>然而内置的应用监控在分析能力和性能两个方面存在不足。在分析能力上，Workflow 上线后对其观测数据需要多维度的聚合分析或二次加工，问题排查也需要关键字、时间范围、模糊匹配、错误类型等多维度的检索能力，但 Dify 自带的监控只能通过会话 ID 和用户 ID 等有限方式检索，不能满足数据分析和问题排查的需要。在性能上，受限于在 DB 中记录执行日志的数据存储方式，内置应用监控在大规模应用的生产环境下性能不佳，日志数据加载较慢甚至大量的执行明细数据会拖慢数据库整体性能，需要在后台 Celery 任务中配置清理任务周期性清理日志数据。</p>
<p>其二是 <strong>Dify 官方集成的第三方应用追踪服务</strong>，包括<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控</a> / Langfuse 和 LangSmith 等。数据采自 Dify 特有的 OpsTrace 事件机制和 Dify 引擎生成的执行明细记录，主要采集 Workflow/Agent 层面的大模型、工具、知识库召回等节点信息。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">阿里云云监控</a>从 Dify v1.6.0 起也集成了 Dify 官方可观测能力，提供全托管免运维的可观测服务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de98bd86d5c4172b97fdb9d68cf1d47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=W8qHsqwkBVrVXTVixPPMlOEtgQk%3D" alt="图片" loading="lazy"/></p>
<p>第三方集成的追踪服务痛点在于<strong>数据采集粒度受限且缺少全链路追踪能力</strong>。Dify 集成的第三方应用追踪服务主要关注 Agentic 应用开发者视角下的 Wrokflow 执行情况，更多地用于 Prompt 调优、Wrokflow 优化、数据分析等场景，但对于自建 Dify 集群时平台运维方的集群监控和上下游全链路问题排查能提供的帮助就很有限。同时受限于 Dify 的 OpsTrace 机制，能够采集的数据粒度在 Workflow 节点层面，其他更细粒度的数据支持起来比较困难。</p>
<p>其三是对 <strong>Dify 集群自身的可观测性</strong>，面向 Dify 集群各组件及上下游依赖的全链路可观测。目前 Dify 原生支持 Sentry 和 OpenTelemetry 两套可观测方式。两者主要采集 Flask、HTTP、DB、Redis、Celery 等框架层面的数据，对 Dify 自身的内部执行逻辑未做埋点。Sentry 由于相对封闭，目前社区 issue 主要转向更开放的 OTel 生态。</p>
<p>原生 OTel 方式的痛点在于<strong>采集的数据非常有限，无法串联上下游</strong>实现全链路追踪且无法与 Workflow 执行明细数据联动。原生的 OTel 只支持对 Dify 执行引擎和 Celery 任务组件埋点，采集的信息并不完整，同时由于 Dify 架构复杂且存在部分自定义协议，缺少全链路可观测以及和 Workflow 执行明细数据联动的能力。</p>
<h2 data-id="heading-3">Dify 全景可观测——挑战与方案</h2>
<p>针对现有可观测方案的痛点，云监控上线了 Dify 全组件无侵入探针 + Dify 官方集成的应用追踪服务组合的 Dify 全景可观测解决方案，满足 Dify Agentic 应用开发者和 Dify 平台维护者两个视角对可观测性的需要，实现对执行引擎、插件引擎、沙箱环境、插件运行时以及 Workflow 应用的全方位监控。在这一过程中，因 Dify 架构复杂迭代迅速，全景可观测的实现面临多项挑战：</p>
<h3 data-id="heading-4">1. Dify 组件众多，执行链路复杂</h3>
<p>Dify 请求经过网关入口、执行引擎、插件引擎、代码沙箱、插件运行时等多个组件，关联 Celery 后台任务队列，插件运行时受插件引擎的私有协议管理，链路复杂。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控</a>为执行引擎、插件运行提供 Python 探针，通过函数 Patch 实现零代码改动的无侵入埋点；为插件引擎和代码沙箱提供 Go 探针，通过编译时插桩实现无侵入注入；为 Nginx 和 Celery 任务队列提供 OTel 探针的解决方案；对于生命周期受插件引擎管控的插件运行时，通过代码插桩改造插件拉起流程，引入探针挂载逻辑。最终对 Dify 集群内的各个组件，只需配置环境变量并修改启动命令即可实现无侵入注入。</p>
<h3 data-id="heading-5">2. Dify 迭代迅速，代码变动频繁</h3>
<p>Dify 社区已有 1000+ 贡献者，经常一周甚至数天发布一个版本。Dify 实现的频繁变动给无侵入探针的实现带来很大挑战，纯无侵入方式很难跟上 Dify 的发版节奏。</p>
<p>云监控团队和社区积极合作，对接官方提供的第三方集成方式，对于 Dify 内部易变的 Workflow 执行逻辑采用官方方式上报，由社区维护版本更迭引起的改动。同时在无侵入探针中对 Dify 内部方法做最小依赖，仅处理框架层面的埋点和上下文传递过程中的断链问题。</p>
<h3 data-id="heading-6">3. Dify 官方集成的监测和 OTel 生态难以串联</h3>
<p>Dify 官方集成的第三方应用监控服务使用 Dify 自定义的 OpsTrace 机制，采用异步后聚合的方式上报追踪数据，这和标准的 OTel 实现存在较大差异。现有的集成方如 Langfuse 等都无法实现官方的应用追踪和全链路追踪结合。</p>
<p>云监控采用 OTel 格式上报数据，在 Dify 引擎挂载探针时将 traceId 信息透传到后台的 Celery 任务，通过 Trace Link 方式关联 Dify 官方集成方式上报的 Workflow 执行明细数据和无侵入探针上报的全链路追踪数据，实现全景可观测。</p>
<h2 data-id="heading-7">云监控可观测集成</h2>
<h3 data-id="heading-8">接入速览</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215a805636554690a9cb18dfec64518d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=lF5XO8gHh%2BBTw7jDXYCdTX3wo%2B0%3D" alt="图片" loading="lazy"/></p>
<p>云监控给 Dify 的各个组件都提供了可观测方案，其中 Workflow 应用无需挂载探针，在 Dify 控制台上为需要监控的应用开启追踪即可。其余组件需要挂载探针实现监控，其中 API 和 Plugin-Daemon 是核心的工作流和插件系统执行引擎，推荐优先挂载。Sandbox、Worker、Nginx 按需可选挂载。</p>
<h3 data-id="heading-9">版本要求</h3>
<h4 data-id="heading-10">Python 探针</h4>
<p>使用最新版 Python 探针即可，Dify v1.x 版本都可用，因为只采 HTTP/Flask/Redis/DB 等框架层数据，所以 Python 探针对 Dify 版本无强要求。Dify v1.8.0 以后的版本支持通过 Trace Link 方式串联 Dify 官方集成上报的 Workflow 执行明细数据。</p>
<h4 data-id="heading-11">Go 探针</h4>
<p>使用最新版本的 Go 探针即可，Dify v1.x 版本都可用，提供对 dify-plugin-damon 的监控，同时支持对插件生命周期进行监控。</p>
<h4 data-id="heading-12">Dify 原生监控</h4>
<p>从 Dify v1.6.x 开始集成，更高的版本功能更全，推荐使用较新的版本。更新记录如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79959323cae54e3b891b74c8eae1f537~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Jur6z0Yh7%2BbulM3k0z0xdmPt7Rk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">Opentelemetry 插件</h4>
<p>推荐首选 Python 探针，阿里云 Python 探针按照 OTel 标准实现，并在探针基座和数据上报上做了增强。Dify 的 Worker、Nginx 可以使用 OTel 方案。Dify 从 v1.3.0 开始支持 OTel 配置，但上报端点存在兼容性问题，从 Dify v1.7.0 以后支持上报到阿里云的云监控2.0/ARMS 后端。</p>
<h3 data-id="heading-14">监控 Workflow 应用</h3>
<p>使用 Dify 官方集成的云监控可采集 LLM、Tool、RAG 等 Workflow 层面的 Trace 数据，即 Dify 官方集成的监控采集大模型应用数据，一个 Workflow 对应一个大模型应用。</p>
<p>限于 Dify 框架特性，Dify 官方集成的云监控和 Python 探针采集的 Trace 无法直接联通，但可以通过 Trace Link 方式实现大模型应用和微服务应用的相关关联，通过 Python 探针和 Dify 原生监控组合实现 API 组件的可观测。</p>
<h4 data-id="heading-15">前提条件</h4>
<p>Dify 版本 &gt;= 1.6.0</p>
<h4 data-id="heading-16">步骤一：获取阿里云 Endpoint 和 License Key</h4>
<p>方式一）云监控 2.0 且 Dify 版本 &gt;= 1.9.1 的用户推荐使用云监控 2.0 的上报端点：</p>
<ol>
<li>
<p>登录云监控 2.0 控制台，在左侧导航栏单击接入中心。</p>
</li>
<li>
<p>在应用监控&amp;链路追踪区域单击 Dify 卡片。</p>
</li>
<li>
<p>在弹出的接入面板中选择数据上报地域，点击获取 LicenseKey。</p>
</li>
<li>
<p>记录生成的 LicenseKey 和 Endpoint。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/011914895a7f43a481eeb59208911244~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=5sgZL7sw%2BL1n7zfVPCSNciMmwDY%3D" alt="图片" loading="lazy"/></p>
<p>方式二）<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Farms%3Fspm%3Da1z389.11499242.0.0.65452413yOc5rP%26utm_content%3Dg_1000408142" target="_blank" title="https://www.aliyun.com/product/arms?spm=a1z389.11499242.0.0.65452413yOc5rP&amp;utm_content=g_1000408142" ref="nofollow noopener noreferrer">ARMS</a> 用户或 Dify 版本在 1.6.0～1.9.0 的用户可以使用 ARMS 的上报端点，数据也会在云监控 2.0 上同步呈现：</p>
<ol>
<li>
<p>登录 ARMS 控制台，在左侧导航栏单击接入中心。</p>
</li>
<li>
<p>在服务端应用区域单击 OpenTelemetry 卡片。</p>
</li>
<li>
<p>在弹出的 OpenTelemetry 面板中选择数据上报地域，上报方式选 gRPC。</p>
</li>
<li>
<p>记录生成的 LicenseKey 和 Endpoint，注意 Endpoint 不要带端口号。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a65d3ea809046c68dc01bce25e87beb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=ngyc0HDEgtyIbd6X9SIDm7t1PAE%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-17">步骤二：配置应用性能追踪</h4>
<ol>
<li>
<p>登录 Dify 控制台，并进入需要监控的 Dify 应用。</p>
</li>
<li>
<p>在左侧导航栏单击监测。</p>
</li>
<li>
<p>单击追踪应用性能，然后在云监控区域单击配置。</p>
</li>
<li>
<p>在弹出的对话框中输入步骤一获取的 License Key 和 Endpoint，并自定义 App Name（ARMS 控制台显示的应用名称），然后单击保存并启用。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca257e9687a4b918ff735379fd303be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=zVjRZp2rF5dYKphlJLX8YOZeNW8%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-18">步骤三：查看 Dify 应用监控数据</h4>
<p>配置完毕后在 Dify 控制台或通过 Dify API 发起几次请求，稍等 1～2 分钟即可登录阿里云控制台查看上报的数据。</p>
<p>方式一：监控 2.0 用户在应用中心- AI 应用可观测处查看</p>
<p>方式二：ARMS 用户在 LLM 应用监控处查看</p>
<p><strong>应用详情示例：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd080d6ce771403987e394600a9a815c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=3%2FIocsqIkXxCtTSBkBENOQZbqYA%3D" alt="图片" loading="lazy"/></p>
<p><strong>调用链详情示例：</strong></p>
<p>LLM 节点会采集系统/用户提示词、模型输出、模型提供商和型号、token 用量等信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7f92d57fa4d4e6199dc722af405b03b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=L9z4jQlm5i3zwFg4izFQgBYoaCE%3D" alt="图片" loading="lazy"/></p>
<p>Retriever 节点会采集查询语句、召回片段、关联文档元数据、embbeding 评分等信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a351fc888844770bd172f54d4684fc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Ki14WctZgV6Jg1QNN9mrV2qBCS0%3D" alt="图片" loading="lazy"/></p>
<p>Tool 节点会采集工具参数和调用结果、工具提供商和描述等信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95aa2c0ec49141068afccaa622b53a77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=3fbOgKrvscyWwujNEap0kbhh%2BhM%3D" alt="图片" loading="lazy"/></p>
<p>其他流程节点也都会采集节点的输入输出、会话 ID、用户 ID 等必要数据。</p>
<p>接入可参考文档[3][4]。</p>
<h3 data-id="heading-19">监控执行引擎 API</h3>
<p>API 是 Dify 执行引擎。使用 Python 探针可采集 HTTP/Flask/Redis/DB 等框架层面的 Trace 数据，并关联上下游调用实现全链路追踪，即 Python 探针采集微服务数据，API 组件对应一个微服务应用。</p>
<h4 data-id="heading-20">步骤一：安装 Python 探针</h4>
<p>首先需要卸载冲突的 OTel 插件，下载并安装 Python 探针。</p>
<p>启动脚本开头改动</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保pip环境</span>
python -m ensurepip --upgrade

<span class="hljs-comment"># 卸载冲突的OTel插件</span>
pip3 uninstall -y opentelemetry-instrumentation-celery \
  opentelemetry-instrumentation-flask \
  opentelemetry-instrumentation-redis \
  opentelemetry-instrumentation-requests \
  opentelemetry-instrumentation-logging \
  opentelemetry-instrumentation-wsgi \
  opentelemetry-instrumentation-fastapi \
  opentelemetry-instrumentation-asgi \
  opentelemetry-instrumentation-sqlalchemy

<span class="hljs-comment"># 安装Python探针</span>
pip3 config <span class="hljs-built_in">set</span> global.index-url https://mirrors.aliyun.com/pypi/simple/ &amp;&amp; pip3 config <span class="hljs-built_in">set</span> install.trusted-host mirrors.aliyun.com
pip3 install aliyun-bootstrap &amp;&amp; aliyun-bootstrap -a install
</code></pre>
<p><strong>提示：</strong></p>
<p>可以通过 Docker 数据卷挂载方式用修改后的启动脚本替换原脚本（修改源码并重打镜像也可以）。即将修改后的脚本作为配置项挂载到容器目录内，并指定容器从此脚本启动。例如：</p>
<p>将修改后的脚本 entrypoint.sh 存储为配置项，并挂载到容器目录 /app/api/docker。</p>
<p>指定启动命令：["/bin/bash","/app/api/docker/entrypoint.sh"]</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16bf9c3ba8bd4cf7b74ebafe95bdb4c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=42kRrfGt9ddXNf9t4e7BRgpwsw4%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-21">步骤二：修改启动命令</h4>
<p>在启动脚本最后的应用启动部分做修改，从 aliyun-instrument 启动：</p>
<p>启动脚本末尾改动</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用aliyun-instrument启动</span>
<span class="hljs-built_in">exec</span> aliyun-instrument gunicorn \
      --<span class="hljs-built_in">bind</span> <span class="hljs-string">"<span class="hljs-variable">${DIFY_BIND_ADDRESS:-0.0.0.0}</span>:<span class="hljs-variable">${DIFY_PORT:-5001}</span>"</span> \
      --workers <span class="hljs-variable">${SERVER_WORKER_AMOUNT:-1}</span> \
      --worker-class <span class="hljs-variable">${SERVER_WORKER_CLASS:-gevent}</span> \
      --worker-connections <span class="hljs-variable">${SERVER_WORKER_CONNECTIONS:-10}</span> \
      --<span class="hljs-built_in">timeout</span> <span class="hljs-variable">${GUNICORN_TIMEOUT:-200}</span> \
      app:app
</code></pre>
<p>同理此步骤也可以通过修改镜像打包过程或通过挂载 K8S 配置项并替换 Dify 启动脚本的方式实现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b018a7ed8f24d9bb851032e19a02009~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=FlQs%2FuUGFyQ3JxrUIks7Fwl6q%2Fo%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-22">步骤三：配置环境变量</h4>
<p>配置如下环境变量，应用名、地域和 License Key 根据实际情况填写。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692375ca8b844b4e85ee655417062a39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=ykq%2Fjxwpji54g7LfA268%2FzTBtHo%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-23">步骤四：部署并查看 API 监控数据</h4>
<p>进入应用监控列表可以看到 dify-api 应用，应用详情示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e04c1d649e734abf9905b5e2d485d68d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=PICxuZzFy5C8A9EnijtD%2B%2FUTWLA%3D" alt="图片" loading="lazy"/></p>
<p>调用链会串联上下游调用信息，示例数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67eba21a02843b499e28167f2ab384e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=P9o%2BWMuxktAhAMG3loTJBZXVc9I%3D" alt="图片" loading="lazy"/></p>
<p>可以参考文档[5]，注意如果直接使用 ack-onepilot 自动注入，会存在 Dify 自带的 OTel SDK 和 Python 探针冲突的问题，还需要手动改启动脚本卸载冲突的 OTel 依赖。</p>
<h3 data-id="heading-24">监控插件引擎 Dify-Plugin-Daemon</h3>
<p>Dify-Plugin-Daemon 是 Dify 的插件管理器，Dify 的 LLM、插件、Agent 策略的执行都依赖 Plugin-Daemon。Go Agent[2]支持监控 Dify-Plugin-Daemon，接入 Go 监控需修改Dockerfile、重新编译镜像后配置环境变量开启。Plugin-Daemon 的 Go 探针同时也会自动为插件运行时挂载 Python 探针。</p>
<h4 data-id="heading-25">步骤一：修改 Dockerfile 文件重新编译对应镜像</h4>
<p>local.dockerfile 修改示例</p>
<p>DockerFile</p>
<pre><code class="hljs language-bash" lang="bash">FROM golang:1.23-alpine AS builder


ARG VERSION=unknown
<span class="hljs-comment"># copy project</span>
COPY . /app
<span class="hljs-comment"># set working directory</span>
WORKDIR /app
<span class="hljs-comment"># using goproxy if you have network issues</span>
<span class="hljs-comment"># ENV GOPROXY=https://goproxy.cn,direct</span>
<span class="hljs-comment"># download arms instgo</span>
RUN wget <span class="hljs-string">"http://arms-apm-cn-hangzhou.oss-cn-hangzhou.aliyuncs.com/instgo/instgo-linux-amd64"</span> -O instgo
RUN <span class="hljs-built_in">chmod</span> 777 instgo
<span class="hljs-comment"># instgo build</span>
RUN INSTGO_EXTRA_RULES=<span class="hljs-string">"dify_python"</span> ./instgo go build \
    -ldflags <span class="hljs-string">"\
    -X 'github.com/langgenius/dify-plugin-daemon/internal/manifest.VersionX=<span class="hljs-variable">${VERSION}</span>' \
    -X 'github.com/langgenius/dify-plugin-daemon/internal/manifest.BuildTimeX=<span class="hljs-subst">$(date -u +%Y-%m-%dT%H:%M:%S%z)</span>'"</span> \
    -o /app/main cmd/server/main.go
<span class="hljs-comment"># copy entrypoint.sh</span>
COPY entrypoint.sh /app/entrypoint.sh
RUN <span class="hljs-built_in">chmod</span> +x /app/entrypoint.sh
FROM ubuntu:24.04
WORKDIR /app
<span class="hljs-comment"># check build args</span>
ARG PLATFORM=<span class="hljs-built_in">local</span>
<span class="hljs-comment"># Install python3.12if PLATFORM is local</span>
RUN apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y curl python3.12 python3.12-venv python3.12-dev python3-pip ffmpeg build-essential \
    &amp;&amp; apt-get clean \
    &amp;&amp; <span class="hljs-built_in">rm</span> -rf /var/lib/apt/lists/* \
    &amp;&amp; update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1;
<span class="hljs-comment"># preload tiktoken</span>
ENV TIKTOKEN_CACHE_DIR=/app/.tiktoken
<span class="hljs-comment"># Install dify_plugin to speedup the environment setup, test uv and preload tiktoken</span>
RUN <span class="hljs-built_in">mv</span> /usr/lib/python3.12/EXTERNALLY-MANAGED /usr/lib/python3.12/EXTERNALLY-MANAGED.bk \
    &amp;&amp; python3 -m pip install uv \
    &amp;&amp; uv pip install --system dify_plugin \
    &amp;&amp; python3 -c <span class="hljs-string">"from uv._find_uv import find_uv_bin;print(find_uv_bin());"</span> \
    &amp;&amp; python3 -c <span class="hljs-string">"import tiktoken; encodings = ['o200k_base', 'cl100k_base', 'p50k_base', 'r50k_base', 'p50k_edit', 'gpt2']; [tiktoken.get_encoding(encoding).special_tokens_set for encoding in encodings]"</span>
ENV UV_PATH=/usr/local/bin/uv
ENV PLATFORM=<span class="hljs-variable">$PLATFORM</span>
ENV GIN_MODE=release
COPY --from=builder /app/main /app/entrypoint.sh /app/
<span class="hljs-comment"># run the server, using sh as the entrypoint to avoid process being the root process</span>
<span class="hljs-comment"># and using bash to recycle resources</span>
CMD [<span class="hljs-string">"/bin/bash"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"/app/entrypoint.sh"</span>]
</code></pre>
<p>注意 INSTGO_EXTRA_RULES 选项会开启 Plugin 运行时自动监测功能，如果不需要在 Plugin-Daemon 启动时拉起对 Plugin 探针，可以去除编译文件中的<code>INSTGO_EXTRA_RULES="dify_python"。</code></p>
<h4 data-id="heading-26">步骤二：配置环境变量</h4>
<p>方式一）ECS 环境</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a14ec06f90f44155b0bd899e6ea1d2fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=E%2Bpeiy1kp2YXQZ2WRw5cbxrg4WI%3D" alt="图片" loading="lazy"/></p>
<p>方式二）容器化 ack-onepilot 环境</p>
<p>在 dify-plugin-daemon 应用的 YAML 配置中将以下 labels 添加到 spec.template.metadata 层级下。</p>
<pre><code class="hljs language-bash" lang="bash">labels:
  aliyun.com/app-language: golang
  armsPilotAutoEnable: <span class="hljs-string">'on'</span>
  armsPilotCreateAppName: <span class="hljs-string">"dify-daemon-plugin"</span>
</code></pre>
<h4 data-id="heading-27">步骤三：部署并查看 dify-plugin-daemon 监控</h4>
<p>在应用列表页面进入 dify-plugin-daemon 应用，监控详情如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58ac56cd7ef24c119d2a7db118a59370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=IFOGvcgL99hkyGAlVsx1qAaPUIo%3D" alt="图片" loading="lazy"/></p>
<p><strong>调用链详情：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac53088b9e66401c95422be50dfbd1ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=6hAhQq8xXNCOyOHZjOurjLYx4Po%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-28">步骤四：查看 Plugin 监控</h4>
<p>挂载探针后，Plugin-Daemon 会自动拉起插件运行时的探针。每个插件运行时对应一个可观测应用，应用名为 {plugin_daemon_name}<em>plugin</em>{plugin_name}_{plugin_version}。例如，Plugin-Daemon 配置的应用名为 local-dify-plugin-daemon，安装了 tongyi 的 version 0.0.53 插件时，会自动生成应用 local-dify-plugin-daemon_plugin_tongyi_0.0.53。</p>
<p>插件监控概览页示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02763908464745ddba514613fadaad9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=67YjRhs2uZFciyoBgCzmMbcpyVE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-29">(可选) 监控代码沙箱 Sandbox</h3>
<p>Sandbox 是 Dify 代码沙箱引擎，负责执行 Workflow 中的 Python/Node.js 代码。Go 探针支持监控 Sandbox，需修改 Dockerfile、重新编译镜像后配置环境变量开启。</p>
<h4 data-id="heading-30">步骤一：修改 Dockerfile 文件重新编译对应镜像</h4>
<p>修改 ./build/build_[amd64|arm64].sh 文件。</p>
<p>a. 添加 instgo 下载命令。</p>
<p>下载命令示例如下，其他地域和架构的下载命令请参见下载 instgo。</p>
<p>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fdeveloper-reference%2Finstgo-tool-introduction%255B%239b94bbe8a62ra%25EF%25BC%2589" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/developer-reference/instgo-tool-introduction%5B#9b94bbe8a62ra%EF%BC%89" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<pre><code class="hljs language-bash" lang="bash">wget <span class="hljs-string">"http://arms-apm-cn-hangzhou.oss-cn-hangzhou.aliyuncs.com/instgo/instgo-linux-amd64"</span> -O instgo
<span class="hljs-built_in">chmod</span> 777 instgo
</code></pre>
<p>b. 在 <code>go build</code> 前添加 <code>instgo</code> 命令。</p>
<p>以 amd64 为例，修改示例如下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">rm</span> -f internal/core/runner/python/python.so
<span class="hljs-built_in">rm</span> -f internal/core/runner/nodejs/nodejs.so
<span class="hljs-built_in">rm</span> -f /tmp/sandbox-python/python.so
<span class="hljs-built_in">rm</span> -f /tmp/sandbox-nodejs/nodejs.so
wget <span class="hljs-string">"http://arms-apm-cn-hangzhou.oss-cn-hangzhou.aliyuncs.com/instgo/instgo-linux-amd64"</span> -O instgo
<span class="hljs-built_in">chmod</span> 777 instgo
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Building Python lib"</span>
CGO_ENABLED=1 GOOS=linux GOARCH=amd64 ./instgo go build -o internal/core/runner/python/python.so -buildmode=c-shared -ldflags=<span class="hljs-string">"-s -w"</span> cmd/lib/python/main.go &amp;&amp;
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Building Nodejs lib"</span> &amp;&amp;
CGO_ENABLED=1 GOOS=linux GOARCH=amd64 ./instgo go build -o internal/core/runner/nodejs/nodejs.so -buildmode=c-shared -ldflags=<span class="hljs-string">"-s -w"</span> cmd/lib/nodejs/main.go &amp;&amp;
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Building main"</span> &amp;&amp;
GOOS=linux GOARCH=amd64 ./instgo go build -o main -ldflags=<span class="hljs-string">"-s -w"</span> cmd/server/main.go
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Building env"</span>
GOOS=linux GOARCH=amd64 ./instgo go build -o <span class="hljs-built_in">env</span> -ldflags=<span class="hljs-string">"-s -w"</span> cmd/dependencies/init.go
</code></pre>
<h4 data-id="heading-31">步骤二：配置环境变量</h4>
<p>方式一）无 ack-onepilot 环境</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/636de4fea1ba4df388e678b033c1292b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=UMp4vE%2FC7Da%2BuYs0XwYfnohVztQ%3D" alt="图片" loading="lazy"/></p>
<p>方式二）容器化 ack-onepilot 环境</p>
<p>在 dify-plugin-daemon 应用的 YAML 配置中将以下 labels 添加到 spec.template.metadata 层级下。</p>
<pre><code class="hljs language-bash" lang="bash">labels:
  aliyun.com/app-language: golang
  armsPilotAutoEnable: <span class="hljs-string">'on'</span>
  armsPilotCreateAppName: <span class="hljs-string">"dify-daemon-plugin"</span>
</code></pre>
<h3 data-id="heading-32">步骤三：部署并查看 sandbox 监控</h3>
<p>在应用列表页面进入 dify-sandbox 应用，监控详情如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae047344ee80435e904f9c0194e681f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Y6U4bD3OhAGluZix7Js7uiw8VRg%3D" alt="图片" loading="lazy"/></p>
<p><strong>调用链详情：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fbaf52127eb4d2089932fa04bcdfd86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=MR5AIp%2FKsI%2BpBr%2BOASuV%2BNrUpHM%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p><strong>参考文档：</strong></p>
<p>监控 Go 应用</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fuser-guide%2Fmonitoring-the-golang-applications%2F" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/user-guide/monitoring-the-golang-applications/" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fuser-guide%2Fconnect-a-dify-application-to-arms-application-monitoring(%25E6%25AD%25A5%25E9%25AA%25A4%25E4%25BA%2594)" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/user-guide/connect-a-dify-application-to-arms-application-monitoring(%E6%AD%A5%E9%AA%A4%E4%BA%94)" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
</blockquote>
<h3 data-id="heading-33">(可选) 监控任务队列 Worker</h3>
<p>Worker 是 Dify 后台任务组件，知识库构建和周期性清理任务依赖 Worker 执行。按普通 Python Celery 应用方式接入即可。这里给出使用 Dify 内置的 OTel 插件上报数据的示例：</p>
<h4 data-id="heading-34">步骤一：修改 Worker 环境变量</h4>
<p>OTel 插件是 Dify 内置功能，直接修改环境变量即可。注意要求 Dify 1.7.0 以上版本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e3f6587c64405b9a3a4c710f9b37e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=SiojLQfW6wPHik4GYNGkKQHEH6c%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-35">步骤二：部署并查看 Worker 监控</h4>
<p>进入应用监控/ OpenTelemetry 监控页面查看上报的数据。</p>
<p>Worker 执行的后台任务 Trace 详情示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec32342ce9dc4987ac13f0e10543d630~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=QuiZVT7nWh7SKNV%2FjlpyfAoRMyE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-36">(可选) 监控入口网关 Nginx</h3>
<p>Nginx 是 Dify 的入口网关，一些超时问题和知识库/插件/Workflow 的文件上传问题可能和 Nginx 配置有关。</p>
<p>直接使用 Opentelemetry 方式上报即可，推荐使用预构建的 Nginx-OTel 镜像方式。</p>
<h4 data-id="heading-37">步骤一：下载预构建 Docker 镜像</h4>
<p>前往 Docker 官网，搜索并拉取带有 -otel 后缀的 Nginx 镜像（如 nginx:1.29.0-otel），通过标准容器启动流程部署服务。</p>
<h4 data-id="heading-38">步骤二：获取 gRPC 接入点和鉴权 Token 信息</h4>
<p>登录可观测链路 OpenTelemetry 版控制台，在接入中心选取 OpenTelemetry 卡片，选择 gRPC 协议上报数据。</p>
<p>记录接入点和鉴权 Token 备用。</p>
<p>在开源框架区域单击，在弹出的 OpenTelemetry 面板中选择数据需要上报的地域。</p>
<h4 data-id="heading-39">步骤三：启用 Nginx OTel 模块</h4>
<p>修改 Nginx 配置文件 nginx.conf.template：</p>
<p>Nginx 配置文件</p>
<pre><code class="hljs language-bash" lang="bash">load_module modules/ngx_otel_module.so; <span class="hljs-comment"># 加载 ngx_otel_module</span>
...
http {
    ...

    otel_exporter {
        endpoint <span class="hljs-string">"<span class="hljs-variable">${GRPC_ENDPOINT}</span>"</span>; <span class="hljs-comment"># 前提条件中获取的 gRPC 接入点</span>
        header Authentication <span class="hljs-string">"<span class="hljs-variable">${GRPC_TOKEN}</span>"</span>; <span class="hljs-comment"># 前提条件中获取的鉴权 Token</span>
    }

    otel_trace on;                     <span class="hljs-comment"># 开启链路追踪</span>
    otel_service_name <span class="hljs-variable">${SERVICE_NAME}</span>;  <span class="hljs-comment"># 应用名</span>
    otel_trace_context propagate;         <span class="hljs-comment"># 向下游服务注入Trace上下文</span>
    ...
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5227e4b9ca54920a9a9a53844bb74ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Bu5XRQk9cTA6X70IBB4c2SVgdwI%3D" alt="图片" loading="lazy"/></p>
<p>可参考文档[6]接入 Nginx 监控。</p>
<h2 data-id="heading-40">实践指南</h2>
<h3 data-id="heading-41">关联 LLM Trace 和微服务 Trace=</h3>
<p>Dify 的 Workflow 执行数据通过官方集成方式上报 Trace，而 Dify-api、Dify-Worker、Dify-Plugin-Daemon 等基础设施通过无侵入探针按 OTel 标准上报 Trace。这两套割裂的体系无法直接融合，阿里云提供了 Trace Link 能力，将应用层和基础设施层的两条 Trace 串联。</p>
<p><strong>从 LLM Trace 跳转微服务 Trace：</strong></p>
<p>进入一条 LLM Trace 的详情，可以看到完整的 Workflow 执行数据，但如何找到基础设施组件的 span 和上下游串联数据？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24fafe96a69b49048838f757dfd418e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=jNXWyQ0AcuH5JH2Q%2BdjLK1JaWAg%3D" alt="图片" loading="lazy"/></p>
<p>选中一个 span，在 span 右侧的附加信息面板选择 Links 标签页，可以看到和此 LLM Trace 相关联的基础设施 Trace 的信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d5e80d4adcb42dca86b90a8ea68a61a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=6r%2Bm4DZN45tktcRh2ET4JwWyM%2Bc%3D" alt="图片" loading="lazy"/></p>
<p>点击“查询关联的调用链”，可以直接跳转到关联的基础设施 Trace：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/305362d503c8496fb726565b9f31e53c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=%2BZGzsXOkfnHqkbPTcm4Ya%2BmIYA4%3D" alt="图片" loading="lazy"/></p>
<p>从 微服务 Trace 跳转 LLM Trace：</p>
<p>在基础设施的微服务 Trace 上，可以看到 nginx、dify-api、dify-plugin-daemon、dify-sandbox 等各个组件的 Trace 数据，是否可以将它关联到 Dify 官方集成的 Trace 数据上？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c8195d657974f3298a3aff0cd747a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=gRdQvmhpAG93%2BZ4V285Hp8r2W3I%3D" alt="图片" loading="lazy"/></p>
<p>点击调用链上方的筛选功能，用 span 名称筛选，找到名称为 AdvancedChatAppRunner.run 或 WorkflowAppRunner.run 的 span。（取决于 Dify Workflow 的类型，如果调用了子 Workflow 可能会有多个这样的 span）。</p>
<p>如果对应的 Workflow 开启了云监控追踪，在 span 附加信息的 Links 页签可以看到关联的 LLM Trace Id，点击“查询关联的调用链”可跳转到相应 LLM Trace。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/990d1a3ed5c545f68a7fa98197d5aa49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=ift9PpxfUZAT232KQs506nz%2Bnp8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-42">分析执行引擎异常根因</h3>
<p>工作流层面的异常通常在 LLM Trace 或 Dify 日志追踪里可以看到直观的报错信息，但还有一类错误是底层 Dify 引擎的配置不当或内部 bug 引起的。无侵入探针提供了对这类错误的定位分析能力。</p>
<p>如图的示例场景，在 Dify Workflow 的某次执行中发现知识检索的输出总是为空，但是 Dify 控制台上又没有报错信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/786acfb4f8554128a091f809faaaab86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=h3c3W5FC1scrPu2m9g0ylyfCDCE%3D" alt="图片" loading="lazy"/></p>
<p>此时，可以根据 Dify 对话 ID、用户 ID 等信息在云监控上定位对应的 LLM Trace：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5837c0bfdb804b0ba9e478a2666385a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=5wY53GrBvbzDjPFxn%2FhujFfWIs4%3D" alt="图片" loading="lazy"/></p>
<p>进入会话详情，找到对应 Trace 和相关 Span，首先尝试在 Span 详情中查找相关信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53f1b598bab8498bad1c3b84e8f897a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Lw1ZkBwcHL3SiYMEpylaOlIglQw%3D" alt="图片" loading="lazy"/></p>
<p>这个 Case 的问题不在 Wrokflow 层面，所以只能观察到输出异常，要定位具体原因，可以通过上一节介绍的 Links 功能，跳转到对应的 Dify infra 层 Trace：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84477c7605d54eb9a70998491736c6f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=FjjOpKOyqqXgq4HbHMHtImrhScs%3D" alt="图片" loading="lazy"/></p>
<p>可以观察到 Trace 上存在部分错误 Span，通过快捷筛选直接定位错误 Span：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/320193f2edd744a1beb37b19071725dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=Lz3FlEESb2EoNHvRTjfnJ22H9Kg%3D" alt="图片" loading="lazy"/></p>
<p>在错误 Span 的 Details 和 Events 中，可以看到错误信息和异常堆栈。并定位到根因是 Weaviate 向量存储配置引起的问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a58664826c8b4ad4acc96f2ecc2feff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=IhAli%2FHfPX46Qt3osBWPzoboM3w%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-43">定位插件慢调用</h3>
<p>Dify 社区提供了丰富的插件生态，但管理插件的 Dify-Plugin-Daemon 和插件运行时却是难以定位故障的黑盒。在 Dify 控制台上能清晰地看到各个工作流节点的运行记录，但对于流程节点之下 Dify infra 设施的故障却无从分析。一次 Workflow 调用链路涉及 Nginx、API、Plugin-Daemon、Plugin 运行时和模型网关等多个组件，阿里云云监控提供的全链路追踪能力可以串联上下游的完整链路，定位插件内的错慢异常。</p>
<p>如图示例中“查询 SLS 日志”是一个 Dify 插件，正常调用只需 200 ms，但在这个 Trace 中却有 5s 多的慢调用。仅看 LLM Trace 或 Dify 执行日志，无法判断慢请求是因为 Dify-Api 引擎、Dify-Plugin-Daemon 插件引擎、Dify-Plugin 运行时或者 SLS 日志服务本身导致的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/870192cf24ea4ab8a18159450602d410~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=HZiPR7WdfcJ7OZY7C99aiDiNC3o%3D" alt="图片" loading="lazy"/></p>
<p>通过 Links 找到关联的 Infra 层调用，可以看到 Trace 详情：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08ea1a24080041efbb9aec94f0cf7d38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=1nuEpsJiHfJ7s8%2BLmskoX3PO2Cc%3D" alt="图片" loading="lazy"/></p>
<p>Dify 引擎会做大量 DB 和 Redis 访问，排查非 DB/Redis 类问题时，可以在组件标签处点选并滤去 sqlalchemy 和 redis 组件的 Span 以便排查。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e4d0b5cb3e743c29c6979fe32545e53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764751112&amp;x-signature=3iKdzKHNuo%2BPwycjp9FaXN%2FyUyg%3D" alt="图片" loading="lazy"/></p>
<p>可以看到 dify 执行引擎（local-dify-api）发起了对 dify 插件引擎（local-dify-plugin-daemon）的 POST 调用，插件引擎调用插件运行时（local-dify-plugin-daemon_plugin_cms_0.0.1）并转发请求给 SLS 服务端口。整个链路上耗时最长的是 dify_plugin_execute，这是插件运行时内部的入口方法，我们正是在此处注入了故障模拟的慢调用。</p>
<p>欢迎大家加入我们的钉钉群，共同构建更好的 Dify 全链路监控能力。</p>
<ul>
<li>
<p>LoongSuite Python 开源交流群：101925034286</p>
</li>
<li>
<p>LoongSuite Go Agent 开源交流群：102565007776</p>
</li>
<li>
<p>ARMS 多语言应用监控产品交流群：159215000379</p>
</li>
</ul>
<p><strong>参考：</strong></p>
<p>[1] 获取 LicenseKey</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fdeveloper-reference%2Fapi-arms-2019-08-08-describetracelicensekey-apps" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/developer-reference/api-arms-2019-08-08-describetracelicensekey-apps" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<p>[2] ARMS 应用监控支持的 Go 组件和框架</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fdeveloper-reference%2Fgo-components-and-frameworks-supported-by-arms-application-monitoring" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/developer-reference/go-components-and-frameworks-supported-by-arms-application-monitoring" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<p>[3] Dify 官方监控接入</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Ftracing-analysis%2Funtitled-document-1750672984680" target="_blank" title="https://help.aliyun.com/zh/arms/tracing-analysis/untitled-document-1750672984680" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/tra…</a></p>
<p>[4] 集成阿里云云监控</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.dify.ai%2Fzh-hans%2Fguides%2Fmonitoring%2Fintegrate-external-ops-tools%2Fintegrate-aliyun" target="_blank" title="https://docs.dify.ai/zh-hans/guides/monitoring/integrate-external-ops-tools/integrate-aliyun" ref="nofollow noopener noreferrer">docs.dify.ai/zh-hans/gui…</a></p>
<p>[5] Dify Python 探针接入</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fcms%2Fcloudmonitor-2-0%2Fuser-guide%2Fmonitor-dify-applications" target="_blank" title="https://help.aliyun.com/zh/cms/cloudmonitor-2-0/user-guide/monitor-dify-applications" ref="nofollow noopener noreferrer">help.aliyun.com/zh/cms/clou…</a></p>
<p>[6] 使用 OpenTelemetry 对 Nginx 进行链路追踪</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fopentelemetry%2Fuser-guide%2Fuse-opentelemetry-to-perform-tracing-analysis-on-nginx" target="_blank" title="https://help.aliyun.com/zh/opentelemetry/user-guide/use-opentelemetry-to-perform-tracing-analysis-on-nginx" ref="nofollow noopener noreferrer">help.aliyun.com/zh/opentele…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[支付请求幂等性设计：从原理到落地，杜绝重复扣款]]></title>    <link>https://juejin.cn/post/7576843726011301914</link>    <guid>https://juejin.cn/post/7576843726011301914</guid>    <pubDate>2025-11-26T10:01:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576843726011301914" data-draft-id="7576838095519105075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="支付请求幂等性设计：从原理到落地，杜绝重复扣款"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-26T10:01:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            支付请求幂等性设计：从原理到落地，杜绝重复扣款
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T10:01:52.000Z" title="Wed Nov 26 2025 10:01:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">支付请求幂等性设计：从原理到落地，杜绝重复扣款</h2>
<p>支付场景中，“重复支付” 是最致命的问题之一 —— 用户点击两次支付按钮、网络延迟导致系统重试、第三方支付回调重复通知，都可能导致 “一笔订单扣两次款”。一旦发生，不仅会引发用户投诉，还可能造成资金损失与合规风险。而解决这一问题的核心，就是<strong>保证支付请求的幂等性</strong>。</p>
<p>本文结合电商、金融支付的实战经验，从 “为什么需要幂等性”“重复请求的来源”“具体实现方案” 到 “落地避坑”，完整拆解支付幂等性的设计逻辑，提供可直接复用的技术方案。</p>
<h3 data-id="heading-1">一、先搞懂：支付场景的幂等性是什么？</h3>
<h4 data-id="heading-2">1. 幂等性的定义</h4>
<p>在计算机领域，幂等性是指：<strong>同一操作无论执行多少次，最终结果都是一致的</strong>。</p>
<p>对于支付请求，幂等性的核心要求是：</p>
<ul>
<li>同一笔订单，无论用户发起多少次支付请求，都只扣一次款；</li>
</ul>

<ul>
<li>同一笔支付回调，无论第三方（如微信支付、支付宝）重复通知多少次，都只更新一次订单状态；</li>
</ul>

<ul>
<li>重复操作不会产生额外的业务影响（如重复生成支付记录、重复发送扣款短信）。</li>
</ul>
<h4 data-id="heading-3">2. 为什么支付场景必须保证幂等性？</h4>
<p>支付的核心是 “资金安全”，幂等性是资金安全的底线：</p>
<ul>
<li>若不保证幂等性：用户因网络卡顿重复点击支付，可能导致 “一笔订单扣两次款”（资损风险）；</li>
</ul>

<ul>
<li>若不保证幂等性：第三方支付回调重复通知，可能导致 “订单已支付但重复回调更新状态”（业务混乱）；</li>
</ul>

<ul>
<li>合规要求：金融支付场景需满足 “一笔交易一次清算”，幂等性是合规的基础。</li>
</ul>
<h3 data-id="heading-4">二、支付请求重复的 4 个常见场景</h3>
<p>在设计方案前，先明确 “重复请求从哪来”，才能针对性解决：</p>






























<table><thead><tr><th>重复场景</th><th>具体描述</th><th>典型案例</th></tr></thead><tbody><tr><td>用户重复操作</td><td>用户点击支付按钮后，因页面无响应再次点击（或连续点击）</td><td>电商下单后，用户快速点击 “微信支付” 按钮 3 次</td></tr><tr><td>网络延迟 / 超时重试</td><td>支付请求发送后，因网络延迟未收到响应，客户端 / 服务端触发重试</td><td>移动端支付请求超时，APP 自动重试 2 次</td></tr><tr><td>系统故障重发</td><td>服务端处理支付时宕机，重启后重新接收未完成的请求</td><td>支付服务处理中数据库宕机，恢复后重放请求</td></tr><tr><td>第三方支付回调重复通知</td><td>微信支付 / 支付宝的支付结果回调，因网络波动重复发送</td><td>支付宝回调通知超时，重复发送 3 次支付成功通知</td></tr></tbody></table>
<p><strong>关键结论</strong>：重复请求无法避免（用户操作、网络、系统都可能导致），必须通过技术手段让重复请求 “无害”。</p>
<h3 data-id="heading-5">三、核心方案：支付幂等性的 5 种实现方式（按易落地排序）</h3>
<p>支付幂等性的实现核心是 “<strong>唯一标识 + 状态校验</strong>”—— 用唯一标识区分请求，用状态校验判断是否允许执行，以下是 5 种主流方案，覆盖不同场景：</p>
<h4 data-id="heading-6">方案 1：唯一订单号（幂等号）—— 最基础、最常用</h4>
<h5 data-id="heading-7">原理</h5>
<p>用<strong>全局唯一的订单号</strong>作为幂等标识，支付请求必须携带该订单号，服务端通过订单号判断是否已处理：</p>
<ol>
<li>下单时生成唯一订单号（如ORDER202511210001），关联用户、金额等核心信息；</li>
</ol>

<ol start="2">
<li>用户支付时，请求携带该订单号；</li>
</ol>

<ol start="3">
<li>服务端接收请求后，先查询 “该订单号是否已支付 / 处理中”；</li>
</ol>

<ol start="4">
<li>若已处理：直接返回成功结果；若未处理：执行支付逻辑；若处理中：返回 “处理中”（避免并发重复）。</li>
</ol>
<h5 data-id="heading-8">实现步骤（Java+MySQL）</h5>
<ol>
<li><strong>订单表设计</strong>（核心字段）：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `payment_order` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `order_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'唯一订单号（幂等标识）'</span>,
  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
  `amount` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付金额'</span>,
  `status` tinyint <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付状态：0=待支付，1=支付中，2=已支付，3=支付失败'</span>,
  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  `update_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'更新时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_order_no` (`order_no`) COMMENT <span class="hljs-string">'订单号唯一索引（确保幂等）'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'支付订单表'</span>;
</code></pre>
<ul>
<li>关键：order_no加唯一索引，避免重复创建订单；status字段用于状态校验。</li>
</ul>
<ol start="2">
<li><strong>服务端支付接口实现</strong>：</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentOrderMapper orderMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PayGatewayClient payGateway; <span class="hljs-comment">// 调用第三方支付网关（如微信支付）</span>
    
    <span class="hljs-comment">/**
     * 支付接口（保证幂等性）
     * <span class="hljs-doctag">@param</span> orderNo 唯一订单号（幂等标识）
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@param</span> amount 支付金额
     * <span class="hljs-doctag">@return</span> 支付结果
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> PaymentResultDTO pay(String orderNo, <span class="hljs-built_in">Long</span> userId, BigDecimal amount) {
        <span class="hljs-comment">// 步骤1：查询订单（通过唯一订单号）</span>
        PaymentOrder order = orderMapper.selectByOrderNo(orderNo);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 步骤2：已处理过，直接返回结果</span>
            <span class="hljs-keyword">if</span> (order.getStatus() == <span class="hljs-number">2</span>) { <span class="hljs-comment">// 已支付</span>
                <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (order.getStatus() == <span class="hljs-number">1</span>) { <span class="hljs-comment">// 支付中</span>
                <span class="hljs-keyword">return</span> PaymentResultDTO.processing(<span class="hljs-string">"支付处理中，请稍后查询"</span>, orderNo);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (order.getStatus() == <span class="hljs-number">3</span>) { <span class="hljs-comment">// 支付失败，允许重试</span>
                <span class="hljs-keyword">return</span> processPayment(orderNo, userId, amount);
            }
        }
        <span class="hljs-comment">// 步骤3：未处理，执行支付逻辑</span>
        <span class="hljs-keyword">return</span> processPayment(orderNo, userId, amount);
    }
    
    <span class="hljs-comment">/**
     * 核心支付逻辑（抽离复用）
     */</span>
    <span class="hljs-keyword">private</span> PaymentResultDTO processPayment(String orderNo, <span class="hljs-built_in">Long</span> userId, BigDecimal amount) {
        <span class="hljs-comment">// 步骤1：创建订单（唯一索引保证不会重复创建）</span>
        PaymentOrder newOrder = new PaymentOrder();
        newOrder.setOrderNo(orderNo);
        newOrder.setUserId(userId);
        newOrder.setAmount(amount);
        newOrder.setStatus(<span class="hljs-number">1</span>); <span class="hljs-comment">// 状态设为“支付中”（防止并发重复）</span>
        <span class="hljs-keyword">try</span> {
            orderMapper.insert(newOrder);
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 并发场景下，其他线程已创建订单，直接查询返回</span>
            <span class="hljs-keyword">return</span> pay(orderNo, userId, amount);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 步骤2：调用第三方支付网关（如微信支付统一下单接口）</span>
            PayGatewayResponse gatewayResp = payGateway.unifiedOrder(orderNo, amount);
            <span class="hljs-keyword">if</span> (gatewayResp.isSuccess()) {
                <span class="hljs-comment">// 步骤3：支付成功，更新状态为“已支付”</span>
                orderMapper.updateStatusByOrderNo(orderNo, <span class="hljs-number">2</span>);
                <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 步骤4：支付失败，更新状态为“支付失败”</span>
                orderMapper.updateStatusByOrderNo(orderNo, <span class="hljs-number">3</span>);
                <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"支付失败："</span> + gatewayResp.getMsg(), orderNo);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 步骤5：异常情况，更新状态为“支付失败”</span>
            orderMapper.updateStatusByOrderNo(orderNo, <span class="hljs-number">3</span>);
            log.error(<span class="hljs-string">"支付异常，订单号：{}"</span>, orderNo, e);
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"支付异常，请重试"</span>, orderNo);
        }
    }
}
</code></pre>
<h5 data-id="heading-9">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：单体应用、订单驱动的支付（如电商订单支付）、同步支付请求；</li>
</ul>

<ul>
<li><strong>优点</strong>：实现简单，无额外依赖（仅用订单表），兼容性强；</li>
</ul>

<ul>
<li><strong>缺点</strong>：依赖订单号的唯一性，若订单号生成规则泄露可能被恶意利用（需配合签名验证）。</li>
</ul>
<h4 data-id="heading-10">方案 2：令牌机制（Token）—— 适合前端重复提交</h4>
<h5 data-id="heading-11">原理</h5>
<p>针对 “用户重复点击” 场景，通过 “预生成令牌” 控制支付请求的唯一性：</p>
<ol>
<li>前端发起支付前，先调用 “获取支付令牌” 接口，服务端生成唯一 Token（如TOKEN_123456），存入 Redis（设置 15 分钟过期）；</li>
</ol>

<ol start="2">
<li>前端携带该 Token 发起支付请求；</li>
</ol>

<ol start="3">
<li>服务端校验 Token：若 Token 不存在（已使用 / 过期），拒绝请求；若存在，执行支付逻辑并删除 Token（或标记为已使用）。</li>
</ol>
<h5 data-id="heading-12">实现步骤（Java+Redis）</h5>
<ol>
<li><strong>获取令牌接口</strong>：</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/api/pay"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    <span class="hljs-keyword">private</span> static <span class="hljs-keyword">final</span> String TOKEN_PREFIX = <span class="hljs-string">"pay:token:"</span>;
    
    <span class="hljs-comment">/**
     * 获取支付令牌（前端支付前调用）
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 唯一Token
     */</span>
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/get-token"</span>)</span>
    <span class="hljs-keyword">public</span> ResultDTO getPayToken(<span class="hljs-built_in">Long</span> userId) {
        <span class="hljs-comment">// 生成唯一Token（UUID+用户ID，确保唯一性）</span>
        String token = <span class="hljs-string">"TOKEN_"</span> + UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>) + <span class="hljs-string">"_"</span> + userId;
        <span class="hljs-comment">// 存入Redis，过期时间15分钟（避免Token长期有效）</span>
        redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(TOKEN_PREFIX + token, userId.toString(), <span class="hljs-number">15</span>, TimeUnit.MINUTES);
        <span class="hljs-keyword">return</span> ResultDTO.success(token);
    }
}
</code></pre>
<ol start="2">
<li><strong>支付接口（结合 Token 校验）</strong> ：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOKEN_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"pay:token:"</span>;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> PaymentResultDTO <span class="hljs-title function_">payWithToken</span><span class="hljs-params">(String token, String orderNo, Long userId, BigDecimal amount)</span> {
        <span class="hljs-comment">// 步骤1：Token校验（核心幂等逻辑）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> TOKEN_PREFIX + token;
        <span class="hljs-type">String</span> <span class="hljs-variable">redisUserId</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(redisKey);
        <span class="hljs-keyword">if</span> (redisUserId == <span class="hljs-literal">null</span> || !redisUserId.equals(userId.toString())) {
            <span class="hljs-comment">// Token不存在/已使用/用户不匹配，拒绝请求</span>
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"无效的支付请求，请刷新页面重试"</span>, orderNo);
        }
        
        <span class="hljs-comment">// 步骤2：订单校验（同方案1，双重保障）</span>
        <span class="hljs-type">PaymentOrder</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
        <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span> &amp;&amp; order.getStatus() == <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 步骤3：执行支付逻辑（同方案1）</span>
            <span class="hljs-type">PaymentResultDTO</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> processPayment(orderNo, userId, amount);
            
            <span class="hljs-comment">// 步骤4：支付完成后，删除Token（标记为已使用）</span>
            redisTemplate.delete(redisKey);
            
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 异常时不删除Token，允许重试（避免因系统异常导致无法支付）</span>
            log.error(<span class="hljs-string">"支付异常，Token：{}，订单号：{}"</span>, token, orderNo, e);
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"支付异常，请重试"</span>, orderNo);
        }
    }
}
</code></pre>
<h5 data-id="heading-13">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：前端重复提交（如按钮连续点击）、移动端支付、需要防止恶意请求的场景；</li>
</ul>

<ul>
<li><strong>优点</strong>：Token 一次性有效，安全性高，能有效防止无 Token 的恶意支付请求；</li>
</ul>

<ul>
<li><strong>缺点</strong>：多一步 “获取 Token” 接口调用，增加前端开发成本；依赖 Redis（分布式场景需 Redis 集群）。</li>
</ul>
<h4 data-id="heading-14">方案 3：支付状态机校验 —— 防止状态回退</h4>
<h5 data-id="heading-15">原理</h5>
<p>支付订单的状态变更遵循固定流程（如 “待支付→支付中→已支付”），通过状态机限制 “不允许的状态变更”，避免重复处理：</p>
<ul>
<li>状态流转规则：0=待支付 → 1=支付中 → 2=已支付 或 3=支付失败；</li>
</ul>

<ul>
<li>幂等逻辑：若当前状态是 “已支付” 或 “支付中”，拒绝重复支付请求；只有 “待支付” 或 “支付失败” 状态允许执行支付。</li>
</ul>
<h5 data-id="heading-16">实现示例（状态机校验）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 支付状态机校验（工具类）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentStateMachine</span> {
    <span class="hljs-comment">// 状态流转规则：key=当前状态，value=允许流转的目标状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Integer, List&lt;Integer&gt;&gt; STATE_RULES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 待支付（0）可流转到：支付中（1）</span>
        STATE_RULES.put(<span class="hljs-number">0</span>, Collections.singletonList(<span class="hljs-number">1</span>));
        <span class="hljs-comment">// 支付中（1）可流转到：已支付（2）、支付失败（3）</span>
        STATE_RULES.put(<span class="hljs-number">1</span>, Arrays.asList(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));
        <span class="hljs-comment">// 支付失败（3）可流转到：支付中（1）（允许重试）</span>
        STATE_RULES.put(<span class="hljs-number">3</span>, Collections.singletonList(<span class="hljs-number">1</span>));
        <span class="hljs-comment">// 已支付（2）不可流转到任何状态（不允许重复支付）</span>
        STATE_RULES.put(<span class="hljs-number">2</span>, Collections.emptyList());
    }
    
    <span class="hljs-comment">/**
     * 校验状态是否允许流转
     * <span class="hljs-doctag">@param</span> currentState 当前状态
     * <span class="hljs-doctag">@param</span> targetState 目标状态
     * <span class="hljs-doctag">@return</span> true=允许，false=不允许
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkStateTransition</span><span class="hljs-params">(<span class="hljs-type">int</span> currentState, <span class="hljs-type">int</span> targetState)</span> {
        List&lt;Integer&gt; allowedStates = STATE_RULES.getOrDefault(currentState, Collections.emptyList());
        <span class="hljs-keyword">return</span> allowedStates.contains(targetState);
    }
}
<span class="hljs-comment">// 支付接口中使用状态机校验</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> PaymentResultDTO <span class="hljs-title function_">payWithStateMachine</span><span class="hljs-params">(String orderNo, Long userId, BigDecimal amount)</span> {
    <span class="hljs-type">PaymentOrder</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
    <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 状态机校验：若当前状态不允许流转到“支付中”，直接返回</span>
        <span class="hljs-keyword">if</span> (!PaymentStateMachine.checkStateTransition(order.getStatus(), <span class="hljs-number">1</span>)) {
            <span class="hljs-keyword">if</span> (order.getStatus() == <span class="hljs-number">2</span>) {
                <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"当前订单状态不允许支付"</span>, orderNo);
            }
        }
    }
    <span class="hljs-comment">// 后续执行支付逻辑（同方案1）</span>
    <span class="hljs-keyword">return</span> processPayment(orderNo, userId, amount);
}
</code></pre>
<h5 data-id="heading-17">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：复杂支付流程（如分期支付、预授权支付）、需要严格控制状态流转的场景；</li>
</ul>

<ul>
<li><strong>优点</strong>：状态校验严谨，能防止 “已支付订单重复支付”“支付中订单被重复处理”；</li>
</ul>

<ul>
<li><strong>缺点</strong>：需维护状态机规则，适合状态流转清晰的场景。</li>
</ul>
<h4 data-id="heading-18">方案 4：防重表 —— 分布式场景的强一致性保障</h4>
<h5 data-id="heading-19">原理</h5>
<p>针对分布式系统（多服务实例），用 “防重表” 记录已处理的支付请求，通过数据库唯一索引保证幂等：</p>
<ol>
<li>防重表仅存储 “幂等标识”（如订单号、支付流水号），无其他业务字段；</li>
</ol>

<ol start="2">
<li>支付请求到达后，先向防重表插入幂等标识；</li>
</ol>

<ol start="3">
<li>若插入成功（无重复），执行支付逻辑；若插入失败（已存在），直接返回成功结果。</li>
</ol>
<h5 data-id="heading-20">实现步骤</h5>
<ol>
<li><strong>防重表设计</strong>：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `payment_idempotent` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `idempotent_key` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'幂等标识（订单号/支付流水号）'</span>,
  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_idempotent_key` (`idempotent_key`) COMMENT <span class="hljs-string">'幂等标识唯一索引'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'支付防重表'</span>;
</code></pre>
<ul>
<li>核心：idempotent_key加唯一索引，确保同一标识只能插入一次。</li>
</ul>
<ol start="2">
<li><strong>分布式支付接口实现</strong>：</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedPaymentService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentIdempotentMapper idempotentMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentOrderMapper orderMapper;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> PaymentResultDTO distributedPay(String orderNo, <span class="hljs-built_in">Long</span> userId, BigDecimal amount) {
        <span class="hljs-comment">// 步骤1：插入防重表（核心幂等逻辑）</span>
        PaymentIdempotent idempotent = new PaymentIdempotent();
        idempotent.setIdempotentKey(orderNo); <span class="hljs-comment">// 用订单号作为幂等标识</span>
        <span class="hljs-keyword">try</span> {
            idempotentMapper.insert(idempotent);
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 插入失败，说明已处理过，查询订单状态返回</span>
            PaymentOrder order = orderMapper.selectByOrderNo(orderNo);
            <span class="hljs-keyword">if</span> (order != <span class="hljs-literal">null</span> &amp;&amp; order.getStatus() == <span class="hljs-number">2</span>) {
                <span class="hljs-keyword">return</span> PaymentResultDTO.success(<span class="hljs-string">"支付成功"</span>, orderNo);
            }
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"该订单已提交支付，请稍后查询结果"</span>, orderNo);
        }
        
        <span class="hljs-comment">// 步骤2：执行支付逻辑（同方案1）</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> processPayment(orderNo, userId, amount);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 步骤3：支付失败，删除防重表记录（允许重试）</span>
            idempotentMapper.deleteByIdempotentKey(orderNo);
            log.error(<span class="hljs-string">"分布式支付异常，订单号：{}"</span>, orderNo, e);
            <span class="hljs-keyword">return</span> PaymentResultDTO.fail(<span class="hljs-string">"支付异常，请重试"</span>, orderNo);
        }
    }
}
</code></pre>
<h5 data-id="heading-21">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：分布式系统（多服务实例）、高并发支付（如秒杀支付）、需要强一致性的场景；</li>
</ul>

<ul>
<li><strong>优点</strong>：不依赖缓存，数据库唯一索引保证强一致性，适合分布式环境；</li>
</ul>

<ul>
<li><strong>缺点</strong>：多一张防重表，增加数据库存储成本；插入删除操作增加数据库压力（可通过分表优化）。</li>
</ul>
<h4 data-id="heading-22">方案 5：第三方支付回调幂等 —— 处理重复通知</h4>
<h5 data-id="heading-23">原理</h5>
<p>第三方支付平台（微信支付、支付宝）的支付结果回调可能重复发送，需单独处理回调的幂等性：</p>
<ol>
<li>第三方回调会携带唯一的 “支付流水号”（如微信的transaction_id、支付宝的trade_no）；</li>
</ol>

<ol start="2">
<li>服务端接收回调后，先校验该流水号是否已处理；</li>
</ol>

<ol start="3">
<li>若已处理：直接返回第三方 “成功” 标识（避免第三方重复通知）；若未处理：更新订单状态并记录流水号。</li>
</ol>
<h5 data-id="heading-24">实现步骤（以微信支付回调为例）</h5>
<ol>
<li><strong>回调记录表设计</strong>（存储已处理的回调流水号）：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `payment_callback_record` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `third_party_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'第三方支付流水号（如微信transaction_id）'</span>,
  `order_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'关联订单号'</span>,
  `callback_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'回调时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_third_party_no` (`third_party_no`) COMMENT <span class="hljs-string">'第三方流水号唯一索引'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'支付回调记录表'</span>;
</code></pre>
<ol start="2">
<li><strong>微信支付回调接口实现</strong>：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@RestController</span>
<span class="hljs-keyword">@RequestMapping</span>(<span class="hljs-string">"/api/pay/callback"</span>)
public class WechatPayCallbackController {
    <span class="hljs-keyword">@Autowired</span>
    private PaymentCallbackRecordMapper callbackMapper;
    <span class="hljs-keyword">@Autowired</span>
    private PaymentOrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 微信支付回调接口（保证幂等性）
     */</span>
    <span class="hljs-keyword">@PostMapping</span>(<span class="hljs-string">"/wechat"</span>)
    public String wechatPayCallback(<span class="hljs-keyword">@RequestBody</span> String xmlData) {
        <span class="hljs-comment">// 步骤1：解析微信回调数据（获取transaction_id、order_no、result_code等）</span>
        WechatCallbackDTO callbackDTO = <span class="hljs-built_in">parseWechatCallback</span>(xmlData);
        String thirdPartyNo = callbackDTO<span class="hljs-selector-class">.getTransactionId</span>(); <span class="hljs-comment">// 第三方唯一流水号</span>
        String orderNo = callbackDTO<span class="hljs-selector-class">.getOutTradeNo</span>(); <span class="hljs-comment">// 商户订单号</span>
        
        <span class="hljs-comment">// 步骤2：校验回调是否已处理（幂等核心）</span>
        PaymentCallbackRecord record = callbackMapper<span class="hljs-selector-class">.selectByThirdPartyNo</span>(thirdPartyNo);
        if (record != null) {
            <span class="hljs-comment">// 已处理，返回微信“成功”标识（避免重复回调）</span>
            return <span class="hljs-built_in">buildWechatSuccessXml</span>();
        }
        
        <span class="hljs-comment">// 步骤3：校验支付结果（仅处理支付成功的回调）</span>
        if (!"SUCCESS".equals(callbackDTO.getResultCode())) {
            log<span class="hljs-selector-class">.error</span>("微信支付回调失败，订单号：{}，原因：{}", orderNo, callbackDTO.getErrCodeDes());
            return <span class="hljs-built_in">buildWechatFailXml</span>("支付失败");
        }
        
        try {
            <span class="hljs-comment">// 步骤4：更新订单状态为“已支付”</span>
            int updateCount = orderMapper<span class="hljs-selector-class">.updateStatusByOrderNo</span>(orderNo, <span class="hljs-number">2</span>);
            if (updateCount == <span class="hljs-number">0</span>) {
                log<span class="hljs-selector-class">.error</span>("订单不存在或已处理，订单号：{}", orderNo);
                return <span class="hljs-built_in">buildWechatSuccessXml</span>(); <span class="hljs-comment">// 仍返回成功，避免重复回调</span>
            }
            
            <span class="hljs-comment">// 步骤5：记录回调流水号（标记为已处理）</span>
            PaymentCallbackRecord newRecord = new <span class="hljs-built_in">PaymentCallbackRecord</span>();
            newRecord<span class="hljs-selector-class">.setThirdPartyNo</span>(thirdPartyNo);
            newRecord<span class="hljs-selector-class">.setOrderNo</span>(orderNo);
            callbackMapper<span class="hljs-selector-class">.insert</span>(newRecord);
            
            <span class="hljs-comment">// 步骤6：返回成功标识</span>
            return <span class="hljs-built_in">buildWechatSuccessXml</span>();
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("微信支付回调处理异常，订单号：{}", orderNo, e);
            <span class="hljs-comment">// 回调处理失败，返回失败标识，微信会重试（需做好重试机制）</span>
            return <span class="hljs-built_in">buildWechatFailXml</span>("处理异常");
        }
    }
    
    <span class="hljs-comment">// 工具方法：解析微信回调XML、构建返回XML（省略）</span>
    private WechatCallbackDTO <span class="hljs-built_in">parseWechatCallback</span>(String xmlData) { <span class="hljs-comment">/* ... */</span> }
    private String <span class="hljs-built_in">buildWechatSuccessXml</span>() { <span class="hljs-comment">/* ... */</span> }
    private String <span class="hljs-built_in">buildWechatFailXml</span>(String msg) { <span class="hljs-comment">/* ... */</span> }
}
</code></pre>
<h5 data-id="heading-25">关键注意点</h5>
<ul>
<li>必须用第三方提供的 “唯一流水号” 作为幂等标识，而非商户订单号（避免同一订单多次支付的回调冲突）；</li>
</ul>

<ul>
<li>回调处理成功后，无论订单状态是否更新成功，都需返回第三方 “成功” 标识（否则第三方会持续重复回调）；</li>
</ul>

<ul>
<li>回调接口需支持幂等重试（如订单不存在时仍返回成功，避免第三方重复通知）。</li>
</ul>
<h3 data-id="heading-26">四、实战案例：电商支付幂等性完整流程</h3>
<p>结合以上方案，以电商支付为例，梳理完整的幂等性保障流程：</p>
<ol>
<li><strong>下单阶段</strong>：生成唯一订单号ORDER202511210001，订单状态设为 “待支付”；</li>
</ol>

<ol start="2">
<li><strong>前端支付前</strong>：调用 “获取 Token” 接口，获取 TokenTOKEN_XXX；</li>
</ol>

<ol start="3">
<li><strong>支付请求阶段</strong>：前端携带 Token + 订单号发起支付，服务端执行：</li>
</ol>
<ul>
<li>
<ul>
<li>Token 校验（方案 2）→ 订单状态校验（方案 3）→ 防重表插入（方案 4）→ 调用第三方支付；</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>第三方回调阶段</strong>：微信支付回调携带transaction_id，服务端执行：</li>
</ol>
<ul>
<li>
<ul>
<li>回调流水号校验（方案 5）→ 更新订单状态→ 记录回调记录；</li>
</ul>
</li>
</ul>
<ol start="5">
<li><strong>重复请求处理</strong>：用户重复点击支付时，服务端通过 Token / 防重表 / 订单状态直接返回结果，不重复扣款。</li>
</ol>
<h3 data-id="heading-27">五、避坑指南：支付幂等性的 6 个关键注意事项</h3>
<ol>
<li><strong>幂等标识必须全局唯一</strong>：订单号、Token、第三方流水号等幂等标识，需保证全局唯一（如订单号用 “时间戳 + 随机数 + 用户 ID” 生成）；</li>
</ol>

<ol start="2">
<li><strong>并发场景加锁</strong>：高并发支付时，需用分布式锁（如 Redis 锁）锁定订单号，避免 “同时插入防重表” 导致的 DuplicateKeyException 过多；</li>
</ol>

<ol start="3">
<li><strong>异常处理需谨慎</strong>：支付失败 / 系统异常时，需释放幂等标识（如删除 Token、防重表记录），允许用户重试；</li>
</ol>

<ol start="4">
<li><strong>避免状态回退</strong>：已支付的订单不允许再次支付（状态机限制），防止 “已支付订单重复扣款”；</li>
</ol>

<ol start="5">
<li><strong>第三方回调必须幂等</strong>：第三方回调的幂等性独立处理，不依赖订单状态（避免同一订单多次支付的回调冲突）；</li>
</ol>

<ol start="6">
<li><strong>日志与监控</strong>：记录每笔支付的幂等校验结果、状态变更日志，监控重复请求次数，异常时触发告警（如重复支付请求突增）。</li>
</ol>
<h3 data-id="heading-28">六、方案选型建议</h3>



































<table><thead><tr><th>业务场景</th><th>推荐方案组合</th><th>核心原因</th></tr></thead><tbody><tr><td>中小电商（单体应用）</td><td>唯一订单号（方案 1）+ 状态机（方案 3）</td><td>实现简单，无额外依赖，满足基础幂等需求</td></tr><tr><td>移动端支付（防重复点击）</td><td>令牌机制（方案 2）+ 唯一订单号（方案 1）</td><td>Token 防止重复点击，订单号双重保障</td></tr><tr><td>分布式电商（多服务）</td><td>防重表（方案 4）+ 状态机（方案 3）</td><td>分布式强一致性，支持高并发</td></tr><tr><td>第三方支付回调</td><td>回调流水号校验（方案 5）</td><td>针对性处理第三方重复通知</td></tr><tr><td>秒杀支付（高并发）</td><td>防重表（方案 4）+ Redis 分布式锁</td><td>兼顾高并发与强一致性</td></tr></tbody></table>
<h3 data-id="heading-29">总结：支付幂等性的核心逻辑</h3>
<p>支付幂等性的本质是 “<strong>用唯一标识锁定操作，用状态校验控制流程</strong>”—— 无论重复请求来自用户、网络还是系统，只要通过 “唯一标识判断是否已处理”，就能保证结果一致。</p>
<p>设计时需遵循 “<strong>简单优先，兼顾场景</strong>”：</p>
<ul>
<li>中小团队 / 单体应用：优先用 “唯一订单号 + 状态机”，低成本落地；</li>
</ul>

<ul>
<li>分布式 / 高并发场景：叠加 “防重表 + 分布式锁”，保证强一致性；</li>
</ul>

<ul>
<li>第三方回调：单独用 “第三方流水号” 做幂等，避免重复通知。</li>
</ul>
<p>最终，支付幂等性是资金安全的底线，没有 “最优方案”，只有 “最适合业务场景的方案”—— 结合自身业务规模、技术架构选择组合方案，同时做好监控与日志，才能杜绝重复扣款，保障用户与平台的资金安全。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter之阿里云视频播放器支持 iOS模拟器解决方案]]></title>    <link>https://juejin.cn/post/7576556950331867136</link>    <guid>https://juejin.cn/post/7576556950331867136</guid>    <pubDate>2025-11-26T03:16:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576556950331867136" data-draft-id="7576559408659103796" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter之阿里云视频播放器支持 iOS模拟器解决方案"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-26T03:16:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卢叁"/> <meta itemprop="url" content="https://juejin.cn/user/1292681403434270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter之阿里云视频播放器支持 iOS模拟器解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1292681403434270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卢叁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:16:30.000Z" title="Wed Nov 26 2025 03:16:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题描述</h2>
<p>项目中要做视频播放，接入阿里云的 <code>flutter_aliplayer</code>后模拟器跑不起来</p>
<pre><code class="hljs language-bash" lang="bash">Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AVPFilter</span>

Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AVPFilterConfig</span>

Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AVPFilterOptions</span>

Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AVPPreloadTask</span>

Error (Xcode): Undefined symbol: _OBJC_CLASS_<span class="hljs-variable">$_AliMediaLoaderV2</span>

</code></pre>
<h3 data-id="heading-1">问题原因</h3>
<p>AliPlayer SDK 的 <code>AliyunPlayer.framework</code> 在 iOS 模拟器架构（x86_64/arm64-simulator）中缺少以下符号的实现：</p>
<ul>
<li>
<p><code>AVPFilter</code>、<code>AVPFilterConfig</code>、<code>AVPFilterOptions</code> - 视频滤镜相关类</p>
</li>
<li>
<p><code>AVPPreloadTask</code>、<code>AliMediaLoaderV2</code> - 预加载功能相关类</p>
</li>
</ul>
<p>这些符号在真机架构（arm64）中存在，但在模拟器架构中缺失，导致链接失败。</p>
<h2 data-id="heading-2">解决方案</h2>
<p>通过在 <code>flutter_aliplayer</code> 插件中添加条件编译，在模拟器上使用存根实现，在真机上使用完整实现。</p>
<h3 data-id="heading-3">核心思路</h3>
<ol>
<li>
<p><strong><strong>条件编译</strong></strong>：使用 <code>#if TARGET_OS_SIMULATOR</code> 区分模拟器和真机</p>
</li>
<li>
<p><strong><strong>存根实现</strong></strong>：在模拟器上提供最小化实现，返回明确的错误提示</p>
</li>
<li>
<p><strong><strong>完整实现</strong></strong>：在真机上使用完整的 AliPlayer SDK 功能</p>
</li>
<li>
<p><strong><strong>依赖管理</strong></strong>：通过 <code>dependency_overrides</code> 使用修改后的本地版本</p>
</li>
</ol>
<h2 data-id="heading-4">实现细节</h2>
<h3 data-id="heading-5">1. 修改 <code>FlutterAliMediaLoaderV2.m</code></h3>
<p>为预加载 v2 功能添加模拟器存根：</p>
<pre><code class="hljs language-objective-c" lang="objective-c">
#import "FlutterAliMediaLoaderV2.h"

#import &lt;TargetConditionals.h&gt;

#if TARGET_OS_SIMULATOR
// 模拟器版本：返回错误，不调用任何 AliPlayer API

- (void)handleMethodCall:(FlutterMethodCall*)call result:(FlutterResult)result {

    result([FlutterError errorWithCode:@"AliPlayerPreloadV2Unavailable"

                               message:@"AliPlayer preload v2 is not available on the iOS Simulator."

                               details:nil]);

}

  


#else

// 真机版本：正常实现

// ... 原有完整实现 ...

#endif

</code></pre>
<h3 data-id="heading-6">2. 修改 AliPlayerFactory.m</h3>
<p>为滤镜功能添加模拟器保护：</p>
<pre><code class="hljs language-objective-c" lang="objective-c">
- (void)setFilterConfig:(NSArray *)arr {

    FlutterResult result = arr[1];

#if TARGET_OS_SIMULATOR

    result([FlutterError errorWithCode:@"AliPlayerFilterUnavailable"

                               message:@"Video filter effects are not available on the iOS Simulator."

                               details:nil]);

    return;

#else

    // 真机版本：正常实现滤镜功能

    // ... 原有完整实现 ...

#endif

}

  


- (void)updateFilterConfig:(NSArray *)arr {

    FlutterResult result = arr[1];

#if TARGET_OS_SIMULATOR

    result([FlutterError errorWithCode:@"AliPlayerFilterUnavailable"

                               message:@"Video filter effects are not available on the iOS Simulator."

                               details:nil]);

    return;

#else

    // 真机版本：正常实现

    // ... 原有完整实现 ...

#endif

}

</code></pre>
<p>修改完毕后，就可以愉快的用模拟器开发啦。个人开发直接放在本地，使用模拟器开发的时候引用本地<code>flutter_aliplayer</code>包，真机上线时使用阿里云的正式包。团队开发时最好把修改后的代码上传到自己公司的git,然后配置打包脚本。</p>
<h2 data-id="heading-7">项目配置</h2>
<h3 data-id="heading-8">1. 使用 Git 仓库版本</h3>
<p>在 <code>pubspec.yaml</code> 中配置 <code>dependency_overrides</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-attr">dependency_overrides:</span>

  <span class="hljs-attr">flutter_aliplayer:</span>

    <span class="hljs-attr">git:</span>

      <span class="hljs-attr">url:</span> <span class="hljs-string">自己的.git</span>

</code></pre>
<h3 data-id="heading-9">2. 构建脚本自动切换</h3>
<p><code>build.sh</code> 脚本会在不同场景自动切换依赖源：</p>
<ul>
<li>
<p>注释掉 git 配置，使用 pub.dev 原始版本</p>
</li>
<li>
<p>取消注释 git 配置，使用包含模拟器修复的版本</p>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 注释掉 flutter_aliplayer git 配置，使用 pub.dev 版本</span>

comment_flutter_aliplayer_override

  


<span class="hljs-comment"># 恢复 flutter_aliplayer git 配置，使用 git 版本（包含模拟器修复）</span>

uncomment_flutter_aliplayer_override

</code></pre>
<h3 data-id="heading-10">模拟器上的限制</h3>
<p>在 iOS 模拟器上，视频播放的功能不可用，修改只是为了开发中方便使用iOS模拟器。</p>
<h3 data-id="heading-11">符号检查</h3>
<p>可以通过以下命令检查框架中的符号：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 检查所有架构</span>

lipo -info ios/Pods/AliPlayerSDK_iOS/AliyunPlayer.framework/AliyunPlayer

<span class="hljs-comment"># 检查 x86_64 架构中的符号</span>

lipo ios/Pods/AliPlayerSDK_iOS/AliyunPlayer.framework/AliyunPlayer -thin x86_64 -output /tmp/AliyunPlayer_x86_64

nm -gU /tmp/AliyunPlayer_x86_64 | grep AVPFilter

</code></pre>
<h3 data-id="heading-12">依赖管理</h3>
<ul>
<li>
<p><strong><strong>开发环境</strong></strong>：使用 git 仓库版本（包含模拟器修复）</p>
</li>
<li>
<p><strong><strong>生产环境</strong></strong>：使用 pub.dev 原始版本（避免本地修改影响生产构建）</p>
</li>
</ul>
<h2 data-id="heading-13">未来改进</h2>
<p>如果哪天<code>AliPlayer SDK</code>官方提供了包含完整模拟器支持的版本，那最好不过。</p>
<h2 data-id="heading-14">相关文件</h2>
<ul>
<li>
<p><code>plugins/flutter_aliplayer/ios/Classes/FlutterAliMediaLoaderV2.m</code> - 预加载 v2 实现</p>
</li>
<li>
<p><code>plugins/flutter_aliplayer/ios/Classes/AliPlayerFactory.m</code> - 播放器工厂实现</p>
</li>
<li>
<p><code>pubspec.yaml</code> - 依赖配置</p>
</li>
<li>
<p><code>build.sh</code> - 构建脚本</p>
</li>
</ul>
<h2 data-id="heading-15">参考资料</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fvod%2Fdeveloper-reference" target="_blank" title="https://help.aliyun.com/zh/vod/developer-reference" ref="nofollow noopener noreferrer">AliPlayer SDK 官方文档</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fdevelopment%2Fplatform-integration%2Fplatform-channels" target="_blank" title="https://docs.flutter.dev/development/platform-integration/platform-channels" ref="nofollow noopener noreferrer">Flutter iOS 平台特定代码</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Fdocumentation%2FDeveloperTools%2FConceptual%2Fcross_development%2FUsing%2Fusing.html" target="_blank" title="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/cross_development/Using/using.html" ref="nofollow noopener noreferrer">Objective-C 条件编译</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++类型转换的隐蔽陷阱：当size_t遇见负数]]></title>    <link>https://juejin.cn/post/7577228831137660971</link>    <guid>https://juejin.cn/post/7577228831137660971</guid>    <pubDate>2025-11-27T10:55:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577228831137660971" data-draft-id="7577215663968124970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++类型转换的隐蔽陷阱：当size_t遇见负数"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T10:55:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++类型转换的隐蔽陷阱：当size_t遇见负数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:55:19.000Z" title="Thu Nov 27 2025 10:55:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d90ed9aea7445f7b7e461d158f6fb1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845718&amp;x-signature=WWe2r7BZJwc6tTMGSMR7AIoYtZE%3D" alt="4c1920f98b528d631ce91ff20a708bd6.png" loading="lazy"/></p>
<p>在C++开发中，我们经常会遇到各种类型转换的问题，但有一种情况特别容易导致难以发现的bug——那就是无符号类型与有符号类型的混合运算。今天，我们就来深入探讨这个看似简单却暗藏玄机的问题。</p>
<h2 data-id="heading-0">一个看似无害的循环</h2>
<p>考虑下面这段代码，它看起来完全正确：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processPair</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"Processing: "</span> &lt;&lt; a &lt;&lt; <span class="hljs-string">" and "</span> &lt;&lt; b &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    std::vector&lt;<span class="hljs-type">int</span>&gt; data = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>};
    
    <span class="hljs-comment">// 处理相邻元素对</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-built_in">processPair</span>(data[i], data[i + <span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>当向量中有数据时，这段代码运行得很好。它会输出：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Processing: 1 and 2</span>
<span class="hljs-section">Processing: 2 and 3</span>
<span class="hljs-section">Processing: 3 and 4</span>
<span class="hljs-section">Processing: 4 and 5</span>
</code></pre>
<p>但是，当我们面对一个空向量时，问题就出现了：</p>
<pre><code class="hljs language-cpp" lang="cpp">std::vector&lt;<span class="hljs-type">int</span>&gt; empty_vec;  <span class="hljs-comment">// 空向量</span>

<span class="hljs-comment">// 同样的代码，不同的结果</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; empty_vec.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {
    <span class="hljs-built_in">processPair</span>(empty_vec[i], empty_vec[i + <span class="hljs-number">1</span>]);
}
</code></pre>
<p><strong>思考一下：你期望这个循环执行多少次？</strong></p>
<h2 data-id="heading-1">问题的根源：隐式类型转换</h2>
<p>要理解这个问题，我们需要深入了解C++的类型转换规则。</p>
<h3 data-id="heading-2">常用算术转换（Usual Arithmetic Conversions）</h3>
<p>在C++中，当二元操作符两边的操作数类型不同时，编译器会执行<strong>常用算术转换</strong>。其中一个关键规则是：</p>
<p><strong>当有符号类型与无符号类型进行运算时，有符号类型会被提升为无符号类型。</strong></p>
<p>让我们分解那个问题表达式：<code>empty_vec.size() - 1</code></p>
<ol>
<li><code>empty_vec.size()</code> 返回 <code>size_t</code> 类型（无符号整型）</li>
<li><code>1</code> 是 <code>int</code> 类型（有符号整型）</li>
<li>根据规则，<code>1</code> 被转换为 <code>size_t</code> 类型</li>
<li>表达式变为：<code>size_t_value - size_t(1)</code></li>
</ol>
<h3 data-id="heading-3">无符号整数的下溢行为</h3>
<p>当容器为空时：</p>
<ul>
<li><code>empty_vec.size()</code> = 0</li>
<li><code>size_t(0) - size_t(1)</code> 发生下溢</li>
</ul>
<p>由于<code>size_t</code>是无符号类型，它遵循模算术规则：</p>
<ul>
<li>下溢不会产生负数，而是回绕到该类型的最大值</li>
<li>在64位系统上，<code>0 - 1</code> 变成了 <code>18446744073709551615</code></li>
</ul>
<p>于是我们的循环条件变成了：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">18446744073709551615</span>; i++)
</code></pre>
<p>这就导致了一个几乎无限循环！</p>
<h2 data-id="heading-4">为什么这个问题如此危险？</h2>
<h3 data-id="heading-5">1. 隐蔽性极高</h3>
<p>这种bug在大多数情况下都不会出现：</p>
<ul>
<li>在测试环境中，我们很少测试空容器的情况</li>
<li>在代码审查时，这样的循环看起来完全正常</li>
<li>在有数据的正常情况下，代码运行完美</li>
</ul>
<h3 data-id="heading-6">2. 后果严重</h3>
<p>当问题真的发生时：</p>
<ul>
<li>程序陷入死循环，消耗大量CPU资源</li>
<li>可能导致整个服务不可用</li>
<li>在嵌入式或资源受限环境中可能造成系统崩溃</li>
</ul>
<h3 data-id="heading-7">3. 调试困难</h3>
<p>由于问题只在特定条件下出现：</p>
<ul>
<li>难以在开发环境中复现</li>
<li>核心转储文件可能非常大（因为循环次数极多）</li>
<li>日志输出可能淹没系统</li>
</ul>
<h2 data-id="heading-8">解决方案</h2>
<h3 data-id="heading-9">方案1：显式检查边界</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 明确检查容器大小</span>
<span class="hljs-keyword">if</span> (!data.<span class="hljs-built_in">empty</span>() &amp;&amp; data.<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-built_in">processPair</span>(data[i], data[i + <span class="hljs-number">1</span>]);
    }
}
</code></pre>
<p>这是最安全的做法，明确表达了我们的意图。</p>
<h3 data-id="heading-10">方案2：调整循环条件</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 避免减法操作</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i + <span class="hljs-number">1</span> &lt; data.<span class="hljs-built_in">size</span>(); i++) {
    <span class="hljs-built_in">processPair</span>(data[i], data[i + <span class="hljs-number">1</span>]);
}
</code></pre>
<p>这种方法通过调整比较逻辑来避免减法操作。</p>
<h3 data-id="heading-11">方案3：使用迭代器</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用标准库迭代器</span>
<span class="hljs-keyword">if</span> (data.<span class="hljs-built_in">size</span>() &gt;= <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = data.<span class="hljs-built_in">begin</span>(); it != std::<span class="hljs-built_in">prev</span>(data.<span class="hljs-built_in">end</span>()); ++it) {
        <span class="hljs-built_in">processPair</span>(*it, *(std::<span class="hljs-built_in">next</span>(it)));
    }
}
</code></pre>
<p>迭代器方式更符合C++的惯用法。</p>
<h3 data-id="heading-12">方案4：使用标准库算法</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用标准库算法（如果适用）</span>
std::<span class="hljs-built_in">adjacent_difference</span>(data.<span class="hljs-built_in">begin</span>(), data.<span class="hljs-built_in">end</span>(), 
                        std::<span class="hljs-built_in">ostream_iterator</span>&lt;<span class="hljs-type">int</span>&gt;(std::cout, <span class="hljs-string">" "</span>));
</code></pre>
<p>对于某些场景，标准库已经提供了现成的算法。</p>
<h2 data-id="heading-13">防御性编程的最佳实践</h2>
<h3 data-id="heading-14">1. 保持类型一致性</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 好：使用一致的size_t类型</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-built_in">size</span>(); i++)

<span class="hljs-comment">// 更好：如果需要减法，确保类型一致</span>
<span class="hljs-type">size_t</span> size = data.<span class="hljs-built_in">size</span>();
<span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; size - <span class="hljs-number">1</span>; i++)
}
</code></pre>
<h3 data-id="heading-15">2. 启用编译器警告</h3>
<p>现代编译器可以检测到很多类型转换问题：</p>
<pre><code class="hljs language-bash" lang="bash">g++ -Wall -Wextra -Wsign-conversion -Wsign-compare program.cpp
</code></pre>
<p>关键警告选项：</p>
<ul>
<li><code>-Wsign-conversion</code>：警告有符号/无符号转换</li>
<li><code>-Wsign-compare</code>：警告有符号/无符号比较</li>
<li><code>-Wconversion</code>：警告可能改变值的隐式转换</li>
</ul>
<h3 data-id="heading-16">3. 使用静态分析工具</h3>
<p>工具如Clang-Tidy、CPPCheck等可以帮助发现这类问题：</p>
<pre><code class="hljs language-bash" lang="bash">clang-tidy -checks=<span class="hljs-string">'*'</span> program.cpp -- -std=c++17
</code></pre>
<h3 data-id="heading-17">4. 全面的边界测试</h3>
<p>确保测试用例覆盖所有边界情况：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">TEST</span>(ContainerTest, EmptyVector) {
    std::vector&lt;<span class="hljs-type">int</span>&gt; empty_vec;
    <span class="hljs-built_in">EXPECT_NO_THROW</span>(<span class="hljs-built_in">processContainer</span>(empty_vec));
}

<span class="hljs-built_in">TEST</span>(ContainerTest, SingleElement) {
    std::vector&lt;<span class="hljs-type">int</span>&gt; single_vec{<span class="hljs-number">42</span>};
    <span class="hljs-built_in">EXPECT_NO_THROW</span>(<span class="hljs-built_in">processContainer</span>(single_vec));
}

<span class="hljs-built_in">TEST</span>(ContainerTest, NormalCase) {
    std::vector&lt;<span class="hljs-type">int</span>&gt; normal_vec{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>};
    <span class="hljs-built_in">EXPECT_NO_THROW</span>(<span class="hljs-built_in">processContainer</span>(normal_vec));
}
</code></pre>
<h2 data-id="heading-18">更广泛的适用场景</h2>
<p>这个问题不仅出现在<code>std::vector</code>中，还出现在所有返回<code>size_t</code>的容器中：</p>
<pre><code class="hljs language-cpp" lang="cpp">std::string str;
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-built_in">length</span>() - <span class="hljs-number">1</span>; i++) {}  <span class="hljs-comment">// 同样的问题！</span>

std::array&lt;<span class="hljs-type">int</span>, 5&gt; arr;
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; i++) {}    <span class="hljs-comment">// 这里也是！</span>

<span class="hljs-comment">// 甚至自定义容器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContainer</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> data_size; }
    <span class="hljs-comment">// ...</span>
};
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p>C++的类型系统虽然强大，但也充满了陷阱。无符号类型与有符号类型的混合运算就是其中一个典型的"坑"。通过理解背后的转换规则，并采用防御性编程策略，我们可以避免这类隐蔽的bug。</p>
<p><strong>关键要点：</strong></p>
<ul>
<li>警惕无符号类型的减法操作</li>
<li>保持运算中的类型一致性</li>
<li>启用编译器警告并使用静态分析工具</li>
<li>全面测试边界情况</li>
<li>优先使用标准库算法和迭代器</li>
</ul>
<p>记住：在C++编程中，最危险的bug往往藏在最"明显"的代码里。多一份谨慎，少一份调试的煎熬！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++中不同类型的默认转换详解]]></title>    <link>https://juejin.cn/post/7577204540417982527</link>    <guid>https://juejin.cn/post/7577204540417982527</guid>    <pubDate>2025-11-27T10:57:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417982527" data-draft-id="7577220965437751350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++中不同类型的默认转换详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T10:57:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++中不同类型的默认转换详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:57:40.000Z" title="Thu Nov 27 2025 10:57:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>不熟悉默认类型转换，真的很容易写出bug！！！</p>
</blockquote>
<p>在C++中，类型转换是一个非常重要的概念。下面详细讲解C++中各种默认类型转换的规则和机制。</p>
<h2 data-id="heading-0">1. 算术类型转换</h2>
<h3 data-id="heading-1">整型提升 (Integral Promotion)</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">char</span> c = <span class="hljs-string">'A'</span>;
<span class="hljs-type">short</span> s = <span class="hljs-number">100</span>;
<span class="hljs-type">int</span> i = c + s;  <span class="hljs-comment">// char和short都提升为int</span>
</code></pre>
<h3 data-id="heading-2">算术转换规则</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 转换优先级：long double &gt; double &gt; float &gt; unsigned long long &gt; long long &gt; </span>
<span class="hljs-comment">// unsigned long &gt; long &gt; unsigned int &gt; int</span>

<span class="hljs-type">int</span> i = <span class="hljs-number">10</span>;
<span class="hljs-type">double</span> d = <span class="hljs-number">3.14</span>;
<span class="hljs-type">double</span> result = i + d;  <span class="hljs-comment">// int转换为double</span>

<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> u = <span class="hljs-number">100</span>;
<span class="hljs-type">int</span> j = <span class="hljs-number">-50</span>;
<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> result2 = u + j;  <span class="hljs-comment">// int转换为unsigned int</span>
</code></pre>
<h2 data-id="heading-3">2. 指针类型转换</h2>
<h3 data-id="heading-4">隐式指针转换</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 派生类指针到基类指针</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {};

Derived d;
Base* bp = &amp;d;  <span class="hljs-comment">// 隐式向上转换</span>

<span class="hljs-comment">// 数组到指针退化</span>
<span class="hljs-type">int</span> arr[<span class="hljs-number">5</span>];
<span class="hljs-type">int</span>* ptr = arr;  <span class="hljs-comment">// 数组退化为指针</span>

<span class="hljs-comment">// 0或nullptr到指针</span>
<span class="hljs-type">int</span>* p1 = <span class="hljs-number">0</span>;
<span class="hljs-type">int</span>* p2 = <span class="hljs-literal">nullptr</span>;

<span class="hljs-comment">// 任意指针到void*</span>
<span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;
<span class="hljs-type">void</span>* vp = &amp;x;
</code></pre>
<h2 data-id="heading-5">3. 引用类型转换</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Base"</span> &lt;&lt; endl; }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Derived"</span> &lt;&lt; endl; }
};

Derived d;
Base&amp; br = d;  <span class="hljs-comment">// 派生类引用到基类引用</span>
br.<span class="hljs-built_in">show</span>();     <span class="hljs-comment">// 输出: Derived (多态)</span>
</code></pre>
<h2 data-id="heading-6">4. 限定符转换 (Qualification Conversions)</h2>
<h3 data-id="heading-7">const转换</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span>* cp = &amp;x;     <span class="hljs-comment">// 非const到const</span>
<span class="hljs-comment">// int* p = cp;         // 错误: 不能去掉const限定</span>

<span class="hljs-type">const</span> <span class="hljs-type">int</span> y = <span class="hljs-number">20</span>;
<span class="hljs-comment">// int* p2 = &amp;y;        // 错误: 不能去掉const限定</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span>* cp2 = &amp;y;    <span class="hljs-comment">// OK</span>
</code></pre>
<h3 data-id="heading-8">volatile转换</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> normal = <span class="hljs-number">10</span>;
<span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> vi = <span class="hljs-number">20</span>;
<span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span>* vp = &amp;normal;  <span class="hljs-comment">// 非volatile到volatile</span>
<span class="hljs-comment">// int* p = &amp;vi;            // 错误: 不能去掉volatile限定</span>
</code></pre>
<h2 data-id="heading-9">5. 布尔转换</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 以下情况会隐式转换为bool</span>
<span class="hljs-type">int</span>* ptr = <span class="hljs-literal">nullptr</span>;
<span class="hljs-keyword">if</span> (ptr) {  <span class="hljs-comment">// 指针到bool: nullptr→false, 其他→true</span>
    cout &lt;&lt; <span class="hljs-string">"Pointer is valid"</span> &lt;&lt; endl;
}

<span class="hljs-type">int</span> value = <span class="hljs-number">10</span>;
<span class="hljs-keyword">if</span> (value) {  <span class="hljs-comment">// 算术类型到bool: 0→false, 非0→true</span>
    cout &lt;&lt; <span class="hljs-string">"Value is non-zero"</span> &lt;&lt; endl;
}
</code></pre>
<h2 data-id="heading-10">6. 用户定义类型转换</h2>
<h3 data-id="heading-11">转换构造函数</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyString</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">char</span>* str;
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 转换构造函数: const char* → MyString</span>
    <span class="hljs-built_in">MyString</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* s) {
        str = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[<span class="hljs-built_in">strlen</span>(s) + <span class="hljs-number">1</span>];
        <span class="hljs-built_in">strcpy</span>(str, s);
    }
    
    ~<span class="hljs-built_in">MyString</span>() { <span class="hljs-keyword">delete</span>[] str; }
};

MyString s = <span class="hljs-string">"Hello"</span>;  <span class="hljs-comment">// 隐式调用转换构造函数</span>
</code></pre>
<h3 data-id="heading-12">类型转换运算符</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartBool</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">bool</span> value;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">SmartBool</span>(<span class="hljs-type">bool</span> b) : <span class="hljs-built_in">value</span>(b) {}
    
    <span class="hljs-comment">// 类型转换运算符: SmartBool → bool</span>
    <span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">bool</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> value;
    }
};

SmartBool sb = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">if</span> (sb) {  <span class="hljs-comment">// 隐式调用operator bool()</span>
    cout &lt;&lt; <span class="hljs-string">"SmartBool is true"</span> &lt;&lt; endl;
}
</code></pre>
<h2 data-id="heading-13">7. 标准转换序列</h2>
<p>C++编译器会尝试以下标准转换序列：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A {};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> {};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(A a)</span> </span>{}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    B b;
    <span class="hljs-built_in">func</span>(b);  <span class="hljs-comment">// 标准转换: B → A (派生类到基类)</span>
    
    <span class="hljs-comment">// 可能的转换序列:</span>
    <span class="hljs-comment">// 1. 精确匹配</span>
    <span class="hljs-comment">// 2. 提升转换</span>
    <span class="hljs-comment">// 3. 标准转换</span>
    <span class="hljs-comment">// 4. 用户定义转换</span>
    <span class="hljs-comment">// 5. 省略号匹配</span>
}
</code></pre>
<h2 data-id="heading-14">8. 显式控制隐式转换</h2>
<h3 data-id="heading-15">explicit关键字</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExplicitClass</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">ExplicitClass</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> </span>{}  <span class="hljs-comment">// 禁止隐式转换</span>
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">(ExplicitClass ec)</span> </span>{}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// ExplicitClass ec = 10;  // 错误: 不能隐式转换</span>
    <span class="hljs-function">ExplicitClass <span class="hljs-title">ec</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;      <span class="hljs-comment">// OK: 直接初始化</span>
    <span class="hljs-built_in">test</span>(<span class="hljs-built_in">ExplicitClass</span>(<span class="hljs-number">10</span>));   <span class="hljs-comment">// OK: 显式转换</span>
}
</code></pre>
<h3 data-id="heading-16">删除转换函数</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NoConvert</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">NoConvert</span>(<span class="hljs-type">int</span>) {}
    
    <span class="hljs-comment">// 删除不需要的转换</span>
    <span class="hljs-built_in">NoConvert</span>(<span class="hljs-type">double</span>) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-function"><span class="hljs-keyword">operator</span> <span class="hljs-title">bool</span><span class="hljs-params">()</span> </span>= <span class="hljs-keyword">delete</span>;
};

<span class="hljs-function">NoConvert <span class="hljs-title">nc</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;    <span class="hljs-comment">// OK</span>
<span class="hljs-comment">// NoConvert nc(3.14); // 错误: 使用已删除的函数</span>
<span class="hljs-comment">// if (nc) {}         // 错误: 使用已删除的函数</span>
</code></pre>
<h2 data-id="heading-17">9. 转换的优先级和歧义</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Ambiguous</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Ambiguous</span>(<span class="hljs-type">int</span> x) {}
    <span class="hljs-built_in">Ambiguous</span>(<span class="hljs-type">double</span> x) {}
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">(Ambiguous a)</span> </span>{}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// func(10);     // 歧义: int可以转换为int或double</span>
    <span class="hljs-built_in">func</span>(<span class="hljs-built_in">Ambiguous</span>(<span class="hljs-number">10</span>));  <span class="hljs-comment">// 必须显式指定</span>
}
</code></pre>
<h2 data-id="heading-18">10. 最佳实践和注意事项</h2>
<ol>
<li>
<p><strong>避免意外的隐式转换</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用explicit防止意外的构造函数转换</span>
<span class="hljs-comment">// 小心算术类型转换的精度损失</span>
</code></pre>
</li>
<li>
<p><strong>注意符号性和大小</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> u = <span class="hljs-number">10</span>;
<span class="hljs-type">int</span> i = <span class="hljs-number">-5</span>;
<span class="hljs-keyword">if</span> (u &gt; i) {  <span class="hljs-comment">// i转换为unsigned int, 结果可能出乎意料</span>
    cout &lt;&lt; <span class="hljs-string">"Unexpected result!"</span> &lt;&lt; endl;
}
</code></pre>
</li>
<li>
<p><strong>使用static_cast进行显式转换</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">double</span> d = <span class="hljs-number">3.14</span>;
<span class="hljs-type">int</span> i = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(d);  <span class="hljs-comment">// 明确的意图</span>
</code></pre>
</li>
</ol>
<p>理解C++的类型转换规则对于编写安全、高效的代码至关重要。在可能产生歧义或意外行为的地方，建议使用显式转换来明确意图。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年 8 款最佳远程协作工具]]></title>    <link>https://juejin.cn/post/7577215663967420458</link>    <guid>https://juejin.cn/post/7577215663967420458</guid>    <pubDate>2025-11-27T09:02:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577215663967420458" data-draft-id="7577215663967387690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年 8 款最佳远程协作工具"/> <meta itemprop="keywords" content="后端,远程工作,前端"/> <meta itemprop="datePublished" content="2025-11-27T09:02:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年 8 款最佳远程协作工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:02:42.000Z" title="Thu Nov 27 2025 09:02:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>现在不少开发团队会选择远程办公，但他们的协作效率问题依然存在。介绍几款好用的远程协作工具，提升开发效率。</p>
<h3 data-id="heading-0">直击开发核心：从环境到编码的无缝协作</h3>
<p>对开发者来说，最高效的协作，就是能让大家像坐在同一间办公室里一样，面对同样的环境、同样的代码，顺畅地沟通。下面这几个工具，就是为了实现这个目标。</p>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">ServBay</a>：对齐团队开发环境的颗粒度</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60d0fd44ddff4516b14577392afcfb47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=ZGnJ4sejl1P6BFljDCOl6NOOJnM%3D" alt="" loading="lazy"/></p>
<p>“我电脑上跑得好好的啊！” 这句话你肯定不陌生。一个团队里，老张用 PHP 8.1，老李用 8.2，老外的 Node.js 还是旧版本，光是解决这些环境差异带来的 bug，就能耗费掉大量时间。</p>
<p>ServBay就是解决这些问题而存在。</p>
<p>ServBay 本身是一个非常强大的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">本地 Web 开发环境集成工具</a>，支持 PHP、Node.js、Python、Go、Java 等各种语言和数据库。但它真正让我觉得惊艳的，是它的团队协作功能。</p>
<p>它通过 <code>.servbay.config</code> 的配置文件，把团队开发环境不一致这个难题给解决了。</p>
<p>通过 <code>.servbay.config</code> ，团队负责人可以在这个文件里，精确指定项目需要用到的 Python 版本、Node.js 版本或者其他的语言，甚至是 Node.js 包管理器的仓库地址和缓存目录。然后把这个文件随代码一起提交到 Git 仓库。</p>
<p>这样一来，团队协作的体验就完全不同了：</p>
<ul>
<li><strong>告别“我这儿没问题”的问题</strong>：团队里所有人，只要拉下代码，ServBay 就会自动根据 <code>.servbay.config</code> 文件来切换和配置环境。确保了从开发、测试到最终上线，环境都是高度一致的。</li>
<li><strong>新人入职速度快到飞起</strong>：新人来了，不用再对着长长的文档折腾半天环境。直接用团队的 <code>.servbay.config</code> 文件，几分钟就能把项目跑起来，马上就能投入工作。</li>
<li><strong>环境管理不再是散装的</strong>：团队的技术负责人可以统一管理和更新这份配置文件。比如项目需要升级语言版本，只需要修改一下文件，团队成员下次拉取代码时，环境就自动同步了。</li>
<li><strong>大家能更专注于写代码</strong>：环境统一了，因为环境问题导致的冲突和阻塞就少了。开发者可以把精力都放在业务逻辑上，协作效率自然就高了。</li>
</ul>
<p>ServBay的这个功能，不管是远程工作还是线下工作，都是必不可少的。</p>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fblogs%2F2017%2F11%2F15%2Flive-share" target="_blank" title="https://code.visualstudio.com/blogs/2017/11/15/live-share" ref="nofollow noopener noreferrer">Live Share</a>：身临其境的远程结对编程</h4>
<p>环境统一了，下一步就是怎么高效地一起写代码。Live Share 是 VS Code 的一个插件，它能让开发者把自己的编辑器分享给队友。队友可以直接进入你的编辑器，实时看到你的代码，和你一起编辑、调试，甚至共享你的终端。</p>
<p>整个过程非常流畅，就像他坐在你旁边一样。</p>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGruntfuggly%2Ftodo-tree" target="_blank" title="https://github.com/Gruntfuggly/todo-tree" ref="nofollow noopener noreferrer">Todo Tree</a>：代码中的异步备忘录</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26ca1444f1943dfbbc67e64c7920b8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=NU8X4%2BsTDrByAYEJ4UHcgKQQoMA%3D" alt="" loading="lazy"/></p>
<p>不是所有问题都需要拉着人实时沟通。有时候，我们在代码里发现一个小bug，可以先记下来。Todo Tree 这个 VS Code 插件就能派上用场。</p>
<p>它能扫描整个项目代码里的 <code>TODO</code>、<code>FIXME</code> 等注释，并把它们集中在一个视图里展示。这样，在写代码时随手记下的待办事项就不会被遗忘。在 Code Review 的时候，团队成员也能清晰地看到还有哪些地方需要完善，算是一种轻量级的、代码层面的异步协同。</p>
<h3 data-id="heading-4">任务与项目管理：为开发流程服务的骨架</h3>
<p>代码层面的协作理顺了，我们再来看更高一层的项目管理。这里的工具选择很多，它们各有侧重，适合不同风格的团队。</p>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Flinear.app%2F" target="_blank" title="https://linear.app/" ref="nofollow noopener noreferrer">Linear</a>：追求极致速度的开发者首选</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6efc5bc49bd460a9129b40d94ee8abf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=mpx0ELjmDCwjvnrh9rCDh6y%2BSGc%3D" alt="" loading="lazy"/></p>
<p>如果你受够了 Jira 的臃肿和卡顿，Linear 绝对能让你眼前一亮。它的界面极简、响应飞快，所有操作基本都能用键盘快捷键完成。它和 GitHub 的集成做得非常好，代码提交能自动更新任务状态。用它来管理 Sprint 和 Bug，感觉就像在写代码一样流畅。</p>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Ftrello.com%2F" target="_blank" title="https://trello.com/" ref="nofollow noopener noreferrer">Trello</a>：简单直观的看板</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5098b3c992ad4b5fba1051bff91af2f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=Wt%2BA6I9g2NPJbKD7jn3Yjc%2FVMZ4%3D" alt="" loading="lazy"/></p>
<p>Trello 就像一块白板和一堆便利贴。它的核心就是看板（Board）、列表（List）、卡片（Card）。操作简单直观，学习成本几乎为零。非常适合规模不大、流程不复杂的团队，或者用来管理一些临时的、非核心的项目。</p>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fmonday.com%2F" target="_blank" title="https://monday.com/" ref="nofollow noopener noreferrer">Monday</a>：高度定制化的项目工具</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0440d1d54b241ecadfdfb76d7203582~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=eKuNsDDgmlt%2BZiEOt0QLhsuBVO0%3D" alt="" loading="lazy"/></p>
<p>Monday 更像一个工作操作系统。它的强大之处在于高度的可定制性，你可以用它搭建出各种各样的工作流。它的各种视图（时间线、图表）非常丰富，很适合需要向管理层或非技术同事展示项目进度的场景。</p>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.teamcamp.app%2F" target="_blank" title="https://www.teamcamp.app/" ref="nofollow noopener noreferrer">Teamcamp</a>：整合代码与任务的一体化平台</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2165b0336a7f46078001fccf541ec6e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=pEuhq67X8odcTA4RAeOJD1NQEms%3D" alt="" loading="lazy"/></p>
<p>Teamcamp 的思路是把项目管理和代码工作流更紧密地结合起来。比如它的一个特色是 Git 提交可以自动更新任务状态，减少了开发者在任务板和代码库之间来回切换的手动操作。如果想要任务状态能和代码进度强绑定，它可以作为一个不错的选择。</p>
<h3 data-id="heading-9">时间与效率追踪</h3>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fclockify.me%2F" target="_blank" title="https://clockify.me/" ref="nofollow noopener noreferrer">Clockify</a>：简单直接的时间记录工具</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2a9937d241449fdad7ef01d4d55e728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838962&amp;x-signature=nFqE9JzeCd1b%2Bys3iGW5rXQ%2FDMc%3D" alt="" loading="lazy"/></p>
<p>远程工作，有时候需要记录一下自己在各个项目上花了多少时间，以便评估工作量或进行项目复盘。Clockify 是一个免费又简单的时间追踪工具。它没什么学习成本，可以按项目、按任务来记录时间，也能生成简单的报表。如果你只是需要一个不打扰、不复杂的工具来记录工时，它足够了。</p>
<h3 data-id="heading-11">总结一下</h3>
<p>一个好的远程协作工具栈，有自己擅长的领域：</p>
<ul>
<li>
<p><strong>ServBay</strong> 负责打好地基，统一开发环境。</p>
</li>
<li>
<p><strong>Linear、Trello、Monday、Teamcamp</strong> 负责搭建项目管理的骨架，风格各异，按需使用。</p>
</li>
<li>
<p><strong>Live Share</strong> 和 <strong>Todo</strong> <strong>Tree</strong> 负责填充代码协作的血肉，一个实时、一个异步。</p>
</li>
<li>
<p><strong>Clockify</strong> 负责最后的度量和复盘。</p>
</li>
</ul>
<p>先把地基打牢，上层的协作才会事半功倍。希望这些工具能帮到你和你的团队。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何打造AI时代的数据基石 | Databend Meetup 上海站]]></title>    <link>https://juejin.cn/post/7577204540417228863</link>    <guid>https://juejin.cn/post/7577204540417228863</guid>    <pubDate>2025-11-27T09:08:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417228863" data-draft-id="7577220965437079606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何打造AI时代的数据基石 | Databend Meetup 上海站"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-27T09:08:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Databend"/> <meta itemprop="url" content="https://juejin.cn/user/4477651847485534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何打造AI时代的数据基石 | Databend Meetup 上海站
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4477651847485534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Databend
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:08:58.000Z" title="Thu Nov 27 2025 09:08:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>数据洪流奔涌，AI 浪潮澎湃。当 Data 与 AI 深度交织，如何构建面向未来的技术栈？如何基于亚马逊云科技构数据分析业务？11月29日「如何打造AI时代的数据基石 | Databend Meetup 上海站」 应势而来！我们力邀多位来自明星开源项目与一线大厂的资深专家，为您全景解析数据平台架构、AI 创新实践与职业发展路径，开启一场思想与技术的碰撞。</p>
<p>本次 Meetup，我们荣幸地邀请到 Databend Labs 联合创始人吴炳锡、沉浸式翻译技术专家陈琦、数据平台架构师邵锋、平凯星辰（TiDB）解决方案架构师刘源、Airwallex 空中云汇数据库架构师赵飞祥，他们将带来兼具深度与广度的干货分享，为您呈现一场 Data + AI 的实践。</p>
<h2 data-id="heading-0">活动信息</h2>
<p>⏰ 活动时间：2025 年 11 月 29 日（周六）13:30 - 17:30</p>
<p>📍 活动地点：上海市黄浦区中海国际中心 A 座 21 楼 </p>
<p>🔗 报名方式：（扫描海报二维码）线下参与采取审核制 (100 人)</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/124728b4348f4bbd9806b0c14104e8e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGF0YWJlbmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839337&amp;x-signature=Yw%2FRhuOP3GIs7koFqUSbE3%2BHeUQ%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">活动亮点</h2>
<p>一线实战： 嘉宾来自业内知名企业及开源项目，分享内容源于真实业务场景。</p>
<p>全景视角： 覆盖从开源工具、AI 产品到企业级平台的完整产业链视角。</p>
<p>深度互动： 圆桌讨论与交流环节，让您有机会与嘉宾直接对话。</p>
<p>高端人脉： 结识众多对 Data 和 AI 充满热情的同道中人，拓展专业人脉圈。</p>
<h2 data-id="heading-2">活动参与奖励</h2>
<p>🎁 丰厚参会福利：Databend 社区丰富周边,另有技术资料等你来拿~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b583891dbd246d0bdb544ec905eb85b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGF0YWJlbmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839337&amp;x-signature=oMMykhkhFrk8VEEPQ3FZcL0s9mI%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">立即行动，锁定席位！</h3>
<ul>
<li>活动主题： DATA AI Databend Meetup</li>
<li>活动形式： 线下分享 + 圆桌讨论 + 自由交流</li>
</ul>
<p>无论您是数据工程师、AI 开发者、技术负责人，还是对数据智能充满好奇的学习者，这都将是一场收获满满的盛会。席位有限，请立即报名，与我们一同站在技术浪潮之巅，共绘 Data 与 AI 的未来图景！</p>
<h2 data-id="heading-4">关于 Databend</h2>
<p>Databend 是一款 100% Rust 构建、面向对象存储设计的新一代开源云原生数据仓库，统一支持 BI 分析、AI 向量、全文检索及地理空间分析等多模态能力。期待您的关注，一起打造新一代开源 AI + Data Cloud。</p>
<p>👨‍💻‍ Databend Cloud：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdatabend.cn" target="_blank" title="https://databend.cn" ref="nofollow noopener noreferrer">databend.cn</a></p>
<p>📖 Databend 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.databend.cn" target="_blank" title="https://docs.databend.cn" ref="nofollow noopener noreferrer">docs.databend.cn</a></p>
<p>💻 Wechat：Databend</p>
<p>✨ GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatabendlabs%2Fdatabend" target="_blank" title="https://github.com/databendlabs/databend" ref="nofollow noopener noreferrer">github.com/databendlab…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ipa Guard 集成到 CICD 流程，让 iOS 加固进入自动化时代的完整工程方案]]></title>    <link>https://juejin.cn/post/7577215663967535146</link>    <guid>https://juejin.cn/post/7577215663967535146</guid>    <pubDate>2025-11-27T09:10:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577215663967535146" data-draft-id="7577198193215094827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ipa Guard 集成到 CICD 流程，让 iOS 加固进入自动化时代的完整工程方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T09:10:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ipa Guard 集成到 CICD 流程，让 iOS 加固进入自动化时代的完整工程方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:10:13.000Z" title="Thu Nov 27 2025 09:10:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在许多团队中，iOS 加固往往是构建链路中被忽略的一环。
要么依赖人工操作，要么走专人执行，导致：</p>
<ul>
<li>混淆策略不统一</li>
<li>某些渠道包忘记加固</li>
<li>手工操作易出错</li>
<li>不同构建之间映射表不一致</li>
<li>发布流程不可审计、不可追踪</li>
<li>审核前的加固步骤临时补救、压力巨大</li>
</ul>
<p>而随着 <strong>Ipa Guard CLI</strong> 支持命令行操作、支持符号文件、可控混淆策略，iOS 加固终于可以被正式纳入 <strong>CI/CD 流程</strong>，实现：</p>
<p>自动加固
自动测试
自动重签
自动上传
自动归档混淆映射表
可回滚、可审计、可追踪</p>
<p>本文将从 DevOps 实践角度介绍如何让 <strong>Ipa Guard + CI/CD</strong> 形成完整闭环，并结合 MobSF、kxsign、Frida/Hopper、KMS 等工具给出整套自动化方案。</p>
<hr/>
<h2 data-id="heading-0">一、为什么要把 Ipa Guard 集成到 CI/CD？</h2>
<h3 data-id="heading-1"><strong>1. 消除人工步骤，降低风险</strong></h3>
<p>手动混淆容易出错，尤其是多渠道、多版本、多团队。</p>
<h3 data-id="heading-2"><strong>2. 加固策略可控、可治理</strong></h3>
<p>使用 sym.json，确保每次混淆一致性。</p>
<h3 data-id="heading-3"><strong>3. 映射表自动归档</strong></h3>
<p>用于崩溃符号化、问题回溯与审计。</p>
<h3 data-id="heading-4"><strong>4. 拉齐多个版本流程</strong></h3>
<p>主包、渠道包、品牌定制包都可统一处理。</p>
<h3 data-id="heading-5"><strong>5. 形成可证实的安全链路</strong></h3>
<p>对外合规与内部审计更友好。</p>
<p>因此，Ipa Guard CLI 的命令行能力为构建流水线奠定了最佳基础。</p>
<hr/>
<h2 data-id="heading-6">二、CI/CD 中需要的工具矩阵（全链路自动化）</h2>























































<table><thead><tr><th>阶段</th><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>静态分析</td><td>MobSF、class-dump</td><td>自动识别暴露符号，辅助生成白名单</td></tr><tr><td>IPA 解析</td><td><strong>Ipa Guard CLI parse</strong></td><td>导出符号文件 sym.json</td></tr><tr><td>策略生成</td><td>自定义脚本</td><td>自动合并白名单或策略模板</td></tr><tr><td>IPA 加固</td><td><strong>Ipa Guard CLI protect</strong></td><td>自动混淆、资源扰动、MD5 修改</td></tr><tr><td>重签名</td><td>kxsign</td><td>生成可安装 ipa（Dev / Adhoc / Release）</td></tr><tr><td>自动测试</td><td>XCTest / UI 自动化 / 真机组</td><td>验证加固后稳定性</td></tr><tr><td>安全验证</td><td>Frida、Hopper</td><td>自动检查关键方法是否被混淆</td></tr><tr><td>归档</td><td>KMS / S3 / 内网文件库</td><td>保存映射表、产物与审计日志</td></tr><tr><td>分发</td><td>Fastlane / GitLab Runner / Jenkins</td><td>自动上传 TestFlight / 内部分发平台</td></tr></tbody></table>
<p>这是一套可控、可维护的 iOS 加固流水线体系。</p>
<hr/>
<h2 data-id="heading-7">三、Ipa Guard 在 CI/CD 中的完整集成流程</h2>
<p>下面以 Jenkins/GitLab CI 为例介绍流水线。</p>
<hr/>
<h2 data-id="heading-8"><strong>① Step 1：生成基础 IPA</strong></h2>
<p>来自：</p>
<ul>
<li>Xcode 构建（主包）</li>
<li>外包提交的 IPA</li>
<li>渠道包</li>
<li>自动构建流程</li>
</ul>
<p>将 IPA 存放到 <code>$WORKSPACE/app.ipa</code></p>
<hr/>
<h2 data-id="heading-9"><strong>② Step 2：导出可混淆符号（自动执行）</strong></h2>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p>CI 将生成的 <code>sym.json</code> 上传到：</p>
<ul>
<li>内网仓库</li>
<li>Git repo</li>
<li>或者 KMS 存储</li>
</ul>
<p>用于审计。</p>
<hr/>
<h2 data-id="heading-10"><strong>③ Step 3：自动编辑符号（策略合并）</strong></h2>
<p>通常包含两部分：</p>
<h3 data-id="heading-11">1. 项目专属白名单（如 MethodChannel、JSBridge 黑名单）</h3>
<p>由安全团队维护，例如：</p>
<pre><code class="hljs">whitelist.json
</code></pre>
<h3 data-id="heading-12">2. 自动生成的 sym.json（来自 parse）</h3>
<p>脚本自动合并两者，得到最终可混淆策略：</p>
<pre><code class="hljs">merged_sym.json
</code></pre>
<hr/>
<h2 data-id="heading-13"><strong>④ Step 4：执行 Ipa Guard 混淆（CI 核心步骤）</strong></h2>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli protect app.ipa \
  -c merged_sym.json \
  --email team@company.com \
  --image \
  --js \
  -o protected.ipa
</code></pre>
<p>CI 自动完成：</p>
<p>Swift/ObjC 方法、类名混淆
变量名混淆
图片、资源文件名扰动
JSON/JS/H5 路径修改
MD5 修改
生成映射表（用于回滚与符号化）</p>
<p>所有结果自动备份。</p>
<hr/>
<h2 data-id="heading-14"><strong>⑤ Step 5：自动重签名</strong></h2>
<pre><code class="hljs language-arduino" lang="arduino">kxsign sign <span class="hljs-keyword">protected</span>.ipa \
  -c cert.p12 \
  -p $CERT_PASSWORD \
  -m profile.mobileprovision \
  -z <span class="hljs-type">signed</span>.ipa
</code></pre>
<p>可自动生成：</p>
<ul>
<li>Dev 测试包</li>
<li>Adhoc 内测包</li>
<li>Release 提审包</li>
<li>渠道专属签名包</li>
</ul>
<p>CI 下发对应文件即可。</p>
<hr/>
<h2 data-id="heading-15"><strong>⑥ Step 6：自动化测试（可选但强烈建议）</strong></h2>
<p>包括：</p>
<ul>
<li>XCTest 单元测试</li>
<li>XCUITest UI 自动化</li>
<li>真机自动化跑一遍主流程</li>
<li>或者使用第三方真机集群（如内部设备农场）</li>
</ul>
<p>重点验证：</p>
<ul>
<li>混淆后是否崩溃</li>
<li>JS/H5 页面是否正常</li>
<li>Flutter/RN 是否正常加载</li>
<li>SDK（登录/支付）是否正常</li>
</ul>
<hr/>
<h2 data-id="heading-16"><strong>⑦ Step 7：自动逆向验证（可自动执行）</strong></h2>
<h3 data-id="heading-17">1. class-dump 应该完全看不懂</h3>
<h3 data-id="heading-18">2. Frida Hook 应该难以直接定位方法名称</h3>
<h3 data-id="heading-19">3. Hopper 中符号应该全乱码</h3>
<p>脚本自动比对是否存在可读符号：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span>-dump <span class="hljs-type">signed</span>.ipa | grep <span class="hljs-string">"Controller"</span>
</code></pre>
<p>若输出不为空 → 阻断发布</p>
<hr/>
<h2 data-id="heading-20"><strong>⑧ Step 8：保存映射表、审计数据</strong></h2>
<p>CI 自动将：</p>
<ul>
<li>映射表</li>
<li>sym.json</li>
<li>merged_sym.json</li>
<li>ipa 产物</li>
<li>构建号、Git 提交</li>
<li>时间戳、操作日志</li>
</ul>
<p>归档至：</p>
<ul>
<li>内部对象存储（S3、OSS、COS）</li>
<li>KMS 加密机制</li>
<li>内部符号化服务（Sentry/Bugly）</li>
</ul>
<p>实现完整可追踪治理体系。</p>
<hr/>
<h2 data-id="heading-21"><strong>⑨ Step 9：自动分发 / 上传审核</strong></h2>
<p>通过 Fastlane：</p>
<pre><code class="hljs">fastlane deliver
</code></pre>
<p>或内部分发平台：</p>
<ul>
<li>蒲公英</li>
<li>自建分发</li>
<li>Jenkins Artifacts</li>
</ul>
<p>从此 iOS 加固成为流水线自动的一环。</p>
<hr/>
<h2 data-id="heading-22">四、Ipa Guard 集成 CI/CD 的最终效果</h2>
<p>当这套流程跑通后，你会获得：</p>
<h3 data-id="heading-23">自动混淆</h3>
<h3 data-id="heading-24">自动重签</h3>
<h3 data-id="heading-25">自动测试</h3>
<h3 data-id="heading-26">自动审计</h3>
<h3 data-id="heading-27">自动逆向检测</h3>
<h3 data-id="heading-28">自动分发</h3>
<h3 data-id="heading-29">结构清晰、可回滚</h3>
<h3 data-id="heading-30">有映射表可符号化</h3>
<p>整个 iOS 加固不再依靠人工，而是：</p>
<p><strong>自动化、可重复、可审计、可治理。</strong></p>
<p>这才是现代移动团队应该达到的安全水平。</p>
<hr/>
<h2 data-id="heading-31">五、总结：Ipa Guard 与 CI/CD 的结合，是工程体系升级的关键</h2>
<p>最终推荐组合如下：</p>
<h3 data-id="heading-32"><strong>分析层</strong></h3>
<p>MobSF、class-dump</p>
<h3 data-id="heading-33"><strong>加固层（核心）</strong></h3>
<p>Ipa Guard CLI</p>
<ul>
<li>IPA 混淆</li>
<li>资源扰动</li>
<li>加固策略控制</li>
</ul>
<h3 data-id="heading-34"><strong>验证层</strong></h3>
<p>kxsign、Frida、Hopper、自动化测试</p>
<h3 data-id="heading-35"><strong>治理层</strong></h3>
<p>KMS、Sentry/Bugly、GitLab/Jenkins 归档</p>
<h3 data-id="heading-36"><strong>分发层</strong></h3>
<p>Fastlane、Jenkins、内部平台</p>
<p>通过这套链路，iOS 加固才能“工程化”，而不是“手工化”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Axios 请求取消机制详解]]></title>    <link>https://juejin.cn/post/7577042851080880171</link>    <guid>https://juejin.cn/post/7577042851080880171</guid>    <pubDate>2025-11-27T09:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577042851080880171" data-draft-id="7576994308274307091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Axios 请求取消机制详解"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-27T09:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Axios 请求取消机制详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:14:51.000Z" title="Thu Nov 27 2025 09:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Axios是否真的支持取消请求呢</h2>
<p>是的，<strong>Axios 完全支持取消请求</strong>。</p>
<p>Axios 提供了两种主要的取消请求的方式：</p>
<ol>
<li><strong>使用 <code>AbortController</code> (推荐，现代浏览器和 Node.js 环境)</strong></li>
<li><strong>使用 <code>CancelToken</code> (旧版方式，Axios 0.22.0 之前的主要方式，现在已废弃但仍兼容)</strong></li>
</ol>
<hr/>
<h3 data-id="heading-1">1. 使用 <code>AbortController</code> (推荐)</h3>
<p><code>AbortController</code> 是 Web 标准 API，用于中止一个或多个 Web 请求。Axios 从 v0.22.0 开始支持它，并推荐使用这种方式。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 1. 创建一个 AbortController 实例</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>; <span class="hljs-comment">// 获取 AbortSignal 对象</span>

<span class="hljs-comment">// 2. 在 Axios 请求配置中传入 signal</span>
axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>, { signal })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功:'</span>, response.<span class="hljs-property">data</span>);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 检查错误是否是由于请求取消引起的</span>
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求发生错误:'</span>, error.<span class="hljs-property">message</span>);
    }
  });

<span class="hljs-comment">// 3. 在需要取消请求时调用 controller.abort()</span>
<span class="hljs-comment">// 例如，在组件卸载时，或者用户点击了取消按钮时</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 这会触发 signal 上的 abort 事件，Axios 会捕获并取消请求</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求已尝试取消'</span>);
}, <span class="hljs-number">100</span>); <span class="hljs-comment">// 100ms 后取消请求</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>是 Web 标准 API，不仅限于 Axios，也可以用于 <code>fetch</code> API 或其他支持 <code>AbortSignal</code> 的异步操作。</li>
<li>更现代、更简洁的 API 设计。</li>
<li>可以取消多个请求（将同一个 <code>signal</code> 传递给多个请求）。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 使用 <code>CancelToken</code> (旧版，已废弃但仍兼容)</h3>
<p><code>CancelToken</code> 是 Axios 早期提供的取消请求机制。虽然现在推荐使用 <code>AbortController</code>，但如果你在使用旧版本的 Axios 或者需要兼容旧代码，它仍然可用。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 1. 创建一个 CancelToken.Source 工厂函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CancelToken</span> = axios.<span class="hljs-property">CancelToken</span>;
<span class="hljs-keyword">const</span> source = <span class="hljs-title class_">CancelToken</span>.<span class="hljs-title function_">source</span>(); <span class="hljs-comment">// source 对象包含 token 和 cancel 方法</span>

<span class="hljs-comment">// 2. 在 Axios 请求配置中传入 token</span>
axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>, { <span class="hljs-attr">cancelToken</span>: source.<span class="hljs-property">token</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功:'</span>, response.<span class="hljs-property">data</span>);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 检查错误是否是由于请求取消引起的</span>
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求发生错误:'</span>, error.<span class="hljs-property">message</span>);
    }
  });

<span class="hljs-comment">// 3. 在需要取消请求时调用 source.cancel()</span>
<span class="hljs-comment">// 例如，在组件卸载时，或者用户点击了取消按钮时</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  source.<span class="hljs-title function_">cancel</span>(<span class="hljs-string">'用户取消了请求'</span>); <span class="hljs-comment">// 传入一个可选的消息</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求已尝试取消'</span>);
}, <span class="hljs-number">100</span>); <span class="hljs-comment">// 100ms 后取消请求</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>在旧版本 Axios 中广泛使用。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>Axios 特有的 API，不适用于其他 Web API。</li>
<li>已被 <code>AbortController</code> 替代，未来可能不再维护或推荐。</li>
</ul>
<hr/>
<h3 data-id="heading-3">何时需要取消请求？</h3>
<p>取消请求在前端开发中非常有用，常见场景包括：</p>
<ol>
<li><strong>组件卸载时</strong>：当用户在请求完成前切换页面或组件被销毁时，避免因请求返回后尝试更新已不存在的组件状态而导致的内存泄漏或错误。</li>
<li><strong>用户操作取消</strong>：例如，用户点击了“取消上传”按钮，或在搜索框中快速输入时，取消之前的旧搜索请求，只保留最新的请求。</li>
<li><strong>避免重复请求</strong>：在某些情况下，为了防止用户多次点击或快速触发某个操作导致发送多个相同的请求，可以在新请求发出前取消旧请求。</li>
</ol>
<p>总之，Axios 提供了强大且灵活的请求取消机制，推荐在现代项目中使用 <code>AbortController</code>。</p>
<h2 data-id="heading-4">这种取消是前端拒绝接收数据还是真的停止http的请求链接呢？</h2>
<h3 data-id="heading-5">1. 它是如何“真取消”的？（浏览器层面）</h3>
<p>当你调用 <code>controller.abort()</code>（或旧版的 <code>cancelToken</code>）时，Axios 会调用浏览器底层的 API（<code>XMLHttpRequest.abort()</code> 或 <code>fetch</code> 的 signal 机制）。</p>
<p>这意味着：</p>
<ul>
<li><strong>网络连接被切断</strong>：浏览器会立即关闭与服务器的 TCP 连接。</li>
<li><strong>停止接收数据</strong>：如果服务器正在发送一个很大的响应（比如下载一个 100MB 的文件），浏览器会立刻停止下载，<strong>节省带宽</strong>。</li>
<li><strong>Promise 立即 Reject</strong>：Axios 的 Promise 会立刻抛出一个 <code>CanceledError</code>，你的代码会立刻进入 <code>.catch()</code>，而不需要等待服务器响应超时。</li>
</ul>
<p><strong>对比：</strong>  如果仅仅是“前端不予接收”，浏览器会傻傻地把 100MB 下载完，然后你的代码再把数据扔掉。<strong>Axios 的取消是前者，直接掐断连接，节省资源。</strong></p>
<hr/>
<h3 data-id="heading-6">2. 服务器端发生了什么？（后端层面）</h3>
<p>这是最容易产生误解的地方。 <strong>“前端取消了请求”并不代表“后端撤销了操作”。</strong></p>
<ul>
<li>
<p><strong>请求已发出</strong>：在大多数情况下，当你点击取消时，请求指令已经通过网络发送到了服务器。</p>
</li>
<li>
<p><strong>服务器正在处理</strong>：服务器收到请求后，开始查询数据库、计算数据或写入记录。</p>
</li>
<li>
<p><strong>连接中断</strong>：此时前端断开了连接。</p>
<ul>
<li><strong>大多数后端框架（如 Java Spring, Node Express, Python Flask）</strong> ：通常<strong>不会</strong>自动检测连接断开而停止业务逻辑。它们会继续把活干完（比如把数据写进数据库），然后试图把结果返回给前端。</li>
<li><strong>结果</strong>：当服务器试图返回结果时，发现连接已经没了，服务器会报错（如 <code>Broken pipe</code>），但之前的业务逻辑（如写库）可能已经执行了。</li>
</ul>
</li>
</ul>
<p><strong>举个例子：</strong><br/>
你在餐厅点了一道菜（<strong>发送请求</strong>）。<br/>
厨师开始做菜（<strong>服务器处理</strong>）。<br/>
你突然有急事走了，跟服务员说“我不要了”（<strong>前端取消请求</strong>）。</p>
<ul>
<li><strong>前端视角</strong>：你走了，没吃到菜，也没付钱（节省了时间和资源）。</li>
<li><strong>后端视角</strong>：厨师可能已经把菜做好了，发现没人吃，只能倒掉。<strong>但菜确实被做出来了（副作用已产生）。</strong></li>
</ul>
<hr/>
<h3 data-id="heading-7">3. 总结：三种情况</h3>
<p>根据取消的时机不同，效果也不同：</p>
<ol>
<li>
<p><strong>请求还在排队（极少见）</strong> ：</p>
<ul>
<li>浏览器还没来得及把请求发出去你就取消了。</li>
<li><strong>结果</strong>：服务器完全不知道有这回事，这是最彻底的取消。</li>
</ul>
</li>
<li>
<p><strong>请求在传输中/服务器处理中（最常见）</strong> ：</p>
<ul>
<li>请求已发，服务器正在算，前端取消。</li>
<li><strong>结果</strong>：前端断开连接，不再等待。服务器可能还是会把活干完，但发不回来。<strong>这对前端来说是真取消（不卡界面、不费流量），对后端来说通常无法撤销副作用。</strong></li>
</ul>
</li>
<li>
<p><strong>响应已到达浏览器</strong>：</p>
<ul>
<li>服务器数据已经发回来了，浏览器刚收到，你正好点了取消。</li>
<li><strong>结果</strong>：这时候其实已经晚了，Axios 只是抛个错让你忽略结果。这就变成了你说的“前端不予接收”。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">核心建议</h3>
<ul>
<li><strong>用于优化体验</strong>：Axios 的取消非常适合用于<strong>搜索框联想</strong>（输入 <code>a</code> 发请求，紧接着输入 <code>ab</code>，此时取消 <code>a</code> 的请求）或<strong>切换 Tab</strong>。这能有效防止“旧数据的响应覆盖了新数据”的 Bug，并节省带宽。</li>
<li><strong>不要依赖它来回滚数据</strong>：如果你发的是 <code>POST</code> 请求（比如“付款”），千万不要指望前端取消就能阻止服务器扣款。后端必须要有幂等性设计或专门的撤销接口。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter版本选择指南：3.35稳定，3.38发布 | 2025年11月]]></title>    <link>https://juejin.cn/post/7577189654488989746</link>    <guid>https://juejin.cn/post/7577189654488989746</guid>    <pubDate>2025-11-27T09:13:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654488989746" data-draft-id="7576968345876283419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter版本选择指南：3.35稳定，3.38发布 | 2025年11月"/> <meta itemprop="keywords" content="Flutter,客户端"/> <meta itemprop="datePublished" content="2025-11-27T09:13:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter版本选择指南：3.35稳定，3.38发布 | 2025年11月
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:13:45.000Z" title="Thu Nov 27 2025 09:13:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>哈喽，我是老刘</strong></p>
<p>老刘做Flutter开发差不多7年了，期间如何选择Flutter版本是被问得最多的问题之一。</p>
<p>所以老刘新开了一个系列文章，每个月都会深度分析最近的几个Flutter版本。</p>
<ul>
<li>提供具体的版本选择建议</li>
<li>分享真实的生产环境经验</li>
<li>给出详细的升级和回滚策略</li>
</ul>
<p>让你在版本选择上不再纠结，不再踩坑。</p>
<hr/>
<h2 data-id="heading-0">一、Flutter版本选择策略</h2>
<p>对于技术框架和版本的选择，不应该是盲目的选择最新版，或者无脑看网上别人怎么推荐，而是应该有自己的分析方法。</p>
<p>最新的版本大概率解决了之前版本中比较严重的问题，优化了性能，添加了新特性。</p>
<p>但是最新版有很有可能引入新的bug或者缺陷。</p>
<p>那么作为开发者该如何权衡这两者的利弊呢？</p>
<p><strong>第一个法则：2个月观察期，别当小白鼠</strong></p>
<p>新版本发布后的前2个月，就是一场大型真人实验。</p>
<p>大部分严重的bug在发布后的一到两个月都能被爆出来。</p>
<p>所以聪明的做法是什么？</p>
<p>等2个月，看社区反馈，看bug列表。如果这段时间没有什么比较严重的问题，那么大概率就是比较安全的。</p>
<p>也可以看老刘每个月发布的《Flutter版本选择指南》。</p>
<p>这就像买股票一样，不要追高，要等进入低估区间。</p>
<p><strong>第二个法则：分环境测试，别一上来就all in</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/069712e44df847c2b90613ce4f1892c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839625&amp;x-signature=Wt%2BEWnIMdRIGP%2BqQor82AwplVoY%3D" alt="" loading="lazy"/></p>
<p><strong>开发环境 → 测试环境 → 生产环境</strong></p>
<p>开发环境用最新版，踩坑我认了，反正影响不了用户。</p>
<p>测试环境用经过开发环境检验的版本，充分测试，记录问题。</p>
<p>生产环境用稳定版，用户至上，稳定压倒一切。</p>
<p>升级前预留足够的时间窗口，比如在当前已经发布的版本上只升级Flutter版本，然后快速发布一个小版本。</p>
<p>如果发现问题可以尽快回滚。</p>
<hr/>
<h2 data-id="heading-1">二、Flutter最近5个版本深度解析</h2>
<h3 data-id="heading-2">1. 版本列表</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/982928cab4c54c32982500ec2a44f651~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839625&amp;x-signature=c%2FykUfoOuFEtgx2urT4mSNiYU70%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>Flutter 3.38</strong> (最新) - 2025年11月发布</li>
<li><strong>Flutter 3.35</strong> - 2025年8月发布</li>
<li><strong>Flutter 3.32</strong> - 2025年5月发布</li>
<li><strong>Flutter 3.29</strong> - 2025年2月发布</li>
<li><strong>Flutter 3.27</strong> - 2024年12月发布</li>
</ol>
<h3 data-id="heading-3">2. 各版本问题分析与风险评估</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feabfc3b870d4ad89cb56e5063093a86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839625&amp;x-signature=SFsswHzu7MiIX%2FrTiNOT%2BVLOYRo%3D" alt="" loading="lazy"/></p>
<p><strong>Flutter 3.38 - 刚发布，进入观察期</strong></p>
<ul>
<li><strong>工具链升级</strong>：iOS 引入 UIScene 生命周期支持，旧工程需按指南迁移；Android 默认 NDK 升至 r28，满足 Google Play 16 KB 页面大小兼容要求。</li>
<li><strong>渲染与性能</strong>：Web与移动端有优化，建议用真机与线上数据做对比。</li>
<li><strong>生态适配</strong>：第三方插件与库通常需要1–3周完成适配。</li>
<li><strong>建议</strong>：建议等待三方库适配，同时观察社群反馈</li>
</ul>
<blockquote>
<p>注意：此版本支持了iOS端的UIScene生命周期迁移和Android端的Google Play 16 KB 页面大小兼容，因此建议开发者保持关注，时机成熟后尽早进行适配。</p>
</blockquote>
<p><strong>Flutter 3.35 - 当前推荐版本</strong></p>
<ul>
<li><strong>稳定性提升</strong>：修复了前期版本的主要问题</li>
<li><strong>新功能</strong>：Web端热重载、Widget预览等功能逐步完善</li>
<li><strong>社区评价</strong>：稳定版本，推荐各种项目使用</li>
</ul>
<p><strong>Flutter 3.32 - 渲染引擎调整期</strong></p>
<ul>
<li><strong>渲染后端调整</strong>：从Vulkan回退到OpenGLES，性能有所影响</li>
<li><strong>设备兼容性</strong>：部分老旧设备支持有限</li>
<li><strong>过渡期建议</strong>：等待后续版本稳定性提升</li>
</ul>
<p><strong>Flutter 3.29 - 启动和内存管理需关注</strong></p>
<ul>
<li><strong>应用启动问题</strong>：部分开发者反馈启动阶段存在崩溃现象</li>
<li><strong>内存管理优化</strong>：相比早期版本有所改进，但需持续观察</li>
<li><strong>建议</strong>：生产环境升级前需充分测试</li>
</ul>
<p><strong>Flutter 3.27 - 高风险版本，需谨慎评估</strong></p>
<ul>
<li><strong>Impeller渲染引擎稳定性问题</strong>：新渲染引擎在部分设备上存在问题
<ul>
<li>部分Android设备出现花屏、黑屏现象，影响用户体验</li>
<li>开发环境模拟器性能下降，影响开发效率</li>
<li>可通过 <code>--no-enable-impeller</code> 参数禁用新渲染引擎</li>
</ul>
</li>
<li><strong>社区反馈</strong>：Reddit等平台有用户报告蓝屏和冻结问题</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、不同场景的版本选择策略</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eca95582b2f4ff39eaa0d7e7cbaa185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839625&amp;x-signature=3SROAOvuBn%2F%2FONUqcG3GcSLnrjw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5"><strong>生产环境（求稳不求新）</strong></h4>
<ul>
<li><strong>首选</strong>：Flutter 3.35 - 新功能与稳定性的平衡点</li>
<li><strong>观察期</strong>：Flutter 3.38 - 刚发布，暂不建议直接上生产</li>
</ul>
<p><strong>理由</strong>：用户体验 &gt; 开发体验，稳定压倒一切</p>
<p><strong>3.35版本经过两个月验证没什么大问题，10月份提升为首选</strong></p>
<ul>
<li>如果对稳定性没有极端要求的App可以考虑升级3.35。</li>
<li>如果对稳定性要求很高，建议再观察一个月。</li>
</ul>
<h4 data-id="heading-6"><strong>开发环境（可以激进一点）</strong></h4>
<ul>
<li><strong>推荐</strong>：Flutter 3.35 - 体验最新功能，当前最稳定的版本</li>
<li><strong>注意</strong>：随时准备回滚，不要在deadline前升级</li>
<li><strong>观察期</strong>：3.38版本发布时间太短，三方库适配不够充分，暂时不建议进入开发环境</li>
</ul>
<h4 data-id="heading-7"><strong>新项目启动</strong></h4>
<ul>
<li><strong>最佳选择</strong>：Flutter 3.35</li>
<li><strong>优势</strong>：长期支持、社区活跃、bug修复及时</li>
<li><strong>观察期</strong>：3.38版本发布时间太短，三方库适配不够充分，暂时不建议进入开发环境</li>
</ul>
<h3 data-id="heading-8">⚠️ <strong>需谨慎使用的版本</strong></h3>
<ul>
<li><strong>Flutter 3.38</strong>：刚发布，建议先在开发环境验证，等待社区反馈</li>
<li><strong>Flutter 3.32</strong>：渲染引擎调整期，性能有所影响</li>
<li><strong>Flutter 3.29</strong>：建议充分测试后再用于生产环境</li>
<li><strong>Flutter 3.27</strong>：Impeller渲染引擎在部分设备上存在稳定性问题</li>
</ul>
<hr/>
<h2 data-id="heading-9">总结</h2>
<p>当前的现状是：大厂都在用"过时"版本，而小公司却在追最新。</p>
<p>在客户端项目中，基础框架的版本选择核心原则是不要追新，留两个月冷静期。</p>
<p>"在这个快速迭代的时代，懂得慢下来选择稳定版本的开发者，才是真正的高手。"</p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[事务与消息中间件：分布式系统中的可见性边界问题]]></title>    <link>https://juejin.cn/post/7577050643203375154</link>    <guid>https://juejin.cn/post/7577050643203375154</guid>    <pubDate>2025-11-27T09:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577050643203375154" data-draft-id="7577031454586273819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="事务与消息中间件：分布式系统中的可见性边界问题"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-27T09:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="每天进步一点_JL"/> <meta itemprop="url" content="https://juejin.cn/user/1161549994267080"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            事务与消息中间件：分布式系统中的可见性边界问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1161549994267080/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    每天进步一点_JL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:06:06.000Z" title="Thu Nov 27 2025 09:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">事务与消息中间件：分布式系统中的可见性边界问题</h2>
<h3 data-id="heading-1">一、问题的本质：时空错位的一致性困境</h3>
<p>在微服务架构中，我们常遇到这样的场景：一个业务方法既要修改数据库状态，又要发送消息到MQ触发下游服务。表面看，这只是简单的"写DB+发消息"，但细究其执行时序，隐藏着一个致命陷阱【本文以@Transactional为例】：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
    userRepository.<span class="hljs-title function_">save</span>(user); <span class="hljs-comment">// 1. 数据库操作</span>
    mqProducer.<span class="hljs-title function_">sendUserCreatedEvent</span>(user.<span class="hljs-title function_">getId</span>()); <span class="hljs-comment">// 2. 发送MQ消息</span>
    ......
}
</code></pre>
<p><strong>问题核心</strong>：当事务尚未提交时，MQ消息已被发出。下游消费者立即处理该消息，尝试查询刚刚创建的用户数据，却因<strong>事务尚未提交</strong>而查询不到，导致业务失败。</p>
<p>这不是简单的代码bug，而是分布式系统中<strong>时空错位</strong>的典型表现——事务边界与消息传递在时间维度上不同步，造成数据可见性不一致。正如物理学中的相对论，不同参照系（服务）对"现在"的定义并不相同。</p>
<h4 data-id="heading-2">1.1 事务提交时机的迷思</h4>
<p>Spring的<code>@Transactional</code>背后运作机制常被误解：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/212bc1a115e94599bf4fe23bd04a1767~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q-P5aSp6L-b5q2l5LiA54K5X0pM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839166&amp;x-signature=2Q913JqQTWr59DU6UfyIMr8SynE%3D" alt="image.png" loading="lazy"/></p>
<p>关键洞察：<strong>事务提交发生在方法执行结束之后</strong>，而非数据库操作之后。当<code>mqProducer.send()</code>执行时，事务尚未提交，数据对其他连接不可见。</p>
<h3 data-id="heading-3">二、如何识别这种场景？</h3>
<p>在代码审查中，警惕同时出现的以下模式：</p>
<ul>
<li><code>@Transactional</code>注解的方法内直接调用MQ发送</li>
<li>事务方法内调用异步方法(<code>@Async</code>)</li>
<li>事务方法内触发远程服务调用</li>
<li>事务方法中操作缓存(如Redis)</li>
</ul>
<h3 data-id="heading-4">三、解决方案</h3>
<h4 data-id="heading-5">3.1 事务同步机制：让消息在提交后发送</h4>
<p>利用Spring的<code>TransactionSynchronizationManager</code>注册回调：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeUserService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        userRepository.<span class="hljs-title function_">save</span>(user);
        
        <span class="hljs-comment">// 注册事务提交后的回调</span>
        <span class="hljs-title class_">TransactionSynchronizationManager</span>.<span class="hljs-title function_">registerSynchronization</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionSynchronization</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">afterCommit</span>(<span class="hljs-params"/>) {
                    mqProducer.<span class="hljs-title function_">sendUserCreatedEvent</span>(user.<span class="hljs-title function_">getId</span>());
                }
            }
        );
    }
}
</code></pre>
<h4 data-id="heading-6">3.2 事务消息表：本地事务与消息的原子性</h4>
<p>将消息作为业务数据的一部分，写入同一事务：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
    userRepository.<span class="hljs-title function_">save</span>(user);
    <span class="hljs-comment">// 同一事务中保存消息</span>
    messageRepository.<span class="hljs-title function_">save</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OutboxMessage</span>(<span class="hljs-string">"user.created"</span>, user.<span class="hljs-title function_">getId</span>()));
}

<span class="hljs-comment">// 独立的定时任务/监听器</span>
<span class="hljs-meta">@Scheduled</span>(fixedDelay = <span class="hljs-number">1000</span>)
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendPendingMessages</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">OutboxMessage</span>&gt; messages = messageRepository.<span class="hljs-title function_">findPending</span>(<span class="hljs-number">100</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-title class_">OutboxMessage</span> message : messages) {
        <span class="hljs-keyword">if</span> (mqProducer.<span class="hljs-title function_">send</span>(message)) {
            message.<span class="hljs-title function_">setSent</span>(<span class="hljs-literal">true</span>);
        }
    }
}
</code></pre>
<p>优势：本地事务保证数据与消息的一致性；</p>
<p>劣势：增加了系统复杂度，需要处理消息表清理、重复发送等问题。</p>
<h4 data-id="heading-7">3.3 事件溯源：重构数据与事件的关系</h4>
<p>将事件本身作为首要数据存储，而非副产品：</p>
<pre><code class="hljs language-csharp" lang="csharp">@Transactional
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createUser</span>(<span class="hljs-params">User user</span>)</span> {
    <span class="hljs-comment">// 创建领域事件(持久化)</span>
    UserCreatedEvent <span class="hljs-keyword">event</span> = <span class="hljs-keyword">new</span> UserCreatedEvent(user);
    eventRepository.save(<span class="hljs-keyword">event</span>);
    
    <span class="hljs-comment">// 业务数据从事件中派生</span>
    userRepository.save(user);
}

<span class="hljs-comment">// 事件处理器(独立事务)</span>
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleUserCreated</span>(<span class="hljs-params">UserCreatedEvent <span class="hljs-keyword">event</span></span>)</span> {
    mqProducer.send(<span class="hljs-keyword">event</span>);
}
</code></pre>
<p>这种模式将事件提升为一等公民，从根本上解决了时序问题，但需要对领域模型进行重构。</p>
<h3 data-id="heading-8">四、架构层面的思考</h3>
<h4 data-id="heading-9">4.1 最终一致性 vs 强一致性</h4>
<p>认识到分布式系统中强一致性的高昂代价，大多数业务场景可接受<strong>最终一致性</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">public void handleUserCreatedEvent(String userId) {
    User <span class="hljs-attr">user</span> = null<span class="hljs-comment">;</span>
    int <span class="hljs-attr">retryCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    // 重试机制，等待数据可见
    while (<span class="hljs-attr">user</span> == null &amp;&amp; retryCount &lt; <span class="hljs-number">5</span>) {
        <span class="hljs-attr">user</span> = userRepository.findById(userId).orElse(null)<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">user</span> == null) {
            Thread.sleep(100 * (long)Math.pow(2, retryCount))<span class="hljs-comment">; // 指数退避</span>
            retryCount++<span class="hljs-comment">;</span>
        }
    }
    
    if (<span class="hljs-attr">user</span> == null) {
        // 重试失败，进入死信队列或人工干预
        deadLetterService.handleUnresolvedEvent(userId)<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    
    // 正常处理
    processUser(user)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-10">4.2 事务边界设计原则</h4>
<ul>
<li><strong>单一职责原则</strong>：事务方法应只负责数据一致性，不混杂外部通信</li>
<li><strong>最小事务原则</strong>：事务范围应当尽可能小，只包含必要的数据库操作</li>
<li><strong>分层明确原则</strong>：将事务控制、业务逻辑、集成通信分层实现</li>
</ul>

<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化后的分层设计</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TransactionalEventPublisher eventPublisher;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(CreateUserCommand command)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(command.getName(), command.getEmail());
        userRepository.save(user);
        
        <span class="hljs-comment">// 仅发布领域事件，不关心传输细节</span>
        eventPublisher.publishAfterCommit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCreatedEvent</span>(user.getId()));
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserEventConsumer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmailService emailService;
    
    <span class="hljs-meta">@TransactionalEventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserCreated</span><span class="hljs-params">(UserCreatedEvent event)</span> {
        <span class="hljs-comment">// 保证在事务提交后处理</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(event.getUserId())
            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">EntityNotFoundException</span>(<span class="hljs-string">"User not found after TX commit"</span>));
        
        emailService.sendWelcomeEmail(user);
    }
}
</code></pre>
<h3 data-id="heading-11">五、规避</h3>
<p>当在事务方法中涉及异步操作时，问自己：</p>
<ol>
<li><strong>时序验证</strong>：我的MQ消费者是否依赖此事务中创建/修改的数据？</li>
<li><strong>边界识别</strong>：事务边界是否恰好包裹了所有数据操作，不包含通信逻辑？</li>
<li><strong>回滚考量</strong>：若事务回滚，已发送的MQ消息如何处理？(补偿机制)</li>
<li><strong>重试设计</strong>：消费者是否具备幂等性和重试能力，应对短暂不一致？</li>
<li><strong>监控覆盖</strong>：是否有监控能检测到"消息先于数据到达"的异常情况？</li>
</ol>
<p>事务与MQ的协调问题，本质是分布式系统中时空关系的映射。</p>
<p>避免此问题不在于使用更复杂的框架，而在于<strong>深刻理解事务边界</strong>、<strong>明确系统组件间的时序依赖</strong>，以及<strong>设计符合物理规律的架构</strong>。</p>
<p>当你下次在事务方法中编写MQ发送代码时，不妨暂停片刻，思考：此刻，我的数据的确切位置是什么？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ResizeObserver：轻松监听元素尺寸变化]]></title>    <link>https://juejin.cn/post/7577189654488842290</link>    <guid>https://juejin.cn/post/7577189654488842290</guid>    <pubDate>2025-11-27T08:47:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654488842290" data-draft-id="7577189654488645682" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ResizeObserver：轻松监听元素尺寸变化"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T08:47:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Drift_Dream"/> <meta itemprop="url" content="https://juejin.cn/user/3107677514241500"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ResizeObserver：轻松监听元素尺寸变化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3107677514241500/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Drift_Dream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:47:03.000Z" title="Thu Nov 27 2025 08:47:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ResizeObserver：轻松监听元素尺寸变化</h2>
<h3 data-id="heading-1">什么是ResizeObserver？</h3>
<p>在前端开发中，我们经常需要知道一个元素的尺寸是否发生了变化。过去，我们只能通过监听window的resize事件，但这只能监听浏览器窗口的变化，无法监听具体元素的变化。ResizeObserver应运而生，它可以帮助我们监听任意元素的大小变化。</p>
<p>简单来说，ResizeObserver就像是一个"尺寸监视器"，当被观察的元素尺寸发生变化时，它会立即通知我们。</p>
<h3 data-id="heading-2">为什么需要ResizeObserver？</h3>
<p>在ResizeObserver出现之前，我们想要监听元素尺寸变化通常有以下几种方法：</p>
<ol>
<li><strong>window.resize事件</strong>：只能监听窗口变化，不能监听具体元素</li>
<li><strong>轮询检查</strong>：通过定时器不断检查元素尺寸，性能差</li>
<li><strong>MutationObserver</strong>：可以监听DOM变化，但无法直接监听尺寸变化</li>
</ol>
<p>这些方法要么功能有限，要么性能不佳。ResizeObserver专门为解决这个问题而生，它提供了高效、精准的元素尺寸监听能力。</p>
<h3 data-id="heading-3">基本使用方法</h3>
<h4 data-id="heading-4">创建ResizeObserver</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建ResizeObserver实例</span>
<span class="hljs-keyword">const</span> resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) {
    <span class="hljs-comment">// entry.target：被观察的元素</span>
    <span class="hljs-comment">// entry.contentRect：元素的尺寸信息</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素尺寸发生变化:'</span>, entry.<span class="hljs-property">contentRect</span>);
  }
});
</code></pre>
<h4 data-id="heading-5">观察元素</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myElement'</span>);
resizeObserver.<span class="hljs-title function_">observe</span>(element);
</code></pre>
<h4 data-id="heading-6">停止观察</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 停止观察特定元素</span>
resizeObserver.<span class="hljs-title function_">unobserve</span>(element);

<span class="hljs-comment">// 停止所有观察并销毁实例</span>
resizeObserver.<span class="hljs-title function_">disconnect</span>();
</code></pre>
<h3 data-id="heading-7">完整示例</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ResizeObserver<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.box</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;
    }
    <span class="hljs-selector-class">.resizeable</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">resize</span>: both;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">overflow</span>: auto;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
    <span class="hljs-selector-class">.resizeable1</span> {
      <span class="hljs-attribute">background-color</span>: aquamarine;
    }
    <span class="hljs-selector-class">.resizeable2</span> {
      <span class="hljs-attribute">background-color</span>: blueviolet;
    }
    <span class="hljs-selector-class">.log</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">resize</span>: both;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">flex-direction</span>: column;
      <span class="hljs-attribute">justify-content</span>: space-around;
      <span class="hljs-attribute">align-items</span>: center;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resizeable resizeable1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"resizeable1"</span>&gt;</span>box1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resizeable resizeable2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"resizeable2"</span>&gt;</span>box2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"log"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text2"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> textNode1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">".text1"</span>);
    <span class="hljs-keyword">const</span> textNode2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">".text2"</span>);

    <span class="hljs-keyword">const</span> resizeNode1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#resizeable1"</span>);
    <span class="hljs-keyword">const</span> resizeNode2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#resizeable2"</span>);

    <span class="hljs-keyword">const</span> nodeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entry);
        <span class="hljs-keyword">const</span> { width, height } = entry.<span class="hljs-property">contentRect</span>;
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">target</span>.<span class="hljs-property">id</span> === <span class="hljs-string">"resizeable1"</span>) {
          textNode1.<span class="hljs-property">textContent</span> = <span class="hljs-string">`box1当前尺寸：<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.round(
            width
          )}</span> * <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.round(height)}</span> 像素`</span>;
        } <span class="hljs-keyword">else</span> {
          textNode2.<span class="hljs-property">textContent</span> = <span class="hljs-string">`box2当前尺寸：<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.round(
            width
          )}</span> * <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.round(height)}</span> 像素`</span>;
        }
      }
    });
    nodeObserver.<span class="hljs-title function_">observe</span>(resizeNode1);
    nodeObserver.<span class="hljs-title function_">observe</span>(resizeNode2);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12b3ca003d764be99aab9eb28c9d639a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJpZnRfRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838022&amp;x-signature=sofh2PB60pDRxQWbUIPTaXkLfxI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">在Vue 3中的使用实践</h3>
<h4 data-id="heading-9">组合式API用法</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resize-observer"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"resizableElement"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resizable-box"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>ResizeObserver 简单示例<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前宽度: {{ width }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前高度: {{ height }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">const</span> resizableElement = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> width = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> height = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">let</span> <span class="hljs-attr">resizeObserver</span>: <span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (resizableElement.<span class="hljs-property">value</span>) {
    resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) {
        width.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">width</span>;
        height.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">height</span>;
      }
    });

    resizeObserver.<span class="hljs-title function_">observe</span>(resizableElement.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (resizeObserver) {
    resizeObserver.<span class="hljs-title function_">disconnect</span>();
  }
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.resizable-box</span> {
  <span class="hljs-attribute">resize</span>: both;
  <span class="hljs-attribute">overflow</span>: auto;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e0e0e0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-10">自定义Hook封装</h4>
<p>为了更好地复用，我们可以将ResizeObserver封装成自定义Hook：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { onUnmounted, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useResizeObserver</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> width = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> height = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">let</span> <span class="hljs-attr">resizeObserver</span>: <span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">observe</span> = (<span class="hljs-params">el: HTMLElement</span>) =&gt; {
    <span class="hljs-keyword">if</span> (resizeObserver) {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    }
    resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
        width.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">width</span>;
        height.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">height</span>;
      }
    });
    resizeObserver.<span class="hljs-title function_">observe</span>(el);
  };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">unobserve</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (resizeObserver) {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    }
  };
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (resizeObserver) {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    }
  });
  <span class="hljs-keyword">return</span> {
    width,
    height,
    observe,
    unobserve,
  };
}

</code></pre>
<p>使用自定义Hook</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resize-observer"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"resizableElement"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resizable-box"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>使用钩子函数实现的 ResizeObserver<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前宽度: {{ width }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前高度: {{ height }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onMounted, onUnmounted, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { useResizeObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hook/useResizeObserver.ts"</span>;

<span class="hljs-keyword">const</span> { width, height, observe, unobserve } = <span class="hljs-title function_">useResizeObserver</span>();

<span class="hljs-keyword">const</span> resizableElement = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (resizableElement.<span class="hljs-property">value</span>) {
    <span class="hljs-title function_">observe</span>(resizableElement.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (resizableElement.<span class="hljs-property">value</span>) {
    <span class="hljs-title function_">unobserve</span>(resizableElement.<span class="hljs-property">value</span>);
  }
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.resizable-box</span> {
  <span class="hljs-attribute">resize</span>: both;
  <span class="hljs-attribute">overflow</span>: auto;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e0e0e0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background-color</span>: aquamarine;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-11">Vue 3中ResizeObserver的实际应用：可调整布局的管理后台</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo-container"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 可调整宽度的侧边栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aside</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">"sidebarRef"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar"</span>
      <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ width: sidebarWidth + 'px' }"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>导航菜单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in menuItems"</span>
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span>
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ active: activeMenu === item.id }"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"activeMenu = item.id"</span>
          &gt;</span>
            {{ item.name }}
          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- 拖拽把手 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resize-handle"</span> @<span class="hljs-attr">mousedown</span>=<span class="hljs-string">"startResize"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"mainRef"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleSidebar"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"toggle-btn"</span>&gt;</span>
          {{ isSidebarCollapsed ? "展开侧边栏" : "折叠侧边栏" }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>主要内容区域<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 显示当前尺寸信息 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"size-info"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>侧边栏宽度: {{ sidebarWidth }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>主内容区域宽度: {{ mainContentWidth }}px<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">//  侧边栏状态</span>
<span class="hljs-keyword">const</span> sidebarWidth = <span class="hljs-title function_">ref</span>(<span class="hljs-number">280</span>);
<span class="hljs-keyword">const</span> isSidebarCollapsed = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> activeMenu = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"dashboard"</span>);

<span class="hljs-comment">// 元素引用</span>
<span class="hljs-keyword">const</span> sidebarRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> mainRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 尺寸数据</span>
<span class="hljs-keyword">const</span> mainContentWidth = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// 菜单数据</span>
<span class="hljs-keyword">const</span> menuItems = [
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"dashboard"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"仪表盘"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"users"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"用户管理"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"orders"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"订单管理"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">"settings"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"系统设置"</span> },
];

<span class="hljs-comment">// 监听主内容区域宽度变化</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">mainResizeObserver</span>: <span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 监听主内容区域宽度</span>
  mainResizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) {
      mainContentWidth.<span class="hljs-property">value</span> = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">width</span>;
    }
  });

  <span class="hljs-keyword">if</span> (mainRef.<span class="hljs-property">value</span>) {
    mainResizeObserver.<span class="hljs-title function_">observe</span>(mainRef.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-comment">// 切换侧边栏显示/隐藏</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleSidebar</span> = (<span class="hljs-params"/>) =&gt; {
  isSidebarCollapsed.<span class="hljs-property">value</span> = !isSidebarCollapsed.<span class="hljs-property">value</span>;
  sidebarWidth.<span class="hljs-property">value</span> = isSidebarCollapsed.<span class="hljs-property">value</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">280</span>;
};

<span class="hljs-comment">// 开始调整侧边栏宽度</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">startResize</span> = (<span class="hljs-params">e: MouseEvent</span>) =&gt; {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-keyword">const</span> startX = e.<span class="hljs-property">clientX</span>;
  <span class="hljs-keyword">const</span> startWidth = sidebarWidth.<span class="hljs-property">value</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseMove</span> = (<span class="hljs-params">e: MouseEvent</span>) =&gt; {
    <span class="hljs-keyword">const</span> newWidth = startWidth + (e.<span class="hljs-property">clientX</span> - startX);
    <span class="hljs-comment">// 限制最小和最大宽度</span>
    <span class="hljs-keyword">if</span> (newWidth &gt;= <span class="hljs-number">200</span> &amp;&amp; newWidth &lt;= <span class="hljs-number">500</span>) {
      sidebarWidth.<span class="hljs-property">value</span> = newWidth;
      isSidebarCollapsed.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousemove"</span>, handleMouseMove);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
  };

  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousemove"</span>, handleMouseMove);
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
};

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (mainResizeObserver) {
    mainResizeObserver.<span class="hljs-title function_">disconnect</span>();
  }
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.demo-container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
}

<span class="hljs-selector-class">.sidebar</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#2c3e50</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.sidebar-content</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.sidebar</span> <span class="hljs-selector-tag">h3</span> {
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#34495e</span>;
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-class">.nav-item</span> {
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#34495e</span>;
}

<span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-class">.active</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
}

<span class="hljs-selector-class">.resize-handle</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#34495e</span>;
  <span class="hljs-attribute">cursor</span>: col-resize;
  <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.resize-handle</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
}

<span class="hljs-selector-class">.main-content</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ecf0f1</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
}

<span class="hljs-selector-class">.content-header</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">15px</span>;
}

<span class="hljs-selector-class">.toggle-btn</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-class">.toggle-btn</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#2980b9</span>;
}

<span class="hljs-selector-class">.size-info</span> {
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
}

<span class="hljs-selector-class">.chart-container</span>,
<span class="hljs-selector-class">.table-container</span> {
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3中createApp多个实例共享状态]]></title>    <link>https://juejin.cn/post/7577016562252873779</link>    <guid>https://juejin.cn/post/7577016562252873779</guid>    <pubDate>2025-11-27T08:47:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577016562252873779" data-draft-id="7576953459544916022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3中createApp多个实例共享状态"/> <meta itemprop="keywords" content="Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-27T08:47:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jason_yang"/> <meta itemprop="url" content="https://juejin.cn/user/2972704795802653"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3中createApp多个实例共享状态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2972704795802653/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jason_yang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:47:28.000Z" title="Thu Nov 27 2025 08:47:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.背景</h2>
<p>在 Vue 3 开发中，通常一个应用只需要调用一次 <code>createApp()</code> 创建一个根应用实例。但在某些特定场景下，确实需要创建多个 Vue 应用实例（即多次调用 <code>createApp</code>）。这些场景主要包括：</p>
<h2 data-id="heading-1">2.场景</h2>
<h3 data-id="heading-2">1.动态生成html</h3>
<p><strong>说明</strong>：<br/>
比如在使用google地图的时候，点击弹框使用传入一个html弹框内容详情内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96752d0b501d4d1d88e1c6604a7a50ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839137&amp;x-signature=NK%2FKgzo6IZCklM4TVPIw848jaE8%3D" alt="image.png" loading="lazy"/>
上面就是谷歌点击时候提供的弹框内容，使用<code>InfoWindow.open</code>触发弹框，。<code>infoWindow.setContent</code>插入自己要显示的详情内容。</p>
<p>老办法是直接jquery 插各种dom操作。但现在都组件化了如果能复用现有的架构和样式是最理想的。</p>
<h4 data-id="heading-3">方案1 createApp</h4>
<p>这时候就可以利用createApp创建vue来渲染详情，这样就可以复用系统已经开发好的样式的结构。（缺点重新实例了一遍有一定开销）</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-Js" lang="Js">  <span class="hljs-keyword">import</span> <span class="hljs-title class_">StoreInfoWindow</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/StoreInfoWindow.vue'</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">infoWindow</span>: google.<span class="hljs-property">maps</span>.<span class="hljs-property">InfoWindow</span>
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">markerShowDetail</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">marker: google.maps.marker.AdvancedMarkerElement</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 调用接口查询详情数据</span>
      <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: any = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getStoreInfo</span>(marker)
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span> &amp;&amp; res.<span class="hljs-property">data</span>.<span class="hljs-property">row</span>) {
        <span class="hljs-comment">// 详情页面显示</span>
        <span class="hljs-keyword">const</span> storeDetail = res.<span class="hljs-property">data</span>.<span class="hljs-property">row</span>
        <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
        infoWindow.<span class="hljs-title function_">setContent</span>(content)
        infoWindow.<span class="hljs-title function_">open</span>(map, marker)
        <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">StoreInfoWindow</span>, { <span class="hljs-attr">store</span>: xxx })
        app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ElementPlus</span>)
        app.<span class="hljs-title function_">mount</span>(content)
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// loading.value = false</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error fetching store info:'</span>, error)
    }
  }
</code></pre>
<h4 data-id="heading-4">方案2 隐藏div</h4>
<p>当然也可以不使用createApp，直接在现有sfc页面里 插入一个隐藏的div，内容把内容渲染到隐藏div，调用<code>infoWindow.setContent</code>传入dom</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">import</span> <span class="hljs-title class_">StoreInfoWindow</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/StoreInfoWindow.vue'</span>
  
 &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"hideDiv"</span>&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StoreInfoWindow</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"storeInfoRef"</span> <span class="hljs-attr">:store</span>=<span class="hljs-string">"storeDetail"</span>  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">StoreInfoWindow</span>&gt;</span></span>
    &lt;/div&gt;


  <span class="hljs-keyword">const</span> storeDetail = ref&lt;<span class="hljs-title class_">MapStore</span>&gt;()
  <span class="hljs-keyword">const</span> storeInfoRef = <span class="hljs-title function_">ref</span>()
  <span class="hljs-keyword">let</span> <span class="hljs-attr">infoWindow</span>: google.<span class="hljs-property">maps</span>.<span class="hljs-property">InfoWindow</span>
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">markerShowDetail</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">marker: google.maps.marker.AdvancedMarkerElement</span>) =&gt; {    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 调用接口查询详情数据</span>
      <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: any = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getStoreInfo</span>(marker)
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span> &amp;&amp; res.<span class="hljs-property">data</span>.<span class="hljs-property">row</span>) {
        <span class="hljs-comment">// 详情页面显示</span>
        storeDetail.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">row</span>
        <span class="hljs-keyword">if</span> (storeInfoRef.<span class="hljs-property">value</span>) {
          <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
            infoWindow.<span class="hljs-title function_">setContent</span>(storeInfoRef.<span class="hljs-property">value</span>.<span class="hljs-property">$el</span>)
            infoWindow.<span class="hljs-title function_">open</span>(map, marker)
          })
        }
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error fetching store info:'</span>, error)
    }
  }
</code></pre>
<blockquote>
<p>由于一个dom节点 不能同时挂在多个不同节点下，所以上面的infoWindow.setContent(storeInfoRef.value.$el) 设置后，hideDiv的下面的内容会被移走。所以关闭时候需要还原回来。防止节点引用丢失。</p>
</blockquote>
<p>关闭后，补偿方法</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">infoWindowClose</span> = (<span class="hljs-params"/>) =&gt; {
    infoWindow.<span class="hljs-title function_">close</span>()
    <span class="hljs-keyword">const</span> hideDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.hideDiv'</span>)
    <span class="hljs-keyword">if</span> (hideDiv) {
      <span class="hljs-keyword">if</span> (!hideDiv.<span class="hljs-title function_">contains</span>(storeInfoRef.<span class="hljs-property">value</span>.<span class="hljs-property">$el</span>)) {
        hideDiv.<span class="hljs-title function_">appendChild</span>(storeInfoRef.<span class="hljs-property">value</span>.<span class="hljs-property">$el</span>)
      }
    }
  }
</code></pre>
<h3 data-id="heading-5">2.微前端架构（Micro Frontends）</h3>
<p>在微前端架构中，一个页面可能由多个独立的子应用组成，每个子应用可能是由不同的团队开发、使用不同的框架或不同版本的 Vue。为了隔离作用域和避免冲突，每个子应用应拥有自己的 Vue 实例。</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-number">1</span><span class="hljs-comment">// 子应用 A</span>
2<span class="hljs-keyword">const</span> appA = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">AppA</span>);
3appA.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#micro-app-a'</span>);
<span class="hljs-number">4</span>
<span class="hljs-number">5</span><span class="hljs-comment">// 子应用 B</span>
6<span class="hljs-keyword">const</span> appB = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">AppB</span>);
7appB.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#micro-app-b'</span>);
</code></pre>
<blockquote>
<p>每个子应用可以独立注册插件、全局组件、指令等，互不影响。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">3.在同一个页面嵌入多个独立的 Vue 应用</h3>
<p><strong>说明</strong>：<br/>
比如一个传统多页网站（非 SPA）中，某些页面包含多个功能模块（如导航栏、侧边购物车、评论区），它们彼此逻辑独立，不需要共享状态，也不需要通信。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-Html" lang="Html"><span class="hljs-comment">&lt;!-- index.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"header-widget"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cart-widget"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"comment-section"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HeaderWidget</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./HeaderWidget.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CartWidget</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./CartWidget.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CommentSection</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./CommentSection.vue'</span>;

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">HeaderWidget</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#header-widget'</span>);
<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">CartWidget</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#cart-widget'</span>);
<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">CommentSection</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#comment-section'</span>);
</code></pre>
<blockquote>
<p>每个 widget 是一个独立的 Vue 应用，可单独开发、测试、部署。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">4.插件或第三方库需要隔离的 Vue 实例</h3>
<p><strong>说明</strong>：<br/>
当你开发一个 Vue 插件（如 UI 组件库中的弹窗、通知等），而该插件内部需要渲染 Vue 组件时，为避免污染主应用的全局配置（如全局指令、混入、provide/inject 等），应创建独立的 Vue 实例。</p>
<p><strong>示例</strong>（封装一个全局 Toast 组件）：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-comment">// toast.js</span>
<span class="hljs-keyword">import</span> { createVNode, render } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ToastComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Toast.vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">showToast</span>(<span class="hljs-params">message</span>) {
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container);

  <span class="hljs-keyword">const</span> vm = <span class="hljs-title function_">createVNode</span>(<span class="hljs-title class_">ToastComponent</span>, { message });
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>({}); <span class="hljs-comment">// 创建干净实例</span>
  app.<span class="hljs-title function_">mount</span>(container);
  <span class="hljs-title function_">render</span>(vm, container);
}
</code></pre>
<blockquote>
<p>这样 Toast 不会继承主应用的全局配置，更安全可靠。</p>
</blockquote>
<h3 data-id="heading-8">5.单元测试或多实例沙箱环境</h3>
<p><strong>说明</strong>：<br/>
在编写测试用例时，为避免测试之间互相干扰，每个测试用例应使用独立的 Vue 应用实例。</p>
<p><strong>示例</strong>（Vitest / Jest）：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-title function_">test</span>(<span class="hljs-string">'Component A works'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">ComponentA</span>);
  <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  app.<span class="hljs-title function_">mount</span>(div);
  <span class="hljs-comment">// ...断言</span>
  app.<span class="hljs-title function_">unmount</span>();
});

<span class="hljs-title function_">test</span>(<span class="hljs-string">'Component B works'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">ComponentB</span>); <span class="hljs-comment">// 全新实例，无污染</span>
  <span class="hljs-comment">// ...</span>
});
</code></pre>
<h2 data-id="heading-9">3.createApp 构造方式</h2>
<p>我们复习一下 创建的方式</p>
<h3 data-id="heading-10"><strong>1.传入 SFC（单文件组件）【最常用】</strong></h3>
<h4 data-id="heading-11">传入 .vue 文件作为根组件</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-12">带 root props 的方式</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>, { <span class="hljs-attr">title</span>: <span class="hljs-string">'Hello'</span> }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>SFC 内：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt;
<span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">title</span>: <span class="hljs-title class_">String</span>
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-13"><strong>2.传入 Options API 对象（构造对象组件）</strong></h3>
<p>不用 SFC，直接传一个对象：</p>
<h4 data-id="heading-14">直接传组件对象</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">msg</span>: <span class="hljs-string">'Hello'</span> }
  },
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;{{ msg }}&lt;/div&gt;`</span>
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-15">带 root props</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'title'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;h1&gt;{{ title }}&lt;/h1&gt;`</span>
}, {
  <span class="hljs-attr">title</span>: <span class="hljs-string">'Hello Props'</span>
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-16"><strong>3.传入 Render Function（函数式创建根组件）</strong></h3>
<h4 data-id="heading-17">使用 <code>h()</code> 渲染函数</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp, h } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">createApp</span>({
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'Hello from render'</span>)
  }
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-18">带 root props 的 render 写法</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'msg'</span>],
  <span class="hljs-title function_">render</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, props.<span class="hljs-property">msg</span>)
  }
}, {
  <span class="hljs-attr">msg</span>: <span class="hljs-string">'Hello props'</span>
})
.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<hr/>
<h3 data-id="heading-19"><strong>4.传入 Template 字符串（inline 模板）</strong></h3>
<p>适用于快速 demo：</p>
<h4 data-id="heading-20">根组件直接写 template 字符串</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;p&gt;Hello Template&lt;/p&gt;`</span>
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h4 data-id="heading-21">root props + template</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>({
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'text'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;p&gt;{{ text }}&lt;/p&gt;`</span>
}, {
  <span class="hljs-attr">text</span>: <span class="hljs-string">'Hello!'</span>
}).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h2 data-id="heading-22">4.数据共享问题</h2>
<p>由于两个app 是独立的沙盒，但是我们又需要同步部分数据状态</p>
<h3 data-id="heading-23">1.全局变量（简单场景，不推荐大型项目）</h3>
<p>通过浏览器全局对象（<code>window</code>）存储共享数据，利用 Vue 的响应式 API（<code>ref</code>/<code>reactive</code>）保证数据变更能触发视图更新。</p>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
  <span class="hljs-keyword">const</span> { createApp, ref } = <span class="hljs-title class_">Vue</span>;

  <span class="hljs-comment">// 1. 定义全局共享的响应式数据</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">sharedState</span> = <span class="hljs-title function_">ref</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">'Vue开发者'</span>,
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
  });

  <span class="hljs-comment">// 2. 应用实例1：使用全局共享数据</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> shared = <span class="hljs-variable language_">window</span>.<span class="hljs-property">sharedState</span>;
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; shared.<span class="hljs-property">value</span>.<span class="hljs-property">count</span>++;
      <span class="hljs-keyword">return</span> { shared, increment };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`
      &lt;div&gt;
        &lt;h3&gt;应用1 - 计数：{{ shared.count }}&lt;/h3&gt;
        &lt;button @click="increment"&gt;+1&lt;/button&gt;
      &lt;/div&gt;
    `</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>);

  <span class="hljs-comment">// 3. 应用实例2：共享同一份数据</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> shared = <span class="hljs-variable language_">window</span>.<span class="hljs-property">sharedState</span>;
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeName</span> = (<span class="hljs-params"/>) =&gt; shared.<span class="hljs-property">value</span>.<span class="hljs-property">username</span> = <span class="hljs-string">'新名称'</span>;
      <span class="hljs-keyword">return</span> { shared, changeName };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`
      &lt;div&gt;
        &lt;h3&gt;应用2 - 用户名：{{ shared.username }}&lt;/h3&gt;
        &lt;h3&gt;应用2 - 同步计数：{{ shared.count }}&lt;/h3&gt;
        &lt;button @click="changeName"&gt;修改用户名&lt;/button&gt;
      &lt;/div&gt;
    `</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app2'</span>);
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-24">2.事件总线</h3>
<p>通过第三方事件库（如 <code>mitt</code>）实现跨实例的 “发布 - 订阅” 通信，适用于需要<strong>触发行为 / 传递临时数据</strong>的场景（而非持久化共享状态）。</p>
<h4 data-id="heading-25">步骤：</h4>
<ol>
<li>安装 <code>mitt</code>（工程化项目）：<code>npm install mitt</code>；</li>
<li>创建全局事件总线实例；</li>
<li>不同应用实例通过 <code>emit</code> 发布事件，<code>on</code> 监听事件传递数据。</li>
</ol>
<pre><code class="hljs language-js" lang="js">&lt;!-- <span class="hljs-variable constant_">CDN</span> 方式示例 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.prod.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/mitt/dist/mitt.umd.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> { createApp, ref } = <span class="hljs-title class_">Vue</span>;
  <span class="hljs-comment">// 1. 创建全局事件总线</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">eventBus</span> = <span class="hljs-title function_">mitt</span>();

  <span class="hljs-comment">// 应用1：发布事件（传递数据）</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendCount</span> = (<span class="hljs-params"/>) =&gt; {
        count.<span class="hljs-property">value</span>++;
        <span class="hljs-comment">// 发布事件，携带数据</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'count-change'</span>, count.<span class="hljs-property">value</span>);
      };
      <span class="hljs-keyword">return</span> { count, sendCount };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;button @click="sendCount"&gt;应用1发送计数&lt;/button&gt;`</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>);

  <span class="hljs-comment">// 应用2：监听事件（接收数据）</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> receiveCount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
      <span class="hljs-comment">// 监听事件，接收数据</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">eventBus</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'count-change'</span>, <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {
        receiveCount.<span class="hljs-property">value</span> = val;
      });
      <span class="hljs-keyword">return</span> { receiveCount };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;应用2接收的计数：{{ receiveCount }}&lt;/div&gt;`</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app2'</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-26">3.Pinia/Vuex</h3>
<p>Pinia（Vue 3 官方推荐）/ Vuex 是专门的状态管理库，可创建<strong>全局共享的状态仓库</strong>，多个应用实例通过访问同一仓库实现数据共享（最规范的方案）。</p>
<h4 data-id="heading-27">创建全局 Pinia</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/store/index.js</span>
<span class="hljs-keyword">import</span> { createPinia, defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-comment">// 1. 创建全局 Pinia 实例（唯一）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>();

<span class="hljs-comment">// 2. 定义共享仓库</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useSharedStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'shared'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Pinia 共享数据'</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++;
    },
    <span class="hljs-title function_">updateMessage</span>(<span class="hljs-params">newMsg</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = newMsg;
    }
  }
});
</code></pre>
<h4 data-id="heading-28">多个应用实例挂载同一 Pinia 并使用仓库</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/app1.js（应用实例1）</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { pinia, useSharedStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App1</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App1.vue'</span>;

<span class="hljs-keyword">const</span> app1 = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App1</span>);
<span class="hljs-comment">// 挂载全局 Pinia 实例</span>
app1.<span class="hljs-title function_">use</span>(pinia);
<span class="hljs-comment">// 组件内使用仓库</span>
<span class="hljs-comment">// App1.vue 中：</span>
<span class="hljs-comment">// setup() { const store = useSharedStore(); store.increment(); }</span>
app1.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>);

<span class="hljs-comment">// src/app2.js（应用实例2）</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { pinia, useSharedStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App2</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App2.vue'</span>;

<span class="hljs-keyword">const</span> app2 = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App2</span>);
<span class="hljs-comment">// 挂载同一个 Pinia 实例</span>
app2.<span class="hljs-title function_">use</span>(pinia);
<span class="hljs-comment">// App2.vue 中可直接访问同一份仓库数据</span>
app2.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app2'</span>);
</code></pre>
<h4 data-id="heading-29">组件内使用示例（App1.vue）：</h4>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>应用1 - {{ store.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数：{{ store.count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"store.increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useSharedStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useSharedStore</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-30">组件内使用示例（App2.vue）：</h4>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>应用2 - {{ store.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>同步计数：{{ store.count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"store.updateMessage('应用2修改了消息')"</span>&gt;</span>修改消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useSharedStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useSharedStore</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-31">4.共享响应式对象</h3>
<h4 data-id="heading-32">1. 非sfc方式</h4>
<p>直接创建一个独立的响应式对象（<code>ref</code>/<code>reactive</code>），作为多个应用实例的 “数据源”，本质是将响应式数据抽离到实例外部。</p>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
  <span class="hljs-keyword">const</span> { createApp, ref } = <span class="hljs-title class_">Vue</span>;

  <span class="hljs-comment">// 1. 抽离共享的响应式数据（独立于应用实例）</span>
  <span class="hljs-keyword">const</span> sharedData = <span class="hljs-title function_">ref</span>({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">text</span>: <span class="hljs-string">'共享响应式数据'</span>
  });

  <span class="hljs-comment">// 应用1：使用共享数据</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; sharedData.<span class="hljs-property">value</span>.<span class="hljs-property">count</span>++;
      <span class="hljs-keyword">return</span> { sharedData, increment };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;应用1：{{ sharedData.count }} &lt;button @click="increment"&gt;+1&lt;/button&gt;&lt;/div&gt;`</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>);

  <span class="hljs-comment">// 应用2：使用同一份共享数据</span>
  <span class="hljs-title function_">createApp</span>({
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeText</span> = (<span class="hljs-params"/>) =&gt; sharedData.<span class="hljs-property">value</span>.<span class="hljs-property">text</span> = <span class="hljs-string">'应用2修改'</span>;
      <span class="hljs-keyword">return</span> { sharedData, changeText };
    },
    <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;应用2：{{ sharedData.text }} / {{ sharedData.count }} &lt;button @click="changeText"&gt;改文本&lt;/button&gt;&lt;/div&gt;`</span>
  }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app2'</span>);
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-33">2.sfc的方式</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e477e7b7eb844fd8b509a983b12229b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839137&amp;x-signature=stE2D8COLFf5zIUrdg314iPtls8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Vue 3 共享Ref示例<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 主应用组件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>主应用<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>共享计数: {{ sharedCount }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>标题: {{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"incrementCount"</span>&gt;</span>增加计数<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTitle"</span>&gt;</span>修改标题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 动态创建的组件容器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dynamic-component"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { ref, onMounted, onUnmounted, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
  <span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

  <span class="hljs-comment">// 子组件定义</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">ChildComponent</span> = {
    <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div class="child-component"&gt;
      &lt;h3&gt;动态创建的子组件&lt;/h3&gt;
      &lt;p&gt;共享计数: {{ count }}&lt;/p&gt;
      &lt;p&gt;标题: {{ title }}&lt;/p&gt;
      &lt;button @click="decrementCount"&gt;减少计数&lt;/button&gt;
      &lt;button @click="resetTitle"&gt;重置标题&lt;/button&gt;
    &lt;/div&gt;
  `</span>,
    <span class="hljs-attr">props</span>: {
      <span class="hljs-attr">count</span>: {
        <span class="hljs-comment">// 这里要传入ref类型</span>
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
      <span class="hljs-attr">title</span>: {
        <span class="hljs-comment">// 这里要传入ref类型</span>
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
      <span class="hljs-attr">onDecrement</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Function</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
      <span class="hljs-attr">onResetTitle</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Function</span>,
        <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
      },
    },
    <span class="hljs-attr">methods</span>: {
      <span class="hljs-title function_">decrementCount</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onDecrement</span>()
      },
      <span class="hljs-title function_">resetTitle</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onResetTitle</span>()
      },
    },
  }

  <span class="hljs-comment">// 创建共享的ref</span>
  <span class="hljs-keyword">const</span> sharedCount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> title = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'Hello'</span>)
  <span class="hljs-keyword">let</span> dynamicApp = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">incrementCount</span> = (<span class="hljs-params"/>) =&gt; {
    sharedCount.<span class="hljs-property">value</span>++
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrementCount</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (sharedCount.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0</span>) {
      sharedCount.<span class="hljs-property">value</span>--
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeTitle</span> = (<span class="hljs-params"/>) =&gt; {
    title.<span class="hljs-property">value</span> = <span class="hljs-string">`标题已修改 <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>`</span>
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resetTitle</span> = (<span class="hljs-params"/>) =&gt; {
    title.<span class="hljs-property">value</span> = <span class="hljs-string">'Hello'</span>
  }

  <span class="hljs-comment">// 动态应用的根组件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicRoot</span> = {
    <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;ChildComponent :count="count" :title="title" :on-decrement="onDecrement" :on-reset-title="onResetTitle" /&gt;'</span>,
    <span class="hljs-attr">components</span>: {
      <span class="hljs-title class_">ChildComponent</span>,
    },
    <span class="hljs-attr">props</span>: {
      <span class="hljs-attr">count</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">onDecrement</span>: <span class="hljs-title class_">Function</span>,
      <span class="hljs-attr">onResetTitle</span>: <span class="hljs-title class_">Function</span>,
    },
  }

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 使用createApp(App, props)的写法创建动态应用</span>
    dynamicApp = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">DynamicRoot</span>, {
      <span class="hljs-attr">count</span>: sharedCount,
      <span class="hljs-attr">title</span>: title,
      <span class="hljs-attr">onDecrement</span>: decrementCount,
      <span class="hljs-attr">onResetTitle</span>: resetTitle,
    })

    <span class="hljs-comment">// 挂载到DOM</span>
    dynamicApp.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#dynamic-component'</span>)
  })

  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 清理动态创建的应用</span>
    <span class="hljs-keyword">if</span> (dynamicApp) {
      dynamicApp.<span class="hljs-title function_">unmount</span>()
    }
  })
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
  }

  <span class="hljs-selector-class">.main-app</span>,
  <span class="hljs-selector-class">.child-component</span> {
    <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#e0e0e0</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f9f9f9</span>;
  }

  <span class="hljs-selector-class">.child-component</span> {
    <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#007bff</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f8ff</span>;
  }

  <span class="hljs-selector-tag">button</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#007bff</span>;
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">border</span>: none;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span>;
  }

  <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#0056b3</span>;
  }

  <span class="hljs-selector-tag">h1</span>,
  <span class="hljs-selector-tag">h2</span>,
  <span class="hljs-selector-tag">h3</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<blockquote>
<p>注意 子组件需要使用ref类型作为参数，因为是根节点</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅记一下ElementPlus中的虚拟化表格（el-table-v2）的简单使用]]></title>    <link>https://juejin.cn/post/7577016562252890163</link>    <guid>https://juejin.cn/post/7577016562252890163</guid>    <pubDate>2025-11-27T08:49:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577016562252890163" data-draft-id="7577031454585831451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅记一下ElementPlus中的虚拟化表格（el-table-v2）的简单使用"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-27T08:49:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_瑶瑶_"/> <meta itemprop="url" content="https://juejin.cn/user/3635454702002747"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅记一下ElementPlus中的虚拟化表格（el-table-v2）的简单使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3635454702002747/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _瑶瑶_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:49:59.000Z" title="Thu Nov 27 2025 08:49:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">我的需求</h3>
<p>同时在一个表格中显示6个甚至更多的传感器数据，数据量在每个传感器每10秒1条数据，一般请求1天的数据。</p>
<p>以6个传感器计算一下数据量：</p>
<p><code>6 * 24 * 60 * 6 = 51840</code></p>
<p>一次只能请求到1个传感器的数据，也就是8640条，当查询时间范围变化时，循环请求接口获取数据，并且需要很快的渲染完毕。</p>
<p>效果像这样</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caa8193045524e92941d241d6041b374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-eRtueRtl8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764838242&amp;x-signature=nA55nICdoid0l8aLZgY7OBv7SL0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">我的经历</h3>
<h4 data-id="heading-2">先使用的 Table（el-table）</h4>
<p>调用一次接口反应时间（浏览器网络窗口查看）约在1-2s左右，一次接口的数据使用<code>Table</code>渲染一次时间约是4s左右。</p>
<h4 data-id="heading-3">最开始的想法</h4>
<p>新添加一个传感器的数据，每一次需要重新渲染一次没有问题。</p>
<p>当切换查询时间后，循环调用时，采用的是——给tableData中直接添加。这会导致在循环调取数据时，每调取一次就会重新渲染一次。出现渲染卡顿问题，6个接口调用完毕且渲染完成，需要20-30s的时间，数据量大的时间会更长，有兴趣的朋友可以试一下。</p>
<pre><code class="hljs language-js" lang="js">&lt;el-table v-loading=<span class="hljs-string">"loading"</span> element-loading-text=<span class="hljs-string">"数据加载中"</span>:data=<span class="hljs-string">"tableData"</span>
  height=<span class="hljs-string">"100%"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">:min-width</span>=<span class="hljs-string">"leftWidth"</span> <span class="hljs-attr">:fixed</span>=<span class="hljs-string">"index == 0"</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(column, index) in columns"</span>
    <span class="hljs-attr">:key</span>=<span class="hljs-string">"column.prop"</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">"column.label"</span> <span class="hljs-attr">:prop</span>=<span class="hljs-string">"column.prop"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
&lt;/el-table&gt;
······
tableData.<span class="hljs-property">value</span> = tableData.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any, index: number</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      ...item,
      [<span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(sensor.<span class="hljs-property">id</span>)]: <span class="hljs-title class_">Number</span>(res.<span class="hljs-property">data</span>.<span class="hljs-property">Data</span>[index].<span class="hljs-property">data</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>)
    }
})
</code></pre>
<h4 data-id="heading-4">对最开始的想法优化</h4>
<p>在循环调用时，调用一次渲染一次非常慢，第一次优化是拿到所有的数据之后，再将数据添加至tableData，之后同意进行渲染，这种方式快了一点，但没有太大改善。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">buildTableFromAllData</span> = (<span class="hljs-params">allFetched: <span class="hljs-built_in">Array</span>&lt;any&gt;</span>) =&gt; {
  <span class="hljs-keyword">if</span> (allFetched.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 第一步：构建 columns</span>
  <span class="hljs-keyword">const</span> newColumns = [
    { <span class="hljs-attr">prop</span>: <span class="hljs-string">'time'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'时间'</span> }
  ];
  allFetched.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ device, gateway }</span>) =&gt;</span> {
    newColumns.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">prop</span>: <span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(sensor.<span class="hljs-property">id</span>),
      <span class="hljs-attr">label</span>: sensor.<span class="hljs-property">name</span>
    });
  });

  <span class="hljs-comment">// 第二步：对齐时间轴（假设所有设备返回的时间点一致）</span>
  <span class="hljs-keyword">const</span> firstData = allFetched[<span class="hljs-number">0</span>].<span class="hljs-property">rawData</span>;
  <span class="hljs-keyword">const</span> timeList = firstData.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> <span class="hljs-title function_">dayjs</span>(item.<span class="hljs-property">time</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm:ss'</span>));

  <span class="hljs-comment">// 第三步：构建 tableData 行数据</span>
  <span class="hljs-keyword">const</span> newTableData = timeList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">time: string, index: number</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">row</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = { time };
    allFetched.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">_, colIndex</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> value = allFetched[colIndex].<span class="hljs-property">rawData</span>[index]?.<span class="hljs-property">data</span>;
      <span class="hljs-keyword">const</span> formatted = value ? <span class="hljs-title class_">Number</span>(value).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>) : <span class="hljs-string">''</span>;
      row[<span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(_.<span class="hljs-property">sensor</span>.<span class="hljs-property">id</span>)] = formatted;
    });
    <span class="hljs-keyword">return</span> row;
  });

  <span class="hljs-comment">// 第四步：构建 lineData（用于图表）</span>
  <span class="hljs-keyword">const</span> newLineData = allFetched.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">fetched</span> =&gt;</span>
    fetched.<span class="hljs-property">rawData</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> <span class="hljs-title class_">Number</span>(item.<span class="hljs-property">data</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>))
  );

  <span class="hljs-comment">// ✅ 一次性赋值！只触发一次响应式更新</span>
  columns.<span class="hljs-property">value</span> = newColumns;
  tableData.<span class="hljs-property">value</span> = newTableData;
};
</code></pre>
<h4 data-id="heading-5">虚拟化表格的接触</h4>
<p>在AI的建议下使用虚拟化表格。</p>
<p><code>ElementPlus</code>中的说明<code>通过虚拟化表格组件，超大数据渲染将不再是一个头疼的问题</code>。</p>
<p>使用虚拟化表格之后，渲染速度至少提升一半时间以上。</p>
<pre><code class="hljs language-js" lang="js">&lt;el-auto-resizer&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ height, width }"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-v2</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span> <span class="hljs-attr">element-loading-text</span>=<span class="hljs-string">"数据加载中"</span> <span class="hljs-attr">:columns</span>=<span class="hljs-string">"columns"</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"tableData"</span>
      <span class="hljs-attr">:width</span>=<span class="hljs-string">"width"</span> <span class="hljs-attr">:height</span>=<span class="hljs-string">"height"</span> <span class="hljs-attr">fixed</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/el-auto-resizer&gt;
······
<span class="hljs-keyword">const</span> <span class="hljs-title function_">buildTableFromAllData</span> = (<span class="hljs-params">allFetched: <span class="hljs-built_in">Array</span>&lt;any&gt;</span>) =&gt; {
  <span class="hljs-keyword">if</span> (allFetched.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">newColumns</span>: any[] = [
    {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'time'</span>,
      <span class="hljs-attr">dataKey</span>: <span class="hljs-string">'time'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'时间'</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-number">200</span> * <span class="hljs-title class_">Number</span>(ratio.<span class="hljs-property">value</span>),
      <span class="hljs-attr">fixed</span>: <span class="hljs-string">'left'</span>
    }
  ];

  allFetched.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ sensor }</span>) =&gt;</span> {
    newColumns.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">key</span>: <span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(sensor.<span class="hljs-property">id</span>),
      <span class="hljs-attr">dataKey</span>: <span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(device.<span class="hljs-property">Deviceid</span>),
      <span class="hljs-attr">title</span>: sensor.<span class="hljs-property">name</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-number">200</span> * <span class="hljs-title class_">Number</span>(ratio.<span class="hljs-property">value</span>)
    })
  });

  <span class="hljs-keyword">const</span> firstData = allFetched[<span class="hljs-number">0</span>].<span class="hljs-property">rawData</span>;
  <span class="hljs-keyword">const</span> timeList = firstData.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> <span class="hljs-title function_">dayjs</span>(item.<span class="hljs-property">time</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm:ss'</span>));

  <span class="hljs-keyword">const</span> newTableData = timeList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">time: string, index: number</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">row</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = { time };
    allFetched.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">_, colIndex</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> value = allFetched[colIndex].<span class="hljs-property">rawData</span>[index]?.<span class="hljs-property">data</span>;
      <span class="hljs-keyword">const</span> formatted = value ? <span class="hljs-title class_">Number</span>(value).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>) : <span class="hljs-string">''</span>;
      row[<span class="hljs-string">'data'</span> + <span class="hljs-title class_">String</span>(_.<span class="hljs-property">sensor</span>.<span class="hljs-property">id</span>)] = formatted;
    });
    <span class="hljs-keyword">return</span> row;
  });
  
  <span class="hljs-keyword">const</span> newLineData = allFetched.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">fetched</span> =&gt;</span>
    fetched.<span class="hljs-property">rawData</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> <span class="hljs-title class_">Number</span>(item.<span class="hljs-property">data</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">3</span>))
  );

  <span class="hljs-comment">// ✅ 一次性赋值！只触发一次响应式更新</span>
  columns.<span class="hljs-property">value</span> = newColumns;
  tableData.<span class="hljs-property">value</span> = newTableData;
};
</code></pre>
<h4 data-id="heading-6">其它问题</h4>
<h5 data-id="heading-7">问题</h5>
<p>其实以上用法已经完全解决了我的问题，但是在电脑浏览器中使用无误，但是<code>一换到手机浏览器或者平板浏览器中，虚拟表格直接滑不动</code>，能看到滚动条，但是就是滑不动，以下是我的解决尝试过程。</p>
<h5 data-id="heading-8">AI给的解决方案——添加CSS</h5>
<p>查询到滚动的内容是这样的<code>&lt;div class="el-vl__wrapper el-table-v2__body"</code>，于是我添加了下面的样式</p>
<pre><code class="hljs language-css" lang="css">:<span class="hljs-built_in">deep</span>(.el-table-v2__main .el-table-v2__body) {
  -webkit-<span class="hljs-attribute">overflow</span>-scrolling: touch <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-y</span>: auto <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-x</span>: auto <span class="hljs-meta">!important</span>;
  touch-action: pan-x pan-y <span class="hljs-meta">!important</span>;
}
</code></pre>
<p>结果就是没有结果，并没有解决我的问题。</p>
<h5 data-id="heading-9">最终解决方案——还是添加CSS，但略有不同</h5>
<p>在审查元素的时候发现了一个东西，第二行div中的<code>overflow: hidden;</code></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-vl__wrapper el-table-v2__body"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"rowgroup"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">""</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: relative; overflow: hidden; will-change: transform; direction: ltr; height: 1313.11px; width: 2143.33px;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 3000px; width: 2137.33px;"</span>&gt;</span>
    ······
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>怎么给body设置滚动都没有用，因为里面给<code>hidden</code>了，于是添加的CSS变成了这样</p>
<pre><code class="hljs language-css" lang="css">:<span class="hljs-built_in">deep</span>(.el-table-v2__main .el-table-v2__body) {
  -webkit-<span class="hljs-attribute">overflow</span>-scrolling: touch <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-y</span>: auto <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">overflow-x</span>: auto <span class="hljs-meta">!important</span>;
  touch-action: pan-x pan-y <span class="hljs-meta">!important</span>;
}
</code></pre>
<blockquote>
<p>OK！成功解决问题，以上就是虚拟化表格的浅用过程，得下次有机会再深入使用！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通过<RouterView/>来切换页面组件时，transition如何生效？]]></title>    <link>https://juejin.cn/post/7577204540417146943</link>    <guid>https://juejin.cn/post/7577204540417146943</guid>    <pubDate>2025-11-27T08:59:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417146943" data-draft-id="7576681897297920015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通过&lt;RouterView/&gt;来切换页面组件时，transition如何生效？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-27T08:59:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="saberxyL"/> <meta itemprop="url" content="https://juejin.cn/user/3942228504379243"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通过&lt;RouterView/&gt;来切换页面组件时，transition如何生效？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3942228504379243/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    saberxyL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:59:31.000Z" title="Thu Nov 27 2025 08:59:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">场景</h3>
<p>在使用Vue提供的<code>transition</code>组件来实现页面切换时的过渡效果时，直接使用了<code>transition</code>来包裹路由，结果发现了一个问题，新页面进入时的动画效果成功实现了，而旧页面离开的动画却失效了。</p>
<p>子页面1：</p>
<pre><code class="hljs language-Page1.Vue" lang="Page1.Vue">&lt;template&gt;
    &lt;div class="page1"&gt;
        page1
    &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.page1 {
    width: 100%;
    height: 100%;
    border: 1px solid #000;
    background-color: pink;
    text-align: center;
    font-size: 50px;
}
&lt;/style&gt;
</code></pre>
<p>子页面2:</p>
<pre><code class="hljs language-Page2.vue" lang="Page2.vue">&lt;template&gt;
    &lt;div class="page2"&gt;
        page2
    &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.page2 {
    width: 100%;
    height: 100%;
    background-color: blue;
    text-align: center;
    font-size: 50px;
}
&lt;/style&gt;
</code></pre>
<p>主页面：</p>
<pre><code class="hljs language-App.vue" lang="App.vue">&lt;template&gt;
&lt;div class="container"&gt;
      &lt;div class="tabs"&gt;
    &lt;router-link to="/page1"&gt;page1&lt;/router-link&gt;
    &lt;router-link to="/page2"&gt;page2&lt;/router-link&gt;
  &lt;/div&gt;
  &lt;div class="page"&gt;
      &lt;transition name="fade" mode="out-in"&gt;
          &lt;/router-view&gt;
      &lt;/transition&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;/template&gt;

&lt;style&gt;
.container {
  margin: 0 auto;
  width: 800px;
  height: 600px;
  border: 1px solid #000;
}
.page {
  width: 100%;
  height: calc(100% - 60px);
}
.tabs {
  height: 40px;
  width: 200px;
  margin: 0 auto;
  background: green;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-bottom: 20px;
}
a {
  color: #fff;
  font-size: 20px;
}
.fade-enter-active {
  transition: all 0.5s ease-in-out;
}
.fade-enter-from {
  opacity: 0;
  transform: translateX(100%);
}
.fade-enter-to {
  opacity: 1;
  transform: translateX(0);
}
.fade-leave-active {
  transition: all 0.5s ease-in-out;
}
.fade-leave-from {
  opacity: 1;
  transform: translateX(0);
}
.fade-leave-to {
  opacity: 0;
  transform: translateX(-100%);
}
&lt;/style&gt;

</code></pre>
<p>页面效果如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/980b5ba1a5ef499686630ea997387dc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2FiZXJ4eUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839452&amp;x-signature=tU80UIBMZm6C9wYyKKGsc0ph%2FuI%3D" alt="" loading="lazy"/>
切换页面
<code>.fade-enter</code>相关CSS成功执行，<code>.fade-leave</code>相关CSS执行失败.（如图）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6681024eaf4f12afc4766407dcb97a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2FiZXJ4eUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839452&amp;x-signature=I8Fkf02k0IkhwAntN%2F2sN3jYRyo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">解决方法</h3>
<p>后来我从别人那获取到了解决方法：用 <code>RouterView</code> 包裹 <code>Transition</code> 配合 <code>Component</code> 实现过渡效果。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;router-view v-slot="{ Component }"&gt;
      &lt;transition&gt;
        &lt;component :is="Component" /&gt;
      &lt;/transition&gt;
    &lt;/router-view&gt;
&lt;template/&gt;
</code></pre>
<p>改为这样子后，无论是进入还是里离开都能正确执行了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79bdcc035173466e885a59b6c78e6780~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2FiZXJ4eUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764839452&amp;x-signature=zae8qDK8WznCLSolSoGwJ8OHSIs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">原因</h3>
<p>Vue3 官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fguide%2Fbuilt-ins%2Ftransition.html" target="_blank" title="https://cn.vuejs.org/guide/built-ins/transition.html" ref="nofollow noopener noreferrer">Transition</a>一节中，给出了<code>transition</code>组件的触发条件（满足其一）：</p>
<ul>
<li>由 <code>v-if</code> 所触发的切换</li>
<li>由 <code>v-show</code> 所触发的切换</li>
<li>由特殊元素 <code>&lt;component&gt;</code> 切换的动态组件</li>
<li>改变特殊的 <code>key</code> 属性</li>
</ul>
<p>意思就是说<code>&lt;transition&gt;</code> 组件要正常工作，<strong>包裹的内容必须是 “可复用” 的元素或组件</strong></p>
<h4 data-id="heading-3">问题根源：<code>router-view</code> 是一个 “动态渲染出口”</h4>
<p>其关键在于<code>router-view</code>本身不可复用，它的核心行为如下：</p>
<ul>
<li>当路由切换时，<strong>销毁旧组件实例</strong>，<strong>创建新组件实例</strong>；</li>
<li><code>router-view</code> 本身不会 “更新”，而是直接替换内部的组件内容。</li>
</ul>
<p>当直接写 <code>&lt;transition&gt;&lt;router-view /&gt;&lt;/transition&gt;</code> 时，路由更新，<code>transition</code>还没有来得及给旧组件添加离开的效果时，旧的组件实例已经销毁了，这时新的组件实例创建，<code>transition</code>能够正常捕获到该组件实例。而解决方法是通过作用域插槽 <code>"v-slot={Component}"</code> ，把当前路由对应的组件实例暴露出来, 然后使用 <code>component</code>来动态渲染，由于 <code>&lt;component&gt;</code> 本身是一个 “可复用” 的容器，它不会被销毁，只是改变内部渲染的组件。可以让 <code>&lt;transition&gt;</code> 正常监听组件的 “离开” 和 “进入”，从而执行完整的过渡动画。</p>
<h3 data-id="heading-4">总结</h3>
<p>总之，路由切换过渡动画的核心是让 <code>&lt;transition&gt;</code> 能正常捕获组件的 “离开” 与 “进入” 状态（满足官方给出的触发条件）。避开直接包裹 <code>&lt;router-view&gt;</code> 的误区，同时呢也需要注意样式隔离、动画执行顺序等细节，这样就能实现完整的路由过渡效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android多层嵌套RecyclerView滚动]]></title>    <link>https://juejin.cn/post/7577226553285984291</link>    <guid>https://juejin.cn/post/7577226553285984291</guid>    <pubDate>2025-11-27T09:16:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577226553285984291" data-draft-id="7577226553285935139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android多层嵌套RecyclerView滚动"/> <meta itemprop="keywords" content="Android,Kotlin,Java"/> <meta itemprop="datePublished" content="2025-11-27T09:16:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="方白羽"/> <meta itemprop="url" content="https://juejin.cn/user/2333635831676704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android多层嵌套RecyclerView滚动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2333635831676704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    方白羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:16:07.000Z" title="Thu Nov 27 2025 09:16:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android嵌套滚动终极指南：从Fling中断到丝滑联动的实现之路（含多层嵌套扩展）</h2>
<p>在构建复杂的Android界面时，<strong>RecyclerView嵌套RecyclerView</strong>是无法回避的经典难题。用户期望的是「如丝般顺滑、浑然一体」的滚动体验，但现实往往充斥着滑动冲突、卡顿与恼人的 <strong>「Fling中断」</strong>。</p>
<p>本文将以一个真实的复杂首页场景为例，系统性拆解问题根源，并通过<strong>自定义RecyclerView</strong>从根源解决问题，最终实现「一个整体」的滚动效果。<strong>更重要的是，这套「托管Fling+手动分发」的方案具备极强的扩展性，可支持3层、4层甚至更多层嵌套滚动</strong>（如「外层列表→ViewPager→内层列表→滚动子列表」）。</p>
<h3 data-id="heading-1">一、问题的根源：为什么官方方案「不完美」？</h3>
<h4 data-id="heading-2">1.1 CoordinatorLayout的局限性</h4>
<p><code>CoordinatorLayout + AppBarLayout</code>是官方推荐的嵌套滑动方案，能优雅处理<strong>拖拽滑动</strong>（如向上滚动收起AppBar、向下展开），但在 <strong>Fling（惯性滑动）</strong> ​ 时存在致命缺陷：</p>
<blockquote>
<p><strong>惯性速度无法跨View传递</strong>​</p>
<p>系统的Fling是一次性的动画，一旦某个View的Fling结束，其速度立即消失。不同View间没有天然的「速度接力」机制，导致滚动体验被硬生生中断。</p>
</blockquote>
<h4 data-id="heading-3">1.2 核心矛盾：Fling为何难以跨RecyclerView传递？</h4>
<p>要理解Fling中断的本质，需先明确两个关键事实：</p>
<ul>
<li><strong>系统Fling的一次性</strong>：系统对Fling的处理是「触发即执行完毕」，动画过程中无法中途干预或传递速度；</li>
<li><strong>无天然速度接力机制</strong>：不同RecyclerView作为独立View，没有内置逻辑感知彼此的滚动状态并传递惯性。</li>
</ul>
<p>这导致：当用户快速滑动屏幕时，头部（如AppBar）的Fling结束后，下方列表的Fling无法自动接续，用户会明显感受到「滚动突然停了一下」。</p>
<h3 data-id="heading-4">二、破局之道：托管Fling + 手动分发，实现无缝滚动</h3>
<p>面对官方方案的局限，我们需要跳出「依赖系统Fling」的思维，转向<strong>主动控制滚动流程</strong>：</p>
<h4 data-id="heading-5">2.1 核心策略：从「被动响应」到「主动托管」</h4>
<p>通过两个关键动作打破Fling中断困局：</p>
<ul>
<li><strong>托管Fling</strong>：自行实现惯性滚动的物理模拟（替代系统一次性Fling），掌控每帧滚动的距离与速度；</li>
<li><strong>手动分发</strong>：在每帧滚动中，按预设规则（如上滑外部优先、下滑内部优先）将滚动距离分配给不同RecyclerView。</li>
</ul>
<h3 data-id="heading-6">三、困境：理想滚动与「Fling中断」的现实冲突</h3>
<h4 data-id="heading-7">3.1 目标场景：复杂首页的典型结构</h4>
<p>我们以电商/资讯类App的首页为例，其结构极具代表性：</p>
<ul>
<li><strong>顶部Header</strong>：Banner、金刚区、运营位等固定/可滚动区域；</li>
<li><strong>中部容器</strong>：ViewPager（多Tab切换）；</li>
<li><strong>底部列表</strong>：ViewPager每个Tab对应一个「无限滚动的推荐信息流RecyclerView」。</li>
</ul>
<p><strong>理想体验</strong>：用户一次快速滑动，整个页面（从Header到ViewPager内的列表）应像「单一超长列表」一样惯性滚动到底，无任何中断感。</p>
<h4 data-id="heading-8">3.2 官方方案的尝试与折戟</h4>
<h5 data-id="heading-9">3.2.1 CoordinatorLayout的「拖拽优势」</h5>
<p>通过XML布局，<code>CoordinatorLayout</code>可实现拖拽时的无缝衔接：</p>
<ul>
<li>向上拖拽 → AppBar先收起 → Header完全隐藏后，ViewPager内的列表开始滚动；</li>
<li>向下拖拽 → 列表滚到顶部后，AppBar开始展开。</li>
</ul>
<h5 data-id="heading-10">3.2.2 致命缺陷：Fling速度「断档」</h5>
<p>尽管拖拽体验流畅，但<strong>Fling时惯性速度无法传递</strong>：</p>
<p>当用户快速上滑触发Fling，AppBar的收起动画结束后，速度直接消失，下方的ViewPager列表不会自动接续滚动，用户会看到「列表突然停住，需再次滑动才能继续」的割裂感。</p>
<h3 data-id="heading-11">四、终极方案：自定义嵌套RecyclerView——总指挥官的「托管与分发」</h3>
<p>要彻底解决Fling中断，需让父容器成为滚动的「总指挥官」，完全接管滑动事件的分发权。我们设计的<strong>自定义父RecyclerView</strong>，核心逻辑围绕「精准路权分配」与「Fling托管」展开。</p>
<h4 data-id="heading-12">4.1 策略一：精准的拖拽「路权」分配</h4>
<p>通过重写 <code>dispatchNestedPreScroll</code>定义清晰的滚动优先级规则，确保拖拽过程连贯如「接力赛」：</p>

















<table><thead><tr><th>滑动方向</th><th>路权分配规则</th></tr></thead><tbody><tr><td><strong>上滑</strong>​</td><td>外部父RecyclerView先滚动 → 滑到底后，剩余滚动距离无缝分配给内部子RecyclerView</td></tr><tr><td><strong>下滑</strong>​</td><td>内部子RecyclerView先滚动 → 滑到顶后，外部父RecyclerView开始接管滚动</td></tr></tbody></table>
<p><strong>实现逻辑</strong>：在 <code>dispatchNestedPreScroll</code>中，根据当前滑动方向和子View的滚动边界（如是否滑到底/顶），动态调整传递给子View的滚动距离 <code>consumed</code>，确保「一个View滚不动了，另一个立刻跟上」。</p>
<h4 data-id="heading-13">4.2 策略二：化整为零，托管Fling（方案精髓）</h4>
<p>Fling中断的核心是「系统一次性动画无法接力」，因此我们需要<strong>将Fling拆解为连续的手动滚动帧</strong>，具体分三步：</p>
<h5 data-id="heading-14">4.2.1 拦截Fling：告诉系统「我来处理」</h5>
<p>重写 <code>dispatchNestedPreFling</code>并返回 <code>true</code>，拦截系统的默认Fling处理：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatchNestedPreFling</span><span class="hljs-params">(velocityX: <span class="hljs-type">Float</span>, velocityY: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-comment">// 拦截Fling，后续由自定义逻辑接管</span>
    startCustomFling(velocityY) 
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> 
}
</code></pre>
<h5 data-id="heading-15">4.2.2 启动模拟器：用OverScroller计算每帧位置</h5>
<p>借助 <code>OverScroller</code>模拟物理滚动（类似「自定义物理引擎」），根据初始Fling速度计算未来每帧的滚动位置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> overScroller = OverScroller(context, customInterpolator)

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startCustomFling</span><span class="hljs-params">(initialVelocityY: <span class="hljs-type">Float</span>)</span></span> {
    <span class="hljs-comment">// 传入初始速度（如用户快速上滑的velocityY），OverScroller会自动计算滚动轨迹</span>
    overScroller.fling(
        <span class="hljs-number">0</span>, getCurrentScrollY(), <span class="hljs-comment">// 起始位置</span>
        <span class="hljs-number">0</span>, initialVelocityY,   <span class="hljs-comment">// 初始速度（x轴无需处理，聚焦垂直滚动）</span>
        <span class="hljs-built_in">Int</span>.MIN_VALUE, <span class="hljs-built_in">Int</span>.MAX_VALUE, <span class="hljs-comment">// 滚动范围（理论上无限）</span>
        <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    )
    <span class="hljs-comment">// 触发重绘，进入computeScroll循环</span>
    invalidate()
}
</code></pre>
<h5 data-id="heading-16">4.2.3 逐帧分发：按规则分配滚动距离</h5>
<p>重写 <code>computeScroll</code>方法，在每帧动画中：</p>
<ol>
<li>检查 <code>OverScroller</code>是否还有未完成的滚动；</li>
<li>计算当前帧需滚动的微小距离 <code>dy</code>；</li>
<li>按「上滑外部优先、下滑内部优先」规则，将 <code>dy</code>分配给父/子RecyclerView；</li>
<li>调用 <code>scrollBy(0, dy)</code>执行滚动，直至Fling结束。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">computeScroll</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> (overScroller.computeScrollOffset()) { <span class="hljs-comment">// 滚动未结束</span>
        <span class="hljs-keyword">val</span> currentY = overScroller.currY
        <span class="hljs-keyword">val</span> dy = currentY - lastFlingY <span class="hljs-comment">// 当前帧滚动距离</span>
        lastFlingY = currentY

        <span class="hljs-comment">// 按规则分发dy：上滑时父RV先消费，剩余给子RV；下滑时相反</span>
        distributeScroll(dy, isUpward = dy &lt; <span class="hljs-number">0</span>) 

        invalidate() <span class="hljs-comment">// 继续下一帧</span>
    }
}
</code></pre>
<p><strong>效果</strong>：原本「一次性Fling」被转化为「连续可控的scrollBy」，父/子RecyclerView的滚动无缝接力，彻底消除Fling中断。</p>
<h4 data-id="heading-17">4.3 连接：findViewWithTag——总指挥官的「GPS定位」</h4>
<p>「总指挥官」（父RecyclerView）需精准找到「士兵」（子RecyclerView）。我们通过<strong>Tag链式查找</strong>实现动态定位（避免硬编码ID，增强复用性）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchNestedChild</span><span class="hljs-params">()</span></span>: RecyclerView? {
    <span class="hljs-comment">// 1. 找到ViewPager（假设Tag为"main_viewpager"）</span>
    <span class="hljs-keyword">val</span> viewPager = findViewWithTag&lt;ViewPager&gt;(<span class="hljs-string">"main_viewpager"</span>) ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-comment">// 2. 获取当前显示的Fragment（需结合ViewPager适配器逻辑）</span>
    <span class="hljs-keyword">val</span> adapter = viewPager.adapter <span class="hljs-keyword">as</span>? MainViewPagerAdapter ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">val</span> currentFragment = adapter.getCurrentFragment() ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-comment">// 3. 在Fragment视图中找到子RecyclerView（Tag为"inner_feed_rv"）</span>
    <span class="hljs-keyword">return</span> currentFragment.view?.findViewWithTag&lt;RecyclerView&gt;(<span class="hljs-string">"inner_feed_rv"</span>)
}
</code></pre>
<p><strong>优势</strong>：通过Tag解耦布局层级，即使ViewPager的Fragment动态切换，也能实时定位当前活跃的子RecyclerView。</p>
<h4 data-id="heading-18">4.4 灵魂：手感的秘密——五次方缓出插值器</h4>
<p>滚动「手感」决定用户体验的上限。我们通过自定义插值器，让Fling的减速过程更接近真实物理摩擦力：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">val</span> <span class="hljs-variable">customInterpolator</span> <span class="hljs-operator">=</span> Interpolator { t -&gt;
    <span class="hljs-type">val</span> <span class="hljs-variable">adjustedT</span> <span class="hljs-operator">=</span> t - <span class="hljs-number">1.0f</span>
    adjustedT * adjustedT * adjustedT * adjustedT * adjustedT + <span class="hljs-number">1.0f</span> <span class="hljs-comment">// 五次方缓出公式</span>
}

<span class="hljs-comment">// 初始化OverScroller时传入插值器</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">val</span> <span class="hljs-variable">overScroller</span> <span class="hljs-operator">=</span> OverScroller(context, customInterpolator)
</code></pre>
<p><strong>五次方缓出（Quintic Ease-Out）的特性</strong>：</p>
<ul>
<li>速度曲线：瞬间达到峰值 → 迅速衰减 → 缓慢归零；</li>
<li>物理感：接近「带摩擦力的滚动」，比系统原生指数衰减更灵敏、动态感更强；</li>
<li>体验优化：避免Fling「戛然而止」的突兀感，滚动结束更自然。</li>
</ul>
<h3 data-id="heading-19">五、【关键扩展】从2层到N层：多层嵌套滚动的实现逻辑</h3>
<p>前文方案以「2层嵌套」（父RecyclerView→子RecyclerView）为例，但<strong>核心设计天然支持3层、4层甚至更多层嵌套</strong>。关键在于：<strong>将「父子分发」抽象为「层级链分发」，每层仅关注「自身与直接子View」的交互，形成递归式滚动接力</strong>。</p>
<h4 data-id="heading-20">5.1 多层嵌套的典型场景</h4>
<p>例如某资讯App的「专题详情页」：</p>
<ul>
<li><strong>第1层</strong>：外层纵向RecyclerView（包含专题Header、简介、章节列表）；</li>
<li><strong>第2层</strong>：章节列表中的Item是横向RecyclerView（展示该章节的文章卡片）；</li>
<li><strong>第3层</strong>：文章卡片点击后展开为纵向RecyclerView（展示文章评论流）；</li>
<li><strong>第4层</strong>：评论流中可能嵌套横向RecyclerView（展示热门回复标签）。</li>
</ul>
<p><strong>需求</strong>：用户快速上滑时，从第1层Header到第4层评论流，需像「单一长列表」一样惯性滚动到底，无任何中断。</p>
<h4 data-id="heading-21">5.2 扩展核心：层级链分发 + 递归路权判断</h4>
<p>多层嵌套的关键是<strong>让每层RecyclerView都成为「局部指挥官」</strong>，通过「递归判断滚动边界」实现跨层接力：</p>
<h5 data-id="heading-22">5.2.1 抽象分发规则：每层仅需处理「自身与直接子View」</h5>
<p>无论多少层，每层RecyclerView的分发逻辑可抽象为：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/** 通用滚动分发逻辑：当前层先消费滚动距离，剩余传递给直接子View */</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatchScrollToChild</span><span class="hljs-params">(dy: <span class="hljs-type">Int</span>, isUpward: <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">var</span> remainingDy = dy <span class="hljs-comment">// 剩余未消费的滚动距离</span>
    <span class="hljs-comment">// 1. 当前层先判断是否可滚动（如未到顶部/底部）</span>
    <span class="hljs-keyword">val</span> currentConsumed = consumeSelfScroll(remainingDy, isUpward)
    remainingDy -= currentConsumed

    <span class="hljs-comment">// 2. 若当前层已滚不动（remainingDy≠0），则传递给直接子View</span>
    <span class="hljs-keyword">if</span> (remainingDy != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">val</span> child = findDirectChildRecyclerView() <span class="hljs-comment">// 找直接子RecyclerView（如第2层找第3层）</span>
        <span class="hljs-keyword">if</span> (child != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 递归调用子View的分发逻辑（子View可能继续传递给它的子View）</span>
            remainingDy = child.dispatchScrollRecursive(remainingDy, isUpward)
        }
    }
    <span class="hljs-keyword">return</span> dy - remainingDy <span class="hljs-comment">// 返回当前层及子View总共消费的距离</span>
}
</code></pre>
<h5 data-id="heading-23">5.2.2 递归终止条件：最内层View或滚动边界</h5>
<p>递归分发会在两种情况下终止：</p>
<ul>
<li><strong>触达最内层View</strong>：如第4层评论流的RecyclerView无嵌套子View，直接消费剩余滚动距离；</li>
<li><strong>滚动到边界</strong>：某层View已滑到顶部/底部（如第2层横向RecyclerView滑到最左/右），无法继续消费滚动距离，此时滚动停止或反向传递（如下滑时从内层向外层传递）。</li>
</ul>
<h5 data-id="heading-24">5.2.3 Fling托管的跨层延续</h5>
<p>Fling的托管逻辑同样支持多层：</p>
<ul>
<li>每层RecyclerView维护自身的 <code>OverScroller</code>，但根据「层级优先级」决定是否接管Fling；</li>
<li>例如第1层Fling时，若第1层未滚到底，则自身消费Fling；若已滚到底，则将Fling速度传递给第2层；第2层同理传递给第3层，直至最内层消费完毕。</li>
</ul>
<h4 data-id="heading-25">5.3 多层嵌套的关键实现细节</h4>
<h5 data-id="heading-26">5.3.1 动态层级查找：从「单层GPS」到「层级链GPS」</h5>
<p>通过<strong>层级Tag标记</strong>实现任意层View的定位，例如：</p>
<ul>
<li>第1层RecyclerView Tag：<code>"layer1_main_rv"</code></li>
<li>第2层横向RecyclerView Tag：<code>"layer2_horizontal_rv"</code></li>
<li>第3层评论流RecyclerView Tag：<code>"layer3_comment_rv"</code></li>
</ul>
<p>查找第N层View时，通过链式Tag拼接定位：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findLayerNChild</span><span class="hljs-params">(layerTagPrefix: <span class="hljs-type">String</span>)</span></span>: RecyclerView? {
    <span class="hljs-keyword">var</span> currentView: View = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">2.</span>.layerTagPrefix.last().digitToInt()) { <span class="hljs-comment">// 从第2层开始递归查找</span>
        currentView = currentView.findViewWithTag(<span class="hljs-string">"<span class="hljs-subst">${layerTagPrefix}</span><span class="hljs-subst">${i}</span>"</span>) ?: <span class="hljs-keyword">break</span>
    }
    <span class="hljs-keyword">return</span> currentView <span class="hljs-keyword">as</span>? RecyclerView
}
</code></pre>
<h5 data-id="heading-27">5.3.2 性能考量：避免递归过深导致的卡顿</h5>
<p>多层递归可能增加计算开销，需通过以下方式优化：</p>
<ul>
<li><strong>缓存子View引用</strong>：对频繁访问的内层View（如当前显示的ViewPager Tab内的RecyclerView），缓存其引用避免重复查找；</li>
<li><strong>限制最大嵌套深度</strong>：实际业务中嵌套超过4层的情况极少，可通过配置限制最大递归深度，避免栈溢出；</li>
<li><strong>异步预加载边界</strong>：提前计算各层View的滚动边界（如是否已滑到底），减少实时递归判断的性能消耗。</li>
</ul>
<h3 data-id="heading-28">六、结论：从「用轮子」到「造轮子」的工程智慧</h3>
<p>当官方API无法满足复杂场景需求时，深入底层构建自定义方案是一种「高级工程权衡」。本文方案的核心启示：</p>
<h4 data-id="heading-29">6.1 理解问题本质是基础</h4>
<p>CoordinatorLayout的局限不在「拖拽」，而在「Fling速度无法跨View传递」——这是所有嵌套滚动卡顿/中断的起点。</p>
<h4 data-id="heading-30">6.2 选择正确的「攻坚道路」</h4>
<p>上层API（如CoordinatorLayout）是「通用工具」，复杂业务场景需「定制化武器」。通过深入 <code>NestedScrolling</code>机制与事件分发底层，我们能构建更贴合业务的滚动规则。</p>
<h4 data-id="heading-31">6.3 扩展性：从2层到N层的核心价值</h4>
<p>本文方案的最大亮点并非仅解决2层嵌套，而是提供了<strong>一套可扩展的嵌套滚动框架</strong>：通过「层级链分发+递归路权判断」，支持3层、4层甚至更多层嵌套，满足电商首页、资讯专题页等超复杂场景的无缝滚动需求。</p>
<h4 data-id="heading-32">6.4 优雅解决问题：功能与体验的双重打磨</h4>
<p>我们不仅通过「托管Fling+手动分发」解决了Fling中断的功能问题，更通过<strong>五次方插值器</strong>优化了滚动手感，让体验从「能用」升级为「好用」。</p>
<h4 data-id="heading-33">最终权衡：牺牲100%保真，换99%流畅与100%连贯</h4>
<p>该方案虽未100%复刻系统Fling的物理精度，却换来了复杂业务场景下「几乎无中断」的流畅体验。这是工程实践中「取舍与平衡」的典范——<strong>用户的「连贯感」比「物理精度」更重要</strong>。</p>
<p>下一次面对棘手嵌套滚动时，不妨思考：除了使用现成轮子，我们也可选择成为「造轮子的人」——毕竟，极致的用户体验，往往藏在自定义的细节里，而「可扩展的自定义方案」，更能支撑业务的无限可能</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[密码算法的OID查阅]]></title>    <link>https://juejin.cn/post/7577189654489169970</link>    <guid>https://juejin.cn/post/7577189654489169970</guid>    <pubDate>2025-11-27T09:33:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654489169970" data-draft-id="7576968345876348955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="密码算法的OID查阅"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-11-27T09:33:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鳄鱼儿"/> <meta itemprop="url" content="https://juejin.cn/user/3751996066103758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            密码算法的OID查阅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3751996066103758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鳄鱼儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:33:51.000Z" title="Thu Nov 27 2025 09:33:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、OID 命名结构</h3>
<h4 data-id="heading-1">1. 纯模式（Pure Mode）</h4>
<p>直接对原始消息签名，OID 格式为：</p>
<pre><code class="hljs language-xml" lang="xml">id-slh-dsa-<span class="hljs-tag">&lt;<span class="hljs-name">hash-family</span>&gt;</span>-<span class="hljs-tag">&lt;<span class="hljs-name">security-level</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">variant</span>&gt;</span>
</code></pre>
<p>其中：</p>
<ul>
<li><code>&lt;hash-family&gt;</code>：<code>sha2</code> 或 <code>shake</code></li>
<li><code>&lt;security-level&gt;</code>：<code>128</code>、<code>192</code>、<code>256</code></li>
<li><code>&lt;variant&gt;</code>：<code>s</code>（small，优化签名长度）或 <code>f</code>（fast，优化签名/密钥生成速度）</li>
</ul>
<p>示例：</p>
<ul>
<li><code>id-slh-dsa-sha2-128s</code></li>
<li><code>id-slh-dsa-shake-256f</code></li>
</ul>
<p>这些 OID 隶属于 <code>nistAlgorithms(2.16.840.1.101.3.4.3)</code> 下的 <code>sigAlgs(20–31)</code> 范围。</p>
<h4 data-id="heading-2">2. 预哈希模式（Hashed Mode）</h4>
<p>先对消息进行指定哈希，再对摘要签名，OID 格式为：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">id</span>-<span class="hljs-built_in">hash</span>-slh-dsa-&lt;<span class="hljs-built_in">hash</span>-family&gt;-&lt;security-level&gt;&lt;variant&gt;-<span class="hljs-keyword">with</span>-&lt;prehash-alg&gt;
</code></pre>
<p>其中 <code>&lt;prehash-alg&gt;</code> 必须与安全级别匹配：</p>
<ul>
<li>128 位安全 → SHA-256 或 SHAKE128</li>
<li>192 位安全 → SHA-384 或 SHAKE192</li>
<li>256 位安全 → SHA-512 或 SHAKE256</li>
</ul>
<p>示例：</p>
<ul>
<li><code>id-hash-slh-dsa-sha2-128s-with-sha256</code></li>
<li><code>id-hash-slh-dsa-shake-256f-with-shake256</code></li>
</ul>
<p>这些 OID 隶属于 <code>nistAlgorithms.sigAlgs(2.16.840.1.101.3.4.3)</code> 的 <code>35–46</code> 范围。</p>
<hr/>
<h3 data-id="heading-3">二、完整 OID 列表（按安全级别分类）</h3>
<h4 data-id="heading-4">SLH-DSA算法</h4>
<p>SLH-DSA（Stateless Hash-Based Digital Signature Algorithm）是 NIST 在 FIPS 205 标准中正式标准化的后量子数字签名算法，其 OID（对象标识符）由 <strong>NIST CSOR（Computer Security Objects Registry）</strong> 分配，用于在 X.509 PKI、CMS 等密码协议中唯一标识不同参数组合和工作模式。</p>













































































































































































































<table><thead><tr><th>安全级别</th><th>模式</th><th>哈希家族</th><th>变体</th><th>OID 名称</th><th>示例 OID（十进制点分格式）</th></tr></thead><tbody><tr><td>128</td><td>Pure</td><td>sha2</td><td>s</td><td>id-slh-dsa-sha2-128s</td><td><code>2.16.840.1.101.3.4.3.20</code></td></tr><tr><td>128</td><td>Pure</td><td>sha2</td><td>f</td><td>id-slh-dsa-sha2-128f</td><td><code>2.16.840.1.101.3.4.3.21</code></td></tr><tr><td>128</td><td>Pure</td><td>shake</td><td>s</td><td>id-slh-dsa-shake-128s</td><td><code>2.16.840.1.101.3.4.3.22</code></td></tr><tr><td>128</td><td>Pure</td><td>shake</td><td>f</td><td>id-slh-dsa-shake-128f</td><td><code>2.16.840.1.101.3.4.3.23</code></td></tr><tr><td>192</td><td>Pure</td><td>sha2</td><td>s</td><td>id-slh-dsa-sha2-192s</td><td><code>2.16.840.1.101.3.4.3.24</code></td></tr><tr><td>192</td><td>Pure</td><td>sha2</td><td>f</td><td>id-slh-dsa-sha2-192f</td><td><code>2.16.840.1.101.3.4.3.25</code></td></tr><tr><td>192</td><td>Pure</td><td>shake</td><td>s</td><td>id-slh-dsa-shake-192s</td><td><code>2.16.840.1.101.3.4.3.26</code></td></tr><tr><td>192</td><td>Pure</td><td>shake</td><td>f</td><td>id-slh-dsa-shake-192f</td><td><code>2.16.840.1.101.3.4.3.27</code></td></tr><tr><td>256</td><td>Pure</td><td>sha2</td><td>s</td><td>id-slh-dsa-sha2-256s</td><td><code>2.16.840.1.101.3.4.3.28</code></td></tr><tr><td>256</td><td>Pure</td><td>sha2</td><td>f</td><td>id-slh-dsa-sha2-256f</td><td><code>2.16.840.1.101.3.4.3.29</code></td></tr><tr><td>256</td><td>Pure</td><td>shake</td><td>s</td><td>id-slh-dsa-shake-256s</td><td><code>2.16.840.1.101.3.4.3.30</code></td></tr><tr><td>256</td><td>Pure</td><td>shake</td><td>f</td><td>id-slh-dsa-shake-256f</td><td><code>2.16.840.1.101.3.4.3.31</code></td></tr><tr><td>128</td><td>Prehash</td><td>sha2</td><td>s</td><td>id-hash-slh-dsa-sha2-128s-with-sha256</td><td><code>2.16.840.1.101.3.4.3.35</code></td></tr><tr><td>128</td><td>Prehash</td><td>sha2</td><td>f</td><td>id-hash-slh-dsa-sha2-128f-with-sha256</td><td><code>2.16.840.1.101.3.4.3.36</code></td></tr><tr><td>128</td><td>Prehash</td><td>shake</td><td>s</td><td>id-hash-slh-dsa-shake-128s-with-shake128</td><td><code>2.16.840.1.101.3.4.3.37</code></td></tr><tr><td>128</td><td>Prehash</td><td>shake</td><td>f</td><td>id-hash-slh-dsa-shake-128f-with-shake128</td><td><code>2.16.840.1.101.3.4.3.38</code></td></tr><tr><td>192</td><td>Prehash</td><td>sha2</td><td>s</td><td>id-hash-slh-dsa-sha2-192s-with-sha384</td><td><code>2.16.840.1.101.3.4.3.39</code></td></tr><tr><td>192</td><td>Prehash</td><td>sha2</td><td>f</td><td>id-hash-slh-dsa-sha2-192f-with-sha384</td><td><code>2.16.840.1.101.3.4.3.40</code></td></tr><tr><td>192</td><td>Prehash</td><td>shake</td><td>s</td><td>id-hash-slh-dsa-shake-192s-with-shake192</td><td><code>2.16.840.1.101.3.4.3.41</code></td></tr><tr><td>192</td><td>Prehash</td><td>shake</td><td>f</td><td>id-hash-slh-dsa-shake-192f-with-shake192</td><td><code>2.16.840.1.101.3.4.3.42</code></td></tr><tr><td>256</td><td>Prehash</td><td>sha2</td><td>s</td><td>id-hash-slh-dsa-sha2-256s-with-sha512</td><td><code>2.16.840.1.101.3.4.3.43</code></td></tr><tr><td>256</td><td>Prehash</td><td>sha2</td><td>f</td><td>id-hash-slh-dsa-sha2-256f-with-sha512</td><td><code>2.16.840.1.101.3.4.3.44</code></td></tr><tr><td>256</td><td>Prehash</td><td>shake</td><td>s</td><td>id-hash-slh-dsa-shake-256s-with-shake256</td><td><code>2.16.840.1.101.3.4.3.45</code></td></tr><tr><td>256</td><td>Prehash</td><td>shake</td><td>f</td><td>id-hash-slh-dsa-shake-256f-with-shake256</td><td><code>2.16.840.1.101.3.4.3.46</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">三、参考资料</h3>
<ul>
<li><strong>FIPS 205</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnvlpubs.nist.gov%2Fnistpubs%2FFIPS%2FNIST.FIPS.205.pdf" target="_blank" title="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.205.pdf" ref="nofollow noopener noreferrer">nvlpubs.nist.gov/nistpubs/FI…</a></li>
<li><strong>RFC 9814</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rfc-editor.org%2Frfc%2Frfc9814.html" target="_blank" title="https://www.rfc-editor.org/rfc/rfc9814.html" ref="nofollow noopener noreferrer">www.rfc-editor.org/rfc/rfc9814…</a></li>
<li><strong>NIST CSOR Registry</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fcsrc.nist.gov%2Fprojects%2Fcomputer-security-objects-register" target="_blank" title="https://csrc.nist.gov/projects/computer-security-objects-register" ref="nofollow noopener noreferrer">csrc.nist.gov/projects/co…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcsrc.nist.gov%2Fprojects%2Fcomputer-security-objects-register%2Falgorithm-registration" target="_blank" title="https://csrc.nist.gov/projects/computer-security-objects-register/algorithm-registration" ref="nofollow noopener noreferrer">NIST CSOR</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[揭秘 eMMC 存储扩容：找回 “消失” 空间的简便之道]]></title>    <link>https://juejin.cn/post/7577050643203588146</link>    <guid>https://juejin.cn/post/7577050643203588146</guid>    <pubDate>2025-11-27T09:29:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577050643203588146" data-draft-id="7577016562253103155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="揭秘 eMMC 存储扩容：找回 “消失” 空间的简便之道"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2025-11-27T09:29:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月光技术杂谈"/> <meta itemprop="url" content="https://juejin.cn/user/3323149076668138"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            揭秘 eMMC 存储扩容：找回 “消失” 空间的简便之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323149076668138/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月光技术杂谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:29:12.000Z" title="Thu Nov 27 2025 09:29:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">揭秘 eMMC 存储扩容：找回 “消失” 空间的简便之道</h2>
<h3 data-id="heading-1">概要</h3>
<p>在使用编译好的固件烧写系统启动后，你是否遇到过这样的困惑：明明硬件 eMMC 存储为 32G，可系统显示的用户分区却仅有 812M。常规修改固件分区表来调整的方法较为繁琐，本文将带你验证一种更为简便的方式，轻松找回那些 “消失” 的 eMMC 存储空间。</p>
<h3 data-id="heading-2">问题分析</h3>
<p>系统启动后，通过执行相关命令查看分区信息，能清晰了解当前系统的存储分配状况：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  664M   91M  88% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   19M  968M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup

<span class="hljs-comment"># lsblk</span>
NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
mmcblk0      179:0    0 28.9G  0 disk 
├─mmcblk0p1  179:1    0    4M  0 part 
├─mmcblk0p2  179:2    0    4M  0 part 
├─mmcblk0p3  179:3    0   64M  0 part 
├─mmcblk0p4  179:4    0   64M  0 part 
├─mmcblk0p5  179:5    0   32M  0 part 
├─mmcblk0p6  179:6    0    6G  0 part /
├─mmcblk0p7  179:7    0  128M  0 part 
└─mmcblk0p8  179:8    0 22.6G  0 part 
mmcblk0boot0 179:32   0    4M  1 disk 
mmcblk0boot1 179:64   0    4M  1 disk 
zram0        254:0    0    0B  0 disk 
</code></pre>
<p>从上述信息可知，分区<code>mmcblk0p6</code>被挂载为根分区，而拥有 22.6G 空间的<code>mmcblk0p8</code>却处于闲置状态，这便是存储空间未被充分利用的症结所在。</p>
<h3 data-id="heading-3">解决过程</h3>
<ol>
<li><strong>初次挂载尝试</strong>：尝试挂载<code>mmcblk0p8</code>分区到<code>/mnt/</code>目录，然而，执行<code>df -h</code>命令查看时，却发现并未显示其实际大小：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mount /dev/mmcblk0p8 /mnt/
<span class="hljs-built_in">df</span> -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  664M   91M  88% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   20M  967M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup
/dev/mmcblk0p8   23G   24K   21G   1% /mnt

<span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  664M   91M  88% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   19M  968M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup
/dev/mmcblk0p8  4.0M  283K  3.5M   8% /mnt
</code></pre>
<ol>
<li><strong>格式化与重新挂载</strong>：为解决这一问题，需先对<code>/dev/mmcblk0p8</code>进行格式化操作。格式化使用<code>mkfs.ext4</code>命令，此命令将在该分区创建一个 ext4 文件系统：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># mkfs.ext4 /dev/mmcblk0p8</span>
mke2fs 1.46.5 (30 - Dec - 2021)
/dev/mmcblk0p8 contains a ext2 file system labelled <span class="hljs-string">'userdata'</span>
    last mounted on Wed Dec 20 16:54:25 2023
Proceed anyway? (y,N) y
Discarding device blocks: <span class="hljs-keyword">done</span>                            
Creating filesystem with 5926904 4k blocks and 1482752 inodes
Filesystem UUID: af5f8523 - e705 - 4b11 - 8615 - 7c28df16aecb
Superblock backups stored on blocks: 
    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
    4096000

Allocating group tables: <span class="hljs-keyword">done</span>                            
Writing inode tables: <span class="hljs-keyword">done</span>                            
Creating journal (32768 blocks): <span class="hljs-keyword">done</span>
Writing superblocks and filesystem accounting information: <span class="hljs-keyword">done</span>  
</code></pre>
<p>格式化完成后，卸载之前的挂载点，重新挂载<code>/dev/mmcblk0p8</code>到<code>/mnt/</code>。此时再次执行<code>df -h</code>和<code>lsblk</code>命令查看，分区大小已显示正常：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># umount /mnt/</span>
<span class="hljs-comment"># mount /dev/mmcblk0p8 /mnt/</span>
<span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  664M   91M  88% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   20M  967M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup
/dev/mmcblk0p8   23G   24K   21G   1% /mnt

<span class="hljs-comment"># lsblk </span>
NAME         MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
mmcblk0      179:0    0 28.9G  0 disk 
├─mmcblk0p1  179:1    0    4M  0 part 
├─mmcblk0p2  179:2    0    4M  0 part 
├─mmcblk0p3  179:3    0   64M  0 part 
├─mmcblk0p4  179:4    0   64M  0 part 
├─mmcblk0p5  179:5    0   32M  0 part 
├─mmcblk0p6  179:6    0    6G  0 part /
├─mmcblk0p7  179:7    0  128M  0 part 
└─mmcblk0p8  179:8    0 22.6G  0 part /root
mmcblk0boot0 179:32   0    4M  1 disk 
mmcblk0boot1 179:64   0    4M  1 disk 
zram0        254:0    0    0B  0 disk
</code></pre>
<h3 data-id="heading-4">配置永久生效</h3>
<p>为使上述挂载配置在系统重启后依然生效，需对<code>fstab</code>文件进行相应设置。</p>
<ol>
<li><strong>导出 fstab 配置</strong>：通过执行<code>block detect &gt; /etc/config/fstab</code>命令，导出当前系统的<code>fstab</code>配置信息。查看该文件内容如下：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># cat  /etc/config/fstab </span>
config <span class="hljs-string">'global'</span>
    option	anon_swap	<span class="hljs-string">'0'</span>
    option	anon_mount	<span class="hljs-string">'0'</span>
    option	auto_swap	<span class="hljs-string">'1'</span>
    option	auto_mount	<span class="hljs-string">'1'</span>
    option	delay_root	<span class="hljs-string">'5'</span>
    option	check_fs	<span class="hljs-string">'0'</span>

config<span class="hljs-string">'mount'</span>
    option	target	<span class="hljs-string">'/mnt'</span>
    option	uuid	<span class="hljs-string">'af5f8523 - e705 - 4b11 - 8615 - 7c28df16aecb'</span>
    option	enabled	<span class="hljs-string">'0'</span>
</code></pre>
<ol>
<li><strong>修改 fstab 配置</strong>：对<code>/etc/config/fstab</code>文件内容进行修改，将挂载目标设为<code>/root</code>，并将<code>enabled</code>选项设为<code>1</code>，使能系统自动挂载<code>mmcblk0p8</code>到<code>/root</code>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">config<span class="hljs-string">'mount'</span>
    option	target	<span class="hljs-string">'/root'</span>
    option	uuid	<span class="hljs-string">'af5f8523 - e705 - 4b11 - 8615 - 7c28df16aecb'</span>
    option	enabled	<span class="hljs-string">'1'</span>
</code></pre>
<ol>
<li><strong>验证配置生效</strong>：重启系统后，再次执行<code>df -h</code>命令查看，确认挂载配置已生效，<code>/dev/mmcblk0p8</code>分区已正确挂载到<code>/root</code>目录，且空间大小显示正常：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       812M  608M  147M  81% /
tmpfs           512K     0  512K   0% /dev
tmpfs           987M   18M  969M   2% /tmp
cgroup          987M     0  987M   0% /sys/fs/cgroup
/dev/mmcblk0p8   23G   57M   21G   1% /root
</code></pre>
<p>通过以上步骤，我们成功地以一种简便的方式找回了 eMMC 存储中 “消失” 的空间，并使其配置在系统重启后持续生效，为系统存储资源的充分利用提供了有效解决方案。希望本文能为遇到类似问题的开发者和技术爱好者带来帮助。</p>
<p><strong>相关标签</strong>：#eMMC 存储 #系统分区 #挂载配置 #Openwrt 系统</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LeanSpec：一个轻量级的 SDD 框架]]></title>    <link>https://juejin.cn/post/7577203946063020072</link>    <guid>https://juejin.cn/post/7577203946063020072</guid>    <pubDate>2025-11-27T09:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577203946063020072" data-draft-id="7577049352839315471" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LeanSpec：一个轻量级的 SDD 框架"/> <meta itemprop="keywords" content="GitHub,架构,开源"/> <meta itemprop="datePublished" content="2025-11-27T09:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MarvinZhang"/> <meta itemprop="url" content="https://juejin.cn/user/2348212566363197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LeanSpec：一个轻量级的 SDD 框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212566363197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MarvinZhang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:39:17.000Z" title="Thu Nov 27 2025 09:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今年年初，我被 Claude Sonnet 3.7 的 AI 编程能力深深震撼。那时 "Vibe Coding" 这个词还没流行起来，但我做的正是这件事——让 AI 生成代码，我只负责引导对话。感觉像魔法一样神奇。直到问题开始浮现。</p>
<p>几周后，我注意到一些规律：代码冗余越来越多，实现方向偏离了最初的设想，AI 在不同会话之间丢失上下文导致返工不断增加。蜜月期结束了。我需要一套结构化的方法，但又不想引入那些拖慢开发速度的重型流程。</p>
<p>这段探索之旅让我先后尝试了 Kiro、Spec Kit、OpenSpec 等工具，最终促使我开发了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodervisor%2Flean-spec" target="_blank" title="https://github.com/codervisor/lean-spec" ref="nofollow noopener noreferrer">LeanSpec</a>——一个轻量级的规格驱动开发（Spec-Driven Development，SDD）框架。今天发布的 v0.2.7 版本，是三周内的第十个版本。这篇文章分享我为什么要做 LeanSpec、它有什么不同，以及如何快速上手。</p>
<h2 data-id="heading-0">Vibe Coding 的隐性成本</h2>
<p>📝 <strong>Vibe Coding 的陷阱</strong></p>
<blockquote>
<p>AI 编程助手的生产力惊人——直到它们开始出问题。缺乏结构化的上下文，AI 会生成看似合理但前后矛盾的代码，导致技术债务在每个会话中不断累积。</p>
</blockquote>
<p>如果你深度使用过 AI 编程工具，大概率遇到过这些问题：</p>






























<table><thead><tr><th>症状</th><th>根本原因</th><th>影响</th></tr></thead><tbody><tr><td><strong>代码冗余</strong></td><td>AI 不记得之前的实现</td><td>重复逻辑散落在各处</td></tr><tr><td><strong>意图偏移</strong></td><td>上下文在会话间丢失</td><td>功能与你的设想渐行渐远</td></tr><tr><td><strong>返工增多</strong></td><td>缺少持久的单一信息源</td><td>反复解释相同的背景</td></tr><tr><td><strong>架构不一致</strong></td><td>缺乏结构化指导</td><td>组件之间无法顺畅协作</td></tr></tbody></table>
<p>业界的解决方案是 <strong>规格驱动开发（Spec-Driven Development，SDD）</strong>——先写规格文档，再写代码，为 AI（和人类）提供持久的上下文。但当我考察现有工具时，发现了一个空白地带。</p>
<p>ℹ️ <strong>延伸阅读</strong></p>
<blockquote>
<p>刚接触 SDD？可以先阅读我的基础文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fspec-driven-development" target="_blank" title="https://marvinzhang.dev/zh/blog/spec-driven-development" ref="nofollow noopener noreferrer">规格驱动开发：复杂功能的系统化方法</a> 了解方法论基础，或者看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fsdd-tools-practices" target="_blank" title="https://marvinzhang.dev/zh/blog/sdd-tools-practices" ref="nofollow noopener noreferrer">2025 年 SDD 工具全景</a> 了解业界工具的全面对比。想不安装任何工具就体验方法论？试试 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lean-spec.dev%2Fdocs%2Ftutorials%2Fsdd-without-toolkit" target="_blank" title="https://www.lean-spec.dev/docs/tutorials/sdd-without-toolkit" ref="nofollow noopener noreferrer">不用工具实践 SDD</a> 教程。</p>
</blockquote>
<h2 data-id="heading-1">为什么要做 LeanSpec</h2>
<p>我在 SDD 领域的探索揭示了三类工具，每类都有不适合我的地方：</p>
<p><strong>厂商锁定</strong>：Kiro（亚马逊的 SDD IDE）集成度很高，但要求放弃现有工作流。我喜欢自己的工具组合，换 IDE 不在考虑范围内。</p>
<p><strong>认知负担过重</strong>：Spec Kit 提供了完整的结构，但其繁复的格式带来了很大的认知负担。即使有 AI 辅助撰写，理解和维护这些规格文档仍然耗费大量心智资源，对于独立开发者和小团队来说过于沉重。</p>
<p><strong>缺少项目管理</strong>：OpenSpec 最接近我理想中的样子——轻量且灵活——但缺乏跨项目管理几十个规格的能力。</p>
<p>我想要的是：<strong>一套方法论，而不只是一个工具</strong>。就像敏捷开发一样——一组人人可以采纳的原则，配合不碍事的轻量工具。</p>
<p>于是我做了 LeanSpec。然后用 LeanSpec 来开发 LeanSpec。</p>
<h2 data-id="heading-2">第一性原理：设计基石</h2>
<p>LeanSpec 不只是工具链，它建立在五条第一性原理（First Principles）之上，指导每一个设计决策：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f5be651f69463fa882f85473fbc673~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFydmluWmhhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841157&amp;x-signature=Zud9LpIYiu3frMHVyfrnyW0sItA%3D" alt="" loading="lazy"/></p>
<p><strong>上下文经济（Context Economy）</strong>：规格必须装进工作记忆——无论人还是 AI。目标 300 行以内。如果 10 分钟读不完，就太长了。</p>
<p><strong>信噪比最大化（Signal-to-Noise）</strong>：每一行都要服务于决策。没有样板文件，没有填充内容，没有为了形式的形式。</p>
<p><strong>意图优先于实现（Intent Over Implementation）</strong>：记录 <em>为什么</em>，而不只是 <em>怎么做</em>。实现细节会变，意图不会。</p>
<p><strong>弥合鸿沟（Bridge the Gap）</strong>：规格同时服务于人和 AI。任何一方看不懂，这份规格就是失败的。</p>
<p><strong>渐进披露（Progressive Disclosure）</strong>：从简单开始，只在感到痛点时才增加结构。不做预设的复杂。</p>
<p>这些原则不只是文档——LeanSpec 的 <code>validate</code> 命令会自动检查规格是否符合它们。</p>
<h2 data-id="heading-3">核心功能</h2>
<h3 data-id="heading-4">Web UI 可视化管理</h3>
<p>我最兴奋的功能：<code>lean-spec ui</code> 启动完整的 Web 界面，让你可视化地管理规格。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动 Web UI</span>
npx lean-spec ui
</code></pre>
<p>UI 提供看板视图、规格详情页（支持 Mermaid 图表渲染）和依赖关系可视化——全在浏览器里完成。适合规划会议或审查项目状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e56971740b714a3984dca3debb4ecabc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFydmluWmhhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841157&amp;x-signature=w0yLhPWCaDlyyy85Zc7tcIFpGao%3D" alt="LeanSpec 看板视图" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea45798bdc5e4ddeaa572f14f1ef9a2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFydmluWmhhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841157&amp;x-signature=HfxMM9x%2BoCc5W3wLKA0KAuvpkFc%3D" alt="LeanSpec 规格详情页" loading="lazy"/></p>
<h3 data-id="heading-5">第一性原理校验</h3>
<p>LeanSpec 不只存储规格，还会对照第一性原理进行校验：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 校验规格是否符合第一性原理</span>
lean-spec validate

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># specs/045-user-auth/README.md</span>
<span class="hljs-comment">#   ⚠️  warning  Spec exceeds 300 lines (342)  context-economy</span>
<span class="hljs-comment">#   ⚠️  warning  Missing overview section      structure</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># ✖ 2 warnings in 1 spec</span>
</code></pre>
<p>这能保持规格精简有意义，防止重型 SDD 工具常见的规格膨胀问题。</p>
<h3 data-id="heading-6">智能搜索与项目管理</h3>
<p>查找相关规格不应该需要记住精确名称：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 跨所有规格的语义搜索</span>
lean-spec search <span class="hljs-string">"authentication flow"</span>

<span class="hljs-comment"># 高级查询</span>
lean-spec search <span class="hljs-string">"status:in-progress tag:api"</span>
lean-spec search <span class="hljs-string">"created:&gt;2025-11-01"</span>
</code></pre>
<p>看板视图让项目状态一目了然：</p>
<pre><code class="hljs language-bash" lang="bash">lean-spec board

<span class="hljs-comment"># 📋 LeanSpec Board</span>
<span class="hljs-comment"># ─────────────────────────────────────</span>
<span class="hljs-comment"># 📅 Planned (12)     🚧 In Progress (3)     ✅ Complete (47)</span>
<span class="hljs-comment"># ─────────────────────────────────────</span>
</code></pre>
<h3 data-id="heading-7">MCP Server：AI 集成</h3>
<p>LeanSpec 内置 MCP（Model Context Protocol）服务器，让 AI 助手可以直接与你的规格交互：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"leanspec"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"@leanspec/mcp"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>支持 Claude Code、Cursor、GitHub Copilot 等 MCP 兼容工具。AI 代理可以搜索规格、读取上下文、更新状态——全部通过编程接口完成。</p>
<h3 data-id="heading-8">示例项目快速上手</h3>
<p>刚接触 SDD？从一个完整的示例开始：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成一个完整的教程项目</span>
npx lean-spec init --example dark-theme
</code></pre>
<p>提供三个示例：<code>dark-theme</code>、<code>dashboard-widgets</code> 和 <code>api-refactor</code>——分别演示不同的 SDD 模式。</p>
<h2 data-id="heading-9">开发历程：用 LeanSpec 开发 LeanSpec</h2>
<p>这个项目最有意思的地方在于：初版发布后，<strong>LeanSpec 完全使用 LeanSpec 自身来开发</strong>。</p>






























<table><thead><tr><th>里程碑</th><th>日期</th><th>说明</th></tr></thead><tbody><tr><td>第一行代码</td><td>2025 年 10 月 23 日</td><td>从基础的规格增删改查开始</td></tr><tr><td>v0.1.0（首次发布）</td><td>2025 年 11 月 2 日</td><td>从零到发布仅用 10 天</td></tr><tr><td>v0.2.0（生产就绪）</td><td>2025 年 11 月 10 日</td><td>第一性原理校验，完整 CLI</td></tr><tr><td>v0.2.7（当前版本）</td><td>2025 年 11 月 26 日</td><td>24 天内发布 10 个版本</td></tr></tbody></table>
<p>在 LeanSpec 项目内部，已经创建了超过 120 个规格——涵盖功能实现、架构决策、复盘反思，甚至营销策略。反馈循环非常紧凑：发现痛点 → 写规格 → 实现 → 用真实场景验证。</p>
<p>我还把 LeanSpec 应用到了其他项目：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcrawlab-team%2Fcrawlab" target="_blank" title="https://github.com/crawlab-team/crawlab" ref="nofollow noopener noreferrer">Crawlab</a>（12k+ stars）—— 网络爬虫管理平台</li>
<li>这个博客（marvinzhang.dev）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodervisor" target="_blank" title="https://github.com/codervisor" ref="nofollow noopener noreferrer">codervisor</a> 组织下即将发布的新项目</li>
</ul>
<p>在所有项目中，规律都是一致的：规格提供了跨会话存续的上下文，AI 能持续对齐我的意图，我花在反复解释上的时间大幅减少。</p>
<h2 data-id="heading-10">LeanSpec 的独特之处</h2>
<p>如果你读过我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fsdd-tools-practices" target="_blank" title="https://marvinzhang.dev/zh/blog/sdd-tools-practices" ref="nofollow noopener noreferrer">SDD 工具分析</a>，就知道我评估过这个领域的六个主要工具。LeanSpec 的定位是这样的：</p>








































<table><thead><tr><th>维度</th><th>重型工具</th><th>LeanSpec</th></tr></thead><tbody><tr><td><strong>学习曲线</strong></td><td>数天到数周</td><td>几分钟</td></tr><tr><td><strong>规格开销</strong></td><td>大量前期工作</td><td>边写边补</td></tr><tr><td><strong>Token 成本</strong></td><td>通常 &gt;2,000</td><td>目标 &lt;300 行</td></tr><tr><td><strong>灵活性</strong></td><td>结构刚性</td><td>适应你的工作流</td></tr><tr><td><strong>厂商锁定</strong></td><td>常见</td><td>不存在</td></tr><tr><td><strong>理念</strong></td><td>工具优先</td><td>方法论优先</td></tr></tbody></table>
<p>LeanSpec 的 "Lean" 有多重含义：</p>
<ul>
<li><strong>方法论</strong>：像敏捷一样，是无论工具如何都能采纳的原则</li>
<li><strong>认知负担</strong>：低开销，快速上手</li>
<li><strong>Token 经济</strong>：规格保持精简，能装进 AI 的上下文窗口</li>
<li><strong>灵活性</strong>：适应你的工作流，而不是反过来</li>
</ul>
<h2 data-id="heading-11">快速上手</h2>
<p>5 分钟内试用 LeanSpec：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装</span>
npm install -g lean-spec

<span class="hljs-comment"># 在项目中初始化</span>
lean-spec init

<span class="hljs-comment"># 创建第一个规格</span>
lean-spec create user-authentication

<span class="hljs-comment"># 启动 Web UI</span>
lean-spec ui
</code></pre>
<p>或者试试示例项目：</p>
<pre><code class="hljs language-bash" lang="bash">npx lean-spec init --example dark-theme
</code></pre>
<p><strong>已经在用 Spec Kit 或 OpenSpec？</strong> 参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lean-spec.dev%2Fdocs%2Fguide%2Fmigration" target="_blank" title="https://www.lean-spec.dev/docs/guide/migration" ref="nofollow noopener noreferrer">迁移指南</a>——迁移过程很顺畅。</p>
<h2 data-id="heading-12">未来规划</h2>
<p>LeanSpec 仍在活跃迭代中。当前开发重点包括：</p>
<ul>
<li>VS Code 插件，实现内联规格管理（<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.lean-spec.dev%2Fspecs%2F17" target="_blank" title="https://web.lean-spec.dev/specs/17" ref="nofollow noopener noreferrer">规格 17</a>）</li>
<li>AI 聊天界面，实现交互式规格辅助（<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.lean-spec.dev%2Fspecs%2F94" target="_blank" title="https://web.lean-spec.dev/specs/94" ref="nofollow noopener noreferrer">规格 94</a>）</li>
<li>全面的国际化支持（<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.lean-spec.dev%2Fspecs%2F91" target="_blank" title="https://web.lean-spec.dev/specs/91" ref="nofollow noopener noreferrer">规格 91</a>）</li>
<li>GitHub 多项目集成（<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.lean-spec.dev%2Fspecs%2F98" target="_blank" title="https://web.lean-spec.dev/specs/98" ref="nofollow noopener noreferrer">规格 98</a>）</li>
</ul>
<p>我做 LeanSpec 是为了解决自己的问题——Vibe Coding 带来的代码质量下降、AI 会话间的上下文丢失、重型 SDD 工具的认知负担。如果你也面临类似的挑战，希望它对你同样有帮助。</p>
<hr/>
<p><strong>链接：</strong></p>
<ul>
<li>📦 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodervisor%2Flean-spec" target="_blank" title="https://github.com/codervisor/lean-spec" ref="nofollow noopener noreferrer">GitHub</a></li>
<li>📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lean-spec.dev%2F" target="_blank" title="https://www.lean-spec.dev/" ref="nofollow noopener noreferrer">文档</a></li>
<li>📊 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Flean-spec" target="_blank" title="https://www.npmjs.com/package/lean-spec" ref="nofollow noopener noreferrer">npm 包</a></li>
</ul>
<p>有问题、反馈或功能建议？欢迎提 issue 或发起 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodervisor%2Flean-spec%2Fdiscussions" target="_blank" title="https://github.com/codervisor/lean-spec/discussions" ref="nofollow noopener noreferrer">讨论</a>。每一条我都会看。</p>
<hr/>
<p>📝 <strong>本文同步发布于我的个人技术博客</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fintroducing-leanspec" target="_blank" title="https://marvinzhang.dev/zh/blog/introducing-leanspec" ref="nofollow noopener noreferrer">marvinzhang.dev</a></p>
<p>🔗 <strong>完整文章链接：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarvinzhang.dev%2Fzh%2Fblog%2Fintroducing-leanspec" target="_blank" title="https://marvinzhang.dev/zh/blog/introducing-leanspec" ref="nofollow noopener noreferrer">marvinzhang.dev/zh/blog/int…</a></p>
<p>💬 <strong>欢迎访问我的博客了解更多技术文章！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Windows 环境完成 iOS 上架，跨平台发布体系的落地实践]]></title>    <link>https://juejin.cn/post/7577204540417474623</link>    <guid>https://juejin.cn/post/7577204540417474623</guid>    <pubDate>2025-11-27T09:40:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577204540417474623" data-draft-id="7577042851080994859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Windows 环境完成 iOS 上架，跨平台发布体系的落地实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T09:40:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aiopencode"/> <meta itemprop="url" content="https://juejin.cn/user/1898230261493865"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Windows 环境完成 iOS 上架，跨平台发布体系的落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1898230261493865/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aiopencode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:40:49.000Z" title="Thu Nov 27 2025 09:40:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在许多公司内部，iOS 上架常被误认为是“必须依赖 Mac 才能进行的任务”。
但随着跨端项目增多，甚至有团队完全以 Windows 为主力开发环境，“没有 Mac 可以上架吗？”成为实际工程中反复被提及的问题。
答案是肯定的：<strong>在合规和工程链路允许的前提下，iOS 上架流程完全可以在 Windows 环境中顺利完成。</strong></p>
<p>本文从实践角度复盘一个典型的 Windows 环境上架方案，重点关注：构建、签名、上传、协作、审核等环节如何在无 Mac 条件下保持稳定性和可控性。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、为什么许多团队选择在 Windows 环境完成上架？</strong></h2>
<p>Windows 在企业中的普及率极高，无论是前端团队、跨端团队、后端团队还是游戏团队，开发机大量使用 Windows 是事实。</p>
<p>在以下场景中，“Windows 上架”需求尤其突出：</p>
<ul>
<li>前端主导的 App（Hybrid、uni-app、H5）</li>
<li>小团队无预算购买 Mac</li>
<li>游戏团队使用 Unity / Cocos，编辑器本地是 Windows</li>
<li>企业 CI/CD 在 Linux / Windows 服务器运行</li>
<li>海外团队分布式协作，Mac 数量有限</li>
</ul>
<p>因此，一个可在 Windows 自然运行的上架方案，能显著降低成本并提升工程协作效率。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、在 Windows 环境上架的关键挑战</strong></h2>
<p>没有 Mac 的关键难点并非编码，而是：</p>
<ol>
<li><strong>证书生成不依赖钥匙串助手</strong></li>
<li><strong>构建无需本地 Xcode</strong></li>
<li><strong>上传 IPA 不依赖 Transporter/Xcode Organizer</strong></li>
<li><strong>团队协作与分发流程需可重复执行</strong></li>
</ol>
<p>解决以上关键点，Windows 上架自然成立。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、Windows 环境的证书与签名管理：跨平台工具链成为基础</strong></h2>
<p>传统方式：</p>
<ul>
<li>使用 Mac 的钥匙串助手生成 CSR</li>
<li>在 Apple Developer 中下载证书</li>
<li>生成 p12</li>
</ul>
<p>问题在于 Windows 无法直接处理钥匙串与 Mac 私钥格式。</p>
<p>现代解决方式依赖开心上架（Appuploader）跨平台命令行工具，可在 Windows 直接生成 iOS 证书：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04bd5df26aed4b0ea353205414290b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWlvcGVuY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841249&amp;x-signature=ikPHx6ZLjdVbQwQDzpA%2FbdPIuW0%3D" alt="证书生成" loading="lazy"/></p>
<p>优点：</p>
<ul>
<li>Windows / Linux / macOS 都能生成证书</li>
<li>团队协作不需要反复导出</li>
<li>多设备共享证书不再受限</li>
</ul>
<p>这是整个 Windows 上架体系的“第一块基石”。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、构建 IPA：不同项目类型的 Windows 解决方案</strong></h2>
<p>构建方式取决于 App 技术栈。</p>
<hr/>
<h3 data-id="heading-4"><strong>1. Web / Hybrid / uni-app 项目</strong></h3>
<p>最友好的类型。</p>
<p>因为：</p>
<ul>
<li>不需要本地 iOS 原生代码编译</li>
<li>不需要 Xcode</li>
<li>云端直接生成 ipa</li>
</ul>
<p>常见方式：</p>
<ul>
<li>HBuilderX 云打包</li>
<li>Web 项目 → 云端编译 → 得到 ipa</li>
</ul>
<p>整个过程可以完全在 Windows 执行。</p>
<hr/>
<h3 data-id="heading-5"><strong>2. Flutter / React Native 项目</strong></h3>
<p>构建仍需要 iOS 编译链，因此在 Windows 环境通常采用：</p>
<ul>
<li>GitHub Actions（macOS runner）</li>
<li>Codemagic / Appcircle</li>
<li>团队共享的云构建节点</li>
</ul>
<p>构建步骤自动化，最终从流水线下载 ipa，即可转入 Windows 端继续处理上传。</p>
<hr/>
<h3 data-id="heading-6"><strong>3. Unity / Cocos 游戏项目</strong></h3>
<p>游戏资源构建在 Windows 完成：</p>
<ul>
<li>在 Windows 生成 Xcode 工程</li>
<li>上传到云端构建（CI/CD）</li>
<li>得到 ipa</li>
</ul>
<p>这种方式在游戏团队中最常见。</p>
<hr/>
<h2 data-id="heading-7"><strong>五、Windows 环境的上传环节：真正实现跨平台的关键</strong></h2>
<p>在 Windows 上，最大突破点是 ipa 上传环节。
传统工具（Transporter、Xcode Organizer）都需要 macOS。</p>
<p>现在的工程实践是使用开心上架（Appuploader）跨平台命令行上传：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli \
  -u ios@team.com \
  -p xxx-xxx-xxx-xxx \
  -c 2 \
  -f ./build/release.ipa
</code></pre>
<p>特点：</p>
<ul>
<li>完整支持 Windows 命令行</li>
<li>无需 Xcode</li>
<li>新旧上传通道可选</li>
<li>适用于 TF 测试与正式发布</li>
<li>支持自动化集成发展到 CI/CD</li>
</ul>
<p>这意味着团队不必再为“上传”特意配置独立 Mac 环境。</p>
<p>图形化界面：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/881bd76652134b61803ca8348f3bcab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWlvcGVuY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764841249&amp;x-signature=HNvp5cfZIf%2BvRfA4S%2FO%2FisgGJtM%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8"><strong>六、上架提交：Windows 环境与 App Store Connect 的协作方式</strong></h2>
<p>上传构建后，剩余任务主要在网页端 App Store Connect 执行：</p>
<ul>
<li>配置截图（可在 Windows 制作）</li>
<li>填写描述、关键词</li>
<li>设置权限与隐私标签</li>
<li>上传预览视频（可选）</li>
<li>审核说明</li>
<li>添加测试账号（如需要）</li>
</ul>
<p>这些操作全部通过浏览器完成，不依赖系统平台。</p>
<hr/>
<h2 data-id="heading-9"><strong>七、审核阶段：与系统无关，但与流程质量强相关</strong></h2>
<p>审核本身不依赖操作系统。
真正影响审核的并不是“你用 Mac 还是 Windows”，而是：</p>
<ul>
<li>功能稳定</li>
<li>首屏加载速度</li>
<li>登录流程是否可复现</li>
<li>权限说明是否清晰</li>
<li>隐私标签是否一致</li>
<li>服务器是否能访问</li>
<li>截图是否真实</li>
<li>提交是否包含足够说明</li>
</ul>
<p>以下拒审最常见：</p>
<ul>
<li>2.1：功能不可用</li>
<li>4.2：内容不足 / 壳应用</li>
<li>5.1.1：隐私权限未说明</li>
<li>4.3：重复 App</li>
<li>3.1：支付违规</li>
</ul>
<p>这些问题与操作系统无关，与 App 质量和提交内容有关。</p>
<hr/>
<h2 data-id="heading-10"><strong>八、Windows 上架方案的优势：不是权宜，而是趋势</strong></h2>
<p>经过多项目实践，Windows 上架方案体现出几个明显优势：</p>
<hr/>
<h3 data-id="heading-11"><strong>1. 团队不再被“必须有 Mac”限制</strong></h3>
<p>前端团队、测试团队、运营团队不需要 Mac，即可独立完成上架流程。</p>
<hr/>
<h3 data-id="heading-12"><strong>2. 更适合跨国团队与多人协作</strong></h3>
<p>Windows 环境普及率高，多人可并行处理：</p>
<ul>
<li>构建触发</li>
<li>上传</li>
<li>文案准备</li>
<li>截图整理</li>
<li>审核沟通</li>
</ul>
<p>减少对“唯一一台 Mac”的依赖。</p>
<hr/>
<h3 data-id="heading-13"><strong>3. 更适合 CI/CD 自动化</strong></h3>
<p>服务器多数是 Linux 或 Windows：</p>
<ul>
<li>云构建生成 ipa</li>
<li>Windows / Linux CLI 上传</li>
<li>自动触发 TF 测试</li>
<li>自动通知团队</li>
</ul>
<p>上架流程可以高度自动化。</p>
<hr/>
<h3 data-id="heading-14"><strong>4. 成本更低，风险更低</strong></h3>
<p>不需要维护额外硬件、不需要手工上传，也无需担心 Mac 系统升级带来的兼容问题。</p>
<hr/>
<h2 data-id="heading-15"><strong>在 Windows 上进行 iOS 上架，不仅可行，而且成熟</strong></h2>
<p>通过以下组合：</p>
<ul>
<li><strong>跨系统证书管理</strong></li>
<li><strong>云构建生成 ipa</strong></li>
<li><strong>Windows/Linux 上传 ipa</strong></li>
<li><strong>浏览器完成 App Store Connect 操作</strong></li>
</ul>
<p>一个完整的 iOS 上架流程即可在 Windows 环境顺利展开。</p>
<p>这不是权宜之计，而是一种适合现代多端团队的可持续上架体系。
参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.applicationloader.net%2Ftutorial%2Fzh%2F83%2F83.html" target="_blank" title="https://www.applicationloader.net/tutorial/zh/83/83.html" ref="nofollow noopener noreferrer">www.applicationloader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fiddler抓包配置与使用教程，HTTPHTTPS抓包、代理设置与接口调试完整指南]]></title>    <link>https://juejin.cn/post/7577220965437358134</link>    <guid>https://juejin.cn/post/7577220965437358134</guid>    <pubDate>2025-11-27T09:43:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577220965437358134" data-draft-id="7577204540417540159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fiddler抓包配置与使用教程，HTTPHTTPS抓包、代理设置与接口调试完整指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T09:43:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fiddler抓包配置与使用教程，HTTPHTTPS抓包、代理设置与接口调试完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:43:51.000Z" title="Thu Nov 27 2025 09:43:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代软件开发中，无论是前端调试、移动端开发，还是接口联调与性能优化，“抓包”几乎是每位开发者绕不开的关键技能。
而在所有抓包工具中，<strong>Fiddler抓包工具</strong> 以其强大的功能和灵活的配置能力，成为业内最受欢迎的网络调试利器之一。</p>
<p>本文将以实战角度，详细介绍 <strong>Fiddler使用教程、代理配置、HTTPS抓包技巧、请求调试与常见问题分析</strong>，帮助你从入门到精通，真正掌握这款强大的网络调试工具。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、Fiddler抓包工具概览</strong></h2>
<p><strong>Fiddler</strong> 是 Telerik 公司推出的一款 HTTP/HTTPS 抓包和网络调试工具。
它通过充当系统代理服务器的方式，捕获设备发出的网络请求与响应，从而帮助开发者直观查看、修改和分析网络通信数据。</p>
<p>相较于其他工具（如 Charles、Postman、Wireshark），Fiddler 的优势体现在：</p>
<ul>
<li>免费、稳定、功能全面；</li>
<li>支持多端抓包（Web、App、小程序）；</li>
<li>可实现断点调试、请求修改、Mock 接口；</li>
<li>支持 HTTPS 解密与性能分析；</li>
<li>可自定义规则与脚本扩展。</li>
</ul>
<p>一句话总结：</p>
<blockquote>
<p>Fiddler 不只是“抓包工具”，更是一款“网络分析与接口调试平台”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1"><strong>二、Fiddler安装与配置</strong></h2>
<h3 data-id="heading-2"><strong>1. 安装与启动</strong></h3>
<p>Fiddler 的安装包体积小，安装过程简单。
安装完成后，启动软件即可自动接管系统代理。</p>
<ul>
<li>左下角显示 “Capturing” 表示正在抓包；</li>
<li>若显示 “Paused”，点击即可恢复。</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>2. Fiddler代理设置（电脑与移动端）</strong></h3>
<p>默认情况下，Fiddler 仅捕获本机请求。
若需抓取手机或其他设备的请求，则需开启远程代理。</p>
<p><strong>配置步骤如下：</strong></p>
<ol>
<li>打开菜单栏 <code>Tools → Options → Connections</code>；</li>
<li>勾选 <strong>Allow remote computers to connect</strong>；</li>
<li>记录电脑 IP 地址和端口号（默认 8888）；</li>
<li>确保手机与电脑在同一 Wi-Fi 网络；</li>
<li>在手机 Wi-Fi 设置中添加代理：
<ul>
<li>主机名：电脑 IP</li>
<li>端口号：8888</li>
</ul>
</li>
</ol>
<p>此时，Fiddler 即可捕获移动端的 HTTP 流量。</p>
<hr/>
<h3 data-id="heading-4"><strong>3. HTTPS 抓包配置</strong></h3>
<p>随着 HTTPS 普及，Fiddler 需要通过证书解密方式查看加密流量。</p>
<p><strong>配置方法如下：</strong></p>
<ul>
<li>打开 <code>Tools → Options → HTTPS</code>；</li>
<li>勾选 <strong>Decrypt HTTPS traffic</strong>；</li>
<li>点击 “Actions → Trust Root Certificate”；</li>
<li>安装并信任 Fiddler 根证书；</li>
<li>若抓取移动端 HTTPS 请求，还需导出证书并在手机信任。</li>
</ul>
<p>完成配置后，你将能查看 HTTPS 请求的完整内容，包括参数与响应。</p>
<hr/>
<h2 data-id="heading-5"><strong>三、Fiddler核心功能与使用技巧</strong></h2>
<h3 data-id="heading-6"><strong>1. 请求与响应分析</strong></h3>
<p>Fiddler 会记录系统中的所有请求，每条请求都包含：</p>
<ul>
<li>请求方式（GET、POST、PUT、DELETE）；</li>
<li>请求路径与参数；</li>
<li>请求头、Cookie 与请求体；</li>
<li>响应状态码、响应体与时间消耗。</li>
</ul>
<p>某次调试接口时，响应返回空 JSON。
通过 Fiddler 发现请求头中 <code>Content-Type</code> 缺失，导致后端未正确解析请求体。</p>
<p>短短几秒即可定位错误源。</p>
<hr/>
<h3 data-id="heading-7"><strong>2. 断点调试（Breakpoints）</strong></h3>
<p>Fiddler 可在请求发出前或响应返回前拦截数据，允许开发者修改请求或响应内容。</p>
<p><strong>应用场景：</strong></p>
<ul>
<li>模拟接口返回错误（如 500/403）；</li>
<li>修改参数测试接口容错；</li>
<li>延迟响应验证前端加载逻辑。</li>
</ul>
<p>输入命令 <code>bpu yourapi.com</code> 可对指定接口启用断点。</p>
<hr/>
<h3 data-id="heading-8"><strong>3. 模拟接口响应（AutoResponder）</strong></h3>
<p>Fiddler 的 AutoResponder 模块可用于 Mock 接口数据。</p>
<p><strong>使用步骤：</strong></p>
<ol>
<li>打开 AutoResponder 面板；</li>
<li>点击 “Add Rule” 添加匹配规则；</li>
<li>指定本地 JSON 文件或自定义返回内容；</li>
<li>启用规则后，请求将自动返回模拟响应。</li>
</ol>
<p>前端可模拟 <code>{ "code":200,"msg":"success" }</code>，无需后端即可完成调试。</p>
<hr/>
<h3 data-id="heading-9"><strong>4. 构造与重放请求（Composer）</strong></h3>
<p>Composer 模块支持自定义构造与重发请求。</p>
<p><strong>常见用途：</strong></p>
<ul>
<li>验证接口签名；</li>
<li>测试参数变化；</li>
<li>复现线上 Bug。</li>
</ul>
<p>右键历史请求 → “Replay → Reissue Request” 可快速重放。</p>
<hr/>
<h3 data-id="heading-10"><strong>5. 性能分析（Timeline）</strong></h3>
<p>Timeline 模块展示请求生命周期（DNS → TCP → TLS → Server → Download）。</p>
<p>通过时序图可分析：</p>
<ul>
<li>哪个阶段耗时最长；</li>
<li>请求延迟是否来自网络或服务器；</li>
<li>页面加载是否被资源阻塞。</li>
</ul>
<hr/>
<h2 data-id="heading-11"><strong>四、Fiddler实战案例：定位接口延迟问题</strong></h2>
<p>一次移动端接口请求经常超时。
通过 Fiddler 的 Timeline 发现 请求阶段中 <strong>TLS 握手耗时 1.2 秒</strong>，明显高于正常范围。</p>
<p>进一步排查发现，测试环境的 HTTPS 证书配置错误，导致多次握手重试。
修复证书后，接口耗时从 3.8 秒降至 1.1 秒。</p>
<hr/>
<h2 data-id="heading-12"><strong>五、Fiddler功能模块汇总</strong></h2>



































<table><thead><tr><th>模块</th><th>功能说明</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>Filters</strong></td><td>按条件过滤请求</td><td>聚焦目标接口调试</td></tr><tr><td><strong>AutoResponder</strong></td><td>模拟接口返回</td><td>前后端分离开发</td></tr><tr><td><strong>Breakpoints</strong></td><td>拦截并修改请求</td><td>测试异常与安全验证</td></tr><tr><td><strong>Composer</strong></td><td>构造与重放请求</td><td>接口测试与复现</td></tr><tr><td><strong>Timeline</strong></td><td>分析性能瓶颈</td><td>请求优化与性能评估</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13"><strong>六、Fiddler与其他工具对比</strong></h2>






























<table><thead><tr><th>工具</th><th>特点</th><th>适用人群</th></tr></thead><tbody><tr><td><strong>Fiddler</strong></td><td>免费、功能全、支持请求修改</td><td>开发 / 测试人员</td></tr><tr><td><strong>Charles</strong></td><td>界面简洁、易上手</td><td>新手用户</td></tr><tr><td><strong>Postman</strong></td><td>请求构造灵活</td><td>API 测试人员</td></tr><tr><td><strong>Wireshark</strong></td><td>底层网络分析强</td><td>安全研究者</td></tr></tbody></table>
<p>Fiddler 是开发调试阶段最实用的 HTTP/HTTPS 抓包工具之一，兼顾可视化、易用性与灵活性。</p>
<hr/>
<h2 data-id="heading-14"><strong>七、学习与资源推荐</strong></h2>
<p>想更掌握 <strong>Fiddler使用教程</strong>、<strong>代理设置</strong> 与 <strong>HTTPS 调试技巧</strong>？推荐访问 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fiddler.hk%2F" target="_blank" title="https://www.fiddler.hk/" ref="nofollow noopener noreferrer">Fiddler 中文网</a></strong></p>
<p>你将找到：</p>
<ul>
<li>Fiddler 安装与配置教程；</li>
<li>HTTPS 抓包与证书安装指南；</li>
<li>移动端代理设置；</li>
<li>Mock 数据与性能调试实例；</li>
<li>常见错误与实战解决方案。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果App上架全流程指南：从注册到审核通过，一文读懂]]></title>    <link>https://juejin.cn/post/7577220965437390902</link>    <guid>https://juejin.cn/post/7577220965437390902</guid>    <pubDate>2025-11-27T09:46:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577220965437390902" data-draft-id="7577198193215307819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果App上架全流程指南：从注册到审核通过，一文读懂"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T09:46:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果App上架全流程指南：从注册到审核通过，一文读懂
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:46:23.000Z" title="Thu Nov 27 2025 09:46:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>苹果 App 上架全流程指南：从注册到审核通过，一文读懂</p>
<p>在移动应用市场中，苹果 App Store 凭借庞大的用户基数与高付费意愿，成为开发者必争之地。但 App 上架绝非易事，从注册账号、准备资料，到提交审核、应对反馈，每一环节都暗藏挑战，稍有差池就可能被拒，耗费大量时间精力。今天，我们就梳理苹果 App 上架全流程，帮开发者顺利闯关，让优质 App 快速触达用户。</p>
<p><strong>一、前期准备：注册账号与获取资质</strong></p>
<p>（一）选择开发者账号类型</p>
<p>苹果提供个人、公司、企业三类开发者账号，功能与适用场景各异：</p>
<p>个人开发者账号：年费 99 美元，适合独立开发者。权限覆盖 App Store 上架、开发测试，无团队协作功能，应用归属个人。</p>
<p>公司开发者账号：同样年费 99 美元，适用于企业团队。需提交公司资质证明（营业执照等），支持多人协作开发，应用归属公司，利于品牌建设与市场推广。</p>
<p>企业开发者账号：年费 299 美元，主要用于企业内部应用分发，无法上架 App Store。适合大型企业定制内部办公 App，保障数据安全与应用隐私。</p>
<p>（二）注册开发者账号</p>
<p>访问苹果开发者官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2F%25EF%25BC%2589%25EF%25BC%258C%25E7%2582%25B9%25E5%2587%25BB" target="_blank" title="https://developer.apple.com/%EF%BC%89%EF%BC%8C%E7%82%B9%E5%87%BB" ref="nofollow noopener noreferrer">developer.apple.com/），点击</a> “Join the Apple Developer Program”，按提示填写个人 / 公司信息，完成注册流程。</p>
<p>若申请公司账号，需申请邓白氏码（D-U-N-S Number），这是全球通用的企业身份识别编码。申请耗时 1 - 2 周，获批后苹果会邮件通知，建议 14 个工作日后再使用，以便苹果同步数据。</p>
<p>（三）准备相关资质文件</p>
<p>隐私政策：自 2018 年 10 月起，所有新 App 及更新版本均需提供隐私政策链接，详细说明如何收集、使用、存储用户数据，保障用户知情权与隐私权。</p>
<p>版权证明：若 App 使用第三方素材（图片、音乐、代码等），需获取合法授权，备好版权文件，避免侵权纠纷导致上架受阻。</p>
<p><strong>二、技术筹备：创建 App ID、证书与描述文件</strong></p>
<p>（一）创建 App ID</p>
<p>登录开发者账号，进入 “Certificates, Identifiers &amp; Profiles” 页面。</p>
<p>点击 “Identifiers” - “App IDs”，选择 “+” 创建新 App ID。格式为 “com.company.appname”，其中 “company” 为公司缩写或自定义标识，“appname” 是 App 名称，此 ID 是 App 唯一标识，后续证书申请、应用配置都需用到。</p>
<p>（二）申请证书</p>
<p>打开 Mac 的钥匙串访问工具，依次选择 “钥匙串访问” - “证书助理” - “从证书颁发机构请求证书”，按提示填写信息，生成证书签名请求文件（.certSigningRequest）。</p>
<p>返回开发者账号 “Certificates” 页面，点击 “+”，按证书类型（开发证书用于真机调试、发布证书用于 App Store 上架、推送证书用于推送通知）上传上述文件，生成并下载对应证书。开发证书可在多台设备调试，发布证书则关联 App Store 发布。</p>
<p>（三）生成描述文件</p>
<p>描述文件关联证书与 App ID，在开发者账号 “Profiles” 页面，点击 “+” 创建。</p>
<p>按提示选择 App ID、证书，配置设备列表（开发描述文件需指定调试设备），生成并下载描述文件。</p>
<p><strong>三、App 信息配置：iTunes Connect 设置</strong></p>
<p>（一）基础信息填写</p>
<p>登录 iTunes Connect，点击 “我的 App” - “+” 创建新 App，填写 App 名称、主要语言、Bundle ID（与创建 App ID 时一致）等基础信息。</p>
<p>主标题：显示在 App Store 的本地化名称，简洁展现 App 功能特性，选取高热度相关词汇，避免竞品品牌词，利于搜索排名。</p>
<p>副标题：对 App 的简要介绍，补充主标题，控制在 30 字符内，同样避免竞品词，增强吸引力。</p>
<p>（二）隐私政策与详细描述</p>
<p>在 “App 信息” 页面，填入隐私政策网址，确保政策内容清晰、合法合规。</p>
<p>应用描述限定在 4000 字符内，详细介绍 App 特色功能。建议开篇前三行突出核心优势，吸引用户，且描述仅在版本更新时可修改。</p>
<p>（三）关键词与应用分级</p>
<p>关键词：在 “关键词” 栏填写 100 字符，尽量写满，少用逗号分隔，提升关键词覆盖度，影响 App 搜索曝光与基础排名。</p>
<p>应用分级：回答 13 个问题，依 App 实际内容与功能，确定分级（4 岁以上、9 岁以上、12 岁以上、17 岁以上、无分级），无分级无法上架销售。</p>
<p>（四）屏幕截图与图标上传</p>
<p>准备各版本屏幕截图，展示 App 核心功能与界面设计，适配不同设备尺寸。</p>
<p>上传 1024*1024 像素的图标，图标设计简洁、醒目，不得有圆角，符合苹果设计规范。若 App 支持预定，可设置相关信息，提前吸引用户关注。</p>
<p><strong>四、打包上传：Xcode 配置与提交</strong></p>
<p>（一）Xcode 项目配置</p>
<p>打开 Xcode，确保已正确导入申请的证书与描述文件。在项目设置中，选择 iOS device 真机（非模拟器）作为运行目标。</p>
<p>若 App 不支持横屏，在 “General” 选项取消 “Landscape Left” 与 “Landscape Right” 勾选；检查版本号与构建版本号，配置发布证书。确保项目无黄色叹号（代表证书、描述文件或 Bundle Identifier 匹配异常），切换至 release 发布模式（debug 用于测试）。</p>
<p>（二）打包与上传</p>
<p>选择 “Xcode” - “Product” - “Archive” 打包项目。完成后，可选择直接上传至 App Store，或导出 ipa 文件（务必选择 “Save for iOS App Store Deployment”）。</p>
<p>若导出 ipa，借助 Application Loader 工具上传。登录后，按提示选择 ipa 文件，上传至 iTunes Connect。</p>
<p>对于没有 Mac 电脑的开发者，可以使用 AppUploader 工具在 Windows、Linux 或 Mac 系统上直接上传 IPA 文件到 App Store，支持证书申请和管理，简化上架流程。</p>
<p><strong>五、提交审核：App Store Connect 操作</strong></p>
<p>（一）创建新 App 版本</p>
<p>在 App Store Connect “我的 App” 页面，选择对应 App，点击 “+” 创建新版本，填写版本号、构建版本号等信息。</p>
<p>（二）选择构建版本</p>
<p>执行 archive 操作后，生成的 ipa 会显示在构建版本列表。选择已上传的构建版本关联至新版本。</p>
<p>（三）提交审核</p>
<p>仔细核对 App 各项信息，确保准确无误。若 App 需登录使用，在后台提供测试账号（账号权限、数据完备，方便审核人员测试）。确认无误后，提交审核。</p>
<p><strong>六、审核应对：等待结果与处理反馈</strong></p>
<p>（一）审核时间预估</p>
<p>苹果审核通常需 1 - 3 个工作日，复杂应用、敏感内容或提交高峰期，审核时长可能延长至 7 个工作日甚至更久。开发者可在 App Store Connect 查看审核进度。</p>
<p>（二）常见审核不通过原因及解决</p>
<p>功能问题：如 App 崩溃、卡顿、关键功能无法使用，需全面测试修复，提交新版本审核。</p>
<p>隐私合规：未按规定获取用户权限、收集使用数据，或隐私政策不完善，需调整隐私策略，优化数据处理流程。</p>
<p>界面设计：界面布局混乱、不遵循苹果设计规范（如按钮样式、交互逻辑），重新设计界面，提升用户体验。</p>
<p>内容侵权：使用未经授权素材、存在抄袭内容，立即替换侵权素材，确保内容原创合法。</p>
<p>描述不符：App 描述、截图与实际功能不符，修改描述与截图，真实反映 App 特性。</p>
<p>每个开发者账号有两次加急审核机会，若遇紧急情况（如修复重大安全漏洞），可申请加急，加快审核进程。</p>
<p><strong>结语</strong></p>
<p>苹果 App 上架是一场精心筹备的 “闯关之旅”，从账号注册的细致规划，到技术配置的严谨操作，再到审核反馈的灵活应对，每一环节都考验开发者的耐心与专业度。但只要严格遵循苹果审核指南，打磨产品质量，精心准备上架资料，就能提升上架成功率，让 App 在 App Store 的舞台上大放异彩，收获海量用户与商业价值。若你正筹备 App 上架，不妨参考这份指南，提前布局、稳步推进，助力产品顺利上线。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>