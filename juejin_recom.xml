<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[【转载】Claude Code Swarms - Agent Teams]]></title>    <link>https://juejin.cn/post/7604715051463344143</link>    <guid>https://juejin.cn/post/7604715051463344143</guid>    <pubDate>2026-02-10T05:32:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604715051463344143" data-draft-id="7604715051463327759" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【转载】Claude Code Swarms - Agent Teams"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2026-02-10T05:32:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【转载】Claude Code Swarms - Agent Teams
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T05:32:25.000Z" title="Tue Feb 10 2026 05:32:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Faddyosmani.com%2Fblog%2Fclaude-code-agent-teams%2F" target="_blank" title="https://addyosmani.com/blog/claude-code-agent-teams/" ref="nofollow noopener noreferrer">转载</a></p>
<p><strong>Claude Code 现已支持 agent teams（群组）。</strong> 不再是单个 agent 顺序地处理任务，一个 lead agent 可以委托给多个 teammates 并行工作——进行研究、调试和构建，同时相互协调。在您的 <code>settings.json</code> 中启用 agent teams 来试试看。如果您一直在通过 Conductor、Gas Town 或类似工具进行 multi-agent orchestration 的实验，这个消息会让您兴奋不已。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12acae9d28524b60a8887e0fd2f58354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771306350&amp;x-signature=87284Q4SIItZp9xkL7QYXpbPDmE%3D" alt="" loading="lazy"/></p>
<p>社区将这些模式称为 <strong>swarms（群组）</strong>——协调的 AI agent 团队，每个都有专门的角色，通过结构化通信并行工作。从开发者在 Claude Code 二进制文件中发现 feature-flagged 功能开始，通过 subagents 和 bash 脚本构建变通方案，现在这已经是一个一等特性。TeammateTool、基于 inbox 的通信、tmux 分割窗格——所有东西都在这里了。</p>
<p>这很重要，因为它与我们大多数人一直在使用的 single-agent 模型有着根本不同的架构。如果您一直在关注从 conductor 到 orchestrator 的转变，或者试验并行 agent workflows，agent teams 就是这些想法变得具体的地方。</p>
<h2 data-id="heading-0">为什么 multi-agent coordination 很重要</h2>
<p>Single-agent 模型有一个众所周知的失败模式。您让 Claude 做一些复杂的事情——比如重构三个服务的认证——它可能在上下文退化之前完成 60%。第 2 步的细节模糊到第 5 步中。您 <code>/clear</code> 并重新开始。重复直到沮丧。</p>
<p>Swarms 背后的核心见解很简单：<strong>随着上下文的扩展，LLM 的性能会下降。</strong> 这不仅仅是关于达到 token 限制，而是上下文窗口中的信息越多，模型就越难专注于现在重要的事情。将项目经理的战略笔记添加到正在修复 CSS bug 的上下文中会损害性能。</p>
<p>人类团队以类似的方式工作。我们不让后端工程师参加前端代码审查。我们不会在每条 Slack 线程中抄送整个公司。专业化是为了专注。</p>
<p>Multi-agent patterns 将此形式化。通过给每个 agent 一个狭窄的范围和清晰的上下文，您可以在每个领域内获得更好的推理、独立的质量检查、阶段之间的自然检查点，以及当一个 agent 失败时的优雅降级。测试 agent 的上下文中有测试，而不是三小时的规划讨论。安全审查者不需要通过性能优化笔记。</p>
<p>警告是这仅在任务正确范围化时才有效。"给我构建一个应用程序"会消耗 tokens 而 agents 徒劳无功。"根据此规范实现这五个明确定义的 API 端点"会产生好的结果。</p>
<h2 data-id="heading-1">Agent teams 是什么</h2>
<p>架构很简单。一个 Claude Code 会话成为 <strong>team lead</strong>。它生成 <strong>teammates</strong>——每个都是一个完整的、独立的 Claude Code 实例，有自己的大型 token 上下文窗口。有一个共享的任务列表，具有依赖关系跟踪，一个基于 inbox 的消息传递系统用于 agent 间通信，teammates 可以在完成任务时自己认领工作。</p>

























<table><thead><tr><th>组件</th><th>角色</th></tr></thead><tbody><tr><td><strong>Team lead</strong></td><td>创建团队、生成 teammates、协调工作</td></tr><tr><td><strong>Teammates</strong></td><td>在分配的任务上工作的独立 Claude Code 实例</td></tr><tr><td><strong>Task list</strong></td><td>具有依赖关系跟踪和自动解除阻止的共享工作项</td></tr><tr><td><strong>Mailbox</strong></td><td>agent 之间的直接消息传递——不仅仅是向 lead 报告</td></tr></tbody></table>
<p>这与 Claude Code 现有的 subagents 不同。Subagents 是向单个父级报告结果的专注工作者——它们不能相互交谈。Agent teams 是真正的协作——teammates 分享发现、挑战彼此的方法并独立协调。权衡是 token 成本——每个 teammate 都是一个独立的 Claude 实例。</p>



































<table><thead><tr><th/><th>Subagents</th><th>Agent teams</th></tr></thead><tbody><tr><td><strong>上下文</strong></td><td>自己的窗口；结果返回给调用者</td><td>自己的窗口；完全独立</td></tr><tr><td><strong>通信</strong></td><td>仅向主 agent 报告</td><td>Teammates 直接相互消息传递</td></tr><tr><td><strong>协调</strong></td><td>主 agent 管理一切</td><td>具有自我协调的共享任务列表</td></tr><tr><td><strong>最适合</strong></td><td>只关注结果的专注任务</td><td>需要讨论和协作的复杂工作</td></tr><tr><td><strong>Token 成本</strong></td><td>较低</td><td>较高——每个 teammate 都是一个独立的实例</td></tr></tbody></table>
<p>当您需要快速、专注的工作者时使用 subagents。当 teammates 需要分享发现、相互挑战并独立协调时使用 agent teams。</p>
<blockquote>
<p>Claude Code 现已支持 agent teams（研究预览版）</p>
<p>不是单个 agent 顺序地处理任务，lead agent 可以委托给多个 teammates 并行工作，进行研究、调试和构建，同时相互协调。</p>
<p>今天就试试看... pic.twitter.com/vi7lUJDOTi</p>
<p>— Lydia Hallie ✨ (@lydiahallie) 2026年2月5日</p>
</blockquote>
<h2 data-id="heading-2">入门</h2>
<p>通过在设置中添加实验标志来启用 agent teams：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// settings.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后用自然语言告诉 Claude 您想要什么团队。它从那里处理生成和协调：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">我正在设计一个 <span class="hljs-built_in">CLI</span> 工具，帮助开发者在其代码库中跟踪 TODO 注释。
创建一个 agent team 从不同角度探索这个问题：一个 teammate 负责 UX，
一个负责技术架构，一个扮演唱反调的角色。
</code></pre>
<p>Claude 创建具有共享任务列表的团队，为每个角度生成 teammates，让它们探索问题，并综合发现。Lead 的终端列出了所有 teammates 及它们正在处理的工作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4b0cec381e44b90ad4f1270af49e53c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771306350&amp;x-signature=J6pcQgwSy%2FK%2BYT1h8IAJKMYZ%2Fr4%3D" alt="" loading="lazy"/></p>
<p>您也可以明确团队结构：</p>
<pre><code class="hljs">创建一个有 4 个 teammates 的团队来并行重构这些模块。
每个 teammate 使用 Opus。
</code></pre>
<h2 data-id="heading-3">在哪些方面表现出色</h2>
<p>这是一个有效的模式：<strong>并行探索真正有价值且 teammates 可以很大程度上独立操作的任务。</strong></p>
<p><strong>用于调试的竞争假设。</strong> 生成五个 teammates，每个调查一个关于为什么应用程序在一条消息后退出的不同理论。让它们相互交谈来反驳彼此的理论，就像科学辩论一样。这确实比顺序调查更好，顺序调查会受到锚定的影响——一旦您探索了一个理论，随后的调查就会偏向它。多个调查者进行对抗性辩论更快地收敛到根本原因。</p>
<p><strong>使用不同镜头的并行代码审查。</strong> 一个 teammate 负责安全影响，一个检查性能影响，一个验证测试覆盖率。单个审查者倾向于一次专注于一种类型的问题。将审查标准拆分为独立领域意味着每个领域同时得到彻底关注。</p>
<p><strong>跨层功能工作。</strong> 跨越 frontend、backend 和 tests 的变更——每个由不同的 teammate 拥有。而不是一个 agent 在层之间上下文切换，三个 agents 并行工作，完全专注于其领域。</p>
<p><strong>研究和探索。</strong> 多个 teammates 同时调查不同的方法，分享它们发现的内容，并收敛到最佳前进路径。研究发现直接流入实现上下文——没有电话游戏。</p>
<h2 data-id="heading-4">控制团队</h2>
<p>您通过 lead 的终端与 agent teams 交互。一些在实践中重要的控件：</p>
<h3 data-id="heading-5">显示模式</h3>
<p>两个选项。<strong>In-process</strong>（默认）：所有 teammates 在您的主终端内运行。使用 <code>Shift+Up/Down</code> 选择一个 teammate 并输入以直接向它们发送消息。按 <code>Enter</code> 查看 teammate 的会话，<code>Escape</code> 中断它们的回合，<code>Ctrl+T</code> 切换任务列表。适用于任何终端。</p>
<p><strong>Split panes</strong>：每个 teammate 通过 tmux 或 iTerm2 获得自己的窗格。您同时看到每个人的输出，并点击窗格直接交互。在设置中或按会话设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"teammateMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tmux"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>或为单个会话覆盖：</p>
<pre><code class="hljs language-bash" lang="bash">claude --teammate-mode in-process
</code></pre>
<h3 data-id="heading-6">计划批准</h3>
<p>对于有风险的工作，要求 teammates 在实施之前先计划。Teammate 在只读模式下工作，直到 lead 批准它们的方法：</p>
<pre><code class="hljs">生成一个架构师 teammate 来重构认证模块。
要求它们在进行任何更改之前获得计划批准。
</code></pre>
<p>如果被拒绝，它们会修改并重新提交。您可以使用标准影响 lead 的判断："仅批准包含测试覆盖的计划"或"拒绝修改数据库架构的计划"。</p>
<h3 data-id="heading-7">委托模式</h3>
<p>按 <code>Shift+Tab</code> 将 lead 限制为仅协调——生成、消息传递、关闭 teammates 和管理任务。不接触代码。这停止了一个常见问题：lead 分心并自己实现事情，而不是等待 teammates。</p>
<h3 data-id="heading-8">直接 teammate 交互</h3>
<p>每个 teammate 都是一个完整的 Claude Code 会话。您可以向其中任何一个直接发送消息以提供额外指令、提出后续问题或重定向其方法——无需通过 lead。</p>
<h3 data-id="heading-9">任务管理</h3>
<p>共享任务列表协调整个团队的工作。任务有三种状态：pending、in progress 和 completed。任务可以依赖于其他任务——具有未解决依赖关系的 pending 任务在那些依赖完成之前不能被认领。当阻止任务完成时，自动解除阻止发生。</p>
<p>Lead 可以显式分配任务，或者 teammates 可以在完成时自己认领下一个未分配、未阻止的任务。任务认领使用文件锁定来防止竞争条件。</p>
<p>Teams 和 tasks 本地存储：</p>
<pre><code class="hljs language-ruby" lang="ruby">~<span class="hljs-regexp">/.claude/teams</span><span class="hljs-regexp">/{team-name}/config</span>.json    <span class="hljs-comment"># Team metadata + members</span>
~<span class="hljs-regexp">/.claude/tasks</span><span class="hljs-regexp">/{team-name}/</span>               <span class="hljs-comment"># Task list</span>
</code></pre>
<p>Teammates 可以读取配置文件来发现其他团队成员。</p>
<h3 data-id="heading-10">关闭</h3>
<p>要求 lead 关闭特定的 teammates——它们可以批准或拒绝请求并提供解释。要清理整个团队：</p>
<pre><code class="hljs language-bash" lang="bash">/cleanup
</code></pre>
<p>始终使用 lead 进行清理。Teammates 不应该运行它，因为它们的团队上下文可能无法正确解析，可能会使资源处于不一致状态。Lead 检查活跃的 teammates，如果仍在运行则失败，因此先关闭它们。</p>
<h2 data-id="heading-11">这里有管理学的类比</h2>
<p>我不断回到这一点：使某人成为强大的工程经理的技能直接转化为有效的 agent orchestration。Agent teams 使这更加明确。</p>
<p><strong>任务大小很重要。</strong> 太小而协调开销占主导地位。太大而 teammates 工作时间太长而没有检查，冒着浪费精力的风险。最佳点是产生清晰交付成果的自包含单元。每个 teammate 有 5-6 个任务保持每个人的生产力，并让 lead 在某人被卡住时重新分配工作。</p>
<p><strong>文件所有权很重要。</strong> 两个 teammates 编辑同一个文件会导致覆盖。分解工作，使每个 teammate 拥有不同的文件集。与人类团队相同的边界设置以避免合并冲突。</p>
<p><strong>上下文加载很重要。</strong> Teammates 自动获取您项目的 <code>CLAUDE.md</code>、MCP 服务器和技能，但它们不继承 lead 的对话历史。在生成提示中包含特定于任务的详细信息：</p>
<pre><code class="hljs language-arduino" lang="arduino">生成一个安全审查者 teammate，提示为：<span class="hljs-string">"审查 src/auth/ 处的认证模块
是否存在安全漏洞。专注于令牌处理、会话管理和输入验证。
应用程序使用存储在 httpOnly cookies 中的 JWT 令牌。报告任何带有
严重性评级的问题。"</span>
</code></pre>
<p>简报越具体，输出越好。和往常一样——但现在您是为一个团队而不是单个 agent 编写简报。</p>
<h2 data-id="heading-12">需要注意什么</h2>
<p>这是实验性的。粗糙的边缘是真实的，值得了解。</p>
<p><strong>Lead 有时会实现而不是委托。</strong> 告诉它等待："在继续之前等待您的 teammates 完成他们的任务。"或使用委托模式（<code>Shift+Tab</code>）将 lead 限制为仅协调工具。</p>
<p><strong>In-process teammates 没有会话恢复。</strong> <code>/resume</code> 和 <code>/rewind</code> 不会恢复 in-process teammates。恢复后，lead 可能会尝试向不再存在的 teammates 发送消息。生成新的。</p>
<p><strong>任务状态可能滞后。</strong> Teammates 有时未能将任务标记为完成，阻止依赖任务。检查工作是否实际完成并推动 lead 或手动更新。</p>
<p><strong>每个会话一个团队，没有嵌套团队。</strong> Lead 一次管理一个团队。Teammates 不能生成自己的团队或 teammates。只有 lead 管理团队。这是故意的——防止无限递归、失控的 token 成本和失去人类监督。在开始新团队之前清理当前团队。</p>
<p><strong>Token 成本随 teammates 扩展。</strong> 每个 teammate 都是一个具有自己上下文窗口的独立 Claude 实例。对于常规任务，单个会话更具成本效益。Multi-agent patterns 在更大的、可并行的工作上得到回报——而不是修复拼写错误。</p>
<p><strong>Split panes 需要 tmux 或 iTerm2。</strong> 在 VS Code 的集成终端、Windows Terminal 或 Ghostty 中不支持。默认的 in-process 模式在任何地方都有效。</p>
<p><strong>权限从 lead 传播。</strong> 所有 teammates 从 lead 的权限设置开始。如果 lead 使用 <code>--dangerously-skip-permissions</code> 运行，所有 teammates 也是如此。您可以在生成后更改各个 teammate 模式，但不能在生成时设置每个 teammate 的模式。</p>
<p><strong>关闭可能很慢。</strong> Teammates 在关闭之前完成当前的请求或工具调用，这可能需要时间。</p>
<h2 data-id="heading-13">警告</h2>
<p>观看 agents 并行工作有一种诱人的特质。活动指标令人印象深刻——每小时提交、并行任务完成、接触的代码行数。</p>
<p>但活动并不总是转化为价值。</p>
<p>Multi-agent systems 的风险在于它们使快速生成大量代码变得容易。这些代码仍然需要正确、可维护并且真正解决问题。我看到开发者失去了情节，花更多时间配置 orchestration patterns 而不是思考他们在构建什么。</p>
<p><strong>让问题指导工具，而不是相反。</strong> 如果专注会话中的单个 agent 更快地让您到达那里，请使用它。如果您需要并行专家，请使用 agent teams。Agent teams 增加协调开销并使用明显比单个会话更多的 tokens。当 teammates 可以独立操作时，它们效果最好。对于顺序任务、同文件编辑或具有许多依赖的工作，单个会话或 subagents 更有效。</p>
<h2 data-id="heading-14">使用 Compound Engineering 最大化您的 swarms</h2>
<p>如果您想要围绕 agent teams 的更结构化的工作流，Every 的 Compound Engineering Plugin 可能值得一看。它是一个 Claude Code 插件，添加了专门的审查 agents 和 plan → work → review → compound 循环，设计围绕每个工程工作单元应该使后续单元更容易的想法。</p>
<p>直接在 Claude Code 中安装：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin marketplace add https://github.com/EveryInc/compound-engineering-plugin
/plugin install compound-engineering
</code></pre>
<p>与 agent teams 最相关的部分：<code>/workflows:plan</code> 将功能想法转化为详细的实施计划（正是使 agent 委托工作良好的那种前期规范），<code>/workflows:review</code> 在合并之前运行 multi-agent 代码审查（安全、性能、架构和复杂性——每个都有自己的专门审查者），<code>/workflows:compound</code> 记录学习，以便未来的 agents 从过去的工作中受益。</p>
<p>最后一部分是有趣的部分。插件的哲学——80% 的规划和审查，20% 的执行——清晰地映射到使 agent teams 有效的内容。您的规范越好，agent 输出越好。您将学习形式化的越多，每个后续 agent 徒劳的时间越少。这与我用 AGENTS.md 和持久上下文描述的复合动态相同，但打包成可重复的工作流。</p>
<p>如果您不专门使用 Claude Code，它也可以与 OpenCode 和 Codex 一起使用（实验性地）。</p>
<h2 data-id="heading-15">入门——我会这样做</h2>
<p>如果您是 multi-agent coordination 的新手，从小处着手。</p>
<p><strong>从研究和审查开始。</strong> 具有清晰边界且不需要编写代码的任务——从三个角度审查 PR、研究库、使用竞争理论调查 bug。这些展示了并行探索的价值，而没有并行代码更改的协调复杂性。</p>
<p><strong>然后尝试跨层功能。</strong> Frontend、backend 和 tests 各由不同的 teammate 拥有。清晰的边界、清晰的交付成果。</p>
<p><strong>然后扩展到更大的重构。</strong> 多个服务、共享设计阶段后的并行实现。这就是时间压缩变得戏剧性的地方——可能需要数天顺序工作的东西压缩成几个小时的并行执行加上审查。</p>
<p>核心技能不是写更少的代码。它是<strong>将问题分解为 agent teams 可以执行的结构</strong>——知道要构建什么、正确性意味着什么以及如何验证结果。实施越来越变成一个充分精确规范的问题。</p>
<p>这就是当 agents 实际可以协调时的 agentic engineering 的样子。协调 AI agent systems 的架构就在这里。明智地使用它。</p>
<p>完整的 Claude Code agent teams 文档有完整的设置和使用指南。</p>
<hr/>
<p><em>我在我的 Elevate newsletter 和我的 O'Reilly 书籍 Beyond Vibe Coding 中撰写关于 agentic coding workflows 的演变。如果您正在试验 agent teams 或 multi-agent workflows，我很乐意听到什么对您有效。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go 全新存储方式的map的解读]]></title>    <link>https://juejin.cn/post/7604715051463180303</link>    <guid>https://juejin.cn/post/7604715051463180303</guid>    <pubDate>2026-02-10T04:21:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604715051463180303" data-draft-id="7604779604124991488" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" go 全新存储方式的map的解读"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-10T04:21:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jzzzzz"/> <meta itemprop="url" content="https://juejin.cn/user/2631550499038236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             go 全新存储方式的map的解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2631550499038236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jzzzzz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:21:57.000Z" title="Tue Feb 10 2026 04:21:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读38分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Map</h2>
<p>在go 1.24中，对于map的存储更换了新的存储方法，使用Swiss table的方式存储数据，优化了map的操作，下面我们展开讨论map的实现，以下表述默认 64 位架构</p>
<p>首先是简介对hash冲突的解决方法，因为某个 key 应该落在哪个槽位，主要由哈希函数 hash(key) 决定。哈希函数把每个 key 映射为一个整数：同一个 key 总是映射到同一个整数；所以会存在hash冲突问题，下面我们简单介绍开放寻址哈希表方法。</p>
<h3 data-id="heading-1">开放寻址哈希表</h3>
<p>在<strong>开放寻址哈希表</strong>中，所有条目都存放在同一个底层数组中。数组中的每个位置称为一个 slot（槽位）。不同 key 理想情况下应当遵循均匀随机的整数分布。开放寻址哈希表的定义性特征在于：它通过把 key 存到数组中的其他位置来解决碰撞。因此，如果目标 slot 已经满了（发生碰撞），就使用探测序列（probe sequence）去尝试其他 slot，直到找到一个空 slot。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e61baa87f3949b1823ccc0c0541ffeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=b0jPx6j42jo1Ix4A3wKk%2Fho2yxQ%3D" alt="xz.png" loading="lazy"/></p>
<h3 data-id="heading-2">swiss table</h3>
<p>Swiss Table 同样是开放寻址哈希表的一种形式。仍然使用单一底层数组进行存储，但会把数组按逻辑划分为每组 8 个 slot 的 group（组）。此外，每个 group 还有一个 64 位控制字（control word）作为元数据。控制字的 8 个字节分别对应该 group 的 8 个 slot。每个字节的值表示对应 slot 是空、已删除，还是正在使用。如果正在使用，该字节还包含该 slot 的 key 的哈希值低 7 位（称为 h2）。例如：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3db2fae49f504896a931d21238cd2344~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=5VQWYWTbinI001XD5alSVVr52JY%3D" alt="example.png" loading="lazy"/></p>
<p>在Swiss Tables中会对hash(key)得到的值，并把哈希拆成两部分，分别为<strong>h1(高 57 位)和h2(低 7 位)</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/257d9f9fcdfe4cda86f202c92d8865fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=xq%2B1Efh%2BglzK9fZOkDu9TcS0r3o%3D" alt="key.png" loading="lazy"/></p>
<p>在插入操作中：</p>
<ol>
<li>hash(key)计算拆分得到h1和h2</li>
<li>根据h1计算首先需要查询的group， h1 % group的数量</li>
<li>在group内，判断slot是否可以插入or包含key（此时为更新操作）</li>
<li>如果没有slot包含key，则寻找empty 插入key</li>
<li>如果没empty，则沿探测序列继续搜索下一个 group</li>
</ol>
<p>在第三步就是swiss table做的优化，一个 group有8个slot，正常是线性扫描并比较 8 个 key，但存在控制字可以进行快速比较，通过比较控制字中的每个字节为我们的h2,得到候选（一次比较同一 group 的 8 个 slot 控制字节，从而优化）</p>
<p>例如查找 key 36，并且 h2 = 23：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b31468f07343c4af5f0e0d92743cfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=xGzN73XEQLfw0r9uWaBTjq61kqM%3D" alt="compare.png" loading="lazy"/></p>
<h3 data-id="heading-3">map的基本使用</h3>
<h4 data-id="heading-4">创建map</h4>
<p>有两种创建方式分别是带容量和不带容量的创建：</p>
<pre><code class="hljs language-go" lang="go">m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>, <span class="hljs-built_in">cap</span>)

m2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)
</code></pre>
<h4 data-id="heading-5">map写入数据</h4>
<pre><code class="hljs language-go" lang="go">m[key] = val
</code></pre>
<h4 data-id="heading-6">map读取数据</h4>
<ol>
<li>第一种方式如果key不存在返回0值，存在返回对应val</li>
<li>第二种方式可以根据返回的bool值判断是否真的取到值</li>
</ol>
<pre><code class="hljs language-go" lang="go">v1 := m[key]
v2, ok := m[key]
</code></pre>
<h4 data-id="heading-7">map删除数据</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-built_in">delete</span>(m, key)
</code></pre>
<h3 data-id="heading-8">map数据结构</h3>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/207978eb6dc04d11ad7e33bd9dfe7a9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=LxSLDiHKHVG5kOdGjDk%2BYE7MqSw%3D" alt="map-structure.png" width="70%" loading="lazy"/>
<p><strong>internal/runtime/maps/map.go</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Map <span class="hljs-keyword">struct</span> {
	used <span class="hljs-type">uint64</span>
	seed <span class="hljs-type">uintptr</span>
	dirPtr unsafe.Pointer
	dirLen <span class="hljs-type">int</span> <span class="hljs-comment">//*[dirLen]*table</span>
	globalDepth <span class="hljs-type">uint8</span>
	globalShift <span class="hljs-type">uint8</span>
	writing <span class="hljs-type">uint8</span>
	clearSeq <span class="hljs-type">uint64</span>
}
</code></pre>
<ol>
<li>used 已经填充的slot的数量（所有table中的元素的总数）</li>
<li>seed 用于hash计算使用</li>
<li>dirPtr 通常情况下，dirPtr 指向一个由 table 指针组成的数组，如果map中元素数量不超过 8 此时 dirPtr 直接指向一个单独的 group</li>
<li>globalDepth 在table目录查找时要使用的比特数</li>
<li>globalShift 在进行目录查找时，需要从哈希值中右移掉的比特数</li>
<li>writing 是一个标志位：当 map 正在被写入时，会通过异或 1（XOR 1）的方式翻转。</li>
<li>clearSeq 是对 Clear 调用次数的序列计数器，用于在迭代期间检测 map 是否被清空。</li>
</ol>
<p><strong>internal/runtime/maps/table.go</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> table <span class="hljs-keyword">struct</span> {
	used <span class="hljs-type">uint16</span>
	capacity <span class="hljs-type">uint16</span>
	growthLeft <span class="hljs-type">uint16</span>
	localDepth <span class="hljs-type">uint8</span>
	index <span class="hljs-type">int</span>
	groups groupsReference
}
</code></pre>
<ol>
<li>used 该table已填充的的元素（slot）数量</li>
<li>capacity 该table的容量，slot的上限</li>
<li>growthLeft 在无需rehash的情况下，还能继续填充的 slot 数量。（used + tombstones &gt; loadFactor*capacity 时会触发 rehash）</li>
<li>localDepth 在该 table 之上，用于目录查找（directory lookups）的比特数。（如果目录扩容但该table未拆分可能会小于m.globalDepth）</li>
<li>index 该 table 在 Map 目录中的索引。这是目录中该 table 出现的“第一个”位置的索引。同一个 table 可能会在目录中连续出现多个索引位置。如果index为-1则已过期不再使用</li>
<li>groups  table 自己持有的一个 group 数组</li>
</ol>
<p><strong>internal/runtime/maps/group.go</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> groupsReference <span class="hljs-keyword">struct</span> {
	data unsafe.Pointer <span class="hljs-comment">// data *[length]typ.Group</span>
	lengthMask <span class="hljs-type">uint64</span>
}
</code></pre>
<ol>
<li>data 指向一个 group 数组</li>
<li>lengthMask 等于 data 中 group 的数量减一，方便按位</li>
</ol>
<p><strong>internal/rutime/maps/group.go</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> groupReference <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">// data points to the group, which is described by typ.Group and has</span>
	<span class="hljs-comment">// layout:</span>
	<span class="hljs-comment">// group由 abi.SwissMapGroupSlots（8）个 slot 加上一个控制字组成的一组。</span>
	<span class="hljs-comment">// type group struct {</span>
	<span class="hljs-comment">// 	ctrls ctrlGroup // 控制字节组，每个 slot 1 个控制字节，控制字节最高位区分空/删除/占用；占用时其余 7 位存 H2（hash(key)的低7位）。</span>
	<span class="hljs-comment">// 	slots [abi.SwissMapGroupSlots]slot</span>
	<span class="hljs-comment">// }</span>
	<span class="hljs-comment">//</span>
	<span class="hljs-comment">// type slot struct {</span>
	<span class="hljs-comment">// 	key  typ.Key </span>
	<span class="hljs-comment">// 	elem typ.Elem</span>
	<span class="hljs-comment">// }</span>
	data unsafe.Pointer <span class="hljs-comment">// data *typ.Group</span>
}
</code></pre>
<p>用来表示存放在 data 中的单个 slot group, 一个group包含 abi.SwissMapGroupSlots （8）个 slot（key/elem 对），以及它们的控制字。</p>
<h3 data-id="heading-9">创建map</h3>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04dce541bf5e4feea0b97e255e149568~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=Yn9bJ3DKKC4BIMwTxjyOv1O%2B6So%3D" alt="newmap.png" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMap</span><span class="hljs-params">(mt *abi.SwissMapType, hint <span class="hljs-type">uintptr</span>, m *Map, maxAlloc <span class="hljs-type">uintptr</span>)</span></span> *Map {
	<span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> {
		m = <span class="hljs-built_in">new</span>(Map)
	}
	m.seed = <span class="hljs-type">uintptr</span>(rand())
	<span class="hljs-keyword">if</span> hint &lt;= abi.SwissMapGroupSlots {
		<span class="hljs-keyword">return</span> m
	}
	targetCapacity := (hint * abi.SwissMapGroupSlots) / maxAvgGroupLoad
	<span class="hljs-keyword">if</span> targetCapacity &lt; hint { 
		<span class="hljs-keyword">return</span> m <span class="hljs-comment">// return an empty map.</span>
	}
	dirSize := (<span class="hljs-type">uint64</span>(targetCapacity) + maxTableCapacity - <span class="hljs-number">1</span>) / maxTableCapacity
	dirSize, overflow := alignUpPow2(dirSize)
	<span class="hljs-keyword">if</span> overflow || dirSize &gt; <span class="hljs-type">uint64</span>(math.MaxUintptr) {
		<span class="hljs-keyword">return</span> m <span class="hljs-comment">// return an empty map.</span>
	}
	groups, overflow := math.MulUintptr(<span class="hljs-type">uintptr</span>(dirSize), maxTableCapacity)
	<span class="hljs-keyword">if</span> overflow {
		<span class="hljs-keyword">return</span> m <span class="hljs-comment">// return an empty map.</span>
	} <span class="hljs-keyword">else</span> {
		mem, overflow := math.MulUintptr(groups, mt.GroupSize)
		<span class="hljs-keyword">if</span> overflow || mem &gt; maxAlloc {
			<span class="hljs-keyword">return</span> m <span class="hljs-comment">// return an empty map.</span>
		}
	}
	m.globalDepth = <span class="hljs-type">uint8</span>(sys.TrailingZeros64(dirSize))
	m.globalShift = depthToShift(m.globalDepth)
	directory := <span class="hljs-built_in">make</span>([]*table, dirSize)
	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> directory {
		
		directory[i] = newTable(mt, <span class="hljs-type">uint64</span>(targetCapacity)/dirSize, i, m.globalDepth)
	}
	m.dirPtr = unsafe.Pointer(&amp;directory[<span class="hljs-number">0</span>])
	m.dirLen = <span class="hljs-built_in">len</span>(directory)
	<span class="hljs-keyword">return</span> m
}
</code></pre>
<p>该方法有四个参数，mt *abi.SwissMapType：map 的类型元数据，hint uintptr：来自 make(map[K]V, hint) 的期望容量，m *Map：可复用/预分配的 Map 头部指针；maxAlloc uintptr：本次分配允许的最大内存上限；</p>
<p>由于代码过长且判断条件较多所以就划分讲解：</p>
<p><strong>step1:</strong></p>
<ol>
<li>编译器判断 map 逃逸，就不在栈上预分配，直接传 nil，NewMap 会 new(Map)，且因为指针要返回给调用方，这个 Map 会逃逸，实际分配在堆上。</li>
<li>编译器判断 map 不逃逸，就在调用方栈上放一个临时 Map 头部，并把它的地址传给 NewMap 复用。</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMap</span><span class="hljs-params">(mt *abi.SwissMapType, hint <span class="hljs-type">uintptr</span>, m *Map, maxAlloc <span class="hljs-type">uintptr</span>)</span></span> *Map {
	<span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> {
		m = <span class="hljs-built_in">new</span>(Map)
	}
	<span class="hljs-comment">//..</span>
	<span class="hljs-keyword">return</span> m
}
</code></pre>
<p><strong>step2:</strong>
对m的seed赋值，并根据hint大小：判断当hint &lt;= abi.SwissMapGroupSlots(=8) ，此时一个group即可满足，函数直接返回不分配;在对map首次写入时会分配一个 8-slot group</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMap</span><span class="hljs-params">(mt *abi.SwissMapType, hint <span class="hljs-type">uintptr</span>, m *Map, maxAlloc <span class="hljs-type">uintptr</span>)</span></span> *Map {
	<span class="hljs-comment">//..</span>
	m.seed = <span class="hljs-type">uintptr</span>(rand())
	<span class="hljs-keyword">if</span> hint &lt;= abi.SwissMapGroupSlots {
		<span class="hljs-keyword">return</span> m
	}
	<span class="hljs-comment">//..</span>
}
</code></pre>
<p><strong>step3:</strong>
计算 targetCapacity = hint * slotsPerGroup / maxAvgGroupLoad，等价于 hint / 负载因子(7/8)，防止刚创建后就触发扩容，如果计算分配的预期容量溢出转为则直接返回空map。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMap</span><span class="hljs-params">(mt *abi.SwissMapType, hint <span class="hljs-type">uintptr</span>, m *Map, maxAlloc <span class="hljs-type">uintptr</span>)</span></span> *Map {
	<span class="hljs-comment">//..</span>
	targetCapacity := (hint * abi.SwissMapGroupSlots) / maxAvgGroupLoad
	<span class="hljs-keyword">if</span> targetCapacity &lt; hint { <span class="hljs-comment">// overflow</span>
		<span class="hljs-keyword">return</span> m <span class="hljs-comment">// return an empty map.</span>
	}
	<span class="hljs-comment">//..</span>
}
</code></pre>
<p><strong>step4:</strong>
计算 table 个数dirSize = ceil(targetCapacity / maxTableCapacity) ，随后向上取整到 2 的幂；溢出则返回空 map</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMap</span><span class="hljs-params">(mt *abi.SwissMapType, hint <span class="hljs-type">uintptr</span>, m *Map, maxAlloc <span class="hljs-type">uintptr</span>)</span></span> *Map {
	<span class="hljs-comment">//..</span>
	dirSize := (<span class="hljs-type">uint64</span>(targetCapacity) + maxTableCapacity - <span class="hljs-number">1</span>) / maxTableCapacity
	dirSize, overflow := alignUpPow2(dirSize)
	<span class="hljs-keyword">if</span> overflow || dirSize &gt; <span class="hljs-type">uint64</span>(math.MaxUintptr) {
		<span class="hljs-keyword">return</span> m <span class="hljs-comment">// return an empty map.</span>
	}
	<span class="hljs-comment">//..</span>
}
</code></pre>
<p><strong>step5:</strong>
进行过大 hint 的内存上限检查：用 dirSize*maxTableCapacity 得到总 groups 上界，再乘 mt.GroupSize 得到内存上界；任一处溢出或超 maxAlloc 则返回</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMap</span><span class="hljs-params">(mt *abi.SwissMapType, hint <span class="hljs-type">uintptr</span>, m *Map, maxAlloc <span class="hljs-type">uintptr</span>)</span></span> *Map {
	<span class="hljs-comment">//..</span>
	groups, overflow := math.MulUintptr(<span class="hljs-type">uintptr</span>(dirSize), maxTableCapacity)
	<span class="hljs-keyword">if</span> overflow {
		<span class="hljs-keyword">return</span> m <span class="hljs-comment">// return an empty map.</span>
	} <span class="hljs-keyword">else</span> {
		mem, overflow := math.MulUintptr(groups, mt.GroupSize)
		<span class="hljs-keyword">if</span> overflow || mem &gt; maxAlloc {
			<span class="hljs-keyword">return</span> m <span class="hljs-comment">// return an empty map.</span>
		}
	}
	<span class="hljs-comment">//..</span>
}
</code></pre>
<pre><code class="hljs language-go" lang="go">计算目录需要用的位数，以及取出这 globalDepth 位，哈希值需要右移多少位。然后创建table（容量为预期容量 / table个数）并分配目录数组，记录目录长度，初始化完成返回
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMap</span><span class="hljs-params">(mt *abi.SwissMapType, hint <span class="hljs-type">uintptr</span>, m *Map, maxAlloc <span class="hljs-type">uintptr</span>)</span></span> *Map {
	<span class="hljs-comment">//..</span>
	m.globalDepth = <span class="hljs-type">uint8</span>(sys.TrailingZeros64(dirSize))
	m.globalShift = depthToShift(m.globalDepth)
	directory := <span class="hljs-built_in">make</span>([]*table, dirSize)
	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> directory {
		directory[i] = newTable(mt, <span class="hljs-type">uint64</span>(targetCapacity)/dirSize, i, m.globalDepth)
	}
	m.dirPtr = unsafe.Pointer(&amp;directory[<span class="hljs-number">0</span>])
	m.dirLen = <span class="hljs-built_in">len</span>(directory)
	<span class="hljs-keyword">return</span> m
}
</code></pre>
<p>接下来看上面调用到的创建table的方法newTable()</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af3cdce427c14f1c83cf1b29e782a4b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=VHoFmXMrCxeEn1i5qwohsS9fHqQ%3D" alt="newtable.png" width="50%" loading="lazy"/></p>
<p><strong>internal/rutime/maps/table.go  newTable()</strong></p>
<ol>
<li>首先根据capacity大小进行兜底，避免不够一个group的slot容量，然后对table赋值</li>
<li>如果capacity &gt; maxTableCapacity（1024）则panic</li>
<li>然后将capacity对齐到 2 的幂，如果对齐后溢出panic</li>
<li>调用reset 方法会按容量分配 groups 数组、设置 capacity/ growthLeft，并把 control 字节初始化为 empty。</li>
<li>返回创建好的table</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newTable</span><span class="hljs-params">(typ *abi.SwissMapType, capacity <span class="hljs-type">uint64</span>, index <span class="hljs-type">int</span>, localDepth <span class="hljs-type">uint8</span>)</span></span> *table {
	<span class="hljs-keyword">if</span> capacity &lt; abi.SwissMapGroupSlots {
		capacity = abi.SwissMapGroupSlots
	}
	t := &amp;table{
		index:      index,
		localDepth: localDepth,
	}

	<span class="hljs-keyword">if</span> capacity &gt; maxTableCapacity {
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">"initial table capacity too large"</span>)
	}
	capacity, overflow := alignUpPow2(capacity)
	<span class="hljs-keyword">if</span> overflow {
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">"rounded-up capacity overflows uint64"</span>)
	}

	t.reset(typ, <span class="hljs-type">uint16</span>(capacity))
	<span class="hljs-keyword">return</span> t
}
</code></pre>
<p>对table分配group数组</p>
<p><strong>table.reset()</strong></p>
<ol>
<li>根据capacity计算出groupCount</li>
<li>newGroups(typ, groupCount)创建了一个groupsReference分配一段连续的 group 数组并返回，对table赋值</li>
<li>然后调用resetGrowthLeft计算growthLeft</li>
<li>最后清空整张groups表的 control 字节</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *table)</span></span> reset(typ *abi.SwissMapType, capacity <span class="hljs-type">uint16</span>) {
	groupCount := <span class="hljs-type">uint64</span>(capacity) / abi.SwissMapGroupSlots
	t.groups = newGroups(typ, groupCount)
	t.capacity = capacity
	t.resetGrowthLeft()

	<span class="hljs-keyword">for</span> i := <span class="hljs-type">uint64</span>(<span class="hljs-number">0</span>); i &lt;= t.groups.lengthMask; i++ {
		g := t.groups.group(typ, i) <span class="hljs-comment">//根据index返回对应的group</span>
		g.ctrls().setEmpty()
	}
}
</code></pre>
<p>该方法根据capacity计算当前table不扩容情况下还可以放多少数据</p>
<p><strong>table.resetGrowthLeft()</strong></p>
<ol>
<li>如果 capacity 为0则直接panic，一个table必须有一个有效的容量</li>
<li>根据 capacity 计算出growthLeft，对于单 group 表需要至少留 1 个空槽来保证探测终止</li>
<li>对于多个 group 负载因子是 maxAvgGroupLoad / SwissMapGroupSlots（7/8），先做溢出检查：t.capacity*maxAvgGroupLoad 如果溢出会panic。最终可用槽数 = capacity * 7 / 8。</li>
<li>返回</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *table)</span></span> resetGrowthLeft() {
	<span class="hljs-keyword">var</span> growthLeft <span class="hljs-type">uint16</span>
	<span class="hljs-keyword">if</span> t.capacity == <span class="hljs-number">0</span> {
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">"table must have positive capacity"</span>)
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> t.capacity &lt;= abi.SwissMapGroupSlots {
		growthLeft = t.capacity - <span class="hljs-number">1</span>
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">if</span> t.capacity*maxAvgGroupLoad &lt; t.capacity {
			<span class="hljs-built_in">panic</span>(<span class="hljs-string">"overflow"</span>)
		}
		growthLeft = (t.capacity * maxAvgGroupLoad) / abi.SwissMapGroupSlots
	}
	t.growthLeft = growthLeft
}
</code></pre>
<p>分配一段连续的 group 数组加初始化lengthMask方便快速查找</p>
<p><strong>newGroups()</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newGroups</span><span class="hljs-params">(typ *abi.SwissMapType, length <span class="hljs-type">uint64</span>)</span></span> groupsReference {
	<span class="hljs-keyword">return</span> groupsReference{
		data:       newarray(typ.Group, <span class="hljs-type">int</span>(length)),
		lengthMask: length - <span class="hljs-number">1</span>,
	}
}
</code></pre>
<h3 data-id="heading-10">map中读数据</h3>
<p>在internal/runtime/maps/runtime_swiss.go中可以查看实现方法</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5024a84b8c7482c8eb3be04b6b607f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=c8PQuuvf%2FaIyRnCRnvuAnbZqmgc%3D" alt="readmap.png" width="70%" loading="lazy"/></p>
**runtime\_mapaccess1()**
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runtime_mapaccess1</span><span class="hljs-params">(typ *abi.SwissMapType, m *Map, key unsafe.Pointer)</span></span> unsafe.Pointer {
	<span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> || m.Used() == <span class="hljs-number">0</span> {
		<span class="hljs-keyword">if</span> err := mapKeyError(typ, key); err != <span class="hljs-literal">nil</span> {
			<span class="hljs-built_in">panic</span>(err) <span class="hljs-comment">// see issue 23734</span>
		}
		<span class="hljs-keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="hljs-number">0</span>])
	}

	<span class="hljs-keyword">if</span> m.writing != <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map read and map write"</span>)
	}

	hash := typ.Hasher(key, m.seed)

	<span class="hljs-keyword">if</span> m.dirLen &lt;= <span class="hljs-number">0</span> {
		_, elem, ok := m.getWithKeySmall(typ, hash, key)
		<span class="hljs-keyword">if</span> !ok {
			<span class="hljs-keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="hljs-number">0</span>])
		}
		<span class="hljs-keyword">return</span> elem
	}

	<span class="hljs-comment">// Select table.</span>
	idx := m.directoryIndex(hash)
	t := m.directoryAt(idx)

	<span class="hljs-comment">// Probe table.</span>
	seq := makeProbeSeq(h1(hash), t.groups.lengthMask)
	<span class="hljs-keyword">for</span> ; ; seq = seq.next() {
		g := t.groups.group(typ, seq.offset)

		match := g.ctrls().matchH2(h2(hash))

		<span class="hljs-keyword">for</span> match != <span class="hljs-number">0</span> {
			i := match.first()

			slotKey := g.key(typ, i)
			slotKeyOrig := slotKey
			<span class="hljs-keyword">if</span> typ.IndirectKey() {
				slotKey = *((*unsafe.Pointer)(slotKey))
			}
			<span class="hljs-keyword">if</span> typ.Key.Equal(key, slotKey) {
				slotElem := unsafe.Pointer(<span class="hljs-type">uintptr</span>(slotKeyOrig) + typ.ElemOff)
				<span class="hljs-keyword">if</span> typ.IndirectElem() {
					slotElem = *((*unsafe.Pointer)(slotElem))
				}
				<span class="hljs-keyword">return</span> slotElem
			}
			match = match.removeFirst()
		}

		match = g.ctrls().matchEmpty()
		<span class="hljs-keyword">if</span> match != <span class="hljs-number">0</span> {
			<span class="hljs-comment">// Finding an empty slot means we've reached the end of</span>
			<span class="hljs-comment">// the probe sequence.</span>
			<span class="hljs-keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="hljs-number">0</span>])
		}
	}
}
</code></pre>
<p><strong>step1:</strong></p>
<p>如果map为nil，或者map中无已填充的数据，首先对key的合法性进行判断，如果key不合法则直接panic，否则返回一个零值；</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> || m.Used() == <span class="hljs-number">0</span> {
		<span class="hljs-keyword">if</span> err := mapKeyError(typ, key); err != <span class="hljs-literal">nil</span> {
			<span class="hljs-built_in">panic</span>(err) <span class="hljs-comment">// see issue 23734</span>
		}
		<span class="hljs-keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="hljs-number">0</span>])
	}
</code></pre>
<p><strong>step2：</strong></p>
<p>此时存在其他goroutine在写该map，则直接fatal</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> m.writing != <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map read and map write"</span>)
	}
</code></pre>
<p><strong>step3：</strong></p>
<p>使用typ类型对应的hasher函数得到key对应的hash，如果m.dirLen &lt;= 0说明是一个小map
则调用getWithKeySmall方法取值并返回，若没取到返回零值</p>
<pre><code class="hljs language-go" lang="go">hash := typ.Hasher(key, m.seed)
	<span class="hljs-keyword">if</span> m.dirLen &lt;= <span class="hljs-number">0</span> {
		_, elem, ok := m.getWithKeySmall(typ, hash, key)
		<span class="hljs-keyword">if</span> !ok {
			<span class="hljs-keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="hljs-number">0</span>])
		}
		<span class="hljs-keyword">return</span> elem
	}
</code></pre>
<p><strong>step4：</strong></p>
<ol>
<li>根据hash值右移globalShift获取到table的index，然后根据index取出对应的table指针</li>
<li>根据h1(hash)和group的lengthMask计算出，起始 offset 和步进序列</li>
<li>然后根据取出seq，开启for循环，每次seq.next()会给出下一个要探测的 group 位置。</li>
<li>在for循环内部，根据h2(hash)与控制字匹配，得到位图（哪些 slot 的 h2 匹配）例如：mask = 0b00001001</li>
<li>当match大于0，开启第二个for遍历，按位图逐个取，mask.first() 取最低位的 1，如果key存的是指向key的指针才解指针</li>
<li>如果typ.Key.Equal(key, slotKey)成立，则取出对应槽位的elem，并且如果elem存的是指向elem的指针才解指针，最后返回</li>
<li>如果没配对则从match中 mask.removeFirst()把最低位的 1 清掉，继续遍历直到取出或，match为空</li>
<li>如果第二个for循环没取出值，且当前组有emptyslot，说明探测序列结束，直接返回零值。</li>
<li>否则继续执行第一个for循环取出根据步进序列得出要探测的 group 位置继续执行 4 - 8操作</li>
</ol>
<pre><code class="hljs language-go" lang="go">	idx := m.directoryIndex(hash)
	t := m.directoryAt(idx)

	seq := makeProbeSeq(h1(hash), t.groups.lengthMask)
	<span class="hljs-keyword">for</span> ; ; seq = seq.next() {
		g := t.groups.group(typ, seq.offset)

		match := g.ctrls().matchH2(h2(hash))

		<span class="hljs-keyword">for</span> match != <span class="hljs-number">0</span> {
			i := match.first()

			slotKey := g.key(typ, i)
			slotKeyOrig := slotKey
			<span class="hljs-keyword">if</span> typ.IndirectKey() {
				slotKey = *((*unsafe.Pointer)(slotKey))
			}
			<span class="hljs-keyword">if</span> typ.Key.Equal(key, slotKey) {
				slotElem := unsafe.Pointer(<span class="hljs-type">uintptr</span>(slotKeyOrig) + typ.ElemOff)
				<span class="hljs-keyword">if</span> typ.IndirectElem() {
					slotElem = *((*unsafe.Pointer)(slotElem))
				}
				<span class="hljs-keyword">return</span> slotElem
			}
			match = match.removeFirst()
		}

		match = g.ctrls().matchEmpty()
		<span class="hljs-keyword">if</span> match != <span class="hljs-number">0</span> {
			<span class="hljs-keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="hljs-number">0</span>])
		}
	}
</code></pre>
<p>接下来看一下里面用到的方法的实现首先是getWithKeySmall,该方法用于<strong>小map的key取对应的elem</strong></p>
<p><strong>Map.getWithKeySmall()</strong></p>
<p>首先根据m.dirptr封装了一个group，前面也提到小map无table只有一个group</p>
<ol>
<li>取出h2(hash)和group的控制字</li>
<li>开启for循环遍历（结束条件：1.i == SwissMapGroupSlots；2.找到key对应elem返回），先取低8位的第一个字节的控制位，然后将ctrls右移8位</li>
<li>如果取出的控制位!=h2则继续循环取下一个控制位</li>
<li>如果控制位==h2，首先取出index 偏移量对应的slot key，并且当存放的key为指向key指针时解指针</li>
<li>接着判断slot key 是否等于 key，如果等于取出index 偏移量对应的slot Elem，并且当存放的Elem为指向Elem指针时解指针，返回值结束；否则继续for循环直到取出</li>
<li>如果到最后还没有找到配对的就直接return false</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> getWithKeySmall(typ *abi.SwissMapType, hash <span class="hljs-type">uintptr</span>, key unsafe.Pointer) (unsafe.Pointer, unsafe.Pointer, <span class="hljs-type">bool</span>) {
	g := groupReference{
		data: m.dirPtr,
	}
	h2 := <span class="hljs-type">uint8</span>(h2(hash))
	ctrls := *g.ctrls()
	<span class="hljs-keyword">for</span> i := <span class="hljs-type">uintptr</span>(<span class="hljs-number">0</span>); i &lt; abi.SwissMapGroupSlots; i++ {
		c := <span class="hljs-type">uint8</span>(ctrls)
		ctrls &gt;&gt;= <span class="hljs-number">8</span>
		<span class="hljs-keyword">if</span> c != h2 {
			<span class="hljs-keyword">continue</span>
		}

		slotKey := g.key(typ, i)
		<span class="hljs-keyword">if</span> typ.IndirectKey() {
			slotKey = *((*unsafe.Pointer)(slotKey))
		}

		<span class="hljs-keyword">if</span> typ.Key.Equal(key, slotKey) {
			slotElem := g.elem(typ, i)
			<span class="hljs-keyword">if</span> typ.IndirectElem() {
				slotElem = *((*unsafe.Pointer)(slotElem))
			}
			<span class="hljs-keyword">return</span> slotKey, slotElem, <span class="hljs-literal">true</span>
		}
	}
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>
}
</code></pre>
<p>然后是取table的操作，此时不是小map
<strong>Map.directoryIndex 和 Map.directoryAt</strong></p>
<p>directoryIndex负责计算table的index，directoryA负责取出对应的table的指针
directoryIndex，如果dirLen == 1说明只有一个table直接返回0，否则将hash右移globalShift位返回
directoryAt根据传进来的index计算出table的指针地址，返回</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> directoryIndex(hash <span class="hljs-type">uintptr</span>) <span class="hljs-type">uintptr</span> {
	<span class="hljs-keyword">if</span> m.dirLen == <span class="hljs-number">1</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
	}
	<span class="hljs-keyword">return</span> hash &gt;&gt; (m.globalShift &amp; <span class="hljs-number">63</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> directoryAt(i <span class="hljs-type">uintptr</span>) *table {
	<span class="hljs-keyword">return</span> *(**table)(unsafe.Pointer(<span class="hljs-type">uintptr</span>(m.dirPtr) + goarch.PtrSize*i))
}
</code></pre>
<p>接着是取探测起始位置和探测序列函数；计算探测起始位置使用到makeProbeSeq函数，利用hash和group的lengthMask按位与得出起始位置，设置index为0并封装为probeSeq返回计算下一个探测位置用到next()函数，采用二次探测的方法，每次 next()：index++，然后 offset = (offset + index) &amp; mask</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makeProbeSeq</span><span class="hljs-params">(hash <span class="hljs-type">uintptr</span>, mask <span class="hljs-type">uint64</span>)</span></span> probeSeq {
	<span class="hljs-keyword">return</span> probeSeq{
		mask:   mask,
		offset: <span class="hljs-type">uint64</span>(hash) &amp; mask,
		index:  <span class="hljs-number">0</span>,
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s probeSeq)</span></span> next() probeSeq {
	s.index++
	s.offset = (s.offset + s.index) &amp; s.mask
	<span class="hljs-keyword">return</span> s
}
</code></pre>
<p>然后看matchH2()用来判断该group中那些slot是候选
<strong>ctrlGroup.matchH2()</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g ctrlGroup)</span></span> matchH2(h <span class="hljs-type">uintptr</span>) bitset {
	<span class="hljs-keyword">return</span> ctrlGroupMatchH2(g, h)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctrlGroupMatchH2</span><span class="hljs-params">(g ctrlGroup, h <span class="hljs-type">uintptr</span>)</span></span> bitset {
	v := <span class="hljs-type">uint64</span>(g) ^ (bitsetLSB * <span class="hljs-type">uint64</span>(h)) <span class="hljs-comment">// bitsetLSB = 0x0101010101010101</span>
	<span class="hljs-keyword">return</span> bitset(((v - bitsetLSB) &amp;^ v) &amp; bitsetMSB) <span class="hljs-comment">//bitsetMSB = 0x8080808080808080</span>
}
</code></pre>
<ol>
<li>bitsetLSB * h 把 8 位的 h 复制到 8 个字节里，例如 ： h为00100010，计算后为 0x22 22 22 22 22 22 22 22</li>
<li>g ^ 用于按位异或， 此时v中每个字节为 0 的位置就表示 g 的对应字节 等于 h；例如前面计算得到0x22 22 22 22 22 22 22 22 g为0x21 22 11 33 44 22 22 22，则得到0x03 00 33 11 66 00 00 00</li>
<li>v - bitsetLSB 将每个字节减一，例如0x03 00 33 11 66 00 00 00得到：0x01 FF 32 10 64 FE FE FF</li>
<li>((v - bitsetLSB) &amp;^ v) 按位清除（v为1的为，会把(v - bitsetLSB)的对应位清0），得到0x00 ff 00 00 00 fe fe ff</li>
<li>最后于bitsetMSB按位与 得到  0x00 80 00 00 00 80 80 80 返回遍历需要的位图</li>
</ol>
<p>matchEmpty()用来判断该group中是否有empty slot，有的话说明探测结束，后面无slot
<strong>ctrlGroup.matchEmpty()</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g ctrlGroup)</span></span> matchEmpty() bitset {
	<span class="hljs-keyword">return</span> ctrlGroupMatchEmpty(g)
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctrlGroupMatchEmpty</span><span class="hljs-params">(g ctrlGroup)</span></span> bitset {
	<span class="hljs-comment">// An empty slot is   1000 0000</span>
	<span class="hljs-comment">// A deleted slot is  1111 1110</span>
	<span class="hljs-comment">// A full slot is     0??? ????</span>
	v := <span class="hljs-type">uint64</span>(g)
	<span class="hljs-keyword">return</span> bitset((v &amp;^ (v &lt;&lt; <span class="hljs-number">6</span>)) &amp; bitsetMSB)
}
</code></pre>
<p>go官方定义第 7 位被置 1 且第 1 位未置位时则该slot是一个empty slot</p>
<ol>
<li>v &lt;&lt; 6 会把 每个字节的 bit1（0x02）移动到该字节的 bit7 位置。</li>
<li>v &amp;^ (v&lt;&lt;6) 会在 v 的 bit7 上 清掉 那些原本 bit1 为 1的字节。</li>
<li>然后使用bitsetMSB 按位与确保每个字节只保留最高位，此时0x80的字节就是空empty slot</li>
</ol>
<h3 data-id="heading-11">向map中写数据</h3>
<p>首先总结一下map写数据的大致流程：</p>
<ol>
<li>m == nil（nil map）写入会 panic；进入写前若 m.writing != 0 会 fatal。</li>
<li>计算 hash 后把 m.writing ^= 1（通常 0 -&gt; 1）。</li>
<li>若 m.dirPtr == nil，先 growToSmall 分配首个 group。</li>
<li>若 m.dirLen == 0（小 map）：未满：直接 small put；已满：growToTable 转成 table 再走大 map 流程。</li>
<li>大 map：按 hash 找 table，沿 probe 序列先找“同 key”槽位（找到就是更新并返回）。
没找到时：遇到 empty 表示 probe 结束；若之前记过 deleted 槽位则<strong>优先用 deleted，否则用 empty</strong>；若 growthLeft == 0 则 rehash 后 continue outer 重试。</li>
<li>返回前再做并发校验：若 m.writing == 0 则 fatal，否则再 ^= 1（1 -&gt; 0）恢复。</li>
</ol>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c821e2d0a047528479bd85387355fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=v1gviu8NNSgIEr6jVN9DWpfmkfY%3D" alt="putmap.png" width="80%" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runtime_mapassign</span><span class="hljs-params">(typ *abi.SwissMapType, m *Map, key unsafe.Pointer)</span></span> unsafe.Pointer {
	<span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(errNilAssign)
	}
	<span class="hljs-keyword">if</span> m.writing != <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map writes"</span>)
	}
	hash := typ.Hasher(key, m.seed)
	m.writing ^= <span class="hljs-number">1</span> 
	<span class="hljs-keyword">if</span> m.dirPtr == <span class="hljs-literal">nil</span> {
		m.growToSmall(typ)
	}
	<span class="hljs-keyword">if</span> m.dirLen == <span class="hljs-number">0</span> {
		<span class="hljs-keyword">if</span> m.used &lt; abi.SwissMapGroupSlots {
			elem := m.putSlotSmall(typ, hash, key)
			<span class="hljs-keyword">if</span> m.writing == <span class="hljs-number">0</span> {
				fatal(<span class="hljs-string">"concurrent map writes"</span>)
			}
			m.writing ^= <span class="hljs-number">1</span>
			<span class="hljs-keyword">return</span> elem
		}
		m.growToTable(typ)
	}
	<span class="hljs-keyword">var</span> slotElem unsafe.Pointer
outer:
	<span class="hljs-keyword">for</span> {
		idx := m.directoryIndex(hash)
		t := m.directoryAt(idx)
		seq := makeProbeSeq(h1(hash), t.groups.lengthMask)
		<span class="hljs-keyword">var</span> firstDeletedGroup groupReference
		<span class="hljs-keyword">var</span> firstDeletedSlot <span class="hljs-type">uintptr</span>

		<span class="hljs-keyword">for</span> ; ; seq = seq.next() {
			g := t.groups.group(typ, seq.offset)
			match := g.ctrls().matchH2(h2(hash))
			<span class="hljs-keyword">for</span> match != <span class="hljs-number">0</span> {
				i := match.first()
				slotKey := g.key(typ, i)
				slotKeyOrig := slotKey
				<span class="hljs-keyword">if</span> typ.IndirectKey() {
					slotKey = *((*unsafe.Pointer)(slotKey))
				}
				<span class="hljs-keyword">if</span> typ.Key.Equal(key, slotKey) {
					<span class="hljs-keyword">if</span> typ.NeedKeyUpdate() {
						typedmemmove(typ.Key, slotKey, key)
					}
					slotElem = unsafe.Pointer(<span class="hljs-type">uintptr</span>(slotKeyOrig) + typ.ElemOff)
					<span class="hljs-keyword">if</span> typ.IndirectElem() {
						slotElem = *((*unsafe.Pointer)(slotElem))
					}
					t.checkInvariants(typ, m)
					<span class="hljs-keyword">break</span> outer
				}
				match = match.removeFirst()
			}
			match = g.ctrls().matchEmpty()
			<span class="hljs-keyword">if</span> match != <span class="hljs-number">0</span> {
				<span class="hljs-keyword">var</span> i <span class="hljs-type">uintptr</span>
				<span class="hljs-keyword">if</span> firstDeletedGroup.data != <span class="hljs-literal">nil</span> {
					g = firstDeletedGroup
					i = firstDeletedSlot
					t.growthLeft++ 
				} <span class="hljs-keyword">else</span> {
					i = match.first()
				}
				<span class="hljs-keyword">if</span> t.growthLeft &gt; <span class="hljs-number">0</span> {
					slotKey := g.key(typ, i)
					slotKeyOrig := slotKey
					<span class="hljs-keyword">if</span> typ.IndirectKey() {
						kmem := newobject(typ.Key)
						*(*unsafe.Pointer)(slotKey) = kmem
						slotKey = kmem
					}
					typedmemmove(typ.Key, slotKey, key)

					slotElem = unsafe.Pointer(<span class="hljs-type">uintptr</span>(slotKeyOrig) + typ.ElemOff)
					<span class="hljs-keyword">if</span> typ.IndirectElem() {
						emem := newobject(typ.Elem)
						*(*unsafe.Pointer)(slotElem) = emem
						slotElem = emem
					}
					g.ctrls().set(i, ctrl(h2(hash)))
					t.growthLeft--
					t.used++
					m.used++

					t.checkInvariants(typ, m)
					<span class="hljs-keyword">break</span> outer
				}
				t.rehash(typ, m)
				<span class="hljs-keyword">continue</span> outer
			}
			<span class="hljs-keyword">if</span> firstDeletedGroup.data == <span class="hljs-literal">nil</span> {
				match = g.ctrls().matchEmptyOrDeleted()
				<span class="hljs-keyword">if</span> match != <span class="hljs-number">0</span> {
					firstDeletedGroup = g
					firstDeletedSlot = match.first()
				}
			}
		}
	}

	<span class="hljs-keyword">if</span> m.writing == <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map writes"</span>)
	}
	m.writing ^= <span class="hljs-number">1</span>
	<span class="hljs-keyword">return</span> slotElem
}
</code></pre>
<p>该方法较长分为几步来进行阐述</p>
<p><strong>step1:</strong></p>
<p>向未初始化 map写入会panic；如果该map此时被其他协程写则fatal
如果此时已初始化且没有其他协程写则计算hash并将writing与1做异或（m.writing ^= 1（ 0 -&gt; 1））</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(errNilAssign)
	}

	<span class="hljs-keyword">if</span> m.writing != <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map writes"</span>)
	}
	hash := typ.Hasher(key, m.seed)
	m.writing ^= <span class="hljs-number">1</span> 
</code></pre>
<p><strong>step2:</strong></p>
<ol>
<li>若dirptr为nil此时map还未分配group，调用growToSmall初始化一个group供map使用</li>
<li>若dirLen为0则以为着该map为小map，此时有两种情况1：当前小map未填满则进入put流程；2：小map填满了此时将小map扩容，创建一个table供当前map使用</li>
<li>put 成功返回前再检查：如果 m.writing == 0 则 fatal（说明被其他协程并发写修改）；否则再 （m.writing ^= 1（ 1 -&gt; 0））再返回。</li>
</ol>
<pre><code class="hljs language-go" lang="go">	<span class="hljs-keyword">if</span> m.dirPtr == <span class="hljs-literal">nil</span> {
		m.growToSmall(typ)
	}

	<span class="hljs-keyword">if</span> m.dirLen == <span class="hljs-number">0</span> {
		<span class="hljs-keyword">if</span> m.used &lt; abi.SwissMapGroupSlots {
			elem := m.putSlotSmall(typ, hash, key)

			<span class="hljs-keyword">if</span> m.writing == <span class="hljs-number">0</span> {
				fatal(<span class="hljs-string">"concurrent map writes"</span>)
			}
			m.writing ^= <span class="hljs-number">1</span>

			<span class="hljs-keyword">return</span> elem
		}
		m.growToTable(typ)
	}
</code></pre>
<p><strong>step3：</strong> 在前面没有返回说明不是小map，或者小map被填满触发扩容了，进入下面的outer 标签的 for循环</p>
<ol>
<li>先用 hash 计算目录索引拿到 table，再得到 probe 序列和起始 group。</li>
</ol>
<pre><code class="hljs language-go" lang="go">	<span class="hljs-keyword">var</span> slotElem unsafe.Pointer
outer:
	<span class="hljs-keyword">for</span> {
		idx := m.directoryIndex(hash)
		t := m.directoryAt(idx)
		seq := makeProbeSeq(h1(hash), t.groups.lengthMask)
		<span class="hljs-keyword">var</span> firstDeletedGroup groupReference <span class="hljs-comment">//第一个存在删除slot的group</span>
		<span class="hljs-keyword">var</span> firstDeletedSlot <span class="hljs-type">uintptr</span> <span class="hljs-comment">//第一个被删除的slot</span>
		<span class="hljs-comment">//..</span>
	}
</code></pre>
<p><strong>step4:</strong></p>
<ol>
<li>进入内层for 按 probe 序列继续探测（与前面读路径相似）。</li>
<li>内层for循环里，首先获得起始group然后根据h2(hash)与控制字匹配，得到位图（哪些 slot 的 h2 匹配）；（与前面读路径相似）。</li>
<li>如果该group有与h2匹配的slot则：首先取得第一个匹配的key，倘若是指向key的指针的则解引用；倘若不存在不进入for match != 0 循环</li>
<li>判断与传入的key是否equal：equal则判断是否需要更新key需要的话直接基于typedmemmove将key赋给slotkey，不需要进入取elem（倘若是指向elem的指针的则解引用）并复制给slotElem，直接结束outer循环；</li>
<li>若不equal则取下一个与h2匹配的key；直到该group没有与h2匹配的slot</li>
</ol>
<pre><code class="hljs language-go" lang="go">	<span class="hljs-comment">//..</span>
	<span class="hljs-keyword">for</span> ; ; seq = seq.next() {
			g := t.groups.group(typ, seq.offset)
			match := g.ctrls().matchH2(h2(hash))
			<span class="hljs-comment">// Look for an existing slot containing this key.</span>
			<span class="hljs-keyword">for</span> match != <span class="hljs-number">0</span> {
				i := match.first()

				slotKey := g.key(typ, i)
				slotKeyOrig := slotKey
				<span class="hljs-keyword">if</span> typ.IndirectKey() {
					slotKey = *((*unsafe.Pointer)(slotKey))
				}
				<span class="hljs-keyword">if</span> typ.Key.Equal(key, slotKey) {
					<span class="hljs-keyword">if</span> typ.NeedKeyUpdate() {
						typedmemmove(typ.Key, slotKey, key)
					}

					slotElem = unsafe.Pointer(<span class="hljs-type">uintptr</span>(slotKeyOrig) + typ.ElemOff)
					<span class="hljs-keyword">if</span> typ.IndirectElem() {
						slotElem = *((*unsafe.Pointer)(slotElem))
					}

					t.checkInvariants(typ, m)
					<span class="hljs-keyword">break</span> outer
				}
				match = match.removeFirst()
			}
			<span class="hljs-comment">//..</span>
	}
</code></pre>
<p><strong>step5:</strong></p>
<p>此时该group没有匹配到key对应的slot</p>
<ol>
<li>取出当前group的空slot，若没有则不进入</li>
<li>倘若有空slot（说明探测序列要结束了），首先查看firstDeletedGroup是否为空，不为空说明已经找到第一个删除的slot和对应得Group并将t.growthLeft++，否则取出当前group中第一位空的slot</li>
<li>接着判断当前t.growthLeft是否大于0.大于0则说明可直接插入无需扩容，否则说明当前table需要扩容才能继续插入</li>
<li>倘若可直接插入取出空slot的地址，如果 key 是间接存储（槽里放指针），首先分配给key内存，把指针写进槽位，接着把传入 key 拷贝到最终 key 存储位置。</li>
<li>用槽位原始地址 + 偏移，定位到该槽位的 elem 字段。如果 elem 也间接存储，就分配 elem 内存，把指针写进槽位，并让 slotElem 指向新内存。</li>
<li>将控制位写入g的控制字并且将g和t的used++，将t.growthLeft--， 调用checkInvariants，结束outer循环</li>
<li>倘若当前插入需要rehash则rehash 后重试outer for循环</li>
</ol>
<pre><code class="hljs language-go" lang="go">		<span class="hljs-comment">//..</span>
		match = g.ctrls().matchEmpty()
		<span class="hljs-keyword">if</span> match != <span class="hljs-number">0</span> {
			<span class="hljs-keyword">var</span> i <span class="hljs-type">uintptr</span>
			<span class="hljs-keyword">if</span> firstDeletedGroup.data != <span class="hljs-literal">nil</span> {
				g = firstDeletedGroup
				i = firstDeletedSlot
				t.growthLeft++ <span class="hljs-comment">// will be decremented below tobecome a no-op.</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-comment">// Otherwise, use the empty slot.</span>
				i = match.first()
			}
			<span class="hljs-keyword">if</span> t.growthLeft &gt; <span class="hljs-number">0</span> {
				slotKey := g.key(typ, i)
				slotKeyOrig := slotKey
				<span class="hljs-keyword">if</span> typ.IndirectKey() {
					kmem := newobject(typ.Key)
					*(*unsafe.Pointer)(slotKey) = kmem
					slotKey = kmem
				}
				typedmemmove(typ.Key, slotKey, key)
				slotElem = unsafe.Pointer(<span class="hljs-type">uintptr</span>(slotKeyOrig) + typElemOff)
				<span class="hljs-keyword">if</span> typ.IndirectElem() {
					emem := newobject(typ.Elem)
					*(*unsafe.Pointer)(slotElem) = emem
					slotElem = emem
				}
				g.ctrls().set(i, ctrl(h2(hash)))
				t.growthLeft--
				t.used++
				m.used++
				t.checkInvariants(typ, m)
				<span class="hljs-keyword">break</span> outer
			}
			t.rehash(typ, m)
			<span class="hljs-keyword">continue</span> outer
		}
			
</code></pre>
<p><strong>step6:</strong>
此时该group没有配对的key也没有结束探寻</p>
<ol>
<li>如果此时没有找到第一个存在删除的group，则检查当前group是否存在被删除得slot，存在的话则进行赋值，不存在则继续探测序列循环</li>
</ol>
<pre><code class="hljs language-go" lang="go">			<span class="hljs-keyword">if</span> firstDeletedGroup.data == <span class="hljs-literal">nil</span> {
				match = g.ctrls().matchEmptyOrDeleted()
				<span class="hljs-keyword">if</span> match != <span class="hljs-number">0</span> {
					firstDeletedGroup = g
					firstDeletedSlot = match.first()
				}
			}
</code></pre>
<p><strong>step7:</strong>
此时找到可以写入的位置</p>
<ol>
<li>先检查：如果 m.writing == 0 则 fatal（说明被其他协程并发写修改）；否则再 （m.writing ^= 1（ 1 -&gt; 0））再返回slotElem。</li>
</ol>
<pre><code class="hljs language-go" lang="go">	<span class="hljs-keyword">if</span> m.writing == <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map writes"</span>)
	}
	m.writing ^= <span class="hljs-number">1</span>
	<span class="hljs-keyword">return</span> slotElem
</code></pre>
<p>写入操作结束，接下来阐述其中用到的关键方法：</p>
<p><strong>Map.growToSmall()</strong></p>
<p>该方法用于小 map 路径下首次为 m 分配存储</p>
<ol>
<li>创建一个包含一个group的groupsReference，将m的dirPtr指向该group的地址,并将控制位全部置为 empty。</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> growToSmall(typ *abi.SwissMapType) {
	grp := newGroups(typ, <span class="hljs-number">1</span>)
	m.dirPtr = grp.data

	g := groupReference{
		data: m.dirPtr,
	}
	g.ctrls().setEmpty()
}
</code></pre>
<p><strong>Map.putSlotSmall()</strong>
该方法用于向小map写入数据，该方法主要有两个流程</p>
<p>第一步：当前group有与h2匹配的slot</p>
<ol>
<li>首先封装一个group指向当前m的group的地址</li>
<li>在当前group得到控制位与h2(hash)匹配的位图</li>
<li>如果有匹配的，则首先取得第一个匹配的key，倘若是指向key的指针的则解引用；倘若不存在不进入for match != 0 循环</li>
<li>判断与传入的key是否equal：equal则判断是否需要更新key需要的话直接基于typedmemmove将key赋给slotkey，不需要进入取elem（如果elem存放的是指向elem的指针则解引用）并复制给slotElem，返回 slotelem；</li>
<li>若不equal则取下一个与h2匹配的key；直到该group没有与h2匹配的slot</li>
</ol>
<p>第二步：当前group没有与h2匹配的slot</p>
<ol start="6">
<li>如果当前group没匹配的slot则获取为空or已删除的slot位图</li>
<li>如果位图为空则fatal（因为在进入该函数前确保了存在位置供插入）</li>
<li>否则取第一个slot，如果 key 是间接存储（槽里放指针），首先分配给key内存，把指针写进槽位，接着把传入 key 拷贝到最终 key 存储位置。</li>
<li>用槽位原始地址 + 偏移，定位到该槽位的 elem 字段。如果 elem 也间接存储，就分配 elem 内存，把指针写进槽位，并让 slotElem 指向新内存</li>
<li>最后将控制位写入h2(hash)，m.used++并且返回slotElem</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> putSlotSmall(typ *abi.SwissMapType, hash <span class="hljs-type">uintptr</span>, key unsafe.Pointer) unsafe.Pointer {
	g := groupReference{
		data: m.dirPtr,
	}
	match := g.ctrls().matchH2(h2(hash))
	<span class="hljs-keyword">for</span> match != <span class="hljs-number">0</span> {
		i := match.first()
		slotKey := g.key(typ, i)
		<span class="hljs-keyword">if</span> typ.IndirectKey() {
			slotKey = *((*unsafe.Pointer)(slotKey))
		}
		<span class="hljs-keyword">if</span> typ.Key.Equal(key, slotKey) {
			<span class="hljs-keyword">if</span> typ.NeedKeyUpdate() {
				typedmemmove(typ.Key, slotKey, key)
			}
			slotElem := g.elem(typ, i)
			<span class="hljs-keyword">if</span> typ.IndirectElem() {
				slotElem = *((*unsafe.Pointer)(slotElem))
			}
			<span class="hljs-keyword">return</span> slotElem
		}
		match = match.removeFirst()
	}
	match = g.ctrls().matchEmptyOrDeleted()
	<span class="hljs-keyword">if</span> match == <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"small map with no empty slot (concurrent map writes?)"</span>)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}
	i := match.first()
	slotKey := g.key(typ, i)
	<span class="hljs-keyword">if</span> typ.IndirectKey() {
		kmem := newobject(typ.Key)
		*(*unsafe.Pointer)(slotKey) = kmem
		slotKey = kmem
	}
	typedmemmove(typ.Key, slotKey, key)

	slotElem := g.elem(typ, i)
	<span class="hljs-keyword">if</span> typ.IndirectElem() {
		emem := newobject(typ.Elem)
		*(*unsafe.Pointer)(slotElem) = emem
		slotElem = emem
	}
	g.ctrls().set(i, ctrl(h2(hash)))
	m.used++
	<span class="hljs-keyword">return</span> slotElem
}
</code></pre>
<p><strong>table.checkInvariants()</strong> table 的调试自检函数（只在 debugLog=true 时运行），用来验证哈希表内部状态没坏。</p>
<h3 data-id="heading-12">map扩容</h3>
<p>简述扩容的流程：
小map的扩容：直接创建一个2 * SwissMapGroupSlots的table，将非空旧slot插入新table，加入到m的目录里</p>
<p>大map的扩容：
首先新容量设为旧容量的2倍，如果 新容量不大于maxTableCapacity则根据新容量创建一个table，将非空旧slot插入新table，加入到m的目录里，并将旧table的设为弃用；</p>
<p>如果新容量超限制则将table分为两个容量为maxTableCapacity的table，并将非空旧slot根据hash插入分别两个table,并且根据table的localDepth和m的globalDepth决定对目录的操作最后将table加入到m的目录项；</p>
<p><strong>基于extendible hashing 的增量扩容</strong></p>
<ol>
<li>目录（globalDepth）负责把 key 路由到某个 table。</li>
<li>每个 table 有自己的 localDepth。</li>
<li>写入冲突时，只扩命中的那一个 table：grow 或 split。</li>
<li>如果该 table 的 localDepth == globalDepth，先把目录翻倍，再 split 这个 table。</li>
<li>其他 table 不搬迁，后续再按需扩。</li>
</ol>
<h4 data-id="heading-13">小容量map扩容</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/774436b68dcf4577af1458a659ac96a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=44iFnpRVCzsiY35QBf4H6a2hQ9U%3D" alt="小map扩容.png" loading="lazy"/></p>
<p>该方法用于小map插入slot时扩容使用，</p>
<ol>
<li>首先创建一个容量为2个group数量槽位的table</li>
<li>封装一个group指向当前m的group的地址</li>
<li>紧接着开启循环处理group中的slot，如果遇到empty slot则continue,对非空槽位取出 key/elem，重新算 hash 后插入新 table</li>
<li>处理完当前m的slot，对m的进行重新赋值，结束，进入大map路径</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> growToTable(typ *abi.SwissMapType) {
	tab := newTable(typ, <span class="hljs-number">2</span>*abi.SwissMapGroupSlots, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
	g := groupReference{
		data: m.dirPtr,
	}
	<span class="hljs-keyword">for</span> i := <span class="hljs-type">uintptr</span>(<span class="hljs-number">0</span>); i &lt; abi.SwissMapGroupSlots; i++ {
		<span class="hljs-keyword">if</span> (g.ctrls().get(i) &amp; ctrlEmpty) == ctrlEmpty {
			<span class="hljs-keyword">continue</span>
		}
		key := g.key(typ, i)
		<span class="hljs-keyword">if</span> typ.IndirectKey() {
			key = *((*unsafe.Pointer)(key))
		}
		elem := g.elem(typ, i)
		<span class="hljs-keyword">if</span> typ.IndirectElem() {
			elem = *((*unsafe.Pointer)(elem))
		}
		hash := typ.Hasher(key, m.seed)
		tab.uncheckedPutSlot(typ, hash, key, elem)
	}
	directory := <span class="hljs-built_in">make</span>([]*table, <span class="hljs-number">1</span>)
	directory[<span class="hljs-number">0</span>] = tab
	m.dirPtr = unsafe.Pointer(&amp;directory[<span class="hljs-number">0</span>])
	m.dirLen = <span class="hljs-built_in">len</span>(directory)
	m.globalDepth = <span class="hljs-number">0</span>
	m.globalShift = depthToShift(m.globalDepth)
}
</code></pre>
<p>接着看对小map扩容的时候slot是怎么插入到新table的</p>
<p><strong>table.uncheckedPutSlot()</strong></p>
<ol>
<li>如果table的growthLeft为0 违反则直接panic</li>
<li>首先也是获取探测序列和起始group，并进入探测迭代</li>
<li>在循环里，首先获得group的空或者已经删除的slot的位图（但官方规定该函数要求table中不存在已删除的slot，所以大概率写入empty slot）</li>
<li>如果有则取第一个slot，并拿到第 i 槽位的 key 字段地址，typ.IndirectKey() 为真：槽位里存“指针”，直接把 key 指针写进去；否则typedmemmove 把 key 内容拷贝进槽位； elem同理</li>
<li>写入过后t.growthLeft--，t.used++并将该group的控制位写入当前key的h2（hash）返回</li>
<li>如果当前group不存在已删除或者空slot则去下一个探测位置的group</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *table)</span></span> uncheckedPutSlot(typ *abi.SwissMapType, hash <span class="hljs-type">uintptr</span>, key, elem unsafe.Pointer) {
	<span class="hljs-keyword">if</span> t.growthLeft == <span class="hljs-number">0</span> {
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">"invariant failed: growthLeft is unexpectedly 0"</span>)
	}
	seq := makeProbeSeq(h1(hash), t.groups.lengthMask)
	<span class="hljs-keyword">for</span> ; ; seq = seq.next() {
		g := t.groups.group(typ, seq.offset)

		match := g.ctrls().matchEmptyOrDeleted()
		<span class="hljs-keyword">if</span> match != <span class="hljs-number">0</span> {
			i := match.first()

			slotKey := g.key(typ, i)
			<span class="hljs-keyword">if</span> typ.IndirectKey() {
				*(*unsafe.Pointer)(slotKey) = key
			} <span class="hljs-keyword">else</span> {
				typedmemmove(typ.Key, slotKey, key)
			}

			slotElem := g.elem(typ, i)
			<span class="hljs-keyword">if</span> typ.IndirectElem() {
				*(*unsafe.Pointer)(slotElem) = elem
			} <span class="hljs-keyword">else</span> {
				typedmemmove(typ.Elem, slotElem, elem)
			}

			t.growthLeft--
			t.used++
			g.ctrls().set(i, ctrl(h2(hash)))
			<span class="hljs-keyword">return</span>
		}
	}
}
</code></pre>
<h4 data-id="heading-14">大容量map扩容</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d6b7e0c32514d48ab23ec564027ed4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=vO5yaI22gcs5PJzkYdu1uoNQJPQ%3D" alt="大map扩容.png" width="70%" loading="lazy"/></p>
该方法用于大map插入时扩容
<ol>
<li>将新newCapacity设为老容量的两倍，没超限制的话调用t.grow(typ, m, newCapacity)然后返回</li>
<li>超限制则调用t.split(typ, m)</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *table)</span></span> rehash(typ *abi.SwissMapType, m *Map) {
	newCapacity := <span class="hljs-number">2</span> * t.capacity
	<span class="hljs-keyword">if</span> newCapacity &lt;= maxTableCapacity {
		t.grow(typ, m, newCapacity)
		<span class="hljs-keyword">return</span>
	}

	t.split(typ, m)
}
</code></pre>
<p>首先看新容量没超限制的情况：</p>
<ol>
<li>首先根据新容量创建一个table</li>
<li>首先判断t.capacity是否大于0，防止capacity==0（零值/异常状态）时去遍历旧 groups 导致错误。只有当t.capacity大于0才会进入处理旧数据</li>
<li>处理旧数据跟小map扩容类似，不过大map时遍历groups，对groups中的每个group的slot进行处理，空slot不管，有数据重新hash的插入新table，具体看小map的解释</li>
<li>结束前面操作首先检查table的内部状态，然后将m的table换为新table</li>
<li>旧table的index设为-1代表已失效，返回
<strong>table.grow()</strong></li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *table)</span></span> grow(typ *abi.SwissMapType, m *Map, newCapacity <span class="hljs-type">uint16</span>) {
	newTable := newTable(typ, <span class="hljs-type">uint64</span>(newCapacity), t.index, t.localDepth)
	<span class="hljs-keyword">if</span> t.capacity &gt; <span class="hljs-number">0</span> {
		<span class="hljs-keyword">for</span> i := <span class="hljs-type">uint64</span>(<span class="hljs-number">0</span>); i &lt;= t.groups.lengthMask; i++ {
			g := t.groups.group(typ, i)
			<span class="hljs-keyword">for</span> j := <span class="hljs-type">uintptr</span>(<span class="hljs-number">0</span>); j &lt; abi.SwissMapGroupSlots; j++ {
				<span class="hljs-keyword">if</span> (g.ctrls().get(j) &amp; ctrlEmpty) == ctrlEmpty {
					<span class="hljs-keyword">continue</span>
				}
				key := g.key(typ, j)
				<span class="hljs-keyword">if</span> typ.IndirectKey() {
					key = *((*unsafe.Pointer)(key))
				}

				elem := g.elem(typ, j)
				<span class="hljs-keyword">if</span> typ.IndirectElem() {
					elem = *((*unsafe.Pointer)(elem))
				}

				hash := typ.Hasher(key, m.seed)

				newTable.uncheckedPutSlot(typ, hash, key, elem)
			}
		}
	}
	newTable.checkInvariants(typ, m)
	m.replaceTable(newTable)
	t.index = <span class="hljs-number">-1</span>
}
</code></pre>
<p><strong>table.split()</strong>
该方法用于在大map扩容时新容量超出table的限制时将一个table分为两个</p>
<ol>
<li>首先将取出table的localDepth赋值给一个变量，并对该变量++，表示 split 后新表深度 +1</li>
<li>然后分别创建left和right两个table，容量时maxTableCapacity，index为-1</li>
<li>调用localDepthMask返回一个掩码，用于取哈希值中当前 localDepth 新增出来的那一位（用于 split 时选 left/right）。</li>
<li>在处理旧的slot数据时，与直接翻倍容量扩容处理相似，只不过多了一个hash&amp;mask计算落在那一个table，处理结束后调用m.installTableSplit(t, left, right) 把左右表加入目录（必要时先扩目录）。</li>
<li>最后将当前table的index设为-1，返回</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *table)</span></span> split(typ *abi.SwissMapType, m *Map) {
	localDepth := t.localDepth
	localDepth++

	left := newTable(typ, maxTableCapacity, <span class="hljs-number">-1</span>, localDepth)
	right := newTable(typ, maxTableCapacity, <span class="hljs-number">-1</span>, localDepth)

	mask := localDepthMask(localDepth)

	<span class="hljs-keyword">for</span> i := <span class="hljs-type">uint64</span>(<span class="hljs-number">0</span>); i &lt;= t.groups.lengthMask; i++ {
		g := t.groups.group(typ, i)
		<span class="hljs-keyword">for</span> j := <span class="hljs-type">uintptr</span>(<span class="hljs-number">0</span>); j &lt; abi.SwissMapGroupSlots; j++ {
			<span class="hljs-keyword">if</span> (g.ctrls().get(j) &amp; ctrlEmpty) == ctrlEmpty {
				<span class="hljs-keyword">continue</span>
			}
			key := g.key(typ, j)
			<span class="hljs-keyword">if</span> typ.IndirectKey() {
				key = *((*unsafe.Pointer)(key))
			}

			elem := g.elem(typ, j)
			<span class="hljs-keyword">if</span> typ.IndirectElem() {
				elem = *((*unsafe.Pointer)(elem))
			}

			hash := typ.Hasher(key, m.seed)
			<span class="hljs-keyword">var</span> newTable *table
			<span class="hljs-keyword">if</span> hash&amp;mask == <span class="hljs-number">0</span> {
				newTable = left
			} <span class="hljs-keyword">else</span> {
				newTable = right
			}
			newTable.uncheckedPutSlot(typ, hash, key, elem)
		}
	}
	m.installTableSplit(t, left, right)
	t.index = <span class="hljs-number">-1</span>
}
</code></pre>
<p><strong>Map.installTableSplit()</strong>
该方法用于将split后的left和right table加入目录项</p>
<ol>
<li>如果old.localDepth == m.globalDepth，说明当前目录项不够再对table进行细分需要对目录进行翻倍（<strong>把所有目录项复制扩展，但不会立刻把其他 table 也一起 split</strong>）</li>
<li>首先创建一个m.dirLen*2长度的 *table切片，然后将每个table的旧索引 i 扩成新索引 2 * i 和 2 * i+1。t.index 存的是该 table 在目录中的第一个位置。同一个 table 可能在目录里出现多次，所以只在遇到它原来的起始位置（t.index == i）时更新一次为 2 * i，避免重复改错。（确保只更新一次每个 table 的起始索引）</li>
<li>并对m的一些参数进行对应的修改</li>
<li>调用replaceTable将left和right插入到目录项里，entries表示该 table 需要被多少个目录项共享引用。当 m.globalDepth - left.localDepth == 1 时，entries=2，所以 replaceTable 会把 left（或 right）写入连续 2 个目录项。</li>
<li>此时right的目录项紧挨着left的目录项</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> installTableSplit(old, left, right *table) {
	<span class="hljs-keyword">if</span> old.localDepth == m.globalDepth {
		newDir := <span class="hljs-built_in">make</span>([]*table, m.dirLen*<span class="hljs-number">2</span>)
		<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> m.dirLen {
			t := m.directoryAt(<span class="hljs-type">uintptr</span>(i))
			newDir[<span class="hljs-number">2</span>*i] = t
			newDir[<span class="hljs-number">2</span>*i+<span class="hljs-number">1</span>] = t
			<span class="hljs-keyword">if</span> t.index == i {
				t.index = <span class="hljs-number">2</span> * i
			}
		}
		m.globalDepth++
		m.globalShift--
		m.dirPtr = unsafe.Pointer(&amp;newDir[<span class="hljs-number">0</span>])
		m.dirLen = <span class="hljs-built_in">len</span>(newDir)
	}
	left.index = old.index
	m.replaceTable(left)
	entries := <span class="hljs-number">1</span> &lt;&lt; (m.globalDepth - left.localDepth)
	right.index = left.index + entries
	m.replaceTable(right)
}
</code></pre>
<p><strong>Map.replaceTable()</strong>
用来实现同一个 table 被多个目录项共享引用</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> replaceTable(nt *table) {
	<span class="hljs-comment">// The number of entries that reference the same table doubles for each</span>
	<span class="hljs-comment">// time the globalDepth grows without the table splitting.</span>
	entries := <span class="hljs-number">1</span> &lt;&lt; (m.globalDepth - nt.localDepth)
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; entries; i++ {
		<span class="hljs-comment">//m.directory[nt.index+i] = nt</span>
		m.directorySet(<span class="hljs-type">uintptr</span>(nt.index+i), nt)
	}
}
</code></pre>
<h3 data-id="heading-15">从map中删除数据</h3>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ed55f33bee14215b44859679263ee97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganp6enp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771302119&amp;x-signature=Ok5WRpnqXCWAryhpWNtwKWlTbJQ%3D" alt="delmap.png" width="70%" loading="lazy"/></p>
<ol>
<li>如果map为nil，或者map中无已填充的数据，首先对key的合法性进行判断，如果key不合法则直接panic，否则返回；</li>
<li>判断是否有其他协程再写map，有的话fatal</li>
<li>如没有其他协程写且map不为空则先计算key的hash，并将	m.writing ^= 1</li>
<li>接着进入删除操作，小map和大map执行不同操作</li>
<li>删除结束，如果 m.used == 0，说明 map 已经空了。重新设置 m.seed = uintptr(rand())，并判断是否有其他协程在过程中进行并发写，有的话fatal，否则m.writing ^= 1返回
<strong>Map.Delete()</strong></li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> Delete(typ *abi.SwissMapType, key unsafe.Pointer) {
	<span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> || m.Used() == <span class="hljs-number">0</span> {
		<span class="hljs-keyword">if</span> err := mapKeyError(typ, key); err != <span class="hljs-literal">nil</span> {
			<span class="hljs-built_in">panic</span>(err) 
		}
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> m.writing != <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map writes"</span>)
	}
	hash := typ.Hasher(key, m.seed)
	m.writing ^= <span class="hljs-number">1</span> 
	<span class="hljs-keyword">if</span> m.dirLen == <span class="hljs-number">0</span> {
		m.deleteSmall(typ, hash, key)
	} <span class="hljs-keyword">else</span> {
		idx := m.directoryIndex(hash)
		m.directoryAt(idx).Delete(typ, m, hash, key)
	}
	<span class="hljs-keyword">if</span> m.used == <span class="hljs-number">0</span> {
		m.seed = <span class="hljs-type">uintptr</span>(rand())
	}
	<span class="hljs-keyword">if</span> m.writing == <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map writes"</span>)
	}
	m.writing ^= <span class="hljs-number">1</span>
}
</code></pre>
<p>接着看小map删除的具体实现
<strong>Map.deleteSmall()</strong></p>
<ol>
<li>首先封装一个group指向m.dirPtr（即存放slot的地址）</li>
<li>得到group中与h2(hash)匹配的slot的位图，如果没有直接结束deleteSmall（）</li>
<li>首先取出第一个与h2匹配的slot的slotKey，并赋值变量方便清除elem，如果slotkey存放的是指向 key 的指针则解引用</li>
<li>接着判断Equal(key, slotKey)，不相等的话则继续取下一个匹配的slot</li>
<li>匹配的话进入清除数据，首先将m.used--,然后判断key是否是存放的是指向 key 的指针，是的话清空指针，切断对key的引用；typ.Key.Pointers() 为真说明 key 本身包含指针字段。这时用 typedmemclr 按类型清零，把 key 里的指针字段清掉，防止残留引用。上述两步都是为了方便gc回收</li>
<li>对elem判断elem是否是存放的是指向 elem的指针，是的话清空指针，切断对elem的引用，否则直接按类型清空，返回</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Map)</span></span> deleteSmall(typ *abi.SwissMapType, hash <span class="hljs-type">uintptr</span>, key unsafe.Pointer) {
	g := groupReference{
		data: m.dirPtr,
	}
	match := g.ctrls().matchH2(h2(hash))
	<span class="hljs-keyword">for</span> match != <span class="hljs-number">0</span> {
		i := match.first()
		slotKey := g.key(typ, i)
		origSlotKey := slotKey
		<span class="hljs-keyword">if</span> typ.IndirectKey() {
			slotKey = *((*unsafe.Pointer)(slotKey))
		}
		<span class="hljs-keyword">if</span> typ.Key.Equal(key, slotKey) {
			m.used--
			<span class="hljs-keyword">if</span> typ.IndirectKey() {
				*(*unsafe.Pointer)(origSlotKey) = <span class="hljs-literal">nil</span>
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> typ.Key.Pointers() {
				typedmemclr(typ.Key, slotKey)
			}
			slotElem := g.elem(typ, i)
			<span class="hljs-keyword">if</span> typ.IndirectElem() {
				*(*unsafe.Pointer)(slotElem) = <span class="hljs-literal">nil</span>
			} <span class="hljs-keyword">else</span> {
				typedmemclr(typ.Elem, slotElem)
			}
			g.ctrls().set(i, ctrlEmpty)
			<span class="hljs-keyword">return</span>
		}
		match = match.removeFirst()
	}
}
</code></pre>
<p>最后看大map删除的具体实现</p>
<ol>
<li>首先取探测序列和起始group位置，进入探测循环</li>
<li>取起始group，首先得到group中与h2(hash)匹配的slot的位图，如果matchH2 为空后，再看 是否存在空 slot；如果有空 slot，探测序列到此结束直接返回；如果没有空 slot，继续下一个 group。</li>
<li>下面主要流程与小map一样，主要说在group查找与小map不一样的地方</li>
<li>大 map 删除时会 t.used-- 和 m.used--；如果该 group 里已有空 slot，删除位会被设为 ctrlEmpty，并且 t.growthLeft++；否则设为 ctrlDeleted。</li>
<li>并且table会有多个group，第一个group没探测到会探测下一个直到结束
<strong>table.Delete()</strong></li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *table)</span></span> Delete(typ *abi.SwissMapType, m *Map, hash <span class="hljs-type">uintptr</span>, key unsafe.Pointer) {
	seq := makeProbeSeq(h1(hash), t.groups.lengthMask)
	<span class="hljs-keyword">for</span> ; ; seq = seq.next() {
		g := t.groups.group(typ, seq.offset)
		match := g.ctrls().matchH2(h2(hash))
		<span class="hljs-keyword">for</span> match != <span class="hljs-number">0</span> {
			i := match.first()
			slotKey := g.key(typ, i)
			origSlotKey := slotKey
			<span class="hljs-keyword">if</span> typ.IndirectKey() {
				slotKey = *((*unsafe.Pointer)(slotKey))
			}
			<span class="hljs-keyword">if</span> typ.Key.Equal(key, slotKey) {
				t.used--
				m.used--
				<span class="hljs-keyword">if</span> typ.IndirectKey() {
					*(*unsafe.Pointer)(origSlotKey) = <span class="hljs-literal">nil</span>
				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> typ.Key.Pointers() {
					typedmemclr(typ.Key, slotKey)
				}

				slotElem := g.elem(typ, i)
				<span class="hljs-keyword">if</span> typ.IndirectElem() {
					*(*unsafe.Pointer)(slotElem) = <span class="hljs-literal">nil</span>
				} <span class="hljs-keyword">else</span> {
					typedmemclr(typ.Elem, slotElem)
				}
				<span class="hljs-keyword">if</span> g.ctrls().matchEmpty() != <span class="hljs-number">0</span> {
					g.ctrls().set(i, ctrlEmpty)
					t.growthLeft++
				} <span class="hljs-keyword">else</span> {
					g.ctrls().set(i, ctrlDeleted)
				}

				t.checkInvariants(typ, m)
				<span class="hljs-keyword">return</span>
			}
			match = match.removeFirst()
		}
		match = g.ctrls().matchEmpty()
		<span class="hljs-keyword">if</span> match != <span class="hljs-number">0</span> {
			<span class="hljs-keyword">return</span>
		}
	}
}
</code></pre>
<h3 data-id="heading-16">迭代器</h3>
<p><strong>map保证在遍历过程中同一 goroutine 下可改；并发写会触发 fatal对表进行修改，但不保证这些修改会在遍历中可见。</strong>
下面首先看迭代器的数据结构；</p>
<h4 data-id="heading-17">迭代器数据结构</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Iter <span class="hljs-keyword">struct</span> {
	key  unsafe.Pointer 
	elem unsafe.Pointer
	typ  *abi.SwissMapType
	m    *Map
	entryOffset <span class="hljs-type">uint64</span>
	dirOffset   <span class="hljs-type">uint64</span>
	clearSeq <span class="hljs-type">uint64</span>
	globalDepth <span class="hljs-type">uint8</span>
	dirIdx <span class="hljs-type">int</span>
	tab *table
	group groupReference
	entryIdx <span class="hljs-type">uint64</span>
}
</code></pre>
<ol>
<li>key 槽位对应的key</li>
<li>elem 槽位对应的elem</li>
<li>entryOffset 一个随机 slot 偏移开始遍历来打乱遍历顺序</li>
<li>dirOffset 目录的偏移量使用一个独立的 offset，因为目录增长时需要调整</li>
<li>clearSeq 用于检测遍历期间是否发生了 Clear</li>
<li>globalDepth 上一次调用 Next 时 Map.globalDepth 的值，用于检测遍历期间目录是否增长</li>
<li>dirIdx 当前目录索引，尚未应用 dirOffset 的调整。</li>
<li>tab  上一次调用 Next 时 dirIdx 对应的 table。</li>
<li>group 上一次调用 Next 时 entryIdx 对应的 group。</li>
<li>entryIdx 是当前 entry 的索引，尚未应用 entryOffset 的调整。index 的低 3 位是 slot 索引，高位是 group 索引。</li>
</ol>
<h4 data-id="heading-18">迭代的主流程如下</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mapIterStart</span><span class="hljs-params">(t *abi.SwissMapType, m *maps.Map, it *maps.Iter)</span></span> {
	it.Init(t, m)
	it.Next()
}
</code></pre>
<p>在map遍历时首先初始化一个迭代器</p>
<ol>
<li>当map为nil，或者为空时直接结束</li>
<li>如果map时小map时，将dirIdx设为-1，并将group设为map的dirPtr存放的数据</li>
<li>然后利用rand()分别设置entryOffset和dirOffset偏移和以及初始化其它参数
<strong>Iter.Init()</strong></li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(it *Iter)</span></span> Init(typ *abi.SwissMapType, m *Map) {
	it.typ = typ

	<span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> || m.used == <span class="hljs-number">0</span> {
		<span class="hljs-keyword">return</span>
	}

	dirIdx := <span class="hljs-number">0</span>
	<span class="hljs-keyword">var</span> groupSmall groupReference
	<span class="hljs-keyword">if</span> m.dirLen &lt;= <span class="hljs-number">0</span> {
		<span class="hljs-comment">// Use dirIdx == -1 as sentinel for small maps.</span>
		dirIdx = <span class="hljs-number">-1</span>
		groupSmall.data = m.dirPtr
	}

	it.m = m
	it.entryOffset = rand()
	it.dirOffset = rand()
	it.globalDepth = m.globalDepth
	it.dirIdx = dirIdx
	it.group = groupSmall
	it.clearSeq = m.clearSeq
}
</code></pre>
<p>初始化迭代器结束后进入迭代函数
该方法较长拆分解释：
首先看错误情况</p>
<ol>
<li>首先看m是否为nil，如果为nil则将迭代器的key和elem都设为nil，返回</li>
<li>如果在迭代过程有其他的协程在写map，则直接fatal返回</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(it *Iter)</span></span> Next() {
	<span class="hljs-keyword">if</span> it.m == <span class="hljs-literal">nil</span> {
		it.key = <span class="hljs-literal">nil</span>
		it.elem = <span class="hljs-literal">nil</span>
		<span class="hljs-keyword">return</span>
	}
	<span class="hljs-keyword">if</span> it.m.writing != <span class="hljs-number">0</span> {
		fatal(<span class="hljs-string">"concurrent map iteration and map write"</span>)
		<span class="hljs-keyword">return</span>
	}
	
	<span class="hljs-comment">//小map的迭代对应step1</span>
	<span class="hljs-keyword">if</span> it.dirIdx &lt; <span class="hljs-number">0</span> {
		<span class="hljs-comment">// Map was small at Init.</span>
		<span class="hljs-keyword">for</span> ; it.entryIdx &lt; abi.SwissMapGroupSlots; it.entryIdx++ {
			k := <span class="hljs-type">uintptr</span>(it.entryIdx+it.entryOffset) % abi.SwissMapGroupSlots

			<span class="hljs-keyword">if</span> (it.group.ctrls().get(k) &amp; ctrlEmpty) == ctrlEmpty {
				<span class="hljs-keyword">continue</span>
			}

			key := it.group.key(it.typ, k)
			<span class="hljs-keyword">if</span> it.typ.IndirectKey() {
				key = *((*unsafe.Pointer)(key))
			}

			grown := it.m.dirLen &gt; <span class="hljs-number">0</span>
			<span class="hljs-keyword">var</span> elem unsafe.Pointer
			<span class="hljs-keyword">if</span> grown {
				<span class="hljs-keyword">var</span> ok <span class="hljs-type">bool</span>
				newKey, newElem, ok := it.m.getWithKey(it.typ, key)
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">if</span> it.clearSeq == it.m.clearSeq &amp;&amp; !it.typ.Key.Equal(key, key) {
						elem = it.group.elem(it.typ, k)
						<span class="hljs-keyword">if</span> it.typ.IndirectElem() {
							elem = *((*unsafe.Pointer)(elem))
						}
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-keyword">continue</span>
					}
				} <span class="hljs-keyword">else</span> {
					key = newKey
					elem = newElem
				}
			} <span class="hljs-keyword">else</span> {
				elem = it.group.elem(it.typ, k)
				<span class="hljs-keyword">if</span> it.typ.IndirectElem() {
					elem = *((*unsafe.Pointer)(elem))
				}
			}

			it.entryIdx++
			it.key = key
			it.elem = elem
			<span class="hljs-keyword">return</span>
		}
		it.key = <span class="hljs-literal">nil</span>
		it.elem = <span class="hljs-literal">nil</span>
		<span class="hljs-keyword">return</span>
	}

	<span class="hljs-comment">//大map在迭代期间扩容对应step2</span>
	<span class="hljs-keyword">if</span> it.globalDepth != it.m.globalDepth {
		orders := it.m.globalDepth - it.globalDepth
		it.dirIdx &lt;&lt;= orders
		it.dirOffset &lt;&lt;= orders
		it.globalDepth = it.m.globalDepth
	}

	<span class="hljs-comment">//大map的迭代对应step3</span>
	<span class="hljs-keyword">for</span> ; it.dirIdx &lt; it.m.dirLen; it.nextDirIdx() {
		<span class="hljs-keyword">if</span> it.tab == <span class="hljs-literal">nil</span> {
			dirIdx := <span class="hljs-type">int</span>((<span class="hljs-type">uint64</span>(it.dirIdx) + it.dirOffset) &amp; <span class="hljs-type">uint64</span>(it.m.dirLen<span class="hljs-number">-1</span>))
			newTab := it.m.directoryAt(<span class="hljs-type">uintptr</span>(dirIdx))
			<span class="hljs-keyword">if</span> newTab.index != dirIdx {

				diff := dirIdx - newTab.index
				it.dirOffset -= <span class="hljs-type">uint64</span>(diff)
				dirIdx = newTab.index
			}
			it.tab = newTab
		}

		entryMask := <span class="hljs-type">uint64</span>(it.tab.capacity) - <span class="hljs-number">1</span>
		<span class="hljs-keyword">if</span> it.entryIdx &gt; entryMask {
			<span class="hljs-keyword">continue</span>
		}

		entryIdx := (it.entryIdx + it.entryOffset) &amp; entryMask
		slotIdx := <span class="hljs-type">uintptr</span>(entryIdx &amp; (abi.SwissMapGroupSlots - <span class="hljs-number">1</span>))
		<span class="hljs-keyword">if</span> slotIdx == <span class="hljs-number">0</span> || it.group.data == <span class="hljs-literal">nil</span> {

			groupIdx := entryIdx &gt;&gt; abi.SwissMapGroupSlotsBits
			it.group = it.tab.groups.group(it.typ, groupIdx)
		}

		<span class="hljs-keyword">if</span> (it.group.ctrls().get(slotIdx) &amp; ctrlEmpty) == <span class="hljs-number">0</span> {
			key := it.group.key(it.typ, slotIdx)
			<span class="hljs-keyword">if</span> it.typ.IndirectKey() {
				key = *((*unsafe.Pointer)(key))
			}

			grown := it.tab.index == <span class="hljs-number">-1</span>
			<span class="hljs-keyword">var</span> elem unsafe.Pointer
			<span class="hljs-keyword">if</span> grown {
				newKey, newElem, ok := it.grownKeyElem(key, slotIdx)
				<span class="hljs-keyword">if</span> !ok {

					<span class="hljs-keyword">goto</span> next
				} <span class="hljs-keyword">else</span> {
					key = newKey
					elem = newElem
				}
			} <span class="hljs-keyword">else</span> {
				elem = it.group.elem(it.typ, slotIdx)
				<span class="hljs-keyword">if</span> it.typ.IndirectElem() {
					elem = *((*unsafe.Pointer)(elem))
				}
			}

			it.entryIdx++
			it.key = key
			it.elem = elem
			<span class="hljs-keyword">return</span>
		}

	next:
		it.entryIdx++
		<span class="hljs-keyword">var</span> groupMatch bitset
		<span class="hljs-keyword">for</span> it.entryIdx &lt;= entryMask {
			entryIdx := (it.entryIdx + it.entryOffset) &amp; entryMask
			slotIdx := <span class="hljs-type">uintptr</span>(entryIdx &amp; (abi.SwissMapGroupSlots - <span class="hljs-number">1</span>))

			<span class="hljs-keyword">if</span> slotIdx == <span class="hljs-number">0</span> || it.group.data == <span class="hljs-literal">nil</span> {
				groupIdx := entryIdx &gt;&gt; abi.SwissMapGroupSlotsBits
				it.group = it.tab.groups.group(it.typ, groupIdx)
			}

			<span class="hljs-keyword">if</span> groupMatch == <span class="hljs-number">0</span> {
				groupMatch = it.group.ctrls().matchFull()

				<span class="hljs-keyword">if</span> slotIdx != <span class="hljs-number">0</span> {
					groupMatch = groupMatch.removeBelow(slotIdx)
				}

				<span class="hljs-keyword">if</span> groupMatch == <span class="hljs-number">0</span> {
					it.entryIdx += abi.SwissMapGroupSlots - <span class="hljs-type">uint64</span>(slotIdx)
					<span class="hljs-keyword">continue</span>
				}

				i := groupMatch.first()
				it.entryIdx += <span class="hljs-type">uint64</span>(i - slotIdx)
				<span class="hljs-keyword">if</span> it.entryIdx &gt; entryMask {
					<span class="hljs-keyword">continue</span>
				}
				entryIdx += <span class="hljs-type">uint64</span>(i - slotIdx)
				slotIdx = i
			}

			key := it.group.key(it.typ, slotIdx)
			<span class="hljs-keyword">if</span> it.typ.IndirectKey() {
				key = *((*unsafe.Pointer)(key))
			}

			grown := it.tab.index == <span class="hljs-number">-1</span>
			<span class="hljs-keyword">var</span> elem unsafe.Pointer
			<span class="hljs-keyword">if</span> grown {
				newKey, newElem, ok := it.grownKeyElem(key, slotIdx)
				<span class="hljs-keyword">if</span> !ok {
	
					groupMatch = groupMatch.removeFirst()
					<span class="hljs-keyword">if</span> groupMatch == <span class="hljs-number">0</span> {

						it.entryIdx += abi.SwissMapGroupSlots - <span class="hljs-type">uint64</span>(slotIdx)
						<span class="hljs-keyword">continue</span>
					}

					i := groupMatch.first()
					it.entryIdx += <span class="hljs-type">uint64</span>(i - slotIdx)
					<span class="hljs-keyword">continue</span>
				} <span class="hljs-keyword">else</span> {
					key = newKey
					elem = newElem
				}
			} <span class="hljs-keyword">else</span> {
				elem = it.group.elem(it.typ, slotIdx)
				<span class="hljs-keyword">if</span> it.typ.IndirectElem() {
					elem = *((*unsafe.Pointer)(elem))
				}
			}

			groupMatch = groupMatch.removeFirst()
			<span class="hljs-keyword">if</span> groupMatch == <span class="hljs-number">0</span> {

				it.entryIdx += abi.SwissMapGroupSlots - <span class="hljs-type">uint64</span>(slotIdx)
			} <span class="hljs-keyword">else</span> {

				i := groupMatch.first()
				it.entryIdx += <span class="hljs-type">uint64</span>(i - slotIdx)
			}

			it.key = key
			it.elem = elem
			<span class="hljs-keyword">return</span>
		}

	}

	it.key = <span class="hljs-literal">nil</span>
	it.elem = <span class="hljs-literal">nil</span>
	<span class="hljs-keyword">return</span>
}
</code></pre>
<p><strong>step1：</strong> 小map的迭代处理逻辑：
这段代码块逻辑也比较复杂拆开来讲
首先可以肯定的是it.dirIdx &lt; 0只有小map才会出现，并且此时entryIdx是为0
首先是获得迭代器取到的slot的key的逻辑</p>
<ol>
<li>使用entryIdx结合entryOffset 随机取到一个index，如果对应slot为空或者被删除则进行下一轮循环</li>
<li>否则取出index对应的key，如果slotkey存放的是指向key地址的指针则解引用</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> it.dirIdx &lt; <span class="hljs-number">0</span> {
<span class="hljs-keyword">for</span> ; it.entryIdx &lt; abi.SwissMapGroupSlots; it.entryIdx++ {
	k := <span class="hljs-type">uintptr</span>(it.entryIdx+it.entryOffset) % abi.SwissMapGroupSlots
	<span class="hljs-keyword">if</span> (it.group.ctrls().get(k) &amp; ctrlEmpty) == ctrlEmpty {
		<span class="hljs-keyword">continue</span>
	}
	key := it.group.key(it.typ, k)
	<span class="hljs-keyword">if</span> it.typ.IndirectKey() {
		key = *((*unsafe.Pointer)(key))
	}
</code></pre>
<p>然后是取slot key对应的slot elem的逻辑</p>
<ol>
<li>grown == false 时直接从旧 group 取 elem（必要时解引用）；grown == true 时必须 getWithKey 去新表取 newKey/newElem。</li>
<li>getWithKey 失败时的处理是：若 clearSeq 变了（发生 Clear）直接 continue；若 没 Clear 且 key != key（NaN 情况）才回退用旧 group 的 elem；否则 continue。</li>
<li>key != key 不仅限于纯 float key，结构体/数组里含 NaN 也会触发。</li>
<li>返回时会把 it.elem 和 it.key 设置好，并 entryIdx++。</li>
<li>循环结束直接将it.elem 和 it.key 设置 nil，并返回</li>
</ol>
<pre><code class="hljs language-go" lang="go">	grown := it.m.dirLen &gt; <span class="hljs-number">0</span>
	<span class="hljs-keyword">var</span> elem unsafe.Pointer
	<span class="hljs-keyword">if</span> grown {
		<span class="hljs-keyword">var</span> ok <span class="hljs-type">bool</span>
		newKey, newElem, ok := it.m.getWithKey(it.typ, key)
		<span class="hljs-keyword">if</span> !ok {
			<span class="hljs-keyword">if</span> it.clearSeq == it.m.clearSeq &amp;&amp; !it.typ.Key.Equal(key, key) {
				elem = it.group.elem(it.typ, k)
				<span class="hljs-keyword">if</span> it.typ.IndirectElem() {
					elem = *((*unsafe.Pointer)(elem))
				}
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">continue</span>
			}
		} <span class="hljs-keyword">else</span> {
			key = newKey
			elem = newElem
		}
	} <span class="hljs-keyword">else</span> {
		elem = it.group.elem(it.typ, k)
		<span class="hljs-keyword">if</span> it.typ.IndirectElem() {
			elem = *((*unsafe.Pointer)(elem))
		}
	}
	it.entryIdx++
	it.key = key
	it.elem = elem
	<span class="hljs-keyword">return</span>
	}
it.key = <span class="hljs-literal">nil</span>
it.elem = <span class="hljs-literal">nil</span>
<span class="hljs-keyword">return</span>
}
</code></pre>
<p><strong>step2：</strong> 在迭代大map之前 it.globalDepth != it.m.globalDepth （说明map在迭代时扩容目录）</p>
<ol>
<li>则将目录项和目录偏移按位数差左移，适配目录扩容后的索引空间。</li>
<li>将迭代器的globalDepth更新为新的globalDepth</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> it.globalDepth != it.m.globalDepth {
		orders := it.m.globalDepth - it.globalDepth
		it.dirIdx &lt;&lt;= orders
		it.dirOffset &lt;&lt;= orders
		it.globalDepth = it.m.globalDepth
	}
</code></pre>
<p><strong>step3：</strong> 大map的迭代</p>
<p>此代码块也较多拆解分析：首先开启一个for循环，迭代的时候使用nextDirIdx()跳过整个重复区间会按该 table 在目录中出现的次数来跳转</p>
<ol>
<li>如果it.tab为空则说明第一次迭代，首先根据dirIdx和dirOffset计算出table的index，然后得到对应table</li>
<li>如果table的index（在map的首个记录项）与dirIdx不同说明没有落在该table的起始目录项</li>
<li>则把 dirIdx 调回到该 table 的首个索引，并同步回退 dirOffset，保证后续迭代不会重复或错位。并将取出的table赋值给迭代器</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">for</span> ; it.dirIdx &lt; it.m.dirLen; it.nextDirIdx() {
	<span class="hljs-keyword">if</span> it.tab == <span class="hljs-literal">nil</span> {
		dirIdx := <span class="hljs-type">int</span>((<span class="hljs-type">uint64</span>(it.dirIdx) + it.dirOffset) &amp; <span class="hljs-type">uint64</span>(it.m.dirLen<span class="hljs-number">-1</span>))
		newTab := it.m.directoryAt(<span class="hljs-type">uintptr</span>(dirIdx))
		<span class="hljs-keyword">if</span> newTab.index != dirIdx {
			diff := dirIdx - newTab.index
			it.dirOffset -= <span class="hljs-type">uint64</span>(diff)
			dirIdx = newTab.index
		}
		it.tab = newTab
	}
</code></pre>
<p>如果entryidx已经超过该表的最大 entry 索引，就结束这张表，转到下一张表。</p>
<pre><code class="hljs language-go" lang="go">	entryMask := <span class="hljs-type">uint64</span>(it.tab.capacity) - <span class="hljs-number">1</span>
		<span class="hljs-keyword">if</span> it.entryIdx &gt; entryMask {
			<span class="hljs-keyword">continue</span>
		}
</code></pre>
<p>接着看快速处理路径</p>
<ol>
<li>首先根据it.entryIdx和entryOffset计算entryIdx（低三位用于slot，高位用于group）</li>
<li>然后根据entryIdx计算slotidx，在开始遍历这张表的第一次迭代时，需要计算一次group，slotidx从末尾绕到首位时说明开启下一组也需要计算一次group，计算group使用到了entryIdx</li>
<li>获得group后，对slotIdx的控制位进行判别是否为存在值的，如果不是则进入慢路径</li>
<li>如果存在值则进入if执行，首先根据slotIdx在group取出slotkey（如果是指向key指针解引用）</li>
<li>接着判断table是否触发扩容，倘若触发扩容去新表根据slotIdx取出newKey, newElem，如果取到赋值给key和elem，没取到则进入慢路径</li>
<li>若没扩容则直接去group取elem（如果是指向elem指针解引用）</li>
<li>最后给迭代器更新值，返回</li>
</ol>
<pre><code class="hljs language-go" lang="go">	entryIdx := (it.entryIdx + it.entryOffset) &amp; entryMask
	slotIdx := <span class="hljs-type">uintptr</span>(entryIdx &amp; (abi.SwissMapGroupSlots - <span class="hljs-number">1</span>))

	<span class="hljs-keyword">if</span> slotIdx == <span class="hljs-number">0</span> || it.group.data == <span class="hljs-literal">nil</span> {
		groupIdx := entryIdx &gt;&gt; abi.SwissMapGroupSlotsBits
		it.group = it.tab.groups.group(it.typ, groupIdx)
	}

	<span class="hljs-keyword">if</span> (it.group.ctrls().get(slotIdx) &amp; ctrlEmpty) == <span class="hljs-number">0</span> {
		key := it.group.key(it.typ, slotIdx)
		<span class="hljs-keyword">if</span> it.typ.IndirectKey() {
			key = *((*unsafe.Pointer)(key))
		}
		grown := it.tab.index == <span class="hljs-number">-1</span>
		<span class="hljs-keyword">var</span> elem unsafe.Pointer
		<span class="hljs-keyword">if</span> grown {
			newKey, newElem, ok := it.grownKeyElem(key, slotIdx)
			<span class="hljs-keyword">if</span> !ok {
				<span class="hljs-keyword">goto</span> next
			} <span class="hljs-keyword">else</span> {
				key = newKey
				elem = newElem
			}
		} <span class="hljs-keyword">else</span> {
			elem = it.group.elem(it.typ, slotIdx)
			<span class="hljs-keyword">if</span> it.typ.IndirectElem() {
				elem = *((*unsafe.Pointer)(elem))
			}
		}
		it.entryIdx++
		it.key = key
		it.elem = elem
		<span class="hljs-keyword">return</span>
	}
</code></pre>
<p>接着我们来看慢路径是怎么处理</p>
<ol>
<li>将entryIdx++（因为在前面流程中entryIdx游标没有取到值）</li>
<li>如果it.entryidx已经超过该表的最大 entry 索引，就结束这张表，转到下一张表。</li>
<li>否则进入匹配首先根据it.entryIdx和entryOffset计算entryIdx（低三位用于slot，高位用于group）</li>
<li>然后根据entryIdx计算slotidx，在开始遍历这张表的第一次迭代时，需要计算一次group，slotidx从末尾绕到首位时说明开启下一组也需要计算一次group，计算group使用到了entryIdx</li>
</ol>
<pre><code class="hljs language-go" lang="go">	next:
		it.entryIdx++
		<span class="hljs-keyword">var</span> groupMatch bitset
		<span class="hljs-keyword">for</span> it.entryIdx &lt;= entryMask {
			entryIdx := (it.entryIdx + it.entryOffset) &amp; entryMask
			slotIdx := <span class="hljs-type">uintptr</span>(entryIdx &amp; (abi.SwissMapGroupSlots - <span class="hljs-number">1</span>))

			<span class="hljs-keyword">if</span> slotIdx == <span class="hljs-number">0</span> || it.group.data == <span class="hljs-literal">nil</span> {
				groupIdx := entryIdx &gt;&gt; abi.SwissMapGroupSlotsBits
				it.group = it.tab.groups.group(it.typ, groupIdx)
			}
			<span class="hljs-comment">//..</span>
		
</code></pre>
<ol>
<li>对group寻找不为空的slot的位图（当第一次进入迭代时）</li>
<li>如果slotidx不为0则清除匹配得到位图的低位，只留下 slot i 及之后的位。</li>
<li>如果位图为0（无可用的slot），则跳过该group剩余槽位，转到下一轮循环</li>
<li>找到第一个可用slot，把线性游标前进到这个位置</li>
<li>如果游标超过表尾，下一轮处理回绕。</li>
<li>同步更新带 offset 的实际索引。以及更新slotIdx，后续就用去取 key/elem。</li>
</ol>
<pre><code class="hljs language-go" lang="go">	<span class="hljs-keyword">if</span> groupMatch == <span class="hljs-number">0</span> {
		groupMatch = it.group.ctrls().matchFull()
		<span class="hljs-keyword">if</span> slotIdx != <span class="hljs-number">0</span> {
			groupMatch = groupMatch.removeBelow(slotIdx)
		}
		<span class="hljs-keyword">if</span> groupMatch == <span class="hljs-number">0</span> {
			it.entryIdx += abi.SwissMapGroupSlots - <span class="hljs-type">uint64</span>(slotIdx)
			<span class="hljs-keyword">continue</span>
		}
		i := groupMatch.first()
		it.entryIdx += <span class="hljs-type">uint64</span>(i - slotIdx)
		<span class="hljs-keyword">if</span> it.entryIdx &gt; entryMask {
			<span class="hljs-keyword">continue</span>
		}
		entryIdx += <span class="hljs-type">uint64</span>(i - slotIdx)
		slotIdx = i
	}
</code></pre>
<ol>
<li>根据slotidx取到slotkey（如果是指向key的指针则解引用）</li>
<li>接着判断当前表在迭代时是否发生扩容，即（t.tab.index == -1（发生扩容时会将table的index设为-1）），没扩容的话直接在迭代器的group中取elem（如果是指向elem指针解引用）</li>
<li>扩容的话，去新table查询，查到则直接赋值</li>
<li>新table没查到的话，将位图第一个匹配的slot移除，接着判断位图是否还有值，没值的话将跳过该group剩余槽位，转到下一轮循;</li>
<li>如果位图还有值则接着取和更新游标</li>
<li>在前面取完值以后执行和新table没查到情况相同判断，不过此时已经去到值可以给elem和key赋值返回</li>
</ol>
<pre><code class="hljs language-go" lang="go">	key := it.group.key(it.typ, slotIdx)
	<span class="hljs-keyword">if</span> it.typ.IndirectKey() {
		key = *((*unsafe.Pointer)(key))
	}

	grown := it.tab.index == <span class="hljs-number">-1</span>
	<span class="hljs-keyword">var</span> elem unsafe.Pointer
	<span class="hljs-keyword">if</span> grown {
		newKey, newElem, ok := it.grownKeyElem(key, slotIdx)
		<span class="hljs-keyword">if</span> !ok {
			groupMatch = groupMatch.removeFirst()
			<span class="hljs-keyword">if</span> groupMatch == <span class="hljs-number">0</span> {
				it.entryIdx += abi.SwissMapGroupSlots - <span class="hljs-type">uint64</span>(slotIdx)
				<span class="hljs-keyword">continue</span>
			}
			i := groupMatch.first()
			it.entryIdx += <span class="hljs-type">uint64</span>(i - slotIdx)
			<span class="hljs-keyword">continue</span>
		} <span class="hljs-keyword">else</span> {
			key = newKey
			elem = newElem
		}
	} <span class="hljs-keyword">else</span> {
		elem = it.group.elem(it.typ, slotIdx)
		<span class="hljs-keyword">if</span> it.typ.IndirectElem() {
			elem = *((*unsafe.Pointer)(elem))
		}
	}

	groupMatch = groupMatch.removeFirst()
	<span class="hljs-keyword">if</span> groupMatch == <span class="hljs-number">0</span> {
		it.entryIdx += abi.SwissMapGroupSlots - <span class="hljs-type">uint64</span>(slotIdx)
	} <span class="hljs-keyword">else</span> {
		i := groupMatch.first()
		it.entryIdx += <span class="hljs-type">uint64</span>(i - slotIdx)
	}

	it.key = key
	it.elem = elem
	<span class="hljs-keyword">return</span>
	}
</code></pre>
<p>如果大map没取到值则返回nil，小map没取到值得情况在前面已经提前终止</p>
<pre><code class="hljs language-go" lang="go">	it.key = <span class="hljs-literal">nil</span>
	it.elem = <span class="hljs-literal">nil</span>
	<span class="hljs-keyword">return</span>
}
</code></pre>
<p>go 新存储方式map的解读到此结束，谢谢阅读！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微前端架构下的 Axios 请求封装：从 336 行耦合到 64 行薄 Wrapper 的重构之路]]></title>    <link>https://juejin.cn/post/7604775190212329482</link>    <guid>https://juejin.cn/post/7604775190212329482</guid>    <pubDate>2026-02-10T04:21:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604775190212329482" data-draft-id="7604775190212296714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微前端架构下的 Axios 请求封装：从 336 行耦合到 64 行薄 Wrapper 的重构之路"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-02-10T04:21:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大象的鼻子那么长"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821926871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微前端架构下的 Axios 请求封装：从 336 行耦合到 64 行薄 Wrapper 的重构之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821926871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大象的鼻子那么长
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.4 融会贯通
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.4 融会贯通" title="VIP.4 融会贯通" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:21:38.000Z" title="Tue Feb 10 2026 04:21:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    23
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>日期</strong>: 2026-02-10<br/>
<strong>适用场景</strong>: 微前端 / Monorepo / 多应用共享请求层</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、问题：为什么要重构 Axios 封装？</h2>
<p>在一个典型的企业级微前端项目中，主应用（Shell）和多个子应用都需要发起 HTTP 请求。最初的做法是每个应用各自封装一套 Axios 实例，但随着项目演进，问题逐渐暴露：</p>
<h3 data-id="heading-1">1.1 重复代码</h3>
<p>每个子应用都要实现一遍：</p>
<ul>
<li>Token 注入（Bearer Authorization）</li>
<li>Token 刷新 + 请求队列</li>
<li>错误码处理（400/401/500/901）</li>
<li>国际化错误消息</li>
<li>二进制响应处理（Blob 下载）</li>
</ul>
<p>一个完整的 Axios 封装通常 <strong>300+ 行</strong>，5 个子应用就是 1500+ 行重复代码。</p>
<h3 data-id="heading-2">1.2 深度耦合</h3>
<p>以我们主应用的 <code>service.ts</code>（336 行）为例，它直接依赖了：</p>
<pre><code class="hljs language-arduino" lang="arduino">service.ts 的依赖图谱
├── axios                    ← 纯库依赖 ✅
├── qs                       ← 纯库依赖 ✅
├── element-plus             ← UI 库 ❌
│   ├── ElMessage
│   ├── ElMessageBox
│   └── ElNotification
├── vue-i18n                 ← 国际化 ❌
│   └── i18n.global.<span class="hljs-built_in">t</span>()
├── @/utils/auth             ← 应用级 hooks ❌
│   ├── <span class="hljs-built_in">getAccessToken</span>()
│   ├── <span class="hljs-built_in">getRefreshToken</span>()
│   ├── <span class="hljs-built_in">setToken</span>()
│   └── <span class="hljs-built_in">removeToken</span>()
└── @/config/axios/config    ← 应用级配置 ❌
    ├── baseURL
    └── result_code
</code></pre>
<p><strong>6 个外部依赖中有 4 个是应用级的</strong>。这意味着你无法把这个文件直接搬到共享包里——它会把 Element Plus、vue-i18n、应用 Store 全部拖进来。</p>
<h3 data-id="heading-3">1.3 成功码不一致</h3>
<p>主应用后端返回 <code>code === 200</code> 表示成功，而某些微服务返回 <code>code === 0</code>。硬编码在拦截器里的成功码判断让共享变得更加困难。</p>
<hr/>
<h2 data-id="heading-4">二、设计思路：插件式拦截器架构</h2>
<h3 data-id="heading-5">2.1 核心原则</h3>
<blockquote>
<p><strong>Axios 封装层只做 HTTP 协议的事，应用逻辑通过插件注入。</strong></p>
</blockquote>
<p>这个原则来自 <strong>依赖倒置（DIP）</strong>：高层模块（Axios 封装）不应该依赖低层模块（Element Plus、vue-i18n），两者都应该依赖抽象（插件接口）。</p>
<pre><code class="hljs language-bash" lang="bash">传统架构（紧耦合）：
┌─────────────────────────────┐
│         service.ts          │
│  ┌───────┐ ┌──────┐ ┌────┐ │
│  │ElMsg  │ │i18n  │ │auth│ │
│  └───────┘ └──────┘ └────┘ │
└─────────────────────────────┘

插件式架构（松耦合）：
┌─────────────────────────────┐
│     @cmclink/api            │
│     createRequest()         │
│  ┌──────────────────────┐   │
│  │  Plugin Interfaces   │   │
│  │  AuthPlugin          │   │
│  │  I18nPlugin          │   │
│  │  UiPlugin            │   │
│  │  LogoutPlugin        │   │
│  └──────────────────────┘   │
└──────────┬──────────────────┘
           │ 注入
┌──────────▼──────────────────┐
│     apps/main               │
│  ┌───────┐ ┌──────┐ ┌────┐ │
│  │ElMsg  │ │i18n  │ │auth│ │
│  └───────┘ └──────┘ └────┘ │
└─────────────────────────────┘
</code></pre>
<h3 data-id="heading-6">2.2 四个插件接口</h3>
<p>我们把 336 行 <code>service.ts</code> 中的应用级依赖抽象为 4 个插件接口：</p>
<h4 data-id="heading-7">AuthPlugin — Token 管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthPlugin</span> {
  <span class="hljs-attr">getAccessToken</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">getRefreshToken</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>
  getTenantId?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">setToken</span>: <span class="hljs-function">(<span class="hljs-params">token: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-attr">removeToken</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
  refreshTokenUrl?: <span class="hljs-built_in">string</span>
}
</code></pre>
<p><strong>设计决策</strong>：为什么不直接传 <code>tokenKey</code> 让 Axios 自己从 localStorage 读？</p>
<p>因为不同应用的 Token 存储策略不同——有的用 <code>localStorage</code>，有的用 <code>sessionStorage</code>，有的用加密缓存（如 <code>web-storage-cache</code>）。通过函数接口，调用方完全控制存储实现。</p>
<h4 data-id="heading-8">I18nPlugin — 国际化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> I18nPlugin {
  <span class="hljs-attr">getLocale</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>
  <span class="hljs-attr">t</span>: <span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>
}
</code></pre>
<p><strong>设计决策</strong>：为什么只暴露 <code>getLocale</code> 和 <code>t</code>？</p>
<p>Axios 拦截器只需要两个能力：设置 <code>Accept-Language</code> 请求头（需要 locale），翻译错误消息（需要 <code>t</code>）。不需要暴露整个 i18n 实例。<strong>最小接口原则（ISP）</strong>。</p>
<h4 data-id="heading-9">UiPlugin — 错误提示</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UiPlugin</span> {
  <span class="hljs-attr">showMessage</span>: <span class="hljs-function">(<span class="hljs-params">msg: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">type</span>: <span class="hljs-string">'success'</span> | <span class="hljs-string">'warning'</span> | <span class="hljs-string">'error'</span> | <span class="hljs-string">'info'</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-attr">showConfirm</span>: <span class="hljs-function">(<span class="hljs-params">msg: <span class="hljs-built_in">string</span>, title: <span class="hljs-built_in">string</span>, options?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;
  <span class="hljs-attr">showNotification</span>: <span class="hljs-function">(<span class="hljs-params">msg: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">type</span>: <span class="hljs-string">'success'</span> | <span class="hljs-string">'warning'</span> | <span class="hljs-string">'error'</span> | <span class="hljs-string">'info'</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}
</code></pre>
<p><strong>设计决策</strong>：为什么用 <code>showMessage</code> 而不是直接传 <code>ElMessage</code>？</p>
<ol>
<li><strong>解耦 UI 库</strong>：子应用可能用 Ant Design Vue、Naive UI 或自定义组件</li>
<li><strong>可测试性</strong>：单元测试时可以传入 mock 函数</li>
<li><strong>SSR 安全</strong>：服务端渲染时不会引入浏览器 API</li>
</ol>
<h4 data-id="heading-10">LogoutPlugin — 登出处理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">LogoutPlugin</span> {
  <span class="hljs-attr">onUnauthorized</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
  onBeforeLogout?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
}
</code></pre>
<p><strong>设计决策</strong>：为什么要 <code>onBeforeLogout</code>？</p>
<p>我们的主应用有一个站内信轮询定时器，401 时需要先停止轮询再跳转登录页。这个 hook 让应用有机会做清理工作。</p>
<h3 data-id="heading-11">2.3 配置项设计</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AxiosRequestConfig</span> {
  resultCode?: <span class="hljs-built_in">number</span>          <span class="hljs-comment">// 业务成功码，默认 200</span>
  tenantEnable?: <span class="hljs-built_in">boolean</span>       <span class="hljs-comment">// 租户功能开关</span>
  headerTag?: <span class="hljs-built_in">string</span>           <span class="hljs-comment">// 环境标记</span>
  ignoreMsgs?: <span class="hljs-built_in">string</span>[]        <span class="hljs-comment">// 忽略的错误消息</span>
  whiteList?: <span class="hljs-built_in">string</span>[]         <span class="hljs-comment">// 无需 Token 的 URL</span>
  specialCodeUrls?: <span class="hljs-built_in">string</span>[]   <span class="hljs-comment">// 特殊 code 处理白名单</span>
  noPromptPages?: <span class="hljs-built_in">string</span>[]     <span class="hljs-comment">// 无需弹窗的页面路径</span>
  plugins?: <span class="hljs-title class_">RequestPlugins</span>     <span class="hljs-comment">// 插件集合</span>
}
</code></pre>
<p><strong>关键设计</strong>：<code>resultCode</code> 可配置。主应用传 <code>200</code>，子应用可以传 <code>0</code>，同一套拦截器逻辑适配不同后端约定。</p>
<hr/>
<h2 data-id="heading-12">三、技术细节</h2>
<h3 data-id="heading-13">3.1 Token 刷新 + 请求队列</h3>
<p>这是整个封装中最复杂的部分。当 Token 过期时，我们不能让所有并发请求都去刷新 Token，需要一个队列机制：</p>
<pre><code class="hljs language-css" lang="css">时间线：
Request <span class="hljs-selector-tag">A</span> → <span class="hljs-number">401</span> → 开始刷新 Token → 刷新成功 → 重试 <span class="hljs-selector-tag">A</span>
Request <span class="hljs-selector-tag">B</span> → <span class="hljs-number">401</span> → 加入队列等待   ─────────→ 重试 <span class="hljs-selector-tag">B</span>
Request C → <span class="hljs-number">401</span> → 加入队列等待   ─────────→ 重试 C
</code></pre>
<p>核心实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> isRefreshingToken = <span class="hljs-literal">false</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">requestQueue</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-function">(<span class="hljs-params">err?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt; = []

<span class="hljs-comment">// 响应拦截器中</span>
<span class="hljs-keyword">if</span> (code === <span class="hljs-number">401</span>) {
  <span class="hljs-comment">// 正在刷新，加入队列</span>
  <span class="hljs-keyword">if</span> (isRefreshingToken) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      requestQueue.<span class="hljs-title function_">push</span>(<span class="hljs-function">(<span class="hljs-params">err?: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) <span class="hljs-title function_">reject</span>(err)
        <span class="hljs-keyword">else</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">instance</span>(reqConfig))  <span class="hljs-comment">// 用新 Token 重试</span>
      })
    })
  }

  <span class="hljs-comment">// 执行刷新</span>
  <span class="hljs-keyword">try</span> {
    isRefreshingToken = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">post</span>(refreshUrl, {
      <span class="hljs-attr">refreshToken</span>: auth.<span class="hljs-title function_">getRefreshToken</span>()
    })
    auth.<span class="hljs-title function_">setToken</span>(res.<span class="hljs-property">data</span>)
    <span class="hljs-comment">// 通知队列中的请求重试</span>
    requestQueue.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>())
    requestQueue = []
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">instance</span>(reqConfig)
  } <span class="hljs-keyword">catch</span> (e) {
    requestQueue.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>(e))
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">handleUnauthorized</span>()
  } <span class="hljs-keyword">finally</span> {
    requestQueue = []
    isRefreshingToken = <span class="hljs-literal">false</span>
  }
}
</code></pre>
<p><strong>注意 <code>finally</code> 中的双重清理</strong>：即使 <code>catch</code> 中已经清理了队列，<code>finally</code> 仍然要再清一次，防止异常路径遗漏。</p>
<h3 data-id="heading-14">3.2 二进制响应处理</h3>
<p>文件下载接口返回 <code>Blob</code>，但如果后端返回了 JSON 错误（如权限不足），<code>Blob</code> 的 <code>type</code> 会是 <code>application/json</code>。我们需要检测这种情况：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (response.<span class="hljs-property">request</span>.<span class="hljs-property">responseType</span> === <span class="hljs-string">'blob'</span>) {
  <span class="hljs-keyword">if</span> (data <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Blob</span> &amp;&amp; data.<span class="hljs-property">type</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'application/json'</span>)) {
    <span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">text</span>()
    <span class="hljs-keyword">const</span> jsonData = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(text)
    <span class="hljs-keyword">if</span> (jsonData.<span class="hljs-property">success</span>) <span class="hljs-keyword">return</span> jsonData
    ui?.<span class="hljs-title function_">showMessage</span>(jsonData.<span class="hljs-property">msg</span> || <span class="hljs-string">'文件下载失败'</span>, <span class="hljs-string">'error'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(jsonData.<span class="hljs-property">msg</span>))
  }
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>  <span class="hljs-comment">// 正常的 Blob</span>
}
</code></pre>
<h3 data-id="heading-15">3.3 GET 参数编码</h3>
<p>Axios 默认的 <code>params</code> 序列化对嵌套对象支持不好。我们手动编码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (reqConfig.<span class="hljs-property">method</span>?.<span class="hljs-title function_">toUpperCase</span>() === <span class="hljs-string">'GET'</span> &amp;&amp; params) {
  <span class="hljs-keyword">let</span> url = reqConfig.<span class="hljs-property">url</span> + <span class="hljs-string">'?'</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> propName <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(params)) {
    <span class="hljs-keyword">const</span> value = params[propName]
    <span class="hljs-keyword">if</span> (value !== <span class="hljs-built_in">void</span> <span class="hljs-number">0</span> &amp;&amp; value !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span>) {
        <span class="hljs-comment">// 嵌套对象：propName[key]=value</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> val <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(value)) {
          url += <span class="hljs-built_in">encodeURIComponent</span>(propName + <span class="hljs-string">'['</span> + val + <span class="hljs-string">']'</span>) + <span class="hljs-string">'='</span>
            + <span class="hljs-built_in">encodeURIComponent</span>(value[val]) + <span class="hljs-string">'&amp;'</span>
        }
      } <span class="hljs-keyword">else</span> {
        url += <span class="hljs-string">`<span class="hljs-subst">${propName}</span>=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(value)}</span>&amp;`</span>
      }
    }
  }
  reqConfig.<span class="hljs-property">params</span> = {}
  reqConfig.<span class="hljs-property">url</span> = url.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)
}
</code></pre>
<h3 data-id="heading-16">3.4 密码过期特殊处理</h3>
<p>业务需求：密码过期时（<code>code === 1002000016</code>），不弹错误提示，而是返回完整 response 让业务层弹出修改密码弹窗。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (code === <span class="hljs-number">1002000016</span>) {
  <span class="hljs-keyword">return</span> response  <span class="hljs-comment">// 不走错误处理，让业务层决定</span>
}
</code></pre>
<p>这种"逃生舱"设计在企业级项目中很常见——总有一些特殊 code 需要业务层自己处理。<code>specialCodeUrls</code> 配置项也是同样的思路。</p>
<hr/>
<h2 data-id="heading-17">四、工厂模式 vs 单例模式</h2>
<h3 data-id="heading-18">4.1 为什么不用单例？</h3>
<p>早期版本我们在 <code>packages/api</code> 中导出了一个全局 <code>request</code> 单例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 单例模式 — 有问题</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> request = <span class="hljs-title function_">createRequest</span>({ <span class="hljs-attr">baseURL</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span> })
</code></pre>
<p>问题：</p>
<ol>
<li><strong>配置无法差异化</strong>：主应用和子应用的 <code>baseURL</code>、<code>resultCode</code>、<code>timeout</code> 可能不同</li>
<li><strong>插件无法注入</strong>：单例在模块加载时就创建了，此时 Element Plus、i18n 还没初始化</li>
<li><strong>测试困难</strong>：无法为不同测试用例创建独立的实例</li>
</ol>
<h3 data-id="heading-19">4.2 工厂模式</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 工厂模式</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createRequest</span> = (<span class="hljs-params">config: RequestConfig</span>) =&gt; { ... }
</code></pre>
<p>每个应用在自己的入口文件中调用 <code>createRequest()</code>，传入自己的配置和插件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/main/src/config/axios/index.ts — 仅 64 行</span>
<span class="hljs-keyword">import</span> { createRequest } <span class="hljs-keyword">from</span> <span class="hljs-string">'@cmclink/api'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">ElMessageBox</span>, <span class="hljs-title class_">ElNotification</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>
<span class="hljs-keyword">import</span> { i18n } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/plugins/vueI18n'</span>
<span class="hljs-keyword">import</span> { getAccessToken, getRefreshToken, ... } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth'</span>

<span class="hljs-keyword">const</span> request = <span class="hljs-title function_">createRequest</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_API_URL</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span>,
  <span class="hljs-attr">resultCode</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-attr">auth</span>: { getAccessToken, getRefreshToken, ... },
    <span class="hljs-attr">i18n</span>: { <span class="hljs-attr">getLocale</span>: <span class="hljs-function">() =&gt;</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">value</span>, <span class="hljs-attr">t</span>: <span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">t</span>(k) },
    <span class="hljs-attr">ui</span>: { <span class="hljs-attr">showMessage</span>: <span class="hljs-function">(<span class="hljs-params">msg, <span class="hljs-keyword">type</span></span>) =&gt;</span> <span class="hljs-title class_">ElMessage</span>[<span class="hljs-keyword">type</span>](msg), ... },
    <span class="hljs-attr">logout</span>: { <span class="hljs-attr">onUnauthorized</span>: <span class="hljs-function">() =&gt;</span> { <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span> } }
  }
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> request
</code></pre>
<p><strong>从 336 行到 64 行</strong>，减少 81%，且所有业务逻辑都在调用方可见。</p>
<h3 data-id="heading-20">4.3 API 模块也用工厂</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/api/src/modules/auth.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createAuthApi</span> = (<span class="hljs-params">request: RequestInstance</span>) =&gt; ({
  <span class="hljs-attr">login</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> request.<span class="hljs-title function_">post</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/system/v1/auth/login'</span>, data }),
  <span class="hljs-attr">logout</span>: <span class="hljs-function">() =&gt;</span> request.<span class="hljs-title function_">post</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/system/v1/auth/logout'</span> }),
})

<span class="hljs-comment">// 子应用使用</span>
<span class="hljs-keyword">import</span> { createRequest, createAuthApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@cmclink/api'</span>
<span class="hljs-keyword">const</span> request = <span class="hljs-title function_">createRequest</span>({ ... })
<span class="hljs-keyword">const</span> authApi = <span class="hljs-title function_">createAuthApi</span>(request)
<span class="hljs-keyword">await</span> authApi.<span class="hljs-title function_">login</span>({ <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">'123'</span> })
</code></pre>
<hr/>
<h2 data-id="heading-21">五、迁移策略：渐进式替换</h2>
<h3 data-id="heading-22">5.1 兼容性设计</h3>
<p>新的 <code>createRequest()</code> 返回的方法签名与旧的 <code>config/axios/index.ts</code> <strong>完全一致</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 旧 API（option-object 风格）</span>
request.<span class="hljs-title function_">get</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/users'</span>, <span class="hljs-attr">params</span>: { <span class="hljs-attr">page</span>: <span class="hljs-number">1</span> } })
request.<span class="hljs-title function_">post</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/users'</span>, <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'test'</span> } })
request.<span class="hljs-title function_">upload</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/file'</span>, <span class="hljs-attr">data</span>: formData })

<span class="hljs-comment">// 新 API — 完全相同</span>
request.<span class="hljs-title function_">get</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/users'</span>, <span class="hljs-attr">params</span>: { <span class="hljs-attr">page</span>: <span class="hljs-number">1</span> } })
request.<span class="hljs-title function_">post</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/users'</span>, <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'test'</span> } })
request.<span class="hljs-title function_">upload</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/file'</span>, <span class="hljs-attr">data</span>: formData })
</code></pre>
<p>这意味着 <strong>62 个 API 文件零改动</strong>。它们仍然 <code>import request from '@/config/axios'</code>，只是底层实现换了。</p>
<h3 data-id="heading-23">5.2 类型共享</h3>
<p>公共类型（<code>DictDataVO</code>、<code>FileUploadReqVO</code>、<code>UserVO</code>）迁移到 <code>@cmclink/api</code>，主应用改为 re-export：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/main/src/api/system/dict/dict.data.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">DictDataVO</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@cmclink/api'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">DictDataVO</span> }  <span class="hljs-comment">// re-export，消费方无感知</span>
</code></pre>
<p>子应用可以直接从 <code>@cmclink/api</code> 导入类型，无需重复定义。</p>
<h3 data-id="heading-24">5.3 渐进式路线</h3>









































<table><thead><tr><th>阶段</th><th>改动范围</th><th>风险</th><th>对消费方影响</th></tr></thead><tbody><tr><td>Phase 1</td><td>清理冗余 API</td><td>低</td><td>无</td></tr><tr><td>Phase 2</td><td>重写 <code>packages/api/request.ts</code></td><td>低</td><td>无（新代码）</td></tr><tr><td>Phase 3</td><td>替换 <code>config/axios/index.ts</code></td><td><strong>中</strong></td><td>无（接口不变）</td></tr><tr><td>Phase 4</td><td>类型迁移到共享包</td><td>低</td><td>无（re-export）</td></tr><tr><td>Phase 5</td><td>子应用接入</td><td>低</td><td>新应用直接用</td></tr></tbody></table>
<p><strong>Phase 3 是风险最高的一步</strong>——替换了请求层的核心实现。但由于接口签名完全兼容，实际影响范围可控。建议在替换后做以下验证：</p>
<ol>
<li>登录 → 获取 Token → 页面跳转</li>
<li>Token 过期 → 自动刷新 → 请求重试</li>
<li>刷新 Token 过期 → 弹窗提示重新登录</li>
<li>文件下载（Blob 响应）</li>
<li>文件上传（multipart/form-data）</li>
<li>多语言切换后请求头 <code>Accept-Language</code> 变化</li>
</ol>
<hr/>
<h2 data-id="heading-25">六、子应用接入指南</h2>
<h3 data-id="heading-26">6.1 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add @cmclink/api
</code></pre>
<h3 data-id="heading-27">6.2 创建请求实例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/request.ts</span>
<span class="hljs-keyword">import</span> { createRequest } <span class="hljs-keyword">from</span> <span class="hljs-string">'@cmclink/api'</span>

<span class="hljs-keyword">const</span> request = <span class="hljs-title function_">createRequest</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_API_URL</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span>,
  <span class="hljs-attr">resultCode</span>: <span class="hljs-number">200</span>,  <span class="hljs-comment">// 根据后端约定调整</span>

  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-attr">auth</span>: {
      <span class="hljs-comment">// 微前端场景：从主应用获取 Token</span>
      <span class="hljs-attr">getAccessToken</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">__MICRO_APP_TOKEN__</span>?.<span class="hljs-property">accessToken</span> || <span class="hljs-literal">null</span>,
      <span class="hljs-attr">getRefreshToken</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">__MICRO_APP_TOKEN__</span>?.<span class="hljs-property">refreshToken</span> || <span class="hljs-literal">null</span>,
      <span class="hljs-attr">setToken</span>: <span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> { <span class="hljs-variable language_">window</span>.<span class="hljs-property">__MICRO_APP_TOKEN__</span> = token },
      <span class="hljs-attr">removeToken</span>: <span class="hljs-function">() =&gt;</span> { <span class="hljs-variable language_">window</span>.<span class="hljs-property">__MICRO_APP_TOKEN__</span> = <span class="hljs-literal">null</span> },
    },
    <span class="hljs-comment">// i18n 和 ui 根据子应用技术栈注入</span>
    <span class="hljs-attr">i18n</span>: {
      <span class="hljs-attr">getLocale</span>: <span class="hljs-function">() =&gt;</span> navigator.<span class="hljs-property">language</span>,
      <span class="hljs-attr">t</span>: <span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key,  <span class="hljs-comment">// 子应用可以不做国际化</span>
    },
    <span class="hljs-attr">ui</span>: {
      <span class="hljs-attr">showMessage</span>: <span class="hljs-function">(<span class="hljs-params">msg, <span class="hljs-keyword">type</span></span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">type</span>}</span>] <span class="hljs-subst">${msg}</span>`</span>),
      <span class="hljs-attr">showConfirm</span>: <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">confirm</span>(msg)),
      <span class="hljs-attr">showNotification</span>: <span class="hljs-function">(<span class="hljs-params">msg, <span class="hljs-keyword">type</span></span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">type</span>}</span>] <span class="hljs-subst">${msg}</span>`</span>),
    },
    <span class="hljs-attr">logout</span>: {
      <span class="hljs-attr">onUnauthorized</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 通知主应用跳转登录页</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'UNAUTHORIZED'</span> }, <span class="hljs-string">'*'</span>)
      },
    },
  },
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> request
</code></pre>
<h3 data-id="heading-28">6.3 使用共享 API 模块</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createSystemApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@cmclink/api'</span>
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'./request'</span>

<span class="hljs-keyword">const</span> systemApi = <span class="hljs-title function_">createSystemApi</span>(request)

<span class="hljs-comment">// 获取字典数据</span>
<span class="hljs-keyword">const</span> dictList = <span class="hljs-keyword">await</span> systemApi.<span class="hljs-title function_">listSimpleDictData</span>()

<span class="hljs-comment">// 上传文件</span>
<span class="hljs-keyword">await</span> systemApi.<span class="hljs-title function_">uploadFile</span>({ file, <span class="hljs-attr">innerServiceName</span>: <span class="hljs-string">'bdt'</span>, <span class="hljs-attr">fileBusinessPoint</span>: <span class="hljs-string">'avatar'</span> })
</code></pre>
<h3 data-id="heading-29">6.4 使用共享类型</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">DictDataVO</span>, <span class="hljs-title class_">FileUploadReqVO</span>, <span class="hljs-title class_">SystemUserVO</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@cmclink/api'</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">dict</span>: <span class="hljs-title class_">DictDataVO</span> = { ... }
</code></pre>
<hr/>
<h2 data-id="heading-30">七、总结</h2>
<h3 data-id="heading-31">设计原则回顾</h3>





























<table><thead><tr><th>原则</th><th>体现</th></tr></thead><tbody><tr><td><strong>依赖倒置（DIP）</strong></td><td>Axios 封装依赖插件接口，不依赖具体 UI 库</td></tr><tr><td><strong>接口隔离（ISP）</strong></td><td>4 个小接口而非 1 个大接口</td></tr><tr><td><strong>开闭原则（OCP）</strong></td><td>新增错误处理逻辑只需扩展插件，不修改核心</td></tr><tr><td><strong>单一职责（SRP）</strong></td><td>每个插件只负责一个关切点</td></tr><tr><td><strong>工厂模式</strong></td><td><code>createRequest()</code> 支持多实例、差异化配置</td></tr></tbody></table>
<h3 data-id="heading-32">数据对比</h3>






























<table><thead><tr><th>指标</th><th>重构前</th><th>重构后</th></tr></thead><tbody><tr><td>main <code>config/axios/</code> 代码量</td><td>5 个文件，~450 行</td><td>2 个文件，~74 行</td></tr><tr><td>应用级依赖</td><td>4 个（Element Plus, i18n, auth, config）</td><td>0 个（全部通过插件注入）</td></tr><tr><td>子应用复用成本</td><td>复制粘贴 + 适配</td><td><code>pnpm add @cmclink/api</code> + 64 行配置</td></tr><tr><td>类型共享</td><td>各应用重复定义</td><td><code>import type { ... } from '@cmclink/api'</code></td></tr></tbody></table>
<h3 data-id="heading-33">一句话总结</h3>
<blockquote>
<p><strong>把 Axios 拦截器中的「做什么」和「怎么做」分离：<code>@cmclink/api</code> 定义「做什么」（Token 注入、错误处理、刷新队列），应用层通过插件告诉它「怎么做」（用 ElMessage 还是 console.warn，从 localStorage 还是 sessionStorage 读 Token）。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[单服务器Docker Redis缓存集群搭建及Spring Boot适配实践]]></title>    <link>https://juejin.cn/post/7604761524976877577</link>    <guid>https://juejin.cn/post/7604761524976877577</guid>    <pubDate>2026-02-10T04:03:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604761524976877577" data-draft-id="7604761524976861193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="单服务器Docker Redis缓存集群搭建及Spring Boot适配实践"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2026-02-10T04:03:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光蛋"/> <meta itemprop="url" content="https://juejin.cn/user/3537560778573467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            单服务器Docker Redis缓存集群搭建及Spring Boot适配实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3537560778573467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光蛋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:03:57.000Z" title="Tue Feb 10 2026 04:03:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">单服务器Docker Redis缓存集群搭建及Spring Boot适配实践</h2>
<p>缓存是微服务架构中提升性能、减轻数据库压力的核心，Redis凭借高性能成为主流方案。单节点Redis存在单点故障风险，主从+哨兵集群可实现读写分离与故障自动转移，保障高可用。</p>
<p>本文针对中小型项目单服务器场景，详细介绍Docker容器化搭建Redis主从+哨兵集群（统一目录运维）、Spring Boot用户缓存适配，补充缓存三大异常解决方案及故障排查，助力快速落地生产级缓存架构。</p>
<p><strong>摘要</strong>：针对单服务器部署场景，提出Docker容器化Redis主从+哨兵集群方案，解决单点故障、IP动态变化、配置兼容等问题；实现Spring Boot缓存服务适配，提供缓存穿透、击穿、雪崩解决方案，通过验证确保集群高可用。方案部署简单、运维便捷，适用于中小型项目生产落地。</p>
<p><strong>关键词</strong>：Docker；Redis主从集群；Redis哨兵；Spring Boot；缓存适配</p>
<hr/>
<h3 data-id="heading-1">一、单服务器Docker搭建Redis主从+哨兵集群（目录统一管理）</h3>
<h4 data-id="heading-2">1. 集群设计思路</h4>
<p>单服务器采用“不同端口模拟多节点”，结合Docker Compose一键编排，所有集群目录统一至<code>/docker/redis-ha-docker</code>，简化运维。节点规划贴合生产端口规范，具体如下：</p>
<ul>
<li>主节点（master）：6379端口（核心写节点，同步数据至从节点，负责数据持久化）</li>
<li>从节点1（slave1）：6380端口；从节点2（slave2）：6381端口（均为读节点，分担并发、冗余备份）</li>
<li>哨兵1-3：端口26379、26380、26381（监控节点，协同判断故障、执行故障转移，满足quorum=2）</li>
</ul>
<p>核心优势：哨兵冗余避免监控失效；主从读写分离提升并发；Docker环境隔离；目录统一便于运维；适配主节点IP动态变化，解决容器重启失联问题。</p>
<h4 data-id="heading-3">2. 环境准备</h4>
<p>确保服务器满足以下要求，避免部署失败：</p>
<ul>
<li>系统：CentOS 7/8或Ubuntu 20.04+，内存≥2GB；</li>
<li>组件：Docker≥20.10、Docker Compose≥2.10，启动并设置开机自启；</li>
<li>端口：放行6379、6380、6381、26379、26380、26381（防火墙、安全组同步配置）；</li>
<li>目录：执行命令创建统一结构，路径可调整但需保持后续配置一致：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /docker/redis-ha-docker/{master,slave1,slave2,sentinel1,sentinel2,sentinel3}
<span class="hljs-built_in">cd</span> /docker/redis-ha-docker
</code></pre>
<h4 data-id="heading-4">3. 编写Docker Compose文件（核心编排）</h4>
<p>在集群根目录创建<code>docker-compose.yml</code>，适配Redis 7.0.15，核心解决主节点IP动态变化问题，内容如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-comment"># 主节点</span>
  <span class="hljs-attr">redis-master:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7.0-alpine</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis-master</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6379:6379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./master/redis.conf:/etc/redis/redis.conf</span>  <span class="hljs-comment"># 路径对应redis-ha-docker下的master目录</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./master/data:/data</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-server</span> <span class="hljs-string">/etc/redis/redis.conf</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-attr">redis-network:</span>
        <span class="hljs-attr">aliases:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">redis-master</span>  

  <span class="hljs-comment"># 从节点1</span>
  <span class="hljs-attr">redis-slave1:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7.0-alpine</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis-slave1</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6380:6379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./slave1/redis.conf:/etc/redis/redis.conf</span>  <span class="hljs-comment"># 路径对应redis-ha-docker下的slave1目录</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./slave1/data:/data</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-server</span> <span class="hljs-string">/etc/redis/redis.conf</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-master</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-network</span>

  <span class="hljs-comment"># 从节点2</span>
  <span class="hljs-attr">redis-slave2:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7.0-alpine</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis-slave2</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6381:6379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./slave2/redis.conf:/etc/redis/redis.conf</span>  <span class="hljs-comment"># 路径对应redis-ha-docker下的slave2目录</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./slave2/data:/data</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-server</span> <span class="hljs-string">/etc/redis/redis.conf</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-master</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-network</span>

  <span class="hljs-comment"># 哨兵1 核心逻辑：1个哨兵检测到主节点故障→标记主观下线→询问其他哨兵→≥2个哨兵确认→标记客观下线→选举1个主导哨兵执行故障转移</span>
  <span class="hljs-attr">redis-sentinel1:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7.0-alpine</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis-sentinel1</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"26379:26379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./sentinel1/sentinel.conf:/etc/redis/sentinel.conf</span>  <span class="hljs-comment"># 路径对应redis-ha-docker下的sentinel1目录</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-sentinel</span> <span class="hljs-string">/etc/redis/sentinel.conf</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-master</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-slave1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-slave2</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-network</span>

  <span class="hljs-comment"># 哨兵2（与哨兵1、3配置一致，参与投票协商，不单独触发故障转移）</span>
  <span class="hljs-attr">redis-sentinel2:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7.0-alpine</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis-sentinel2</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"26380:26379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./sentinel2/sentinel.conf:/etc/redis/sentinel.conf</span>  <span class="hljs-comment"># 路径对应redis-ha-docker下的sentinel2目录</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-sentinel</span> <span class="hljs-string">/etc/redis/sentinel.conf</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-master</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-slave1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-slave2</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-network</span>

  <span class="hljs-comment"># 哨兵3（与哨兵1、2配置一致，quorum=2，需至少2个哨兵确认主节点故障才触发转移）</span>
  <span class="hljs-attr">redis-sentinel3:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7.0-alpine</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis-sentinel3</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"26381:26379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./sentinel3/sentinel.conf:/etc/redis/sentinel.conf</span>  <span class="hljs-comment"># 路径对应redis-ha-docker下的sentinel3目录</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-sentinel</span> <span class="hljs-string">/etc/redis/sentinel.conf</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-master</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-slave1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-slave2</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-network</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">redis-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<h4 data-id="heading-5">4. 编写各节点配置文件</h4>
<p>所有配置文件对应挂载目录创建，适配Redis 7.0.15，删除无效配置，确保集群稳定运行。</p>
<h5 data-id="heading-6">（1）主节点配置（./master/redis.conf）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">bind</span> 0.0.0.0
protected-mode no
port 6379
daemonize no  <span class="hljs-comment"># Docker环境必须设为no，避免容器退出</span>
pidfile /var/run/redis_6379.pid
logfile <span class="hljs-string">"redis_6379.log"</span>
<span class="hljs-built_in">dir</span> /data

<span class="hljs-comment"># 双重持久化，兼顾安全与性能</span>
rdbcompression <span class="hljs-built_in">yes</span>
save 900 1
save 300 10
save 60 10000
appendonly <span class="hljs-built_in">yes</span>
appendfsync everysec
replica-read-only <span class="hljs-built_in">yes</span>  <span class="hljs-comment"># 从节点只读，保证数据一致</span>
</code></pre>
<h5 data-id="heading-7">（2）从节点配置（./slave1/redis.conf、./slave2/redis.conf）</h5>
<p>两者配置一致，仅目录不同，核心添加主节点指向：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">bind</span> 0.0.0.0
protected-mode no
port 6379
daemonize no
pidfile /var/run/redis_6379.pid
logfile <span class="hljs-string">"redis_6379.log"</span>
<span class="hljs-built_in">dir</span> /data

replicaof redis-master 6379  <span class="hljs-comment"># 指向主节点别名，适配IP动态变化</span>
replica-read-only <span class="hljs-built_in">yes</span>

<span class="hljs-comment"># 持久化配置与主节点一致</span>
rdbcompression <span class="hljs-built_in">yes</span>
save 900 1
save 300 10
save 60 10000
appendonly <span class="hljs-built_in">yes</span>
appendfsync everysec
</code></pre>
<h5 data-id="heading-8">（3）哨兵配置（3个哨兵一致，以./sentinel1/sentinel.conf为例）</h5>
<pre><code class="hljs language-bash" lang="bash">port 26379
daemonize no
pidfile /var/run/redis-sentinel_26379.pid
logfile <span class="hljs-string">"sentinel_26379.log"</span>
<span class="hljs-built_in">dir</span> /data

<span class="hljs-comment"># 监控主节点，quorum=2（至少2个哨兵确认故障）</span>
sentinel monitor mymaster redis-master 6379 2

<span class="hljs-comment"># 核心兼容配置（适配Redis 7.0.15，解决解析报错）</span>
protected-mode no
sentinel resolve-hostnames <span class="hljs-built_in">yes</span>  <span class="hljs-comment"># 开启主机名解析</span>

<span class="hljs-comment"># 超时与故障转移配置</span>
sentinel config-epoch mymaster 0
sentinel leader-epoch mymaster 0
sentinel down-after-milliseconds mymaster 30000  <span class="hljs-comment"># 30秒无响应标记主观下线</span>
sentinel failover-timeout mymaster 180000  <span class="hljs-comment"># 故障转移超时3分钟</span>
sentinel parallel-syncs mymaster 1  <span class="hljs-comment"># 每次同步1个从节点，避免集群压力</span>
</code></pre>
<p>说明：3个哨兵配置分别放入对应目录，无需修改IP，均沿用主节点别名，彻底规避配置兼容及解析报错。</p>
<h4 data-id="heading-9">5. 集群启动与验证</h4>
<p>在<code>/docker/redis-ha-docker</code>目录执行以下命令，完成启动与验证，确保集群正常运行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键启动所有节点</span>
docker-compose up -d

<span class="hljs-comment"># 查看容器状态（确保所有容器Up）</span>
docker-compose ps

<span class="hljs-comment"># 验证主从关系（主节点应显示2个从节点）</span>
docker <span class="hljs-built_in">exec</span> -it redis-master redis-cli info replication

<span class="hljs-comment"># 验证哨兵状态（应显示监控1个主节点、2个从节点、3个哨兵）</span>
docker <span class="hljs-built_in">exec</span> -it redis-sentinel1 redis-cli -p 26379 info sentinel

<span class="hljs-comment"># 验证主节点IP动态变化适配（重启主节点后重新验证哨兵状态）</span>
docker restart redis-master
<span class="hljs-built_in">sleep</span> 10
docker <span class="hljs-built_in">exec</span> -it redis-sentinel1 redis-cli -p 26379 info sentinel
</code></pre>
<h4 data-id="heading-10">6. 故障转移测试</h4>
<p>测试故障转移功能，确保集群高可用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止主节点，模拟故障</span>
docker stop redis-master

<span class="hljs-comment"># 30秒后查询新主节点（应为slave1或slave2）</span>
docker <span class="hljs-built_in">exec</span> -it redis-sentinel1 redis-cli -p 26379 sentinel get-master-addr-by-name mymaster

<span class="hljs-comment"># 重启原主节点，验证其作为从节点重新加入集群</span>
docker start redis-master
docker <span class="hljs-built_in">exec</span> -it redis-master redis-cli info replication
</code></pre>
<hr/>
<h3 data-id="heading-11">二、Spring Boot用户缓存服务适配</h3>
<h4 data-id="heading-12">1. 配置文件修改（application.yml）</h4>
<p>核心配置哨兵节点地址，与Redis集群端口对应，确保服务正常连接集群：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">sentinel:</span>
      <span class="hljs-attr">master:</span> <span class="hljs-string">mymaster</span>  <span class="hljs-comment"># 与哨兵配置中主节点名称一致</span>
      <span class="hljs-attr">nodes:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span><span class="hljs-string">:26379,192.168.1.10:26380,192.168.1.10:26381</span>  <span class="hljs-comment"># 替换为服务器IP</span>
    <span class="hljs-attr">lettuce:</span>
      <span class="hljs-attr">pool:</span>
        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">2000ms</span>

<span class="hljs-attr">user:</span>
  <span class="hljs-attr">cache:</span>
    <span class="hljs-attr">expire:</span> <span class="hljs-number">3600</span>  <span class="hljs-comment"># 缓存默认过期时间1小时</span>
    <span class="hljs-attr">hot-user-ids:</span> <span class="hljs-number">1</span><span class="hljs-string">,2,3</span>  <span class="hljs-comment"># 热点用户ID，用于缓存优化</span>
</code></pre>
<h4 data-id="heading-13">2. Docker部署Spring Boot服务（可选）</h4>
<p>容器化部署服务，与Redis集群协同工作，步骤如下：</p>
<h5 data-id="heading-14">（1）编写Dockerfile</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">FROM</span> openjdk:<span class="hljs-number">8</span><span class="hljs-operator">-</span>jre<span class="hljs-operator">-</span>alpine
WORKDIR <span class="hljs-operator">/</span>app
<span class="hljs-keyword">COPY</span> target<span class="hljs-operator">/</span>redis<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-operator">-</span>cache<span class="hljs-number">-1.0</span><span class="hljs-number">.0</span>.jar app.jar
EXPOSE <span class="hljs-number">8080</span>
ENTRYPOINT ["java", "-jar", "app.jar"]
</code></pre>
<h5 data-id="heading-15">（2）打包与启动</h5>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 打包Spring Boot项目</span>
mvn clean <span class="hljs-keyword">package</span> -DskipTests

<span class="hljs-comment"># 构建镜像</span>
docker build -t user-cache-service:<span class="hljs-number">1.0</span> .

<span class="hljs-comment"># 启动容器，加入Redis集群网络</span>
docker run -d --name user-cache -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> &amp;<span class="hljs-comment">#xA  --network redis-network &amp;#xA  -e SPRING_REDIS_SENTINEL_NODES=192.168.1.10:26379,192.168.1.10:26380,192.168.1.10:26381 &amp;#xA  user-cache-service:1.0</span>
</code></pre>
<h4 data-id="heading-16">3. 服务验证</h4>
<p>访问接口验证缓存功能正常，确保适配无误：</p>
<ul>
<li>缓存命中/未命中：访问<code>http://服务器IP:8080/user/1</code>；</li>
<li>空值缓存：访问<code>http://服务器IP:8080/user/999</code>；</li>
<li>缓存更新：调用更新接口，验证缓存同步更新。</li>
</ul>
<h4 data-id="heading-17">4. 缓存三大异常解决方案（适配当前集群）</h4>
<p>针对缓存穿透、击穿、雪崩，结合Redis集群特性，提供可落地、无侵入解决方案，与业务逻辑兼容。</p>
<h5 data-id="heading-18">（1）缓存穿透</h5>
<p>问题：请求不存在的用户ID，穿透缓存直击数据库，导致数据库压力激增。</p>
<p>解决方案：空值缓存+布隆过滤器双兜底：</p>
<ol>
<li>空值缓存：查询数据库无结果时，缓存“null”标记（过期30秒），避免重复穿透；</li>
<li>布隆过滤器：项目启动时加载所有有效用户ID至Redis Set，请求先校验ID是否存在，不存在直接返回404。</li>
</ol>
<h5 data-id="heading-19">（2）缓存击穿</h5>
<p>问题：热点用户缓存过期瞬间，大量并发请求穿透至数据库。</p>
<p>解决方案：互斥锁+热点数据永不过期：</p>
<ol>
<li>互斥锁：缓存未命中时，通过Redis SetNx获取分布式锁，获取成功查询数据库更新缓存，失败则重试；</li>
<li>热点数据永不过期：针对配置中热点用户，后台定时（每1小时）刷新缓存，确保缓存始终有效。</li>
</ol>
<h5 data-id="heading-20">（3）缓存雪崩</h5>
<p>问题：大量缓存同时过期，或Redis集群故障，导致所有请求穿透至数据库，引发数据库雪崩。</p>
<p>解决方案：过期时间随机化+集群高可用+降级熔断：</p>
<ol>
<li>过期时间随机化：缓存设置基础过期时间+随机偏移量（10-60秒），避免缓存集中过期；</li>
<li>集群高可用：依托Redis主从+哨兵集群，主节点故障时哨兵自动切换新主节点，避免缓存服务中断；</li>
<li>降级熔断：通过Sentinel等组件监控数据库压力，压力过高时熔断缓存穿透请求，返回默认数据。</li>
</ol>
<hr/>
<h3 data-id="heading-21">三、常见故障排查与注意事项</h3>
<h4 data-id="heading-22">1. 常见故障排查</h4>
<ul>
<li>哨兵启动报错：检查配置文件，确保无Redis 7.0.15不支持的配置（如resolve-ip、known-master）；</li>
<li>主从同步失败：确认从节点配置中replicaof指向主节点别名，主从节点网络连通；</li>
<li>容器启动失败：查看容器日志（docker logs 容器名），排查配置挂载路径错误、端口冲突；</li>
<li>缓存适配失败：检查Spring Boot配置中哨兵节点地址、主节点名称，确保与集群一致。</li>
</ul>
<h4 data-id="heading-23">2. 注意事项</h4>
<ul>
<li>所有哨兵配置需完全一致，同步更新，避免哨兵协同异常；</li>
<li>目录路径、端口、网络别名需保持统一，避免配置混乱；</li>
<li>生产环境需定期备份Redis数据（挂载目录备份），避免数据丢失；</li>
<li>根据业务压力调整Redis连接池、过期时间等参数，优化性能。</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别让并发 Bug 毁掉你的系统：从 HR 项目实战聊聊数据库锁的正确姿势]]></title>    <link>https://juejin.cn/post/7604786493639589915</link>    <guid>https://juejin.cn/post/7604786493639589915</guid>    <pubDate>2026-02-10T04:45:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604786493639589915" data-draft-id="7604761524977041417" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别让并发 Bug 毁掉你的系统：从 HR 项目实战聊聊数据库锁的正确姿势"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-02-10T04:45:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不想起名字1111111"/> <meta itemprop="url" content="https://juejin.cn/user/4300945220705486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别让并发 Bug 毁掉你的系统：从 HR 项目实战聊聊数据库锁的正确姿势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4300945220705486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不想起名字1111111
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:45:39.000Z" title="Tue Feb 10 2026 04:45:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://cdn.jsdelivr.net/gh/gxj1134506645/img-bed@main/images/20260210113058246.png" alt="" loading="lazy"/></p>
<hr/>
<p>上周五下午，测试同事突然在群里甩出一张截图："同一个员工，怎么出现了两条转正申请？"</p>
<p>我心里一沉——这不就是经典的<strong>并发重复提交</strong>问题吗？</p>
<p>两个请求几乎同时到达服务器，各自查了一遍"有没有进行中的申请"，都查到"没有"，然后各自创建了一条。结果就是：一个员工，两条转正申请，审批人一脸懵。</p>
<p>这个 Bug 让我重新审视了项目中所有涉及"先查后写"的业务逻辑，最终用 <code>SELECT ... FOR UPDATE</code> 彻底解决了问题。今天就结合我们 HR 管理系统的真实代码，聊聊数据库锁到底怎么用、什么时候用、有哪些坑。</p>
<hr/>
<h2 data-id="heading-0">一、先搞清楚：为什么"先查后写"会出问题？</h2>
<p>很多业务逻辑都有这样的模式：</p>
<blockquote>
<p>先查询数据库，判断条件是否满足，再执行写入操作。</p>
</blockquote>
<p>比如：</p>
<ul>
<li>提交转正申请前，先查有没有进行中的申请</li>
<li>扣减库存前，先查库存够不够</li>
<li>转账前，先查余额是否充足</li>
</ul>
<p><strong>在单线程环境下，这完全没问题。</strong> 但在并发场景下，两个请求可能在"查"和"写"之间形成时间窗口：</p>
<pre><code class="hljs language-css" lang="css">请求<span class="hljs-selector-tag">A</span>：查询 → 没有重复申请 → 准备创建...
请求<span class="hljs-selector-tag">B</span>：查询 → 没有重复申请 → 准备创建...
请求<span class="hljs-selector-tag">A</span>：                              → 创建成功 ✓
请求<span class="hljs-selector-tag">B</span>：                              → 创建成功 ✓  ← 重复了！
</code></pre>
<p>这就是经典的 <strong>TOCTOU（Time of Check to Time of Use）</strong> 问题。查和写之间没有原子性保证，并发一来就翻车。</p>
<hr/>
<h2 data-id="heading-1">二、解决方案：SELECT ... FOR UPDATE</h2>
<p><code>SELECT ... FOR UPDATE</code> 是 MySQL InnoDB 引擎提供的<strong>悲观锁</strong>机制。它的核心语义很简单：</p>
<blockquote>
<p>在事务内执行 SELECT 时，对命中的行加排他锁（X 锁）。其他事务如果也想锁这些行，必须等当前事务结束。</p>
</blockquote>
<p>关键点：</p>
<ul>
<li>锁的是<strong>行</strong>，不是表（前提是命中了索引）</li>
<li>锁的释放时机是<strong>事务结束</strong>（COMMIT / ROLLBACK），不是语句结束</li>
<li>必须在事务中使用，否则语句执行完锁就没了，毫无意义</li>
</ul>
<p>加了锁之后，并发流程变成了这样：</p>
<pre><code class="hljs language-css" lang="css">请求<span class="hljs-selector-tag">A</span>：开启事务 → FOR UPDATE 锁定用户行 → 查询无重复 → 创建申请 → 提交事务，释放锁
请求<span class="hljs-selector-tag">B</span>：开启事务 → FOR UPDATE 锁定用户行 → 等待...（被阻塞）
请求<span class="hljs-selector-tag">B</span>：                                   → 拿到锁 → 查询发现已有申请 → 拒绝 → 回滚
</code></pre>
<p>"校验 + 创建"被串行化了，问题解决。</p>
<hr/>
<h2 data-id="heading-2">三、实战代码：HR 系统中的落地方案</h2>
<p>我们的 HR 系统后端使用 NestJS + Prisma + MySQL，涉及大量申请类业务：转正、离职、请假、加班、出差、补卡等。每一种申请都有防重复提交的需求。</p>
<p><strong>核心锁方法</strong>（<code>application.service.ts</code>）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 申请创建并发防护：锁定当前申请人行，确保"校验 + 创建"串行执行
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">lockApplicantRowForUpdate</span>(<span class="hljs-params">
  tx: Prisma.TransactionClient,
  applicantId: <span class="hljs-built_in">number</span>
</span>) {
  <span class="hljs-keyword">await</span> tx.<span class="hljs-property">$queryRaw</span><span class="hljs-string">`
    SELECT id FROM users WHERE id = <span class="hljs-subst">${<span class="hljs-built_in">BigInt</span>(applicantId)}</span> FOR UPDATE
  `</span>;
}
</code></pre>
<p>只有一行 SQL，但它是整个并发防护的基石。</p>
<p><strong>转正申请中的使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">createRegularizationApplication</span>(<span class="hljs-params">applicantId: <span class="hljs-built_in">number</span>, dto</span>) {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.$transaction(<span class="hljs-keyword">async</span> (tx) =&gt; {
    <span class="hljs-comment">// 第一步：锁定申请人行，阻塞同一用户的并发请求</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">lockApplicantRowForUpdate</span>(tx, applicantId);

    <span class="hljs-comment">// 第二步：业务校验（此时已经串行，不会有并发问题）</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> tx.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({ <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-title class_">BigInt</span>(applicantId) } });
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">assertEligibleForRegularizationApplication</span>(user);

    <span class="hljs-comment">// 第三步：防重复校验</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">assertNoDuplicateApplication</span>(tx, applicantId, <span class="hljs-string">'regularization'</span>);

    <span class="hljs-comment">// 第四步：创建申请记录</span>
    <span class="hljs-keyword">const</span> application = <span class="hljs-keyword">await</span> tx.<span class="hljs-property">application</span>.<span class="hljs-title function_">create</span>({ ... });
    <span class="hljs-keyword">return</span> application;
  });
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>这个模式在项目中被复用了 9 次</strong>，覆盖了所有申请类型：</p>





































<table><thead><tr><th>申请类型</th><th>防重口径</th></tr></thead><tbody><tr><td>转正申请</td><td>存在待审批/审批中时禁止；已通过则永久禁止</td></tr><tr><td>离职申请</td><td>存在待审批/审批中/已通过时禁止</td></tr><tr><td>请假申请</td><td>存在待审批/审批中时禁止</td></tr><tr><td>加班申请</td><td>存在待审批/审批中时禁止</td></tr><tr><td>出差申请</td><td>存在未闭环出差单时禁止</td></tr><tr><td>补卡申请</td><td>存在待审批/审批中时禁止</td></tr><tr><td>入职申请</td><td>身份证号不可重复</td></tr></tbody></table>
<p>每种申请的防重规则不同，但<strong>锁的策略完全一致</strong>：先锁用户行，再做业务校验，最后写入。</p>
<hr/>
<h2 data-id="heading-3">四、为什么锁 users 表而不是 applications 表？</h2>
<p>这是一个值得思考的设计决策。</p>
<p>我们锁的是 <code>users</code> 表的申请人行，而不是 <code>applications</code> 表。原因是：</p>
<p><strong>1. 防重校验的维度是"人"，不是"申请"</strong></p>
<p>业务规则是"同一个人不能重复提交某类申请"。锁的粒度应该和业务校验的粒度一致。</p>
<p><strong>2. 申请记录还不存在</strong></p>
<p>并发场景下，两个请求都还没创建申请记录，<code>applications</code> 表里根本没有可以锁的行。而 <code>users</code> 表的记录是确定存在的。</p>
<p><strong>3. 主键查询，锁粒度最小</strong></p>
<p><code>WHERE id = ? FOR UPDATE</code> 命中的是主键索引，InnoDB 只会锁定这一行，不会影响其他用户的操作。</p>
<hr/>
<h2 data-id="heading-4">五、踩坑记录：这些细节不注意就翻车</h2>
<h3 data-id="heading-5">坑 1：没有索引，行锁变表锁</h3>
<p>InnoDB 的行锁是基于索引实现的。如果 <code>WHERE</code> 条件没有命中索引，锁的范围会急剧扩大。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 命中主键索引，只锁一行（推荐）</span>
<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

<span class="hljs-comment">-- 没有索引的字段，可能锁大量行甚至全表（危险）</span>
<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'13800138000'</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
</code></pre>
<p><strong>建议：FOR UPDATE 的 WHERE 条件务必命中主键或唯一索引。</strong></p>
<h3 data-id="heading-6">坑 2：事务内做了耗时操作</h3>
<p>锁的持有时间 = 事务的持续时间。如果在事务内调用了外部 API、发送邮件、做复杂计算，锁就会被长时间持有，其他请求全部排队等待。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误示范：事务内调用外部服务</span>
<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.$transaction(<span class="hljs-keyword">async</span> (tx) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">lockApplicantRowForUpdate</span>(tx, applicantId);
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendEmailNotification</span>();  <span class="hljs-comment">// 可能耗时数秒，锁一直不释放！</span>
  <span class="hljs-keyword">await</span> tx.<span class="hljs-property">application</span>.<span class="hljs-title function_">create</span>({ ... });
});

<span class="hljs-comment">// 正确做法：事务内只做最小必要的数据库操作</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.$transaction(<span class="hljs-keyword">async</span> (tx) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">lockApplicantRowForUpdate</span>(tx, applicantId);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> tx.<span class="hljs-property">application</span>.<span class="hljs-title function_">create</span>({ ... });
});
<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendEmailNotification</span>();  <span class="hljs-comment">// 事务外发邮件</span>
</code></pre>
<p><strong>原则：锁内只做最小必要读写。</strong></p>
<h3 data-id="heading-7">坑 3：死锁</h3>
<p>多个事务交叉锁定不同资源时，可能产生死锁：</p>
<pre><code class="hljs language-css" lang="css">事务<span class="hljs-selector-tag">A</span>：锁用户<span class="hljs-number">1</span> → 等待锁用户<span class="hljs-number">2</span>...
事务<span class="hljs-selector-tag">B</span>：锁用户<span class="hljs-number">2</span> → 等待锁用户<span class="hljs-number">1</span>...
</code></pre>
<p>规避方法：</p>
<ul>
<li><strong>固定加锁顺序</strong>：比如总是按用户 ID 从小到大加锁</li>
<li><strong>缩短事务时间</strong>：减少锁持有时长</li>
<li><strong>做死锁重试</strong>：捕获死锁错误码，短暂等待后重试</li>
</ul>
<h3 data-id="heading-8">坑 4：RR 隔离级别下的间隙锁</h3>
<p>MySQL 默认的 <code>REPEATABLE READ</code> 隔离级别下，范围查询 + <code>FOR UPDATE</code> 会触发 Next-Key Lock，不仅锁记录本身，还会锁住记录之间的"间隙"。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 这条语句可能锁住的不只是 id=1001 的行</span>
<span class="hljs-comment">-- 还包括 id 在某个范围内的间隙</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> applications <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
</code></pre>
<p><strong>所以我们选择锁 users 表的主键行，等值主键查询的锁定范围最精确。</strong></p>
<hr/>
<h2 data-id="heading-9">六、FOR UPDATE 不是万能的</h2>
<p><code>SELECT ... FOR UPDATE</code> 很好用，但它有明确的边界：</p>
<p><strong>适合的场景：</strong></p>
<ul>
<li>单库事务内的资源竞争</li>
<li>有明确主键的并发串行化</li>
<li>库存扣减、余额变更、幂等防重</li>
</ul>
<p><strong>不适合的场景：</strong></p>
<ul>
<li>跨数据库、跨服务的分布式锁 → 用 Redis / ZooKeeper / etcd</li>
<li>高吞吐写热点（大量请求锁同一行）→ 考虑乐观锁或队列削峰</li>
<li>全局任务调度锁 → 用分布式锁中间件</li>
</ul>
<p><strong>选型速查：</strong></p>





















<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>事务内资源竞争，有明确主键</td><td><code>SELECT ... FOR UPDATE</code></td></tr><tr><td>冲突概率低，追求吞吐</td><td>乐观锁（version 字段）</td></tr><tr><td>跨服务全局互斥</td><td>Redis / ZK / etcd 分布式锁</td></tr></tbody></table>
<p>最终原则：<strong>先保证一致性，再优化性能。</strong></p>
<hr/>
<h2 data-id="heading-10">七、总结</h2>
<p>回到开头那个 Bug。修复方案其实就一行 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> ? <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
</code></pre>
<p>但要用好它，需要理解背后的原理：</p>
<ul>
<li><strong>为什么要锁</strong>：消除"先查后写"的并发时间窗口</li>
<li><strong>锁什么</strong>：锁业务校验维度对应的行，用主键命中索引</li>
<li><strong>锁多久</strong>：事务结束才释放，所以事务要尽可能短</li>
<li><strong>什么时候不用</strong>：跨服务场景、高吞吐热点、分布式协调</li>
</ul>
<p>数据库锁不是什么高深的技术，但它是保证数据一致性的最后一道防线。希望这篇文章能帮你在自己的项目中少踩一个坑。</p>
<hr/>
<p>欢迎关注公众号FishTech Notes，一块交流使用心得！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini CLI 中转站配置使用教程]]></title>    <link>https://juejin.cn/post/7604761524976664585</link>    <guid>https://juejin.cn/post/7604761524976664585</guid>    <pubDate>2026-02-10T03:16:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604761524976664585" data-draft-id="7604741630448599074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini CLI 中转站配置使用教程"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-02-10T03:16:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曦和"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545101406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini CLI 中转站配置使用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545101406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曦和
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:16:46.000Z" title="Tue Feb 10 2026 03:16:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Gemini CLI 中文使用指南</h2>
<h3 data-id="heading-1">基本介绍</h3>
<p>Gemini CLI 是谷歌提供的开源命令行 AI 工具，将 Gemini 的强大功能直接带入您的终端。它提供轻量级的 Gemini 访问方式，为您提供从提示到模型的最直接路径。通过设置中转站（代理），您可以在网络受限的情况下正常使用 Gemini CLI 服务。</p>
<h3 data-id="heading-2">🚀 为什么选择 Gemini CLI？</h3>
<ul>
<li><strong>🧠 强大的 Gemini 2.5 Pro</strong>：访问 100 万 token 上下文窗口</li>
<li><strong>🔧 内置工具</strong>：Google 搜索基础功能、文件操作、Shell 命令、网页抓取</li>
<li><strong>🔌 可扩展</strong>：支持 MCP（模型上下文协议）进行自定义集成</li>
<li><strong>💻 终端优先</strong>：专为在命令行中工作的开发者设计</li>
<li><strong>🛡️ 开源</strong>：Apache 2.0 许可证</li>
</ul>
<h3 data-id="heading-3">📦 安装方式</h3>
<h4 data-id="heading-4">快速安装</h4>
<h4 data-id="heading-5">使用 npx 即时运行（无需安装）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用官方仓库</span>
npx &lt;https://github.com/google-gemini/gemini-cli&gt;
</code></pre>
<h4 data-id="heading-6">使用 npm 全局安装</h4>
<pre><code class="hljs language-bash" lang="bash">npm install -g @google/gemini-cli
</code></pre>
<h4 data-id="heading-7">使用 Homebrew 安装（macOS/Linux）</h4>
<pre><code class="hljs language-bash" lang="bash">brew install gemini-cli
</code></pre>
<h4 data-id="heading-8">系统要求</h4>
<ul>
<li>Node.js 版本 20 或更高</li>
<li>macOS、Linux 或 Windows</li>
</ul>
<h3 data-id="heading-9">配置中转站（代理）使用</h3>
<h4 data-id="heading-10">1. 设置环境变量</h4>
<p>在使用中转站之前，您需要配置以下环境变量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 API 密钥</span>
<span class="hljs-built_in">export</span> GEMINI_API_KEY=sk-xxxxx

<span class="hljs-comment"># 设置 API 中转站地址</span>
<span class="hljs-built_in">export</span> GOOGLE_GEMINI_BASE_URL=https://api.88api.chat

<span class="hljs-comment">#cmd 使用下面这个</span>

<span class="hljs-built_in">set</span> GEMINI_API_KEY=sk-xxxxx
<span class="hljs-built_in">set</span> GOOGLE_GEMINI_BASE_URL=https://api.88api.chat
</code></pre>
<blockquote>
<p>注意：您也可以将这些环境变量添加到 <code>.bashrc</code>、<code>.zshrc</code> 或其他 shell 配置文件中，这样每次启动终端时都会自动设置这些变量。</p>
</blockquote>
<h3 data-id="heading-11">🚀 快速开始</h3>
<h4 data-id="heading-12">基本使用</h4>
<h4 data-id="heading-13">在当前目录启动</h4>
<pre><code class="hljs language-bash" lang="bash">gemini
</code></pre>
<h4 data-id="heading-14">包含多个目录</h4>
<pre><code class="hljs language-bash" lang="bash">gemini --include-directories ../lib,../docs
</code></pre>
<h4 data-id="heading-15">使用特定模型</h4>
<pre><code class="hljs language-bash" lang="bash">gemini -m gemini-2.5-flash
</code></pre>
<h4 data-id="heading-16">脚本非交互模式</h4>
<p>获取简单文本响应：</p>
<pre><code class="hljs language-bash" lang="bash">gemini -p <span class="hljs-string">"解释这个代码库的架构"</span>
</code></pre>
<p>获取结构化 JSON 输出：</p>
<pre><code class="hljs language-bash" lang="bash">gemini -p <span class="hljs-string">"解释这个代码库的架构"</span> --output-format json
</code></pre>
<h4 data-id="heading-17">快速示例</h4>
<h4 data-id="heading-18">启动新项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> new-project/
gemini
&gt; 为我编写一个 Discord 机器人，使用我提供的 FAQ.md 文件回答问题
</code></pre>
<h4 data-id="heading-19">分析现有代码</h4>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> &lt;https://github.com/google-gemini/gemini-cli&gt;
<span class="hljs-built_in">cd</span> gemini-cli
gemini
&gt; 给我一个昨天所有更改的摘要
</code></pre>
<h3 data-id="heading-20">📋 主要功能</h3>
<h4 data-id="heading-21">代码理解与生成</h4>
<ul>
<li>查询和编辑大型代码库</li>
<li>使用多模态能力从 PDF、图片或草图生成新应用</li>
<li>使用自然语言调试问题和故障排除</li>
</ul>
<h4 data-id="heading-22">自动化与集成</h4>
<ul>
<li>自动化操作任务，如查询拉取请求或处理复杂的变基操作</li>
<li>使用 MCP 服务器连接新功能</li>
<li>在脚本中非交互式运行以实现工作流自动化</li>
</ul>
<h4 data-id="heading-23">高级功能</h4>
<ul>
<li>使用内置 Google 搜索获取实时信息</li>
<li>对话检查点以保存和恢复复杂会话</li>
<li>自定义上下文文件（<a href="https://link.juejin.cn?target=http%3A%2F%2Fgemini.md%2F" target="_blank" title="http://gemini.md/" ref="nofollow noopener noreferrer">GEMINI.md</a>）为您的项目定制行为</li>
</ul>
<h3 data-id="heading-24">常用命令和功能示例</h3>
<h4 data-id="heading-25">探索代码库</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-quote">&gt; 描述这个系统架构的主要组成部分</span>
<span class="hljs-quote">&gt; 有哪些安全机制？</span>
<span class="hljs-quote">&gt; 为新开发者提供一份分步骤的入门文档</span>
</code></pre>
<h4 data-id="heading-26">处理现有代码</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">为 GitHub issue <span class="hljs-comment">#123 实现一个初稿</span></span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">帮我将这个代码库迁移到最新版本的 Java。先制定一个计划</span>
</code></pre>
<h4 data-id="heading-27">自动化工作流程</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-quote">&gt; 制作一个幻灯片，展示过去 7 天的 git 历史，按功能和团队成员分组</span>
<span class="hljs-quote">&gt; 制作一个全屏 Web 应用用于墙上显示，展示我们互动最多的 GitHub issues</span>
</code></pre>
<h4 data-id="heading-28">系统交互</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-quote">&gt; 将此目录中的所有图像转换为 png，并使用 exif 数据中的日期重命名它们</span>
<span class="hljs-quote">&gt; 按支出月份整理我的 PDF 发票</span>
</code></pre>
<h3 data-id="heading-29">GitHub 集成</h3>
<p>使用 <strong>Gemini CLI GitHub Action</strong> 将 Gemini CLI 直接集成到您的 GitHub 工作流中：</p>
<ul>
<li><strong>拉取请求审查</strong>：自动代码审查，提供上下文反馈和建议</li>
<li><strong>Issue 分类</strong>：基于内容分析自动标记和优先级排序 GitHub issues</li>
<li><strong>按需帮助</strong>：在 issues 和拉取请求中提及 <code>@gemini-cli</code> 获取调试、解释或任务委派的帮助</li>
<li><strong>自定义工作流</strong>：构建适合您团队需求的自动化、定时和按需工作流</li>
</ul>
<h3 data-id="heading-30">故障排除</h3>
<p>如果您在使用过程中遇到问题，可以参考以下几点：</p>
<ol>
<li>
<p><strong>检查环境变量是否正确设置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$GEMINI_API_KEY</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$GOOGLE_GEMINI_BASE_URL</span>
</code></pre>
</li>
<li>
<p><strong>检查网络连接是否稳定，中转站是否可访问</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">curl -I &lt;https://api.88api.chat&gt;
</code></pre>
</li>
<li>
<p><strong>查看是否有错误信息输出</strong>，这些信息通常会指示问题所在</p>
</li>
<li>
<p><strong>如果使用 SOCKS 代理</strong>，确保代理格式正确，例如 <code>socks5://&lt;user&gt;:&lt;pass&gt;@&lt;proxy&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><strong>使用内置命令报告问题</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 CLI 中直接报告 bug</span>
/bug
</code></pre>
</li>
</ol>
<h3 data-id="heading-31">发布版本说明</h3>
<h4 data-id="heading-32">预览版（Preview）</h4>
<p>每周二 UTC 23:59 发布新的预览版本。使用 <code>preview</code> 标签安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @google/gemini-cli@preview
</code></pre>
<h4 data-id="heading-33">稳定版（Stable）</h4>
<p>每周二 UTC 20:00 发布新的稳定版本。使用 <code>latest</code> 标签安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @google/gemini-cli@latest
</code></pre>
<h4 data-id="heading-34">每夜版（Nightly）</h4>
<p>每天 UTC 00:00 发布每夜版本。使用 <code>nightly</code> 标签安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @google/gemini-cli@nightly
</code></pre>
<h3 data-id="heading-35">MCP 服务器使用</h3>
<p>在 <code>~/.gemini/settings.json</code> 中配置 MCP 服务器以扩展 Gemini CLI 的自定义工具：</p>
<pre><code class="hljs language-perl" lang="perl">&gt; @github 列出我的开放拉取请求
&gt; @slack 向 <span class="hljs-comment">#dev 频道发送今天提交的摘要</span>
&gt; @database 运行查询查找不活跃用户
</code></pre>
<h3 data-id="heading-36">📚 相关资源</h3>
<ul>
<li><strong>官方路线图</strong>：查看即将推出的功能</li>
<li><strong>NPM 包</strong>：包注册表</li>
<li><strong>GitHub Issues</strong>：报告 bug 或请求功能</li>
<li><strong>安全建议</strong>：安全更新</li>
</ul>
<h3 data-id="heading-37">卸载</h3>
<p>如果您需要卸载 Gemini CLI，请参考官方的卸载指南。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[0.5 美元剥夺 3 万月薪：Agent 时代，你只是财务报表上的“带宽延迟”]]></title>    <link>https://juejin.cn/post/7604805226696228902</link>    <guid>https://juejin.cn/post/7604805226696228902</guid>    <pubDate>2026-02-10T04:40:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604805226696228902" data-draft-id="7604786493639573531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 0.5 美元剥夺 3 万月薪：Agent 时代，你只是财务报表上的“带宽延迟”"/> <meta itemprop="keywords" content="Agent,程序员"/> <meta itemprop="datePublished" content="2026-02-10T04:40:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Agions"/> <meta itemprop="url" content="https://juejin.cn/user/360295545187751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             0.5 美元剥夺 3 万月薪：Agent 时代，你只是财务报表上的“带宽延迟”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545187751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Agions
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:40:08.000Z" title="Tue Feb 10 2026 04:40:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>500 倍。</strong>
<strong>这是顶级 AI Agent (如 Devin/OpenClaw) 与人类初级开发者的成本差。</strong></p>
<p>别再谈什么“情感价值”或“软技能”了。
在近期 Q3 财报里，Klarna 仅用 350 万美元的 AI 投入，就替代了 700 名全职客服，节省了 4000 万美元的运营坏账。</p>
<p><strong>承认吧：作为“信息倒卖者”的你，正在成为公司系统里最昂贵的瓶颈。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">📉 1. 中间商的“大清洗”</h2>
<p>我们正在经历人类历史上最残酷的**“语义折现”<strong>。
所谓的中间商，本质上是</strong>在信息差中赚取延迟费的人**。</p>
<ul>
<li><strong>初级客服</strong>：在知识库与愤怒的用户之间，充当低速的语义网关。</li>
<li><strong>CRUD 程序员</strong>：在 StackOverflow 与业务需求之间，充当昂贵的代码搬运工。</li>
<li><strong>初级文案</strong>：在品牌调性与空白文档之间，充当高损耗的关键词解释器。</li>
</ul>
<p>在 Agent 面前，这些人的带宽太低、延迟太高，且维护成本极其不稳定。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph Human["🔴 传统人效瓶颈"]
        A[需求发起] --&gt; B(人类员工: 思考/开会/摸鱼)
        B --&gt; C[产出/代码]
        B -.-&gt;|隐藏成本| D[五险一金/情绪管理]
    end
    
    subgraph Agent["🟢 Agent 瞬时效率"]
        E[需求发起] --&gt; F{AI Agent}
        F --&gt; G[知识库读写]
        F --&gt; H[API 工具调用]
        G &amp; H --&gt; F
        F --&gt; I[产出/代码]
    end
    
    style B fill:#ffe6e6,stroke:#ff3333
    style F fill:#e6fffa,stroke:#00cc99
</code></pre>
<p><strong>看懂这张图了吗？</strong>
中间红色的框（人类），曾经是业务流转的必然。
但在今天，那个框叫 <strong>“沟通摩擦力” (Communication Friction)</strong>。</p>
<hr/>
<h2 data-id="heading-1">🌪️ 2. 管理成本的“非线性崩塌”</h2>
<p>大多数人忽略了一个真相：<strong>管理 1 个 Agent 的复杂度是 0，管理 1 个人的复杂度是无穷大。</strong></p>
<p>这就是 <strong>“管理折旧” (Management Depreciation)</strong>：</p>
<ul>
<li><strong>人类员工</strong>：你需要同步他的认知、考核他的 KPI、安抚他的情绪、忍受他的离职。这些全是业务的<strong>隐形负债</strong>。</li>
<li><strong>AI Agent</strong>：它只需要一个定义良好的 <strong>SOP</strong> 和一份 <strong>Tool Authorization</strong>。</li>
</ul>
<p>当 Agent 的 Pull Request 通过率达到 67% 时，它不仅仅是写代码比你快，它是它的<strong>生命周期管理成本 (LCC)</strong> 趋近于零。</p>
<hr/>
<h2 data-id="heading-2">🛡️ 3. 唯一的生存战：成为“数字牧羊人”</h2>
<p>这是否意味着我们都要失业？
<strong>不。这只是“打工仔”逻辑的终结。</strong></p>
<p>正如那行著名的注释：<code>// Agents are powerful, but they need a Driver.</code>
AI 擅长处理<strong>封闭任务</strong>的极限优化，但它在<strong>开放性决策</strong>上依然是盲目的。</p>
<p><strong>未来的职业护城河只有三条：</strong></p>
<ol>
<li><strong>定义目标</strong>：知道“为什么”要砌这堵墙，而不是“如何”砌砖。</li>
<li><strong>工作流重塑 (Workflow Architect)</strong>：将复杂的业务逻辑拆解为 Agent 可执行的协议（Protocol）。</li>
<li><strong>最终兜底 (Human in the Loop)</strong>：在 AI 产生幻觉、逻辑冲突或涉及法律伦理时，行使那一票否决权。</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant O as 👨‍💻 超级个体 (You)
    participant A as 🤖 Agent 集群
    participant M as 💰 市场需求
    
    O-&gt;&gt;A: 授权 &amp; 注入洞察 (SOP)
    A-&gt;&gt;A: 多机协作 &amp; 并发执行
    A--&gt;&gt;O: 异常上报 (Edge Cases)
    O-&gt;&gt;A: 决策 &amp; 兜底
    A-&gt;&gt;M: 极低成本交付
    M--&gt;&gt;O: 现金流直达
    
    Note right of O: 你不再是零件，你是系统的造物主
</code></pre>
<hr/>
<blockquote>
<p><strong>给你的最后一个警告：</strong>
<strong>如果你还在追求“把代码写得漂亮”，你就是在雕琢一块注定要碎掉的冰。</strong>
<strong>去学习如何设计那个冻冰的模具吧。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 AI 编程不再"失忆"：planning-with-files 插件完全指南]]></title>    <link>https://juejin.cn/post/7604805226696245286</link>    <guid>https://juejin.cn/post/7604805226696245286</guid>    <pubDate>2026-02-10T05:04:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604805226696245286" data-draft-id="7604784281956859942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 AI 编程不再&quot;失忆&quot;：planning-with-files 插件完全指南"/> <meta itemprop="keywords" content="AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-02-10T05:04:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小碗细面"/> <meta itemprop="url" content="https://juejin.cn/user/1618104611770958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 AI 编程不再"失忆"：planning-with-files 插件完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1618104611770958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小碗细面
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T05:04:28.000Z" title="Tue Feb 10 2026 05:04:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><h2 data-id="heading-0">让 AI 编程不再"失忆"：planning-with-files 插件完全指南</h2>
<blockquote>
<p><strong>GitHub 暴涨 11.7k Star！</strong> 复刻 Manus 核心秘诀的开源插件，让你的 AI 编程助手拥有持久化记忆能力</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c93e184786844caa9446179dbb7a595~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56KX57uG6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771304668&amp;x-signature=v8tWv7pBxGetULt%2BblcyAV0IvF8%3D" alt="planning-with-files" loading="lazy"/> <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e86d38eee7c34d689f033661b86e23b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56KX57uG6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771304668&amp;x-signature=5cDN3tukMI2i9kajT5W8kxvD29s%3D" alt="version" loading="lazy"/> <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11ee6e887be446e7967ffcd290abcc66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56KX57uG6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771304668&amp;x-signature=vQpMO7T6if%2BmvlaMG8qwPFsM6Jg%3D" alt="stars" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">前言：AI 编程的"失忆"困境</h3>
<p>你是否遇到过这样的场景：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">你: <span class="hljs-string">"帮我构建一个 Next.js 博客系统，支持 Markdown 和暗黑模式"</span>

<span class="hljs-symbol">AI:</span> <span class="hljs-string">"好的！让我开始..."</span> [进行 <span class="hljs-number">50</span>+ 次工具调用]

你: <span class="hljs-string">"等一下，我们的目标是支持 Markdown 吗？"</span>

<span class="hljs-symbol">AI:</span> <span class="hljs-string">"对不起，我有点迷失了...你能再提醒我一下要做什么吗？"</span>
</code></pre>
<p>这就是 AI 编程助手的核心问题：</p>






























<table><thead><tr><th>问题</th><th>症状</th><th>影响</th></tr></thead><tbody><tr><td><strong>易失记忆</strong></td><td>TodoWrite 工具在上下文重置后消失</td><td>下次会话从头开始</td></tr><tr><td><strong>目标漂移</strong></td><td>50+ 次工具调用后忘记原始目标</td><td>偏离用户需求</td></tr><tr><td><strong>隐藏错误</strong></td><td>失败没有被记录，反复踩坑</td><td>浪费时间和 tokens</td></tr><tr><td><strong>上下文堆砌</strong></td><td>所有信息塞进上下文</td><td>达到 token 上限</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">解决方案：Manus AI 的 20 亿美元秘密</h3>
<p>2025 年 12 月 29 日，<strong>Meta 以 20 亿美元收购了 Manus AI</strong>。这家公司在短短 8 个月内从启动到 1 亿美元营收，他们的秘密是什么？</p>
<blockquote>
<p><em>"Markdown 是我的'工作记忆'磁盘。由于我迭代式处理信息且活跃上下文有限，Markdown 文件作为笔记的草稿纸、进度的检查点、最终交付物的构建块。"</em>
— Manus AI</p>
</blockquote>
<p><strong>核心原理：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────┐
│                    传统模式 vs <span class="hljs-number">3</span>-<span class="hljs-built_in">File</span> 模式                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  传统模式:                        <span class="hljs-number">3</span>-<span class="hljs-built_in">File</span> 模式:               │
│  ┌─────────────┐                 ┌─────────────┐            │
│  │ 上下文窗口  │ ← 堆满 →      │ 上下文窗口  │ ← 只放当前需要│
│  │  (RAM)      │                 │  (RAM)      │            │
│  └─────────────┘                 └─────────────┘            │
│         ↓                              ↓                    │
│    ❌ 易失 (<span class="hljs-keyword">volatile</span>)              ✅ 持久 (persistent)      │
│    ❌ 有限 (limited)               ✅ 无限 (unlimited)       │
│                                                                 │
│                                   ↓                            │
│                            ┌─────────────┐                    │
│                            │ 文件系统    │                     │
│                            │  (Disk)     │                     │
│                            │ task_plan   │                     │
│                            │ findings    │                     │
│                            │ progress    │                     │
│                            └─────────────┘                     │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心公式：</strong></p>
<pre><code class="hljs language-ini" lang="ini">Context <span class="hljs-attr">Window</span> = RAM (易失、有限)
<span class="hljs-attr">Filesystem</span> = Disk (持久、无限)

→ 任何重要信息都写入磁盘
</code></pre>
<hr/>
<h3 data-id="heading-3">什么是 planning-with-files？</h3>
<p><strong>planning-with-files</strong> 是一个开源 Claude Code 插件，实现了 Manus AI 的<strong>三文件持久化规划模式</strong>。</p>
<h4 data-id="heading-4">核心机制：3-File 模式</h4>
<pre><code class="hljs language-scss" lang="scss">your-project/
├── task_plan<span class="hljs-selector-class">.md</span>    ← 阶段划分 + 进度追踪 (checkbox)
├── findings<span class="hljs-selector-class">.md</span>     ← 研究发现 + 技术决策 (知识库)
└── progress<span class="hljs-selector-class">.md</span>     ← 会话日志 + 测试结果 (时间线)
</code></pre>
<h4 data-id="heading-5">三大文件详解</h4>





























<table><thead><tr><th>文件</th><th>作用</th><th>更新时机</th><th>示例内容</th></tr></thead><tbody><tr><td><strong>task_plan.md</strong></td><td>任务分解和进度追踪</td><td>创建时 + 每次决策前</td><td>Phase 1: 初始化<br/>- [x] 创建项目<br/>- [ ] 配置 TS</td></tr><tr><td><strong>findings.md</strong></td><td>研究发现和技术决策</td><td>每两次查看操作后</td><td>## 技术选型<br/>- 选择 @mdx-js/loader<br/>- 原因：需要自定义插件</td></tr><tr><td><strong>progress.md</strong></td><td>会话日志和测试结果</td><td>会话结束时</td><td>### 2024-02-10<br/>- ✅ Phase 1 完成<br/>- ⚠️ 遇到 TS 配置问题</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">快速上手</h3>
<h4 data-id="heading-7">安装（三种方式）</h4>
<h5 data-id="heading-8">方式一：Claude Code 插件市场（推荐）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加插件</span>
/plugin marketplace add OthmanAdi/planning-with-files

<span class="hljs-comment"># 安装</span>
/plugin install planning-with-files@planning-with-files

<span class="hljs-comment"># 完成！现在可以使用：</span>
/plan          <span class="hljs-comment"># 开始规划</span>
/plan:status   <span class="hljs-comment"># 查看进度</span>
</code></pre>
<h5 data-id="heading-9">方式二：手动安装到本地 skills</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux</span>
<span class="hljs-built_in">cp</span> -r ~/.claude/plugins/cache/planning-with-files/planning-with-files/*/skills/planning-with-files ~/.claude/skills/

<span class="hljs-comment"># Windows (PowerShell)</span>
Copy-Item -Recurse -Path <span class="hljs-string">"<span class="hljs-variable">$env</span>:USERPROFILE\.claude\plugins\cache\planning-with-files\planning-with-files\*\skills\planning-with-files"</span> -Destination <span class="hljs-string">"<span class="hljs-variable">$env</span>:USERPROFILE\.claude\skills\"
</span></code></pre>
<h5 data-id="heading-10">方式三：其他 IDE</h5>








































<table><thead><tr><th>IDE</th><th>支持状态</th><th>安装方式</th></tr></thead><tbody><tr><td><strong>Gemini CLI</strong></td><td>✅ 完整支持</td><td>Agent Skills</td></tr><tr><td><strong>Cursor</strong></td><td>✅ 完整支持</td><td>Skills + Hooks</td></tr><tr><td><strong>OpenClaw</strong></td><td>✅ 完整支持</td><td>Workspace Skills</td></tr><tr><td><strong>Kiro</strong></td><td>✅ 完整支持</td><td>Steering Files</td></tr><tr><td><strong>Continue</strong></td><td>✅ 完整支持</td><td>Skills + Prompts</td></tr><tr><td><strong>Codex</strong></td><td>✅ 完整支持</td><td>Personal Skill</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">使用方法深度解析</h3>
<h4 data-id="heading-12">1. 三种启动命令</h4>
<h5 data-id="heading-13">命令一：<code>/plan</code> - 开始新规划（推荐）</h5>
<pre><code class="hljs language-bash" lang="bash">你: /plan

Claude: 太好了！让我们开始规划会话。

请描述您想要完成的任务，我会帮您：
1. 创建结构化的任务计划
2. 跟踪研究发现和中间结果
3. 记录进度和测试结果

您的任务是什么？

你: 我想用 Next.js 构建一个博客系统，需要支持 Markdown、暗黑模式和评论功能

Claude: 明白了！我将帮您构建 Next.js 博客系统。

正在创建规划文件...

✅ task_plan.md - 任务分解和进度追踪
✅ findings.md - 研究发现和技术决策
✅ progress.md - 会话日志和测试结果

现在让我们从 Phase 1 开始...
</code></pre>
<h5 data-id="heading-14">命令二：<code>/plan:status</code> - 查看当前进度</h5>
<pre><code class="hljs language-bash" lang="bash">你: /plan:status

Claude:
┌─────────────────────────────────────────┐
│  📋 当前规划状态                        │
├─────────────────────────────────────────┤
│  任务: Next.js 博客系统                 │
│  进度: ████████░░░░░░░░ 40%             │
│                                         │
│  ✅ Phase 1: 项目初始化                 │
│  ✅ Phase 2: 基础页面                   │
│  🔄 Phase 3: Markdown 支持 (进行中)     │
│  ⏳ Phase 4: 暗黑模式                   │
│  ⏳ Phase 5: 评论系统                   │
└─────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-15">命令三：<code>/planning-with-files:start</code> - 传统启动</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 兼容旧版本的启动方式</span>
/planning-with-files:start
<span class="hljs-comment"># 或简写</span>
/planning
</code></pre>
<hr/>
<h4 data-id="heading-16">2. 首次使用完整流程</h4>
<p><strong>Step 1: 命令触发</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">你: /plan</span>

<span class="hljs-section">Claude: 让我们设置您的规划会话！</span>
请描述您想要完成的任务...
</code></pre>
<p><strong>Step 2: AI 分析并创建文件</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Claude: 正在创建规划文件...</span>

✅ task_plan.md - 任务分解和进度追踪
✅ findings.md - 研究发现和技术决策
✅ progress.md - 会话日志和测试结果
</code></pre>
<p><strong>Step 3: 文件结构预览</strong></p>
<pre><code class="hljs language-ini" lang="ini">your-project/
├── task_plan.md
│   ├── Phase 1: 项目初始化
│   │   ├── <span class="hljs-section">[ ]</span> 创建 Next.js 项目
│   │   ├── <span class="hljs-section">[ ]</span> 配置 TypeScript
│   │   └── <span class="hljs-section">[ ]</span> 设置 ESLint/Prettier
│   ├── Phase 2: 基础页面
│   ├── Phase 3: Markdown 支持
│   └── ...
├── findings.md
│   └── <span class="hljs-comment">## 技术选型</span>
│       - 使用 next-mdx-renderer
│       - 使用 rehype 插件
└── progress.md
    └── <span class="hljs-comment">### 2024-02-10 14:30</span>
        - ✅ 创建项目骨架
        - 🔄 配置 TypeScript 中...
</code></pre>
<hr/>
<h4 data-id="heading-17">3. Hooks 自动化工作流（核心机制）</h4>
<p>planning-with-files 的魔力来自三个自动触发的 Hooks：</p>
<h5 data-id="heading-18">PreToolUse Hook - 决策前重读计划</h5>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────┐
│                     PreToolUse Hook                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  用户操作 → Hook 触发 → 读取 task_plan.md → AI 了解进度 → 执行 │
│                                                              │
│  示例场景:                                                   │
│  ─────────────────────────────────────────────────────────  │
│  用户: <span class="hljs-string">"添加评论功能"</span>                                         │
│                                                               │
│  Hook: 📋 读取 task_plan.md...                                │
│        Phase <span class="hljs-number">3</span> 还在进行中，Phase <span class="hljs-number">5</span> 是评论功能                 │
│        建议先完成 Phase <span class="hljs-number">3</span>                                     │
│                                                               │
│  AI: <span class="hljs-string">"我注意到 Phase 3 (Markdown 支持) 还未完成。            │
│       建议先完成 Markdown 渲染，再添加评论功能。              │
│       要继续 Phase 3 还是直接跳到 Phase 5？"</span>                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-19">PostToolUse Hook - 操作后提醒保存</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                    <span class="hljs-string">PostToolUse</span> <span class="hljs-string">Hook</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">AI</span> <span class="hljs-string">操作完成</span> <span class="hljs-string">→</span> <span class="hljs-string">Hook</span> <span class="hljs-string">检查计数</span> <span class="hljs-string">→</span> <span class="hljs-string">提醒保存</span> <span class="hljs-string">findings</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">示例场景:</span>                                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">─────────────────────────────────────────────────────────</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-attr">AI:</span> [<span class="hljs-string">读取了</span> <span class="hljs-number">2</span> <span class="hljs-string">个文件</span>]                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-attr">Hook:</span> <span class="hljs-string">📝</span> <span class="hljs-string">检测到连续</span> <span class="hljs-number">2</span> <span class="hljs-string">次查看操作</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>        <span class="hljs-string">建议将发现保存到</span> <span class="hljs-string">findings.md</span>                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-attr">AI:</span> <span class="hljs-string">"我查看了两个文档配置文件。                              │
│       我发现 next.config.js 需要 experimental 特性。         │
│       让我将这个发现记录到 findings.md..."</span>                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                              <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h5 data-id="heading-20">Stop Hook - 完成前验证</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                       <span class="hljs-string">Stop</span> <span class="hljs-string">Hook</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">用户退出</span> <span class="hljs-string">→</span> <span class="hljs-string">Hook</span> <span class="hljs-string">触发</span> <span class="hljs-string">→</span> <span class="hljs-string">检查所有</span> <span class="hljs-string">Phase</span> <span class="hljs-string">→</span> <span class="hljs-string">生成报告</span>            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">示例输出:</span>                                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">─────────────────────────────────────────────────────────</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">📊</span> <span class="hljs-string">会话完成报告</span>                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">任务完成度:</span> <span class="hljs-number">60</span><span class="hljs-string">%</span>                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">✅</span> <span class="hljs-string">已完成:</span>                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>     <span class="hljs-bullet">-</span> <span class="hljs-attr">Phase 1:</span> <span class="hljs-string">项目初始化</span> <span class="hljs-string">(3/3)</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>     <span class="hljs-bullet">-</span> <span class="hljs-attr">Phase 2:</span> <span class="hljs-string">基础页面</span> <span class="hljs-string">(2/2)</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">🔄</span> <span class="hljs-string">进行中:</span>                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>     <span class="hljs-bullet">-</span> <span class="hljs-attr">Phase 3:</span> <span class="hljs-string">Markdown</span> <span class="hljs-string">支持</span> <span class="hljs-string">(2/4)</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>       <span class="hljs-string">✓</span> <span class="hljs-string">已安装</span> <span class="hljs-string">next-mdx-renderer</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>       <span class="hljs-string">✓</span> <span class="hljs-string">已配置</span> <span class="hljs-string">rehype</span> <span class="hljs-string">插件</span>                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>       <span class="hljs-string">✗</span> <span class="hljs-string">待处理:</span> <span class="hljs-string">代码高亮</span>                                     <span class="hljs-string">│</span>
<span class="hljs-string">│</span>       <span class="hljs-string">✗</span> <span class="hljs-string">待处理:</span> <span class="hljs-string">图片优化</span>                                     <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">⏳</span> <span class="hljs-string">未开始:</span>                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>     <span class="hljs-bullet">-</span> <span class="hljs-attr">Phase 4:</span> <span class="hljs-string">暗黑模式</span>                                      <span class="hljs-string">│</span>
<span class="hljs-string">│</span>     <span class="hljs-bullet">-</span> <span class="hljs-attr">Phase 5:</span> <span class="hljs-string">评论系统</span>                                      <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">下次继续时使用:</span> <span class="hljs-string">/plan:status</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                              <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────┘</span>
</code></pre>
<hr/>
<h3 data-id="heading-21">最佳实践深度指南</h3>
<h4 data-id="heading-22">实践 1: 任务拆分的艺术</h4>
<p><strong>❌ 错误拆分 - 太粗糙</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## Phase 1: 开发博客</span>
<span class="hljs-bullet">-</span> [ ] 完成所有功能
</code></pre>
<p><strong>✅ 正确拆分 - 粒度适中</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## Phase 1: 项目初始化</span>
<span class="hljs-bullet">-</span> [ ] 创建 Next.js 项目 (使用 <span class="hljs-code">`npx create-next-app@latest`</span>)
<span class="hljs-bullet">-</span> [ ] 配置 TypeScript (启用严格模式)
<span class="hljs-bullet">-</span> [ ] 设置 ESLint 和 Prettier
<span class="hljs-bullet">-</span> [ ] 配置 Git (.gitignore, husky)

<span class="hljs-section">## Phase 2: 核心布局</span>
<span class="hljs-bullet">-</span> [ ] 创建 Layout 组件
<span class="hljs-bullet">-</span> [ ] 实现响应式导航栏
<span class="hljs-bullet">-</span> [ ] 添加暗黑模式切换
<span class="hljs-bullet">-</span> [ ] 配置全局样式

<span class="hljs-section">## Phase 3: Markdown 系统</span>
<span class="hljs-bullet">-</span> [ ] 选择 MDX 处理器
<span class="hljs-bullet">-</span> [ ] 实现代码高亮
<span class="hljs-bullet">-</span> [ ] 添加图片优化
<span class="hljs-bullet">-</span> [ ] 配置 frontmatter 解析
</code></pre>
<p><strong>拆分原则:</strong></p>
<ul>
<li>每个 Phase 2-6 个任务</li>
<li>每个任务 30 分钟 - 2 小时可完成</li>
<li>按逻辑依赖顺序排列</li>
<li>使用动词开头（创建、配置、实现）</li>
</ul>
<hr/>
<h4 data-id="heading-23">实践 2: Findings 的黄金结构</h4>
<p><strong>标准 findings.md 模板:</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Research Findings</span>

<span class="hljs-section">## 技术选型</span>
<span class="hljs-section">### MDX 处理器对比</span>
| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| next-mdx | 官方支持 | 功能有限 | ❌ 不够灵活 |
| next-mdx-enhanced | 功能丰富 | 维护较少 | ⚠️ 备选 |
| @mdx-js/loader | 生态成熟 | 配置复杂 | ✅ 选择此方案 |

<span class="hljs-strong">**决策原因:**</span> 需要自定义 rehype/recaka 插件

<span class="hljs-section">## 关键发现</span>
<span class="hljs-section">### Next.js 15 Breaking Changes</span>
<span class="hljs-bullet">-</span> <span class="hljs-code">`next/image`</span> 现在需要配置 domains
<span class="hljs-bullet">-</span> <span class="hljs-code">`getStaticPaths`</span> 改名为 <span class="hljs-code">`generateStaticParams`</span>
<span class="hljs-bullet">-</span> <span class="hljs-code">`next/link`</span> 不再需要 <span class="hljs-code">`&lt;a&gt;`</span> 包裹

<span class="hljs-section">### 性能优化点</span>
<span class="hljs-bullet">-</span> 使用 <span class="hljs-code">`dynamic`</span> import 减少初始 bundle
<span class="hljs-bullet">-</span> 图片使用 <span class="hljs-code">`next/image`</span> 自动优化
<span class="hljs-bullet">-</span> 启用 ISR 增量静态再生

<span class="hljs-section">## 遇到的问题</span>
<span class="hljs-section">### 问题 1: MDX 代码高亮不工作</span>
<span class="hljs-strong">**错误:**</span> SyntaxHighlighter 无法解析 TSX
<span class="hljs-strong">**原因:**</span> rehype-highlight 与 shiki 冲突
<span class="hljs-strong">**解决:**</span> 移除 rehype-highlight，只使用 shiki
<span class="hljs-strong">**命令:**</span> <span class="hljs-code">`npm uninstall rehype-highlight`</span>

<span class="hljs-section">## 待研究事项</span>
<span class="hljs-bullet">-</span> [ ] 评论系统集成 (Giscus vs Utterances)
<span class="hljs-bullet">-</span> [ ] RSS 订阅生成方案
<span class="hljs-bullet">-</span> [ ] 搜索功能实现
</code></pre>
<p><strong>Findings 书写原则:</strong></p>
<ul>
<li>✅ 使用表格对比，一目了然</li>
<li>✅ 记录失败原因和解决方案</li>
<li>✅ 标注决策原因</li>
<li>✅ 保留待办事项</li>
</ul>
<hr/>
<h4 data-id="heading-24">实践 3: 进度记录的最佳节奏</h4>
<p><strong>什么时候更新 progress.md?</strong></p>



































<table><thead><tr><th>触发条件</th><th>动作</th><th>示例</th></tr></thead><tbody><tr><td>完成 Phase 任务</td><td>打勾并记录</td><td><code>✅ 完成首页布局，耗时 45 分钟</code></td></tr><tr><td>遇到阻塞问题</td><td>详细记录问题</td><td><code>⚠️ ESLint 配置与 Prettier 冲突，需要解决</code></td></tr><tr><td>产生新想法</td><td>记录到 findings</td><td><code>💡 考虑使用 contentlayer 替代 MDX</code></td></tr><tr><td>发现 Bug</td><td>记录复现步骤</td><td><code>🐛 暗黑模式切换时页面闪烁</code></td></tr><tr><td>测试通过</td><td>记录测试覆盖</td><td><code>✅ 单元测试覆盖率达到 80%</code></td></tr></tbody></table>
<p><strong>进度记录模板:</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">### 2024-02-10 14:30 - Session 1</span>
<span class="hljs-strong">**目标:**</span> 完成项目初始化

<span class="hljs-strong">**完成事项:**</span>
<span class="hljs-bullet">-</span> ✅ 创建 Next.js 项目 (TypeScript 模板)
<span class="hljs-bullet">-</span> ✅ 配置 Tailwind CSS
<span class="hljs-bullet">-</span> ✅ 设置 Git 仓库

<span class="hljs-strong">**遇到的问题:**</span>
<span class="hljs-bullet">-</span> ⚠️ TypeScript 严格模式下 props 类型报错
<span class="hljs-bullet">  -</span> 解决: 添加 <span class="hljs-code">`interface Props`</span> 定义

<span class="hljs-strong">**时间消耗:**</span> 1.5 小时

<span class="hljs-strong">**下次继续:**</span> Phase 2 - 核心布局开发
</code></pre>
<hr/>
<h4 data-id="heading-25">实践 4: 会话恢复的正确姿势</h4>
<p><strong>场景：上下文满了，执行 <code>/clear</code></strong></p>
<p><strong>自动恢复流程:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Claude:</span> <span class="hljs-string">检测到之前的规划会话！</span>

<span class="hljs-string">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
<span class="hljs-string">📋</span> <span class="hljs-string">会话恢复报告</span>
<span class="hljs-string">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>

<span class="hljs-string">上次活动:</span> <span class="hljs-number">2024-02-10 </span><span class="hljs-number">16</span><span class="hljs-string">:45</span> <span class="hljs-string">(2小时前)</span>

<span class="hljs-string">任务进度:</span> <span class="hljs-string">████████░░░░░░░</span> <span class="hljs-number">40</span><span class="hljs-string">%</span>

<span class="hljs-string">✅</span> <span class="hljs-string">已完成阶段:</span>
   <span class="hljs-string">•</span> <span class="hljs-attr">Phase 1:</span> <span class="hljs-string">项目初始化</span> <span class="hljs-string">(4/4)</span>
   <span class="hljs-string">•</span> <span class="hljs-attr">Phase 2:</span> <span class="hljs-string">核心布局</span> <span class="hljs-string">(3/3)</span>

<span class="hljs-string">🔄</span> <span class="hljs-string">进行中阶段:</span>
   <span class="hljs-string">•</span> <span class="hljs-attr">Phase 3:</span> <span class="hljs-string">Markdown</span> <span class="hljs-string">支持</span> <span class="hljs-string">(2/4)</span>
     <span class="hljs-string">✓</span> <span class="hljs-string">MDX</span> <span class="hljs-string">处理器配置</span>
     <span class="hljs-string">✓</span> <span class="hljs-string">代码高亮设置</span>
     <span class="hljs-string">✗</span> <span class="hljs-string">图片优化</span> <span class="hljs-string">(待处理)</span>
     <span class="hljs-string">✗</span> <span class="hljs-string">Frontmatter</span> <span class="hljs-string">解析</span> <span class="hljs-string">(待处理)</span>

<span class="hljs-string">💡</span> <span class="hljs-string">最近发现:</span>
   <span class="hljs-string">•</span> <span class="hljs-string">next-mdx-enhanced</span> <span class="hljs-string">已停止维护</span>
   <span class="hljs-string">•</span> <span class="hljs-string">考虑迁移到</span> <span class="hljs-string">@mdx-js/loader</span>

<span class="hljs-string">🚧</span> <span class="hljs-string">未解决问题:</span>
   <span class="hljs-string">•</span> <span class="hljs-string">rehype</span> <span class="hljs-string">插件与</span> <span class="hljs-string">Next.js</span> <span class="hljs-string">冲突</span>

<span class="hljs-string">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>

<span class="hljs-string">是否继续</span> <span class="hljs-string">Phase</span> <span class="hljs-number">3</span> <span class="hljs-string">的工作？</span>
</code></pre>
<p><strong>恢复后的智能建议:</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">Claude: 根据进度记录，我建议：

<span class="hljs-bullet">1.</span> 优先处理 rehype 插件冲突
<span class="hljs-bullet">2.</span> 然后完成图片优化
<span class="hljs-bullet">3.</span> 最后实现 frontmatter 解析

要继续吗？还是想先看看 findings.md 了解之前的发现？
</code></pre>
<hr/>
<h4 data-id="heading-26">实践 5: 多项目并行管理</h4>
<p><strong>目录结构:</strong></p>
<pre><code class="hljs language-scss" lang="scss">├── project-<span class="hljs-selector-tag">a</span>/
│   ├── task_plan<span class="hljs-selector-class">.md</span>
│   ├── findings<span class="hljs-selector-class">.md</span>
│   └── progress<span class="hljs-selector-class">.md</span>
├── project-<span class="hljs-selector-tag">b</span>/
│   ├── task_plan<span class="hljs-selector-class">.md</span>
│   ├── findings<span class="hljs-selector-class">.md</span>
│   └── progress<span class="hljs-selector-class">.md</span>
└── project-c/
    ├── task_plan<span class="hljs-selector-class">.md</span>
    ├── findings<span class="hljs-selector-class">.md</span>
    └── progress<span class="hljs-selector-class">.md</span>
</code></pre>
<p><strong>切换项目时:</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 项目 A 工作中...</span>
你: 切换到项目 B

Claude: 明白，切换到 project-b。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📂 Project-B 状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

上次活动: 昨天 10:30

任务进度: ████████████████░ 80%

🔄 进行中: Phase 4 - API 集成

要继续吗？先快速看一下 plan 还是 findings？
</code></pre>
<hr/>
<h4 data-id="heading-27">实践 6: 团队协作模式</h4>
<p><strong>共享 findings.md:</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Team Findings</span>

<span class="hljs-section">## @Alice - 2024-02-10</span>
发现 Vercel 部署时环境变量问题...
[详细记录]

<span class="hljs-section">## @Bob - 2024-02-11</span>
修复了 Alice 的问题，需要添加 <span class="hljs-code">`.env.production`</span>...

<span class="hljs-section">## @Charlie - 2024-02-12</span>
基于 Alice 和 Bob 的发现，创建了部署脚本...
</code></pre>
<p><strong>Git 集成最佳实践:</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .gitignore</span>
task_plan.md.local  <span class="hljs-comment"># 个人任务顺序</span>
progress.md.local   <span class="hljs-comment"># 个人进度</span>

<span class="hljs-comment"># Git commit 前检查</span>
git diff task_plan.md  <span class="hljs-comment"># 查看计划变更</span>
git diff findings.md   <span class="hljs-comment"># 查看新增发现</span>
</code></pre>
<hr/>
<h4 data-id="heading-28">实践 7: 性能优化技巧</h4>
<p><strong>减少不必要的文件读取:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Hook 优化示例</span>
<span class="hljs-keyword">if</span> (action === <span class="hljs-string">'write_file'</span> &amp;&amp; file.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.md'</span>)) {
  <span class="hljs-comment">// 只在写入 Markdown 时提醒</span>
  <span class="hljs-title function_">remindToUpdateFindings</span>();
}

<span class="hljs-keyword">if</span> (action === <span class="hljs-string">'run_command'</span> &amp;&amp; command.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'test'</span>)) {
  <span class="hljs-comment">// 测试命令后记录结果</span>
  <span class="hljs-title function_">remindToLogTestResults</span>();
}
</code></pre>
<p><strong>智能缓存策略:</strong></p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    文件读取策略                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  task_plan<span class="hljs-selector-class">.md</span>    → 每次决策前读取 (PreToolUse Hook)          │
│  findings<span class="hljs-selector-class">.md</span>     → 每 <span class="hljs-number">2</span> 次操作后读取 (PostToolUse Counter)   │
│  progress<span class="hljs-selector-class">.md</span>     → 会话结束时读取 (Stop Hook)                │
│                                                              │
│  避免过度读取 → 节省 tokens                                  │
│  关键时刻读取 → 确保一致性                                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h4 data-id="heading-29">实践 8: 常见陷阱与避坑指南</h4>



































<table><thead><tr><th>陷阱</th><th>症状</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>过度规划</strong></td><td>花 1 小时写 plan，代码没写几行</td><td>10-15 分钟快速规划，边做边调整</td></tr><tr><td><strong>忽视 findings</strong></td><td>重复搜索相同问题</td><td>每次查资料后立即记录</td></tr><tr><td><strong>checkbox 恐惧</strong></td><td>不敢开始因为任务太多</td><td>先拆成 3 个大 Phase，细化再说</td></tr><tr><td><strong>完美主义</strong></td><td>findings 写得像博客</td><td>关键信息优先，格式可以粗糙</td></tr><tr><td><strong>不检查 status</strong></td><td>忘记进度</td><td>每 30 分钟 <code>/plan:status</code> 一次</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-30">实战对照表：传统方式 vs 3-File 模式</h3>








































<table><thead><tr><th>场景</th><th>传统方式</th><th>3-File 模式</th></tr></thead><tbody><tr><td><strong>中途退出</strong></td><td>❌ 下次从头解释</td><td>✅ <code>/plan:status</code> 快速恢复</td></tr><tr><td><strong>遇到错误</strong></td><td>❌ 重复犯相同错误</td><td>✅ findings.md 记录解决方案</td></tr><tr><td><strong>多步任务</strong></td><td>❌ AI 忘记原始目标</td><td>✅ task_plan.md 持续追踪</td></tr><tr><td><strong>研究发现</strong></td><td>❌ 散落在上下文中</td><td>✅ findings.md 结构化存储</td></tr><tr><td><strong>进度可视化</strong></td><td>❌ 无法直观看到</td><td>✅ checkbox 进度条</td></tr><tr><td><strong>团队交接</strong></td><td>❌ 口头解释很累</td><td>✅ 共享 findings 文档</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-31">使用场景决策树</h3>
<pre><code class="hljs language-bash" lang="bash">                    开始任务
                       │
                       ▼
              ┌────────────────┐
              │ 任务是否复杂？   │
              └────────────────┘
                 │          │
                否          是
                 │          │
                 ▼          ▼
          ┌──────────┐  ┌─────────────────┐
          │ 直接执行  │  │ 是否 &gt;3 步骤？   │
          │ 不用 plan │  └─────────────────┘
          └──────────┘     │          │
                          否          是
                           │          │
                           ▼          ▼
                    ┌──────────┐  ┌─────────────┐
                    │ 简单记录  │  │ 启动 /plan  │
                    │ todo list │  │ 3-File 模式 │
                    └──────────┘  └─────────────┘

示例判断:
• <span class="hljs-string">"修复一个 bug"</span>        → 直接执行
• <span class="hljs-string">"添加一个按钮"</span>        → 直接执行
• <span class="hljs-string">"重构一个组件"</span>        → 简单记录
• <span class="hljs-string">"构建完整功能模块"</span>    → /plan
• <span class="hljs-string">"研究新技术并实现"</span>    → /plan
• <span class="hljs-string">"多步骤系统集成"</span>      → /plan
</code></pre>
<hr/>
<h3 data-id="heading-32">社区生态与扩展</h3>
<p><strong>planning-with-files</strong> 已催生多个社区 Fork 项目：</p>

























<table><thead><tr><th>项目</th><th>作者</th><th>特色功能</th></tr></thead><tbody><tr><td><strong>devis</strong></td><td>@st01cs</td><td>面试优先工作流，<code>/devis:intv</code> 和 <code>/devis:impl</code> 命令</td></tr><tr><td><strong>multi-manus-planning</strong></td><td>@kmichels</td><td>多项目支持，SessionStart git 同步</td></tr><tr><td><strong>plan-cascade</strong></td><td>@Taoidle</td><td>多级任务编排，并行执行，多代理协作</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-33">常见问题解答</h3>
<p><strong>Q: 和内置 <code>/plan</code> 命令有什么区别？</strong></p>
<blockquote>
<p>A: 内置命令进入 plan mode 后退出，本插件持久化到文件，支持会话恢复和进度追踪。</p>
</blockquote>
<p><strong>Q: 支持 Windows 吗？</strong></p>
<blockquote>
<p>A: 完全支持！v2.2.0 开始提供 PowerShell 脚本。</p>
</blockquote>
<p><strong>Q: 会增加很多 token 消耗吗？</strong></p>
<blockquote>
<p>A: 不会。Hooks 只在关键时刻（决策前、写文件后、退出时）读取文件，相比传统模式反而更节省 tokens。</p>
</blockquote>
<p><strong>Q: 可以自定义模板吗？</strong></p>
<blockquote>
<p>A: 可以！修改 <code>~/.claude/plugins/.../templates/</code> 下的模板文件即可。</p>
</blockquote>
<p><strong>Q: 如何查看当前进度？</strong></p>
<blockquote>
<p>A: 使用 <code>/plan:status</code> 命令快速查看进度报告。</p>
</blockquote>
<hr/>
<h3 data-id="heading-34">快速参考卡片</h3>
<pre><code class="hljs language-bash" lang="bash">╔═══════════════════════════════════════════════════════════════╗
║           planning-with-files 快速参考                        ║
╠═══════════════════════════════════════════════════════════════╣
║                                                               ║
║  🚀 启动命令                                                  ║
║     /plan          开始新规划                                ║
║     /plan:status   查看当前进度                              ║
║                                                               ║
║  📁 三个文件                                                  ║
║     task_plan.md    ← 任务分解 + checkbox 进度               ║
║     findings.md     ← 研究发现 + 技术决策                     ║
║     progress.md     ← 会话日志 + 时间记录                     ║
║                                                               ║
║  🔄 Hooks 自动化                                              ║
║     PreToolUse    → 决策前重读 plan                          ║
║     PostToolUse   → 操作后提醒保存                           ║
║     Stop          → 退出前验证完成度                         ║
║                                                               ║
║  ⚡ 关键规则                                                  ║
║     1. 先创建 Plan，再开始执行                               ║
║     2. 每两次查看操作保存 findings                           ║
║     3. 所有错误必须记录原因                                  ║
║     4. 失败后改变方法，不要重复                              ║
║                                                               ║
║  ✅ 适合场景                                                 ║
║     ✓ 多步骤任务 (3+)                                        ║
║     ✓ 研究性任务                                             ║
║     ✓ 长周期项目                                             ║
║     ✓ 多次会话完成                                           ║
║                                                               ║
║  ❌ 不适合场景                                               ║
║     ✗ 简单问答                                               ║
║     ✗ 单文件编辑                                             ║
║     ✗ 快速查找                                               ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
</code></pre>
<hr/>
<h3 data-id="heading-35">总结</h3>
<p><strong>planning-with-files</strong> 通过 Manus AI 的三文件模式，解决了 AI 编程助手的核心痛点：</p>
<ol>
<li><strong>持久化记忆</strong> - 用文件系统作为 AI 的外部记忆</li>
<li><strong>进度可视化</strong> - checkbox 进度条清晰展示任务状态</li>
<li><strong>自动恢复</strong> - 上下文重置后无缝接续工作</li>
<li><strong>知识沉淀</strong> - findings.md 积累技术决策和经验</li>
<li>** Hooks 自动化** - 无需手动干预，智能追踪进度</li>
</ol>
<p><strong>核心理念：</strong></p>
<pre><code class="hljs language-ini" lang="ini">Context <span class="hljs-attr">Window</span> = RAM (易失、有限)
<span class="hljs-attr">Filesystem</span> = Disk (持久、无限)
→ 任何重要信息都写入磁盘
</code></pre>
<p><strong>立即开始：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键安装</span>
/plugin marketplace add OthmanAdi/planning-with-files
/plugin install planning-with-files@planning-with-files

<span class="hljs-comment"># 开始你的第一个规划会话</span>
/plan
</code></pre>
<p><strong>相关链接：</strong></p>
<ul>
<li>📦 GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOthmanAdi%2Fplanning-with-files" target="_blank" title="https://github.com/OthmanAdi/planning-with-files" ref="nofollow noopener noreferrer">OthmanAdi/planning-with-files</a></li>
<li>📖 文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOthmanAdi%2Fplanning-with-files%2Ftree%2Fmain%2Fdocs" target="_blank" title="https://github.com/OthmanAdi/planning-with-files/tree/main/docs" ref="nofollow noopener noreferrer">完整文档</a></li>
<li>💬 社区: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOthmanAdi%2Fplanning-with-files%2Fissues" target="_blank" title="https://github.com/OthmanAdi/planning-with-files/issues" ref="nofollow noopener noreferrer">提交 Issue 分享使用经验</a></li>
</ul>
<hr/>
<p><strong>文章标签：</strong> <code>#ClaudeCode</code> <code>#AI编程</code> <code>#开发工具</code> <code>#效率提升</code> <code>#Manus</code> <code>#上下文工程</code> <code>#开源项目</code></p>
<p><strong>如果这篇文章对你有帮助，欢迎点赞收藏，也欢迎在评论区分享你的使用经验！</strong></p>
<hr/>
<blockquote>
<p><strong>作者简介：</strong> 全栈开发者，专注于 AI 辅助编程工具的研究与实践。</p>
<p><strong>版权声明：</strong> 本文原创，转载请注明出处。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于DWS的向量计算功能实现简单的商品搜索推荐系统]]></title>    <link>https://juejin.cn/post/7604693038440218630</link>    <guid>https://juejin.cn/post/7604693038440218630</guid>    <pubDate>2026-02-10T03:33:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604693038440218630" data-draft-id="7604666872128110611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于DWS的向量计算功能实现简单的商品搜索推荐系统"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-02-10T03:33:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="华为云开发者联盟"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685605143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于DWS的向量计算功能实现简单的商品搜索推荐系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685605143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    华为云开发者联盟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:33:57.000Z" title="Tue Feb 10 2026 03:33:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文分享自华为云社区《<a href="https://link.juejin.cn?target=https%3A%2F%2Fbbs.huaweicloud.com%2Fblogs%2F470986%3Futm_source%3Djuejin%26utm_medium%3Dbbs-ex%26utm_campaign%3Dother%26utm_content%3Dcontent" target="_blank" title="https://bbs.huaweicloud.com/blogs/470986?utm_source=juejin&amp;utm_medium=bbs-ex&amp;utm_campaign=other&amp;utm_content=content" ref="nofollow noopener noreferrer">基于DWS的向量计算功能实现简单的商品搜索推荐系统</a>》</p>
<h2 data-id="heading-0">1. 前言</h2>
<ul>
<li>适用版本：【9.1.1.200（及以上）】</li>
</ul>
<p>在生成式 AI 与大模型（LLM）重塑技术栈的今天，数据处理的需求已经从单一的“精确匹配”转向了“语义理解”。传统的数据库系统在处理结构化数据（如订单金额、用户ID）方面表现完美，但在面对 AI 时代爆发的非结构化数据（文本、图像、音视频）时，基于关键词搜索的传统方式由于无法理解数据本身背后的“<strong>意思</strong>”从而显得力不从心。</p>
<p><strong>核心痛点</strong>：传统数据库本质上依赖精确匹配（exact match）或字段索引查询，缺少以“<strong>含义</strong>”为中心的模糊相似搜索能力。AI相关应用与推荐系统场景带来了海量向量检索需求，相似性搜索是核心需求，对向量数据库常见应用场景：</p>
<ul>
<li>
<p>以文搜图/以图搜图： 找到与输入图片最相似的图片</p>
</li>
<li>
<p>智能问答/RAG：在知识库中找到与用户问题最相关的文档片段</p>
</li>
<li>
<p>推荐系统：找到与用户兴趣向量最相似的商品</p>
</li>
</ul>
<p><strong>解决方案</strong>：DWS集成 pgvector(0.8.0) 插件，可插拔式加载，实现库内向量计算检索能力。</p>
<p><strong>定义</strong>： DWS向量计算并非独立的数据库系统，而是通过插件形式扩展传统数据库功能，使其能够处理高维向量数据，无需用户迁徙数据或重构应用架构，即可在现有系统中实现向量检索相关功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e24ff525f904d07952ac318a1fa47b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5Li65LqR5byA5Y-R6ICF6IGU55uf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299239&amp;x-signature=cfx7MSdJQj7Aot7oF%2FV2I97I56Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. DWS向量计算功能简介</h2>
<p>1、向量数据类型：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a16a404052d24cab850e0159c3326d5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5Li65LqR5byA5Y-R6ICF6IGU55uf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299239&amp;x-signature=uIqOsx4NXYY0UKv8dzE3p6wiYvE%3D" alt="" loading="lazy"/></p>
<p>2、向量距离/相似度操作符</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae3e5e05399a4753b31d7d679d855a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5Li65LqR5byA5Y-R6ICF6IGU55uf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299239&amp;x-signature=obwM2RaZGRjRUmnoYN4pcRDmcKk%3D" alt="" loading="lazy"/></p>
<p>3、索引类型：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f83382b508e4e40bfd0d363d0cfd689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5Li65LqR5byA5Y-R6ICF6IGU55uf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299239&amp;x-signature=d%2Fey3jWA9v%2BODco9%2BBVJx8iKdcY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3. 完整示例</h2>
<p>假设我们正在做一个商品推荐搜索系统：</p>
<ul>
<li>
<p>商品本身有标题、描述、分类、价格等字段</p>
</li>
<li>
<p>借助大模型embedding能力，我们能够将商品描述编码为向量</p>
</li>
<li>
<p>同样的，将用户的搜索关键字也转化为向量</p>
</li>
<li>
<p><strong>目的</strong>：通过<strong>相似性</strong>搜索找出最符合用户<strong>搜索意图</strong>的商品</p>
</li>
</ul>
<blockquote>
<p>如需使用向量计算功能，请联系技术支持修改feature_support_options参数, 开启enable_pgvector选项。详细语法介绍，请参考DWS产品文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.huaweicloud.com%2Fdevg-911-dws%2Fdws_04_1462.html" target="_blank" title="https://support.huaweicloud.com/devg-911-dws/dws_04_1462.html" ref="nofollow noopener noreferrer">向量计算</a>章节</p>
</blockquote>
<h3 data-id="heading-3">3.1 基础查询</h3>
<ol>
<li>
<p>安装扩展：</p>
<pre><code class="hljs language-ini" lang="ini">create extension pgvector<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p>创建商品表，储存向量embedding：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (    id bigserial <span class="hljs-keyword">PRIMARY</span> KEY,    title text,    description text,    price <span class="hljs-type">numeric</span>,    embedding vector(<span class="hljs-number">768</span>)   <span class="hljs-comment">--768维向量，由商品描述(description)生成);</span>
</code></pre>
</li>
<li>
<p>插入数据</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (title, description, price, embedding) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'Wireless Earbuds'</span>, <span class="hljs-string">'Bluetooth wireless earbuds with charging case'</span>, <span class="hljs-number">59.9</span>, <span class="hljs-string">'[0.12, 0.34, -0.21, ...]'</span>),(<span class="hljs-string">'Noise Cancelling Headphones'</span>, <span class="hljs-string">'Over-ear headphones with active noise cancellation'</span>, <span class="hljs-number">129.9</span>, <span class="hljs-string">'[0.11, 0.36, -0.19, ...]'</span>),(<span class="hljs-string">'Gaming Headset'</span>, <span class="hljs-string">'Wired gaming headset with microphone'</span>, <span class="hljs-number">79.9</span>, <span class="hljs-string">'[0.10, 0.33, -0.25, ...]'</span>),(<span class="hljs-string">'Smartphone Stand'</span>, <span class="hljs-string">'Adjustable phone stand for desk use'</span>, <span class="hljs-number">12.9</span>, <span class="hljs-string">'[0.45, -0.12, 0.08, ...]'</span>),(<span class="hljs-string">'USB-C Charger'</span>, <span class="hljs-string">'Fast charging USB-C power adapter'</span>, <span class="hljs-number">19.9</span>, <span class="hljs-string">'[0.42, -0.15, 0.05, ...]'</span>),(<span class="hljs-string">'Mechanical Keyboard'</span>, <span class="hljs-string">'Mechanical keyboard with blue switches'</span>, <span class="hljs-number">89.9</span>, <span class="hljs-string">'[0.55, 0.02, -0.31, ...]'</span>),(<span class="hljs-string">'Wireless Mouse'</span>, <span class="hljs-string">'Ergonomic wireless mouse'</span>, <span class="hljs-number">29.9</span>, <span class="hljs-string">'[0.53, 0.01, -0.28, ...]'</span>),(<span class="hljs-string">'Laptop Backpack'</span>, <span class="hljs-string">'Water-resistant laptop backpack'</span>, <span class="hljs-number">49.9</span>, <span class="hljs-string">'[0.60, -0.05, -0.10, ...]'</span>),(<span class="hljs-string">'4K Monitor'</span>, <span class="hljs-string">'27-inch 4K UHD computer monitor'</span>, <span class="hljs-number">299.9</span>, <span class="hljs-string">'[0.58, 0.04, -0.35, ...]'</span>),(<span class="hljs-string">'Webcam'</span>, <span class="hljs-string">'HD webcam for video conferencing'</span>, <span class="hljs-number">39.9</span>, <span class="hljs-string">'[0.52, -0.01, -0.20, ...]'</span>),(<span class="hljs-string">'Bluetooth Speaker'</span>, <span class="hljs-string">'Portable Bluetooth speaker with deep bass'</span>, <span class="hljs-number">45.9</span>, <span class="hljs-string">'[0.14, 0.30, -0.18, ...]'</span>),(<span class="hljs-string">'Smart Watch'</span>, <span class="hljs-string">'Fitness tracking smart watch'</span>, <span class="hljs-number">99.9</span>, <span class="hljs-string">'[0.20, 0.40, -0.22, ...]'</span>),(<span class="hljs-string">'Fitness Tracker'</span>, <span class="hljs-string">'Lightweight activity and sleep tracker'</span>, <span class="hljs-number">49.9</span>, <span class="hljs-string">'[0.22, 0.38, -0.24, ...]'</span>),(<span class="hljs-string">'Tablet Stylus'</span>, <span class="hljs-string">'Stylus pen for tablets'</span>, <span class="hljs-number">25.9</span>, <span class="hljs-string">'[0.48, -0.10, 0.12, ...]'</span>),(<span class="hljs-string">'Laptop Cooling Pad'</span>, <span class="hljs-string">'Cooling pad with dual fans'</span>, <span class="hljs-number">34.9</span>, <span class="hljs-string">'[0.57, -0.02, -0.15, ...]'</span>);
</code></pre>
</li>
<li>
<p>相似度查询：</p>
<p>通过以下查询，能够获取与用户向量相似度最高/距离最近的topk个商品</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, title, priceFROM productsORDER <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;</span><span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'[0.091, -0.054, 0.92, ...]'</span>   <span class="hljs-comment">-- 用户向量, 通过L2距离计算相似度LIMIT 10;</span>
</code></pre>
</li>
<li>
<p>混合查询:</p>
<p>DWS向量计算支持传统过滤方式及语义相似度查询的混合使用</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span> id,title,priceFROM productsWHERE price &lt; <span class="hljs-number">2000</span><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding &lt;-&gt; <span class="hljs-comment">'[0.091, -0.054, 0.92, ...]'LIMIT 10;</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-4">3.2 使用索引</h3>
<p>DWS向量计算默认使用精确近邻搜索，提供百分之百召回率但查询速度较慢。可以按需使用近似相邻搜索索引来牺牲部分召回率以提高查询速度。不同于传统索引，近似搜索索引可能会返回不同的查询结果。DWS向量计算目前支持的索引类型包括HNSW和IVFFlat。</p>
<ol>
<li>
<p>创建索引</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- HNSW 索引CREATE INDEX <span class="hljs-keyword">ON</span> products <span class="hljs-keyword">USING</span> hnsw (embedding vector_l2_ops) <span class="hljs-keyword">WITH</span> (m = <span class="hljs-number">16</span>, ef_construction = <span class="hljs-number">200</span>);-- 或者 IVFFlat 索引CREATE INDEX <span class="hljs-keyword">ON</span> products <span class="hljs-keyword">USING</span> ivfflat (embedding vector_l2_ops) <span class="hljs-keyword">WITH</span> (lists = <span class="hljs-number">100</span>);
</code></pre>
</li>
<li>
<p>使用索引 创建索引后执行topk查询，在距离操作符匹配的场景下会使用index scan，可以通过explain观察计划</p>
<pre><code class="hljs language-rust" lang="rust"> id |                            operation                             ----+------------------------------------------------------------------  <span class="hljs-number">1</span> | <span class="hljs-punctuation">-&gt;</span>  Limit                                                          <span class="hljs-number">2</span> |    <span class="hljs-punctuation">-&gt;</span>  <span class="hljs-title function_ invoke__">Streaming</span> (<span class="hljs-keyword">type</span>: GATHER)                                    <span class="hljs-number">3</span> |       <span class="hljs-punctuation">-&gt;</span>  Limit                                                    <span class="hljs-number">4</span> |          <span class="hljs-punctuation">-&gt;</span>  Index Scan using products_embedding_idx on products
</code></pre>
</li>
</ol>
<h3 data-id="heading-5">3.3 结果解读</h3>
<ul>
<li>
<p>用户搜索词为 <code>wireless audio headset</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, title    <span class="hljs-keyword">FROM</span> products    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;</span><span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'[0.13, 0.35, -0.20, ...]'</span>   <span class="hljs-comment">--用户搜索词的embedding    LIMIT 10;</span>
</code></pre>
</li>
</ul>
<p>查询结果： 商品名为耳机、音响类型的数据相较于表中其他商品类别与用户搜索词在语义上更为接近，即便没有精确包含<code>headset</code>仍然会在结果中排序更靠前</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a6d7a8f2cad4ba89cc139d9e683dd28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5Li65LqR5byA5Y-R6ICF6IGU55uf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299239&amp;x-signature=W7BsELu3GzkDaoqTFianWnqDUnA%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>用户正在浏览 <code>Noise Cancelling Headphones</code> 商品，根据相关性进行推荐：</p>
<p>SELECT p2.title, p2.priceFROM products p1JOIN products p2 ON p1.id &lt;&gt; p2.idWHERE p1.title = 'Noise Cancelling Headphones'ORDER BY p2.embedding &lt;-&gt; p1.embeddingLIMIT 10;</p>
</li>
</ul>
<p>查询结果： 耳机音响类商品与用户正在浏览的 <code>Noise Cancelling Headphones</code> 产品相关性更高 </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1419bc4e28fd47d3afa8648bfed5e2ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5Li65LqR5byA5Y-R6ICF6IGU55uf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299239&amp;x-signature=NZHSadf1UqWUo0fwO58unVud%2FvY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">4 性能</h2>
<p>以下图示展示了dws pgvector插件在不同数据集及索引下的检索性能</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d06a5fdc48e04959b3bc2d3b61f09f2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5Li65LqR5byA5Y-R6ICF6IGU55uf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299239&amp;x-signature=w4b%2BUZf4ZY30KhoyTl4pIZyhZY8%3D" alt="" loading="lazy"/></p>
<p>实测表明，dws pgvector插件能够做到千万级向量数据：</p>
<ol>
<li>
<p>低于小时级索引构建时间</p>
</li>
<li>
<p>毫秒级查询</p>
</li>
<li>
<p>稳定高召回率，按需调参控制</p>
</li>
</ol>
<p>对比两种索引，我们可以发现：</p>
<ul>
<li>
<p>hnsw索引构建时间与数据量和维度强相关。相同数据量和维度场景下构建时间相较ivfflat显著增加，换取更快得查询速度和更好的召回率</p>
</li>
<li>
<p>ivfflat索引构建时间更短，主要受构建参数lists影响，对数据量不敏感。相同数据量和维度场景下查询耗时及召回率表现低于hnsw</p>
</li>
</ul>
<p>因此，两者的推荐使用场景分别为： HNSW</p>
<ul>
<li>
<p>线上实时检索 搜索 / 推荐 / RAG</p>
</li>
<li>
<p>高召回要求 Recall ≥ 0.9</p>
</li>
<li>
<p>多租户/长期运维系统</p>
</li>
</ul>
<p>IVFFLAT</p>
<ul>
<li>
<p>离线 / 批量检索</p>
</li>
<li>
<p>检索成本优先</p>
</li>
<li>
<p>作为多级检索的第一层粗筛</p>
</li>
</ul>
<h2 data-id="heading-7">5 总结</h2>
<p>通过在 DWS 向量计算扩展能力，我们将传统以结构化查询为核心的数据库系统升级为能够具备语义理解与相似度计算能力的统一数据底座。系统不仅支持向量数据的存储与高效相似度检索，还允许业务方直接通过标准 SQL 完成语义搜索、推荐与相似内容匹配，无需引入额外的向量引擎或复杂的数据同步链路。</p>
<p>依托 HNSW、IVFFlat 近似最近邻索引，向量查询在大规模数据场景下依然具备可控的性能与稳定的响应能力。同时，向量检索能力与传统结构化查询、过滤条件、JOIN 逻辑的深度融合，使得搜索推荐、个性化分析以及 RAG 等 AI 应用可以自然落地在现有数仓与业务体系之上。</p>
<p>最终，这一能力扩展不仅降低了系统架构复杂度，也显著提升了数据平台对新一代智能应用的支撑能力，实现了从“数据查询”向“语义计算与业务决策支持”的演进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArkTS基础语法 |（2）函数]]></title>    <link>https://juejin.cn/post/7604805226696343590</link>    <guid>https://juejin.cn/post/7604805226696343590</guid>    <pubDate>2026-02-10T05:36:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604805226696343590" data-draft-id="7604694326519365683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArkTS基础语法 |（2）函数"/> <meta itemprop="keywords" content="ArkTS"/> <meta itemprop="datePublished" content="2026-02-10T05:36:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lee_xiaoming"/> <meta itemprop="url" content="https://juejin.cn/user/3775072660106464"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArkTS基础语法 |（2）函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3775072660106464/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lee_xiaoming
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T05:36:57.000Z" title="Tue Feb 10 2026 05:36:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ArkTS基础语法 |（2）函数</h2>
<p>在学习HarmonyOS开发的核心语言ArkTS时，整理了一份基础语法笔记，方便日后回顾。
<br/>
<br/></p>
<p>函数能够封装重复的业务逻辑（代码块），遵循<strong>先定义、后调用</strong>的基本原则，大幅提升代码的复用率和可维护性。
<br/></p>
<h3 data-id="heading-1">一、函数声明</h3>
<p>ArkTS中声明函数需明确<strong>函数名、参数列表、返回类型（可选）和函数体</strong></p>
<ul>
<li>声明函数的核心规则：</li>
</ul>
<ol>
<li>
<p>形参必须显式标记类型，实参的数量、类型需与形参一一对应。</p>
</li>
<li>
<p>仅定义函数不调用，函数体代码不会执行。</p>
</li>
<li>
<p>支持无参无返回值、带参带返回值等多种形式。</p>
</li>
<li>
<p>可通过<code>return</code>关键字返回处理结果，无返回值时可省略<code>return</code> 。</p>
</li>
</ol>
<h5 data-id="heading-2">1. 无参无返回值函数</h5>
<p>最基础的函数形式，无参数传入，也无结果返回，适用于执行简单的固定逻辑。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 定义语法</span>
<span class="hljs-keyword">function</span> 函数名() {
  函数体
}
<span class="hljs-comment">// 调用语法</span>
函数名()

<span class="hljs-comment">// 示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello ArkTS!'</span>);   <span class="hljs-comment">// 执行简单的打印逻辑</span>
}
<span class="hljs-title function_">sayHello</span>();   <span class="hljs-comment">// 调用后输出：Hello ArkTS!</span>
</code></pre>
<h5 data-id="heading-3">2. 带参带返回值函数</h5>
<p>适用于需要传入参数并返回处理结果的场景，需指定<strong>形参类型</strong>和<strong>函数返回类型</strong>。</p>
<ul>
<li>
<p><strong>形参</strong>：函数定义时的参数，必须指定类型。</p>
</li>
<li>
<p><strong>实参</strong>：函数调用时传入的参数，需与形参数量、类型严格匹配。</p>
</li>
<li>
<p><strong>return</strong> ：用于返回处理结果，执行到<code>return</code>后函数体立即终止。</p>
</li>
</ul>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 示例：定义求和函数，接收两个number类型参数，返回number类型结果。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">num1: <span class="hljs-built_in">number</span>, num2: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> num1 + num2;   <span class="hljs-comment">// 返回两数之和</span>
}
<span class="hljs-comment">// 调用函数，接收返回值并打印。</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title function_">sum</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);   <span class="hljs-comment">// 输出：30</span>
</code></pre>
<br/>
<h3 data-id="heading-4">二、函数参数</h3>
<p>ArkTS对函数参数做了灵活扩展，支持<strong>必选参数、可选参数、默认值参数、rest参数</strong>，其中可选参数、默认值参数、rest参数均需遵循特定的语法规则，且<strong>只能出现在必选参数之后</strong>。</p>
<h5 data-id="heading-5">1. 可选参数</h5>
<p>调用函数时可省略的参数
语法：<code>参数名?: 类型</code>
省略时参数值为<code>undefined</code>，需在函数体内做判空处理。</p>
<ul>
<li>注意：可选参数必须跟在必选参数后面，不能放在必选参数之前。</li>
</ul>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params">name?: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">undefined</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Hello!'</span>);   <span class="hljs-comment">// 省略参数时执行</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>);   <span class="hljs-comment">// 传入参数时执行</span>
  }
}
<span class="hljs-title function_">hello</span>();   <span class="hljs-comment">// 省略参数 输出：Hello!</span>
<span class="hljs-title function_">hello</span>(<span class="hljs-string">'ArkTS'</span>);   <span class="hljs-comment">// 传入参数 输出：Hello, ArkTS!</span>
</code></pre>
<h5 data-id="heading-6">2. 默认值参数</h5>
<p>可选参数的另一种形式，为参数设置默认值，调用时若省略该参数，会自动使用默认值作为实参.
语法:<code>参数名: 类型 = 默认值</code></p>
<ul>
<li>注意：默认值参数也需跟在必选参数之后，若调用时传入新值，会覆盖默认值。</li>
</ul>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 示例：定义乘法函数，系数coeff设置默认值2。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">n: <span class="hljs-built_in">number</span>, coeff: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> n * coeff;
}
<span class="hljs-title function_">multiply</span>(<span class="hljs-number">2</span>);   <span class="hljs-comment">// 省略coeff，使用默认值2，返回：4。</span>
<span class="hljs-title function_">multiply</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>);   <span class="hljs-comment">// 传入coeff=3，覆盖默认值，返回：6。</span>
</code></pre>
<h5 data-id="heading-7">3. rest参数</h5>
<p>用于处理<strong>不定数量的参数输入</strong>，允许函数接收一个不定长的数组。
语法<code>...rest参数名: 类型[]</code>
核心规则：</p>
<ol>
<li>rest参数<strong>只能是函数的最后一个参数</strong></li>
<li>rest参数的类型必须是<strong>数组类型</strong></li>
<li>调用时可传入0个、1个或多个同类型参数，均会被封装为数组。</li>
</ol>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 示例：定义求和函数，支持传入任意多个number类型参数.</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">...numbers: <span class="hljs-built_in">number</span>[]</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">let</span> res = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// 遍历rest参数数组，累加求和</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> n <span class="hljs-keyword">of</span> numbers) {
    res += n;
  }
  <span class="hljs-keyword">return</span> res;
}
<span class="hljs-title function_">sum</span>();   <span class="hljs-comment">// 传入0个参数 返回：0</span>
<span class="hljs-title function_">sum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);   <span class="hljs-comment">// 传入3个参数 返回：6</span>
<span class="hljs-title function_">sum</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>);   <span class="hljs-comment">// 传入4个参数 返回：100</span>
</code></pre>
<br/>
<h3 data-id="heading-8">三、函数返回类型</h3>
<p>ArkTS中函数的返回类型支持<strong>显式指定</strong>和<strong>自动推断</strong>，无返回值时可指定为<code>void</code>类型.
核心规则：</p>
<ol>
<li>若函数体的返回结果可被编译器推断，可省略返回类型标注。</li>
<li>无返回值的函数，可显式指定<code>void</code>或省略返回类型。</li>
<li>显式指定返回类型后，函数返回的结果必须与该类型匹配，否则编译报错。</li>
</ol>
<h5 data-id="heading-9">1. 显式指定返回类型</h5>
<p>适用于需要明确函数返回值类型的场景，提升代码的可读性和规范性。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 显式指定返回string类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>): <span class="hljs-built_in">string</span> { 
  <span class="hljs-keyword">return</span> <span class="hljs-string">'foo'</span>; 
}
<span class="hljs-comment">// 显式指定返回number类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getNum</span>(<span class="hljs-params"/>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
}
</code></pre>
<h5 data-id="heading-10">2. 自动推断返回类型</h5>
<p>编译器可根据函数体的<code>return</code>语句自动推断返回类型，可省略返回类型标注，简化代码。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 自动推断返回类型为string</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">goo</span>(<span class="hljs-params"/>) { 
  <span class="hljs-keyword">return</span> <span class="hljs-string">'goo'</span>; 
}
<span class="hljs-comment">// 自动推断返回类型为boolean</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isTrue</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> &gt; <span class="hljs-number">0</span>;
}
</code></pre>
<h5 data-id="heading-11">3. 无返回值（void类型）</h5>
<p>表示函数无任何返回结果，即使写<code>return</code>也不能携带值，两种声明方式均可，效果一致。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 方式1：省略返回类型标注（简洁写法）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">hi1</span>(<span class="hljs-params"/>) { 
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'hi'</span>); 
}

<span class="hljs-comment">// 方式2：显式指定void类型（规范写法）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">hi2</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> { 
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'hi'</span>); 
  <span class="hljs-comment">// 无返回值的函数可写空return，不可写return 123（编译报错）。</span>
  <span class="hljs-keyword">return</span>;
}
</code></pre>
<h5 data-id="heading-12">4. 拓展：never类型</h5>
<p>表示函数<strong>永远不会执行完成</strong>（如函数内抛出异常、无限循环），是比<code>void</code>更严格的返回类型，基础开发中使用较少，做简单了解即可。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">errorFunc</span>(<span class="hljs-params"/>): <span class="hljs-built_in">never</span> {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'程序执行异常'</span>);
}
</code></pre>
<br/>
<h3 data-id="heading-13">四、函数的作用域</h3>
<p>ArkTS中函数遵循<strong>块级作用域</strong>规则，函数内定义的变量/实例为<strong>局部变量</strong>，函数外定义的为<strong>全局变量</strong>。
核心规则：</p>
<ol>
<li>局部变量仅能在函数内部访问，外部无法访问。</li>
<li>若函数内的局部变量与全局变量同名，<strong>局部变量会覆盖全局变量</strong>（函数内优先使用局部变量）。</li>
<li>函数内定义变量时，必须使用<code>let/const</code>，否则会被提升为全局变量。</li>
</ol>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 定义全局变量</span>
<span class="hljs-keyword">let</span> outerVar = <span class="hljs-string">'I am outer '</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">func</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 定义同名局部变量，覆盖全局变量。</span>
    <span class="hljs-keyword">let</span> outerVar = <span class="hljs-string">'I am inside'</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(outerVar);   <span class="hljs-comment">// 输出：I am inside（使用局部变量）</span>
}
<span class="hljs-title function_">func</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(outerVar);   <span class="hljs-comment">// 输出：I am outer（全局变量未被修改）</span>

<span class="hljs-comment">// 易错点：函数内未用let/const定义的变量，会成为全局变量。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">badFunc</span>(<span class="hljs-params"/>) {
  testVar = <span class="hljs-string">'全局变量'</span>;   <span class="hljs-comment">// 未用let/const，提升为全局变量</span>
}
<span class="hljs-title function_">badFunc</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(testVar);   <span class="hljs-comment">// 输出：全局变量</span>
</code></pre>
<br/>
<h3 data-id="heading-14">五、函数的调用</h3>
<p>函数定义后，需通过 <code>函数名(实参)</code> 的方式调用，才能执行函数体代码。
核心规则：</p>
<ol>
<li>实参的数量、类型需与形参严格匹配（可选参数、rest参数除外）。</li>
<li>函数调用时，实参会按顺序赋值给形参。</li>
<li>带返回值的函数，调用时可通过变量接收返回结果，也可直接调用（忽略返回结果）。</li>
</ol>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 定义函数：拼接两个字符串</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">join</span>(<span class="hljs-params">x: <span class="hljs-built_in">string</span>, y: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">z</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">`<span class="hljs-subst">${x}</span> <span class="hljs-subst">${y}</span>`</span>;
  <span class="hljs-keyword">return</span> z;
}

<span class="hljs-comment">// 方式1：接收返回值（推荐）</span>
<span class="hljs-keyword">let</span> res = <span class="hljs-title function_">join</span>(<span class="hljs-string">'hello'</span>, <span class="hljs-string">'world'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(res);   <span class="hljs-comment">// 输出: hello world</span>

<span class="hljs-comment">// 方式2：直接调用，忽略返回结果。</span>
<span class="hljs-title function_">join</span>(<span class="hljs-string">'Hi'</span>, <span class="hljs-string">'ArkTS'</span>);
</code></pre>
<h5 data-id="heading-15">拓展：参数的传递方式</h5>
<p>ArkTS中参数传递分为<strong>值传递</strong>和<strong>引用传递</strong>，取决于参数的类型。</p>
<ul>
<li><strong>值传递</strong>：适用于<strong>基本类型</strong>（number、string、boolean、undefined、null），传递的是变量的副本，函数内修改副本不会影响原变量。</li>
<li><strong>引用传递</strong>：适用于<strong>引用类型</strong>（对象、数组），传递的是变量的内存地址，函数内修改对象/数组的属性，会影响原变量。</li>
</ul>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 值传递（基本类型）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">changeNum</span>(<span class="hljs-params">num: <span class="hljs-built_in">number</span></span>) {
  num = <span class="hljs-number">100</span>;
}
<span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;
<span class="hljs-title function_">changeNum</span>(a);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);   <span class="hljs-comment">// 输出：10（原变量未被修改）</span>

<span class="hljs-comment">// 引用传递（引用类型）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">changeObj</span>(<span class="hljs-params">obj: {name: <span class="hljs-built_in">string</span>}</span>) {
  obj.<span class="hljs-property">name</span> = <span class="hljs-string">'ArkTS'</span>;
}
<span class="hljs-keyword">let</span> person = {<span class="hljs-attr">name</span>: <span class="hljs-string">'鸿蒙'</span>};
<span class="hljs-title function_">changeObj</span>(person);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">name</span>);   <span class="hljs-comment">// 输出：ArkTS（原对象被修改）</span>
</code></pre>
<br/>
<h3 data-id="heading-16">六、函数类型</h3>
<p>ArkTS中函数也是一种数据类型，可通过<code>type</code>关键字定义<strong>函数类型</strong>，用于约束函数的<strong>参数列表</strong>和<strong>返回类型</strong>，<strong>最常用的场景是定义回调函数</strong>，让代码的类型约束更严格。</p>
<h6 data-id="heading-17">函数类型的定义语法</h6>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">type</span> 函数类型名 = <span class="hljs-function">(<span class="hljs-params">参数<span class="hljs-number">1</span>: 类型<span class="hljs-number">1</span>, 参数<span class="hljs-number">2</span>: 类型<span class="hljs-number">2</span>, ...</span>) =&gt;</span> 返回类型;   <span class="hljs-comment">// 语法格式</span>
</code></pre>
<h6 data-id="heading-18">示例：定义回调函数</h6>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 定义函数类型：接收2个number类型参数，返回number类型结果。</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AddFunc</span> = <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 定义函数，参数是AddFunc类型的回调函数。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span>, back: AddFunc</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">back</span>(a, b);   <span class="hljs-comment">// 调用回调函数 传入a和b</span>
}

<span class="hljs-comment">// 传入符合AddFunc类型的函数作为实参（求和）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) =&gt; x + y;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">calculate</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, add));   <span class="hljs-comment">// 输出：5（符合规矩 正常执行）</span>

<span class="hljs-comment">// 若传不符合规矩的函数（比如返回string），编译直接报错（这就是函数类型的作用！）。</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">badAdd</span> = (<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) =&gt; <span class="hljs-string">'${x+y}'</span>;
<span class="hljs-title function_">calculate</span>(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>, badAdd);   <span class="hljs-comment">// 报错：返回类型string不符合AddFunc的number类型</span>
</code></pre>
<h6 data-id="heading-19">函数类型的赋值</h6>
<p>定义函数类型后，可将符合该类型的函数赋值给变量，约束变量的函数形态。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 定义函数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AddFunc</span> = <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 定义符合该类型的函数</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">add</span>: <span class="hljs-title class_">AddFunc</span> = <span class="hljs-function">(<span class="hljs-params">x, y</span>) =&gt;</span> x + y;

<span class="hljs-comment">// 调用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));   <span class="hljs-comment">// 输出：3</span>
</code></pre>
<br/>
<h3 data-id="heading-20">七、箭头函数（Lambda函数）</h3>
<p>箭头函数是<strong>普通函数的简洁写法</strong>，语法更精炼、代码更简洁，适合编写短小的函数逻辑，也是鸿蒙开发中高频使用的写法。</p>
<ul>
<li>核心特点：<strong>无自己的this</strong>（继承外层作用域的this）</li>
</ul>
<h5 data-id="heading-21">1. 基本语法</h5>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 完整语法</span>
<span class="hljs-keyword">let</span> 函数名 = <span class="hljs-function">(<span class="hljs-params">形参<span class="hljs-number">1</span>: 类型<span class="hljs-number">1</span>, 形参<span class="hljs-number">2</span>: 类型<span class="hljs-number">2</span></span>) =&gt;</span> {
  函数体;
  <span class="hljs-keyword">return</span> 结果;
}
</code></pre>
<p>简写规则：</p>
<ol>
<li>单表达式函数体，可省略大括号<code>{}</code>和<code>return</code> 。</li>
<li>单个形参，可省略小括号<code>()</code> 。</li>
<li>无参或多个形参，必须保留小括号<code>()</code> 。</li>
<li>返回类型可省略，由编译器自动推断。</li>
</ol>
<h5 data-id="heading-22">2. 常见使用形式</h5>
<h6 data-id="heading-23">（1）无参箭头函数</h6>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 完整写法</span>
<span class="hljs-keyword">let</span> <span class="hljs-title function_">sayHi</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hi, 箭头函数'</span>);
};
<span class="hljs-comment">// 调用</span>
<span class="hljs-title function_">sayHi</span>();   <span class="hljs-comment">// 输出：Hi,箭头函数</span>

<span class="hljs-comment">// 无参+单表达式（若有返回值）</span>
<span class="hljs-keyword">let</span> <span class="hljs-title function_">getStr</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-string">'Hello Arrow Function'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getStr</span>());   <span class="hljs-comment">// 输出：Hello Arrow Function</span>
</code></pre>
<h6 data-id="heading-24">（2）带参箭头函数</h6>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 多个形参完整写法</span>
<span class="hljs-keyword">let</span> multiply = (<span class="hljs-attr">num1</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">num2</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> num1 * num2;
};
<span class="hljs-keyword">let</span> res = <span class="hljs-title function_">multiply</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);   <span class="hljs-comment">// 输出：30</span>

<span class="hljs-comment">// 单个形参简写（省略小括号、大括号、return）</span>
<span class="hljs-keyword">let</span> <span class="hljs-title function_">double</span> = (<span class="hljs-params">n: <span class="hljs-built_in">number</span></span>) =&gt; n * <span class="hljs-number">2</span>;   <span class="hljs-comment">// 标准简写（推荐写法）</span>
<span class="hljs-keyword">let</span> <span class="hljs-title function_">double2</span> = n =&gt; n * <span class="hljs-number">2</span>;   <span class="hljs-comment">// 不推荐写法</span>

<span class="hljs-comment">// 多个形参 单表达式 简写</span>
<span class="hljs-keyword">let</span> <span class="hljs-title function_">sum</span> = (<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt; a + b;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sum</span>(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>));   <span class="hljs-comment">// 输出：7</span>
</code></pre>
<h5 data-id="heading-25">3. 箭头函数的核心特性</h5>
<p>箭头函数的核心差异是<strong>无自身的this</strong>，鸿蒙开发中在组件生命周期、事件回调中使用时需特别注意：</p>
<ol>
<li>箭头函数的 <code>this</code> <strong>继承自外层作用域</strong>，不会随调用方式改变。（外层无目标属性则输出undefined）</li>
<li>普通函数的 <code>this</code> <strong>指向调用者</strong>，调用方式不同，<code>this</code> 指向不同。（调用者无目标属性也可能输出undefined）</li>
<li>箭头函数不能作为构造函数，不能使用<code>new</code>关键字调用。</li>
</ol>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 示例：箭头函数继承外层this</span>
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'ArkTS'</span>,
  <span class="hljs-attr">fn1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 普通函数：this指向obj</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-attr">fn2</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 箭头函数：this继承外层（全局作用域）（无name属性）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  }
};
obj.<span class="hljs-title function_">fn1</span>();   <span class="hljs-comment">// 调用普通函数fn1  输出：ArkTS</span>
obj.<span class="hljs-title function_">fn2</span>();   <span class="hljs-comment">// 调用箭头函数fn2  输出：undefined</span>
</code></pre>
<br/>
<h3 data-id="heading-26">八、闭包</h3>
<p>闭包是由<strong>函数</strong>和<strong>声明该函数的环境</strong>组合而成的整体，该环境包含了闭包创建时作用域内的所有局部变量。</p>
<ul>
<li>核心特性：<strong>闭包可以访问并保留外层函数的局部变量，即使外层函数执行完毕，局部变量也不会被销毁</strong>。</li>
</ul>
<h5 data-id="heading-27">1. 闭包的实操示例</h5>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 外层函数f</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>): <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;   <span class="hljs-comment">// 外层函数的局部变量</span>
  <span class="hljs-comment">// 内层箭头函数g 形成闭包</span>
  <span class="hljs-keyword">let</span> g = (): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> { 
    count++;   <span class="hljs-comment">// 访问外层函数的局部变量count</span>
    <span class="hljs-keyword">return</span> count; 
  };
  <span class="hljs-keyword">return</span> g;   <span class="hljs-comment">// 返回内层函数g</span>
}

<span class="hljs-keyword">let</span> z = <span class="hljs-title function_">f</span>();   <span class="hljs-comment">// 外层函数执行完毕 返回内层函数g</span>
<span class="hljs-comment">// 多次调用z 闭包保留count的状态 持续递增</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">z</span>());   <span class="hljs-comment">// 返回：1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">z</span>());   <span class="hljs-comment">// 返回：2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">z</span>());   <span class="hljs-comment">// 返回：3</span>
</code></pre>
<h5 data-id="heading-28">2. 闭包的使用场景</h5>
<ol>
<li><strong>封装私有变量</strong>：隐藏内部变量，仅通过闭包暴露操作方法，避免全局变量污染。</li>
<li><strong>保留函数执行状态</strong>：如闭包实操示例中的计数器，多次调用可保留上一次的执行结果。</li>
<li><strong>鸿蒙开发中</strong>：组件事件回调、定时器中保留上下文状态。</li>
</ol>
<h5 data-id="heading-29">3. 闭包的注意事项</h5>
<p>闭包会保留外层函数的变量，导致<strong>变量不会被垃圾回收</strong>，若过度使用或不当使用，会造成<strong>内存泄漏</strong>。
注意事项：</p>
<ol>
<li>避免在循环中创建闭包。</li>
<li>不需要使用闭包时，及时解除引用（如将闭包变量赋值为<code>null</code>）。</li>
</ol>
<h5 data-id="heading-30">4. 闭包封装私有变量示例</h5>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 封装计数器 仅暴露增/减方法 隐藏count变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;   <span class="hljs-comment">// 私有变量 外部无法访问</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">add</span>: <span class="hljs-function">() =&gt;</span> count++,   <span class="hljs-comment">// 闭包：增加计数</span>
    <span class="hljs-attr">sub</span>: <span class="hljs-function">() =&gt;</span> count--,   <span class="hljs-comment">// 闭包：减少计数</span>
    <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> count      <span class="hljs-comment">// 闭包：获取计数</span>
  };
}

<span class="hljs-keyword">let</span> counter = <span class="hljs-title function_">createCounter</span>();
counter.<span class="hljs-title function_">add</span>();
counter.<span class="hljs-title function_">add</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">get</span>());   <span class="hljs-comment">// 输出：2</span>
counter.<span class="hljs-title function_">sub</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">get</span>());   <span class="hljs-comment">// 输出：1</span>
<span class="hljs-comment">// 外部无法直接修改count 避免变量污染</span>
</code></pre>
<br/>
<h3 data-id="heading-31">九、函数重载</h3>
<p>函数重载指<strong>为同一个函数定义多个不同的签名（参数列表/返回类型不同）</strong>，让同一个函数支持多种调用方式。
在ArkTS中编译器会根据<strong>实参的类型/数量</strong>，匹配对应的重载签名执行。</p>
<h5 data-id="heading-32">1. 函数重载的语法规则</h5>
<ol>
<li>先编写<strong>多个重载声明</strong>（同名、不同签名、无函数体）</li>
<li>最后编写<strong>一个函数实现</strong>（必须包含所有重载声明的参数/返回类型，用联合类型表示）。</li>
<li>重载声明的参数列表不能相同，否则编译报错。</li>
<li>函数实现的参数类型需<strong>覆盖所有重载声明的参数类型</strong>，返回类型也需匹配。</li>
</ol>
<h5 data-id="heading-33">2. 函数重载的实操示例</h5>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 重载声明1：接收一个number类型参数 无返回值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 重载声明2：接收一个string类型参数 无返回值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">x: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 函数实现：参数类型为 “ number | string ”  覆盖所有重载声明</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'number'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数字类型：'</span>, x);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'字符串类型：'</span>, x);
  }
}

<span class="hljs-comment">// 调用：编译器自动匹配对应的重载声明</span>
<span class="hljs-title function_">foo</span>(<span class="hljs-number">123</span>);    <span class="hljs-comment">// 匹配重载1  输出： 数字类型： 123</span>
<span class="hljs-title function_">foo</span>(<span class="hljs-string">'aa'</span>);   <span class="hljs-comment">// 匹配重载2  输出： 字符串类型： aa</span>
</code></pre>
<h5 data-id="heading-34">3. 带返回值的函数重载示例</h5>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 重载声明1：两个number参数 返回number</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 重载声明2：两个string参数 返回string</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">a: <span class="hljs-built_in">string</span>, b: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span>;

<span class="hljs-comment">// 函数实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>, b: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">'number'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">'number'</span>) {
    <span class="hljs-keyword">return</span> a + b;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${a}</span><span class="hljs-subst">${b}</span>`</span>;
  }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">calc</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));   <span class="hljs-comment">// 输出：3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">calc</span>(<span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>));   <span class="hljs-comment">// 输出：ab</span>
</code></pre>
<h5 data-id="heading-35">4. 函数重载的注意事项</h5>
<ol>
<li>函数重载<strong>仅在编译阶段生效</strong>，用于做类型校验，运行时只有一个函数实现。</li>
<li>不能只有重载声明而无函数实现，否则编译报错。</li>
<li>鸿蒙开发中，函数重载常用于封装通用方法，让方法支持多种参数类型，提升代码的灵活性。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SCALE 一月榜单发布：国产大模型在 AI4DB 领域上的水平如何？]]></title>    <link>https://juejin.cn/post/7604786493639753755</link>    <guid>https://juejin.cn/post/7604786493639753755</guid>    <pubDate>2026-02-10T05:41:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604786493639753755" data-draft-id="7604791354257834022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SCALE 一月榜单发布：国产大模型在 AI4DB 领域上的水平如何？"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-02-10T05:41:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱可生开源社区"/> <meta itemprop="url" content="https://juejin.cn/user/1480387593251847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SCALE 一月榜单发布：国产大模型在 AI4DB 领域上的水平如何？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1480387593251847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱可生开源社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T05:41:31.000Z" title="Tue Feb 10 2026 05:41:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 本月榜单摘要</h2>
<p>2026 年伊始，<a href="https://link.juejin.cn?target=https%3A%2F%2Fsql-llm-leaderboard.com%2Franking%2F2026-01" title="https://sql-llm-leaderboard.com/ranking/2026-01" target="_blank" ref="nofollow noopener noreferrer">SCALE</a> 评测框架迎来了重要进化。本月，我们不仅迎来了 <em>智谱 GLM-4.7</em> 与 <em>字节跳动 Seed-OSS-36B-Instruct</em> 的入场，更在评测深度上实现了突破 —— 在 <strong>SQL 优化</strong> 维度中正式引入 <strong>“索引建议”</strong> 指标。</p>
<p><em>这意味着 SQL 优化能力的测评标准已从单一的</em>*“语法层面的改写 “迈向了” <strong>语法优化 + 执行成本优化”</strong> 的综合评估，更体现了模型是否真正站在数据库执行与资源消耗的角度思考问题，能否给出具备实际性能收益、符合真实生产场景的优化建议。*</p>
<h2 data-id="heading-1">二、 评测基准体系升级</h2>
<p>SCALE 致力于通过多维度的压力测试，量化大语言模型在专业数据库任务中的真实价值。我们严格遵循 SCALE 框架自创立以来的三大核心维度和统一评测数据集，确保结果的公正性与可复现性。</p>
<h3 data-id="heading-2">SCALE 三大评测维度</h3>

























<table><thead><tr><th>评测维度</th><th>评估目标</th><th>核心应用场景</th></tr></thead><tbody><tr><td><strong>SQL 理解</strong></td><td>对现有 SQL 代码的逻辑、意图和执行计划的深度分析能力。</td><td>数据分析、生产环境故障排查、代码审查。</td></tr><tr><td><strong>SQL 优化</strong></td><td>在保证逻辑等价下，将低效 SQL 改写为性能更优查询的策略应用和效果。</td><td>数据库调优、存量代码重构。</td></tr><tr><td><strong>方言转换</strong></td><td>在不同数据库方言之间进行语法迁移和复杂过程化逻辑重构的准确性和可靠性。</td><td>数据库迁移、跨平台数据中台构建。</td></tr></tbody></table>
<h3 data-id="heading-3">本月新增指标：索引建议</h3>
<p>在日常 <strong>SQL 优化</strong> 时，<strong>索引优化非常重要的一个手段</strong>，索引能让数据库尽量少读数据、少做计算，从而用更低的成本更快地返回结果。为此我们在 <strong>SQL 优化</strong> 维度新增了对 <strong>索引建议</strong> 的测评。</p>
<ul>
<li><strong>评测定位</strong>：索引优化是 SQL 性能提升的核心。该指标检验模型能否给出可落地、性价比合理、风险可控的优化方案，而非仅停留在语法层面的改写。</li>
<li><strong>指标排名</strong>：根据最新测评结果，各主流模型在索引建议测评的表现如下：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d13aa63450744223acbfd33d71e58ecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771306894&amp;x-signature=YaB%2Bif6vTSY2miMA7LjaIcX6Xp8%3D" alt="scale-1.png" loading="lazy"/></p>
<h2 data-id="heading-4">三、专项测评：智谱 GLM-4.7</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fz.ai%2Fblog%2Fglm-4.7" title="https://z.ai/blog/glm-4.7" target="_blank" ref="nofollow noopener noreferrer">GLM-4.7</a> 是智谱 AI 于 2025 年 12 月 23 日发布并开源的大语言模型，该模型针对编码场景在相关能力方面进行了强化。模型发布后，曾在开源社区 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fzai-org%2FGLM-4.7" title="https://huggingface.co/zai-org/GLM-4.7" target="_blank" ref="nofollow noopener noreferrer">Hugging Face</a> 的全球趋势榜上位列榜首。2026 年 1 月 8 日，智谱 AI 在港交所挂牌上市。（信息来源：百度百科）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4b40faf35dd4b58ba127e1cc8dbd1f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771306894&amp;x-signature=k1myyred9Fi8Zap%2BL62qejjDATU%3D" alt="glm-1.png" loading="lazy"/></p>
<h3 data-id="heading-5">1. 能力定位判断</h3>
<p><strong>智谱 GLM-4.7 在本次测评中表现出极高的逻辑严谨性与场景适应性。</strong></p>
<p>它不仅仅是一个 SQL 生成器，更像是一个具备初步工程思维的 <strong>“初级 DBA”</strong>，在处理复杂业务逻辑与国产化迁移时展现了第一梯队的稳定性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d790ab2e5165447dbd1fbfad94a33700~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771306894&amp;x-signature=HgFMcxJ%2FgA%2B2jjM5%2BAhUC49c8sM%3D" alt="glm-2.png" loading="lazy"/></p>
<h3 data-id="heading-6">2. 核心维度分析</h3>
<h4 data-id="heading-7">SQL 理解：79.8 分</h4>
<p>**<em>GLM-4.7</em> 表现出较强的逻辑一致性。**其执行准确性（82.9）与语法错误检测（82.9）得分较高，意味着模型能够准确理解复杂的业务意图。</p>
<p>在执行计划检测中，测试案例通过率相对较低，仅有 55%，模型对包含 <code>LEFT JOIN</code>、<code>GROUP BY</code> 和 <code>ORDER BY</code> 的复杂查询，错误地输出了连接缓冲和嵌套循环（<code>Using join buffer (Block Nested Loop)</code>），却遗漏了关键的临时表和文件排序标识（<code>Using temporary; Using filesort</code>），且行数估算错误，暴露出其对聚合排序操作的执行机制理解不足，以及在多表关联场景下对驱动表和执行步骤的推理能力欠缺。</p>
<h4 data-id="heading-8">SQL 优化：59.6 分</h4>
<p>在新增的索引建议指标中，模型取得了 58.1 分的成绩。整体来看，模型已能够结合查询条件给出符合索引设计基本原理的优化建议，<strong>初步具备了基于执行计划进行分析并提出物理结构优化方案的能力。</strong></p>
<p>在更复杂的场景下，尤其是涉及索引冗余判断以及低选择性列与索引维护成本之间权衡的问题时，模型的表现仍不稳定，难以持续给出有效且合理的索引建议。</p>
<h4 data-id="heading-9">方言转换：68.2 分</h4>
<p><strong>国产数据库转换得分高达 89.5 分，这是 GLM-4.7 的传统强项，表现出较高的成熟度。</strong></p>
<p>但是在语法正确性检测测评上得分为 50 分，处于较低水平，反映出模型在细粒度方言知识掌握上的显著不足，特别是对特定数据库版本（如 OceanBase 4.2.5、GaussDB-v2.0_3.x）的语法约束、数据类型支持范围缺乏准确认知。</p>
<h3 data-id="heading-10">3. 应用价值建议</h3>
<ul>
<li><strong>推荐场景</strong>：适用于企业级遗留系统重构、复杂业务 SQL 开发辅助、数据库国产化迁移专项。</li>
<li><strong>实战建议</strong>：可用于生成迁移脚本的参考初稿，但在索引建议方面，建议作为 DBA 审查的“第一道参考”，在生产环境部署前仍需配合 Explain Plan 进行微调。</li>
</ul>
<h2 data-id="heading-11">四、专项测评：字节 Seed-OSS-36B</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FByteDance-Seed%2FSeed-OSS-36B-Base" title="https://huggingface.co/ByteDance-Seed/Seed-OSS-36B-Base" target="_blank" ref="nofollow noopener noreferrer">Seed-OSS-36B</a> 是由字节跳动旗下 Seed 团队于 2025 年 8 月 21 日 在 Hugging Face 平台发布的开源大型语言模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4cb776487504771af58c331299030b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771306894&amp;x-signature=RNMMmrQU%2F%2B%2FbXD6rjjfaVJ4plmI%3D" alt="seed-1.png" loading="lazy"/></p>
<p>该模型采用因果语言建模、分组查询注意力和 RoPE 位置编码等技术，包含 360 亿参数并支持 15.5 万词表规模。通过 64 层网络结构实现 512k tokens 的长上下文处理能力，适用于文档分析、推理链、Agent 交互及通用场景。（信息来源：百度百科）</p>
<h3 data-id="heading-12">1. 能力定位判断</h3>
<p><em>字节 Seed-OSS-36B</em> 是一个性格鲜明的模型：<strong>在标准规范性上达到了极高水准，但在长文本处理与深层执行推理上仍有待突破。</strong> 它非常适合作为代码规范的**“守门员”**，但在面对重度复杂的工业级任务时表现出一定的波动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb76f64e9deb45a49c055d6c808f7711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771306894&amp;x-signature=3wVwHyEB%2FWgp4c8X1EEsL5PS2SA%3D" alt="seed-2.png" loading="lazy"/></p>
<h3 data-id="heading-13">2. 核心维度分析</h3>
<h4 data-id="heading-14">SQL 理解：55.2 分</h4>
<p><em>字节 Seed-OSS-36B</em> 展现了**“偏科”** 的特性。其语法检测得分高达 88.6，能够识别出极其隐蔽的方言冲突和拼写错误；但执行准确性（48.6）偏低，模型在分析 <code>SELECT</code> 查询时，虽然正确计算出了查询结果（列名和数据行均准确），但将 <code>result_type</code> 错误标识为 <code>table_state</code> 而非 <code>select</code>，混淆了查询操作 <code>SELECT</code> 与表状态修改操作 <code>INSERT/UPDATE/DELETE</code> 的语义分类，反映出其对 SQL 语句类型的理解和分类能力存在缺陷，以及在结构化输出的语义一致性把控上不够严谨。</p>
<h4 data-id="heading-15">SQL 优化：55.3 分</h4>
<p>其优化策略相对保守。索引建议（53.8 分）多集中在单表简单索引，模型暴露出三个核关键问题：推荐索引时添加了非必要的 ID 列、未能识别与现有索引的冗余关系、以及无法检测隐式类型转换导致的索引失效问题，综合反映出其在索引列选择精准度、已有索引上下文分析能力以及索引生效机制的深层理解上均存在不足，缺乏全局优化视角。</p>
<h4 data-id="heading-16">方言转换：55.0 分</h4>
<p>模型存在较明显的“长度天花板”。在标准短 SQL 转换中表现优异，但在 “大 SQL 转换” 测试项中仅得 19.4 分，模型暴露出对过程语言和复杂 DML 转换的系统性缺陷：<em>Oracle 转 PostgreSQL</em> 时，错误地将表达式用于 <code>GET DIAGNOSTICS</code> 目标位置、混用 PL/SQL 特有的 <code>TYPE ... IS RECORD</code> 和游标属性语法（%NOTFOUND、SQL%ROWCOUNT），未能正确映射到 PL/pgSQL 规范；<em>SQL Server 转 GaussDB</em> 时，保留了 <code>+</code> 字符串拼接运算符而非使用 <code>||</code>，且在多表 <code>UPDATE ... FROM</code> 语句中错误地将目标表纳入 <code>FROM</code> 列表却缺失关联条件，导致笛卡尔积和逻辑错误。这些问题反映出模型在过程语言方言差异、运算符映射规则以及复杂 DML 语义等价转换上的理解深度不足，尤其缺乏对目标方言隐含规则和语法约束的精准把握。</p>
<h3 data-id="heading-17">3. 应用价值建议</h3>
<ul>
<li><strong>推荐场景</strong>：适用于代码审计、日常 SQL 规范性校验、轻量级数据库日常维护。</li>
<li><strong>实战建议</strong>：推荐将其集成在 IDE 插件中进行实时的语法纠错；对于涉及数百行、跨多层嵌套的复杂存储过程，建议拆解后再交给模型处理。</li>
</ul>
<blockquote>
<p>该模型的发布时间较早，SCALE 将持续关注字节跳动 Seed 团队的发布计划，第一时间带来测评分析。</p>
</blockquote>
<h2 data-id="heading-18">五、SCALE 网站更新</h2>
<p>为了增强 SCALE 的技术沉淀，本月我们上线了以下功能：</p>
<ol>
<li><strong>新闻模块</strong>：查看往期发版深度分析，追踪 SCALE 评测标准的演进历程。</li>
<li><strong>博客模块</strong>：沉淀社区专家的实战案例，手把手教您如何基于测评数据选择最适合的大模型方案。</li>
</ol>
<h2 data-id="heading-19">六、总结与建议</h2>
<p><strong>本月的测评结果不仅是模型分数的更新，更揭示了通用大语言模型在专业数据库领域发展的两个核心趋势：</strong></p>
<ul>
<li>从“写对语法”向“跑得更快”转变</li>
<li>国产化迁移能力的快速成熟</li>
</ul>
<h3 data-id="heading-20">关注模型在复杂场景下的“能力阶梯”</h3>
<p>根据本次 <strong>“大 SQL 转换”</strong> 专项测试，国产大模型在长文本逻辑处理上仍面临挑战（如 Seed 模型在长 SQL 任务中得分排名较为落后）。</p>
<ul>
<li><strong>开发策略建议</strong>：对于业务逻辑极度复杂的 SQL 或存储过程，建议采用**“逻辑分块”**的协作方式，即由人工明确核心逻辑单元，再由大模型进行分块实现或转换，以抵消大模型的长距离逻辑漂移。</li>
<li><strong>校验必要性</strong>：鉴于部分模型存在 <strong>“高语法分、低执行准确性”</strong> 的现象（如执行准确率低于 50% 的情况），生产环境的 SQL 必须经过严格的逻辑验证与性能压测。</li>
</ul>
<h3 data-id="heading-21">利用大模型加速国产化迁移的“黄金期”</h3>
<p>评测数据显示，国产模型在 <strong>“国产数据库转换”</strong> 维度已表现出极高的适配性（如 GLM-4.7 达到 89.5 分）。</p>
<ul>
<li><strong>架构演进建议</strong>：面对企业级国产化迁移趋势，通用大模型已具备处理绝大部分标准函数与语法映射的能力，可以作为迁移工程初期的自动化底座。</li>
<li><strong>索引优化前置</strong>：随着 <strong>“索引建议”</strong> 能力的引入，大模型开始能够提供初步的物理结构参考。企业在进行数据库迁移时，可以同步利用大模型的建议进行 Schema 的初步调优，而非仅仅是原样搬迁。</li>
</ul>
<h2 data-id="heading-22">七、专家点评</h2>
<blockquote>
<p>白鳝（徐戟），佰晟智算 CEO。著有《DBA 的思想天空》《实战国产数据库》等技术专著。担任多家国产数据库厂商的技术顾问。Oracle ACE、PostgreSQL ACE Director。</p>
</blockquote>
<p><em>国产开源大模型在 SQL 编程能力上的进步是令人兴奋的，这使得 AIOPS 有了十分有力的支撑，让 SQL 审计、SQL 优化这些涉密的任务可以在内网安全环境中实现。</em></p>
<p><em>SCALE 榜单的出现让 AI 应用开发者有了一个十分权威的参考，本次模型 SQL 能力榜单与我们的实际应用感受相当一致，为爱可生开源社区点个赞。</em></p>
<hr/>
<p>SCALE 评测体系将持续跟踪各大厂商的最新模型动态和迭代进展。我们致力于通过公正、透明的评测数据，与社区共同推动大语言模型在数据库领域的应用和实践走向更深层次。</p>
<p><strong>即刻探索新一代模型的专业能力！</strong> 欢迎您访问 SCALE 官方网站，查看完整的最新榜单和模型对比详情，共同把握 AI 技术的前沿脉搏。</p>
<p><em>数据截止时间：2026/1/5</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 设计与落地 [9 - 2]：微前端架构的设计陷阱]]></title>    <link>https://juejin.cn/post/7604775190212657162</link>    <guid>https://juejin.cn/post/7604775190212657162</guid>    <pubDate>2026-02-10T05:47:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604775190212657162" data-draft-id="7604775190212624394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 设计与落地 [9 - 2]：微前端架构的设计陷阱"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-10T05:47:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 设计与落地 [9 - 2]：微前端架构的设计陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T05:47:26.000Z" title="Tue Feb 10 2026 05:47:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>很多人把微前端理解为“把一个大页面拆成几个小页面”。 如果只是这样，<code>&lt;iframe&gt;</code> 已经够用了。</p>
<p>微前端的本质不是<strong>分发</strong>，而是<strong>协调</strong>。</p>
<p>真正的微前端架构，是一套<strong>复杂的系统工程</strong>。它需要解决：应用的加载与路由分发、样式隔离、状态共享、公共依赖管理，以及最核心的——<strong>如何让不同团队在互不干扰的情况下独立开发和部署</strong>。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/728dc62869e04d9cbfe6861352ab4a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771307535&amp;x-signature=mowstdANjXmLiLSrQarpQdttq5Q%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 为什么我们要“拆”？（微前端的核心价值）</h2>
<p>在决定“拆”之前，先问问自己，你的项目是否面临以下问题：</p>
<ol>
<li><strong>技术债堆积：</strong> 核心系统还在用老掉牙的技术栈（比如 jQuery），想换 React/Vue 但重构代价太大。</li>
<li><strong>构建速度崩溃：</strong> 每次改一行代码，本地编译要 10 分钟，CI/CD 要半小时。</li>
<li><strong>协作冲突：</strong> 几十个前端在同一个仓库提交代码，代码冲突和“线上互相踩脚”成为常态。</li>
</ol>
<hr/>
<h2 data-id="heading-1">二、 三大主流方案的“三国演义”</h2>
<p>在微前端的世界里，目前有三股势力最为强大。架构师需要根据业务场景进行精准选型：</p>

































<table><thead><tr><th>方案</th><th>核心原理</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>iframe</strong></td><td>浏览器原生容器</td><td>彻底的隔离，上手最快</td><td>性能差，SEO 难，通信极其痛苦，弹窗无法溢出</td><td>外部系统嵌入，极简集成</td></tr><tr><td><strong>qiankun (基于协议)</strong></td><td>JS 沙箱 + HTML Entry</td><td>技术栈无关，生态成熟，支持子应用预加载</td><td>样式隔离不彻底，侵入性较强（需改造子应用）</td><td>企业级中后台，跨团队协作</td></tr><tr><td><strong>Module Federation</strong></td><td>Webpack 5 模块联邦</td><td><strong>性能最高</strong>，原生共享依赖，无沙箱开销</td><td>强绑定 Webpack，无原生样式隔离</td><td><strong>同构系统</strong>（技术栈统一）的性能优化</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">三、 避坑指南：微前端的设计陷阱</h2>
<p>很多项目死掉，不是因为方案不好，而是掉进了这些坑里：</p>
<h3 data-id="heading-3">3.1 样式的“灵异事件”</h3>
<ul>
<li><strong>陷阱：</strong> 子应用 A 改了 <code>.btn</code> 的颜色，导致子应用 B 的按钮也变色了。</li>
<li><strong>对策：</strong> 不要完全依赖 CSS-in-JS。使用 <strong>Shadow DOM</strong>（最彻底但有兼容性坑）或者 <strong>CSS Prefix（CSS 前缀）</strong> 配合工程化工具强制加上命名空间。</li>
</ul>
<h3 data-id="heading-4">3.2 “重”应用的加载地狱</h3>
<ul>
<li><strong>陷阱：</strong> 主应用加载了 React，子应用 A 加载了 React，子应用 B 还是 React。用户打开一个页面要下载三份 React 运行时。</li>
<li><strong>对策：</strong> 必须在构建层面做 <strong>Externals（外部依赖抽取）</strong> 或者利用 <strong>Module Federation</strong> 共享公共底座。</li>
</ul>
<h3 data-id="heading-5">3.3 共享状态的“过度耦合”</h3>
<ul>
<li><strong>陷阱：</strong> 试图通过全局变量在子应用之间共享复杂的业务逻辑。</li>
<li><strong>对策：</strong> 遵循 <strong>“最小化通信”原则</strong>。子应用之间应该是通过 <strong>CustomEvents</strong> 或 <strong>URL 参数</strong> 进行简单的解耦通信，而不是共用一个巨大的 Redux Store。</li>
</ul>
<h3 data-id="heading-6">3.4 路由的“多重人格”</h3>
<p>主应用有一套路由，子应用也有一套路由。</p>
<ul>
<li><strong>陷阱：</strong> 当你在子应用 A 里点击跳转，URL 变了，但主应用可能没监听到，导致侧边栏的高亮状态不同步。</li>
<li><strong>最佳实践：</strong> 采用 <strong>“主应用托管路由，子应用消费路由”</strong> 。子应用内部不应直接使用 <code>BrowserRouter</code>，而应使用 <code>MemoryRouter</code> 或由主应用下发的路由实例。</li>
</ul>
<h3 data-id="heading-7">3.5 性能的“木桶效应”</h3>
<p>微前端的启动速度取决于<strong>最慢的那一个子应用</strong>。</p>
<ul>
<li><strong>架构手段：</strong> 1. <strong>子应用预加载 (Preload):</strong> 在用户还没点开子应用 B 时，利用浏览器空闲时间（<code>requestIdleCallback</code>）悄悄拉取静态资源。 2. <strong>骨架屏同步：</strong> 基座要接管子应用加载过程中的 Loading 状态，避免“白屏 -&gt; Loading -&gt; 白屏 -&gt; 渲染”的跳跃感。</li>
</ul>
<h3 data-id="heading-8">3.6 全局组件的“溢出地狱”</h3>
<ul>
<li><strong>问题：</strong> 子应用里的 <code>Tooltip</code> 或 <code>Select</code> 展开时，如果容器开启了 <code>overflow: hidden</code>，选项会被截断。</li>
<li><strong>架构决策：</strong> 所有浮层必须通过 <code>Portal</code> 挂载到基座的特定容器下，并确保基座对这些容器有统一的样式注入。</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、 架构师的最佳实践清单</h2>
<p>如果你决定落地微前端，请确保你已经准备好了以下配套：</p>
<ol>
<li><strong>统一的 UI 规范：</strong> 如果子应用 A 用 AntD，子应用 B 用 Element，最后拼出来的页面会像“缝合怪”。</li>
<li><strong>自动化的路由托管：</strong> 主应用负责监听路由并分发，子应用只需关心自己的内页。</li>
<li><strong>独立部署流水线 (CI/CD)：</strong> 这是微前端的<strong>灵魂</strong>。子应用的发布不应该依赖主应用的重启。</li>
<li><strong>全链路监控：</strong> 当一个报错发生时，你必须能一眼看出是主应用的基座崩了，还是某个子应用的代码写烂了。</li>
</ol>
<p>一个合格的微前端架构师，应该建立一套**“接入协议”**：</p>
<ol>
<li><strong>生命周期约束：</strong> 必须导出 <code>bootstrap</code> (初始化)、<code>mount</code> (挂载)、<code>unmount</code> (卸载) 三个钩子。</li>
<li><strong>契约化通信：</strong> 禁止直接读写 <code>window</code>。必须通过 <code>props</code> 下发的 <code>EventBus</code> 或全局 <code>Actions</code> 进行跨应用通信。</li>
<li><strong>独立版本控制：</strong> 子应用必须有独立的仓库和独立的域名，通过 <code>manifest.json</code> 动态告诉主应用最新代码的地址。</li>
</ol>
<hr/>
<h2 data-id="heading-10">五、 总结：何时该回归“单体”？</h2>
<p>架构师最需要时刻警惕的是：<strong>微前端增加了系统的熵值。</strong></p>
<p>如果你的团队只有 5 个人，且业务模块相对固定，那么<strong>微前端就是过度设计</strong>。此时，一个整洁的 <strong>Monorepo (单仓库多项目)</strong> 方案可能比微前端更高效、更稳定。</p>
<p><strong>架构的艺术在于：在应用规模小的时候保持单体的简洁，在规模爆炸前预留拆分的口子。</strong></p>
<p>当你考虑使用微前端时，请对照这个 <strong>ROI (投入产出比)</strong> 公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>架构收益</mtext><mo>=</mo><mo stretchy="false">(</mo><mtext>开发解耦速度</mtext><mo>+</mo><mtext>技术栈迁移收益</mtext><mo stretchy="false">)</mo><mo>−</mo><mo stretchy="false">(</mo><mtext>系统复杂度增加</mtext><mo>+</mo><mtext>通信成本</mtext><mo>+</mo><mtext>调试难度</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">架构收益 = (开发解耦速度 + 技术栈迁移收益) - (系统复杂度增加 + 通信成本 + 调试难度)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">架构收益</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord cjk_fallback">开发解耦速度</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">技术栈迁移收益</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord cjk_fallback">系统复杂度增加</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">通信成本</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">调试难度</span><span class="mclose">)</span></span></span></span></span></p>
<p>如果你的收益是负数，请果断停手。</p>
<p><strong>记住：微前端不是为了让前端变得更酷，而是为了让 50 个人协作起来像 5 个人一样高效。</strong></p>
<hr/>
<h2 data-id="heading-11">结语：延伸的触角</h2>
<p>微前端解决了前端之间的“分治”问题，但前端与后端之间的那层“胶水”依然脆弱。当业务逻辑变得极端复杂，前端是否应该接管一部分后端的职能？</p>
<blockquote>
<p><strong>Next Step:</strong></p>
<p>随着云原生和 Node.js 生态的成熟，前端架构的边界正在向后端无限延伸。 下一节，我们将探讨前端架构师的“跨界”武器。 请看**《第三篇：延伸——打破边界：BFF (Backend for Frontend) 层与 Serverless 的架构融合》**。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何让 MyBatis 批量插入从5分钟缩短到3秒？我的三个关键优化]]></title>    <link>https://juejin.cn/post/7604775190212673546</link>    <guid>https://juejin.cn/post/7604775190212673546</guid>    <pubDate>2026-02-10T05:52:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604775190212673546" data-draft-id="7604784281957154854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何让 MyBatis 批量插入从5分钟缩短到3秒？我的三个关键优化"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-10T05:52:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何让 MyBatis 批量插入从5分钟缩短到3秒？我的三个关键优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T05:52:31.000Z" title="Tue Feb 10 2026 05:52:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周接了个数据迁移的活，要把10万条数据从老系统导入新系统。</p>
<p>写了个简单的批量插入，跑起来一看——5分钟。</p>
<p>领导说太慢了，能不能快点？</p>
<p>折腾了一下午，最后优化到3秒，记录一下过程。</p>
<h3 data-id="heading-0"/>
<h3 data-id="heading-1"/>
<h3 data-id="heading-2">最初的代码（5分钟）</h3>
<p>最开始写的很简单，foreach循环插入：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 方式1：循环单条插入（最慢）</span>
for (User user : userList) {
    userMapper<span class="hljs-selector-class">.insert</span>(user);
}
</code></pre>
<p>10万条数据，每条都要走一次网络请求、一次SQL解析、一次事务提交。</p>
<p>算一下：假设每条插入需要3ms，10万条就是300秒 = 5分钟。</p>
<p><strong>这是最蠢的写法，但我见过很多项目都这么写。</strong></p>
<h3 data-id="heading-3"/>
<h3 data-id="heading-4"/>
<h3 data-id="heading-5">第一次优化：批量SQL（30秒）</h3>
<p>把循环插入改成批量SQL：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Mapper.xml --&gt;</span>
&lt;insertid="batchInsert"&gt;
    INSERT INTO user (name, age, email) VALUES
    &lt;foreachcollection="list"item="item"separator=","&gt;
        (#{item.name}, #{item.age}, #{item.email})
    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
</code></pre>

<pre><code class="hljs language-ini" lang="ini">// 分批插入，每批1000条
int <span class="hljs-attr">batchSize</span> = <span class="hljs-number">1000</span><span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; userList.size(); i += batchSize) {</span>
    int <span class="hljs-attr">end</span> = Math.min(i + batchSize, userList.size())<span class="hljs-comment">;</span>
    List&lt;User&gt; <span class="hljs-attr">batch</span> = userList.subList(i, end)<span class="hljs-comment">;</span>
    userMapper.batchInsert(batch)<span class="hljs-comment">;</span>
}
</code></pre>
<p>从5分钟降到30秒，提升10倍。</p>
<p>原理：一条SQL插入多条数据，减少网络往返次数。</p>
<p>但还有问题：30秒还是太慢。</p>
<h3 data-id="heading-6"/>
<h3 data-id="heading-7"/>
<h3 data-id="heading-8">第二次优化：JDBC批处理（8秒）</h3>
<p>MySQL有个参数叫<code>rewriteBatchedStatements</code>，开启后可以把多条INSERT合并成一条。</p>
<h5 data-id="heading-9">第一步：修改数据库连接URL</h5>
<pre><code class="hljs language-bash" lang="bash">jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=<span class="hljs-literal">true</span>
</code></pre>
<h5 data-id="heading-10">第二步：使用MyBatis的批处理模式</h5>
<pre><code class="hljs language-ini" lang="ini">@Autowired
private SqlSessionFactory sqlSessionFactory<span class="hljs-comment">;</span>

publicvoidbatchInsertWithExecutor(List&lt;User&gt; userList){
    try (SqlSession <span class="hljs-attr">sqlSession</span> = sqlSessionFactory.openSession(ExecutorType.BATCH)) {
        UserMapper <span class="hljs-attr">mapper</span> = sqlSession.getMapper(UserMapper.class)<span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">batchSize</span> = <span class="hljs-number">1000</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; userList.size(); i++) {</span>
            mapper.insert(userList.get(i))<span class="hljs-comment">;</span>
            
            if ((i + 1) % <span class="hljs-attr">batchSize</span> == <span class="hljs-number">0</span>) {
                sqlSession.flushStatements()<span class="hljs-comment">;</span>
                sqlSession.clearCache()<span class="hljs-comment">;</span>
            }
        }
        sqlSession.flushStatements()<span class="hljs-comment">;</span>
        sqlSession.commit()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>从30秒降到8秒。</p>
<p>原理：<code>ExecutorType.BATCH</code>模式下，MyBatis会缓存SQL，最后一次性发送给数据库执行。配合<code>rewriteBatchedStatements=true</code>，MySQL驱动会把多条INSERT合并。</p>
<h3 data-id="heading-11"/>
<h3 data-id="heading-12"/>
<h3 data-id="heading-13">第三次优化：多线程并行（3秒）</h3>
<p>8秒还是不够快，上多线程：</p>
<pre><code class="hljs language-ini" lang="ini">publicvoidparallelBatchInsert(List&lt;User&gt; userList){
    int <span class="hljs-attr">threadCount</span> = <span class="hljs-number">4</span><span class="hljs-comment">;  // 根据数据库连接池大小调整</span>
    int <span class="hljs-attr">batchSize</span> = userList.size() / threadCount<span class="hljs-comment">;</span>
    
    ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(threadCount)<span class="hljs-comment">;</span>
    List&lt;Future&lt;?&gt;&gt; <span class="hljs-attr">futures</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
    
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; threadCount; i++) {</span>
        int <span class="hljs-attr">start</span> = i * batchSize<span class="hljs-comment">;</span>
        int <span class="hljs-attr">end</span> = (i == threadCount - <span class="hljs-number">1</span>) ? userList.size() : (i + <span class="hljs-number">1</span>) * batchSize<span class="hljs-comment">;</span>
        List&lt;User&gt; <span class="hljs-attr">subList</span> = userList.subList(start, end)<span class="hljs-comment">;</span>
        
        futures.add(executor.submit(() -&gt; {
            batchInsertWithExecutor(subList)<span class="hljs-comment">;</span>
        }))<span class="hljs-comment">;</span>
    }
    
    // 等待所有任务完成
    for (Future&lt;?&gt; future : futures) {
        try {
            future.get()<span class="hljs-comment">;</span>
        } catch (Exception e) {
            thrownew RuntimeException(e)<span class="hljs-comment">;</span>
        }
    }
    
    executor.shutdown()<span class="hljs-comment">;</span>
}
</code></pre>
<p>从8秒降到3秒。</p>
<p>注意事项：</p>
<ul>
<li>线程数不要超过数据库连接池大小</li>
<li>如果需要事务一致性，这个方案不适用</li>
<li>要考虑主键冲突的问题</li>
</ul>
<h3 data-id="heading-14"/>
<h3 data-id="heading-15"/>
<h3 data-id="heading-16">优化效果对比</h3>
<h3 data-id="heading-17"/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6da9e695da64dcca1741bfe530658f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771307553&amp;x-signature=vMP1%2FFJVFxJLToBuBOFPs1sIl4w%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-18"/>
<h3 data-id="heading-19">踩过的坑</h3>
<h5 data-id="heading-20">坑1：foreach拼接SQL过长</h5>
<pre><code class="hljs language-ini" lang="ini">&lt;foreach <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> item=<span class="hljs-string">"item"</span> separator=<span class="hljs-string">","</span>&gt;
</code></pre>
<p>如果一次插入太多条，SQL会非常长，可能超过<code>max_allowed_packet</code>限制。</p>
<p><strong>解决：</strong>  分批插入，每批500-1000条。</p>
<h5 data-id="heading-21">坑2：rewriteBatchedStatements不生效</h5>
<p>检查几个点：</p>
<ul>
<li>URL参数是否正确：<code>rewriteBatchedStatements=true</code></li>
<li>是否使用了<code>ExecutorType.BATCH</code></li>
<li>MySQL驱动版本是否太旧</li>
</ul>
<h5 data-id="heading-22">坑3：自增主键返回问题</h5>
<p>批量插入时想获取自增主键：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;<span class="hljs-attr">insertid</span>=<span class="hljs-string">"batchInsert"</span>useGeneratedKeys=<span class="hljs-string">"true"</span>keyProperty=<span class="hljs-string">"id"</span>&gt;
</code></pre>
<p>注意：<code>rewriteBatchedStatements=true</code>时，自增主键返回可能有问题，需要升级MySQL驱动到8.0.17+。</p>
<h5 data-id="heading-23">坑4：内存溢出</h5>
<p>10万条数据一次性加载到内存，可能OOM。</p>
<p>解决：分页读取 + 分批插入。</p>
<pre><code class="hljs language-ini" lang="ini">int <span class="hljs-attr">pageSize</span> = <span class="hljs-number">10000</span><span class="hljs-comment">;</span>
int <span class="hljs-attr">total</span> = countTotal()<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; total; i += pageSize) {</span>
    List&lt;User&gt; <span class="hljs-attr">page</span> = selectByPage(i, pageSize)<span class="hljs-comment">;</span>
    batchInsertWithExecutor(page)<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-24"/>
<h3 data-id="heading-25"/>
<h3 data-id="heading-26">最终方案代码</h3>
<pre><code class="hljs language-ini" lang="ini">@Service
publicclassBatchInsertService{
    
    @Autowired
    private SqlSessionFactory sqlSessionFactory<span class="hljs-comment">;</span>
    
    /**
     * 高性能批量插入
     * 10万条数据约3秒
     */
    publicvoidhighPerformanceBatchInsert(List&lt;User&gt; userList){
        if (<span class="hljs-attr">userList</span> == null || userList.isEmpty()) {
            return<span class="hljs-comment">;</span>
        }
        
        int <span class="hljs-attr">threadCount</span> = Math.min(<span class="hljs-number">4</span>, Runtime.getRuntime().availableProcessors())<span class="hljs-comment">;</span>
        int <span class="hljs-attr">batchSize</span> = (int) Math.ceil((double) userList.size() / threadCount)<span class="hljs-comment">;</span>
        
        ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(threadCount)<span class="hljs-comment">;</span>
        CountDownLatch <span class="hljs-attr">latch</span> = new CountDownLatch(threadCount)<span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; threadCount; i++) {</span>
            int <span class="hljs-attr">start</span> = i * batchSize<span class="hljs-comment">;</span>
            int <span class="hljs-attr">end</span> = Math.min((i + <span class="hljs-number">1</span>) * batchSize, userList.size())<span class="hljs-comment">;</span>
            
            if (start &gt;= userList.size()) {
                latch.countDown()<span class="hljs-comment">;</span>
                continue<span class="hljs-comment">;</span>
            }
            
            List&lt;User&gt; <span class="hljs-attr">subList</span> = new ArrayList&lt;&gt;(userList.subList(start, end))<span class="hljs-comment">;</span>
            
            executor.submit(() -&gt; {
                try {
                    doBatchInsert(subList)<span class="hljs-comment">;</span>
                } finally {
                    latch.countDown()<span class="hljs-comment">;</span>
                }
            })<span class="hljs-comment">;</span>
        }
        
        try {
            latch.await()<span class="hljs-comment">;</span>
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt()<span class="hljs-comment">;</span>
        }
        
        executor.shutdown()<span class="hljs-comment">;</span>
    }
    
    privatevoiddoBatchInsert(List&lt;User&gt; userList){
        try (SqlSession <span class="hljs-attr">sqlSession</span> = sqlSessionFactory.openSession(ExecutorType.BATCH, <span class="hljs-literal">false</span>)) {
            UserMapper <span class="hljs-attr">mapper</span> = sqlSession.getMapper(UserMapper.class)<span class="hljs-comment">;</span>
            
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; userList.size(); i++) {</span>
                mapper.insert(userList.get(i))<span class="hljs-comment">;</span>
                
                if ((i + 1) % <span class="hljs-attr">1000</span> == <span class="hljs-number">0</span>) {
                    sqlSession.flushStatements()<span class="hljs-comment">;</span>
                    sqlSession.clearCache()<span class="hljs-comment">;</span>
                }
            }
            
            sqlSession.flushStatements()<span class="hljs-comment">;</span>
            sqlSession.commit()<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-27"/>
<h3 data-id="heading-28"/>
<h3 data-id="heading-29">总结</h3>
<h3 data-id="heading-30"/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e270d75098d948998577c9c53d48202a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771307553&amp;x-signature=stAnw%2BdeTn6WdKl7fJhR0rlskdc%3D" alt="图片" loading="lazy"/></p>
<p><strong>核心原则：</strong>  减少网络往返 + 减少事务次数 + 并行处理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TDesign E2E —— 一套配置驱动、可扩展的端到端测试框架]]></title>    <link>https://juejin.cn/post/7604701848150802432</link>    <guid>https://juejin.cn/post/7604701848150802432</guid>    <pubDate>2026-02-10T04:03:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604701848150802432" data-draft-id="7604779604125106176" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TDesign E2E —— 一套配置驱动、可扩展的端到端测试框架"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-10T04:03:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Novlan1"/> <meta itemprop="url" content="https://juejin.cn/user/1987523605435432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TDesign E2E —— 一套配置驱动、可扩展的端到端测试框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1987523605435432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Novlan1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:03:17.000Z" title="Tue Feb 10 2026 04:03:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style>
<h2 data-id="heading-0">一、项目背景</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftdesign.tencent.com%2F" target="_blank" title="https://tdesign.tencent.com/" ref="nofollow noopener noreferrer">TDesign</a> 是腾讯开源的企业级设计体系，覆盖了 Vue Next、UniApp、小程序、Mobile Vue 等多个技术栈，其官网承载着大量组件文档页面。随着站点规模增长，一个核心风险始终存在——<strong>页面发布后白屏</strong>或<strong>关键元素丢失</strong>。手工巡检不现实，传统的单元测试又覆盖不到真实浏览器的渲染链路。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTDesignOteam%2Ftdesign-e2e-test" target="_blank" title="https://github.com/TDesignOteam/tdesign-e2e-test" ref="nofollow noopener noreferrer">tdesign-e2e-test</a> 正是为解决这一问题而设计的：基于 <strong>Puppeteer + Jest</strong>，通过 <strong>纯配置驱动</strong> 的方式，让开发者只需编写 JSON 风格的配置对象，即可自动生成完整的 E2E 测试用例，<strong>零测试代码编写</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、整体架构</h2>
<p>项目采用 <strong>"配置层 → 引擎层 → 工具层"</strong> 三层架构，各层职责清晰、互不耦合：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 配置层["📂 配置层 (tests/config/)"]
        types["types.ts&lt;br/&gt;类型定义"]
        modules["modules/&lt;br/&gt;模块化配置"]
        entry["pages.config.ts&lt;br/&gt;配置汇总入口"]
        modules --&gt; entry
        types -.-&gt; modules
    end

    subgraph 引擎层["⚙️ 引擎层 (tests/)"]
        spec["tdesign.spec.ts&lt;br/&gt;测试引擎&lt;br/&gt;自动遍历配置 → 生成用例"]
    end

    subgraph 工具层["🔧 工具层 (tests/utils/)"]
        helpers["helpers.ts&lt;br/&gt;白屏检测 / 元素检测&lt;br/&gt;Shadow DOM 穿透&lt;br/&gt;操作执行器"]
    end

    subgraph CI["🚀 CI/CD"]
        workflow["GitHub Actions&lt;br/&gt;定时 + Push 触发"]
        notify["scripts/notify.ts&lt;br/&gt;企业微信机器人通知"]
        workflow --&gt; notify
    end

    entry --&gt; spec
    spec --&gt; helpers
    spec --&gt; CI
</code></pre>
<h3 data-id="heading-2">2.1 配置层：声明式描述"测什么"</h3>
<p>配置层是用户唯一需要关注的部分。核心类型 <code>PageConfig</code> 定义了一个测试用例的完整描述：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PageConfig</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;                <span class="hljs-comment">// 用例名称</span>
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;                 <span class="hljs-comment">// 目标页面</span>
  whiteScreenCheck?: <span class="hljs-built_in">boolean</span>;  <span class="hljs-comment">// 是否白屏检测</span>
  expectedSelectors?: <span class="hljs-built_in">string</span>[];<span class="hljs-comment">// 期望存在的元素</span>
  actions?: <span class="hljs-title class_">PageAction</span>[];      <span class="hljs-comment">// 操作序列（点击/悬浮/导航/滚动/输入）</span>
  afterActionCheck?: <span class="hljs-title class_">AfterActionCheck</span>; <span class="hljs-comment">// 操作后校验</span>
  viewport?: { width; height };<span class="hljs-comment">// 自定义视口</span>
  skip?: <span class="hljs-built_in">boolean</span>;              <span class="hljs-comment">// 跳过标记</span>
}
</code></pre>
<p>使用者只需填写配置对象，<strong>不需要编写任何 <code>test()</code>、<code>expect()</code> 代码</strong>。框架会自动将每条配置映射为一个独立的 Jest 测试用例。</p>
<h3 data-id="heading-3">2.2 引擎层：自动化遍历 + 用例生成</h3>
<p><code>tdesign.spec.ts</code> 是整个框架的"心脏"，核心逻辑仅约 120 行，但完成了以下工作：</p>
<ol>
<li><strong>启动浏览器</strong>：<code>beforeAll</code> 中初始化 Puppeteer，CI 环境自动切换 headless 模式</li>
<li><strong>遍历配置、生成用例</strong>：<code>for (const pageConfig of pagesConfig)</code> 循环，为每条配置动态生成 <code>test()</code></li>
<li><strong>标准化测试流程</strong>：每个用例按统一管线执行——设置视口 → 注册错误收集 → 访问页面 → 等待网络空闲 → 白屏检测 → 元素检测 → 执行操作 → 操作后校验</li>
<li><strong>资源管理</strong>：每个用例独立开启/关闭 Page，<code>afterAll</code> 中关闭浏览器，杜绝内存泄漏</li>
</ol>
<p>这种设计让引擎层成为"不可变的骨架"——<strong>新增测试用例永远不需要修改引擎代码</strong>。</p>
<h3 data-id="heading-4">2.3 工具层：对抗 Web Components 的深度穿透</h3>
<p>TDesign 官网大量使用了 Web Components + Shadow DOM（如 <code>&lt;td-header&gt;</code>、<code>&lt;td-doc-layout&gt;</code>），传统的 <code>document.querySelector</code> 无法穿透 Shadow DOM 边界。</p>
<p><code>helpers.ts</code> 中实现了一套 <strong>递归穿透 Shadow DOM 的选择器引擎</strong>，这是整个项目最有技术含量的部分：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">deepQuerySelector</span>(page, selector)
│
├── 普通选择器 <span class="hljs-string">".TDesign-header"</span>
│   └── 递归遍历所有 ShadowRoot + Slot 分发内容
│
└── 穿透组合选择器 <span class="hljs-string">"td-header &gt;&gt;&gt; .TDesign-header-nav"</span>
    └── 按 <span class="hljs-string">"&gt;&gt;&gt;"</span> 分段，逐层进入 Shadow DOM
</code></pre>
<p>此外，<code>waitForVisible()</code> 实现了轮询等待机制，不仅检查元素存在，还验证其真实可见性（<code>getBoundingClientRect</code> + <code>getComputedStyle</code>），避免 <code>display:none</code> 或零尺寸元素的误判。</p>
<p><strong>白屏检测</strong> 采用 4 层递进策略：</p>






























<table><thead><tr><th>层级</th><th>检测项</th><th>目的</th></tr></thead><tbody><tr><td>1</td><td><code>body.children.length &gt; 0</code></td><td>排除完全空白页</td></tr><tr><td>2</td><td><code>body.innerHTML.length &gt; 50</code></td><td>排除仅有空标签壳</td></tr><tr><td>3</td><td>递归穿透 Shadow DOM 找可见内容</td><td>排除 Web Components 内部白屏</td></tr><tr><td>4</td><td>检查 SPA 根挂载点 + 自定义元素</td><td>排除框架未挂载</td></tr></tbody></table>
<p>四层策略相互补充，既能检测传统 SPA 白屏，也能覆盖 Web Components 场景。</p>
<hr/>
<h2 data-id="heading-5">三、灵活的配置方式</h2>
<h3 data-id="heading-6">3.1 五种操作类型覆盖主流交互</h3>
<p>框架内置了 5 种操作类型，通过组合使用可以模拟几乎所有用户交互场景：</p>



































<table><thead><tr><th>类型</th><th>用途</th><th>关键参数</th></tr></thead><tbody><tr><td><code>click</code></td><td>点击元素，支持自动等待导航</td><td><code>selector</code></td></tr><tr><td><code>hover</code></td><td>鼠标悬浮，验证浮层/下拉菜单</td><td><code>selector</code></td></tr><tr><td><code>navigate</code></td><td>SPA 路由跳转</td><td><code>targetUrl</code></td></tr><tr><td><code>scroll</code></td><td>页面滚动，测试懒加载</td><td><code>scrollY</code></td></tr><tr><td><code>input</code></td><td>文本输入，测试搜索/表单</td><td><code>selector</code> + <code>inputValue</code></td></tr></tbody></table>
<p>操作支持 <code>waitBefore</code> / <code>waitAfter</code> 精细控制时序，也支持链式组合——先滚动、再点击、再输入，一气呵成。</p>
<h3 data-id="heading-7">3.2 Shadow DOM 穿透选择器</h3>
<p>针对 Web Components，框架设计了直观的 <code>&gt;&gt;&gt;</code> 穿透语法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 先找到 &lt;td-header&gt;，进入其 Shadow DOM，再找 .TDesign-header-nav</span>
<span class="hljs-attr">selector</span>: <span class="hljs-string">'td-header &gt;&gt;&gt; .TDesign-header-nav'</span>
</code></pre>
<p>普通选择器则自动递归穿透所有层级的 Shadow DOM，开发者无需关心元素在哪一层。</p>
<h3 data-id="heading-8">3.3 操作后校验</h3>
<p>每条配置可以附带 <code>afterActionCheck</code>，在操作执行后自动验证：</p>
<ul>
<li><strong>白屏检测</strong>：操作后页面是否正常渲染</li>
<li><strong>元素检测</strong>：操作后目标元素是否出现</li>
<li><strong>URL 校验</strong>：通过正则匹配验证跳转是否正确</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、可扩展性设计</h2>
<h3 data-id="heading-10">4.1 模块化拆分</h3>
<p>配置按 TDesign 子站拆分为独立模块，存放在 <code>tests/config/modules/</code> 目录下：</p>
<pre><code class="hljs language-java" lang="java">modules/
├── index.ts           ← 统一导出
├── home.ts            ← 官网首页
├── uniapp.ts          ← UniApp
├── miniprogram.ts     ← 小程序
├── vue-next.ts        ← Vue <span class="hljs-title function_">Next</span> <span class="hljs-params">(桌面端)</span>
└── mobile-vue.ts      ← Mobile <span class="hljs-title function_">Vue</span> <span class="hljs-params">(移动端)</span>
</code></pre>
<p><code>pages.config.ts</code> 作为汇总入口，通过展开运算符合并所有模块：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">PageConfig</span>[] = [
  ...homePages,
  ...uniappPages,
  ...miniprogramPages,
  ...vueNextPages,
  ...mobileVuePages,
];
</code></pre>
<h3 data-id="heading-11">4.2 新增模块只需 3 步</h3>
<p>以新增 React 模块为例：</p>
<ol>
<li><strong>创建</strong> <code>modules/react.ts</code>，导出 <code>PageConfig[]</code> 数组</li>
<li><strong>注册</strong> 在 <code>modules/index.ts</code> 中添加一行 <code>export</code></li>
<li><strong>合并</strong> 在 <code>pages.config.ts</code> 中展开 <code>...reactPages</code></li>
</ol>
<p>整个过程不需要修改引擎代码、不需要新建测试文件、不需要改动 CI 配置。</p>
<h3 data-id="heading-12">4.3 新增操作类型</h3>
<p>如果未来需要支持新的交互（如拖拽、长按），只需：</p>
<ol>
<li>在 <code>PageAction.type</code> 联合类型中新增枚举值</li>
<li>在 <code>helpers.ts</code> 的 <code>executeActions</code> 中新增 <code>case</code> 分支</li>
</ol>
<p>引擎层和配置层完全不受影响，体现了 <strong>开闭原则（OCP）</strong>。</p>
<hr/>
<h2 data-id="heading-13">五、易维护性</h2>
<h3 data-id="heading-14">5.1 TypeScript 全链路类型安全</h3>
<p>从配置定义到引擎消费，全程 TypeScript 强类型。<code>PageConfig</code> 接口确保：</p>
<ul>
<li>拼错字段名 → 编译报错</li>
<li>遗漏必填字段 → 编译报错</li>
<li><code>action.type</code> 传入未知值 → 编译报错</li>
</ul>
<p>类型系统充当了"活文档"，开发者阅读接口定义即可理解所有配置项。</p>
<h3 data-id="heading-15">5.2 配置与代码完全解耦</h3>
<p>这是项目最核心的设计理念：<strong>测试逻辑是稳定的框架代码，测试内容是可变的配置数据</strong>。</p>
<ul>
<li>新增页面？→ 只改配置</li>
<li>页面改版？→ 只改选择器</li>
<li>新增检测维度？→ 只改工具函数</li>
</ul>
<p>三个变更方向互不干扰，团队中不同角色可以并行工作。</p>
<h3 data-id="heading-16">5.3 自动化 CI/CD + 告警闭环</h3>
<p>项目集成了 <a href="/Users/guowangyang/Documents/github/tdesign-e2e/.github/workflows/e2e-test.yml" target="_blank" title="/Users/guowangyang/Documents/github/tdesign-e2e/.github/workflows/e2e-test.yml">GitHub Actions 工作流</a>，实现了完整的自动化闭环：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A["⏰ 定时触发&lt;br/&gt;每 10 分钟"] --&gt; B["🧪 执行 E2E 测试"]
    C["📦 master Push"] --&gt; B
    D["🖱️ 手动触发"] --&gt; B
    B --&gt;|通过| E["✅ 上传测试报告"]
    B --&gt;|失败| F["📤 企业微信通知&lt;br/&gt;失败用例 + Actions 链接"]
    F --&gt; E
</code></pre>
<p><code>notify.ts</code> 通知脚本会自动解析 Jest JSON 输出，提取失败用例的名称和错误信息，格式化为 Markdown 消息推送到企业微信，包含直达 Actions 日志的链接。</p>
<h3 data-id="heading-17">5.4 容错设计</h3>
<p>框架在多处做了容错处理，保证单个用例失败不会拖垮整个测试：</p>
<ul>
<li><code>networkIdle</code> 超时不阻塞测试（<code>.catch(() =&gt; {})</code>）</li>
<li>导航超时静默处理（适应 SPA 无导航场景）</li>
<li>每个用例独立开启/关闭 Page，<code>finally</code> 块确保资源释放</li>
<li>控制台错误仅记录告警，不直接判定失败</li>
<li><code>skip</code> 标记支持临时跳过不稳定用例</li>
</ul>
<hr/>
<h2 data-id="heading-18">六、技术亮点总结</h2>





































<table><thead><tr><th>亮点</th><th>说明</th></tr></thead><tbody><tr><td><strong>配置驱动，零代码测试</strong></td><td>使用者只写配置对象，框架自动生成测试用例</td></tr><tr><td><strong>Shadow DOM 深度穿透</strong></td><td>递归遍历 + <code>&gt;&gt;&gt;</code> 穿透语法，完美适配 Web Components</td></tr><tr><td><strong>4 层白屏检测策略</strong></td><td>DOM 结构 + 内容长度 + 可见性 + SPA 挂载点，多维度交叉验证</td></tr><tr><td><strong>模块化配置架构</strong></td><td>按子站拆分，新增模块 3 步完成，零耦合</td></tr><tr><td><strong>全链路 TypeScript</strong></td><td>配置到执行全程类型安全，拼错即报错</td></tr><tr><td><strong>自动化告警闭环</strong></td><td>定时巡检 → 失败检测 → 企业微信推送 → Actions 日志溯源</td></tr><tr><td><strong>容错隔离设计</strong></td><td>单用例失败不扩散，资源自动回收，超时静默降级</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-19">七、适用场景</h2>
<ul>
<li><strong>组件库官网巡检</strong>：防止发布后白屏、关键文档元素丢失</li>
<li><strong>多框架站点监控</strong>：一套框架覆盖 Vue / UniApp / 小程序 / 移动端等所有子站</li>
<li><strong>Web Components 场景</strong>：内置 Shadow DOM 穿透，开箱即用</li>
<li><strong>团队协作</strong>：配置与代码分离，产品/QA 也能编写测试配置</li>
</ul>
<p>这套框架的设计哲学是：<strong>把测试的复杂性封装进框架，把测试的简单性交还给用户</strong>。开发者只需要回答"测哪个页面、检查什么元素、执行什么操作"，剩下的一切——浏览器管理、Shadow DOM 穿透、白屏判定、CI 调度、失败告警——全部由框架接管。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端也能搞模型？在浏览器里跑 Qwen2.5，我给公司省了 5 万 API 费用]]></title>    <link>https://juejin.cn/post/7604741630448893986</link>    <guid>https://juejin.cn/post/7604741630448893986</guid>    <pubDate>2026-02-10T04:17:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604741630448893986" data-draft-id="7604671453454090255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端也能搞模型？在浏览器里跑 Qwen2.5，我给公司省了 5 万 API 费用"/> <meta itemprop="keywords" content="前端,JavaScript,AI编程"/> <meta itemprop="datePublished" content="2026-02-10T04:17:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端也能搞模型？在浏览器里跑 Qwen2.5，我给公司省了 5 万 API 费用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:17:43.000Z" title="Tue Feb 10 2026 04:17:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34fe2125c5044ab7af251979e55cb917~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771301869&amp;x-signature=cpeVAVvHSWB4MpoWcEcLhRAdhYM%3D" alt="run-qwen-locally.webp" loading="lazy"/></p>
<p>月初，财务把上个月的 OpenAI 账单甩在了 咱们 CTO 的桌子上。</p>
<p>数字很惊人：<strong>9000 刀</strong>。</p>
<p>我们那个所谓<strong>AI 赋能</strong> 的内部知识库助手，每个月光 Token 费就要烧掉一辆比亚迪秦PLUS😃。</p>
<p>老板在会上拍桌子：不就是个查文档的机器人吗？为什么要用 GPT-5？能不能换便宜的？能不能限流？GPT-4o 或者 GPT-4o mini 就行?</p>
<p>后端架构师面露难色：精度要求高啊，换 GPT-4o 就变智障。自部署？那得买 H100 显卡，更贵。😖</p>
<p>会议室里充满了<strong>贫穷且焦虑</strong>的空气。</p>
<p>这时候，我默默合上了笔记本，说了一句：<strong>要不，把模型跑在前端吧？让用户的显卡帮我们算。</strong></p>
<p>全场安静了三秒。</p>
<p>后端组长没忍住笑了：浏览器跑大模型？你当 Chrome 是 4090 呢？跑个 Three.js 都能卡，还要跑 Llama 3？😥</p>
<p>我不响。</p>
<p>如果你不知道 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWebGPU_API" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API" ref="nofollow noopener noreferrer"><strong>WebGPU</strong></a>，那我们确实没法聊。</p>
<hr/>
<h3 data-id="heading-0">你的浏览器就是显卡</h3>
<p>兄弟，时代变了🤷‍♂️。</p>
<p>在大多数人的认知里，前端就是切图、调 API、写 React 组件。</p>
<p>计算？那是服务器的事。</p>
<p>但你有没有想过，现在的用户手里拿的是什么设备？</p>
<p><strong>M3 芯片的 MacBook，RTX 4060 的游戏本，甚至 iPhone 15 Pro。</strong></p>
<p>这些设备的算力，如果不利用起来，简直就是<strong>暴殄天物</strong>。</p>
<p>我们现在做的，叫 <strong>Edge AI（边缘 AI）</strong> 。</p>
<p>核心技术就三个词：<strong>WebGPU + WebAssembly + 量化模型</strong>。</p>
<p>以前浏览器只能用 CPU 跑 JS，慢得像蜗牛。</p>
<p>现在有了 WebGPU，JavaScript 可以直接调用底层的显卡算力。</p>
<p>再加上 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwebllm.mlc.ai%2F" target="_blank" title="https://webllm.mlc.ai/" ref="nofollow noopener noreferrer"><strong>WebLLM 🤖</strong></a> 这种大杀器，我们完全可以把 <strong>Llama-3-8B-Instruct</strong> 这种级别的模型，经过 <strong>4bit 量化</strong> 后，压缩到 3-4GB，直接塞进浏览器里。</p>
<p><strong>这意味着什么？</strong></p>
<p>意味着每一次对话，不再消耗公司的 Token，而是消耗<strong>用户自己的电费</strong>。</p>
<p>听起来是不是有点资本家？</p>
<p>不，这叫<strong>分布式计算</strong>，哈哈哈哈哈。😎</p>
<hr/>
<h3 data-id="heading-1">先让 Chrome 跑起来</h3>
<p>说干就干。</p>
<p>我没用后端的一行代码。</p>
<p>直接 <code>npm install @mlc-ai/web-llm</code>。</p>
<p>核心逻辑就这么几行（伪代码），大家可以自己去试一下：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateMLCEngine</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@mlc-ai/web-llm"</span>;

<span class="hljs-comment">// 选最小且稳定的Qwen2.5,先保证能跑起来</span>
<span class="hljs-keyword">const</span> modelId = <span class="hljs-string">"Qwen2.5-0.5B-Instruct-q4f32_1-MLC"</span>;

<span class="hljs-comment">// 初始化引擎（WebGPU）</span>
<span class="hljs-keyword">const</span> engine = <span class="hljs-keyword">await</span> <span class="hljs-title class_">CreateMLCEngine</span>(modelId, {
  <span class="hljs-attr">initProgressCallback</span>: <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[MLC]"</span>, p.<span class="hljs-property">text</span>);
  },
});

<span class="hljs-comment">// 控制台对话</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ask</span>(<span class="hljs-params">text: string</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> engine.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: text }],
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🤖"</span>, res.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>);
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">ask</span>(<span class="hljs-string">"写一个 React Button"</span>)
<span class="hljs-keyword">await</span> <span class="hljs-title function_">ask</span>(<span class="hljs-string">"用CSS实现三角形"</span>)
<span class="hljs-keyword">await</span> <span class="hljs-title function_">ask</span>(<span class="hljs-string">"用Python写一个冒泡排序"</span>)

</code></pre>
<p>运行的那一刻，模型会自动加载（设备配置低的同学尽量用小模型🙂‍↔️）
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmlc-ai%2Fweb-llm%2Fblob%2Fmain%2Fsrc%2Fconfig.ts%23L313" target="_blank" title="https://github.com/mlc-ai/web-llm/blob/main/src/config.ts#L313" ref="nofollow noopener noreferrer">👉 可用模型</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea96ea970286482ebf6359b5e77ede8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771301869&amp;x-signature=9XHkhpQeC1HBWE%2FPbx%2BOpm8Ja9M%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>ASK: 写一个 React Button</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58aa00282dfb4558a8ebaf3b0fe9ba82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771301869&amp;x-signature=V01UYIzbY8joVVkIhlvK%2Bqad5ac%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>ASK: 用CSS实现三角形</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4184bfd3ef24b0d884154ca36e6c471~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771301869&amp;x-signature=HbFI%2BJIPT0lJ6IwRbH6OKFm1vIk%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>ASK: 用Python写一个冒泡排序</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee8a472996b942bb88b529874d1130e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771301869&amp;x-signature=sBBsPLUr%2BE8hM8ILX1X7ddcWDfI%3D" alt="image.png" loading="lazy"/></p>
<p>上周一，我把 Demo 发到了公司群里了。</p>
<p>那个嘲笑我的后端组长，拿着他的 M1 MacBook Air 点开了链接。</p>
<p>初次加载用了 40 秒（下载模型权重），然后...</p>
<p><strong>Token 生成速度：15 tokens/s。</strong></p>
<p>甚至比 GPT-4 的 API 响应还要快！</p>
<p>因为这是<strong>本地生成</strong>，没有网络延迟。</p>
<p>他抬头看我：这...真的没调 API？😖</p>
<p>我指了指 Network 面板：<strong>0 请求，纯本地。</strong></p>
<hr/>
<h3 data-id="heading-2">算一笔账：这 5 万多是怎么省出来的</h3>
<p>我们内部有 50 个员工，每个人每天平均问 50 次。</p>
<p>如果是 GPT-5，一年就是30多万了（排除假期和周末）。</p>
<p>现在呢？</p>
<p><strong>成本 = CDN 流量费（下载那是 0.5GB 模型文件，默认最低成本去算）。</strong></p>
<p>而且模型有了缓存（Cache Storage）后，第二次打开就是<strong>零成本</strong>。</p>
<p>更重要的是<strong>数据隐私</strong>。</p>
<p>财务部那个姐姐之前死活不敢用 AI 搜发票政策，怕数据传给 OpenAI 泄密。</p>
<p>现在我告诉她：这东西跑在你自己的电脑上，断网都能用，数据出不了这个房间。</p>
<p>她看我的眼神都变了。🤩😃</p>
<hr/>
<h3 data-id="heading-3">也别神话，也有坑的！</h3>
<p>当然，为了保持技术人的客观（虽然我已经在爽文里了），我得说实话，这方案不是完美的。</p>
<ol>
<li><strong>首屏加载是噩梦</strong>：如果让用户下载 4GB 的文件，如果是移动端 5G，用户会顺着网线来打你。所以这只适合<strong>桌面端 Web</strong> 或者 <strong>Electron 应用</strong>，尤其是开发测或者内部。</li>
<li><strong>显卡门槛</strong>：没有独立显卡或者 Apple Silicon 的老电脑，跑起来会卡成 PPT。</li>
<li><strong>发热</strong>：跑模型时，用户的电脑确实会变成暖手宝。</li>
</ol>
<p>但在我们的场景——<strong>企业内部工具、文档助手、代码生成器</strong>——这些缺点完全可以接受。</p>
<p>毕竟，公司省下来的钱，哪怕分我 1% 当奖金，也够我换个新键盘了😂😂😂。</p>
<hr/>
<p>前端的边界在哪里？</p>
<p>2026 年了，别再把自己定义为画页面的。</p>
<p><strong>WebGPU</strong> 的出现，给了前端直接挑战原生性能的入场券。</p>
<p>从今天起，试着把计算压力从云端搬到到终端来吧。</p>
<p>当后端还在为扩容发愁时，你已经利用用户闲置的 GPU 算力，构建了一个庞大的分布式计算网络。</p>
<p>这，才是属于前端的<strong>降本增效</strong>。🚀</p>
<p>你们说是不是呢？😃</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96999aa3a0ab4359bed0d5bfe148c73a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771301869&amp;x-signature=QnzWJu3YB%2Bn94Q1HqQKuXXTVcGI%3D" alt="Suggestion.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀99% 前端都用错了 flatMap！把 “映射扁平” 用成高级 for 循环？20 个高阶用法一次性讲透]]></title>    <link>https://juejin.cn/post/7604666872128356371</link>    <guid>https://juejin.cn/post/7604666872128356371</guid>    <pubDate>2026-02-10T04:58:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604666872128356371" data-draft-id="7604757482003923007" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀99% 前端都用错了 flatMap！把 “映射扁平” 用成高级 for 循环？20 个高阶用法一次性讲透"/> <meta itemprop="keywords" content="前端,JavaScript,TypeScript"/> <meta itemprop="datePublished" content="2026-02-10T04:58:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iDao技术魔方"/> <meta itemprop="url" content="https://juejin.cn/user/166781496080782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀99% 前端都用错了 flatMap！把 “映射扁平” 用成高级 for 循环？20 个高阶用法一次性讲透
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781496080782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iDao技术魔方
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:58:16.000Z" title="Tue Feb 10 2026 04:58:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>我在 3 个项目里用 flatMap 重构了 50+ 处代码，总结了这些经验。今天全部教给你。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">开篇：为什么要专门学 flatMap？</h2>
<p>去年我接手一个电商后台项目，代码里到处都是这样的写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 性能杀手：两次遍历 + 中间数组</span>
<span class="hljs-keyword">const</span> result = orders
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span> order.<span class="hljs-property">status</span> === <span class="hljs-string">'paid'</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span> order.<span class="hljs-property">items</span>)
  .<span class="hljs-title function_">flat</span>();
</code></pre>
<p>重构后用 flatMap：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 一次遍历，代码更简洁</span>
<span class="hljs-keyword">const</span> result = orders.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span> 
  order.<span class="hljs-property">status</span> === <span class="hljs-string">'paid'</span> ? order.<span class="hljs-property">items</span> : []
);
</code></pre>
<p><strong>性能提升 40%，代码量减少 30%</strong>。这就是 flatMap 的威力。</p>
<hr/>
<h2 data-id="heading-1">第一部分：基础技巧（1-5）</h2>
<h3 data-id="heading-2">技巧 1：替代 filter + map</h3>
<p><strong>场景</strong>：提取所有已付款订单的商品</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> orders = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'paid'</span>, <span class="hljs-attr">items</span>: [<span class="hljs-string">'iPhone'</span>, <span class="hljs-string">'AirPods'</span>] },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span>, <span class="hljs-attr">items</span>: [<span class="hljs-string">'iPad'</span>] },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'paid'</span>, <span class="hljs-attr">items</span>: [<span class="hljs-string">'MacBook'</span>] }
];

<span class="hljs-comment">// ❌ 传统写法：两次遍历</span>
<span class="hljs-keyword">const</span> items1 = orders
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.<span class="hljs-property">status</span> === <span class="hljs-string">'paid'</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.<span class="hljs-property">items</span>)
  .<span class="hljs-title function_">flat</span>();

<span class="hljs-comment">// ✅ flatMap：一次遍历</span>
<span class="hljs-keyword">const</span> items2 = orders.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span>
  order.<span class="hljs-property">status</span> === <span class="hljs-string">'paid'</span> ? order.<span class="hljs-property">items</span> : []
);
<span class="hljs-comment">// ['iPhone', 'AirPods', 'MacBook']</span>
</code></pre>
<p><strong>为什么更好</strong>：减少一次遍历，大数据量时性能优势明显。</p>
<hr/>
<h3 data-id="heading-3">技巧 2：处理嵌套数组（树形结构扁平化）</h3>
<p><strong>场景</strong>：菜单树转平级列表</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> menuTree = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'系统管理'</span>,
    <span class="hljs-attr">children</span>: [
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'用户管理'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/users'</span> },
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'角色管理'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/roles'</span> }
    ]
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'业务管理'</span>,
    <span class="hljs-attr">children</span>: [
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'订单管理'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/orders'</span> }
    ]
  }
];

<span class="hljs-comment">// 提取所有菜单项，保留父级信息</span>
<span class="hljs-keyword">const</span> flatMenu = menuTree.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span>
  parent.<span class="hljs-property">children</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> ({
    ...child,
    <span class="hljs-attr">parentName</span>: parent.<span class="hljs-property">name</span>
  }))
);

<span class="hljs-comment">/*
[
  { name: '用户管理', path: '/users', parentName: '系统管理' },
  { name: '角色管理', path: '/roles', parentName: '系统管理' },
  { name: '订单管理', path: '/orders', parentName: '业务管理' }
]
*/</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">技巧 3：字符串拆分与合并</h3>
<p><strong>场景</strong>：处理多行输入的关键词</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> userInput = [
  <span class="hljs-string">'apple, banana, orange'</span>,
  <span class="hljs-string">'react, vue, angular'</span>,
  <span class="hljs-string">'frontend, backend'</span>
];

<span class="hljs-comment">// 拆分成所有关键词并去重</span>
<span class="hljs-keyword">const</span> keywords = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(
  userInput.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> 
    line.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>())
  )
)];
<span class="hljs-comment">// ['apple', 'banana', 'orange', 'react', 'vue', 'angular', 'frontend', 'backend']</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">技巧 4：根据数量展开元素</h3>
<p><strong>场景</strong>：购物车根据商品数量生成明细</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cart = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'iPhone'</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">2</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'AirPods'</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span> }
];

<span class="hljs-comment">// 展开成独立项（用于库存检查）</span>
<span class="hljs-keyword">const</span> items = cart.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span>
  <span class="hljs-title class_">Array</span>(product.<span class="hljs-property">quantity</span>).<span class="hljs-title function_">fill</span>(product.<span class="hljs-property">name</span>)
);
<span class="hljs-comment">// ['iPhone', 'iPhone', 'AirPods']</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">技巧 5：过滤 null/undefined（但要注意坑）</h3>
<p><strong>场景</strong>：清理接口返回的数据</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> apiResponse = [<span class="hljs-number">1</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>];

<span class="hljs-comment">// ✅ 正确写法</span>
<span class="hljs-keyword">const</span> clean = apiResponse.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> 
  x != <span class="hljs-literal">null</span> ? [x] : []
);
<span class="hljs-comment">// [1, 2, 3, 4]</span>

<span class="hljs-comment">// ❌ 错误写法（会误删 0 和空字符串）</span>
<span class="hljs-comment">// const wrong = apiResponse.flatMap(x =&gt; x || []);</span>
<span class="hljs-comment">// const wrong2 = apiResponse.flatMap(x =&gt; x ?? []);</span>
</code></pre>
<p><strong>坑点警示</strong>：<code>x || []</code> 或 <code>x ?? []</code> 会把 <code>0</code>、<code>''</code>、<code>false</code> 也过滤掉！</p>
<hr/>
<h2 data-id="heading-7">第二部分：进阶技巧（6-12）</h2>
<h3 data-id="heading-8">技巧 6：递归扁平化树结构</h3>
<p><strong>场景</strong>：无限极分类转平级</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> categoryTree = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'电子产品'</span>,
    <span class="hljs-attr">children</span>: [
      {
        <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'手机'</span>,
        <span class="hljs-attr">children</span>: [
          { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'iPhone'</span>, <span class="hljs-attr">children</span>: [] }
        ]
      }
    ]
  }
];

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flattenTree</span>(<span class="hljs-params">nodes, depth = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">return</span> nodes.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> [
    { ...node, depth, <span class="hljs-attr">children</span>: <span class="hljs-literal">undefined</span> },
    ...<span class="hljs-title function_">flattenTree</span>(node.<span class="hljs-property">children</span> || [], depth + <span class="hljs-number">1</span>)
  ]);
}

<span class="hljs-keyword">const</span> flatList = <span class="hljs-title function_">flattenTree</span>(categoryTree);
<span class="hljs-comment">/*
[
  { id: 1, name: '电子产品', depth: 0 },
  { id: 2, name: '手机', depth: 1 },
  { id: 3, name: 'iPhone', depth: 2 }
]
*/</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">技巧 7：笛卡尔积生成（SKU 组合）</h3>
<p><strong>场景</strong>：电商 SKU 生成</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> colors = [<span class="hljs-string">'深空灰'</span>, <span class="hljs-string">'银色'</span>];
<span class="hljs-keyword">const</span> sizes = [<span class="hljs-string">'128GB'</span>, <span class="hljs-string">'256GB'</span>];
<span class="hljs-keyword">const</span> editions = [<span class="hljs-string">'标准版'</span>, <span class="hljs-string">'Pro版'</span>];

<span class="hljs-comment">// 生成所有 SKU 组合</span>
<span class="hljs-keyword">const</span> skus = colors.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span>
  sizes.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">size</span> =&gt;</span>
    editions.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">edition</span> =&gt;</span> ({
      <span class="hljs-attr">sku</span>: <span class="hljs-string">`PHONE-<span class="hljs-subst">${color}</span>-<span class="hljs-subst">${size}</span>-<span class="hljs-subst">${edition}</span>`</span>,
      color,
      size,
      edition,
      <span class="hljs-attr">price</span>: <span class="hljs-title function_">calculatePrice</span>(color, size, edition)
    }))
  )
);

<span class="hljs-comment">// 生成 2×2×2=8 个 SKU</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">技巧 8：分页数据合并</h3>
<p><strong>场景</strong>：合并多个分页接口返回的数据</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> pages = [
  { <span class="hljs-attr">items</span>: [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> }], <span class="hljs-attr">hasMore</span>: <span class="hljs-literal">true</span> },
  { <span class="hljs-attr">items</span>: [{ <span class="hljs-attr">id</span>: <span class="hljs-number">3</span> }], <span class="hljs-attr">hasMore</span>: <span class="hljs-literal">false</span> }
];

<span class="hljs-comment">// 合并所有 items，并标记来源页</span>
<span class="hljs-keyword">const</span> allItems = pages.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function">(<span class="hljs-params">page, pageIndex</span>) =&gt;</span>
  page.<span class="hljs-property">items</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
    ...item,
    pageIndex,
    <span class="hljs-attr">isLastPage</span>: !page.<span class="hljs-property">hasMore</span>
  }))
);

<span class="hljs-comment">/*
[
  { id: 1, pageIndex: 0, isLastPage: false },
  { id: 2, pageIndex: 0, isLastPage: false },
  { id: 3, pageIndex: 1, isLastPage: true }
]
*/</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">技巧 9：表单验证错误收集</h3>
<p><strong>场景</strong>：收集所有表单字段的验证错误</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fields = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'email'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'invalid'</span>, <span class="hljs-attr">validators</span>: [isEmail, isRequired] },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'age'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">validators</span>: [isAdult, isRequired] }
];

<span class="hljs-keyword">const</span> errors = fields.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">field</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> fieldErrors = field.<span class="hljs-property">validators</span>
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-title function_">v</span>(field.<span class="hljs-property">value</span>))
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> error !== <span class="hljs-literal">null</span>);
  
  <span class="hljs-keyword">return</span> fieldErrors.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> ({
    <span class="hljs-attr">field</span>: field.<span class="hljs-property">name</span>,
    <span class="hljs-attr">message</span>: msg
  }));
});

<span class="hljs-comment">/*
[
  { field: 'email', message: '邮箱格式不正确' },
  { field: 'age', message: '年龄必须大于18岁' }
]
*/</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">技巧 10：标签系统展开</h3>
<p><strong>场景</strong>：文章标签反向索引</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> articles = [
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'React Hooks'</span>, <span class="hljs-attr">tags</span>: [<span class="hljs-string">'react'</span>, <span class="hljs-string">'frontend'</span>] },
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'Vue 3'</span>, <span class="hljs-attr">tags</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'frontend'</span>] }
];

<span class="hljs-comment">// 展开成 "标签-文章" 映射</span>
<span class="hljs-keyword">const</span> tagIndex = articles.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">article</span> =&gt;</span>
  article.<span class="hljs-property">tags</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">tag</span> =&gt;</span> ({ tag, <span class="hljs-attr">title</span>: article.<span class="hljs-property">title</span> }))
);

<span class="hljs-comment">// 统计每个标签的文章数</span>
<span class="hljs-keyword">const</span> tagCount = tagIndex.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, { tag }</span>) =&gt;</span> {
  acc[tag] = (acc[tag] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
  <span class="hljs-keyword">return</span> acc;
}, {});
<span class="hljs-comment">// { react: 1, frontend: 2, vue: 1 }</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">技巧 11：权限菜单过滤</h3>
<p><strong>场景</strong>：根据权限过滤可见菜单</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> menuTree = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'系统管理'</span>,
    <span class="hljs-attr">children</span>: [
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'用户管理'</span>, <span class="hljs-attr">permission</span>: <span class="hljs-string">'user:view'</span>, <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span> },
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'配置管理'</span>, <span class="hljs-attr">permission</span>: <span class="hljs-string">'config:view'</span>, <span class="hljs-attr">visible</span>: <span class="hljs-literal">false</span> }
    ]
  }
];

<span class="hljs-keyword">const</span> userPermissions = [<span class="hljs-string">'user:view'</span>, <span class="hljs-string">'order:view'</span>];

<span class="hljs-comment">// 过滤出用户有权限的菜单</span>
<span class="hljs-keyword">const</span> visibleMenus = menuTree.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">menu</span> =&gt;</span>
  menu.<span class="hljs-property">children</span>.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span>
    child.<span class="hljs-property">visible</span> &amp;&amp; userPermissions.<span class="hljs-title function_">includes</span>(child.<span class="hljs-property">permission</span>)
      ? [{ ...child, <span class="hljs-attr">parent</span>: menu.<span class="hljs-property">name</span> }]
      : []
  )
);
</code></pre>
<hr/>
<h3 data-id="heading-14">技巧 12：矩阵转置</h3>
<p><strong>场景</strong>：表格行列转换</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> matrix = [
  [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],
  [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>],
  [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]
];

<span class="hljs-comment">// 矩阵转置</span>
<span class="hljs-keyword">const</span> transposed = matrix[<span class="hljs-number">0</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, colIndex</span>) =&gt;</span>
  matrix.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">row</span> =&gt;</span> row[colIndex] !== <span class="hljs-literal">undefined</span> ? [row[colIndex]] : [])
);

<span class="hljs-comment">/*
[
  [1, 4, 7],
  [2, 5, 8],
  [3, 6, 9]
]
*/</span>
</code></pre>
<hr/>
<h2 data-id="heading-15">第三部分：高阶技巧（13-20）</h2>
<h3 data-id="heading-16">技巧 13：动态条件展开</h3>
<p><strong>场景</strong>：根据数据类型决定展开策略</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> data = [
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'batch'</span>, <span class="hljs-attr">items</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>] },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'single'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'d'</span> }
];

<span class="hljs-keyword">const</span> result = data.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">type</span> === <span class="hljs-string">'batch'</span>) {
    <span class="hljs-keyword">return</span> item.<span class="hljs-property">items</span>; <span class="hljs-comment">// 展开数组</span>
  }
  <span class="hljs-keyword">return</span> [item.<span class="hljs-property">value</span>]; <span class="hljs-comment">// 包装成数组</span>
});
<span class="hljs-comment">// ['a', 'b', 'c', 'd']</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">技巧 14：深度路径提取</h3>
<p><strong>场景</strong>：提取嵌套对象的所有叶子节点</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> nested = {
  <span class="hljs-attr">a</span>: { <span class="hljs-attr">b</span>: { <span class="hljs-attr">c</span>: <span class="hljs-number">1</span> } },
  <span class="hljs-attr">d</span>: { <span class="hljs-attr">e</span>: <span class="hljs-number">2</span> }
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPaths</span>(<span class="hljs-params">obj, prefix = <span class="hljs-string">''</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj).<span class="hljs-title function_">flatMap</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> path = prefix ? <span class="hljs-string">`<span class="hljs-subst">${prefix}</span>.<span class="hljs-subst">${key}</span>`</span> : key;
    
    <span class="hljs-keyword">if</span> (value &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">getPaths</span>(value, path);
    }
    
    <span class="hljs-keyword">return</span> [{ path, value }];
  });
}

<span class="hljs-title function_">getPaths</span>(nested);
<span class="hljs-comment">/*
[
  { path: 'a.b.c', value: 1 },
  { path: 'd.e', value: 2 }
]
*/</span>
</code></pre>
<hr/>
<h3 data-id="heading-18">技巧 15：分组报表生成</h3>
<p><strong>场景</strong>：销售数据透视表预处理</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sales = [
  { <span class="hljs-attr">month</span>: <span class="hljs-string">'1月'</span>, <span class="hljs-attr">region</span>: <span class="hljs-string">'东'</span>, <span class="hljs-attr">amount</span>: <span class="hljs-number">100</span> },
  { <span class="hljs-attr">month</span>: <span class="hljs-string">'1月'</span>, <span class="hljs-attr">region</span>: <span class="hljs-string">'西'</span>, <span class="hljs-attr">amount</span>: <span class="hljs-number">200</span> },
  { <span class="hljs-attr">month</span>: <span class="hljs-string">'2月'</span>, <span class="hljs-attr">region</span>: <span class="hljs-string">'东'</span>, <span class="hljs-attr">amount</span>: <span class="hljs-number">150</span> }
];

<span class="hljs-keyword">const</span> months = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(sales.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-property">month</span>))];

<span class="hljs-keyword">const</span> report = months.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">month</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> monthData = sales.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-property">month</span> === month);
  <span class="hljs-keyword">const</span> total = monthData.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, s</span>) =&gt;</span> sum + s.<span class="hljs-property">amount</span>, <span class="hljs-number">0</span>);
  
  <span class="hljs-keyword">return</span> [{
    month,
    <span class="hljs-attr">details</span>: monthData,
    total,
    <span class="hljs-attr">average</span>: total / monthData.<span class="hljs-property">length</span>
  }];
});
</code></pre>
<hr/>
<h3 data-id="heading-19">技巧 16：全选功能展开</h3>
<p><strong>场景</strong>：下拉框全选展开成子项</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> options = [
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'水果'</span>, <span class="hljs-attr">children</span>: [<span class="hljs-string">'苹果'</span>, <span class="hljs-string">'香蕉'</span>] },
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'蔬菜'</span>, <span class="hljs-attr">children</span>: [<span class="hljs-string">'白菜'</span>] },
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'全选'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'all'</span> }
];

<span class="hljs-keyword">const</span> flattened = options.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">opt</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (opt.<span class="hljs-property">value</span> === <span class="hljs-string">'all'</span>) {
    <span class="hljs-comment">// 全选展开成所有子项</span>
    <span class="hljs-keyword">return</span> options
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.<span class="hljs-property">children</span>)
      .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.<span class="hljs-property">children</span>);
  }
  
  <span class="hljs-keyword">return</span> opt.<span class="hljs-property">children</span>
    ? opt.<span class="hljs-property">children</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> ({ <span class="hljs-attr">label</span>: child, <span class="hljs-attr">group</span>: opt.<span class="hljs-property">label</span> }))
    : [opt];
});
</code></pre>
<hr/>
<h3 data-id="heading-20">技巧 17：自定义深度扁平化</h3>
<p><strong>场景</strong>：指定深度的数组扁平化</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> deepArray = [<span class="hljs-number">1</span>, [<span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, [<span class="hljs-number">4</span>]]], <span class="hljs-number">5</span>];

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flatMapDeep</span>(<span class="hljs-params">arr, depth = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">if</span> (depth === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> arr;
  
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span>
    <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(item)
      ? <span class="hljs-title function_">flatMapDeep</span>(item, depth - <span class="hljs-number">1</span>)
      : [item]
  );
}

<span class="hljs-title function_">flatMapDeep</span>(deepArray, <span class="hljs-number">1</span>); <span class="hljs-comment">// [1, 2, [3, [4]], 5]</span>
<span class="hljs-title function_">flatMapDeep</span>(deepArray, <span class="hljs-number">2</span>); <span class="hljs-comment">// [1, 2, 3, [4], 5]</span>
<span class="hljs-title function_">flatMapDeep</span>(deepArray, <span class="hljs-number">3</span>); <span class="hljs-comment">// [1, 2, 3, 4, 5]</span>
</code></pre>
<hr/>
<h3 data-id="heading-21">技巧 18：数据转换管道</h3>
<p><strong>场景</strong>：多阶段数据处理</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> rawData = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">items</span>: [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>], <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">items</span>: [<span class="hljs-number">30</span>], <span class="hljs-attr">active</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">items</span>: [<span class="hljs-number">40</span>, <span class="hljs-number">50</span>], <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span> }
];

<span class="hljs-comment">// 管道：过滤 -&gt; 展开 -&gt; 转换</span>
<span class="hljs-keyword">const</span> processed = rawData
  .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span> ? [item] : [])           <span class="hljs-comment">// 过滤</span>
  .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">items</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> ({             <span class="hljs-comment">// 展开</span>
    <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, 
    <span class="hljs-attr">value</span>: val 
  })))
  .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">{ id, value }</span>) =&gt;</span> ({                             <span class="hljs-comment">// 转换</span>
    id,
    value,
    <span class="hljs-attr">doubled</span>: value * <span class="hljs-number">2</span>
  }));

<span class="hljs-comment">/*
[
  { id: 1, value: 10, doubled: 20 },
  { id: 1, value: 20, doubled: 40 },
  { id: 3, value: 40, doubled: 80 },
  { id: 3, value: 50, doubled: 100 }
]
*/</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">技巧 19：多重条件过滤与展开</h3>
<p><strong>场景</strong>：复杂条件的数据筛选</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> products = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'iPhone'</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">'手机'</span>, <span class="hljs-attr">variants</span>: [<span class="hljs-string">'128GB'</span>, <span class="hljs-string">'256GB'</span>] },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'T恤'</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">'服装'</span>, <span class="hljs-attr">variants</span>: [<span class="hljs-string">'M'</span>, <span class="hljs-string">'L'</span>, <span class="hljs-string">'XL'</span>] }
];

<span class="hljs-comment">// 只展开指定类别的商品变体</span>
<span class="hljs-keyword">const</span> variants = products.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (product.<span class="hljs-property">category</span> !== <span class="hljs-string">'手机'</span>) <span class="hljs-keyword">return</span> [];
  
  <span class="hljs-keyword">return</span> product.<span class="hljs-property">variants</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">variant</span> =&gt;</span> ({
    <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${product.name}</span> <span class="hljs-subst">${variant}</span>`</span>,
    <span class="hljs-attr">basePrice</span>: <span class="hljs-number">5999</span>,
    variant
  }));
});
</code></pre>
<hr/>
<h3 data-id="heading-23">技巧 20：实战综合案例（购物车系统）</h3>
<p><strong>场景</strong>：完整的购物车数据处理流程</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cart = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'bundle'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'苹果套装'</span>,
    <span class="hljs-attr">items</span>: [
      { <span class="hljs-attr">sku</span>: <span class="hljs-string">'IPHONE'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'iPhone'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">5999</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">'手机'</span> },
      { <span class="hljs-attr">sku</span>: <span class="hljs-string">'AIRPODS'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'AirPods'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">1999</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">category</span>: <span class="hljs-string">'配件'</span> }
    ]
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'single'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'MacBook'</span>,
    <span class="hljs-attr">sku</span>: <span class="hljs-string">'MACBOOK'</span>,
    <span class="hljs-attr">price</span>: <span class="hljs-number">14999</span>,
    <span class="hljs-attr">stock</span>: <span class="hljs-number">5</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">'电脑'</span>,
    <span class="hljs-attr">options</span>: { <span class="hljs-attr">colors</span>: [<span class="hljs-string">'深空灰'</span>, <span class="hljs-string">'银色'</span>], <span class="hljs-attr">sizes</span>: [<span class="hljs-string">'14寸'</span>, <span class="hljs-string">'16寸'</span>] }
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'single'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'鼠标'</span>,
    <span class="hljs-attr">sku</span>: <span class="hljs-string">'MOUSE'</span>,
    <span class="hljs-attr">price</span>: <span class="hljs-number">299</span>,
    <span class="hljs-attr">stock</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">'配件'</span>
  }
];

<span class="hljs-comment">// 步骤1：展开所有商品（包括套装）</span>
<span class="hljs-keyword">const</span> expanded = cart.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">type</span> === <span class="hljs-string">'bundle'</span>) {
    <span class="hljs-keyword">return</span> item.<span class="hljs-property">items</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">sub</span> =&gt;</span> ({ 
      ...sub, 
      <span class="hljs-attr">bundleId</span>: item.<span class="hljs-property">id</span>,
      <span class="hljs-attr">bundleName</span>: item.<span class="hljs-property">name</span> 
    }));
  }
  <span class="hljs-keyword">return</span> [item];
});

<span class="hljs-comment">// 步骤2：过滤库存为0的商品</span>
<span class="hljs-keyword">const</span> available = expanded.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span>
  product.<span class="hljs-property">stock</span> &gt; <span class="hljs-number">0</span> ? [product] : []
);

<span class="hljs-comment">// 步骤3：生成 SKU 组合</span>
<span class="hljs-keyword">const</span> withSkus = available.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (product.<span class="hljs-property">options</span>) {
    <span class="hljs-keyword">const</span> { colors, sizes } = product.<span class="hljs-property">options</span>;
    <span class="hljs-keyword">return</span> colors.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span>
      sizes.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">size</span> =&gt;</span> ({
        ...product,
        <span class="hljs-attr">sku</span>: <span class="hljs-string">`<span class="hljs-subst">${product.sku}</span>-<span class="hljs-subst">${color}</span>-<span class="hljs-subst">${size}</span>`</span>,
        <span class="hljs-attr">variant</span>: <span class="hljs-string">`<span class="hljs-subst">${color}</span> <span class="hljs-subst">${size}</span>`</span>,
        <span class="hljs-attr">unitPrice</span>: product.<span class="hljs-property">price</span>
      }))
    );
  }
  <span class="hljs-keyword">return</span> [product];
});

<span class="hljs-comment">// 步骤4：按分类分组</span>
<span class="hljs-keyword">const</span> byCategory = withSkus.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, item</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> cat = item.<span class="hljs-property">category</span>;
  <span class="hljs-keyword">if</span> (!acc[cat]) acc[cat] = [];
  acc[cat].<span class="hljs-title function_">push</span>(item);
  <span class="hljs-keyword">return</span> acc;
}, {});

<span class="hljs-comment">// 步骤5：生成订单摘要</span>
<span class="hljs-keyword">const</span> orderSummary = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(byCategory).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[category, items]</span>) =&gt;</span> ({
  category,
  <span class="hljs-attr">count</span>: items.<span class="hljs-property">length</span>,
  <span class="hljs-attr">items</span>: items.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> ({
    <span class="hljs-attr">name</span>: i.<span class="hljs-property">name</span>,
    <span class="hljs-attr">sku</span>: i.<span class="hljs-property">sku</span>,
    <span class="hljs-attr">price</span>: i.<span class="hljs-property">unitPrice</span> || i.<span class="hljs-property">price</span>
  })),
  <span class="hljs-attr">subtotal</span>: items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, i</span>) =&gt;</span> sum + (i.<span class="hljs-property">unitPrice</span> || i.<span class="hljs-property">price</span>), <span class="hljs-number">0</span>)
}));

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'订单摘要:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(orderSummary, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
</code></pre>
<p><strong>输出结果</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"手机"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"items"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPhone"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sku"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"IPHONE"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5999</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"subtotal"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5999</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"电脑"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"items"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MacBook"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sku"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MACBOOK-深空灰-14寸"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">14999</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MacBook"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sku"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MACBOOK-深空灰-16寸"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">14999</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MacBook"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sku"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MACBOOK-银色-14寸"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">14999</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MacBook"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sku"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MACBOOK-银色-16寸"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">14999</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"subtotal"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">59996</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"配件"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"items"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"鼠标"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sku"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MOUSE"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">299</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"subtotal"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">299</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">第四部分：性能对比与最佳实践</h2>
<h3 data-id="heading-25">性能测试</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 测试数据：10000 条订单</span>
<span class="hljs-keyword">const</span> orders = <span class="hljs-title class_">Array</span>(<span class="hljs-number">10000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
  <span class="hljs-attr">status</span>: i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'paid'</span> : <span class="hljs-string">'pending'</span>,
  <span class="hljs-attr">items</span>: [<span class="hljs-string">`item-<span class="hljs-subst">${i}</span>-a`</span>, <span class="hljs-string">`item-<span class="hljs-subst">${i}</span>-b`</span>]
}));

<span class="hljs-comment">// 方法1：filter + map + flat</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'filter-map-flat'</span>);
<span class="hljs-keyword">const</span> r1 = orders
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.<span class="hljs-property">status</span> === <span class="hljs-string">'paid'</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o.<span class="hljs-property">items</span>)
  .<span class="hljs-title function_">flat</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'filter-map-flat'</span>); <span class="hljs-comment">// ~2.5ms</span>

<span class="hljs-comment">// 方法2：flatMap</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'flatMap'</span>);
<span class="hljs-keyword">const</span> r2 = orders.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span>
  o.<span class="hljs-property">status</span> === <span class="hljs-string">'paid'</span> ? o.<span class="hljs-property">items</span> : []
);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'flatMap'</span>); <span class="hljs-comment">// ~1.2ms</span>

<span class="hljs-comment">// flatMap 快 2 倍！</span>
</code></pre>
<h3 data-id="heading-26">使用口诀</h3>
<ol>
<li><strong>能一次遍历做完，绝不用两次</strong>（filter + map → flatMap）</li>
<li><strong>需要条件过滤 + 转换 → flatMap</strong></li>
<li><strong>需要展开嵌套数组 → flatMap</strong></li>
<li><strong>flatMap 只扁平一层，深度扁平需要递归</strong></li>
<li><strong>大数据量优先用 flatMap 减少中间数组创建</strong></li>
</ol>
<hr/>
<h2 data-id="heading-27">第五部分：常见踩坑记录</h2>
<h3 data-id="heading-28">坑 1：误用 ?? 或 || 导致数据丢失</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> data = [<span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">undefined</span>];

<span class="hljs-comment">// ❌ 错误：会过滤掉 0、''、false</span>
<span class="hljs-keyword">const</span> wrong = data.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x || []); <span class="hljs-comment">// []</span>
<span class="hljs-keyword">const</span> wrong2 = data.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x ?? []); <span class="hljs-comment">// []</span>

<span class="hljs-comment">// ✅ 正确：只过滤 null/undefined</span>
<span class="hljs-keyword">const</span> right = data.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x != <span class="hljs-literal">null</span> ? [x] : []); 
<span class="hljs-comment">// [0, '', false]</span>
</code></pre>
<h3 data-id="heading-29">坑 2：async 函数不能直接用于 flatMap</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> ids = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// ❌ 错误：flatMap 不会等待 Promise</span>
<span class="hljs-keyword">const</span> wrong = ids.<span class="hljs-title function_">flatMap</span>(<span class="hljs-keyword">async</span> id =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/<span class="hljs-subst">${id}</span>`</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
});
<span class="hljs-comment">// 返回的是 [Promise, Promise, Promise]</span>

<span class="hljs-comment">// ✅ 正确：先用 Promise.all，再用 flatMap</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ids.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/<span class="hljs-subst">${id}</span>`</span>)));
<span class="hljs-keyword">const</span> results = data.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">items</span> || []);
</code></pre>
<h3 data-id="heading-30">坑 3：返回非数组会报错</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> nums = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// ❌ 错误：返回非数组</span>
<span class="hljs-comment">// const wrong = nums.flatMap(n =&gt; n * 2); // TypeError</span>

<span class="hljs-comment">// ✅ 正确：返回数组</span>
<span class="hljs-keyword">const</span> right = nums.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> [n * <span class="hljs-number">2</span>]); <span class="hljs-comment">// [2, 4, 6]</span>
</code></pre>
<hr/>
<h2 data-id="heading-31">总结</h2>
<p>经过 3 个项目的实战检验，flatMap 是我使用频率最高的数组方法之一。它的核心优势：</p>

























<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td>性能</td><td>减少遍历次数，大数据量时优势明显</td></tr><tr><td>简洁</td><td>filter + map 合并成一行代码</td></tr><tr><td>灵活</td><td>支持条件展开、动态返回 0/1/N 个元素</td></tr><tr><td>组合</td><td>可链式调用，构建数据处理管道</td></tr></tbody></table>
<p><strong>记住核心心法</strong>：</p>
<ul>
<li>需要「条件过滤 + 转换」→ flatMap</li>
<li>需要「展开嵌套」→ flatMap</li>
<li>能一次遍历 → 绝不用两次</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 线程同步-02：不同锁状态下Java对象头的表现]]></title>    <link>https://juejin.cn/post/7604697194795892746</link>    <guid>https://juejin.cn/post/7604697194795892746</guid>    <pubDate>2026-02-10T03:08:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604697194795892746" data-draft-id="7604672395627790363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 线程同步-02：不同锁状态下Java对象头的表现"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-10T03:08:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白衣鸽子"/> <meta itemprop="url" content="https://juejin.cn/user/3072451409619223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 线程同步-02：不同锁状态下Java对象头的表现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3072451409619223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白衣鸽子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:08:31.000Z" title="Tue Feb 10 2026 03:08:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文主要分享不同锁状态下，Java对象头的布局是怎么样的，重点关注其中的Mark Word字段。文章构成如下：Mark Wrod 字段对照表、锁状态表、JOL查看对象头实战、关于偏向锁的特殊说明。</p>
<h2 data-id="heading-1">Mark Word字段对照表</h2>











































































<table><thead><tr><th>English 英文</th><th>Chinese 中文</th><th>Description 描述</th></tr></thead><tbody><tr><td><strong>bits</strong></td><td>位</td><td>Basic unit of digital information 数字信息的基本单位</td></tr><tr><td><strong>unused</strong></td><td>未使用</td><td>Reserved space, not currently used 保留空间，当前未使用</td></tr><tr><td><strong>identity_hashcode</strong></td><td>对象哈希码</td><td>Unique hash code of the object 对象的唯一哈希码</td></tr><tr><td><strong>age</strong></td><td>GC年龄</td><td>Generation count in garbage collection 垃圾回收中的分代计数</td></tr><tr><td><strong>thread</strong></td><td>线程ID</td><td>Identifier of the thread holding the lock 持有锁的线程标识符</td></tr><tr><td><strong>epoch</strong></td><td>时间戳/版本号</td><td>Timestamp or version for biased locks 偏向锁的时间戳或版本号</td></tr><tr><td><strong>ptr_to_lock_record</strong></td><td>指向栈中锁记录的指针</td><td>Pointer to lock record in thread stack 指向线程栈中锁记录的指针</td></tr><tr><td><strong>ptr_to_monitor</strong></td><td>指向Monitor对象的指针</td><td>Pointer to ObjectMonitor object 指向ObjectMonitor对象的指针</td></tr><tr><td><strong>Normal (Unlocked)</strong></td><td>无锁状态</td><td>No thread holds the lock 无线程持有锁</td></tr><tr><td><strong>Biased Lock</strong></td><td>偏向锁</td><td>Lock biased towards first acquiring thread 偏向于第一个获取锁的线程</td></tr><tr><td><strong>Thin Lock</strong></td><td>轻量级锁</td><td>Lock using CAS and stack records 使用CAS和栈记录的锁</td></tr><tr><td><strong>Fat Lock</strong></td><td>重量级锁</td><td>Lock using OS-level monitor 使用操作系统级监视器的锁</td></tr><tr><td><strong>GC Marked</strong></td><td>GC标记</td><td>Object marked during garbage collection 垃圾回收期间标记的对象</td></tr></tbody></table>
<h2 data-id="heading-2">状态表</h2>















































<table><thead><tr><th>锁状态</th><th>锁标志位 (2 bits)</th><th>偏向锁标志 (1 bit)</th><th>Mark Word 64位结构 (高位 → 低位)</th><th>存储内容说明</th></tr></thead><tbody><tr><td><strong>无锁状态</strong></td><td><strong>01</strong></td><td><strong>0</strong></td><td><code>25 bits unused</code> | <code>31 bits identity_hashcode</code> | <code>1 bit unused</code> | <code>4 bits age</code> | <code>0</code> | <code>01</code></td><td>• 31位：对象哈希码（第一次调用hashCode()时生成）<br/>• 4位：GC分代年龄（0-15）<br/>• 25位：未使用<br/>• 1位：未使用</td></tr><tr><td><strong>偏向锁状态</strong></td><td><strong>01</strong></td><td><strong>1</strong></td><td><code>54 bits thread</code> | <code>2 bits epoch</code> | <code>1 bit unused</code> | <code>4 bits age</code> | <code>1</code> | <code>01</code></td><td>• 54位：持有偏向锁的线程ID<br/>• 2位：epoch（偏向锁时间戳）<br/>• 4位：GC分代年龄<br/>• 1位：未使用</td></tr><tr><td><strong>轻量级锁状态</strong></td><td><strong>00</strong></td><td>-</td><td><code>62 bits ptr_to_lock_record</code> | <code>00</code></td><td>• 62位：指向栈中锁记录的指针<br/>• 指针最后2位实际为00（对齐要求）</td></tr><tr><td><strong>重量级锁状态</strong></td><td><strong>10</strong></td><td>-</td><td><code>62 bits ptr_to_monitor</code> | <code>10</code></td><td>• 62位：指向ObjectMonitor对象的指针<br/>• 指针指向堆中的Monitor实例</td></tr><tr><td><strong>GC标记状态</strong></td><td><strong>11</strong></td><td>-</td><td><code>62 bits GC information</code> | <code>11</code></td><td>• 62位：垃圾收集相关信息<br/>• 不同GC算法内容不同</td></tr></tbody></table>
<h2 data-id="heading-3">JOL工具查看对象头</h2>
<p>JOL（Java Object Layout）是OpenJDK提供的官方工具，专门用于分析Java对象的内存布局。在项目中引入相关代码依赖可以参考如下：</p>
<p><strong>Maven:</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jol<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jol-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>Gradle:</strong></p>
<pre><code class="hljs language-gradle" lang="gradle">dependencies {
    compileOnly 'org.openjdk.jol:jol-core:0.17'
}
</code></pre>
<p>下面给出一个不同锁状态下查看对象头布局的代码示例，感兴趣的可以本地运行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> concurrent;

<span class="hljs-keyword">import</span> org.openjdk.jol.info.ClassLayout;

<span class="hljs-comment">/**
 * 使用 JOL（Java Object Layout）查看 Java 对象头在不同锁状态下的变化。
 * 顺序：无锁 → 无锁(含 hash) → 偏向锁 → 轻量级锁 → 重量级锁。
 *
 * 要看到「偏向锁」必须开启 JVM 偏向锁并去掉启动延迟，推荐运行：
 *   ./gradlew runObjectHeaderDemo
 * （该任务已自动添加 -XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay=0）
 *
 * 若仍用 runMain 且未加上述 VM 参数，JDK 15+ 下第 3 步会显示 thin lock 而非 biased lock。
 * JDK 18+ 已移除偏向锁，只能看到轻量级/重量级。
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectHeaderDemo</span> {

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleObject</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">42</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-number">100L</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-comment">// 用于展示：无锁 → 无锁+hash → 轻量级 → 重量级（此对象会先算 hash，因此不会进入偏向）</span>
        <span class="hljs-type">SimpleObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleObject</span>();

        <span class="hljs-comment">// 1. 无锁</span>
        System.out.println(<span class="hljs-string">"=== 1. 初始状态（无锁） ==="</span>);
        System.out.println(ClassLayout.parseInstance(obj).toPrintable());

        <span class="hljs-comment">// 2. 无锁但已写入 identity hashCode（一旦写入 hash，该对象永远无法进入偏向锁）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">hc</span> <span class="hljs-operator">=</span> System.identityHashCode(obj);
        System.out.println(<span class="hljs-string">"identityHashCode = 0x"</span> + Integer.toHexString(hc));
        System.out.println(<span class="hljs-string">"\n=== 2. 写入 hashCode 后（无锁，且此对象之后无法偏向） ==="</span>);
        System.out.println(ClassLayout.parseInstance(obj).toPrintable());

        <span class="hljs-comment">// 3. 偏向锁：必须用「从未算过 hash」的对象，且要等偏向生效（默认约 4s）</span>
        <span class="hljs-type">SimpleObject</span> <span class="hljs-variable">biasedCandidate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleObject</span>();
        System.out.println(<span class="hljs-string">"\n=== 3. 偏向锁（等待 "</span> + <span class="hljs-number">5</span> + <span class="hljs-string">" 秒让 JVM 开启该类偏向，且此对象从未调用 identityHashCode） ==="</span>);
        Thread.sleep(<span class="hljs-number">5000</span>);
        <span class="hljs-keyword">synchronized</span> (biasedCandidate) {
            System.out.println(ClassLayout.parseInstance(biasedCandidate).toPrintable());
        }

        <span class="hljs-comment">// 4. 轻量级锁：对已写 hash 的 obj 加锁，只能是轻量级</span>
        System.out.println(<span class="hljs-string">"\n=== 4. 轻量级锁（同一线程对 obj 加锁） ==="</span>);
        <span class="hljs-keyword">synchronized</span> (obj) {
            System.out.println(ClassLayout.parseInstance(obj).toPrintable());
        }

        <span class="hljs-comment">// 5. 多线程竞争 → 重量级锁</span>
        System.out.println(<span class="hljs-string">"\n=== 5. 多线程竞争下的对象头（可能膨胀为重量级锁） ==="</span>);
        showContendedLockStates(obj);
    }

    <span class="hljs-comment">/**
     * 展示在多线程竞争同一个锁时，对象头的变化。
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showContendedLockStates</span><span class="hljs-params">(SimpleObject obj)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">synchronized</span> (obj) {
                System.out.println(<span class="hljs-string">"T1 获取到锁时的对象头："</span>);
                System.out.println(ClassLayout.parseInstance(obj).toPrintable());
                <span class="hljs-comment">// 保持一段时间，让 T2 有机会竞争这把锁</span>
                sleepQuietly(<span class="hljs-number">500</span>);
            }
            System.out.println(<span class="hljs-string">"T1 释放锁后结束"</span>);
        }, <span class="hljs-string">"T1-holder"</span>);

        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-comment">// 先稍微等待，尽量保证在 T1 已经持锁的情况下来竞争</span>
            sleepQuietly(<span class="hljs-number">50</span>);
            <span class="hljs-keyword">synchronized</span> (obj) {
                System.out.println(<span class="hljs-string">"T2 竞争并获取到锁时的对象头："</span>);
                System.out.println(ClassLayout.parseInstance(obj).toPrintable());
            }
            System.out.println(<span class="hljs-string">"T2 释放锁后结束"</span>);
        }, <span class="hljs-string">"T2-contender"</span>);

        System.out.println(<span class="hljs-string">"主线程：启动 T1、T2 之前的对象头："</span>);
        System.out.println(ClassLayout.parseInstance(obj).toPrintable());

        t1.start();
        t2.start();

        t1.join();
        t2.join();

        System.out.println(<span class="hljs-string">"主线程：T1、T2 都结束后的对象头："</span>);
        System.out.println(ClassLayout.parseInstance(obj).toPrintable());
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sleepQuietly</span><span class="hljs-params">(<span class="hljs-type">long</span> ms)</span> {
        <span class="hljs-keyword">try</span> {
            Thread.sleep(ms);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<p>以上代码在我本地运行的结果，可参考如下：</p>
<pre><code class="hljs language-shell" lang="shell"> code git:(main) ✗ ./gradlew runObjectHeaderDemo
<span class="hljs-meta prompt_">
&gt; </span><span class="bash">Task :runObjectHeaderDemo</span>
OpenJDK 64-Bit Server VM warning: Option UseBiasedLocking was deprecated in version 15.0 and will likely be removed in a future release.
OpenJDK 64-Bit Server VM warning: Option BiasedLockingStartupDelay was deprecated in version 15.0 and will likely be removed in a future release.
=== 1. 初始状态（无锁） ===
<span class="hljs-meta prompt_"># </span><span class="bash">WARNING: Unable to attach Serviceability Agent. You can try again with escalated privileges. Two options: a) use -Djol.tryWithSudo=<span class="hljs-literal">true</span> to try with sudo; b) <span class="hljs-built_in">echo</span> 0 | sudo <span class="hljs-built_in">tee</span> /proc/sys/kernel/yama/ptrace_scope</span>
concurrent.ObjectHeaderDemo$SimpleObject object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x0000000000000005 (biasable; age: 0)
  8   4        (object header: class)    0x00000a30
 12   4    int SimpleObject.x            42
 16   8   long SimpleObject.y            100
Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total

identityHashCode = 0x15ff3e9e

=== 2. 写入 hashCode 后（无锁，且此对象之后无法偏向） ===
concurrent.ObjectHeaderDemo$SimpleObject object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x00000015ff3e9e01 (hash: 0x15ff3e9e; age: 0)
  8   4        (object header: class)    0x00000a30
 12   4    int SimpleObject.x            42
 16   8   long SimpleObject.y            100
Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total


=== 3. 偏向锁（等待 5 秒让 JVM 开启该类偏向，且此对象从未调用 identityHashCode） ===
concurrent.ObjectHeaderDemo$SimpleObject object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x00007fb3c9008805 (biased: 0x0000001fecf24022; epoch: 0; age: 0)
  8   4        (object header: class)    0x00000a30
 12   4    int SimpleObject.x            42
 16   8   long SimpleObject.y            100
Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total


=== 4. 轻量级锁（同一线程对 obj 加锁） ===
concurrent.ObjectHeaderDemo$SimpleObject object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x000070000c139ab0 (thin lock: 0x000070000c139ab0)
  8   4        (object header: class)    0x00000a30
 12   4    int SimpleObject.x            42
 16   8   long SimpleObject.y            100
Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total


=== 5. 多线程竞争下的对象头（可能膨胀为重量级锁） ===
主线程：启动 T1、T2 之前的对象头：
concurrent.ObjectHeaderDemo$SimpleObject object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x00000015ff3e9e01 (hash: 0x15ff3e9e; age: 0)
  8   4        (object header: class)    0x00000a30
 12   4    int SimpleObject.x            42
 16   8   long SimpleObject.y            100
Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total

T1 获取到锁时的对象头：
concurrent.ObjectHeaderDemo$SimpleObject object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x000070000d59fa10 (thin lock: 0x000070000d59fa10)
  8   4        (object header: class)    0x00000a30
 12   4    int SimpleObject.x            42
 16   8   long SimpleObject.y            100
Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total

T1 释放锁后结束
T2 竞争并获取到锁时的对象头：
concurrent.ObjectHeaderDemo$SimpleObject object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x00007fb3d0013712 (fat lock: 0x00007fb3d0013712)
  8   4        (object header: class)    0x00000a30
 12   4    int SimpleObject.x            42
 16   8   long SimpleObject.y            100
Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total

T2 释放锁后结束
主线程：T1、T2 都结束后的对象头：
concurrent.ObjectHeaderDemo$SimpleObject object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x00007fb3d0013712 (fat lock: 0x00007fb3d0013712)
  8   4        (object header: class)    0x00000a30
 12   4    int SimpleObject.x            42
 16   8   long SimpleObject.y            100
Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total
</code></pre>
<h2 data-id="heading-4">关于偏向锁的特殊说明</h2>
<p>Java高版本逐渐移除偏向锁，移除时间线：</p>
<ul>
<li><strong>JDK 15</strong>: 默认禁用偏向锁（<code>-XX:-UseBiasedLocking</code>）</li>
<li><strong>JDK 18</strong>: 完全移除偏向锁相关代码</li>
<li><strong>当前状态</strong>: 所有现代JVM版本（JDK 18+）都不支持偏向锁</li>
</ul>
<p>据我所观察，偏向锁未出现通常有三个可能原因：</p>
<ol>
<li>先调用了 System.identityHashCode(obj)，对象头里写入了 hash，就无法再进入偏向锁。</li>
<li>偏向有“延迟生效”（默认约 4 秒），刚 new 出来的对象不会立刻偏向。</li>
<li>JDK版本较高，JVM默认未开启或者已经移除偏向锁的使用。</li>
</ol>
<p>在我本地项目运行过程中使用的是JDK17，可以在运行时加入以下JVM参数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 运行对象头示例并开启偏向锁（仅 JDK 8~17 有效，JDK 18+ 已移除偏向锁）</span>
tasks.register&lt;JavaExec&gt;(<span class="hljs-string">"runObjectHeaderDemo"</span>) {
    group = <span class="hljs-string">"application"</span>
    description = <span class="hljs-string">"Run ObjectHeaderDemo with -XX:+UseBiasedLocking to see biased lock state"</span>
    javaLauncher.set(javaToolchains.launcherFor {
        languageVersion.set(JavaLanguageVersion.of(<span class="hljs-number">17</span>))
    })
    mainClass.set(<span class="hljs-string">"concurrent.ObjectHeaderDemo"</span>)
    classpath = sourceSets[<span class="hljs-string">"main"</span>].runtimeClasspath
    <span class="hljs-title function_">jvmArgs</span><span class="hljs-params">(
        <span class="hljs-string">"-XX:+UseBiasedLocking"</span>,
        <span class="hljs-string">"-XX:BiasedLockingStartupDelay=0"</span>,
        <span class="hljs-string">"-Djdk.attach.allowAttachSelf=true"</span>  // 让 JOL 能 attach 当前进程，避免 ClassLoader 重复加载导致异常
    )</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink ClickHouse Sink：生产级高可用写入方案｜得物技术]]></title>    <link>https://juejin.cn/post/7604701848150556672</link>    <guid>https://juejin.cn/post/7604701848150556672</guid>    <pubDate>2026-02-10T03:11:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604701848150556672" data-draft-id="7604678037808644132" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink ClickHouse Sink：生产级高可用写入方案｜得物技术"/> <meta itemprop="keywords" content="后端,大数据"/> <meta itemprop="datePublished" content="2026-02-10T03:11:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink ClickHouse Sink：生产级高可用写入方案｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:11:38.000Z" title="Tue Feb 10 2026 03:11:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景与痛点</h2>
<h3 data-id="heading-1">业务场景</h3>
<p>在实时大数据处理场景中，Flink + ClickHouse 的组合被广泛应用于：</p>
<ul>
<li><strong>日志处理：</strong> 海量应用日志实时写入分析库。</li>
<li><strong>监控分析：</strong> 业务指标、APM 数据的实时聚合。</li>
</ul>
<p>这些场景的共同特点：</p>
<ul>
<li><strong>数据量大</strong>：百万级 TPS，峰值可达千万级。</li>
<li><strong>写入延迟敏感：</strong> 需要秒级可见。</li>
<li><strong>数据准确性要求高</strong>：不允许数据丢失。</li>
<li><strong>多表写入：</strong> 不同数据根据分表策略写入不同的表。</li>
</ul>
<h3 data-id="heading-2">开源 Flink ClickHouse Sink 的痛点</h3>
<p>Flink 官方提供的 ClickHouse Sink（flink-connector-jdbc）在生产环境中存在以下严重问题：</p>
<h4 data-id="heading-3">痛点一：缺乏基于数据量的攒批机制</h4>
<p><strong>问题表现：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Flink 官方 JDBC Sink 的实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">JdbcSink</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">extends</span> <span class="hljs-title">RichSinkFunction</span>&lt;<span class="hljs-title">T</span>&gt; {
    <span class="hljs-keyword">private</span> final <span class="hljs-built_in">int</span> batchSize;  <span class="hljs-comment">// 固定批次大小</span>
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span>, Context context</span>)</span> {
        bufferedValues.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">value</span>);
        <span class="hljs-keyword">if</span> (bufferedValues.size() &gt;= batchSize) {
            <span class="hljs-comment">// 只能基于记录数攒批，无法基于数据量</span>
            flush();
        }
    }
</code></pre>
<p><strong>带来的问题：</strong></p>
<ol>
<li><strong>内存占用不可控：</strong> 100 条 1KB 的日志和 100 条 10MB 的日志占用内存差距 100 倍。</li>
<li><strong>OOM 风险高：</strong> 大日志记录（如堆栈转储）会迅速撑爆内存。</li>
<li><strong>写入性能差：</strong> 无法根据记录大小动态调整批次，导致小记录批次过大浪费网络开销。</li>
</ol>
<h4 data-id="heading-4">痛点二：无法支持动态表结构</h4>
<p><strong>问题表现：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Flink 官方 Sink 只能写入固定表</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcSink</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> sql;  <span class="hljs-comment">// 固定的 INSERT SQL</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JdbcSink</span><span class="hljs-params">(<span class="hljs-type">String</span> jdbcUrl, <span class="hljs-type">String</span> sql, ...)</span> </span>{
        <span class="hljs-keyword">this</span>.sql = sql;  <span class="hljs-comment">// 硬编码的表结构</span>
    }
}
</code></pre>
<p><strong>带来的问题：</strong></p>
<ol>
<li><strong>多应用无法隔离：</strong> 所有应用的数据写入同一张表，通过特定分表策略区分。</li>
<li><strong>扩展性差：</strong> 新增应用需要手动建表，无法动态路由。</li>
<li><strong>性能瓶颈：</strong> 单表数据量过大（百亿级），查询和写入性能急剧下降。</li>
</ol>
<h4 data-id="heading-5">痛点三：分布式表写入性能问题</h4>
<p><strong>问题表现：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 大多数生产实现直接写入分布式表
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> distributed_table_all <span class="hljs-keyword">VALUES</span> (...)
</code></pre>
<p><strong>ClickHouse 分布式表的工作原理：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/119927d3b86e4b89ad0df2f1d8ae0ca2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=lMTfG4%2FdIpgbs5q5vY4%2BgK2837c%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>带来的问题：</strong></p>
<ol>
<li><strong>网络开销大：</strong> 数据需要经过分布式表层转发，延迟增加。</li>
<li><strong>写入性能差：</strong> 分布式表增加了路由和转发逻辑，吞吐量降低。</li>
<li><strong>热点问题：</strong> 所有数据先到分布式表节点，再转发，造成单点瓶颈。</li>
</ol>
<h3 data-id="heading-6">生产级方案的核心改进</h3>
<p>针对以上痛点，本方案提供了以下核心改进：</p>
<h4 data-id="heading-7">改进一：基于数据量的攒批机制</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseSinkCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Long</span> metaSize;  <span class="hljs-comment">// 累计数据量（字节）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">LogModel value</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">values</span>.<span class="hljs-title function_">add</span>(value);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">metaSize</span> += value.<span class="hljs-title function_">getMetaSize</span>();  <span class="hljs-comment">// 累加数据量</span>
    }
}
<span class="hljs-comment">// 触发条件</span>
<span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">flushCondition</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> application</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">checkMetaSize</span>(application)  <span class="hljs-comment">// metaSize &gt;= 10000 字节</span>
        || <span class="hljs-title function_">checkTime</span>(application);     <span class="hljs-comment">// 或超时 30 秒</span>
}
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>内存可控：</strong> 根据数据量而非记录数攒批。</li>
<li><strong>精确控制：</strong> 1KB 的记录攒 10000 条 = 10MB，1MB 的记录攒 10 条 = 10MB。</li>
<li><strong>避免OOM：</strong> 大日志记录不会撑爆内存。</li>
</ul>
<h4 data-id="heading-8">改进二：动态表结构与分片策略</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseShardStrategy</span>&lt;T&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTableName</span>(T data);
}
<span class="hljs-comment">//日志侧实现为应用级分表</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogClickHouseShardStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ClickHouseShardStrategy</span>&lt;<span class="hljs-title class_">String</span>&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTableName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> application</span>) {
        <span class="hljs-comment">// 动态路由：order-service → tb_logs_order_service</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"tb_logs_%s"</span>, application);
    }
}
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>应用隔离：</strong> 日志侧内置应用级分表，每个应用独立分表。</li>
<li><strong>动态路由：</strong> 根据 application 自动路由到目标表。</li>
<li><strong>扩展性强：</strong> 新增应用无需手动建表（配合 ClickHouse 自动建表）。</li>
</ul>
<h4 data-id="heading-9">改进三：本地表写入 + 动态节点发现</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseLocalWriter</span> extends ClickHouseWriter {
    <span class="hljs-comment">// 直接写本地表，避免分布式表转发</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;<span class="hljs-type">String</span>, HikariDataSource&gt; dataSourceMap;
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> HikariDataSource <span class="hljs-title">getNextDataSource</span><span class="hljs-params">(Set&lt;<span class="hljs-type">String</span>&gt; exceptionHosts)</span> </span>{
        <span class="hljs-comment">// 1. 动态获取集群节点列表</span>
        List&lt;<span class="hljs-type">String</span>&gt; healthyHosts = <span class="hljs-built_in">getHealthyHosts</span>(exceptionHosts);
        <span class="hljs-comment">// 2. 随机选择健康节点</span>
        <span class="hljs-keyword">return</span> dataSourceMap.<span class="hljs-built_in">get</span>(healthyHosts.<span class="hljs-built_in">get</span>(random.<span class="hljs-built_in">nextInt</span>(size)));
    }
}
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>性能提升：</strong> 直接写本地表，避免网络转发。</li>
<li><strong>高可用：</strong> 动态节点发现 + 故障节点剔除。</li>
<li><strong>负载均衡：</strong> 随机选择 + Shuffle 初始化。</li>
</ul>
<h3 data-id="heading-10">技术方案概览</h3>
<p>基于以上改进，本方案提供了以下核心能力：</p>
<ol>
<li><strong>本地表/分布式表写入：</strong> 性能优化与高可用平衡。</li>
<li><strong>分片策略：</strong> 按应用维度路由与隔离。</li>
<li><strong>攒批与内存控制：</strong> 双触发机制（数据量 + 超时）。</li>
<li><strong>流量控制与限流：</strong> 有界队列 + 连接池。</li>
<li><strong>健壮的重试机制：</strong> 递归重试 + 故障节点剔除。</li>
<li><strong>Checkpoint 语义保证：</strong> At-Least-Once 数据一致性。</li>
</ol>
<h2 data-id="heading-11">二、核心架构设计</h2>
<h3 data-id="heading-12">架构图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6230f98edcb4387a91be9777855e095~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=0asR5n8cBcdMRovjP61HlgLzcJU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-13">核心组件</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ae0e0cae190480a906ce9eedc850e55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=yfhgmUdoRLsLwyvcbV7UO%2FBC7wg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-14">核心流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/994fb8f04a3f4a5e9037ed1d68ed4fd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=%2Bu1yXFOZ5fTWFhCbOH4FWVmZcZo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-15">三、本地表 vs 分布式表写入</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aefda04b30094fa7a7597653ebe525d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=nvVXa8CPurVbLZzR%2BPN58hXZQ7E%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-16">ClickHouse 表结构说明</h3>
<p>ClickHouse <strong>推荐直接写本地表</strong>，原因：</p>
<ol>
<li><strong>写入性能：</strong> 避免分布式表的网络分发。</li>
<li><strong>数据一致性：</strong> 直接写入目标节点，减少中间环节故障点，比分布式表写入更安全，利于工程化。</li>
<li><strong>负载均衡：</strong> 客户端路由实现负载分散。</li>
</ol>

<pre><code class="hljs language-scss" lang="scss">-- 本地表（实际存储数据）
CREATE <span class="hljs-selector-tag">TABLE</span> tb_logs_local ON CLUSTER 'default' (
    application String,
    environment String,
    message String,
    log_time DateTime
) ENGINE = <span class="hljs-built_in">MergeTree</span>()
PARTITION BY <span class="hljs-built_in">toYYYYMM</span>(log_time)
<span class="hljs-attribute">ORDER</span> BY (application, log_time);
-- 分布式表（逻辑视图，不存储数据）
CREATE <span class="hljs-selector-tag">TABLE</span> tb_logs_all ON CLUSTER 'default' AS tb_logs_local
ENGINE = <span class="hljs-built_in">Distributed</span>('default', dw_log, tb_logs_local, cityHash64(application));
</code></pre>
<h3 data-id="heading-17">HikariCP 连接池配置</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// HikariCP 连接池配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseDataSourceUtils</span> {
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">static</span> HikariConfig <span class="hljs-title">getHikariConfig</span><span class="hljs-params">(DataSourceImpl dataSource)</span> </span>{
        HikariConfig config = <span class="hljs-keyword">new</span> <span class="hljs-built_in">HikariConfig</span>();
        config.<span class="hljs-built_in">setConnectionTimeout</span>(<span class="hljs-number">30000L</span>);    <span class="hljs-comment">// 连接超时 30s</span>
        config.<span class="hljs-built_in">setMaximumPoolSize</span>(<span class="hljs-number">20</span>);          <span class="hljs-comment">// 最大连接数 20</span>
        config.<span class="hljs-built_in">setMinimumIdle</span>(<span class="hljs-number">2</span>);               <span class="hljs-comment">// 最小空闲 2</span>
        config.<span class="hljs-built_in">setDataSource</span>(dataSource);
        <span class="hljs-keyword">return</span> config;
    }
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">static</span> Properties <span class="hljs-title">getClickHouseProperties</span><span class="hljs-params">(ClickHouseSinkCommonParams params)</span> </span>{
        Properties props = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Properties</span>();
        props.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"user"</span>, params.<span class="hljs-built_in">getUser</span>());
        props.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"password"</span>, params.<span class="hljs-built_in">getPassword</span>());
        props.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"database"</span>, params.<span class="hljs-built_in">getDatabase</span>());
        props.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"socket_timeout"</span>, <span class="hljs-string">"180000"</span>);      <span class="hljs-comment">// Socket 超时 3 分钟</span>
        props.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"socket_keepalive"</span>, <span class="hljs-string">"true"</span>);      <span class="hljs-comment">// 保持连接</span>
        props.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"http_connection_provider"</span>, <span class="hljs-string">"APACHE_HTTP_CLIENT"</span>);
        <span class="hljs-keyword">return</span> props;
    }
}
</code></pre>
<p><strong>配置说明：</strong></p>
<ul>
<li>maxPoolSize=20：每个 ClickHouse 节点最多 20 个连接。</li>
<li>minIdle=2：保持 2 个空闲连接，避免频繁创建。</li>
<li>socket_timeout=180s：Socket 超时 3 分钟，防止长时间查询阻塞。</li>
</ul>
<h3 data-id="heading-18">ClickHouseLocalWriter：动态节点发现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseLocalWriter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ClickHouseWriter</span> {
    <span class="hljs-comment">// 本地节点缓存，按 IP 维护</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">ConcurrentMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">HikariDataSource</span>&gt; dataSourceMap;
    <span class="hljs-comment">// 动态获取集群本地表节点</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">ClusterIpsUtils</span> clusterIpsUtils;
    <span class="hljs-comment">// IP 变更标志（CAS 锁，避免并发更新）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">AtomicBoolean</span> <span class="hljs-variable constant_">IP_CHANGING</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">HikariDataSource</span> <span class="hljs-title function_">getNextDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;<span class="hljs-built_in">String</span>&gt; exceptionHosts</span>) {
        <span class="hljs-comment">// 1️⃣ 检测集群节点变化（通过 CAS 避免并发更新）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">clusterIpsChanged</span>() &amp;&amp; <span class="hljs-variable constant_">IP_CHANGING</span>.<span class="hljs-title function_">compareAndSet</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-title function_">ipChanged</span>(); <span class="hljs-comment">// 动态更新 dataSourceMap</span>
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-variable constant_">IP_CHANGING</span>.<span class="hljs-title function_">set</span>(<span class="hljs-literal">false</span>);
            }
        }
        <span class="hljs-comment">// 2️⃣ 获取异常节点列表（从 Redis + APM 实时查询）</span>
        <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; exceptIps = clusterIpsUtils.<span class="hljs-title function_">getExceptIps</span>();
        exceptIps.<span class="hljs-title function_">addAll</span>(exceptionHosts);
        <span class="hljs-comment">// 3️⃣ 过滤健康节点，随机选择</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; healthyHosts = dataSourceMap.<span class="hljs-title function_">keySet</span>().<span class="hljs-title function_">stream</span>()
            .<span class="hljs-title function_">filter</span>(host -&gt; !exceptIps.<span class="hljs-title function_">contains</span>(host))
            .<span class="hljs-title function_">collect</span>(<span class="hljs-title class_">Collectors</span>.<span class="hljs-title function_">toList</span>());
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">CollectionUtils</span>.<span class="hljs-title function_">isEmpty</span>(healthyHosts)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Can't get datasource from local cache"</span>);
        }
        <span class="hljs-keyword">return</span> dataSourceMap.<span class="hljs-title function_">get</span>(healthyHosts.<span class="hljs-title function_">get</span>(random.<span class="hljs-title function_">nextInt</span>(healthyHosts.<span class="hljs-title function_">size</span>())));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">ipChanged</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; clusterIps = clusterIpsUtils.<span class="hljs-title function_">getClusterIps</span>();
        <span class="hljs-comment">// 新增节点：自动创建连接池</span>
        clusterIps.<span class="hljs-title function_">forEach</span>(ip -&gt;
            dataSourceMap.<span class="hljs-title function_">computeIfAbsent</span>(ip, v -&gt;
                <span class="hljs-title function_">createHikariDataSource</span>(ip, port)
            )
        );
        <span class="hljs-comment">// 移除下线节点：关闭连接池</span>
        dataSourceMap.<span class="hljs-title function_">forEach</span>((ip, ds) -&gt; {
            <span class="hljs-keyword">if</span> (!clusterIps.<span class="hljs-title function_">contains</span>(ip)) {
                dataSourceMap.<span class="hljs-title function_">remove</span>(ip);
                ds.<span class="hljs-title function_">close</span>();
            }
        });
    }
}
</code></pre>
<p><strong>核心逻辑：</strong></p>
<ol>
<li><strong>动态节点发现：</strong> 从 system.clusters 查询所有节点。</li>
<li><strong>自动扩缩容：</strong> 节点上线自动加入，下线自动剔除。</li>
<li><strong>故障节点剔除：</strong> 通过 APM 监控，自动剔除异常节点。</li>
<li><strong>负载均衡：</strong> 随机选择健康节点，避免热点。</li>
</ol>
<h3 data-id="heading-19">集群节点动态发现（ClusterIpsUtils）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ClusterIpsUtils</span> {
    <span class="hljs-comment">// 从 system.clusters 查询所有节点</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">QUERY_CLUSTER_IPS</span> =
        "<span class="hljs-selector-tag">select</span> <span class="hljs-selector-tag">host_address</span> <span class="hljs-selector-tag">from</span> <span class="hljs-selector-tag">system</span><span class="hljs-selector-class">.clusters</span> <span class="hljs-selector-tag">where</span> <span class="hljs-selector-tag">cluster</span> = '<span class="hljs-selector-tag">default</span>'";
    <span class="hljs-comment">// LoadingCache：定时刷新节点列表（1 小时）</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">LoadingCache</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">String</span>&gt;&gt; <span class="hljs-selector-tag">clusterIpsCache</span> =
        <span class="hljs-selector-tag">CacheBuilder</span><span class="hljs-selector-class">.newBuilder</span>()
            <span class="hljs-selector-class">.expireAfterAccess</span>(<span class="hljs-number">10</span>, TimeUnit.HOURS)
            <span class="hljs-selector-class">.refreshAfterWrite</span>(<span class="hljs-number">1</span>, TimeUnit.HOURS)
            <span class="hljs-selector-class">.build</span>(CacheLoader.<span class="hljs-built_in">asyncReloading</span>(new CacheLoader&lt;&gt;() {
                <span class="hljs-variable">@Override</span>
                public List&lt;String&gt; <span class="hljs-built_in">load</span>(String dbName) {
                    return <span class="hljs-built_in">queryClusterIps</span>();  <span class="hljs-comment">// 定时刷新节点列表</span>
                }
            }));
    <span class="hljs-comment">// 异常节点缓存（1 分钟刷新）</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">LoadingCache</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">FlinkExceptIpModel</span>&gt; <span class="hljs-selector-tag">exceptIpsCache</span> =
        <span class="hljs-selector-tag">CacheBuilder</span><span class="hljs-selector-class">.newBuilder</span>()
            <span class="hljs-selector-class">.refreshAfterWrite</span>(<span class="hljs-number">1</span>, TimeUnit.MINUTES)
            <span class="hljs-selector-class">.build</span>(CacheLoader.<span class="hljs-built_in">asyncReloading</span>(new CacheLoader&lt;&gt;() {
                <span class="hljs-variable">@Override</span>
                public FlinkExceptIpModel <span class="hljs-built_in">load</span>(String dbName) {
                    return <span class="hljs-built_in">queryExceptIp</span>();  <span class="hljs-comment">// 从 Redis + APM 查询异常节点</span>
                }
            }));
}
</code></pre>
<p><strong>异常节点监控策略：</strong></p>
<ul>
<li><strong>磁盘使用率 &gt;= 90%：</strong> 从 APM 查询 Prometheus 指标，自动加入黑名单。</li>
<li><strong>HTTP 连接数 &gt;= 50：</strong> 连接数过多说明节点压力大，自动加入黑名单。</li>
<li><strong>人工配置：</strong> 通过 Redis 配置手动剔除节点</li>
</ul>
<p><strong>数据来源：</strong></p>
<ol>
<li><strong>ClickHouse system.clusters 表：</strong> 获取所有集群节点。</li>
<li><strong>APM Prometheus 接口：</strong> 监控节点健康状态。</li>
<li><strong>Redis 缓存：</strong> 人工配置的异常节点。</li>
</ol>
<h3 data-id="heading-20">负载均衡优化</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseWriter</span> {
    <span class="hljs-keyword">public</span> &lt;T&gt; ClickHouseWriter(...) {
        <span class="hljs-comment">// Shuffle：随机打乱数据源顺序</span>
        Collections.shuffle(clickHouseDataSources);
        <span class="hljs-keyword">this</span>.clickHouseDataSources = clickHouseDataSources;
    }
    <span class="hljs-keyword">public</span> HikariDataSource getNextDataSource(Set&lt;String&gt; exceptionHosts) {
        <span class="hljs-comment">// 轮询 + 随机选择（已 shuffle，避免热点）</span>
        int current = <span class="hljs-keyword">this</span>.currentRandom.getAndIncrement();
        <span class="hljs-keyword">if</span> (current &gt;= clickHouseDataSources.size()) {
            <span class="hljs-keyword">this</span>.currentRandom.<span class="hljs-keyword">set</span>(<span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">return</span> clickHouseDataSources.<span class="hljs-keyword">get</span>(currentRandom.<span class="hljs-keyword">get</span>());
    }
}
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>初始化时 shuffle，避免所有 writer 同时从第一个节点开始。</li>
<li>轮询 + 随机选择，负载分散更均匀。</li>
<li>故障节点自动剔除。</li>
</ul>
<h2 data-id="heading-21">四、支持分表策略</h2>
<h3 data-id="heading-22">分片策略抽象</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClickHouseShardStrategy</span>&lt;<span class="hljs-title">T</span>&gt; {
    <span class="hljs-keyword">private</span> String tableName;      <span class="hljs-comment">// 表名模板，如 "tb_log_%s"</span>
    <span class="hljs-keyword">private</span> Integer tableCount;    <span class="hljs-comment">// 分表数量</span>
    <span class="hljs-comment">// 根据数据决定目标表名</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">getTableName</span>(<span class="hljs-params">T data</span>)</span>;
}
</code></pre>
<h3 data-id="heading-23">日志分片实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogClickHouseShardStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ClickHouseShardStrategy</span>&lt;<span class="hljs-title class_">String</span>&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTableName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> application</span>) {
        <span class="hljs-comment">// 表名格式：tb_log_{application}</span>
        <span class="hljs-comment">// 例如：application = "order-service" -&gt; table = "tb_log_order_service"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTableName</span>(),
            application.<span class="hljs-title function_">replace</span>(<span class="hljs-string">"-"</span>, <span class="hljs-string">"_"</span>).<span class="hljs-title function_">toLowerCase</span>()
        );
    }
}
</code></pre>
<h3 data-id="heading-24">按表（应用）维度的缓冲区</h3>
<p>日志侧维度降级为应用名称维度缓冲区，实则因为按照应用分表，</p>
<p>业务方可使用自身分表策略携带表名元数据，进行表维度缓冲。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseShardSinkBuffer</span> {
    <span class="hljs-comment">// 按 application 分组的缓冲区（ConcurrentHashMap 保证并发安全）</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">ConcurrentHashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">ClickHouseSinkCounter</span>&gt; localValues;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">put</span>(<span class="hljs-params">LogModel value</span>) {
        <span class="hljs-title class_">String</span> application = value.<span class="hljs-title function_">getApplication</span>();
        <span class="hljs-comment">// 1️⃣ 检查是否需要 flush</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">flushCondition</span>(application)) {
            <span class="hljs-title function_">addToQueue</span>(application); <span class="hljs-comment">// 触发写入</span>
        }
        <span class="hljs-comment">// 2️⃣ 添加到缓冲区（线程安全的 compute 操作）</span>
        localValues.<span class="hljs-title function_">compute</span>(application, (k, v) -&gt; {
            <span class="hljs-keyword">if</span> (v == <span class="hljs-literal">null</span>) v = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClickHouseSinkCounter</span>();
            v.<span class="hljs-title function_">add</span>(value);
            <span class="hljs-keyword">return</span> v;
        });
    }
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addToQueue</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> application</span>) {
        localValues.<span class="hljs-title function_">computeIfPresent</span>(application, (k, v) -&gt; {
            <span class="hljs-comment">// 深拷贝并清空（避免并发修改异常）</span>
            <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">LogModel</span>&gt; deepCopy = v.<span class="hljs-title function_">copyValuesAndClear</span>();
            <span class="hljs-comment">// 构造请求 Blank：application + targetTable + values</span>
            <span class="hljs-title class_">String</span> targetTable = shardStrategy.<span class="hljs-title function_">getTableName</span>(application);
            <span class="hljs-title class_">ClickHouseRequestBlank</span> blank = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClickHouseRequestBlank</span>(deepCopy, application, targetTable);
            <span class="hljs-comment">// 放入队列</span>
            writer.<span class="hljs-title function_">put</span>(blank);
            <span class="hljs-keyword">return</span> v;
        });
    }
}
</code></pre>
<p><strong>核心设计：</strong></p>
<ul>
<li><strong>应用隔离：</strong> 每个表（应用）独立的 buffer，互不影响。</li>
<li><strong>线程安全：</strong> 使用 ConcurrentHashMap.compute()保证并发安全。</li>
<li><strong>深拷贝：</strong> List.copyOf() 创建不可变副本，避免并发修改。</li>
<li><strong>批量清空：</strong> 一次性取出所有数据，清空计数器。</li>
</ul>
<h2 data-id="heading-25">五、攒批与内存控制</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fbe4dbd0e40420ebfe253fdd2c5209a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=SS577U1jEN8%2BTZ3ptFL3TZKSQF4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-26">双触发机制</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseShardSinkBuffer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> maxFlushBufferSize;  <span class="hljs-comment">// 最大批次大小（如 10000）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeoutMillis;      <span class="hljs-comment">// 超时时间（如 30s）</span>
    <span class="hljs-comment">// 触发条件检查（满足任一即触发）</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title">flushCondition</span><span class="hljs-params">(<span class="hljs-type">String</span> application)</span> </span>{
        <span class="hljs-keyword">return</span> localValues.<span class="hljs-built_in">get</span>(application) != null
            &amp;&amp; (<span class="hljs-built_in">checkMetaSize</span>(application) || <span class="hljs-built_in">checkTime</span>(application));
    }
    <span class="hljs-comment">// 条件1：达到批次大小</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title">checkMetaSize</span><span class="hljs-params">(<span class="hljs-type">String</span> application)</span> </span>{
        <span class="hljs-keyword">return</span> localValues.<span class="hljs-built_in">get</span>(application).<span class="hljs-built_in">getMetaSize</span>() &gt;= maxFlushBufferSize;
    }
    <span class="hljs-comment">// 条件2：超时</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title">checkTime</span><span class="hljs-params">(<span class="hljs-type">String</span> application)</span> </span>{
        <span class="hljs-type">long</span> current = System.<span class="hljs-built_in">currentTimeMillis</span>();
        <span class="hljs-keyword">return</span> current - localValues.<span class="hljs-built_in">get</span>(application).<span class="hljs-built_in">getInsertTime</span>() &gt; timeoutMillis;
    }
}
</code></pre>
<h3 data-id="heading-27">批次大小计算</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseSinkCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;LogModel&gt; values;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> metaSize; <span class="hljs-comment">// 累计的 metaSize（字节）</span>
    <span class="hljs-keyword">public</span> void add(LogModel value) {
        <span class="hljs-keyword">this</span>.values.add(value);
        <span class="hljs-keyword">this</span>.metaSize += value.getMetaSize(); <span class="hljs-comment">// 累加 metaSize</span>
    }
    <span class="hljs-keyword">public</span> List&lt;LogModel&gt; copyValuesAndClear() {
        List&lt;LogModel&gt; logModels = List.copyOf(<span class="hljs-keyword">this</span>.values); <span class="hljs-comment">// 深拷贝（不可变）</span>
        <span class="hljs-keyword">this</span>.values.clear();
        <span class="hljs-keyword">this</span>.metaSize = <span class="hljs-number">0L</span>;
        <span class="hljs-keyword">this</span>.insertTime = System.currentTimeMillis();
        <span class="hljs-keyword">return</span> logModels;
    }
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>使用 metaSize（字节数）而非记录数控制批次，内存控制更精确。</li>
<li>List.copyOf() 创建不可变副本，避免并发修改。</li>
<li>清空后重置 insertTime，保证超时触发准确性。</li>
</ul>
<h3 data-id="heading-28">带随机抖动的超时</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeoutMillis;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClickHouseShardSinkBuffer</span><span class="hljs-params">(..., <span class="hljs-type">int</span> timeoutSec, ...)</span> </span>{
    <span class="hljs-comment">// 基础超时 + 10% 随机抖动（避免惊群效应）</span>
    <span class="hljs-keyword">this</span>.timeoutMillis = TimeUnit.SECONDS.<span class="hljs-built_in">toMillis</span>(timeoutSec)
                      + <span class="hljs-keyword">new</span> <span class="hljs-built_in">SecureRandom</span>().<span class="hljs-built_in">nextInt</span>((<span class="hljs-type">int</span>) (timeoutSec * <span class="hljs-number">0.1</span> * <span class="hljs-number">1000</span>));
}
</code></pre>
<p><strong>目的：</strong> 避免多个TM 同时触发 flush，造成写入流量峰值。</p>
<h3 data-id="heading-29">配置示例</h3>
<pre><code class="hljs language-scss" lang="scss">ClickHouseShardSinkBuffer<span class="hljs-selector-class">.Builder</span>
    <span class="hljs-selector-class">.aClickHouseSinkBuffer</span>()
    <span class="hljs-selector-class">.withTargetTable</span>("single_table")  <span class="hljs-comment">//单表时，可直接使用指定表名</span>
    <span class="hljs-selector-class">.withMaxFlushBufferSize</span>(<span class="hljs-number">10000</span>)  <span class="hljs-comment">// 对应字节数</span>
    <span class="hljs-selector-class">.withTimeoutSec</span>(<span class="hljs-number">30</span>)              <span class="hljs-comment">// 30 秒超时</span>
    <span class="hljs-selector-class">.withClickHouseShardStrategy</span>(new LogClickHouseShardStrategy("table_prefix_%s", <span class="hljs-number">8</span>))  <span class="hljs-comment">//分表策略时，使用</span>
    <span class="hljs-comment">// 分表策略可根据业务实际情况进行扩展</span>
    <span class="hljs-selector-class">.build</span>(clickHouseWriter);
</code></pre>
<h2 data-id="heading-30">六、写入限流与流量控制</h2>
<h3 data-id="heading-31">有界队列设计</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClickHouseWriter</span> {
    <span class="hljs-comment">// 有界阻塞队列</span>
    <span class="hljs-keyword">private</span> final BlockingQueue&lt;ClickHouseRequestBlank&gt; commonQueue;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClickHouseWriter</span>(<span class="hljs-params">ClickHouseSinkCommonParams sinkParams, ...</span>)</span> {
        <span class="hljs-comment">// 队列最大容量配置（默认 10）</span>
        <span class="hljs-keyword">this</span>.commonQueue = <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;&gt;(sinkParams.getQueueMaxCapacity());
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span>(<span class="hljs-params">ClickHouseRequestBlank <span class="hljs-keyword">params</span></span>)</span> {
        unProcessedCounter.incrementAndGet();
        <span class="hljs-comment">// put() 方法在队列满时会阻塞，实现背压</span>
        commonQueue.put(<span class="hljs-keyword">params</span>);
    }
}
</code></pre>
<p>背压传导：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec8c6b583404a38a991008e87765dfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=opiqc2MK6x4y25odW74eMs9%2BN2U%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-32">线程池并发控制</h3>
<pre><code class="hljs language-ini" lang="ini">public class ClickHouseWriter {
    private final int numWriters<span class="hljs-comment">; // 写入线程数</span>
    private ExecutorService service<span class="hljs-comment">;</span>
    private void buildComponents() {
        ThreadFactory <span class="hljs-attr">threadFactory</span> = ThreadUtil.threadFactory(<span class="hljs-string">"clickhouse-writer"</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">service</span> = Executors.newFixedThreadPool(numWriters, threadFactory)<span class="hljs-comment">;</span>
        // 创建多个 WriterTask 并提交
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; numWriters; i++) {</span>
            WriterTask <span class="hljs-attr">task</span> = new WriterTask(i, commonQueue, sinkParams, futures, unProcessedCounter)<span class="hljs-comment">;</span>
            service.submit(task)<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-33">WriterTask 消费逻辑</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WriterTask</span> implements Runnable {
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
        isWorking = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">while</span> (isWorking || !queue.<span class="hljs-built_in">isEmpty</span>()) {
            <span class="hljs-comment">// poll() 超时返回（100ms），避免无限等待</span>
            ClickHouseRequestBlank blank = queue.<span class="hljs-built_in">poll</span>(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);
            <span class="hljs-keyword">if</span> (blank != null) {
                <span class="hljs-comment">// 创建 Future 并设置超时（3 分钟）</span>
                CompletableFuture&lt;Boolean&gt; future = <span class="hljs-keyword">new</span> CompletableFuture&lt;&gt;();
                future.<span class="hljs-built_in">orTimeout</span>(<span class="hljs-number">3</span>, TimeUnit.MINUTES);
                futures.<span class="hljs-built_in">add</span>(future);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-built_in">send</span>(blank, future, <span class="hljs-keyword">new</span> HashSet&lt;&gt;());
                } finally {
                    <span class="hljs-comment">// final 进行未知异常兜底，防止为捕获异常造成future状态不完成，永久阻塞</span>
                    <span class="hljs-keyword">if</span> (!future.<span class="hljs-built_in">isDone</span>()) {
                        future.<span class="hljs-built_in">completeExceptionally</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"Unknown exception"</span>));
                    }
                    queueCounter.<span class="hljs-built_in">decrementAndGet</span>();
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-34">配置参数</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9d99484e9774322948675bc946eb62f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=%2F5ipurXD1JRrSwWbG4hz7k0OScU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-35">七、重试机制与超时控制</h2>
<h3 data-id="heading-36">Future 超时控制</h3>
<pre><code class="hljs language-ini" lang="ini">public class ClickHouseWriter {
    private final int numWriters<span class="hljs-comment">; // 写入线程数</span>
    private ExecutorService service<span class="hljs-comment">;</span>
    private void buildComponents() {
        ThreadFactory <span class="hljs-attr">threadFactory</span> = ThreadUtil.threadFactory(<span class="hljs-string">"clickhouse-writer"</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">service</span> = Executors.newFixedThreadPool(numWriters, threadFactory)<span class="hljs-comment">;</span>
        // 创建多个 WriterTask 并提交
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; numWriters; i++) {</span>
            WriterTask <span class="hljs-attr">task</span> = new WriterTask(i, commonQueue, sinkParams, futures, unProcessedCounter)<span class="hljs-comment">;</span>
            service.submit(task)<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<p><strong>超时策略：</strong></p>
<ul>
<li><strong>Future 超时：</strong> 3 分钟（orTimeout）。</li>
<li><strong>Socket 超时：</strong> 3 分钟（socket_timeout=180000）。</li>
<li><strong>连接超时：</strong> 30 秒（connectionTimeout=30000）。</li>
</ul>
<h3 data-id="heading-37">重试逻辑</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WriterTask</span> implements Runnable {
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
        isWorking = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">while</span> (isWorking || !queue.<span class="hljs-built_in">isEmpty</span>()) {
            <span class="hljs-comment">// poll() 超时返回（100ms），避免无限等待</span>
            ClickHouseRequestBlank blank = queue.<span class="hljs-built_in">poll</span>(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);
            <span class="hljs-keyword">if</span> (blank != null) {
                <span class="hljs-comment">// 创建 Future 并设置超时（3 分钟）</span>
                CompletableFuture&lt;Boolean&gt; future = <span class="hljs-keyword">new</span> CompletableFuture&lt;&gt;();
                future.<span class="hljs-built_in">orTimeout</span>(<span class="hljs-number">3</span>, TimeUnit.MINUTES);
                futures.<span class="hljs-built_in">add</span>(future);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-built_in">send</span>(blank, future, <span class="hljs-keyword">new</span> HashSet&lt;&gt;());
                } finally {
                    <span class="hljs-comment">// final 进行未知异常兜底，防止为捕获异常造成future状态不完成，永久阻塞</span>
                    <span class="hljs-keyword">if</span> (!future.<span class="hljs-built_in">isDone</span>()) {
                        future.<span class="hljs-built_in">completeExceptionally</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"Unknown exception"</span>));
                    }
                    queueCounter.<span class="hljs-built_in">decrementAndGet</span>();
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-38">重试控制逻辑</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">handleUnsuccessfulResponse</span><span class="hljs-params">(..., Set&lt;<span class="hljs-type">String</span>&gt; exceptHosts)</span> </span>{
    <span class="hljs-comment">// 检查 Future 是否已完成（避免重复完成）</span>
    <span class="hljs-keyword">if</span> (future.<span class="hljs-built_in">isDone</span>()) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (attemptCounter &gt;= maxRetries) {
        <span class="hljs-comment">// 达到最大重试次数，标记失败</span>
        future.<span class="hljs-built_in">completeExceptionally</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"Max retries exceeded"</span>));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 递归重试</span>
        requestBlank.<span class="hljs-built_in">incrementCounter</span>();
        <span class="hljs-built_in">send</span>(requestBlank, future, exceptHosts); <span class="hljs-comment">// 递归调用，排除失败节点</span>
    }
}
</code></pre>
<p><strong>重试策略：</strong></p>
<ul>
<li><strong>递归重试：</strong> 失败后递归调用，直到成功或达到最大次数。</li>
<li><strong>异常节点隔离：</strong> 每次重试时排除失败的节点（exceptHosts）。</li>
<li><strong>超时控制：</strong> Future 超时（3 分钟）防止永久阻塞。</li>
</ul>
<p><strong>为什么递归重试是更好的选择</strong></p>
<p><strong>递归重试（当前实现）</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cff580bff498427780a97a1280a54a21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=jW5LDcOYN7cZmZdYx9jVzsqyzfk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>队列重试（假设方案）</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfe6d6876377456b9fd028835aefc42c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=R7dRjFjZaqR8ZPbcCRsfZi5jIlk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h4 data-id="heading-39">保证一致性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">  <span class="hljs-comment">// ClickHouseWriter.java:139-158</span>
  <span class="hljs-keyword">while</span> (!futures.isEmpty() || unProcessedCounter.<span class="hljs-keyword">get</span>() &gt; <span class="hljs-number">0</span>) {
      CompletableFuture&lt;<span class="hljs-built_in">Void</span>&gt; future = FutureUtil.allOf(futures);
      future.<span class="hljs-keyword">get</span>(<span class="hljs-number">3</span>, TimeUnit.MINUTES);  <span class="hljs-comment">// 阻塞直到全部完成</span>
  }
</code></pre>
<ul>
<li>Checkpoint 时所有数据要么全部成功，要么全部失败。</li>
<li>重启后不会有部分数据重复的问题。</li>
</ul>
<h4 data-id="heading-40">简单可靠</h4>
<ul>
<li>代码逻辑清晰。</li>
<li>对于队列重试且不重复，需要复杂的二阶段提交（这里暂不展开），大幅增加代码复杂度。</li>
</ul>
<h4 data-id="heading-41">性能可接受</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WriterTask</span> implements Runnable {
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">while</span> (isWorking || !queue.<span class="hljs-built_in">isEmpty</span>()) {
            ClickHouseRequestBlank blank = queue.<span class="hljs-built_in">poll</span>(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);
            <span class="hljs-keyword">if</span> (blank != null) {
                <span class="hljs-comment">// 创建 Future 并设置 3 分钟超时</span>
                CompletableFuture&lt;Boolean&gt; future = <span class="hljs-keyword">new</span> CompletableFuture&lt;&gt;();
                future.<span class="hljs-built_in">orTimeout</span>(<span class="hljs-number">3</span>, TimeUnit.MINUTES); <span class="hljs-comment">// 防止永久阻塞</span>
                futures.<span class="hljs-built_in">add</span>(future);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-built_in">send</span>(blank, future, <span class="hljs-keyword">new</span> HashSet&lt;&gt;());
                } finally {
                    <span class="hljs-keyword">if</span> (!future.<span class="hljs-built_in">isDone</span>()) {
                        future.<span class="hljs-built_in">completeExceptionally</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"Timeout"</span>));
                    }
                    queueCounter.<span class="hljs-built_in">decrementAndGet</span>();
                }
            }
        }
    }
}
</code></pre>
<ul>
<li>虽然阻塞，但有超时保护。</li>
<li>ClickHouse 写入通常很快（秒级）。</li>
<li>网络故障时重试也合理。</li>
</ul>
<h4 data-id="heading-42">避开故障节点</h4>
<pre><code class="hljs language-ini" lang="ini">  // ClickHouseWriter.java:259-260
  HikariDataSource <span class="hljs-attr">dataSource</span> = getNextDataSource(exceptHosts)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>递归时可以传递 exceptHosts。</li>
<li>自动避开失败的节点。</li>
<li>提高成功率。</li>
</ul>
<h3 data-id="heading-43">异常节点剔除</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 特殊错误码列表（自动加入黑名单）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Integer&gt; ignoreHostCodes = Arrays.asList(<span class="hljs-number">210</span>, <span class="hljs-number">1002</span>);
<span class="hljs-keyword">public</span> HikariDataSource getNextDataSource(Set&lt;String&gt; exceptionHosts) {
    <span class="hljs-keyword">if</span> (CollectionUtils.isNotEmpty(exceptionHosts)) {
        <span class="hljs-comment">// 过滤异常节点</span>
        List&lt;HikariDataSource&gt; healthyHosts = clickHouseDataSources.stream()
            .filter(ds -&gt; !exceptionHosts.contains(getHostFromUrl(ds)))
            .collect(Collectors.toList());
        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(healthyHosts)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 所有节点都异常</span>
        }
        <span class="hljs-keyword">return</span> healthyHosts.<span class="hljs-keyword">get</span>(random.nextInt(healthyHosts.size()));
    }
    <span class="hljs-comment">// 正常轮询（已 shuffle，避免热点）</span>
    <span class="hljs-keyword">return</span> clickHouseDataSources.<span class="hljs-keyword">get</span>(currentRandom.getAndIncrement() % size);
}
</code></pre>
<p><strong>故障节点剔除策略：</strong></p>
<ol>
<li><strong>错误码 210（网络异常）：</strong> 自动加入黑名单。</li>
<li><strong>错误码 1002（连接池异常）：</strong> 自动加入黑名单。</li>
<li><strong>APM 监控：</strong> 磁盘 &gt;= 90%、HTTP 连接 &gt;= 50 的节点。</li>
<li><strong>手动配置：</strong> 通过 Redis 配置剔除。</li>
</ol>
<p><strong>恢复机制：</strong></p>
<ul>
<li>LoadingCache 定时刷新（1 分钟）。</li>
<li>节点恢复健康后自动从黑名单移除。</li>
</ul>
<h3 data-id="heading-44">重试流程图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0189dadaec2c4a59a03071e72b007243~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=q3T5EN6w2kq4WuyZT2e%2F3pWOLvQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-45">八、异常处理模式</h2>
<h3 data-id="heading-46">两种 Sink 模式</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> Sink <span class="hljs-title">buildSink</span><span class="hljs-params">(<span class="hljs-type">String</span> targetTable, <span class="hljs-type">String</span> targetCount, <span class="hljs-type">int</span> maxBufferSize)</span> </span>{
    IClickHouseSinkBuffer buffer = ClickHouseShardSinkBuffer.Builder
        .<span class="hljs-built_in">aClickHouseSinkBuffer</span>()
        .<span class="hljs-built_in">withTargetTable</span>(targetTable)
        .<span class="hljs-built_in">withMaxFlushBufferSize</span>(maxBufferSize)
        .<span class="hljs-built_in">withClickHouseShardStrategy</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">LogClickHouseShardStrategy</span>(targetTable, count))
        .<span class="hljs-built_in">build</span>(clickHouseWriter);
    <span class="hljs-comment">// 根据配置选择模式</span>
    <span class="hljs-keyword">if</span> (ignoringClickHouseSendingExceptionEnabled) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">UnexceptionableSink</span>(buffer);  <span class="hljs-comment">// 忽略异常</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ExceptionsThrowableSink</span>(buffer); <span class="hljs-comment">// 抛出异常</span>
    }
}
</code></pre>
<h3 data-id="heading-47">UnexceptionableSink（忽略异常 - At-Most-Once）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnexceptionableSink</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Sink</span>&lt;<span class="hljs-title class_">LogModel</span>&gt; {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">IClickHouseSinkBuffer</span>&lt;<span class="hljs-title class_">LogModel</span>&gt; buffer;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">put</span>(<span class="hljs-params">LogModel message</span>) {
        buffer.<span class="hljs-title function_">put</span>(message);  <span class="hljs-comment">// 不检查 Future 状态</span>
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">flush</span>(<span class="hljs-params"/>) {
        buffer.<span class="hljs-title function_">flush</span>();
    }
}
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>允许部分数据丢失。</li>
<li>不希望因写入异常导致任务失败。</li>
<li>对数据准确性要求不高（如日志统计）。</li>
</ul>
<p><strong>语义保证：At-Most-Once（最多一次）</strong></p>
<h3 data-id="heading-48">ExceptionsThrowableSink（抛出异常 - At-Least-Once）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionsThrowableSink</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Sink</span>&lt;LogModel&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IClickHouseSinkBuffer&lt;LogModel&gt; buffer;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(LogModel message)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException {
        buffer.put(message);
        <span class="hljs-comment">// 每次写入都检查 Future 状态</span>
        buffer.assertFuturesNotFailedYet();
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flush</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException {
        buffer.flush();
    }
}
</code></pre>
<p><strong>Future 状态检查：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">assertFuturesNotFailedYet</span><span class="hljs-params">()</span> throws ExecutionException, InterruptedException </span>{
    CompletableFuture&lt;Void&gt; future = FutureUtil.<span class="hljs-built_in">allOf</span>(futures);
    <span class="hljs-comment">// 非阻塞检查</span>
    <span class="hljs-keyword">if</span> (future.<span class="hljs-built_in">isCompletedExceptionally</span>()) {
        logger.<span class="hljs-built_in">error</span>(<span class="hljs-string">"There is something wrong with the future. exist sink now"</span>);
        future.<span class="hljs-built_in">get</span>(); <span class="hljs-comment">// 抛出异常，导致 Flink 任务失败</span>
    }
}
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>数据准确性要求高。</li>
<li>需要保证所有数据写入成功。</li>
<li>异常时希望 Flink 任务失败并重启。</li>
</ul>
<p><strong>语义保证：At-Least-Once（至少一次）</strong></p>
<h3 data-id="heading-49">Future 清理策略与并发控制</h3>
<h4 data-id="heading-50">定时检查器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHouseSinkScheduledCheckerAndCleaner</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ScheduledExecutorService scheduledExecutorService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;CompletableFuture&lt;Boolean&gt;&gt; futures;
    <span class="hljs-comment">// ⚠️ volatile 保证多线程可见性（关键并发控制点）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isFlushing</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClickHouseSinkScheduledCheckerAndCleaner</span><span class="hljs-params">(...)</span> {
        <span class="hljs-comment">// 单线程定时执行器</span>
        scheduledExecutorService = Executors.newSingleThreadScheduledExecutor(factory);
        <span class="hljs-comment">// 定时执行清理任务（每隔 checkTimeout 秒，默认 30 秒）</span>
        scheduledExecutorService.scheduleWithFixedDelay(getTask(), ...);
    }
    <span class="hljs-keyword">private</span> Runnable <span class="hljs-title function_">getTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> () -&gt; {
            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
                <span class="hljs-comment">//  关键：检查是否正在 flush，避免并发冲突</span>
                <span class="hljs-keyword">if</span> (isFlushing) {
                    <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Checkpoint 期间暂停清理</span>
                }
                <span class="hljs-comment">// 1️⃣ 清理已完成的 Future</span>
                futures.removeIf(filter);
                <span class="hljs-comment">// 2️⃣ 触发所有 Buffer 的 flush（检查是否需要写入）</span>
                clickHouseSinkBuffers.forEach(IClickHouseSinkBuffer::tryAddToQueue);
            }
        };
    }
    <span class="hljs-comment">// Checkpoint flush 前调用（暂停 cleaner）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeFlush</span><span class="hljs-params">()</span> {
        isFlushing = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// Checkpoint flush 后调用（恢复 cleaner）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterFlush</span><span class="hljs-params">()</span> {
        isFlushing = <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p><strong>核心设计：</strong></p>
<ul>
<li><strong>volatile boolean isFlushing：</strong> 标志位，协调 cleaner 与 checkpoint 线程。</li>
<li><strong>synchronized (this)：</strong> 保证原子性，避免并发冲突。</li>
<li><strong>单线程执行器：</strong> 避免 cleaner 内部并发问题。</li>
</ul>
<h4 data-id="heading-51">并发控制机制</h4>
<p><strong>问题场景：</strong></p>
<pre><code class="hljs language-css" lang="css">时间轴冲突：
T1: Cleaner 线程正在执行 <span class="hljs-built_in">tryAddToQueue</span>()
T2: Checkpoint 触发，调用 sink.<span class="hljs-built_in">flush</span>()
T3: Cleaner 同时也在执行 <span class="hljs-built_in">tryAddToQueue</span>()
    ├─ 可能导致：数据重复写入
    ├─ 可能导致：Buffer 清空顺序混乱
    └─ 可能导致：Future 状态不一致
</code></pre>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ClickHouseSinkManager.flush()</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flush</span>()</span> {
    <span class="hljs-comment">// 1️⃣ 暂停定时清理任务（设置标志）</span>
    clickHouseSinkScheduledCheckerAndCleaner.beforeFlush(); <span class="hljs-comment">// isFlushing = true</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 2️⃣ 执行 flush（此时 cleaner 线程会跳过执行）</span>
        clickHouseWriter.waitUntilAllFuturesDone(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 3️⃣ 恢复定时清理任务</span>
        clickHouseSinkScheduledCheckerAndCleaner.afterFlush(); <span class="hljs-comment">// isFlushing = false</span>
    }
}
</code></pre>
<p>并发控制流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10f55374e4ee49abb914d3c9137c91f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=rWjqaPoBWG7mDze7UwWj9ENsauA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>关键设计点：</strong></p>
<ol>
<li><strong>volatile 保证可见性：</strong> isFlushing 使用 volatile，确保多线程间的可见性。</li>
<li><strong>synchronized 保证原子性：</strong> getTask() 整个方法体使用 synchronized (this)。</li>
<li><strong>标志位协调：</strong> 通过 isFlushing 标志实现两个线程间的协调。</li>
<li><strong>finally 确保恢复：</strong> 即使 waitUntilAllFuturesDone() 异常，也会在 finally 中恢复 cleaner。</li>
</ol>
<p><strong>避免的并发问题：</strong></p>
<ul>
<li><strong>数据重复写入：</strong> Cleaner 和 Checkpoint 同时 flush。</li>
<li><strong>Buffer 状态不一致：</strong> 一边清空一边写入。</li>
<li><strong>Future 清理冲突：</strong> 正在使用的 Future 被清理。</li>
</ul>
<p><strong>性能影响：</strong></p>
<ul>
<li>Checkpoint flush 期间，cleaner 暂停执行（通常 1-3 秒）。</li>
<li>Cleaner 跳过的周期会在下次正常执行时补偿。</li>
<li>对整体吞吐影响极小（cleaner 间隔通常 30 秒）。</li>
</ul>
<h2 data-id="heading-52">九、Checkpoint 语义保证</h2>
<h3 data-id="heading-53">为什么 Checkpoint 时必须 Flush？</h3>
<h4 data-id="heading-54">不 Flush 的后果</h4>
<p><strong>不Flush导致数据永久丢失</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ef7013722b5400084a22dd0754d2a47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=MhVyQZQj1FGYwBPV%2Fud2blWmEn8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h4 data-id="heading-55">正确做法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">snapshotState</span><span class="hljs-params">(FunctionSnapshotContext context)</span> <span class="hljs-keyword">throws</span> Exception {
    logger.info(<span class="hljs-string">"start doing snapshot. flush sink to ck"</span>);
    <span class="hljs-comment">// 1. 先 flush buffer（将内存数据写入 ClickHouse）</span>
    <span class="hljs-keyword">if</span> (sink != <span class="hljs-literal">null</span>) {
        sink.flush();
    }
    <span class="hljs-comment">// 2. 等待所有写入完成</span>
    <span class="hljs-keyword">if</span> (sinkManager != <span class="hljs-literal">null</span> &amp;&amp; !sinkManager.isClosed()) {
        sinkManager.flush();
    }
    <span class="hljs-comment">// 此时 Checkpoint 才能标记为成功</span>
    logger.info(<span class="hljs-string">"doing snapshot. flush sink to ck"</span>);
}
</code></pre>
<h3 data-id="heading-56">Flush 实现与并发协调</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClickHouseSinkManager</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flush</span>()</span> {
        <span class="hljs-comment">//  步骤1：暂停定时清理任务</span>
        clickHouseSinkScheduledCheckerAndCleaner.beforeFlush(); <span class="hljs-comment">// isFlushing = true</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//  步骤2：执行 buffer flush + 等待所有写入完成</span>
            clickHouseWriter.waitUntilAllFuturesDone(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">//  步骤3：恢复定时清理任务（finally 确保执行）</span>
            clickHouseSinkScheduledCheckerAndCleaner.afterFlush(); <span class="hljs-comment">// isFlushing = false</span>
        }
    }
}
</code></pre>
<p><strong>并发协调详解：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// cleaner 线程执行流程</span>
synchronized (<span class="hljs-keyword">this</span>) {
    <span class="hljs-keyword">if</span> (isFlushing) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Checkpoint 期间跳过本次执行</span>
    }
    <span class="hljs-comment">// 正常执行：清理已完成的 Future + 触发 Buffer flush</span>
    futures.removeIf(filter);
    buffers.forEach(Buffer::tryAddToQueue);
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>volatile 可见性：</strong> isFlushing 使用 volatile 确保 cleaner 线程立即看到状态变化。</li>
<li><strong>synchronized互斥：</strong> getTask()方法体使用 synchronized (this) 确保原子性。</li>
<li><strong>标志位协调：</strong> 通过 beforeFlush() / afterFlush() 管理标志位。</li>
<li><strong>finally 保证恢复：</strong> 即使 flush 异常，也会在 finally 中恢复 cleaner。</li>
</ul>
<h3 data-id="heading-57">等待所有 Future 完成</h3>
<pre><code class="hljs language-scss" lang="scss">public synchronized void <span class="hljs-built_in">waitUntilAllFuturesDone</span>(boolean stopWriters, boolean clearFutures) {
    try {
        <span class="hljs-comment">// 循环等待：直到所有 Future 完成 + 队列清空</span>
        while (!futures.isEmpty() || unProcessedCounter<span class="hljs-selector-class">.get</span>() &gt; <span class="hljs-number">0</span>) {
            CompletableFuture&lt;Void&gt; <span class="hljs-attribute">all</span> = FutureUtil<span class="hljs-selector-class">.allOf</span>(futures);
            <span class="hljs-comment">// 最多等待 3 分钟（与 Future 超时一致）</span>
            <span class="hljs-attribute">all</span><span class="hljs-selector-class">.get</span>(<span class="hljs-number">3</span>, TimeUnit.MINUTES);
            <span class="hljs-comment">// 移除已完成的 Future（非异常）</span>
            futures<span class="hljs-selector-class">.removeIf</span>(f -&gt; f.isDone() &amp;&amp; !f<span class="hljs-selector-class">.isCompletedExceptionally</span>());
            <span class="hljs-comment">// 检查是否有异常 Future</span>
            if (anyFutureFailed()) {
                break; <span class="hljs-comment">// 有异常则退出</span>
            }
        }
    } finally {
        if (stopWriters) <span class="hljs-built_in">stopWriters</span>();
        if (clearFutures) futures<span class="hljs-selector-class">.clear</span>();
    }
}
</code></pre>
<p><strong>关键逻辑：</strong></p>
<ul>
<li>循环等待直到所有 Future 完成 + 队列清空。</li>
<li>超时 3 分钟（与 Future 超时一致）。</li>
<li>移除已完成的非异常 Future。</li>
<li>有异常时退出循环。</li>
</ul>
<h3 data-id="heading-58">三种 Flush 触发方式对比</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ba3862ba4e84285b1be07308345fdb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=skgFor1D%2FYZHiYwHiGTxrQDZrKI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-59">Checkpoint 参数配置</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Checkpoint 配置建议</span>
StreamExecutionEnvironment env = StreamExecutionEnvironment<span class="hljs-selector-class">.getExecutionEnvironment</span>();
<span class="hljs-comment">// 启用 Checkpoint（间隔 1 分钟）</span>
env<span class="hljs-selector-class">.enableCheckpointing</span>(<span class="hljs-number">60000</span>);
<span class="hljs-comment">// Checkpoint 超时（必须大于 Future 超时 + 重试时间）</span>
<span class="hljs-comment">// 建议：CheckpointTimeout &gt; FutureTimeout * MaxRetries</span>
env<span class="hljs-selector-class">.getCheckpointConfig</span>()<span class="hljs-selector-class">.setCheckpointTimeout</span>(<span class="hljs-number">600000</span>); <span class="hljs-comment">// 10 分钟</span>
<span class="hljs-comment">// 一致性模式</span>
env<span class="hljs-selector-class">.getCheckpointConfig</span>()<span class="hljs-selector-class">.setCheckpointingMode</span>(CheckpointingMode.EXACTLY_ONCE);
<span class="hljs-comment">// 最小间隔（避免过于频繁）</span>
env<span class="hljs-selector-class">.getCheckpointConfig</span>()<span class="hljs-selector-class">.setMinPauseBetweenCheckpoints</span>(<span class="hljs-number">30000</span>); <span class="hljs-comment">// 30 秒</span>
<span class="hljs-comment">// 最大并发 Checkpoint 数</span>
env<span class="hljs-selector-class">.getCheckpointConfig</span>()<span class="hljs-selector-class">.setMaxConcurrentCheckpoints</span>(<span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-60">语义保证</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c965ba43df64f469d2a77c7eccae8ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=9o0Je3HH%2BS7502YiMr%2BRlt5wq%2Bc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>推荐配置：</strong></p>
<p><strong>生产环境：</strong> 使用 ExceptionsThrowableSink + Checkpoint。</p>
<p><strong>允许部分丢失：</strong> 使用 UnexceptionableSink。</p>
<h2 data-id="heading-61">十、最佳实践与调优</h2>
<h3 data-id="heading-62">生产配置</h3>
<pre><code class="hljs language-ini" lang="ini">// ========== ClickHouse 连接参数 ==========
<span class="hljs-attr">clickhouse.sink.target-table</span> = tb_logs_local
<span class="hljs-attr">clickhouse.sink.max-buffer-size</span> = <span class="hljs-number">104857600</span>        // 批次大小
<span class="hljs-attr">clickhouse.sink.table-count</span> = <span class="hljs-number">0</span>                // <span class="hljs-number">0</span> 表示不分表
// ========== 写入性能参数 ==========
<span class="hljs-attr">clickhouse.sink.num-writers</span> = <span class="hljs-number">10</span>               // 写入线程数
<span class="hljs-attr">clickhouse.sink.queue-max-capacity</span> = <span class="hljs-number">10</span>        // 队列容量
<span class="hljs-attr">clickhouse.sink.timeout-sec</span> = <span class="hljs-number">30</span>               // flush 超时
<span class="hljs-attr">clickhouse.sink.retries</span> = <span class="hljs-number">10</span>                   // 最大重试次数
<span class="hljs-attr">clickhouse.sink.check.timeout-sec</span> = <span class="hljs-number">30</span>         // 定时检查间隔
// ========== 异常处理参数 ==========
<span class="hljs-attr">clickhouse.sink.ignoring-clickhouse-sending-exception-enabled</span> = <span class="hljs-literal">false</span>
<span class="hljs-attr">clickhouse.sink.local-address-enabled</span> = <span class="hljs-literal">true</span>   // 启用本地表写入
// ========== ClickHouse 集群配置 ==========
<span class="hljs-attr">clickhouse.access.hosts</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span>:<span class="hljs-number">8123</span>,<span class="hljs-number">192.168</span>.<span class="hljs-number">1.2</span>:<span class="hljs-number">8123</span>,<span class="hljs-number">192.168</span>.<span class="hljs-number">1.3</span>:<span class="hljs-number">8123</span>
<span class="hljs-attr">clickhouse.access.user</span> = default
<span class="hljs-attr">clickhouse.access.password</span> = ***
<span class="hljs-attr">clickhouse.access.database</span> = dw_xx_xx
<span class="hljs-attr">clickhouse.access.cluster</span> = default
// ========== HikariCP 连接池配置 ==========
<span class="hljs-attr">connectionTimeout</span> = <span class="hljs-number">30000</span>                      // 连接超时 <span class="hljs-number">30</span>s
<span class="hljs-attr">maximumPoolSize</span> = <span class="hljs-number">20</span>                           // 最大连接数 <span class="hljs-number">20</span>
<span class="hljs-attr">minimumIdle</span> = <span class="hljs-number">2</span>                                // 最小空闲 <span class="hljs-number">2</span>
<span class="hljs-attr">socket_timeout</span> = <span class="hljs-number">180000</span>                        // Socket 超时 <span class="hljs-number">3</span>mi
</code></pre>
<h2 data-id="heading-63">性能调优</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe85a601349453aa2541fe47b0e88e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=3XhrUD4mwBz1c%2FJeYb8fQ5x7Amg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-64">故障排查</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a917bed37a46ccb9f2a8a196762b93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297904&amp;x-signature=WlnooX42uWG5kXf4ycZTBXk4VTY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-65">十一、总结</h2>
<p>本文深入分析了 Flink ClickHouse Sink 的实现方案，核心亮点包括：</p>
<h3 data-id="heading-66">技术亮点</h3>
<ul>
<li><strong>连接池选型：</strong> 使用 HikariCP，性能优异，连接管理可靠。</li>
<li><strong>Future 超时控制：</strong> orTimeout(3min) 防止永久阻塞。</li>
<li><strong>显式资源管理：</strong> Connection 和 PreparedStatement 显式关闭，防止连接泄漏。</li>
<li><strong>负载均衡优化：</strong> Shuffle 初始化 + 轮询选择，避免热点。</li>
<li><strong>异常处理增强：</strong> future.isDone() 检查，避免重复完成。</li>
<li><strong>本地表写入：</strong> 动态节点发现 + 故障剔除，写入性能提升。</li>
<li><strong>分片策略：</strong> 按表（应用）维度路由，独立缓冲和隔离。</li>
<li><strong>攒批优化：</strong> 双触发机制（大小 + 超时）+ 随机抖动。</li>
<li><strong>流量控制：</strong> 有界队列 + 线程池，实现背压。</li>
<li><strong>健壮重试：</strong> 递归重试 + 异常节点剔除 + 最大重试限制。</li>
</ul>
<h3 data-id="heading-67">Checkpoint 语义</h3>
<ul>
<li><strong>At-Least-Once：</strong> ExceptionsThrowableSink + Checkpoint。</li>
<li><strong>At-Most-Once：</strong> UnexceptionableSink。</li>
<li><strong>Exactly-Once：</strong> 需要配合 ClickHouse 事务（未实现）。</li>
</ul>
<h3 data-id="heading-68">生产建议</h3>
<ol>
<li><strong>必须：</strong> Checkpoint 时 flush，否则会丢数据。</li>
<li><strong>推荐：</strong> 使用 HikariCP + 本地表写入。</li>
<li><strong>推荐：</strong> 配置合理的超时（Future &lt; Socket &lt; Checkpoint）。</li>
<li><strong>推荐：</strong> 监控队列大小、Future 失败率、重试次数。</li>
</ol>
<p>该方案已在生产环境大规模验证，能够稳定支撑<strong>百万级 TPS</strong> 的日志写入场景。</p>
<h2 data-id="heading-69">往期回顾</h2>
<p>1.服务拆分之旅：测试过程全揭秘｜得物技术</p>
<p>2.大模型网关：大模型时代的智能交通枢纽｜得物技术</p>
<p>3.从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践</p>
<p>4.AI编程实践：从Claude Code实践到团队协作的优化思考｜得物技术</p>
<p>5.入选AAAI-PerFM｜得物社区推荐之基于大语言模型的新颖性推荐算法</p>
<h2 data-id="heading-70">文 /虚白</h2>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨域全攻略：从 Vite 代理到 Nginx 生产环境配置实战]]></title>    <link>https://juejin.cn/post/7604761524976648201</link>    <guid>https://juejin.cn/post/7604761524976648201</guid>    <pubDate>2026-02-10T03:14:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604761524976648201" data-draft-id="7604665952321372211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨域全攻略：从 Vite 代理到 Nginx 生产环境配置实战"/> <meta itemprop="keywords" content="前端,Nginx,面试"/> <meta itemprop="datePublished" content="2026-02-10T03:14:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨域全攻略：从 Vite 代理到 Nginx 生产环境配置实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:14:52.000Z" title="Tue Feb 10 2026 03:14:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在前后端分离的架构中，跨域（CORS）是我们联调接口时遇到的第一个“拦路虎”。无论是本地开发还是线上部署，掌握跨域的解决手段是前端开发者的基本功。本文将结合 Vite 和 Nginx，深度解析跨域问题的终极解决方案。</p>
<h2 data-id="heading-1">一、 什么是跨域？</h2>
<p><strong>跨域</strong>是由浏览器的<strong>同源策略（Same-origin policy）引起的。当一个请求的协议、域名、端口</strong>三者中至少有一个不同时，浏览器就会拦截该请求的响应。</p>
<blockquote>
<p><strong>注意</strong>：跨域请求其实已经发到了服务器，服务器也正常返回了数据，只是浏览器在接收响应时，发现源不匹配，为了安全将其拦截了。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">二、 开发环境方案：Vite 反向代理</h2>
<p>在开发阶段，我们无法要求后端频繁改动 CORS 配置。此时，利用 Vite 自带的 <code>http-proxy</code> 模块进行转发是最优解。</p>
<h3 data-id="heading-3">1. Vite 配置实战</h3>
<p>在 <code>vite.config.js</code> 中配置 <code>server</code> 对象，通过代理服务器绕过浏览器同源策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
    <span class="hljs-attr">cors</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用并允许任何源（主要用于开发服务器的响应头）</span>
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启动时自动打开浏览器</span>
    
    <span class="hljs-comment">// 反向代理配置</span>
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-comment">// 场景 A：不移除路径前缀</span>
      <span class="hljs-comment">// 例如请求 /aPath/login 会转发到 http://33.133.190.116:8100/aPath/login</span>
      <span class="hljs-string">"/aPath"</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">"http://33.133.190.116:8100"</span>, 
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 必须设置为 true，否则后端无法获取正确的 Host</span>
      },
      
      <span class="hljs-comment">// 场景 B：重写路径（移除前缀）</span>
      <span class="hljs-comment">// 例如请求 /bPath/list 会转发到 http://172.16.7.160:9022/list</span>
      <span class="hljs-string">"/bPath"</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">"http://172.16.7.160:9022"</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>bPath/, <span class="hljs-string">""</span>),
      },
    },
  },
})
</code></pre>
<hr/>
<h2 data-id="heading-4">三、 生产环境方案：Nginx 部署配置</h2>
<p>项目上线后，Vite 的代理就不起作用了。此时我们需要在 Nginx 中配置反向代理，让所有的请求由 Nginx 统一分发。</p>
<h3 data-id="heading-5">1. Nginx 核心配置文件解析 (<code>nginx.conf</code>)</h3>
<pre><code class="hljs language-Nginx" lang="Nginx"># 基础全局配置
user nginx;
worker_processes auto; # 自动适配 CPU 核心数
error_log /var/log/nginx/error.log notice;
pid /run/nginx.pid;

events {
    worker_connections 1024;
    use epoll; # 使用高性能事件驱动模型
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    client_max_body_size 300m; # 支持大文件上传

    # 开启 Gzip 压缩，优化传输性能
    gzip on;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript;

    server {
        listen 80 default_server;
        server_name _; 

        # 静态资源处理
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html; # 适配单页面应用路由
        }

        # 代理方案 A：带前缀转发
        # 请求：/aPath/api -&gt; http://33.133.190.116:8100/aPath/api
        location ^~/aPath/ {
            proxy_pass http://33.133.190.116:8100/aPath/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_read_timeout 3600s;
            proxy_buffering off; # AI 对话场景需关闭缓冲
            chunked_transfer_encoding on;
        }

        # 代理方案 B：抹除前缀转发
        # 请求：/bPath/api -&gt; http://172.16.7.160:9022/api
        location ^~/bPath/ {
            proxy_pass http://172.16.7.160:9022/; 
            proxy_set_header X-Forwarded-For $remote_addr;
        }

        # 禁止访问 .ht 文件
        location ~ /.ht {
            deny all;
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-6">四、 补充</h2>
<h3 data-id="heading-7">1. 后端 CORS 配置（简单请求与预检请求）</h3>
<p>后端通过在响应头中添加特定字段，告诉浏览器允许该源的访问：</p>
<ul>
<li><code>Access-Control-Allow-Origin: *</code></li>
<li><code>Access-Control-Allow-Methods: GET, POST, PUT, DELETE</code></li>
</ul>
<h3 data-id="heading-8">2. 为什么 Nginx 代理能解决跨域？</h3>
<p>因为 <strong>“跨域”仅存在于浏览器端</strong>。 当你的前端代码请求 Nginx 时，它们同源；Nginx 作为中转站再去请求后端接口，这是 <strong>服务器对服务器的通信</strong>，不受同源策略限制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大道不该如此之小：从微内核的角度介绍前端监控]]></title>    <link>https://juejin.cn/post/7604775190212018186</link>    <guid>https://juejin.cn/post/7604775190212018186</guid>    <pubDate>2026-02-10T03:33:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604775190212018186" data-draft-id="7604786493639163931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大道不该如此之小：从微内核的角度介绍前端监控"/> <meta itemprop="keywords" content="前端,架构,NPM"/> <meta itemprop="datePublished" content="2026-02-10T03:33:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="敲代码的彭于晏"/> <meta itemprop="url" content="https://juejin.cn/user/553809592465277"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大道不该如此之小：从微内核的角度介绍前端监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/553809592465277/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    敲代码的彭于晏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:33:54.000Z" title="Tue Feb 10 2026 03:33:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前端监控一直是保障 Web 应用稳定性和用户体验的重要基础设施。随着应用复杂度的提升，监控系统的需求也在不断膨胀：我们要捕获 JavaScript 错误、监控 HTTP 请求、追踪用户行为、甚至记录性能指标。如果把所有的监控逻辑都写在一个庞大的 SDK 里，不仅代码难以维护，还会因为体积过大影响页面性能。</p>
<p>本文将结合我自己写的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcwjbjy%2Fcwj_monitoring" target="_blank" title="https://github.com/cwjbjy/cwj_monitoring" ref="nofollow noopener noreferrer">cwj_monitoring</a> 这个开源项目的源码，介绍如何利用 <strong>微内核架构（Micro-kernel Architecture）</strong> 来设计一个可扩展、轻量级的前端监控 SDK。前端监控包的使用方式，参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fcwj_monitoring" target="_blank" title="https://www.npmjs.com/package/cwj_monitoring" ref="nofollow noopener noreferrer">www.npmjs.com/package/cwj…</a></p>
<h3 data-id="heading-1">一、前置知识：微内核架构</h3>
<p>在深入代码之前，我们先来聊聊微内核架构（Microkernel Architecture），又称为“插件架构”。</p>
<h4 data-id="heading-2">1. 核心概念</h4>
<p>微内核架构主要由两部分组成：<strong>Core（内核）</strong> + <strong>Plugin（插件）</strong>。</p>
<ul>
<li><strong>Core (内核)</strong>：主要负责基础设施建设（如生命周期管理、基础配置）以及插件的调度。它应该保持最精简，只维持系统运行的最小功能集。</li>
<li><strong>Plugin (插件)</strong>：独立的功能模块，用来丰富和加强内核的能力。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee7636e1f7a4488aac69365e7b286873~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWy5Luj56CB55qE5b2t5LqO5pmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771300894&amp;x-signature=qqhYqT7cY66CeNDM2hcrocT4s6Q%3D" alt="1770696057167.png" loading="lazy"/></p>
<p>这种架构在前端领域非常常见，典型的例子如 Webpack、Babel、PostCSS 和 ESLint。它们都需要应对复杂的定制需求，只有微内核架构才能保证系统的灵活性和可扩展性。</p>
<h4 data-id="heading-3">2. 设计思想</h4>
<p>微内核架构背后蕴含着几个重要的软件设计原则：</p>
<ul>
<li><strong>单一职责原则 (Single Responsibility)</strong>：每个插件相互独立，只负责其对应的特定监控功能（如只负责捕获 Promise 错误），便于开发和测试。</li>
<li><strong>开放封闭原则 (Open/Closed)</strong>：扩展新功能（如新增 WebSocket 监控）时，不需要修改内核老代码，只需开发新插件即可。</li>
<li><strong>控制反转 (Inversion of Control)</strong>：内核通过依赖注入（Dependency Injection）的方式将上下文（Context）传递给插件，而不是让插件去实例化内核。</li>
<li><strong>策略模式 (Strategy Pattern)</strong>：不同的插件通过统一的接口接入系统，内核只需要像遍历列表一样去执行它们，而不需要关心具体实现。</li>
</ul>
<h3 data-id="heading-4">二、架构实现：Core 与 Plugin</h3>
<h4 data-id="heading-5">1. 核心系统 (The Core)</h4>
<p>Core 的两个主要用途是：实现基础功能和管理插件。</p>
<p>在 <code>src/core/index.ts</code> 中，<code>Core</code> 类扮演了内核的角色：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/core/index.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Core</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventTrack</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">pluginMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">IPlugin</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

  <span class="hljs-comment">// 1. 插件注册 (Registry)</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-attr">plugin</span>: <span class="hljs-title class_">IPlugin</span>): <span class="hljs-title class_">Core</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">pluginMap</span>.<span class="hljs-title function_">has</span>(plugin.<span class="hljs-property">name</span>)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pluginMap</span>.<span class="hljs-title function_">set</span>(plugin.<span class="hljs-property">name</span>, plugin);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 支持链式调用，如 core.use(plugin1).use(plugin2)</span>
  }

  <span class="hljs-comment">// 2. 插件调度 (Scheduling)</span>
  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建上下文，注入核心能力</span>
    <span class="hljs-keyword">const</span> context = {
      <span class="hljs-attr">emit</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),
      <span class="hljs-attr">url</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">url</span>,
    };

    <span class="hljs-comment">// 依次初始化插件 (顺序执行)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pluginMap</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">plugin</span>) =&gt;</span> {
      plugin.<span class="hljs-title function_">install</span>(context);
    });

    <span class="hljs-comment">// 挂载全局变量</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mount</span>();
  }

  <span class="hljs-comment">// 3. 停止系统</span>
  <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pluginMap</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">plugin</span>) =&gt;</span> {
      plugin.<span class="hljs-property">uninstall</span>?.();
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pluginMap</span>.<span class="hljs-title function_">clear</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unmount</span>();
  }
}
</code></pre>
<p>这里我们使用了 <code>Map</code> 来存储插件，方便去重（具名插件）。<code>run</code> 方法展示了简单的<strong>管道式</strong>调度：依次遍历并执行插件的 <code>install</code> 方法。</p>
<h4 data-id="heading-6">2. 通信机制：控制反转</h4>
<p>插件和内核如何通信？我们采用了<strong>依赖注入</strong>的方式。</p>
<p>在 <code>src/plugin/definePlugin.ts</code> 中定义了标准接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/plugin/definePlugin.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PluginContext</span> {
  <span class="hljs-comment">/** 发送事件的能力 */</span>
  <span class="hljs-attr">emit</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** 监控上报地址 */</span>
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IPlugin</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/**
   * 控制反转：Core 在调用 install 时，将 context (自身能力的投影) 传给插件
   */</span>
  <span class="hljs-title function_">install</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">PluginContext</span>): <span class="hljs-built_in">void</span>;
  uninstall?(): <span class="hljs-built_in">void</span>;
}
</code></pre>
<p>通过这种设计，插件不需要关心数据通过什么方式（XHR/Beacon）发送，也不需要关心 <code>Core</code> 的具体实现细节。它只需要拿到 <code>context.emit</code>，像调用 API 一样上报数据即可。</p>
<h4 data-id="heading-7">3. 实战案例：ErrorPlugin</h4>
<p>让我们看看 <code>ErrorPlugin</code> 如何利用这个架构工作。它的职责是捕获错误，并通过注入的上下文上报。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/plugin/error.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ErrorPlugin</span> = (<span class="hljs-attr">options</span>: <span class="hljs-title class_">ErrorOptions</span> = {}): <span class="hljs-function"><span class="hljs-params">IPlugin</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"error"</span>,
    <span class="hljs-attr">install</span>: <span class="hljs-function">(<span class="hljs-params">context: PluginContext</span>) =&gt;</span> {
      <span class="hljs-comment">// 1. 实现业务逻辑：监听全局 JS 错误</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">errorHandler</span> = (<span class="hljs-params">e: ErrorEvent</span>) =&gt; {
        <span class="hljs-comment">// 定义处理函数</span>
        <span class="hljs-keyword">const</span> errorData = {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"js"</span>,
          <span class="hljs-attr">message</span>: e.<span class="hljs-property">message</span>,
          <span class="hljs-comment">// ... 其他错误信息提取</span>
        };
        <span class="hljs-comment">// 2. 使用注入的能力：通过 emit 上报，不关心底层传输</span>
        context.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"error"</span>, errorData);
      };
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"error"</span>, errorHandler, <span class="hljs-literal">true</span>);

      <span class="hljs-comment">// 监听 Promise 未捕获异常</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">rejectionHandler</span> = (<span class="hljs-params">e: PromiseRejectionEvent</span>) =&gt; {
        <span class="hljs-comment">// 定义处理函数</span>
        <span class="hljs-comment">// ... 处理逻辑</span>
        context.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"error"</span>, { <span class="hljs-attr">type</span>: <span class="hljs-string">"promise"</span>, <span class="hljs-attr">reason</span>: e.<span class="hljs-property">reason</span> });
      };
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"unhandledrejection"</span>, rejectionHandler, <span class="hljs-literal">true</span>);
    },
    <span class="hljs-attr">uninstall</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 清理监听器，防止内存泄漏</span>
      <span class="hljs-comment">// ...</span>
    },
  };
};
</code></pre>
<h3 data-id="heading-8">三、重点设计考量</h3>
<p>在设计这样一个系统时，除了基本功能，还有几个关键点需要考虑：</p>
<ol>
<li>
<p><strong>安全性与隔离</strong>：
由于 JS 语言特性，很难做到完全的沙箱隔离。但在设计上，我们通过 <code>PluginContext</code> 限制了插件能访问的 API 范围（只暴露 <code>emit</code> 和 <code>url</code>），而不是把整个 <code>Core</code> 实例暴露给插件，这体现了最小权限原则。</p>
</li>
<li>
<p><strong>稳定性</strong>：
虽然示例代码中直接进行了 <code>forEach</code> 调用，但在生产环境的内核设计中，通常需要在执行插件代码时包裹 <code>try-catch</code>。这样一旦某个插件内部报错（比如 <code>addEventListener</code> 失败），不会导致整个监控 SDK 崩溃，影响到业务主流程。</p>
</li>
<li>
<p><strong>插件管理策略</strong>：
<code>cwj_monitoring</code> 使用 <code>Map</code> 来管理插件，这意味着同一个名称的插件只会被安装一次，防止重复注册。这是一种简单的冲突解决策略。</p>
</li>
</ol>
<h3 data-id="heading-9">组装与使用</h3>
<p>最终，用户在使用 SDK 时，就像搭积木一样简单：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createMonitor, <span class="hljs-title class_">ErrorPlugin</span>, <span class="hljs-title class_">PerformancePlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"cwj_monitoring"</span>;

<span class="hljs-keyword">const</span> monitor = <span class="hljs-title function_">createMonitor</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">"https://monitor.example.com/report"</span>,
})
  .<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ErrorPlugin</span>()) <span class="hljs-comment">// 插上错误监控模块</span>
  .<span class="hljs-title function_">use</span>(<span class="hljs-title class_">PerformancePlugin</span>()) <span class="hljs-comment">// 插上性能监控模块</span>
  .<span class="hljs-title function_">run</span>(); <span class="hljs-comment">// 启动！</span>
</code></pre>
<p>这种使用方式非常符合现代前端开发的直觉，同时也给予了开发者极大的灵活性。</p>
<h3 data-id="heading-10">四、总结</h3>
<p>通过 <code>cwj_monitoring</code>，我们实践了一个标准的前端微内核架构：</p>
<ul>
<li><strong>Core</strong>：精简的调度器，负责生命周期和基础设施。</li>
<li><strong>Plugin</strong>：独立的业务单元，通过 <code>install(context)</code> 接入系统。</li>
</ul>
<p>这种架构让前端监控 SDK 具备了极强的生命力。针对不同业务场景（如不需要录屏时就不引入录屏插件），我们可以灵活组合不同的 Plugin，实现按需构建和加载。</p>
<p>最后：如果文章有不对或者有补充的地方，欢迎在评论区留言。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别单调配音！VibeVoice+cpolar：多角色语音生成随时随地搞创作]]></title>    <link>https://juejin.cn/post/7604761524976762889</link>    <guid>https://juejin.cn/post/7604761524976762889</guid>    <pubDate>2026-02-10T03:35:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604761524976762889" data-draft-id="7604784281956646950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别单调配音！VibeVoice+cpolar：多角色语音生成随时随地搞创作"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-10T03:35:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别单调配音！VibeVoice+cpolar：多角色语音生成随时随地搞创作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:35:04.000Z" title="Tue Feb 10 2026 03:35:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d71a2470f40040c4a40424c13bd099eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=i4UOg7x47ESSoooNRHsMno7dj9E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>VibeVoice 作为微软开发的文本转语音工具，核心优势在于支持 4 个不同角色的语音生成，每个角色有专属声线，还能根据文本内容匹配喜怒哀乐的情绪，1.5B 模型可生成 90 分钟连续语音，适配剧本杀配音、自媒体音频创作、企业培训课件制作等场景，尤其适合剧本杀工作室、自媒体创作者、企业培训人员这类需要多角色、长时长语音的人群，搭配 ComfyUI 可视化操作后，无需编程基础也能调整参数，降低了专业配音的门槛。</p>
<p>使用 VibeVoice 时发现，想要生成贴合角色的语音，参考音频的选择很关键，30 秒的清晰参考音频能让克隆的声音更贴近原型，另外硬件方面建议搭配 8G 以上显存的 NVIDIA 显卡，否则 7B 模型容易出现显存不足的情况，日常使用中先测试短文本生成效果，再扩展到长篇内容会更稳妥。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e55cbe6b9aff4581bc73bbff4e23d8f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=HjVxfi4ovQQJVsN2FPWwWPvW5rI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>不过 VibeVoice+ComfyUI 的组合默认只能在局域网内使用，比如剧本杀工作室的创作者在家调好的配音参数，出门后想在手机上修改台词就做不到；团队协作时，编剧改了剧本，配音师只能等文件传输完成才能试听效果，跨设备操作也受限于局域网，比如电脑上生成一半的音频，平板无法接续编辑，大大影响了创作效率。</p>
<p>而将 VibeVoice+ComfyUI 与 cpolar 内网穿透结合后，这些问题都能解决：通过 cpolar 生成的公网地址，无论在家、地铁还是外出办公，都能随时访问语音生成项目；团队成员无需来回传文件，共享链接就能实时试听、调整配音效果；跨设备切换也毫无阻碍，电脑、平板、手机都能操作，还能给链接设置密码，保障配音方案的安全性，让创作不受空间和设备的限制。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c001fc8321d44be19cfb96338c04f523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=xTDSbb8%2BcGm8tVLOhNZgUFiMLfI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-0">自己就是一个团队，无论是自己做账号还是接单子赚钱。这个工具组合可是妥妥的生产力！教程在下面，快去安装挣钱吧！</h4>
<p>本文将详细介绍如何借助 cpolar 内网穿透，结合 VibeVoice 搭建可随时随地访问的多角色音频生成平台，并以 4 角色对话实战演示，突破传统 TTS 在多说话人场景下的限制。</p>
<h2 data-id="heading-1">1 项目概述</h2>
<h3 data-id="heading-2">1.1 什么是VibeVoice</h3>
<p>VibeVoice 是微软开发的一款先进文本转语音（TTS）模型，专注于长对话场景的高质量语音生成。它的核心特点包括：支持多达 4 个不同角色，每个角色拥有独特声音；能够生成长时间连续对话（1.5B 模型可生成约 90 分钟，Large 模型约 45 分钟）；具备丰富的情感表达能力，可根据文本自动调整语调与情感色彩；支持中英文语音生成，并具备跨语言迁移能力；同时支持实时流式音频输出，提升互动体验。VibeVoice 适用于多角色剧本、长篇故事朗读以及虚拟助手等场景。</p>
<hr/>
<h3 data-id="heading-3">1.2 什么是ComfyUI</h3>
<p>ComfyUI 是一个基于节点的可视化界面工具，主要用于构建和管理深度学习模型的推理流程。它通过拖拽式节点连接，将模型加载、数据处理、图像生成等环节直观地呈现出来，使用户无需编写大量代码即可搭建复杂的 AI 流程。ComfyUI 支持多种扩展节点和自定义功能，可以灵活集成第三方模型和插件，同时提供实时预览和调试功能，极大降低了深度学习模型操作的门槛，适合研究者、创作者以及开发者进行快速原型设计和实验。</p>
<h2 data-id="heading-4">2 环境安装</h2>
<blockquote>
<p><strong>重要提示</strong>：确保您的系统满足以下要求，否则可能导致安装失败或运行异常。</p>
</blockquote>













































<table><thead><tr><th>环境项</th><th>要求说明</th></tr></thead><tbody><tr><td>操作系统</td><td>Windows 10/11（推荐）</td></tr><tr><td>Python版本</td><td>3.11</td></tr><tr><td>内存</td><td>至少 8GB RAM，推荐 16GB 以上</td></tr><tr><td>存储空间</td><td>至少 20GB 可用空间（模型文件较大）</td></tr><tr><td>网络环境</td><td>稳定的网络连接，用于下载模型和依赖</td></tr><tr><td>显卡要求</td><td>NVIDIA GPU，建议 8GB 显存及以上（<strong>RTX 20 系列及以上</strong>）</td></tr><tr><td>显卡驱动</td><td>NVIDIA 驱动 531 及以上（<strong>示例环境</strong>：580.97）</td></tr><tr><td>CUDA版本</td><td>CUDA 12（需与 PyTorch/FlashAttention 版本对应）</td></tr><tr><td>PyTorch版本</td><td>2.8.0（已编译支持 cu128，即 CUDA 12.8，对应 wheel 包：torch2.8+cu128）</td></tr></tbody></table>
<blockquote>
<p>资料打包下载（含 FlashAttention 2.7.4、VibeVoice 模型（1.5B）、参考音频）</p>
<p>百度网盘：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.baidu.com%2Fs%2F1IxFfB0SKPiQuIIbiZfKwBQ%3Fpwd%3D7au3%25EF%25BC%2588%25E6%258F%2590%25E5%258F%2596%25E7%25A0%2581%25EF%25BC%259A**7au3**%25EF%25BC%2589" target="_blank" title="https://pan.baidu.com/s/1IxFfB0SKPiQuIIbiZfKwBQ?pwd=7au3%EF%BC%88%E6%8F%90%E5%8F%96%E7%A0%81%EF%BC%9A**7au3**%EF%BC%89" ref="nofollow noopener noreferrer">pan.baidu.com/s/1IxFfB0SK…</a></p>
</blockquote>
<h3 data-id="heading-5">2.1 安装FlashAttention2</h3>
<p><strong>FlashAttention（flash_attn）</strong> 是一种针对 <strong>Transformer 模型中注意力机制 (Attention)</strong> 的高效实现，它的主要作用是 <strong>让大模型推理和训练更快、更省显存</strong>。</p>
<blockquote>
<p>官方GitHub发布页地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmjun0812%2Fflash-attention-prebuild-wheels%2Freleases" target="_blank" title="https://github.com/mjun0812/flash-attention-prebuild-wheels/releases" ref="nofollow noopener noreferrer">github.com/mjun0812/fl…</a></p>
<p>本教程演示安装的FlashAttention版本为2.7.4</p>
</blockquote>
<p>在选择<code>Flash-Attention</code>时，需要查看您的显卡驱动支持的CUDA版本信息，在CMD中输入：</p>
<pre><code class="hljs language-shell" lang="shell">nvidia-smi
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edaef1ca172944e998ea36c3eeaa8831~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=1q5mtPHyLmk2OGdXS67zweRqQcM%3D" alt="image-20250905150304683" loading="lazy"/></p>
<p>可以看到，当前<code>CUDA</code>版本显示13.0（支持向下兼容一些的）</p>
<p>在发布页下，下载对应你系统环境的whl包：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d85347f354f43de8f97232bbe3c9716~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=6zVEW6IF37t4JU6q%2FBK1ZbvlE%2F8%3D" alt="image-20250905145650427" loading="lazy"/></p>
<p>将文件下载至本地：</p>
<pre><code class="hljs language-text" lang="text">flash_attn-2.7.4+cu128torch2.8-cp311-cp311-win_amd64.whl
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be910439fb84da2be03d1a973162ed5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=KNWyLZzxGglMZQ%2F4HRSuCoiEpqI%3D" alt="image-20250905145715450" loading="lazy"/></p>
<p><strong>环境要求解析：</strong></p>
<ul>
<li><strong><code>cp311-cp311</code></strong> → 说明需要 <strong>Python 3.11</strong></li>
<li><strong><code>torch2.8</code></strong> → 说明需要 <strong>PyTorch 2.8.0</strong></li>
<li><strong><code>cu128</code></strong> → 说明需要 <strong>CUDA 12.8</strong>（PyTorch 要用对应的 CUDA 编译版本）</li>
<li><strong><code>win_amd64</code></strong> → 说明需要 <strong>Windows 64 位系统</strong></li>
</ul>
<p>首先，需要检查当前电脑的python环境，在cmd中输入如下命令检查：</p>
<pre><code class="hljs language-shell" lang="shell">python --version
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c69f4982cd6c47a38902c8d07a4ab566~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=mc5RbeF0BHmBpyYLxHKNcjo%2BVJA%3D" alt="image-20250905145843345" loading="lazy"/></p>
<p>可以看到已经是<code>python 3.11.4</code>的版本。</p>
<blockquote>
<p>如果没有安装python,可前往官网进行安装：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2Fdownloads%2F" target="_blank" title="https://www.python.org/downloads/" ref="nofollow noopener noreferrer">www.python.org/downloads/</a></p>
</blockquote>
<p>接下来需要检查 PyTorch 版本，同样打开cmd执行:</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">1.输入python回车</span>
python
<span class="hljs-meta prompt_">
#</span><span class="bash">2.然后输入如下命令</span>
import torch
print(torch.__version__)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ee71508d2940ba83d2b8932dc68b7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=4X56w17URWRYNVnmIS6sFrBk4D0%3D" alt="image-20250905151112814" loading="lazy"/></p>
<p>如果没有安装 PyTorch ，显示应如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b223d7c74ab4a23b492e5d51c61fcee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=WDaq4soJntnuZa6I4CGrOMDS6FA%3D" alt="image-20250905151323803" loading="lazy"/></p>
<p>需要执行如下命令进行安装即可：</p>
<pre><code class="hljs language-shell" lang="shell">pip install torch==2.8.0+cu128 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128
</code></pre>
<p>接下来需要安装FlashAttention2.7.4，在前面已经下载的适配环境的 wheel 文件目录下打开CMD：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b31a58c5c5264983aca12d492e45831c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=4k0UjCfrp19OQ3kjnu0ajEt5zWU%3D" alt="image-20250905151800906" loading="lazy"/></p>
<p>然后输入如下命令进行安装：</p>
<pre><code class="hljs language-shell" lang="shell">pip install flash_attn-2.7.4+cu128torch2.8-cp311-cp311-win_amd64.whl
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32928a8ede5b4737a312a0c55092564c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=pV59ESKMt1OM4BK1w9qFRQ0ybFU%3D" alt="image-20250905152033680" loading="lazy"/></p>
<p>检查版本信息确认安装：</p>
<pre><code class="hljs language-shell" lang="shell">python

import flash_attn
print(flash_attn.__version__)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f6b0c59396a42d6b951a589aeba2104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=X%2FGuOhDyzuce0RYO2lVzzWIBnJs%3D" alt="image-20250905152122033" loading="lazy"/></p>
<p>成功安装！</p>
<h2 data-id="heading-6">3 ComfyUI工作流项目安装部署</h2>
<blockquote>
<p>官方GitHub仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcomfyanonymous%2FComfyUI" target="_blank" title="https://github.com/comfyanonymous/ComfyUI" ref="nofollow noopener noreferrer">github.com/comfyanonym…</a></p>
</blockquote>
<p>以windows为例，首先使用git命令将项目克隆至本地，cmd执行命令：</p>
<blockquote>
<p>git官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fdownloads" target="_blank" title="https://git-scm.com/downloads" ref="nofollow noopener noreferrer">git-scm.com/downloads</a></p>
</blockquote>
<pre><code class="hljs language-shell" lang="shell">git clone https://github.com/comfyanonymous/ComfyUI.git
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43738156e9e04cb6a30f7a90c781fe52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=EQJ%2BWT44zkpKA2Emcwn0e3cOsU4%3D" alt="image-20250905154423769" loading="lazy"/></p>
<p>接着继续在该窗口，依次执行如下命令，安装所需依赖：</p>
<pre><code class="hljs language-shell" lang="shell">cd ComfyUI

pip install -r requirements.txt
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5014c2fd11d47db86bc502205057daf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=UfFRFpsx0KnlmXx%2FM9WPJnXYnCA%3D" alt="image-20250905154544713" loading="lazy"/></p>
<p>安装完成依赖后，执行如下命令进行启动测试：</p>
<pre><code class="hljs language-shell" lang="shell">python main.py --listen 0.0.0.0 --port 18188
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1565314acc94307858ce10a83e596af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=pFKqztlIRnF%2FTO8cF4Mk1kNcegg%3D" alt="image-20250905154857906" loading="lazy"/>可以看到，成功启动了，端口为 18188，为了后续方便启动，可以写一个bat脚本，将命令放入其中：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31fe5ce28baa4bdeab9138c13fcb4ffa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=9%2BYM7ldF31N%2Bqa8Xkm%2F8rxuxIcQ%3D" alt="image-20250905155057220" loading="lazy"/></p>
<p>后续双击脚本，就可以直接启动：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/737ac359e12d4c469d612990ed2e4162~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=44Mn3Vpqvy62RVMB%2B0zM7aoT%2B4U%3D" alt="image-20250905155134482" loading="lazy"/></p>
<p>可以看到输出了如下信息：</p>
<pre><code class="hljs language-text" lang="text">To see the GUI go to: http://0.0.0.0:18188
</code></pre>
<p>让我们访问浏览器进行测试：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">上面显示的0.0.0.0 通常表示绑定到本机的所有网络接口，因此它可以通过本机的任何有效IP地址（包括localhost或127.0.0.1）来访问。</span>
http://localhost:18188
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec1ed0da83e49a2a98b06e24e2ab240~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=pMaBVJgYw50SpX05Y%2FpjLEFJaLc%3D" alt="image-20250905155443397" loading="lazy"/></p>
<p>可以看到，成功访问啦！</p>
<h2 data-id="heading-7">4 ComfyUI-VibeVoice项目部署</h2>
<p>ComfyUI-VibeVoice 是一个为 <strong>ComfyUI</strong> 开发的自定义插件，它集成了微软的 <strong>VibeVoice</strong> 文本转语音（TTS）模型，能够实现高质量、多说话人的语音合成与零样本语音克隆。用户只需输入文本并提供参考音频，就可以快速生成风格一致、自然流畅的语音；同时支持多角色对话、长篇内容生成，并提供多种注意力机制和 4-bit 量化以优化性能，适合在播客制作、对话配音、AI 语音实验等场景中使用。</p>
<h3 data-id="heading-8">4.1 克隆项目代码</h3>
<p>在前面的步骤，已经部署好了ComfyUI工作流项目。接下来需要打开如下目录：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">前面项目<span class="hljs-built_in">clone</span>下来的位置</span>
D:\AI\ComfyUI\custom_nodes
</code></pre>
<p>在该目录下打开命令终端，使用git命令将项目克隆下来：</p>
<pre><code class="hljs language-shell" lang="shell">git clone https://github.com/wildminder/ComfyUI-VibeVoice.git
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbb3b9ae4d5f4f6b8a7594d25b27780d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=lkUjPU1gohdmnu8sH1jg1Eq8zCE%3D" alt="image-20250905160411584" loading="lazy"/></p>
<p>然后接着执行如下命令，下载该项目相关依赖：</p>
<pre><code class="hljs language-shell" lang="shell">cd ComfyUI-VibeVoice

pip install -r requirements.txt
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1864d6808dda492ea03a6420e993b07e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=O1NPIOeDReIVAehr1tfRBGxp0gQ%3D" alt="image-20250905160551797" loading="lazy"/></p>
<h2 data-id="heading-9">5 ComfyUI 中配置和使用 VibeVoice（实战）</h2>
<p>双击启动前面在ComfyUI目录中创建的<code>StartComfyUI-WEB.bat</code>脚本（如果前面启动了，没有停止窗口需要先停止启动的窗口）：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2f19694edca4ca3a612276bf8cd65b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=ooriI8k%2FW3%2FIjFt5SUkPDlFn4Iw%3D" alt="image-20250905161339378" loading="lazy"/></p>
<p>启动后在浏览器中访问ComfyUI项目，然后依次如下图选择（或直接按快捷键 Ctrl + O）：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11519e9f5e79404692389786747a2162~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=5%2F2hpRUuUmDRItIp971LkA%2BwL80%3D" alt="image-20250905161515561" loading="lazy"/></p>
<p>接着，进入到如下目录选择VibeVoice_example.json文件，然后点击打开：</p>
<pre><code class="hljs language-shell" lang="shell">D:\AI\ComfyUI\custom_nodes\ComfyUI-VibeVoice\example_workflows
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9d4d8055dd64a37a5884cf0a46d01b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=mroQeHxvPaz9iB2%2FqhaeAI0vKjI%3D" alt="image-20250905161627411" loading="lazy"/></p>
<p>打开后，可以看到如下图显示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6d6335f1a0d4fbf9d91c7474e9a6eba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=17jGTMaiYW9z4cWeNtdEQGTnnco%3D" alt="image-20250905161951873" loading="lazy"/></p>
<p>接着，随意上传两个<code>参考音频</code>，然后给定一段对话（这里使用的是AI生成的杨幂和海绵宝宝的对话）：</p>
<pre><code class="hljs language-shell" lang="shell">Speaker 1: 哈哈，海绵宝宝，听说你在水下的生活非常有趣，能和我们分享一下吗？
Speaker 2: 哇哦，杨幂！当然可以！我每天都在比奇堡和我的朋友们一起玩，最喜欢的就是和派大星一起做冒险了！
Speaker 1: 这听起来真的很有趣！那你觉得派大星最搞笑的地方是什么？
Speaker 2: 哇，派大星真的很搞笑！他总是那么天真无邪，做事常常没有任何计划，总是带给我们惊喜和笑声！
Speaker 1: 哈哈，感觉你们的冒险一定很欢乐。我想知道，海绵宝宝，你有做过什么特别的事情吗？
Speaker 2: 当然！我曾经当过餐厅经理，在蟹堡王工作，每天都忙得不亦乐乎。不过最特别的还是我做的蟹堡，大家都说我做的最美味！
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a624394e0e994afdbbeade0ea3117865~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=k0ROFQpbxX2m0FY1kZmmf0SjnOs%3D" alt="image-20250905163933933" loading="lazy"/></p>
<blockquote>
<p>模型选择，首次如果没有该模型会自动进行下载，也可以直接手动下载模型</p>
<p>放入如下文件夹：D:\AI\ComfyUI\models\tts\VibeVoice</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ce02bab5c4f4f8789180b395bc652e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=%2B5XO4jcK2b5cgZxAsDFlj%2B8q9ic%3D" alt="image-20250905164034943" loading="lazy"/></p>
<p>完成本地流程配置后，我们将通过 cpolar 将该工作流对外发布，便于跨设备访问与共享。</p>
<p>如下为1.5B模型生成,点击可进行试听：</p>

  
  您的浏览器不支持 audio 元素。

<p>以下为7B模型开启量化功能后生成推理的语音（3060ti的8G显存无法完全加载7B模型）：</p>

  
  您的浏览器不支持 audio 元素。

<h2 data-id="heading-10">6 使用 cpolar 将 ComfyUI 安全暴露到公网</h2>
<h3 data-id="heading-11">6.1 为什么要穿透comfyUI</h3>
<p>借助 cpolar 内网穿透，我们无需公网 IP 与路由配置，即可将本地 ComfyUI 服务稳定、安全地发布到公网，支持 HTTPS 与固定二级域名。</p>
<p>很多时候我们在本地电脑或者服务器上部署了 ComfyUI，但又希望能随时从其他设备访问，比如远程调试、和同事协作修改节点，或者在不同地方展示模型生成效果。问题是 ComfyUI 默认只能在本地访问，外网根本无法连接，这就让远程使用变得非常麻烦，需要复杂的路由设置或者固定公网 IP。通过内网穿透工具如 cpolar，我们可以把本地的 ComfyUI 安全地映射到公网，生成一个随时可用的公网地址。这样无论身处何地，都能轻松访问和操作 ComfyUI，实现远程协作和展示，而不必再为网络配置烦恼。</p>
<h3 data-id="heading-12">6.2 什么是 cpolar（内网穿透）？</h3>
<ul>
<li><strong>cpolar 是一款内网穿透工具</strong>，可以将你在局域网内运行的服务（如本地 Web 服务器、SSH、远程桌面等）通过一条安全加密的中间隧道映射至公网，让外部设备无需配置路由器即可访问。</li>
<li>广泛支持 Windows、macOS、Linux、树莓派、群晖 NAS 等平台，并提供一键安装脚本方便部署。</li>
</ul>
<h3 data-id="heading-13">6.3 下载cpolar</h3>
<p>打开cpolar官网的下载页面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2Fdownload" target="_blank" title="https://www.cpolar.com/download" ref="nofollow noopener noreferrer">www.cpolar.com/download</a>
点击<code>立即下载 64-bit</code>按钮，下载cpolar的安装包：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4607555e15264d5dbf843193bb8b600f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=tC4i48eGRrB99Yo6%2FeuMmlF6hW8%3D" alt="image-20250815171202537" loading="lazy"/></p>
<p>下载下来是一个压缩包，解压后执行目录中的应用程序，一路默认安装即可，安装完成后，打开cmd窗口输入如下命令确认安装：</p>
<pre><code class="hljs language-shell" lang="shell">cpolar version
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8c22b55462c49ff8c44e2b4f252c5ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=DSSqUuZL8cTPQLxoaOuG9GV6Q5o%3D" alt="image-20250815171446129" loading="lazy"/></p>
<p>出现如上版本即代表安装成功！</p>
<p>安装完成后，cpolar 将作为本方案“公网访问能力”的关键基础，贯穿后续所有远程访问与协作场景。</p>
<h3 data-id="heading-14">6.4注册及登录cpolar web ui管理界面</h3>
<h4 data-id="heading-15">6.4.1 注册cpolar</h4>
<p>官网链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2F" target="_blank" title="https://www.cpolar.com/" ref="nofollow noopener noreferrer">www.cpolar.com/</a></p>
<p>访问<code>cpolar</code>官网，点击<code>免费注册</code>按钮，进行账号注册</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5493be24a2f247249093e09e4555628b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=FQMYWN8jhxDQ%2BvHerI9KCj%2BV4oQ%3D" alt="image-20250804085039567" loading="lazy"/></p>
<p>注册页面：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f92f5ad382ed461f8db75324ce9403ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=B46CuJaq7cVMe0xTWHKEp9rGNGE%3D" alt="image-20250804085208319" loading="lazy"/></p>
<h4 data-id="heading-16">6.4.2 访问web ui管理界面</h4>
<p>注册完成后,在浏览器中输入如下地址访问 web ui管理界面:</p>
<pre><code class="hljs language-shell" lang="shell">http://127.0.0.1:9200
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35db9041d20d4760a997711200d4b894~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=iGhB5FnrMO207Z%2B%2Bfs%2B%2B%2FHoL%2BJk%3D" alt="image-20250815171734046" loading="lazy"/></p>
<p>输入刚才注册好的cpolar账号登录即可进入后台页面:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54067c621ea54f58a8c1188ef14f8a84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=Dw8v5J%2Ftb0knP8snTT38WMURQd8%3D" alt="image-20250815171846757" loading="lazy"/></p>
<h3 data-id="heading-17">6.5 使用 cpolar 穿透 ComfyUI 的 WebUI 界面</h3>
<p>前面可以看到，comfyUI的WebUI的界面，端口显示为：18188</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dcc34d18a5c41cfa866addb6fb652c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=X%2FqGEPRg5WReKNFGDJd6JsDWELk%3D" alt="image-20250905180851034" loading="lazy"/></p>
<p>所以我们需要将该端口进行穿透以支持咱们公网访问！</p>
<h4 data-id="heading-18">6.5.1 随机域名方式(免费方案)</h4>
<p>使用 cpolar 的随机域名方式适合预算有限的用户。使用此方式时，系统会每隔 <strong>24 小时左右</strong> 自动更换一次域名地址。对于长期访问的不太友好，但是该方案是免费的，如果您有一定的预算，可以查看大纲6.5.2 的<strong>固定域名方式</strong>，且<strong>访问更稳定</strong>。</p>
<p>点击左侧菜单栏的<code>隧道管理</code>，展开进入<code>隧道列表</code>页面，页面下默认会有 2 个隧道：</p>
<ul>
<li>ssh隧道，指向22端口，tcp协议</li>
<li>website隧道，指向8080端口，http协议（http协议默认会生成2个公网地址，一个是http，另一个https，免去配置ssl证书的繁琐步骤）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97584695f0554052856fa19c3be46f24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=Ao1kUgOU9CdOVShcBhuo1cyVlIw%3D" alt="image-20250731121517683" loading="lazy"/></p>
<p>点击<code>website隧道</code>的<code>编辑</code>按钮，填写如下信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52ad329ea4e24c84819499b518e39343~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=MXg%2FVsueeLFCAImzEST3Ri1Xshc%3D" alt="image-20250905181406529" loading="lazy"/></p>
<ul>
<li>注意：每个用户创建的隧道显示的公网地址都不一样！</li>
</ul>
<p>接着，点击左侧菜单的<code>状态</code>菜单，接着点击<code>在线隧道列表</code>菜单按钮，可以看到有2个comfyui-18188的隧道，一个为 http 协议，另一个为 https 协议：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fa4931d3e0c485a8089e10f6c2eb4ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=mgtuLox7Z99mdd6jrBtkoPAZfOM%3D" alt="image-20250905181536558" loading="lazy"/></p>
<p>接下来在浏览器中访问 website 隧道生成的公网地址（http 和 https 皆可）
这里以https为例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b76ad8f8a8c4d73bc7a7b77e30772fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=2xKMHi3TY0WKYtY%2FVLyL5sIVj9g%3D" alt="image-20250905181810649" loading="lazy"/></p>
<p>可以看到成功访问啦！</p>
<h4 data-id="heading-19">6.5.2 固定域名方式（升级套餐）</h4>
<p>通过 cpolar 的固定二级子域名方式（升级套餐），可获得稳定不变的公网地址，便于长期访问与对外分享。</p>
<p>进入官网的预留页面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdashboard.cpolar.com%2Freserved" target="_blank" title="https://dashboard.cpolar.com/reserved" ref="nofollow noopener noreferrer">dashboard.cpolar.com/reserved</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa222ab999b42f7a53a81ef48c95878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=Cc81khmCHZ8CmpV3pdrTkOFSsSU%3D" alt="image-20250905193637752" loading="lazy"/></p>
<p>列表中显示了一条已保留的二级子域名记录：</p>
<ul>
<li>地区：显示为<code>China Top</code>。</li>
<li>二级域名：显示为<code>comfyui01</code>。</li>
</ul>
<pre><code class="hljs language-text" lang="text">注：二级域名是唯一的，每个账号都不相同，请以自己设置的二级域名保留的为主
</code></pre>
<p>进入侧边菜单栏的<code>隧道管理</code>下的<code>隧道列表</code>，可以看到名为<code>comfyui-18188</code>的隧道
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e14982dd6b3c489eb82f1d8a0037678d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=RdM2g5I7G0%2B5I5t4wI0WcAoTtss%3D" alt="image-20250905193710797" loading="lazy"/></p>
<p>点击<code>编辑</code>按钮进入编辑页面，修改域名类型为<code>二级子域名</code>，然后填写前面配置好的子域名，点击更新按钮：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/158c4105b1094f63b021bb9303cd1b30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=fXFO%2B1LiGlQFvQLSyjrU6pfwKE4%3D" alt="image-20250905195904105" loading="lazy"/></p>
<p>来到<code>状态</code>菜单下的<code>在线隧道列表</code>可以看到隧道名称为<code>comfyui-18188</code>的公网地址已经变更为<code>二级子域名+固定域名主体及后缀</code>的形式了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ad256789be445acb93fe66ccf11f515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=9yysg3EgM8XB7d8pfQX7sIM%2B4Ps%3D" alt="image-20250905195932400" loading="lazy"/></p>
<p>这里以https协议做访问测试:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab21e13b8b904f92a0eca479cfa251ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=W30v68UmZ3rVD4unVylPhCmIyqY%3D" alt="image-20250907174602474" loading="lazy"/></p>
<p>访问成功！</p>
<p>至此，依托 cpolar，我们已将本地 ComfyUI 服务稳定发布到公网，便于团队远程协作与外部演示。</p>
<h3 data-id="heading-20">6.6 给ComfyUI添加授权验证</h3>
<p>由于<code>ComfyUI</code>服务的WebUI界面无需登录即可进行访问，为了保护个人的隐私即安全，cpolar的隧道服务支持给网站添加授权验证功能，防止您部署在家中的<code>ComfyUI</code>服务被滥用。</p>
<p>首先，打开隧道列表，点击编辑<code>comfyui-18188</code>的隧道：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd8445dc53974721a6860fadb4b28548~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=HFk7N4GGbdbxLVuLGLAwJ3LHX8M%3D" alt="image-20250908104953889" loading="lazy"/></p>
<p>然后，点击高级按钮，展开，按照如下图进行配置：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5272a0e4a1b04ee884f9ebc504b1bf37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=ea%2BljrpTMGKeqpqEwZbsATYprAU%3D" alt="image-20250908105304054" loading="lazy"/></p>
<p>点击更新按钮后，访问穿透的地址，可以发现需要授权验证：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3901ed16e9c4961afea472541436dae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=9XgkdJQDkJp8xv4QF%2Fxhqmre6Og%3D" alt="image-20250908105335660" loading="lazy"/></p>
<p>这样，一个可以随时访问且带有安全性的<code>ComfyUI</code>的工作流网页端就弄好啦！</p>
<h2 data-id="heading-21">7 三人对话和四人对话测试</h2>
<h3 data-id="heading-22">7.1 三人对话</h3>
<p>首先准备一段对话内容：</p>
<pre><code class="hljs language-text" lang="text">Speaker 1: 大家好，好久不见了！我们今天终于可以好好聊聊了。
Speaker 2: 是啊，最近工作太忙了，终于能和大家放松一下了。
Speaker 3: 哈哈，你们有没有发现，我们三个凑在一起，话题根本停不下来。
Speaker 1: 最近我在拍一部古装剧，造型超级复杂，每天都要花三个小时化妆。
Speaker 2: 哇，那也太辛苦了！我最近在做新歌demo，熬夜熬到快失眠了。
Speaker 3: 看来大家都很拼啊，我这边刚从巡演回来，现在只想休息睡觉。
</code></pre>
<p>这里的<code>Speaker 1</code>和<code>Speaker 2</code>以及<code>Speaker 3</code>分别对应的参考音频如下：</p>
<ul>
<li><strong>Speaker 1</strong>：杨幂</li>
<li><strong>Speaker 2</strong>：蔡徐坤</li>
<li><strong>Speaker 3</strong>：王俊凯</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/458c32cc4def4359b000ec1e1822abc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=OvwbazAjvSWrd0Vo4Ln6EOJpgXI%3D" alt="image-20250907192122704" loading="lazy"/></p>
<p>让我们试听一下3人对话的效果：</p>

  
  您的浏览器不支持 audio 元素。

<blockquote>
<p>由于演示的windows系统，3060ti显卡，显存为8G，推理 7B 模型内存会超出，所以这边就不做7B的演示了</p>
</blockquote>
<h3 data-id="heading-23">7.2 四人对话</h3>
<p>在前面的对话内容基础上，添加一个新的角色<code>Speaker 4</code>,这里使用的参考音频为：</p>
<ul>
<li><strong>Speaker 4</strong>：林志玲</li>
</ul>
<pre><code class="hljs language-text" lang="text">Speaker 1: 大家好，好久不见了！我们今天终于可以好好聊聊了。
Speaker 2: 是啊，最近工作太忙了，终于能和大家放松一下了。
Speaker 3: 哈哈，你们有没有发现，我们四个凑在一起，话题根本停不下来。
Speaker 4: 听到你们的声音我就觉得特别温暖，今天一定要聊个尽兴！
Speaker 1: 最近我在拍一部古装剧，造型超级复杂，每天都要花三个小时化妆。
Speaker 2: 哇，那也太辛苦了！我最近在做新歌demo，熬夜熬到快失眠了。
Speaker 3: 看来大家都很拼啊，我这边刚从巡演回来，现在只想休息睡觉。
Speaker 4: 我和你们比轻松多了，最近主要在做一些公益活动，也蛮充实的。
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af062384dcc9422182b231c07c55dcb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299521&amp;x-signature=L7uaaVPSLuqAQ9c%2Fv%2BklXCGkCf8%3D" alt="image-20250908004742342" loading="lazy"/></p>
<p>让我们试听一下4人对话的效果：</p>

  
  您的浏览器不支持 audio 元素。

<p>可以看到，4人对话的效果也是非常不错的，都是演示了2轮对话。推理显示用了 180s 左右，还是很不错的！</p>
<h2 data-id="heading-24">总结</h2>
<p>VibeVoice 凭借多角色、长时长、带情绪的语音生成能力，解决了多场景下音频创作的核心痛点，ComfyUI 则让操作门槛大幅降低，但局域网使用的局限确实制约了创作的灵活性。而 cpolar 内网穿透的加入，恰好补齐了这一短板，实现了 VibeVoice 创作场景的延伸 —— 无论是个人创作者随时随地调整配音脚本，还是团队协作实时优化音频效果，都能高效完成。这套组合并非单纯的技术叠加，而是从实际创作需求出发，让多角色语音生成从 “只能固定地点操作” 变成 “随时随地可创作”，真正适配了剧本杀、自媒体、企业培训等场景的实际使用需求，为音频内容创作提供了更灵活、更实用的解决方案。</p>
<p>感谢您阅读本篇文章，有任何问题欢迎留言交流。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2F" target="_blank" title="https://www.cpolar.com/" ref="nofollow noopener noreferrer">cpolar官网-安全的内网穿透工具 | 无需公网ip | 远程访问 | 搭建网站</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C 端高并发下的 KV 存储优化]]></title>    <link>https://juejin.cn/post/7604666872128241683</link>    <guid>https://juejin.cn/post/7604666872128241683</guid>    <pubDate>2026-02-10T03:45:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604666872128241683" data-draft-id="7604757482003841087" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C 端高并发下的 KV 存储优化"/> <meta itemprop="keywords" content="后端,Java,数据库"/> <meta itemprop="datePublished" content="2026-02-10T03:45:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LanLance"/> <meta itemprop="url" content="https://juejin.cn/user/2837173444548711"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C 端高并发下的 KV 存储优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2837173444548711/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LanLance
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:45:14.000Z" title="Tue Feb 10 2026 03:45:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>C 端场景下分布式 KV 存储（如 Redis、Tair）随着业务逻辑的日益复杂、对象体积不断膨胀，大 Value 问题成为系统顽疾之一，危害系统稳定性与接口性能。</p>
<ul>
<li>
<p>大 Value 数据如果读写频率较高，容易导致网卡流量较高触发流控，还容易硬盘的负载太高甚至导致引擎处理不过来而阻塞正常的写入。</p>
</li>
<li>
<p>大 Value 网络传输和内存拷贝本身就慢，服务端的内置缓存引擎不容易缓存大 Value，涉及的大 Value 读写基本都是经过硬盘，而且大 Value 在存储引擎上容易有严重的写放大问题，所以大 Value 处理性能会明显较差。</p>
</li>
</ul>
<p>为了解决这一痛点，同时不牺牲系统的吞吐能力，针对性地设计出了一套基于 Fory 序列化与 Zstd 压缩的组合方案。这套方案的核心逻辑在于：利用 Fory 的极致性能解决序列化带来的 CPU 和耗时问题，利用 Zstd 的高压缩比与解压速度解决 KV 存储的大 Value 问题。</p>
<h2 data-id="heading-0">为什么是 Fory 与 Zstd</h2>
<p>在传统 Java 服务端开发中，序列化通常使用 JDK 自带方案或 Hessian，压缩习惯使用 Gzip。但在 QPS 极高的场景下该组合性能差、系统压力大。</p>
<p><strong>Apache Fory™</strong>（淘宝开源）是一个基于动态代码生成和零拷贝技术的多语言序列化框架，实现了无需 IDL 编译的原生多语言编程范式，并提供最高 170 倍的性能和极致的易用性。大幅提升大规模数据传输、高并发 RPC、分布式系统、云原生中间件等场景的性能，显著降低多语言系统的研发成本。</p>
<p><strong>Zstandard</strong>（Facebook 开源）是一个提供高压缩比的快速压缩算法，采用了有限状态熵（Finite State Entropy，缩写为 FSE）编码器。该编码器是基于 ANS 理论开发的一种新型熵编码器，提供了非常强大的压缩速度/压缩率的折中方案（事实上也的确做到了“鱼”和“熊掌”兼得）。Zstandard 达到了 Pareto frontier（资源分配最佳的理想状态），因为它解压缩速度快于任何其他当前可用的算法，但压缩比类似或更好。</p>
<h2 data-id="heading-1">选型对比</h2>
<p><strong>序列化算法对比</strong></p>
<p>在序列化层面，我们主要关注序列化速度（影响接口耗时）、码流大小（影响网络与存储）以及易用性。</p>















































<table><thead><tr><th>序列化框架</th><th>序列化/反序列化速度</th><th>码流大小</th><th>易用性与兼容性</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Fory</strong></td><td>极快 (JIT 加速)</td><td>小 (支持类注册)</td><td>高 (兼容 JDK 序列化，无需 IDL)</td><td>高性能 Java 应用，内部 RPC/KV</td></tr><tr><td><strong>Hessian2</strong></td><td>中等</td><td>中等</td><td>高 (兼容性好)</td><td>传统 RPC，对性能要求不严苛</td></tr><tr><td><strong>Protobuf</strong></td><td>快</td><td>极小</td><td>低 (需编写.proto 文件)</td><td>跨语言交互，Schema 稳定的场景</td></tr><tr><td><strong>JDK 原生</strong></td><td>慢</td><td>大</td><td>高 (开箱即用)</td><td>不推荐用于高并发生产环境</td></tr><tr><td><strong>Kryo</strong></td><td>极快</td><td>小</td><td>中 (需处理线程安全)</td><td>大数据处理，Spark/Flink</td></tr></tbody></table>
<p>Fory 在保持了 Java 原生兼容性的前提下，提供了接近甚至超越 Protobuf 的性能，且不需要维护复杂的 IDL 文件。</p>
<p><strong>压缩算法对比</strong></p>
<p>在压缩层面，我们重点关注压缩率（节省空间）与解压速度（影响读取 RT）。</p>








































<table><thead><tr><th>压缩算法</th><th>压缩率</th><th>压缩速度</th><th>解压速度</th><th>特点</th></tr></thead><tbody><tr><td><strong>Zstd</strong></td><td>高</td><td>快</td><td>极快</td><td>综合性能最强，平衡了空间与时间</td></tr><tr><td><strong>Gzip</strong></td><td>高</td><td>慢</td><td>慢</td><td>CPU 消耗大，高并发下易导致 RT 抖动</td></tr><tr><td><strong>LZ4</strong></td><td>低</td><td>极快</td><td>极快</td><td>速度最快，但压缩率较低，大 Value 优化有限</td></tr><tr><td><strong>Snappy</strong></td><td>低</td><td>快</td><td>快</td><td>Google 出品，性能介于 LZ4 与 Gzip 之间</td></tr></tbody></table>
<p>Zstd 在压缩率上完胜 LZ4，在解压速度上完胜 Gzip，达到了 Pareto frontier。</p>
<h2 data-id="heading-2">最佳实践</h2>
<p><strong>整体流程</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dfd66e5876f43d68c01b0d8173ad935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGFuTGFuY2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771299915&amp;x-signature=p3Be7rSi5EUHbOrmL4Tzm%2BIXafI%3D" alt="" loading="lazy"/></p>
<p><strong>Fory 实例复用</strong></p>
<p>创建 Fory 成本很高，始终复用实例，严禁在每次请求中通过 <code>new Fory()</code> 创建实例，应使用 <code>ThreadSafeFory</code> 或者 <code>ThreadLocal</code> 来复用实例。同时按 ID 注册类会有更好的性能和更小的空间开销。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadSafeFory FORY_INSTANCE;

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Integer&gt; REGISTERED_CLASSES_WITH_IDS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
<span class="hljs-keyword">static</span> {
    REGISTERED_CLASSES_WITH_IDS.put(LbsRecallCacheBO.class, <span class="hljs-number">1</span>);
    REGISTERED_CLASSES_WITH_IDS.put(ActivityPoiDocument.class, <span class="hljs-number">2</span>);
    REGISTERED_CLASSES_WITH_IDS.put(SkuSolrVo.class, <span class="hljs-number">3</span>);
    REGISTERED_CLASSES_WITH_IDS.put(PoiScore.class, <span class="hljs-number">4</span>);
}
</code></pre>
<p><strong>Zstd 解压精确分配</strong></p>
<p>Zstd 在解压时，如果能预先知道解压后的数据大小，就可以直接分配精确的内存空间，避免多次内存扩容或分配过大的缓冲区。最佳实践是在压缩后的字节数组头部手动写入原始数据的长度（或者使用 <em>ZSTD_getFrameContentSize</em> API）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] serializeAndCompress(Object object) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];
        }
        <span class="hljs-type">byte</span>[] serializedData = FORY_INSTANCE.serializeJavaObject(object);
        <span class="hljs-keyword">if</span> (serializedData == <span class="hljs-literal">null</span> || serializedData.length == <span class="hljs-number">0</span>) {
            LOGGER.warn(<span class="hljs-string">"Serialized data is empty for object: {}"</span>, object.getClass().getName());
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];
        }
        <span class="hljs-type">byte</span>[] compressedData = Zstd.compress(serializedData, ZSTD_COMPRESSION_LEVEL);
        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(HEADER_SIZE + compressedData.length);
        buffer.putInt(serializedData.length);
        buffer.put(compressedData);
        <span class="hljs-keyword">return</span> buffer.array();
    } <span class="hljs-keyword">catch</span> (Exception e) {
        LOGGER.error(<span class="hljs-string">"Fory+Zstd serialization failed for object: {}"</span>, object.getClass().getName(), e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Fory+Zstd serialization failed"</span>, e);
    }
}
</code></pre>
<h2 data-id="heading-3">优化效果</h2>
<p>某核心营销页面（脱敏）正常召回 TP90 59.4ms，使用缓存召回 TP90 1.6ms，同时午高峰该页面缓存命中率 80% 左右。且在 10 万 QPS 的入口流量下 TP90 能够保证 2ms 以内，Value 大小均小于 100Kb。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用bufio Writer时，手动调用Flush()的必要性]]></title>    <link>https://juejin.cn/post/7604741630448648226</link>    <guid>https://juejin.cn/post/7604741630448648226</guid>    <pubDate>2026-02-10T03:23:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604741630448648226" data-draft-id="7604779604124893184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用bufio Writer时，手动调用Flush()的必要性"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2026-02-10T03:23:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cppgo"/> <meta itemprop="url" content="https://juejin.cn/user/1924620895400932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用bufio Writer时，手动调用Flush()的必要性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1924620895400932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cppgo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:23:16.000Z" title="Tue Feb 10 2026 03:23:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"bytes"</span>
	<span class="hljs-string">"bufio"</span>
	<span class="hljs-string">"fmt"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	buf := &amp;bytes.Buffer{}

	wr := bufio.NewWriter(buf)
	wr.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">"1234"</span>))

	fmt.Println(<span class="hljs-string">"buf:"</span>, buf.String())
}
</code></pre>
<p>　　内容没有写到buf：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> run iotest.<span class="hljs-keyword">go</span>
buf:
</code></pre>
<p>　　添加Flush：</p>
<pre><code class="hljs language-css" lang="css">package <span class="hljs-selector-tag">main</span>

import (
	"bytes"
	"bufio"
	"fmt"
)

func <span class="hljs-selector-tag">main</span>() {
	buf := &amp;bytes.Buffer{}

	wr := bufio.<span class="hljs-built_in">NewWriter</span>(buf)
	wr.<span class="hljs-built_in">Write</span>([]<span class="hljs-built_in">byte</span>(<span class="hljs-string">"1234"</span>))
	wr.<span class="hljs-built_in">Flush</span>()

	fmt.<span class="hljs-built_in">Println</span>(<span class="hljs-string">"buf:"</span>, buf.<span class="hljs-built_in">String</span>())
}
</code></pre>
<p>　　输出：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> run iotest.<span class="hljs-keyword">go</span>
buf: <span class="hljs-number">1234</span>
</code></pre>
<p>　　查看这块的源码:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afe89e59c9e740e28309d0c0a9830f65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY3BwZ28=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771298655&amp;x-signature=t9YKQUINaBtq2IHYcO05lbYbtLw%3D" alt="" loading="lazy"/></p>
<p> </p>
<p>可以看到，只有在buffer写满（默认4KB）后，才会主动调Flush()把buffer内容写入底层io。或者写入的数据很大超过buffer长度，会直接写入底层io。</p>
<p>所以，使用bufio Writer时，在适当位置手动调用Flush()才比较稳妥。</p>
<p>【迁移】<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fzxq89%2Fp%2F16737371.html" target="_blank" title="https://www.cnblogs.com/zxq89/p/16737371.html" ref="nofollow noopener noreferrer">www.cnblogs.com/zxq89/p/167…</a> posted @ 2022-09-28 11:19</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot中结合MySQL、Redis，实现异步落库的评论点赞/拉踩功能]]></title>    <link>https://juejin.cn/post/7604697194795974666</link>    <guid>https://juejin.cn/post/7604697194795974666</guid>    <pubDate>2026-02-10T03:24:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604697194795974666" data-draft-id="7604775190211870730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot中结合MySQL、Redis，实现异步落库的评论点赞/拉踩功能"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-10T03:24:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PersonalViolet"/> <meta itemprop="url" content="https://juejin.cn/user/502926347091433"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot中结合MySQL、Redis，实现异步落库的评论点赞/拉踩功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/502926347091433/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PersonalViolet
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:24:43.000Z" title="Tue Feb 10 2026 03:24:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概要</h2>
<p>该方案是一个典型的<strong>用空间（Redis缓存）和异步化换取时间（响应速度）和系统稳定性（数据库抗压）</strong> 的架构设计。它非常适合点赞这类<strong>写多读多、对实时一致性要求稍低</strong>的业务场景。</p>
<h2 data-id="heading-1">前言</h2>
<p>学习java过程中的心得，如有错误请提醒作者纠正，感谢不尽！！！</p>
<p>如果有更好的实现，欢迎分享！！！</p>
<h3 data-id="heading-2">当前实现优点</h3>
<ol>
<li>
<p><strong>高性能与低延迟</strong>：</p>
<ul>
<li><strong>写操作快</strong>：用户点赞/拉踩请求直接操作内存数据库Redis，响应速度极快，用户体验好。</li>
<li><strong>数据库在定时任务触发前压力小</strong>：高频的写操作被Redis承接，避免了直接冲击MySQL</li>
</ul>
</li>
<li>
<p><strong>数据一致性保障</strong>：</p>
<ul>
<li><strong>原子性操作</strong>：使用<strong>Lua脚本</strong>在Redis内完成状态切换（点赞-&gt;拉踩-&gt;无状态），保证了“一个评论同一时刻只能有一种状态”的业务逻辑的原子性，防止并发请求导致的数据错乱。</li>
<li><strong>分布式锁</strong>：对单个用户的操作加锁（<code>RLock</code>），防止同一用户极短时间内的重复提交造成缓存数据问题。</li>
</ul>
</li>
<li>
<p><strong>批量处理效率高</strong>：</p>
<ul>
<li><strong>异步落库</strong>：定时任务将缓存中的大量变更集中起来，通过<strong>批量插入/更新</strong>（<code>ON DUPLICATE KEY UPDATE</code>）和<strong>批量更新统计</strong>（<code>CASE WHEN</code>）的方式与数据库交互，极大地减少了网络I/O和SQL执行次数，数据库处理效率高。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3"><strong>当前实现存在问题</strong></h3>
<ol>
<li>
<p>定时任务引发的数据库峰值：</p>
<ol>
<li><strong>可通过使用消息队列削峰填谷</strong></li>
<li><strong>将定时任务从处理全部数据改为处理部分数据，定时任务的周期调低</strong></li>
</ol>
</li>
</ol>
<h2 data-id="heading-4">主要实现细节</h2>
<p>Redis + Redis分布式锁 + 原子操作 + 异步落库 + SpringBoot定时任务</p>
<h2 data-id="heading-5">流程图</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dab1bc3269c407dac3ef72a7a66f5f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGVyc29uYWxWaW9sZXQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771298683&amp;x-signature=A4FfvkVAxdaVUCby1PfCawMtG9c%3D" alt="点赞拉踩无状态方案2.png" loading="lazy"/></p>
<h2 data-id="heading-6">请求方法设计</h2>
<p><strong>请求URL</strong>：<code>/api/article/v1/{commentId}/vote</code></p>
<p><strong>请求方法</strong>：PUT</p>
<p><strong>请求参数</strong>：type(Integer);(type=0表示修改成无状态，type=1表示修改成点赞状态，type=-1表示修改成拉踩状态)</p>
<p><strong>URL示例</strong>：/api/article/v1/{commentId}/vote?type = 1</p>
<h2 data-id="heading-7">Redis表设计</h2>
<p>下述三表都用来记录用户对评论的状态(点赞、拉踩、无状态)</p>
<h3 data-id="heading-8">articles:comments:likes:users:{userId}</h3>
<p>{userId}为动态键名</p>
<p><strong>Redis Set</strong>数据结构；</p>
<p>存储的值：{commentId}</p>
<h3 data-id="heading-9">articles:comments:dislikes:users:{userId}</h3>
<p>{userId}为动态键名</p>
<p><strong>Redis Set</strong>数据结构；</p>
<p>存储的值：{commentId}</p>
<h3 data-id="heading-10">articles:comments:stateless:users:{userId}</h3>
<p>{userId}为动态键名</p>
<p><strong>Redis Set</strong>数据结构；</p>
<p>存储的值：{commentId}</p>
<h2 data-id="heading-11">MySQL表设计</h2>
<p>该博客聚焦实现点赞/拉踩功能，涉及x_article_comments表不多，故不做x_article_comments表的字段介绍</p>
<ul>
<li>
<p>x_article_comments_votes</p>
<ul>
<li>联合主键(comment_id, user_id)</li>
<li>vote字段表用户对评论的状态，1代表点赞，-1代表拉踩，0代表无状态，即不处于点赞状态或拉踩状态</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 文章评论表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> x_article_comments (
  id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
  article_id <span class="hljs-type">BIGINT</span> UNSIGNED <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,            <span class="hljs-comment">-- 关联的文章</span>
  parent_id <span class="hljs-type">BIGINT</span> UNSIGNED <span class="hljs-keyword">NULL</span>,               <span class="hljs-comment">-- NULL 表示顶级评论；否则是回复</span>
  root_id <span class="hljs-type">BIGINT</span> UNSIGNED <span class="hljs-keyword">NULL</span>,                 <span class="hljs-comment">-- 同一Thread的Root评论 id（便于查询整个Thread）</span>
  user_id <span class="hljs-type">BIGINT</span> UNSIGNED <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,             <span class="hljs-comment">-- 评论作者</span>
  content TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>,            <span class="hljs-comment">-- 1=显示,0=已删除/隐藏,2=待审核 等</span>
  like_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  dislike_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  reply_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>, <span class="hljs-comment">-- 该层孩子的数量</span>
  reply_descendant_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>, <span class="hljs-comment">-- 该层后代的数量</span>
  version <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,               <span class="hljs-comment">-- 乐观锁（更新时校验）</span>
  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
​
  <span class="hljs-keyword">PRIMARY</span> KEY (id)
) ENGINE<span class="hljs-operator">=</span>InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4
  <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_unicode_ci;
​
<span class="hljs-comment">-- 点赞/踩表（每个用户对某条评论的动作）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> x_article_comments_votes (
  comment_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  vote TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 1=like, -1=dislike, 0=none</span>
  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  update_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (comment_id, user_id)
) ENGINE<span class="hljs-operator">=</span>InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4
  <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_unicode_ci;
</code></pre>
<h2 data-id="heading-12">后端实现细节</h2>
<h3 data-id="heading-13">处理用户发起的点赞/拉踩/无状态请求</h3>
<h4 data-id="heading-14">Controller层</h4>
<h5 data-id="heading-15">校验参数</h5>
<p>先校验当前用户是否登录，userReadApi.getCurrentUserId()是我封装好的方法，用于获取发起当前请求的用户ID</p>
<pre><code class="hljs language-ini" lang="ini">        // 获取当前用户ID
        Long <span class="hljs-attr">userId</span> = userReadApi.getCurrentUserId()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">userId</span> == null) {
            return AjaxResult.error(HttpStatus.UNAUTHORIZED, "用户未登录或获取用户ID失败")<span class="hljs-comment">;</span>
        }
</code></pre>
<h5 data-id="heading-16">完整代码</h5>
<pre><code class="hljs language-less" lang="less">    <span class="hljs-comment">/**
     * 点赞/拉踩/无状态评论
     */</span>
    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/{commentId}/vote"</span>)
    public AjaxResult <span class="hljs-built_in">voteComment</span>(
            <span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"commentId"</span>) Long commentId,
            <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"type"</span>) Integer type
    ) {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"进入请求 /api/article/v1/{}/vote -&gt; 点赞/取消点赞评论 type={}"</span>, commentId, type);
​
        <span class="hljs-comment">// 获取当前用户ID</span>
        <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">userId</span> = <span class="hljs-selector-tag">userReadApi</span><span class="hljs-selector-class">.getCurrentUserId</span>();
        <span class="hljs-selector-tag">if</span> (userId == null) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">AjaxResult</span><span class="hljs-selector-class">.error</span>(HttpStatus.UNAUTHORIZED, <span class="hljs-string">"用户未登录或获取用户ID失败"</span>);
        }
​
​
        <span class="hljs-selector-tag">articleService</span><span class="hljs-selector-class">.voteComment</span>(userId, commentId, type);
​
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"返回结果 /api/article/v1/{}/vote -&gt; OK"</span>, commentId);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">AjaxResult</span><span class="hljs-selector-class">.success</span>();
    }
</code></pre>
<h4 data-id="heading-17">Service层</h4>
<h5 data-id="heading-18">校验参数</h5>
<pre><code class="hljs language-typescript" lang="typescript">        <span class="hljs-comment">// 1. 参数校验</span>
        <span class="hljs-keyword">if</span> (commentId == <span class="hljs-literal">null</span> || <span class="hljs-keyword">type</span> == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(<span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">BAD_REQUEST</span>, <span class="hljs-string">"参数不完整"</span>);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> != <span class="hljs-title class_">ArticleCommentVoteConstants</span>.<span class="hljs-property">LIKE</span> &amp;&amp; <span class="hljs-keyword">type</span> != <span class="hljs-title class_">ArticleCommentVoteConstants</span>.<span class="hljs-property">DISLIKE</span> &amp;&amp; <span class="hljs-keyword">type</span> != <span class="hljs-title class_">ArticleCommentVoteConstants</span>.<span class="hljs-property">STATELESS</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(<span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">BAD_REQUEST</span>, <span class="hljs-string">"投票类型非法"</span>);
        }
​
        <span class="hljs-comment">// 2. 校验评论是否存在</span>
        <span class="hljs-title class_">ArticleComment</span> comment = articleCommentMapper.<span class="hljs-title function_">selectArticleCommentById</span>(commentId);
        <span class="hljs-keyword">if</span> (comment == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(<span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">NOT_FOUND</span>, <span class="hljs-string">"评论不存在"</span>);
        }
</code></pre>
<h5 data-id="heading-19">分布式锁 + lua脚本</h5>
<p>使用了redisson实现加锁，并使用了lua脚本保证原子性，从而防止用户频繁发起请求导致在redis缓存的数据出现错误的情况</p>
<h6 data-id="heading-20"><strong>分布式锁相关代码</strong></h6>
<pre><code class="hljs language-csharp" lang="csharp">        <span class="hljs-comment">// 5. 尝试获取分布式锁</span>
        RLock <span class="hljs-keyword">lock</span> = redisson.getLock(RedisKeyConstants.ARTICLES_COMMENTS_VOTES_LOCK_KEY + userId);
        boolean isLocked = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            isLocked = <span class="hljs-keyword">lock</span>.tryLock(<span class="hljs-number">0</span>, RedisKeyConstants.ARTICLES_COMMENTS_VOTES_LOCK_KEY_EXPIRE_TIME, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ClientException(HttpStatus.SERVICE_UNAVAILABLE, <span class="hljs-string">"系统繁忙，请稍后再试"</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 获取到锁，执行投票逻辑，此处省略</span>
                <span class="hljs-comment">// ...</span>
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ClientException(HttpStatus.ERROR, <span class="hljs-string">"系统繁忙，请稍后再试"</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (isLocked &amp;&amp; <span class="hljs-keyword">lock</span>.isHeldByCurrentThread()) {
                <span class="hljs-keyword">lock</span>.unlock();
                log.info(<span class="hljs-string">"用户 {} 的锁已释放"</span>, userId);
            }
        }
</code></pre>
<h6 data-id="heading-21">lua脚本相关代码</h6>
<p><strong>预先准备好redis键和lua脚本</strong></p>
<pre><code class="hljs language-ini" lang="ini">        // 3. 构建 Redis 键
        String <span class="hljs-attr">likeKey</span> = RedisKeyConstants.ARTICLES_COMMENTS_LIKES_USERS_KEY + userId<span class="hljs-comment">;</span>
        String <span class="hljs-attr">dislikeKey</span> = RedisKeyConstants.ARTICLES_COMMENTS_DISLIKES_USERS_KEY + userId<span class="hljs-comment">;</span>
        String <span class="hljs-attr">statelessKey</span> = RedisKeyConstants.ARTICLES_COMMENTS_STATELESS_USERS_KEY + userId<span class="hljs-comment">;</span>
        // 4. 根据投票类型处理逻辑
        DefaultRedisScript&lt;Long&gt; <span class="hljs-attr">deleteScript</span> = new DefaultRedisScript&lt;&gt;()<span class="hljs-comment">;</span>
        deleteScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(RedisLuaConstants.ARTICLE_COMMENTS_VOTE_LUA_SCRIPT_PATH)))<span class="hljs-comment">;</span>
        deleteScript.setResultType(Long.class)<span class="hljs-comment">;</span>
        Long <span class="hljs-attr">execute</span> = null<span class="hljs-comment">;</span>
</code></pre>
<p><strong>lua脚本文件</strong></p>
<p>lua脚本能够<strong>保证原子性</strong>，若用户频繁发起请求也能保证<strong>以下的要求</strong></p>
<p>三个键对应的set集合里的值应<strong>保持互斥</strong>，只允许一个值如3只能出现在一个键，例如：共有三个键like:{userId}、dislike:{userId}、stateless:{userId}，键like现在持有3，用户对commentId = 3发起了点赞/拉踩/无状态请求，修改为拉踩，此时要去除like:{userId}键和stateless:{userId}键的set集合中值为3的元素，执行完后只有键dislike:{userId}存在值3</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua 脚本：处理评论投票逻辑</span>
<span class="hljs-keyword">local</span> mainKey = KEYS[<span class="hljs-number">1</span>]       <span class="hljs-comment">-- 进行add的键</span>
<span class="hljs-keyword">local</span> srem1Key = KEYS[<span class="hljs-number">2</span>]    <span class="hljs-comment">-- 进行srem的键</span>
<span class="hljs-keyword">local</span> srem2Key = KEYS[<span class="hljs-number">3</span>]  <span class="hljs-comment">-- 进行srem的键</span>
<span class="hljs-keyword">local</span> commentId = ARGV[<span class="hljs-number">1</span>]     <span class="hljs-comment">-- 评论 ID</span>
​
<span class="hljs-comment">-- 添加到main集合</span>
redis.call(<span class="hljs-string">'SADD'</span>, mainKey, commentId)
​
<span class="hljs-comment">-- 从两个集合中移除</span>
redis.call(<span class="hljs-string">'SREM'</span>, srem1Key, commentId)
redis.call(<span class="hljs-string">'SREM'</span>, srem2Key, commentId)
​
<span class="hljs-comment">-- 返回操作结果（可选）</span>
<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>  <span class="hljs-comment">-- 表示成功执行</span>
​
</code></pre>
<p><strong>获取到锁后，为实现存进redis，执行的操作如下</strong></p>
<pre><code class="hljs language-vbscript" lang="vbscript">                switch (type) {
                    <span class="hljs-keyword">case</span> ArticleCommentVoteConstants.LIKE:
                        // <span class="hljs-number">4.</span> 处理点赞逻辑
                        <span class="hljs-keyword">execute</span> = stringRedisTemplate.<span class="hljs-keyword">execute</span>(deleteScript, Arrays.asList(likeKey, dislikeKey, statelessKey), commentId.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">execute</span> == <span class="hljs-literal">null</span>) {
                            throw <span class="hljs-keyword">new</span> ClientException(HttpStatus.SERVICE_UNAVAILABLE, <span class="hljs-string">"处理点踩逻辑失败"</span>);
                        }
                        break;
                    <span class="hljs-keyword">case</span> ArticleCommentVoteConstants.DISLIKE:
                        // <span class="hljs-number">5.</span> 处理点踩逻辑
                        <span class="hljs-keyword">execute</span> = stringRedisTemplate.<span class="hljs-keyword">execute</span>(deleteScript, Arrays.asList(dislikeKey, likeKey, statelessKey), commentId.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">execute</span> == <span class="hljs-literal">null</span>) {
                            throw <span class="hljs-keyword">new</span> ClientException(HttpStatus.SERVICE_UNAVAILABLE, <span class="hljs-string">"处理点踩逻辑失败"</span>);
                        }
                        break;
                    <span class="hljs-keyword">case</span> ArticleCommentVoteConstants.STATELESS:
                        <span class="hljs-keyword">execute</span> = stringRedisTemplate.<span class="hljs-keyword">execute</span>(deleteScript, Arrays.asList(statelessKey, dislikeKey, likeKey), commentId.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());
                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">execute</span> == <span class="hljs-literal">null</span>) {
                            throw <span class="hljs-keyword">new</span> ClientException(HttpStatus.<span class="hljs-keyword">ERROR</span>, <span class="hljs-string">"处理无状态逻辑失败"</span>);
                        }
                        break;
                    <span class="hljs-keyword">default</span>:
                        throw <span class="hljs-keyword">new</span> ClientException(HttpStatus.BAD_REQUEST, <span class="hljs-string">"未知的投票类型"</span>);
                }
</code></pre>
<h5 data-id="heading-22">完整代码</h5>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">voteComment</span><span class="hljs-params">(Long userId, Long commentId, Integer type)</span> {
        <span class="hljs-comment">// 1. 参数校验</span>
        <span class="hljs-keyword">if</span> (commentId == <span class="hljs-literal">null</span> || type == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.BAD_REQUEST, <span class="hljs-string">"参数不完整"</span>);
        }
        <span class="hljs-keyword">if</span> (type != ArticleCommentVoteConstants.LIKE &amp;&amp; type != ArticleCommentVoteConstants.DISLIKE &amp;&amp; type != ArticleCommentVoteConstants.STATELESS) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.BAD_REQUEST, <span class="hljs-string">"投票类型非法"</span>);
        }

        <span class="hljs-comment">// 2. 校验评论是否存在</span>
        <span class="hljs-type">ArticleComment</span> <span class="hljs-variable">comment</span> <span class="hljs-operator">=</span> articleCommentMapper.selectArticleCommentById(commentId);
        <span class="hljs-keyword">if</span> (comment == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.NOT_FOUND, <span class="hljs-string">"评论不存在"</span>);
        }

        <span class="hljs-comment">// 3. 构建 Redis 键</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">likeKey</span> <span class="hljs-operator">=</span> RedisKeyConstants.ARTICLES_COMMENTS_LIKES_USERS_KEY + userId;
        <span class="hljs-type">String</span> <span class="hljs-variable">dislikeKey</span> <span class="hljs-operator">=</span> RedisKeyConstants.ARTICLES_COMMENTS_DISLIKES_USERS_KEY + userId;
        <span class="hljs-type">String</span> <span class="hljs-variable">statelessKey</span> <span class="hljs-operator">=</span> RedisKeyConstants.ARTICLES_COMMENTS_STATELESS_USERS_KEY + userId;
        <span class="hljs-comment">// 4. 根据投票类型处理逻辑</span>
        DefaultRedisScript&lt;Long&gt; deleteScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();
        deleteScript.setScriptSource(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceScriptSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(RedisLuaConstants.ARTICLE_COMMENTS_VOTE_LUA_SCRIPT_PATH)));
        deleteScript.setResultType(Long.class);
        <span class="hljs-type">Long</span> <span class="hljs-variable">execute</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 5. 尝试获取分布式锁</span>
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(RedisKeyConstants.ARTICLES_COMMENTS_VOTES_LOCK_KEY + userId);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            isLocked = lock.tryLock(<span class="hljs-number">0</span>, RedisKeyConstants.ARTICLES_COMMENTS_VOTES_LOCK_KEY_EXPIRE_TIME, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.SERVICE_UNAVAILABLE, <span class="hljs-string">"系统繁忙，请稍后再试"</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 获取到锁，执行投票逻辑</span>
                <span class="hljs-keyword">switch</span> (type) {
                    <span class="hljs-keyword">case</span> ArticleCommentVoteConstants.LIKE:
                        <span class="hljs-comment">// 4. 处理点赞逻辑</span>
                        execute = stringRedisTemplate.execute(deleteScript, Arrays.asList(likeKey, dislikeKey, statelessKey), commentId.toString());
                        <span class="hljs-keyword">if</span> (execute == <span class="hljs-literal">null</span>) {
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.SERVICE_UNAVAILABLE, <span class="hljs-string">"处理点踩逻辑失败"</span>);
                        }
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> ArticleCommentVoteConstants.DISLIKE:
                        <span class="hljs-comment">// 5. 处理点踩逻辑</span>
                        execute = stringRedisTemplate.execute(deleteScript, Arrays.asList(dislikeKey, likeKey, statelessKey), commentId.toString());
                        <span class="hljs-keyword">if</span> (execute == <span class="hljs-literal">null</span>) {
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.SERVICE_UNAVAILABLE, <span class="hljs-string">"处理点踩逻辑失败"</span>);
                        }
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> ArticleCommentVoteConstants.STATELESS:
                        execute = stringRedisTemplate.execute(deleteScript, Arrays.asList(statelessKey, dislikeKey, likeKey), commentId.toString());
                        <span class="hljs-keyword">if</span> (execute == <span class="hljs-literal">null</span>) {
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.ERROR, <span class="hljs-string">"处理无状态逻辑失败"</span>);
                        }
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.BAD_REQUEST, <span class="hljs-string">"未知的投票类型"</span>);
                }
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientException</span>(HttpStatus.ERROR, <span class="hljs-string">"系统繁忙，请稍后再试"</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (isLocked &amp;&amp; lock.isHeldByCurrentThread()) {
                lock.unlock();
                log.info(<span class="hljs-string">"用户 {} 的锁已释放"</span>, userId);
            }
        }
    }
</code></pre>
<h3 data-id="heading-23">定时任务</h3>
<p>定时任务要实现落库到MySQL中，并且清空redis对应的缓存</p>
<h4 data-id="heading-24">创建定时任务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoteSyncScheduler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArticleService articleService;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">VoteSyncScheduler</span><span class="hljs-params">(ArticleService articleService)</span> {
        <span class="hljs-built_in">this</span>.articleService = articleService;
    }

    <span class="hljs-meta">@Scheduled(fixedRate = 5 * 60 * 1000)</span> <span class="hljs-comment">// 每五分钟执行一次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncVote</span><span class="hljs-params">()</span> {
        log.info(<span class="hljs-string">"开始执行点赞同步任务..."</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> articleService.syncVote();
        log.info(<span class="hljs-string">"点赞同步任务执行完成。"</span>);
    }
}
</code></pre>
<h4 data-id="heading-25">syncVote实现</h4>
<p>MySQL涉及操作多张表，所以需要在方法上加上注解@Transactional</p>
<p><a href="##%E6%B5%81%E7%A8%8B%E5%9B%BE" title="##%E6%B5%81%E7%A8%8B%E5%9B%BE">参考流程图</a></p>
<ol start="0">
<li>我们首先要从redis中获取数据，并将数据封装到两个集合中。</li>
<li>落库到MySQL</li>
<li>根据x_article_comments_votes表，通过SQL语句统计出like_count, dislike_count</li>
<li>将统计出的数据更新到x_article_comments</li>
<li>清除已在该定时任务处理完的redis缓存数据</li>
</ol>
<h5 data-id="heading-26">变量说明</h5>
<ul>
<li>List votes = new ArrayList&lt;&gt;(); // 保存所有投票数据</li>
<li>Set TotalcommentId = new HashSet&lt;&gt;(); // 保存所有评论id</li>
<li>likesUserIdToCommentIdsMap、dislikesUserIdToCommentIdsMap、statelessUserIdToCommentIdsMap——存储的值为经过逻辑后键中已被处理的值，在最后一步清除redis缓存发挥作用</li>
</ul>
<h5 data-id="heading-27">从redis中获取数据，并将数据封装到两个集合中</h5>
<pre><code class="hljs language-ini" lang="ini">        Set&lt;String&gt; <span class="hljs-attr">userLikesKeys</span> = stringRedisTemplate.keys(RedisKeyConstants.ARTICLES_COMMENTS_LIKES_USERS_KEY + <span class="hljs-string">"*"</span>)<span class="hljs-comment">;</span>
        Set&lt;String&gt; <span class="hljs-attr">userDislikesKeys</span> = stringRedisTemplate.keys(RedisKeyConstants.ARTICLES_COMMENTS_DISLIKES_USERS_KEY + <span class="hljs-string">"*"</span>)<span class="hljs-comment">;</span>
        Set&lt;String&gt; <span class="hljs-attr">userStatelessKeys</span> = stringRedisTemplate.keys(RedisKeyConstants.ARTICLES_COMMENTS_STATELESS_USERS_KEY + <span class="hljs-string">"*"</span>)<span class="hljs-comment">;</span>
        if (userLikesKeys.isEmpty() &amp;&amp; userDislikesKeys.isEmpty() &amp;&amp; userStatelessKeys.isEmpty()){
            log.info("没有需要同步的数据")<span class="hljs-comment">;</span>
            return true<span class="hljs-comment">;</span>
        }
        List&lt;ArticleCommentVote&gt; <span class="hljs-attr">votes</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;      // 保存所有投票数据</span>
        Set&lt;Long&gt; <span class="hljs-attr">TotalcommentId</span> = new HashSet&lt;&gt;()<span class="hljs-comment">;     // 保存所有评论id</span>
        Map&lt;Long, Set&lt;String&gt;&gt; <span class="hljs-attr">likesUserIdToCommentIdsMap</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
        Map&lt;Long, Set&lt;String&gt;&gt; <span class="hljs-attr">dislikesUserIdToCommentIdsMap</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
        Map&lt;Long, Set&lt;String&gt;&gt; <span class="hljs-attr">statelessUserIdToCommentIdsMap</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
        for (String userLikesKey : userLikesKeys) {
            String <span class="hljs-attr">userId</span> = userLikesKey.replace(RedisKeyConstants.ARTICLES_COMMENTS_LIKES_USERS_KEY, <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
            Set&lt;String&gt; <span class="hljs-attr">commentIds</span> = stringRedisTemplate.opsForSet().members(userLikesKey)<span class="hljs-comment">;</span>
            for (String commentId : commentIds) {
                votes.add(new ArticleCommentVote(Long.parseLong(commentId), Long.parseLong(userId), ArticleCommentVoteConstants.LIKE, null, null))<span class="hljs-comment">;</span>
                TotalcommentId.add(Long.parseLong(commentId))<span class="hljs-comment">;</span>
                // 更新或新增likesUserIdToCommentIdsMap键值对，值的set集合新增commentId
                likesUserIdToCommentIdsMap.computeIfAbsent(Long.parseLong(userId), k -&gt; new HashSet&lt;&gt;()).add(commentId)<span class="hljs-comment">;</span>
            }
        }
        for (String userDislikesKey : userDislikesKeys) {
            String <span class="hljs-attr">userId</span> = userDislikesKey.replace(RedisKeyConstants.ARTICLES_COMMENTS_DISLIKES_USERS_KEY, <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
            Set&lt;String&gt; <span class="hljs-attr">commentIds</span> = stringRedisTemplate.opsForSet().members(userDislikesKey)<span class="hljs-comment">;</span>
            for (String commentId : commentIds) {
                votes.add(new ArticleCommentVote(Long.parseLong(commentId), Long.parseLong(userId), ArticleCommentVoteConstants.DISLIKE, null, null))<span class="hljs-comment">;</span>
                TotalcommentId.add(Long.parseLong(commentId))<span class="hljs-comment">;</span>
                // 更新或新增dislikesUserIdToCommentIdsMap键值对，值的set集合新增commentId
                dislikesUserIdToCommentIdsMap.computeIfAbsent(Long.parseLong(userId), k -&gt; new HashSet&lt;&gt;()).add(commentId)<span class="hljs-comment">;</span>
            }
        }
        for (String userStatelessKey : userStatelessKeys) {
            String <span class="hljs-attr">userId</span> = userStatelessKey.replace(RedisKeyConstants.ARTICLES_COMMENTS_STATELESS_USERS_KEY, <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
            Set&lt;String&gt; <span class="hljs-attr">commentIds</span> = stringRedisTemplate.opsForSet().members(userStatelessKey)<span class="hljs-comment">;</span>
            for (String commentId : commentIds) {
                votes.add(new ArticleCommentVote(Long.parseLong(commentId), Long.parseLong(userId), ArticleCommentVoteConstants.STATELESS, null, null))<span class="hljs-comment">;</span>
                TotalcommentId.add(Long.parseLong(commentId))<span class="hljs-comment">;</span>
                // 添加到statelessUserIdToCommentIdsMap键值对，值的set集合新增commentId
                statelessUserIdToCommentIdsMap.computeIfAbsent(Long.parseLong(userId), k -&gt; new HashSet&lt;&gt;()).add(commentId)<span class="hljs-comment">;</span>
            }
        }
</code></pre>
<h5 data-id="heading-28">落库到MySQL</h5>
<h6 data-id="heading-29">Service层相关代码</h6>
<pre><code class="hljs language-arduino" lang="arduino">        <span class="hljs-comment">// 根据votes执行落库逻辑（包含插入/更新）</span>
        <span class="hljs-keyword">if</span> (!votes.<span class="hljs-built_in">isEmpty</span>()){
            <span class="hljs-type">int</span> i = articleCommentVoteMapper.<span class="hljs-built_in">batchInsertOrUpdate</span>(votes);
            <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span>){
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ClientException</span>(HttpStatus.ERROR, <span class="hljs-string">"批量插入或更新数据失败"</span>);
            }
            log.<span class="hljs-built_in">info</span>(<span class="hljs-string">"批量插入或更新数据成功，数量为：{}"</span>, i);
        } <span class="hljs-keyword">else</span> {
            log.<span class="hljs-built_in">info</span>(<span class="hljs-string">"没有需要落库的数据"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
</code></pre>
<h6 data-id="heading-30">SQL语句相关实现</h6>
<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-comment">&lt;!-- 原有方法 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"batchInsertOrUpdate"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.util.List"</span>&gt;</span>
        INSERT INTO x_article_comments_votes (
            comment_id,
            user_id,
            vote,
            create_time,
            update_time
        )
        VALUES
        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"item"</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span>&gt;</span>
            (
                #{item.commentId},
                #{item.userId},
                #{item.vote},
                NOW(),
                NOW()
            )
        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
        ON DUPLICATE KEY UPDATE
            vote = VALUES(vote),
            update_time = VALUES(update_time)
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
</code></pre>
<h5 data-id="heading-31">根据x_article_comments_votes表，通过SQL语句统计出like_count, dislike_count</h5>
<h6 data-id="heading-32">Service层相关代码</h6>
<pre><code class="hljs language-ini" lang="ini">        List&lt;UpdateCommentVoteCountDTO&gt; <span class="hljs-attr">updateCommentVoteCountDTOList</span> = getCommentLikeCountAndDislikeCountByListOfCommentId(TotalcommentId)<span class="hljs-comment">;</span>
</code></pre>
<h6 data-id="heading-33">SQL语句相关实现</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span><span class="hljs-operator">!</span><span class="hljs-comment">-- 新增方法: 聚合查询点赞/点踩数量 --&gt;</span>
<span class="hljs-operator">&lt;</span><span class="hljs-keyword">select</span> id<span class="hljs-operator">=</span>"selectCommentLikeCountAndDislikeCountByListOfCommentId" resultType<span class="hljs-operator">=</span>"com.anon.spaceblogserver.modules.article.POJO.DTO.UpdateCommentVoteCountDTO"<span class="hljs-operator">&gt;</span>
    <span class="hljs-keyword">SELECT</span>
        comment_id <span class="hljs-keyword">AS</span> commentId,
        <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> vote <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> likeCount,
        <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> vote <span class="hljs-operator">=</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> dislikeCount
    <span class="hljs-keyword">FROM</span> x_article_comments_votes
    <span class="hljs-keyword">WHERE</span> comment_id <span class="hljs-keyword">IN</span>
    <span class="hljs-operator">&lt;</span>foreach collection<span class="hljs-operator">=</span>"commentIds" item<span class="hljs-operator">=</span>"commentId" <span class="hljs-keyword">open</span><span class="hljs-operator">=</span>"(" separator<span class="hljs-operator">=</span>"," <span class="hljs-keyword">close</span><span class="hljs-operator">=</span>")"<span class="hljs-operator">&gt;</span>
        #{commentId}
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>foreach<span class="hljs-operator">&gt;</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> comment_id
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span><span class="hljs-keyword">select</span><span class="hljs-operator">&gt;</span>
</code></pre>
<h5 data-id="heading-34">将统计出的数据批量更新到x_article_comments</h5>
<h6 data-id="heading-35">Service层相关代码</h6>
<pre><code class="hljs language-scss" lang="scss">int updated = <span class="hljs-built_in">batchUpdateCommentLikeCountAndDislikeCount</span>(updateCommentVoteCountDTOList, MySQLBatchSizeConstants.DEFAULT_UPDATE_BATCH_SIZE);
if (updated &lt; <span class="hljs-number">0</span>){
    throw new <span class="hljs-built_in">ClientException</span>(HttpStatus.ERROR, "批量更新数据失败");
}
log<span class="hljs-selector-class">.info</span>("批量更新数据成功，更新数量为：{}", updated);
</code></pre>
<h6 data-id="heading-36">限制单条SQL语句长度，批量更新操作具体实现</h6>
<p>因为<strong>SQL语句</strong>采用了<code>case when</code>来<strong>减少网络往返</strong>，为<strong>限制SQL语句长度防止溢出</strong>以及<strong>影响性能</strong>，采用的策略如下</p>
<p>若检测到参数updateCommentVoteCountDTOList超过指定个数，将会拆分成多条SQL语句与MySQL数据库进行交互</p>
<pre><code class="hljs language-ini" lang="ini">/**
 * 批量更新评论的点赞数和点踩数
 * @param updateCommentVoteCountDTOList     需要更新的评论点赞数和点踩数列表
 * @param batchSize                   批次大小，建议根据实际情况调整，过大可能导致单次更新过慢，过小可能导致更新次数过多
 * @return      成功更新的记录数
 */
public int batchUpdateCommentLikeCountAndDislikeCount(List&lt;UpdateCommentVoteCountDTO&gt; updateCommentVoteCountDTOList, Integer batchSize) {
    int <span class="hljs-attr">totalUpdated</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; updateCommentVoteCountDTOList.size(); i += batchSize) {</span>
        // 截取当前批次的数据
        List&lt;UpdateCommentVoteCountDTO&gt; <span class="hljs-attr">batch</span> = updateCommentVoteCountDTOList.subList(
                i,
                Math.min(i + batchSize, updateCommentVoteCountDTOList.size())
        )<span class="hljs-comment">;</span>
        // 执行当前批次的更新
        int <span class="hljs-attr">updated</span> = articleCommentMapper.batchUpdateCommentLikeCountAndDislikeCount(batch)<span class="hljs-comment">;</span>
        if (updated &lt; 0) {
            log.error("批量更新数据失败，当前批次更新数量: {}", updated)<span class="hljs-comment">;</span>
            return -1<span class="hljs-comment">;</span>
        }
        totalUpdated += updated<span class="hljs-comment">;</span>

        log.info("批量更新评论点赞/点踩数，当前批次更新数量: {}, 累计更新数量: {}", updated, totalUpdated)<span class="hljs-comment">;</span>
    }
    return totalUpdated<span class="hljs-comment">;</span>
}
</code></pre>
<h6 data-id="heading-37">SQL语句相关实现</h6>
<pre><code class="hljs language-ini" lang="ini">&lt;update <span class="hljs-attr">id</span>=<span class="hljs-string">"batchUpdateCommentLikeCountAndDislikeCount"</span>&gt;
    UPDATE x_article_comments
    SET <span class="hljs-attr">like_count</span> = CASE id
    &lt;foreach <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> item=<span class="hljs-string">"item"</span>&gt;
        WHEN <span class="hljs-comment">#{item.commentId} THEN #{item.likeCount}</span>
    &lt;/foreach&gt;
    END,
    <span class="hljs-attr">dislike_count</span> = CASE id
    &lt;foreach <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> item=<span class="hljs-string">"item"</span>&gt;
        WHEN <span class="hljs-comment">#{item.commentId} THEN #{item.dislikeCount}</span>
    &lt;/foreach&gt;
    END,
    <span class="hljs-attr">update_time</span> = NOW()
    WHERE id IN
    &lt;foreach <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> item=<span class="hljs-string">"item"</span> open=<span class="hljs-string">"("</span> separator=<span class="hljs-string">","</span> close=<span class="hljs-string">")"</span>&gt;
        <span class="hljs-comment">#{item.commentId}</span>
    &lt;/foreach&gt;
&lt;/update&gt;
</code></pre>
<h5 data-id="heading-38">清除已在该定时任务处理完的redis缓存数据</h5>
<p>前面提到的变量——likesUserIdToCommentIdsMap、dislikesUserIdToCommentIdsMap、statelessUserIdToCommentIdsMap。存储的值为经过逻辑后键中已被处理的值，在最后一步清除redis缓存发挥作用</p>
<p>上述变量类型形式为<strong>Map&lt;Long, Set&gt;</strong> ，满足了userId -&gt; 评论id集合，这可以精准且方便的清除已处理后的redis缓存数据</p>
<p>构建上述三个Map集合的过程在<a href="####%E4%BB%8Eredis%E4%B8%AD%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B9%B6%E5%B0%86%E6%95%B0%E6%8D%AE%E5%B0%81%E8%A3%85%E5%88%B0%E4%B8%A4%E4%B8%AA%E9%9B%86%E5%90%88%E4%B8%AD" title="####%E4%BB%8Eredis%E4%B8%AD%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B9%B6%E5%B0%86%E6%95%B0%E6%8D%AE%E5%B0%81%E8%A3%85%E5%88%B0%E4%B8%A4%E4%B8%AA%E9%9B%86%E5%90%88%E4%B8%AD">第一步操作</a>中经历三个for循环已经构建完毕</p>
<p>该操作同样用到<strong>lua脚本</strong>保证<strong>原子性</strong></p>
<h6 data-id="heading-39">lua脚本</h6>
<p>该脚本实现<strong>安全批量的移除</strong>key中<strong>要删除的元素列表</strong>，<strong>为什么不直接把键删除的原因</strong> -&gt; 假如在该定时任务执行过程中以及该脚本执行之前<strong>用户又发起点赞/拉踩/无状态请求</strong>，若与定时任务触发后<strong>从redis查到的用户对评论的状态相等，则会移除</strong>，这并没有什么问题，<strong>若不相等，不会移除新请求中用户设置的点赞/拉踩/无状态，留到下一次定时任务触发后处理</strong>。</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 安全批量删除，包含key存在性检查</span>
<span class="hljs-comment">-- KEYS[1]: Set的key</span>
<span class="hljs-comment">-- ARGV[1..n]: 要删除的元素列表</span>
<span class="hljs-comment">--</span>
<span class="hljs-keyword">local</span> key = KEYS[<span class="hljs-number">1</span>]
<span class="hljs-keyword">local</span> key_type = redis.call(<span class="hljs-string">'TYPE'</span>, key).ok

<span class="hljs-comment">-- 检查key是否存在且类型为set</span>
<span class="hljs-keyword">if</span> key_type == <span class="hljs-string">'none'</span> <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">elseif</span> key_type ~= <span class="hljs-string">'set'</span> <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> redis.error_reply(<span class="hljs-string">'WRONGTYPE Operation against a key holding the wrong kind of value'</span>)
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- 兼容 Lua 5.1 和 Lua 5.2+</span>
<span class="hljs-keyword">local</span> <span class="hljs-built_in">unpack</span> = <span class="hljs-built_in">unpack</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">unpack</span>

<span class="hljs-keyword">local</span> result = <span class="hljs-number">0</span>

<span class="hljs-comment">-- 如果 ARGV 不为空，则执行批量删除</span>
<span class="hljs-keyword">if</span> #ARGV &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    result = redis.call(<span class="hljs-string">'SREM'</span>, key, <span class="hljs-built_in">unpack</span>(ARGV))
<span class="hljs-keyword">end</span>

<span class="hljs-keyword">return</span> result
</code></pre>
<h6 data-id="heading-40">Service层相关代码</h6>
<pre><code class="hljs language-vbscript" lang="vbscript">// 清空Redis中的数据
DefaultRedisScript&lt;Long&gt; deleteScript = <span class="hljs-keyword">new</span> DefaultRedisScript&lt;&gt;();
deleteScript.setScriptSource(<span class="hljs-keyword">new</span> ResourceScriptSource(<span class="hljs-keyword">new</span> ClassPathResource(RedisLuaConstants.BATCH_REMOVE_MEMBERS_FROM_SET_LUA_SCRIPT_PATH)));
deleteScript.setResultType(Long.<span class="hljs-keyword">class</span>);
likesUserIdToCommentIdsMap.forEach((userId, commentIdSet) -&gt; {
    Long result = stringRedisTemplate.<span class="hljs-keyword">execute</span>(deleteScript, List.of(RedisKeyConstants.ARTICLES_COMMENTS_LIKES_USERS_KEY + userId.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>()), commentIdSet.<span class="hljs-keyword">to</span><span class="hljs-built_in">Array</span>());
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result &lt; <span class="hljs-number">0</span>){
        log.<span class="hljs-keyword">error</span>(<span class="hljs-string">"批量删除用户 {} 缓存点赞的评论失败，欲删除的commentId -&gt; {}"</span>, userId, commentIdSet);
    }
});
dislikesUserIdToCommentIdsMap.forEach((userId, commentIdSet) -&gt; {
    Long result = stringRedisTemplate.<span class="hljs-keyword">execute</span>(deleteScript, List.of(RedisKeyConstants.ARTICLES_COMMENTS_DISLIKES_USERS_KEY + userId.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>()), commentIdSet.<span class="hljs-keyword">to</span><span class="hljs-built_in">Array</span>());
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result &lt; <span class="hljs-number">0</span>){
        log.<span class="hljs-keyword">error</span>(<span class="hljs-string">"批量删除用户 {} 缓存点踩的评论失败，欲删除的commentId -&gt; {}"</span>, userId, commentIdSet);
    }
});
statelessUserIdToCommentIdsMap.forEach((userId, commentIdSet) -&gt; {
    Long result = stringRedisTemplate.<span class="hljs-keyword">execute</span>(deleteScript, List.of(RedisKeyConstants.ARTICLES_COMMENTS_STATELESS_USERS_KEY + userId.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>()), commentIdSet.<span class="hljs-keyword">to</span><span class="hljs-built_in">Array</span>());
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result &lt; <span class="hljs-number">0</span>){
        log.<span class="hljs-keyword">error</span>(<span class="hljs-string">"批量删除用户 {} 缓存无状态的评论失败，欲删除的commentId -&gt; {}"</span>, userId, commentIdSet);
    }
});
</code></pre>
<h4 data-id="heading-41">SyncVote完整代码</h4>
<pre><code class="hljs language-ini" lang="ini">@Transactional
@Override
public Boolean syncVote() {
    //TODO 发散思维，该段逻辑似乎在收藏、投币等功能有相似之处，该段之所以有点复杂是因为有三种状态————点赞、点踩、无状态，且三者之间是互斥的，但前面的收藏、投币功能没有这个问题，并且好像只有两个状态，日后可以抽象出一个通用方法来处理这类功能，减少代码重复度
    Set&lt;String&gt; <span class="hljs-attr">userLikesKeys</span> = stringRedisTemplate.keys(RedisKeyConstants.ARTICLES_COMMENTS_LIKES_USERS_KEY + <span class="hljs-string">"*"</span>)<span class="hljs-comment">;</span>
    Set&lt;String&gt; <span class="hljs-attr">userDislikesKeys</span> = stringRedisTemplate.keys(RedisKeyConstants.ARTICLES_COMMENTS_DISLIKES_USERS_KEY + <span class="hljs-string">"*"</span>)<span class="hljs-comment">;</span>
    Set&lt;String&gt; <span class="hljs-attr">userStatelessKeys</span> = stringRedisTemplate.keys(RedisKeyConstants.ARTICLES_COMMENTS_STATELESS_USERS_KEY + <span class="hljs-string">"*"</span>)<span class="hljs-comment">;</span>
    if (userLikesKeys.isEmpty() &amp;&amp; userDislikesKeys.isEmpty() &amp;&amp; userStatelessKeys.isEmpty()){
        log.info("没有需要同步的数据")<span class="hljs-comment">;</span>
        return true<span class="hljs-comment">;</span>
    }
    List&lt;ArticleCommentVote&gt; <span class="hljs-attr">votes</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;      // 保存所有投票数据</span>
    Set&lt;Long&gt; <span class="hljs-attr">TotalcommentId</span> = new HashSet&lt;&gt;()<span class="hljs-comment">;     // 保存所有评论id</span>
    Map&lt;Long, Set&lt;String&gt;&gt; <span class="hljs-attr">likesUserIdToCommentIdsMap</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
    Map&lt;Long, Set&lt;String&gt;&gt; <span class="hljs-attr">dislikesUserIdToCommentIdsMap</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
    Map&lt;Long, Set&lt;String&gt;&gt; <span class="hljs-attr">statelessUserIdToCommentIdsMap</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
    for (String userLikesKey : userLikesKeys) {
        String <span class="hljs-attr">userId</span> = userLikesKey.replace(RedisKeyConstants.ARTICLES_COMMENTS_LIKES_USERS_KEY, <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
        Set&lt;String&gt; <span class="hljs-attr">commentIds</span> = stringRedisTemplate.opsForSet().members(userLikesKey)<span class="hljs-comment">;</span>
        for (String commentId : commentIds) {
            votes.add(new ArticleCommentVote(Long.parseLong(commentId), Long.parseLong(userId), ArticleCommentVoteConstants.LIKE, null, null))<span class="hljs-comment">;</span>
            TotalcommentId.add(Long.parseLong(commentId))<span class="hljs-comment">;</span>
            // 更新或新增likesUserIdToCommentIdsMap键值对，值的set集合新增commentId
            likesUserIdToCommentIdsMap.computeIfAbsent(Long.parseLong(userId), k -&gt; new HashSet&lt;&gt;()).add(commentId)<span class="hljs-comment">;</span>
        }
    }
    for (String userDislikesKey : userDislikesKeys) {
        String <span class="hljs-attr">userId</span> = userDislikesKey.replace(RedisKeyConstants.ARTICLES_COMMENTS_DISLIKES_USERS_KEY, <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
        Set&lt;String&gt; <span class="hljs-attr">commentIds</span> = stringRedisTemplate.opsForSet().members(userDislikesKey)<span class="hljs-comment">;</span>
        for (String commentId : commentIds) {
            votes.add(new ArticleCommentVote(Long.parseLong(commentId), Long.parseLong(userId), ArticleCommentVoteConstants.DISLIKE, null, null))<span class="hljs-comment">;</span>
            TotalcommentId.add(Long.parseLong(commentId))<span class="hljs-comment">;</span>
            // 更新或新增dislikesUserIdToCommentIdsMap键值对，值的set集合新增commentId
            dislikesUserIdToCommentIdsMap.computeIfAbsent(Long.parseLong(userId), k -&gt; new HashSet&lt;&gt;()).add(commentId)<span class="hljs-comment">;</span>
        }
    }
    for (String userStatelessKey : userStatelessKeys) {
        String <span class="hljs-attr">userId</span> = userStatelessKey.replace(RedisKeyConstants.ARTICLES_COMMENTS_STATELESS_USERS_KEY, <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
        Set&lt;String&gt; <span class="hljs-attr">commentIds</span> = stringRedisTemplate.opsForSet().members(userStatelessKey)<span class="hljs-comment">;</span>
        for (String commentId : commentIds) {
            votes.add(new ArticleCommentVote(Long.parseLong(commentId), Long.parseLong(userId), ArticleCommentVoteConstants.STATELESS, null, null))<span class="hljs-comment">;</span>
            TotalcommentId.add(Long.parseLong(commentId))<span class="hljs-comment">;</span>
            // 添加到statelessUserIdToCommentIdsMap键值对，值的set集合新增commentId
            statelessUserIdToCommentIdsMap.computeIfAbsent(Long.parseLong(userId), k -&gt; new HashSet&lt;&gt;()).add(commentId)<span class="hljs-comment">;</span>
        }
    }
    // 根据votes执行落库逻辑（包含插入/更新）
    if (!votes.isEmpty()){
        int <span class="hljs-attr">i</span> = articleCommentVoteMapper.batchInsertOrUpdate(votes)<span class="hljs-comment">;</span>
        if (i &lt; 0){
            throw new ClientException(HttpStatus.ERROR, "批量插入或更新数据失败")<span class="hljs-comment">;</span>
        }
        log.info("批量插入或更新数据成功，数量为：{}", i)<span class="hljs-comment">;</span>
    } else {
        log.info("没有需要落库的数据")<span class="hljs-comment">;</span>
        return true<span class="hljs-comment">;</span>
    }
    // 根据TotalcommentId集合中的commentId，利用聚合函数获取对应表中对应评论的likeCount和dislikeCount，封装成List&lt;updateCommentVoteCountDTO&gt; updateCommentVoteCountDTOList
    List&lt;UpdateCommentVoteCountDTO&gt; <span class="hljs-attr">updateCommentVoteCountDTOList</span> = getCommentLikeCountAndDislikeCountByListOfCommentId(TotalcommentId)<span class="hljs-comment">;</span>
    // 根据updateCommentVoteCountDTOList执行批量更新的逻辑，作用的表为x_article_comments，使用case when then语法更新likeCount和dislikeCount
    int <span class="hljs-attr">updated</span> = batchUpdateCommentLikeCountAndDislikeCount(updateCommentVoteCountDTOList, MySQLBatchSizeConstants.DEFAULT_UPDATE_BATCH_SIZE)<span class="hljs-comment">;</span>
    if (updated &lt; 0){
        throw new ClientException(HttpStatus.ERROR, "批量更新数据失败")<span class="hljs-comment">;</span>
    }
    log.info("批量更新数据成功，更新数量为：{}", updated)<span class="hljs-comment">;</span>
    // 清空Redis中的数据
    DefaultRedisScript&lt;Long&gt; <span class="hljs-attr">deleteScript</span> = new DefaultRedisScript&lt;&gt;()<span class="hljs-comment">;</span>
    deleteScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(RedisLuaConstants.BATCH_REMOVE_MEMBERS_FROM_SET_LUA_SCRIPT_PATH)))<span class="hljs-comment">;</span>
    deleteScript.setResultType(Long.class)<span class="hljs-comment">;</span>
    likesUserIdToCommentIdsMap.forEach((userId, commentIdSet) -&gt; {
        Long <span class="hljs-attr">result</span> = stringRedisTemplate.execute(deleteScript, List.of(RedisKeyConstants.ARTICLES_COMMENTS_LIKES_USERS_KEY + userId.toString()), commentIdSet.toArray())<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">result</span> == null || result &lt; <span class="hljs-number">0</span>){
            log.error("批量删除用户 {} 缓存点赞的评论失败，欲删除的commentId -&gt; {}", userId, commentIdSet)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
    dislikesUserIdToCommentIdsMap.forEach((userId, commentIdSet) -&gt; {
        Long <span class="hljs-attr">result</span> = stringRedisTemplate.execute(deleteScript, List.of(RedisKeyConstants.ARTICLES_COMMENTS_DISLIKES_USERS_KEY + userId.toString()), commentIdSet.toArray())<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">result</span> == null || result &lt; <span class="hljs-number">0</span>){
            log.error("批量删除用户 {} 缓存点踩的评论失败，欲删除的commentId -&gt; {}", userId, commentIdSet)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
    statelessUserIdToCommentIdsMap.forEach((userId, commentIdSet) -&gt; {
        Long <span class="hljs-attr">result</span> = stringRedisTemplate.execute(deleteScript, List.of(RedisKeyConstants.ARTICLES_COMMENTS_STATELESS_USERS_KEY + userId.toString()), commentIdSet.toArray())<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">result</span> == null || result &lt; <span class="hljs-number">0</span>){
            log.error("批量删除用户 {} 缓存无状态的评论失败，欲删除的commentId -&gt; {}", userId, commentIdSet)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
    return true<span class="hljs-comment">;</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[N皇后问题(含位运算版本)]]></title>    <link>https://juejin.cn/post/7604775190211936266</link>    <guid>https://juejin.cn/post/7604775190211936266</guid>    <pubDate>2026-02-10T03:29:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604775190211936266" data-draft-id="7604697194795810826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="N皇后问题(含位运算版本)"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-02-10T03:29:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艺艺生辉"/> <meta itemprop="url" content="https://juejin.cn/user/1071389369728667"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            N皇后问题(含位运算版本)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1071389369728667/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艺艺生辉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:29:33.000Z" title="Tue Feb 10 2026 03:29:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">N皇后问题(含位运算版本)</h2>
<h3 data-id="heading-1">1.经典方法解决N皇后问题</h3>
<p><strong>题目</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e120d4407c364b048ed4e35344203689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im66Im655Sf6L6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771298974&amp;x-signature=PBCxwG24BlE%2BmiytH4eIph2kMGU%3D" alt="image.png" loading="lazy"/>
测试连接:<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fn-queens%2F%3FenvType%3Dstudy-plan-v2%26envId%3Dtop-100-liked" target="_blank" title="https://leetcode.cn/problems/n-queens/?envType=study-plan-v2&amp;envId=top-100-liked" ref="nofollow noopener noreferrer">leetcode.cn/problems/n-…</a><br/>
题目中:1&lt;=n&lt;=9，n的范围较小，我们可以枚举所有可能<br/>
<strong>代码:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">private</span> List&lt;List&lt;String&gt;&gt; ans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">public</span> List&lt;List&lt;String&gt;&gt; <span class="hljs-title function_">solveNQueens</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-type">int</span>[] path = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];
        f(path,<span class="hljs-number">0</span>,n);
        <span class="hljs-keyword">return</span> ans;
    }
    <span class="hljs-comment">//策略:每一行开始枚举，看每一行的棋子应该放置哪个位置</span>
    <span class="hljs-comment">//path数组:记录每一行的棋子放置的列数</span>
    <span class="hljs-comment">//cur:当前的行</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">f</span><span class="hljs-params">(<span class="hljs-type">int</span>[] path ,<span class="hljs-type">int</span> cur,<span class="hljs-type">int</span> n)</span>{
        <span class="hljs-comment">//递归终止条件</span>
        <span class="hljs-keyword">if</span>(cur == n){
            List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n;i++){
                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;n;j++){
                    <span class="hljs-keyword">if</span>(path[i]==j) sb.append(<span class="hljs-string">'Q'</span>);
                    <span class="hljs-keyword">else</span> sb.append(<span class="hljs-string">'.'</span>);
                }
                list.add(sb.toString());
            }
            ans.add(list);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">//枚举每一列，看看能不能放</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> col=<span class="hljs-number">0</span>;col&lt;n;col++){
            <span class="hljs-comment">//check函数检查</span>
            <span class="hljs-keyword">if</span>(check(path,cur,col)){
                path[cur]=col;
                f(path,cur+<span class="hljs-number">1</span>,n);
            }
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">check</span><span class="hljs-params">(<span class="hljs-type">int</span>[] path,<span class="hljs-type">int</span> row,<span class="hljs-type">int</span> col)</span>{
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;row;i++){
            <span class="hljs-comment">//这里利用斜率==1的知识，巧妙处理了两条对角线</span>
            <span class="hljs-keyword">if</span>(path[i]==col || Math.abs(row-i)==Math.abs(col-path[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

</code></pre>
<p><strong>时间复杂度:</strong> O(n!)</p>
<h3 data-id="heading-2">2.用位运算解决N皇后问题</h3>
<p><strong>题目</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20bfd3a1b4394f8cad3104888d35011a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im66Im655Sf6L6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771298974&amp;x-signature=k4j6v0%2F7jQadVlCwAf6f6N92ALo%3D" alt="image.png" loading="lazy"/>
测试链接:<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fn-queens-ii%2Fdescription%2F" target="_blank" title="https://leetcode.cn/problems/n-queens-ii/description/" ref="nofollow noopener noreferrer">leetcode.cn/problems/n-…</a><br/>
<strong>代码</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-comment">//用位运算实现递归版本</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">totalNQueens</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-comment">//比如5皇后问题,limit= ...00011111,最右边有5个1</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">limit</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span>&lt;&lt;n) -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">return</span> f2(limit,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);
    }
    <span class="hljs-comment">//col:列的限制条件，记录哪些列放置了皇后,0代表当前行可以放置，1代表不可以放置</span>
    <span class="hljs-comment">//left:右上角到左下角的限制条件，0代表当前行可以放置，1代表不可以放置</span>
    <span class="hljs-comment">//right:左上角到右下角的限制条件,0代表当前行可以放置，1代表不可以放置</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2</span><span class="hljs-params">(<span class="hljs-type">int</span> limit,<span class="hljs-type">int</span> col,<span class="hljs-type">int</span> left,<span class="hljs-type">int</span> right)</span>{
        <span class="hljs-comment">//递归终止条件</span>
        <span class="hljs-keyword">if</span>(col == limit){
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
        <span class="hljs-comment">//可以放置的位置</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">cadidate</span> <span class="hljs-operator">=</span> col | left | right;
        <span class="hljs-comment">//取反是将1变为可放置的，0变为不可放置，方便我们后面运算</span>
        <span class="hljs-comment">//&amp;limit:是去掉无用的信息</span>
        cadidate = ((~cadidate) &amp; limit);
        <span class="hljs-type">int</span> <span class="hljs-variable">ans</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span>(cadidate != <span class="hljs-number">0</span>){
            <span class="hljs-comment">//取出最右侧的1</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">choice</span> <span class="hljs-operator">=</span> cadidate &amp; (~cadidate+<span class="hljs-number">1</span>);
            <span class="hljs-comment">//更新candidate</span>
            cadidate ^= choice;
            <span class="hljs-comment">//更新下一行的条件</span>
            ans += f2(limit,col | choice,(left | choice)&lt;&lt;<span class="hljs-number">1</span> ,(right | choice) &gt;&gt;<span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">return</span> ans;
    }
}

</code></pre>
<p><strong>时间复杂度:O(n!)</strong><br/>
位运算的速度比用path数组记录更快<br/></p>
<h3 data-id="heading-3">3.声明</h3>
<p><strong>以上的代码是听了左神(b站左程云)的教学后自己写的</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[for range的使用注意事项]]></title>    <link>https://juejin.cn/post/7604701848150687744</link>    <guid>https://juejin.cn/post/7604701848150687744</guid>    <pubDate>2026-02-10T03:31:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604701848150687744" data-draft-id="7604779604124925952" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="for range的使用注意事项"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2026-02-10T03:31:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cppgo"/> <meta itemprop="url" content="https://juejin.cn/user/1924620895400932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            for range的使用注意事项
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1924620895400932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cppgo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:31:22.000Z" title="Tue Feb 10 2026 03:31:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>(一)</strong></p>
<p>1.在range中修改切片：</p>
<pre><code class="hljs language-go" lang="go"> <span class="hljs-number">1</span> n := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>}
 <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> i, e := <span class="hljs-keyword">range</span> n{
 <span class="hljs-number">3</span>         <span class="hljs-keyword">if</span> i == <span class="hljs-built_in">len</span>(n)<span class="hljs-number">-1</span> {
 <span class="hljs-number">4</span>                 n[<span class="hljs-number">0</span>] += e
 <span class="hljs-number">5</span>         } <span class="hljs-keyword">else</span> {
 <span class="hljs-number">6</span>                 n[i+<span class="hljs-number">1</span>] += e
 <span class="hljs-number">7</span>         }
 <span class="hljs-number">8</span> 
 <span class="hljs-number">9</span> }
<span class="hljs-number">10</span> fmt.Println(<span class="hljs-string">"n:"</span>, n)
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-ini" lang="ini">n: <span class="hljs-section">[22 3 6 10 15 21]</span>
</code></pre>
<p>2.在range中修改数组：</p>
<pre><code class="hljs language-go" lang="go"> <span class="hljs-number">1</span> n := [...]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>}
 <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> i, e := <span class="hljs-keyword">range</span> n{
 <span class="hljs-number">3</span>         <span class="hljs-keyword">if</span> i == <span class="hljs-built_in">len</span>(n)<span class="hljs-number">-1</span> {
 <span class="hljs-number">4</span>                 n[<span class="hljs-number">0</span>] += e
 <span class="hljs-number">5</span>         } <span class="hljs-keyword">else</span> {
 <span class="hljs-number">6</span>                 n[i+<span class="hljs-number">1</span>] += e
 <span class="hljs-number">7</span>         }
 <span class="hljs-number">8</span> 
 <span class="hljs-number">9</span> }
<span class="hljs-number">10</span> fmt.Println(<span class="hljs-string">"n:"</span>, n)
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-ini" lang="ini">n: <span class="hljs-section">[7 3 5 7 9 11]</span>
</code></pre>
<p> </p>
<p><strong><code>range</code>表达式会在<code>for</code>语句开始执行时被求值一次。求值的结果值被传递出来，是值传递（复制）。由于切片是引用类型，所以可以跟随变化。</strong></p>
<p><strong>(二)</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">str</span><span class="hljs-params">()</span></span> {
        a := <span class="hljs-string">"你好123"</span>
        <span class="hljs-keyword">for</span> i, v :=  <span class="hljs-keyword">range</span> a {
                fmt.Println(<span class="hljs-string">"i:"</span>,i, <span class="hljs-string">", v:"</span>, v)
        }
        b := []<span class="hljs-type">rune</span>(a)
        fmt.Println(<span class="hljs-string">"b:"</span>, b)

}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">i:</span> <span class="hljs-number">0</span> <span class="hljs-string">,</span> <span class="hljs-attr">v:</span> <span class="hljs-number">20320</span>
<span class="hljs-attr">i:</span> <span class="hljs-number">3</span> <span class="hljs-string">,</span> <span class="hljs-attr">v:</span> <span class="hljs-number">22909</span>
<span class="hljs-attr">i:</span> <span class="hljs-number">6</span> <span class="hljs-string">,</span> <span class="hljs-attr">v:</span> <span class="hljs-number">49</span>
<span class="hljs-attr">i:</span> <span class="hljs-number">7</span> <span class="hljs-string">,</span> <span class="hljs-attr">v:</span> <span class="hljs-number">50</span>
<span class="hljs-attr">i:</span> <span class="hljs-number">8</span> <span class="hljs-string">,</span> <span class="hljs-attr">v:</span> <span class="hljs-number">51</span>
<span class="hljs-attr">b:</span> [<span class="hljs-number">20320</span> <span class="hljs-number">22909</span> <span class="hljs-number">49</span> <span class="hljs-number">50</span> <span class="hljs-number">51</span>]
</code></pre>
<p>【迁移】<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fzxq89%2Fp%2F16658420.html" target="_blank" title="https://www.cnblogs.com/zxq89/p/16658420.html" ref="nofollow noopener noreferrer">www.cnblogs.com/zxq89/p/166…</a> posted @ 2022-09-05 15:42</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[antfu 新作：skills-npm 如何用包管理重塑 Agent Skills 生态]]></title>    <link>https://juejin.cn/post/7604666872128061459</link>    <guid>https://juejin.cn/post/7604666872128061459</guid>    <pubDate>2026-02-10T03:18:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604666872128061459" data-draft-id="7604853010162810943" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="antfu 新作：skills-npm 如何用包管理重塑 Agent Skills 生态"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-10T03:18:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="twl"/> <meta itemprop="url" content="https://juejin.cn/user/3016715635534029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            antfu 新作：skills-npm 如何用包管理重塑 Agent Skills 生态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3016715635534029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    twl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:18:02.000Z" title="Tue Feb 10 2026 03:18:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<blockquote>
<p>深度解析 Anthony Fu 的又一个「理念先行」开源作品</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、为什么需要 skills-npm？</h3>
<p>如果你正在用 Cursor、Claude Code 或 Windsurf 等 AI 编码助手，你可能已经体验过「Skills」的概念 —— 一组自定义的指令和上下文，告诉 AI 如何与你的项目协作。但当你想把这些 Skills 分享给团队、跨项目复用，甚至随工具库一起分发时，问题就来了：</p>

























<table><thead><tr><th>痛点</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>分发碎片化</strong></td><td>每个 Skill 都散落在独立 Git 仓库中，手动克隆安装</td></tr><tr><td><strong>版本不对齐</strong></td><td>工具升级了，Skill 还停留在旧版本，行为不可预测</td></tr><tr><td><strong>手动管理</strong></td><td>从安装到更新，全程手动操作</td></tr><tr><td><strong>团队同步困难</strong></td><td>新成员加入需要重新配置一遍 Skills 环境</td></tr></tbody></table>
<p>Anthony Fu（Vue/Vite 核心贡献者）的解法优雅而大胆：<strong>不要重新发明轮子，让 npm 来做它最擅长的事。</strong></p>
<p>skills-npm 的核心主张是：将 Agent Skills 内嵌到 npm 包中，利用 npm 已有的版本管理、依赖解析、lockfile 锁定和私有仓库等基础设施，让 Skills 的分发和管理变得和安装一个 npm 依赖一样简单。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装一个包含 Skills 的 npm 包</span>
npm install @slidev/cli

<span class="hljs-comment"># 运行 skills-npm，自动发现并链接 Skills</span>
npx skills-npm
</code></pre>
<p>就这么简单。<code>.cursor/skills/</code> 下自动出现了 <code>npm-slidev-cli-presenter-mode</code> — 一个符号链接，指向刚安装的 npm 包中的 Skill 目录。</p>
<hr/>
<h3 data-id="heading-2">二、约定优于配置：一切始于 <code>skills/*/SKILL.md</code></h3>
<p>skills-npm 的分发协议极其简洁。如果你是工具库作者，想随包附带 Agent Skills，只需要在你的 npm 包中按如下结构组织：</p>
<pre><code class="hljs language-css" lang="css">your-awesome-lib/
├── <span class="hljs-attribute">src</span>/
├── package<span class="hljs-selector-class">.json</span>
└── skills/
    ├── debug-helper/
    │   └── SKILL<span class="hljs-selector-class">.md</span>
    └── <span class="hljs-selector-tag">code</span>-generation/
        └── SKILL<span class="hljs-selector-class">.md</span>
</code></pre>
<p>每个 <code>SKILL.md</code> 需要包含 YAML frontmatter 来声明元信息：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">debug-helper</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">帮助</span> <span class="hljs-string">AI</span> <span class="hljs-string">代理理解项目的调试约定</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">在调试本项目时，请遵循以下规范...</span>
</code></pre>
<p>这就是全部的「协议」。没有 JSON Schema，没有注册中心，没有额外的构建步骤 —— <strong>约定优于配置的极致实践。</strong></p>
<p>skills-npm 会使用 <code>gray-matter</code> 库解析 frontmatter，并验证 <code>name</code> 和 <code>description</code> 字段的存在性。不符合规范的 Skill 会被标记为无效并在终端中报告，但不会中断整个流程。</p>
<hr/>
<h3 data-id="heading-3">三、架构剖析：一个精简的 ETL 管道</h3>
<p>整个 skills-npm 的核心代码仅约 <strong>1,400 行</strong>，却实现了完整的 CLI 工具链。它采用了经典的 <strong>ETL（Extract-Transform-Load）管道架构</strong>：</p>
<pre><code class="hljs">配置加载 → 技能扫描 → 过滤处理 → Agent 检测 → 符号链接创建 → .gitignore 更新
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[CLI 入口&lt;br/&gt;cac] --&gt; B[配置解析&lt;br/&gt;unconfig]
    B --&gt; C[Skills 扫描&lt;br/&gt;scan.ts]
    C --&gt; D[Include/Exclude&lt;br/&gt;过滤]
    D --&gt; E[Agent 检测]
    E --&gt; F[用户确认&lt;br/&gt;@clack/prompts]
    F --&gt; G[符号链接&lt;br/&gt;symlink.ts]
    G --&gt; H[.gitignore&lt;br/&gt;更新]
    
    C -.-&gt; J[缓存层&lt;br/&gt;cache.ts]
    J -.-&gt; C
</code></pre>
<p>每个环节对应一个独立模块，职责单一、边界清晰。让我们逐一拆解。</p>
<h4 data-id="heading-4">3.1 Extract — 技能扫描引擎</h4>
<p>扫描引擎（<code>scan.ts</code>）是整个工具的核心，支持两种扫描策略：</p>
<p><strong>策略一：<code>node_modules</code> 全扫描</strong></p>
<p>遍历整个 <code>node_modules</code> 目录，检查每个包是否包含 <code>skills/</code> 子目录。这种方式覆盖面广，能发现所有层级的 Skills，包括间接依赖中的 Skills。</p>
<p><strong>策略二：<code>package.json</code> 精准扫描</strong></p>
<p>只检查 <code>dependencies</code> 和 <code>devDependencies</code> 中显式声明的直接依赖。更快、更精准，适合大型项目。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">scanCurrentNodeModules</span>(<span class="hljs-params">
  cwd: <span class="hljs-built_in">string</span>, 
  source: ScanOptions[<span class="hljs-string">'source'</span>] = <span class="hljs-string">'node_modules'</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ScanResult</span>&gt; {
  <span class="hljs-comment">// 根据策略决定扫描范围</span>
  <span class="hljs-keyword">const</span> packageNames = source === <span class="hljs-string">'package.json'</span> 
    ? <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPackageDeps</span>(cwd) 
    : <span class="hljs-literal">null</span>

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">name</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'@'</span>)) {
      <span class="hljs-comment">// 处理作用域包：进入 @org/ 二级目录继续扫描</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">scanPackageForSkills</span>(entry)
    }
  }
}
</code></pre>
<p>一个值得注意的细节：扫描时使用 <code>isDirectoryOrSymlink()</code> 而非简单的 <code>isDirectory()</code> 检查，这是对 <strong>pnpm 符号链接结构的专门适配</strong>。pnpm 为了节省磁盘空间，在 <code>node_modules</code> 中使用符号链接指向全局存储，如果只检查目录类型会遗漏所有包。</p>
<p>对于 <strong>Monorepo 场景</strong>，skills-npm 提供 <code>--recursive</code> 参数，通过解析 <code>pnpm-workspace.yaml</code> 或 <code>package.json</code> 的 <code>workspaces</code> 字段，找到所有子包并独立扫描，使用 Map 按包名去重。</p>
<h4 data-id="heading-5">3.2 Transform — 过滤系统</h4>
<p>过滤系统（<code>utils/skills.ts</code>）支持两种粒度的控制：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 包级别过滤：匹配整个包的所有 Skills</span>
<span class="hljs-attr">include</span>: [<span class="hljs-string">'@slidev/cli'</span>]

<span class="hljs-comment">// 技能级别过滤：精确到特定包的特定 Skill</span>
<span class="hljs-attr">exclude</span>: [{ <span class="hljs-attr">package</span>: <span class="hljs-string">'@some/lib'</span>, <span class="hljs-attr">skills</span>: [<span class="hljs-string">'deprecated-skill'</span>] }]
</code></pre>
<p>过滤使用经典的白名单 + 黑名单模式：先通过 <code>include</code> 筛选出想要的，再通过 <code>exclude</code> 排除不需要的。</p>
<h4 data-id="heading-6">3.3 Load — 符号链接引擎</h4>
<p>符号链接创建（<code>symlink.ts</code>）是最体现工程素养的模块。126 行代码中，边界处理堪称教科书级别：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createSymlink</span>(<span class="hljs-params">target: <span class="hljs-built_in">string</span>, linkPath: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 幂等性：目标路径相同 → 直接跳过</span>
  <span class="hljs-keyword">if</span> (resolvedTarget === resolvedLinkPath) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

  <span class="hljs-comment">// 2. 已有链接处理：</span>
  <span class="hljs-comment">//    - 符号链接已指向正确目标 → 跳过</span>
  <span class="hljs-comment">//    - 符号链接指向错误目标 → 删除后重建</span>
  <span class="hljs-comment">//    - 非符号链接文件占位 → 递归删除后重建</span>

  <span class="hljs-comment">// 3. 循环引用防护：捕获 ELOOP 错误并强制清除</span>

  <span class="hljs-comment">// 4. 跨平台兼容：Windows 使用 junction 类型</span>
  <span class="hljs-keyword">const</span> symlinkType = <span class="hljs-title function_">platform</span>() === <span class="hljs-string">'win32'</span> ? <span class="hljs-string">'junction'</span> : <span class="hljs-literal">undefined</span>

  <span class="hljs-comment">// 5. 使用相对路径：项目移动后链接依然有效</span>
  <span class="hljs-keyword">const</span> relativePath = <span class="hljs-title function_">relative</span>(linkDir, target)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">symlink</span>(relativePath, linkPath, symlinkType)
}
</code></pre>
<p><strong>为什么用相对路径而不是绝对路径？</strong> 考虑一个场景：你在 CI 环境中 clone 项目到 <code>/home/runner/project</code>，本地开发在 <code>/Users/you/project</code>。如果使用绝对路径创建符号链接，链接在不同机器上会失效。相对路径确保了项目目录可以整体移动或在不同路径下使用，符号链接始终有效。</p>
<p><strong>命名规则</strong> 使用 <code>npm-{sanitized-package}-{skill-name}</code> 的格式：</p>
<pre><code class="hljs language-perl" lang="perl">@slidev/cli 的 presenter-mode → npm-slidev-cli-presenter-mode
<span class="hljs-keyword">my</span>-lib 的 debug-helper       → npm-<span class="hljs-keyword">my</span>-lib-debug-helper
</code></pre>
<p><code>npm-</code> 前缀让用户一眼就能区分来自 npm 的 Skill 和手动创建的 Skill。</p>
<hr/>
<h3 data-id="heading-7">四、缓存：小而精的性能优化</h3>
<p>在大型项目中，<code>node_modules</code> 可能包含数千个包。每次运行都全量扫描显然不切实际。skills-npm 的缓存策略（<code>cache.ts</code>，58 行）巧妙而实用：</p>
<p><strong>核心思路：lockfile 不变 = 依赖不变 = 扫描结果不变。</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPackageManagerLockFileHash</span>(<span class="hljs-params">cwd: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 按优先级尝试：bun.lockb → pnpm-lock.yaml → yarn.lock → package-lock.json</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> <span class="hljs-variable constant_">LOCK_FILES</span>.<span class="hljs-property">all</span>) {
    <span class="hljs-keyword">const</span> encoding = <span class="hljs-title function_">isBinaryLockFile</span>(file) ? <span class="hljs-literal">undefined</span> : <span class="hljs-string">'utf-8'</span>
    <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-title function_">join</span>(cwd, file), encoding)
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">hash</span>: <span class="hljs-title function_">createHash</span>(<span class="hljs-string">'md5'</span>).<span class="hljs-title function_">update</span>(content).<span class="hljs-title function_">digest</span>(<span class="hljs-string">'hex'</span>),
      <span class="hljs-attr">path</span>: file,
    }
  }
}
</code></pre>
<p>缓存存储在 <code>node_modules/.skills-npm/cache.json</code>。这个路径的选择也值得玩味 —— 当你执行 <code>rm -rf node_modules</code> 重装依赖时，旧缓存自动消失，新一次扫描会重建缓存。缓存的清理和 <code>node_modules</code> 的生命周期自然对齐，不需要额外的清理机制。</p>
<hr/>
<h3 data-id="heading-8">五、配置系统：三层覆盖 + TypeScript 原生支持</h3>
<p>skills-npm 提供三层配置合并机制，遵循「最近原则」：</p>
<pre><code class="hljs language-arduino" lang="arduino">默认配置 &lt; skills-npm.config.ts &lt; CLI 参数
</code></pre>
<p>配置文件使用 Anthony Fu 自己维护的 <code>unconfig</code> 库加载，原生支持 TypeScript 格式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// skills-npm.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'skills-npm'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">source</span>: <span class="hljs-string">'package.json'</span>,      <span class="hljs-comment">// 只扫描直接依赖</span>
  <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>,             <span class="hljs-comment">// 递归扫描 Monorepo</span>
  <span class="hljs-attr">include</span>: [<span class="hljs-string">'@slidev/*'</span>],      <span class="hljs-comment">// 只安装 Slidev 相关的 Skills</span>
  <span class="hljs-attr">exclude</span>: [{ <span class="hljs-attr">package</span>: <span class="hljs-string">'@some/lib'</span>, <span class="hljs-attr">skills</span>: [<span class="hljs-string">'experimental'</span>] }],
  <span class="hljs-attr">confirm</span>: <span class="hljs-literal">false</span>,              <span class="hljs-comment">// 跳过确认提示（CI 环境）</span>
})
</code></pre>
<p><code>defineConfig</code> 是一个经典的 identity 函数，唯一的作用是提供 TypeScript 类型推导，让你在写配置时获得完整的自动补全。</p>
<hr/>
<h3 data-id="heading-9">六、终端体验：TTY 感知的双模式输出</h3>
<p>skills-npm 的终端体验做了精细的环境适配（<code>printer.ts</code>）：</p>
<p><strong>TTY 模式</strong>（交互式终端）：使用 <code>@clack/prompts</code> 提供交互式体验，包括渐变灰色的 ASCII Art Logo、spinner 进度动画、彩色技能列表（<code>picocolors</code>）、以及确认/多选提示。</p>
<p><strong>非 TTY 模式</strong>（CI/CD 管道）：自动降级为纯文本输出，无 ANSI 颜色码，无交互式提示，确保在日志系统中可读。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (isTTY) {
  p.<span class="hljs-property">log</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Discovered skills:'</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  <span class="hljs-subst">${c.green(<span class="hljs-string">'●'</span>)}</span> <span class="hljs-subst">${c.bold(skill.name)}</span> <span class="hljs-subst">${c.dim(<span class="hljs-string">`from <span class="hljs-subst">${pkg}</span>`</span>)}</span>`</span>)
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  - <span class="hljs-subst">${skill.name}</span> (<span class="hljs-subst">${pkg}</span>)`</span>)
}
</code></pre>
<p>这种双模式设计保证了一个命令在本地开发和 CI/CD 环境中都表现良好，是优秀 CLI 工具的标准实践。</p>
<hr/>
<h3 data-id="heading-10">七、Vendor 子模块：站在巨人肩膀上</h3>
<p>skills-npm 通过 Git submodule 引入了 <code>vercel-labs/skills</code> 作为 vendor 依赖。这个子模块提供了 Agent 类型定义（<code>AgentType</code>、<code>AgentConfig</code>）和 Agent 检测逻辑（<code>detectInstalledAgents()</code>）。</p>
<p>构建时通过 tsdown 的 <code>noExternal: [/vendor\/skills/]</code> 配置将 vendor 代码内联打包到最终产物中，实现了：</p>
<ul>
<li><strong>类型共享</strong>：复用上游标准类型而非自己定义</li>
<li><strong>检测逻辑复用</strong>：不重复实现 Agent 特定目录的检测</li>
<li><strong>版本可控</strong>：通过 submodule 的 commit hash 精确锁定上游版本</li>
</ul>
<p>这是一种「<strong>编译时依赖，运行时零依赖</strong>」的策略 —— 用户不需要安装 <code>vercel-labs/skills</code>，但 skills-npm 的代码中包含了它的逻辑。</p>
<hr/>
<h3 data-id="heading-11">八、工作区检测：移植自 Vite 的成熟实践</h3>
<p>工作区根目录的检测（<code>utils/workspace.ts</code>）直接移植自 Vite 的源码，通过递归向上搜索来定位 Monorepo 根目录：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ROOT_FILES</span> = [<span class="hljs-string">'pnpm-workspace.yaml'</span>, <span class="hljs-string">'lerna.json'</span>]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchForWorkspaceRoot</span>(<span class="hljs-params">current: <span class="hljs-built_in">string</span>, root: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasRootFile</span>(current)) <span class="hljs-keyword">return</span> current              <span class="hljs-comment">// 找到标志文件</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasWorkspacePackageJSON</span>(current)) <span class="hljs-keyword">return</span> current  <span class="hljs-comment">// package.json 有 workspaces</span>
  <span class="hljs-keyword">const</span> dir = <span class="hljs-title function_">dirname</span>(current)
  <span class="hljs-keyword">if</span> (!dir || dir === current) <span class="hljs-keyword">return</span> root              <span class="hljs-comment">// 到达文件系统根</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">searchForWorkspaceRoot</span>(dir, root)              <span class="hljs-comment">// 继续向上</span>
}
</code></pre>
<p>这种「向上探测」的模式在 Node.js 工具链中非常常见（ESLint、Prettier 也是类似策略），skills-npm 选择复用 Vite 经过大规模验证的实现，是明智的工程决策。</p>
<hr/>
<h3 data-id="heading-12">九、设计精华与技术创新</h3>
<p>回顾整个项目，有几个设计决策值得特别关注：</p>
<h4 data-id="heading-13">9.1 理念创新：基础设施复用</h4>
<p>skills-npm 没有构建新的分发渠道、注册中心或版本管理系统。它的创新在于 <strong>认知层面</strong> —— 将 Agent Skills 的分发问题映射到已有的 npm 生态上。npm 的版本语义化、lockfile 锁定、私有仓库、CI/CD 集成、Monorepo 支持……这些经过十多年打磨的基础设施，skills-npm 全部白嫖。</p>
<h4 data-id="heading-14">9.2 幂等设计：<code>prepare</code> 脚本友好</h4>
<p>skills-npm 被设计为可以安全地放入 <code>package.json</code> 的 <code>prepare</code> 脚本中：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"skills-npm --yes"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>每次 <code>npm install</code> 后自动执行。幂等性确保了重复运行不会产生副作用，缓存机制避免了不必要的扫描开销。</p>
<h4 data-id="heading-15">9.3 模块化极致</h4>
<p>14 个源文件，平均每个文件不超过 100 行。每个文件的命名就是它的职责：<code>scan.ts</code> 只做扫描，<code>symlink.ts</code> 只做链接，<code>cache.ts</code> 只做缓存。类型定义集中在 <code>types.ts</code>，常量集中在 <code>constants.ts</code>。这种极致的关注点分离让代码的可维护性和可测试性都达到了很高的水平。</p>
<hr/>
<h3 data-id="heading-16">十、改进空间与未来展望</h3>
<p>作为 v0.1.0 阶段的项目，skills-npm 仍有不少进化空间：</p>








































<table><thead><tr><th>方面</th><th>现状</th><th>潜在改进</th></tr></thead><tbody><tr><td><strong>扫描性能</strong></td><td>包逐个串行扫描</td><td>使用 <code>Promise.all</code> 或 <code>p-limit</code> 并行扫描</td></tr><tr><td><strong>错误恢复</strong></td><td>大量 catch 块静默忽略</td><td>增加 <code>--verbose</code> 模式暴露调试信息</td></tr><tr><td><strong>缓存粒度</strong></td><td>lockfile 级别（任何依赖变化都失效）</td><td>可按包级别做增量缓存</td></tr><tr><td><strong>链接清理</strong></td><td>无自动清理功能</td><td>增加 <code>--clean</code> 命令清除失效链接</td></tr><tr><td><strong>实时更新</strong></td><td>无 watch 模式</td><td>监听 <code>node_modules</code> 变化自动更新</td></tr><tr><td><strong>嵌套发现</strong></td><td>不扫描嵌套 <code>node_modules</code></td><td>适配非 hoisted 模式的包管理策略</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">十一、总结</h3>
<p>skills-npm 是一个典型的「小工具，大理念」项目。1,400 行代码背后，是对 AI Agent 工具链生态的深刻观察：Skills 的分发不需要新的基础设施，npm 已经准备好了一切。</p>
<p>从技术实现来看，项目的代码质量极高：TypeScript 类型系统运用规范、模块职责划分清晰、边界处理（符号链接的幂等性、ELOOP 防护、Windows 兼容）无可挑剔。技术栈选型也体现了 Anthony Fu 一贯的品味 —— <code>cac</code>、<code>picocolors</code>、<code>unconfig</code>、<code>tsdown</code> —— 每一个都是轻量级、无依赖的精品工具。</p>
<p>在 AI 编码助手快速普及的今天，skills-npm 很可能成为 Agent Skills 分发领域的事实标准。毕竟，<strong>最好的基础设施，是让你感觉不到它存在的基础设施。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如果 JavaScript 和 TypeScript 是人，他们会怎么谈恋爱？]]></title>    <link>https://juejin.cn/post/7604786493639442459</link>    <guid>https://juejin.cn/post/7604786493639442459</guid>    <pubDate>2026-02-10T03:50:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604786493639442459" data-draft-id="7604694326519119923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如果 JavaScript 和 TypeScript 是人，他们会怎么谈恋爱？"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-02-10T03:50:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小崔日记"/> <meta itemprop="url" content="https://juejin.cn/user/1576048754165866"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如果 JavaScript 和 TypeScript 是人，他们会怎么谈恋爱？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1576048754165866/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小崔日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:50:28.000Z" title="Tue Feb 10 2026 03:50:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">当JavaScript和TypeScript在咖啡店相亲：一场关于"类型"的爱情喜剧</h2>
<h3 data-id="heading-1">简介：两个程序员相亲记</h3>
<p>想象一下，你走进一家名为"代码咖啡"的奇怪咖啡馆。角落里坐着两位正在相亲的程序员：JavaScript（简称JS），穿着随意T恤，头发乱糟糟，看起来有点漫不经心；TypeScript（简称TS），西装革履，戴着金丝眼镜，面前整齐摆放着一份清单和一支笔。</p>
<p>JS喝了口咖啡："嗨，我是个灵活的单身汉，随时可以变成任何你想要的样子！"</p>
<p>TS推了推眼镜："很高兴认识你。在我考虑进一步发展前，请先填写这份类型声明表，包括你的姓名（字符串）、年龄（数字），以及是否有过变量重定义的经历（布尔值）。"</p>
<p>这，就是故事的开端。</p>
<h3 data-id="heading-2">区别与联系：一场代码约会实录</h3>
<h4 data-id="heading-3">第一幕：点单风波</h4>
<p>JS看了一眼菜单："我要一杯'随便'。"</p>
<p>服务员困惑："'随便'是什么？"</p>
<p>JS眨眨眼："运行时你就知道了！可能是咖啡，也可能是茶，甚至可能是果汁——惊喜不是更美妙吗？"</p>
<p>TS叹了口气："请给我一杯无糖拿铁，温度70±2℃，咖啡豆产地哥伦比亚，牛奶脂肪含量3.5%。这是我的详细订单接口声明。"</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// JS的点单方式</span>
<span class="hljs-keyword">let</span> myDrink = <span class="hljs-string">"coffee"</span>;
myDrink = <span class="hljs-number">42</span>; <span class="hljs-comment">// 现在变成数字了！</span>
myDrink = { <span class="hljs-attr">beverage</span>: <span class="hljs-string">"tea"</span>, <span class="hljs-attr">temp</span>: <span class="hljs-string">"hot"</span> }; <span class="hljs-comment">// 又变成对象了！</span>
<span class="hljs-comment">// 一切发生在运行时，像魔术一样！</span>

<span class="hljs-comment">// TS的点单方式</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoffeeOrder</span> {
  <span class="hljs-attr">beverageType</span>: <span class="hljs-string">"latte"</span> | <span class="hljs-string">"espresso"</span> | <span class="hljs-string">"cappuccino"</span>;
  <span class="hljs-attr">temperature</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">sugar</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">milkPercentage</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">myOrder</span>: <span class="hljs-title class_">CoffeeOrder</span> = {
  <span class="hljs-attr">beverageType</span>: <span class="hljs-string">"latte"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">70</span>,
  <span class="hljs-attr">sugar</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">milkPercentage</span>: <span class="hljs-number">100</span>
};
<span class="hljs-comment">// 试图把water赋值给beverageType？编辑器会立即红线下划线警告！</span>
</code></pre>
<h4 data-id="heading-4">第二幕：约会中的"惊喜"</h4>
<p>JS和TS决定去看电影。</p>
<p>JS说："我知道一家很棒的影院，走！"</p>
<p>到了地方，TS愣住了："这是保龄球馆。"</p>
<p>JS挠头："啊，我以为'娱乐场所'都差不多。不过没关系！我们可以现场决定做什么！"</p>
<p>TS从包里拿出计划表："根据我预先的类型检查，我们应该在第15街的影院，观看类型为'喜剧片'或'科幻片'的电影，时长不超过150分钟。"</p>
<h4 data-id="heading-5">第三幕：见朋友时的尴尬</h4>
<p>JS带着TS见朋友Python和Java。</p>
<p>JS大声介绍："这是TS，我的...呃...朋友？同事？工具？反正我们一起写代码！"</p>
<p>Python小声说："所以你们的关系类型是'any'？"</p>
<p>Java点头："需要我来强制转换一下关系类型吗？"</p>
<p>TS平静地说："确切地说，我们是渐进式类型系统的伙伴关系。我是JS的超集，在开发阶段提供类型安全，但最终会编译成纯JS运行。"</p>
<p>全场沉默三秒。</p>
<p>JS打破尴尬："他说的是'我们很配'的意思啦！就像JSON和对象字面量那么配！"</p>
<h3 data-id="heading-6">联系：他们其实是亲戚！</h3>
<p>事实上，TS悄悄对JS说："有件事得告诉你——我其实就是你，只是多了些'规矩'。"</p>
<p>JS惊讶："什么？"</p>
<p>TS解释："咱们本质上是一家人。你写的所有代码，我都能理解。而我的代码，最终都会变成你的样子运行。我是你的'开发时保镖'，确保你不会在运行时摔跤。"</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// TS写的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name: string</span>): string {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
}

<span class="hljs-comment">// 编译后会变成JS认识的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + name + <span class="hljs-string">"!"</span>;
}
<span class="hljs-comment">// 看，我们骨子里是一样的！</span>
</code></pre>
<h4 data-id="heading-7">那个决定性的拥抱</h4>
<p>项目截止前夜，JS的代码突然在凌晨3点崩溃。</p>
<p>JS绝望地发现：一个应该是数组的变量不知何时变成了字符串，整个应用像多米诺骨牌一样倒下。</p>
<p>这时TS出现了，带着清晰的错误信息："第247行：类型'string'上不存在属性'map'。建议：确保变量在此处为数组类型。"</p>
<p>JS修复了bug，看着TS："你一直都知道这里会出问题？"</p>
<p>TS点头："从你写下代码的那一刻就知道。但你有'any'的权力，我只能建议，不能强制。"</p>
<p>JS沉思："也许...有时候惊喜不如稳定来得重要？"</p>
<h3 data-id="heading-8">总结：不是取代，而是进化</h3>
<p>所以，JavaScript和TypeScript到底是什么关系？</p>
<h4 data-id="heading-9">1. <strong>艺术家 vs 建筑师</strong></h4>
<ul>
<li>JS是即兴创作的街头艺术家</li>
<li>TS是带着蓝图的建筑师</li>
<li>两者都能造出房子，但一个可能造出梦幻树屋，另一个则确保房子符合安全规范</li>
</ul>
<h4 data-id="heading-10">2. <strong>"先做后想" vs "先想后做"</strong></h4>
<ul>
<li>JS喜欢快速原型</li>
<li>TS喜欢提前规划</li>
<li>大型项目常常需要两者结合——用TS搭建稳固框架，用JS快速试验新想法</li>
</ul>
<h4 data-id="heading-11">3. <strong>最终都是一家人</strong></h4>
<ul>
<li>所有TS代码最终都会"变身"为JS运行</li>
<li>TS就像是JS的"训练轮"，等你熟悉了类型系统，甚至可以逐渐拆除</li>
</ul>
<h4 data-id="heading-12">4. <strong>幽默的真相</strong></h4>
<ul>
<li>使用JS就像在说"相信我，我知道我在做什么"</li>
<li>使用TS则像在说"我不完全相信自己，所以让编译器双重检查一下"</li>
</ul>
<p>最终，JS和TS在代码咖啡店达成了和解。JS学会了偶尔接受类型建议，TS学会了容忍一些"any"的灵活性。他们共同创建了一个项目：一个在开发阶段严格类型检查，但在某些小模块保留JS灵活性的混合应用。</p>
<p>就像咖啡店老板说的："纯黑咖啡提神，加奶加糖好入口。关键是知道自己什么时候需要什么。"</p>
<p>而角落里，一个新来的语言叫Rust正在点单："我要一杯绝对内存安全的饮料，所有权明确，零成本抽象..."</p>
<p>但那是另一个故事了。</p>
<hr/>
<h3 data-id="heading-13">附录：快速对比表</h3>








































<table><thead><tr><th>特性</th><th>JavaScript</th><th>TypeScript</th></tr></thead><tbody><tr><td>类型系统</td><td>动态类型</td><td>静态类型（可选的）</td></tr><tr><td>错误发现时间</td><td>运行时</td><td>编译时</td></tr><tr><td>学习曲线</td><td>相对平缓</td><td>需要额外学习类型系统</td></tr><tr><td>灵活性</td><td>极高</td><td>高，但有约束</td></tr><tr><td>适合项目</td><td>小型项目、原型、脚本</td><td>大型项目、团队协作、长期维护</td></tr><tr><td>流行框架</td><td>React、Vue、Node.js</td><td>Angular、React+TS、Vue+TS</td></tr></tbody></table>
<hr/>
<p><strong>后记</strong>：无论你选择JS的灵活还是TS的严谨，记住最好的代码不是最聪明的，而是六个月后你（或同事）还能看懂的那一些。毕竟，在编程世界里，能让你少熬夜的技术，才是真爱的技术。</p>
<hr/>
<p><em>文章字数：约1200字</em><br/>
<em>建议阅读时间：5-7分钟</em><br/>
<em>技术难度：初级到中级</em><br/>
<em>幽默指数：☕☕☕☕ (4/5杯咖啡)</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Koin 依赖注入深度解析：Single、Factory 与 Scoped 到底怎么选？]]></title>    <link>https://juejin.cn/post/7604666872128077843</link>    <guid>https://juejin.cn/post/7604666872128077843</guid>    <pubDate>2026-02-10T03:22:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604666872128077843" data-draft-id="7604693038440136710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Koin 依赖注入深度解析：Single、Factory 与 Scoped 到底怎么选？"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-02-10T03:22:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Ehtan_Zheng"/> <meta itemprop="url" content="https://juejin.cn/user/413072099642478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Koin 依赖注入深度解析：Single、Factory 与 Scoped 到底怎么选？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/413072099642478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Ehtan_Zheng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:22:49.000Z" title="Tue Feb 10 2026 03:22:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 的世界里，Koin 以其“无反射、极简 DSL”的特性让开发者倍感幸福。但要用好 Koin，理解其三大核心定义类型：<strong><code>single</code></strong>、<strong><code>factory</code></strong> 与 <strong><code>scoped</code></strong> 是必修课。</p>
<hr/>
<h2 data-id="heading-0">一、 <code>single</code>：全局唯一的单例 (Singleton)</h2>
<p><code>single</code> 是 Koin 中最常用的定义方式。</p>
<ul>
<li>
<p><strong>本质</strong>：在整个 Koin 容器的生命周期内（通常是应用的生命周期），该定义的实例只会被创建<strong>一次</strong>。后续所有的注入请求都会返回同一个对象。</p>
</li>
<li>
<p><strong>生命周期</strong>：与应用进程共存亡。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li><strong>Repository 层</strong>：数据仓库通常不需要重复创建。</li>
<li><strong>网络模块</strong>：如 Retrofit 实例、OkHttpClient。</li>
<li><strong>本地数据库</strong>：如 Room 数据库实例。</li>
</ul>
</li>
</ul>
<p><strong>代码示例：</strong></p>
<p>Kotlin</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">val</span> <span class="hljs-variable">appModule</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">module</span> {
    <span class="hljs-comment">// 整个应用运行期间，只有一个 UserRepository 实例</span>
    single { UserRepository(get()) }
}
</code></pre>
<hr/>
<h2 data-id="heading-1">二、 <code>factory</code>：按需创建的工厂 (Factory)</h2>
<p>与 <code>single</code> 相反，<code>factory</code> 每次都会给你提供一个“全新的”对象。</p>
<ul>
<li>
<p><strong>本质</strong>：每次进行注入（通过 <code>inject()</code> 或 <code>get()</code>）时，Koin 都会执行一次代码块，创建一个<strong>新的实例</strong>。</p>
</li>
<li>
<p><strong>生命周期</strong>：Koin 不负责保存这个实例，它的生命周期由调用者决定（例如被赋值给某个局部变量）。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li><strong>临时的 UI 逻辑类</strong>：不需要持久化状态的小工具。</li>
<li><strong>具有状态的对象</strong>：你不希望不同页面共享同一个状态的对象。</li>
</ul>
</li>
</ul>
<p><strong>代码示例：</strong></p>
<p>Kotlin</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">val</span> <span class="hljs-variable">appModule</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">module</span> {
    <span class="hljs-comment">// 每次注入都会创建一个新的 Presenter 实例</span>
    factory { UserPresenter(get()) }
}
</code></pre>
<hr/>
<h2 data-id="heading-2">三、 <code>scoped</code>：受控的作用域 (Scoped)</h2>
<p>这是 Koin 中最强大但也最容易被误解的部分。它介于 <code>single</code> 和 <code>factory</code> 之间。</p>
<ul>
<li>
<p><strong>本质</strong>：实例在一个特定的**作用域（Scope）**内是唯一的。当作用域开启时创建，当作用域关闭（如 Activity 销毁）时，该实例也会随之销毁。</p>
</li>
<li>
<p><strong>生命周期</strong>：绑定到特定的组件生命周期。</p>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li><strong>分步表单/向导界面</strong>：在 3 个 Fragment 之间共享数据，但一旦退出该流程，数据应立即清除。</li>
<li><strong>Activity 专有数据</strong>：只在某个特定页面及其内部子组件中共享。</li>
</ul>
</li>
</ul>
<p><strong>代码示例：</strong></p>
<p>Kotlin</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">val</span> <span class="hljs-variable">appModule</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">module</span> {
    <span class="hljs-comment">// 定义一个作用域</span>
    scope&lt;MyActivity&gt; {
        <span class="hljs-comment">// 在 MyActivity 的生命周期内，该实例是单例</span>
        scoped { UserSession() }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-3">四、 核心差异对比表</h2>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>single</strong></th><th><strong>factory</strong></th><th><strong>scoped</strong></th></tr></thead><tbody><tr><td><strong>实例数量</strong></td><td>全局只有一个</td><td>每次请求都有一个新实例</td><td>作用域内唯一</td></tr><tr><td><strong>内存占用</strong></td><td>持续占用，直到应用关闭</td><td>瞬时占用，随用随关</td><td>随作用域生命周期释放</td></tr><tr><td><strong>实例共享</strong></td><td>全局共享</td><td>不共享</td><td>仅在当前作用域内共享</td></tr><tr><td><strong>推荐用途</strong></td><td>数据库、API 客户端、Repo</td><td>工具类、瞬时数据处理</td><td>页面私有逻辑、分步任务流</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">五、 避坑与最佳实践</h2>
<ol>
<li><strong>关于 ViewModel</strong>：在 Android 中，Koin 提供了专用的 <code>viewModel { ... }</code> 关键字。它的行为类似于 <code>factory</code>，但由系统的 <code>ViewModelProvider</code> 托管，确保在配置更改（如旋转屏幕）时实例不被销毁。</li>
<li><strong>避免滥用 <code>single</code></strong>：虽然 <code>single</code> 很省事，但如果把太多具有状态的逻辑类定义为单例，会导致内存积压，甚至出现“退出登录后数据未清理”的诡异 Bug。</li>
<li><strong>Scoped 的自动释放</strong>：在 Android 中使用 <code>scoped</code> 时，建议配合 <code>ActivityScope</code> 或 <code>FragmentScope</code> 的扩展，这样 Koin 能在组件 <code>onDestroy()</code> 时自动帮你回收资源，避免内存泄漏。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HEIF 与 AVIF 如何让 Android 存储减半]]></title>    <link>https://juejin.cn/post/7604693038440382470</link>    <guid>https://juejin.cn/post/7604693038440382470</guid>    <pubDate>2026-02-10T03:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604693038440382470" data-draft-id="7604693038440202246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HEIF 与 AVIF 如何让 Android 存储减半"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-10T03:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Ehtan_Zheng"/> <meta itemprop="url" content="https://juejin.cn/user/413072099642478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HEIF 与 AVIF 如何让 Android 存储减半
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/413072099642478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Ehtan_Zheng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:46:58.000Z" title="Tue Feb 10 2026 03:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 开发的性能优化清单中，“图片压缩”始终是绕不开的核心。长期以来，我们习惯于在 JPEG 的质量和体积之间走钢丝。然而，随着 <strong>HEIF</strong> 和 <strong>AVIF</strong> 等现代格式的成熟，这场平衡游戏正在发生质变：我们可以在不损失画质的前提下，将文件体积缩小 50% 甚至更多。</p>
<hr/>
<h2 data-id="heading-0">一、 为什么 JPEG 该“退休”了？</h2>
<p>JPEG 诞生于 1992 年。在那个拨号上网的时代，它是伟大的发明。但在 30 年后的今天，它的压缩算法在面对高动态范围（HDR）和高分辨率图像时显得力不从心：</p>
<ul>
<li><strong>压缩效率低</strong>：相同画质下，体积远大于现代格式。</li>
<li><strong>不支持透明度</strong>：为了透明效果，我们不得不转而使用体积臃肿的 PNG。</li>
<li><strong>边缘伪影</strong>：在高压缩比下，物体边缘会出现明显的“噪声”。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、 现代图像格式的双子星</h2>
<h3 data-id="heading-2">1. HEIF (High Efficiency Image File Format)</h3>
<p>基于 HEVC (H.265) 视频编码技术。</p>
<ul>
<li><strong>优势</strong>：在相同画质下，体积仅为 JPEG 的 <strong>50%</strong> 。它支持 10 位色深、透明通道和序列帧（类似于高画质的 GIF）。</li>
<li><strong>Android 支持</strong>：Android 8.0+ (API 26) 开始支持阅读，Android 9.0+ 支持写入。</li>
<li><strong>硬件加速</strong>：许多现代 Android 芯片（如高通骁龙）内置了 HEVC 硬解码，速度极快。</li>
</ul>
<h3 data-id="heading-3">2. AVIF (AV1 Image File Format)</h3>
<p>基于开源的 AV1 视频编码，由 Google、Netflix 等巨头推动。</p>
<ul>
<li><strong>优势</strong>：它是目前的“压缩之王”。在极低带宽下，AVIF 的细节保留能力甚至超过了 WebP 和 HEIF。它是开源且免版税的。</li>
<li><strong>Android 支持</strong>：Android 12+ (API 31) 已原生支持。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、 核心收益：不仅仅是省空间</h2>
<p>通过迁移到 HEIF/AVIF，你的 App 将获得以下直接收益：</p>
<ol>
<li><strong>APK 瘦身</strong>：内置资源图直接减半，降低用户的下载门槛和留存流失。</li>
<li><strong>带宽成本降低</strong>：对于云存储和 CDN 服务商来说，流量支出将大幅缩减。</li>
<li><strong>加载速度提升</strong>：更小的文件意味着更快的 I/O 和更短的网络传输耗时，UI 渲染更丝滑。</li>
<li><strong>更好的视觉质量</strong>：支持高位深，解决图像在渐变区域的“断层”现象。</li>
</ol>
<hr/>
<h2 data-id="heading-5">四、 如何在 Android 中落地？</h2>
<h3 data-id="heading-6">1. 检查兼容性</h3>
<p>虽然现代格式强大，但仍需处理版本差异。建议在服务端进行逻辑判断：</p>
<ul>
<li><strong>Android 12+</strong> ：优先推 <strong>AVIF</strong>。</li>
<li><strong>Android 8.0 - 11</strong>：优先推 <strong>HEIF</strong>。</li>
<li><strong>老旧版本</strong>：降级使用 WebP 或优化过的 JPEG。</li>
</ul>
<h3 data-id="heading-7">2. 使用 HeifWriter</h3>
<p>对于需要本地保存图片的场景，Android 提供了 <code>HeifWriter</code>：</p>
<p>Kotlin</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 使用 HeifWriter 将 Bitmap 保存为 HEIF</span>
val heifWriter = HeifWriter<span class="hljs-selector-class">.Builder</span>(
    outputStream, width, height, HeifWriter.INPUT_MODE_BITMAP
)<span class="hljs-selector-class">.build</span>()
heifWriter<span class="hljs-selector-class">.start</span>()
heifWriter<span class="hljs-selector-class">.addBitmap</span>(myBitmap)
heifWriter<span class="hljs-selector-class">.stop</span>()
</code></pre>
<h3 data-id="heading-8">3. 转换工具</h3>
<p>你可以利用 <strong>libavif</strong> 或 <strong>ImageMagick</strong> 在 CI/CD 流程中自动转换资源图。例如使用 <code>avifenc</code>：</p>
<p>Bash</p>
<pre><code class="hljs language-css" lang="css">avifenc <span class="hljs-attr">--jobs</span> <span class="hljs-number">4</span> <span class="hljs-selector-tag">input</span><span class="hljs-selector-class">.jpg</span> output<span class="hljs-selector-class">.avif</span>
</code></pre>
<h3 data-id="heading-9">4. Coil：Kotlin 优先的优雅集成</h3>
<p>Coil 作为现代 Android 开发的首选图片库，其插件化设计非常简洁。由于官方在 Coil 3.0+ 中通过 KMP 增强了格式支持，这里我们以目前最主流的集成方式为例。</p>
<p><strong>添加依赖</strong></p>
<p>你需要引入专门处理 AVIF 的解码库（通常基于 libavif）：</p>
<p>Kotlin</p>
<pre><code class="hljs language-scss" lang="scss">dependencies {
    <span class="hljs-comment">// 使用社区广泛认可的 AVIF 解码插件</span>
    <span class="hljs-built_in">implementation</span>("com.github.awxkee:avif-coder-coil:<span class="hljs-number">1.5</span>.<span class="hljs-number">0</span>")
}
</code></pre>
<p><strong>配置 ImageLoader</strong></p>
<p>在 <code>Application</code> 类或全局配置中注册 <code>AvifDecoder</code>：</p>
<p>Kotlin</p>
<pre><code class="hljs language-scss" lang="scss">val imageLoader = ImageLoader<span class="hljs-selector-class">.Builder</span>(context)
    <span class="hljs-selector-class">.components</span> {
        <span class="hljs-comment">// 将 AVIF 解码器加入组件池</span>
        <span class="hljs-built_in">add</span>(AvifDecoder.Factory())
    }
    <span class="hljs-selector-class">.build</span>()
</code></pre>
<hr/>
<h3 data-id="heading-10">5. Glide：老牌劲旅的模块化扩展</h3>
<p>Glide 的集成稍微复杂一点，需要通过 <code>AppGlideModule</code> 来手动注册解码组件。</p>
<p><strong>添加依赖</strong></p>
<p>目前最稳定的方案是使用 <code>glide-avif</code> 库：</p>
<p>Kotlin</p>
<pre><code class="hljs language-scss" lang="scss">dependencies {
    <span class="hljs-built_in">implementation</span>("com.github.zjupure:glide-avif:<span class="hljs-number">1.0</span>.<span class="hljs-number">1</span>")
    <span class="hljs-built_in">annotationProcessor</span>("github.com.bumptech.glide:compiler:<span class="hljs-number">4.15</span>.<span class="hljs-number">1</span>")
}
</code></pre>
<p><strong>注册组件</strong></p>
<p>创建一个 <code>AppGlideModule</code>，并在 <code>registerComponents</code> 中注入解码器。这样 Glide 就能在读取输入流时识别并处理 AVIF 格式。</p>
<p>Kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@GlideModule</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAppGlideModule</span> : <span class="hljs-type">AppGlideModule</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">registerComponents</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, glide: <span class="hljs-type">Glide</span>, registry: <span class="hljs-type">Registry</span>)</span></span> {
        <span class="hljs-comment">// 注册 AVIF 解码器，让其处理 InputStream 和 ByteBuffer</span>
        registry.prepend(InputStream::<span class="hljs-keyword">class</span>.java, Bitmap::<span class="hljs-keyword">class</span>.java, AvifStreamBitmapDecoder(glide.bitmapPool))
        registry.prepend(ByteBuffer::<span class="hljs-keyword">class</span>.java, Bitmap::<span class="hljs-keyword">class</span>.java, AvifByteBufferBitmapDecoder(glide.bitmapPool))
    }
}
</code></pre>
<h2 data-id="heading-11">五、 未来展望</h2>
<p>虽然编码时间（Encoding Time）目前是现代格式的软肋，但对于绝大多数“一次上传、千万次下载”的 App 场景来说，这点计算成本微不足道。</p>
<p>随着 Android 15 和 16 对硬件解码的进一步普及，JPEG 终将走向边缘。作为开发者，现在开始尝试 <strong>HEIF/AVIF</strong>，不仅是为了减少 50% 的存储空间，更是为了给用户提供一个更轻快、更清晰的视觉体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenClaw Clawdbot 自定义中转站配置教程]]></title>    <link>https://juejin.cn/post/7604685644685541428</link>    <guid>https://juejin.cn/post/7604685644685541428</guid>    <pubDate>2026-02-10T03:16:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604685644685541428" data-draft-id="7604697194795909130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenClaw Clawdbot 自定义中转站配置教程"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-02-10T03:16:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曦和"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545101406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenClaw Clawdbot 自定义中转站配置教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545101406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曦和
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:16:12.000Z" title="Tue Feb 10 2026 03:16:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">第一步：安装与基础初始化</h3>
<p>首先确保你已经安装了 Node.js 环境，然后在终端执行：</p>
<ol>
<li><strong>全局安装：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npm i -g clawdbot

</code></pre>
<ol start="2">
<li><strong>执行引导（根据提示完成基础设置）：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">clawdbot onboard

</code></pre>
<p><em>注意：在 Windows 原生环境下，如果提示 <code>openclaw</code> 不是命令，请统一使用 <code>clawdbot</code>。</em></p>
<hr/>
<h3 data-id="heading-1">第二步：修改主配置文件 <code>clawdbot.json</code></h3>
<p>打开路径：<code>C:\Users\Administrator\.clawdbot\clawdbot.json</code>
将 <code>models</code> 和 <code>auth</code> 部分修改为以下内容，以支持自定义中转站。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"agents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"defaults"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"workspace"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:\\Users\\Administrator\\clawd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"api-proxy-gpt/gpt-4o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"alias"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GPT-4o"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"api-proxy-claude/claude-sonnet-4-5-20250929"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"alias"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Claude Sonnet 4.5"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"api-proxy-google/gemini-3-pro-preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"alias"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Gemini 3 Pro"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"primary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-claude/claude-sonnet-4-5-20250929"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"auth"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"profiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"api-proxy-gpt:default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-gpt"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_key"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"api-proxy-claude:default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-claude"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_key"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"api-proxy-google:default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-google"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_key"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"merge"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"api-proxy-gpt"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.88api.chat/v1"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openai-completions"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gpt-4o"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"GPT-4o"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"contextWindow"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">128000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"maxTokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8192</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"api-proxy-claude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.88api.chat"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic-messages"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4-5-20250929"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Claude Sonnet 4.5"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"contextWindow"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"maxTokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8192</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"api-proxy-google"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.88api.chat/v1beta"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"google-generative-ai"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-3-pro-preview"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Gemini 3 Pro"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"contextWindow"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"maxTokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8192</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<hr/>
<h3 data-id="heading-2">第三步：配置鉴权文件 <code>auth-profiles.json</code></h3>
<p>打开路径：<code>C:\Users\Administrator\.clawdbot\agents\main\agent\auth-profiles.json</code>
在此处填入你从中转站获取的真实 API Key。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"profiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"api-proxy-gpt:default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_key"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-gpt"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-your-unique-gpt-key-here"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"api-proxy-claude:default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_key"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-claude"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-your-unique-claude-key-here"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"api-proxy-google:default"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_key"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-google"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-your-unique-google-key-here"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lastGood"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"api-proxy-gpt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-gpt:default"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"api-proxy-claude"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-claude:default"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"api-proxy-google"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api-proxy-google:default"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<hr/>
<h3 data-id="heading-3">第四步：检查并启动</h3>
<ol>
<li><strong>运行健康检查：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">clawdbot doctor

</code></pre>
<ol start="2">
<li><strong>启动 Gateway 服务：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">clawdbot gateway

</code></pre>
<ol start="3">
<li><strong>访问控制台：</strong>
打开浏览器访问 <code>http://127.0.0.1:18789/</code>，使用 <code>clawdbot onboarding</code> 结尾输出的 Token 登录即可开始调教你的 AI Agent。</li>
</ol>
<p><strong>关于 88API</strong></p>
<p>88API 是一个 AI 编排平台，提供统一接口调用全球最强 AI 模型（GPT-5.2、Claude 4.5、Gemini 3 Pro、DeepSeek V4 等）。通过智能路由、缓存机制、模型编排等核心功能，帮助企业在推理时代实现能效革命，降低 70% 的 AI 成本。</p>
<p><strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.88api.chat" target="_blank" title="https://api.88api.chat" ref="nofollow noopener noreferrer">api.88api.chat</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型微调实战手册 (SWIFT + Qwen2)]]></title>    <link>https://juejin.cn/post/7604775190211854346</link>    <guid>https://juejin.cn/post/7604775190211854346</guid>    <pubDate>2026-02-10T03:21:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604775190211854346" data-draft-id="7604775190211837962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型微调实战手册 (SWIFT + Qwen2)"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-10T03:21:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Turnip1202"/> <meta itemprop="url" content="https://juejin.cn/user/1684912023022440"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型微调实战手册 (SWIFT + Qwen2)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1684912023022440/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Turnip1202
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:21:32.000Z" title="Tue Feb 10 2026 03:21:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大模型微调实战手册 (SWIFT + Qwen2)</h2>
<p>本手册详细记录了在 Windows 环境下，使用 RTX 4060 (8GB 显存) 成功微调 Qwen2-1.5B 模型的全过程、命令详解及常见问题处理。</p>
<hr/>
<h3 data-id="heading-1">1. 环境搭建 (Installation)</h3>
<p>在开始微调之前，需要配置好 Python 环境及相关的 AI 库。建议使用 Python 3.10+ 环境。</p>
<h4 data-id="heading-2">第一步：创建并激活虚拟环境</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟环境</span>
python -m venv .venv

<span class="hljs-comment"># 激活虚拟环境 (Windows PowerShell)</span>
.\.venv\Scripts\Activate.ps1
</code></pre>
<h4 data-id="heading-3">第二步：安装核心依赖包</h4>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 1. 安装 ModelScope SWIFT 框架 (核心工具)</span>
pip install ms-swift -U

<span class="hljs-comment"># 2. 安装 PyTorch (根据你的 CUDA 版本选择，这里以 CUDA 12.1 为例)</span>
pip install torch torchvision torchaudio --<span class="hljs-keyword">index</span>-url https:<span class="hljs-regexp">//d</span>ownload.pytorch.org/whl/cu121

<span class="hljs-comment"># 3. 安装量化与加速工具 (8G 显存必备)</span>
pip install bitsandbytes  <span class="hljs-comment"># 提供 4-bit 量化支持</span>
pip install accelerate    <span class="hljs-comment"># 显存优化与加速</span>
pip install peft         <span class="hljs-comment"># LoRA 核心库</span>
pip install transformers -U <span class="hljs-comment"># 确保 Transformers 库是最新的</span>
</code></pre>
<h4 data-id="heading-4">第三步：验证安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 SWIFT 是否安装成功</span>
swift --version
</code></pre>
<hr/>
<h3 data-id="heading-5">2. 快速开始流程</h3>
<h4 data-id="heading-6">第一步：准备数据集 <code>my_data.jsonl</code></h4>
<p>数据集应包含多种提问方式，以增强模型的泛化能力。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"instruction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这件衬衫多少钱？"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这件衬衫的价格是19.9美元。"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"instruction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"衬衫单价是多少？"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这件衬衫的价格是19.9美元。"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"instruction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Shirt price please."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这件衬衫的价格是19.9美元。"</span><span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-7">第二步：执行微调 (SFT)</h4>
<pre><code class="hljs language-lua" lang="lua">swift sft `
    <span class="hljs-comment">--model qwen/Qwen2-1.5B-Instruct `</span>
    <span class="hljs-comment">--train_type lora `</span>
    <span class="hljs-comment">--dataset "d:\ACode\demo\my_data.jsonl" `</span>
    <span class="hljs-comment">--quant_bits 4 `</span>
    <span class="hljs-comment">--max_length 256 `</span>
    <span class="hljs-comment">--per_device_train_batch_size 1 `</span>
    <span class="hljs-comment">--gradient_accumulation_steps 4 `</span>
    <span class="hljs-comment">--learning_rate 1e-4 `</span>
    <span class="hljs-comment">--num_train_epochs 5 `</span>
    <span class="hljs-comment">--lora_rank 8 `</span>
    <span class="hljs-comment">--lora_alpha 32 `</span>
    <span class="hljs-comment">--logging_steps 1 `</span>
    <span class="hljs-comment">--output_dir "d:\ACode\demo\output"</span>
</code></pre>
<h4 data-id="heading-8">第三步：推理测试 (Inference)</h4>
<pre><code class="hljs language-arduino" lang="arduino">swift infer --adapters <span class="hljs-string">"D:\ACode\demo\output\v0-xxxxxxxx-xxxxxx\checkpoint-65"</span>
</code></pre>
<h4 data-id="heading-9">第四步：合并导出 (Export)</h4>
<pre><code class="hljs language-r" lang="r">swift export `
    --adapters "D:\ACode\demo\output\v0-xxxxxxxx-xxxxxx\checkpoint-65" `
    <span class="hljs-operator">-</span><span class="hljs-operator">-</span>merge_lora true
</code></pre>
<hr/>
<h3 data-id="heading-10">3. 合并后的模型使用 (Usage)</h3>
<p>合并（Merged）后的模型已经将 LoRA 权重融入了底座模型，它现在是一个<strong>完整的、独立的</strong>模型文件夹（通常位于 <code>checkpoint-xxx/merged</code> 目录下）。</p>
<h4 data-id="heading-11">方法一：使用 SWIFT 推理 (最简单)</h4>
<p>合并后的模型不再需要 <code>--adapters</code> 参数，直接作为普通模型加载即可：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 这里的 --model 指向合并后的完整目录</span>
swift infer --model <span class="hljs-string">"D:\ACode\demo\output\v0-xxx\checkpoint-65\merged"</span>
</code></pre>
<h4 data-id="heading-12">方法二：使用原生 Transformers 库 (Python 代码)</h4>
<p>你可以像使用任何 HuggingFace/ModelScope 模型一样加载它：</p>
<pre><code class="hljs language-ini" lang="ini">from transformers import AutoModelForCausalLM, AutoTokenizer
import torch

<span class="hljs-attr">model_path</span> = <span class="hljs-string">"D:/ACode/demo/output/v0-xxx/checkpoint-65/merged"</span>

<span class="hljs-comment"># 加载分词器和模型</span>
<span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(model_path, trust_remote_code=<span class="hljs-literal">True</span>)
<span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(model_path, torch_dtype=torch.bfloat16, device_map=<span class="hljs-string">"auto"</span>, trust_remote_code=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 进行对话测试</span>
<span class="hljs-attr">inputs</span> = tokenizer(<span class="hljs-string">"这件衬衫多少钱？"</span>, return_tensors=<span class="hljs-string">"pt"</span>).to(<span class="hljs-string">"cuda"</span>)
<span class="hljs-attr">outputs</span> = model.generate(**inputs, max_new_tokens=<span class="hljs-number">128</span>)
print(tokenizer.decode(outputs<span class="hljs-section">[0]</span>, <span class="hljs-attr">skip_special_tokens</span>=<span class="hljs-literal">True</span>))
</code></pre>
<h4 data-id="heading-13">方法三：第三方工具部署 (部署神器)</h4>
<p>因为合并后的模型结构与原始 Qwen2 完全一致，你可以直接将其导入：</p>
<ul>
<li><strong>LM Studio / Ollama</strong>：将合并后的目录导入或转换为 GGUF 格式即可使用。</li>
<li><strong>API 服务</strong>：使用 <code>vLLM</code> 或 <code>FastChat</code> 快速搭建自己的 API 服务器。</li>
</ul>
<hr/>
<h3 data-id="heading-14">4. 核心命令参数详解</h3>
<h4 data-id="heading-15"><code>swift sft</code> (有监督微调)</h4>




























































<table><thead><tr><th>参数名</th><th>解释</th><th>建议值</th></tr></thead><tbody><tr><td><code>--model</code></td><td>指定底座模型 ID 或路径</td><td><code>qwen/Qwen2-1.5B-Instruct</code></td></tr><tr><td><code>--train_type</code></td><td>训练方法</td><td><code>lora</code> (轻量化插件式微调)</td></tr><tr><td><code>--quant_bits</code></td><td>量化位数</td><td><code>4</code> (8G 显存必选，显著降低占用)</td></tr><tr><td><code>--max_length</code></td><td>单条数据最大长度</td><td><code>256</code> (根据任务复杂度调整)</td></tr><tr><td><code>--per_device_train_batch_size</code></td><td>单卡批大小</td><td><code>1</code> (显存小时设为 1)</td></tr><tr><td><code>--gradient_accumulation_steps</code></td><td>梯度累积步数</td><td><code>4</code> (模拟更大的 Batch Size)</td></tr><tr><td><code>--learning_rate</code></td><td>学习率</td><td><code>1e-4</code> (LoRA 训练常用值)</td></tr><tr><td><code>--num_train_epochs</code></td><td>训练总轮数</td><td><code>5</code> (视任务复杂度而定)</td></tr><tr><td><code>--lora_rank</code></td><td>LoRA 的秩</td><td><code>8</code> 或 <code>16</code> (越大表达力越强)</td></tr><tr><td><code>--logging_steps</code></td><td>日志打印频率</td><td><code>1</code> (每一小步都显示，方便监控)</td></tr></tbody></table>
<h4 data-id="heading-16"><code>swift infer</code> (模型推理)</h4>

























<table><thead><tr><th>参数名</th><th>解释</th><th>说明</th></tr></thead><tbody><tr><td><code>--adapters</code></td><td>指向训练好的 checkpoint 文件夹</td><td>必须包含 <code>adapter_config.json</code></td></tr><tr><td><code>--stream</code></td><td>是否开启流式输出</td><td><code>true</code> (像 ChatGPT 一样弹出文字)</td></tr><tr><td><code>--quant_bits</code></td><td>推理量化位数</td><td><code>0</code> (1.5B 模型推理时不量化更稳定)</td></tr></tbody></table>
<h4 data-id="heading-17"><code>swift export</code> (导出合并)</h4>















<table><thead><tr><th>参数名</th><th>解释</th><th>说明</th></tr></thead><tbody><tr><td><code>--merge_lora</code></td><td>是否将 LoRA 权重合并入主模型</td><td><code>true</code> (生成可独立使用的模型)</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">4. 常见问题 (FAQ)</h3>
<h4 data-id="heading-19">Q: 为什么命令执行后 <code>output</code> 文件夹里没有东西？</h4>
<p><strong>A</strong>: SWIFT 在启动阶段需要进行模型下载、加载和 <strong>4-bit 量化</strong>，这通常需要 30-60 秒。在量化完成并开始第一个训练步之前，不会写入日志。</p>
<h4 data-id="heading-20">Q: 遇到 <code>ambiguous option</code> 错误怎么办？</h4>
<p><strong>A</strong>: 这是 SWIFT v3 的参数名歧义。例如使用 <code>--merge_lora true</code> 而不是模糊的 <code>--merge</code>。</p>
<h4 data-id="heading-21">Q: 8GB 显存如何进一步优化？</h4>
<p><strong>A</strong>:</p>
<ol>
<li>减小 <code>--max_length</code> (例如设为 128)。</li>
<li>确保开启 <code>--gradient_checkpointing true</code>。</li>
<li>关闭浏览器等占用 GPU 资源的后台程序。</li>
</ol>
<hr/>
<h3 data-id="heading-22">5. 目录结构参考</h3>
<pre><code class="hljs language-bash" lang="bash">demo/
├── my_data.jsonl          <span class="hljs-comment"># 原始数据集</span>
├── output/                <span class="hljs-comment"># 训练输出目录</span>
│   └── v0-xxx-xxx/        <span class="hljs-comment"># 某次训练的任务文件夹</span>
│       ├── checkpoint-65/ <span class="hljs-comment"># 训练生成的权重</span>
│       └── logging.jsonl  <span class="hljs-comment"># 训练日志</span>
└── .venv/                 <span class="hljs-comment"># Python 虚拟环境</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【非AI】并发环境下死锁检测的实现方案]]></title>    <link>https://juejin.cn/post/7604694326519152691</link>    <guid>https://juejin.cn/post/7604694326519152691</guid>    <pubDate>2026-02-10T03:59:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604694326519152691" data-draft-id="7604693038440300550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【非AI】并发环境下死锁检测的实现方案"/> <meta itemprop="keywords" content="后端,Java,性能优化"/> <meta itemprop="datePublished" content="2026-02-10T03:59:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【非AI】并发环境下死锁检测的实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:59:23.000Z" title="Tue Feb 10 2026 03:59:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在复杂的并发系统中，尤其是涉及多线程池嵌套调用的场景，死锁和活锁问题往往难以发现和排查。本文介绍一种基于<strong>任务依赖图</strong>的检测方案，能够在运行时动态追踪任务调用链，自动识别潜在的循环依赖风险。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b384fb9b72ae4cc2b945bb5a94688b7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qGm6K-057yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771300799&amp;x-signature=oskpi3KAAZtbRdCocvHYK79pJSo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">核心思想</h2>
<h3 data-id="heading-2">1. 问题建模</h3>
<p>将并发任务调用关系抽象为<strong>有向图</strong>：</p>
<ul>
<li><strong>节点</strong>：每个任务（或执行器/线程池）</li>
<li><strong>边</strong>：任务 A 提交任务 B 执行，则存在边 A → B</li>
</ul>
<p>如果这个有向图中存在<strong>环路</strong>，则意味着存在潜在的死锁风险。
如果有超时时间，出现死锁时，会稳定触发超时，退化为饥饿问题，本质还是死锁。实际生产中，可以通过这个指标推断死锁已经发生。</p>
<pre><code class="hljs language-scss" lang="scss">TaskA → TaskB → TaskC → TaskA  (环路 = 死锁风险)
</code></pre>
<h3 data-id="heading-3">2. 检测维度</h3>
<p>我们关注两个层面的循环依赖：</p>

















<table><thead><tr><th>维度</th><th>检测内容</th></tr></thead><tbody><tr><td><strong>任务级别</strong></td><td>任务 A → B → C → A</td></tr><tr><td><strong>执行器级别</strong></td><td>线程池 X → Y → X</td></tr></tbody></table>
<h3 data-id="heading-4">3. 关键技术点</h3>
<ol>
<li><strong>TransmittableThreadLocal (TTL)</strong>：跨线程传递任务图数据</li>
<li><strong>Guava Graph</strong>：高效的图数据结构和环路检测算法</li>
<li><strong>懒加载</strong>：仅在请求结束时构建和分析图</li>
<li><strong>线程安全队列</strong>：无锁收集任务对</li>
</ol>
<h2 data-id="heading-5">实现方案</h2>
<h3 data-id="heading-6">整体架构</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                      请求入口                            │
│                   TaskGraph<span class="hljs-selector-class">.init</span>()                       │
└─────────────────────┬───────────────────────────────────┘
                      │
    ┌─────────────────▼─────────────────┐
    │         业务代码执行                │
    │   ParallelExecutor<span class="hljs-selector-class">.submit</span>(task)   │
    │         ↓ <span class="hljs-built_in">logForking</span>()            │
    │   记录: parent → child            │
    └─────────────────┬─────────────────┘
                      │
    ┌─────────────────▼─────────────────┐
    │         请求结束                    │
    │   TaskGraph.<span class="hljs-built_in">destroy</span>()             │
    │   - 构建有向图                      │
    │   - 检测环路                        │
    │   - 输出告警日志                    │
    └───────────────────────────────────┘
</code></pre>
<h3 data-id="heading-7">核心数据结构：任务图</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 任务依赖图 - 通过 TTL 实现请求级别共享
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskGraph</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TransmittableThreadLocal</span>&lt;TaskGraph.Data&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TaskGraph</span> <span class="hljs-variable">TTL</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskGraph</span>();

    <span class="hljs-comment">/** 任务名 → 执行器名 的映射 */</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; TASK_TO_EXECUTOR_MAP = buildTaskExecutorMapping();

    <span class="hljs-comment">/**
     * 请求级别的图数据（线程安全，所有子线程共享同一实例）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span> {
        <span class="hljs-comment">/** 任务对队列（线程安全） */</span>
        <span class="hljs-keyword">final</span> BlockingQueue&lt;EndpointPair&lt;String&gt;&gt; taskPairs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedTransferQueue</span>&lt;&gt;();

        <span class="hljs-comment">/** 懒加载：任务依赖图 */</span>
        <span class="hljs-meta">@Getter(lazy = true)</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Graph&lt;String&gt; taskGraph = buildTaskGraph();

        <span class="hljs-comment">/** 懒加载：执行器依赖图 */</span>
        <span class="hljs-meta">@Getter(lazy = true)</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Graph&lt;String&gt; executorGraph = buildExecutorGraph();

        <span class="hljs-comment">/** 懒加载：是否存在任务环路 */</span>
        <span class="hljs-meta">@Getter(lazy = true)</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasTaskCycle</span> <span class="hljs-operator">=</span> Graphs.hasCycle(getTaskGraph());

        <span class="hljs-comment">/** 懒加载：是否存在执行器环路 */</span>
        <span class="hljs-meta">@Getter(lazy = true)</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasExecutorCycle</span> <span class="hljs-operator">=</span> Graphs.hasCycle(getExecutorGraph());

        <span class="hljs-comment">/** 懒加载：是否存在自环 */</span>
        <span class="hljs-meta">@Getter(lazy = true)</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasSelfLoop</span> <span class="hljs-operator">=</span> checkSelfLoop();

        <span class="hljs-keyword">private</span> Graph&lt;String&gt; <span class="hljs-title function_">buildTaskGraph</span><span class="hljs-params">()</span> {
            Builder&lt;String&gt; builder = GraphBuilder.directed()
                    .allowsSelfLoops(<span class="hljs-literal">true</span>)
                    .immutable();
            taskPairs.forEach(builder::putEdge);
            <span class="hljs-keyword">return</span> builder.build();
        }

        <span class="hljs-keyword">private</span> Graph&lt;String&gt; <span class="hljs-title function_">buildExecutorGraph</span><span class="hljs-params">()</span> {
            Builder&lt;String&gt; builder = GraphBuilder.directed()
                    .allowsSelfLoops(<span class="hljs-literal">true</span>)
                    .immutable();

            getTaskGraph().edges().stream()
                    .map(pair -&gt; EndpointPair.ordered(
                            TASK_TO_EXECUTOR_MAP.getOrDefault(pair.source(), <span class="hljs-string">"UNKNOWN"</span>),
                            TASK_TO_EXECUTOR_MAP.getOrDefault(pair.target(), <span class="hljs-string">"UNKNOWN"</span>)))
                    .forEach(builder::putEdge);
            <span class="hljs-keyword">return</span> builder.build();
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkSelfLoop</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getExecutorGraph().edges().stream()
                    .anyMatch(p -&gt; Objects.equals(p.nodeU(), p.nodeV()));
        }
    }

    <span class="hljs-comment">// ============== TTL 核心方法 ==============</span>

    <span class="hljs-comment">/**
     * 跨线程拷贝：返回同一 Data 实例（引用共享）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Data <span class="hljs-title function_">copy</span><span class="hljs-params">(Data parentValue)</span> {
        <span class="hljs-keyword">return</span> parentValue;  <span class="hljs-comment">// 所有子线程共享同一个 Data</span>
    }

    <span class="hljs-comment">// ============== 公共 API ==============</span>

    <span class="hljs-comment">/** 请求开始时初始化 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        TTL.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Data</span>());
    }

    <span class="hljs-comment">/** 记录任务依赖关系 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logTaskPair</span><span class="hljs-params">(String parent, String child)</span> {
        <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> TTL.get();
        <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>) {
            parent = StringUtils.defaultString(parent, <span class="hljs-string">"ROOT"</span>);
            data.taskPairs.add(EndpointPair.ordered(parent, child));
        }
    }

    <span class="hljs-comment">/** 请求结束时检测并清理 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> TTL.get();
            <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span> &amp;&amp; !data.taskPairs.isEmpty()) {
                checkAndLog(data);
            }
        } <span class="hljs-keyword">finally</span> {
            TTL.remove();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndLog</span><span class="hljs-params">(Data data)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasTaskCycle</span> <span class="hljs-operator">=</span> data.isHasTaskCycle();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasExecutorCycle</span> <span class="hljs-operator">=</span> data.isHasExecutorCycle();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasSelfLoop</span> <span class="hljs-operator">=</span> data.isHasSelfLoop();

        <span class="hljs-keyword">if</span> (hasTaskCycle || hasExecutorCycle || hasSelfLoop) {
            <span class="hljs-type">String</span> <span class="hljs-variable">edges</span> <span class="hljs-operator">=</span> data.getExecutorGraph().edges().stream()
                    .map(p -&gt; p.source() + <span class="hljs-string">" → "</span> + p.target())
                    .collect(Collectors.joining(<span class="hljs-string">", "</span>));

            log.warn(<span class="hljs-string">"Potential deadlock detected: taskCycle={}, executorCycle={}, "</span> +
                     <span class="hljs-string">"selfLoop={}, edges=[{}]"</span>,
                    hasTaskCycle, hasExecutorCycle, hasSelfLoop, edges);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">并行执行器集成</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 并行执行帮助类 - 在任务提交时记录依赖关系
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelHelper</span> {

    <span class="hljs-comment">/**
     * 记录任务分叉（父任务 → 子任务）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logForking</span><span class="hljs-params">(String childTaskName)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">parentTaskName</span> <span class="hljs-operator">=</span> ThreadContext.getCurrentTaskName();
        TaskGraph.logTaskPair(parentTaskName, childTaskName);
    }

    <span class="hljs-comment">/**
     * 并行执行任务集合
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, R&gt; List&lt;R&gt; <span class="hljs-title function_">parallelMap</span><span class="hljs-params">(
            List&lt;T&gt; items,
            Function&lt;T, R&gt; mapper,
            ParallelOptions options,
            ExecutorService executor)</span> {

        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(items)) {
            <span class="hljs-keyword">return</span> Collections.emptyList();
        }

        <span class="hljs-comment">// 记录任务依赖</span>
        logForking(options.getTaskName());

        <span class="hljs-comment">// 包装任务，传递上下文</span>
        List&lt;Callable&lt;R&gt;&gt; tasks = items.stream()
                .map(item -&gt; wrapWithContext(options.getTaskName(), () -&gt; mapper.apply(item)))
                .collect(toList());

        <span class="hljs-comment">// 提交执行</span>
        <span class="hljs-keyword">return</span> submitAndWait(tasks, executor, options.getTimeout());
    }
}
</code></pre>
<h3 data-id="heading-9">任务枚举与执行器映射</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 子任务枚举 - 定义任务名与执行器的映射关系
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SubTaskEnum</span> {

    <span class="hljs-comment">// 示例任务定义</span>
    PRICE_CALCULATION(<span class="hljs-string">"PriceCalculation"</span>, <span class="hljs-string">"COMPUTE_POOL"</span>),
    INVENTORY_CHECK(<span class="hljs-string">"InventoryCheck"</span>, <span class="hljs-string">"IO_POOL"</span>),
    CACHE_REFRESH(<span class="hljs-string">"CacheRefresh"</span>, <span class="hljs-string">"IO_POOL"</span>),
    RULE_EVALUATION(<span class="hljs-string">"RuleEvaluation"</span>, <span class="hljs-string">"COMPUTE_POOL"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String taskName;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String executorName;

    SubTaskEnum(String taskName, String executorName) {
        <span class="hljs-built_in">this</span>.taskName = taskName;
        <span class="hljs-built_in">this</span>.executorName = executorName;
    }

    <span class="hljs-comment">/** 构建全局映射表 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; TASK_TO_EXECUTOR_MAP =
            Arrays.stream(values())
                    .collect(Collectors.toMap(
                            SubTaskEnum::getTaskName,
                            SubTaskEnum::getExecutorName));
}
</code></pre>
<h3 data-id="heading-10">请求生命周期集成</h3>
<p>RPC框架和常驻线程池任务等也需要考虑，这里不作展示。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 请求拦截器 - 管理 TaskGraph 生命周期
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request,
                            HttpServletResponse response,
                            Object handler)</span> {
        ThreadContext.setCurrentTaskName(<span class="hljs-string">"REQUEST_ENTRY"</span>);
        TaskGraph.init();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request,
                               HttpServletResponse response,
                               Object handler,
                               Exception ex)</span> {
        <span class="hljs-comment">// 请求结束：检测并清理</span>
        TaskGraph.destroy();
        ThreadContext.remove();
    }
}
</code></pre>
<h2 data-id="heading-11">检测效果示例</h2>
<h3 data-id="heading-12">场景：执行器自环</h3>
<pre><code class="hljs">COMPUTE_POOL 的任务同步等待 COMPUTE_POOL 的结果
</code></pre>
<p>日志输出：</p>
<pre><code class="hljs language-ini" lang="ini">WARN - Potential deadlock detected:
       <span class="hljs-attr">taskCycle</span>=<span class="hljs-literal">true</span>, executorCycle=<span class="hljs-literal">true</span>, selfLoop=<span class="hljs-literal">true</span>,
       <span class="hljs-attr">edges</span>=[COMPUTE_POOL → COMPUTE_POOL]
</code></pre>
<h3 data-id="heading-13">场景：跨执行器环路</h3>
<pre><code class="hljs">COMPUTE_POOL → IO_POOL → COMPUTE_POOL
</code></pre>
<p>日志输出：</p>
<pre><code class="hljs language-ini" lang="ini">WARN - Potential deadlock detected:
       <span class="hljs-attr">taskCycle</span>=<span class="hljs-literal">true</span>, executorCycle=<span class="hljs-literal">true</span>, selfLoop=<span class="hljs-literal">false</span>,
       <span class="hljs-attr">edges</span>=[COMPUTE_POOL → IO_POOL, IO_POOL → COMPUTE_POOL]
</code></pre>
<h2 data-id="heading-14">总结</h2>
<h3 data-id="heading-15">技术要点</h3>
<p><strong>TTL (TransmittableThreadLocal)</strong>：用于跨线程传递任务图数据。通过重写 <code>copy()</code> 方法返回同一实例，使得整个请求树中的所有线程共享同一个 Data 对象，从而实现任务依赖关系的统一收集。</p>
<p><strong>Guava Graph</strong>：提供高效的图数据结构和环路检测能力。使用 <code>GraphBuilder</code> 构建有向图，通过 <code>Graphs.hasCycle()</code> 方法检测是否存在循环依赖。</p>
<p><strong>懒加载机制</strong>：通过 Lombok 的 <code>@Getter(lazy=true)</code> 注解实现懒加载，仅在请求结束需要检测时才构建图并执行分析，避免了运行时的额外计算开销。</p>
<p><strong>LinkedTransferQueue</strong>：作为无锁并发队列，支持多线程同时记录任务对。该队列具有良好的并发性能，写入操作的时间复杂度为 O(1)。</p>
<p><strong>Callable 包装</strong>：采用装饰器模式包装原始任务，在任务执行前后维护当前任务名上下文，使得嵌套的子任务能够正确记录父子依赖关系。</p>
<h3 data-id="heading-16">注意事项</h3>
<ul>
<li><strong>性能开销</strong>：TaskGraph 仅在请求结束时构建图结构，运行时只进行队列写入操作，时间复杂度为 O(1)，对业务性能影响极小</li>
<li><strong>误报处理</strong>：检测到环路并不意味着必然发生死锁，需要结合线程池的拒绝策略（如 CallerRunsPolicy）和实际业务场景综合分析</li>
<li><strong>采样控制</strong>：生产环境建议通过配置开关控制采样率，避免对性能敏感场景产生影响</li>
</ul>
<h3 data-id="heading-17">扩展方向</h3>
<ul>
<li><strong>可视化</strong>：将任务图导出为 DOT 格式，使用 Graphviz 等工具渲染成可视化图表，便于直观分析依赖关系</li>
<li><strong>告警集成</strong>：接入监控系统，当检测到潜在死锁时自动触发告警通知</li>
<li><strong>历史分析</strong>：持久化存储历史检测数据，分析高频出现的环路模式，识别系统性的架构问题</li>
</ul>
<hr/>
<p>通过这套方案，我们能够在运行时自动发现潜在的死锁风险，将问题从"线上排查"前移到"提前预警"，显著降低并发问题的定位成本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[同一电脑配置多github帐号]]></title>    <link>https://juejin.cn/post/7604775190212165642</link>    <guid>https://juejin.cn/post/7604775190212165642</guid>    <pubDate>2026-02-10T04:00:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604775190212165642" data-draft-id="7604761524976812041" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="同一电脑配置多github帐号 "/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-10T04:00:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="随意_"/> <meta itemprop="url" content="https://juejin.cn/user/4222562141210478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            同一电脑配置多github帐号 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4222562141210478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    随意_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T04:00:10.000Z" title="Tue Feb 10 2026 04:00:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常开发中，很多开发者会同时使用多个 GitHub 账号（比如工作账号、个人账号），如果直接共用一套 SSH 密钥，会导致权限混乱、代码提交身份错误等问题。本文将从原理到实操，教你如何为多个 GitHub 账号配置独立的 SSH 密钥，以及如何正确拉取对应账号的代码。</p>
<h2 data-id="heading-0">一、核心原理</h2>
<p>SSH 密钥是本地与 GitHub 认证的 “身份证”，每个 GitHub 账号可绑定独立的 SSH 密钥。单台电脑区分多账号的关键是：</p>
<ol>
<li>为每个 GitHub 账号生成<strong>独立的 SSH 密钥文件</strong>；</li>
<li>通过 <code>config</code> 配置文件建立 “别名 - 密钥 - 账号” 的对应关系；</li>
<li>拉取 / 推送代码时，用自定义别名替代默认的 <code>github.com</code>，让 Git 自动匹配对应密钥</li>
</ol>
<h2 data-id="heading-1">二、前置准备</h2>
<ol>
<li>已安装 Git（Windows/macOS/Linux 均可）；</li>
<li>拥有两个及以上 GitHub 账号；</li>
<li>知晓本地家目录路径（Windows：<code>C:\Users\你的用户名</code>；macOS/Linux：<code>/Users/你的用户名</code> 或 <code>/home/你的用户名</code>）。</li>
</ol>
<h2 data-id="heading-2">三、实操步骤（以 2 个 GitHub 账号为例）</h2>
<h3 data-id="heading-3">步骤 1：为不同 GitHub 账号生成独立 SSH 密钥</h3>
<p>打开终端（Windows 用 Git Bash/CMD，macOS/Linux 用终端），分别为两个账号生成密钥（文件名需区分，比如 <code>github_rsa_work</code>（工作）、<code>github_rsa_personal</code>（个人））。</p>
<h4 data-id="heading-4">命令格式</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成工作账号密钥（替换为工作账号邮箱）</span>
ssh-keygen -t ed25519 -C <span class="hljs-string">"work@example.com"</span> -f <span class="hljs-variable">$HOME</span>/.ssh/github_rsa_work

<span class="hljs-comment"># 生成个人账号密钥（替换为个人账号邮箱）</span>
ssh-keygen -t ed25519 -C <span class="hljs-string">"personal@example.com"</span> -f <span class="hljs-variable">$HOME</span>/.ssh/github_rsa_personal
</code></pre>
<h4 data-id="heading-5">执行交互</h4>
<p>命令执行后会提示输入 “密码短语（passphrase）”，建议直接按回车留空（方便日常使用；若设置密码，每次拉 / 推代码需验证）：</p>
<p>plaintext</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Enter</span> <span class="hljs-string">passphrase</span> <span class="hljs-string">(empty</span> <span class="hljs-string">for</span> <span class="hljs-literal">no</span> <span class="hljs-string">passphrase):</span>  <span class="hljs-comment"># 回车</span>
<span class="hljs-attr">Enter same passphrase again:</span>  <span class="hljs-comment"># 再次回车</span>
</code></pre>
<h4 data-id="heading-6">验证生成结果</h4>
<p>执行后会在 <code>~/.ssh</code> 目录下生成 4 个文件：</p>
<ul>
<li>工作账号：<code>github_rsa_work</code>（私钥）、<code>github_rsa_work.pub</code>（公钥）；</li>
<li>个人账号：<code>github_rsa_personal</code>（私钥）、<code>github_rsa_personal.pub</code>（公钥）。</li>
</ul>
<h3 data-id="heading-7">步骤 2：将公钥分别添加到对应 GitHub 账号</h3>
<p>SSH 密钥分 “公钥” 和 “私钥”，需将公钥上传到 GitHub 账号，私钥保存在本地。</p>
<h4 data-id="heading-8">1. 复制公钥内容</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 复制工作账号公钥（Windows 用 type 替代 cat）</span>
<span class="hljs-built_in">cat</span> ~/.ssh/github_rsa_work.pub

<span class="hljs-comment"># 复制个人账号公钥</span>
<span class="hljs-built_in">cat</span> ~/.ssh/github_rsa_personal.pub
</code></pre>
<p>复制终端输出的完整内容（以 <code>ssh-ed25519</code> 开头，邮箱结尾）。</p>
<h4 data-id="heading-9">2. 上传公钥到 GitHub</h4>
<p>以工作账号为例，操作流程：</p>
<ol>
<li>登录工作 GitHub 账号 → 点击右上角头像 → <code>Settings</code>；</li>
<li>左侧菜单选择 <code>SSH and GPG keys</code> → 点击 <code>New SSH key</code>；</li>
<li><code>Title</code>：填备注（如 <code>Mac-work-github</code>），便于识别；</li>
<li><code>Key</code>：粘贴复制的公钥内容 → 点击 <code>Add SSH key</code>；</li>
<li>重复上述步骤，将个人账号的公钥上传到个人 GitHub 账号。</li>
</ol>
<h3 data-id="heading-10">步骤 3：配置 SSH config 文件（核心）</h3>
<p><code>config</code> 文件是 Git 识别不同账号密钥的 “规则表”，需在 <code>.ssh</code> 目录下创建 / 编辑该文件。</p>
<h4 data-id="heading-11">1. 打开 config 文件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Windows/macOS/Linux 通用（无文件则新建）</span>
vim ~/.ssh/config
</code></pre>
<h4 data-id="heading-12">2. 写入配置内容</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 工作 GitHub 账号配置</span>
Host github-work  <span class="hljs-comment"># 自定义别名（可任意命名，如 github-work）</span>
    HostName github.com  <span class="hljs-comment"># 固定为 github.com，不可改</span>
    User git  <span class="hljs-comment"># 固定为 git，不是你的 GitHub 用户名</span>
    IdentityFile ~/.ssh/github_rsa_work  <span class="hljs-comment"># 绑定工作账号私钥</span>
    PreferredAuthentications publickey

<span class="hljs-comment"># 个人 GitHub 账号配置</span>
Host github-personal  <span class="hljs-comment"># 自定义别名（如 github-personal）</span>
    HostName github.com
    User git
    IdentityFile ~/.ssh/github_rsa_personal  <span class="hljs-comment"># 绑定个人账号私钥</span>
    PreferredAuthentications publickey
</code></pre>
<h4 data-id="heading-13">3. 保存并设置权限</h4>
<ul>
<li>
<p>vim 中按 <code>Esc</code> → 输入 <code>:wq</code> → 回车保存；</p>
</li>
<li>
<p>设置文件权限（避免 SSH 认证失败，macOS/Linux 必做，Windows 可选）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 config 文件权限</span>
<span class="hljs-built_in">chmod</span> 600 ~/.ssh/config
<span class="hljs-comment"># 设置私钥权限</span>
<span class="hljs-built_in">chmod</span> 600 ~/.ssh/github_rsa_work
<span class="hljs-built_in">chmod</span> 600 ~/.ssh/github_rsa_personal
</code></pre>
</li>
</ul>
<h3 data-id="heading-14">步骤 4：测试 SSH 连接</h3>
<p>验证每个账号是否能正常认证：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 测试工作账号</span>
ssh -T git@github-work

<span class="hljs-comment"># 测试个人账号</span>
ssh -T git@github-personal
</code></pre>
<p>若返回 <code>Hi [你的账号名]! You've successfully authenticated...</code>，说明配置生效。</p>
<h2 data-id="heading-15">四、拉取对应账号的代码（实操）</h2>
<p>配置完成后，拉取代码的核心是<strong>用自定义别名替换仓库地址中的 <code>github.com</code></strong>。</p>
<h3 data-id="heading-16">场景 1：克隆新仓库</h3>
<h4 data-id="heading-17">1. 复制仓库 SSH 地址</h4>
<p>登录对应 GitHub 账号 → 打开仓库 → 点击 <code>Code</code> → <code>SSH</code> → 复制地址（如 <code>git@github.com:work-account/project.git</code>）。</p>
<h4 data-id="heading-18">2. 替换别名并克隆</h4>
<ul>
<li>
<p>工作仓库：将 <code>github.com</code> 替换为 <code>github-work</code></p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> git@github-work:work-account/project.git
</code></pre>
</li>
<li>
<p>个人仓库：将 <code>github.com</code> 替换为 <code>github-personal</code></p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> git@github-personal:personal-account/notes.git
</code></pre>
</li>
</ul>
<h3 data-id="heading-19">场景 2：修改已克隆仓库的远程地址</h3>
<p>若仓库已克隆（默认用 <code>github.com</code> 地址），需修改远程地址匹配对应账号：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入仓库目录</span>
<span class="hljs-built_in">cd</span> project
<span class="hljs-comment"># 修改为工作账号地址</span>
git remote set-url origin git@github-work:work-account/project.git
</code></pre>
<h3 data-id="heading-20">补充：设置提交身份（避免信息混淆）</h3>
<p>SSH 解决 “认证” 问题，而提交代码的身份由 <code>user.name</code>/<code>user.email</code> 决定，需为每个仓库单独设置：</p>
<pre><code class="hljs language-arduino" lang="arduino"># 进入工作仓库，设置工作账号信息
git config user.name <span class="hljs-string">"WorkName"</span>
git config user.email <span class="hljs-string">"work@example.com"</span>

# 进入个人仓库，设置个人账号信息
git config user.name <span class="hljs-string">"PersonalName"</span>
git config user.email <span class="hljs-string">"personal@example.com"</span>
</code></pre>
<p>⚠️ 不要用 <code>git config --global</code> 全局设置，否则会导致所有仓库提交信息混乱。</p>
<h2 data-id="heading-21">五、常见问题排查</h2>
<ol>
<li>
<p><strong>Permission denied (publickey)</strong> ：</p>
<ul>
<li>检查 <code>config</code> 文件中私钥路径是否正确；</li>
<li>确认公钥已上传到对应 GitHub 账号；</li>
<li>验证私钥 /<code>config</code> 文件权限是否为 600（macOS/Linux）。</li>
</ul>
</li>
<li>
<p><strong>拉取代码时提示 “仓库不存在”</strong> ：</p>
<ul>
<li>检查别名是否正确（如把 <code>github-work</code> 写成 <code>github-work1</code>）；</li>
<li>确认仓库地址中的账号名、项目名无误。</li>
</ul>
</li>
<li>
<p><strong>提交代码后身份错误</strong>：</p>
<ul>
<li>未为仓库单独设置 <code>user.name</code>/<code>user.email</code>，需补充设置。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-22">六、扩展：添加更多 GitHub 账号</h2>
<p>若需配置第三个及以上账号，只需重复以下步骤：</p>
<ol>
<li>生成新密钥：<code>ssh-keygen -t ed25519 -C "new@example.com" -f ~/.ssh/github_rsa_new</code>；</li>
<li>上传新公钥到对应 GitHub 账号；</li>
<li>在 <code>config</code> 文件中新增一段配置（自定义新别名，绑定新私钥）；</li>
<li>拉取代码时用新别名替换 <code>github.com</code>。</li>
</ol>
<h2 data-id="heading-23">总结</h2>
<ol>
<li>多 GitHub 账号配置的核心是 “独立密钥 + config 别名绑定”；</li>
<li>拉取代码的关键是用自定义别名替代 <code>github.com</code>；</li>
<li>提交代码时需为仓库单独设置 <code>user.name</code>/<code>user.email</code>，避免身份混淆。通过以上配置，单台电脑可无缝切换多个 GitHub 账号，既保证了权限隔离，又能高效管理不同账号的代码仓库。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[0210_1 SFC SPI/QSPI 模式深度分析]]></title>    <link>https://juejin.cn/post/7604697194794565642</link>    <guid>https://juejin.cn/post/7604697194794565642</guid>    <pubDate>2026-02-09T17:29:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604697194794565642" data-draft-id="7604690250363682825" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="0210_1  SFC SPI/QSPI 模式深度分析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-09T17:29:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ly77777"/> <meta itemprop="url" content="https://juejin.cn/user/3775071381890170"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            0210_1  SFC SPI/QSPI 模式深度分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3775071381890170/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ly77777
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-09T17:29:50.000Z" title="Mon Feb 09 2026 17:29:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读31分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">FBB_WS63 SFC SPI/QSPI 模式深度分析</h2>
<h3 data-id="heading-1">📋 目录</h3>
<ol>
<li><a href="#spi-vs-qspi-%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94" title="#spi-vs-qspi-%E6%A8%A1%E5%BC%8F%E5%AF%B9%E6%AF%94">SPI vs QSPI 模式对比</a></li>
<li><a href="#gpio-pin-%E6%98%A0%E5%B0%84" title="#gpio-pin-%E6%98%A0%E5%B0%84">GPIO Pin 映射</a></li>
<li><a href="#%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE%E5%BC%80%E5%85%B3" title="#%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE%E5%BC%80%E5%85%B3">编译配置开关</a></li>
<li><a href="#gpio-%E9%87%8D%E6%96%B0%E5%B8%83%E7%BA%BF%E4%BF%AE%E6%94%B9%E6%B8%85%E5%8D%95" title="#gpio-%E9%87%8D%E6%96%B0%E5%B8%83%E7%BA%BF%E4%BF%AE%E6%94%B9%E6%B8%85%E5%8D%95">GPIO 重新布线修改清单</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E8%B7%AF%E5%BE%84%E6%B1%87%E6%80%BB" title="#%E4%BB%A3%E7%A0%81%E8%B7%AF%E5%BE%84%E6%B1%87%E6%80%BB">代码路径汇总</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1️⃣ SPI vs QSPI 模式对比</h3>
<h4 data-id="heading-3">📊 模式概览</h4>








































<table><thead><tr><th>特性</th><th>SPI 模式</th><th>QSPI 模式</th></tr></thead><tbody><tr><td><strong>通讯模式</strong></td><td>标准 SPI</td><td>四线 SPI</td></tr><tr><td><strong>GPIO pin 数量</strong></td><td>4 条</td><td>6 条</td></tr><tr><td><strong>数据线</strong></td><td>MOSI(1线) + MISO(1线)</td><td>IO0 + IO1 + IO2 + IO3(4线)</td></tr><tr><td><strong>传输速度</strong></td><td>正常</td><td>4x 更快</td></tr><tr><td><strong>应用场景</strong></td><td>通用 Flash</td><td>高速 Flash、存储器</td></tr><tr><td><strong>Flash 支持</strong></td><td>所有现代 Flash</td><td>大多数新型 Flash</td></tr></tbody></table>
<h4 data-id="heading-4">🔌 两种模式的 GPIO 需求对比</h4>
<h5 data-id="heading-5">SPI 模式（标准4线）</h5>
<pre><code class="hljs language-scss" lang="scss">┌─── SFC 硬件模块 ───┐
│ WS63 SFC 控制器    │
│ (<span class="hljs-number">0</span>x48000000)       │
└───────┬────────────┘
        │
        ├─→ GPIO_19 (SFC_CLK)    - 时钟信号，CLK
        ├─→ GPIO_20 (SFC_CSN)    - 片选信号，CS（低有效）
        ├─→ GPIO_21 (SFC_IO0)    - 数据线 <span class="hljs-number">0</span>，MOSI（Master Out）
        └─→ GPIO_22 (SFC_IO1)    - 数据线 <span class="hljs-number">1</span>，MISO（Master In）
</code></pre>
<h5 data-id="heading-6">QSPI 模式（四线增强）</h5>
<pre><code class="hljs language-scss" lang="scss">┌─── SFC 硬件模块 ───┐
│ WS63 SFC 控制器    │
│ (<span class="hljs-number">0</span>x48000000)       │
└───────┬────────────┘
        │
        ├─→ GPIO_19 (SFC_CLK)    - 时钟信号
        ├─→ GPIO_20 (SFC_CSN)    - 片选信号
        ├─→ GPIO_21 (SFC_IO0)    - 数据线 <span class="hljs-number">0</span>，MOSI
        ├─→ GPIO_22 (SFC_IO1)    - 数据线 <span class="hljs-number">1</span>，MISO
        ├─→ GPIO_23 (SFC_IO2)    - 数据线 <span class="hljs-number">2</span>，WP（写保护，低有效）
        └─→ GPIO_24 (SFC_IO3)    - 数据线 <span class="hljs-number">3</span>，HOLD（保持，低有效）
</code></pre>
<h4 data-id="heading-7">📌 关键差异说明</h4>





















































<table><thead><tr><th>项目</th><th>SPI 模式</th><th>QSPI 模式</th><th>说明</th></tr></thead><tbody><tr><td><strong>CLK</strong></td><td>GPIO_19</td><td>GPIO_19</td><td>始终需要（硬固定）</td></tr><tr><td><strong>CSN</strong></td><td>GPIO_20</td><td>GPIO_20</td><td>始终需要（硬固定）</td></tr><tr><td><strong>MOSI(IO0)</strong></td><td>GPIO_21</td><td>GPIO_21</td><td>始终需要（硬固定）</td></tr><tr><td><strong>MISO(IO1)</strong></td><td>GPIO_22</td><td>GPIO_22</td><td>始终需要（硬固定）</td></tr><tr><td><strong>WP(IO2)</strong></td><td>❌ 不需要</td><td>GPIO_23</td><td>⚠️ QSPI 必需</td></tr><tr><td><strong>HOLD(IO3)</strong></td><td>❌ 不需要</td><td>GPIO_24</td><td>⚠️ QSPI 必需</td></tr><tr><td><strong>总 Pin 数</strong></td><td><strong>4</strong></td><td><strong>6</strong></td><td>+2 pin</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">2️⃣ GPIO Pin 映射</h3>
<h4 data-id="heading-9">🎯 GPIO Pin 定义位置</h4>
<h5 data-id="heading-10"><strong>文件 1</strong>：<a href="https://link.juejin.cn?target=src%2Fdrivers%2Fchips%2Fws63%2Finclude%2Fplatform_core_rom.h" target="_blank" title="src/drivers/chips/ws63/include/platform_core_rom.h" ref="nofollow noopener noreferrer">src/drivers/chips/ws63/include/platform_core_rom.h</a></h5>
<p><strong>位置</strong>：第 50-54 行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span>
    GPIO_00 = <span class="hljs-number">0</span>,
    <span class="hljs-comment">// ... GPIO_01 到 GPIO_18 ...</span>
    GPIO_18 = <span class="hljs-number">18</span>,
    SFC_CLK = <span class="hljs-number">19</span>,      <span class="hljs-comment">// ✅ Flash 时钟</span>
    SFC_CSN = <span class="hljs-number">20</span>,      <span class="hljs-comment">// ✅ 片选（CS#）</span>
    SFC_IO0 = <span class="hljs-number">21</span>,      <span class="hljs-comment">// ✅ MOSI 数据线 0</span>
    SFC_IO1 = <span class="hljs-number">22</span>,      <span class="hljs-comment">// ✅ MISO 数据线 1</span>
    SFC_IO2 = <span class="hljs-number">23</span>,      <span class="hljs-comment">// ⚠️  数据线 2（WP，仅 QSPI）</span>
    SFC_IO3 = <span class="hljs-number">24</span>,      <span class="hljs-comment">// ⚠️  数据线 3（HOLD，仅 QSPI）</span>
    PIN_NONE = <span class="hljs-number">25</span>,
} <span class="hljs-type">pin_t</span>;
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>这些是 <strong>enum 枚举定义</strong>，映射到具体的 GPIO 号（19-24）</li>
<li>GPIO_19-22 是硬件固定分配的 SFC 引脚</li>
<li>GPIO_23-24 是可选的 QSPI 扩展引脚</li>
<li><strong>这是硬件级别的固定连接</strong>，不能改变</li>
</ul>
<hr/>
<h5 data-id="heading-11"><strong>文件 2</strong>：<a href="https://link.juejin.cn?target=src%2Fdrivers%2Fchips%2Fws63%2Fporting%2Fsoc%2Fsoc_porting.c" target="_blank" title="src/drivers/chips/ws63/porting/soc/soc_porting.c" ref="nofollow noopener noreferrer">src/drivers/chips/ws63/porting/soc/soc_porting.c</a></h5>
<p><strong>位置</strong>：第 64-79 行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// PAD 寄存器地址（硬件 Pad Control）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CLK_CTRL  0x4400d868    <span class="hljs-comment">// GPIO_19 的 Pad 控制寄存器</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CSN_CTRL  0x4400d86C    <span class="hljs-comment">// GPIO_20 的 Pad 控制寄存器</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO0_CTRL  0x4400d870    <span class="hljs-comment">// GPIO_21 的 Pad 控制寄存器</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO1_CTRL  0x4400d874    <span class="hljs-comment">// GPIO_22 的 Pad 控制寄存器</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO2_CTRL  0x4400d878    <span class="hljs-comment">// GPIO_23 的 Pad 控制寄存器（QSPI）</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO3_CTRL  0x4400d87C    <span class="hljs-comment">// GPIO_24 的 Pad 控制寄存器（QSPI）</span></span>

<span class="hljs-comment">// 驱动强度 (Drive Strength) 设置</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_CLK_DS_VALUE      0x3       <span class="hljs-comment">// CLK 驱动强度</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_CSN_DS_VALUE      0x2       <span class="hljs-comment">// CSN 驱动强度</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_DATA_DS_VALUE     0x2       <span class="hljs-comment">// 数据线驱动强度</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">config_sfc_ctrl_ds</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    reg_setbits(PAD_SFC_CLK_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_CLK_DS_VALUE);
    reg_setbits(PAD_SFC_CSN_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_CSN_DS_VALUE);
    reg_setbits(PAD_SFC_IO0_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO1_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO2_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO3_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>这是芯片 Pad 控制的硬件寄存器地址</li>
<li>配置了每条线的驱动强度（Drive Strength）</li>
<li>这些地址是芯片级别的固定值（SOC 级别）</li>
<li><strong>不建议修改这些地址</strong>，除非硬件重新设计</li>
</ul>
<hr/>
<h5 data-id="heading-12"><strong>文件 3</strong>：<a href="https://link.juejin.cn?target=src%2Fdrivers%2Fdrivers%2Fhal%2Fpinmux%2Fws63%2Fhal_pinctrl_ws63.c" target="_blank" title="src/drivers/drivers/hal/pinmux/ws63/hal_pinctrl_ws63.c" ref="nofollow noopener noreferrer">src/drivers/drivers/hal/pinmux/ws63/hal_pinctrl_ws63.c</a></h5>
<p><strong>位置</strong>：第 20-27 行（基地址定义）、第 109-140 行（pin 配置组）</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_IO_CFG_BASE_ADDR            0x4400D000</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_SEL_START_OFFSET   0x000</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_UART_SEL_START_OFFSET   0x03C</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_CTRL_START_OFFSET  0x800</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_SFC_CTRL_START_OFFSET   0x868  <span class="hljs-comment">// ✅ SFC pin 控制起始地址</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_SEL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_GPIO_SEL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_UART_SEL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_UART_SEL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_CTRL_START_ADDR    (HAL_IO_CFG_BASE_ADDR + HAL_PIN_GPIO_CTRL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_SFC_CTRL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_SFC_CTRL_START_OFFSET)</span>
</code></pre>
<p><strong>Pin 配置组（第 109-140 行）</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_pull_map[] = {
    {
        GPIO_00,
        GPIO_14,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        <span class="hljs-comment">// ... GPIO_00~14 的上拉/下拉配置 ...</span>
    },
    {
        SFC_CLK,                          <span class="hljs-comment">// GPIO_19</span>
        SFC_IO3,                          <span class="hljs-comment">// GPIO_24</span>
        HAL_PIN_SFC_CTRL_START_ADDR,      <span class="hljs-comment">// 0x4400D868</span>
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_PULL_START_BIT,
        HAL_PIN_PULL_BITS_NUM
    }
};

<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_ds_map[] = {
    {
        GPIO_00,
        GPIO_14,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        <span class="hljs-comment">// ... GPIO_00~14 的驱动强度配置 ...</span>
    },
    {
        SFC_CLK,                          <span class="hljs-comment">// GPIO_19</span>
        SFC_IO3,                          <span class="hljs-comment">// GPIO_24</span>
        HAL_PIN_SFC_CTRL_START_ADDR,      <span class="hljs-comment">// 0x4400D868</span>
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_DS_START_BIT,
        HAL_PIN_DS_BITS_NUM
    }
};

<span class="hljs-comment">// IE（输入使能）配置</span>
<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_ie_map[] = {
    {
        SFC_CLK,      <span class="hljs-comment">// GPIO_19</span>
        SFC_IO3,      <span class="hljs-comment">// GPIO_24</span>
        HAL_PIN_SFC_CTRL_START_ADDR,
        <span class="hljs-comment">// ...</span>
    }
};

<span class="hljs-comment">// ST（Schmitt Trigger）配置</span>
<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_st_map[] = {
    {
        SFC_CLK,      <span class="hljs-comment">// GPIO_19</span>
        SFC_IO3,      <span class="hljs-comment">// GPIO_24</span>
        HAL_PIN_SFC_CTRL_START_ADDR,
        <span class="hljs-comment">// ...</span>
    }
};
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>定义了 SFC 的 pin 控制寄存器基地址</li>
<li>GPIO_19-24 都统一在 <code>HAL_PIN_SFC_CTRL_START_ADDR</code> 配置组中</li>
<li>配置项包括：上拉/下拉、驱动强度、输入使能、施密特触发器</li>
</ul>
<hr/>
<h4 data-id="heading-13">🔄 GPIO Pin 使用流程</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────┐
│ 硬启动/烧录（BootLoader）                           │
├─────────────────────────────────────────────────────┤
│ <span class="hljs-number">1</span>. SFC 硬件自动使用 GPIO_19-<span class="hljs-number">22</span>（SPI 模式）        │
│ <span class="hljs-number">2</span>. soc_porting<span class="hljs-selector-class">.c</span> 配置 Pad 驱动强度                 │
│    └─ <span class="hljs-built_in">config_sfc_ctrl_ds</span>()                         │
└──────────┬──────────────────────────────────────────┘
           │
┌──────────▼──────────────────────────────────────────┐
│ 应用启动（APP 阶段）                               │
├─────────────────────────────────────────────────────┤
│ <span class="hljs-number">1</span>. sfc<span class="hljs-selector-class">.c</span> 调用 <span class="hljs-built_in">hal_sfc_init</span>()                       │
│ <span class="hljs-number">2</span>. hal_pinctrl_ws63<span class="hljs-selector-class">.c</span> 配置 pin 属性                │
│    └─ 拉高/拉低、驱动强度等                       │
│ <span class="hljs-number">3</span>. SFC 驱动初始化完成                              │
└─────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-14">3️⃣ 编译配置开关</h3>
<h4 data-id="heading-15">📚 Kconfig 配置文件位置</h4>
<h5 data-id="heading-16"><strong>文件 1</strong>：<a href="https://link.juejin.cn?target=src%2Fdrivers%2Fdrivers%2FKconfig" target="_blank" title="src/drivers/drivers/Kconfig" ref="nofollow noopener noreferrer">src/drivers/drivers/Kconfig</a></h5>
<p><strong>位置</strong>：第 387-403 行</p>
<pre><code class="hljs language-kconfig" lang="kconfig">config DRIVER_SUPPORT_SFC
    bool
    prompt "SFC"
    default y
    help
        This option means support SFC.

if DRIVER_SUPPORT_SFC
menu "SFC Configuration"
    comment "Config  SFC"
    osource "drivers/drivers/driver/sfc/Kconfig"
    osource "drivers/drivers/hal/sfc/Kconfig"
endmenu
endif

config DRIVER_SUPPORT_SPI
    bool
    prompt "SPI"
    default n
    help
        This option means support SPI.

if DRIVER_SUPPORT_SPI
menu "SPI Configuration"
    comment "Config SPI"
    osource "drivers/drivers/driver/spi/Kconfig"
    osource "drivers/drivers/hal/spi/Kconfig"
endmenu
endif
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>CONFIG_DRIVER_SUPPORT_SFC</code> - SFC 驱动总开关（<strong>默认启用</strong>）</li>
<li><code>CONFIG_DRIVER_SUPPORT_SPI</code> - 通用 SPI 驱动总开关（<strong>默认禁用</strong>）</li>
<li><strong>关键点</strong>：SFC 和 SPI 是分别的驱动，不会直接冲突</li>
</ul>
<hr/>
<h5 data-id="heading-17"><strong>文件 2</strong>：<a href="https://link.juejin.cn?target=src%2Fdrivers%2Fchips%2Fws63%2From%2Fdrivers%2Fdrivers%2Fdriver%2Fsfc%2FKconfig" target="_blank" title="src/drivers/chips/ws63/rom/drivers/drivers/driver/sfc/Kconfig" ref="nofollow noopener noreferrer">src/drivers/chips/ws63/rom/drivers/drivers/driver/sfc/Kconfig</a></h5>
<p><strong>位置</strong>：完整内容</p>
<pre><code class="hljs language-kconfig" lang="kconfig">#===============================================================================
# @brief    Kconfig file.
# Copyright (c) HiSilicon (Shanghai) Technologies Co., Ltd. 2022-2022. All rights reserved.
#===============================================================================
config SFC_SUPPORT_DMA
    bool
    prompt "SFC Support DMA"
    default y
    depends on DRIVER_SUPPORT_SFC

config SFC_ALLOW_ERASE_WRITEBACK
    bool
    prompt "Allows Erase at Any Address, needs 4KB RAM at least"
    default n
    depends on DRIVER_SUPPORT_SFC

config SFC_ALREADY_INIT
    bool
    prompt "SFC has been inited, need not to set reg in init/deinit func."
    default n
    depends on DRIVER_SUPPORT_SFC
</code></pre>
<p><strong>SFC 相关配置</strong>：</p>





























<table><thead><tr><th>配置项</th><th>说明</th><th>默认值</th><th>用途</th></tr></thead><tbody><tr><td><code>CONFIG_SFC_SUPPORT_DMA</code></td><td>启用 DMA 传输</td><td><code>y</code>（启用）</td><td>提高传输速度</td></tr><tr><td><code>CONFIG_SFC_ALLOW_ERASE_WRITEBACK</code></td><td>允许任意地址擦除</td><td><code>n</code>（禁用）</td><td>需要额外 4KB RAM</td></tr><tr><td><code>CONFIG_SFC_ALREADY_INIT</code></td><td>Skip 初始化</td><td><code>n</code>（禁用）</td><td>BootLoader 已初始化时</td></tr></tbody></table>
<p><strong>⚠️ 重要</strong>：</p>
<ul>
<li><strong>这些配置中没有 QSPI/SPI 模式选择开关</strong></li>
<li><strong>QSPI 模式是由 Flash 芯片本身决定的</strong>（Flash 支持 QSPI 就自动启用）</li>
</ul>
<hr/>
<h5 data-id="heading-18"><strong>文件 3</strong>：<a href="https://link.juejin.cn?target=src%2Fapplication%2Fsamples%2Fperipheral%2Fspi%2FKconfig" target="_blank" title="src/application/samples/peripheral/spi/Kconfig" ref="nofollow noopener noreferrer">src/application/samples/peripheral/spi/Kconfig</a></h5>
<p><strong>位置</strong>：第 49-77 行（SPI Master QSPI 支持）</p>
<pre><code class="hljs language-kconfig" lang="kconfig">config SPI_MASTER_SUPPORT_QSPI
    bool
    prompt "SPI master support QSPI."
    depends on SAMPLE_SUPPORT_SPI_MASTER
    default n

config SPI_MASTER_D3_PIN_MODE
    int
    prompt "Choose QSPI master D3 pin mode."
    depends on SPI_MASTER_SUPPORT_QSPI
    default 1

config SPI_MASTER_D2_PIN_MODE
    int
    prompt "Choose QSPI master D2 pin mode."
    depends on SPI_MASTER_SUPPORT_QSPI
    default 1

config SPI_MASTER_D3_PIN
    int
    prompt "Choose QSPI master D3 pin."
    depends on SPI_MASTER_SUPPORT_QSPI
    default 40

config SPI_MASTER_D2_PIN
    int
    prompt "Choose QSPI master D2 pin."
    depends on SPI_MASTER_SUPPORT_QSPI
    default 41
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>这是 <strong>通用 SPI 模块</strong>（不是 SFC）的 QSPI 配置</li>
<li>支持用户自定义 D2/D3 pin（GPIO_40、GPIO_41 等）</li>
<li><strong>这不影响 SFC 的 GPIO_23-24</strong></li>
</ul>
<hr/>
<h4 data-id="heading-19">📊 当前项目配置状态</h4>
<h5 data-id="heading-20"><strong>文件</strong>：<a href="https://link.juejin.cn?target=src%2Fbuild%2Fconfig%2Ftarget_config%2Fws63%2Fmenuconfig%2Facore%2Fws63_liteos_app.config" target="_blank" title="src/build/config/target_config/ws63/menuconfig/acore/ws63_liteos_app.config" ref="nofollow noopener noreferrer">src/build/config/target_config/ws63/menuconfig/acore/ws63_liteos_app.config</a></h5>
<p><strong>位置</strong>：第 357-383 行</p>
<pre><code class="hljs language-config" lang="config">#
# SFC Configuration
#

#
# Config  SFC
#
# CONFIG_SFC_SUPPORT_DMA is not set
# CONFIG_SFC_ALLOW_ERASE_WRITEBACK is not set
# CONFIG_SFC_ALREADY_INIT is not set
# CONFIG_SFC_SUPPORT_LPM is not set
# CONFIG_SFC_SUPPORT_SFC_LOCK is not set
# CONFIG_SFC_SUPPORT_DATA_CACHE is not set
# CONFIG_SFC_SUPPORT_RWE_INDEPENDENT is not set
# CONFIG_SFC_SUPPORT_WRITE_PROTECT is not set
# CONFIG_SFC_USE_CUSTOMIZED_DEVICE_INFO is not set
# CONFIG_SFC_DEBUG is not set
# end of SFC Configuration

CONFIG_DRIVER_SUPPORT_SPI=y

#
# SPI Configuration
#

#
# Config SPI
#
# CONFIG_SPI_SUPPORT_MASTER is not set
# CONFIG_SPI_SUPPORT_SLAVE is not set
# CONFIG_SPI_SUPPORT_DMA is not set
# CONFIG_SPI_SUPPORT_INTERRUPT is not set
# CONFIG_SPI_SUPPORT_CONCURRENCY is not set
# CONFIG_SPI_SUPPORT_LOOPBACK is not set
# CONFIG_SPI_SUPPORT_CRC is not set
</code></pre>
<p><strong>当前配置分析</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">✅ 启用的配置：
   └─ CONFIG_DRIVER_SUPPORT_SFC=y         （SFC 驱动启用）
   └─ CONFIG_DRIVER_SUPPORT_SPI=y         （<span class="hljs-built_in">SPI</span> 驱动启用）

❌ 禁用的配置：
   └─ CONFIG_SFC_SUPPORT_DMA              （DMA 禁用 - 仅寄存器模式）
   └─ CONFIG_SPI_SUPPORT_MASTER           （通用 <span class="hljs-built_in">SPI</span> Master 禁用）
   └─ CONFIG_SPI_SUPPORT_SLAVE            （通用 <span class="hljs-built_in">SPI</span> Slave 禁用）
   └─ CONFIG_SPI_SUPPORT_DMA              （<span class="hljs-built_in">SPI</span> DMA 禁用）

⚠️  关键发现：
   • SFC 没有显式的 <span class="hljs-built_in">SPI</span>/QSPI 模式开关
   • QSPI 模式由 Flash 芯片自动检测和启用
   • 当前使用的是寄存器模式（非 DMA），较低效率
</code></pre>
<hr/>
<h4 data-id="heading-21">🔍 模式配置决策流程</h4>
<pre><code class="hljs language-arduino" lang="arduino">硬件检测 Flash 芯片
        │
        ├─→ 识别 Flash ID
        │   └─ sfc.c line <span class="hljs-number">151</span>
        │       <span class="hljs-built_in">build_cmds</span>(flash_id, ...)
        │
        └─→ 查询 Flash 支持的模式
            └─ flash_config_info.c
                <span class="hljs-type">flash_spi_info_t</span> 中的 quad_mode

            ├─ quad_mode != <span class="hljs-literal">NULL</span>
            │  └─→ 此 Flash 支持 QSPI
            │      ├─ 自动启用 GPIO_23<span class="hljs-number">-24</span>
            │      └─ 配置 QSPI 指令
            │
            └─ quad_mode == <span class="hljs-literal">NULL</span>
               └─→ 此 Flash 仅支持 <span class="hljs-built_in">SPI</span>
                   ├─ 仅使用 GPIO_19<span class="hljs-number">-22</span>
                   └─ 配置 <span class="hljs-built_in">SPI</span> 指令
</code></pre>
<hr/>
<h3 data-id="heading-22">4️⃣ GPIO 重新布线修改清单</h3>
<h4 data-id="heading-23">⚠️ 硬件GPIO固定性警告</h4>
<pre><code class="hljs language-markdown" lang="markdown">❌ 【不可修改】硬件固定的 GPIO 映射：

<span class="hljs-code">    GPIO_19 ←→ SFC_CLK（硬线连接）
    GPIO_20 ←→ SFC_CSN（硬线连接）
    GPIO_21 ←→ SFC_IO0/MOSI（硬线连接）
    GPIO_22 ←→ SFC_IO1/MISO（硬线连接）
    GPIO_23 ←→ SFC_IO2/WP（硬线连接）
    GPIO_24 ←→ SFC_IO3/HOLD（硬线连接）
</span>
这些是芯片设计阶段的硬连接，无法通过软件修改。
</code></pre>
<h4 data-id="heading-24">📝 若<strong>硬件重新设计</strong>需要修改GPIO</h4>
<p><strong>假设新硬件使用了不同的 GPIO 引脚</strong>，需要修改以下位置：</p>
<h5 data-id="heading-25"><strong>1️⃣ platform_core_rom.h</strong></h5>
<p><strong>文件位置</strong>：<a href="https://link.juejin.cn?target=src%2Fdrivers%2Fchips%2Fws63%2Finclude%2Fplatform_core_rom.h" target="_blank" title="src/drivers/chips/ws63/include/platform_core_rom.h" ref="nofollow noopener noreferrer">src/drivers/chips/ws63/include/platform_core_rom.h</a></p>
<p><strong>原内容</strong>（第 50-54 行）：</p>
<pre><code class="hljs language-c" lang="c">SFC_CLK = <span class="hljs-number">19</span>,
SFC_CSN = <span class="hljs-number">20</span>,
SFC_IO0 = <span class="hljs-number">21</span>,
SFC_IO1 = <span class="hljs-number">22</span>,
SFC_IO2 = <span class="hljs-number">23</span>,
SFC_IO3 = <span class="hljs-number">24</span>,
</code></pre>
<p><strong>修改示例</strong>（假设新硬件用不同 GPIO）：</p>
<pre><code class="hljs language-c" lang="c">SFC_CLK = <span class="hljs-number">25</span>,    <span class="hljs-comment">// 改为 GPIO_25</span>
SFC_CSN = <span class="hljs-number">26</span>,    <span class="hljs-comment">// 改为 GPIO_26</span>
SFC_IO0 = <span class="hljs-number">27</span>,    <span class="hljs-comment">// 改为 GPIO_27</span>
SFC_IO1 = <span class="hljs-number">28</span>,    <span class="hljs-comment">// 改为 GPIO_28</span>
SFC_IO2 = <span class="hljs-number">29</span>,    <span class="hljs-comment">// 改为 GPIO_29（QSPI）</span>
SFC_IO3 = <span class="hljs-number">30</span>,    <span class="hljs-comment">// 改为 GPIO_30（QSPI）</span>
</code></pre>
<p><strong>修改步骤</strong>：</p>
<ol>
<li>确定新的 GPIO 号（需要硬件原理图确认）</li>
<li>修改 enum 中的数值</li>
<li>确保新 GPIO 号在有效范围内（0-45 以内）</li>
</ol>
<hr/>
<h5 data-id="heading-26"><strong>2️⃣ soc_porting.c（Pad 控制寄存器地址）</strong></h5>
<p><strong>文件位置</strong>：<a href="https://link.juejin.cn?target=src%2Fdrivers%2Fchips%2Fws63%2Fporting%2Fsoc%2Fsoc_porting.c" target="_blank" title="src/drivers/chips/ws63/porting/soc/soc_porting.c" ref="nofollow noopener noreferrer">src/drivers/chips/ws63/porting/soc/soc_porting.c</a></p>
<p><strong>原内容</strong>（第 64-67 行）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CLK_CTRL   0x4400d868</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CSN_CTRL   0x4400d86C</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO0_CTRL   0x4400d870</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO1_CTRL   0x4400d874</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO2_CTRL   0x4400d878</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO3_CTRL   0x4400d87C</span>
</code></pre>
<p><strong>修改说明</strong>：</p>
<ul>
<li>这些寄存器地址来自 <strong>WS63 芯片设计文档</strong></li>
<li>每个新 GPIO 号对应新的寄存器地址</li>
<li><strong>需要查阅 WS63 数据手册</strong>获取新地址</li>
</ul>
<p><strong>修改示例</strong>（假设新 GPIO 的 Pad 地址）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CLK_CTRL   0x4400d880    <span class="hljs-comment">// 新地址</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CSN_CTRL   0x4400d884</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO0_CTRL   0x4400d888</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO1_CTRL   0x4400d88C</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO2_CTRL   0x4400d890</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO3_CTRL   0x4400d894</span>
</code></pre>
<hr/>
<h5 data-id="heading-27"><strong>3️⃣ hal_pinctrl_ws63.c</strong></h5>
<p><strong>文件位置</strong>：<a href="https://link.juejin.cn?target=src%2Fdrivers%2Fdrivers%2Fhal%2Fpinmux%2Fws63%2Fhal_pinctrl_ws63.c" target="_blank" title="src/drivers/drivers/hal/pinmux/ws63/hal_pinctrl_ws63.c" ref="nofollow noopener noreferrer">src/drivers/drivers/hal/pinmux/ws63/hal_pinctrl_ws63.c</a></p>
<p><strong>原内容</strong>（第 109-140 行）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_pull_map[] = {
    {
        GPIO_00,
        GPIO_14,
        <span class="hljs-comment">// ... GPIO_00~14 ...</span>
    },
    {
        SFC_CLK,    <span class="hljs-comment">// = 19</span>
        SFC_IO3,    <span class="hljs-comment">// = 24</span>
        HAL_PIN_SFC_CTRL_START_ADDR,
        <span class="hljs-comment">// ...</span>
    }
};
</code></pre>
<p><strong>修改说明</strong>：</p>
<ul>
<li>如果新 GPIO 号仍在连续范围内（如 25-30），只需修改 begin 和 end</li>
<li>如果分散在不同范围，可能需要新增配置组</li>
</ul>
<p><strong>修改示例</strong>（假设新 GPIO 为 25-30）：</p>
<pre><code class="hljs language-c" lang="c">{
    SFC_CLK,        <span class="hljs-comment">// 新定义为 GPIO_25</span>
    SFC_IO3,        <span class="hljs-comment">// 新定义为 GPIO_30</span>
    HAL_PIN_SFC_CTRL_START_ADDR,  <span class="hljs-comment">// 使用新的基地址</span>
    HAL_PIN_CONFIG_PER_NUM,
    HAL_PIN_PULL_START_BIT,
    HAL_PIN_PULL_BITS_NUM
}
</code></pre>
<hr/>
<h4 data-id="heading-28">🚫 Kconfig 中<strong>无需修改</strong>的内容</h4>
<pre><code class="hljs language-bash" lang="bash">✅ Kconfig 文件：
   • src/drivers/drivers/Kconfig
   • src/drivers/chips/ws63/rom/drivers/drivers/driver/sfc/Kconfig
   • src/application/samples/peripheral/spi/Kconfig

为什么？
   ├─ GPIO pin 号不在 Kconfig 中硬编码
   ├─ Kconfig 只控制功能启用/禁用开关
   └─ Pin 映射在源代码中定义，不在配置中
</code></pre>
<hr/>
<h4 data-id="heading-29">✅ 完整修改检查清单</h4>
<h5 data-id="heading-30">如果只是普通项目（不改硬件GPIO）：</h5>
<pre><code class="hljs">✅ 检查项：
   ☐ 确认当前 GPIO_19-24 在硬件上连接正确
   ☐ 检查原理图中 Flash pin 的物理连接
   ☐ 验证电源和 GND 连接
   ☐ 确保 Flash 芯片规格书中支持当前固件
   
❌ 无需修改任何代码
</code></pre>
<h5 data-id="heading-31">如果需要硬件gpio重新布线：</h5>
<pre><code class="hljs language-markdown" lang="markdown">✅ 修改步骤：
<span class="hljs-bullet">   1.</span> 获取硬件原理图
<span class="hljs-bullet">   2.</span> 确定新 GPIO 号和 Pad 寄存器地址
<span class="hljs-bullet">   3.</span> 修改 platform<span class="hljs-emphasis">_core_</span>rom.h（GPIO 号）
<span class="hljs-bullet">   4.</span> 修改 soc<span class="hljs-emphasis">_porting.c（Pad 控制地址）
   5. 修改 hal_</span>pinctrl<span class="hljs-emphasis">_ws63.c（pin 配置范围）
   6. 编译验证
   7. 烧录 BootLoader 执行初始化

🔧 工具需求：
   • WS63 数据手册（获取 Pad 地址）
   • FlashTool 重新烧录 BootLoader
   • 硬件测试工具（示波器、逻辑分析仪）
</span></code></pre>
<hr/>
<h3 data-id="heading-32">5️⃣ 代码路径汇总</h3>
<h4 data-id="heading-33">📁 文件结构图</h4>
<pre><code class="hljs language-erlang" lang="erlang">fbb_ws63-master/
├── src/drivers/
│   ├── chips/ws63/
│   │   ├── include/
│   │   │   ├── platform_core_rom.h                ⭐ GPIO 枚举定义
│   │   │   └── ...
│   │   ├── porting/
│   │   │   ├── soc/
│   │   │   │   └── soc_porting.c                 ⭐ Pad 寄存器地址
│   │   │   ├── sfc/
│   │   │   │   ├── sfc_porting.h                 📋 SFC 配置结构体
│   │   │   │   ├── porting/
│   │   │   │   │   └── sfc_porting.c             ⭐ SFC 寄存器基地址
│   │   │   │   ├── driver/
│   │   │   │   │   └── sfc.c                     💻 SFC 驱动核心
│   │   │   │   └── flash_config/
│   │   │   │       └── flash_config_info.c       📊 Flash 芯片配置
│   │   │   └── ...
│   │   └── ...
│   ├── drivers/
│   │   ├── hal/
│   │   │   ├── pinmux/ws63/
│   │   │   │   └── hal_pinctrl_ws63.c            ⭐ Pin 控制配置
│   │   │   ├── sfc/
│   │   │   │   └── hal_sfc_v150.c               💻 SFC HAL 层
│   │   │   └── ...
│   │   ├── Kconfig                               📝 驱动配置开关
│   │   └── ...
│   └── ...
├── src/application/
│   └── samples/
│       └── peripheral/
│           ├── spi/
│           │   ├── Kconfig                       📝 SPI 配置开关
│           │   └── spi_master_demo.c             📜 SPI Master 示例
│           └── sfc/
│               └── sfc_demo.c                    📜 SFC 使用示例
├── src/build/
│   ├── config/
│   │   └── target_config/ws63/menuconfig/acore/
│   │       ├── ws63_liteos_app.config            ⚙️  APP 配置
│   │       ├── ws63_flashboot.config             ⚙️  BootLoader 配置
│   │       └── ws63_liteos_testsuite.config      ⚙️  测试套件配置
│   └── ...
└── ...
</code></pre>
<hr/>
<h4 data-id="heading-34">🔑 核心文件详解</h4>


















































































<table><thead><tr><th>#</th><th>文件名</th><th>路径</th><th>功能</th><th>修改频率</th></tr></thead><tbody><tr><td>1</td><td><strong>platform_core_rom.h</strong></td><td><code>src/drivers/chips/ws63/include/</code></td><td>GPIO 枚举定义（GPIO_19-24）</td><td>🔴 极少修改</td></tr><tr><td>2</td><td><strong>soc_porting.c</strong></td><td><code>src/drivers/chips/ws63/porting/soc/</code></td><td>Pad 寄存器地址 &amp; 驱动强度配置</td><td>🔴 极少修改</td></tr><tr><td>3</td><td><strong>hal_pinctrl_ws63.c</strong></td><td><code>src/drivers/drivers/hal/pinmux/ws63/</code></td><td>Pin 控制配置映射表</td><td>🟡 如果改GPIO</td></tr><tr><td>4</td><td><strong>sfc_porting.h</strong></td><td><code>src/drivers/chips/ws63/porting/sfc/</code></td><td>SFC 配置结构体定义</td><td>🟢 可配置</td></tr><tr><td>5</td><td><strong>sfc_porting.c</strong></td><td><code>src/drivers/chips/ws63/porting/sfc/porting/</code></td><td>SFC 寄存器基地址</td><td>🔴 固定</td></tr><tr><td>6</td><td><strong>sfc.c</strong></td><td><code>src/drivers/chips/ws63/porting/sfc/driver/</code></td><td>SFC 驱动实现</td><td>🟢 按需配置</td></tr><tr><td>7</td><td><strong>flash_config_info.c</strong></td><td><code>src/drivers/chips/ws63/porting/sfc/flash_config/</code></td><td>Flash 芯片数据库</td><td>🟢 新芯片需添加</td></tr><tr><td>8</td><td><strong>hal_sfc_v150.c</strong></td><td><code>src/drivers/drivers/hal/sfc/</code></td><td>SFC 硬件抽象层</td><td>🔴 极少修改</td></tr><tr><td>9</td><td><strong>Kconfig</strong></td><td><code>src/drivers/drivers/</code></td><td>驱动功能开关</td><td>🟡 按项目需求</td></tr><tr><td>10</td><td><strong>.config</strong></td><td><code>src/build/config/target_config/ws63/</code></td><td>当前编译配置</td><td>🟢 频繁修改</td></tr></tbody></table>
<p><strong>图例</strong>：</p>
<ul>
<li>🔴 红色：硬件固定，极少改动</li>
<li>🟡 黄色：特定场景修改</li>
<li>🟢 绿色：常规配置和定制</li>
</ul>
<hr/>
<h4 data-id="heading-35">🔍 功能追踪</h4>
<h5 data-id="heading-36"><strong>"如何启用 QSPI 模式？"追踪</strong></h5>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 硬件检测阶段
   └─ sfc.c:151
<span class="hljs-code">       uapi_sfc_init() 入口
           ↓
       build_cmds(flash_id, ...)
           ↓
</span>
<span class="hljs-bullet">2.</span> Flash 芯片查询
   └─ flash<span class="hljs-emphasis">_config_</span>info.c
<span class="hljs-code">       查询 flash_spi_info_t 数组
       找到匹配的 flash_id
           ↓
</span>
<span class="hljs-bullet">3.</span> 模式自动选择
   └─ sfc.c:67
<span class="hljs-code">       if (spi_info-&gt;quad_mode != NULL)
           ├─ QSPI 支持
           │  ├─ 自动启用 GPIO_23-24
           │  ├─ 加载 QSPI 指令序列
           │  └─ 配置 Quad SPI 模式
           └─ SPI 仅支持
              ├─ 仅使用 GPIO_19-22
              ├─ 加载 SPI 指令
              └─ 配置标准 SPI 模式
</span>
<span class="hljs-bullet">4.</span> HAL 层初始化
   └─ hal<span class="hljs-emphasis">_sfc_</span>v150.c
<span class="hljs-code">       hal_sfc_init()
       根据 quad_mode 参数配置硬件
           ↓
</span>
<span class="hljs-bullet">5.</span> 完成
   └─ 驱动自动运行于最优模式
</code></pre>
<hr/>
<h5 data-id="heading-37"><strong>"如何修改 Flash 配置？"追踪</strong></h5>
<pre><code class="hljs language-ini" lang="ini">1. 找到使用的 Flash 芯片型号
   └─ 硬件原理图 → Flash 芯片手册

2. 检查 flash_config_info.c
   └─ 查找对应的 FLASH_XXX ID 定义
       是否存在该芯片配置

3. 如果已有配置
   └─ sfc.c 会自动使用
   └─ 无需修改代码

4. 如果无该配置
   └─ flash_config_info.c
       仿照现有格式添加该 Flash 配置
           ├─ .<span class="hljs-attr">chip_id</span> = <span class="hljs-number">0</span>xXXXXXX
           ├─ .read_cmds<span class="hljs-section">[]</span> = { ... }
           ├─ .write_cmds<span class="hljs-section">[]</span> = { ... }
           ├─ .erase_cmds<span class="hljs-section">[]</span> = { ... }
           └─ .<span class="hljs-attr">quad_mode</span> = &amp;cmd_seq  (如果支持)

5. 重新编译烧录
</code></pre>
<hr/>
<h4 data-id="heading-38">🎯 快速查找表</h4>
<p><strong>我想要配置...</strong></p>

































































<table><thead><tr><th>需求</th><th>文件</th><th>行号</th><th>说明</th></tr></thead><tbody><tr><td>查看 GPIO 定义</td><td>platform_core_rom.h</td><td>50-54</td><td>enum GPIO 编号</td></tr><tr><td>改变 GPIO 号</td><td>platform_core_rom.h</td><td>50-54</td><td>修改枚举值</td></tr><tr><td>调整驱动强度</td><td>soc_porting.c</td><td>70-71</td><td>SFC_CLK_DS_VALUE 等</td></tr><tr><td>启用 DMA</td><td>Kconfig</td><td>配置菜单</td><td>CONFIG_SFC_SUPPORT_DMA</td></tr><tr><td>添加新 Flash</td><td>flash_config_info.c</td><td>全文</td><td>仿照现有条目添加</td></tr><tr><td>启用 Quad 模式</td><td>自动</td><td>-</td><td>Flash 自动检测</td></tr><tr><td>查看 SFC 初始化</td><td>sfc.c</td><td>145-170</td><td>uapi_sfc_init() 函数</td></tr><tr><td>查看 Pin 配置</td><td>hal_pinctrl_ws63.c</td><td>109-140</td><td>g_pin_xxx_map 数组</td></tr><tr><td>禁用 SFC</td><td>Kconfig</td><td>驱动菜单</td><td>CONFIG_DRIVER_SUPPORT_SFC</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-39">🎓 总结对比表</h3>
<h4 data-id="heading-40">SPI vs QSPI 模式：硬件视角</h4>
<pre><code class="hljs language-scss" lang="scss">┌──────────────┬─────────────────┬─────────────────┐
│ 特性         │ SPI 模式        │ QSPI 模式       │
├──────────────┼─────────────────┼─────────────────┤
│ GPIO pin     │ GPIO_19~<span class="hljs-number">22</span>      │ GPIO_19~<span class="hljs-number">24</span>      │
│ 总数         │ <span class="hljs-number">4</span> 条            │ <span class="hljs-number">6</span> 条            │
│ CLK          │ GPIO_19         │ GPIO_19         │
│ CSN          │ GPIO_20         │ GPIO_20         │
│ <span class="hljs-built_in">MOSI</span>(IO0)    │ GPIO_21         │ GPIO_21         │
│ <span class="hljs-built_in">MISO</span>(IO1)    │ GPIO_22         │ GPIO_22         │
│ <span class="hljs-built_in">WP</span>(IO2)      │ ❌ 不需要       │ GPIO_23         │
│ <span class="hljs-built_in">HOLD</span>(IO3)    │ ❌ 不需要       │ GPIO_24         │
│ 驱动强度     │ 在 soc_porting<span class="hljs-selector-class">.c</span> 中配置 | 同左   │
│ Pad 寄存器   │ <span class="hljs-number">0</span>x4400d868-<span class="hljs-number">74</span>   │ <span class="hljs-number">0</span>x4400d868-<span class="hljs-number">7</span>C   │
│ 数据线数     │ <span class="hljs-number">1</span>(收) + <span class="hljs-number">1</span>(发)   │ <span class="hljs-number">4</span> 线双向        │
│ 传输速率     │ 基线            │ ~<span class="hljs-number">4</span>x 快速        │
│ Pin 配置文件 │ hal_pinctrl_ws63<span class="hljs-selector-class">.c</span> （统一）       │
└──────────────┴─────────────────┴─────────────────┘
</code></pre>
<h4 data-id="heading-41">编译配置：当前项目状态</h4>
<pre><code class="hljs language-ini" lang="ini">├─ <span class="hljs-attr">CONFIG_DRIVER_SUPPORT_SFC</span>=y       ✅ SFC 驱动启用
├─ <span class="hljs-attr">CONFIG_DRIVER_SUPPORT_SPI</span>=y       ✅ 通用 SPI 启用（但无 Master）
├─ CONFIG_SFC_SUPPORT_DMA 未设       ❌ 禁用 DMA（低性能）
│
└─ 当前模式自动检测：
    Flash 支持 QUAD → 自动启用 QSPI（GPIO_19-24）
    Flash 仅支持 SPI → 使用 SPI 模式（GPIO_19-22）
</code></pre>
<h4 data-id="heading-42">修改需求清单</h4>
<pre><code class="hljs language-arduino" lang="arduino">场景 <span class="hljs-number">1</span>：仅使用现有硬件（GPIO_19<span class="hljs-number">-24</span>）
   修改文件：无
   重编译：仅需更新 .config（如启用 DMA）
   
场景 <span class="hljs-number">2</span>：更换不同 Flash 芯片（同 GPIO）
   修改文件：可能需要 flash_config_info.c
   重编译：仅驱动代码
   
场景 <span class="hljs-number">3</span>：重新设计硬件（不同 GPIO）
   修改文件：
      ✏️  platform_core_rom.h（GPIO 枚举）
      ✏️  soc_porting.c（Pad 地址）
      ✏️  hal_pinctrl_ws63.c（Pin 配置）
   重编译：整个驱动 + BootLoader
   烧录：重新初始化硬件
</code></pre>
<hr/>
<h3 data-id="heading-43">📚 参考资源</h3>






























<table><thead><tr><th>资源</th><th>位置</th><th>用途</th></tr></thead><tbody><tr><td><strong>WS63 数据手册</strong></td><td>（硬件文档）</td><td>Pad 地址、GPIO 定义</td></tr><tr><td><strong>GPIO_LITTLEFS_ANALYSIS.md</strong></td><td>项目根目录</td><td>GPIO 配置详解</td></tr><tr><td><strong>SFC_GPIO_PIN_MAPPING.md</strong></td><td>AI/ 文件夹</td><td>Pin 映射参考</td></tr><tr><td><strong>NOR_FLASH_CONFIG_PARAMETER_GUIDE.md</strong></td><td>AI/ 文件夹</td><td>Flash 配置指南</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-44">❓ 常见问题解答</h3>
<h4 data-id="heading-45">Q1：能否改变 GPIO_19-24 的引脚号？</h4>
<p><strong>A</strong>：不能。这是硬件级别的固定连接。SFC 硬件内部已直接连接到这些 GPIO，改需要重新设计芯片。</p>
<h4 data-id="heading-46">Q2：SPI 和 QSPI 是否可以同时启用？</h4>
<p><strong>A</strong>：在 SFC 驱动中，Flash 自动选择一种模式。但通用 SPI 模块可独立使用不同 GPIO（如 GPIO_40-41），与 SFC 无冲突。</p>
<h4 data-id="heading-47">Q3：为什么配置中没有 QSPI 开关？</h4>
<p><strong>A</strong>：因为 QSPI 模式由 Flash 芯片决定。SFC 驱动自动检测 Flash 是否支持 Quad 模式，无需手动开关。</p>
<h4 data-id="heading-48">Q4：修改了 GPIO 定义后编译不过怎么办？</h4>
<p><strong>A</strong>：</p>
<ol>
<li>检查新 GPIO 号是否超出有效范围（0-45）</li>
<li>更新所有涉及的文件（platform_core_rom.h、soc_porting.c、hal_pinctrl_ws63.c）</li>
<li>清理编译缓存：<code>rm -rf src/build/cmake_build</code></li>
<li>重新编译</li>
</ol>
<h4 data-id="heading-49">Q5：GPIO_23-24 可以用于其他功能吗？</h4>
<p><strong>A</strong>：如果 Flash 不支持 QSPI，这两个 GPIO 理论上可复用。但不建议：</p>
<ul>
<li>硬件设计通常已连接到 Flash</li>
<li>会使代码维护复杂化</li>
<li>可用的 GPIO 有其他选项（GPIO_0-18, GPIO_25+）</li>
</ul>
<hr/>
<p><strong>文档更新时间</strong>：2025-02 | <strong>FBB_WS63 版本</strong>：最新 | <strong>适用范围</strong>：SPI/QSPI 配置</p>
<p>————————————————————————————————————————————————————--——————</p>
<h2 data-id="heading-50">FBB_WS63 SFC GPIO 修改代码示例</h2>
<h3 data-id="heading-51">🎯 使用场景：假设需要改变 GPIO 映射</h3>
<p>假定原硬件使用 GPIO_19-24，现在需要改为 GPIO_25-30（仅作示例）</p>
<hr/>
<h3 data-id="heading-52">模板 1：platform_core_rom.h 修改示例</h3>
<h4 data-id="heading-53">原始代码</h4>
<p><strong>文件</strong>：<code>src/drivers/chips/ws63/include/platform_core_rom.h</code>
<strong>行号</strong>：45-60</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/**
 * @brief Definition of pin.
 */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span>
    GPIO_00 = <span class="hljs-number">0</span>,
    GPIO_01 = <span class="hljs-number">1</span>,
    GPIO_02 = <span class="hljs-number">2</span>,
    GPIO_03 = <span class="hljs-number">3</span>,
    GPIO_04 = <span class="hljs-number">4</span>,
    GPIO_05 = <span class="hljs-number">5</span>,
    GPIO_06 = <span class="hljs-number">6</span>,
    GPIO_07 = <span class="hljs-number">7</span>,
    GPIO_08 = <span class="hljs-number">8</span>,
    GPIO_09 = <span class="hljs-number">9</span>,
    GPIO_10 = <span class="hljs-number">10</span>,
    GPIO_11 = <span class="hljs-number">11</span>,
    GPIO_12 = <span class="hljs-number">12</span>,
    GPIO_13 = <span class="hljs-number">13</span>,
    GPIO_14 = <span class="hljs-number">14</span>,
    GPIO_15 = <span class="hljs-number">15</span>,
    GPIO_16 = <span class="hljs-number">16</span>,
    GPIO_17 = <span class="hljs-number">17</span>,
    GPIO_18 = <span class="hljs-number">18</span>,
    SFC_CLK = <span class="hljs-number">19</span>,      <span class="hljs-comment">// ← 原值</span>
    SFC_CSN = <span class="hljs-number">20</span>,      <span class="hljs-comment">// ← 原值</span>
    SFC_IO0 = <span class="hljs-number">21</span>,      <span class="hljs-comment">// ← 原值</span>
    SFC_IO1 = <span class="hljs-number">22</span>,      <span class="hljs-comment">// ← 原值</span>
    SFC_IO2 = <span class="hljs-number">23</span>,      <span class="hljs-comment">// ← 原值</span>
    SFC_IO3 = <span class="hljs-number">24</span>,      <span class="hljs-comment">// ← 原值</span>
    PIN_NONE = <span class="hljs-number">25</span>, <span class="hljs-comment">// used as invalid/unused PIN number</span>
} <span class="hljs-type">pin_t</span>;
</code></pre>
<h4 data-id="heading-54">修改后的代码</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/**
 * @brief Definition of pin.
 */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span>
    GPIO_00 = <span class="hljs-number">0</span>,
    GPIO_01 = <span class="hljs-number">1</span>,
    GPIO_02 = <span class="hljs-number">2</span>,
    GPIO_03 = <span class="hljs-number">3</span>,
    GPIO_04 = <span class="hljs-number">4</span>,
    GPIO_05 = <span class="hljs-number">5</span>,
    GPIO_06 = <span class="hljs-number">6</span>,
    GPIO_07 = <span class="hljs-number">7</span>,
    GPIO_08 = <span class="hljs-number">8</span>,
    GPIO_09 = <span class="hljs-number">9</span>,
    GPIO_10 = <span class="hljs-number">10</span>,
    GPIO_11 = <span class="hljs-number">11</span>,
    GPIO_12 = <span class="hljs-number">12</span>,
    GPIO_13 = <span class="hljs-number">13</span>,
    GPIO_14 = <span class="hljs-number">14</span>,
    GPIO_15 = <span class="hljs-number">15</span>,
    GPIO_16 = <span class="hljs-number">16</span>,
    GPIO_17 = <span class="hljs-number">17</span>,
    GPIO_18 = <span class="hljs-number">18</span>,
    GPIO_19 = <span class="hljs-number">19</span>,      <span class="hljs-comment">// 现在作为普通 GPIO</span>
    GPIO_20 = <span class="hljs-number">20</span>,      <span class="hljs-comment">// 现在作为普通 GPIO</span>
    GPIO_21 = <span class="hljs-number">21</span>,      <span class="hljs-comment">// 现在作为普通 GPIO</span>
    GPIO_22 = <span class="hljs-number">22</span>,      <span class="hljs-comment">// 现在作为普通 GPIO</span>
    GPIO_23 = <span class="hljs-number">23</span>,      <span class="hljs-comment">// 现在作为普通 GPIO</span>
    GPIO_24 = <span class="hljs-number">24</span>,      <span class="hljs-comment">// 现在作为普通 GPIO</span>
    SFC_CLK = <span class="hljs-number">25</span>,      <span class="hljs-comment">// ← 新值（改到 GPIO_25）</span>
    SFC_CSN = <span class="hljs-number">26</span>,      <span class="hljs-comment">// ← 新值（改到 GPIO_26）</span>
    SFC_IO0 = <span class="hljs-number">27</span>,      <span class="hljs-comment">// ← 新值（改到 GPIO_27）</span>
    SFC_IO1 = <span class="hljs-number">28</span>,      <span class="hljs-comment">// ← 新值（改到 GPIO_28）</span>
    SFC_IO2 = <span class="hljs-number">29</span>,      <span class="hljs-comment">// ← 新值（改到 GPIO_29）</span>
    SFC_IO3 = <span class="hljs-number">30</span>,      <span class="hljs-comment">// ← 新值（改到 GPIO_30）</span>
    PIN_NONE = <span class="hljs-number">31</span>,     <span class="hljs-comment">// 更新为 31（之前的 PIN_NONE 值也要顺延）</span>
} <span class="hljs-type">pin_t</span>;

<span class="hljs-meta">#<span class="hljs-keyword">define</span> PIN_MAX_NUMBER PIN_NONE  <span class="hljs-comment">// 保留这一行</span></span>
</code></pre>
<h4 data-id="heading-55">修改要点</h4>
<pre><code class="hljs">✏️  改动清单：
   ☐ SFC_CLK 从 19 改为 25
   ☐ SFC_CSN 从 20 改为 26
   ☐ SFC_IO0 从 21 改为 27
   ☐ SFC_IO1 从 22 改为 28
   ☐ SFC_IO2 从 23 改为 29
   ☐ SFC_IO3 从 24 改为 30
   ☐ PIN_NONE 从 25 改为 31
   ☐ 添加 GPIO_19-24 的普通定义（可选）
</code></pre>
<hr/>
<h3 data-id="heading-56">模板 2：soc_porting.c 修改示例</h3>
<h4 data-id="heading-57">原始代码</h4>
<p><strong>文件</strong>：<code>src/drivers/chips/ws63/porting/soc/soc_porting.c</code>
<strong>行号</strong>：64-79</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CLK_CTRL  0x4400d868    <span class="hljs-comment">// GPIO_19</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CSN_CTRL  0x4400d86C    <span class="hljs-comment">// GPIO_20</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO0_CTRL  0x4400d870    <span class="hljs-comment">// GPIO_21</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO1_CTRL  0x4400d874    <span class="hljs-comment">// GPIO_22</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO2_CTRL  0x4400d878    <span class="hljs-comment">// GPIO_23</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO3_CTRL  0x4400d87C    <span class="hljs-comment">// GPIO_24</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_CLK_DS_VALUE  0x3</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_CSN_DS_VALUE  0x2</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_DATA_DS_VALUE 0x2</span>

<span class="hljs-type">void</span> <span class="hljs-title function_">config_sfc_ctrl_ds</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    reg_setbits(PAD_SFC_CLK_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_CLK_DS_VALUE);
    reg_setbits(PAD_SFC_CSN_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_CSN_DS_VALUE);
    reg_setbits(PAD_SFC_IO0_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO1_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO2_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO3_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
}
</code></pre>
<h4 data-id="heading-58">修改后的代码</h4>
<p><strong>⚠️ 关键</strong>：需要从 WS63 数据手册查询新 GPIO 对应的 Pad 控制寄存器地址</p>
<p>假设新地址从 0x4400d880 开始（按顺序递增 0x4）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 新 GPIO 的 Pad 控制寄存器地址（需从芯片手册查询）</span>
<span class="hljs-comment">// GPIO_25 → GPIO_30 的 Pad 地址（假设）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CLK_CTRL  0x4400d880    <span class="hljs-comment">// GPIO_25 对应的 Pad 地址</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_CSN_CTRL  0x4400d884    <span class="hljs-comment">// GPIO_26 对应的 Pad 地址</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO0_CTRL  0x4400d888    <span class="hljs-comment">// GPIO_27 对应的 Pad 地址</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO1_CTRL  0x4400d88C    <span class="hljs-comment">// GPIO_28 对应的 Pad 地址</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO2_CTRL  0x4400d890    <span class="hljs-comment">// GPIO_29 对应的 Pad 地址</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PAD_SFC_IO3_CTRL  0x4400d894    <span class="hljs-comment">// GPIO_30 对应的 Pad 地址</span></span>

<span class="hljs-comment">// 驱动强度值保持不变（除非需要微调）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_CLK_DS_VALUE  0x3           <span class="hljs-comment">// 时钟强驱动</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_CSN_DS_VALUE  0x2           <span class="hljs-comment">// 片选中等驱动</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SFC_DATA_DS_VALUE 0x2           <span class="hljs-comment">// 数据线中等驱动</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">config_sfc_ctrl_ds</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 配置逻辑完全相同，只是使用了新的寄存器地址</span>
    reg_setbits(PAD_SFC_CLK_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_CLK_DS_VALUE);
    reg_setbits(PAD_SFC_CSN_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_CSN_DS_VALUE);
    reg_setbits(PAD_SFC_IO0_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO1_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO2_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
    reg_setbits(PAD_SFC_IO3_CTRL, <span class="hljs-number">0</span>, POS_4, DTRL_DS_LEN, SFC_DATA_DS_VALUE);
}
</code></pre>
<h4 data-id="heading-59">修改要点</h4>
<pre><code class="hljs language-scss" lang="scss">✏️  改动清单：
   ☐ PAD_SFC_CLK_CTRL 地址更新（从芯片手册查表）
   ☐ PAD_SFC_CSN_CTRL 地址更新
   ☐ PAD_SFC_IO0_CTRL 地址更新
   ☐ PAD_SFC_IO1_CTRL 地址更新
   ☐ PAD_SFC_IO2_CTRL 地址更新
   ☐ PAD_SFC_IO3_CTRL 地址更新
   ☐ 驱动强度值保持或微调（可选）
   ☐ <span class="hljs-built_in">config_sfc_ctrl_ds</span>() 函数逻辑不变

⚠️  重要：
   • 所有地址都必须从 WS63 数据手册查询
   • 地址通常是按顺序排列，间隔 <span class="hljs-number">0</span>x4 字节
   • 务必确保地址准确无误
</code></pre>
<hr/>
<h3 data-id="heading-60">模板 3：hal_pinctrl_ws63.c 修改示例</h3>
<h4 data-id="heading-61">原始代码</h4>
<p><strong>文件</strong>：<code>src/drivers/drivers/hal/pinmux/ws63/hal_pinctrl_ws63.c</code>
<strong>行号</strong>：93-140</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_mode_map[] = {
    {
        GPIO_00,
        GPIO_14,
        HAL_PIN_GPIO_SEL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_GPIO_SEL_START_BIT,
        HAL_PIN_GPIO_SEL_BITS_NUM
    },
    {
        GPIO_15,
        GPIO_18,
        HAL_PIN_UART_SEL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_UART_SEL_START_BIT,
        HAL_PIN_UART_SEL_BITS_NUM
    }
    <span class="hljs-comment">// ⚠️ 原来没有 SFC_CLK 的条目</span>
};

<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_pull_map[] = {
    {
        GPIO_00,
        GPIO_14,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_PULL_START_BIT,
        HAL_PIN_PULL_BITS_NUM
    },
    {
        SFC_CLK,        <span class="hljs-comment">// = 19（原值）</span>
        SFC_IO3,        <span class="hljs-comment">// = 24（原值）</span>
        HAL_PIN_SFC_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_PULL_START_BIT,
        HAL_PIN_PULL_BITS_NUM
    }
};

<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_ds_map[] = {
    {
        GPIO_00,
        GPIO_14,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_DS_START_BIT,
        HAL_PIN_DS_BITS_NUM
    },
    {
        SFC_CLK,        <span class="hljs-comment">// = 19（原值）</span>
        SFC_IO3,        <span class="hljs-comment">// = 24（原值）</span>
        HAL_PIN_SFC_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_DS_START_BIT,
        HAL_PIN_DS_BITS_NUM
    }
};

<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_PINCTRL_SUPPORT_IE)</span>
<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_ie_map[] = {
    {
        GPIO_00,
        GPIO_18,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_IE_START_BIT,
        HAL_PIN_IE_BITS_NUM
    },
    {
        SFC_CLK,        <span class="hljs-comment">// = 19（原值）</span>
        SFC_IO3,        <span class="hljs-comment">// = 24（原值）</span>
        HAL_PIN_SFC_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_IE_START_BIT,
        HAL_PIN_IE_BITS_NUM
    }
};
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_PINCTRL_SUPPORT_ST)</span>
<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_st_map[] = {
    {
        GPIO_00,
        GPIO_18,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_ST_START_BIT,
        HAL_PIN_ST_BITS_NUM
    },
    {
        SFC_CLK,        <span class="hljs-comment">// = 19（原值）</span>
        SFC_IO3,        <span class="hljs-comment">// = 24（原值）</span>
        HAL_PIN_SFC_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_ST_START_BIT,
        HAL_PIN_ST_BITS_NUM
    }
};
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<h4 data-id="heading-62">修改后的代码</h4>
<p><strong>假设新的 SFC GPIO 为 GPIO_25-30，仍在连续范围内</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_mode_map[] = {
    {
        GPIO_00,
        GPIO_14,
        HAL_PIN_GPIO_SEL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_GPIO_SEL_START_BIT,
        HAL_PIN_GPIO_SEL_BITS_NUM
    },
    {
        GPIO_15,
        GPIO_18,
        HAL_PIN_UART_SEL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_UART_SEL_START_BIT,
        HAL_PIN_UART_SEL_BITS_NUM
    }
    <span class="hljs-comment">// SFC 的 GPIO_25-30 可能不需要在 mode_map 中配置</span>
};

<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_pull_map[] = {
    {
        GPIO_00,
        GPIO_14,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_PULL_START_BIT,
        HAL_PIN_PULL_BITS_NUM
    },
    {
        SFC_CLK,        <span class="hljs-comment">// 现在等于 25（新值从 platform_core_rom.h 自动获得）</span>
        SFC_IO3,        <span class="hljs-comment">// 现在等于 30（新值从 platform_core_rom.h 自动获得）</span>
        HAL_PIN_SFC_CTRL_START_ADDR,  <span class="hljs-comment">// 这个地址可能也需要更新</span>
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_PULL_START_BIT,
        HAL_PIN_PULL_BITS_NUM
    }
};

<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_ds_map[] = {
    {
        GPIO_00,
        GPIO_14,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_DS_START_BIT,
        HAL_PIN_DS_BITS_NUM
    },
    {
        SFC_CLK,        <span class="hljs-comment">// 自动从 enum 获取新值 25</span>
        SFC_IO3,        <span class="hljs-comment">// 自动从 enum 获取新值 30</span>
        HAL_PIN_SFC_CTRL_START_ADDR,  <span class="hljs-comment">// 可能需要更新</span>
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_DS_START_BIT,
        HAL_PIN_DS_BITS_NUM
    }
};

<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_PINCTRL_SUPPORT_IE)</span>
<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_ie_map[] = {
    {
        GPIO_00,
        GPIO_18,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_IE_START_BIT,
        HAL_PIN_IE_BITS_NUM
    },
    {
        SFC_CLK,        <span class="hljs-comment">// 自动获取新值 25</span>
        SFC_IO3,        <span class="hljs-comment">// 自动获取新值 30</span>
        HAL_PIN_SFC_CTRL_START_ADDR,  <span class="hljs-comment">// 可能需要更新</span>
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_IE_START_BIT,
        HAL_PIN_IE_BITS_NUM
    }
};
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_PINCTRL_SUPPORT_ST)</span>
<span class="hljs-type">static</span> <span class="hljs-type">hal_pin_config_group_t</span> <span class="hljs-type">const</span> g_pin_st_map[] = {
    {
        GPIO_00,
        GPIO_18,
        HAL_PIN_GPIO_CTRL_START_ADDR,
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_ST_START_BIT,
        HAL_PIN_ST_BITS_NUM
    },
    {
        SFC_CLK,        <span class="hljs-comment">// 自动获取新值 25</span>
        SFC_IO3,        <span class="hljs-comment">// 自动获取新值 30</span>
        HAL_PIN_SFC_CTRL_START_ADDR,  <span class="hljs-comment">// 可能需要更新</span>
        HAL_PIN_CONFIG_PER_NUM,
        HAL_PIN_ST_START_BIT,
        HAL_PIN_ST_BITS_NUM
    }
};
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<h4 data-id="heading-63">修改说明</h4>
<p><strong>关键要点</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">☑️  自动适配：
   • 由于使用了 SFC_CLK 和 SFC_IO3 的枚举名
   • platform_core_rom.h 改了后自动应用
   • hal_pinctrl_ws63.c 中用枚举名的地方自动更新

❌ 需要手动改的：
   • HAL_PIN_SFC_CTRL_START_ADDR
   • 所有 GPIO 配置组的数据结构范围

✏️  改动方式：
   方案 A（最简单）：
      • 只改 platform_core_rom.h 中的 <span class="hljs-keyword">enum</span>
      • 如果新 GPIO 范围仍然连续，其他文件可能无需改
      
   方案 B（彻底）：
      • 改 platform_core_rom.h（<span class="hljs-keyword">enum</span>）
      • 改 soc_porting.c（Pad 地址）
      • 改 hal_pinctrl_ws63.c（配置组）
      • 改 HAL_PIN_SFC_CTRL_START_OFFSET 基地址
</code></pre>
<hr/>
<h3 data-id="heading-64">模板 4：HAL_PIN_SFC_CTRL_START_OFFSET 基地址更新</h3>
<h4 data-id="heading-65">原始定义</h4>
<p><strong>文件</strong>：<code>src/drivers/drivers/hal/pinmux/ws63/hal_pinctrl_ws63.c</code>
<strong>行号</strong>：20-27</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_IO_CFG_BASE_ADDR            0x4400D000</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_SEL_START_OFFSET   0x000</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_UART_SEL_START_OFFSET   0x03C</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_CTRL_START_OFFSET  0x800</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_SFC_CTRL_START_OFFSET   0x868    <span class="hljs-comment">// ← 原值（用于 GPIO_19-24）</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_SEL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_GPIO_SEL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_UART_SEL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_UART_SEL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_CTRL_START_ADDR    (HAL_IO_CFG_BASE_ADDR + HAL_PIN_GPIO_CTRL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_SFC_CTRL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_SFC_CTRL_START_OFFSET)</span>
</code></pre>
<h4 data-id="heading-66">修改后（如果 GPIO 改到 25-30）</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_IO_CFG_BASE_ADDR            0x4400D000</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_SEL_START_OFFSET   0x000</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_UART_SEL_START_OFFSET   0x03C</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_CTRL_START_OFFSET  0x800</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_SFC_CTRL_START_OFFSET   0x880    <span class="hljs-comment">// ← 新值（从芯片手册查询）</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_SEL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_GPIO_SEL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_UART_SEL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_UART_SEL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_GPIO_CTRL_START_ADDR    (HAL_IO_CFG_BASE_ADDR + HAL_PIN_GPIO_CTRL_START_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HAL_PIN_SFC_CTRL_START_ADDR     (HAL_IO_CFG_BASE_ADDR + HAL_PIN_SFC_CTRL_START_OFFSET)</span>
</code></pre>
<hr/>
<h3 data-id="heading-67">模板 5：flash_config_info.c 添加新 Flash</h3>
<h4 data-id="heading-68">场景：添加新的 Flash 芯片（如 GD25Q256）</h4>
<h4 data-id="heading-69">原有 Flash 条目示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> FLASH_GD25Q32           0x1640C8</span>

<span class="hljs-comment">// ... 在某个数组中 ...</span>
{
    .chip_id = FLASH_GD25Q32,
    .chip_size = <span class="hljs-number">0x400000</span>,                <span class="hljs-comment">// 4MB</span>
    .read_cmds = {
        {
            .cmd = <span class="hljs-number">0x0B</span>, .cmd_support = <span class="hljs-number">1</span>,
            .addr_len = SPI_ADDR_LEN_24, .addr_support = <span class="hljs-number">1</span>,
            .dummy_cycles = <span class="hljs-number">1</span>,
            .cmd_type = STANDARD_READ, .size = <span class="hljs-number">0x04</span>
        },
        <span class="hljs-comment">// ... 其他读命令 ...</span>
    },
    .read_cmd_num = <span class="hljs-number">3</span>,
    .write_cmds = { ... },
    .write_cmd_num = <span class="hljs-number">2</span>,
    .erase_cmds = { ... },
    .erase_cmd_num = <span class="hljs-number">4</span>,
    .quad_mode = &amp;gd25_quad_mode_cmd,      <span class="hljs-comment">// QSPI 支持</span>
},
</code></pre>
<h4 data-id="heading-70">新增 Flash GD25Q256</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 1. 首先添加 Flash ID 定义（在宏定义部分）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FLASH_GD25Q256          0x1940C8    <span class="hljs-comment">// 256Mbit</span></span>

<span class="hljs-comment">// 2. 定义 QSPI 模式的使能命令（如果支持 Quad）</span>
<span class="hljs-type">static</span> <span class="hljs-type">flash_cmd_execute_t</span> gd25q256_quad_mode_cmd = {
    {
        .cmd = <span class="hljs-number">0x35</span>,                        <span class="hljs-comment">// 写状态寄存器 2</span>
        .cmd_support = <span class="hljs-number">1</span>,
        .addr_support = <span class="hljs-number">0</span>,
        .dummy_cycles = <span class="hljs-number">0</span>,
        .cmd_type = FLASH_CMD_WRITE,
        .size = <span class="hljs-number">1</span>,
    },
    {
        .cmd = <span class="hljs-number">0x15</span>,                        <span class="hljs-comment">// 读状态寄存器 2</span>
        .cmd_support = <span class="hljs-number">1</span>,
        .addr_support = <span class="hljs-number">0</span>,
        .dummy_cycles = <span class="hljs-number">0</span>,
        .cmd_type = FLASH_CMD_READ,
        .size = <span class="hljs-number">1</span>,
    },
    {
        .cmd_support = <span class="hljs-number">0</span>,                   <span class="hljs-comment">// 其他命令可选</span>
    }
};

<span class="hljs-comment">// 3. 在 Flash 配置数组中追加新条目</span>
{
    .chip_id = FLASH_GD25Q256,
    .chip_size = <span class="hljs-number">0x2000000</span>,                 <span class="hljs-comment">// 32MB（256Mbit）</span>
    .read_cmds = {
        {
            .cmd = <span class="hljs-number">0x0B</span>,                    <span class="hljs-comment">// Standard Read</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_len = SPI_ADDR_LEN_24,
            .addr_support = <span class="hljs-number">1</span>,
            .dummy_cycles = <span class="hljs-number">1</span>,
            .cmd_type = STANDARD_READ,
            .size = <span class="hljs-number">0x04</span>
        },
        {
            .cmd = <span class="hljs-number">0x3B</span>,                    <span class="hljs-comment">// Fast Read</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_len = SPI_ADDR_LEN_24,
            .addr_support = <span class="hljs-number">1</span>,
            .dummy_cycles = <span class="hljs-number">1</span>,
            .cmd_type = STANDARD_READ,
            .size = <span class="hljs-number">0x04</span>
        },
        {
            .cmd = <span class="hljs-number">0xEB</span>,                    <span class="hljs-comment">// Quad Fast Read</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_len = SPI_ADDR_LEN_24,
            .addr_support = <span class="hljs-number">1</span>,
            .dummy_cycles = <span class="hljs-number">3</span>,
            .cmd_type = QUAD_READ,
            .size = <span class="hljs-number">0x04</span>
        },
    },
    .read_cmd_num = <span class="hljs-number">3</span>,
    .write_cmds = {
        {
            .cmd = <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">// Page Program</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_len = SPI_ADDR_LEN_24,
            .addr_support = <span class="hljs-number">1</span>,
            .dummy_cycles = <span class="hljs-number">0</span>,
            .cmd_type = PAGE_PROGRAM,
            .size = <span class="hljs-number">256</span>
        },
        {
            .cmd = <span class="hljs-number">0x32</span>,                    <span class="hljs-comment">// Quad Page Program</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_len = SPI_ADDR_LEN_24,
            .addr_support = <span class="hljs-number">1</span>,
            .dummy_cycles = <span class="hljs-number">0</span>,
            .cmd_type = PAGE_PROGRAM,
            .size = <span class="hljs-number">256</span>
        },
    },
    .write_cmd_num = <span class="hljs-number">2</span>,
    .erase_cmds = {
        {
            .cmd = <span class="hljs-number">0x20</span>,                    <span class="hljs-comment">// Sector Erase (4KB)</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_support = <span class="hljs-number">1</span>,
            .cmd_type = ERASE_SECTOR,
            .size = <span class="hljs-number">0x1000</span>
        },
        {
            .cmd = <span class="hljs-number">0x52</span>,                    <span class="hljs-comment">// 32KB Erase</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_support = <span class="hljs-number">1</span>,
            .cmd_type = ERASE_32K,
            .size = <span class="hljs-number">0x8000</span>
        },
        {
            .cmd = <span class="hljs-number">0xD8</span>,                    <span class="hljs-comment">// 64KB Erase (Block)</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_support = <span class="hljs-number">1</span>,
            .cmd_type = ERASE_BLOCK,
            .size = <span class="hljs-number">0x10000</span>
        },
        {
            .cmd = <span class="hljs-number">0xC7</span>,                    <span class="hljs-comment">// Chip Erase</span>
            .cmd_support = <span class="hljs-number">1</span>,
            .addr_support = <span class="hljs-number">0</span>,
            .cmd_type = ERASE_CHIP,
            .size = <span class="hljs-number">0x2000000</span>                <span class="hljs-comment">// 全容量</span>
        },
    },
    .erase_cmd_num = <span class="hljs-number">4</span>,
    .quad_mode = &amp;gd25q256_quad_mode_cmd,   <span class="hljs-comment">// 支持 QSPI</span>
},
</code></pre>
<h4 data-id="heading-71">修改清单</h4>
<pre><code class="hljs language-arduino" lang="arduino">☑️  添加 Flash 的步骤：
   <span class="hljs-number">1.</span> 从 Flash 数据手册获取：
      □ Flash ID（<span class="hljs-number">3</span> 字节）
      □ 容量（<span class="hljs-type">byte</span>）
      □ 各种读命令的 opcode
      □ 编程命令 opcode
      □ 擦除命令 opcode（通常 <span class="hljs-number">4</span> 种）
      □ QSPI 使能序列（如支持）
      
   <span class="hljs-number">2.</span> 修改 flash_config_info.c：
      □ 添加 <span class="hljs-meta">#<span class="hljs-keyword">define</span> FLASH_XXXXX ID</span>
      □ 如果支持 QSPI，定义 quad_mode 结构
      □ 创建 <span class="hljs-type">flash_spi_info_t</span> 条目
      □ 填充读/写/擦命令数组
      
   <span class="hljs-number">3.</span> 编译验证：
      □ 固件编译成功
      □ 烧录并测试 Flash 识别
      □ 验证 <span class="hljs-built_in">SPI</span> 模式读写
      □ 验证 QSPI 模式读写（如支持）
</code></pre>
<hr/>
<h3 data-id="heading-72">模板 6：编译配置修改</h3>
<h4 data-id="heading-73">启用 DMA 模式</h4>
<p><strong>文件</strong>：<code>ws63_liteos_app.config</code>
<strong>修改</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">  #
  # SFC Configuration
  #
  
  #
  # Config  SFC
  #
<span class="hljs-deletion">- # CONFIG_SFC_SUPPORT_DMA is not set</span>
<span class="hljs-addition">+ CONFIG_SFC_SUPPORT_DMA=y</span>
  # CONFIG_SFC_ALLOW_ERASE_WRITEBACK is not set
  # CONFIG_SFC_ALREADY_INIT is not set
</code></pre>
<h4 data-id="heading-74">启用通用 SPI Master</h4>
<p><strong>文件</strong>：<code>ws63_liteos_app.config</code>
<strong>修改</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">  CONFIG_DRIVER_SUPPORT_SPI=y
  
  #
  # SPI Configuration
  #
  
  #
  # Config SPI
  #
<span class="hljs-deletion">- # CONFIG_SPI_SUPPORT_MASTER is not set</span>
<span class="hljs-addition">+ CONFIG_SPI_SUPPORT_MASTER=y</span>
</code></pre>
<hr/>
<h3 data-id="heading-75">🔍 编译验证步骤</h3>
<h4 data-id="heading-76">步骤 1：清理旧编译</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> fbb_ws63-master
<span class="hljs-built_in">rm</span> -rf src/build/cmake_build
<span class="hljs-built_in">rm</span> -rf src/build/output
</code></pre>
<h4 data-id="heading-77">步骤 2：重新编译</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> src
python build.py
</code></pre>
<h4 data-id="heading-78">步骤 3：检查编译错误</h4>
<pre><code class="hljs language-arduino" lang="arduino">常见错误：
  • <span class="hljs-string">"undefined reference to SFC_CLK"</span> 
    → 检查 platform_core_rom.h <span class="hljs-keyword">enum</span> 定义
  
  • <span class="hljs-string">"SFC initialization failed"</span>
    → 检查 Pad 寄存器地址是否正确
  
  • <span class="hljs-string">"Flash not detected"</span>
    → 检查 GPIO 硬件连接
    → 检查 flash_config_info.c Flash ID
</code></pre>
<h4 data-id="heading-79">步骤 4：烧录和测试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 烧录新固件</span>
./flashtool --boot src/build/output/bin/out.bin

<span class="hljs-comment"># 通过串口观察 SFC 初始化日志</span>
<span class="hljs-comment"># 应看到类似：</span>
<span class="hljs-comment">#   SFC: Identifying flash...</span>
<span class="hljs-comment">#   SFC: Flash ID = 0x1640C8</span>
<span class="hljs-comment">#   SFC: QSPI mode enabled</span>
<span class="hljs-comment">#   SFC: Initialization success</span>
</code></pre>
<hr/>
<h3 data-id="heading-80">⚠️ 常见陷阱</h3>
<h4 data-id="heading-81">陷阱 1：忘记同时改多个文件</h4>
<pre><code class="hljs">❌ 错误做法：
   只改 platform_core_rom.h，没改 soc_porting.c

✅ 正确做法：
   同时改：
   • platform_core_rom.h（GPIO 号）
   • soc_porting.c（Pad 地址）
   • hal_pinctrl_ws63.c（配置范围）
</code></pre>
<h4 data-id="heading-82">陷阱 2：Pad 寄存器地址假设</h4>
<pre><code class="hljs language-ini" lang="ini">❌ 错误做法：
   简单地加偏移：0x4400d868 + <span class="hljs-attr">8</span> = <span class="hljs-number">0</span>x4400d870
   （实际可能不是线性关系）

✅ 正确做法：
   从 WS63 数据手册查表获取准确地址
</code></pre>
<h4 data-id="heading-83">陷阱 3：Flash ID 匹配失败</h4>
<pre><code class="hljs language-arduino" lang="arduino">❌ 错误现象：
   Flash ID = <span class="hljs-number">0xFFFFFF</span>
   
✅ 排查步骤：
   <span class="hljs-number">1.</span> 用逻辑分析仪捕获 <span class="hljs-built_in">SPI</span> 通信
   <span class="hljs-number">2.</span> 检查 GPIO_19<span class="hljs-number">-22</span> 波形
   <span class="hljs-number">3.</span> 用 Flash 数据手册验证 read ID 命令
   <span class="hljs-number">4.</span> 检查 flash_config_info.c 中是否有该 ID
</code></pre>
<h4 data-id="heading-84">陷阱 4：QSPI 模式无法启用</h4>
<pre><code class="hljs language-markdown" lang="markdown">❌ 错误现象：
   始终运行在 SPI 而非 QSPI 模式
   
✅ 排查步骤：
<span class="hljs-bullet">   1.</span> 确认 Flash 数据手册支持 QSPI
<span class="hljs-bullet">   2.</span> 检查 flash<span class="hljs-emphasis">_config_</span>info.c 中 quad<span class="hljs-emphasis">_mode 指针是否为 NULL
   3. 验证 GPIO_</span>23-24 的连接（仅 QSPI 用）
<span class="hljs-bullet">   4.</span> 检查 QSPI 使能命令是否正确
</code></pre>
<hr/>
<h3 data-id="heading-85">📚 参考资源</h3>

























<table><thead><tr><th>资源</th><th>说明</th></tr></thead><tbody><tr><td>WS63 数据手册</td><td>Pad 地址查表、GPIO 功能</td></tr><tr><td>Flash 数据手册</td><td>命令集、QSPI 支持、ID</td></tr><tr><td>GPIO_LITTLEFS_ANALYSIS.md</td><td>GPIO 配置原理</td></tr><tr><td>SFC_GPIO_PIN_MAPPING.md</td><td>Pin 映射完整表</td></tr></tbody></table>
<hr/>
<p><strong>示例文档完成</strong> | 用于学习和参考 | 实际使用需按硬件定制</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[改造米家屏幕挂灯1代接入HomeKit]]></title>    <link>https://juejin.cn/post/7604694326517923891</link>    <guid>https://juejin.cn/post/7604694326517923891</guid>    <pubDate>2026-02-09T23:40:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604694326517923891" data-draft-id="7604672395626905627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="改造米家屏幕挂灯1代接入HomeKit"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2026-02-09T23:40:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chaosgoo"/> <meta itemprop="url" content="https://juejin.cn/user/2541726616010317"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            改造米家屏幕挂灯1代接入HomeKit
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726616010317/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chaosgoo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-09T23:40:44.000Z" title="Mon Feb 09 2026 23:40:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文首发于我的个人博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchaosgoo.com%2FAdd-your-Xiaomi-Yeelight-Monitor-Light-Bar-to-HomeKit-with-ESP32-C3%2F" target="_blank" title="https://chaosgoo.com/Add-your-Xiaomi-Yeelight-Monitor-Light-Bar-to-HomeKit-with-ESP32-C3/" ref="nofollow noopener noreferrer">chaosgoo.com</a>，欢迎来访交流。</p>
</blockquote>
<h3 data-id="heading-0">前言</h3>
<p>我住的屋子床头没有插座也没有控制房间顶灯的开关,假如熄灯睡觉的话会让房间陷入一片漆黑.
所以很长一段时间里我都把米家屏幕挂灯的控制器放在床头,用于临时照明.<br/>
这就引发了另外一个问题,每次回家开电脑打开屏幕挂灯,我都得走到床头找到控制器开启屏幕挂灯.
在经历了多次麻烦后,我决定把这个屏幕挂灯接入HomeKit. 这样就可以用语音或者手机控制了.</p>
<h3 data-id="heading-1">资料搜集</h3>
<p>在阅读了这篇<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.chongdiantou.com%2Farchives%2F55542.html" target="_blank" title="https://www.chongdiantou.com/archives/55542.html" ref="nofollow noopener noreferrer">拆解报告：MJ米家显示器挂灯MJGJD01YL</a>后, 需要做的工作就很明确了.
大致分为以下几个步骤</p>
<ul>
<li>阅读手册,找到控制引脚</li>
<li>拆除芯片,替换成ESP32</li>
<li>编写代码,接入HomeKit</li>
</ul>

<h3 data-id="heading-2">阅读手册,找到控制引脚</h3>
<p>看完拆解报告后,得知亮度由TLSR8368和SY7301A芯片控制实现, 两款芯片的资料很容易在Google上搜索到.<br/>
基本上可以确定是由TLSR8368发送PWM信号给SY7301A进行调光.</p>
<p>TLSR8368一共就16个引脚, 对照手册配合示波器挨个测量控制引脚测出PWM引脚是由#3,#5产生, 还有一个引脚#8用于使能SY7301A芯片.</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7eee3ad29d2345568d15d76ec5b1413c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhb3Nnb28=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771285244&amp;x-signature=RpsqGsDXIug37QbH3lfw%2FkvfJrc%3D" alt="measurePins" loading="lazy"/></p>
<p>测量出引脚如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16900dbf24024929878ec9377cd69de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhb3Nnb28=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771285244&amp;x-signature=3kSHQPt%2Bz1l0V5dTGxRiJAQynIQ%3D" alt="QQ_1770680236013.png" loading="lazy"/></p>
<h3 data-id="heading-3">拆除芯片,替换成ESP32</h3>
<p>到了这一步需要选择合适尺寸的芯片,然后重新绘制一块板子寄生在原始位置即可.</p>
<p>TLSR8368的焊盘空间还算宽敞, 这里可以焊接一个封装小一点的ESP32-C3(对应的型号名称是ESP8685), 封装为QFN28 4x4mm</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff49a94f109047c994889201ae1f141a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhb3Nnb28=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771285244&amp;x-signature=%2FXQlk0xDrmD%2FFivbSKhAiOomXEk%3D" alt="Lamp++ Top View" loading="lazy"/></p>
<p>这里右半部分的TypeC和LDO部分将会在在烧录后折断, 后续固件可以通过4P 2mm间距探针或者OTA进行更新.</p>
<p>附上一张初版焊接后的图片, 初版为之前没有预留可折断TypeC部分的版本.</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bfc8ee95a8f4c8a9d8e88475c188be9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhb3Nnb28=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771285244&amp;x-signature=bv3%2BWbiO9E5dvvTdEu0OEOTGeCE%3D" alt="Preview" loading="lazy"/></p>
<h3 data-id="heading-4">编写代码,接入HomeKit</h3>
<p>得益于HomeSpan这个库,需要编写的代码很简单.</p>
<p>目前实现了白色LED的调光, 由于我损坏了暖黄色LED控制引脚的阻焊,导致最终版本未能实现色温调节功能。</p>
<p>因此，以下代码主要演示了如何控制白色LED的开关与调光</p>
<pre><code class="hljs language-cpp" lang="cpp">#<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>

#<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"HomeSpan.h"</span></span>
#<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"extras/PwmPin.h"</span>  <span class="hljs-comment">// library of various PWM functions</span></span>

<span class="hljs-comment">////////////////////////////////////</span>

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">FadingLED</span> : Service::LightBulb {
  LedPin *ledPin;             <span class="hljs-comment">// reference to Led Pin</span>
  SpanCharacteristic *power;  <span class="hljs-comment">// reference to the On Characteristic</span>
  SpanCharacteristic *level;  <span class="hljs-comment">// reference to the Brightness Characteristic</span>
  SpanCharacteristic *colorTemperature;  <span class="hljs-comment">// reference to the Color Temperature</span>

  <span class="hljs-built_in">FadingLED</span>(<span class="hljs-type">int</span> _ledPin) : Service::<span class="hljs-built_in">LightBulb</span>() {
    power = <span class="hljs-keyword">new</span> Characteristic::<span class="hljs-built_in">On</span>();
    level = <span class="hljs-keyword">new</span> Characteristic::<span class="hljs-built_in">Brightness</span>(<span class="hljs-number">0</span>);
    colorTemperature = <span class="hljs-keyword">new</span> Characteristic::<span class="hljs-built_in">ColorTemperature</span>(<span class="hljs-number">200</span>, <span class="hljs-literal">true</span>);
    ledPin = <span class="hljs-keyword">new</span> <span class="hljs-built_in">LedPin</span>(_ledPin);
  }

  <span class="hljs-function">boolean <span class="hljs-title">update</span><span class="hljs-params">()</span> </span>{
    Serial.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"power-&gt;getNewVal()=%d"</span>, power-&gt;<span class="hljs-built_in">getNewVal</span>());
    Serial.<span class="hljs-built_in">printf</span>(<span class="hljs-string">",level-&gt;getNewVal()=%d"</span>, level-&gt;<span class="hljs-built_in">getNewVal</span>());
    Serial.<span class="hljs-built_in">printf</span>(<span class="hljs-string">",colorTemperature-&gt;getNewVal()=%d\n"</span>,
                  colorTemperature-&gt;<span class="hljs-built_in">getNewVal</span>());
    ledPin-&gt;<span class="hljs-built_in">fade</span>(power-&gt;<span class="hljs-built_in">getNewVal</span>() * level-&gt;<span class="hljs-built_in">getNewVal</span>(), <span class="hljs-number">2000</span>,
                 LedPin::PROPORTIONAL);
    <span class="hljs-keyword">while</span> (ledPin-&gt;<span class="hljs-built_in">fadeStatus</span>() == LedPin::FADING)
      ;

    <span class="hljs-keyword">return</span> (<span class="hljs-literal">true</span>);
  }

  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
    <span class="hljs-keyword">if</span> (ledPin-&gt;<span class="hljs-built_in">fadeStatus</span>() == LedPin::COMPLETED) {
      power-&gt;<span class="hljs-built_in">setVal</span>(<span class="hljs-number">1</span> - power-&gt;<span class="hljs-built_in">getVal</span>());
      level-&gt;<span class="hljs-built_in">setVal</span>(power-&gt;<span class="hljs-built_in">getVal</span>() ? <span class="hljs-number">100</span> : <span class="hljs-number">0</span>);
    }
  }
};

<span class="hljs-comment">//////////////////////////////////</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">pinMode</span>(<span class="hljs-number">5</span>, OUTPUT);
  <span class="hljs-built_in">pinMode</span>(<span class="hljs-number">10</span>, OUTPUT);
  <span class="hljs-built_in">digitalWrite</span>(<span class="hljs-number">5</span>, HIGH);
  <span class="hljs-built_in">digitalWrite</span>(<span class="hljs-number">10</span>, LOW);
  Serial.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  <span class="hljs-built_in">digitalWrite</span>(<span class="hljs-number">10</span>, HIGH);

  Serial.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Wi-Fi is Connected!"</span>);
  homeSpan.<span class="hljs-built_in">enableOTA</span>(<span class="hljs-string">"12345678"</span>);
  homeSpan.<span class="hljs-built_in">setPairingCode</span>(<span class="hljs-string">"11223344"</span>);
  homeSpan.<span class="hljs-built_in">begin</span>(Category::Lighting, <span class="hljs-string">"Lamp++"</span>);

  <span class="hljs-keyword">new</span> <span class="hljs-built_in">SpanAccessory</span>();
  <span class="hljs-keyword">new</span> Service::<span class="hljs-built_in">AccessoryInformation</span>();
  <span class="hljs-keyword">new</span> Characteristic::<span class="hljs-built_in">Identify</span>();
  <span class="hljs-keyword">new</span> Characteristic::<span class="hljs-built_in">ColorTemperature</span>(<span class="hljs-number">200</span>, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">new</span> <span class="hljs-built_in">FadingLED</span>(<span class="hljs-number">4</span>);
}

<span class="hljs-comment">//////////////////////////////////////</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{ 
  homeSpan.<span class="hljs-built_in">poll</span>();
}

</code></pre>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[env:airm2m_core_esp32c3]</span>
<span class="hljs-attr">platform</span> = espressif32@<span class="hljs-number">5.4</span>.<span class="hljs-number">0</span>
<span class="hljs-attr">board</span> = airm2m_core_esp32c3
<span class="hljs-attr">framework</span> = ardui<span class="hljs-literal">no</span>
<span class="hljs-attr">monitor_speed</span> = <span class="hljs-number">115200</span>
<span class="hljs-attr">lib_deps</span> = homespan/HomeSpan@^<span class="hljs-number">1.8</span>.<span class="hljs-number">0</span>
<span class="hljs-comment">; upload_protocol = espota</span>
<span class="hljs-comment">; upload_flags =  --auth=12345678</span>
<span class="hljs-comment">; upload_port = 192.168.0.104</span>
<span class="hljs-attr">build_flags</span> = 
	-D <span class="hljs-attr">ARDUINO_USB_MODE</span>=<span class="hljs-number">1</span>
	-D <span class="hljs-attr">ARDUINO_USB_CDC_ON_BOOT</span>=<span class="hljs-number">1</span>  
</code></pre>
<h3 data-id="heading-5">效果展示</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82a44809216b45d5a65661f87217c7b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhb3Nnb28=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771285244&amp;x-signature=0IyWjKqF1pppGymEJbM4la8LD%2BQ%3D" alt="Preview2" loading="lazy"/></p>
<h3 data-id="heading-6">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.chongdiantou.com%2Farchives%2F55542.html" target="_blank" title="https://www.chongdiantou.com/archives/55542.html" ref="nofollow noopener noreferrer">拆解报告：MJ米家显示器挂灯MJGJD01YL</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL的10种高级SQL，性能起飞]]></title>    <link>https://juejin.cn/post/7604493165329203234</link>    <guid>https://juejin.cn/post/7604493165329203234</guid>    <pubDate>2026-02-10T02:10:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604493165329203234" data-draft-id="7604685644685017140" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL的10种高级SQL，性能起飞"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-10T02:10:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL的10种高级SQL，性能起飞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:10:56.000Z" title="Tue Feb 10 2026 02:10:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>很多小伙伴在工作中，可能只把MySQL当作一个简单的“数据存储箱”，用了它80%的基础功能，却不知道它还有另外20%的、能解决90%复杂问题的“高级用法”。</p>
<p>今天，我不谈基础的增删改查，就和你深入聊聊，在实际高性能、高并发、大数据量的场景下，那些真正能让你和团队生产力倍增、性能飞升的10种MySQL高级实战技巧。</p>
<p>希望对你会有所帮助。</p>
<h2 data-id="heading-1">01 执行计划</h2>
<p>在优化任何查询之前，<strong>读懂<code>EXPLAIN</code>的输出是你的第一门必修课</strong>。</p>
<p>它就像SQL的“X光片”，能告诉你MySQL究竟打算如何执行你的查询，瓶颈在哪里。</p>
<h3 data-id="heading-2">核心用法与实战</h3>
<p>执行<code>EXPLAIN</code>后，你需要重点关注以下几个关键字段：</p>
<ul>
<li><strong>type</strong>：访问类型，从最优到最差大致是：<code>system</code> &gt; <code>const</code> &gt; <code>eq_ref</code> &gt; <code>ref</code> &gt; <code>range</code> &gt; <code>index</code> &gt; <code>ALL</code>。看到<code>ALL</code>（全表扫描）就要警惕了。</li>
<li><strong>key</strong>：实际使用的索引。如果为<code>NULL</code>，说明没用上索引。</li>
<li><strong>rows</strong>：MySQL预估要扫描的行数。这个数字越接近实际需要的数据行数越好。</li>
<li><strong>Extra</strong>：包含非常丰富的信息，例如<code>Using filesort</code>（需要额外排序）、<code>Using temporary</code>（使用了临时表），这通常是性能杀手。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 一个需要优化的查询示例</span>
EXPLAIN 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">10086</span> 
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2024-01-31'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> amount <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>假设这个查询的<code>type</code>是<code>ALL</code>，<code>key</code>是<code>NULL</code>。这意味着它在<code>orders</code>表上进行了全表扫描，性能极差。优化方法通常是创建一个复合索引：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建覆盖了WHERE和ORDER BY的复合索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_time_amount <span class="hljs-keyword">ON</span> orders(user_id, create_time, amount);
<span class="hljs-comment">-- 再次使用EXPLAIN，你会看到type变成了range，key显示了新索引，性能天差地别。</span>
</code></pre>
<p><strong>深度剖析</strong>：<code>EXPLAIN</code>是基于表的统计信息来估算成本的。如果表数据变化很大而统计信息未更新，优化器可能会选错索引。</p>
<p>这时，可以用<code>ANALYZE TABLE table_name;</code>来手动更新统计信息。</p>
<p>有些小伙伴在工作中写的SQL本身不复杂，但执行很慢，第一步就应该祭出<code>EXPLAIN</code>。</p>
<h2 data-id="heading-3">02 高级索引策略</h2>
<p>索引是性能的基石，但错误的索引比没有索引更糟糕。</p>
<h3 data-id="heading-4">高级索引策略</h3>
<ol>
<li><strong>覆盖索引（Covering Index）</strong>：如果索引包含了查询需要的所有字段，引擎就无需回表查询数据行，速度极快。</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 假设常用查询是获取用户的姓名和邮箱</span>
<span class="hljs-keyword">SELECT</span> name, email <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">20</span>;
<span class="hljs-comment">-- 为这个查询设计覆盖索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_age_name_email <span class="hljs-keyword">ON</span> users(age, name, email);
<span class="hljs-comment">-- age用于查询，name和email本身就在索引页中，无需查找数据行。</span>
</code></pre>
<ol start="2">
<li>
<p><strong>索引下推（Index Condition Pushdown， ICP）</strong>：这是MySQL 5.6引入的重大优化。对于复合索引<code>(a, b)</code>，查询<code>WHERE a = ? AND b LIKE ‘%xxx’</code>。在旧版本中，即使<code>a</code>命中了索引，引擎也会将所有<code>a=?</code>的记录回表，再去过滤<code>b</code>。而ICP允许将<code>b LIKE ‘%xxx’</code>这个条件下推到存储引擎层，在索引扫描时就过滤，大大减少回表次数。</p>
</li>
<li>
<p><strong>前缀索引（Prefix Index）</strong>：对于超长文本字段（如<code>VARCHAR(500)</code>），为整个字段建索引非常臃肿。可以只对前N个字符建立索引，在空间和效率间取得平衡。</p>
</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为content字段前100个字符创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_content_prefix <span class="hljs-keyword">ON</span> articles (content(<span class="hljs-number">100</span>));
<span class="hljs-comment">-- 缺点是前缀索引无法用于GROUP BY和ORDER BY操作。</span>
</code></pre>
<p><strong>深度剖析</strong>：索引是一把双刃剑，加速查询的同时，会降低写操作（INSERT/UPDATE/DELETE）的速度，因为索引树也需要维护。</p>
<p>一个表上创建十几个索引是常见的设计误区。</p>
<p>你需要定期使用<code>SHOW INDEX FROM table_name;</code>审查索引的基数（Cardinality，唯一值数量），删除使用率极低的冗余索引。</p>
<h2 data-id="heading-5">03 窗口函数</h2>
<p>这是MySQL 8.0带来的“神兵利器”，用于进行<strong>跨行计算</strong>，完美解决复杂排名、累加、移动平均等问题。</p>
<h3 data-id="heading-6">核心场景与语法</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 经典场景：计算每个部门内员工的薪水排名</span>
<span class="hljs-keyword">SELECT</span> 
    name,
    department,
    salary,
    <span class="hljs-built_in">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> dept_salary_rank,
    <span class="hljs-comment">-- 同时计算公司整体排名</span>
    <span class="hljs-built_in">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> company_rank,
    <span class="hljs-comment">-- 计算部门内薪水累计占比</span>
    <span class="hljs-built_in">SUM</span>(salary) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department) <span class="hljs-keyword">as</span> dept_total,
    salary <span class="hljs-operator">/</span> <span class="hljs-built_in">SUM</span>(salary) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department) <span class="hljs-keyword">as</span> salary_ratio
<span class="hljs-keyword">FROM</span> employees;
</code></pre>
<p><code>PARTITION BY</code>类似于<code>GROUP BY</code>，但不会将行合并，而是定义窗口范围。</p>
<p><code>ORDER BY</code>决定窗口内的排序。</p>
<p><strong>深度剖析</strong>：在MySQL 8.0之前，要实现上述查询，你需要写复杂的自连接或效率极低的子查询。窗口函数在数据库内部进行了深度优化，性能提升可达几个数量级。</p>
<p>它特别适用于<strong>分析报表、实时排行榜、计算同比环比</strong>等OLAP型场景。</p>
<h2 data-id="heading-7">04 通用表表达式（CTE）</h2>
<p>CTE（WITH子句）是另一个MySQL 8.0的重要特性，它<strong>允许你定义临时的命名结果集</strong>，在后续查询中像普通表一样引用。</p>
<h3 data-id="heading-8">优势与示例</h3>
<ol>
<li><strong>提升可读性</strong>：将复杂查询分解成逻辑清晰的步骤。</li>
<li><strong>支持递归</strong>：这是CTE的杀手级功能，可以轻松查询树形或图状数据。</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例1：分解复杂查询（非递归）</span>
<span class="hljs-keyword">WITH</span> 
  high_value_orders <span class="hljs-keyword">AS</span> ( <span class="hljs-comment">-- 找出高价值订单</span>
    <span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">as</span> total_spent 
    <span class="hljs-keyword">FROM</span> orders 
    <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'completed'</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id 
    <span class="hljs-keyword">HAVING</span> total_spent <span class="hljs-operator">&gt;</span> <span class="hljs-number">10000</span>
  ),
  active_users <span class="hljs-keyword">AS</span> ( <span class="hljs-comment">-- 找出活跃用户</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> user_id 
    <span class="hljs-keyword">FROM</span> user_logs 
    <span class="hljs-keyword">WHERE</span> last_active_date <span class="hljs-operator">&gt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">30</span> <span class="hljs-keyword">DAY</span>)
  )
<span class="hljs-comment">-- 最终查询：既是高价值又是活跃的用户</span>
<span class="hljs-keyword">SELECT</span> u.name, u.email, h.total_spent
<span class="hljs-keyword">FROM</span> users u
<span class="hljs-keyword">JOIN</span> high_value_orders h <span class="hljs-keyword">ON</span> u.id <span class="hljs-operator">=</span> h.user_id
<span class="hljs-keyword">JOIN</span> active_users a <span class="hljs-keyword">ON</span> u.id <span class="hljs-operator">=</span> a.user_id;

<span class="hljs-comment">-- 示例2：递归CTE，查询部门树</span>
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> department_tree <span class="hljs-keyword">AS</span> (
    <span class="hljs-comment">-- 锚点：找到根部门</span>
    <span class="hljs-keyword">SELECT</span> id, name, parent_id, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> level 
    <span class="hljs-keyword">FROM</span> departments 
    <span class="hljs-keyword">WHERE</span> parent_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    <span class="hljs-comment">-- 递归成员：连接父部门和子部门</span>
    <span class="hljs-keyword">SELECT</span> d.id, d.name, d.parent_id, dt.level <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> departments d
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> department_tree dt <span class="hljs-keyword">ON</span> d.parent_id <span class="hljs-operator">=</span> dt.id
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> department_tree <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> level, id;
</code></pre>
<p><strong>深度剖析</strong>：递归CTE极大地简化了<strong>组织架构、分类目录、评论嵌套</strong>等层次数据的查询。</p>
<p>在旧版本中，这通常需要在应用层进行多次查询或在数据库中使用存储过程，递归CTE在数据库内核完成遍历，效率更高。</p>
<h2 data-id="heading-9">05 JSON类型与函数</h2>
<p>MySQL 5.7+原生支持JSON数据类型，让你能够在关系型数据库中灵活地存储和查询半结构化数据，这在处理<strong>动态字段、配置信息或第三方API返回的数据</strong>时非常有用。</p>
<h3 data-id="heading-10">核心操作</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 创建包含JSON列的表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    attributes JSON COMMENT <span class="hljs-string">'存储颜色、尺寸等动态属性'</span>
);

<span class="hljs-comment">-- 2. 插入JSON数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'T-Shirt'</span>, <span class="hljs-string">'{"color": "red", "size": ["M", "L"], "tags": ["casual", "cotton"]}'</span>);

<span class="hljs-comment">-- 3. 查询 (使用 -&gt; 和 -&gt;&gt; 操作符)</span>
<span class="hljs-comment">-- -&gt; 返回JSON类型， -&gt;&gt; 返回纯文本字符串</span>
<span class="hljs-keyword">SELECT</span> 
    name,
    attributes<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'$.color'</span> <span class="hljs-keyword">as</span> color, <span class="hljs-comment">-- 提取color值</span>
    attributes<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span><span class="hljs-string">'$.size'</span> <span class="hljs-keyword">as</span> size_array <span class="hljs-comment">-- 提取size数组（仍为JSON）</span>
<span class="hljs-keyword">FROM</span> products 
<span class="hljs-keyword">WHERE</span> attributes<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'$.color'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'red'</span> 
   <span class="hljs-keyword">OR</span> JSON_CONTAINS(attributes<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span><span class="hljs-string">'$.tags'</span>, <span class="hljs-string">'"cotton"'</span>);

<span class="hljs-comment">-- 4. 更新部分JSON</span>
<span class="hljs-keyword">UPDATE</span> products 
<span class="hljs-keyword">SET</span> attributes <span class="hljs-operator">=</span> JSON_SET(attributes, <span class="hljs-string">'$.color'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'$.new_field'</span>, <span class="hljs-string">'value'</span>) 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>深度剖析</strong>：JSON列同样可以建立索引（通过函数索引），加速查询。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_color <span class="hljs-keyword">ON</span> products( (attributes<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'$.color'</span>) );
</code></pre>
<p>这允许你在保持灵活性的同时，不丧失对关键字段的查询性能。</p>
<p>它完美填补了关系模型在应对<strong>多变业务需求</strong>时的短板。</p>
<h2 data-id="heading-11">06 分区表（Partitioning）</h2>
<p>当单表数据量巨大（如数亿行）时，分区可以将一张大表在物理上分割为多个更小、更易管理的部分，而逻辑上仍是一张表。</p>
<h3 data-id="heading-12">分区策略与示例</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 按时间范围(RANGE)分区，非常适合日志、订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> sales (
    id <span class="hljs-type">INT</span>,
    sale_date <span class="hljs-type">DATE</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
)
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> COLUMNS(sale_date) (
    <span class="hljs-keyword">PARTITION</span> p2023q1 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-string">'2023-04-01'</span>),
    <span class="hljs-keyword">PARTITION</span> p2023q2 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-string">'2023-07-01'</span>),
    <span class="hljs-keyword">PARTITION</span> p2023q3 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-string">'2023-10-01'</span>),
    <span class="hljs-keyword">PARTITION</span> p2023q4 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-string">'2024-01-01'</span>),
    <span class="hljs-keyword">PARTITION</span> p_future <span class="hljs-keyword">VALUES</span> LESS THAN MAXVALUE
);

<span class="hljs-comment">-- 查询时，优化器会自动定位到特定分区（分区裁剪，Partition Pruning）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sales <span class="hljs-keyword">WHERE</span> sale_date <span class="hljs-operator">=</span> <span class="hljs-string">'2023-05-15'</span>;
<span class="hljs-comment">-- 你会看到partitions: p2023q2，意味着只扫描了2023年Q2的分区。</span>
</code></pre>
<p>除了<code>RANGE</code>，还有<code>LIST</code>（按列表值）、<code>HASH</code>（按哈希值均匀分布）等分区方式。</p>
<p><strong>深度剖析</strong>：分区的核心优势在于<strong>维护性</strong>和<strong>查询性能</strong>。</p>
<p>你可以快速删除或归档整个旧分区（<code>ALTER TABLE sales DROP PARTITION p2023q1;</code>），这比<code>DELETE</code>操作快得多，且不产生碎片。对于按分区键过滤的查询，性能提升显著。</p>
<p>但注意，分区键选择不当或跨分区查询，性能可能反而下降。</p>
<h2 data-id="heading-13">07 连接（JOIN）与子查询</h2>
<p>多表关联是业务常态，但写得不好就是性能灾难。</p>
<h3 data-id="heading-14">高级技巧</h3>
<ol>
<li><strong>控制连接顺序</strong>：MySQL优化器通常会选择它认为最佳的顺序，但你可以在复杂场景下用<code>STRAIGHT_JOIN</code>强制指定顺序。</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> ... 
<span class="hljs-keyword">FROM</span> small_table s
STRAIGHT_JOIN large_table l <span class="hljs-keyword">ON</span> s.id <span class="hljs-operator">=</span> l.s_id; <span class="hljs-comment">-- 强制先查小表</span>
</code></pre>
<ol start="2">
<li><strong>利用衍生表（Derived Table）下推条件</strong>：有时将子查询或过滤条件提前，能极大地减少中间结果集。</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 优化前：先连接两个大表，再过滤</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> A <span class="hljs-keyword">JOIN</span> B <span class="hljs-keyword">ON</span> A.id <span class="hljs-operator">=</span> B.aid <span class="hljs-keyword">WHERE</span> A.create_time <span class="hljs-operator">&gt;</span> <span class="hljs-string">'...'</span>;

<span class="hljs-comment">-- 优化后：先过滤A表，再连接</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> A <span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;</span> <span class="hljs-string">'...'</span>) filtered_A
<span class="hljs-keyword">JOIN</span> B <span class="hljs-keyword">ON</span> filtered_A.id <span class="hljs-operator">=</span> B.aid;
</code></pre>
<ol start="3">
<li><strong><code>EXISTS</code> vs <code>IN</code></strong>：对于“是否存在”的查询，特别是子查询结果集较大时，<code>EXISTS</code>（关联子查询）通常比<code>IN</code>（非关联子查询）性能更好，因为它找到第一个匹配项就会停止。</li>
</ol>
<p><strong>深度剖析</strong>：所有的JOIN优化，其核心思想都是 <strong>“尽早过滤，减少中间数据量”</strong> 。熟练使用<code>EXPLAIN</code>查看连接类型（如<code>eq_ref</code>很好，<code>Using join buffer</code>说明可能需要索引）是关键。</p>
<h2 data-id="heading-15">08 用户自定义变量</h2>
<p>MySQL允许你定义用户变量（如<code>@rank</code>），这在一些需要<strong>跨行计算或记录中间状态</strong>的分析中非常有用。</p>
<h3 data-id="heading-16">实战案例：计算行间差值</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 计算每日销售额的日环比增长率</span>
<span class="hljs-keyword">SELECT</span> 
    sale_date,
    daily_amount,
    <span class="hljs-comment">-- 使用变量记录前一天的值</span>
    <span class="hljs-variable">@prev</span>_amount <span class="hljs-keyword">as</span> prev_day_amount,
    ROUND( (daily_amount <span class="hljs-operator">-</span> <span class="hljs-variable">@prev</span>_amount) <span class="hljs-operator">/</span> <span class="hljs-variable">@prev</span>_amount <span class="hljs-operator">*</span> <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> growth_rate,
    <span class="hljs-comment">-- 将当前值赋给变量，供下一行使用</span>
    <span class="hljs-variable">@prev</span>_amount :<span class="hljs-operator">=</span> daily_amount
<span class="hljs-keyword">FROM</span> 
    daily_sales_summary,
    (<span class="hljs-keyword">SELECT</span> <span class="hljs-variable">@prev</span>_amount :<span class="hljs-operator">=</span> <span class="hljs-number">0</span>) init <span class="hljs-comment">-- 初始化变量</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> sale_date;
</code></pre>
<p><strong>深度剖析</strong>：用户变量提供了过程式编程的能力，可以模拟窗口函数的部分功能（在MySQL 8.0之前）。</p>
<p>但它<strong>不是SQL标准</strong>，执行顺序有时反直觉，需谨慎使用。</p>
<p>在复杂的会话或事务中，变量的生命周期和作用域也需要仔细考量。</p>
<h2 data-id="heading-17">09 在线DDL与无锁变更</h2>
<p>在业务7x24小时运行的时代，给大表加字段、改索引再也不能随意停服务了。</p>
<p>MySQL 5.6+提供了<code>ALGORITHM</code>和<code>LOCK</code>选项，实现<strong>在线DDL</strong>（Online Data Definition）。</p>
<h3 data-id="heading-18">安全操作指南</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 添加一个可为空且有默认值的新列，使用INPLACE算法和尽量低的锁级别</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> huge_table 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> new_column <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
ALGORITHM<span class="hljs-operator">=</span>INPLACE, <span class="hljs-comment">-- 尽量使用INPLACE（原地重建），避免COPY（锁表复制）</span>
LOCK<span class="hljs-operator">=</span><span class="hljs-keyword">NONE</span>; <span class="hljs-comment">-- 目标：不加锁，或共享锁</span>

<span class="hljs-comment">-- 修改列类型（某些情况需要COPY，会锁表）</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> huge_table 
MODIFY <span class="hljs-keyword">COLUMN</span> old_column <span class="hljs-type">BIGINT</span>,
ALGORITHM<span class="hljs-operator">=</span><span class="hljs-keyword">COPY</span>, <span class="hljs-comment">-- 注意：这里可能必须用COPY</span>
LOCK<span class="hljs-operator">=</span>SHARED;
</code></pre>
<p><strong>深度剖析</strong>：<code>ALGORITHM=INPLACE</code>意味着大部分工作（如重建索引）在引擎内部完成，允许并发DML操作。</p>
<p>而<code>ALGORITHM=COPY</code>会创建新表并复制数据，全程锁表。</p>
<p>执行前务必用<code>ALGORITHM=DEFAULT</code>先测试一下。</p>
<p><strong>pt-online-schema-change</strong> 是Percona提供的第三方工具，通过触发器实现真正的全程无锁，是更稳妥的选择。</p>
<h2 data-id="heading-19">10 利用生成列与函数索引</h2>
<p>生成列的值由表中其他列计算而来，可分为<strong>虚拟列（VIRTUAL，不存储，读取时计算）和存储列（STORED，持久化存储）</strong>。</p>
<p>这为建立高效的函数索引铺平了道路。</p>
<h3 data-id="heading-20">应用场景</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景：经常需要根据 `first_name` 和 `last_name` 进行全名搜索</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> full_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) 
GENERATED ALWAYS <span class="hljs-keyword">AS</span> (CONCAT(first_name, <span class="hljs-string">' '</span>, last_name)) STORED, <span class="hljs-comment">-- 创建存储的生成列</span>
<span class="hljs-keyword">ADD</span> INDEX idx_full_name (full_name); <span class="hljs-comment">-- 在生成列上建立索引</span>

<span class="hljs-comment">-- 现在，以下查询可以高效使用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> full_name <span class="hljs-operator">=</span> <span class="hljs-string">'John Doe'</span>;
</code></pre>
<p><strong>深度剖析</strong>：这解决了直接在表达式（如<code>CONCAT(first_name, ‘ ‘, last_name)</code>）上建立函数索引的难题。</p>
<p>虚拟列节省空间但增加CPU计算开销；存储列反之。</p>
<p>更多项目实战在项目实战网：<a href="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" title="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" target="_blank">java突击队</a></p>
<h2 data-id="heading-21">总结：从“会用”到“精通”的跃迁</h2>
<p>好了，一口气聊了11个MySQL的高级用法。让我们最后再梳理一下，这些技巧并非孤立存在，它们构成了一个应对不同场景挑战的工具箱。</p>




























































<table><thead><tr><th align="left">高级用法</th><th align="left">核心解决痛点</th><th align="left">推荐适用场景</th></tr></thead><tbody><tr><td align="left"><strong>执行计划(EXPLAIN)</strong></td><td align="left">性能瓶颈可视化</td><td align="left"><strong>所有</strong>慢查询优化前的第一步</td></tr><tr><td align="left"><strong>高级索引策略</strong></td><td align="left">查询速度慢，写操作重</td><td align="left">高频查询、大表性能优化</td></tr><tr><td align="left"><strong>窗口函数(Window)</strong></td><td align="left">复杂跨行计算效率低</td><td align="left">排行榜、数据分析、报表</td></tr><tr><td align="left"><strong>通用表表达式(CTE)</strong></td><td align="left">复杂SQL难读写，树查询难</td><td align="left">复杂业务逻辑拆分，层次数据查询</td></tr><tr><td align="left"><strong>JSON类型</strong></td><td align="left">动态、半结构化数据存储与查询</td><td align="left">配置、动态属性、API数据存储</td></tr><tr><td align="left"><strong>分区表</strong></td><td align="left">超大表维护难，历史数据清理慢</td><td align="left">时间序列数据（日志、订单）</td></tr><tr><td align="left"><strong>JOIN/子查询优化</strong></td><td align="left">多表关联性能低下</td><td align="left">涉及多个业务实体的复杂查询</td></tr><tr><td align="left"><strong>用户自定义变量</strong></td><td align="left">需行间计算或状态保持（8.0前）</td><td align="left">自定义序列、差值计算（有窗口函数后优先级降低）</td></tr><tr><td align="left"><strong>在线DDL</strong></td><td align="left">业务不中断变更表结构</td><td align="left">7x24小时系统表结构变更</td></tr><tr><td align="left"><strong>生成列/函数索引</strong></td><td align="left">无法直接对表达式建索引</td><td align="left">基于JSON字段、计算字段的高效查询</td></tr></tbody></table>
<p>有些小伙伴在工作中可能会有这样的疑问：“我知道它们好，但该从哪里开始学起呢？”</p>
<p>我的建议是：<strong>从<code>EXPLAIN</code>和<code>索引优化</code>开始</strong>。</p>
<p>这是性能问题的根本。</p>
<p>然后，根据你的业务需求，引入<code>窗口函数</code>或<code>CTE</code>来简化复杂查询。当数据量上来后，考虑<code>分区</code>。</p>
<p>对于动态数据结构，尝试<code>JSON</code>类型。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring 源码分析 AOP 的实现原理]]></title>    <link>https://juejin.cn/post/7604522883487318050</link>    <guid>https://juejin.cn/post/7604522883487318050</guid>    <pubDate>2026-02-10T02:10:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604522883487318050" data-draft-id="7601069677567410222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 源码分析 AOP 的实现原理"/> <meta itemprop="keywords" content="Spring,Spring Boot,Java"/> <meta itemprop="datePublished" content="2026-02-10T02:10:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="暮色妖娆丶"/> <meta itemprop="url" content="https://juejin.cn/user/4292946760307655"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 源码分析 AOP 的实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292946760307655/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    暮色妖娆丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:10:48.000Z" title="Tue Feb 10 2026 02:10:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<h2 data-id="heading-1">AOP 的概念</h2>
<p><code>AOP</code> 的全称是 <code>Aspect-Oriented Programming</code> 面向切面编程，通常在我们日常开发中的模式都是方法直接实现完整功能。但有时候我们希望在某一个或多个功能方法中加入一些通用的其他逻辑，但是又不希望修改这一批方法的源代码，也不希望修改调用这批方法的方法的源代码，导致一大堆重复代码。于是 <code>AOP</code> 就诞生了。<code>AOP</code> 的作用可以理解为下图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c88de1bc118f490cac334029a7f1d0f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pqu6Imy5aaW5aiG5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771294248&amp;x-signature=CSroo%2Fd8VPUTiVFF46Ck1VSTBF4%3D" alt="image.png" loading="lazy"/></p>
<p>在执行目标方法前后添加一些额外的逻辑。最经典的实现是 <code>AspectJ</code> 框架</p>
<h2 data-id="heading-2">AOP 的代表作 AspectJ</h2>
<p>在 <code>Java</code> 领域中， <code>AspectJ</code> 是最早、最完整、功能最强大的一个 <code>AOP</code> 框架。前面我们说了 <code>AOP</code> 的思想是在方法执行前后加入一些自定义逻辑，那么到底怎么加呢？<code>AspectJ</code> 提供了两种方式：编译期织入和运行时织入。下面我们先看代码示例，使用 <code>AspectJ</code> 如何实现 <code>AOP</code> 编程</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyanzhisishui%2Faspectj-test.git" target="_blank" title="https://github.com/yanzhisishui/aspectj-test.git" ref="nofollow noopener noreferrer">示例源码已分享到 Github</a></p>
<p>目标类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span>{
        System.out.println(<span class="hljs-string">"test1 started!"</span>);
    }
}
</code></pre>
<p>切面类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceAspect</span> {
    <span class="hljs-meta">@Before("execution(* com.example.UserService.test1())")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span>{
        System.out.println(<span class="hljs-string">"before test1!"</span>);
    }
}
</code></pre>
<p>这里 <code>@Before</code> 注解的值叫做 <code>切点表达式</code>，它描述了我们将要拦截哪些目标方法执行当前的增强逻辑</p>
<h3 data-id="heading-3">编译期织入</h3>
<p>编译期织入需要特定的编译插件。在 <code>pom.xml</code> 中添加下面这个插件</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.mojo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectj-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.14.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">complianceLevel</span>&gt;</span>16.0<span class="hljs-tag">&lt;/<span class="hljs-name">complianceLevel</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>16<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>16<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<p>有了这个插件之后，<code>maven</code> 工具栏里面就会多一个工具</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89f54ac3b880443b90a8499fba610b40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pqu6Imy5aaW5aiG5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771294248&amp;x-signature=wLyOqO35o4MHa2QII2hRI0MglDk%3D" alt="image.png" loading="lazy"/></p>
<p>运行它之后，我们可以直观的看到 <code>target/classes</code> 文件夹下目标类的方法已经变了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baefc08982cb4b83b6ab77496409ee26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pqu6Imy5aaW5aiG5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771294248&amp;x-signature=05ymz3iunsnalx6XYSPpEwUJ5I8%3D" alt="image.png" loading="lazy"/></p>
<p>实际业务中这种方式使用很少，这里只是为了后续理解 <code>Spring AOP</code> 。</p>
<h3 data-id="heading-4">运行时织入</h3>
<p>运行时织入是基于 <code>Java agent</code> 技术。它允许在 <code>JVM</code> 启动时或运行时 <strong>动态修改已加载或即将加载的类的字节码</strong>。对于上面的示例，也就是说运行时把 <code>UserService</code> 的 <code>class</code> 文件改了，其实就是改成了上面编译织入后的 <code>class</code> 文件一样。只不过这是基于 <code>Java agent</code> 技术 <strong>运行时</strong> 实现的</p>
<p>在 <code>JVM</code> 启动参数添加下面内容，<code>aspectjweaver-1.9.25.jar</code> 的路径换成自己实际的地址即可</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-javaagent:C:\Users\14812.m2\repository\org\aspectj\aspectjweaver\1.9.25\aspectjweaver-1.9.25.jar</span>
</code></pre>
<blockquote>
<p>关于 Java Agent 技术也挺神奇，在运行程序后会先执行 <code>aspectjweaver-1.9.25.jar</code> 下 <code>META-INF/MANIFEST.MF</code> 中指定的一个类 <code>Premain-Class</code></p>
</blockquote>
<h3 data-id="heading-5">切点、切面、连接点、通知</h3>
<p>有了上面的案例，我们再来理解 <code>AOP</code> 思想中核心的几个概念，这对于我们后续理解 <code>Spring AOP</code> 非常重要。</p>
<ul>
<li>切面：目标类的横切增强，是横切增强的完整封装单元，包含了可以对目标类所有增强</li>
<li>连接点：程序执行的所有潜在拦截点，可以理解为目标类中所有的内容，包括方法、字段赋值或访问、对象初始化等</li>
<li>切点：连接点的筛选器，它的切点表达式能筛选出一系列符合的方法</li>
<li>通知：具体拦截行为，我们拦截了这个切点要干什么业务</li>
</ul>
<p>这四个概念是 <code>AOP</code> 思想的重中之重。</p>



































<table><thead><tr><th>概念</th><th>demo示例</th><th>代码角色</th><th>说明</th></tr></thead><tbody><tr><td><strong>切面</strong></td><td><code>UserServiceAspect</code> 类</td><td><code>@Aspect</code> 类</td><td><strong>容器</strong>，组织切点、通知和其他 <code>AOP</code> 元素</td></tr><tr><td><strong>连接点</strong></td><td><code>UserService.test1()</code> 方法</td><td>目标类中所有的内容，包括方法、字段赋值、对象初始化</td><td><strong>客观存在</strong>的可执行点</td></tr><tr><td><strong>切点</strong></td><td><code>@Before("execution(* com.example.UserService.test1())")</code></td><td><code>@Pointcut</code> 定义 <code>@Before、@After、@Around</code> 的表达式</td><td><strong>筛选器</strong>，选择哪些连接点要处理</td></tr><tr><td><strong>通知</strong></td><td><code>public void before(){System.out.println("before test1!");}</code></td><td><code>@Before、@After、@Around</code>标注的方法</td><td><strong>拦截行为，前置、后置、环绕</strong>，在连接点执行的代码</td></tr></tbody></table>
<h3 data-id="heading-6">AspectJ 的强大之处，万物皆可拦截</h3>
<p>正如我们上面对连接点的描述。<code>AspectJ</code> 不仅能拦截方法，甚至还能拦截字段的设置、字段的访问、对象初始化等等。都是通过切点表达式来实现，切点表达式的写法非常丰富。<code>demo</code> 示例中演示了字段访问的拦截，由于工作中几乎用不到，所以其他内容这里就不一一介绍了，有兴趣可以自己探索。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 拦截 User.name 字段的读取</span>
<span class="hljs-meta">@Before("get(private String com.example.UserService.name)")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeReadName</span><span class="hljs-params">(JoinPoint jp)</span> {
    System.out.println(<span class="hljs-string">"【字段读】正在读取 User.name 字段"</span>);
    System.out.println(<span class="hljs-string">"  目标对象: "</span> + jp.getTarget());
    System.out.println(<span class="hljs-string">"  在类中: "</span> + jp.getSourceLocation());
}

<span class="hljs-comment">// 1. 拦截 User.name 字段的赋值</span>
<span class="hljs-meta">@Before("set(private String com.example.UserService.name)")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeSetName</span><span class="hljs-params">(JoinPoint jp)</span> {
    System.out.println(<span class="hljs-string">"【字段读】正在设置 User.name 字段"</span>);
    System.out.println(<span class="hljs-string">"  目标对象: "</span> + jp.getTarget());
    System.out.println(<span class="hljs-string">"  在类中: "</span> + jp.getSourceLocation());
}
</code></pre>
<h2 data-id="heading-7">SpringBoot 项目中使用 AspectJ</h2>
<h3 data-id="heading-8">Spring 中的 AOP 官网介绍</h3>
<p>在 <code>Spring</code> 中，集成了 <code>AspectJ</code> 框架，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-framework%2Freference%2F6.1%2Fcore%2Faop%2Fintroduction-spring-defn.html" target="_blank" title="https://docs.spring.io/spring-framework/reference/6.1/core/aop/introduction-spring-defn.html" ref="nofollow noopener noreferrer">Spring AOP 官网描述</a> 有一段是这么说的：</p>
<blockquote>
<p>Spring AOP never strives to compete with AspectJ to provide a comprehensive AOP solution. We believe that both proxy-based frameworks such as Spring AOP and full-blown frameworks such as AspectJ are valuable and that they are complementary, rather than in competition. Spring seamlessly integrates Spring AOP and IoC with AspectJ, to enable all uses of AOP within a consistent Spring-based application architecture. This integration does not affect the Spring AOP API or the AOP Alliance API. Spring AOP remains backward-compatible.</p>
</blockquote>
<p>可以自行翻译。<code>Spring</code> 保留了原生 <code>AspectJ</code> 的编程用法，但是实现原理不同，<code>AspectJ</code> 运行时增强通过 <code>Java agent</code> 实现，<code>Spring AOP</code> 是通过动态代理实现。关于动态代理可以参考这篇文章 <a href="https://juejin.cn/post/7387657842114134068" target="_blank" title="https://juejin.cn/post/7387657842114134068">学习 Java 动态代理</a> 。</p>
<h3 data-id="heading-9">使用示例</h3>
<p>和上一段的非 <code>Spring</code> 项目 <code>Aspect</code> 示例完全相同，只要在 <code>UserService</code> 和 <code>UserServiceAspect</code> 类上面加上 <code>@Component</code> 注解，交给 <code>Spring</code> 管理即可。如果使用非 <code>SpringBoot</code> 项目，还需要一个配置类，启用注解 <code>@EnableAspectJAutoProxy</code> 。如果是 <code>SpringBoot</code> 项目，我们引入 <code>aop-starter</code> 即可</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><code>AopAutoConfiguration</code> 会自动配置启用<code>@EnableAspectJAutoProxy</code>，那么只需要把我们两个类 <code>UserService</code> 和 <code>UserServiceAspect</code> 交给 <code>Sping</code> 管理即可实现。</p>
<h2 data-id="heading-10">Spring 中对于代理的抽象设计</h2>
<p><code>Spring</code> 中对于代理中的几个概念例如 通知、切点、连接的、切面做了一些抽象设计。</p>



































<table><thead><tr><th>概念</th><th>接口</th><th>描述</th><th>主要实现类</th></tr></thead><tbody><tr><td><strong>切点</strong></td><td>org.springframework.aop.Pointcut</td><td>在哪里应用通知，具体拦截行为发生在哪里，仅支持方法切点</td><td>AspectJExpressionPointcut</td></tr><tr><td><strong>通知</strong></td><td>org.aopalliance.aop.Advice</td><td>增强行为的统一抽象，表示具体增强逻辑是什么</td><td>BeforeAdvice、MethodInterceptor</td></tr><tr><td><strong>切面</strong></td><td>org.springframework.aop.Advisor</td><td>在 Spring AOP 中通常是包含切点和通知的封装</td><td>InstantiationModelAwarePointcutAdvisor</td></tr><tr><td><strong>连接点</strong></td><td>org.aopalliance.intercept.Joinpoint</td><td>可访问对象（方法）的访问的具体化</td><td>ReflectiveMethodInvocation</td></tr></tbody></table>
<p>这里需要类比前面我们在 <code>AspectJ</code> 那段关于这几个概念的表格，在 <code>Spring AOP</code> 中这些概念都有统一的抽象和具体的实现。</p>
<h2 data-id="heading-11">代理类的创建过程</h2>
<p>根据我们前面的文章 <code>Bean 的创建过程源码分析</code> 我们知道，代理类的创建发生在 <code>BeanPostProcessor.postProcessAfterInitialization()</code>。这里有一个重要的实现类 <code>AnnotationAwareAspectJAutoProxyCreator</code> 。它调用父类 <code>AbstractAutoProxyCreator.wrapIfNecessary()</code> 的创建代理逻辑</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">wrapIfNecessary</span><span class="hljs-params">(Object bean, String beanName, Object cacheKey)</span> {
    <span class="hljs-comment">//......</span>
    <span class="hljs-comment">// 获取这个类所有的切面</span>
    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="hljs-literal">null</span>);
    <span class="hljs-keyword">if</span> (specificInterceptors != DO_NOT_PROXY) {
       <span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);
       <span class="hljs-comment">//创建代理</span>
       <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createProxy(bean.getClass(), beanName, specificInterceptors, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonTargetSource</span>(bean));
       <span class="hljs-built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());
       <span class="hljs-keyword">return</span> proxy;
    }

    <span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);
    <span class="hljs-keyword">return</span> bean;
}
</code></pre>
<p>这里会获取所有该类的增强逻辑，示例中也就是 <code>UserServiceAspect</code>，如果有切面就创建代理对象返回。</p>
<h3 data-id="heading-12">获取切面</h3>
<p>一路跟踪源码 <code>getAdvicesAndAdvisorsForBean()</code> 源码进去，最后发现会在 <code>org.springframework.aop.aspectj.annotation.BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</code> 方法中遍历所有的 <code>beanName</code> 过滤出我们的切面类，源码中扫描 <code>@Aspect</code> 判断是否是一个切面，然后根据切点表达式匹配对应的目标类。然后遍历切点，为每一个切点都创建一个 <code>Advisor</code>，具体类型是 <code>InstantiationModelAwarePointcutAdvisorImpl</code>，随后缓存起来。</p>
<p><code>InstantiationModelAwarePointcutAdvisorImpl</code> 的主要作用是根据其内部的切面工厂获取具体的切点拦截行为。</p>
<h3 data-id="heading-13">创建代理的方式</h3>
<p>在 <code>AbstractAutoProxyCreator#buildProxy()</code> 中先构建代理工厂 <code>ProxyFactory</code>，然后调用 <code>ProxyFactory.getProxy()</code>。内部最终会根据代理工厂的配置来决定使用 <code>CGLIB</code> 还是 <code>JDK</code> 代理</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> AopProxy <span class="hljs-title function_">createAopProxy</span><span class="hljs-params">(AdvisedSupport config)</span> <span class="hljs-keyword">throws</span> AopConfigException {
    <span class="hljs-comment">// config.isProxyTargetClass() 在 SpringBoot 中是默认为 true 的</span>
    <span class="hljs-keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || !config.hasUserSuppliedInterfaces()) {
       Class&lt;?&gt; targetClass = config.getTargetClass();
       <span class="hljs-comment">//...</span>
       <span class="hljs-keyword">if</span> (targetClass == <span class="hljs-literal">null</span> || targetClass.isInterface() ||
             Proxy.isProxyClass(targetClass) || ClassUtils.isLambdaClass(targetClass)) {
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkDynamicAopProxy</span>(config);
       }
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjenesisCglibAopProxy</span>(config);
    }
    <span class="hljs-keyword">else</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkDynamicAopProxy</span>(config);
    }
}
</code></pre>
<h3 data-id="heading-14">SpringBoot 强制 CGLIB 代理</h3>
<p>上一段在实例化代理工厂的时候会执行一个复制方法，把当前对象 <code>AnnotationAwareAspectJAutoProxyCreator</code> 的 <code>proxyTargetClass</code> 属性拿过来，赋值给代理工厂，而这个属性默认是 <code>true</code>，后面会介绍</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#buildProxy</span>
<span class="hljs-keyword">private</span> Object <span class="hljs-title function_">buildProxy</span><span class="hljs-params">(Class&lt;?&gt; beanClass, <span class="hljs-meta">@Nullable</span> String beanName,<span class="hljs-meta">@Nullable</span> Object[] specificInterceptors, TargetSource targetSource, <span class="hljs-type">boolean</span> classOnly)</span> {
    <span class="hljs-comment">//......</span>
    <span class="hljs-type">ProxyFactory</span> <span class="hljs-variable">proxyFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyFactory</span>();
    proxyFactory.copyFrom(<span class="hljs-built_in">this</span>);
    <span class="hljs-comment">//......</span>
}

<span class="hljs-comment">//赋值方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">copyFrom</span><span class="hljs-params">(ProxyConfig other)</span> {
    Assert.notNull(other, <span class="hljs-string">"Other ProxyConfig object must not be null"</span>);
    <span class="hljs-built_in">this</span>.proxyTargetClass = other.proxyTargetClass;
    <span class="hljs-built_in">this</span>.optimize = other.optimize;
    <span class="hljs-built_in">this</span>.exposeProxy = other.exposeProxy;
    <span class="hljs-built_in">this</span>.frozen = other.frozen;
    <span class="hljs-built_in">this</span>.opaque = other.opaque;
}
</code></pre>
<p>所以当执行到 <code>org.springframework.aop.framework.DefaultAopProxyFactory#createAopProxy</code> 方法时，不管目标类是否实现接口，只要它本身不是接口，就一定会走 <code>CGLIB</code> 代理，这一点与原生 <code>Spring</code> 不同。<strong>SpringBoot 默认强制走 CGLIB 代理</strong></p>
<h3 data-id="heading-15">CGLIB 代理创建细节</h3>
<p>和我们之前在 <a href="https://link.juejin.cn?target=url" target="_blank" title="url" ref="nofollow noopener noreferrer">学习 Java 动态代理</a> 中提到的一样，先构造 <code>Enhancer</code> 实例，然后设置它的回调列表，
这里有一个代理对象方法调用入口的拦截器 <code>DynamicAdvisedInterceptor</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Callback[] getCallbacks(Class&lt;?&gt; rootClass) <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// Choose an "aop" interceptor (used for AOP calls).</span>
    <span class="hljs-comment">//调用目标方法前会先调用这个拦截器，构造时传入当前 Bean 的所有切面</span>
    <span class="hljs-type">Callback</span> <span class="hljs-variable">aopInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicAdvisedInterceptor</span>(<span class="hljs-built_in">this</span>.advised);

    <span class="hljs-comment">//......</span>
    Callback[] mainCallbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>[] {
          aopInterceptor,  <span class="hljs-comment">// for normal advice</span>
          targetInterceptor,  <span class="hljs-comment">// invoke target without considering advice, if optimized</span>
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializableNoOp</span>(),  <span class="hljs-comment">// no override for methods mapped to this</span>
          targetDispatcher, <span class="hljs-built_in">this</span>.advisedDispatcher,
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsInterceptor</span>(<span class="hljs-built_in">this</span>.advised),
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashCodeInterceptor</span>(<span class="hljs-built_in">this</span>.advised)
    };
    <span class="hljs-comment">//......</span>
       <span class="hljs-keyword">return</span> mainCallbacks;
    }
----------------------------分隔线-----------------------------
<span class="hljs-comment">//设置回调列表    </span>
enhancer.setCallbacks(callbacks);
</code></pre>
<p>当代理类创建完毕之后，我们获取它的 <code>class</code> 全名，然后使用 <code>arthas</code> 工具获取代理类的源码，代码很多，这里我们只看我们增强的方法 <code>test1()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">MethodInterceptor</span> <span class="hljs-variable">methodInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.CGLIB$CALLBACK_0;
        <span class="hljs-keyword">if</span> (methodInterceptor == <span class="hljs-literal">null</span>) {
            UserService$$SpringCGLIB$$<span class="hljs-number">0.</span>CGLIB$BIND_CALLBACKS(<span class="hljs-built_in">this</span>);
            methodInterceptor = <span class="hljs-built_in">this</span>.CGLIB$CALLBACK_0;
        }
        <span class="hljs-keyword">if</span> (methodInterceptor != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> methodInterceptor.intercept(<span class="hljs-built_in">this</span>, CGLIB$test1$<span class="hljs-number">0</span>$Method, CGLIB$emptyArgs, CGLIB$test1$<span class="hljs-number">0</span>$Proxy);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">//调用原始类的方法，这也说明当前代理类是原始类的一个子类</span>
        <span class="hljs-built_in">super</span>.test1();
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">//......</span>
}
</code></pre>
<p>我们发现执行 <code>super.test1()</code> 也就是调用原始对象的方法时，会先调用这个 <code>CGLIB$CALLBACK_0</code> 的 <code>intercept()</code> 方法，而这个 <code>CGLIB$CALLBACK_0</code> 就是上一段我们设置的 <code>DynamicAdvisedInterceptor</code> 实例。</p>
<h3 data-id="heading-16">AnnotationAwareAspectJAutoProxyCreator</h3>
<p>前面我们介绍了这个类是创建代理的入口类，查看类的继承结构，发现它是 <code>AbstractAutoProxyCreator</code> 的子类，并且是一个 <code>BeanPostProcessor</code>，它是被 <code>AspectJAutoProxyRegistrar#registerBeanDefinitions</code> 注册到 <code>Spring</code> 容器的，<code>AspectJAutoProxyRegistrar</code> 是被 <code>@EnableAspectJAutoProxy</code> 导入的，在 <code>AopAutoConfiguration</code> 自动配置中启用了该注解</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AutoConfiguration</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "spring.aop", name = "auto", havingValue = "true", matchIfMissing = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopAutoConfiguration</span> {

    <span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span>
    <span class="hljs-comment">//有 AspectJ 时生效</span>
    <span class="hljs-meta">@ConditionalOnClass(Advice.class)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectJAutoProxyingConfiguration</span> {

       <span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span>
       <span class="hljs-comment">//启用 Aspect 自动代理，matchIfMissing = true 默认使用 CGLIB 代理</span>
       <span class="hljs-comment">//proxyTargetClass = true</span>
       <span class="hljs-meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span>
       <span class="hljs-meta">@ConditionalOnProperty(prefix = "spring.aop", name = "proxy-target-class", havingValue = "true",matchIfMissing = true)</span>
       <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibAutoProxyConfiguration</span> {}
    }

    <span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span>
    <span class="hljs-comment">//当没有 AspectJ 时生效，下一篇说事务的时候会介绍</span>
    <span class="hljs-meta">@ConditionalOnMissingClass("org.aspectj.weaver.Advice")</span>
    <span class="hljs-meta">@ConditionalOnProperty(prefix = "spring.aop", name = "proxy-target-class", havingValue = "true",matchIfMissing = true)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassProxyingConfiguration</span> {
       <span class="hljs-meta">@Bean</span>
       <span class="hljs-keyword">static</span> BeanFactoryPostProcessor <span class="hljs-title function_">forceAutoProxyCreatorToUseClassProxying</span><span class="hljs-params">()</span> {
          <span class="hljs-keyword">return</span> (beanFactory) -&gt; {
             <span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry registry) {
                AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry);
                AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);
             }
          };
       }
    }
}
</code></pre>
<p>总结 <code>AnnotationAwareAspectJAutoProxyCreator</code> 这个 <code>Bean</code> 的来源如下</p>
<p><code>AopAutoConfiguration → AspectJAutoProxyingConfiguration → @EnableAspectJAutoProxy → AspectJAutoProxyRegistrar</code></p>
<h2 data-id="heading-17">代理类的调用过程</h2>
<p><code>debug UserService.test1()</code> 我们发现在实际调用这个方法前有一系列的调用</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/add23be526f04a56b4cbb531ba5a1506~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pqu6Imy5aaW5aiG5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771294248&amp;x-signature=Kzjv4qTwxRSuJB%2B9%2FvqLEtEBFuM%3D" alt="image.png" loading="lazy"/></p>
<p>最早的入口是一个代理类的 <code>UserService$$SpringCGLIB$$0.test1()</code>，紧接着是我们上一段在创建代理对象是提到的，<code>DynamicAdvisedInterceptor#intercept</code> 入口回调函数。然后就是一系列的 <code>invoke</code> 最终到达我们原生的 <code>UserService.test1()</code> 。</p>
<h3 data-id="heading-18">DynamicAdvisedInterceptor</h3>
<p>上一段我们说了，代理对象调用目标对象方法之前会调用 <code>DynamicAdvisedInterceptor.intercept()</code>，这里是代理对象增强逻辑处理的入口 我们看一下它的源码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object proxy, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable {
   <span class="hljs-comment">//......</span>
   <span class="hljs-comment">//根据当前 Bean 的切面获取一个 chain 列表</span>
   List&lt;Object&gt; chain = <span class="hljs-built_in">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);
   Object retVal;
   <span class="hljs-keyword">if</span> (chain.isEmpty()) {......}
   <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// We need to create a method invocation...</span>
      retVal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectiveMethodInvocation</span>(proxy, target, method, args, targetClass, chain).proceed();
   }
   <span class="hljs-keyword">return</span> processReturnType(proxy, target, method, args, retVal);
    <span class="hljs-comment">//......</span>
}
</code></pre>
<p>只看关键部分，获取了一个 <code>chain</code> 列表，然后构造 <code>ReflectiveMethodInvocation</code> 调用 <code>proceed()</code>，这个 <code>chain</code> 就是我们的包含增强逻辑的拦截器</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/108e55fa04464963a09c8de7b8a08291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pqu6Imy5aaW5aiG5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771294248&amp;x-signature=CEbGw9gu4FdpGP%2FHP%2Bwb%2B5bZXWk%3D" alt="image.png" loading="lazy"/></p>
<p>因为我们测试案例使用的是 <code>@Before</code> 注解实现的前置增强，所以这里是 <code>MethodBeforeAdviceInterceptor</code>，同理 <code>@AfterReturning</code>、<code>@Around</code> 等都有对应的拦截器，除了第一个 <code>ExposeInvocationInterceptor</code> 之外，定义几个切点这里就会有几个 <code>chain</code>。</p>
<p><code>ExposeInvocationInterceptor</code> 是一个特殊的拦截器，用来充当上下文的，内部有一个 <code>ThreadLocal</code> 存储入口 <code>ReflectiveMethodInvocation</code> 对象，</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;MethodInvocation&gt; invocation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedThreadLocal</span>&lt;&gt;(<span class="hljs-string">"Current AOP method invocation"</span>);
</code></pre>
<p>这可以便于后续 <code>AspectJ</code> 内部或者我们自己在增强代码块中使用它，例如</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Around("pointcut()")</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
    <span class="hljs-comment">//获取当前 MethodInvocation，现在你知道为什么 ExposeInvocationInterceptor 在 List&lt;chain&gt; 的第一个了吧？</span>
    <span class="hljs-type">MethodInvocation</span> <span class="hljs-variable">methodInvocation</span> <span class="hljs-operator">=</span> ExposeInvocationInterceptor.currentInvocation();
    <span class="hljs-comment">//......</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>现在你知道为什么 <code>ExposeInvocationInterceptor</code> 在 <code>List&lt;chain&gt;</code> 的第一个了吧？因为后续每一个拦截器都可能会用到它绑定到 <code>ThreadLocal</code> 的 <code>MethodInvocation</code> 。</p>
<h3 data-id="heading-19">ReflectiveMethodInvocation</h3>
<p>这是代理方法增强逻辑的核心，拦截器链会在 <code>ReflectiveMethodInvocation.proceed()</code> 里面遍历执行，就像我们以前学过的 <code>Servlet</code> 过滤器链，查看源码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ReflectiveMethodInvocation</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">proceed</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable {
    <span class="hljs-comment">// 如果当前拦截器列表全部执行完，就调用原始方法</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.currentInterceptorIndex == <span class="hljs-built_in">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="hljs-number">1</span>) {
       <span class="hljs-comment">//调用原始方法（被代理的对象的方法）</span>
       <span class="hljs-keyword">return</span> invokeJoinpoint();
    }
    <span class="hljs-comment">//每次都索引自增，获取下一个拦截器</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">interceptorOrInterceptionAdvice</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="hljs-built_in">this</span>.currentInterceptorIndex);
    <span class="hljs-keyword">if</span> (interceptorOrInterceptionAdvice <span class="hljs-keyword">instanceof</span> InterceptorAndDynamicMethodMatcher dm) {
       <span class="hljs-comment">//......</span>
    }
    <span class="hljs-keyword">else</span> {
       <span class="hljs-comment">//调用拦截器</span>
       <span class="hljs-keyword">return</span> ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(<span class="hljs-built_in">this</span>);
    }
}
</code></pre>
<p>注意这里 <code>MethodInterceptor.invoke(this)</code>，传递了当前 <code>ReflectiveMethodInvocation</code> 对象，每个拦截器内部处理完都会再执行一遍 <code>ReflectiveMethodInvocation.proceed()</code>，所以程序又会回到，<code>ReflectiveMethodInvocation.proceed()</code> 内部，进而开始执行下一个拦截器，直接到拦截器列表执行完毕，会调用 <code>invokeJoinpoint()</code> 执行原始方法。</p>
<h3 data-id="heading-20">代理方法调用链路图解</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5cba946a72f442eae3e9f014fc0b923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pqu6Imy5aaW5aiG5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771294248&amp;x-signature=knrIbicSwYO%2Bcu3zPKJufrWTYlI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-21">Spring AOP 和 AspectJ 的区别</h2>



























































<table><thead><tr><th>对比维度</th><th>Spring AOP</th><th>AspectJ 原生 AOP</th><th>区别</th></tr></thead><tbody><tr><td><strong>核心实现机制</strong></td><td><strong>动态代理</strong>（JDK动态代理或CGLIB字节码生成）</td><td><strong>字节码织入</strong>（编译时、加载时、编译后）</td><td>Spring AOP 在运行时创建代理包装目标对象；AspectJ 直接修改 .class 文件字节码</td></tr><tr><td><strong>织入时机</strong></td><td><strong>运行时</strong>（应用启动时创建代理）</td><td><strong>编译时</strong>、<strong>加载时</strong>（类加载期）或<strong>编译后</strong></td><td>AspectJ 的编译时织入性能最优，无运行时开销；Spring AOP 每次方法调用都有代理转发开销</td></tr><tr><td><strong>拦截能力（连接点）</strong></td><td><strong>仅方法执行</strong>（主要是 public 方法）</td><td><strong>很多种连接点</strong>：方法执行/调用、构造器执行/调用、字段读/写、异常处理、类初始化、静态初始化、建议执行</td><td>Spring AOP 无法拦截字段访问、构造器调用、静态初始化等</td></tr><tr><td><strong>目标对象限制</strong></td><td><strong>仅 Spring 容器管理的 Bean</strong></td><td><strong>任何Java对象</strong>（包括第三方库、自己 new 的对象）</td><td>Spring AOP 只能拦截通过 Spring 容器获取的 Bean；AspectJ 可拦截任何类的实例</td></tr><tr><td><strong>内部调用问题</strong></td><td><strong>无法拦截</strong>（同类内的方法A调用方法B）</td><td><strong>可以拦截</strong></td><td>Spring AOP 由于代理机制限制，内部调用不经过代理；AspectJ 直接修改字节码，无此限制</td></tr><tr><td><strong>性能影响</strong></td><td><strong>有运行时开销</strong>（代理调用链、反射）</td><td><strong>编译时织入零运行时开销</strong>；加载时织入有初次加载开销</td><td>对性能敏感场景，AspectJ 编译时织入是首选</td></tr><tr><td><strong>依赖关系</strong></td><td>轻量，只依赖 Spring 核心</td><td>需要 AspectJ 编译器（ajc）或 织入器 agent</td><td>Spring 项目可轻易集成 Spring AOP；AspectJ 需要构建工具配合</td></tr><tr><td><strong>适用场景</strong></td><td>典型的 Spring 应用，横切关注点简单（日志、事务、安全等）</td><td>复杂 AOP 需求、高性能要求、拦截非 Spring 对象、系统级监控</td><td>根据需求复杂度选择：简单用 Spring AOP ，复杂用 AspectJ</td></tr></tbody></table>
<h2 data-id="heading-22">结语</h2>
<p>掌握了 <code>Spring AOP</code> 的实现原理，对于后续我们理解 <code>Spring</code> 事务的支持会有极大的帮助。</p>
<h3 data-id="heading-23">如果这篇文章对你有帮助，记得点赞加关注！你的支持就是我继续创作的动力！</h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Polymarket 量化交易实战（二）：WebSocket 实时数据流]]></title>    <link>https://juejin.cn/post/7604693038439759878</link>    <guid>https://juejin.cn/post/7604693038439759878</guid>    <pubDate>2026-02-10T02:05:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604693038439759878" data-draft-id="7604574877035823147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Polymarket 量化交易实战（二）：WebSocket 实时数据流"/> <meta itemprop="keywords" content="web3,区块链"/> <meta itemprop="datePublished" content="2026-02-10T02:05:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不辞远_Web3"/> <meta itemprop="url" content="https://juejin.cn/user/3452906910267656"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Polymarket 量化交易实战（二）：WebSocket 实时数据流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3452906910267656/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不辞远_Web3
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:05:54.000Z" title="Tue Feb 10 2026 02:05:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>HTTP 轮询拿到的价格，是历史。</strong></p>
<p>V1 版本的 Bot 用 REST API 轮询盘口，2 秒一次。结果很直接：单子要么成交不了，要么成交即亏损。</p>
<p>预测市场的盘口变化快，2 秒的延迟足以让你看到的价格和实际价格完全脱节。要做量化，<strong>必须接 WebSocket</strong>。</p>
<hr/>
<h2 data-id="heading-0">两个 WebSocket，选哪个</h2>
<p>Polymarket 提供两个 WebSocket 服务：</p>
<ol>
<li>
<p><strong>CLOB WebSocket</strong> — <code>wss://ws-subscriptions-clob.polymarket.com/ws/market</code><br/>
盘口、成交、价格变动，量化交易要的数据都在这里</p>
</li>
<li>
<p><strong>RTDS</strong> — <code>wss://ws-live-data.polymarket.com</code><br/>
实时价格流和评论数据，更适合做前端展示</p>
</li>
</ol>
<p>量化交易用 CLOB WebSocket。它分两个频道：</p>
<ul>
<li><strong>Market Channel</strong> — 公开市场数据，不需要认证</li>
<li><strong>User Channel</strong> — 订单状态推送，需要 API Key 认证</li>
</ul>
<p>我的 Bot 两个都接了。Market Channel 拿盘口数据做决策，User Channel 监听自己的订单状态，确认成交后再更新仓位。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b62902ec26994e60b3aef32cd8a9b513~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6L6e6L-cX1dlYjM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771294516&amp;x-signature=UW6hljsCeiGD4lgfV6mbR%2BPiXlA%3D" alt="Polymarket WebSocket 架构总览" loading="lazy"/>
<em>Polymarket WebSocket 架构总览</em></p>
<h2 data-id="heading-1">连接与订阅</h2>
<p>Market Channel 不需要认证，连上就能订阅：</p>
<pre><code class="hljs language-bash" lang="bash">import websockets
import json

WS_URL = <span class="hljs-string">"wss://ws-subscriptions-clob.polymarket.com/ws/market"</span>

async def subscribe(ws, asset_ids: list[str]):
    <span class="hljs-string">""</span><span class="hljs-string">"订阅指定 token 的市场数据"</span><span class="hljs-string">""</span>
    msg = {
        <span class="hljs-string">"assets_ids"</span>: asset_ids,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"market"</span>
    }
    await ws.send(json.dumps(msg))
</code></pre>
<p>连接建立后可以动态增减订阅，不用断开重连：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 追加订阅</span>
await ws.send(json.dumps({
    <span class="hljs-string">"assets_ids"</span>: [new_token_id],
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"market"</span>,
    <span class="hljs-string">"operation"</span>: <span class="hljs-string">"subscribe"</span>
}))

<span class="hljs-comment"># 取消订阅</span>
await ws.send(json.dumps({
    <span class="hljs-string">"assets_ids"</span>: [old_token_id],
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"market"</span>,
    <span class="hljs-string">"operation"</span>: <span class="hljs-string">"unsubscribe"</span>
}))
</code></pre>
<p>User Channel 需要认证，订阅格式不同：</p>
<pre><code class="hljs language-bash" lang="bash">msg = {
    <span class="hljs-string">"markets"</span>: [condition_id],
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-string">"auth"</span>: {
        <span class="hljs-string">"apiKey"</span>: api_key,
        <span class="hljs-string">"secret"</span>: secret,
        <span class="hljs-string">"passphrase"</span>: passphrase
    }
}
</code></pre>
<p>这里有个容易踩的坑：<strong>Market Channel 用 <code>assets_ids</code>（token ID），User Channel 用 <code>markets</code>（condition ID）</strong>。两个 ID 不是同一个东西。搞混了不会报错，只是收不到消息，debug 半天才发现。</p>
<p>【注：token ID 是某个 outcome 的唯一标识（比如 Yes token），condition ID 是整个市场的标识。一个 condition 下通常有两个 token（Yes 和 No）。】</p>
<h2 data-id="heading-2">四种消息，各有用处</h2>
<p>订阅成功后会收到四种消息。不是每种都要处理，取决于你的策略。</p>
<h3 data-id="heading-3">book — 盘口快照</h3>
<p>首次订阅或盘口大幅变动时推送，包含完整的买卖盘：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"event_type"</span>: <span class="hljs-string">"book"</span>,
  <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"token_id"</span>,
  <span class="hljs-string">"market"</span>: <span class="hljs-string">"condition_id"</span>,
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"1700000000000"</span>,
  <span class="hljs-string">"buys"</span>: [
    { <span class="hljs-string">"price"</span>: <span class="hljs-string">"0.55"</span>, <span class="hljs-string">"size"</span>: <span class="hljs-string">"100"</span> },
    { <span class="hljs-string">"price"</span>: <span class="hljs-string">"0.54"</span>, <span class="hljs-string">"size"</span>: <span class="hljs-string">"200"</span> }
  ],
  <span class="hljs-string">"sells"</span>: [
    { <span class="hljs-string">"price"</span>: <span class="hljs-string">"0.60"</span>, <span class="hljs-string">"size"</span>: <span class="hljs-string">"50"</span> },
    { <span class="hljs-string">"price"</span>: <span class="hljs-string">"0.61"</span>, <span class="hljs-string">"size"</span>: <span class="hljs-string">"150"</span> }
  ],
  <span class="hljs-string">"hash"</span>: <span class="hljs-string">"0xabc..."</span>
}
</code></pre>
<p><code>buys</code> 和 <code>sells</code> 是价位数组，每项包含 <code>price</code> 和 <code>size</code>。注意<strong>字段全是字符串</strong>，需要自己转 float。我一开始直接拿来比较大小，怎么比都不对，排查了好一阵才意识到在比较字符串。</p>
<p><code>hash</code> 是盘口内容的哈希值，可以校验本地盘口是否和服务端一致。实际跑下来，偶尔会出现本地盘口和服务端不同步的情况，定期用 hash 校验很有必要。</p>
<h3 data-id="heading-4">price_change — 价格变动</h3>
<p>有人下单或撤单时推送：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"event_type"</span>: <span class="hljs-string">"price_change"</span>,
  <span class="hljs-string">"market"</span>: <span class="hljs-string">"condition_id"</span>,
  <span class="hljs-string">"price_changes"</span>: [
    {
      <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"token_id"</span>,
      <span class="hljs-string">"price"</span>: <span class="hljs-string">"0.56"</span>,
      <span class="hljs-string">"size"</span>: <span class="hljs-string">"100"</span>,
      <span class="hljs-string">"side"</span>: <span class="hljs-string">"BUY"</span>,
      <span class="hljs-string">"best_bid"</span>: <span class="hljs-string">"0.55"</span>,
      <span class="hljs-string">"best_ask"</span>: <span class="hljs-string">"0.60"</span>
    }
  ],
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"1700000000000"</span>
}
</code></pre>
<p>这个消息直接给你 <code>best_bid</code> 和 <code>best_ask</code>，不需要自己从完整盘口计算。如果你的策略只关心最优报价，<strong>用 price_change 比 book 高效得多</strong>——数据量小，推送频率高。</p>
<p>我的策略主要依赖这个消息。book 只在启动时用来初始化盘口状态，之后全靠 price_change 驱动。</p>
<h3 data-id="heading-5">last_trade_price — 最新成交</h3>
<p>有成交时推送：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"event_type"</span>: <span class="hljs-string">"last_trade_price"</span>,
  <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"token_id"</span>,
  <span class="hljs-string">"price"</span>: <span class="hljs-string">"0.55"</span>,
  <span class="hljs-string">"side"</span>: <span class="hljs-string">"BUY"</span>,
  <span class="hljs-string">"size"</span>: <span class="hljs-string">"50"</span>,
  <span class="hljs-string">"fee_rate_bps"</span>: <span class="hljs-string">"0"</span>,
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"1700000000000"</span>
}
</code></pre>
<p><code>side</code> 是主动方向——BUY 说明是买方吃了卖单，SELL 反之。<code>fee_rate_bps</code> 是手续费率，单位是基点（1 基点 = 0.01%）。</p>
<p>成交数据对判断市场方向有用。连续出现大单 BUY，说明有人在扫货。</p>
<h3 data-id="heading-6">tick_size_change — 最小刻度变化</h3>
<p>当价格接近 0 或 1（&gt;0.96 或 &lt;0.04），最小报价刻度会从 0.01 变成 0.001：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"event_type"</span>: <span class="hljs-string">"tick_size_change"</span>,
  <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"token_id"</span>,
  <span class="hljs-string">"old_tick_size"</span>: <span class="hljs-string">"0.01"</span>,
  <span class="hljs-string">"new_tick_size"</span>: <span class="hljs-string">"0.001"</span>
}
</code></pre>
<p>这个消息容易被忽略。但如果你的策略在极端价格区间运行（比如事件即将结算），<strong>不处理刻度变化会导致下单被拒</strong>。我在一次选举结算前就吃过这个亏，Bot 连续报错 INVALID_TICK_SIZE，排查才发现是刻度变了没更新。</p>
<h2 data-id="heading-7">心跳：10 秒一次 PING</h2>
<p>WebSocket 连接不发心跳会被服务端断开。Polymarket 要求每 10 秒发一次 PING：</p>
<pre><code class="hljs language-bash" lang="bash">import asyncio

async def heartbeat(ws):
    <span class="hljs-keyword">while</span> True:
        await ws.send(<span class="hljs-string">"PING"</span>)
        await asyncio.sleep(10)
</code></pre>
<p>心跳和消息处理要并行跑：</p>
<pre><code class="hljs language-bash" lang="bash">async def run():
    async with websockets.connect(WS_URL) as ws:
        await subscribe(ws, asset_ids)
        await asyncio.gather(
            heartbeat(ws),
            handle_messages(ws)
        )
</code></pre>
<h2 data-id="heading-8">断连处理：先撤单，再重连</h2>
<p>WebSocket 不是万能的。网络抖动、服务端重启都会导致数据中断。</p>
<p>每条消息都带 <code>timestamp</code>，用它判断数据新鲜度：</p>
<pre><code class="hljs language-bash" lang="bash">MAX_STALE_MS = 5000  <span class="hljs-comment"># 5 秒</span>

def is_stale(msg_timestamp: str) -&gt; bool:
    age = time.time() * 1000 - int(msg_timestamp)
    <span class="hljs-built_in">return</span> age &gt; MAX_STALE_MS
</code></pre>
<p>数据过期时，策略应该<strong>立即停止交易</strong>。不要降级到 HTTP 轮询——HTTP 拿到的数据延迟更大，基于过时数据交易只会亏更多。</p>
<p>断连时的原则很简单：<strong>先撤单，再重连。</strong></p>
<pre><code class="hljs language-bash" lang="bash">async def handle_disconnect():
    <span class="hljs-comment"># 1. 立即撤销所有挂单</span>
    await client.cancel_all()
    <span class="hljs-comment"># 2. 等待后重连</span>
    await asyncio.sleep(2)
    await reconnect()
</code></pre>
<p>顺序不能反。先重连再撤单的话，重连期间挂单还在盘口上，盘口已经变了但你不知道，被成交了就是盲盒。</p>
<h2 data-id="heading-9">完整的消息处理框架</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bb47e59f4ff4e88a4c7c0fa52953408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6L6e6L-cX1dlYjM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771294516&amp;x-signature=CQ1mgFW7exKNsZzC2Okz%2FwrviHQ%3D" alt="消息处理与断连流程" loading="lazy"/>
<em>消息处理与断连流程</em></p>
<p>把上面的逻辑串起来：</p>
<pre><code class="hljs language-bash" lang="bash">async def handle_messages(ws):
    async <span class="hljs-keyword">for</span> raw <span class="hljs-keyword">in</span> ws:
        <span class="hljs-keyword">if</span> raw == <span class="hljs-string">"PONG"</span>:
            <span class="hljs-built_in">continue</span>

        msg = json.loads(raw)
        event = msg.get(<span class="hljs-string">"event_type"</span>)

        <span class="hljs-keyword">if</span> is_stale(msg.get(<span class="hljs-string">"timestamp"</span>, <span class="hljs-string">"0"</span>)):
            logger.warning(<span class="hljs-string">"数据过期，跳过"</span>)
            <span class="hljs-built_in">continue</span>

        <span class="hljs-keyword">if</span> event == <span class="hljs-string">"book"</span>:
            update_orderbook(msg)
        <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"price_change"</span>:
            on_price_change(msg)
        <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"last_trade_price"</span>:
            on_trade(msg)
        <span class="hljs-keyword">elif</span> event == <span class="hljs-string">"tick_size_change"</span>:
            on_tick_size_change(msg)
</code></pre>
<p>框架本身不复杂。难的是每个 handler 里的具体逻辑——怎么维护本地盘口、怎么判断信号、怎么管理订单状态。这些在后续的文章里会详细展开。</p>
<hr/>
<p>拿到实时数据流，才有资格谈策略。REST API 是看后视镜开车，WebSocket 才是挡风玻璃。</p>
<hr/>
<h3 data-id="heading-10">参考</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.polymarket.com%2Fdevelopers%2FCLOB%2Fwebsocket%2Fwss-overview" target="_blank" title="https://docs.polymarket.com/developers/CLOB/websocket/wss-overview" ref="nofollow noopener noreferrer">Polymarket WSS Overview</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.polymarket.com%2Fdevelopers%2FCLOB%2Fwebsocket%2Fmarket-channel" target="_blank" title="https://docs.polymarket.com/developers/CLOB/websocket/market-channel" ref="nofollow noopener noreferrer">Market Channel</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.polymarket.com%2Fquickstart%2Fwebsocket%2F" target="_blank" title="https://docs.polymarket.com/quickstart/websocket/" ref="nofollow noopener noreferrer">WSS Quickstart</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Meta Audience Network + AdMob 双平台集成完整指南]]></title>    <link>https://juejin.cn/post/7604685644685164596</link>    <guid>https://juejin.cn/post/7604685644685164596</guid>    <pubDate>2026-02-10T02:25:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604685644685164596" data-draft-id="7604685644685115444" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Meta Audience Network + AdMob 双平台集成完整指南"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-02-10T02:25:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="山水域"/> <meta itemprop="url" content="https://juejin.cn/user/2260251635887309"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Meta Audience Network + AdMob 双平台集成完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2260251635887309/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    山水域
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:25:14.000Z" title="Tue Feb 10 2026 02:25:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、架构选择：聚合平台（Mediation）</h3>
<p>同时接入多个广告网络，<strong>强烈推荐使用广告聚合（Mediation）平台</strong>，而不是自己手动管理切换逻辑。</p>
<h4 data-id="heading-1">1.1 主流聚合平台对比</h4>






























<table><thead><tr><th>聚合平台</th><th>说明</th><th>推荐度</th></tr></thead><tbody><tr><td><strong>Google AdMob Mediation</strong></td><td>AdMob 官方内置聚合，支持 Meta AN 作为第三方适配器</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>AppLovin MAX</strong></td><td>独立聚合平台，支持广泛广告网络，实时竞价能力强</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>ironSource LevelPlay</strong></td><td>游戏领域主流，已与 Unity Ads 合并</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>Mintegral / TopOn / TradPlus</strong></td><td>国内出海常用，支持国内外主流网络</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<blockquote>
<p><strong>本指南重点讲解最主流的两种方案：</strong></p>
<ol>
<li><strong>Google AdMob Mediation</strong>（以 AdMob 为主，Meta AN 做竞价补充）</li>
<li><strong>AppLovin MAX</strong>（独立聚合，AdMob + Meta AN 并行竞价）</li>
</ol>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、方案一：Google AdMob Mediation + Meta Audience Network（推荐）</h3>
<p>这是最直接的方案——AdMob 作为聚合主体，Meta AN 通过 <strong>Bidding（实时竞价）</strong> 参与竞争。好的，已经获取到所有关键信息。下面为您撰写完整详细的集成指南。</p>
<hr/>
<h2 data-id="heading-3">Meta Audience Network + AdMob 双平台集成完整指南（iOS/Swift）</h2>
<hr/>
<h3 data-id="heading-4">一、架构选择：为什么需要聚合（Mediation）？</h3>
<p>手动管理两个广告 SDK 的加载、展示、降级逻辑<strong>非常繁琐且容易出错</strong>。使用 <strong>广告聚合平台</strong> 可以：</p>
<ul>
<li>✅ 自动让多个广告网络实时竞价（Bidding），最大化收益</li>
<li>✅ 统一 API 调用，不需要为每个广告网络写单独代码</li>
<li>✅ 自动处理 No Fill 降级（A 网络没广告则自动切换到 B）</li>
<li>✅ 统一管理隐私合规</li>
</ul>
<h4 data-id="heading-5">1.1 主流聚合平台对比</h4>



































<table><thead><tr><th>聚合平台</th><th>特点</th><th>适合场景</th><th>推荐度</th></tr></thead><tbody><tr><td><strong>Google AdMob Mediation</strong></td><td>AdMob 官方内置，Meta AN 做竞价适配器</td><td>已使用 AdMob 的项目，最简单</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>AppLovin MAX</strong></td><td>独立聚合，两者并行竞价，公正透明</td><td>追求最高 eCPM 的游戏类应用</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>ironSource LevelPlay</strong></td><td>与 Unity 合并，游戏领域强势</td><td>Unity 游戏或已使用 ironSource</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>TopOn / TradPlus</strong></td><td>国内出海常用，支持国内外主流网络</td><td>出海应用同时接国内外广告</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>本指南重点讲解最主流的方案：Google AdMob Mediation + Meta AN（方案一）</strong> 和 <strong>AppLovin MAX（方案二）</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-6">二、方案一：Google AdMob Mediation + Meta Audience Network</h3>
<blockquote>
<p><strong>核心思路：</strong> AdMob 作为主聚合，Meta AN 通过 Bidding 适配器参与实时竞价竞争</p>
</blockquote>
<h4 data-id="heading-7">2.1 版本要求</h4>





























<table><thead><tr><th>条件</th><th>最低版本</th></tr></thead><tbody><tr><td>iOS Deployment Target</td><td><strong>13.0</strong></td></tr><tr><td>Google Mobile Ads SDK</td><td><strong>12.0.0+</strong>（推荐最新）</td></tr><tr><td>Meta Audience Network SDK</td><td><strong>6.21.0</strong></td></tr><tr><td>Meta Adapter</td><td><strong>6.21.0.0</strong></td></tr><tr><td>Xcode</td><td>最新版本</td></tr></tbody></table>
<blockquote>
<p>⚠️ Meta AN 自 2021 年起 <strong>只支持 Bidding</strong>（实时竞价），不再支持 Waterfall</p>
</blockquote>
<h4 data-id="heading-8">2.2 CocoaPods 安装</h4>
<pre><code class="hljs language-ruby" lang="ruby">platform <span class="hljs-symbol">:ios</span>, <span class="hljs-string">'13.0'</span>

target <span class="hljs-string">'YourApp'</span> <span class="hljs-keyword">do</span>
  use_frameworks!

  <span class="hljs-comment"># ① Google Mobile Ads SDK（AdMob 主体）</span>
  pod <span class="hljs-string">'Google-Mobile-Ads-SDK'</span>

  <span class="hljs-comment"># ② Meta Audience Network Mediation Adapter（自动包含 FBAudienceNetwork SDK）</span>
  pod <span class="hljs-string">'GoogleMobileAdsMediationFacebook'</span>
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pod install --repo-update
</code></pre>
<blockquote>
<p>只需要添加 <code>GoogleMobileAdsMediationFacebook</code>，它会<strong>自动拉取 <code>FBAudienceNetwork</code> SDK</strong>，不需要额外单独引入。</p>
</blockquote>
<h4 data-id="heading-9">2.3 Info.plist 配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ① AdMob App ID（必须） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>GADApplicationIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>ca-app-pub-xxxxxxxxxxxxxxxx~yyyyyyyyyy<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ② App Tracking Transparency 权限说明（iOS 14.5+ 必须） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>NSUserTrackingUsageDescription<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>此标识符将用于向您投放个性化广告<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ③ SKAdNetwork 标识符（AdMob + Meta 都需要） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkItems<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- Google --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>cstr6suwn9.skadnetwork<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- Meta --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>v9wttpbfk9.skadnetwork<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>n38lu8286q.skadnetwork<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- ... 完整列表参见 Google 和 Meta 官方文档 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">2.4 AppDelegate 初始化</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> GoogleMobileAds
<span class="hljs-keyword">import</span> FBAudienceNetwork
<span class="hljs-keyword">import</span> AppTrackingTransparency

<span class="hljs-keyword">@main</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(
        <span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,
        <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>
    ) -&gt; <span class="hljs-type">Bool</span> {

        <span class="hljs-comment">// ⏱ 延迟请求 ATT 权限（建议在首页 viewDidAppear 中调用更好）</span>
        <span class="hljs-comment">// 但必须在广告请求之前完成</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
}
</code></pre>
<h4 data-id="heading-11">2.5 ATT 权限请求 + SDK 初始化（推荐写法）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> GoogleMobileAds
<span class="hljs-keyword">import</span> FBAudienceNetwork
<span class="hljs-keyword">import</span> AppTrackingTransparency

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainViewController</span>: <span class="hljs-title class_">UIViewController</span> {

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewDidAppear(animated)
        requestATTThenInitializeAds()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">requestATTThenInitializeAds</span>() {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">14.5</span>, <span class="hljs-operator">*</span>) {
            <span class="hljs-comment">// ① 先请求 ATT 权限</span>
            <span class="hljs-type">ATTrackingManager</span>.requestTrackingAuthorization { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] status <span class="hljs-keyword">in</span>
                <span class="hljs-type">DispatchQueue</span>.main.async {
                    <span class="hljs-comment">// ② 根据结果设置 Meta ATE 标志</span>
                    <span class="hljs-comment">// 注意：SDK 6.15.0+ 在 iOS 17+ 会自动读取 ATT 状态</span>
                    <span class="hljs-comment">// 但 iOS 14.5 ~ 16.x 仍需要手动设置</span>
                    <span class="hljs-keyword">switch</span> status {
                    <span class="hljs-keyword">case</span> .authorized:
                        <span class="hljs-type">FBAdSettings</span>.setAdvertiserTrackingEnabled(<span class="hljs-literal">true</span>)
                    <span class="hljs-keyword">case</span> .denied, .restricted:
                        <span class="hljs-type">FBAdSettings</span>.setAdvertiserTrackingEnabled(<span class="hljs-literal">false</span>)
                    <span class="hljs-keyword">case</span> .notDetermined:
                        <span class="hljs-type">FBAdSettings</span>.setAdvertiserTrackingEnabled(<span class="hljs-literal">false</span>)
                    <span class="hljs-keyword">@unknown</span> <span class="hljs-keyword">default</span>:
                        <span class="hljs-keyword">break</span>
                    }

                    <span class="hljs-comment">// ③ ATT 完成后再初始化 Google Mobile Ads SDK</span>
                    <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.initializeGoogleAds()
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// iOS 14.5 以下直接初始化</span>
            initializeGoogleAds()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">initializeGoogleAds</span>() {
        <span class="hljs-comment">// Google Mobile Ads SDK 初始化（会同时初始化所有 Mediation Adapter）</span>
        <span class="hljs-type">GADMobileAds</span>.sharedInstance().start { status <span class="hljs-keyword">in</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ AdMob SDK 初始化完成"</span>)

            <span class="hljs-comment">// 打印各 Adapter 状态</span>
            <span class="hljs-keyword">let</span> adapterStatuses <span class="hljs-operator">=</span> status.adapterStatusesByClassName
            <span class="hljs-keyword">for</span> (adapter, status) <span class="hljs-keyword">in</span> adapterStatuses {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"  Adapter: <span class="hljs-subst">\(adapter)</span>, State: <span class="hljs-subst">\(status.state.rawValue)</span>, Desc: <span class="hljs-subst">\(status.description)</span>"</span>)
            }
        }
    }
}
</code></pre>
<blockquote>
<p>⚠️ <strong>关键顺序：ATT 权限 → 设置 Meta ATE → 初始化 GADMobileAds</strong></p>
<p>Google AdMob Mediation 初始化时会自动初始化 Meta AN SDK 适配器，<strong>不需要</strong>单独调用 <code>FBAudienceNetworkAds.initialize()</code></p>
</blockquote>
<h4 data-id="heading-12">2.6 Banner 广告（通过 AdMob 聚合）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> GoogleMobileAds

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BannerViewController</span>: <span class="hljs-title class_">UIViewController</span>, <span class="hljs-title class_">GADBannerViewDelegate</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> bannerView: <span class="hljs-type">GADBannerView</span>!

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        setupBanner()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setupBanner</span>() {
        <span class="hljs-comment">// 使用 AdMob 的 Ad Unit ID（在 AdMob 后台配置了 Meta Mediation 的广告单元）</span>
        bannerView <span class="hljs-operator">=</span> <span class="hljs-type">GADBannerView</span>(adSize: <span class="hljs-type">GADAdSizeBanner</span>) <span class="hljs-comment">// 320×50</span>
        bannerView.adUnitID <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-xxxxx/yyyyy"</span> <span class="hljs-comment">// ⬅️ AdMob Ad Unit ID</span>
        bannerView.rootViewController <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
        bannerView.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
        bannerView.translatesAutoresizingMaskIntoConstraints <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>

        view.addSubview(bannerView)
        <span class="hljs-type">NSLayoutConstraint</span>.activate([
            bannerView.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor),
            bannerView.centerXAnchor.constraint(equalTo: view.centerXAnchor)
        ])

        bannerView.load(<span class="hljs-type">GADRequest</span>())
    }

    <span class="hljs-comment">// MARK: - GADBannerViewDelegate</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">bannerViewDidReceiveAd</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">bannerView</span>: <span class="hljs-type">GADBannerView</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Banner 加载成功"</span>)
        <span class="hljs-comment">// 可通过 bannerView.responseInfo 查看是哪个网络填充的</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> adNetworkClassName <span class="hljs-operator">=</span> bannerView.responseInfo<span class="hljs-operator">?</span>.loadedAdNetworkResponseInfo<span class="hljs-operator">?</span>.adNetworkClassName {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"  填充来源: <span class="hljs-subst">\(adNetworkClassName)</span>"</span>)
            <span class="hljs-comment">// 如果是 Meta 填充，会显示 GADMediationAdapterFacebook</span>
        }
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">bannerView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">bannerView</span>: <span class="hljs-type">GADBannerView</span>, <span class="hljs-params">didFailToReceiveAdWithError</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ Banner 加载失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">bannerViewDidRecordImpression</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">bannerView</span>: <span class="hljs-type">GADBannerView</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👁️ Banner 曝光"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">bannerViewDidRecordClick</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">bannerView</span>: <span class="hljs-type">GADBannerView</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👆 Banner 点击"</span>)
    }
}
</code></pre>
<h4 data-id="heading-13">2.7 Interstitial 插屏广告（通过 AdMob 聚合）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> GoogleMobileAds

<span class="hljs-keyword">class</span> <span class="hljs-title class_">InterstitialViewController</span>: <span class="hljs-title class_">UIViewController</span>, <span class="hljs-title class_">GADFullScreenContentDelegate</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interstitialAd: <span class="hljs-type">GADInterstitialAd</span>?

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        loadInterstitialAd()
    }

    <span class="hljs-comment">/// 提前加载插屏广告</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadInterstitialAd</span>() {
        <span class="hljs-type">GADInterstitialAd</span>.load(
            withAdUnitID: <span class="hljs-string">"ca-app-pub-xxxxx/yyyyy"</span>, <span class="hljs-comment">// ⬅️ AdMob Ad Unit ID</span>
            request: <span class="hljs-type">GADRequest</span>()
        ) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] ad, error <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 插屏广告加载失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
                <span class="hljs-keyword">return</span>
            }
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 插屏广告加载成功"</span>)
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.interstitialAd <span class="hljs-operator">=</span> ad
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.interstitialAd<span class="hljs-operator">?</span>.fullScreenContentDelegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>

            <span class="hljs-comment">// 查看填充来源</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> adNetwork <span class="hljs-operator">=</span> ad<span class="hljs-operator">?</span>.responseInfo.loadedAdNetworkResponseInfo<span class="hljs-operator">?</span>.adNetworkClassName {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"  填充来源: <span class="hljs-subst">\(adNetwork)</span>"</span>)
            }
        }
    }

    <span class="hljs-comment">/// 在合适时机展示</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">showInterstitialAd</span>() {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> interstitialAd {
            ad.present(fromRootViewController: <span class="hljs-keyword">self</span>)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 广告尚未就绪"</span>)
        }
    }

    <span class="hljs-comment">// MARK: - GADFullScreenContentDelegate</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">ad</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">GADFullScreenPresentingAd</span>, <span class="hljs-params">didFailToPresentFullScreenContentWithError</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 展示失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
        loadInterstitialAd() <span class="hljs-comment">// 重新加载</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">adDidDismissFullScreenContent</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">GADFullScreenPresentingAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 插屏广告已关闭"</span>)
        loadInterstitialAd() <span class="hljs-comment">// ⭐ 关闭后预加载下一个</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">adDidRecordImpression</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">GADFullScreenPresentingAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👁️ 插屏广告曝光"</span>)
    }
}
</code></pre>
<h4 data-id="heading-14">2.9 AdMob 后台配置 Meta AN Mediation（关键步骤）</h4>
<p>在 AdMob 后台完成以下配置，才能让 Meta AN 参与竞价：</p>
<h5 data-id="heading-15">步骤 1：Meta 后台创建广告位</h5>
<ol>
<li>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbusiness.facebook.com%2Fpub%2Fstart" target="_blank" title="https://business.facebook.com/pub/start" ref="nofollow noopener noreferrer">Meta Business Suite → Monetization Manager</a></li>
<li>创建 Property → 选择 iOS 平台</li>
<li><strong>Mediation Platform 选择 "AdMob"</strong></li>
<li>为每种格式（Banner / Interstitial / Rewarded）创建 Placement</li>
<li><strong>记录每个 Placement ID</strong>（格式如 <code>123456789_987654321</code>）</li>
</ol>
<h5 data-id="heading-16">步骤 2：AdMob 后台添加 Meta 竞价</h5>
<ol>
<li>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.admob.com%2F" target="_blank" title="https://apps.admob.com/" ref="nofollow noopener noreferrer">AdMob Console</a></li>
<li>导航到 <strong>Mediation → Mediation Groups</strong></li>
<li>创建或编辑一个 Mediation Group</li>
<li>在 <strong>Bidding</strong> 区域，点击 <strong>Add Ad Sources → Meta Audience Network</strong></li>
<li>输入 Meta 的 <strong>Placement ID</strong></li>
<li>保存</li>
</ol>
<blockquote>
<p>💡 AdMob 会自动与 Meta 进行实时竞价（Bidding），<strong>不需要设置 eCPM 手动排序</strong></p>
</blockquote>
<h5 data-id="heading-17">步骤 3：配置 app-ads.txt</h5>
<p>在您的开发者网站根目录添加 <code>app-ads.txt</code> 文件，包含 AdMob 和 Meta 的授权行：</p>
<pre><code class="hljs language-text" lang="text"># Google AdMob
google.com, pub-xxxxxxxxxxxxxxxx, DIRECT, f08c47fec0942fa0

# Meta Audience Network
facebook.com, xxxxxxxxxxxxxxxxx, RESELLER, c3e20eee3f780d68
</code></pre>
<hr/>
<h3 data-id="heading-18">三、方案二：AppLovin MAX 聚合（独立聚合平台）</h3>
<blockquote>
<p><strong>核心思路：</strong> MAX 作为独立聚合，AdMob 和 Meta AN 同为竞价参与者，更加公平透明好的，已经获取到了所有需要的信息。以下是完整的后续内容：</p>
</blockquote>
<hr/>
<h4 data-id="heading-19">3.1 CocoaPods 安装</h4>
<pre><code class="hljs language-ruby" lang="ruby">platform <span class="hljs-symbol">:ios</span>, <span class="hljs-string">'13.0'</span>

target <span class="hljs-string">'YourApp'</span> <span class="hljs-keyword">do</span>
  use_frameworks!
  inhibit_all_warnings!

  <span class="hljs-comment"># ① AppLovin MAX SDK（聚合主体）</span>
  pod <span class="hljs-string">'AppLovinSDK'</span>

  <span class="hljs-comment"># ② Google AdMob 适配器（自动包含 Google Mobile Ads SDK）</span>
  pod <span class="hljs-string">'AppLovinMediationGoogleAdapter'</span>

  <span class="hljs-comment"># ③ Meta Audience Network 适配器（自动包含 FBAudienceNetwork SDK）</span>
  pod <span class="hljs-string">'AppLovinMediationFacebookAdapter'</span>
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pod install --repo-update
</code></pre>
<blockquote>
<p>💡 <strong>只需安装适配器 Pod，它们会自动拉取对应的广告网络 SDK</strong></p>
</blockquote>
<h4 data-id="heading-20">3.2 Info.plist 配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ① AppLovin SDK Key --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>AppLovinSdkKey<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>YOUR_APPLOVIN_SDK_KEY<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ② AdMob App ID（Google Adapter 需要） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>GADApplicationIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>ca-app-pub-xxxxxxxxxxxxxxxx~yyyyyyyyyy<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ③ ATT 权限描述 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>NSUserTrackingUsageDescription<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>此标识符将用于向您投放个性化广告<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ④ SKAdNetwork 标识符（AppLovin + Google + Meta 都需要） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkItems<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- AppLovin --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>ludvb6z3bs.skadnetwork<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- Google --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>cstr6suwn9.skadnetwork<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- Meta --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>v9wttpbfk9.skadnetwork<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>SKAdNetworkIdentifier<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>n38lu8286q.skadnetwork<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- ... 完整列表从各平台文档获取 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
</code></pre>
<h4 data-id="heading-21">3.3 SDK 初始化</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> AppLovinSDK
<span class="hljs-keyword">import</span> FBAudienceNetwork
<span class="hljs-keyword">import</span> AppTrackingTransparency

<span class="hljs-keyword">@main</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(
        <span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,
        <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>
    ) -&gt; <span class="hljs-type">Bool</span> {

        <span class="hljs-comment">// ① 请求 ATT 权限（延迟到首页更好，此处简化演示）</span>
        <span class="hljs-type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="hljs-operator">+</span> <span class="hljs-number">1.0</span>) {
            <span class="hljs-keyword">self</span>.requestATTAndInitialize()
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">requestATTAndInitialize</span>() {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">14.5</span>, <span class="hljs-operator">*</span>) {
            <span class="hljs-type">ATTrackingManager</span>.requestTrackingAuthorization { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] status <span class="hljs-keyword">in</span>
                <span class="hljs-type">DispatchQueue</span>.main.async {
                    <span class="hljs-comment">// ② 设置 Meta ATE 标志</span>
                    <span class="hljs-keyword">switch</span> status {
                    <span class="hljs-keyword">case</span> .authorized:
                        <span class="hljs-type">FBAdSettings</span>.setAdvertiserTrackingEnabled(<span class="hljs-literal">true</span>)
                    <span class="hljs-keyword">default</span>:
                        <span class="hljs-type">FBAdSettings</span>.setAdvertiserTrackingEnabled(<span class="hljs-literal">false</span>)
                    }

                    <span class="hljs-comment">// ③ 初始化 AppLovin MAX SDK</span>
                    <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.initializeMAX()
                }
            }
        } <span class="hljs-keyword">else</span> {
            initializeMAX()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">initializeMAX</span>() {
        <span class="hljs-comment">// SDK Key 可在 AppLovin Dashboard → Account → General → Keys 找到</span>
        <span class="hljs-keyword">let</span> initConfig <span class="hljs-operator">=</span> <span class="hljs-type">ALSdkInitializationConfiguration</span>(sdkKey: <span class="hljs-string">"YOUR_SDK_KEY"</span>) { builder <span class="hljs-keyword">in</span>
            builder.mediationProvider <span class="hljs-operator">=</span> <span class="hljs-type">ALMediationProviderMAX</span>

            <span class="hljs-comment">// （可选）如果需要测试特定广告单元</span>
            <span class="hljs-comment">// builder.testDeviceAdvertisingIdentifiers = ["YOUR_IDFA"]</span>
        }

        <span class="hljs-type">ALSdk</span>.shared().initialize(with: initConfig) { sdkConfig <span class="hljs-keyword">in</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ AppLovin MAX SDK 初始化完成"</span>)
            <span class="hljs-comment">// 此时可以开始加载广告</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-22">3.4 Banner 广告</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> AppLovinSDK

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MAXBannerViewController</span>: <span class="hljs-title class_">UIViewController</span>, <span class="hljs-title class_">MAAdViewAdDelegate</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> adView: <span class="hljs-type">MAAdView</span>!

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        createBannerAd()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">createBannerAd</span>() {
        <span class="hljs-comment">// Ad Unit ID 在 AppLovin Dashboard → MAX → Ad Units 创建</span>
        adView <span class="hljs-operator">=</span> <span class="hljs-type">MAAdView</span>(adUnitIdentifier: <span class="hljs-string">"YOUR_AD_UNIT_ID"</span>)
        adView.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>

        <span class="hljs-comment">// Banner 尺寸：iPhone 50pt / iPad 90pt</span>
        <span class="hljs-keyword">let</span> height: <span class="hljs-type">CGFloat</span> <span class="hljs-operator">=</span> <span class="hljs-type">UIDevice</span>.current.userInterfaceIdiom <span class="hljs-operator">==</span> .pad <span class="hljs-operator">?</span> <span class="hljs-number">90</span> : <span class="hljs-number">50</span>
        <span class="hljs-keyword">let</span> width: <span class="hljs-type">CGFloat</span> <span class="hljs-operator">=</span> <span class="hljs-type">UIScreen</span>.main.bounds.width

        adView.frame <span class="hljs-operator">=</span> <span class="hljs-type">CGRect</span>(
            x: <span class="hljs-number">0</span>,
            y: view.bounds.height <span class="hljs-operator">-</span> height <span class="hljs-operator">-</span> view.safeAreaInsets.bottom,
            width: width,
            height: height
        )
        adView.backgroundColor <span class="hljs-operator">=</span> .clear

        view.addSubview(adView)

        <span class="hljs-comment">// 加载广告（Banner 默认自动刷新）</span>
        adView.loadAd()
    }

    <span class="hljs-comment">// MARK: - MAAdViewAdDelegate</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Banner 加载成功, 来源: <span class="hljs-subst">\(ad.networkName)</span>"</span>)
        <span class="hljs-comment">// ad.networkName 会显示 "Google Bidding and Google AdMob" 或 "Meta Audience Network"</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didFailToLoadAd</span>(<span class="hljs-params">forAdUnitIdentifier</span> <span class="hljs-params">adUnitIdentifier</span>: <span class="hljs-type">String</span>, <span class="hljs-params">withError</span> <span class="hljs-params">error</span>: <span class="hljs-type">MAError</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ Banner 加载失败: <span class="hljs-subst">\(error.message)</span>"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didClick</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👆 Banner 点击"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didFail</span>(<span class="hljs-params">toDisplay</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>, <span class="hljs-params">withError</span> <span class="hljs-params">error</span>: <span class="hljs-type">MAError</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ Banner 展示失败"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExpand</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📐 Banner 展开"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didCollapse</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📐 Banner 折叠"</span>)
    }

    <span class="hljs-keyword">deinit</span> {
        adView.delegate <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
        adView.removeFromSuperview()
    }
}
</code></pre>
<h4 data-id="heading-23">3.5 Interstitial 插屏广告</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> AppLovinSDK

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MAXInterstitialViewController</span>: <span class="hljs-title class_">UIViewController</span>, <span class="hljs-title class_">MAAdDelegate</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interstitialAd: <span class="hljs-type">MAInterstitialAd</span>!
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> retryAttempt <span class="hljs-operator">=</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        createInterstitialAd()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">createInterstitialAd</span>() {
        interstitialAd <span class="hljs-operator">=</span> <span class="hljs-type">MAInterstitialAd</span>(adUnitIdentifier: <span class="hljs-string">"YOUR_AD_UNIT_ID"</span>)
        interstitialAd.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
        interstitialAd.load()
    }

    <span class="hljs-comment">/// 在合适时机展示</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">showInterstitialAd</span>() {
        <span class="hljs-keyword">if</span> interstitialAd.isReady {
            interstitialAd.show()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 插屏广告尚未就绪"</span>)
        }
    }

    <span class="hljs-comment">// MARK: - MAAdDelegate</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 插屏加载成功, 来源: <span class="hljs-subst">\(ad.networkName)</span>"</span>)
        retryAttempt <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didFailToLoadAd</span>(<span class="hljs-params">forAdUnitIdentifier</span> <span class="hljs-params">adUnitIdentifier</span>: <span class="hljs-type">String</span>, <span class="hljs-params">withError</span> <span class="hljs-params">error</span>: <span class="hljs-type">MAError</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 插屏加载失败: <span class="hljs-subst">\(error.message)</span>"</span>)

        <span class="hljs-comment">// ⭐ 指数退避重试（最大 64 秒）</span>
        retryAttempt <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">let</span> delaySec <span class="hljs-operator">=</span> pow(<span class="hljs-number">2.0</span>, <span class="hljs-built_in">min</span>(<span class="hljs-number">6.0</span>, <span class="hljs-type">Double</span>(retryAttempt)))
        <span class="hljs-type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="hljs-operator">+</span> delaySec) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.interstitialAd.load()
        }
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didDisplay</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📺 插屏已展示"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didHide</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 插屏已关闭"</span>)
        <span class="hljs-comment">// ⭐ 关闭后预加载下一个</span>
        interstitialAd.load()
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didClick</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👆 插屏被点击"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didFail</span>(<span class="hljs-params">toDisplay</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>, <span class="hljs-params">withError</span> <span class="hljs-params">error</span>: <span class="hljs-type">MAError</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 插屏展示失败"</span>)
        interstitialAd.load()
    }
}
</code></pre>
<h4 data-id="heading-24">3.6 Rewarded 激励视频广告</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> AppLovinSDK

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MAXRewardedViewController</span>: <span class="hljs-title class_">UIViewController</span>, <span class="hljs-title class_">MARewardedAdDelegate</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> rewardedAd: <span class="hljs-type">MARewardedAd</span>!
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> retryAttempt <span class="hljs-operator">=</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        createRewardedAd()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">createRewardedAd</span>() {
        rewardedAd <span class="hljs-operator">=</span> <span class="hljs-type">MARewardedAd</span>.shared(withAdUnitIdentifier: <span class="hljs-string">"YOUR_AD_UNIT_ID"</span>)
        rewardedAd.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
        rewardedAd.load()
    }

    <span class="hljs-comment">/// 用户主动触发观看</span>
    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">watchAdTapped</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UIButton</span>) {
        <span class="hljs-keyword">if</span> rewardedAd.isReady {
            rewardedAd.show()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 激励视频尚未就绪"</span>)
        }
    }

    <span class="hljs-comment">// MARK: - MAAdDelegate</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 激励视频加载成功, 来源: <span class="hljs-subst">\(ad.networkName)</span>"</span>)
        retryAttempt <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didFailToLoadAd</span>(<span class="hljs-params">forAdUnitIdentifier</span> <span class="hljs-params">adUnitIdentifier</span>: <span class="hljs-type">String</span>, <span class="hljs-params">withError</span> <span class="hljs-params">error</span>: <span class="hljs-type">MAError</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 激励视频加载失败: <span class="hljs-subst">\(error.message)</span>"</span>)

        retryAttempt <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">let</span> delaySec <span class="hljs-operator">=</span> pow(<span class="hljs-number">2.0</span>, <span class="hljs-built_in">min</span>(<span class="hljs-number">6.0</span>, <span class="hljs-type">Double</span>(retryAttempt)))
        <span class="hljs-type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="hljs-operator">+</span> delaySec) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.rewardedAd.load()
        }
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didDisplay</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📺 激励视频已展示"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didHide</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 激励视频已关闭"</span>)
        rewardedAd.load() <span class="hljs-comment">// ⭐ 预加载下一个</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didClick</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👆 激励视频被点击"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didFail</span>(<span class="hljs-params">toDisplay</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>, <span class="hljs-params">withError</span> <span class="hljs-params">error</span>: <span class="hljs-type">MAError</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 激励视频展示失败"</span>)
        rewardedAd.load()
    }

    <span class="hljs-comment">// MARK: - MARewardedAdDelegate</span>

    <span class="hljs-comment">/// ⭐ 用户观看完成，发放奖励</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didRewardUser</span>(<span class="hljs-params">for</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>, <span class="hljs-params">with</span> <span class="hljs-params">reward</span>: <span class="hljs-type">MAReward</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"🎉 用户获得奖励: <span class="hljs-subst">\(reward.amount)</span> <span class="hljs-subst">\(reward.label)</span>"</span>)
        grantReward(amount: reward.amount, currency: reward.label)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">grantReward</span>(<span class="hljs-params">amount</span>: <span class="hljs-type">Int</span>, <span class="hljs-params">currency</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-comment">// 发放奖励逻辑</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"发放 <span class="hljs-subst">\(amount)</span> <span class="hljs-subst">\(currency)</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-25">3.7 AppLovin MAX 后台配置</h4>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdash.applovin.com%2F" target="_blank" title="https://dash.applovin.com/" ref="nofollow noopener noreferrer">AppLovin Dashboard</a> 中完成以下配置：</p>
<h5 data-id="heading-26">添加 AdMob 和 Meta AN</h5>
<ol>
<li><strong>MAX → Manage → Ad Units</strong> → 创建 Ad Unit</li>
<li>选择格式（Banner / Interstitial / Rewarded）</li>
<li>在 <strong>Bidding</strong> 区域启用：
<ul>
<li><strong>Google Bidding and Google AdMob</strong> → 填入 AdMob 的 <strong>Ad Unit ID</strong></li>
<li><strong>Meta Audience Network</strong> → 填入 Meta 的 <strong>Placement ID</strong></li>
</ul>
</li>
<li>保存</li>
</ol>
<blockquote>
<p>两个网络都通过 <strong>实时竞价（Bidding）</strong> 参与，MAX 会自动选择出价最高的网络展示广告</p>
</blockquote>
<hr/>
<h3 data-id="heading-27">四、两种方案对比</h3>























































<table><thead><tr><th>特性</th><th>方案一：AdMob Mediation</th><th>方案二：AppLovin MAX</th></tr></thead><tbody><tr><td><strong>聚合主体</strong></td><td>Google AdMob</td><td>AppLovin MAX</td></tr><tr><td><strong>竞价公平性</strong></td><td>AdMob 自家广告可能有优势</td><td>更公平透明，所有网络平等竞争</td></tr><tr><td><strong>接入复杂度</strong></td><td>⭐ 简单（已用 AdMob 的项目）</td><td>⭐⭐ 中等（需额外注册 AppLovin）</td></tr><tr><td><strong>支持网络数量</strong></td><td>约 20+</td><td>约 25+</td></tr><tr><td><strong>收益报告</strong></td><td>AdMob 后台</td><td>AppLovin Dashboard（更详细）</td></tr><tr><td><strong>A/B 测试</strong></td><td>有限</td><td>内置强大 A/B 测试</td></tr><tr><td><strong>广告质量审核</strong></td><td>Google Ad Review</td><td>MAX Ad Review</td></tr><tr><td><strong>费用</strong></td><td>免费</td><td>免费</td></tr><tr><td><strong>推荐场景</strong></td><td>已深度使用 AdMob</td><td>新项目或追求最高收益</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-28">五、方案三：手动管理（不推荐但可行）</h3>
<p>如果你有特殊原因<strong>不想使用聚合平台</strong>，可以手动管理两个 SDK 的降级逻辑：</p>
<h4 data-id="heading-29">5.1 安装两个 SDK</h4>
<pre><code class="hljs language-ruby" lang="ruby">platform <span class="hljs-symbol">:ios</span>, <span class="hljs-string">'13.0'</span>

target <span class="hljs-string">'YourApp'</span> <span class="hljs-keyword">do</span>
  use_frameworks!

  pod <span class="hljs-string">'Google-Mobile-Ads-SDK'</span>   <span class="hljs-comment"># AdMob</span>
  pod <span class="hljs-string">'FBAudienceNetwork'</span>        <span class="hljs-comment"># Meta AN</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4 data-id="heading-30">5.2 手动广告管理器</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation
<span class="hljs-keyword">import</span> GoogleMobileAds
<span class="hljs-keyword">import</span> FBAudienceNetwork

<span class="hljs-comment">/// 广告管理器 - 手动聚合（降级逻辑）</span>
<span class="hljs-comment">/// ⚠️ 不推荐：仅作学习参考，生产环境请用聚合平台</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ManualAdManager</span>: <span class="hljs-title class_">NSObject</span> {

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">ManualAdManager</span>()

    <span class="hljs-comment">// MARK: - 配置</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> admobInterstitialUnitID <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-xxxxx/yyyyy"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> metaInterstitialPlacementID <span class="hljs-operator">=</span> <span class="hljs-string">"123456789_987654321"</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> admobRewardedUnitID <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-xxxxx/zzzzz"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> metaRewardedPlacementID <span class="hljs-operator">=</span> <span class="hljs-string">"123456789_111111111"</span>

    <span class="hljs-comment">// MARK: - 广告实例</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> admobInterstitial: <span class="hljs-type">GADInterstitialAd</span>?
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> metaInterstitial: <span class="hljs-type">FBInterstitialAd</span>?

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> admobRewarded: <span class="hljs-type">GADRewardedAd</span>?
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> metaRewarded: <span class="hljs-type">FBRewardedVideoAd</span>?

    <span class="hljs-comment">// MARK: - 状态追踪</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isAdMobInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isMetaInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isAdMobRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isMetaRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>

    <span class="hljs-comment">// MARK: - 回调</span>

    <span class="hljs-keyword">var</span> onRewardEarned: ((<span class="hljs-keyword">_</span> amount: <span class="hljs-type">Int</span>, <span class="hljs-keyword">_</span> type: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Void</span>)<span class="hljs-operator">?</span>
    <span class="hljs-keyword">var</span> onInterstitialDismissed: (() -&gt; <span class="hljs-type">Void</span>)<span class="hljs-operator">?</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
    }

    <span class="hljs-comment">// MARK: - ==================== 插屏广告 ====================</span>

    <span class="hljs-comment">/// 同时请求两个网络，谁先 ready 谁展示</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadInterstitial</span>() {
        isAdMobInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        isMetaInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>

        loadAdMobInterstitial()
        loadMetaInterstitial()
    }

    <span class="hljs-comment">// —— AdMob 插屏 ——</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadAdMobInterstitial</span>() {
        <span class="hljs-type">GADInterstitialAd</span>.load(
            withAdUnitID: admobInterstitialUnitID,
            request: <span class="hljs-type">GADRequest</span>()
        ) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] ad, error <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ AdMob 插屏加载失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
                <span class="hljs-keyword">return</span>
            }
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ AdMob 插屏加载成功"</span>)
            <span class="hljs-keyword">self</span>.admobInterstitial <span class="hljs-operator">=</span> ad
            <span class="hljs-keyword">self</span>.admobInterstitial<span class="hljs-operator">?</span>.fullScreenContentDelegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
            <span class="hljs-keyword">self</span>.isAdMobInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-comment">// —— Meta 插屏 ——</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadMetaInterstitial</span>() {
        metaInterstitial <span class="hljs-operator">=</span> <span class="hljs-type">FBInterstitialAd</span>(placementID: metaInterstitialPlacementID)
        metaInterstitial<span class="hljs-operator">?</span>.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
        metaInterstitial<span class="hljs-operator">?</span>.load()
    }

    <span class="hljs-comment">/// 展示插屏：优先 AdMob → 降级 Meta → 两者都无则放弃</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">showInterstitial</span>(<span class="hljs-params">from</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>) -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-keyword">if</span> isAdMobInterstitialReady, <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> admobInterstitial {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"📺 展示 AdMob 插屏"</span>)
            ad.present(fromRootViewController: viewController)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> isMetaInterstitialReady, <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> metaInterstitial, ad.isAdValid {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"📺 展示 Meta 插屏"</span>)
            ad.show(fromRootViewController: viewController)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 无可用插屏广告"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
    }

    <span class="hljs-comment">// MARK: - ==================== 激励视频 ====================</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadRewarded</span>() {
        isAdMobRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        isMetaRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>

        loadAdMobRewarded()
        loadMetaRewarded()
    }

    <span class="hljs-comment">// —— AdMob 激励 ——</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadAdMobRewarded</span>() {
        <span class="hljs-type">GADRewardedAd</span>.load(
            withAdUnitID: admobRewardedUnitID,
            request: <span class="hljs-type">GADRequest</span>()
        ) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] ad, error <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ AdMob 激励加载失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
                <span class="hljs-keyword">return</span>
            }
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ AdMob 激励加载成功"</span>)
            <span class="hljs-keyword">self</span>.admobRewarded <span class="hljs-operator">=</span> ad
            <span class="hljs-keyword">self</span>.admobRewarded<span class="hljs-operator">?</span>.fullScreenContentDelegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
            <span class="hljs-keyword">self</span>.isAdMobRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-comment">// —— Meta 激励 ——</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadMetaRewarded</span>() {
        metaRewarded <span class="hljs-operator">=</span> <span class="hljs-type">FBRewardedVideoAd</span>(placementID: metaRewardedPlacementID)
        metaRewarded<span class="hljs-operator">?</span>.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
        metaRewarded<span class="hljs-operator">?</span>.load()
    }

    <span class="hljs-comment">/// 展示激励视频：优先 AdMob → 降级 Meta</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">showRewarded</span>(<span class="hljs-params">from</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>) -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-keyword">if</span> isAdMobRewardedReady, <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> admobRewarded {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"📺 展示 AdMob 激励视频"</span>)
            ad.present(fromRootViewController: viewController) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">let</span> reward <span class="hljs-operator">=</span> ad.adReward
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"🎉 AdMob 奖励: <span class="hljs-subst">\(reward.amount)</span> <span class="hljs-subst">\(reward.type)</span>"</span>)
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.onRewardEarned<span class="hljs-operator">?</span>(reward.amount.intValue, reward.type)
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> isMetaRewardedReady, <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> metaRewarded, ad.isAdValid {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"📺 展示 Meta 激励视频"</span>)
            ad.show(fromRootViewController: viewController)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 无可用激励视频"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
    }

    <span class="hljs-comment">/// 检查是否有广告就绪</span>
    <span class="hljs-keyword">var</span> isInterstitialReady: <span class="hljs-type">Bool</span> {
        <span class="hljs-keyword">return</span> isAdMobInterstitialReady <span class="hljs-operator">||</span> isMetaInterstitialReady
    }

    <span class="hljs-keyword">var</span> isRewardedReady: <span class="hljs-type">Bool</span> {
        <span class="hljs-keyword">return</span> isAdMobRewardedReady <span class="hljs-operator">||</span> isMetaRewardedReady
    }
}

<span class="hljs-comment">// MARK: - ==================== AdMob Delegate ====================</span>

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">ManualAdManager</span>: <span class="hljs-title class_">GADFullScreenContentDelegate</span> {

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">adDidDismissFullScreenContent</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">GADFullScreenPresentingAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ AdMob 全屏广告已关闭"</span>)
        isAdMobInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        isAdMobRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        onInterstitialDismissed<span class="hljs-operator">?</span>()
        <span class="hljs-comment">// 预加载下一个</span>
        loadInterstitial()
        loadRewarded()
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">ad</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">GADFullScreenPresentingAd</span>, <span class="hljs-params">didFailToPresentFullScreenContentWithError</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ AdMob 展示失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
    }
}

<span class="hljs-comment">// MARK: - ==================== Meta Interstitial Delegate ====================</span>

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">ManualAdManager</span>: <span class="hljs-title class_">FBInterstitialAdDelegate</span> {

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">interstitialAdDidLoad</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">interstitialAd</span>: <span class="hljs-type">FBInterstitialAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Meta 插屏加载成功"</span>)
        isMetaInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">interstitialAd</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">interstitialAd</span>: <span class="hljs-type">FBInterstitialAd</span>, <span class="hljs-params">didFailWithError</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ Meta 插屏加载失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
        isMetaInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">interstitialAdDidClose</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">interstitialAd</span>: <span class="hljs-type">FBInterstitialAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Meta 插屏已关闭"</span>)
        isMetaInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        onInterstitialDismissed<span class="hljs-operator">?</span>()
        loadInterstitial()
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">interstitialAdDidClick</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">interstitialAd</span>: <span class="hljs-type">FBInterstitialAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👆 Meta 插屏被点击"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">interstitialAdWillLogImpression</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">interstitialAd</span>: <span class="hljs-type">FBInterstitialAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👁️ Meta 插屏曝光"</span>)
    }
}

<span class="hljs-comment">// MARK: - ==================== Meta Rewarded Delegate ====================</span>

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">ManualAdManager</span>: <span class="hljs-title class_">FBRewardedVideoAdDelegate</span> {

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">rewardedVideoAdDidLoad</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">rewardedVideoAd</span>: <span class="hljs-type">FBRewardedVideoAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Meta 激励加载成功"</span>)
        isMetaRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">rewardedVideoAd</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">rewardedVideoAd</span>: <span class="hljs-type">FBRewardedVideoAd</span>, <span class="hljs-params">didFailWithError</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ Meta 激励加载失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
        isMetaRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">rewardedVideoAdDidClose</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">rewardedVideoAd</span>: <span class="hljs-type">FBRewardedVideoAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Meta 激励视频已关闭"</span>)
        isMetaRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        loadRewarded()
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">rewardedVideoAdVideoComplete</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">rewardedVideoAd</span>: <span class="hljs-type">FBRewardedVideoAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"🎉 Meta 激励视频观看完成"</span>)
        <span class="hljs-comment">// Meta 不像 AdMob 那样返回具体奖励信息，需要自行定义</span>
        onRewardEarned<span class="hljs-operator">?</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"coin"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">rewardedVideoAdDidClick</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">rewardedVideoAd</span>: <span class="hljs-type">FBRewardedVideoAd</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"👆 Meta 激励视频被点击"</span>)
    }
}
</code></pre>
<h4 data-id="heading-31">5.3 手动方案的使用方式</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GameViewController</span>: <span class="hljs-title class_">UIViewController</span> {

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()

        <span class="hljs-comment">// 预加载广告</span>
        <span class="hljs-type">ManualAdManager</span>.shared.loadInterstitial()
        <span class="hljs-type">ManualAdManager</span>.shared.loadRewarded()

        <span class="hljs-comment">// 设置奖励回调</span>
        <span class="hljs-type">ManualAdManager</span>.shared.onRewardEarned <span class="hljs-operator">=</span> { amount, type <span class="hljs-keyword">in</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"🎉 发放奖励: <span class="hljs-subst">\(amount)</span> <span class="hljs-subst">\(type)</span>"</span>)
            <span class="hljs-comment">// 更新用户余额等</span>
        }
    }

    <span class="hljs-comment">/// 关卡结束后展示插屏</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">onLevelComplete</span>() {
        <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-type">ManualAdManager</span>.shared.showInterstitial(from: <span class="hljs-keyword">self</span>)
    }

    <span class="hljs-comment">/// 用户主动观看激励视频</span>
    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">watchAdForReward</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UIButton</span>) {
        <span class="hljs-keyword">let</span> shown <span class="hljs-operator">=</span> <span class="hljs-type">ManualAdManager</span>.shared.showRewarded(from: <span class="hljs-keyword">self</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span>shown {
            <span class="hljs-comment">// 提示用户稍后再试</span>
            showAlert(message: <span class="hljs-string">"广告暂不可用，请稍后再试"</span>)
        }
    }
}
</code></pre>
<blockquote>
<p>⚠️ <strong>手动方案的缺点：</strong></p>
<ul>
<li>无法实现真正的实时竞价（Bidding），只是简单的优先级降级</li>
<li>需要自己维护两套 Delegate</li>
<li>无法动态调整优先级和 eCPM 排序</li>
<li>合规（GDPR/CCPA）需要分别处理</li>
<li>新增广告网络时需要大量改代码</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-32">六、隐私合规处理（三种方案通用）</h3>
<h4 data-id="heading-33">6.1 Google UMP（User Messaging Platform）- GDPR 合规</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> UserMessagingPlatform

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsentManager</span> {

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">ConsentManager</span>()

    <span class="hljs-comment">/// 在 SDK 初始化之前调用</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">requestConsentIfNeeded</span>(<span class="hljs-params">from</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> () -&gt; <span class="hljs-type">Void</span>) {

        <span class="hljs-comment">// ① 创建请求参数</span>
        <span class="hljs-keyword">let</span> parameters <span class="hljs-operator">=</span> <span class="hljs-type">UMPRequestParameters</span>()

        <span class="hljs-comment">// 调试时使用（正式发布移除）</span>
        <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
        <span class="hljs-keyword">let</span> debugSettings <span class="hljs-operator">=</span> <span class="hljs-type">UMPDebugSettings</span>()
        debugSettings.testDeviceIdentifiers <span class="hljs-operator">=</span> [<span class="hljs-string">"YOUR_TEST_DEVICE_HASHED_ID"</span>]
        debugSettings.geography <span class="hljs-operator">=</span> .<span class="hljs-type">EEA</span> <span class="hljs-comment">// 模拟欧洲用户</span>
        parameters.debugSettings <span class="hljs-operator">=</span> debugSettings
        <span class="hljs-keyword">#endif</span>

        <span class="hljs-comment">// ② 请求更新同意信息</span>
        <span class="hljs-type">UMPConsentInformation</span>.sharedInstance.requestConsentInfoUpdate(with: parameters) { error <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 同意信息更新失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
                completion()
                <span class="hljs-keyword">return</span>
            }

            <span class="hljs-comment">// ③ 如果需要，展示同意表单</span>
            <span class="hljs-type">UMPConsentForm</span>.loadAndPresentIfRequired(from: viewController) { formError <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> formError <span class="hljs-operator">=</span> formError {
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 同意表单展示失败: <span class="hljs-subst">\(formError.localizedDescription)</span>"</span>)
                }

                <span class="hljs-comment">// ④ 检查是否可以请求广告</span>
                <span class="hljs-keyword">if</span> <span class="hljs-type">UMPConsentInformation</span>.sharedInstance.canRequestAds {
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 用户已授权，可以请求广告"</span>)
                }

                completion()
            }
        }
    }

    <span class="hljs-comment">/// 检查是否可以请求个性化广告</span>
    <span class="hljs-keyword">var</span> canRequestAds: <span class="hljs-type">Bool</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-type">UMPConsentInformation</span>.sharedInstance.canRequestAds
    }
}
</code></pre>
<h4 data-id="heading-34">6.2 Meta 隐私合规设置</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> FBAudienceNetwork

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MetaPrivacyHelper</span> {

    <span class="hljs-comment">/// 设置 GDPR 数据处理选项（欧洲用户）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setGDPRConsent</span>(<span class="hljs-params">granted</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-comment">// Meta 不在 IAB GVL 中，需要使用 Additional Consent</span>
        <span class="hljs-comment">// 如果用户未同意，应当限制数据使用</span>
        <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span>granted {
            <span class="hljs-comment">// 限制数据处理</span>
            <span class="hljs-type">FBAdSettings</span>.setDataProcessingOptions([<span class="hljs-string">"LDU"</span>], country: <span class="hljs-number">0</span>, state: <span class="hljs-number">0</span>)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 不限制</span>
            <span class="hljs-type">FBAdSettings</span>.setDataProcessingOptions([])
        }
    }

    <span class="hljs-comment">/// 设置 CCPA 数据处理选项（加州用户）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setCCPAOptOut</span>(<span class="hljs-params">optedOut</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">if</span> optedOut {
            <span class="hljs-comment">// 用户选择退出数据售卖</span>
            <span class="hljs-type">FBAdSettings</span>.setDataProcessingOptions([<span class="hljs-string">"LDU"</span>], country: <span class="hljs-number">1</span>, state: <span class="hljs-number">1000</span>)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">FBAdSettings</span>.setDataProcessingOptions([])
        }
    }

    <span class="hljs-comment">/// 设置 iOS 14+ 广告追踪状态</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setAdvertiserTracking</span>(<span class="hljs-params">enabled</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-type">FBAdSettings</span>.setAdvertiserTrackingEnabled(enabled)
    }
}
</code></pre>
<h4 data-id="heading-35">6.3 完整的初始化流程（合规 → ATT → 广告 SDK）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> GoogleMobileAds
<span class="hljs-keyword">import</span> FBAudienceNetwork
<span class="hljs-keyword">import</span> AppTrackingTransparency
<span class="hljs-keyword">import</span> UserMessagingPlatform

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppStartupManager</span> {

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">AppStartupManager</span>()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isAdsInitialized <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>

    <span class="hljs-comment">/// 完整的广告初始化流程：GDPR → ATT → Meta ATE → SDK 初始化</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">startAdInitialization</span>(<span class="hljs-params">from</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>) {
        
        <span class="hljs-comment">// ==================== 第 1 步：GDPR 同意 ====================</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📋 Step 1: 请求 GDPR 同意..."</span>)
        
        <span class="hljs-type">ConsentManager</span>.shared.requestConsentIfNeeded(from: viewController) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            
            <span class="hljs-comment">// ==================== 第 2 步：ATT 权限 ====================</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"📋 Step 2: 请求 ATT 权限..."</span>)
            
            <span class="hljs-keyword">self</span>.requestATTPermission { trackingAuthorized <span class="hljs-keyword">in</span>
                
                <span class="hljs-comment">// ==================== 第 3 步：配置 Meta 隐私 ====================</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"📋 Step 3: 配置 Meta 隐私设置..."</span>)
                
                <span class="hljs-type">FBAdSettings</span>.setAdvertiserTrackingEnabled(trackingAuthorized)
                
                <span class="hljs-comment">// 如果 GDPR 同意信息可用，配置 Meta 数据处理选项</span>
                <span class="hljs-keyword">if</span> <span class="hljs-type">ConsentManager</span>.shared.canRequestAds {
                    <span class="hljs-type">FBAdSettings</span>.setDataProcessingOptions([])
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-type">FBAdSettings</span>.setDataProcessingOptions([<span class="hljs-string">"LDU"</span>], country: <span class="hljs-number">0</span>, state: <span class="hljs-number">0</span>)
                }
                
                <span class="hljs-comment">// ==================== 第 4 步：初始化广告 SDK ====================</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"📋 Step 4: 初始化广告 SDK..."</span>)
                
                <span class="hljs-keyword">self</span>.initializeAdSDK()
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">requestATTPermission</span>(<span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Bool</span>) -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">14.5</span>, <span class="hljs-operator">*</span>) {
            <span class="hljs-type">ATTrackingManager</span>.requestTrackingAuthorization { status <span class="hljs-keyword">in</span>
                <span class="hljs-type">DispatchQueue</span>.main.async {
                    <span class="hljs-keyword">let</span> authorized <span class="hljs-operator">=</span> (status <span class="hljs-operator">==</span> .authorized)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  ATT 状态: <span class="hljs-subst">\(status.rawValue)</span>, 已授权: <span class="hljs-subst">\(authorized)</span>"</span>)
                    completion(authorized)
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// iOS 14.5 以下默认可追踪</span>
            completion(<span class="hljs-literal">true</span>)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">initializeAdSDK</span>() {
        <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>isAdsInitialized <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
        isAdsInitialized <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        
        <span class="hljs-comment">// ====== 方案一：使用 AdMob Mediation ======</span>
        <span class="hljs-type">GADMobileAds</span>.sharedInstance().start { status <span class="hljs-keyword">in</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ AdMob SDK 初始化完成"</span>)
            
            <span class="hljs-keyword">for</span> (adapter, adapterStatus) <span class="hljs-keyword">in</span> status.adapterStatusesByClassName {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"  [<span class="hljs-subst">\(adapter)</span>] state=<span class="hljs-subst">\(adapterStatus.state.rawValue)</span>, <span class="hljs-subst">\(adapterStatus.description)</span>"</span>)
            }
            
            <span class="hljs-comment">// 初始化完成，发送通知让各页面开始加载广告</span>
            <span class="hljs-type">NotificationCenter</span>.default.post(name: .adsSDKInitialized, object: <span class="hljs-literal">nil</span>)
        }
        
        <span class="hljs-comment">// ====== 方案二（替代）：使用 AppLovin MAX ======</span>
        <span class="hljs-comment">/*
        let initConfig = ALSdkInitializationConfiguration(sdkKey: "YOUR_SDK_KEY") { builder in
            builder.mediationProvider = ALMediationProviderMAX
        }
        ALSdk.shared().initialize(with: initConfig) { sdkConfig in
            print("✅ AppLovin MAX SDK 初始化完成")
            NotificationCenter.default.post(name: .adsSDKInitialized, object: nil)
        }
        */</span>
    }
}

<span class="hljs-comment">// MARK: - 自定义通知名</span>

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">Notification</span>.<span class="hljs-title class_">Name</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> adsSDKInitialized <span class="hljs-operator">=</span> <span class="hljs-type">Notification</span>.<span class="hljs-type">Name</span>(<span class="hljs-string">"adsSDKInitialized"</span>)
}
</code></pre>
<h4 data-id="heading-36">6.4 在 AppDelegate / SceneDelegate 中调用</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// SceneDelegate.swift</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SceneDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIWindowSceneDelegate</span> {
    
    <span class="hljs-keyword">var</span> window: <span class="hljs-type">UIWindow</span>?
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">scene</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">scene</span>: <span class="hljs-type">UIScene</span>, <span class="hljs-params">willConnectTo</span> <span class="hljs-params">session</span>: <span class="hljs-type">UISceneSession</span>, <span class="hljs-params">options</span> <span class="hljs-params">connectionOptions</span>: <span class="hljs-type">UIScene</span>.<span class="hljs-type">ConnectionOptions</span>) {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> windowScene <span class="hljs-operator">=</span> scene <span class="hljs-keyword">as?</span> <span class="hljs-type">UIWindowScene</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
        
        <span class="hljs-keyword">let</span> window <span class="hljs-operator">=</span> <span class="hljs-type">UIWindow</span>(windowScene: windowScene)
        <span class="hljs-keyword">let</span> rootVC <span class="hljs-operator">=</span> <span class="hljs-type">MainViewController</span>()
        window.rootViewController <span class="hljs-operator">=</span> <span class="hljs-type">UINavigationController</span>(rootViewController: rootVC)
        window.makeKeyAndVisible()
        <span class="hljs-keyword">self</span>.window <span class="hljs-operator">=</span> window
    }
}

<span class="hljs-comment">// MainViewController.swift</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewDidAppear(animated)
        
        <span class="hljs-comment">// ⭐ 在主页面显示后启动广告初始化流程</span>
        <span class="hljs-comment">// 这样 GDPR 弹窗和 ATT 弹窗能正常展示</span>
        <span class="hljs-type">AppStartupManager</span>.shared.startAdInitialization(from: <span class="hljs-keyword">self</span>)
        
        <span class="hljs-comment">// 监听 SDK 初始化完成</span>
        <span class="hljs-type">NotificationCenter</span>.default.addObserver(
            <span class="hljs-keyword">self</span>,
            selector: <span class="hljs-keyword">#selector</span>(onAdsReady),
            name: .adsSDKInitialized,
            object: <span class="hljs-literal">nil</span>
        )
    }
    
    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">onAdsReady</span>() {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 广告 SDK 已就绪，开始加载广告"</span>)
        <span class="hljs-comment">// 在这里加载各种广告</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-37">七、测试和调试</h3>
<h4 data-id="heading-38">7.1 AdMob 测试广告 ID</h4>
<p>在开发阶段，使用 Google 提供的官方测试 ID，<strong>不要使用真实广告 ID 测试</strong>（会被封号）：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">TestAdUnitIDs</span> {
    <span class="hljs-comment">// Google 官方测试 ID（安全使用，不会触发违规）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> admobBanner           <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-3940256099942544/2934735716"</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> admobInterstitial     <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-3940256099942544/4411468910"</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> admobRewarded         <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-3940256099942544/1712485313"</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> admobRewardedInterstitial <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-3940256099942544/6978759866"</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> admobNative           <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-3940256099942544/3986624511"</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> admobAppOpen          <span class="hljs-operator">=</span> <span class="hljs-string">"ca-app-pub-3940256099942544/5575463023"</span>
}
</code></pre>
<h4 data-id="heading-39">7.2 Meta AN 测试模式</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
<span class="hljs-comment">// 添加测试设备（设备 IDFA 的哈希值，在控制台日志中查找）</span>
<span class="hljs-type">FBAdSettings</span>.addTestDevice(<span class="hljs-string">"YOUR_DEVICE_HASH"</span>)

<span class="hljs-comment">// 或者启用模拟器测试模式</span>
<span class="hljs-type">FBAdSettings</span>.addTestDevice(<span class="hljs-type">FBAdSettings</span>.testDeviceHash())

<span class="hljs-comment">// 设置测试广告类型（可选）</span>
<span class="hljs-comment">// FBAdSettings.setLogLevel(.log)</span>
<span class="hljs-keyword">#endif</span>
</code></pre>
<h4 data-id="heading-40">7.3 AppLovin MAX 调试工具</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
<span class="hljs-comment">// 显示 MAX Mediation Debugger（可视化调试面板）</span>
<span class="hljs-comment">// 显示所有适配器状态、广告加载记录等</span>
<span class="hljs-type">ALSdk</span>.shared().showMediationDebugger()
<span class="hljs-keyword">#endif</span>
</code></pre>
<blockquote>
<p>💡 <strong>MAX Mediation Debugger 非常强大</strong>，可以一目了然看到：</p>
<ul>
<li>各适配器是否正确初始化</li>
<li>各网络的竞价情况</li>
<li>广告加载成功/失败详情</li>
</ul>
</blockquote>
<h4 data-id="heading-41">7.4 广告来源追踪（通用）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">/// 统一的广告事件追踪器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdEventTracker</span> {
    
    <span class="hljs-comment">/// 记录广告展示来源</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">trackImpression</span>(
        <span class="hljs-params">adFormat</span>: <span class="hljs-type">String</span>,       <span class="hljs-comment">// "banner" / "interstitial" / "rewarded"</span>
        <span class="hljs-params">networkName</span>: <span class="hljs-type">String</span>,    <span class="hljs-comment">// "AdMob" / "Meta" / "Google Bidding"</span>
        <span class="hljs-params">revenue</span>: <span class="hljs-type">Double</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>, <span class="hljs-comment">// 收益（如可用）</span>
        <span class="hljs-params">adUnitID</span>: <span class="hljs-type">String</span>
    ) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"""
        📊 广告曝光
          格式: <span class="hljs-subst">\(adFormat)</span>
          来源: <span class="hljs-subst">\(networkName)</span>
          收益: <span class="hljs-subst">\(revenue.map { String(format: <span class="hljs-string">"%.6f"</span>, <span class="hljs-variable">$0</span>) } <span class="hljs-operator">??</span> <span class="hljs-string">"N/A"</span>)</span>
          广告单元: <span class="hljs-subst">\(adUnitID)</span>
        """</span>)
        
        <span class="hljs-comment">// 发送到你的分析平台（Firebase / Amplitude / 自建等）</span>
        <span class="hljs-comment">// Analytics.logEvent("ad_impression", parameters: [...])</span>
    }
    
    <span class="hljs-comment">// —— AdMob 获取收益信息 ——</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">trackAdMobRevenue</span>(<span class="hljs-params">ad</span>: <span class="hljs-type">GADFullScreenPresentingAd</span>, <span class="hljs-params">adFormat</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-comment">// AdMob 收益追踪需要通过 paidEventHandler</span>
        <span class="hljs-comment">// 在加载成功后设置：</span>
        <span class="hljs-comment">// ad.paidEventHandler = { value in</span>
        <span class="hljs-comment">//     let revenue = value.value.doubleValue / 1_000_000 // 微单位转换</span>
        <span class="hljs-comment">//     trackImpression(adFormat: adFormat, networkName: "AdMob", revenue: revenue, adUnitID: "xxx")</span>
        <span class="hljs-comment">// }</span>
    }
    
    <span class="hljs-comment">// —— MAX 获取收益信息 ——</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">trackMAXRevenue</span>(<span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>, <span class="hljs-params">adFormat</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-keyword">let</span> revenue <span class="hljs-operator">=</span> ad.revenue <span class="hljs-comment">// MAX 直接提供收益值</span>
        <span class="hljs-keyword">let</span> networkName <span class="hljs-operator">=</span> ad.networkName
        trackImpression(
            adFormat: adFormat,
            networkName: networkName,
            revenue: revenue,
            adUnitID: ad.adUnitIdentifier
        )
    }
}
</code></pre>
<h4 data-id="heading-42">7.5 常见问题排查清单</h4>


















































<table><thead><tr><th>问题</th><th>可能原因</th><th>解决方案</th></tr></thead><tbody><tr><td>Meta AN 始终 No Fill</td><td>未通过 Meta 审核 / Placement ID 错误</td><td>确认 App 已在 Meta Business 审核通过</td></tr><tr><td>AdMob Adapter 未初始化</td><td><code>GADApplicationIdentifier</code> 未配置</td><td>检查 Info.plist</td></tr><tr><td>ATT 弹窗不出现</td><td>在 <code>viewDidLoad</code> 中调用太早</td><td>改到 <code>viewDidAppear</code> 中调用</td></tr><tr><td>收益极低</td><td>仅一个网络参与竞争</td><td>接入更多网络（Bidding 竞争越多收益越高）</td></tr><tr><td>测试时展示真实广告</td><td>未添加测试设备</td><td>使用测试 ID 或添加测试设备</td></tr><tr><td>崩溃：<code>GADApplicationIdentifier</code></td><td>AdMob App ID 格式错误</td><td>格式应为 <code>ca-app-pub-xxxx~yyyy</code></td></tr><tr><td>Meta SDK 初始化失败</td><td>iOS Deployment Target &lt; 13.0</td><td>升级最低版本到 13.0</td></tr><tr><td>MAX Debugger 显示红色</td><td>适配器版本不兼容</td><td>更新所有 Pod 到最新版本</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-43">八、收益优化最佳实践</h3>
<h4 data-id="heading-44">8.1 广告展示策略</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">/// 广告频次控制器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdFrequencyManager</span> {
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">AdFrequencyManager</span>()
    
    <span class="hljs-comment">// 配置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> interstitialMinInterval: <span class="hljs-type">TimeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>      <span class="hljs-comment">// 插屏最少间隔 60 秒</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> maxInterstitialsPerSession <span class="hljs-operator">=</span> <span class="hljs-number">10</span>                  <span class="hljs-comment">// 每次会话最多 10 个插屏</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> rewardedCooldown: <span class="hljs-type">TimeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>              <span class="hljs-comment">// 激励视频冷却 30 秒</span>
    
    <span class="hljs-comment">// 状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastInterstitialTime: <span class="hljs-type">Date</span>?
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> sessionInterstitialCount <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastRewardedTime: <span class="hljs-type">Date</span>?
    
    <span class="hljs-comment">/// 检查是否可以展示插屏</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">canShowInterstitial</span>() -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-comment">// 检查频率限制</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> lastTime <span class="hljs-operator">=</span> lastInterstitialTime {
            <span class="hljs-keyword">let</span> elapsed <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().timeIntervalSince(lastTime)
            <span class="hljs-keyword">if</span> elapsed <span class="hljs-operator">&lt;</span> interstitialMinInterval {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"⏳ 插屏冷却中，还需 <span class="hljs-subst">\(Int(interstitialMinInterval <span class="hljs-operator">-</span> elapsed))</span> 秒"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            }
        }
        
        <span class="hljs-comment">// 检查会话上限</span>
        <span class="hljs-keyword">if</span> sessionInterstitialCount <span class="hljs-operator">&gt;=</span> maxInterstitialsPerSession {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚫 已达到本次会话插屏上限"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
    
    <span class="hljs-comment">/// 记录插屏已展示</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">recordInterstitialShown</span>() {
        lastInterstitialTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()
        sessionInterstitialCount <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
    }
    
    <span class="hljs-comment">/// 检查是否可以展示激励视频</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">canShowRewarded</span>() -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> lastTime <span class="hljs-operator">=</span> lastRewardedTime {
            <span class="hljs-keyword">let</span> elapsed <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().timeIntervalSince(lastTime)
            <span class="hljs-keyword">if</span> elapsed <span class="hljs-operator">&lt;</span> rewardedCooldown {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
    
    <span class="hljs-comment">/// 记录激励视频已展示</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">recordRewardedShown</span>() {
        lastRewardedTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()
    }
    
    <span class="hljs-comment">/// 重置会话计数（App 启动或从后台恢复时调用）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">resetSession</span>() {
        sessionInterstitialCount <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    }
}
</code></pre>
<h4 data-id="heading-45">8.2 收益优化清单</h4>













































<table><thead><tr><th>优化项</th><th>说明</th><th>预期效果</th></tr></thead><tbody><tr><td><strong>接入 3+ 个 Bidding 网络</strong></td><td>竞争越多出价越高</td><td>eCPM 提升 20~50%</td></tr><tr><td><strong>使用实时竞价</strong></td><td>优于传统 Waterfall</td><td>eCPM 提升 10~30%</td></tr><tr><td><strong>合理控制频次</strong></td><td>避免用户疲劳和政策违规</td><td>长期收益稳定</td></tr><tr><td><strong>预加载广告</strong></td><td>关闭后立即预加载下一个</td><td>填充率接近 100%</td></tr><tr><td><strong>ATT 优化弹窗文案</strong></td><td>提高授权率 → 个性化广告收益更高</td><td>eCPM 提升 15~30%</td></tr><tr><td><strong>Banner 自适应尺寸</strong></td><td>使用 Adaptive Banner 替代固定尺寸</td><td>eCPM 提升 10~20%</td></tr><tr><td><strong>定期更新 SDK</strong></td><td>各网络持续优化竞价算法</td><td>持续收益改善</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-46">九、项目文件结构建议</h3>
<pre><code class="hljs language-arduino" lang="arduino">YourApp/
├── Podfile
├── Info.plist
├── AppDelegate.swift
├── SceneDelegate.swift
│
├── Ads/
│   ├── Core/
│   │   ├── AppStartupManager.swift          <span class="hljs-comment">// 完整初始化流程（GDPR→ATT→SDK）</span>
│   │   ├── ConsentManager.swift             <span class="hljs-comment">// GDPR / UMP 同意管理</span>
│   │   ├── MetaPrivacyHelper.swift          <span class="hljs-comment">// Meta 隐私合规</span>
│   │   ├── AdFrequencyManager.swift         <span class="hljs-comment">// 广告频次控制</span>
│   │   └── AdEventTracker.swift             <span class="hljs-comment">// 收益/事件追踪</span>
│   │
│   ├── AdMobMediation/                      <span class="hljs-comment">// 方案一：AdMob Mediation</span>
│   │   ├── AdMobBannerManager.swift
│   │   ├── AdMobInterstitialManager.swift
│   │   └── AdMobRewardedManager.swift
│   │
│   ├── MAXMediation/                        <span class="hljs-comment">// 方案二：AppLovin MAX</span>
│   │   ├── MAXBannerManager.swift
│   │   ├── MAXInterstitialManager.swift
│   │   └── MAXRewardedManager.swift
│   │
│   └── Manual/                              <span class="hljs-comment">// 方案三（不推荐）</span>
│       └── ManualAdManager.swift
│
├── Config/
│   ├── AdConfig.swift                       <span class="hljs-comment">// 广告 ID 配置（开发/生产）</span>
│   └── TestAdUnitIDs.swift                  <span class="hljs-comment">// 测试广告 ID</span>
│
├── Views/
│   └── ...
└── ViewControllers/
    └── ...
</code></pre>
<h4 data-id="heading-47">9.1 广告配置文件（开发/生产切换）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// AdConfig.swift</span>
<span class="hljs-keyword">import</span> Foundation

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AdConfig</span> {
    
    <span class="hljs-comment">// MARK: - 环境切换</span>
    
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> isTestMode <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">#else</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> isTestMode <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">#endif</span>
    
    <span class="hljs-comment">// MARK: - AdMob 配置</span>
    
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AdMob</span> {
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> bannerID: <span class="hljs-type">String</span> {
            isTestMode
                <span class="hljs-operator">?</span> <span class="hljs-string">"ca-app-pub-3940256099942544/2934735716"</span>       <span class="hljs-comment">// 测试</span>
                : <span class="hljs-string">"ca-app-pub-YOUR_REAL_PUB_ID/BANNER_ID"</span>       <span class="hljs-comment">// 生产</span>
        }
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> interstitialID: <span class="hljs-type">String</span> {
            isTestMode
                <span class="hljs-operator">?</span> <span class="hljs-string">"ca-app-pub-3940256099942544/4411468910"</span>
                : <span class="hljs-string">"ca-app-pub-YOUR_REAL_PUB_ID/INTERSTITIAL_ID"</span>
        }
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> rewardedID: <span class="hljs-type">String</span> {
            isTestMode
                <span class="hljs-operator">?</span> <span class="hljs-string">"ca-app-pub-3940256099942544/1712485313"</span>
                : <span class="hljs-string">"ca-app-pub-YOUR_REAL_PUB_ID/REWARDED_ID"</span>
        }
    }
    
    <span class="hljs-comment">// MARK: - Meta AN 配置</span>
    
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Meta</span> {
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> bannerPlacementID: <span class="hljs-type">String</span> {
            isTestMode
                <span class="hljs-operator">?</span> <span class="hljs-string">"IMG_16_9_APP_INSTALL#YOUR_PLACEMENT_ID"</span>       <span class="hljs-comment">// 测试</span>
                : <span class="hljs-string">"YOUR_REAL_PLACEMENT_ID"</span>                        <span class="hljs-comment">// 生产</span>
        }
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> interstitialPlacementID: <span class="hljs-type">String</span> {
            isTestMode
                <span class="hljs-operator">?</span> <span class="hljs-string">"IMG_16_9_APP_INSTALL#YOUR_PLACEMENT_ID"</span>
                : <span class="hljs-string">"YOUR_REAL_PLACEMENT_ID"</span>
        }
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> rewardedPlacementID: <span class="hljs-type">String</span> {
            isTestMode
                <span class="hljs-operator">?</span> <span class="hljs-string">"VID_HD_16_9_46S_APP_INSTALL#YOUR_PLACEMENT_ID"</span>
                : <span class="hljs-string">"YOUR_REAL_PLACEMENT_ID"</span>
        }
    }
    
    <span class="hljs-comment">// MARK: - AppLovin MAX 配置</span>
    
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MAX</span> {
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> sdkKey <span class="hljs-operator">=</span> <span class="hljs-string">"YOUR_APPLOVIN_SDK_KEY"</span>
        
        <span class="hljs-comment">// MAX Ad Unit ID（在 AppLovin Dashboard 创建）</span>
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> bannerAdUnitID       <span class="hljs-operator">=</span> <span class="hljs-string">"YOUR_MAX_BANNER_UNIT"</span>
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> interstitialAdUnitID <span class="hljs-operator">=</span> <span class="hljs-string">"YOUR_MAX_INTERSTITIAL_UNIT"</span>
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> rewardedAdUnitID     <span class="hljs-operator">=</span> <span class="hljs-string">"YOUR_MAX_REWARDED_UNIT"</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-48">十、SwiftUI 集成（额外补充）</h3>
<p>如果你的项目使用 SwiftUI，以下是适配方式：</p>
<h4 data-id="heading-49">10.1 AdMob Banner 的 SwiftUI 封装</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI
<span class="hljs-keyword">import</span> GoogleMobileAds

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AdMobBannerView</span>: <span class="hljs-title class_">UIViewRepresentable</span> {
    
    <span class="hljs-keyword">let</span> adUnitID: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeUIView</span>(<span class="hljs-params">context</span>: <span class="hljs-type">Context</span>) -&gt; <span class="hljs-type">GADBannerView</span> {
        <span class="hljs-keyword">let</span> bannerView <span class="hljs-operator">=</span> <span class="hljs-type">GADBannerView</span>(adSize: <span class="hljs-type">GADAdSizeBanner</span>)
        bannerView.adUnitID <span class="hljs-operator">=</span> adUnitID
        bannerView.delegate <span class="hljs-operator">=</span> context.coordinator
        
        <span class="hljs-comment">// 延迟获取 rootViewController（SwiftUI 环境需要这样做）</span>
        <span class="hljs-type">DispatchQueue</span>.main.async {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> windowScene <span class="hljs-operator">=</span> <span class="hljs-type">UIApplication</span>.shared.connectedScenes.first <span class="hljs-keyword">as?</span> <span class="hljs-type">UIWindowScene</span>,
               <span class="hljs-keyword">let</span> rootVC <span class="hljs-operator">=</span> windowScene.windows.first<span class="hljs-operator">?</span>.rootViewController {
                bannerView.rootViewController <span class="hljs-operator">=</span> rootVC
                bannerView.load(<span class="hljs-type">GADRequest</span>())
            }
        }
        
        <span class="hljs-keyword">return</span> bannerView
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateUIView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">uiView</span>: <span class="hljs-type">GADBannerView</span>, <span class="hljs-params">context</span>: <span class="hljs-type">Context</span>) {}
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeCoordinator</span>() -&gt; <span class="hljs-type">Coordinator</span> {
        <span class="hljs-type">Coordinator</span>()
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Coordinator</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">GADBannerViewDelegate</span> {
        <span class="hljs-keyword">func</span> <span class="hljs-title function_">bannerViewDidReceiveAd</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">bannerView</span>: <span class="hljs-type">GADBannerView</span>) {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ [SwiftUI] Banner 加载成功"</span>)
        }
        
        <span class="hljs-keyword">func</span> <span class="hljs-title function_">bannerView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">bannerView</span>: <span class="hljs-type">GADBannerView</span>, <span class="hljs-params">didFailToReceiveAdWithError</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>) {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ [SwiftUI] Banner 加载失败: <span class="hljs-subst">\(error.localizedDescription)</span>"</span>)
        }
    }
}
</code></pre>
<h4 data-id="heading-50">10.2 在 SwiftUI View 中使用</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">GameView</span>: <span class="hljs-title class_">View</span> {
    
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> adViewModel <span class="hljs-operator">=</span> <span class="hljs-type">AdViewModel</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-comment">// 游戏内容</span>
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Your Game Content"</span>)
                .frame(maxWidth: .infinity, maxHeight: .infinity)
            
            <span class="hljs-comment">// 底部 Banner 广告</span>
            <span class="hljs-type">AdMobBannerView</span>(adUnitID: <span class="hljs-type">AdConfig</span>.<span class="hljs-type">AdMob</span>.bannerID)
                .frame(height: <span class="hljs-number">50</span>)
        }
        .onAppear {
            adViewModel.loadInterstitial()
            adViewModel.loadRewarded()
        }
    }
}

<span class="hljs-comment">// MARK: - 广告 ViewModel</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> isInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> isRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interstitialAd: <span class="hljs-type">GADInterstitialAd</span>?
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> rewardedAd: <span class="hljs-type">GADRewardedAd</span>?
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadInterstitial</span>() {
        <span class="hljs-type">GADInterstitialAd</span>.load(
            withAdUnitID: <span class="hljs-type">AdConfig</span>.<span class="hljs-type">AdMob</span>.interstitialID,
            request: <span class="hljs-type">GADRequest</span>()
        ) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] ad, error <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> ad {
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.interstitialAd <span class="hljs-operator">=</span> ad
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.isInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            }
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">showInterstitial</span>() {
        <span class="hljs-keyword">guard</span> isInterstitialReady,
              <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> interstitialAd,
              <span class="hljs-keyword">let</span> windowScene <span class="hljs-operator">=</span> <span class="hljs-type">UIApplication</span>.shared.connectedScenes.first <span class="hljs-keyword">as?</span> <span class="hljs-type">UIWindowScene</span>,
              <span class="hljs-keyword">let</span> rootVC <span class="hljs-operator">=</span> windowScene.windows.first<span class="hljs-operator">?</span>.rootViewController <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span>
        }
        
        ad.present(fromRootViewController: rootVC)
        isInterstitialReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        
        <span class="hljs-comment">// 展示后重新加载</span>
        <span class="hljs-type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="hljs-operator">+</span> <span class="hljs-number">1</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.loadInterstitial()
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadRewarded</span>() {
        <span class="hljs-type">GADRewardedAd</span>.load(
            withAdUnitID: <span class="hljs-type">AdConfig</span>.<span class="hljs-type">AdMob</span>.rewardedID,
            request: <span class="hljs-type">GADRequest</span>()
        ) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] ad, error <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> ad {
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.rewardedAd <span class="hljs-operator">=</span> ad
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.isRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            }
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">showRewarded</span>(<span class="hljs-params">onReward</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Int</span>, <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-keyword">guard</span> isRewardedReady,
              <span class="hljs-keyword">let</span> ad <span class="hljs-operator">=</span> rewardedAd,
              <span class="hljs-keyword">let</span> windowScene <span class="hljs-operator">=</span> <span class="hljs-type">UIApplication</span>.shared.connectedScenes.first <span class="hljs-keyword">as?</span> <span class="hljs-type">UIWindowScene</span>,
              <span class="hljs-keyword">let</span> rootVC <span class="hljs-operator">=</span> windowScene.windows.first<span class="hljs-operator">?</span>.rootViewController <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span>
        }
        
        ad.present(fromRootViewController: rootVC) {
            <span class="hljs-keyword">let</span> reward <span class="hljs-operator">=</span> ad.adReward
            onReward(reward.amount.intValue, reward.type)
        }
        
        isRewardedReady <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        <span class="hljs-type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="hljs-operator">+</span> <span class="hljs-number">1</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.loadRewarded()
        }
    }
}
</code></pre>
<h4 data-id="heading-51">10.3 AppLovin MAX 的 SwiftUI 封装</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI
<span class="hljs-keyword">import</span> AppLovinSDK

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MAXBannerSwiftUIView</span>: <span class="hljs-title class_">UIViewRepresentable</span> {
    
    <span class="hljs-keyword">let</span> adUnitID: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeUIView</span>(<span class="hljs-params">context</span>: <span class="hljs-type">Context</span>) -&gt; <span class="hljs-type">MAAdView</span> {
        <span class="hljs-keyword">let</span> adView <span class="hljs-operator">=</span> <span class="hljs-type">MAAdView</span>(adUnitIdentifier: adUnitID)
        adView.delegate <span class="hljs-operator">=</span> context.coordinator
        adView.backgroundColor <span class="hljs-operator">=</span> .clear
        adView.loadAd()
        <span class="hljs-keyword">return</span> adView
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateUIView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">uiView</span>: <span class="hljs-type">MAAdView</span>, <span class="hljs-params">context</span>: <span class="hljs-type">Context</span>) {}
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeCoordinator</span>() -&gt; <span class="hljs-type">Coordinator</span> {
        <span class="hljs-type">Coordinator</span>()
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Coordinator</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">MAAdViewAdDelegate</span> {
        <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ [SwiftUI] MAX Banner 加载成功, 来源: <span class="hljs-subst">\(ad.networkName)</span>"</span>)
        }
        
        <span class="hljs-keyword">func</span> <span class="hljs-title function_">didFailToLoadAd</span>(<span class="hljs-params">forAdUnitIdentifier</span> <span class="hljs-params">adUnitIdentifier</span>: <span class="hljs-type">String</span>, <span class="hljs-params">withError</span> <span class="hljs-params">error</span>: <span class="hljs-type">MAError</span>) {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ [SwiftUI] MAX Banner 加载失败: <span class="hljs-subst">\(error.message)</span>"</span>)
        }
        
        <span class="hljs-keyword">func</span> <span class="hljs-title function_">didClick</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {}
        <span class="hljs-keyword">func</span> <span class="hljs-title function_">didFail</span>(<span class="hljs-params">toDisplay</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>, <span class="hljs-params">withError</span> <span class="hljs-params">error</span>: <span class="hljs-type">MAError</span>) {}
        <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExpand</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {}
        <span class="hljs-keyword">func</span> <span class="hljs-title function_">didCollapse</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">ad</span>: <span class="hljs-type">MAAd</span>) {}
    }
}

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Hello World"</span>)
                .frame(maxHeight: .infinity)
            
            <span class="hljs-type">MAXBannerSwiftUIView</span>(adUnitID: <span class="hljs-type">AdConfig</span>.<span class="hljs-type">MAX</span>.bannerAdUnitID)
                .frame(height: <span class="hljs-number">50</span>)
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-52">十一、完整的 Podfile 汇总</h3>
<p>根据你选择的方案，使用对应的 Podfile：</p>
<h4 data-id="heading-53">方案一：AdMob Mediation（推荐快速上手）</h4>
<pre><code class="hljs language-ruby" lang="ruby">platform <span class="hljs-symbol">:ios</span>, <span class="hljs-string">'13.0'</span>

target <span class="hljs-string">'YourApp'</span> <span class="hljs-keyword">do</span>
  use_frameworks!

  <span class="hljs-comment"># AdMob SDK（聚合主体）</span>
  pod <span class="hljs-string">'Google-Mobile-Ads-SDK'</span>, <span class="hljs-string">'~&gt; 12.0'</span>

  <span class="hljs-comment"># Meta Audience Network Mediation 适配器</span>
  pod <span class="hljs-string">'GoogleMobileAdsMediationFacebook'</span>

  <span class="hljs-comment"># GDPR 合规</span>
  pod <span class="hljs-string">'GoogleUserMessagingPlatform'</span>

  <span class="hljs-comment"># （可选）更多网络</span>
  <span class="hljs-comment"># pod 'GoogleMobileAdsMediationAppLovin'</span>
  <span class="hljs-comment"># pod 'GoogleMobileAdsMediationUnity'</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4 data-id="heading-54">方案二：AppLovin MAX（推荐追求高收益）</h4>
<pre><code class="hljs language-ruby" lang="ruby">platform <span class="hljs-symbol">:ios</span>, <span class="hljs-string">'13.0'</span>

target <span class="hljs-string">'YourApp'</span> <span class="hljs-keyword">do</span>
  use_frameworks!
  inhibit_all_warnings!

  <span class="hljs-comment"># AppLovin MAX SDK（聚合主体）</span>
  pod <span class="hljs-string">'AppLovinSDK'</span>

  <span class="hljs-comment"># AdMob 适配器</span>
  pod <span class="hljs-string">'AppLovinMediationGoogleAdapter'</span>

  <span class="hljs-comment"># Meta AN 适配器</span>
  pod <span class="hljs-string">'AppLovinMediationFacebookAdapter'</span>

  <span class="hljs-comment"># （可选）更多网络 - 接入越多竞争越激烈收益越高</span>
  <span class="hljs-comment"># pod 'AppLovinMediationUnityAdsAdapter'</span>
  <span class="hljs-comment"># pod 'AppLovinMediationMintegralAdapter'</span>
  <span class="hljs-comment"># pod 'AppLovinMediationVungleAdapter'</span>
  <span class="hljs-comment"># pod 'AppLovinMediationIronSourceAdapter'</span>
  <span class="hljs-comment"># pod 'AppLovinMediationByteDanceAdapter'     # Pangle / TikTok</span>
  <span class="hljs-comment"># pod 'AppLovinMediationChartboostAdapter'</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4 data-id="heading-55">方案三：手动管理（不推荐）</h4>
<pre><code class="hljs language-ruby" lang="ruby">platform <span class="hljs-symbol">:ios</span>, <span class="hljs-string">'13.0'</span>

target <span class="hljs-string">'YourApp'</span> <span class="hljs-keyword">do</span>
  use_frameworks!

  pod <span class="hljs-string">'Google-Mobile-Ads-SDK'</span>, <span class="hljs-string">'~&gt; 12.0'</span>
  pod <span class="hljs-string">'FBAudienceNetwork'</span>
  pod <span class="hljs-string">'GoogleUserMessagingPlatform'</span>
<span class="hljs-keyword">end</span>
</code></pre>
<hr/>
<h3 data-id="heading-56">十二、总结与推荐</h3>
<h4 data-id="heading-57">最终推荐</h4>

























<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td><strong>新项目 / 追求最高收益</strong></td><td>⭐ AppLovin MAX</td><td>公平竞价、更多网络、详细报告</td></tr><tr><td><strong>已有 AdMob 基础 / 快速接入</strong></td><td>⭐ AdMob Mediation</td><td>改动最小，生态成熟</td></tr><tr><td><strong>学习了解原理</strong></td><td>手动管理</td><td>仅作学习参考</td></tr></tbody></table>
<h4 data-id="heading-58">关键要点回顾</h4>
<ol>
<li><strong>一定要使用聚合平台</strong>，不要手动管理多个 SDK</li>
<li><strong>优先使用 Bidding（实时竞价）</strong> 而非 Waterfall（瀑布流）</li>
<li><strong>接入 3 个以上竞价网络</strong>，竞争越多收益越高</li>
<li><strong>隐私合规三步走</strong>：GDPR 同意 → ATT 授权 → 各 SDK 设置</li>
<li><strong>使用测试 ID 开发</strong>，上线前切换为生产 ID</li>
<li><strong>预加载策略</strong>：广告关闭后立即预加载下一个</li>
<li><strong>频次控制</strong>：避免过度展示导致用户流失或政策违规</li>
<li><strong>定期更新 SDK</strong>：各广告网络持续优化，新版本通常带来更高收益</li>
</ol>
<h4 data-id="heading-59">预期收益参考（仅供参考，受地区/品类/用户质量影响极大）</h4>



































<table><thead><tr><th>广告格式</th><th>美国市场 eCPM 参考</th><th>中国/亚洲市场 eCPM 参考</th></tr></thead><tbody><tr><td>Banner</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.5</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">0.5 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.5</span><span class="mspace nobreak"> </span></span></span></span></span>3.0</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.1</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">0.1 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.1</span><span class="mspace nobreak"> </span></span></span></span></span>1.0</td></tr><tr><td>Interstitial</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5.0</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">5.0 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5.0</span><span class="mspace nobreak"> </span></span></span></span></span>20.0</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.0</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">1.0 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.0</span><span class="mspace nobreak"> </span></span></span></span></span>8.0</td></tr><tr><td>Rewarded Video</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10.0</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">10.0 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10.0</span><span class="mspace nobreak"> </span></span></span></span></span>40.0</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3.0</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">3.0 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">3.0</span><span class="mspace nobreak"> </span></span></span></span></span>15.0</td></tr><tr><td>MREC</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.0</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">1.0 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.0</span><span class="mspace nobreak"> </span></span></span></span></span>5.0</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.3</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">0.3 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.3</span><span class="mspace nobreak"> </span></span></span></span></span>2.0</td></tr><tr><td>App Open</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5.0</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">5.0 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5.0</span><span class="mspace nobreak"> </span></span></span></span></span>15.0</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.0</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">1.0 ~ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.0</span><span class="mspace nobreak"> </span></span></span></span></span>6.0</td></tr></tbody></table>
<blockquote>
<p>⚠️ 以上数据仅为行业大致参考范围。实际 eCPM 受以下因素影响极大：</p>
<ul>
<li><strong>用户地区</strong>（T1 国家如美/英/澳/加远高于其他地区）</li>
<li><strong>App 品类</strong>（金融、教育类 &gt; 工具类 &gt; 游戏休闲类）</li>
<li><strong>用户质量</strong>（高留存用户 eCPM 更高）</li>
<li><strong>接入网络数量</strong>（3+ 个 Bidding 网络可提升 20~50%）</li>
<li><strong>ATT 授权率</strong>（授权用户 eCPM 可比未授权高 30~80%）</li>
</ul>
</blockquote>
<h3 data-id="heading-60">十三、App Store 审核注意事项</h3>
<h4 data-id="heading-61">13.1 App 隐私标签（Privacy Nutrition Labels）</h4>
<p>上架 App Store 时，需要在 App Store Connect 中如实填写隐私标签。接入广告 SDK 后，通常需要声明以下数据收集：</p>









































<table><thead><tr><th>数据类型</th><th>是否收集</th><th>用途</th><th>是否关联用户</th></tr></thead><tbody><tr><td>设备标识符 (IDFA)</td><td>✅</td><td>第三方广告、分析</td><td>是（如用户授权 ATT）</td></tr><tr><td>粗略位置</td><td>✅</td><td>第三方广告</td><td>否</td></tr><tr><td>使用数据（产品交互）</td><td>✅</td><td>第三方广告、分析</td><td>否</td></tr><tr><td>诊断数据</td><td>✅</td><td>分析</td><td>否</td></tr><tr><td>广告数据</td><td>✅</td><td>第三方广告</td><td>是</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>各 SDK 的隐私声明文档：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fadmob%2Fios%2Fdata-disclosure" target="_blank" title="https://developers.google.com/admob/ios/data-disclosure" ref="nofollow noopener noreferrer">Google AdMob 隐私声明</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Faudience-network%2Fguides%2Fapple-app-data-use" target="_blank" title="https://developers.facebook.com/docs/audience-network/guides/apple-app-data-use" ref="nofollow noopener noreferrer">Meta AN 隐私声明</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.axon.ai%2Fen%2Fmax%2Fios%2Foverview%2Fprivacy%2F" target="_blank" title="https://support.axon.ai/en/max/ios/overview/privacy/" ref="nofollow noopener noreferrer">AppLovin 隐私声明</a></li>
</ul>
</blockquote>
<h4 data-id="heading-62">13.2 审核常见被拒原因及解决</h4>



































<table><thead><tr><th>被拒原因</th><th>描述</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>Guideline 5.1.1</strong></td><td>ATT 弹窗描述不清或存在误导</td><td>使用清晰、诚实的 <code>NSUserTrackingUsageDescription</code> 文案</td></tr><tr><td><strong>Guideline 5.1.2</strong></td><td>隐私标签与实际不符</td><td>根据所有接入 SDK 如实更新隐私标签</td></tr><tr><td><strong>Guideline 2.3.2</strong></td><td>广告遮挡 UI 或影响功能</td><td>确保 Banner 不遮挡按钮；插屏在合理时机展示</td></tr><tr><td><strong>Guideline 3.1.1</strong></td><td>激励视频绕过内购</td><td>激励视频只能奖励消耗型道具，不能替代订阅/永久解锁</td></tr><tr><td><strong>Guideline 4.0</strong></td><td>广告内容不当</td><td>启用 AdMob 或 MAX 的广告质量审核功能</td></tr></tbody></table>
<h4 data-id="heading-63">13.3 ATT 弹窗最佳实践</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 不好的描述</span>
<span class="hljs-string">"We need your permission to track you."</span>

<span class="hljs-comment">// ✅ 好的描述（清晰说明对用户的好处）</span>
<span class="hljs-string">"此标识符将用于为您提供更相关的广告体验。您的数据不会用于其他目的。"</span>

<span class="hljs-comment">// ✅ 英文版</span>
<span class="hljs-string">"This identifier will be used to deliver personalized ads to you. Your data will not be used for any other purpose."</span>
</code></pre>
<p><strong>提高 ATT 授权率的技巧：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">/// 在弹出系统 ATT 弹窗之前，先展示一个自定义的预弹窗说明</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ATTPrePromptView</span>: <span class="hljs-title class_">UIViewController</span> {
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">showPrePrompt</span>(<span class="hljs-params">from</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> () -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-keyword">let</span> alert <span class="hljs-operator">=</span> <span class="hljs-type">UIAlertController</span>(
            title: <span class="hljs-string">"支持我们继续免费提供服务 🙏"</span>,
            message: <span class="hljs-string">"""
            我们通过展示广告来维持应用免费。
            
            接下来系统会询问您是否允许追踪。
            如果您同意，我们能为您展示更相关的广告，
            同时帮助我们获得更好的收入来改进应用。
            
            您的选择不会影响广告数量。
            """</span>,
            preferredStyle: .alert
        )
        
        alert.addAction(<span class="hljs-type">UIAlertAction</span>(title: <span class="hljs-string">"好的，继续"</span>, style: .default) { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
            completion()
        })
        
        alert.addAction(<span class="hljs-type">UIAlertAction</span>(title: <span class="hljs-string">"暂时跳过"</span>, style: .cancel) { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
            completion()
        })
        
        viewController.present(alert, animated: <span class="hljs-literal">true</span>)
    }
}
</code></pre>
<blockquote>
<p>💡 <strong>自定义预弹窗可将 ATT 授权率从 ~20% 提升到 ~40%+</strong>，直接影响广告收益。</p>
</blockquote>
<hr/>
<h3 data-id="heading-64">十四、上线前的检查清单 ✅</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">### 📋 上线前广告集成检查清单</span>

<span class="hljs-section">#### 基础配置</span>
<span class="hljs-bullet">-</span> [ ] Info.plist 中配置了 GADApplicationIdentifier（AdMob App ID）
<span class="hljs-bullet">-</span> [ ] Info.plist 中配置了 NSUserTrackingUsageDescription
<span class="hljs-bullet">-</span> [ ] Info.plist 中添加了所有必需的 SKAdNetworkItems
<span class="hljs-bullet">-</span> [ ] AppLovinSdkKey 已配置（如使用 MAX）

<span class="hljs-section">#### SDK 初始化</span>
<span class="hljs-bullet">-</span> [ ] GDPR 同意流程在 SDK 初始化之前执行
<span class="hljs-bullet">-</span> [ ] ATT 权限请求在 SDK 初始化之前执行
<span class="hljs-bullet">-</span> [ ] Meta ATE 标志根据 ATT 结果正确设置
<span class="hljs-bullet">-</span> [ ] 广告 SDK 初始化在 completionHandler 中确认成功

<span class="hljs-section">#### 广告实现</span>
<span class="hljs-bullet">-</span> [ ] 所有测试 ID 已替换为生产 ID
<span class="hljs-bullet">-</span> [ ] 测试设备代码已移除或被 #if DEBUG 包裹
<span class="hljs-bullet">-</span> [ ] 插屏广告有频次控制
<span class="hljs-bullet">-</span> [ ] 广告关闭后有预加载逻辑
<span class="hljs-bullet">-</span> [ ] 加载失败有指数退避重试
<span class="hljs-bullet">-</span> [ ] 激励视频奖励逻辑在 didRewardUser 回调中处理

<span class="hljs-section">#### 隐私合规</span>
<span class="hljs-bullet">-</span> [ ] App Store Connect 隐私标签已更新
<span class="hljs-bullet">-</span> [ ] GDPR 同意弹窗在欧洲地区正确显示
<span class="hljs-bullet">-</span> [ ] CCPA 合规处理（如面向美国用户）
<span class="hljs-bullet">-</span> [ ] Meta 数据处理选项根据用户同意状态设置

<span class="hljs-section">#### 后台配置</span>
<span class="hljs-bullet">-</span> [ ] AdMob 后台已创建所有 Ad Unit
<span class="hljs-bullet">-</span> [ ] Meta AN 后台已创建所有 Placement
<span class="hljs-bullet">-</span> [ ] AppLovin Dashboard 已配置所有 Ad Unit（如使用 MAX）
<span class="hljs-bullet">-</span> [ ] Mediation 组配置正确，Bidding 已启用

<span class="hljs-section">#### 测试验证</span>
<span class="hljs-bullet">-</span> [ ] 三种广告格式（Banner/Interstitial/Rewarded）均能正常展示
<span class="hljs-bullet">-</span> [ ] 在模拟器和真机上均测试通过
<span class="hljs-bullet">-</span> [ ] 多次打开/关闭广告无崩溃
<span class="hljs-bullet">-</span> [ ] 网络断开时不崩溃，恢复后能重新加载
<span class="hljs-bullet">-</span> [ ] 内存泄漏检查通过（Instruments - Leaks）

<span class="hljs-section">#### 收益追踪</span>
<span class="hljs-bullet">-</span> [ ] 广告展示事件正确上报到分析平台
<span class="hljs-bullet">-</span> [ ] 收益数据可在 AdMob / AppLovin 后台查看
<span class="hljs-bullet">-</span> [ ] 不同网络的填充率和 eCPM 可分别追踪
</code></pre>
<hr/>
<h3 data-id="heading-65">十五、参考链接汇总</h3>





















































<table><thead><tr><th>资源</th><th>链接</th></tr></thead><tbody><tr><td><strong>AdMob iOS 官方文档</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fadmob%2Fios%2Fquick-start" target="_blank" title="https://developers.google.com/admob/ios/quick-start" ref="nofollow noopener noreferrer">developers.google.com/admob/ios/q…</a></td></tr><tr><td><strong>AdMob Mediation 文档</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fadmob%2Fios%2Fmediation" target="_blank" title="https://developers.google.com/admob/ios/mediation" ref="nofollow noopener noreferrer">developers.google.com/admob/ios/m…</a></td></tr><tr><td><strong>Meta AN iOS 文档</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Faudience-network%2Fget-started%2Fios" target="_blank" title="https://developers.facebook.com/docs/audience-network/get-started/ios" ref="nofollow noopener noreferrer">developers.facebook.com/docs/audien…</a></td></tr><tr><td><strong>AppLovin MAX iOS 文档</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.axon.ai%2Fen%2Fmax%2Fios%2Foverview%2Fintegration%2F" target="_blank" title="https://support.axon.ai/en/max/ios/overview/integration/" ref="nofollow noopener noreferrer">support.axon.ai/en/max/ios/…</a></td></tr><tr><td><strong>MAX Mediated Networks</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.axon.ai%2Fen%2Fmax%2Fios%2Fpreparing-mediated-networks%2F" target="_blank" title="https://support.axon.ai/en/max/ios/preparing-mediated-networks/" ref="nofollow noopener noreferrer">support.axon.ai/en/max/ios/…</a></td></tr><tr><td><strong>MAX Banner 文档</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.axon.ai%2Fen%2Fmax%2Fios%2Fad-formats%2Fbanner-and-mrec-ads%2F" target="_blank" title="https://support.axon.ai/en/max/ios/ad-formats/banner-and-mrec-ads/" ref="nofollow noopener noreferrer">support.axon.ai/en/max/ios/…</a></td></tr><tr><td><strong>MAX Interstitial 文档</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.axon.ai%2Fen%2Fmax%2Fios%2Fad-formats%2Finterstitial-ads%2F" target="_blank" title="https://support.axon.ai/en/max/ios/ad-formats/interstitial-ads/" ref="nofollow noopener noreferrer">support.axon.ai/en/max/ios/…</a></td></tr><tr><td><strong>MAX Rewarded 文档</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.axon.ai%2Fen%2Fmax%2Fios%2Fad-formats%2Frewarded-ads%2F" target="_blank" title="https://support.axon.ai/en/max/ios/ad-formats/rewarded-ads/" ref="nofollow noopener noreferrer">support.axon.ai/en/max/ios/…</a></td></tr><tr><td><strong>SKAdNetwork 配置</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.axon.ai%2Fen%2Fmax%2Fios%2Foverview%2Fskadnetwork%2F" target="_blank" title="https://support.axon.ai/en/max/ios/overview/skadnetwork/" ref="nofollow noopener noreferrer">support.axon.ai/en/max/ios/…</a></td></tr><tr><td><strong>AppLovin MAX SDK GitHub</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAppLovin%2FAppLovin-MAX-SDK-iOS" target="_blank" title="https://github.com/AppLovin/AppLovin-MAX-SDK-iOS" ref="nofollow noopener noreferrer">github.com/AppLovin/Ap…</a></td></tr><tr><td><strong>Google UMP SDK</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fadmob%2Fump%2Fios%2Fquick-start" target="_blank" title="https://developers.google.com/admob/ump/ios/quick-start" ref="nofollow noopener noreferrer">developers.google.com/admob/ump/i…</a></td></tr></tbody></table>
<hr/>
<p>以上就是在 iOS 应用中同时集成 <strong>Google AdMob</strong> 和 <strong>Meta Audience Network</strong> 的完整指南。总结核心建议：</p>
<ol>
<li><strong>优先选择聚合方案</strong>（AdMob Mediation 或 AppLovin MAX），避免手动管理</li>
<li><strong>隐私合规</strong>必须放在最优先级——GDPR → ATT → SDK 初始化</li>
<li><strong>接入 3+ 个 Bidding 网络</strong>是提升收益的最有效手段</li>
<li><strong>使用测试 ID 开发</strong>，上线前严格按照检查清单逐项确认</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 CSS 解决“真·shrinkwrap”：把自动换行的内容，紧贴包起来]]></title>    <link>https://juejin.cn/post/7604786493638426651</link>    <guid>https://juejin.cn/post/7604786493638426651</guid>    <pubDate>2026-02-10T02:36:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604786493638426651" data-draft-id="7604709514131898414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 CSS 解决“真·shrinkwrap”：把自动换行的内容，紧贴包起来"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-10T02:36:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 CSS 解决“真·shrinkwrap”：把自动换行的内容，紧贴包起来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:36:13.000Z" title="Tue Feb 10 2026 02:36:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：Solving Shrinkwrap: New Experimental Technique (<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>欢迎关注 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a>，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e987357c15e6449fb1afe4e5376a635d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295772&amp;x-signature=%2FQVHp5kxqjel3W5U1d7t99C%2B8KI%3D" alt="" loading="lazy"/></p>
<p>前端写 UI 写久了，你总会遇到一种特别别扭的视觉：内容明明只有两三行字，容器却像被“撑到一整行”那样宽，留下一大块无意义的空白。标题、标签、气泡、tooltip、legend、图片 caption……只要文本会自动换行，这个问题就会反复出现。</p>
<p>大家管它叫 shrinkwrap：容器应该像“紧贴包裹”一样贴着内容生长。CSS 在很多场景里有 <code>inline-block</code>、<code>max-content</code>、<code>fit-content()</code>，看起来都像答案；但只要内容换行、参与布局分配（尤其是 flex / grid 的剩余空间分配），你就会发现“贴合”很容易变成“占满”。这也是 Roman Komarov 这篇文章要解决的核心：让会自动换行的内容，依旧能得到真正影响布局的 shrinkwrap，而不仅仅是画出来像。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>文章给出的结论很直接：把两个近两年逐渐成熟的 CSS 能力拼起来——<strong>Anchor Positioning（锚点定位）</strong> + <strong>Scroll-driven Animations（滚动驱动动画）</strong> ——就能在纯 CSS 里完成一件过去高度依赖 JS 的事情：<strong>测量内部内容的几何尺寸，然后把测得的结果回写给外层容器作为尺寸约束</strong>。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>这听起来像“黑魔法”，但它的工程价值很明确：只要浏览器支持相关特性，布局就能进入一个更“内容驱动”的状态；不支持时还能优雅降级为普通布局（只是没那么好看）。作者也强调了实验性与风险，尤其提到 Safari 的崩溃 bug，以及生产使用要谨慎评估。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<hr/>
<h2 data-id="heading-0">这个问题为什么难：换行会引发“宽度争夺战”</h2>
<p>理解 shrinkwrap 的难点，关键在“自动换行”这四个字。</p>
<p>当文本能换行时，布局系统倾向于先拿到一个“可用空间”，再在这个空间里排版、换行、对齐。很多组件在 flex / grid 里看起来“突然变宽”，根源就在这里：元素宽度开始响应外部可用空间，内容的换行结果又反过来影响元素看起来“应该多宽”。你想让容器贴着内容，布局引擎却更愿意让内容适配容器。</p>
<p>这也是为什么过去常见的解决方案要么是 JS 测量（<code>getBoundingClientRect()</code> / <code>offsetWidth</code>），要么是硬编码换行（手动 <code>&lt;br&gt;</code>），要么是接受不完美（靠背景伪元素装饰出“看起来贴合”）。作者在 2023 年的旧文里就做过一种偏装饰性的 workaround：锚点能把装饰物贴到换行文本边上，但它不改变真正的布局尺寸，所以仍然“看起来对、布局没变”。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>这次的新技巧，目标更激进：<strong>直接改布局</strong>。</p>
<hr/>
<h2 data-id="heading-1">核心思路：放一个“探针”，用滚动动画把尺寸“偷”出来</h2>
<p>整套方案可以拆成一句话：</p>
<blockquote>
<p>让内部内容在一个可控的“内盒子”里自然换行；再放一个绝对定位的 probe（探针）锚定到内容的边界；用 view-timeline 把 probe 的位置映射成 0~1 的动画进度；把这个进度还原成实际像素值；最终把像素值写回外层容器的 <code>inline-size</code> / <code>min-inline-size</code>。</p>
</blockquote>
<p>这里最关键的点，是作者把“滚动驱动动画”当成了一个<strong>远程状态传递 / 远程测量</strong>机制：动画本来是拿来做动效的，但它天然具备“把一个元素在某个坐标系里的位置，转成一个可被 CSS 变量表达的数”的能力。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>这条思路在社区里也有呼应。作者引用了 Temani Afif 2024 年的文章：同样利用 scroll-driven animations，在纯 CSS 里计算元素宽高。两者差异在于测量点的选择：Temani 的方法更像用一个 <code>1px</code> 元素配合比例反推 scrollport；Roman 这篇更依赖 anchor positioning，把探针直接钉到想测的“那个边界点”，再配一个很大的 timeline-range 当分辨率去还原数值。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<hr/>
<h2 data-id="heading-2">基础结构：为什么要多包三层</h2>
<p>文章给出的基础 HTML 结构很“刻意”，因为它本身就是 API：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"shrinkwrap"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"shrinkwrap-content"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"shrinkwrap-source"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- Text --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"shrinkwrap-probe"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>每一层都有明确职责：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<ul>
<li><code>shrinkwrap</code>：外层真正要参与布局、最终要被“缩到贴合内容”的元素。</li>
<li><code>shrinkwrap-content</code>：一个允许“比外层更宽”的内盒子，它决定文本如何换行；同时它承担溢出裁剪（<code>overflow: hidden</code>），为 view timeline 提供必要条件。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</li>
<li><code>shrinkwrap-source</code>：被测量的目标，默认是行内内容（<code>display: inline</code>），并提供 <code>anchor-name</code> 作为锚点标识。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</li>
<li><code>shrinkwrap-probe</code>：探针元素，绝对定位、禁用 pointer events，通过 <code>position-anchor</code> 锚定到 source，并建立 view timeline，让外层能“读到”它。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</li>
</ul>
<p>这里有个非常工程化的判断：作者建议 probe 优先用真实 DOM 元素，避免 Safari 在某些条件下因为伪元素 probe 触发标签页崩溃；他还给出了 WebKit 的 bug 链接，并解释了自己如何做最小复现来定位问题。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<hr/>
<h2 data-id="heading-3">外层 shrinkwrap 的 CSS：测量 + 回写 + 降级</h2>
<p>外层 <code>shrinkwrap</code> 的 CSS 片段里，能看到三个层次的动作：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>1）用 layers + 自定义属性定义一套可覆写的 CSS API（让这套技巧像“组件”一样可配置）。<br/>
2）通过 <code>timeline-scope</code> + <code>animation</code> 把内部 probe 的 view timeline“提升”到外层可访问的作用域，然后把关键坐标写进自定义属性。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)<br/>
3）把写入的变量用于 <code>inline-size</code> / <code>min-inline-size</code> 的计算，最终让外层真的变窄。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>作者还用了他自己长期研究的一类技巧：<strong>Cyclic Dependency Space Toggles</strong>，用来做“条件式启用”和更顺滑的降级。它的意义很现实：当浏览器不支持 <code>timeline-scope</code> 或锚点定位时，布局回到普通状态，页面照样能用，只是视觉贴合度下降。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>文章里也专门列了限制条件，比如外层可以处在普通流、block/inline-block、flex/grid item 都行，但它自己不适合再成为 flex/grid 容器；并且它的 <code>max-inline-size</code> 不能依赖兄弟元素，否则就会进入更难处理的循环依赖。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<hr/>
<h2 data-id="heading-4">文本对齐是隐藏大坑：左对齐之外都要补一刀</h2>
<p>如果文本永远左对齐，基础技巧已经够用：因为左边界固定，外层缩到合适宽度就能“贴住”。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>一旦出现 <code>text-align: center/right</code>，问题就变得微妙：文本的对齐发生在更大的内盒子里（<code>shrinkwrap-content</code>），外层虽然缩小了，文本依旧在内盒子里“按大宽度对齐”，视觉上就会漂。作者给的解决方式很聪明：继续复用测量阶段得到的变量，给 <code>shrinkwrap-content</code> 加一个相对定位偏移，用 <code>inset-inline-start</code> 把它挪回去。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>这里还提到 Safari 的一个渲染差异：同样的对齐切换，在 Safari 上第一行的排版变化可能比 Chrome 明显得多，这意味着边缘 case 仍然存在。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<hr/>
<h2 data-id="heading-5">把基础技巧当积木：列表、卡片、段落都能拼</h2>
<p>文章中段最有启发的一点，是作者把这套 shrinkwrap 当成“布局积木”来使用：</p>
<p>如果一个复杂内容能拆成多个“独立的行内内容上下文”，就对每一段行内内容重复使用 shrinkwrap，然后在更外层用 <code>max-content</code> 或其他方式把整体也贴合起来。作者用多项列表放进卡片、每项可能多段落的例子说明：只要拆分得当，这套技巧就能覆盖比“标题贴合”更复杂的 UI。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>这也解释了为什么 API 里最重要的自定义属性是 <code>--sw-limit</code>：它相当于告诉这套技巧“允许文本最多占用多宽的上限”，常见默认是 <code>100cqi</code>（容器查询的 inline size 单位），当你希望旁边还留空间给其他列或控件时，就把它算成 50% 减 gap/padding 的形式。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>此外还有 <code>--sw-padding</code>、<code>--sw-inner-padding</code>、<code>--sw-inset</code>、<code>--sw-source</code> 等，用于把 padding 纳入计算、改写 probe 测量范围、甚至让被测量元素在 shrinkwrap 外部时建立连接。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<hr/>
<h2 data-id="heading-6">复杂内容：从“枚举锚点”到“链式锚点怪物”</h2>
<p>当内容不再是简单的行内文本，而是可换行的 flex/grid items，问题会升级。</p>
<p>文章给了两条路线：</p>
<h3 data-id="heading-7">1）多个显式锚点：知道元素数量，就能算出包围盒</h3>
<p>思路很直接：给每个 item 分配唯一 anchor，然后在一个 <code>min()</code> 里把所有 anchors 的 inset 都列出来，计算出决定 shrinkwrap 尺寸的“最远边界”。作者还提到需要用 <code>calc(infinity * 1px)</code> 作为回退，避免某些 item 不存在时计算出错，并让它在 <code>min()</code> 中被“优雅忽略”。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<h3 data-id="heading-8">2）链式锚点怪物：不枚举数量，用布局顺序做“求最值算法”</h3>
<p>这一段读起来像科幻：每个列表项里放两个 probe（left/right），利用“多个 anchors 共享同名时可以链式指向前一个有效目标”的行为，配合容器查询，当 probe 宽度变成正值时动态写入 <code>anchor-name</code>，让“最左/最右”像接力一样传递下去。作者把它形容成“用布局表达的求最大值算法”。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>现实限制同样明确：这个 chaining 行为目前主要在 Chrome 可用，Safari 和 Firefox 存在严重 bug，作者还给出了对应的 WebKit 与 Bugzilla 链接。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)<br/>
性能也有边界：元素超过 100 个可能出现 long task，1000 个元素能测到十几秒级别。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>这两段内容的价值，更多在于“把 layout 当计算模型”的思维：CSS 在逐步获得可组合、可推导的能力，开发者开始能用声明式规则去逼近过去必须写脚本才能做的布局决策。</p>
<hr/>
<h2 data-id="heading-9">跨依赖的终极难题：菜单场景依旧很硬</h2>
<p>文章把最难的 shrinkwrap 用例留给了“导航菜单”：同一行里多个 flex items 一起参与空间分配，空间不足时整体换行、间隙变得很难看。这个场景里，每个 item 的可用宽度取决于其他 items，限制值会动态变化，基础技巧需要一个稳定的 limit 才能成立，因此很难直接套用。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>作者目前找到的可行路线是“内容复制”：先渲染一个隐藏版本进行测量，把每个 item 的尺寸同步到可见副本，再把整个菜单作为整体放进另一层 shrinkwrap，让它也能贴合并把空间让给搜索框等控件。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)<br/>
他也明确说这套实现非常脆弱，暂时不提供完整代码，更多像一个“方向指示牌”。</p>
<hr/>
<h2 data-id="heading-10">一组很落地的用例：气泡、legend、图片 caption、tooltip</h2>
<p>文章后半段很像“设计系统组件目录”，每个例子都击中真实需求：(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<ul>
<li><strong>聊天气泡</strong>：Web 上长期难做得像原生，关键卡点就是换行后的贴合与对齐；新技巧让 <code>text-wrap: balance</code> 终于能更稳定地发挥作用。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</li>
<li><strong>fieldset/legend</strong>：过去常靠伪元素补边框，新技巧可以让 legend 在换行后依旧贴合，并保留原生行为。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</li>
<li><strong>图片覆盖 caption</strong>：半透明背景尽量少挡图，文字短没问题，换行就会横向铺满；shrinkwrap 能让背景贴合文本块。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</li>
<li><strong>tooltip/popover</strong>：既要均衡排版又要上限宽度，缺 shrinkwrap 时很容易“宽得难看”，新技巧能把弹层做得更紧凑。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</li>
</ul>
<p>这些例子共同说明了一点：shrinkwrap 不是“为了省几像素”，它直接影响组件的密度、节奏、对齐感，最终影响整个界面的高级感。</p>
<hr/>
<h2 data-id="heading-11">未来展望：原生 shrinkwrap 可能先从“简单版”落地</h2>
<p>作者最后的判断很务实：原生层面优先解决“最基础的用例”更划算，也就是<strong>已知上限的 max-inline-size 场景</strong>。这个能力可以通过新增属性或新增函数提供，可能需要配合 containment 来避免百分比尺寸引入循环依赖。简单版一旦落地，就能覆盖过去十多年里大量真实需求。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>菜单这种跨依赖 shrinkwrap 属于更复杂的布局问题，先不追求一步到位。作者计划把文章链接与提案发到 CSSWG 的相关 issue，鼓励有明确用例的人去补充需求，让规范讨论更贴近现实。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<hr/>
<h2 data-id="heading-12">给工程落地的判断：这套技巧适合用在什么地方</h2>
<p>结合作者的免责声明和这些 demo 的特性，可以得到一个很清晰的落地边界：</p>
<p>这套技巧很适合“增强型体验”的组件：启用后更精致、停用后可用性不受影响，风格与 <code>text-wrap: balance</code> 很接近。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>) 典型场景就是设计系统里的装饰性容器：气泡、徽标、标题标签、图片角标、tooltip。</p>
<p>对于强交互、强一致性要求的核心业务布局，需要更保守：一方面浏览器支持仍在演进，另一方面作者已经遇到过 Safari 崩溃与 chaining 兼容问题。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>) 这类场景更适合把它当成“可插拔的增强层”，用 <code>@supports</code> 控制启用范围，把风险隔离在可回退的层里。</p>
<hr/>
<h2 data-id="heading-13">结语：CSS 正在获得“测量与反馈”的闭环</h2>
<p>这篇文章真正让人兴奋的点，未必是“终于能做 shrinkwrap 了”，而是 CSS 的能力边界正在发生变化：</p>
<p>Anchor positioning 让元素之间的几何关系变得可引用；scroll-driven animations 让“位置/可见性”变成可计算的连续变量；<code>@property</code> 让变量具备类型与插值语义；容器查询让组件能读取自身所处环境。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p>
<p>当这些能力开始互相咬合，CSS 就出现了一条新的路径：<strong>布局不仅能声明，还能推导；样式不仅能描述，还能计算；组件不仅能渲染，还能自适应地回写自身约束</strong>。</p>
<p>你可以把这篇文章当成一次“未来 CSS”的预演。它已经能在部分稳定版浏览器里工作，也已经能解决一批非常真实的 UI 痛点。剩下的，就是把这些实验性的组合，逐步沉淀成更朴素、更可靠的原生能力。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkizu.dev%2Fshrinkwrap-solution%2F" title="https://kizu.dev/shrinkwrap-solution/" target="_blank" ref="nofollow noopener noreferrer">Kizu</a>)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[设计模式：带你用真实业务方法+Spring源码去理解模板 + 回调]]></title>    <link>https://juejin.cn/post/7604761524976549897</link>    <guid>https://juejin.cn/post/7604761524976549897</guid>    <pubDate>2026-02-10T02:53:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604761524976549897" data-draft-id="7604701848150441984" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="设计模式：带你用真实业务方法+Spring源码去理解模板 + 回调"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-10T02:53:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码丰"/> <meta itemprop="url" content="https://juejin.cn/user/3732161238663437"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            设计模式：带你用真实业务方法+Spring源码去理解模板 + 回调
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3732161238663437/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码丰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:53:58.000Z" title="Tue Feb 10 2026 02:53:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是模版+回调</h2>
<p>你肯定见到过类似这样的 代码</p>
<pre><code class="hljs language-bash" lang="bash">              TransactionUtil.doInTransactionWithRequires(() -&gt; {
               // 执行这个事务
                });
</code></pre>
<p>而doInTransactionWithRequires 这个方法接收一个函数式方法<br/>
supplier 然后内部去调用这个方法</p>
<pre><code class="hljs language-bash" lang="bash">  doInTransactionWithRequires（Suppler&lt;T&gt; supplier）		{
	T result = supplier.get()
}
</code></pre>
<p><strong>这个就是模版+回调</strong></p>
<blockquote>
<p>模板负责“流程骨架”，<br/>
回调负责“变化点注入”。</p>
</blockquote>
<h2 data-id="heading-1">二、先看“纯模板方法”的问题</h2>
<p>传统的模板方法模式长这样：</p>
<pre><code class="hljs language-bash" lang="bash">public abstract class AbstractTask {

    public final void <span class="hljs-function"><span class="hljs-title">execute</span></span>() {
        before();
        doExecute();
        after();
    }

    protected void <span class="hljs-function"><span class="hljs-title">before</span></span>() {}
    protected abstract void doExecute();
    protected void <span class="hljs-function"><span class="hljs-title">after</span></span>() {}
}
</code></pre>
<p>子类继承：</p>
<pre><code class="hljs language-bash" lang="bash">public class OrderTask extends AbstractTask {
    @Override
    protected void <span class="hljs-function"><span class="hljs-title">doExecute</span></span>() {      
    }
}
</code></pre>
<blockquote>
<p>这个方案的问题在工程里很明显：</p>
<p>强依赖继承</p>
<p>子类越来越多</p>
<p>一个类只能继承一个父类</p>
<p>行为组合非常困难</p>
<p>所以在大型框架里，纯继承模板几乎不用了。</p>
</blockquote>
<h2 data-id="heading-2">三、模板 + 回调：把“变化”从继承变成参数</h2>
<p>核心思想</p>
<blockquote>
<p>不再靠子类重写方法， 而是把“变化的逻辑”作为参数传进去</p>
<p>这个“参数”，就是 回调（Callback）。</p>
</blockquote>
<h2 data-id="heading-3">四、源码案例Spring 的TransactionTemplate：</h2>
<p>再看 Spring 提供的 TransactionTemplate：</p>
<pre><code class="hljs language-bash" lang="bash">transactionTemplate.execute(status -&gt; {
    userDao.update(user);
    orderDao.create(order);
    <span class="hljs-built_in">return</span> result;
});
</code></pre>
<p>对应源码里的核心逻辑:</p>
<pre><code class="hljs language-bash" lang="bash">TransactionStatus status = transactionManager.getTransaction(definition);
try {
    T result = action.doInTransaction(status); 
    transactionManager.commit(status);
    <span class="hljs-built_in">return</span> result;
} catch (Exception ex) {
    transactionManager.rollback(status);
    throw ex;
}
</code></pre>
<h2 data-id="heading-4">五、源码案例 JdbcTemplate</h2>
<p>Spring JDBC 里最经典的 JdbcTemplate：</p>
<pre><code class="hljs language-bash" lang="bash">jdbcTemplate.query(
    <span class="hljs-string">"select * from user"</span>,
    (rs, rowNum) -&gt; new User(rs.getLong(<span class="hljs-string">"id"</span>), rs.getString(<span class="hljs-string">"name"</span>))
);
</code></pre>
<p>传进去的 RowMapper，就是回调。</p>
<p>JdbcTemplate 内部做的事是固定的：</p>
<p>变化点只有一行：</p>
<pre><code class="hljs language-bash" lang="bash">rowMapper.mapRow(rs, rowNum);
</code></pre>
<h2 data-id="heading-5">六、总结</h2>
<blockquote>
<p>模板 + 回调并不等于“继承 + 抽象方法”。<br/>
在现代 Java 项目里，它更多以 函数式接口 + Lambda 的形式出现。</p>
<p>不管是公司事务工具类、Spring TransactionTemplate，还是 JdbcTemplate，本质都是同一套思想：<br/>
模板负责流程，回调负责变化。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Express 如何使用 multer 文件上传？]]></title>    <link>https://juejin.cn/post/7604697194795597834</link>    <guid>https://juejin.cn/post/7604697194795597834</guid>    <pubDate>2026-02-10T02:27:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604697194795597834" data-draft-id="7600414546189041674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Express 如何使用 multer 文件上传？"/> <meta itemprop="keywords" content="前端,NestJS,Node.js"/> <meta itemprop="datePublished" content="2026-02-10T02:27:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端付豪"/> <meta itemprop="url" content="https://juejin.cn/user/1741228277763278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Express 如何使用 multer 文件上传？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1741228277763278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端付豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:27:20.000Z" title="Tue Feb 10 2026 02:27:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nest 的文件上传是基于 Express 的中间件 multer 实现的，在学习 Nest 文件上传之前，先学习下 multer 包的使用</p>
<p>新建一个文件夹</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbb2818343724a1e8dd765d828d1a72f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=V%2FZEiXtDQtOYpW4X%2BBHSTCIbaZM%3D" alt="image.png" loading="lazy"/></p>
<p>cors 包是处理跨域 header</p>
<p>index.js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> multer  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>)
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>());

<span class="hljs-keyword">const</span> upload = <span class="hljs-title function_">multer</span>({ <span class="hljs-attr">dest</span>: <span class="hljs-string">'uploads/'</span> })

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/aaa'</span>, upload.<span class="hljs-title function_">single</span>(<span class="hljs-string">'aaa'</span>), <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.file'</span>, req.<span class="hljs-property">file</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.body'</span>, req.<span class="hljs-property">body</span>);
})

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<p>新建 index.html</p>
<p>通过 FormData + axios 上传文件，指定内容的传输格式 content-type 为 multipart/form-data。</p>
<p>（axios 会自动根据内容指定 content-type，不需要手动指定）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/axios@0.24.0/dist/axios.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
      <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#fileInput"</span>);

      <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formData</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
        data.<span class="hljs-title function_">set</span>(<span class="hljs-string">"name"</span>, <span class="hljs-string">"fuhao"</span>);
        data.<span class="hljs-title function_">set</span>(<span class="hljs-string">"age"</span>, <span class="hljs-number">18</span>);
        data.<span class="hljs-title function_">set</span>(<span class="hljs-string">"aaa"</span>, fileInput.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]);

        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">"http://localhost:3000/aaa"</span>, data);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
      }

      fileInput.<span class="hljs-property">onchange</span> = formData;
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<p>用 node 把 server 跑起来，并且用 http-server 把静态服务跑起来</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/962100ebe26a4c65a0027264ef3f6d25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=xNt3FaBV4MOK1MpTVaQ8%2FvMwztU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c940d361e4e649e8b645f42c82d25c48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=6a0fcMcQ3IVt%2FTXXX1dMViS4gaU%3D" alt="image.png" loading="lazy"/></p>
<p>上传文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bf7dd11d32c4afbbec5ab26baa731d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=qyTvYfn3aOqm4%2FtAPw%2Bj8ZVlCYo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eef38859dcd4aa2bbdc6dad91e02ca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=QgOXgHsKK%2F7fQ6%2FCQrCuZumftaE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/050f420dc372467d8c90ba6554ad3c87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=zf%2FLnfyo6I6IjEuVIi%2F%2BlY%2BQyFA%3D" alt="image.png" loading="lazy"/></p>
<p>这就是 form-data 的传输格式</p>
<p>服务端看下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63f784d97eb4afaa981ac3ab7b2e35d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=WUsTs6mHRiBkl6GkHMJUpLjNOHQ%3D" alt="image.png" loading="lazy"/></p>
<p>req.file 拿到文件字段，非文件字段在 req.body</p>
<p>服务端多了 uploads 目录，下面保存着上传文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4032e4c65f4e4593a33e712653a1b351~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=LnmDNyCoL9yzlEoyK3dU4pqh3wY%3D" alt="image.png" loading="lazy"/></p>
<p>这是单文件 上传 那多文件上传呢？</p>
<p>index.js 添加 /bbb</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> multer  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>)
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>());

<span class="hljs-keyword">const</span> upload = <span class="hljs-title function_">multer</span>({ <span class="hljs-attr">dest</span>: <span class="hljs-string">'uploads/'</span> })

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/aaa'</span>, upload.<span class="hljs-title function_">single</span>(<span class="hljs-string">'aaa'</span>), <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.file'</span>, req.<span class="hljs-property">file</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.body'</span>, req.<span class="hljs-property">body</span>);
})

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/bbb'</span>, upload.<span class="hljs-title function_">array</span>(<span class="hljs-string">'bbb'</span>, <span class="hljs-number">2</span>), <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.files'</span>, req.<span class="hljs-property">files</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.body'</span>, req.<span class="hljs-property">body</span>);
})

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<p>index.html 支持多文件</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/axios@0.24.0/dist/axios.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">multiple</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
      <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#fileInput"</span>);

      <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formData2</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
        data.<span class="hljs-title function_">set</span>(<span class="hljs-string">"name"</span>, <span class="hljs-string">"fuhao"</span>);
        data.<span class="hljs-title function_">set</span>(<span class="hljs-string">"age"</span>, <span class="hljs-number">20</span>);
        [...fileInput.<span class="hljs-property">files</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
          data.<span class="hljs-title function_">append</span>(<span class="hljs-string">"bbb"</span>, item);
        });

        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">"http://localhost:3000/bbb"</span>, data);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
      }

      fileInput.<span class="hljs-property">onchange</span> = formData2;
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c107d66c82e3428392481eb993989dbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=C4715%2Ba8k34wXLA0feiChUe%2FPJk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df5ccda136f14eeeb733528b7698c495~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=Bax8NXiLKvKaR24xEThEqa%2FvHcc%3D" alt="image.png" loading="lazy"/></p>
<p>如果超过 2个文件 就会默认报错</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a8690c66990452fabf78bf08dd146dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=LkR5buaPmaPH5%2FtlTeeL723lpLc%3D" alt="image.png" loading="lazy"/></p>
<p>改一下这个 错误</p>
<pre><code class="hljs language-lua" lang="lua">
app.post(<span class="hljs-string">'/bbb'</span>, upload.array(<span class="hljs-string">'bbb'</span>, <span class="hljs-number">2</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res, next)</span></span> {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'req.files'</span>, req.files);
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'req.body'</span>, req.body);
}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, req, res, next)</span></span> {
    <span class="hljs-keyword">if</span>(err instanceof multer.MulterError &amp;&amp; err.code === <span class="hljs-string">'LIMIT_UNEXPECTED_FILE'</span>) {
        res.<span class="hljs-built_in">status</span>(<span class="hljs-number">400</span>).<span class="hljs-keyword">end</span>(<span class="hljs-string">'Too many files uploaded'</span>);
    }
})
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1715dc1de9504c7a976d1e756027504a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=gfQxOMb30z3BN8FX%2BajmxM7QjYo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72826043d55845b18ba2c11625effb83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=5LEvegVTJLLaAnVyJIkr0Y1HFhE%3D" alt="image.png" loading="lazy"/></p>
<p>更复杂一点的情况，如果多个字段都会上传文件，而且限制也都不同呢？</p>
<p>index.js 更新</p>
<pre><code class="hljs language-less" lang="less">
<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.post</span>(<span class="hljs-string">'/ccc'</span>, upload.<span class="hljs-built_in">fields</span>([
    { <span class="hljs-attribute">name</span>: <span class="hljs-string">'aaa'</span>, <span class="hljs-attribute">maxCount</span>: <span class="hljs-number">3</span> },
    { <span class="hljs-attribute">name</span>: <span class="hljs-string">'bbb'</span>, <span class="hljs-attribute">maxCount</span>: <span class="hljs-number">2</span> }
]), function (req, res, next) {
    <span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(<span class="hljs-string">'req.files'</span>, req.files);
    <span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(<span class="hljs-string">'req.body'</span>, req.body);
})
</code></pre>
<p>index.html 更新</p>
<pre><code class="hljs language-ini" lang="ini">      async function formData3() {
        const <span class="hljs-attr">data</span> = new FormData()<span class="hljs-comment">;</span>
        data.set("name", "fuhao")<span class="hljs-comment">;</span>
        data.set("age", 20)<span class="hljs-comment">;</span>
        data.append("aaa", fileInput.files<span class="hljs-section">[0]</span>)<span class="hljs-comment">;</span>
        data.append("aaa", fileInput.files<span class="hljs-section">[1]</span>)<span class="hljs-comment">;</span>
        data.append("bbb", fileInput.files<span class="hljs-section">[2]</span>)<span class="hljs-comment">;</span>
        data.append("bbb", fileInput.files<span class="hljs-section">[3]</span>)<span class="hljs-comment">;</span>

        const <span class="hljs-attr">res</span> = await axios.post(<span class="hljs-string">"http://localhost:3000/ccc"</span>, data)<span class="hljs-comment">;</span>
        console.log(res)<span class="hljs-comment">;</span>
      }

      <span class="hljs-attr">fileInput.onchange</span> = formData3<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a0c9770a5b14038b1ad395c985407b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=k2Tagf0lxHu5EWefBQevUliKeEU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d9afb21f8584aa8ae1aaa7c278b3e95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=lqN%2B0vaPQ30sBTF6SWmQECJrUjM%3D" alt="image.png" loading="lazy"/></p>
<p>如何修改保存的文件名？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> multer  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>)
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>());

<span class="hljs-keyword">const</span> storage = multer.<span class="hljs-title function_">diskStorage</span>({
  <span class="hljs-title function_">destination</span>(<span class="hljs-params">req, file, cb</span>) {
    <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">'uploads/'</span>)
  },
  <span class="hljs-title function_">filename</span>(<span class="hljs-params">req, file, cb</span>) {
    <span class="hljs-comment">// 原始文件名</span>
    <span class="hljs-keyword">const</span> ext = path.<span class="hljs-title function_">extname</span>(file.<span class="hljs-property">originalname</span>)
    <span class="hljs-keyword">const</span> name = path.<span class="hljs-title function_">basename</span>(file.<span class="hljs-property">originalname</span>, ext)

    <span class="hljs-comment">// 自定义规则</span>
    <span class="hljs-keyword">const</span> newName = <span class="hljs-string">`<span class="hljs-subst">${name}</span>-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span><span class="hljs-subst">${ext}</span>`</span>

    <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, newName)
  }
})

<span class="hljs-keyword">const</span> upload = <span class="hljs-title function_">multer</span>({ storage })

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/aaa'</span>, upload.<span class="hljs-title function_">single</span>(<span class="hljs-string">'aaa'</span>), <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.file'</span>, req.<span class="hljs-property">file</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.body'</span>, req.<span class="hljs-property">body</span>);
})

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/bbb'</span>, upload.<span class="hljs-title function_">array</span>(<span class="hljs-string">'bbb'</span>, <span class="hljs-number">2</span>), <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.files'</span>, req.<span class="hljs-property">files</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.body'</span>, req.<span class="hljs-property">body</span>);
}, <span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) {
    <span class="hljs-keyword">if</span>(err <span class="hljs-keyword">instanceof</span> multer.<span class="hljs-property">MulterError</span> &amp;&amp; err.<span class="hljs-property">code</span> === <span class="hljs-string">'LIMIT_UNEXPECTED_FILE'</span>) {
        res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">'Too many files uploaded'</span>);
    }
})

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/ccc'</span>, upload.<span class="hljs-title function_">fields</span>([
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'aaa'</span>, <span class="hljs-attr">maxCount</span>: <span class="hljs-number">3</span> },
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'bbb'</span>, <span class="hljs-attr">maxCount</span>: <span class="hljs-number">2</span> }
]), <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.files'</span>, req.<span class="hljs-property">files</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'req.body'</span>, req.<span class="hljs-property">body</span>);
})


app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95f31046412e491bafc84786468bee53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771295240&amp;x-signature=TuO4ewhO4oqB%2Fw4a0QFANM8Bf2I%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于Elpis全栈框架，DSL模版引擎的一些个人思考]]></title>    <link>https://juejin.cn/post/7604701848150392832</link>    <guid>https://juejin.cn/post/7604701848150392832</guid>    <pubDate>2026-02-10T02:34:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604701848150392832" data-draft-id="7604493165329006626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于Elpis全栈框架，DSL模版引擎的一些个人思考"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-10T02:34:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懿生所爱"/> <meta itemprop="url" content="https://juejin.cn/user/1830001704964680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于Elpis全栈框架，DSL模版引擎的一些个人思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1830001704964680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懿生所爱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:34:05.000Z" title="Tue Feb 10 2026 02:34:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">关于Elpis全栈框架，DSL模版引擎的一些个人思考</h2>
<p>现阶段，大部分前端程序员的工作内容都比较枯燥，且进行一些无意义的苦力劳动，如下：</p>
<p>1.工作中大部分工作是重复性的CRUD
2.项目中存在大量的屎山代码，代码维护性差
3.代码程序逻辑性差，看起来很难理解</p>
<p>在Elpis中，将咱们程序员现阶段存在的一些痛点，进行的了整合，利用DSL领域模型，将沉淀当下程序员80%的重复性工作，将开发的精力放在20%的可扩展性的开发工作中。</p>
<h2 data-id="heading-1">关于DSL的设计</h2>
<p>1.在elpis项目中，DSL模版引擎的一些基础配置，配置如图：</p>
<pre><code class="hljs language-module.exports" lang="module.exports">      model: '', //模版类型，不同模版类型对应不一样的模版数据结构
      name: '',//模版名称
      desc:'',//模版描述
      icon:'',//模版图标
      menu: [
         {
          key: '', //菜单唯一标识
          name: '',//菜单名称
          menuType: '',//菜单类型，枚举值：group / module
          moduleType: '',// 枚举值：sider/iframe/custom/schema
          }，...]
       }
</code></pre>
<p>通过图中的模版配置，完成对页面的基础配置。
2.在完成对项目的基础配置之后，需要大模块下的小模块进行更细致的配置操作：
（1）当menuType为group的时候，会在当前菜单下产生子菜单，这里就需要递归去获取当前菜     单下的所有的子菜单进行展示</p>
<pre><code class="hljs language-ini" lang="ini">//当 <span class="hljs-attr">menuType</span> === group 时，可填
subMenu: <span class="hljs-section">[{
// 可递归 menuItem
          }]</span>,
</code></pre>
<p>（2）当moduleType为schema时，说明这部分为咱们需要沉淀的80%的功能，在elpis项目中通过利用<a href="https://link.juejin.cn?target=https%3A%2F%2Fjson-schema.org%2Flearn%2Fgetting-started-step-by-step" target="_blank" title="https://json-schema.org/learn/getting-started-step-by-step" ref="nofollow noopener noreferrer">《JSON-SCHEMA》</a>工具完成相对应的配置：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//当 moduleType === schema 时</span>

schemaConfig: {

api:<span class="hljs-string">''</span>,<span class="hljs-comment">//数据源API（遵循 RESTFUL 规范）</span>

schema:{<span class="hljs-comment">//板块数据结构</span>

<span class="hljs-keyword">type</span>:<span class="hljs-string">'object'</span>,

properties:{

key:{

...schema,<span class="hljs-comment">//标准 scheam 配置</span>

<span class="hljs-keyword">type</span>:<span class="hljs-string">''</span>,<span class="hljs-comment">//字段类型</span>

label:<span class="hljs-string">''</span>,<span class="hljs-comment">//字段中文名</span>

<span class="hljs-comment">//字段在 table-bar 中的配置</span>

tableOption:{

...elTableColumnConfig,<span class="hljs-comment">//标准 el-table-column 配置</span>

toFixed:<span class="hljs-number">0</span>,<span class="hljs-comment">//保留几位小数</span>

visiable:<span class="hljs-literal">true</span>,<span class="hljs-comment">//默认为true(false时，表示不再表单中显示)</span>

},<span class="hljs-comment">//字段在 table中的相关配置</span>

<span class="hljs-comment">//字段在 search-bar 中的配置</span>

searchOption:{

...elComponentConfig,<span class="hljs-comment">//标准 el-form 配置</span>

comType:<span class="hljs-string">''</span>,<span class="hljs-comment">//配置组件类型</span>

<span class="hljs-keyword">default</span>:<span class="hljs-string">''</span>,<span class="hljs-comment">//默认值</span>
<span class="hljs-comment">//comType === 'select'</span>

enumList:[],

<span class="hljs-comment">//comType === 'dynamicSelect'</span>

api:<span class="hljs-string">''</span>

}

}

}

},

tableConfig: {

headerButtons:[{

label:<span class="hljs-string">''</span>,<span class="hljs-comment">//按钮中文名</span>

eventKey:<span class="hljs-string">''</span>,<span class="hljs-comment">//按钮事件名</span>

eventOption:{},<span class="hljs-comment">//按钮事件具体配置</span>

...elButtonConfig <span class="hljs-comment">//标准 el-button配置</span>

},{}],<span class="hljs-comment">//可以多个配置</span>

rowButtons:[{

label:<span class="hljs-string">''</span>,<span class="hljs-comment">//按钮中文名</span>

eventKey:<span class="hljs-string">''</span>,<span class="hljs-comment">//按钮事件名</span>

eventOption:{

<span class="hljs-comment">//当 eventKey === ‘remove’</span>

params:{

<span class="hljs-comment">//paramKey = 参数的键值</span>

<span class="hljs-comment">//rowValueKey = 参数值，格式为schema::tableKey ，到table 中找相应的字段</span>

paramKey:rowValueKey

}

},<span class="hljs-comment">//按钮事件具体配置</span>

...elButtonConfig <span class="hljs-comment">//标准 el-button配置</span>

},{}],<span class="hljs-comment">//可以多个配置</span>

},<span class="hljs-comment">//table 相关配置</span>
searchConfig:{},<span class="hljs-comment">//search-bar相关配置</span>
</code></pre>
<p>在这里可以看到，在elpis项目中，我们并不是去对每一个页面的各种组件，例如：table，searchBar组件等在每个页面进行重复性的开发，而是将各种组件进行了一个抽象的模版定义，这样我们可以通过对DSL模版引擎的配置，就可以完成对不同菜单下一些重复性的CURD工作就行耦合和沉淀，这样也让代码的可维护性提高。</p>
<h3 data-id="heading-2">总结</h3>
<p>在elpis项目中，通过DSL领域模型的概念，将前端程序员日常工作80%的工作进行了整合，而通过DSl将这80%的工作进行沉淀，只需要用户通过文档进行对应的配置即可展示想要的页面。在组件方面，并不是像前端程序员日常工作一样，将一些重复性的东西抽离出来变成一个组件进行调用，在elpis中我们通过DSL模版引擎，以及各类组件的解析器进行动态的渲染，而不是写死在页面上。</p>
<p>所以我觉得在elpis项目中DSL模版引擎的真正目的是为了培养程序员的框架思维，以及思考问题和不断学习的能力，这样才能让前端程序员在日常的工作中保持更高的竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise方法存档]]></title>    <link>https://juejin.cn/post/7604853010162712639</link>    <guid>https://juejin.cn/post/7604853010162712639</guid>    <pubDate>2026-02-10T02:42:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604853010162712639" data-draft-id="7604678037808594980" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise方法存档"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-10T02:42:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MQliferecord"/> <meta itemprop="url" content="https://juejin.cn/user/1139543665814600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise方法存档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1139543665814600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MQliferecord
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:42:49.000Z" title="Tue Feb 10 2026 02:42:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">Promise.all</h5>
<p>实现<code>Promise.all</code>方法：</p>
<ol>
<li>接收一个可迭代对象（如数组），返回一个新 Promise；</li>
<li>所有 Promise 都成功时，返回结果数组（顺序和输入一致）；</li>
<li>任意一个 Promise 失败时，立即返回该失败原因；</li>
<li>若输入为空数组，立即 resolve 空数组。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">myPromiseAll</span> = (<span class="hljs-params">arrFunc</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> resArr = [];
    <span class="hljs-keyword">let</span> len = arrFunc.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>;
    arrFunc.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(item).<span class="hljs-title function_">then</span>(
        <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          k++;
          resArr[index] = res;
          <span class="hljs-keyword">if</span> (k === len) {
            <span class="hljs-title function_">resolve</span>(resArr);
          }
        },
        <span class="hljs-function">(<span class="hljs-params">rej</span>) =&gt;</span> {
          <span class="hljs-title function_">reject</span>(rej);
        }
      );
    });
  });
};
<span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>), <span class="hljs-number">1000</span>));
<span class="hljs-keyword">const</span> p3 = <span class="hljs-number">3</span>; <span class="hljs-comment">// 非Promise值</span>

<span class="hljs-title function_">myPromiseAll</span>([p1, p2, p3])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"all res:"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res)); <span class="hljs-comment">// [1,2,3]</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"all err:"</span>, err);
  });
</code></pre>
<h5 data-id="heading-1">Promise.race</h5>
<p>实现<code>Promise.race</code>方法：</p>
<ol>
<li>接收可迭代对象，返回新 Promise；</li>
<li>第一个完成（成功 / 失败）的 Promise 的结果 / 原因，就是最终结果；</li>
<li>若输入为空数组，永远 pending</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyPromiseRace</span> = (<span class="hljs-params">arrFunc</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =&gt;</span> {
    arrFunc.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(item).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>{
        <span class="hljs-title function_">resolve</span>(res)
      },<span class="hljs-function"><span class="hljs-params">rej</span>=&gt;</span>{
        <span class="hljs-title function_">reject</span>(rej)
      })
    });   
  });
};

<span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>), <span class="hljs-number">1000</span>));
<span class="hljs-keyword">const</span> p3 = <span class="hljs-number">3</span>; <span class="hljs-comment">// 非Promise值</span>

<span class="hljs-keyword">const</span> p4 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'fail'</span>));
<span class="hljs-title class_">MyPromiseRace</span>([p1, p4]).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'all err:'</span>, err.<span class="hljs-property">message</span>); <span class="hljs-comment">// fail</span>
});
</code></pre>
<h5 data-id="heading-2">Promise.allSettled</h5>
<p>实现<code>Promise.allSettled</code>方法：</p>
<ol>
<li>接收可迭代对象，返回新 Promise；</li>
<li>所有 Promise 都完成（成功 / 失败）后，返回结果数组；</li>
<li>每个结果对象格式：<code>{ status: 'fulfilled', value: xxx }</code> 或 <code>{ status: 'rejected', reason: xxx }</code>；</li>
<li>空数组立即 resolve 空数组</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyPromiseAllSettled</span> = (<span class="hljs-params">arrFunc</span>)=&gt;{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>{
    <span class="hljs-keyword">let</span> len = arrFunc.<span class="hljs-property">length</span>
    <span class="hljs-keyword">let</span> resarr = []
    <span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>

    arrFunc.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item,index</span>)=&gt;</span>{
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(item).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>{
        k++
        resarr[index] = res
        <span class="hljs-keyword">if</span>(len === k){
          <span class="hljs-title function_">resolve</span>(resarr)
        }
      },<span class="hljs-function"><span class="hljs-params">rej</span>=&gt;</span>{
        k++
        resarr[index] = rej
        <span class="hljs-keyword">if</span>(len === k){
          <span class="hljs-title function_">resolve</span>(resarr)
        }
      })
    })
  })
}
<span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>), <span class="hljs-number">1000</span>));
<span class="hljs-keyword">const</span> p3 = <span class="hljs-number">3</span>; <span class="hljs-comment">// 非Promise值</span>

<span class="hljs-keyword">const</span> p4 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'fail'</span>));
<span class="hljs-title class_">MyPromiseAllSettled</span>([p1,p2,p3, p4]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'all err:'</span>, res); <span class="hljs-comment">// fail</span>
});
</code></pre>
<h5 data-id="heading-3">实现异步函数串行执行（基于 Promise）</h5>
<p>给定一个异步函数数组（每个函数返回 Promise），实现一个函数，让这些函数<strong>串行执行</strong>（前一个完成后，再执行后一个），最终返回所有结果的数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">AsyncPromiseArr</span> = (<span class="hljs-params">arrFunc</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-title function_">async</span>(resolve, reject) =&gt; {
    <span class="hljs-keyword">const</span> stack = [];
    <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> func <span class="hljs-keyword">of</span> arrFunc){
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">func</span>();
      stack.<span class="hljs-title function_">push</span>(res);
      i++
      <span class="hljs-keyword">if</span>(i === arrFunc.<span class="hljs-property">length</span>){
        <span class="hljs-title function_">resolve</span>(stack)
      }
    }
  });
};

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-comment">// 模拟异步函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">task1</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>), <span class="hljs-number">500</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title function_">task2</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">3</span>), <span class="hljs-number">1500</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title function_">task3</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>), <span class="hljs-number">100</span>));

<span class="hljs-title class_">AsyncPromiseArr</span>([task1, task2, task3]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'serial res:'</span>, res); <span class="hljs-comment">// [1,2,3]（执行顺序：task1→task2→task3）</span>
});
</code></pre>
<h5 data-id="heading-4">实现 Promise 超时封装</h5>
<p>实现一个函数<code>withTimeout(promise, timeout, errMsg)</code>：</p>
<ol>
<li>给 Promise 添加超时控制，若超过<code>timeout</code>毫秒未完成，返回 reject（错误信息为<code>errMsg</code>）；</li>
<li>若 Promise 在超时前完成，正常返回结果；</li>
<li>超时后终止等待（无需取消原 Promise，仅控制返回结果）。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">withTimeout</span> = (<span class="hljs-params">promise,timeout,errMsg</span>)=&gt;{
  <span class="hljs-keyword">const</span> promise1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>{
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span><span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(errMsg)),timeout)
  })
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([promise,promise1])
}

<span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">100</span>), <span class="hljs-number">500</span>));
<span class="hljs-title function_">withTimeout</span>(p1, <span class="hljs-number">1000</span>, <span class="hljs-string">'超时了'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'timeout res:'</span>, res); <span class="hljs-comment">// 100</span>
});

<span class="hljs-comment">// 超时场景</span>
<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">200</span>), <span class="hljs-number">1500</span>));
<span class="hljs-title function_">withTimeout</span>(p2, <span class="hljs-number">1000</span>, <span class="hljs-string">'超时了'</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'timeout err:'</span>, err.<span class="hljs-property">message</span>); <span class="hljs-comment">// 超时了</span>
});
</code></pre>
<h5 data-id="heading-5">实现一个防抖函数</h5>
<p>触发事件后，第一次触发立即执行，后续<strong>延迟 n 毫秒执行回调函数</strong>；如果在这 n 毫秒内再次触发事件，<strong>重置延迟时间</strong>，同时增加<code>cancel</code>方法支持手动取消</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">debounce_</span> = (<span class="hljs-params">fn,delay</span>)=&gt;{
  <span class="hljs-keyword">let</span> fn_
  <span class="hljs-keyword">const</span> debounceFunc = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>){
    <span class="hljs-keyword">if</span>(fn_){
      <span class="hljs-built_in">clearTimeout</span>(fn_)
    }<span class="hljs-keyword">else</span>{
      fn.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,...args)
    }
    fn_ = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
      fn.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,...args)
      fn_ = <span class="hljs-literal">null</span>
    },delay)
  }
  debounceFunc.<span class="hljs-property">cancel</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-title function_">clearImmediate</span>(fn_)
    fn_ = <span class="hljs-literal">null</span>
  }
  <span class="hljs-keyword">return</span> debounceFunc
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSearch</span>(<span class="hljs-params">val</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索：'</span>, val);
}

<span class="hljs-keyword">const</span> debouncedSearchImmediate = <span class="hljs-title function_">debounce_</span>(handleSearch, <span class="hljs-number">1000</span>);
<span class="hljs-title function_">debouncedSearchImmediate</span>(<span class="hljs-string">'a'</span>); <span class="hljs-comment">// 立即输出「搜索：a」</span>
<span class="hljs-title function_">debouncedSearchImmediate</span>(<span class="hljs-string">'ab'</span>); <span class="hljs-comment">// 500ms内触发，重置定时器（无输出）</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">debouncedSearchImmediate</span>(<span class="hljs-string">'abc'</span>); <span class="hljs-comment">// 500ms后触发，立即输出「搜索：abc」</span>
},<span class="hljs-number">2000</span>);

<span class="hljs-comment">// 测试取消功能</span>
<span class="hljs-keyword">const</span> debouncedCancel = <span class="hljs-title function_">debounce_</span>(handleSearch, <span class="hljs-number">500</span>);
<span class="hljs-title function_">debouncedCancel</span>(<span class="hljs-string">'test'</span>);
debouncedCancel.<span class="hljs-title function_">cancel</span>(); 
</code></pre>
<h5 data-id="heading-6">实现节流函数</h5>
<p>触发事件后，<strong>每隔 n 毫秒只能执行一次回调函数</strong>，无论期间触发多少次，都会按固定频率执行</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">throttle_</span> = (<span class="hljs-params">fn, delay</span>) =&gt; {
  <span class="hljs-keyword">let</span> timer;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (!timer) {
      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        fn.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, ...args);
        timer = <span class="hljs-literal">null</span>
      }, delay);
    }
  };
};
</code></pre>
<h5 data-id="heading-7">实现带 Promise 的防抖函数</h5>
<p>实现一个防抖函数<code>debounceWithPromise(fn, delay)</code>：</p>
<ol>
<li>触发后延迟<code>delay</code>毫秒执行函数；</li>
<li>重复触发时重置延迟；</li>
<li>函数执行结果通过 Promise 返回；</li>
<li>支持取消防抖（添加<code>cancel</code>方法）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再用旧版了！OpenClaw 2026.2.9 更新迁移避坑指南]]></title>    <link>https://juejin.cn/post/7604672395627544603</link>    <guid>https://juejin.cn/post/7604672395627544603</guid>    <pubDate>2026-02-10T02:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604672395627544603" data-draft-id="7604690250364157961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再用旧版了！OpenClaw 2026.2.9 更新迁移避坑指南"/> <meta itemprop="keywords" content="自动化运维,AIGC,机器人"/> <meta itemprop="datePublished" content="2026-02-10T02:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曹工不加班"/> <meta itemprop="url" content="https://juejin.cn/user/4336129588870957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再用旧版了！OpenClaw 2026.2.9 更新迁移避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4336129588870957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曹工不加班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:40:34.000Z" title="Tue Feb 10 2026 02:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么要更新/迁移?</h2>
<h3 data-id="heading-1">Clawdbot → OpenClaw 改名时间线</h3>
<p>2026年1月,项目经历三次改名:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">1月24日: Peter Steinberger 发布 Clawdbot</span>
<span class="hljs-section">1月26日: Anthropic 发律师函(商标问题)</span>
<span class="hljs-section">1月27日: 紧急改名 Moltbot</span>
<span class="hljs-section">1月29日: 最终定名 OpenClaw</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f2780d7dee249768950efb3afb92514~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771296034&amp;x-signature=M62%2F%2FhR5NONC%2Bb4pFtWO%2FCvUyvg%3D" alt="Clawdbot三次改名时间轴" loading="lazy"/></p>
<p>虽然旧命令 <code>clawdbot</code> 仍可用,但新功能、安全更新和 bug 修复只在 OpenClaw 维护。</p>
<h3 data-id="heading-2">更新/迁移的理由</h3>
<p><strong>1. QMD 记忆系统</strong>(2026.2.2+)</p>
<p>Shopify CEO Tobi 开发的本地语义搜索引擎,已集成到 OpenClaw:</p>
<ul>
<li>Token 削减 60-97%</li>
<li>响应速度提升 5-50 倍</li>
<li>完全免费,零 API 成本</li>
<li>自动降级到 SQLite(QMD 失败时)</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7e1ef116642409e896e7451ccb609bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771296034&amp;x-signature=T7IMtsfCGEJ8WD%2Fxd68WpoPpkYw%3D" alt="QMD记忆系统架构" loading="lazy"/></p>
<p><strong>2. 新模型支持</strong></p>
<ul>
<li>Anthropic Opus 4.6</li>
<li>OpenAI GPT-5.3-codex</li>
<li>xAI Grok(含网络搜索)</li>
</ul>
<p><strong>3. 安全增强</strong></p>
<p>OpenClaw 与 VirusTotal 合作扫描 ClawHub 技能,Code Insight(Gemini 驱动)自动分析技能包:</p>
<ul>
<li>✅ <code>benign</code>: 自动通过</li>
<li>⚠️ <code>suspicious</code>: 显示警告</li>
<li>❌ <code>malicious</code>: 阻止下载</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9727649a6544aedb43668921387aeb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771296034&amp;x-signature=nOTvwYvUQ8gBWFh4jjky1KRvx0E%3D" alt="VirusTotal安全扫描流程" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">OpenClaw 最新版本特性</h2>
<h3 data-id="heading-4">当前版本</h3>
<p><strong>v2026.2.9</strong>(2026年2月10日)</p>
<h3 data-id="heading-5">v2026.2.9 新特性</h3>
<ul>
<li>🔍 <strong>Grok 网络搜索提供商</strong>: 集成 xAI Grok 作为网络搜索后端</li>
<li>🧠 <strong>解决压缩后遗忘</strong>: 修复记忆压缩后的上下文丢失问题</li>
<li>🛡️ <strong>上下文溢出恢复</strong>: 自动处理超长对话的上下文管理</li>
<li>⏰ <strong>Cron 可靠性大修</strong>: 定时任务执行更加稳定</li>
<li>🐛 <strong>40+ bug 修复</strong>: 来自 25+ 贡献者的质量改进</li>
<li>🌐 <strong>Web UI 增强</strong>: 代理管理 RPC 方法、压缩分隔符显示</li>
<li>📱 <strong>Telegram 优化</strong>: 引用解析增强、Markdown Spoiler 支持</li>
</ul>
<h3 data-id="heading-6">核心优势</h3>
<p><strong>🧠 QMD 记忆系统</strong>: 本地语义搜索(BM25 + 向量搜索 + LLM 重排序),Token 削减 60-97%,响应速度提升 5-50 倍</p>
<p><strong>🤖 最新模型支持</strong>: Opus 4.6、GPT-5.3-codex、Grok(含网络搜索),支持前向兼容降级</p>
<p><strong>🛡️ 增强安全</strong>: VirusTotal 技能扫描、网关认证、会话历史负载限制</p>
<hr/>
<h2 data-id="heading-7">更新 OpenClaw 到最新版本</h2>
<blockquote>
<p>适用于已在使用 OpenClaw 的用户</p>
</blockquote>
<h3 data-id="heading-8">检查当前版本</h3>
<pre><code class="hljs language-bash" lang="bash">openclaw --version
</code></pre>
<p>低于 v2026.2.9 建议更新。</p>
<h3 data-id="heading-9">备份数据(可选但推荐)</h3>
<p><strong>macOS/Linux:</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/openclaw-backup-$(<span class="hljs-built_in">date</span> +%Y%m%d)
<span class="hljs-built_in">cp</span> -r ~/.openclaw ~/openclaw-backup-$(<span class="hljs-built_in">date</span> +%Y%m%d)/
<span class="hljs-built_in">cp</span> -r ~/clawd ~/openclaw-backup-$(<span class="hljs-built_in">date</span> +%Y%m%d)/
</code></pre>
<p><strong>Windows:</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">$date = Get-Date -Format "yyyyMMdd"
mkdir "$HOME\openclaw-backup-$date"
Copy-Item "$HOME\.openclaw" -Destination "$HOME\openclaw-backup-$date\" -Recurse
Copy-Item "$HOME\clawd" -Destination "$HOME\openclaw-backup-$date\" -Recurse
</code></pre>
<h3 data-id="heading-10">执行更新</h3>
<p><strong>方式一: Shell 脚本(推荐)</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux</span>
curl -fsSL https://openclaw.ai/install.sh | bash

<span class="hljs-comment"># Windows</span>
iwr -useb https://openclaw.ai/install.ps1 | iex
</code></pre>
<p><strong>方式二: npm</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install -g openclaw@latest

<span class="hljs-comment"># 或使用 pnpm</span>
pnpm add -g openclaw@latest
</code></pre>
<p>更新过程会自动保留 <code>~/.openclaw</code> 和 <code>~/clawd</code>,只更新可执行文件。</p>
<h3 data-id="heading-11">验证更新</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查版本</span>
openclaw --version

<span class="hljs-comment"># 检查服务</span>
openclaw gateway status

<span class="hljs-comment"># 测试功能</span>
openclaw chat
</code></pre>
<h3 data-id="heading-12">更新后操作(可选,推荐)</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启用 QMD 记忆系统(需要 Bun)</span>
bun install -g https://github.com/tobi/qmd
<span class="hljs-comment"># 编辑 ~/.openclaw/openclaw.json,设置 memory.qmd.sessions.enabled = true</span>

<span class="hljs-comment"># 更新技能库</span>
openclaw skills update
</code></pre>
<hr/>
<h2 data-id="heading-13">从 Clawdbot 迁移到 OpenClaw</h2>
<blockquote>
<p><strong>警告</strong>: 先停止 Clawdbot 服务再安装 OpenClaw!</p>
<p>两者都使用 18789 端口,但 gateway token 不同。不停服直接安装会导致:</p>
<ul>
<li>端口冲突(双服务争抢端口)</li>
<li>401 认证错误(token 不匹配)</li>
<li>服务不稳定</li>
</ul>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e3a907182f54468a855e8a0bbe747cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771296034&amp;x-signature=fv3okDcAiZT1maMMjRRDAn%2FafRI%3D" alt="双服务端口冲突警告" loading="lazy"/></p>
<h3 data-id="heading-14">配置文件夹对比</h3>






























<table><thead><tr><th>项目</th><th>Clawdbot</th><th>OpenClaw</th></tr></thead><tbody><tr><td>配置文件夹</td><td><code>~/.clawdbot</code></td><td><code>~/.openclaw</code></td></tr><tr><td>配置文件</td><td><code>moltbot.json</code></td><td><code>openclaw.json</code></td></tr><tr><td>工作区</td><td><code>~/clawd</code></td><td><code>~/clawd</code>(相同)</td></tr><tr><td>端口</td><td>18789</td><td>18789(相同)</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6ea35711924352b411f57e21b50275~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771296034&amp;x-signature=STbheMpWZKH4UfcVPmM2UKABahQ%3D" alt="配置文件夹对比" loading="lazy"/></p>
<p>OpenClaw 安装时会自动迁移配置,创建符号链接 <code>~/.clawdbot -&gt; ~/.openclaw</code>,但<strong>不会自动清理旧服务</strong>。</p>
<h3 data-id="heading-15">迁移步骤</h3>
<h4 data-id="heading-16">停止 Clawdbot 服务</h4>
<p><strong>macOS/Linux:</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止网关</span>
clawdbot gateway stop

<span class="hljs-comment"># Linux systemd 用户</span>
systemctl --user stop clawdbot-gateway.service
systemctl --user <span class="hljs-built_in">disable</span> clawdbot-gateway.service
<span class="hljs-built_in">rm</span> -f ~/.config/systemd/user/clawdbot-gateway.service
systemctl --user daemon-reload
systemctl --user reset-failed

<span class="hljs-comment"># 清理残留进程</span>
pkill -f clawdbot

<span class="hljs-comment"># 验证端口已释放</span>
lsof -i :18789
<span class="hljs-comment"># 应该无输出</span>
</code></pre>
<p><strong>Windows:</strong></p>
<pre><code class="hljs language-powershell" lang="powershell"># 停止服务
clawdbot gateway stop

# 检查端口
netstat -ano | findstr :18789

# 如果仍被占用,终止进程(替换 &lt;PID&gt;)
# taskkill /PID &lt;PID&gt; /F

# 或强制终止所有 node 进程
taskkill /IM node.exe /F
</code></pre>
<h4 data-id="heading-17">备份数据(推荐)</h4>
<p><strong>macOS/Linux:</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/openclaw-backup-$(<span class="hljs-built_in">date</span> +%Y%m%d)
<span class="hljs-built_in">cp</span> -r ~/.clawdbot ~/openclaw-backup-$(<span class="hljs-built_in">date</span> +%Y%m%d)/
<span class="hljs-built_in">cp</span> -r ~/clawd ~/openclaw-backup-$(<span class="hljs-built_in">date</span> +%Y%m%d)/
</code></pre>
<p><strong>Windows:</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">$date = Get-Date -Format "yyyyMMdd"
mkdir "$HOME\openclaw-backup-$date"
Copy-Item "$HOME\.clawdbot" -Destination "$HOME\openclaw-backup-$date\" -Recurse
Copy-Item "$HOME\clawd" -Destination "$HOME\openclaw-backup-$date\" -Recurse
</code></pre>
<h4 data-id="heading-18">安装 OpenClaw</h4>
<p><strong>macOS/Linux:</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://openclaw.ai/install.sh | bash
</code></pre>
<p><strong>Windows:</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">iwr -useb https://openclaw.ai/install.ps1 | iex
</code></pre>
<p>安装过程自动迁移配置、创建符号链接并保留工作区。</p>
<h4 data-id="heading-19">验证迁移</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway status         <span class="hljs-comment"># 确认服务运行</span>
lsof -i :18789                  <span class="hljs-comment"># 验证只有一个 openclaw 进程</span>
openclaw chat                   <span class="hljs-comment"># 测试记忆完整性</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6af135e06014d7596751a1668331639~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771296034&amp;x-signature=lXC9bJIWKQpPTyhuHksuuIYaM%2FQ%3D" alt="完整迁移流程" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-20">迁移常见问题</h2>
<h3 data-id="heading-21">迁移会丢失记忆吗?</h3>
<p>不会。OpenClaw 完全兼容 Clawdbot 数据格式:</p>
<ul>
<li>对话历史: <code>~/clawd/</code> 下所有文件</li>
<li>配置信息: 自动从 <code>~/.clawdbot</code> 迁移到 <code>~/.openclaw</code></li>
<li>Agent 状态: 完整保留</li>
</ul>
<h3 data-id="heading-22">.clawdbot 文件夹还在,正常吗?</h3>
<p>正常。OpenClaw 创建符号链接 <code>~/.clawdbot -&gt; ~/.openclaw</code> 保持向后兼容。</p>
<p>验证:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> -la ~/.clawdbot
<span class="hljs-comment"># 应显示符号链接</span>
</code></pre>
<h3 data-id="heading-23">Dashboard 显示 401 认证错误?</h3>
<p>这是双服务运行的典型症状。两个服务用不同的 gateway token,导致认证失败。</p>
<p>解决:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止所有服务</span>
clawdbot gateway stop
openclaw gateway stop

<span class="hljs-comment"># 清理进程</span>
pkill -f clawdbot
pkill -f openclaw

<span class="hljs-comment"># 只启动 OpenClaw</span>
openclaw gateway start

<span class="hljs-comment"># 清理浏览器缓存或用无痕模式</span>
</code></pre>
<p>验证:</p>
<pre><code class="hljs language-bash" lang="bash">lsof -i :18789
<span class="hljs-comment"># 应该只看到一个 openclaw 进程</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11fcc5ca22994d7aa24b732068fc2667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771296034&amp;x-signature=uQWrUMI2CUmxIAdFZJI99vdYu8Y%3D" alt="401认证错误诊断与解决" loading="lazy"/></p>
<h3 data-id="heading-24">端口 18789 被占用?</h3>
<p>Clawdbot 服务没有完全清理。</p>
<p><strong>macOS/Linux:</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看占用进程</span>
lsof -i :18789

<span class="hljs-comment"># 强制终止</span>
lsof -ti :18789 | xargs <span class="hljs-built_in">kill</span> -9

<span class="hljs-comment"># 清理 systemd(Linux)</span>
systemctl --user stop clawdbot-gateway.service
systemctl --user <span class="hljs-built_in">disable</span> clawdbot-gateway.service
<span class="hljs-built_in">rm</span> -f ~/.config/systemd/user/clawdbot-gateway.service
systemctl --user daemon-reload

<span class="hljs-comment"># 再次验证</span>
lsof -i :18789
</code></pre>
<p><strong>Windows:</strong></p>
<pre><code class="hljs language-powershell" lang="powershell"># 查看端口占用
netstat -ano | findstr :18789

# 终止进程
taskkill /PID &lt;PID&gt; /F

# 或强制终止所有 node
taskkill /IM node.exe /F
</code></pre>
<h3 data-id="heading-25">需要重新配置飞书/钉钉吗?</h3>
<p>不需要。配置会自动迁移,包括:</p>
<ul>
<li>Webhook URLs</li>
<li>机器人 Token</li>
<li>频道配置</li>
</ul>
<p>验证:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> ~/.openclaw/openclaw.json | grep -A 5 <span class="hljs-string">"channels"</span>
</code></pre>
<h3 data-id="heading-26">旧的 clawdbot 命令还能用吗?</h3>
<p>能用(符号链接),但新功能只在 <code>openclaw</code> 命令下提供。<strong>切勿同时运行两个服务。</strong></p>
<h3 data-id="heading-27">迁移后性能没有提升?</h3>
<p>性能提升主要来自 QMD 记忆系统,需手动启用:</p>
<pre><code class="hljs language-bash" lang="bash">bun install -g https://github.com/tobi/qmd
<span class="hljs-comment"># 编辑 ~/.openclaw/openclaw.json</span>
<span class="hljs-comment"># 设置 memory.qmd.sessions.enabled = true</span>
</code></pre>
<h3 data-id="heading-28">如何完全卸载 Clawdbot?</h3>
<p>迁移成功并稳定运行后:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确认 OpenClaw 正常</span>
openclaw gateway status

<span class="hljs-comment"># 卸载 Clawdbot(npm 安装的)</span>
npm uninstall -g clawdbot

<span class="hljs-comment"># 删除符号链接(可选)</span>
<span class="hljs-built_in">rm</span> ~/.clawdbot

<span class="hljs-comment"># 清理 systemd(Linux)</span>
<span class="hljs-built_in">rm</span> -f ~/.config/systemd/user/clawdbot-gateway.service
systemctl --user daemon-reload
</code></pre>
<p>注意: 不要删除 <code>~/.openclaw</code>,它是主配置文件夹。</p>
<hr/>
<h2 data-id="heading-29">故障排查</h2>
<h3 data-id="heading-30">常见问题快速解决</h3>
<p><strong>服务启动失败</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw status --all    <span class="hljs-comment"># 一键诊断</span>
openclaw doctor --fix    <span class="hljs-comment"># 自动修复</span>
</code></pre>
<p><strong>Dashboard 无法加载</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway status
curl http://localhost:18789/health
<span class="hljs-comment"># 清理浏览器缓存或使用无痕模式</span>
</code></pre>
<p><strong>记忆丢失</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw memory reindex  <span class="hljs-comment"># QMD 用户</span>
</code></pre>
<p><strong>命令不识别</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">which</span> openclaw
<span class="hljs-built_in">hash</span> -r                  <span class="hljs-comment"># 清理命令缓存</span>
<span class="hljs-built_in">source</span> ~/.zshrc          <span class="hljs-comment"># 重新加载配置</span>
</code></pre>
<h3 data-id="heading-31">诊断命令速查</h3>
<p>五步诊断流程:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 一键诊断报告</span>
openclaw status --all

<span class="hljs-comment"># 2. 检查连接</span>
openclaw gateway status

<span class="hljs-comment"># 3. 自动修复(成功率 60%)</span>
openclaw doctor --fix

<span class="hljs-comment"># 4. 检查事件流</span>
openclaw channels status --probe

<span class="hljs-comment"># 5. 实时日志</span>
openclaw logs --follow
</code></pre>
<p><code>openclaw status</code> 和 <code>openclaw doctor</code> 的区别:</p>
<ul>
<li><code>status</code>: 报告当前状态(正在运行什么)</li>
<li><code>doctor</code>: 分析配置正确性(配置是否有误)</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7fe640ecc8c46c7a0a4f97f18c75bdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55bel5LiN5Yqg54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771296034&amp;x-signature=cCiRfqUAqfEW3jNbofj4axoM%2BcI%3D" alt="五步诊断流程" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-32">获取帮助</h2>
<h3 data-id="heading-33">官方资源</h3>
<ul>
<li><strong>官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai" target="_blank" title="https://docs.openclaw.ai" ref="nofollow noopener noreferrer">docs.openclaw.ai</a></li>
<li><strong>GitHub Issues</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw%2Fissues" target="_blank" title="https://github.com/openclaw/openclaw/issues" ref="nofollow noopener noreferrer">github.com/openclaw/op…</a></li>
<li><strong>GitHub Discussions</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw%2Fdiscussions" target="_blank" title="https://github.com/openclaw/openclaw/discussions" ref="nofollow noopener noreferrer">github.com/openclaw/op…</a></li>
</ul>
<h3 data-id="heading-34">提问时包含</h3>
<p><strong>系统信息:</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw --version
<span class="hljs-built_in">uname</span> -a  <span class="hljs-comment"># Linux/macOS</span>
</code></pre>
<p><strong>错误日志:</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw logs --<span class="hljs-built_in">tail</span> 50
</code></pre>
<p><strong>配置信息(隐藏敏感数据):</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> ~/.openclaw/openclaw.json | jq <span class="hljs-string">'del(.auth, .tokens)'</span>
</code></pre>
<p><strong>诊断结果:</strong></p>
<pre><code class="hljs language-bash" lang="bash">openclaw doctor
</code></pre>
<hr/>
<h2 data-id="heading-35">总结</h2>
<h3 data-id="heading-36">快速更新(3分钟)</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux</span>
curl -fsSL https://openclaw.ai/install.sh | bash

<span class="hljs-comment"># Windows</span>
iwr -useb https://openclaw.ai/install.ps1 | iex
</code></pre>
<h3 data-id="heading-37">迁移关键</h3>
<p>⚠️ <strong>先停 Clawdbot 服务,再安装 OpenClaw</strong>。配置和记忆完整保留。</p>
<h3 data-id="heading-38">更新后推荐操作</h3>
<ol>
<li>启用 QMD 记忆系统(性能提升 5-50 倍)</li>
<li>更新技能库: <code>openclaw skills update</code></li>
</ol>
<p><strong>关注公众号“曹工不加班”，加入 AGI 交流群，一起走向 AGI</strong></p>
<hr/>
<p><strong>官方资源:</strong></p>
<ul>
<li><strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenclaw.ai" target="_blank" title="https://openclaw.ai" ref="nofollow noopener noreferrer">openclaw.ai</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw" target="_blank" title="https://github.com/openclaw/openclaw" ref="nofollow noopener noreferrer">github.com/openclaw/op…</a></li>
<li><strong>文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai" target="_blank" title="https://docs.openclaw.ai" ref="nofollow noopener noreferrer">docs.openclaw.ai</a></li>
<li><strong>QMD 项目</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftobi%2Fqmd" target="_blank" title="https://github.com/tobi/qmd" ref="nofollow noopener noreferrer">github.com/tobi/qmd</a></li>
</ul>
<p><strong>参考资料:</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw%2Freleases%2Ftag%2Fv2026.2.9" target="_blank" title="https://github.com/openclaw/openclaw/releases/tag/v2026.2.9" ref="nofollow noopener noreferrer">OpenClaw v2026.2.9 发布说明</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2Finstall%2Fmigrating" target="_blank" title="https://docs.openclaw.ai/install/migrating" ref="nofollow noopener noreferrer">OpenClaw Migration Guide</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2Fgateway%2Ftroubleshooting" target="_blank" title="https://docs.openclaw.ai/gateway/troubleshooting" ref="nofollow noopener noreferrer">OpenClaw Troubleshooting</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2Fconcepts%2Fmemory" target="_blank" title="https://docs.openclaw.ai/concepts/memory" ref="nofollow noopener noreferrer">QMD 内存系统文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthehackernews.com%2F2026%2F02%2Fopenclaw-integrates-virustotal-scanning.html" target="_blank" title="https://thehackernews.com/2026/02/openclaw-integrates-virustotal-scanning.html" ref="nofollow noopener noreferrer">OpenClaw 与 VirusTotal 合作</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue vs React：当“动态包裹器”需求遇上两种框架哲学]]></title>    <link>https://juejin.cn/post/7604761524976582665</link>    <guid>https://juejin.cn/post/7604761524976582665</guid>    <pubDate>2026-02-10T02:58:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604761524976582665" data-draft-id="7604672395627724827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue vs React：当“动态包裹器”需求遇上两种框架哲学"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-10T02:58:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="再吃一根胡萝卜"/> <meta itemprop="url" content="https://juejin.cn/user/871275323725533"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue vs React：当“动态包裹器”需求遇上两种框架哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/871275323725533/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    再吃一根胡萝卜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:58:02.000Z" title="Tue Feb 10 2026 02:58:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文从一个实际开发案例出发，对比 Vue 和 React 在处理“动态包裹器”需求时的不同实现方式。通过这个具体例子，初学者可以直观感受两个框架设计哲学的差异。</p>
</blockquote>
<h2 data-id="heading-0">问题场景：一个表单生成器组件</h2>
<p>假设我们要开发一个表单生成器组件，它需要满足这样的需求：</p>
<ul>
<li>默认情况下，每个表单项直接渲染</li>
<li>但有时需要在外层包裹一个布局组件（比如栅格布局的 <code>&lt;a-col&gt;</code>）</li>
<li>甚至有时需要包裹一个提示组件（比如 <code>&lt;a-tooltip&gt;</code>）</li>
</ul>
<p>用人类语言描述就是：“如果给了包裹器，就用包裹器包一下；如果没给，就直接渲染。”</p>
<h2 data-id="heading-1">React 的实现：自然的 JavaScript 思维</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// FormGenerator.jsx</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">FormGenerator</span>(<span class="hljs-params">{ wrapper: Wrapper, items }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      {items.map(item =&gt; (
        // 核心逻辑：如果给了 Wrapper 就包裹，否则直接渲染
        Wrapper ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">Wrapper</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Wrapper</span>&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> /&gt;</span>
        )
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// 使用方式 1：传入组件</span>
&lt;<span class="hljs-title class_">FormGenerator</span> 
  wrapper={<span class="hljs-title class_">Col</span>}  <span class="hljs-comment">// 直接传组件引用</span>
  items={formItems}
/&gt;

<span class="hljs-comment">// 使用方式 2：传入自定义渲染函数</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FormGenerator</span>
  <span class="hljs-attr">wrapper</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">children</span> }) =&gt;</span> (
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Tooltip</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"提示"</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Tooltip</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  )}
  items={formItems}
/&gt;</span>
</code></pre>
<p>​<strong>为什么 React 这么简单？​</strong>​<br/>
因为 React 的 JSX 本质上就是 JavaScript 函数调用：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// JSX 最终会被编译成这样的函数调用</span>
React.<span class="hljs-title function_ invoke__">createElement</span>(Wrapper, { <span class="hljs-attr">key</span>: item.id }, 
  React.<span class="hljs-title function_ invoke__">createElement</span>(FormItem, { item })
)
</code></pre>
<p>所以你用 <code>Wrapper ? &lt;Wrapper&gt; : &lt;FormItem&gt;</code> 这种三目运算符，就像写普通 JavaScript 条件判断一样自然。</p>
<h2 data-id="heading-2">Vue 的实现：模板语法的挑战与解决方案</h2>
<h3 data-id="heading-3">方案一：使用动态组件（相对简单）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- FormGenerator.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in items"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 如果有包裹器 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">component</span> 
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"wrapper"</span> 
        <span class="hljs-attr">:is</span>=<span class="hljs-string">"wrapper"</span> 
        <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"wrapperProps"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"before"</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form-item</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"after"</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span>
      
      <span class="hljs-comment">&lt;!-- 如果没有包裹器 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-else</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"before"</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form-item</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"after"</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">wrapper</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">String</span>], <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span> },
  <span class="hljs-attr">wrapperProps</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> ({}) }
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 使用方式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form-generator</span>
    <span class="hljs-attr">:wrapper</span>=<span class="hljs-string">"Col"</span>
    <span class="hljs-attr">:wrapper-props</span>=<span class="hljs-string">"{ span: 12 }"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">方案二：使用作用域插槽（更灵活）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- FormGenerator.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in items"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 把渲染控制权交给父组件 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> 
        <span class="hljs-attr">name</span>=<span class="hljs-string">"item"</span> 
        <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span>
        <span class="hljs-attr">:default</span>=<span class="hljs-string">"() =&gt; h(FormItem, { item })"</span>
      &gt;</span>
        <span class="hljs-comment">&lt;!-- 默认内容 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form-item</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 使用方式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form-generator</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 自己控制如何包裹 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">item</span>=<span class="hljs-string">"{ item, default: defaultContent }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a-col</span> <span class="hljs-attr">:span</span>=<span class="hljs-string">"6"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a-tooltip</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"这是提示"</span>&gt;</span>
          {{ defaultContent() }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">a-tooltip</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">a-col</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form-generator</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h2 data-id="heading-5">对比分析</h2>
<h3 data-id="heading-6">React 的优势</h3>
<ol>
<li>​<strong>思维一致性</strong>​：条件渲染、循环渲染都是 JavaScript 逻辑，不需要学习额外语法</li>
<li>​<strong>灵活性高</strong>​：可以传组件引用、可以传函数、甚至可以现场创建组件</li>
<li>​<strong>代码简洁</strong>​：一个三目运算符搞定所有逻辑</li>
</ol>
<h3 data-id="heading-7">Vue 的优势</h3>
<ol>
<li>​<strong>模板直观</strong>​：<code>v-if</code>、<code>v-for</code> 指令让模板结构清晰易读</li>
<li>​<strong>插槽系统</strong>​：作用域插槽提供了强大的内容分发能力</li>
<li>​<strong>渐进式学习</strong>​：简单的用 <code>v-if</code>，复杂的用插槽，总有解决方案</li>
</ol>
<h3 data-id="heading-8">为什么会有这种差异？</h3>
<p>​<strong>React 认为</strong>​：UI 是状态的函数，渲染逻辑就应该用 JavaScript 表达。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 的哲学：用 JavaScript 描述 UI</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderUI</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">loading</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Loading</span> /&gt;</span></span>
  }
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Content</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{state.data}</span> /&gt;</span></span>
}
</code></pre>
<p>​<strong>Vue 认为</strong>​：模板和逻辑应该分离，模板负责结构，JavaScript 负责逻辑。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Vue 的哲学：模板描述结构，脚本处理逻辑 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Loading</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h2 data-id="heading-9">给初学者的建议</h2>
<ol>
<li>
<p>​<strong>如果你刚刚入门</strong>​：</p>
<ul>
<li>先学 Vue，因为它的模板语法更直观，更容易看到“代码如何变成页面”</li>
<li>把 Vue 的 <code>v-if</code>、<code>v-for</code>、插槽这些概念学扎实</li>
</ul>
</li>
<li>
<p>​<strong>当你熟悉 Vue 后想学 React</strong>​：</p>
<ul>
<li>忘掉“模板”思维，接受“一切都是 JavaScript”的理念</li>
<li>练习用 JavaScript 的三目运算符、<code>map</code>、<code>filter</code> 来处理 UI 逻辑</li>
</ul>
</li>
<li>
<p>​<strong>实际项目中如何选择</strong>​：</p>
<ul>
<li>如果项目有很多<strong>动态的、条件复杂的 UI</strong>​ → 考虑 React</li>
<li>如果项目主要是<strong>表单、表格、固定布局</strong>​ → 考虑 Vue</li>
<li>看团队熟悉哪个框架，就用哪个</li>
</ul>
</li>
</ol>
<h2 data-id="heading-10">一个更简单的例子</h2>
<p>最后用一个更简单的例子结束这个讨论：</p>
<p>​<strong>需求</strong>​：根据用户是否登录显示不同内容</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React：就是 JavaScript 条件判断</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params">{ user }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {user ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>欢迎回来，{user.name}！<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Vue：模板指令 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"user"</span>&gt;</span>欢迎回来，{{ user.name }}！<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-else</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>​<strong>你看，React 让你用 JavaScript 写 UI，Vue 让你用“增强的 HTML”写 UI。​</strong>​ 没有绝对的好坏，只有适不适合你的思维方式和项目需求。</p>
<p>希望这个对比能帮助你理解两者的差异！在实际开发中，两个框架都能很好地完成任务，关键是理解它们的设计哲学，然后选择最适合你和团队的那一个。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最短连续子串]]></title>    <link>https://juejin.cn/post/7604694326518792243</link>    <guid>https://juejin.cn/post/7604694326518792243</guid>    <pubDate>2026-02-10T02:50:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604694326518792243" data-draft-id="7604786493638328347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最短连续子串"/> <meta itemprop="keywords" content="JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2026-02-10T02:50:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最短连续子串
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T02:50:17.000Z" title="Tue Feb 10 2026 02:50:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">问题</h3>
<p>给两个字符串：</p>
<ul>
<li><code>s</code>：主串（比如 <code>"ADOBECODEBANC"</code>）</li>
<li><code>t</code>：目标串（比如 <code>"ABC"</code>）</li>
</ul>
<p>找出 <strong><code>s</code> 中最短的连续子串</strong>，使得这个子串 <strong>包含 <code>t</code> 中所有字符（包括重复次数）</strong> 。</p>
<blockquote>
<p>比如 <code>t = "AAB"</code>，那子串里至少要有 2 个 <code>'A'</code> 和 1 个 <code>'B'</code>。</p>
</blockquote>
<p>如果找不到，返回空字符串 <code>""</code>。</p>
<hr/>
<h2 data-id="heading-1">核心思想：滑动窗口（双指针）</h2>
<p>想象一个<strong>可伸缩的窗口</strong>在 <code>s</code> 上滑动：</p>
<p><strong>右指针（right）</strong> ：不断向右扩展，把字符“吃进来”</p>
<p><strong>左指针（left）</strong> ：当窗口已经“满足条件”时，尝试向右收缩，看看能不能变得更短</p>
<p>我们的目标是：<strong>在所有“满足条件”的窗口中，找到长度最小的那个</strong>。</p>
<hr/>
<h2 data-id="heading-2"><code>cnt</code> 数组 + <code>less</code> 变量</h2>
<h3 data-id="heading-3">1. <code>cnt</code> 数组（大小 128）</h3>
<p>用来记录 <strong>每个字符还需要多少个</strong>。</p>
<p>初始时，根据 <code>t</code> 设置需求：</p>
<p>比如 <code>t = "ABC"</code> → <code>cnt[65] = 1</code>（'A'），<code>cnt[66] = 1</code>（'B'），<code>cnt[67] = 1</code>（'C'）</p>
<p>当我们在 <code>s</code> 中遇到某个字符，就 <strong>减 1</strong>（表示“我提供了一个”）</p>
<p>如果 <code>cnt[c]</code> 从 <code>1</code> 变成 <code>0</code> → 这个字符的需求刚好满足</p>
<p>如果变成负数（比如 <code>-1</code>）→ 这个字符多出来了（冗余）</p>
<h3 data-id="heading-4">2. <code>less</code> 变量</h3>
<p>表示 <strong>还有多少种字符没有满足需求</strong>。</p>
<p>初始值 = <code>t</code> 中<strong>不同字符的种类数</strong>（不是总长度！）</p>
<p><code>t = "AAB"</code> → 有 <code>'A'</code> 和 <code>'B'</code> 两种 → <code>less = 2</code></p>
<p>每当某个字符的需求从 <code>&gt;0</code> 变成 <code>0</code>，<code>less--</code></p>
<p>当 <code>less === 0</code> → 所有字符都满足了！🎉</p>
<hr/>
<h2 data-id="heading-5">🚶 算法步骤详解（配合你的代码）</h2>
<h3 data-id="heading-6">第一步：初始化需求</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> c <span class="hljs-keyword">of</span> t) {
    <span class="hljs-keyword">const</span> code = c.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (cnt[code] === <span class="hljs-number">0</span>) less++; <span class="hljs-comment">// 第一次见到这个字符</span>
    cnt[code]++;                 <span class="hljs-comment">// 记录需要多少个</span>
}
</code></pre>
<p>✅ 此时 <code>cnt</code> 存的是“还需要多少”，<code>less</code> 是“还差几种”。</p>
<hr/>
<h3 data-id="heading-7">第二步：滑动窗口遍历 <code>s</code></h3>
<h4 data-id="heading-8">右指针扩展（吃进新字符）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> c = s[right].<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
cnt[c]--; <span class="hljs-comment">// 提供了一个 c，所以需求减少</span>
<span class="hljs-keyword">if</span> (cnt[c] === <span class="hljs-number">0</span>) less--; <span class="hljs-comment">// 如果刚好满足，种类数减一</span>
</code></pre>
<h4 data-id="heading-9">左指针收缩（当窗口合法时）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">while</span> (less === <span class="hljs-number">0</span>) { <span class="hljs-comment">// 当前窗口已覆盖 t</span>
    <span class="hljs-comment">// 更新答案：如果当前窗口更短，就记录</span>
    <span class="hljs-keyword">if</span> (right - left &lt; ansRight - ansLeft) {
        ansLeft = left;
        ansRight = right;
    }

    <span class="hljs-comment">// 尝试移除左边字符</span>
    <span class="hljs-keyword">const</span> x = s[left].<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (cnt[x] === <span class="hljs-number">0</span>) less++; <span class="hljs-comment">// 移除后，x 不够了！</span>
    cnt[x]++; <span class="hljs-comment">// 需求增加（因为少了一个）</span>
    left++;
}
</code></pre>
<blockquote>
<p>重点：只有当 <code>cnt[x] === 0</code> 时，移除它才会导致“不满足”。<br/>
因为如果 <code>cnt[x] &lt; 0</code>（冗余），移除一个没关系！</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">第三步：返回结果</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> ansLeft &lt; <span class="hljs-number">0</span> ? <span class="hljs-string">""</span> : s.<span class="hljs-title function_">substring</span>(ansLeft, ansRight + <span class="hljs-number">1</span>);
</code></pre>
<ul>
<li>如果从未找到合法窗口（<code>ansLeft</code> 还是 -1），返回 <code>""</code></li>
<li>否则返回 <code>[ansLeft, ansRight]</code> 的子串</li>
</ul>
<hr/>
<h2 data-id="heading-11">🌰 举个完整例子</h2>
<p><code>s = "ADOBECODEBANC"</code>, <code>t = "ABC"</code></p>
<ol>
<li>
<p>初始化 <code>cnt</code>:<br/>
<code>cnt[65]=1 ('A'), cnt[66]=1 ('B'), cnt[67]=1 ('C')</code>, 其他为 0<br/>
<code>less = 3</code></p>
</li>
<li>
<p>右指针移动：</p>
<ul>
<li><code>'A'</code> → <code>cnt[65]=0</code> → <code>less=2</code></li>
<li><code>'D','O','B'</code> → <code>cnt[66]=0</code> → <code>less=1</code></li>
<li><code>'E','C'</code> → <code>cnt[67]=0</code> → <code>less=0</code> ✅ 窗口 <code>"ADOBEC"</code> 合法！</li>
</ul>
</li>
<li>
<p>开始收缩左边界：</p>
<ul>
<li>移除 <code>'A'</code> → <code>cnt[65]=1</code> → <code>less=1</code> ❌ 停止收缩</li>
<li>当前最短长度 = 6</li>
</ul>
</li>
<li>
<p>继续右移……直到找到 <code>"BANC"</code>（长度 4），更新答案。</p>
</li>
</ol>
<p>最终返回 <code>"BANC"</code>。</p>
<hr/>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">s</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">t</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">string</span>}
 */</span>
<span class="hljs-keyword">var</span> minWindow = <span class="hljs-keyword">function</span>(<span class="hljs-params">s, t</span>) {
    <span class="hljs-comment">// 频次数组，ASCII 共 128 个字符</span>
    <span class="hljs-keyword">const</span> cnt = <span class="hljs-title class_">Array</span>(<span class="hljs-number">128</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">let</span> less = <span class="hljs-number">0</span>; <span class="hljs-comment">// 表示还有多少种字符未满足需求</span>

    <span class="hljs-comment">// 初始化 t 中每个字符的需求</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> c <span class="hljs-keyword">of</span> t) {
        <span class="hljs-keyword">const</span> code = c.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">if</span> (cnt[code] === <span class="hljs-number">0</span>) {
            less++; 
        }
        cnt[code]++;
    }

    <span class="hljs-keyword">const</span> m = s.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">let</span> ansLeft = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">let</span> ansRight = m; <span class="hljs-comment">// 初始设为一个较大值（长度 m 不可能）</span>
    <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> right = <span class="hljs-number">0</span>; right &lt; m; right++) {
        <span class="hljs-keyword">const</span> c = s[right].<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
        cnt[c]--;

        <span class="hljs-comment">// 如果某个字符刚好被“补足”（从正变0），说明这种字符达标了</span>
        <span class="hljs-keyword">if</span> (cnt[c] === <span class="hljs-number">0</span>) {
            less--;
        }

        <span class="hljs-comment">// 当所有字符都满足（less === 0），尝试收缩左边界</span>
        <span class="hljs-keyword">while</span> (less === <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 更新最小窗口</span>
            <span class="hljs-keyword">if</span> (right - left &lt; ansRight - ansLeft) {
                ansLeft = left;
                ansRight = right;
            }

            <span class="hljs-keyword">const</span> x = s[left].<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>);
            <span class="hljs-comment">// 如果移除 s[left] 会导致某种字符不足</span>
            <span class="hljs-keyword">if</span> (cnt[x] === <span class="hljs-number">0</span>) {
                less++; <span class="hljs-comment">// 缺失一种字符</span>
            }
            cnt[x]++;
            left++;
        }
    }

    <span class="hljs-keyword">return</span> ansLeft &lt; <span class="hljs-number">0</span> ? <span class="hljs-string">""</span> : s.<span class="hljs-title function_">substring</span>(ansLeft, ansRight + <span class="hljs-number">1</span>);
};
</code></pre>
<h2 data-id="heading-12">为什么这个方法高效？</h2>
<ul>
<li><strong>时间复杂度</strong>：O(n) —— 每个字符最多被访问两次（右指针一次，左指针一次）</li>
<li><strong>空间复杂度</strong>：O(1) —— <code>cnt</code> 固定 128 大小</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS-流光特效]]></title>    <link>https://juejin.cn/post/7604694326518825011</link>    <guid>https://juejin.cn/post/7604694326518825011</guid>    <pubDate>2026-02-10T03:00:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604694326518825011" data-draft-id="7604672395627642907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS-流光特效"/> <meta itemprop="keywords" content="前端,CSS,HTML"/> <meta itemprop="datePublished" content="2026-02-10T03:00:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS-流光特效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T03:00:46.000Z" title="Tue Feb 10 2026 03:00:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 UI 设计中，合理的动效能极大地提升产品的科技感与交互体验。本文将分享两种高频使用的流光特效：<strong>旋转边框流光</strong>（常用于 VIP 会员卡片）与<strong>线性扫描流光</strong>（常用于加载状态或按钮高亮）。</p>
<h2 data-id="heading-1">一、 旋转边框流光 (Border Rotating Glow)</h2>
<h3 data-id="heading-2">1. 实现效果：</h3>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b2f81d62c5745ebb35576b571c3bdaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297249&amp;x-signature=Hq4jfP1Fbb0D7jXRCLxuejFOgy8%3D" alt="流光边框.gif" loading="lazy"/></p>
<h3 data-id="heading-3">2. 实现原理：背景旋转裁剪</h3>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37cb9aa5de494dcd9a5aee5737805786~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297249&amp;x-signature=I8IFfEt%2BuobW1mdR%2BG1fcjhkZXE%3D" alt="流光边框原理.gif" loading="lazy"/></p>
很多同学第一反应是会尝试直接给 `border` 设置渐变，但 CSS 原生 `border` 并不支持动画旋转。 
<p><strong>核心黑科技</strong>：</p>
<ol>
<li>底层放一个<strong>巨大的、旋转的渐变色块</strong>（通常用伪元素实现）。</li>
<li>上层盖一个<strong>略小的容器</strong>（按钮主体）。</li>
<li>父容器设置 <code>overflow: hidden</code>。 这样，转动的渐变色块被裁剪后，露出的那一圈边缘看起来就像流光在游走。</li>
</ol>
<h3 data-id="heading-4">3. 实现代码</h3>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-comment">&lt;!-- 外层容器包裹按钮 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"glow-wrapper"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"glow-button"</span>&gt;</span>流光按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>


/* 外层容器：负责流光效果 */
.glow-wrapper {
  position: relative; 
  display: inline-block;
  padding: 4px; /* 控制流光边框的宽度 */
  border-radius: 12px;
  overflow: hidden; /* 关键：裁剪旋转的渐变层 */
}

/* 伪元素：旋转的渐变框 */
.glow-wrapper::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(
    45deg,
    #0066ff,
    #00ccff,
    #ccff00,
    #ff9900,
    #ff00cc
  );
  border-radius: 12px;
  z-index: -1;
  animation: rotateGlow 3s linear infinite;
}

/* 内部真实按钮 */
.glow-button {
  height: 42px;
  width: 122px;
  line-height: 42px;
  font-size: 18px;
  color: white;
  background: #121212;
  border-radius: 8px; /* 略小于 wrapper 的圆角 */
}
@keyframes rotateGlow {
  0% {
    transform: rotate(0deg);
  }
  40% {
    transform: rotate(180deg);
  }
  60% {
    transform: rotate(180deg);
  }
  100% {
    transform: rotate(360deg);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-5">二、 线性扫描流光 (Linear Scanning Glow)</h2>
<h3 data-id="heading-6">1. 实现效果：</h3>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddf3f5700fc34a3294b5bd9e47c186f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771297249&amp;x-signature=MTdoDA5oYKlv3HLfoY2uXm14UGU%3D" alt="扫描流光.gif" loading="lazy"/></p>
### 2. 实现原理：背景位移
<p>这种效果模拟了光束扫过物体的视觉感，常用于骨架屏或高级按钮。</p>
<p><strong>核心思路</strong>：</p>
<ul>
<li><strong>渐变设计</strong>：设计一个“暗-亮-暗”的 <code>linear-gradient</code>。</li>
<li><strong>尺寸放大</strong>：将 <code>background-size</code> 设为 <code>200%</code> 或更大，让“亮点”隐藏在视口之外。</li>
<li><strong>位置动画</strong>：通过改变 <code>background-position</code>，让亮色条从左至右水平穿过。</li>
</ul>
<h3 data-id="heading-7">3. 实现代码</h3>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"glow-wrapper"</span>&gt;</span>扫描流光<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

.glow-wrapper {
  position: relative;
  padding: 20px 40px; /* 边框厚度 */
  color: white;
  border-radius: 10px;
  font-weight: 800;
  background: linear-gradient(90deg, transparent, #00dbde, transparent);
  background-size: 200% 100%;
  animation: scan 2s linear infinite;
}

@keyframes scan {
  0% {
    background-position: -200% 0%;
  }
  100% {
    background-position: 200% 0%;
  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>